<?xml version="1.0" encoding="UTF-8"?><rss version="2.0">  <channel>      <title>掘金文章推荐</title>      <link>https://juejin.cn/recommended?sort=newest</link>      <description>一个帮助开发者成长的社区</description>      <generator>python juejin_recom.py @Pi20</generator>      <item>    <title><![CDATA[B站社群AI智能分析系统的实践]]></title>    <link>https://juejin.cn/post/7577307100130377778</link>    <guid>https://juejin.cn/post/7577307100130377778</guid>    <pubDate>2025-11-28T04:05:16.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577307100130377778" data-draft-id="7577050643203670066" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="B站社群AI智能分析系统的实践"/> <meta itemprop="keywords" content="人工智能"/> <meta itemprop="datePublished" content="2025-11-28T04:05:16.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="哔哩哔哩技术"/> <meta itemprop="url" content="https://juejin.cn/user/3030701626893405"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            B站社群AI智能分析系统的实践
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3030701626893405/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    哔哩哔哩技术
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-28T04:05:16.000Z" title="Fri Nov 28 2025 04:05:16 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-28
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读11分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0"><strong>一、为什么我们需要一套能“读懂群聊”的 AI？</strong></h2>
<p>在 B 站，我们运营团队需要管理着数量庞大的UP主交流群，如：品类扶持、成长训练营、专项交流、答疑沟通群等。覆盖许许多多的创作者，每天会产生大量的消息。如果完全依赖人工逐条统计，不仅效率低下，而且容易遗漏关键问题。早期运营尝试过简单的关键字分析和人工汇总的方式，但这种传统方案存在明显局限：只能捕捉预先设定的词汇，无法理解上下文和隐含含义，对新出现的话题无法及时捕获。同时人工整理出的反馈多为自由文本，缺乏结构化信息，难以及时深入分析。</p>
<p><strong>于是我们做了一件事：</strong></p>
<ul>
<li>
<p>让 AI 自动阅读社群会话内容</p>
</li>
<li>
<p>理解创作者的真实声音</p>
</li>
<li>
<p>并生成结构化洞察、预警、日报、周报。</p>
</li>
</ul>
<h2 data-id="heading-1"><strong>二、整体架构：一套由 LLM 驱动的社群 “AI 中台”</strong></h2>
<p>整个系统的生命周期可以分为 四层：</p>
<p><strong>数据采集层 → AI 结构化层 → 群体分析层 → 运营洞察层</strong></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6cb3a37f57ab44a8b946a6897ec0f95a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZOU5ZOp5ZOU5ZOp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764907516&amp;x-signature=MtlWc3%2FxHC9ePxvlIbulQ2p%2BbhI%3D" alt="图片" loading="lazy"/></p>
<p>在大量真实业务场景中落地群聊智能分析，我们不仅构建了由多个大模型驱动的 Agent Pipeline，更形成了一套 可治理、可复用、可演化的 Prompt Engineering 与语义分析架构。</p>
<p>系统的关键点如下：</p>
<h3 data-id="heading-2"><strong>1.分层 Prompt Engineering 体系：高召回 × 高精度的协同设计</strong></h3>
<p>我们将整条 LLM 链路拆分为四层 Prompt：</p>
<ol>
<li> 信息挖掘层</li>
</ol>
<ul>
<li>用于高召回地提取所有可能的用户反馈</li>
<li>固定 Schema 输出，保障结构化稳定性</li>
<li>内置业务语义空间（反馈类型、标签体系、情绪体系）</li>
</ul>
<ol start="2">
<li> 内容治理层</li>
</ol>
<ul>
<li>用于高精度校验、去幻觉、去噪</li>
<li>引入“模糊语句过滤 + 情绪 × 意图双因子校验”</li>
<li>合并同用户重复反馈、剔除弱反馈、剔除运营/测试信息</li>
</ul>
<ol start="3">
<li> 语义聚类层</li>
</ol>
<ul>
<li>基于大模型语义理解自动构建话题簇</li>
<li>统一标签命名，避免相似标签分裂</li>
<li>当出现语义相近但不属于既有标签的反馈时，模型能够基于语义自动归并或生成新标签</li>
</ul>
<ol start="4">
<li> 洞察生成层</li>
</ol>
<p>a.  自动生成 100 字社区热点摘要</p>
<p>b.  基于结构化数据生成日报/周报，包含环比变化与风险事件</p>
<p>通过分层 Prompt，我们实现了 <strong>可控、高可用、全链路可解释</strong> 的模型输出体系。</p>
<h3 data-id="heading-3"><strong>2.双模型协作：精准性与成本之间的动态平衡</strong></h3>
<p>社群消息本质是 <strong>非结构化、口语化、强上下文依赖</strong> 的文本，针对每日大量群聊，我们采用“轻模型做召回 → 强模型做校验”的方法：</p>
<ul>
<li>LLM A：擅长高召回、信息挖掘</li>
<li>LLM B：擅长严谨判断、减少幻觉</li>
</ul>
<blockquote>
<p>出于业务安全，本次分享中我们对实际使用的大语言模型进行了匿名化处理，仅以其能力特征进行描述。</p>
</blockquote>
<p>这种 多模型协同校验 的设计，让我们在成本、召回率、准确率之间达成最佳平衡。</p>
<h4 data-id="heading-4"><strong>真实样例：模型幻觉导致的严重误判</strong></h4>
<p>在项目初期，我们仅使用单模型直接解析群聊内容。当遇到某些“非结构化、短句、无明确反馈意图”的消息时，模型会为了满足结构化输出要求，<strong>主动补充一些并不存在的反馈信息</strong>。</p>
<p>下面是一次典型的错误样本：</p>
<blockquote>
<p>真实情况：该群当天没有 UP 主提出任何有效反馈内容。</p>
<p>模型输出：却“凭空生成”了数十条反馈结构，包括需求、负向反馈、标签分类等。</p>
</blockquote>
<p>截图如下：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e202e8c566bd4e08bba3633ae946c488~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZOU5ZOp5ZOU5ZOp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764907516&amp;x-signature=ng6AntzQw4xxkzYt%2F2wdOyCkUsk%3D" alt="图片" loading="lazy"/></p>
<p>然而经过人工复查可以确认：</p>
<blockquote>
<p>以上所有反馈均为模型“自动脑补”，群聊原文中完全不存在。</p>
</blockquote>
<p>这不是简单的技术 Bug，而是足以影响业务判断的 <strong>严重幻觉风险</strong>。</p>
<h4 data-id="heading-5"><strong>因此，我们必须引入第二阶段严格复核节点</strong></h4>
<p>为了避免这类“凭空生成反馈”的问题，我们设计了 LLM A（高召回） → LLM B（高精度） 的双模型协作机制。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d21977afa3c549f3b6f505165a3d2e37~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZOU5ZOp5ZOU5ZOp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764907516&amp;x-signature=H%2B8iGXj9ezhD0vZtTRKSjA2eLiY%3D" alt="图片" loading="lazy"/></p>
<p>在复核节点中我们做了几类专门的 <strong>“反幻觉策略”</strong> ：</p>
<ul>
<li>
<p>严格禁止模型补充不存在的用户原话</p>
</li>
<li>
<p>无原话时 → 必须输出「无反馈」</p>
</li>
<li>
<p>结构化数据必须与原文一一对应</p>
</li>
<li>
<p>模糊语气（似乎、可能） → 自动判定为高风险 → 进入复核</p>
</li>
<li>
<p>字段缺失、标签不符 → Must Fix</p>
</li>
</ul>
<p><strong>经过增强后：</strong></p>
<ul>
<li>
<p>幻觉率从 早期的 8–12% → 降为 &lt;1%</p>
</li>
<li>
<p>假反馈基本完全消失</p>
</li>
<li>
<p>所有反馈均带可追溯原话，形成“证据链”</p>
</li>
</ul>
<h3 data-id="heading-6"><strong>3.基于 Few-shot 的结构化输出稳定机制</strong></h3>
<p>在实际使用大模型时，结构化输出（尤其是表格字段）容易随着上下文或模型版本发生“格式漂移”。</p>
<p>为此，我们采用了一种 轻量级 Few-shot Prompting 方法，让模型在正式解析业务数据前，通过少量示例快速“记住”目标格式，从而保持输出稳定。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6c01eea55a79438c8d565a33cfcd4db4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZOU5ZOp5ZOU5ZOp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764907516&amp;x-signature=ajjjEvIl6DOJwazVFeFY0ExswkE%3D" alt="图片" loading="lazy"/></p>
<p><strong>方案原理：</strong></p>
<p>通过给模型连续提供 2～3 个标准表格示例（Few-shot），并让模型在后续回答中沿用同样的格式，来显著降低结构漂移概率。</p>
<p>无须额外的校验器，无须复杂自愈机制，成本极低，但对稳定性提升非常明显。</p>
<p><strong>技术流程：</strong></p>
<ol>
<li> 在 Prompt 中加入 1–2 个“标准表格示例”（Few-shot Examples）</li>
</ol>
<p>a.  示例内容来自真实数据或我们构造的理想格式。</p>
<ol start="2">
<li>
<p> 要求模型：下一轮回答必须完全沿用示例格式</p>
</li>
<li>
<p> 如果模型偶尔偏移，少量的“格式纠正提示”即可修正</p>
</li>
</ol>
<p>在某些场景下，这种 few-shot 技巧甚至比复杂的结构化约束更实用。</p>
<h3 data-id="heading-7"><strong>4.LLM 语义聚类：适应社区语言变化的轻量级 Topic 分组</strong></h3>
<p>用户在群聊中的用词高度自由，包含大量细微表达差异：</p>
<ul>
<li>
<p>多种说法表达同一个问题（如“审核慢”“卡审核”）</p>
</li>
<li>
<p>多种术语、别名并存（“流量波动”“推流不稳”）</p>
</li>
<li>
<p>不断出现新的词汇或表述</p>
</li>
</ul>
<p>为避免关键词维护负担，我们采用：</p>
<ul>
<li>
<p>LLM 自主判断语义相似度（不是关键词匹配）</p>
</li>
<li>
<p>让模型生成统一标签（避免同类话题被拆分）</p>
</li>
<li>
<p>当模型识别到“完全不属于现有主题”的内容时，自动生成新主题</p>
</li>
</ul>
<p>这是一种轻量但非常实用的 Topic 聚类方式，可以让系统在不依赖复杂算法的前提下，自动跟上业务与社区语境的变化，<strong>效果足以支撑每日热点、话题趋势分析</strong>。</p>
<p>以下Prompt隐去了一些我们业务标签注入的内容，但仍可供大家参考</p>
<pre><code class="hljs language-diff" lang="diff">你是社区运营团队的一员。你即将阅读到一批用户反馈内容，每条反馈都有唯一的“反馈ID”。

你的工作如下：
主题聚类
<span class="hljs-deletion">- 对所有反馈进行语义聚类，将语义相近的反馈归为同一主题（如“系统卡顿”和“服务器崩溃”应归为同类）。</span>
<span class="hljs-deletion">- 相同主题只保留一个统一标签，不要生成相似但不同的标签名称。</span>
标签命名
<span class="hljs-deletion">- 参考微博热搜命名方式，生成简洁有冲击力的标签（2~8字），避免冗长描述。</span>
<span class="hljs-deletion">- 标签需覆盖多种类型（满意度、咨询、问题等），不可只聚焦问题反馈。</span>
事件提炼
<span class="hljs-deletion">- 为每个标签用一句话概括用户关注的焦点，事件化描述，不要罗列类别。</span>
热度统计
<span class="hljs-deletion">- 统计该标签下的反馈数量，作为热度值。</span>
反馈ID标注
<span class="hljs-deletion">- 列出与该标签相关的最多5个反馈ID，用英文逗号分隔。</span>
排序输出
<span class="hljs-deletion">- 按热度从高到低，输出前10个标签的信息。</span>

输出表格格式如下，请勿返回多余的注解：
| 标签 | 热议事件 | 热度 | 反馈ID |
</code></pre>
<h3 data-id="heading-8"><strong>5.语义驱动的风控预警体系：从趋势中提前发现风险</strong></h3>
<p>我们结合语义聚类结果与反馈指标，形成了轻量级的预警判断逻辑：</p>
<ul>
<li>
<p>量级分析</p>
</li>
<li>
<p>增速分析</p>
</li>
<li>
<p>负向占比</p>
</li>
<li>
<p>情绪突发检测</p>
</li>
<li>
<p>跨群体一致性判断</p>
</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1c4318b9ddce4e208f0d6bab799b6646~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZOU5ZOp5ZOU5ZOp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764907516&amp;x-signature=UKMUZ%2F%2Bkuyity2WUKeTQ9vBTTqs%3D" alt="图片" loading="lazy"/></p>
<p>当某个话题出现：</p>
<ul>
<li>
<p>负向情绪短时间急增</p>
</li>
<li>
<p>环比快速上涨</p>
</li>
<li>
<p>多个群同时出现类似反馈</p>
</li>
</ul>
<p>系统会自动判定为 <strong>突发事件</strong>，并标注风险等级。</p>
<p>相比传统人工轮询，这种能力可以：</p>
<h4 data-id="heading-9"><strong>全链路流程图</strong></h4>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1c6bae534fb847969b8b62221db9a9f6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZOU5ZOp5ZOU5ZOp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764907516&amp;x-signature=i25gM6VxupT%2BjPRsBBo8VwpGBMY%3D" alt="图片" loading="lazy"/></p>
<h2 data-id="heading-10"><strong>三、实际效果与业务收益</strong></h2>
<p>引入 AI 智能分析系统后，我们在反馈洞察的效率、覆盖、准确性上都取得了显著提升。</p>
<p>过去依赖人工筛查时，在有限人力下日均只能回收约 50 条有效反馈；如今系统能够每天自动回收近 600 条，覆盖范围扩大十倍以上，大量被忽略的“弱信号”得以被及时捕捉和记录。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7bb81bb1d2ce47a2b92c340b7f254bed~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZOU5ZOp5ZOU5ZOp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764907516&amp;x-signature=1CpbMFvHqXoRUa%2Bf25myEHfNJDs%3D" alt="图片" loading="lazy"/></p>
<p>AI 带来的价值不仅体现在规模化处理，更重要的是对关键事件的提前洞察能力。系统能够识别短时间内出现的异常聚集信号，如创作流程、审核体验、版权申诉等领域的情绪波动。当某一话题的负面表达突然增多时，系统会自动聚合并提升为重点关注事件，让团队能在问题形成大范围扩散前就提前介入，在早期苗头阶段就进行响应与处理。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c74c6a91487c4e1c8448e3ef9406ca65~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZOU5ZOp5ZOU5ZOp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764907516&amp;x-signature=Jvd2IfcmnHB1olfQwDyFycEsFHA%3D" alt="图片" loading="lazy"/></p>
<p>此外，结构化处理后的海量群聊信息，也成为了团队的重要知识资产。这些数据会进一步被用于：</p>
<ul>
<li>
<p>生成每日/每周的事件简报，为运营与产品提供准确的用户温度计</p>
</li>
<li>
<p>输出典型案例与话题热度，辅助判断优先级</p>
</li>
<li>
<p>自动生成 TAPD 需求，推动问题闭环处理</p>
</li>
<li>
<p>为产品团队提供真实用户的“原声证据”，减少沟通成本</p>
</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/72e70150a84a43d0a434b0eb7deb54b4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZOU5ZOp5ZOU5ZOp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764907516&amp;x-signature=fMq6QE%2BWsriiGft7a9C8IMdjsig%3D" alt="图片" loading="lazy"/></p>
<p>在 BI 看板上，这些沉淀的数据以更直观的方式呈现：情绪趋势、话题聚类、反馈规模、风险事件等核心指标一目了然，让业务团队可以随时掌握用户的关注点和变化趋势，做到“数据驱动运营决策”。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fdd27ecf627c4aa59e1b9714b93ceae2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZOU5ZOp5ZOU5ZOp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764907516&amp;x-signature=H7Lc%2FuuR2G747MkMer8QqcagWfU%3D" alt="图片" loading="lazy"/></p>
<p>整体而言，这套社群信息 AI 分析体系让我们从被动响应走向了主动洞察——</p>
<p>不再是等用户大量投诉后再处理，而是能够利用 AI 的语义理解能力，及时捕捉到群聊中不断浮现的细微变化，并将分散的用户声音转化为推动产品迭代的动力。</p>
<h2 data-id="heading-11"><strong>四、AI应用优势总结</strong></h2>
<p>这套社群信息 AI 分析体系的落地，让我们在反馈获取、问题识别和运营决策三个层面都获得了实质性的提升：</p>
<ul>
<li>
<p>效率跃升：大量重复、零散的群聊分析工作被自动化取代，团队能把更多精力投入到关键问题的判断与沟通上。</p>
</li>
<li>
<p>全面覆盖：大模型的语义理解能力让“隐晦表达、弱信号、新话题”都能被及时捕捉，显著降低反馈遗漏率。</p>
</li>
<li>
<p>情绪量化：用户情绪从主观判断变成可观测指标，趋势变化也能通过数据直接呈现，为运营提供更及时的风险提示。</p>
</li>
<li>
<p>话题聚合能力：语义聚类让重复表达的意见被合并、长尾问题被显性化，帮助我们更准确地把握 UP 主的关注点。</p>
</li>
<li>
<p>推动闭环：结构化数据沉淀后，反馈能自然进入日报、周报和需求流转体系，问题从被发现到被解决的路径更加顺畅。</p>
</li>
</ul>
<p>AI 让我们从“人工盯岗”进入“主动洞察”时代。</p>
<p>我们真正实现了将创作者的声音得到规模化记录、分析与反馈，这在过去几乎是不可能完成的任务。</p>
<p>未来，我们也会继续加强模型在风险识别、创作支持与社区生态等方向的能力建设，为平台持续提供更智能的基础设施。</p>
<p>-End-</p>
<p>作者丨Zerooo、蓝莓派</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Python真的要一统天下了？]]></title>    <link>https://juejin.cn/post/7115595433472163870</link>    <guid>https://juejin.cn/post/7115595433472163870</guid>    <pubDate>2022-07-02T02:24:49.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7115595433472163870" data-draft-id="7115591637132115999" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Python真的要一统天下了？"/> <meta itemprop="keywords" content="Python"/> <meta itemprop="datePublished" content="2022-07-02T02:24:49.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Python编程学习圈"/> <meta itemprop="url" content="https://juejin.cn/user/2261048121629512"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Python真的要一统天下了？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2261048121629512/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Python编程学习圈
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2022-07-02T02:24:49.000Z" title="Sat Jul 02 2022 02:24:49 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2022-07-02
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    84
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body cache result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>Python 最近又在搞大事情，就在最近，github上突然多了一个神奇的项目</p>
<p>GitHub地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fpyscript%2Fpyscript" target="_blank" title="https://github.com/pyscript/pyscript" ref="nofollow noopener noreferrer">github.com/pyscript/py…</a></p>
<p>并且最近一直在更新。一看这个名字就让我们不禁想起JavaScript，再去官网一看</p>
<p>pyscript官网：<a href="https://link.juejin.cn?target=https%3A%2F%2Fpyscript.net%2F" target="_blank" title="https://pyscript.net/" ref="nofollow noopener noreferrer">pyscript.net/</a></p>
<p>这家伙不仅模仿了JavaScript的名字，甚至连身子都想要取而代之！</p>
<p>官方对pyscript的期望是可以在浏览器上直接运行python。</p>
<pre><code class="hljs language-bash" lang="bash">&lt;html&gt;|
    ...|
    &lt;py-script&gt; <span class="hljs-built_in">print</span>(<span class="hljs-string">'Now you can!'</span>) &lt;/py-script&gt;|
&lt;/html&gt;|
</code></pre>
<p>怀着一颗好奇心，我们把github上的代码克隆下来，发现是一个基于node的前端项目，那第一步先把他跑起来！</p>
<p>进入\pyscript-main\pyscriptjs目录下，</p>
<ol>
<li>首先安装依赖 cnpm i</li>
<li>然后先在本地运行 npm run dev</li>
<li>打开 <a href="https://link.juejin.cn?target=http%3A%2F%2Flocalhost%3A8080%2F" target="_blank" title="http://localhost:8080/" ref="nofollow noopener noreferrer">http://localhost:8080/</a></li>
</ol>
<p>首页是一个纯纯的html文件，在\pyscript-main\pyscriptjs\examples目录下的index.html，如下图：</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/e0d606931a8c414f811c2c44a9ca1f28~tplv-k3u1fbpfcp-zoom-in-crop-mark:1512:0:0:0.awebp" alt="图片" title="img.png" loading="lazy"/></p>
<p>我们先来看看最简单的Hello world页面，如下图：</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/3879aa959cbc4d539c47fd79f601e74c~tplv-k3u1fbpfcp-zoom-in-crop-mark:1512:0:0:0.awebp" alt="图片" title="img_1.png" loading="lazy"/></p>
<p>页面确实够简单，再看看它的代码：</p>
<pre><code class="hljs language-perl" lang="perl">&lt;body&gt;
    Hello world! &lt;br&gt;
    This is the current date <span class="hljs-keyword">and</span> <span class="hljs-keyword">time</span>, as computed by Python:     &lt;py-script&gt;
from datetime import datetime
now = datetime.now()
now.strftime(<span class="hljs-string">"%m/%d/%Y, %H:%M:%S"</span>)
    &lt;<span class="hljs-regexp">/py-script&gt;  
  &lt;/</span>body&gt;
</code></pre>
<p>想必大家都可以看得懂这段代码，精彩的点在于，只要在标签中，就可以直接使用python语法来进行操作了，并且似乎比JavaScript还要直接嗷，甚至还有点数据绑定的意思。</p>
<p>再来看看另一个经典的例子，todo_list，对应todo.html,如下图：</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/1a2ecb9a8b984e5b9106e5c5612d5421~tplv-k3u1fbpfcp-zoom-in-crop-mark:1512:0:0:0.awebp" alt="图片" title="img_2.png" loading="lazy"/></p>
<p>再看代码：</p>
<pre><code class="hljs language-xml" lang="xml">... 
 <span class="hljs-tag">&lt;<span class="hljs-name">py-script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"/todo.py"</span>&gt;</span>  <span class="hljs-tag">&lt;/<span class="hljs-name">py-script</span>&gt;</span>
...
<span class="hljs-tag">&lt;<span class="hljs-name">section</span>&gt;</span>
    
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"text-center w-full mb-8"</span>&gt;</span>      
      <span class="hljs-tag">&lt;<span class="hljs-name">h1</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"text-3xl font-bold text-gray-800 uppercase tracking-tight"</span>&gt;</span>To Do List<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>   
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>    
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>      
      <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"new-task-content"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"border flex-1 mr-3 border-gray-300 p-2 rounded"</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"text"</span>&gt;</span>      
      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"new-task-btn"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"p-2 text-white bg-blue-600 border border-blue-600 rounded"</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"submit"</span> <span class="hljs-attr">pys-onClick</span>=<span class="hljs-string">"add_task"</span>&gt;</span>        
        Add task      
      <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>    
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    
    <span class="hljs-tag">&lt;<span class="hljs-name">py-list</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"myList"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">py-list</span>&gt;</span>    
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"list-tasks-container"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"flex flex-col-reverse mt-4"</span>&gt;</span>  
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    
    <span class="hljs-tag">&lt;<span class="hljs-name">template</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"task-template"</span>&gt;</span>        
      <span class="hljs-tag">&lt;<span class="hljs-name">section</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"task bg-white my-1"</span>&gt;</span>            
          <span class="hljs-tag">&lt;<span class="hljs-name">label</span> <span class="hljs-attr">for</span>=<span class="hljs-string">"flex items-center p-2 "</span>&gt;</span>              
            <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"mr-2"</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"checkbox"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"task-check"</span>&gt;</span>              
            <span class="hljs-tag">&lt;<span class="hljs-name">p</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"m-0 inline"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>            
          <span class="hljs-tag">&lt;/<span class="hljs-name">label</span>&gt;</span>       
        <span class="hljs-tag">&lt;/<span class="hljs-name">section</span>&gt;</span>      
      <span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>
  
  <span class="hljs-tag">&lt;/<span class="hljs-name">section</span>&gt;</span>
</code></pre>
<p>在代码最上面竟然引入了一个.py文件，代码中使用pys-onClick绑定了add_task方法，而add_task方法在引入的todo.py中进行了声明：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">add_task</span>(<span class="hljs-params">*ags, **kws</span>):   
   ...
</code></pre>
<p>也就是说，pyscript真的可以做到和JavaScript在浏览器中运行时一样的调用体验，甚至还可以在浏览器中引用python类库！</p>
<p>在另一个todo_pylist.html页面中，提供了直接在浏览器中运行python命令的方法，</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/b8f27cd504f04e7789481de69617a37f~tplv-k3u1fbpfcp-zoom-in-crop-mark:1512:0:0:0.awebp" alt="图片" title="img_3.png" loading="lazy"/></p>
<p>为了显示自己在处理复杂图形方面的能力，示例中还提供了和three.js结合而成的webgl示例页面：</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/c56cf42a31834f7d9fce220f4034e6de~tplv-k3u1fbpfcp-zoom-in-crop-mark:1512:0:0:0.awebp" alt="图片" title="img_4.png" loading="lazy"/></p>
<p>和一些图表页面：</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/2cc4f71dd8ba4a858b1597ea18d76feb~tplv-k3u1fbpfcp-zoom-in-crop-mark:1512:0:0:0.awebp" alt="图片" title="img_5.png" loading="lazy"/></p>
<p>可以看到，在功能实现上，pyscript基本可以实现JavaScript能够实现的功能。</p>
<p>不过从目前的体验上来看，在浏览器上运行python属实是够慢的，每次打开页面都得等好几秒，并且第一次打开页面的时候竟然还要下载python类库，github上已经有人提出了这个问题，并且官方回答他们已经努力了，并且还在继续努力。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[React性能优化：这5个Hooks技巧让我减少了40%的重新渲染]]></title>    <link>https://juejin.cn/post/7577284771447439400</link>    <guid>https://juejin.cn/post/7577284771447439400</guid>    <pubDate>2025-11-28T04:17:41.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577284771447439400" data-draft-id="7577284968923086848" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="React性能优化：这5个Hooks技巧让我减少了40%的重新渲染"/> <meta itemprop="keywords" content="后端,前端,人工智能"/> <meta itemprop="datePublished" content="2025-11-28T04:17:41.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="阿橙的百宝箱"/> <meta itemprop="url" content="https://juejin.cn/user/1638743356481367"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            React性能优化：这5个Hooks技巧让我减少了40%的重新渲染
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1638743356481367/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    阿橙的百宝箱
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-28T04:17:41.000Z" title="Fri Nov 28 2025 04:17:41 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-28
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0"><strong>React性能优化：这5个Hooks技巧让我减少了40%的重新渲染</strong></h2>
<h2 data-id="heading-1">引言</h2>
<p>在现代前端开发中，React凭借其组件化思想和声明式编程模型赢得了广泛认可。然而，随着应用规模的增长，性能问题逐渐显现，尤其是组件不必要的重新渲染问题。据统计，超过60%的React性能问题源于不当的状态管理和副作用处理。</p>
<p>作为一名长期深耕React开发的工程师，我在多个大型项目中通过系统性优化成功将重新渲染次数减少了40%。本文将分享5个经过实战检验的Hooks优化技巧，这些方法不仅符合React最佳实践，还能显著提升应用性能。</p>
<h2 data-id="heading-2">主体内容</h2>
<h3 data-id="heading-3">1. useMemo：昂贵的计算不再重复</h3>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">const</span> <span class="hljs-title function_">ExpensiveComponent</span> = (<span class="hljs-params">{ data }</span>) =&gt; {
  <span class="hljs-comment">// ❌ 每次渲染都重新计算</span>
  <span class="hljs-keyword">const</span> processedData = <span class="hljs-title function_">complexCalculation</span>(data);

  <span class="hljs-comment">// ✅ 使用useMemo缓存计算结果</span>
  <span class="hljs-keyword">const</span> memoizedData = <span class="hljs-title function_">useMemo</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">complexCalculation</span>(data), [data]);

  <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>{memoizedData}<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>;
};
</code></pre>
<p><strong>优化原理：</strong></p>
<ul>
<li><code>useMemo</code>会记忆（memoize）计算结果，仅在依赖项变化时重新计算</li>
<li>React使用Object.is比较依赖项的变化</li>
</ul>
<p><strong>最佳实践：</strong></p>
<ul>
<li>适用于JSON序列化、复杂转换或大数据处理等场景</li>
<li>避免过度使用：简单计算可能比记忆化开销更大</li>
<li>Chrome DevTools的Profiler可验证优化效果</li>
</ul>
<p><strong>案例分析：</strong>
在某电商平台商品列表页中，将价格换算逻辑用useMemo包裹后，交互延迟从120ms降至40ms。</p>
<h3 data-id="heading-4">2. useCallback：稳定的函数引用</h3>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">const</span> <span class="hljs-title function_">ProductList</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-keyword">const</span> [products, setProducts] = <span class="hljs-title function_">useState</span>([]);
  
  <span class="hljs-comment">// ❌ 每次渲染创建新函数</span>
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleSelect</span> = (<span class="hljs-params">product</span>) =&gt; { <span class="hljs-comment">/*...*/</span> };

  <span class="hljs-comment">// ✅ 保持稳定引用</span>
  <span class="hljs-keyword">const</span> memoizedHandleSelect = <span class="hljs-title function_">useCallback</span>(<span class="hljs-function">(<span class="hljs-params">product</span>) =&gt;</span> {
    <span class="hljs-comment">// handler逻辑</span>
  }, []);

  <span class="hljs-keyword">return</span> products.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">p</span> =&gt;</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">ProductItem</span> 
      <span class="hljs-attr">key</span>=<span class="hljs-string">{p.id}</span> 
      <span class="hljs-attr">onSelect</span>=<span class="hljs-string">{memoizedHandleSelect}</span> 
    /&gt;</span></span>
  ));
};
</code></pre>
<p><strong>深度解析：</strong></p>
<ul>
<li>JavaScript中函数是对象，每次创建都是新引用</li>
<li>React.memo等优化依赖props的浅比较（shallow compare）</li>
<li>Webpack Bundle Analyzer显示频繁的函数重建会增加内存压力</li>
</ul>
<p><strong>进阶技巧：</strong></p>
<ul>
<li>TypeScript用户可结合<code>react-hooks/exhaustive-deps</code>规则确保依赖完整</li>
<li>Event bus模式可作为大量回调函数的替代方案</li>
</ul>
<h3 data-id="heading-5">3. useContext + useMemo：上下文优化的黄金组合</h3>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">const</span> <span class="hljs-title class_">UserContext</span> = <span class="hljs-title function_">createContext</span>();

<span class="hljs-keyword">const</span> <span class="hljs-title function_">App</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-keyword">const</span> [user, setUser] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">null</span>);

  <span class="hljs-comment">// ❌ Context值变化导致所有消费者重渲染</span>
  <span class="hljs-comment">// return &lt;UserContext.Provider value={{ user, setUser }}&gt;</span>

  <span class="hljs-comment">// ✅ Memo化上下文值对象</span>
	<span class="hljs-keyword">const</span> contextValue = <span class="hljs-title function_">useMemo</span>(<span class="hljs-function">() =&gt;</span> ({ user, setUser }), [user]);

	<span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">UserContext.Provider</span> <span class="hljs-attr">value</span>=<span class="hljs-string">{contextValue}</span>&gt;</span>
    {/* children */}
	<span class="hljs-tag">&lt;/<span class="hljs-name">Provider</span>&gt;</span></span>
}
</code></pre>
<p><strong>架构层面的思考：</strong></p>
<ul>
<li>Context应当遵循最小化更新原则（Principle of Least Updates）</li>
<li>Redux等状态库内部也采用类似策略实现高效更新</li>
<li>React DevTools可查看上下文更新的影响范围</li>
</ul>
<p><strong>真实场景数据：</strong>
某SaaS平台仪表盘通过此优化将上下文相关重渲染减少72%。</p>
<h3 data-id="heading-6">4. useReducer vs useState：状态管理的正确选择</h3>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-comment">// ❌ useState导致多次更新和渲染波峰（render peaks）</span>
<span class="hljs-keyword">const</span> [state, setState] = <span class="hljs-title function_">useState</span>(initialState);
<span class="hljs-keyword">const</span> <span class="hljs-title function_">handleAction</span> = (<span class="hljs-params"/>) =&gt; {
	<span class="hljs-title function_">setState</span>(<span class="hljs-function"><span class="hljs-params">prev</span> =&gt;</span> ({ ...prev, <span class="hljs-attr">a</span>: newA }));
	<span class="hljs-title function_">setState</span>(<span class="hljs-function"><span class="hljs-params">prev</span> =&gt;</span> ({ ...prev, <span class="hljs-attr">b</span>: newB }));
};

<span class="hljs-comment">// ✅ useReducer批量处理相关状态变更</span>
<span class="hljs-keyword">const</span> [state, dispatch] = <span class="hljs-title function_">useReducer</span>(reducer, initialState);
<span class="hljs-title function_">dispatch</span>({ <span class="hljs-attr">type</span>: <span class="hljs-string">'MULTI_UPDATE'</span>, <span class="hljs-attr">payload</span>: { <span class="hljs-attr">a</span>: newA, <span class="hljs-attr">b</span>: newB } });
</code></pre>
<p><strong>性能对比测试：</strong></p>

























<table><thead><tr><th>Metric</th><th>useState</th><th>useReducer</th></tr></thead><tbody><tr><td>Render次数</td><td>N</td><td>≤N</td></tr><tr><td>GC压力</td><td>High</td><td>Medium</td></tr><tr><td>TS类型安全</td><td>Medium</td><td>High</td></tr></tbody></table>
<p><strong>适用场景判断矩阵：</strong></p>
<ol>
<li>
<blockquote>
<p>3个关联状态 → useReducer优先考虑</p>
</blockquote>
</li>
<li><strong>复杂状态逻辑 → Reducer模式更优</strong></li>
<li><strong>高频更新 → Reducer合并优势明显</strong></li>
</ol>
<h3 data-id="heading-7"><em>5.</em> <em>useRef</em> <em>+</em> <em>useEffect</em> <em>/</em> <em>useLayoutEffect</em> <em>DOM操作的艺术</em></h3>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">function</span> <span class="hljs-title function_">ResizablePanel</span>(<span class="hljs-params"/>) {
	<span class="hljs-keyword">const</span> ref = <span class="hljs-title function_">useRef</span>(<span class="hljs-literal">null</span>);
	
	<span class="hljs-title function_">useLayoutEffect</span>(<span class="hljs-function">() =&gt;</span> {
		<span class="hljs-keyword">const</span> element = ref.<span class="hljs-property">current</span>;
		<span class="hljs-keyword">const</span> resizeObserver = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ResizeObserver</span>(<span class="hljs-function"><span class="hljs-params">entries</span> =&gt;</span> {
			<span class="hljs-comment">// DOM测量和布局调整逻辑...</span>
		});
		
		resizeObserver.<span class="hljs-title function_">observe</span>(element);
		<span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> resizeObserver.<span class="hljs-title function_">unobserve</span>(element); 
	}, []);

	<span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">{ref}</span> /&gt;</span></span>;
}
</code></pre>
<p>浏览器工作原理视角：</p>
<ol>
<li><strong>避免"布局抖动"（Layout Thrashing）</strong>: <code>useLayoutEffect</code>在浏览器绘制前同步执行</li>
<li><strong>IntersectionObserver/ResizeObserver API的最佳拍档</strong>: Ref提供稳定的DOM引用<br/>
3.<strong>动画性能提升关键</strong>: requestAnimationFrame与Ref协同工作</li>
</ol>
<p>工程实践建议：
1.<strong>SSR环境特殊处理</strong>: typeof window检查 + useEffect替代<br/>
2.<strong>TypeScript泛型约束</strong>: <code>useRef&lt;HTMLDivElement&gt;(null)</code>提高类型安全</p>
<p>##总结</p>
<p>通过对这五个Hooks技巧的系统性应用——从基础的<code>useMemo/useCallback</code>到进阶的上下文优化和Reducer模式——我们构建了一套完整的React性能防护体系。这些方法共同构成了一个渐进式的优化策略：</p>
<p>1.<strong>初级优化</strong>: <code>单个组件的记忆化手段</code><br/>
2.<strong>中级架构</strong>: <code>跨组件的引用稳定性控制</code><br/>
3.<strong>高级模式</strong>: <code>全局状态的批处理和精确更新</code></p>
<p>值得注意的是,<strong>真正的性能工程是度量驱动的（Metrics-Driven）</strong>,建议结合以下工具链建立完整的监控闭环：</p>
<p>• <strong>React DevTools Profiler</strong>定位具体问题组件<br/>
• <strong>Chrome Performance Tab分析主线程活动</strong>(Long Tasks指标特别关键)<br/>
• <strong>Sentry/BrowserStack进行真实用户监控</strong>(采集FCP/TTI等核心Web Vitals)</p>
<p>最后要强调的是,<strong>没有放之四海而皆准的银弹</strong>,本文介绍的每个技术点都需要结合实际场景进行评估。当你在代码中看到频繁出现的<code>dependency array</code>时,就该停下来思考:<strong>这是否是最优雅的状态关系建模？是否有更合理的组件层级划分？</strong></p>
<p>正如React核心团队成员Dan Abramov所言："Performance is not about micro optimizations,but about having the right mental model."(<strong>性能优化的本质不是微观调优而是建立正确的思维模型</strong>)</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[SEO听不懂？看完这篇你明天就能优化网站了]]></title>    <link>https://juejin.cn/post/7577411657392635946</link>    <guid>https://juejin.cn/post/7577411657392635946</guid>    <pubDate>2025-11-28T04:23:00.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577411657392635946" data-draft-id="7576861477267193875" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="SEO听不懂？看完这篇你明天就能优化网站了"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-11-28T04:23:00.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="技术探索家"/> <meta itemprop="url" content="https://juejin.cn/user/2735240657517816"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            SEO听不懂？看完这篇你明天就能优化网站了
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2735240657517816/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    技术探索家
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-28T04:23:00.000Z" title="Fri Nov 28 2025 04:23:00 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-28
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读15分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b873bd06ec504994a608585073409cac~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oqA5pyv5o6i57Si5a62:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764908580&amp;x-signature=hbafmy5HgUU4NGSwSSUC6LQfBz8%3D" alt="SEO.jpg" loading="lazy"/></p>
<h2 data-id="heading-0">引言</h2>
<p>去年有个做手工的朋友小王跟我吐槽，说他花了三个月搭建了一个自己的作品展示网站，设计特别用心，产品照片也拍得很专业。结果呢？每个月访问量只有可怜的100多人，还有一大半是他自己点进去的。他当时特别沮丧，问我："是不是我的东西不够好？"</p>
<p>其实不是。我看了他的网站，发现问题根本不在内容质量，而是SEO做得太差了——更直白点说，搜索引擎根本找不到他的网站。后来我教他做了一些最基本的优化，两个月后月访问量涨到了接近10000。他兴奋地给我发消息："这SEO也太神了吧！"</p>
<p>说实话，SEO听起来挺高深，什么"爬虫"、"索引"、"权重"一堆专业术语。但我今天想告诉你的是：<strong>SEO其实没那么神秘，很多技巧今天学了明天就能用。</strong></p>
<p>这篇文章会用最接地气的话解释SEO是什么，然后给你5个配了真实案例的优化技巧。看完你就知道怎么让自己的网站在搜索结果里排得更靠前，还能避开3个新手最容易踩的坑。</p>
<h2 data-id="heading-1">SEO到底是什么？（白话解释）</h2>
<p>我们先不讲那些术语，我用个简单的比喻。</p>
<p>你去图书馆找书，是不是要么问管理员，要么查电脑目录？搜索引擎就像这个图书馆管理员，它的工作是帮用户找到最合适的"书"（网页）。那问题来了：凭什么把你的网页推荐给用户，而不是别人的？</p>
<p><strong>这就是SEO要解决的问题——让搜索引擎更容易"找到"和"推荐"你的内容。</strong></p>
<p>具体点说，当你在百度或Google搜索"北京好吃的火锅"，为什么海底捞、小龙坎这些餐厅排在前面？不只是因为它们有名，更重要的是它们的网站做了优化：标题写得清楚、内容详细、用户评价多、网站打开速度快。搜索引擎会根据这些信号判断："嗯，这家店应该比较靠谱，推荐给用户吧。"</p>
<p>Google在2022年更新了一个挺重要的标准，叫E-E-A-T。我第一次看到这四个字母也懵了，后来发现其实好理解：</p>
<ul>
<li><strong>Experience（经验）</strong>：你有没有真实体验过？比如你写"北京火锅推荐"，你真的去吃过吗？</li>
<li><strong>Expertise（专业）</strong>：你在这个领域懂不懂行？</li>
<li><strong>Authority（权威）</strong>：别人认不认可你？有没有其他网站链接到你的内容？</li>
<li><strong>Trust（可信度）</strong>：你的信息准确吗？有没有误导用户？</li>
</ul>
<p>我自己理解下来，就是一句话：<strong>搜索引擎现在越来越聪明，它要的是真正对用户有帮助的内容，而不是那些专门为了排名硬凑出来的文章。</strong></p>
<h2 data-id="heading-2">2025年最重要的SEO趋势</h2>
<p>老实讲，SEO这东西一直在变。我记得2020年的时候，还有人在拼命堆关键词，现在这招早就不管用了，反而会被搜索引擎惩罚。</p>
<p>2024年3月，Google做了一次挺大的核心更新，目标是减少40%的"垃圾内容"。什么叫垃圾内容？就是那种看起来像文章，但读起来完全没营养，纯粹为了凑字数的东西。这个更新之后，很多低质量的内容网站排名直接掉没了。</p>
<p>还有一个趋势你必须知道：<strong>网站速度现在成了排名因素</strong>。Google推出了一个叫Core Web Vitals的指标，听起来挺技术对吧？其实说白了就是衡量"你的网页卡不卡"。具体来说有三个指标：</p>
<ul>
<li><strong>LCP（最大内容绘制）</strong>：网页主要内容加载完成要多久？理想状态是2.5秒以内</li>
<li><strong>FID（首次交互延迟）</strong>：用户点击按钮后，网页反应快不快？应该在100毫秒以内</li>
<li><strong>CLS（累积布局偏移）</strong>：你有没有遇到过那种情况——刚想点个按钮，页面突然跳了一下，你点到广告上了？这就是布局偏移，越少越好</li>
</ul>
<p>我有个做电商的朋友，他的网站之前LCP是4.5秒，用户跳出率（就是打开后马上关掉的比例）高达62%。后来他优化了一下图片压缩，用了CDN（内容分发网络），LCP降到了2.1秒，跳出率直接降到35%，转化率提升了40%。你说这重不重要？</p>
<p>另外，AI对SEO的影响也越来越大。现在搜索引擎能更好地理解用户到底想要什么。比如你搜"怎么让孩子爱上阅读"，它不只是匹配关键词，而是真的理解你是个家长，想找实用的育儿方法。所以现在做内容，不能只想着塞关键词，要真的去解决用户的问题。</p>
<h2 data-id="heading-3">5个立即可用的SEO技巧（重点来了）</h2>
<h3 data-id="heading-4">技巧1：关键词不是"塞进去"的，是"融进去"的</h3>
<p>我见过太多新手犯这个错误了。我自己刚开始做网站那会儿，也以为SEO就是把关键词往文章里多塞几遍。结果呢？文章标题写成"SEO SEO SEO优化技巧大全"，读起来完全不通顺，用户看了就想关掉。</p>
<p><strong>正确的做法是什么？用长尾关键词，自然地融入内容。</strong></p>
<p>什么是长尾关键词？就是那种更具体、更长的搜索词。比如：</p>
<ul>
<li>大词："川菜"（竞争激烈，很难排上去）</li>
<li>长尾词："上班族15分钟能做的川菜家常菜"（竞争小，而且搜这个的人意图明确）</li>
</ul>
<p>我有个写美食的朋友，原来她的文章标题都是"川菜推荐"、"川菜做法"这种。后来改成"上班族15分钟能做的川菜家常菜"、"新手也能学会的麻婆豆腐"，结果流量涨了3倍。为什么？因为搜索这些长尾词的人，就是真的想学做菜的，而不是随便逛逛。</p>
<p>还有个概念叫"关键词集群"，听起来挺专业，其实就是一篇文章解决一类相关问题。比如你写"如何选购笔记本电脑"，文章里可以自然地涉及"学生笔记本推荐"、"游戏本性能对比"、"轻薄本续航测试"这些相关词。搜索引擎现在挺聪明，能理解这些词是相关的，会给你的文章更高的权重。</p>
<p><strong>错误做法</strong>：文章标题"SEO SEO SEO优化技巧"
<strong>正确做法</strong>：标题"新手网站没流量？这5个SEO技巧帮你解决"</p>
<p>看出区别了吗？第二个标题自然、有吸引力，而且解决了具体问题。关键词"SEO"和"优化"都在里面，但读起来完全不生硬。</p>
<h3 data-id="heading-5">技巧2：标题和描述，决定用户点不点你</h3>
<p>说真的，这个太重要了。</p>
<p>你的网站排在搜索结果第三位，但如果标题写得不吸引人，用户照样不点你，反而点了排第五的那个。这就是CTR（点击率）的作用。</p>
<p>我给你看个对比：</p>
<ul>
<li><strong>普通标题</strong>："Python教程"</li>
<li><strong>优化后</strong>："Python入门教程：3天学会写第一个爬虫程序"</li>
</ul>
<p>哪个更吸引你？肯定是第二个对吧。因为它告诉你：1）适合入门新手；2）只需要3天；3）能学会具体的东西（爬虫）。</p>
<p>有个数据我印象特别深：某个技术博客把标题从"JavaScript基础"改成"JavaScript零基础教程：7天从入门到做出第一个网页"，CTR从1.5%直接跳到6.2%，排名还提升了。</p>
<p><strong>那怎么写好标题呢？我的经验是：</strong></p>
<ol>
<li>包含核心关键词（让搜索引擎知道你讲什么）</li>
<li>说明具体价值（用户能得到什么）</li>
<li>最好有数字（3个方法、5个技巧，人对数字特别敏感）</li>
<li>不要超过60个字符（太长会被截断）</li>
</ol>
<p>Meta Description（就是搜索结果下面的那段描述文字）也一样重要。很多人不写，让搜索引擎自己抓取，结果抓的内容乱七八糟。你应该自己写一段150字左右的描述，总结文章核心价值，同时自然地包含关键词。</p>
<h3 data-id="heading-6">技巧3：内容质量 &gt; 内容数量（10X内容策略）</h3>
<p>我之前也陷入过误区，觉得文章越多越好，一天发三篇。结果呢？每篇都写得很浅，用户看了没收获，排名也上不去。</p>
<p>后来我了解到一个概念叫"10X内容"——就是<strong>比竞争对手好10倍的内容</strong>。听起来夸张对吧？但这是真的有效。</p>
<p>举个例子。假设你要写"如何选购笔记本电脑"，你搜一下这个关键词，看看排名前面的文章都写了什么。</p>
<ul>
<li><strong>A文章</strong>：500字，泛泛而谈"要看处理器、内存、硬盘"，没有具体型号推荐</li>
<li><strong>B文章</strong>：3000字，包含15款笔记本实测数据、详细的价格对比表、按使用场景（学生、设计、游戏）分类推荐，还有购买避坑指南</li>
</ul>
<p>你觉得哪个会排名更高？肯定是B对吧。事实也是这样，我观察了很多竞争激烈的关键词，排在第一页的几乎都是这种深度长文。</p>
<p><strong>什么是好内容？我的理解是：</strong></p>
<ol>
<li><strong>深度</strong>：不只停留在表面，深入讲清楚原理和细节</li>
<li><strong>实用</strong>：有具体的操作步骤、数据对比、工具推荐</li>
<li><strong>独特</strong>：有你自己的经验和见解，不是复制粘贴别人的内容</li>
</ol>
<p>我自己写文章的时候，会先搜索这个关键词，看排名前10的文章都讲了什么，然后问自己："我能提供什么他们没有的价值？"可能是更新的数据、更详细的案例，或者是自己的实践经验。</p>
<p>记住：<strong>宁可一个月出一篇高质量文章，也不要一周出七篇水文。</strong></p>
<h3 data-id="heading-7">技巧4：外链不是买的，是"赚"来的</h3>
<p>外链这个东西，很多人理解错了。</p>
<p>我刚开始的时候，看到一些服务商说"花1000块给你100个外链"，我还心动了。幸好我没买，后来才知道那些垃圾外链不仅没用，反而可能害你被搜索引擎惩罚。</p>
<p>**什么是高质量外链？**就是有权威的网站主动链接到你的内容，因为你的内容确实有价值。</p>
<p>比如，某个行业研究机构发布了一份独家的市场分析报告，数据详实、观点独到。结果有50多个行业网站、新闻媒体引用了这份报告，并且附上了来源链接。这50个外链的价值，远远超过你花钱买的1000个垃圾链接。</p>
<p><strong>那怎么"赚"到外链呢？</strong></p>
<ol>
<li><strong>做真正有价值的内容</strong>：行业报告、深度教程、实用工具，这些东西别人自然会想分享</li>
<li><strong>客座博客</strong>：在相关领域的知名博客上发文章，署名里带上你网站的链接</li>
<li><strong>行业合作</strong>：跟同行互换优质资源，前提是双方内容相关且质量都过关</li>
<li><strong>社交媒体传播</strong>：LinkedIn、Facebook、知乎这些平台也能带来流量，而且有些平台的链接权重还不错</li>
</ol>
<p>我有个朋友做了一个特别实用的Excel模板工具，免费分享出来，结果被很多办公类公众号、知乎专栏引用，自然带来了几百个外链，网站权重噌噌往上涨。</p>
<p><strong>避坑指南</strong>：千万别花钱买那种批量外链服务。搜索引擎现在能识别出来，一旦被发现，你的网站可能直接被降权。</p>
<h3 data-id="heading-8">技巧5：技术优化，让网站"跑得快"</h3>
<p>这个技巧说起来有点技术，但其实操作起来不难。</p>
<p>我前面提到过，网站速度现在是排名因素。你想啊，用户打开一个网页，等了10秒还在加载，早就烦了关掉了。Google的数据显示，网页加载时间每增加1秒，转化率下降7%。</p>
<p><strong>你可以做这几件事：</strong></p>
<ol>
<li>
<p><strong>压缩图片</strong>：这个最简单也最有效。很多人上传图片都是原图，一张5MB，网页当然慢。用TinyPNG这种工具压缩一下，画质基本没影响，大小能减少70%</p>
</li>
<li>
<p><strong>使用CDN</strong>：CDN就是内容分发网络，简单说就是把你的网站内容分布到全国各地的服务器上。用户访问的时候，自动从最近的服务器加载，速度当然快</p>
</li>
<li>
<p><strong>减少JS和CSS文件</strong>：如果你用WordPress或者其他建站工具，很可能加载了一堆用不到的脚本文件。用一些优化插件可以合并、压缩这些文件</p>
</li>
<li>
<p><strong>移动端适配</strong>：现在超过60%的流量来自手机，如果你的网站在手机上显示错乱、按钮点不到，用户体验差，排名肯定上不去</p>
</li>
</ol>
<p>我之前帮一个做教育的朋友优化过网站。他的网站之前LCP（最大内容绘制时间）是4.5秒，用户跳出率62%。我们做了这些优化：把首页的大图从3MB压缩到500KB，换了个更快的主机，用上了CDN，结果LCP降到2.1秒，跳出率降到35%，最关键的是转化率提升了40%。</p>
<p><strong>你不需要是技术大神，就用这个简单的检查清单：</strong></p>
<ul>
<li>✓ 所有图片都压缩了吗？</li>
<li>✓ 网站在手机上显示正常吗？</li>
<li>✓ 首页加载时间在3秒以内吗？（用Google PageSpeed Insights测一下）</li>
<li>✓ 有没有死链接或404错误页面？</li>
</ul>
<p>这些做好了，你的技术SEO基本就及格了。</p>
<h2 data-id="heading-9">新手最容易踩的3个坑</h2>
<p>说了这么多技巧，我还想提醒你三个常见的错误，我自己当初也踩过。</p>
<h3 data-id="heading-10">坑1：过度优化（关键词堆砌）</h3>
<p>有个做护肤品的老板，听说SEO重要，就把关键词往文章里猛塞。标题是"护肤品护肤品推荐最好的护肤品"，文章每两句话就出现一次"护肤品"。结果呢？网站被Google降权了，排名从第一页直接掉到找不着。</p>
<p>**记住：关键词密度控制在2-3%就够了，最重要的是自然。**如果你读着都觉得别扭，搜索引擎肯定也觉得不对劲。</p>
<h3 data-id="heading-11">坑2：忽视用户体验，只为SEO而SEO</h3>
<p>我见过一些文章，明明是写给搜索引擎看的，不是给人看的。通篇都是关键词和术语，读起来像机器人写的，完全没有可读性。</p>
<p>这就本末倒置了。**SEO的最终目的是什么？是让真实的用户找到你的内容，并且觉得有用。**如果用户点进来看了10秒就关掉，跳出率高得吓人，搜索引擎会判断"这内容不行"，你的排名照样掉。</p>
<p>所以我的建议是：**先写给人看，再考虑SEO。**写完之后再自然地优化一下关键词、标题，而不是为了SEO牺牲可读性。</p>
<h3 data-id="heading-12">坑3：期望立竿见影</h3>
<p>这个我太理解了。我刚开始做SEO的时候，优化了一周，天天去查排名，发现一点变化都没有，就开始怀疑"是不是方法不对？"</p>
<p>后来我了解到，**SEO是长期投资，通常需要3-6个月才能看到明显效果。**这不是一个快速见效的东西。你今天发了一篇文章，搜索引擎要先爬取、索引、评估，然后慢慢调整排名。</p>
<p>我的建议是：**制定一个至少3个月的SEO计划，持续优化，别急着看短期结果。**很多人就是因为太急，一两周没效果就放弃了，太可惜。</p>
<h2 data-id="heading-13">总结一下</h2>
<p>说了这么多，我们回顾一下这5个技巧：</p>
<ol>
<li><strong>关键词要"融进去"</strong>：用长尾关键词，自然地融入内容，别硬塞</li>
<li><strong>标题和描述很关键</strong>：决定用户点不点你，要写得有吸引力</li>
<li><strong>质量大于数量</strong>：一篇10X内容胜过十篇水文</li>
<li><strong>外链要"赚"来的</strong>：做有价值的内容，让别人主动链接你</li>
<li><strong>技术优化要做好</strong>：网站速度、移动端适配，这些基础必须有</li>
</ol>
<p>**SEO是个持续优化的过程，不是一次性工程。**但好消息是，你不需要一次性做完所有事情。从最简单的开始：</p>
<ul>
<li>今天就检查一下你的网站标题是否优化了</li>
<li>用Google Search Console（免费工具）看看自己的网站数据</li>
<li>优先做好这3件事：关键词、标题、内容质量</li>
</ul>
<p>如果你现在还没有网站也没关系，把这些概念记住，等你开始做内容的时候，从第一篇文章就把SEO考虑进去，比后期再补救容易多了。</p>
<p>最后想说，SEO没有想象中那么难，也没有捷径。踏踏实实做好内容，用心优化细节，3个月后你回头看，一定会发现变化。</p>
<p>你现在就可以动手试试，挑一个你最想优化的页面，用今天学到的技巧改一改。有问题随时交流，我也一直在学习和实践中。加油！</p>
<blockquote>
<p>本文首发自<a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.betterlink.top%2Fzh%2F" target="_blank" title="https://blog.betterlink.top/zh/" ref="nofollow noopener noreferrer">个人博客</a></p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[package.json 配置指南]]></title>    <link>https://juejin.cn/post/7577364921656393770</link>    <guid>https://juejin.cn/post/7577364921656393770</guid>    <pubDate>2025-11-28T03:21:37.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577364921656393770" data-draft-id="7577332659506118699" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="package.json 配置指南"/> <meta itemprop="keywords" content="前端,JavaScript,Node.js"/> <meta itemprop="datePublished" content="2025-11-28T03:21:37.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="颜酱"/> <meta itemprop="url" content="https://juejin.cn/user/905653309941495"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            package.json 配置指南
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/905653309941495/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    颜酱
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-28T03:21:37.000Z" title="Fri Nov 28 2025 03:21:37 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-28
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读14分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">package.json 配置指南</h2>
<p>package.json 是 npm 项目的核心配置文件，定义了项目的基本信息、依赖关系和脚本命令。</p>
<h3 data-id="heading-1">📑 目录</h3>
<ul>
<li><a href="#%E5%BF%AB%E9%80%9F%E5%8F%82%E8%80%83" title="#%E5%BF%AB%E9%80%9F%E5%8F%82%E8%80%83">快速参考</a></li>
<li><a href="#%E9%A1%B9%E7%9B%AE%E5%88%86%E7%B1%BB" title="#%E9%A1%B9%E7%9B%AE%E5%88%86%E7%B1%BB">项目分类</a></li>
<li><a href="#%E7%AC%AC%E4%B8%80%E9%83%A8%E5%88%86%E5%9F%BA%E7%A1%80%E5%AD%97%E6%AE%B5%E8%AF%A6%E8%A7%A3" title="#%E7%AC%AC%E4%B8%80%E9%83%A8%E5%88%86%E5%9F%BA%E7%A1%80%E5%AD%97%E6%AE%B5%E8%AF%A6%E8%A7%A3">第一部分：基础字段详解</a>
<ul>
<li><a href="#%E9%80%9A%E7%94%A8%E5%9F%BA%E7%A1%80%E5%AD%97%E6%AE%B5" title="#%E9%80%9A%E7%94%A8%E5%9F%BA%E7%A1%80%E5%AD%97%E6%AE%B5">通用基础字段</a></li>
<li><a href="#%E5%BA%94%E7%94%A8%E9%A1%B9%E7%9B%AE%E4%B8%93%E7%94%A8%E5%AD%97%E6%AE%B5" title="#%E5%BA%94%E7%94%A8%E9%A1%B9%E7%9B%AE%E4%B8%93%E7%94%A8%E5%AD%97%E6%AE%B5">应用项目专用字段</a></li>
<li><a href="#npm-%E5%8C%85%E4%B8%93%E7%94%A8%E5%AD%97%E6%AE%B5" title="#npm-%E5%8C%85%E4%B8%93%E7%94%A8%E5%AD%97%E6%AE%B5">npm 包专用字段</a></li>
</ul>
</li>
<li><a href="#%E7%AC%AC%E4%BA%8C%E9%83%A8%E5%88%86%E6%8C%89%E9%A1%B9%E7%9B%AE%E7%B1%BB%E5%9E%8B%E9%85%8D%E7%BD%AE" title="#%E7%AC%AC%E4%BA%8C%E9%83%A8%E5%88%86%E6%8C%89%E9%A1%B9%E7%9B%AE%E7%B1%BB%E5%9E%8B%E9%85%8D%E7%BD%AE">第二部分：按项目类型配置</a>
<ul>
<li><a href="#%E5%BA%94%E7%94%A8%E9%A1%B9%E7%9B%AE%E9%85%8D%E7%BD%AE" title="#%E5%BA%94%E7%94%A8%E9%A1%B9%E7%9B%AE%E9%85%8D%E7%BD%AE">应用项目配置</a></li>
<li><a href="#%E5%B7%A5%E5%85%B7%E5%BA%93%E9%85%8D%E7%BD%AE" title="#%E5%B7%A5%E5%85%B7%E5%BA%93%E9%85%8D%E7%BD%AE">工具库配置</a></li>
<li><a href="#cli-%E5%B7%A5%E5%85%B7%E9%85%8D%E7%BD%AE" title="#cli-%E5%B7%A5%E5%85%B7%E9%85%8D%E7%BD%AE">CLI 工具配置</a></li>
<li><a href="#ui-%E7%BB%84%E4%BB%B6%E5%BA%93%E9%85%8D%E7%BD%AE" title="#ui-%E7%BB%84%E4%BB%B6%E5%BA%93%E9%85%8D%E7%BD%AE">UI 组件库配置</a></li>
<li><a href="#hooks-%E5%BA%93%E9%85%8D%E7%BD%AE" title="#hooks-%E5%BA%93%E9%85%8D%E7%BD%AE">Hooks 库配置</a></li>
</ul>
</li>
<li><a href="#%E7%AC%AC%E4%B8%89%E9%83%A8%E5%88%86%E8%BF%9B%E9%98%B6%E5%86%85%E5%AE%B9" title="#%E7%AC%AC%E4%B8%89%E9%83%A8%E5%88%86%E8%BF%9B%E9%98%B6%E5%86%85%E5%AE%B9">第三部分：进阶内容</a>
<ul>
<li><a href="#npm-%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E8%84%9A%E6%9C%AC" title="#npm-%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E8%84%9A%E6%9C%AC">npm 生命周期脚本</a></li>
<li><a href="#npx-%E4%BD%BF%E7%94%A8%E6%8C%87%E5%8D%97" title="#npx-%E4%BD%BF%E7%94%A8%E6%8C%87%E5%8D%97">npx 使用指南</a></li>
</ul>
</li>
<li><a href="#%E9%99%84%E5%BD%95" title="#%E9%99%84%E5%BD%95">附录</a>
<ul>
<li><a href="#%E9%85%8D%E7%BD%AE%E6%A8%A1%E6%9D%BF%E6%B1%87%E6%80%BB" title="#%E9%85%8D%E7%BD%AE%E6%A8%A1%E6%9D%BF%E6%B1%87%E6%80%BB">配置模板汇总</a></li>
<li><a href="#%E5%AD%97%E6%AE%B5%E9%80%9F%E6%9F%A5%E8%A1%A8" title="#%E5%AD%97%E6%AE%B5%E9%80%9F%E6%9F%A5%E8%A1%A8">字段速查表</a></li>
</ul>
</li>
</ul>
<hr/>
<h3 data-id="heading-2">快速参考</h3>
<h4 data-id="heading-3">字段配置速查表</h4>





























































<table><thead><tr><th>字段</th><th>应用项目</th><th>工具库</th><th>CLI工具</th><th>组件库</th><th>Hooks库</th></tr></thead><tbody><tr><td><code>private</code></td><td>✅ 必填</td><td>❌</td><td>❌</td><td>❌</td><td>❌</td></tr><tr><td><code>bin</code></td><td>❌</td><td>❌</td><td>✅ 必填</td><td>❌</td><td>❌</td></tr><tr><td><code>peerDependencies</code></td><td>❌</td><td>❌</td><td>❌</td><td>✅ 必填</td><td>✅ 必填</td></tr><tr><td><code>sideEffects</code></td><td>-</td><td><code>false</code></td><td><code>false</code></td><td><code>["*.css"]</code></td><td><code>false</code></td></tr><tr><td><code>exports</code></td><td>❌</td><td>✅ 推荐</td><td>✅ 推荐</td><td>✅ 推荐</td><td>✅ 推荐</td></tr><tr><td><code>main</code> + <code>module</code> + <code>types</code></td><td>❌</td><td>✅ 必填</td><td>✅ 必填</td><td>✅ 必填</td><td>✅ 必填</td></tr></tbody></table>
<h4 data-id="heading-4">配置选择决策树</h4>
<pre><code class="hljs language-text" lang="text">是否需要发布到 npm？
├─ 否 → 应用项目配置（private: true）
└─ 是 → 是否包含可执行命令？
    ├─ 是 → CLI 工具配置（bin 字段）
    └─ 否 → 是否依赖框架（React/Vue）？
        ├─ 是 → 是否为组件？
        │   ├─ 是 → UI 组件库配置（peerDependencies + sideEffects: ["*.css"]）
        │   └─ 否 → Hooks 库配置（peerDependencies + sideEffects: false）
        └─ 否 → 工具库配置（sideEffects: false）
</code></pre>
<h4 data-id="heading-5">快速配置模板链接</h4>
<p>以下，仅供参考</p>
<ul>
<li><a href="#%E5%BA%94%E7%94%A8%E9%A1%B9%E7%9B%AE%E9%85%8D%E7%BD%AE%E6%A8%A1%E6%9D%BF" title="#%E5%BA%94%E7%94%A8%E9%A1%B9%E7%9B%AE%E9%85%8D%E7%BD%AE%E6%A8%A1%E6%9D%BF">应用项目模板</a></li>
<li><a href="#%E5%B7%A5%E5%85%B7%E5%BA%93%E9%85%8D%E7%BD%AE%E6%A8%A1%E6%9D%BF" title="#%E5%B7%A5%E5%85%B7%E5%BA%93%E9%85%8D%E7%BD%AE%E6%A8%A1%E6%9D%BF">工具库模板</a></li>
<li><a href="#cli-%E5%B7%A5%E5%85%B7%E9%85%8D%E7%BD%AE%E6%A8%A1%E6%9D%BF" title="#cli-%E5%B7%A5%E5%85%B7%E9%85%8D%E7%BD%AE%E6%A8%A1%E6%9D%BF">CLI 工具模板</a></li>
<li><a href="#ui-%E7%BB%84%E4%BB%B6%E5%BA%93%E9%85%8D%E7%BD%AE%E6%A8%A1%E6%9D%BF" title="#ui-%E7%BB%84%E4%BB%B6%E5%BA%93%E9%85%8D%E7%BD%AE%E6%A8%A1%E6%9D%BF">UI 组件库模板</a></li>
<li><a href="#hooks-%E5%BA%93%E9%85%8D%E7%BD%AE%E6%A8%A1%E6%9D%BF" title="#hooks-%E5%BA%93%E9%85%8D%E7%BD%AE%E6%A8%A1%E6%9D%BF">Hooks 库模板</a></li>
</ul>
<hr/>
<h3 data-id="heading-6">项目分类</h3>
<p>前端项目按发布方式分类：</p>
<ul>
<li><strong>应用项目（Application）</strong>：不发布到 npm，如 Web 应用、移动端应用、桌面应用</li>
<li><strong>npm 包（Package/Library）</strong>：发布到 npm，供他人使用
<ul>
<li><strong>工具库（Utility Library）</strong>：纯函数库，如 lodash、dayjs、axios</li>
<li><strong>CLI 工具（CLI Tool）</strong>：命令行工具，如 create-react-app、vite、eslint</li>
<li><strong>UI 组件库（Component Library）</strong>：React/Vue 组件库，如 antd、element-ui、shadcn/ui</li>
<li><strong>Hooks 库（Hooks Library）</strong>：React Hooks 集合，如 ahooks、react-use</li>
</ul>
</li>
</ul>
<hr/>
<h3 data-id="heading-7">第一部分：基础字段详解</h3>
<h4 data-id="heading-8">通用基础字段</h4>
<p>以下字段是所有项目的基础配置，确保项目可识别、可依赖：</p>











































































<table><thead><tr><th>字段名</th><th>作用说明</th><th>示例</th></tr></thead><tbody><tr><td><code>name</code></td><td>项目名称（npm 包需唯一，不能包含大写字母、空格，建议用 kebab-case）</td><td><code>"name": "my-web-app"</code>（应用）<br/><code>"name": "utils-tool"</code>（npm 包）</td></tr><tr><td><code>version</code></td><td>版本号（npm 包必填，遵循语义化版本：MAJOR.MINOR.PATCH）</td><td><code>"version": "1.0.0"</code>（首次发布）<br/><code>"version": "2.1.3-beta.1"</code>（测试版）</td></tr><tr><td><code>description</code></td><td>项目描述（npm 包必填，帮助用户理解用途，影响 npm 搜索）</td><td><code>"description": "A lightweight date processing tool"</code></td></tr><tr><td><code>author</code></td><td>作者信息（姓名、邮箱、主页可选）</td><td><code>"author": "John &lt;john@example.com&gt; (https://john.dev)"</code></td></tr><tr><td><code>license</code></td><td>开源协议（npm 包建议填写，如 MIT、Apache-2.0；应用可省略或填 UNLICENSED）</td><td><code>"license": "MIT"</code>（npm 包）<br/><code>"license": "UNLICENSED"</code>（私有应用）</td></tr><tr><td><code>keywords</code></td><td>关键词（npm 包必填，提升搜索曝光；应用可选）</td><td><code>"keywords": ["date", "format", "utils", "browser"]</code></td></tr><tr><td><code>homepage</code></td><td>项目主页（npm 包建议填写，如 GitHub 仓库地址、文档地址）</td><td><code>"homepage": "https://github.com/username/utils-tool#readme"</code></td></tr><tr><td><code>repository</code></td><td>代码仓库地址（npm 包必填，方便用户贡献代码）</td><td><code>"repository": { "type": "git", "url": "git+https://github.com/username/utils-tool.git" }</code></td></tr><tr><td><code>bugs</code></td><td>问题反馈地址（npm 包建议填写，如 GitHub Issues）</td><td><code>"bugs": "https://github.com/username/utils-tool/issues"</code></td></tr><tr><td><code>engines</code></td><td>声明依赖的 Node.js/npm 版本（避免环境兼容问题）</td><td><code>"engines": { "node": "&gt;=16.0.0", "npm": "&gt;=8.0.0" }</code></td></tr><tr><td><code>type</code></td><td>模块类型（Node.js 14.13+ 支持，默认 commonjs，ES 模块需显式设为 module）</td><td><code>"type": "module"</code></td></tr><tr><td><code>publishConfig</code></td><td>发布配置（如指定 npm 源、访问权限）</td><td><code>"publishConfig": { "registry": "https://registry.npmjs.org/", "access": "public" }</code></td></tr><tr><td><code>files</code></td><td>发布到 npm 的文件 / 目录（指定需要上传的内容，避免冗余文件）</td><td><code>"files": ["dist", "README.md", "package.json"]</code>（排除 node_modules、.git 等）</td></tr></tbody></table>
<h4 data-id="heading-9">应用项目专用字段</h4>
<p>应用项目（如 Web 应用、React/Vue 项目、Electron 桌面应用）不发布到 npm，核心关注依赖管理、脚本命令、构建配置：</p>























































<table><thead><tr><th>字段名</th><th>作用说明</th><th>示例</th></tr></thead><tbody><tr><td><code>dependencies</code></td><td>生产环境依赖（项目运行必需，如 react、vue、axios）</td><td><code>"dependencies": { "react": "^18.2.0", "axios": "^1.6.0" }</code></td></tr><tr><td><code>devDependencies</code></td><td>开发环境依赖（构建、测试、代码检查等，如 webpack、babel、jest）</td><td><code>"devDependencies": { "webpack": "^5.88.0", "jest": "^29.7.0" }</code></td></tr><tr><td><code>scripts</code></td><td>自定义脚本命令（启动、构建、测试、部署等，核心字段）</td><td><code>"scripts": { "start": "vite", "build": "vite build", "test": "jest", "lint": "eslint src" }</code></td></tr><tr><td><code>main</code></td><td>应用入口文件（Node.js 应用必填，如 Express 后端；前端应用可省略，由构建工具指定）</td><td><code>"main": "src/index.js"</code>（Node.js 后端应用）</td></tr><tr><td><code>browserslist</code></td><td>浏览器兼容目标（前端应用常用，配合 babel、autoprefixer 等工具）</td><td><code>"browserslist": ["last 2 versions", "not dead", "iOS &gt;= 12"]</code></td></tr><tr><td><code>proxy</code></td><td>开发环境跨域代理（React/Vue 等前端框架常用，简化跨域配置）</td><td><code>"proxy": "https://api.example.com"</code></td></tr><tr><td><code>private</code></td><td>标记为私有项目（防止误发布到 npm，前端应用强烈建议设置）</td><td><code>"private": true</code></td></tr><tr><td><code>workspaces</code></td><td>monorepo 项目配置（管理多子包，如前端 + 后端 + 组件库放在同一仓库）</td><td><code>"workspaces": ["packages/*", "apps/*"]</code></td></tr><tr><td><code>config</code></td><td>自定义脚本配置（可在 scripts 中通过 npm_config_xxx 读取）</td><td><code>"config": { "port": 3000 }</code>（脚本中用 <code>$npm_config_port</code> 获取）</td></tr></tbody></table>
<h4 data-id="heading-10">npm 包专用字段</h4>
<p>npm 包需发布到 npm 供他人使用，核心关注入口文件、导出规范、兼容性、发布配置：</p>




























































<table><thead><tr><th>字段名</th><th>作用说明</th><th>示例</th></tr></thead><tbody><tr><td><code>main</code></td><td>主入口文件（CommonJS 模块，require 时默认加载）</td><td><code>"main": "dist/index.cjs"</code></td></tr><tr><td><code>module</code></td><td>ES 模块入口（支持 tree-shaking，webpack/rollup 优先加载）</td><td><code>"module": "dist/index.esm.js"</code></td></tr><tr><td><code>browser</code></td><td>浏览器环境入口（区分 Node.js 和浏览器差异，如避免加载 fs 模块）</td><td><code>"browser": "dist/index.browser.js"</code></td></tr><tr><td><code>exports</code></td><td>条件导出（Node.js 12+ 支持，精确控制不同环境的入口，替代 main/module/browser）</td><td><code>"exports": { ".": { "import": "./dist/index.esm.js", "require": "./dist/index.cjs", "browser": "./dist/index.browser.js" }, "./utils": "./dist/utils.esm.js" }</code></td></tr><tr><td><code>types</code> / <code>typings</code></td><td>TypeScript 类型声明文件（TS 项目必填，提供类型提示）</td><td><code>"types": "dist/index.d.ts"</code></td></tr><tr><td><code>bin</code></td><td>CLI 工具入口（仅 CLI 类型 npm 包必填，映射命令到执行文件）</td><td><code>"bin": { "my-cli": "./dist/cli.js" }</code>（用户安装后可直接执行 my-cli）</td></tr><tr><td><code>peerDependencies</code></td><td>对等依赖（声明与宿主环境的兼容版本，如 React 组件库依赖 React）</td><td><code>"peerDependencies": { "react": "&gt;=16.8.0", "react-dom": "&gt;=16.8.0" }</code></td></tr><tr><td><code>peerDependenciesMeta</code></td><td>对等依赖可选配置（标记某些 peerDependency 为可选）</td><td><code>"peerDependenciesMeta": { "vue": { "optional": true } }</code></td></tr><tr><td><code>optionalDependencies</code></td><td>可选依赖（缺失时不影响项目运行，如可选的性能优化模块）</td><td><code>"optionalDependencies": { "lodash-es": "^4.17.0" }</code></td></tr><tr><td><code>sideEffects</code></td><td>标记包是否有副作用（Tree-shaking 优化）</td><td><code>"sideEffects": false</code>（纯工具库）<br/><code>"sideEffects": ["*.css"]</code>（组件库样式文件）</td></tr></tbody></table>
<p><strong>字段优先级</strong>：<code>exports</code>（最高）→ <code>module</code> → <code>main</code> → <code>types</code>（独立）</p>
<p><strong>推荐配置</strong>：同时配置所有字段，确保最大兼容性。</p>
<hr/>
<h3 data-id="heading-11">第二部分：按项目类型配置</h3>
<h4 data-id="heading-12">应用项目配置</h4>
<p><strong>适用场景</strong>：Web 应用、移动端应用、桌面应用、企业内部项目、个人项目（不发布到 npm）</p>
<p><strong>核心字段</strong>：基础字段 + scripts + dependencies + private</p>
<h5 data-id="heading-13">配置模板</h5>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"my-web-app"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"version"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"1.0.0"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"description"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"我的 Web 应用"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"private"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"scripts"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"dev"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"vite"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"build"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"vite build"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"preview"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"vite preview"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"test"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"vitest run"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"lint"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"eslint src"</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"dependencies"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"react"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"^18.2.0"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"react-dom"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"^18.2.0"</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"devDependencies"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"vite"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"^5.0.0"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"@types/react"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"^18.2.0"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"vitest"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"^2.0.5"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"eslint"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"^8.50.0"</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"engines"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"node"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"&gt;=18.0.0"</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"packageManager"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"pnpm@9.0.0"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"browserslist"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"last 2 versions"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"not dead"</span><span class="hljs-punctuation">]</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p><strong>关键配置说明</strong>：</p>
<ul>
<li>✅ <strong>private: true</strong>：防止误发布到 npm</li>
<li>✅ <strong>scripts</strong>：定义开发、构建、预览等命令</li>
<li>✅ <strong>packageManager</strong>：锁定包管理器版本，确保团队一致</li>
<li>❌ 无需配置 <code>files</code>、<code>exports</code>、<code>main</code> 等发布相关字段</li>
<li>❌ 无需配置 <code>repository</code>、<code>bugs</code>、<code>homepage</code> 等公开信息</li>
</ul>
<hr/>
<h4 data-id="heading-14">工具库配置</h4>
<p><strong>适用场景</strong>：纯函数库、工具类库、不依赖框架的 JS/TS 库，如 lodash、dayjs、axios</p>
<p><strong>核心字段</strong>：双模式入口 + sideEffects: false + files</p>
<h5 data-id="heading-15">配置模板</h5>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"my-utils"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"version"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"1.0.0"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"description"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"实用的工具函数库"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"keywords"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"utils"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"helpers"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"tools"</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"author"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"张三 &lt;zhangsan@xxx.com&gt;"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"license"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"MIT"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"module"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"exports"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"."</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"import"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"./dist/index.js"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"require"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"./dist/index.cjs"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"types"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"./dist/index.d.ts"</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"main"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"./dist/index.cjs"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"module"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"./dist/index.js"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"types"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"./dist/index.d.ts"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"files"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"dist"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"README.md"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"LICENSE"</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"sideEffects"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">false</span></span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"scripts"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"build"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"tsup"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"dev"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"tsup --watch"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"test"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"vitest run"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"prepublishOnly"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"npm run build"</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"devDependencies"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"tsup"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"^8.3.0"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"typescript"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"^5.5.4"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"vitest"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"^2.0.5"</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"engines"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"node"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"&gt;=14.0.0"</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"repository"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"git"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"url"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"https://github.com/xxx/my-utils.git"</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"bugs"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"https://github.com/xxx/my-utils/issues"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"homepage"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"https://github.com/xxx/my-utils#readme"</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p><strong>关键配置说明</strong>：</p>
<ul>
<li>✅ <strong>exports + main + module + types</strong>：双模式兼容，确保新旧工具都能使用</li>
<li>✅ <strong>sideEffects: false</strong>：纯函数库无副作用，支持 Tree-shaking</li>
<li>✅ <strong>files</strong>：仅发布 dist 目录，减小包体积</li>
<li>✅ <strong>prepublishOnly</strong>：发布前自动构建，避免忘记打包</li>
</ul>
<h5 data-id="heading-16">实际案例要点：Axios</h5>
<p><strong>核心设计</strong>：</p>
<ul>
<li>跨环境适配：通过 <code>exports</code> 区分 browser/node/react-native</li>
<li>类型支持：区分 CJS/ESM 类型声明</li>
<li>Tree-shaking：<code>sideEffects: false</code></li>
</ul>
<p><strong>关键配置</strong>：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"exports"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"."</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"browser"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span> <span class="hljs-attr">"require"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"./dist/browser/axios.cjs"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"default"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"./index.js"</span> <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"default"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span> <span class="hljs-attr">"require"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"./dist/node/axios.cjs"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"default"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"./index.js"</span> <span class="hljs-punctuation">}</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"sideEffects"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">false</span></span>
<span class="hljs-punctuation">}</span>
</code></pre>
<hr/>
<h4 data-id="heading-17">CLI 工具配置</h4>
<p><strong>适用场景</strong>：命令行工具、脚手架工具，如 create-react-app、vite、eslint</p>
<p><strong>核心字段</strong>：bin + preferGlobal + shebang</p>
<h5 data-id="heading-18">配置模板</h5>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"my-cli"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"version"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"1.0.0"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"description"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"命令行工具"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"keywords"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"cli"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"command-line"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"tool"</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"author"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"张三 &lt;zhangsan@xxx.com&gt;"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"license"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"MIT"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"module"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"exports"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"."</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"import"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"./dist/index.js"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"require"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"./dist/index.cjs"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"types"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"./dist/index.d.ts"</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"main"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"./dist/index.cjs"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"module"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"./dist/index.js"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"types"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"./dist/index.d.ts"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"bin"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"my-cli"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"./dist/cli.js"</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"preferGlobal"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"files"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"dist"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"templates"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"README.md"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"LICENSE"</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"sideEffects"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">false</span></span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"scripts"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"build"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"tsup"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"dev"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"tsup --watch"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"test"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"vitest run"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"prepublishOnly"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"npm run build"</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"dependencies"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"commander"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"^11.1.0"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"inquirer"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"^8.2.6"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"chalk"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"^4.1.2"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"fs-extra"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"^11.2.0"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"handlebars"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"^4.7.8"</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"devDependencies"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"tsup"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"^8.3.0"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"typescript"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"^5.5.4"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"vitest"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"^2.0.5"</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"engines"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"node"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"&gt;=14.0.0"</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"repository"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"git"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"url"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"https://github.com/xxx/my-cli.git"</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"bugs"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"https://github.com/xxx/my-cli/issues"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"homepage"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"https://github.com/xxx/my-cli#readme"</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p><strong>关键配置说明</strong>：</p>
<ul>
<li>✅ <strong>bin</strong>：必须配置，映射命令名到入口文件</li>
<li>✅ <strong>preferGlobal: true</strong>：提示用户全局安装（可选）</li>
<li>✅ <strong>入口文件需添加 Shebang</strong>：<code>#!/usr/bin/env node</code>（tsup 打包时可通过 <code>shebang: true</code> 自动添加）</li>
<li>✅ <strong>files 包含 templates</strong>：如果 CLI 工具包含模板文件，需在 files 中声明</li>
<li>✅ <strong>dependencies 包含 CLI 相关库</strong>：commander、inquirer、chalk 等</li>
</ul>
<h5 data-id="heading-19">实际案例要点：Vite</h5>
<p><strong>核心设计</strong>：</p>
<ul>
<li>monorepo 架构：根包管理工程化，子包专注功能</li>
<li>模块规范统一：<code>type: module</code>，统一使用 ESM</li>
<li>多包协作：通过 pnpm workspace 实现版本联动</li>
</ul>
<p><strong>关键配置</strong>：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"private"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"module"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"packageManager"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"pnpm@10.23.0"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"workspaces"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"packages/*"</span><span class="hljs-punctuation">]</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<hr/>
<h4 data-id="heading-20">UI 组件库配置</h4>
<p><strong>适用场景</strong>：React/Vue 组件库、UI 组件库，如 antd、element-ui、shadcn/ui</p>
<p><strong>核心字段</strong>：peerDependencies + sideEffects（样式）+ 样式导出</p>
<h5 data-id="heading-21">配置模板</h5>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"my-components"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"version"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"1.0.0"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"description"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"React 组件库"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"keywords"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"react"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"components"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"ui"</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"author"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"张三 &lt;zhangsan@xxx.com&gt;"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"license"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"MIT"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"exports"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"."</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"import"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"./dist/index.js"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"require"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"./dist/index.cjs"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"types"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"./dist/index.d.ts"</span>
    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"./style.css"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"./dist/style.css"</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"main"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"./dist/index.cjs"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"module"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"./dist/index.js"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"types"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"./dist/index.d.ts"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"files"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"dist"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"README.md"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"LICENSE"</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"sideEffects"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"*.css"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"./dist/style.css"</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"scripts"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"build"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"tsup"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"dev"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"tsup --watch"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"test"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"vitest run"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"prepublishOnly"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"npm run build"</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"dependencies"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"clsx"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"^2.0.0"</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"peerDependencies"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"react"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"&gt;=16.8.0"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"react-dom"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"&gt;=16.8.0"</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"devDependencies"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"@types/react"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"^18.2.0"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"@types/react-dom"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"^18.2.0"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"react"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"^18.2.0"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"react-dom"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"^18.2.0"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"tsup"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"^8.3.0"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"typescript"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"^5.5.4"</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"engines"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"node"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"&gt;=14.0.0"</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"repository"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"git"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"url"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"https://github.com/xxx/my-components.git"</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"bugs"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"https://github.com/xxx/my-components/issues"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"homepage"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"https://github.com/xxx/my-components#readme"</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p><strong>关键配置说明</strong>：</p>
<ul>
<li>✅ <strong>peerDependencies</strong>：声明框架依赖（React/Vue），用户需自行安装</li>
<li>✅ <strong>sideEffects: ["*.css"]</strong>：样式文件有副作用，需标记避免被 Tree-shaking 移除</li>
<li>✅ <strong>exports 支持样式导出</strong>：允许用户单独导入样式文件（<code>import 'my-components/style.css'</code>）</li>
<li>✅ <strong>devDependencies 包含框架</strong>：开发时需要，但不会被打包到最终产物</li>
</ul>
<h5 data-id="heading-22">实际案例要点：Ant Design</h5>
<p><strong>核心设计</strong>：</p>
<ul>
<li>样式方案：CSS-in-JS（antd 6.x）或 Less 变量（antd 4.x）</li>
<li>多格式输出：CJS/ESM/UMD，支持按需加载</li>
<li>工程化完善：size-limit、视觉回归测试、文档生成</li>
</ul>
<p><strong>关键配置</strong>：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"sideEffects"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"*.css"</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"main"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"lib/index.js"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"module"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"es/index.js"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"peerDependencies"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"react"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"&gt;=18.0.0"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"react-dom"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"&gt;=18.0.0"</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<hr/>
<h4 data-id="heading-23">Hooks 库配置</h4>
<p><strong>适用场景</strong>：React Hooks 集合、自定义 Hooks 库，如 ahooks、react-use</p>
<p><strong>核心字段</strong>：peerDependencies (react) + sideEffects: false</p>
<h5 data-id="heading-24">配置模板</h5>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"my-hooks"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"version"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"1.0.0"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"description"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"实用的 React Hooks 集合"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"keywords"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"react"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"hooks"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"custom-hooks"</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"author"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"张三 &lt;zhangsan@xxx.com&gt;"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"license"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"MIT"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"exports"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"."</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"import"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"./dist/index.js"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"require"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"./dist/index.cjs"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"types"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"./dist/index.d.ts"</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"main"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"./dist/index.cjs"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"module"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"./dist/index.js"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"types"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"./dist/index.d.ts"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"files"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"dist"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"README.md"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"LICENSE"</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"sideEffects"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">false</span></span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"scripts"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"build"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"tsup"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"dev"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"tsup --watch"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"test"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"vitest run"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"prepublishOnly"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"npm run build"</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"peerDependencies"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"react"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"&gt;=16.8.0"</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"devDependencies"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"@types/react"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"^18.2.0"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"react"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"^18.2.0"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"tsup"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"^8.3.0"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"typescript"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"^5.5.4"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"vitest"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"^2.0.5"</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"engines"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"node"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"&gt;=14.0.0"</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"repository"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"git"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"url"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"https://github.com/xxx/my-hooks.git"</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"bugs"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"https://github.com/xxx/my-hooks/issues"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"homepage"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"https://github.com/xxx/my-hooks#readme"</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p><strong>关键配置说明</strong>：</p>
<ul>
<li>✅ <strong>peerDependencies: react</strong>：Hooks 必须在 React 环境中使用</li>
<li>✅ <strong>sideEffects: false</strong>：纯 Hooks 函数，支持 Tree-shaking</li>
<li>✅ <strong>无需样式文件</strong>：Hooks 库通常不包含样式</li>
<li>⚠️ <strong>React 16.8+</strong>：Hooks 功能要求 React 16.8 及以上版本</li>
</ul>
<h5 data-id="heading-25">实际案例要点：ahooks</h5>
<p><strong>核心设计</strong>：</p>
<ul>
<li>monorepo 架构：根包管理工程化，子包专注业务</li>
<li>多模块格式：CJS/ESM/UMD，覆盖不同场景</li>
<li>React 版本兼容：peerDependencies 覆盖主流版本</li>
</ul>
<p><strong>关键配置</strong>：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"sideEffects"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">false</span></span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"peerDependencies"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"react"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"^16.8.0 || ^17.0.0 || ^18.0.0 || ^19.0.0"</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<hr/>
<h3 data-id="heading-26">第三部分：进阶内容</h3>
<h4 data-id="heading-27">npm 生命周期脚本</h4>
<p>npm 生态中的「生命周期脚本」是包管理器（npm/yarn/pnpm）内置的自动化钩子机制——当执行 <code>npm install</code>「安装依赖」、<code>npm publish</code>「发布包」、<code>npm version</code>「版本变更」等核心操作时，会按固定顺序触发一系列预定义脚本，无需手动调用即可自动完成编译、测试、打包等重复性工作。</p>
<h5 data-id="heading-28">核心规则</h5>
<ol>
<li>
<p><strong>pre/post 前缀自动链式执行</strong></p>
<ul>
<li>对于任意自定义或内置脚本（如 build/publish），npm 会自动识别并按以下顺序执行：<code>prexxx（前置脚本）→ xxx（核心脚本）→ postxxx（后置脚本）</code></li>
<li>示例：若定义了 build 脚本，执行 <code>npm run build</code> 时，实际执行顺序为：prebuild → build → postbuild（即使未定义 prebuild/postbuild，也会跳过而非报错）</li>
</ul>
</li>
<li>
<p><strong>内置事件触发规则</strong></p>
<ul>
<li>npm 预定义了一批核心操作（如 install/publish/version）作为「触发事件」，当执行这些操作时，会自动触发对应的生命周期脚本</li>
<li>例如：执行 <code>npm install</code> 会触发 preinstall → 安装核心流程 → postinstall</li>
</ul>
</li>
</ol>
<h5 data-id="heading-29">常用生命周期脚本</h5>



























































<table><thead><tr><th>脚本名</th><th>触发时机</th><th>执行顺序</th><th>常用场景</th></tr></thead><tbody><tr><td><code>preinstall</code></td><td><code>npm install</code> 前</td><td>1</td><td>检查环境、安装前置依赖</td></tr><tr><td><code>postinstall</code></td><td><code>npm install</code> 后</td><td>2</td><td>初始化配置、编译代码</td></tr><tr><td><code>prepare</code></td><td><code>npm install</code> 和 <code>npm publish</code> 时</td><td>特殊</td><td>Git Hooks 初始化（husky install）</td></tr><tr><td><code>prepublishOnly</code></td><td><code>npm publish</code> 前</td><td>1</td><td>构建、测试、版本校验</td></tr><tr><td><code>postpublish</code></td><td><code>npm publish</code> 后</td><td>2</td><td>推送代码、更新文档</td></tr><tr><td><code>preversion</code></td><td><code>npm version</code> 前</td><td>1</td><td>运行测试、检查代码</td></tr><tr><td><code>version</code></td><td><code>npm version</code> 时</td><td>2</td><td>自定义版本变更逻辑</td></tr><tr><td><code>postversion</code></td><td><code>npm version</code> 后</td><td>3</td><td>提交版本变更、打标签</td></tr></tbody></table>
<h5 data-id="heading-30">prepare 的使用场景</h5>
<p><code>prepare</code> 脚本会在以下场景自动执行：</p>
<ul>
<li>你在自己的项目里执行 <code>npm install</code>（安装依赖时）</li>
<li>别人执行 <code>npm install</code> 你的包（安装你的包时，不管是从 npm 还是 GitHub 源码）</li>
<li>你执行 <code>npm publish</code>（发布包到 npm 时）</li>
</ul>
<p><strong>常见用法</strong>：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"scripts"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"prepare"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"husky install"</span> <span class="hljs-comment">// 安装依赖时自动初始化 Husky</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<hr/>
<h4 data-id="heading-31">npx 使用指南</h4>
<p>npx 是 npm 5.2.0+ 内置的包执行工具，全称是 Node Package Execute，用于直接执行 npm 包中的可执行文件，无需手动全局安装包。</p>
<h5 data-id="heading-32">核心功能</h5>
<ol>
<li>
<p><strong>临时执行包（无需全局安装）</strong></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 无需全局安装 create-react-app，直接创建 React 项目</span>
npx create-react-app my-app

<span class="hljs-comment"># 无需全局安装 @vue/cli，直接创建 Vue 项目</span>
npx @vue/cli create my-vue-app
</code></pre>
</li>
<li>
<p><strong>调用本地已安装包的命令</strong></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 项目已安装 eslint，直接运行（等价于 ./node_modules/.bin/eslint）</span>
npx eslint src/**/*.js

<span class="hljs-comment"># 项目已安装 webpack，直接执行打包</span>
npx webpack --mode production
</code></pre>
</li>
<li>
<p><strong>执行指定版本的包</strong></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 使用 4.x 版本的 create-react-app</span>
npx create-react-app@4 my-app

<span class="hljs-comment"># 使用特定版本的 vite 创建项目</span>
npx vite@4 create my-vite-app
</code></pre>
</li>
<li>
<p><strong>执行 GitHub 仓库的脚本</strong></p>
<pre><code class="hljs language-bash" lang="bash">npx github:piuccio/cowsay hello
</code></pre>
</li>
</ol>
<h5 data-id="heading-33">npx 与 npm run 的区别</h5>

























<table><thead><tr><th>特性</th><th>npx</th><th>npm run</th></tr></thead><tbody><tr><td>执行内容</td><td>任意 npm 包的可执行命令（本地/全局/临时）</td><td>package.json 中 scripts 定义的命令</td></tr><tr><td>调用范围</td><td>可调用未安装的包（临时下载）</td><td>仅调用项目 package.json 依赖的包</td></tr><tr><td>使用场景</td><td>临时工具、单次命令、指定版本测试</td><td>项目固定脚本（如 dev/build/test）</td></tr></tbody></table>
<p><strong>示例</strong>：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># npx：直接调用全局/临时包的命令</span>
npx eslint src

<span class="hljs-comment"># npm run：调用 package.json 中 scripts 里的 "lint" 命令</span>
npm run lint
</code></pre>
<h5 data-id="heading-34">常用技巧</h5>
<ul>
<li><strong>跳过本地安装，强制使用远程包</strong>：<code>npx --ignore-existing create-react-app my-app</code></li>
<li><strong>查看包的可执行命令</strong>：<code>npx --commands cowsay</code></li>
<li><strong>执行本地脚本</strong>：<code>npx ./scripts/my-script.js</code>（需有 shebang 或 .js 后缀）</li>
</ul>
<hr/>
<h3 data-id="heading-35">附录</h3>
<h4 data-id="heading-36">配置模板汇总</h4>
<h5 data-id="heading-37">应用项目模板</h5>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"my-web-app"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"version"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"1.0.0"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"description"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"我的 Web 应用"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"private"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"scripts"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"dev"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"vite"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"build"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"vite build"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"preview"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"vite preview"</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"dependencies"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"react"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"^18.2.0"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"react-dom"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"^18.2.0"</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"devDependencies"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"vite"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"^5.0.0"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"@types/react"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"^18.2.0"</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"engines"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"node"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"&gt;=18.0.0"</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"packageManager"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"pnpm@9.0.0"</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h5 data-id="heading-38">工具库模板</h5>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"my-utils"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"version"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"1.0.0"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"description"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"实用的工具函数库"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"keywords"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"utils"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"helpers"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"tools"</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"author"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Your Name &lt;your-email@example.com&gt;"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"license"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"MIT"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"module"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"exports"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"."</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"import"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"./dist/index.js"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"require"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"./dist/index.cjs"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"types"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"./dist/index.d.ts"</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"main"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"./dist/index.cjs"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"module"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"./dist/index.js"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"types"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"./dist/index.d.ts"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"files"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"dist"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"README.md"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"LICENSE"</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"sideEffects"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">false</span></span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"scripts"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"build"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"tsup"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"dev"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"tsup --watch"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"test"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"vitest run"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"prepublishOnly"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"npm run build"</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"devDependencies"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"tsup"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"^8.3.0"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"typescript"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"^5.5.4"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"vitest"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"^2.0.5"</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"engines"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"node"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"&gt;=14.0.0"</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"repository"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"git"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"url"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"https://github.com/your-name/my-utils.git"</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"bugs"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"https://github.com/your-name/my-utils/issues"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"homepage"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"https://github.com/your-name/my-utils#readme"</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h5 data-id="heading-39">CLI 工具模板</h5>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"my-cli"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"version"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"1.0.0"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"description"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"命令行工具"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"keywords"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"cli"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"command-line"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"tool"</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"author"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Your Name &lt;your-email@example.com&gt;"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"license"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"MIT"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"module"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"bin"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"my-cli"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"./dist/cli.js"</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"preferGlobal"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"files"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"dist"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"templates"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"README.md"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"LICENSE"</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"sideEffects"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">false</span></span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"scripts"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"build"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"tsup"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"dev"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"tsup --watch"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"test"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"vitest run"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"prepublishOnly"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"npm run build"</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"dependencies"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"commander"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"^11.1.0"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"inquirer"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"^8.2.6"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"chalk"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"^4.1.2"</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"devDependencies"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"tsup"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"^8.3.0"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"typescript"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"^5.5.4"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"vitest"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"^2.0.5"</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"engines"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"node"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"&gt;=14.0.0"</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"repository"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"git"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"url"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"https://github.com/your-name/my-cli.git"</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"bugs"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"https://github.com/your-name/my-cli/issues"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"homepage"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"https://github.com/your-name/my-cli#readme"</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h5 data-id="heading-40">UI 组件库模板</h5>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"my-components"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"version"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"1.0.0"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"description"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"React 组件库"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"keywords"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"react"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"components"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"ui"</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"author"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Your Name &lt;your-email@example.com&gt;"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"license"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"MIT"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"exports"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"."</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"import"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"./dist/index.js"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"require"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"./dist/index.cjs"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"types"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"./dist/index.d.ts"</span>
    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"./style.css"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"./dist/style.css"</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"main"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"./dist/index.cjs"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"module"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"./dist/index.js"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"types"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"./dist/index.d.ts"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"files"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"dist"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"README.md"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"LICENSE"</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"sideEffects"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"*.css"</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"scripts"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"build"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"tsup"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"dev"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"tsup --watch"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"test"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"vitest run"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"prepublishOnly"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"npm run build"</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"dependencies"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"clsx"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"^2.0.0"</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"peerDependencies"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"react"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"&gt;=16.8.0"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"react-dom"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"&gt;=16.8.0"</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"devDependencies"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"@types/react"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"^18.2.0"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"@types/react-dom"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"^18.2.0"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"react"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"^18.2.0"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"react-dom"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"^18.2.0"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"tsup"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"^8.3.0"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"typescript"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"^5.5.4"</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"engines"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"node"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"&gt;=14.0.0"</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"repository"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"git"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"url"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"https://github.com/your-name/my-components.git"</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"bugs"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"https://github.com/your-name/my-components/issues"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"homepage"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"https://github.com/your-name/my-components#readme"</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h5 data-id="heading-41">Hooks 库模板</h5>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"my-hooks"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"version"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"1.0.0"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"description"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"实用的 React Hooks 集合"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"keywords"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"react"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"hooks"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"custom-hooks"</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"author"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Your Name &lt;your-email@example.com&gt;"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"license"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"MIT"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"exports"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"."</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"import"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"./dist/index.js"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"require"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"./dist/index.cjs"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"types"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"./dist/index.d.ts"</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"main"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"./dist/index.cjs"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"module"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"./dist/index.js"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"types"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"./dist/index.d.ts"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"files"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"dist"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"README.md"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"LICENSE"</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"sideEffects"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">false</span></span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"scripts"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"build"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"tsup"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"dev"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"tsup --watch"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"test"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"vitest run"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"prepublishOnly"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"npm run build"</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"peerDependencies"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"react"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"&gt;=16.8.0"</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"devDependencies"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"@types/react"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"^18.2.0"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"react"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"^18.2.0"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"tsup"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"^8.3.0"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"typescript"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"^5.5.4"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"vitest"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"^2.0.5"</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"engines"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"node"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"&gt;=14.0.0"</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"repository"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"git"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"url"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"https://github.com/your-name/my-hooks.git"</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"bugs"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"https://github.com/your-name/my-hooks/issues"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"homepage"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"https://github.com/your-name/my-hooks#readme"</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h4 data-id="heading-42">字段速查表</h4>





















































































































<table><thead><tr><th>字段名</th><th>类型</th><th>必填</th><th>适用场景</th><th>说明</th></tr></thead><tbody><tr><td><code>name</code></td><td>string</td><td>✅</td><td>所有项目</td><td>项目名称（npm 包需唯一）</td></tr><tr><td><code>version</code></td><td>string</td><td>✅</td><td>所有项目</td><td>版本号（npm 包必填）</td></tr><tr><td><code>description</code></td><td>string</td><td>✅</td><td>npm 包</td><td>项目描述</td></tr><tr><td><code>private</code></td><td>boolean</td><td>✅</td><td>应用项目</td><td>防止误发布</td></tr><tr><td><code>main</code></td><td>string</td><td>✅</td><td>npm 包</td><td>CJS 入口</td></tr><tr><td><code>module</code></td><td>string</td><td>✅</td><td>npm 包</td><td>ESM 入口</td></tr><tr><td><code>types</code></td><td>string</td><td>✅</td><td>TS npm 包</td><td>类型声明</td></tr><tr><td><code>exports</code></td><td>object</td><td>推荐</td><td>npm 包</td><td>条件导出（优先级最高）</td></tr><tr><td><code>bin</code></td><td>object/string</td><td>✅</td><td>CLI 工具</td><td>命令映射</td></tr><tr><td><code>sideEffects</code></td><td>boolean/array</td><td>推荐</td><td>npm 包</td><td>Tree-shaking 优化</td></tr><tr><td><code>peerDependencies</code></td><td>object</td><td>✅</td><td>组件库/Hooks库</td><td>对等依赖</td></tr><tr><td><code>files</code></td><td>array</td><td>✅</td><td>npm 包</td><td>发布文件列表</td></tr><tr><td><code>scripts</code></td><td>object</td><td>✅</td><td>所有项目</td><td>自定义脚本</td></tr><tr><td><code>dependencies</code></td><td>object</td><td>-</td><td>所有项目</td><td>生产依赖</td></tr><tr><td><code>devDependencies</code></td><td>object</td><td>-</td><td>所有项目</td><td>开发依赖</td></tr></tbody></table>
<hr/>
<h3 data-id="heading-43">参考资源</h3>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.npmjs.com%2Fcli%2Fv10%2Fconfiguring-npm%2Fpackage-json" target="_blank" title="https://docs.npmjs.com/cli/v10/configuring-npm/package-json" ref="nofollow noopener noreferrer">npm 官方文档</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fnodejs.org%2Fapi%2Fpackages.html%23exports" target="_blank" title="https://nodejs.org/api/packages.html#exports" ref="nofollow noopener noreferrer">Node.js Package Exports</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fsemver.org%2F" target="_blank" title="https://semver.org/" ref="nofollow noopener noreferrer">Semantic Versioning</a></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[[NOTE] JavaScript 中的稀疏数组、空槽和访问]]></title>    <link>https://juejin.cn/post/7577364921656754218</link>    <guid>https://juejin.cn/post/7577364921656754218</guid>    <pubDate>2025-11-28T04:57:28.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577364921656754218" data-draft-id="7577364921656721450" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="[NOTE] JavaScript 中的稀疏数组、空槽和访问"/> <meta itemprop="keywords" content="JavaScript,V8,面试"/> <meta itemprop="datePublished" content="2025-11-28T04:57:28.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="mCell"/> <meta itemprop="url" content="https://juejin.cn/user/2280829967146779"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            [NOTE] JavaScript 中的稀疏数组、空槽和访问
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2280829967146779/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    mCell
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-28T04:57:28.000Z" title="Fri Nov 28 2025 04:57:28 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-28
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    2
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>标题中的<code>[NOTE]</code>表示当前文章是篇小记，篇幅较短，聚焦一个小问题。</p>
</blockquote>
<p>我写了个 Demo ，想看看 JavaScript 的数组对于声明但没有被使用的空间会如何处理；直接看代码：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> arr = [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>] 

arr.<span class="hljs-property">length</span> = <span class="hljs-number">10</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"arr: "</span>, arr)
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"typeof last item: "</span>, <span class="hljs-keyword">typeof</span> (arr[arr.<span class="hljs-property">length</span> - <span class="hljs-number">1</span>]))
</code></pre>
<p>输出：</p>
<pre><code class="hljs language-bash" lang="bash">arr:  [ 1, 2, 3, 4, 5, &lt;5 empty items&gt; ]
typeof last item:  undefined
</code></pre>
<p>这里出现了一些陌生的定义，<code>empty items</code>，我并不清楚这代表什么意思，尝试打印出来之后返回的是<code>undefined</code>；</p>
<p>抱着好奇心态，我去搜了一番：</p>
<p>整个行为的背后是 JavaScript 数组的 <strong>稀疏数组</strong> 机制：</p>
<ul>
<li>
<p><strong>稀疏数组：</strong>  当你将数组的 <code>length</code> 设置为一个比实际元素数目更大的值时，数组会变成一个稀疏数组。数组中超出原本元素范围的索引会变成 <strong>空槽</strong>，这些空槽在输出时显示为 <code>&lt;empty items&gt;</code>。</p>
</li>
<li>
<p><strong>访问空槽：</strong>  尝试访问空槽时，JavaScript 返回的是 <code>undefined</code>，因此 <code>typeof arr[arr.length - 1]</code> 返回 <code>undefined</code></p>
</li>
</ul>
<p><code>typeof</code> 操作符返回的是 <code>undefined</code>，因为访问的索引是“空槽”。这些空槽在 JavaScript 内部并没有值，所以当你尝试访问它们时，JavaScript 会自动将它们视作 <code>undefined</code>。</p>
<p>那么由此我又在想另外一个问题，稀疏数组在内存中到底是怎么存放的？</p>
<p>我们已知的是，默认情况下数组在内存中都是连续存放，比如:<code>[1, 2, 3, 4, 5]</code>，他们在内存中的地址都是连续的，像这样:<code>xxx1,xxx2,xxx3,xxx4,xxx5</code>；但是对于带有空槽的稀疏数组呢？</p>
<blockquote>
<p>这个问题，留给大家吧；会涉及一些底层知识。</p>
</blockquote>
<h2 data-id="heading-0">参考</h2>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.mozilla.org%2Fzh-CN%2Fdocs%2FWeb%2FJavaScript%2FReference%2FGlobal_Objects%2FArray%23%25E6%2595%25B0%25E7%25BB%2584%25E6%2596%25B9%25E6%25B3%2595%25E5%2592%258C%25E7%25A9%25BA%25E6%25A7%25BD" target="_blank" title="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Array#%E6%95%B0%E7%BB%84%E6%96%B9%E6%B3%95%E5%92%8C%E7%A9%BA%E6%A7%BD" ref="nofollow noopener noreferrer">MDN - JavaScript 数组方法和空槽</a></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[openGauss向量数据库：引领AI时代数据智能新纪元]]></title>    <link>https://juejin.cn/post/7577395040592052234</link>    <guid>https://juejin.cn/post/7577395040592052234</guid>    <pubDate>2025-11-28T05:01:28.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577395040592052234" data-draft-id="7577256255084544009" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="openGauss向量数据库：引领AI时代数据智能新纪元"/> <meta itemprop="keywords" content="数据库"/> <meta itemprop="datePublished" content="2025-11-28T05:01:28.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="倔强的石头_"/> <meta itemprop="url" content="https://juejin.cn/user/3168119757484368"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            openGauss向量数据库：引领AI时代数据智能新纪元
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3168119757484368/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    倔强的石头_
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-28T05:01:28.000Z" title="Fri Nov 28 2025 05:01:28 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-28
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">写在前面</h2>
<p>随着人工智能和大语言模型的快速发展，向量数据库已成为AI应用的关键基础设施。openGauss作为数据库系统，通过集成向量数据库能力，为企业提供了一个统一的、高性能的、安全可靠的数据智能平台。本文详细介绍了openGauss向量数据库的核心特性、技术架构，以及在企业级应用中的实践案例，展示了其在AI时代如何赋能企业数据智能转型。</p>
<h2 data-id="heading-1">面临的挑战及优势</h2>
<h4 data-id="heading-2">AI时代的数据挑战</h4>
<p>在AI和大语言模型（LLM）爆发式发展的时代，企业面临着前所未有的数据处理挑战：</p>
<ul>
<li>
<p><strong>非结构化数据爆炸</strong>：文本、图像、音频等非结构化数据成为企业数据资产的主体</p>
</li>
<li>
<p><strong>语义搜索需求</strong>：传统关键词匹配已无法满足复杂的业务查询需求</p>
</li>
<li>
<p><strong>实时智能应用</strong>：需要快速、准确地进行向量相似度计算和检索</p>
</li>
<li>
<p><strong>数据安全合规</strong>：企业数据必须在国内可控的环境中处理和存储</p>
</li>
</ul>
<h4 data-id="heading-3">向量数据库的必要性</h4>
<p>向量数据库通过将非结构化数据转换为高维向量表示，实现了：</p>
<ul>
<li>
<p>语义级别的相似度搜索</p>
</li>
<li>
<p>毫秒级的查询响应时间</p>
</li>
<li>
<p>支持大规模数据集的高效检索</p>
</li>
<li>
<p>与LLM的无缝集成</p>
</li>
</ul>
<h4 data-id="heading-4">openGauss向量数据库的优势</h4>
<p>openGauss向量数据库结合了openGauss数据库的企业级特性与向量数据库的AI能力：</p>
<ul>
<li>
<p><strong>企业级可靠性</strong>：支持高可用、容灾、备份等企业级特性</p>
</li>
<li>
<p><strong>统一平台</strong>：结构化和非结构化数据在同一数据库中管理</p>
</li>
<li>
<p><strong>性能优异</strong>：针对向量操作进行了深度优化</p>
</li>
<li>
<p><strong>生态完善</strong>：与国内AI生态深度融合</p>
</li>
</ul>
<h2 data-id="heading-5">openGauss向量数据库核心特性</h2>
<h4 data-id="heading-6">向量数据类型与索引</h4>
<p>openGauss向量数据库支持多种向量数据类型和高效的索引机制：</p>
<p><strong>向量****数据类型</strong></p>
<p>CREATE TABLE embeddings (</p>
<p>id BIGSERIAL PRIMARY KEY,</p>
<p>content TEXT,</p>
<p>embedding vector(1536),</p>
<p>created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP</p>
<p>);</p>
<p><strong>向量索引</strong></p>
<ul>
<li>
<p><strong>HNSW索引</strong>：Hierarchical Navigable Small World，适合高维向量</p>
</li>
<li>
<p><strong>IVFFlat索引</strong>：倒排文件，适合大规模数据集</p>
</li>
<li>
<p><strong>PQ****索引</strong>：乘积量化，极致压缩</p>
</li>
</ul>
<h4 data-id="heading-7">向量相似度计算</h4>
<p>支持多种距离度量方式：</p>
<ul>
<li>
<p><strong>欧氏距离</strong>**（L2）**：&lt;-&gt;操作符</p>
</li>
<li>
<p><strong>余弦相似度</strong>**（<strong><strong>Cosine</strong></strong>）**：&lt;=&gt;操作符</p>
</li>
<li>
<p><strong>内积（Inner Product）</strong>：&lt;#&gt;操作符</p>
</li>
</ul>
<p>SELECT id, content, embedding &lt;-&gt; query_embedding AS distance</p>
<p>FROM embeddings</p>
<p>ORDER BY embedding &lt;-&gt; query_embedding</p>
<p>LIMIT 10;</p>
<h4 data-id="heading-8">混合查询能力</h4>
<p>在同一个查询中结合结构化和向量化搜索：</p>
<p>SELECT id, content, category, embedding &lt;-&gt; query_embedding AS distance</p>
<p>FROM embeddings</p>
<p>WHERE category = 'technology'</p>
<p>AND created_at &gt; NOW() - INTERVAL '30 days'</p>
<p>ORDER BY embedding &lt;-&gt; query_embedding</p>
<p>LIMIT 20;</p>
<h4 data-id="heading-9">企业级特性</h4>
<ul>
<li>
<p><strong>高可用</strong>：支持主备、级联备份</p>
</li>
<li>
<p><strong>容灾</strong>：支持跨地域容灾部署</p>
</li>
<li>
<p><strong>备份恢复</strong>：完整的备份和恢复机制</p>
</li>
<li>
<p><strong>安全加密</strong>：支持传输层和存储层加密</p>
</li>
<li>
<p><strong>权限管理</strong>：细粒度的用户权限控制</p>
</li>
<li>
<p><strong>审计日志</strong>：完整的操作审计跟踪</p>
</li>
</ul>
<h2 data-id="heading-10">技术架构</h2>
<h4 data-id="heading-11">项目结构</h4>
<p>src/</p>
<p>├── main/</p>
<p>│ ├── java/com/openGauss/</p>
<p>│ │ ├── VectorKnowledgeManagementApplication.java # 主应用类</p>
<p>│ │ ├── controller/ # REST控制器</p>
<p>│ │ │ ├── DocumentController.java</p>
<p>│ │ │ └── SearchController.java</p>
<p>│ │ ├── service/ # 业务服务</p>
<p>│ │ │ ├── DocumentService.java</p>
<p>│ │ │ ├── EmbeddingService.java</p>
<p>│ │ │ └── VectorSearchService.java</p>
<p>│ │ ├── repository/ # 数据访问层</p>
<p>│ │ │ ├── DocumentRepository.java</p>
<p>│ │ │ ├── DocumentChunkRepository.java</p>
<p>│ │ │ ├── DocumentPermissionRepository.java</p>
<p>│ │ │ └── SearchLogRepository.java</p>
<p>│ │ ├── entity/ # 数据实体</p>
<p>│ │ │ ├── Document.java</p>
<p>│ │ │ ├── DocumentChunk.java</p>
<p>│ │ │ ├── DocumentPermission.java</p>
<p>│ │ │ └── SearchLog.java</p>
<p>│ │ └── dto/ # 数据传输对象</p>
<p>│ │ ├── DocumentDTO.java</p>
<p>│ │ ├── SearchQuery.java</p>
<p>│ │ └── SearchResult.java</p>
<p>│ └── resources/</p>
<p>│ └── application.yml # 应用配置</p>
<p>└── test/</p>
<p>└── java/com/openGauss/service/</p>
<p>└── EmbeddingServiceTest.java # 单元测试</p>
<h4 data-id="heading-12">向量索引机制</h4>
<p><strong>HNSW索引（推荐用于实时查询）</strong></p>
<ul>
<li>
<p>分层结构，支持快速近似最近邻搜索</p>
</li>
<li>
<p>查询复杂度：O(log N)</p>
</li>
<li>
<p>适合：实时应用、中等规模数据集（百万级）</p>
</li>
</ul>
<p><strong>IVFFlat索引（推荐用于大规模数据）</strong></p>
<ul>
<li>
<p>倒排文件结构，将向量空间分割为多个聚类</p>
</li>
<li>
<p>查询复杂度：O(k log N)</p>
</li>
<li>
<p>适合：大规模数据集（千万级以上）</p>
</li>
</ul>
<p><strong>PQ****索引（推荐用于超大规模数据）</strong></p>
<ul>
<li>
<p>乘积量化，极致压缩</p>
</li>
<li>
<p>内存占用：原始向量的1-10%</p>
</li>
<li>
<p>适合：超大规模数据集、内存受限场景</p>
</li>
</ul>
<h2 data-id="heading-13">详细案例分析：企业级智能知识管理系统</h2>
<h4 data-id="heading-14">案例背景</h4>
<p><strong>企业</strong>：某大型金融科技公司 <strong>规模</strong>：员工5000+，日均文档处理量10万+ <strong>挑战</strong>：</p>
<ul>
<li>
<p>企业内部积累了数百万份文档（合同、报告、邮件等）</p>
</li>
<li>
<p>员工需要快速查找相关文档和知识</p>
</li>
<li>
<p>传统关键词搜索准确率低，用户体验差</p>
</li>
<li>
<p>需要支持跨部门的知识共享和复用</p>
</li>
</ul>
<h4 data-id="heading-15">解决方案架构</h4>
<h5 data-id="heading-16">核心模块说明</h5>
<ol>
<li><strong>DefectFeatureExtractor（特征提取器）</strong></li>
</ol>
<p>功能：从产品图像中提取特征向量</p>
<p><strong>主要方法：</strong></p>
<ul>
<li>
<p><code>extractFeatures(String imagePath)</code> - 从图像提取特征向量</p>
</li>
<li>
<p><code>storeDefectFeature(...)</code> - 将缺陷特征存储到数据库</p>
</li>
<li>
<p><code>resizeImage(...)</code> - 调整图像大小</p>
</li>
<li>
<p><code>imageToArray(...)</code> - 将图像转换为张量并归一化</p>
</li>
</ul>
<p><strong>依赖：</strong></p>
<ul>
<li>
<p>DeepLearning4j - 深度学习框架</p>
</li>
<li>
<p>ND4J - 张量计算库</p>
</li>
<li>
<p>PostgreSQL JDBC驱动</p>
</li>
</ul>
<ol>
<li><strong>DefectClassifier（缺陷<strong><strong>分类器</strong></strong>）</strong></li>
</ol>
<p>功能：通过向量相似度搜索对缺陷进行分类</p>
<p><strong>主要方法：</strong></p>
<ul>
<li>
<p><code>classifyDefect(float[] featureVector, int topK)</code> - 分类缺陷</p>
</li>
<li>
<p><code>getDefectStatistics(String defectType, int days)</code> - 获取缺陷统计</p>
</li>
</ul>
<p><strong>输出：</strong></p>
<ul>
<li>
<p>DefectInfo - 缺陷信息（ID、类型、相似度、严重程度等）</p>
</li>
<li>
<p>DefectStatistics - 统计信息（数量、平均严重程度等）</p>
</li>
</ul>
<ol>
<li>RootCauseAnalyzer（根因分析器）</li>
</ol>
<p>功能：分析缺陷根本原因并预测设备维护需求</p>
<p><strong>主要方法：</strong></p>
<ul>
<li>
<p><code>analyzeRootCause(...)</code> - 分析缺陷根本原因</p>
</li>
<li>
<p><code>predictEquipmentMaintenance(...)</code> - 预测维护需求</p>
</li>
<li>
<p><code>cosineSimilarity(...)</code> - 计算向量余弦相似度</p>
</li>
</ul>
<p><strong>分析逻辑</strong>：</p>
<ul>
<li>
<p>相似度 &gt; 0.85：系统性问题，需要检查设备</p>
</li>
<li>
<p>相似度 ≤ 0.85：随机缺陷，加强监控</p>
</li>
</ul>
<h5 data-id="heading-17">数据库设计</h5>
<p>-- 文档表</p>
<p>CREATE TABLE documents (</p>
<p>doc_id BIGSERIAL PRIMARY KEY,</p>
<p>title VARCHAR(500) NOT NULL,</p>
<p>content TEXT NOT NULL,</p>
<p>doc_type VARCHAR(50),</p>
<p>department VARCHAR(100),</p>
<p>created_by VARCHAR(100),</p>
<p>created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,</p>
<p>updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,</p>
<p>is_deleted BOOLEAN DEFAULT FALSE</p>
<p>);</p>
<p>-- 文档块表（用于分块存储）</p>
<p>CREATE TABLE document_chunks (</p>
<p>chunk_id BIGSERIAL PRIMARY KEY,</p>
<p>doc_id BIGINT REFERENCES documents(doc_id),</p>
<p>chunk_index INT,</p>
<p>chunk_text TEXT NOT NULL,</p>
<p>chunk_embedding vector(1536),</p>
<p>created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP</p>
<p>);</p>
<p>-- 为向量列创建HNSW索引</p>
<p>CREATE INDEX idx_chunk_embedding ON document_chunks</p>
<p>USING hnsw (chunk_embedding vector_cosine_ops)</p>
<p>WITH (m=16, ef_construction=200);</p>
<p>-- 用户权限表</p>
<p>CREATE TABLE document_permissions (</p>
<p>perm_id BIGSERIAL PRIMARY KEY,</p>
<p>doc_id BIGINT REFERENCES documents(doc_id),</p>
<p>user_id VARCHAR(100),</p>
<p>department VARCHAR(100),</p>
<p>permission_type VARCHAR(20),</p>
<p>created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP</p>
<p>);</p>
<p>-- 搜索日志表</p>
<p>CREATE TABLE search_logs (</p>
<p>log_id BIGSERIAL PRIMARY KEY,</p>
<p>user_id VARCHAR(100),</p>
<p>query_text TEXT,</p>
<p>query_embedding vector(1536),</p>
<p>result_count INT,</p>
<p>response_time_ms INT,</p>
<p>created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP</p>
<p>);</p>
<h4 data-id="heading-18">核心功能实现</h4>
<h5 data-id="heading-19">文档向量化与存储</h5>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a9f685d6e11644bd8245160c47a1384f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YCU5by655qE55-z5aS0Xw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764910888&amp;x-signature=KDIdXB%2BxiDngdG1l%2BhCGVU4fWqE%3D" alt="" loading="lazy"/></p>
<p>这段代码是 文档智能化处理的核心骨架，设计上兼顾了事务一致性、语义准确性和工程可用性，完整覆盖了 “非结构化文档→结构化分块→语义向量→持久化存储” 的全流程。</p>
<p>其核心价值在于为后续的语义检索、智能问答等场景提供高质量的数据基础，尤其适合工业、医疗、法律等需要精准文档检索的领域。通过 “配置化、异步化、批量优化、向量数据库适配” 等改进，可进一步提升其稳定性、效率和扩展性，满足高并发、大规模文档处理的业务需求。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e021207853084dc6b8bb73137e7326ce~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YCU5by655qE55-z5aS0Xw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764910888&amp;x-signature=0KgwHpthW1wv3wpm8kEmj04NBos%3D" alt="" loading="lazy"/></p>
<p>这段文本分块代码的核心优势是 “语义优先、精准控制、中文适配”：通过句子边界分割保证语义完整，基于 token 数控制分块大小贴合模型需求，重叠机制避免上下文割裂，非常适合中文文本的向量化预处理（如工业文档、知识库文本）。</p>
<p>通过 “扩展分割正则、按 token 数控制重叠、添加最小分块限制” 等优化，可进一步提升其鲁棒性和灵活性，适配中英文混合、多格式文本的分块需求，为后续向量化和语义检索提供更高质量的分块数据。</p>
<h5 data-id="heading-20">智能搜索服务</h5>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f0e5c1606dec4a169b8e769b019ea461~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YCU5by655qE55-z5aS0Xw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764910888&amp;x-signature=x1pNKT%2FlX4yzDSb%2FpTe3s1gMmsg%3D" alt="" loading="lazy"/></p>
<p>该代码的核心设计思路（语义向量化→权限管控→相似度匹配→结果优化）完全符合文档检索的业务需求，但 全量遍历分块 和 N+1 查询 导致其无法支撑大规模文档检索（如分块数 &gt; 1 万）。</p>
<p>最关键的优化是 迁移到专业向量数据库，结合 “权限过滤查询 + 批量元信息查询 + 缓存机制”，可将检索响应时间从秒级降至毫秒级，满足实时检索需求。优化后，该方法可稳定支撑工业知识库、企业文档中心等场景的语义检索，为用户提供精准、高效的 “以文搜文” 体验。</p>
<h5 data-id="heading-21">权限管理</h5>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/dcdd6b2d5fd94be9905721bd542bfeeb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YCU5by655qE55-z5aS0Xw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764910888&amp;x-signature=YAjrOdJfSeL2apoxYH%2BlkJAlCJc%3D" alt="" loading="lazy"/></p>
<p>该代码的核心优势是 “流程闭环、智能化集成、权限合规”：通过简洁的逻辑实现了文档从创建到可用（支持检索、权限可控）的全流程，同时复用了向量化服务的能力，避免代码冗余。</p>
<p>通过 “输入校验、异步向量化、多格式支持、去重校验” 等优化，可进一步提升接口的鲁棒性、响应速度和适用场景，使其更符合企业级文档管理的需求（如高并发上传、多格式文档、精细化权限控制）。优化后，该接口可稳定支撑工业知识库、企业文档中心等场景的文档录入工作，为后续的检索、管理、共享奠定坚实基础。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/73ec36ecc0ec42579383cf6008f44234~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YCU5by655qE55-z5aS0Xw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764910888&amp;x-signature=N%2FMKl3m2b8OQxXE3KwRBd5TXPOs%3D" alt="" loading="lazy"/></p>
<p>这两个方法围绕 “文档权限” 核心，实现了 “查询可访问文档” 和 “授予权限” 的基础能力，逻辑简洁、安全性高，基本满足文档协作的核心需求。但当前存在 性能瓶颈（全量查询）、数据冗余（重复授权）、参数校验缺失 等问题，需通过 “数据库层面过滤、分页查询、重复校验、参数校验” 等优化手段解决。</p>
<p>优化后，该权限管理模块可支撑企业级文档系统的核心场景：</p>
<p>普通用户：查看自己有权访问的文档（支持分页、筛选）；</p>
<p>文档管理员：授权他人访问文档（支持用户级、部门级授权，避免重复操作）；</p>
<p>系统安全：严格的权限校验，确保数据不泄露、不越权。</p>
<p>适用于工业知识库、企业文档中心、团队协作平台等场景，为文档的 “存储 - 管理 - 共享 - 检索” 全流程提供安全可靠的权限支撑。</p>
<h4 data-id="heading-22">性能指标与优化</h4>
<h5 data-id="heading-23">性能基准</h5>
<p><strong>指标</strong></p>
<p><strong>目标</strong></p>
<p><strong>实现</strong></p>
<p><strong>说明</strong></p>
<p>单次查询延迟</p>
<p>&lt;100ms</p>
<p>45ms</p>
<p>基于HNSW索引，100万文档</p>
<p>吞吐量</p>
<p>&gt;1000 QPS</p>
<p>1500 QPS</p>
<p>并发查询处理能力</p>
<p>索引大小</p>
<p>&lt;原始数据的20%</p>
<p>15%</p>
<p>向量压缩和优化</p>
<p>内存占用</p>
<p>&lt;总数据的30%</p>
<p>25%</p>
<p>缓存和索引优化</p>
<p>可用性</p>
<p>&gt;99.9%</p>
<p>99.95%</p>
<p>主备自动转移</p>
<h5 data-id="heading-24">优化策略</h5>
<ol>
<li><strong>索引优化</strong></li>
</ol>
<p>CREATE INDEX idx_chunk_embedding ON document_chunks</p>
<p>USING hnsw (chunk_embedding vector_cosine_ops)</p>
<p>WITH (m=16, ef_construction=200, ef_search=100);</p>
<ol>
<li><strong>查询优化</strong></li>
</ol>
<p>SELECT * FROM document_chunks</p>
<p>WHERE chunk_embedding &lt;-&gt; query_embedding &lt; 0.5</p>
<p>ORDER BY chunk_embedding &lt;-&gt; query_embedding</p>
<p>LIMIT 100;</p>
<ol>
<li><strong>缓存策略</strong></li>
</ol>
<ul>
<li>
<p>热点查询缓存：缓存频繁查询的结果</p>
</li>
<li>
<p>向量缓存：缓存常用的查询向量</p>
</li>
<li>
<p>元数据缓存：缓存文档元数据</p>
</li>
</ul>
<h4 data-id="heading-25">实施成果</h4>
<h5 data-id="heading-26">业务成果</h5>
<p><strong>指标</strong></p>
<p><strong>实施前</strong></p>
<p><strong>实施后</strong></p>
<p><strong>提升</strong></p>
<p>平均搜索时间</p>
<p>3-5秒</p>
<p>45ms</p>
<p>100倍+</p>
<p>搜索准确率</p>
<p>60%</p>
<p>92%</p>
<p>+32%</p>
<p>用户满意度</p>
<p>3.2/5</p>
<p>4.6/5</p>
<p>+44%</p>
<p>日均搜索量</p>
<p>5000次</p>
<p>35000次</p>
<p>7倍</p>
<p>知识复用率</p>
<p>15%</p>
<p>68%</p>
<p>4.5倍</p>
<h5 data-id="heading-27">技术成果</h5>
<ul>
<li>
<p><strong>系统稳定性</strong>：99.95%可用性，零数据丢失</p>
</li>
<li>
<p><strong>性能指标</strong>：45ms平均查询延迟，1500 QPS吞吐量</p>
</li>
<li>
<p><strong>成本效益</strong>：相比商业向量数据库节省70%成本</p>
</li>
</ul>
<h2 data-id="heading-28">最佳实践与建议</h2>
<h4 data-id="heading-29">向量化最佳实践</h4>
<ul>
<li>
<p><strong>选择合适的Embedding模型</strong></p>
<ul>
<li>
<p>根据业务场景选择模型维度（768/1024/1536）</p>
</li>
<li>
<p>优先使用LLM模型</p>
</li>
<li>
<p>定期评估模型效果</p>
</li>
</ul>
</li>
<li>
<p><strong>文本分块策略</strong></p>
<ul>
<li>
<p>根据内容特点调整分块大小</p>
</li>
<li>
<p>保持合理的重叠比例（20-30%）</p>
</li>
<li>
<p>避免在语义边界处分割</p>
</li>
</ul>
</li>
<li>
<p><strong>向量****质量保证</strong></p>
<ul>
<li>
<p>定期验证向量质量</p>
</li>
<li>
<p>监控相似度分布</p>
</li>
<li>
<p>建立反馈机制</p>
</li>
</ul>
</li>
</ul>
<h4 data-id="heading-30">索引选择指南</h4>
<p><strong>场景</strong></p>
<p><strong>推荐索引</strong></p>
<p><strong>原因</strong></p>
<p>实时应用，&lt;100万数据</p>
<p>HNSW</p>
<p>查询快，准确率高</p>
<p>大规模数据，&gt;1000万</p>
<p>IVFFlat</p>
<p>内存占用少，可扩展</p>
<p>超大规模，&gt;1亿</p>
<p>PQ</p>
<p>极致压缩，成本低</p>
<p>混合场景</p>
<p>多索引</p>
<p>根据查询特点选择</p>
<h4 data-id="heading-31">性能优化建议</h4>
<ul>
<li>
<p><strong>监控关键指标</strong></p>
<ul>
<li>
<p>查询延迟分布（p50/p95/p99）</p>
</li>
<li>
<p>索引大小和内存占用</p>
</li>
<li>
<p>复制延迟和可用性</p>
</li>
</ul>
</li>
<li>
<p><strong>定期维护</strong></p>
<ul>
<li>
<p>定期VACUUM和ANALYZE</p>
</li>
<li>
<p>监控索引碎片化</p>
</li>
<li>
<p>及时更新统计信息</p>
</li>
</ul>
</li>
<li>
<p><strong>容量规划</strong></p>
<ul>
<li>
<p>预留30%的增长空间</p>
</li>
<li>
<p>定期评估扩容需求</p>
</li>
<li>
<p>建立分片策略</p>
</li>
</ul>
</li>
</ul>
<h2 data-id="heading-32">总结与展望</h2>
<h4 data-id="heading-33">核心价值</h4>
<p>openGauss向量数据库通过以下方式赋能企业数据智能：</p>
<ul>
<li>
<p><strong>统一平台</strong>：结构化和非结构化数据在同一数据库中管理</p>
</li>
<li>
<p><strong>高性能</strong>：毫秒级查询延迟，支持大规模并发</p>
</li>
<li>
<p><strong>企业级</strong>：高可用、容灾、备份等完整的企业级特性</p>
</li>
</ul>
<h4 data-id="heading-34">应用前景</h4>
<p>向量数据库在以下领域具有广阔的应用前景：</p>
<ul>
<li>
<p><strong>智能搜索</strong>：语义搜索、推荐系统</p>
</li>
<li>
<p><strong>知识管理</strong>：企业知识库、文档管理</p>
</li>
<li>
<p><strong>AI应用</strong>：LLM应用、RAG系统</p>
</li>
<li>
<p><strong>多模态</strong>：图像搜索、视频检索</p>
</li>
</ul>
<h4 data-id="heading-35">未来发展方向</h4>
<ul>
<li>
<p><strong>性能优化</strong></p>
<ul>
<li>
<p>更高效的索引算法</p>
</li>
<li>
<p>GPU加速支持</p>
</li>
<li>
<p>分布式向量计算</p>
</li>
</ul>
</li>
<li>
<p><strong>功能增强</strong></p>
<ul>
<li>
<p>多模态向量支持</p>
</li>
<li>
<p>实时向量更新</p>
</li>
<li>
<p>向量聚类和分析</p>
</li>
</ul>
</li>
<li>
<p><strong>生态建设</strong></p>
<ul>
<li>
<p>与LLM深度融合</p>
</li>
<li>
<p>开源社区建设</p>
</li>
<li>
<p>行业解决方案</p>
</li>
</ul>
</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[LangChain 核心原理-核心组件&应用开发类型 01]]></title>    <link>https://juejin.cn/post/7577307100130033714</link>    <guid>https://juejin.cn/post/7577307100130033714</guid>    <pubDate>2025-11-28T03:26:47.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577307100130033714" data-draft-id="7577321767346143278" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="LangChain 核心原理-核心组件&amp;应用开发类型 01"/> <meta itemprop="keywords" content="LangChain,Agent,LLM"/> <meta itemprop="datePublished" content="2025-11-28T03:26:47.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="大模型教程"/> <meta itemprop="url" content="https://juejin.cn/user/1145012233707299"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            LangChain 核心原理-核心组件&amp;应用开发类型 01
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1145012233707299/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    大模型教程
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-28T03:26:47.000Z" title="Fri Nov 28 2025 03:26:47 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-28
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读12分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#383838;font-size:15px;line-height:30px;letter-spacing:2px;word-break:break-word;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen,Ubuntu,Cantarell,Open Sans,Helvetica Neue,sans-serif;scroll-behavior:smooth;background-image:linear-gradient(0deg,transparent 24%,rgba(201,195,195,.329) 25%,hsla(0,8%,80.4%,.05) 26%,transparent 27%,transparent 74%,hsla(0,5.2%,81%,.185) 75%,rgba(180,176,176,.05) 76%,transparent 77%,transparent),linear-gradient(90deg,transparent 24%,rgba(204,196,196,.226) 25%,hsla(0,4%,66.1%,.05) 26%,transparent 27%,transparent 74%,hsla(0,5.2%,81%,.185) 75%,rgba(180,176,176,.05) 76%,transparent 77%,transparent);background-color:#fff;background-size:50px 50px;padding-bottom:60px}.markdown-body ::selection{color:#fff;background-color:#a862ea}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{margin:24px 0 12px;color:#a862ea}.markdown-body h1{line-height:2;font-size:1.4em}.markdown-body h1~p:first-of-type:first-letter{color:#a862ea;float:left;font-size:2em;margin-right:.4em;font-weight:bolder}.markdown-body h2{font-size:1.2em}.markdown-body h3{font-size:1.1em}.markdown-body ol,.markdown-body ul{padding-left:2em}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;padding-left:.2em}.markdown-body ol li::marker,.markdown-body ul li::marker{color:#a862ea}.markdown-body ol li.task-list-item,.markdown-body ul li.task-list-item{list-style:none}.markdown-body ol li.task-list-item ol,.markdown-body ol li.task-list-item ul,.markdown-body ul li.task-list-item ol,.markdown-body ul li.task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:10px}.markdown-body a,.markdown-body code,.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6,.markdown-body li,.markdown-body p{opacity:.85;vertical-align:baseline;transition:all .1s ease}.markdown-body a:hover,.markdown-body code:hover,.markdown-body h1:hover,.markdown-body h2:hover,.markdown-body h3:hover,.markdown-body h4:hover,.markdown-body h5:hover,.markdown-body h6:hover,.markdown-body li:hover,.markdown-body p:hover{opacity:1}.markdown-body a{display:inline-block;color:#a862ea;cursor:pointer;text-decoration:none;position:relative}.markdown-body a:after{content:"";position:absolute;width:98%;height:1px;bottom:0;left:0;transform:scaleX(0);background-color:#a862ea;transform-origin:bottom right;transition:transform .3s ease-in-out}.markdown-body a:hover:after{transform:scaleX(1);transform-origin:bottom left}.markdown-body a:active,.markdown-body a:link{color:#a862ea}.markdown-body img{max-width:100%;user-select:none;margin:1em 0;transition:transform .2s ease 0s;background-color:#f8f5ff;box-shadow:0 0 10px #e7daff}.markdown-body img:hover{opacity:1;box-shadow:0 0 20px #e7daff;transform:translateY(-1px)}.markdown-body blockquote{padding:.5em 1em;margin:12px 0;border-top-left-radius:2px;border-bottom-left-radius:2px;border-left:3px solid #a862ea;background-color:#f8f5ff}.markdown-body blockquote&gt;p{margin:0}.markdown-body .math{font-style:italic;margin:12px 0;padding:.5em 1em;background-color:#f8f5ff}.markdown-body .math&gt;p{margin:0}.markdown-body code{padding:2px .4em;overflow-x:auto;color:#a862ea;font-weight:700;word-break:break-word;font-family:Operator Mono,Consolas,Monaco,Menlo,monospace;background-color:#f8f5ff}.markdown-body pre{margin:2em 0}.markdown-body pre&gt;code{display:block;padding:1.5em;word-break:normal;font-size:.9em;font-style:normal;font-weight:400;font-family:Operator Mono,Consolas,Monaco,Menlo,monospace;line-height:18px;color:#383838;border-radius:2px;scroll-behavior:smooth;box-shadow:0 0 10px #e7daff}.markdown-body pre&gt;code:hover{box-shadow:0 0 20px #e7daff}.markdown-body pre&gt;code::-webkit-scrollbar{height:6px;background-color:#f8f5ff}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:#e7daff;border-bottom-left-radius:3px;border-bottom-right-radius:3px}.markdown-body hr{margin:2em 0;border-top:1px solid #a862ea}.markdown-body table{width:100%;font-size:12px;max-width:100%;overflow:auto;border-collapse:collapse}.markdown-body thead{color:#a862ea;background:#f8f5ff}.markdown-body td,.markdown-body th{padding:.5em;border:1px solid #e7daff}.markdown-body tr{background-color:#f8f5ff}@media (max-width:720px){.markdown-body{font-size:12px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>本文较长，建议点赞收藏。更多AI大模型应用开发学习视频及资料，在<a href="https://link.juejin.cn?target=https%3A%2F%2Fhy.zhipoai.cn%2F" target="_blank" title="https://hy.zhipoai.cn/" ref="nofollow noopener noreferrer">智泊AI</a>。</p>
</blockquote>
<p><strong>一、LangChain到底是什么</strong></p>
<p>LangChain是一个开源框架，用于开发由大语言模型(LLMs)驱动的应用程序，比如，搭建智能体（Agent）、问答系统（QA）、对话机器人、文档搜索系统、企业私有化知识库等。</p>
<p><strong>简单概括：</strong></p>
<ul>
<li>LangChain ≠ LLMs</li>
<li>LangChain 之于LLMs，类似Spring之于Java</li>
<li>LangChain 之于LLMs，类似Django、Flask之于Python</li>
</ul>
<p>LangChain中的Lang指language，即大预言模型，Chain 即 链，也就是将大模型与外部数据&amp;各种组件链接成链，以此构建AI应用程序</p>
<p><strong>1、LangChain的使用场景</strong></p>








































<table><thead><tr><th>项目名称</th><th>技术点</th><th>难度</th></tr></thead><tbody><tr><td>文档问答助手</td><td>Prompt + Embedding +RetrievalQA</td><td>⭐⭐</td></tr><tr><td>智能日程助手</td><td>Agent + Tool + Memory</td><td> ⭐⭐⭐</td></tr><tr><td>LLM+数据库问答</td><td>SQLDatabaseToolkit + Agent</td><td> ⭐⭐⭐⭐</td></tr><tr><td>多模型路由对话系统</td><td>RouterChain + 多 LLM</td><td> ⭐⭐⭐⭐</td></tr><tr><td>互联网智能客服</td><td>ConversationChain + RAG +Agent</td><td> ⭐⭐⭐⭐⭐</td></tr><tr><td>企业知识助手（RAG+本地模型）</td><td>VectorDB + LLM + Streamlit</td><td> ⭐⭐⭐⭐⭐</td></tr></tbody></table>
<p>比如：知识库的架构</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6ebd35376fc346bfb66bcf2a006bbacf~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn5qih5Z6L5pWZ56iL:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764905206&amp;x-signature=ZluEqc8Pv5oML20pW52S42e2sow%3D" alt="图片" loading="lazy"/></p>
<p><strong>2、LangChain的资料介绍</strong></p>
<ul>
<li>官网地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.langchain.com%2Flangchain" target="_blank" title="https://www.langchain.com/langchain" ref="nofollow noopener noreferrer">www.langchain.com/langchain</a></li>
<li>官网文档：<a href="https://link.juejin.cn?target=https%3A%2F%2Fpython.langchain.com%2Fdocs%2Fintroduction%2F" target="_blank" title="https://python.langchain.com/docs/introduction/" ref="nofollow noopener noreferrer">python.langchain.com/docs/introd…</a></li>
<li>API文档：<a href="https://link.juejin.cn?target=https%3A%2F%2Fpython.langchain.com%2Fapi_reference%2F" target="_blank" title="https://python.langchain.com/api_reference/" ref="nofollow noopener noreferrer">python.langchain.com/api_referen…</a></li>
<li>github地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Flangchain-ai%2Flangchain" target="_blank" title="https://github.com/langchain-ai/langchain" ref="nofollow noopener noreferrer">github.com/langchain-a…</a></li>
</ul>
<p><strong>3、LangChain内部结构</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f430b4ed7a1245d9bbdad9734c3b4914~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn5qih5Z6L5pWZ56iL:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764905206&amp;x-signature=xrILXA1zAw4LhntqPrtA1wUzBnY%3D" alt="图片" loading="lazy"/></p>
<p> 图中展示了LangChain生态系统的主要组件及其分类，分为三个层次：架构(Architecture)、组件(Components)和部署(Deployment)。</p>
<p><strong>结构1</strong>：LangChain --就是AI应用组装套件，封装了一堆API。整体框架不大，但是内部琐碎的知识点特别多</p>
<ul>
<li>langchain：构成应用程序认知架构的Chains、Agent、Retrieval strategies等。构成应用程序的链、智能体、RAG</li>
<li>langchain-community：第三方集成，比如：Model I/O、Retrieval、Tool &amp; Toolkit；合作伙伴包 langchain-openai，langchain-anthropic等</li>
<li>langchain-Core：基础抽象和表达式语言(LCEL)</li>
</ul>
<p><strong>结构2</strong>：LangGraph --基于langchain的api进一步的封装，能够协调多个Chain、Agent、Tools完成更复杂的任务，实现更高级的功能 </p>
<p><strong>结构3</strong>：LangSmith ---链路追踪；提供了6大功能，与langchain无缝对接，帮组从原型阶段过度到生成阶段</p>
<ul>
<li>Debugging 调试</li>
<li>Playground 沙盒</li>
<li>Prompt Management 提供管理</li>
<li>Annotation 注释</li>
<li>Testing 测试</li>
<li>Monitoring 监控</li>
</ul>
<p><strong>结构4</strong>：LangServe -- 将langchain的可运行项和链部署为REST API，使得它们可以通过网络进行调用；java怎么调用langchain呢？就通过langserve，将langchain应用包装成一个rest api，对外暴露服务。同时支持更高的并发，稳定性更好。</p>
<p>总结：langchain当中，最有前途的两个模块是：LangGraph、LangSmith </p>
<p><strong>二、LangChain安装</strong></p>
<p><strong>1、相关环境安装</strong></p>
<p>官网下载python进行安装，或者使用包管理工具（Anaconda）进行安装，通过Anaconda创建和管理虚拟环境，为项目提供独立的依赖空间，避免不同项目之间的依赖关系</p>
<p><strong>1）conda的安装</strong> --官网下载地址:<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.anaconda.com%2Fdownload%2Fsuccess" target="_blank" title="https://www.anaconda.com/download/success" ref="nofollow noopener noreferrer">www.anaconda.com/download/su…</a>   安装是勾选在用户环境变量的Path中添加相应路径</p>
<p><strong>2）验证安装是否成功</strong>，cmd--输入 conda info</p>
<p><strong>3）Conda常用命令</strong></p>
<pre><code class="hljs language-python" lang="python">conda -<span class="hljs-built_in">help</span>            <span class="hljs-comment"># 查看帮助</span>
conda info             <span class="hljs-comment"># 查看 conda 信息</span>
conda --version        <span class="hljs-comment"># 查看 conda 版本</span>
conda update conda     <span class="hljs-comment"># 更新 Conda (慎用)</span>
conda clean -<span class="hljs-built_in">all</span>      <span class="hljs-comment"># 清理不再需要的包</span>
conda &lt;指令&gt; --<span class="hljs-built_in">help</span>     <span class="hljs-comment"># 查看某一个指令的详细帮助</span>
conda config --show    <span class="hljs-comment"># 查看 conda 的环境配置</span>
conda clean -p         <span class="hljs-comment"># 清理没有用, 没有安装的包</span>
conda clean -t         <span class="hljs-comment"># 清理 tarball</span>
conda clean --<span class="hljs-built_in">all</span>      <span class="hljs-comment"># 清理所有包和 conda 的缓存文件</span>
</code></pre>
<p><strong>4）环境管理</strong></p>
<p><strong>|-- 创建conda环境</strong></p>
<p>使用conda可以在电脑上创建很多套相互隔离的python环境，命令：</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># 创建一个名为 myenv 的环境, python 版本为3.10</span>
conda create --name myenv <span class="hljs-attr">python</span>=<span class="hljs-number">3.10</span> <span class="hljs-comment"># --name 可以简写为 -n</span>
</code></pre>
<p><strong>|-- 切换conda环境</strong></p>
<pre><code class="hljs language-bash" lang="bash"> <span class="hljs-comment">#语法 可以切换不同的环境</span>
conda activate env_name

<span class="hljs-comment">#样例 切换到 my_env环境</span>
conda activate my_env
</code></pre>
<p><strong>|-- 如果要退出当前环境</strong></p>
<pre><code class="hljs">conda deactivate
</code></pre>
<h4 data-id="heading-0">|-- 查看 Conda 环境</h4>
<h4 data-id="heading-1">当电脑上安装了很多台 Conda环境的时候，可以使用 <code>conda env list</code> 命令查看所有已创建的 Conda环境。</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 查看当前电脑上所有的 conda环境</span>
conda <span class="hljs-built_in">env</span> list
</code></pre>
<h4 data-id="heading-2">|-- 删除某个 Conda 环境</h4>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-meta"># 语法</span>
conda <span class="hljs-keyword">remove</span> --name &lt;env_name&gt; --all
<span class="hljs-meta"># 样例</span>
conda <span class="hljs-keyword">remove</span> --name learn --all
</code></pre>
<h4 data-id="heading-3">|-- 克隆环境</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 语法</span>
conda create --name &lt;new_evn_name&gt; --<span class="hljs-built_in">clone</span> &lt;old_env_name&gt;<span class="hljs-comment">#样例</span>
conda create --name myclone --<span class="hljs-built_in">clone</span> myenv
</code></pre>
<h3 data-id="heading-4">5）包管理</h3>
<p>一旦激活了环境，你就可以使用 <code>conda</code>和 <code>pip</code>在当前环境下安装你所需要的包。在conda环境中, 不建议使用 <code>pip</code>。</p>
<h4 data-id="heading-5">|--  安装包</h4>
<p>在激活的环境中安装包，例如安装NumPy：</p>
<pre><code class="hljs">conda install numpy
</code></pre>
<p>可以使用以下命令安装特定版本的包：</p>
<pre><code class="hljs language-ini" lang="ini">conda install <span class="hljs-attr">numpy</span>=<span class="hljs-number">1.18</span>
</code></pre>
<h4 data-id="heading-6">|--  更新包</h4>
<p>更新某个包到最新版本：</p>
<pre><code class="hljs language-sql" lang="sql">conda <span class="hljs-keyword">update</span> numpy
​
#更新所有包到最新版本 (慎用)
conda <span class="hljs-keyword">update</span> <span class="hljs-comment">--all</span>
</code></pre>
<p>执行命令后，conda将会对版本进行比较并列出可以升级的版本。同时，也会告知用户其他相关包也会升级到相应版本。当较新的版本可以用于升级时，终端会显示Proceed([y]/n)? , 此时输入y 即可进行升级。</p>
<h4 data-id="heading-7">|-- 卸载包</h4>
<p>如果不再需要某个包，可以将其卸载：</p>
<pre><code class="hljs language-arduino" lang="arduino">conda remove numpy
</code></pre>
<h4 data-id="heading-8">|--  列出环境中的所有包</h4>
<p>查看当前环境中已安装的所有包：</p>
<pre><code class="hljs">conda list
</code></pre>
<p>查看当前虚拟环境中已安装的某个包的信息</p>
<pre><code class="hljs">conda list pip
</code></pre>
<h4 data-id="heading-9">|-- 搜索包</h4>
<p>搜索可用的包及其版本信息：</p>
<pre><code class="hljs language-go" lang="go"> conda search <span class="hljs-keyword">package</span>-name
</code></pre>
<p><strong>2、安装langchain包</strong><br/>
可以使用pip进行安装 --&gt;pip install langchain<br/>
也可以使用conda进行安装 </p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># 安装包（默认仓库）</span>
conda install langchain

<span class="hljs-comment"># 指定频道（如 conda-forge）</span>
conda install -c conda-forge <span class="hljs-attr">langchain</span>==<span class="hljs-number">0.3</span>.<span class="hljs-number">7</span>

<span class="hljs-comment"># 更新包</span>
conda update langchain

<span class="hljs-comment"># 卸载包</span>
conda uninstall langchain

<span class="hljs-comment"># 查看已安装包  conda 安装的包显示频道，pip安装的显示 pypi</span>
conda list

-c ：是 --channel 的缩写，conda⽤于指定包的安装来源渠道。
conda-forge ：该源⽐官⽅默认渠道更新更快、包更全

<span class="hljs-comment">#建议： 二者最好不好混用，推荐先conda装基础包，后 pip补充的顺序。</span>
</code></pre>
<p><strong>二、大模型RAG&amp;Agent开发知识</strong></p>
<p><strong>1、基于RAG架构的开发</strong></p>
<p>RAG主要是为了解决大模型幻觉和知识冻结</p>
<p>何为RAG？ Retrieval-Augmented Generation（检索增强生成）</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c1898384ccf74902911511668bafd7ba~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn5qih5Z6L5pWZ56iL:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764905206&amp;x-signature=0Bc28WhAXqcmcMx2HxEnDiHahx0%3D" alt="图片" loading="lazy"/></p>
<p> 细节图：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b0aebf6d891e417e948a0c30f592ec94~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn5qih5Z6L5pWZ56iL:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764905206&amp;x-signature=DNEeiETHNwE3z6H4Q5KtGmJ0orU%3D" alt="图片" loading="lazy"/></p>
<p> 强调一下难点的步骤：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/091f8527ec7c4b9886993fcc1f40cbfe~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn5qih5Z6L5pWZ56iL:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764905206&amp;x-signature=i7A8ASzlOsYWYB1bD15kVPvx%2BI0%3D" alt="图片" loading="lazy"/></p>
<p> 整体在开发过程中蓝色部分是难点：1、文件解析  2、文件切割  3、知识检索  4、知识重排序（Reranker）</p>
<p>Reranker的使用场景：</p>
<ul>
<li>适合：追求回答高精度和高相关性的场景中特别适合使用Reranker，例如专业知识库或者客服系统等应用</li>
<li>不适合：引入后会增加召回时间，增加检索延迟。对响应要求高的服务就不太适合</li>
</ul>
<p>RAG有三处涉及到大模型的使用：</p>
<ul>
<li>第3步向量化时，需要使用切入模型（EmbeddingModels）</li>
<li>第7步重排序时，需要使用排序模型（RerankerModels）</li>
<li>第9步生成答案时，需要使用LLM</li>
</ul>
<p> 2 <strong>、基于Agent架构的开发</strong></p>
<p>利用LLM的推理决策能力，通过增强规划、记忆和工具调用的能力，构造一个能够独立思考逐步完成给定目标的智能体</p>
<p>Agent的架构：<strong>Agent = LLM +Memory+Tools+Planning+Action</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4dbd1bcc267043888dbad04c8f1eb528~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn5qih5Z6L5pWZ56iL:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764905206&amp;x-signature=RP1J8vGqEaVK6OxLl%2FKJM5Nb104%3D" alt="图片" loading="lazy"/></p>
<p>智能体的核心要素：</p>
<ul>
<li>
<p>LLM：作为大脑，主要提供推理、规划、知识理解能力、是AI Agent的决策中枢</p>
</li>
<li>
<p>记忆（Memory）：记忆机制能让智能体在处理重复工作时调用以前的经验，从而避免用户进行大量重复交互</p>
<ul>
<li>短期记忆：存储单次对话周期的上下文信息，属于临时信息存储机制。受限于模型上下文窗口长度</li>
<li>长期记忆：可以横跨多个任务或时间周期，可存储并调用核心知识，非即时任务；可以通过模型参数微调（固话知识）、知识图谱（结构化语义网络）或向量数据库（相似性检索）方式实现</li>
</ul>
</li>
<li>
<p>工具使用（Tool Use）：调用外部工具，扩展能力边界</p>
</li>
<li>
<p>规划决策（Planning）：通过任务分解、反思与自省框架实现复杂任务处理。例如：把一个任务拆解成多个子任务，并通过与用户反馈随时优化策略</p>
</li>
<li>
<p>行动（Action）：实际执行策略的模块，涵盖软件接口操作和物理交互 。比如：检索、推理、变成等</p>
</li>
</ul>
<p><strong>3、大模型应用开发的四个场景</strong></p>
<p>场景1：纯Prompt</p>
<ul>
<li>Prompt是操作大模型的唯一接口，当用户说一句，ta回一句，在说一句，ta在回一句</li>
</ul>
<p>场景2：Agent+Function Calling</p>
<ul>
<li>Agent：AI主动提要求</li>
<li>Function Calling：需要对接外部系统时，AI要求执行某个函数</li>
<li>当人看：你问ta[ 十一要去新疆旅游需要穿什么衣服]，ta会让你查看天气预报，你看了告诉ta，ta在告诉你要穿什么衣服</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c502df79322e4fefb180bce40519c420~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn5qih5Z6L5pWZ56iL:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764905206&amp;x-signature=faauzd%2BocDfXlmbKHzxm7L%2FT2PE%3D" alt="图片" loading="lazy"/>场景3：RAG（Retrieval-Augmented Generation）</p>
<p>RAG：需要补充领域知识时使用</p>
<ul>
<li>Embeddings：把文字转换成更易于相似度计算的编码。这种编码叫向量</li>
<li>向量数据库：把向量存起来，方便查找</li>
<li>向量搜索：根据输入量，找到最相似的向量</li>
</ul>
<p>举例：考试答题时，到书上找相关内容，在结合题目组成答案</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a2f1612b6513456f860f96d9e362dd9b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn5qih5Z6L5pWZ56iL:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764905206&amp;x-signature=NKmDWvfKPCZQPoem1RwSQFaMcpQ%3D" alt="图片" loading="lazy"/></p>
<p> 场景4：Fine-tuning（精调/微调）</p>
<p>举例：努力学习考试内容，长期记住，活学活用</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/51188464ba31447a8cc96a984fa1cad1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn5qih5Z6L5pWZ56iL:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764905206&amp;x-signature=Z2Jd%2F4jkm2ux%2BT%2BeM95qqBPMpr8%3D" alt="图片" loading="lazy"/></p>
<p> 特点：成本最高；在前面的方式解决不了问题的情况下，在使用</p>
<p><strong>如何选择：</strong></p>
<p>面对一个需求，如何开始，如何选择技术方案？下面是个常用思路：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4075536d943d45808f5ae2081faf2602~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn5qih5Z6L5pWZ56iL:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764905206&amp;x-signature=Hew3tmQ1YZ4KqO4FRxuD4WKeJXM%3D" alt="图片" loading="lazy"/></p>
<p><strong>三 <strong>、</strong> LangChain核心组件</strong></p>
<p>langchain的核心组件涉及到六大模块，这六大模块提供了一个全面且强大的框架，使开发者能够创建复杂，高效且用户友好的基于大模型的应用</p>
<p> </p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8fc23fd2cd1a451f91a0763461eee628~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn5qih5Z6L5pWZ56iL:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764905206&amp;x-signature=PclcCmRYSOghurqdXhq%2Bh1iwssY%3D" alt="图片" loading="lazy"/></p>
<p><strong>核心组件1：Model  I/O</strong></p>
<p>model I/O：标准化各个大模型的输入和输出，包含输入模版，模型本身和格式化输出。 ---&gt;这个模块使用最多，也最简单</p>
<p> </p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0fbc39e62e1f4b1c9070c46d361f09bf~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn5qih5Z6L5pWZ56iL:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764905206&amp;x-signature=0SSF9chqeFfwimzFzTRUn%2F%2FbFvE%3D" alt="图片" loading="lazy"/></p>
<ul>
<li><strong>Format（格式化）</strong> ：指代Prompts   Template，通过模版管理大模型的输入。将原始数据格式化成模型可以处理的形式，插入到一个模版问题中，然后送入模型进行处理</li>
<li><strong>Predict（预测）</strong> ：指代Models，使用通用接口调用不同得到大语言模型。接收被送进来的问题，然后基于这个问题进行预测或生成回答</li>
<li><strong>Parse（生成</strong>）：指代Output Parser部分，用来从模型的推理中提取信息，并按照预先设定好得到模版来规范化输出。比如：格式化成一个结构化的JSON对象</li>
</ul>
<p><strong>核心组件2：Chains</strong></p>
<p>Chain：“链条”，用于将对个模块串联起来组成一个完整的流程，是langchain框架中最重要的模块。--&gt;例如：一个Chain可能包括一个Prompt模版、一个语言模型和一个输出解析器，他们一起工作以处理用户输入，生成响应并处理输出。</p>
<p>常见的Chain类型：</p>
<ul>
<li>LLMChain：最基础的模型调用链</li>
<li>SequentialChain：多个链串联执行</li>
<li>RouterChain：自动分析用户的需求，引导到最适合的链</li>
<li>RetrievalQA：结合向量数据库进行过问答的链</li>
</ul>
<p><strong>核心组件3：Memory</strong></p>
<p>Memory：记忆模块，用户保存对话历史或上下文信息，以便在后续对话中使用</p>
<p>常见的Memory类型：</p>
<ul>
<li>ConversationBufferMemory：保存完整的对话历史</li>
<li>ConversationSummaryMemory：保存对话内容的精简摘要（适合长对话）</li>
<li>ConversationSummaryBufferMemory：混合型记忆机制，兼具上面两个类型的特点</li>
<li>VectorStoreRetrieverMemory：保存对话历史存储在向量数据库中</li>
</ul>
<p><strong>核心组件4：Agent</strong></p>
<p>Agents对应智能体，是langchain的高阶能力，ta可以自主选择工具并规划执行步骤</p>
<p>关键组成部分：</p>
<ul>
<li>AgentType：定义决策逻辑的工作流模式</li>
<li>Tool：是有一些内置的功能模块，如API调用、搜索引擎、文本处理、数据查询等工具。Agents通过这些工具来执行特定的功能</li>
<li>AgentExecutor：用来运行智能体并执行其决策的工具，负责</li>
</ul>
<p><strong>核心组件5：Retrieval</strong></p>
<p>Retrieval：对应着RAG，检索外部数据，然后在执行生成步骤时将其传递到LLM。步骤包括文档加载、切割、Embedding等</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2c1d0bb48c664942ada566ff526bbf00~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn5qih5Z6L5pWZ56iL:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764905206&amp;x-signature=0f9K3QWtO7tDMdd8bau52fdg5kI%3D" alt="图片" loading="lazy"/></p>
<p>上图绿色部分是让入库存储前的操作</p>
<ul>
<li>source：数据源，即大模型可以识别的多种类型的数据：视频、图片、文本、代码、文档等</li>
<li>load：负责将来自不同数据源的非结构化数据，加载为文档（Document）对象</li>
<li>Transform：负责对加载的文档进行转换和处理，比如讲过文本拆分为具有语义意义的 小块</li>
<li>Embed：将文本编码为向量的能力，一种用于嵌入文档，另一种用于嵌入查询</li>
<li>store：将向量化的数据进行存储</li>
<li>Retrieve：从大规模文本库中检索和查询相关的文本段落</li>
</ul>
<p><strong>核心组件6：Callbacks</strong></p>
<p>Callbacks：回调机制，允许连接到LLM应用程序的各个阶段，可以监控和分析LangChain的运行情况，比如日志记录、监控、流传输等等，以优化性能</p>
<p>回调函数允许我们在LLM的各个阶段使用各种各样的“钩子”，从而达实现日志的记录、监控以及流式传输等功能</p>
<p><strong>小结：</strong></p>
<ul>
<li>Model I/O模块：使用最多，也最简单</li>
<li>Chains模块：最重要的模块</li>
<li>Retrieval、Agent模块：大模型的主要落地场</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ec561d61c4474843bafffa4653b2e1c2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn5qih5Z6L5pWZ56iL:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764905206&amp;x-signature=y84ss6EMXtSmEunjSND8v5aKCnI%3D" alt="图片" loading="lazy"/></p>
<p>在这个基础上，其它组件要么是它们的辅助（比如：向量数据库的分块和嵌入），要么只是完成常规应用程序的任务</p>
<h2 data-id="heading-10">学习资源推荐</h2>
<p>如果你想更深入地学习大模型，以下是一些非常有价值的学习资源，这些资源将帮助你从不同角度学习大模型，提升你的实践能力。</p>
<blockquote>
<p>本文较长，建议点赞收藏。更多AI大模型应用开发学习视频及资料，在<a href="https://link.juejin.cn?target=https%3A%2F%2Fhy.zhipoai.cn%2F" target="_blank" title="https://hy.zhipoai.cn/" ref="nofollow noopener noreferrer">智泊AI</a>。</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[如何自己构建一个Markdown增量渲染器]]></title>    <link>https://juejin.cn/post/7577313637950652425</link>    <guid>https://juejin.cn/post/7577313637950652425</guid>    <pubDate>2025-11-28T02:47:29.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577313637950652425" data-draft-id="7577313637950406665" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="如何自己构建一个Markdown增量渲染器"/> <meta itemprop="keywords" content="前端,JavaScript"/> <meta itemprop="datePublished" content="2025-11-28T02:47:29.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="隔壁的大叔"/> <meta itemprop="url" content="https://juejin.cn/user/1714893871660205"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            如何自己构建一个Markdown增量渲染器
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1714893871660205/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    隔壁的大叔
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-28T02:47:29.000Z" title="Fri Nov 28 2025 02:47:29 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-28
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">揭秘 Vue3 增量 Markdown 解析组件的神奇魔法</h2>
<p>先上效果 <a href="https://link.juejin.cn?target=https%3A%2F%2Fxhy12345.github.io%2F" target="_blank" title="https://xhy12345.github.io/" ref="nofollow noopener noreferrer">演示demo</a></p>
<h3 data-id="heading-1">背景</h3>
<p>相信很多大模型前端开发的小伙伴都已经处理过markdown实时解析翻译成html了，传统的方式类似使用Marked、markdown-it等组件全量渲染。但是全量渲染及其消耗性能，会造成大量的重排、重绘，导致页面抖动。</p>
<p>各位前端小伙伴们，今天我要给大家分享一个我最近开发的「Vue3 增量 Markdown 解析组件」。这个组件就像是一个「超级翻译官」，能把枯燥的 Markdown 文本瞬间变成生动的 HTML 页面，而且还支持数学公式、代码高亮等高级功能！废话不多说，让我们一起深入这个组件的「内部世界」吧！</p>
<p>开箱即用模式</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-meta"># 安装命令</span>
npm install v3-markdown-stream
<span class="hljs-meta"># 或</span>
yarn <span class="hljs-keyword">add</span> v3-markdown-stream
</code></pre>
<p>组件使用示例</p>
<pre><code class="hljs language-vue" lang="vue">&lt;template&gt;
  &lt;div&gt;
    &lt;MarkdownRender :markInfo="markdownContent" /&gt;
  &lt;/div&gt;
&lt;/template&gt;

&lt;script setup&gt;
import { ref } from 'vue'
import { MarkdownRender } from 'v3-markdown-stream';
import 'v3-markdown-stream/dist/v3-markdown-stream.css';

// 静态内容
const markdownContent = ref('# Hello World\n\nThis is a simple markdown example.')
&lt;/script&gt;
</code></pre>
<h3 data-id="heading-2">组件概览</h3>
<p>首先，让我们来看看这个组件的「身份证」(<mark>都是站在各位巨人的肩膀上</mark>）</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> { h, defineComponent, computed } <span class="hljs-keyword">from</span> <span class="hljs-string">"vue"</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Fragment</span>, jsxs, jsx } <span class="hljs-keyword">from</span> <span class="hljs-string">"vue/jsx-runtime"</span>;
<span class="hljs-keyword">import</span> { toJsxRuntime } <span class="hljs-keyword">from</span> <span class="hljs-string">"hast-util-to-jsx-runtime"</span>;
<span class="hljs-keyword">import</span> remarkParse <span class="hljs-keyword">from</span> <span class="hljs-string">"remark-parse"</span>;
<span class="hljs-keyword">import</span> rehypeKatex <span class="hljs-keyword">from</span> <span class="hljs-string">"rehype-katex"</span>;
<span class="hljs-keyword">import</span> <span class="hljs-string">"katex/dist/katex.min.css"</span>;
<span class="hljs-keyword">import</span> <span class="hljs-string">'highlight.js/styles/github-dark.css'</span>;
<span class="hljs-keyword">import</span> remarkMath <span class="hljs-keyword">from</span> <span class="hljs-string">"remark-math"</span>;
<span class="hljs-keyword">import</span> remarkRehype <span class="hljs-keyword">from</span> <span class="hljs-string">"remark-rehype"</span>;
<span class="hljs-keyword">import</span> rehypeRaw <span class="hljs-keyword">from</span> <span class="hljs-string">'rehype-raw'</span>;
<span class="hljs-keyword">import</span> rehypeHighlight <span class="hljs-keyword">from</span> <span class="hljs-string">'rehype-highlight'</span>
<span class="hljs-keyword">import</span> remarkFlexibleContainers <span class="hljs-keyword">from</span> <span class="hljs-string">'remark-flexible-containers'</span>
<span class="hljs-keyword">import</span> remarkGfm <span class="hljs-keyword">from</span> <span class="hljs-string">"remark-gfm"</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">VFile</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"vfile"</span>;
<span class="hljs-keyword">import</span> { unified } <span class="hljs-keyword">from</span> <span class="hljs-string">"unified"</span>;

<span class="hljs-comment">// 定义组件</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title function_">defineComponent</span>({
    <span class="hljs-attr">name</span>: <span class="hljs-string">'VueMarkdownStreamRender'</span>,
    <span class="hljs-attr">props</span>: {
        <span class="hljs-attr">markstr</span>: {
            <span class="hljs-attr">type</span>: <span class="hljs-title class_">String</span>,
            <span class="hljs-attr">required</span>: <span class="hljs-literal">true</span>,
            <span class="hljs-attr">default</span>: <span class="hljs-string">''</span>
        }
    },
    <span class="hljs-comment">// 其他实现...</span>
})
</code></pre>
<p>这个组件就像是一个「瑞士军刀」，集成了多种功能，让 Markdown 解析变得异常强大！</p>
<h3 data-id="heading-3">核心功能包解析 - 武林高手们的各司其职</h3>
<h4 data-id="heading-4">1. Vue 核心团队</h4>
<ul>
<li>vue : 提供 h , defineComponent , computed 等核心 API，是整个组件的「骨架」</li>
<li>vue/jsx-runtime : 提供 Fragment , jsxs , jsx ，让我们可以在 Vue 中优雅地使用 JSX 语法，相当于给 Vue 「装上了 React 的小翅膀」</li>
</ul>
<h4 data-id="heading-5">2. Unified 解析系统 - 解析界的「中央司令部」</h4>
<ul>
<li>unified : 这是整个解析系统的「大脑」，负责协调各个插件的工作。想象一下，它就像是一个「指挥官」，指挥着一群「小兵」（插件）协同作战</li>
<li>vfile : 提供文件处理功能，把 Markdown 字符串转换成统一的文件格式，相当于给文本「穿上了标准化的衣服」</li>
</ul>
<h4 data-id="heading-6">3. Remark 家族 - Markdown 的「魔法师」</h4>
<ul>
<li>remark-parse : 将 Markdown 文本解析成抽象语法树(AST)，就像是「翻译官」把中文翻译成一种中间语言</li>
<li>remark-math : 处理数学公式，让你的文档可以「高大上」地展示复杂数学表达式</li>
<li>remark-rehype : 将 Markdown AST 转换成 HTML AST，相当于「转换器」把中间语言翻译成另一种中间语言</li>
<li>remark-gfm : 支持 GitHub 风格的 Markdown 扩展功能，比如表格、任务列表等，让你的 Markdown 「与时俱进」</li>
<li>remark-flexible-containers : 提供灵活的容器功能，让你的内容布局更加多样化，就像是给内容「准备了各种形状的容器」</li>
</ul>
<h4 data-id="heading-7">4. Rehype 家族 - HTML 的「美容师」</h4>
<ul>
<li>rehype-raw : 保留原始 HTML，让你的 Markdown 中混合的 HTML 代码也能正常工作，相当于「允许特殊人才保留自己的特色」</li>
<li>rehype-katex : 将数学公式渲染成漂亮的 HTML，让数学表达式「穿上漂亮的衣服」</li>
<li>rehype-highlight : 为代码块提供语法高亮，让你的代码「光彩照人」</li>
</ul>
<h4 data-id="heading-8">5. 样式支持 - 颜值担当</h4>
<ul>
<li>katex.min.css : 数学公式的「时尚服饰」</li>
<li>github-dark.css : 代码高亮的「炫酷皮肤」</li>
</ul>
<h3 data-id="heading-9">实现原理大揭秘 - 从文本到页面的神奇旅程</h3>
<h4 data-id="heading-10">1. 组件结构设计</h4>
<p>组件使用 Vue3 的 defineComponent 定义，接收一个必须的 markstr 属性，这是要解析的 Markdown 字符串。整个组件的设计非常简洁，就像一个「专注的翻译官」，只做一件事，但要做到极致！</p>
<h4 data-id="heading-11">2. 解析器链的构建</h4>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">let</span> unifiedProcessor = <span class="hljs-title function_">computed</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">const</span> processor = <span class="hljs-title function_">unified</span>()
        .<span class="hljs-title function_">use</span>(remarkParse, { <span class="hljs-attr">allowDangerousHtml</span>: <span class="hljs-literal">true</span>})
        .<span class="hljs-title function_">use</span>(remarkFlexibleContainers)
        .<span class="hljs-title function_">use</span>(remarkRehype, { <span class="hljs-attr">allowDangerousHtml</span>: <span class="hljs-literal">true</span>})
        .<span class="hljs-title function_">use</span>(rehypeRaw)
        .<span class="hljs-title function_">use</span>(remarkGfm)
        .<span class="hljs-title function_">use</span>(rehypeKatex)
        .<span class="hljs-title function_">use</span>(remarkMath)
        .<span class="hljs-title function_">use</span>(rehypeHighlight);

    <span class="hljs-keyword">return</span> processor;
});
</code></pre>
<p>这部分代码构建了一个「解析流水线」，就像工厂里的生产线一样，Markdown 文本会依次经过各个「加工环节」。这里使用 computed 确保解析器只在必要时重新创建，提高了性能。</p>
<h4 data-id="heading-12">3. 文件转换与 AST 处理</h4>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> <span class="hljs-title function_">createFile</span> = (<span class="hljs-params">markstr</span>) =&gt; {
    <span class="hljs-keyword">const</span> file = <span class="hljs-keyword">new</span> <span class="hljs-title class_">VFile</span>();
    file.<span class="hljs-property">value</span> = markstr;
    <span class="hljs-keyword">return</span> file;
};

<span class="hljs-keyword">const</span> <span class="hljs-title function_">generateVueNode</span> = (<span class="hljs-params">tree</span>) =&gt; {
    <span class="hljs-keyword">const</span> vueVnode = <span class="hljs-title function_">toJsxRuntime</span>(tree, {
        <span class="hljs-title class_">Fragment</span>,
        <span class="hljs-attr">jsx</span>: jsx,
        <span class="hljs-attr">jsxs</span>: jsxs,
        <span class="hljs-attr">passNode</span>: <span class="hljs-literal">true</span>,
    });
    <span class="hljs-keyword">return</span> vueVnode;
};
</code></pre>
<p>这两个函数分别负责：</p>
<ul>
<li>createFile : 将 Markdown 字符串包装成 VFile 对象，就像是给文本「准备好行李，准备出发」</li>
<li>generateVueNode : 将解析后的 AST 树转换成 Vue 的虚拟 DOM 节点，相当于「将中间语言翻译成最终的目标语言」</li>
</ul>
<h4 data-id="heading-13">4. 响应式渲染</h4>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> computedVNode = <span class="hljs-title function_">computed</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">const</span> processor = unifiedProcessor.<span class="hljs-property">value</span>;
    <span class="hljs-keyword">const</span> file = <span class="hljs-title function_">createFile</span>(props.<span class="hljs-property">markstr</span>);
    <span class="hljs-keyword">let</span> result = <span class="hljs-title function_">generateVueNode</span>(processor.<span class="hljs-title function_">runSync</span>(processor.<span class="hljs-title function_">parse</span>(file), file));
    <span class="hljs-keyword">return</span> result;
});

<span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">return</span> <span class="hljs-title function_">h</span>(computedVNode.<span class="hljs-property">value</span>);
};
</code></pre>
<p>这里是整个组件的「核心驱动」：</p>
<ul>
<li>使用 computed 响应式地计算虚拟 DOM，当 markstr 变化时，会自动重新解析并渲染</li>
<li>processor.parse(file) 将文件解析成 AST</li>
<li>processor.runSync(...) 运行所有插件处理 AST</li>
<li>最后通过 h() 函数将生成的虚拟 DOM 渲染到页面上</li>
</ul>
<h3 data-id="heading-14">技术亮点与设计精髓</h3>
<ol>
<li>响应式设计 : 利用 Vue3 的 computed ，实现了 Markdown 字符串变化时的自动重新解析和渲染</li>
<li>模块化插件链 : 采用统一的插件系统，各功能模块解耦，可以灵活地添加或移除功能</li>
<li>高性能优化 : 通过 computed 缓存解析器和虚拟 DOM，避免不必要的重复计算</li>
<li>丰富的功能支持 : 支持数学公式、代码高亮、GitHub 风格扩展等高级功能</li>
<li>错误处理机制 : 提供了 errorCaptured 钩子，捕获并记录解析过程中的错误</li>
</ol>
<h3 data-id="heading-15">代码优化建议</h3>
<p>虽然这个组件已经相当优秀，但还有一些小地方可以进一步完善：</p>
<ol>
<li>插件顺序优化 : 目前的插件顺序可能不是最优的，建议调整为更合理的顺序：</li>
</ol>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> processor = <span class="hljs-title function_">unified</span>()
    .<span class="hljs-title function_">use</span>(remarkParse, { <span class="hljs-attr">allowDangerousHtml</span>: <span class="hljs-literal">true</span>})
    .<span class="hljs-title function_">use</span>(remarkGfm) <span class="hljs-comment">// GFM 应该在 early 阶段</span>
    .<span class="hljs-title function_">use</span>(remarkMath) <span class="hljs-comment">// 数学支持也应该 early</span>
    .<span class="hljs-title function_">use</span>(remarkFlexibleContainers)
    .<span class="hljs-title function_">use</span>(remarkRehype, { <span class="hljs-attr">allowDangerousHtml</span>: <span class="hljs-literal">true</span>})
    .<span class="hljs-title function_">use</span>(rehypeRaw)
    .<span class="hljs-title function_">use</span>(rehypeHighlight) <span class="hljs-comment">// 代码高亮应该在 katex 之前</span>
    .<span class="hljs-title function_">use</span>(rehypeKatex); <span class="hljs-comment">// 数学渲染作为最后一步</span>
</code></pre>
<ol>
<li>异步解析支持 : 考虑添加异步解析模式，对于大型文档可以提高性能和用户体验</li>
<li>缓存机制 : 可以添加基于内容哈希的缓存，避免相同内容的重复解析</li>
<li>错误边界 : 增强错误处理，提供更友好的错误提示给用户</li>
</ol>
<h3 data-id="heading-16">总结</h3>
<p>这个 Vue3 Markdown 解析组件就像是一个「智能翻译官 + 高级排版师」，它不仅能准确地将 Markdown 转换成 HTML，还能让最终的展示效果既美观又功能丰富。通过巧妙地组合各种开源工具，它实现了一个功能完备、性能优良的 Markdown 解析渲染系统。</p>
<p>无论是构建博客、文档系统还是知识库，这个组件都能为你的项目增添强大的内容展示能力。希望这篇文章能帮助你理解这个组件的实现原理，也欢迎大家提出宝贵的改进建议！</p>
<p>最后，如果你觉得这个组件对你有帮助，不妨点个赞并分享给更多的开发者朋友，让我们一起让 Markdown 解析变得更简单、更强大！</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fxhy12345%2Fv3-markdown-stream" target="_blank" title="https://github.com/xhy12345/v3-markdown-stream" ref="nofollow noopener noreferrer">GitHub源码仓库地址</a>
如果觉得好用，欢迎给个Star ⭐️ 支持一下！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[HTML iframe 标签]]></title>    <link>https://juejin.cn/post/7577333742277673002</link>    <guid>https://juejin.cn/post/7577333742277673002</guid>    <pubDate>2025-11-28T02:57:02.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577333742277673002" data-draft-id="7577050643203735602" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="HTML iframe 标签"/> <meta itemprop="keywords" content="前端,JavaScript"/> <meta itemprop="datePublished" content="2025-11-28T02:57:02.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="WILLF"/> <meta itemprop="url" content="https://juejin.cn/user/1447373456540285"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            HTML iframe 标签
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1447373456540285/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    WILLF
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-28T02:57:02.000Z" title="Fri Nov 28 2025 02:57:02 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-28
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一、什么是 <code>&lt;iframe&gt;</code> ?</h2>
<p><code>&lt;iframe&gt;</code> 是一个内联框架，用于在当前<code>HTML</code>文档中嵌入另一个独立的<code>HTML</code>页面。它就像一个“窗口”，通过它可以加载并显示另一个网页的内容，且该内容拥有独立的 <code>DOM</code>、<code>CSS</code>、<code>JavaScript</code>环境。</p>
<p>基本语法如下：</p>
<pre><code class="hljs language-html" lang="html">    <span class="hljs-tag">&lt;<span class="hljs-name">iframe</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"https://example.com"</span> <span class="hljs-attr">width</span>=<span class="hljs-string">"600"</span> <span class="hljs-attr">height</span>=<span class="hljs-string">"400"</span> <span class="hljs-attr">frameborder</span>=<span class="hljs-string">"0"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">iframe</span>&gt;</span>
</code></pre>
<h2 data-id="heading-1">二、核心属性</h2>
<ul>
<li><code>src</code>：嵌入页面的 <code>URL</code></li>
<li><code>width</code> / <code>height</code>：尺寸（可设为 100%）</li>
<li><code>title</code>：描述 <code>iframe</code>内容</li>
<li><code>loading="lazy"</code>：懒加载</li>
<li><code>sandbox</code>：启用安全沙箱</li>
<li><code>allowfullscreen</code>：允许嵌入的网页全屏显示，需要全屏<code>API</code>的支持。</li>
<li><code>frameborder</code>：是否绘制边框，<code>0</code>为不绘制，<code>1</code>为绘制（默认值）。建议尽量少用这个属性，而是在<code>CSS</code>里面设置样式。</li>
</ul>
<h2 data-id="heading-2">三、<code>sandbox</code> 沙箱机制（安全核心！）</h2>
<p>这是<code>&lt;iframe&gt;</code>最重要的安全特性。启用后，默认禁止几乎所有危险操作，除非显式授权。</p>
<p>常用<code>sandbox</code>指令：</p>
<ul>
<li>（空值）：最严格：禁止脚本、表单提交、弹窗、同源访问等。</li>
<li><code>allow-scripts</code>：允许执行<code>JavaScript</code></li>
<li><code>allow-same-origin</code>：允许被视为同源（谨慎！若同时允许脚本，可能绕过沙箱）</li>
<li><code>allow-forms</code>：允许提交表单</li>
<li><code>allow-popups</code>：允许 window.open()</li>
<li><code>allow-top-navigation</code>：允许跳转顶层页面（危险！）</li>
</ul>
<h2 data-id="heading-3">四、跨域通信：<code>postMessage API</code></h2>
<p>由于同源策略，父页面与<code>iframe</code>不能直接访问对方<code>DOM</code>或<code>JS</code>变量。但可通过<code>postMessage</code>安全通信。</p>
<p><strong>父页面 -&gt; iframe</strong></p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 父页面</span>
<span class="hljs-keyword">const</span> iframe = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'my-iframe'</span>)
iframe.<span class="hljs-property">contentWindow</span>.<span class="hljs-title function_">postMessage</span>(
    { <span class="hljs-attr">type</span>: <span class="hljs-string">'AUTH'</span>, <span class="hljs-attr">token</span>: <span class="hljs-string">'xxx'</span> },
    <span class="hljs-string">'https://trusted-oframe.com'</span> <span class="hljs-comment">//指定目标 origin，防泄漏</span>
)
</code></pre>
<p><strong>iframe -&gt; 父页面</strong></p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// iframe 内部</span>
<span class="hljs-variable language_">window</span>.<span class="hljs-property">parent</span>.<span class="hljs-title function_">postMessage</span>(
    { <span class="hljs-attr">type</span>: <span class="hljs-string">'RESIZE'</span>, <span class="hljs-attr">height</span>: <span class="hljs-number">800</span> },
    <span class="hljs-string">'*'</span> <span class="hljs-comment">// 或指定父页面 origin</span>
)
</code></pre>
<p><strong>监听消息（双方都要）</strong></p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'message'</span>, <span class="hljs-function">(<span class="hljs-params">event</span>) =&gt;</span> {
    <span class="hljs-keyword">if</span> (event.<span class="hljs-property">origin</span> !== <span class="hljs-string">'https://expected-parent.com'</span>) <span class="hljs-keyword">return</span>
    <span class="hljs-keyword">if</span> (event.<span class="hljs-property">data</span>.<span class="hljs-property">type</span> === <span class="hljs-string">'AUTH'</span>) {
        <span class="hljs-comment">// 处理token</span>
    }
})
</code></pre>
<h2 data-id="heading-4">五、性能优化建议</h2>
<ul>
<li>懒加载：<code>&lt;iframe loading="lazy"&gt;</code> 减少首屏压力</li>
<li>按需加载：用户点击“展开”后再设置 <code>src</code></li>
<li>避免深层嵌套：<code>iframe</code> 嵌套 <code>iframe</code> 会导致性能雪崩</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[使用Hutool的ExcelWriter导出复杂模板，支持下拉选项级联筛选]]></title>    <link>https://juejin.cn/post/7577295460249321518</link>    <guid>https://juejin.cn/post/7577295460249321518</guid>    <pubDate>2025-11-28T03:10:08.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577295460249321518" data-draft-id="7577295460248895534" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="使用Hutool的ExcelWriter导出复杂模板，支持下拉选项级联筛选"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-11-28T03:10:08.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="雪橇僵尸"/> <meta itemprop="url" content="https://juejin.cn/user/3887517054021976"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            使用Hutool的ExcelWriter导出复杂模板，支持下拉选项级联筛选
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3887517054021976/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    雪橇僵尸
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-28T03:10:08.000Z" title="Fri Nov 28 2025 03:10:08 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-28
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    3
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>昨天刚接了一个导入导出的需求，前端页面有三个下拉选择框有相对应的关联关系。在生成模板的时候也需要把这种关系给设置出来。
最终实现的效果为 A D E三列的数据能够实现级联效果，</p>
<ol>
<li>A列下拉选择之后，根据选择的内容是否包含特定条件，给D设置不同的数据有效性。</li>
<li>D列选择之后，匹配对应的id给X列设置值，</li>
<li>E列的数据有效性根据X列的值匹配对应的数据</li>
<li>Y列的值根据E列的值匹配对应的Code</li>
</ol>
</blockquote>
<h2 data-id="heading-0">1. 具体的实现思路</h2>
<ol>
<li>通过隐藏Sheet页将需要用到的数据写入</li>
<li>通过名称管理器设置数据引用</li>
<li>通过几组特定的函数实现功能</li>
</ol>





















<table><thead><tr><th align="center">函数</th><th align="center">作用</th></tr></thead><tbody><tr><td align="center">IF(ISNUMBER(FIND("中介",A{})),hsAgencyNames,CompanyNames)</td><td align="center">从A列判断是否包含特定字符串，然后设置对应的 名称管理器引用</td></tr><tr><td align="center">IFERROR(VLOOKUP($D{}, CompanyIdMap, 2, FALSE), "")</td><td align="center">根据D列的值，去CompanyIdMap这个名称引用中查询对应的ID</td></tr><tr><td align="center">CompanyData!$A$2:$A:$100</td><td align="center">创建名称管理器的引用范围</td></tr></tbody></table>
<h2 data-id="heading-1">2. 拆分实现</h2>
<h3 data-id="heading-2">1. 导出模板功能</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">downloadTemplateV2</span><span class="hljs-params">(HttpServletResponse response)</span> <span class="hljs-keyword">throws</span> Exception {
    <span class="hljs-comment">// 1. 设置响应头</span>
    response.setContentType(<span class="hljs-string">"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"</span>);
    response.setCharacterEncoding(<span class="hljs-string">"utf-8"</span>);
    <span class="hljs-type">String</span> <span class="hljs-variable">fileName</span> <span class="hljs-operator">=</span> URLEncoder.encode(<span class="hljs-string">"级联导入模板"</span>, <span class="hljs-string">"UTF-8"</span>);
    response.setHeader(<span class="hljs-string">"Content-disposition"</span>, <span class="hljs-string">"attachment;filename*=utf-8''"</span> + fileName + <span class="hljs-string">".xlsx"</span>);
    <span class="hljs-comment">// 从自己的数据库获取数据</span>
    Map&lt;String, CompanyVo&gt; seaCmpNameIdMap = getCompanyMap();
    <span class="hljs-comment">// 根据自己的业务调整</span>
    Map&lt;String, List&lt;Org&gt;&gt; orgMap = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>();

    <span class="hljs-type">String</span> <span class="hljs-variable">topTipStr</span> <span class="hljs-operator">=</span> <span class="hljs-string">"导入提示信息"</span>;
    <span class="hljs-keyword">try</span> (<span class="hljs-type">OutputStream</span> <span class="hljs-variable">out</span> <span class="hljs-operator">=</span> response.getOutputStream()) {
        <span class="hljs-comment">// 2. 创建ExcelWriter</span>
        <span class="hljs-type">ExcelWriter</span> <span class="hljs-variable">writer</span> <span class="hljs-operator">=</span> ExcelUtil.getWriter(<span class="hljs-literal">true</span>); <span class="hljs-comment">// true表示创建xlsx格式</span>
        <span class="hljs-type">Sheet</span> <span class="hljs-variable">sheet</span> <span class="hljs-operator">=</span> writer.getSheet();
        <span class="hljs-type">Workbook</span> <span class="hljs-variable">workbook</span> <span class="hljs-operator">=</span> writer.getWorkbook();
        <span class="hljs-comment">// 写入映射数据到工作表并创建名称管理器</span>
        writeCompanyAndOrgData(workbook, seaCmpNameIdMap, orgMap);
        <span class="hljs-comment">// 设置级联下拉和对应列填充</span>
        setCompanyValidationAndFormula(sheet, workbook);
        setDeptValidationAndFormula(sheet, workbook);

        List&lt;String&gt; headers = Arrays.asList(
                <span class="hljs-string">"表头1"</span>，<span class="hljs-string">"表头2"</span>，<span class="hljs-string">"表头3"</span>，<span class="hljs-string">"表头4"</span>
        );
        writer.merge(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">24</span>, topTipStr, <span class="hljs-literal">true</span>);
        writer.passRows(<span class="hljs-number">1</span>);
        writer.writeHeadRow(headers);

        <span class="hljs-comment">// 日期类型限制</span>
        restrictCell2DateFormat(sheet, <span class="hljs-number">1</span>);;
        <span class="hljs-comment">// 字典项类型的数据下拉设置</span>
        setDictDataValidation(sheet, <span class="hljs-string">"spiChecktypeHs"</span>, <span class="hljs-number">0</span>);
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; headers.size(); i++) {
            <span class="hljs-type">String</span> <span class="hljs-variable">headerText</span> <span class="hljs-operator">=</span> headers.get(i);
            <span class="hljs-comment">// 计算宽度：文字长度 × 2 × 256（Excel的宽度单位）</span>
            <span class="hljs-type">int</span> <span class="hljs-variable">columnWidth</span> <span class="hljs-operator">=</span> headerText.length() * <span class="hljs-number">2</span> * <span class="hljs-number">256</span>;
            <span class="hljs-comment">// 设置最小宽度（避免过窄）</span>
            columnWidth = Math.max(columnWidth, <span class="hljs-number">8</span> * <span class="hljs-number">256</span>);
            <span class="hljs-comment">// 设置列宽</span>
            sheet.setColumnWidth(i, columnWidth);
        }
        writer.flush(out).close();
    } <span class="hljs-keyword">catch</span> (Exception e) {
        log.info(<span class="hljs-string">"下载模板失败"</span>, e);
    }
}
</code></pre>
<h3 data-id="heading-3">2.写入映射数据和创建名称管理器</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">writeCompanyAndOrgData</span><span class="hljs-params">(Workbook workbook, Map&lt;String, HsCompanyVo&gt; seaCmpNameIdMap,
                                    Map&lt;String, List&lt;Org&gt;&gt; orgMap)</span> {
    <span class="hljs-comment">// ========== 1. 写入企业数据 ==========</span>
    <span class="hljs-type">Sheet</span> <span class="hljs-variable">companySheet</span> <span class="hljs-operator">=</span> workbook.createSheet(<span class="hljs-string">"CompanyData"</span>);
    workbook.setSheetHidden(workbook.getSheetIndex(companySheet), <span class="hljs-literal">true</span>);

    <span class="hljs-comment">// 企业数据表头</span>
    <span class="hljs-type">Row</span> <span class="hljs-variable">companyHeader</span> <span class="hljs-operator">=</span> companySheet.createRow(<span class="hljs-number">0</span>);
    companyHeader.createCell(<span class="hljs-number">0</span>).setCellValue(<span class="hljs-string">"企业名称"</span>);
    companyHeader.createCell(<span class="hljs-number">1</span>).setCellValue(<span class="hljs-string">"企业ID"</span>);

    <span class="hljs-type">int</span> <span class="hljs-variable">companyRow</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span>;
    <span class="hljs-keyword">for</span> (Map.Entry&lt;String, HsCompanyVo&gt; entry : seaCmpNameIdMap.entrySet()) {
        <span class="hljs-type">Row</span> <span class="hljs-variable">row</span> <span class="hljs-operator">=</span> companySheet.createRow(companyRow++);
        row.createCell(<span class="hljs-number">0</span>).setCellValue(entry.getKey());
        row.createCell(<span class="hljs-number">1</span>).setCellValue(entry.getValue().getId());
    }

    <span class="hljs-comment">// 创建企业名称列表和ID映射的名称管理器</span>
    <span class="hljs-comment">// 这里我遇到了一个问题， 就是第二个参数也就是名称管理器的名字 必须以_或者 字母开头</span>
    createName(workbook, <span class="hljs-string">"CompanyNames"</span>, <span class="hljs-string">"CompanyData!$A$2:$A$"</span> + companyRow);
    <span class="hljs-comment">// </span>
    createName(workbook, <span class="hljs-string">"CompanyIdMap"</span>, <span class="hljs-string">"CompanyData!$A$2:$B$"</span> + companyRow);
    
    
    <span class="hljs-type">Sheet</span> <span class="hljs-variable">orgSheet</span> <span class="hljs-operator">=</span> workbook.createSheet(<span class="hljs-string">"OrgData"</span>);
    workbook.setSheetHidden(workbook.getSheetIndex(orgSheet), <span class="hljs-literal">true</span>);

    <span class="hljs-comment">// 单位数据表头</span>
    <span class="hljs-type">Row</span> <span class="hljs-variable">orgHeader</span> <span class="hljs-operator">=</span> orgSheet.createRow(<span class="hljs-number">0</span>);
    orgHeader.createCell(<span class="hljs-number">0</span>).setCellValue(<span class="hljs-string">"企业ID"</span>);
    orgHeader.createCell(<span class="hljs-number">1</span>).setCellValue(<span class="hljs-string">"单位名称"</span>);
    orgHeader.createCell(<span class="hljs-number">2</span>).setCellValue(<span class="hljs-string">"单位Code"</span>);

    <span class="hljs-type">int</span> <span class="hljs-variable">orgRow</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span>;
    <span class="hljs-type">int</span> <span class="hljs-variable">startRow</span> <span class="hljs-operator">=</span> <span class="hljs-number">2</span>;
    <span class="hljs-type">String</span> <span class="hljs-variable">orgDataNameNamePrefix</span> <span class="hljs-operator">=</span> <span class="hljs-string">"_"</span>;
    <span class="hljs-comment">// 写入所有单位数据</span>
    <span class="hljs-keyword">for</span> (Map.Entry&lt;String, List&lt;Org&gt;&gt; entry : orgMap.entrySet()) {
        <span class="hljs-type">String</span> <span class="hljs-variable">companyId</span> <span class="hljs-operator">=</span> entry.getKey();
        List&lt;Org&gt; orgs = entry.getValue();

        <span class="hljs-keyword">if</span> (CollUtil.isNotEmpty(orgs)) {
            <span class="hljs-keyword">for</span> (Org org : orgs) {
                <span class="hljs-type">Row</span> <span class="hljs-variable">row</span> <span class="hljs-operator">=</span> orgSheet.createRow(orgRow++);
                row.createCell(<span class="hljs-number">0</span>).setCellValue(companyId);
                row.createCell(<span class="hljs-number">1</span>).setCellValue(org.getShortName());
                row.createCell(<span class="hljs-number">2</span>).setCellValue(org.getCode()); <span class="hljs-comment">// 正确写入code</span>
            }
            <span class="hljs-type">String</span> <span class="hljs-variable">referenceStr</span> <span class="hljs-operator">=</span> StrUtil.format(<span class="hljs-string">"OrgData!$B${}:$B${}"</span>, startRow, orgRow);
            log.info(<span class="hljs-string">"{} ::: {}"</span>, orgDataNameNamePrefix + companyId, referenceStr);
            createName(workbook, orgDataNameNamePrefix + companyId, referenceStr);
            startRow = orgRow + <span class="hljs-number">1</span>;
        }
    }
    log.info(<span class="hljs-string">"最终的startRow: {}"</span>, startRow);
    createName(workbook, <span class="hljs-string">"OrgDataMapping"</span>, <span class="hljs-string">"OrgData!$B$2:$C$"</span> + (startRow - <span class="hljs-number">1</span>));
    <span class="hljs-comment">// 保护工作表</span>
    companySheet.protectSheet(<span class="hljs-string">"protected"</span>);
    orgSheet.protectSheet(<span class="hljs-string">"protected"</span>);
}
<span class="hljs-comment">// 创建名称管理器还有引用范围</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">createName</span><span class="hljs-params">(Workbook workbook, String nameName, String reference)</span> {
    <span class="hljs-keyword">if</span> (workbook <span class="hljs-keyword">instanceof</span> XSSFWorkbook) {
        <span class="hljs-type">XSSFName</span> <span class="hljs-variable">name</span> <span class="hljs-operator">=</span> ((XSSFWorkbook) workbook).createName();
        name.setNameName(nameName);
        name.setRefersToFormula(reference);
    }
}

</code></pre>
<h3 data-id="heading-4">3. 设置数据有效性，和根据这一列自动填充值的方法</h3>
<blockquote>
<p>我的E列的数据是根据Y列的数据设置的数据有效性，所以我把Y列用了 _+id的方式做了 名称管理器 引用。所以给E列设置 formula的时候直接写 下百年的代码就可以了， 通过<code>INDIRECT</code>函数引用对应的名称管理器</p>
<pre><code class="hljs language-java" lang="java">StrUtil.format(<span class="hljs-string">"INDIRECT("</span>_<span class="hljs-string">"&amp;X{})"</span>, rowIndex + <span class="hljs-number">1</span>)
</code></pre>
</blockquote>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setCompanyValidationAndFormula</span><span class="hljs-params">(Sheet sheet, Workbook workbook)</span> {
    <span class="hljs-type">XSSFDataValidationHelper</span> <span class="hljs-variable">dvHelper</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">XSSFDataValidationHelper</span>((XSSFSheet) sheet);
    CellRangeAddressList companyRange;
    String formula;
    String orgIdFormula;
    XSSFDataValidationConstraint companyConstraint;
    XSSFDataValidation companyValidation;
    Row row;
    <span class="hljs-comment">// 2. 创建锁定样式用于受检企业ID列</span>
    <span class="hljs-type">CellStyle</span> <span class="hljs-variable">lockedStyle</span> <span class="hljs-operator">=</span> workbook.createCellStyle();
    lockedStyle.setLocked(<span class="hljs-literal">true</span>);
    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">rowIndex</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span>; rowIndex &lt;= templateEndRow; rowIndex++) {
        <span class="hljs-comment">// 只为当前行的第4列（索引3）设置数据验证</span>
        companyRange = <span class="hljs-keyword">new</span> <span class="hljs-title class_">CellRangeAddressList</span>(rowIndex, rowIndex, <span class="hljs-number">3</span>, <span class="hljs-number">3</span>);
        <span class="hljs-comment">// 判断A列选中的数据中是否有删选条件</span>
        <span class="hljs-comment">// 有的话用 trueName这个名称管理器 否则用falseName 这个要根据自己的条件还有业务逻辑自己修改一下</span>
        formula = StrUtil.format(<span class="hljs-string">"=IF(ISNUMBER(FIND("</span>筛选条件<span class="hljs-string">",A{})),trueName,falseName)"</span>, rowIndex + <span class="hljs-number">1</span>);
        log.info(<span class="hljs-string">"当前函数公式 {}"</span>, formula);
        companyConstraint = (XSSFDataValidationConstraint)
                dvHelper.createFormulaListConstraint(formula);

        companyValidation = (XSSFDataValidation)
                dvHelper.createValidation(companyConstraint, companyRange);
        companyValidation.setErrorStyle(DataValidation.ErrorStyle.STOP);
        companyValidation.createErrorBox(<span class="hljs-string">"输入错误"</span>, <span class="hljs-string">"请从下拉列表选择受检企业"</span>);
        companyValidation.setSuppressDropDownArrow(<span class="hljs-literal">true</span>); <span class="hljs-comment">// 对于动态公式，建议隐藏下拉箭头</span>
        sheet.addValidationData(companyValidation);

        row = sheet.getRow(rowIndex) != <span class="hljs-literal">null</span> ? sheet.getRow(rowIndex) : sheet.createRow(rowIndex);
        <span class="hljs-type">Cell</span> <span class="hljs-variable">idCell</span> <span class="hljs-operator">=</span> row.createCell(<span class="hljs-number">23</span>);
        <span class="hljs-comment">// 设置VLOOKUP公式，根据D列查找对应的ID CompanyIdMap可以从 公式 名称管理器中查询到</span>
        orgIdFormula = StrUtil.format(<span class="hljs-string">"IFERROR(VLOOKUP($D{}, CompanyIdMap, 2, FALSE), "</span><span class="hljs-string">")"</span>, rowIndex + <span class="hljs-number">1</span>);
        idCell.setCellFormula(orgIdFormula);
        <span class="hljs-comment">// 应用锁定样式</span>
        idCell.setCellStyle(lockedStyle);
    }
}
</code></pre>
<h3 data-id="heading-5">4. 设置指定列只能填写日期类型和字典项数据有效性</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">restrictCell2DateFormat</span><span class="hljs-params">(Sheet sheet, <span class="hljs-type">int</span> col)</span> {
    <span class="hljs-type">CellRangeAddressList</span> <span class="hljs-variable">regions</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CellRangeAddressList</span>(<span class="hljs-number">1</span>, templateEndRow, col, col);
    <span class="hljs-type">XSSFDataValidationHelper</span> <span class="hljs-variable">dvHelper</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">XSSFDataValidationHelper</span>((XSSFSheet) sheet);
    <span class="hljs-comment">// 设置数据验证约束：日期格式，介于最小日期和最大日期之间</span>
    <span class="hljs-type">XSSFDataValidationConstraint</span> <span class="hljs-variable">dvConstraint</span> <span class="hljs-operator">=</span> (XSSFDataValidationConstraint) dvHelper.createDateConstraint(
            XSSFDataValidationConstraint.OperatorType.BETWEEN,
            <span class="hljs-string">"DATE(1900,1,1)"</span>,  <span class="hljs-comment">// 最小日期</span>
            <span class="hljs-string">"DATE(2100,12,31)"</span>, <span class="hljs-comment">// 最大日期</span>
            <span class="hljs-string">"yyyy-mm-dd"</span>        <span class="hljs-comment">// 日期格式</span>
    );

    <span class="hljs-comment">// 创建数据验证规则</span>
    <span class="hljs-type">XSSFDataValidation</span> <span class="hljs-variable">validation</span> <span class="hljs-operator">=</span> (XSSFDataValidation) dvHelper.createValidation(dvConstraint, regions);

    <span class="hljs-comment">// 设置验证失败时的提示信息</span>
    validation.setErrorStyle(DataValidation.ErrorStyle.STOP);
    validation.createErrorBox(<span class="hljs-string">"输入错误"</span>, <span class="hljs-string">"请输入正确的日期格式：yyyy-MM-dd"</span>);

    <span class="hljs-comment">// 设置输入提示信息</span>
    validation.createPromptBox(<span class="hljs-string">"日期格式提示"</span>, <span class="hljs-string">"请输入 yyyy-MM-dd 格式的日期，例如：2024-01-01"</span>);
    validation.setShowPromptBox(<span class="hljs-literal">true</span>);
    validation.setSuppressDropDownArrow(<span class="hljs-literal">false</span>);

    <span class="hljs-comment">// 将数据验证添加到工作表</span>
    sheet.addValidationData(validation);

    <span class="hljs-comment">// 设置单元格格式为日期格式</span>
    <span class="hljs-type">CellStyle</span> <span class="hljs-variable">dateCellStyle</span> <span class="hljs-operator">=</span> sheet.getWorkbook().createCellStyle();
    <span class="hljs-type">DataFormat</span> <span class="hljs-variable">format</span> <span class="hljs-operator">=</span> sheet.getWorkbook().createDataFormat();
    dateCellStyle.setDataFormat(format.getFormat(<span class="hljs-string">"yyyy-MM-dd"</span>));

    sheet.addValidationData(validation);
}
</code></pre>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">/**
 * 设置字典项数据有效性
 *
 * <span class="hljs-doctag">@param</span> dictType
 */</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setDictDataValidation</span><span class="hljs-params">(Sheet sheet, String dictType, <span class="hljs-type">int</span> col)</span> {
    Map&lt;String, String&gt; dictMap = dictUtil.getDictMap(dictType);
    log.info(<span class="hljs-string">"当前获取的dictMap {}"</span>, dictMap);
    <span class="hljs-type">DataValidationHelper</span> <span class="hljs-variable">dvHelper</span> <span class="hljs-operator">=</span> sheet.getDataValidationHelper();
    <span class="hljs-type">DataValidationConstraint</span> <span class="hljs-variable">constraint</span> <span class="hljs-operator">=</span> dvHelper.createExplicitListConstraint(dictMap.values().toArray(<span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[<span class="hljs-number">0</span>]));
    <span class="hljs-type">CellRangeAddressList</span> <span class="hljs-variable">cellRangeAddressList</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CellRangeAddressList</span>(<span class="hljs-number">1</span>, templateEndRow, col, col);
    <span class="hljs-type">DataValidation</span> <span class="hljs-variable">validation</span> <span class="hljs-operator">=</span> dvHelper.createValidation(constraint, cellRangeAddressList);
    <span class="hljs-comment">// 显示下拉箭头</span>
    validation.setSuppressDropDownArrow(<span class="hljs-literal">true</span>);
    <span class="hljs-comment">// 显示提示框</span>
    validation.setShowPromptBox(<span class="hljs-literal">true</span>);
    <span class="hljs-comment">// 设置为INFO级别允许输入</span>
    validation.setErrorStyle(DataValidation.ErrorStyle.INFO);
    sheet.addValidationData(validation);
}
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Android Auto开发（3）-Audio Integration]]></title>    <link>https://juejin.cn/post/7577309505711063103</link>    <guid>https://juejin.cn/post/7577309505711063103</guid>    <pubDate>2025-11-28T03:03:04.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577309505711063103" data-draft-id="7577333742277689386" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Android Auto开发（3）-Audio Integration"/> <meta itemprop="keywords" content="Android"/> <meta itemprop="datePublished" content="2025-11-28T03:03:04.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="成都大菠萝"/> <meta itemprop="url" content="https://juejin.cn/user/289926799429805"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Android Auto开发（3）-Audio Integration
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/289926799429805/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    成都大菠萝
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-28T03:03:04.000Z" title="Fri Nov 28 2025 03:03:04 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-28
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    5
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0"><strong>Android Auto 车机集成指南 (HUIG) 4.3</strong></h2>
<h3 data-id="heading-1"><strong>第 3 章：Audio Integration 技术规范 —— 完整实施手册</strong></h3>
<blockquote>
<p><strong>核心原则</strong>：<br/>
<strong>Android Auto 的音频子系统必须严格遵循 Google 的音频协议栈、编解码规范和延迟要求</strong>。<br/>
<strong>任何偏离（如自定义编解码器、修改音频路由逻辑）将导致认证失败</strong>（Google CTS 测试自动拦截）。</p>
</blockquote>
<hr/>
<h3 data-id="heading-2"><strong>一、音频协议栈与强制要求</strong></h3>
<h4 data-id="heading-3"><strong>1. 协议栈层级架构</strong></h4>
<pre><code class="hljs language-plaintext" lang="plaintext">┌─────────────────────────────────────────────────────┐
│                Android Auto Audio Stack             │
├───────────────────┬─────────────────────────────────┤
│                   │                                 │
│  1. Receiver Library (Google 源码) │  2. OS Adaptation Layer (OEM 实现) │
│                   │                                 │
│  • 音频通道管理 (AAC-LC/FLAC)    │  • 音频硬件绑定 (Audio HAL)         │
│  • 低延迟传输 (≤300ms)           │  • 音频路由控制 (Speaker/USB)       │
│  • 音量同步与混音策略          │  • 错误恢复 (缓冲区溢出/丢包)       │
└───────────────────┴─────────────────────────────────┘
</code></pre>
<h4 data-id="heading-4"><strong>2. 核心强制要求（R03-010 ~ R03-070）</strong></h4>





















































<table><thead><tr><th>条款</th><th>要求</th><th>开发必须操作</th><th>违反后果</th></tr></thead><tbody><tr><td><strong>R03-010</strong></td><td><strong>必须使用 AAC-LC 或 FLAC 编解码器</strong></td><td>1. Android：<code>MediaCodec.createDecoderByType("audio/aac")</code><br/>2. QNX：<code>aac_decoder_open()</code></td><td>❌ 认证失败（CTS 报错 <code>INVALID_AUDIO_CODEC</code>）</td></tr><tr><td><strong>R03-020</strong></td><td><strong>音频延迟 ≤300ms（从 MD 发送至 HU 输出）</strong></td><td>1. 使用 <code>AudioTrack</code> 的 <code>setPlaybackPositionUpdateListener</code><br/>2. 在 <code>OnPeriodicNotification()</code> 中计算端到端延迟</td><td>❌ 认证失败（CTS 报错 <code>AUDIO_LATENCY_TOO_HIGH</code>）</td></tr><tr><td><strong>R03-030</strong></td><td><strong>必须支持动态音量同步</strong>（与 MD 音量联动）</td><td>1. 实现 <code>setVolume(float volume)</code> 接口<br/>2. 禁止在 HU 端自行调整音量</td><td>❌ 认证失败（CTS 报错 <code>VOLUME_SYNC_FAILURE</code>）</td></tr><tr><td><strong>R03-040</strong></td><td><strong>必须启用音频回声消除（AEC）和噪声抑制（NS）</strong></td><td>1. Android：<code>AudioManager.setParameters("aec=on;ns=on")</code><br/>2. QNX：<code>audio_set_aec_mode(true)</code></td><td>❌ 认证失败（CTS 报错 <code>AUDIO_QUALITY_INSUFFICIENT</code>）</td></tr><tr><td><strong>R03-050</strong></td><td><strong>必须支持 USB 音频直连模式</strong>（当 AAP 无法启动时）</td><td>1. 实现 USB 音频设备枚举逻辑<br/>2. 在 AAP 会话失败时自动切换至 USB 模式</td><td>❌ 认证失败（CTS 报错 <code>USB_AUDIO_FALLBACK_FAILURE</code>）</td></tr><tr><td><strong>R03-060</strong></td><td><strong>音频采样率必须为 44.1kHz 或 48kHz</strong></td><td>1. Android：<code>AudioTrack.setSampleRate(44100)</code><br/>2. QNX：<code>audio_set_sample_rate(44100)</code></td><td>❌ 认证失败（CTS 报错 <code>INVALID_AUDIO_SAMPLE_RATE</code>）</td></tr><tr><td><strong>R03-070</strong></td><td><strong>必须支持音频通道数为 2（立体声）</strong></td><td>1. Android：<code>AudioFormat.CHANNEL_OUT_STEREO</code><br/>2. QNX：<code>AUDIO_CHANNEL_LAYOUT_STEREO</code></td><td>❌ 认证失败（CTS 报错 <code>INVALID_AUDIO_CHANNELS</code>）</td></tr></tbody></table>
<blockquote>
<p>⚠️ <strong>致命错误</strong>：<br/>
<strong>使用 AAC-HE 或 MP3 编解码器</strong> → Google 会检测到协议栈不兼容 → 认证失败。</p>
</blockquote>
<hr/>
<h3 data-id="heading-5"><strong>二、音频流处理关键实现（开发必知）</strong></h3>
<h4 data-id="heading-6"><strong>1. 音频通道生命周期管理</strong></h4>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-comment">// Android 示例：音频流初始化</span>
AudioTrack* track = <span class="hljs-keyword">new</span> <span class="hljs-built_in">AudioTrack</span>(
    AudioManager::STREAM_MUSIC,
    <span class="hljs-number">44100</span>,                <span class="hljs-comment">// 采样率</span>
    AudioFormat::ENCODING_PCM_16BIT,
    AudioFormat::CHANNEL_OUT_STEREO,
    bufferSizeInBytes,
    AudioTrack::MODE_STREAM
);

track-&gt;<span class="hljs-built_in">setPlaybackPositionUpdateListener</span>(<span class="hljs-keyword">this</span>);
track-&gt;<span class="hljs-built_in">play</span>();
</code></pre>
<h4 data-id="heading-7"><strong>2. 动态音量同步实现</strong></h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// Android 示例：接收 MD 音量指令</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setVolume</span><span class="hljs-params">(<span class="hljs-type">float</span> volume)</span> {
    <span class="hljs-keyword">if</span> (volume &lt; <span class="hljs-number">0.0f</span> || volume &gt; <span class="hljs-number">1.0f</span>) <span class="hljs-keyword">return</span>;
    audioManager.setStreamVolume(AudioManager.STREAM_MUSIC, (<span class="hljs-type">int</span>)(volume * maxVolume), <span class="hljs-number">0</span>);
}
</code></pre>
<h4 data-id="heading-8"><strong>3. USB 音频直连模式实现</strong></h4>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-comment">// QNX 示例：USB 音频设备枚举</span>
<span class="hljs-keyword">if</span> (<span class="hljs-built_in">usb_audio_device_is_connected</span>()) {
    <span class="hljs-built_in">audio_open</span>(USB_AUDIO_DEVICE_PATH);
    <span class="hljs-built_in">audio_set_sample_rate</span>(<span class="hljs-number">44100</span>);
    <span class="hljs-built_in">audio_set_channel_layout</span>(AUDIO_CHANNEL_LAYOUT_STEREO);
}
</code></pre>
<blockquote>
<p>⚠️ <strong>开发陷阱</strong>：</p>
<ul>
<li><strong>Android 的 <code>AudioTrack</code> 必须使用 <code>MODE_STREAM</code></strong>（禁止 <code>MODE_STATIC</code>）</li>
<li><strong>QNX 的音频缓冲区大小需为 44100 的倍数</strong>（否则触发 <code>AUDIO_BUFFER_SIZE_INVALID</code>）</li>
</ul>
</blockquote>
<hr/>
<h3 data-id="heading-9"><strong>三、Google 认证测试要求（CTS 测试用例）</strong></h3>
<h4 data-id="heading-10"><strong>1. 必须通过的测试用例</strong></h4>















































<table><thead><tr><th>测试用例</th><th>验证目标</th><th>通过标准</th></tr></thead><tbody><tr><td><code>AudioCodecTest</code></td><td>音频编解码器是否为 AAC-LC/FLAC</td><td><code>decoder_type == "AAC-LC"</code></td></tr><tr><td><code>AudioLatencyTest</code></td><td>端到端延迟 ≤300ms</td><td><code>latency_ms &lt;= 300</code></td></tr><tr><td><code>VolumeSyncTest</code></td><td>音量同步是否与 MD 一致</td><td><code>abs(hu_volume - md_volume) &lt; 0.01</code></td></tr><tr><td><code>AecNsTest</code></td><td>AEC/NS 是否启用</td><td><code>aec_enabled == true &amp;&amp; ns_enabled == true</code></td></tr><tr><td><code>UsbFallbackTest</code></td><td>USB 音频直连模式是否正常</td><td><code>usb_audio_playback_works == true</code></td></tr><tr><td><code>SampleRateTest</code></td><td>采样率是否为 44.1kHz/48kHz</td><td>`sample_rate == 44100</td><td/><td>sample_rate == 48000`</td></tr><tr><td><code>ChannelCountTest</code></td><td>通道数是否为 2</td><td><code>channel_count == 2</code></td></tr></tbody></table>
<h4 data-id="heading-11"><strong>2. 认证失败高频原因（Google 官方数据）</strong></h4>






























<table><thead><tr><th>问题</th><th>占比</th><th>解决方案</th></tr></thead><tbody><tr><td>音频延迟 &gt;300ms</td><td>45%</td><td>优化 <code>AudioTrack</code> 缓冲区大小</td></tr><tr><td>未启用 AEC/NS</td><td>30%</td><td>检查 <code>AudioManager.setParameters()</code> 调用</td></tr><tr><td>采样率错误</td><td>15%</td><td>强制设置 <code>44100</code> 或 <code>48000</code></td></tr><tr><td>USB 音频直连失败</td><td>10%</td><td>实现 USB 设备热插拔检测逻辑</td></tr></tbody></table>
<hr/>
<h3 data-id="heading-12"><strong>四、开发自检清单（认证前必查）</strong></h3>








































<table><thead><tr><th>检查项</th><th>操作指南</th><th>验证工具</th></tr></thead><tbody><tr><td><strong>1. 编解码器</strong></td><td>检查 <code>AudioTrack</code> 或 <code>aac_decoder_open()</code> 是否使用 AAC-LC/FLAC</td><td><code>adb shell cat /proc/audio/codec</code></td></tr><tr><td><strong>2. 延迟测试</strong></td><td>用 <code>AudioTrack</code> 的 <code>getPlaybackHeadPosition()</code> 计算端到端延迟</td><td>自定义测试脚本</td></tr><tr><td><strong>3. 音量同步</strong></td><td>在 MD 上调整音量，检查 HU 音量是否同步</td><td><code>adb shell dumpsys audio</code></td></tr><tr><td><strong>4. AEC/NS 状态</strong></td><td>检查 <code>AudioManager.getParameters("aec")</code> 和 <code>ns</code> 是否启用</td><td><code>adb shell service call audio 10</code></td></tr><tr><td><strong>5. USB 音频直连</strong></td><td>拔插 USB 音频设备，检查是否自动切换</td><td><code>adb logcat -s Audio</code></td></tr><tr><td><strong>6. 采样率/通道数</strong></td><td>检查 <code>AudioTrack.getSampleRate()</code> 和 <code>getChannelCount()</code></td><td><code>adb shell cat /proc/audio/config</code></td></tr></tbody></table>
<blockquote>
<p>🔥 <strong>认证通过率提升技巧</strong>：</p>
<ol>
<li><strong>在 CI 流程中强制检查音频延迟</strong>：
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 自动化测试脚本</span>
<span class="hljs-keyword">if</span> [ $(get_audio_latency.sh) -gt 300 ]; <span class="hljs-keyword">then</span>
  <span class="hljs-built_in">echo</span> <span class="hljs-string">"Audio latency exceeds 300ms: <span class="hljs-variable">$latency</span>"</span>
  <span class="hljs-built_in">exit</span> 1
<span class="hljs-keyword">fi</span>
</code></pre>
</li>
<li><strong>使用 Google 的参考实现</strong>：
<ul>
<li>Android 参考：<code>car-receiver-library/examples/android/audio</code></li>
<li>QNX 参考：<code>car-receiver-library/examples/qnx/audio</code></li>
</ul>
</li>
</ol>
</blockquote>
<hr/>
<h3 data-id="heading-13"><strong>五、附：Google 官方资源与避坑指南</strong></h3>






























<table><thead><tr><th>资源</th><th>用途</th><th>避坑提示</th></tr></thead><tbody><tr><td><strong><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fandroid%2Fcar-receiver-library%2Ftree%2Fmain%2Faudio" target="_blank" title="https://github.com/android/car-receiver-library/tree/main/audio" ref="nofollow noopener noreferrer">Audio Integration GitHub</a></strong></td><td>获取参考实现</td><td>⚠️ <strong>切勿修改 <code>AudioTrack</code> 或 <code>aac_decoder</code> 内部逻辑</strong></td></tr><tr><td><strong><a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Fcar%2Fhuig%23cts" target="_blank" title="https://developer.android.com/car/huig#cts" ref="nofollow noopener noreferrer">CTS 测试工具</a></strong></td><td>运行认证测试</td><td>⚠️ 仅支持 <strong>Linux</strong> 环境（Windows/Mac 需用 WSL）</td></tr><tr><td><strong><a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.qnx.com%2Fdocs%2F7.1%2Faudio%2Findex.html" target="_blank" title="https://developer.qnx.com/docs/7.1/audio/index.html" ref="nofollow noopener noreferrer">QNX 音频调试指南</a></strong></td><td>QNX 音频适配参考</td><td>⚠️ 需安装 <code>qnx-ntoarmv7le-gcc</code> 11.0 工具链</td></tr><tr><td><strong><a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Fcar%2Fhuig%2Ftroubleshooting" target="_blank" title="https://developer.android.com/car/huig/troubleshooting" ref="nofollow noopener noreferrer">常见错误日志</a></strong></td><td>解析认证失败原因</td><td>⚠️ <code>Error 2001: Audio latency exceeds 300ms</code> → 优化缓冲区大小</td></tr></tbody></table>
<blockquote>
<p>⚠️ <strong>终极警告</strong>：<br/>
<strong>Google 不提供音频子系统的商业二进制版本</strong>！<br/>
所有车厂必须<strong>自行实现音频协议栈</strong>，否则认证直接失败。</p>
</blockquote>
<hr/>
<blockquote>
<p>✅ <strong>文档总结</strong>：<br/>
第 3 章的核心是 <strong>“严格遵循 AAC-LC/FLAC 编解码、300ms 延迟上限、动态音量同步”</strong>。<br/>
<strong>任何优化（如自定义编解码器、修改音频路由）都是致命错误</strong>。<br/>
<strong>必须通过 Google 的音频 CTS 测试套件</strong>。</p>
</blockquote>
<blockquote>
<p><strong>下一步行动</strong>：</p>
<ol>
<li>立即从 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fandroid%2Fcar-receiver-library" target="_blank" title="https://github.com/android/car-receiver-library" ref="nofollow noopener noreferrer">GitHub</a> 下载 <strong><code>audio</code> 模块参考实现</strong></li>
<li>按照 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fandroid%2Fcar-receiver-library%2Ftree%2Fmain%2Faudio%2Fqnx" target="_blank" title="https://github.com/android/car-receiver-library/tree/main/audio/qnx" ref="nofollow noopener noreferrer">QNX 示例</a> 搭建开发环境</li>
<li>用 <strong>CTS 测试工具</strong> 运行 <code>AudioLatencyTest</code> 验证延迟</li>
</ol>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Android的自定义View]]></title>    <link>https://juejin.cn/post/7577307100129820722</link>    <guid>https://juejin.cn/post/7577307100129820722</guid>    <pubDate>2025-11-28T03:04:34.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577307100129820722" data-draft-id="7577218195233816622" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Android的自定义View"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-11-28T03:04:34.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="用户444554365426"/> <meta itemprop="url" content="https://juejin.cn/user/1746465251931063"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Android的自定义View
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1746465251931063/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    用户444554365426
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-28T03:04:34.000Z" title="Fri Nov 28 2025 03:04:34 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-28
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    9
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>测量-measure <br/>
布局-layout <br/>
绘制-draw <br/>
三大流程</p>
<p>练练手</p>
<p>来点自定义属性：</p>
<pre><code class="hljs language-xml" lang="xml">
<span class="hljs-meta">&lt;?xml version=<span class="hljs-string">"1.0"</span> encoding=<span class="hljs-string">"utf-8"</span>?&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">resources</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">declare-styleable</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"CustomView"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">attr</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"customColor"</span> <span class="hljs-attr">format</span>=<span class="hljs-string">"color"</span> /&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">attr</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"customText"</span> <span class="hljs-attr">format</span>=<span class="hljs-string">"string"</span> /&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">attr</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"customSize"</span> <span class="hljs-attr">format</span>=<span class="hljs-string">"dimension"</span> /&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">declare-styleable</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">resources</span>&gt;</span>

</code></pre>
<p>再来点代码时鲜：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">package</span> com.mircles.test.ui

<span class="hljs-keyword">import</span> android.content.Context
<span class="hljs-keyword">import</span> android.graphics.Canvas
<span class="hljs-keyword">import</span> android.graphics.Color
<span class="hljs-keyword">import</span> android.graphics.Paint
<span class="hljs-keyword">import</span> android.graphics.Rect
<span class="hljs-keyword">import</span> android.util.AttributeSet
<span class="hljs-keyword">import</span> android.view.View
<span class="hljs-keyword">import</span> androidx.<span class="hljs-keyword">annotation</span>.StyleRes
<span class="hljs-keyword">import</span> androidx.compose.runtime.Composable
<span class="hljs-keyword">import</span> androidx.compose.ui.tooling.preview.Preview
<span class="hljs-keyword">import</span> androidx.compose.ui.viewinterop.AndroidView
<span class="hljs-keyword">import</span> androidx.core.content.withStyledAttributes
<span class="hljs-keyword">import</span> com.mircles.test.R
<span class="hljs-keyword">import</span> kotlin.math.min


<span class="hljs-keyword">class</span> <span class="hljs-title class_">CustomView</span> <span class="hljs-meta">@JvmOverloads</span> <span class="hljs-keyword">constructor</span>(
    context: Context,
    attrs: AttributeSet? = <span class="hljs-literal">null</span>,
    defStyleAttr: <span class="hljs-built_in">Int</span> = <span class="hljs-number">0</span>
) : View(context, attrs, defStyleAttr) {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> mPaint: Paint = Paint().apply {
        color = Color.BLACK
        style = Paint.Style.FILL
    }

    <span class="hljs-comment">//定义变量来存储自定义属性值</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> customColor: <span class="hljs-built_in">Int</span> = Color.BLUE
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> customSize: <span class="hljs-built_in">Float</span> = <span class="hljs-number">100f</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> customText: String = <span class="hljs-string">"Say"</span>


    <span class="hljs-keyword">init</span> {

        <span class="hljs-comment">//context.obtainStyledAttributes()</span>
        <span class="hljs-comment">//withStyledAttributes是obtainStyledAttributes的扩展函数，可以学学谷歌的工程师是怎么做扩展的</span>
        context.withStyledAttributes(
            attrs,
            R.styleable.CustomView,
            defStyleAttr = defStyleAttr
        ) {
            customColor = getColor(R.styleable.CustomView_customColor, Color.BLACK)
            customSize = getDimension(R.styleable.CustomView_customSize, <span class="hljs-number">100f</span>)
            customText = getString(R.styleable.CustomView_customText) ?: <span class="hljs-string">"hello"</span>

            <span class="hljs-comment">//应用到画笔中</span>
            mPaint.color = customColor

        }

    }


    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onMeasure</span><span class="hljs-params">(widthMeasureSpec: <span class="hljs-type">Int</span>, heightMeasureSpec: <span class="hljs-type">Int</span>)</span></span> {
        <span class="hljs-keyword">val</span> desiredWidth = <span class="hljs-number">200</span> <span class="hljs-comment">// 你期望的默认宽度（像素）</span>
        <span class="hljs-keyword">val</span> desiredHeight = <span class="hljs-number">200</span> <span class="hljs-comment">// 你期望的默认高度（像素）</span>

        <span class="hljs-keyword">val</span> widthMode = MeasureSpec.getMode(widthMeasureSpec)
        <span class="hljs-keyword">val</span> widthSize = MeasureSpec.getSize(widthMeasureSpec)
        <span class="hljs-keyword">val</span> heightMode = MeasureSpec.getMode(heightMeasureSpec)
        <span class="hljs-keyword">val</span> heightSize = MeasureSpec.getSize(heightMeasureSpec)



        <span class="hljs-comment">// 测量宽度</span>
        <span class="hljs-keyword">val</span> width = <span class="hljs-keyword">when</span> (widthMode) {
            MeasureSpec.EXACTLY -&gt; widthSize
            MeasureSpec.AT_MOST -&gt; min(desiredWidth, widthSize)
            <span class="hljs-keyword">else</span> -&gt; desiredWidth
        }


        <span class="hljs-comment">// 测量高度</span>
        <span class="hljs-keyword">val</span> height = <span class="hljs-keyword">when</span> (heightMode) {
            MeasureSpec.EXACTLY -&gt; heightSize
            MeasureSpec.AT_MOST -&gt; min(desiredHeight, heightSize)
            <span class="hljs-keyword">else</span> -&gt; desiredHeight
        }

        setMeasuredDimension(width, height)
    }

    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onLayout</span><span class="hljs-params">(changed: <span class="hljs-type">Boolean</span>, left: <span class="hljs-type">Int</span>, top: <span class="hljs-type">Int</span>, right: <span class="hljs-type">Int</span>, bottom: <span class="hljs-type">Int</span>)</span></span> {
        <span class="hljs-keyword">super</span>.onLayout(changed, left, top, right, bottom)
    }

    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onDraw</span><span class="hljs-params">(canvas: <span class="hljs-type">Canvas</span>)</span></span> {
        <span class="hljs-keyword">super</span>.onDraw(canvas)

        <span class="hljs-comment">// 绘制一个圆形</span>
        <span class="hljs-keyword">val</span> centerX = width / <span class="hljs-number">2f</span>
        <span class="hljs-keyword">val</span> centerY = height / <span class="hljs-number">2f</span>
        <span class="hljs-keyword">val</span> radius = min(centerX, centerY) - <span class="hljs-number">10</span>
        canvas.drawCircle(centerX, centerY, radius, mPaint)


        <span class="hljs-comment">// 绘制文字</span>
        <span class="hljs-keyword">val</span> textPaint = Paint().apply {
            color = Color.BLUE
            textSize = customSize
            textAlign = Paint.Align.CENTER
        }
        <span class="hljs-comment">//计算文字基线位置，使文字垂直居中:可以留意计算的思路</span>
        <span class="hljs-keyword">val</span> textBounds = Rect()
        textPaint.getTextBounds(customText,<span class="hljs-number">0</span>,customText.length,textBounds)
        <span class="hljs-keyword">val</span> textY = centerY - (textBounds.top+textBounds.bottom)/<span class="hljs-number">2f</span>

        canvas.drawText(customText, centerX, textY, textPaint)

    }

    <span class="hljs-comment">//提供设置方法以便在代码中动态修改</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">setCustomColor</span><span class="hljs-params">(color:<span class="hljs-type">Int</span>)</span></span>{
        customColor = color
        mPaint.color = color
        invalidate()
    }

    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">setCustomText</span><span class="hljs-params">(text: <span class="hljs-type">String</span>)</span></span>{
        customText = text
        invalidate()
    }
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">setCustomSize</span><span class="hljs-params">(size: <span class="hljs-type">Float</span>)</span></span>{
        customSize = size
        invalidate()
    }

    <span class="hljs-comment">// 如果你想要从样式资源中获取属性</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">applyStyle</span><span class="hljs-params">(<span class="hljs-meta">@StyleRes</span> styleRes: <span class="hljs-type">Int</span>)</span></span> {
        context.withStyledAttributes(styleRes, R.styleable.CustomView) {
            customColor = getColor(R.styleable.CustomView_customColor, customColor)
            customSize = getDimension(R.styleable.CustomView_customSize, customSize)
            customText = getString(R.styleable.CustomView_customText) ?: customText
            mPaint.color = customColor
            invalidate()
        }
    }



}


<span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">CircleOO</span><span class="hljs-params">()</span></span> {
    AndroidView(
        factory = { context -&gt;
            CustomView(context).apply {
                setCustomText(<span class="hljs-string">"卧槽"</span>)
                setCustomSize(<span class="hljs-number">50f</span>)
                setCustomColor(Color.DKGRAY)
            }
        },
        update = { cv -&gt;

        }
    )
}

<span class="hljs-meta">@Preview(showBackground = true)</span>
<span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">PreviewUI</span><span class="hljs-params">()</span></span> {
    CircleOO()
}
</code></pre>
<p>还可以添加更多的属性，文字的规格样式、背景的规格样式等等。
还有onLayout()方法没用起来，继续进阶学习...</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[一次从“卡顿地狱”到“丝般顺滑”的 React 搜索优化实战]]></title>    <link>https://juejin.cn/post/7577295460249288750</link>    <guid>https://juejin.cn/post/7577295460249288750</guid>    <pubDate>2025-11-28T03:08:17.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577295460249288750" data-draft-id="7576821574428672009" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="一次从“卡顿地狱”到“丝般顺滑”的 React 搜索优化实战"/> <meta itemprop="keywords" content="前端,React.js,掘金日报"/> <meta itemprop="datePublished" content="2025-11-28T03:08:17.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="大布布将军"/> <meta itemprop="url" content="https://juejin.cn/user/1535361573994189"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            一次从“卡顿地狱”到“丝般顺滑”的 React 搜索优化实战
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1535361573994189/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    大布布将军
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-28T03:08:17.000Z" title="Fri Nov 28 2025 03:08:17 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-28
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">author: 大布布将军</h2>
<h2 data-id="heading-1">前言：万恶之源</h2>
<p>本故事有虚构成分。但来源于现实开发场景。
事情是这样的。</p>
<p>某个周五下午 4 点，产品经理（PM）迈着六亲不认的步伐向我们前端走来。他满面春风地说：“哎，那个列表页，用户反馈说找不到想要的数据，加个<strong>实时搜索</strong>功能吧？要那种一边打字一边过滤的，<strong>丝般顺滑</strong>的感觉，懂我意思吧？”</p>
<p>前端心想：这还不简单？<code>input</code> 绑定 <code>onChange</code>，拿到 value 往列表里一 <code>filter</code>，完事儿。半小时搞定，还能赶上 6 点的地铁。</p>
<p>于是，前端写下了那段让我后来后悔不已的代码。</p>
<hr/>
<h2 data-id="heading-2">第一阶段：由于过度自信导致的翻车</h2>
<p>为了还原案发现场，前端写了一个简化版的 Demo。假设我们有一个包含 10,000 条数据的列表（别问为什么前端要处理一万条数据，问就是后端甩锅）。</p>
<h3 data-id="heading-3">也就是这几行“天真”的代码：</h3>
<pre><code class="hljs language-import" lang="import">
// 假装这里有一万个商品
const generateProducts = () =&gt; {
  return Array.from({ length: 10000 }, (_, i) =&gt; `超级无敌好用的商品 #${i}`);
};

const dummyProducts = generateProducts();

export default function SearchList() {
  const [query, setQuery] = useState('');

  // 🔴 罪魁祸首在这里：每次 render 都要遍历一万次
  const filteredProducts = dummyProducts.filter(p =&gt; 
    p.toLowerCase().includes(query.toLowerCase())
  );

  const handleChange = (e) =&gt; {
    setQuery(e.target.value); // 这一步更新 state，触发重渲染
  };

  return (
    &lt;div className="p-4"&gt;
      &lt;input 
        type="text" 
        value={query} 
        onChange={handleChange} 
        placeholder="搜索..." 
        className="border p-2 w-full"
      /&gt;
      &lt;ul className="mt-4"&gt;
        {filteredProducts.map((p, index) =&gt; (
          &lt;li key={index}&gt;{p}&lt;/li&gt;
        ))}
      &lt;/ul&gt;
    &lt;/div&gt;
  );
}
</code></pre>
<p><strong>结果如何？</strong></p>
<p>在前端的 ThinkBook 上跑了一下，输入的时候感觉像是在 PPT 里打字。每一个字符敲下去，都要顿个几百毫秒才会显示在输入框里。</p>
<p><strong>为什么？</strong> 这是 React 的基本原理：</p>
<ol>
<li>用户输入 'a' -&gt; 触发 <code>setQuery</code>。</li>
<li>React 甚至还没来得及把 'a' 更新到 input 框里，就被迫去执行组件的 <code>render</code> 函数。</li>
<li><code>render</code> 函数里有一个极其昂贵的 <code>filter</code> 操作（遍历 10k 次）。</li>
<li>即使 <code>filter</code> 完了，React 还要把生成的几千个 DOM 节点和之前的做 Diff，然后挂载到页面上。</li>
<li>JS 线程被堵死，UI 渲染被阻塞，用户看到的就是：<strong>卡顿</strong>。</li>
</ol>
<h2 data-id="heading-4">第二阶段：万金油防抖 (Debounce) —— 治标不治本</h2>
<p>作为老油条，第一反应当然是：“切，防抖一下不就行了？”</p>
<p>只要让用户打字的时候不触发计算，停下来再计算，不就完了？</p>
<pre><code class="hljs language-//" lang="//">import { debounce } from 'lodash';

// ... 省略部分代码

const handleChange = debounce((e) =&gt; {
    setQuery(e.target.value);
}, 300);
</code></pre>
<p><strong>效果：</strong> 输入框确实不卡了，打字很流畅。但是，当你停止打字 300ms 后，页面会突然“冻结”一下，然后列表瞬间刷新。</p>
<p><strong>痛点：</strong> 这种体验就像是便秘。虽然没有一直在用力，但最后那一下还是很痛苦。而且，UI 的响应滞后感很强，依然没有达到 PM 要求的“丝般顺滑”。</p>
<h2 data-id="heading-5">第三阶段：祭出神器 <code>useDeferredValue</code></h2>
<p>React 18 发布这么久了，是时候让它出来干点活了。</p>
<p>这时候作为前端的我们需要引入一个概念：<strong>并发模式 (Concurrent Features)</strong> 。</p>
<p>简单来说，就是把更新任务分为“<strong>大哥</strong>”和“<strong>小弟</strong>”。</p>
<ul>
<li><strong>大哥（紧急更新）</strong> ：用户的打字输入、点击反馈。这玩意儿必须马上响应，不然用户会以为死机了。</li>
<li><strong>小弟（非紧急更新）</strong> ：列表的过滤渲染。晚个几百毫秒没人在意。</li>
</ul>
<p>React 18 给了我们一个 Hook 叫 <code>useDeferredValue</code>，专门用来处理这种场景。</p>
<p>改造后的代码：</p>
<pre><code class="hljs language-import" lang="import">
export default function OptimizedSearchList() {
  const [query, setQuery] = useState('');
  
  //  魔法在这里：创建一个“滞后”的副本
  // React 会在空闲的时候更新这个值
  const deferredQuery = useDeferredValue(query);

  const handleChange = (e) =&gt; {
    // 这里依然是紧急更新，保证 input 框打字流畅
    setQuery(e.target.value); 
  };

  // 只有当 deferredQuery 变了，才去跑这个昂贵的 filter
  // 注意：这里要配合 useMemo，不然也没用
  const filteredProducts = useMemo(() =&gt; {
    return dummyProducts.filter(p =&gt; 
      p.toLowerCase().includes(deferredQuery.toLowerCase())
    );
  }, [deferredQuery]);

  return (
    &lt;div className="p-4"&gt;
      &lt;input 
        type="text" 
        value={query} // 绑定实时的 query
        onChange={handleChange} 
        className="border p-2 w-full"
      /&gt;
      
      {/* 甚至可以加个 loading 状态，判断 query 和 deferredQuery 是否同步 */}
      &lt;div style={{ opacity: query !== deferredQuery ? 0.5 : 1 }}&gt;
        &lt;ul className="mt-4"&gt;
          {filteredProducts.map((p, index) =&gt; (
            &lt;li key={index}&gt;{p}&lt;/li&gt;
          ))}
        &lt;/ul&gt;
      &lt;/div&gt;
    &lt;/div&gt;
  );
}
</code></pre>
<h3 data-id="heading-6">这一波操作到底发生了什么？</h3>
<ol>
<li>
<p><strong>输入 'a'</strong> ：React 此时收到了两个任务。</p>
<ul>
<li>任务 A（高优先级）：更新 <code>query</code>，让 input 框显示 'a'。</li>
<li>任务 B（低优先级）：更新 <code>deferredQuery</code>，并重新计算列表。</li>
</ul>
</li>
<li>
<p><strong>React 的调度</strong>：</p>
<ul>
<li>React 说：“任务 A 甚至关乎到我的尊严，马上执行！” -&gt; Input 框瞬间变了。</li>
<li>React 接着说：“任务 B 嘛，我先切片执行一点点... 哎？用户又输入 'b' 了？那任务 B 先暂停，我去执行新的任务 A！”</li>
</ul>
</li>
<li>
<p><strong>结果</strong>：</p>
<ul>
<li>JS 线程没有被长列表渲染锁死。</li>
<li>输入框始终保持 60fps 的响应速度。</li>
<li>列表会在资源空闲时“不知不觉”地更新完成。</li>
</ul>
</li>
</ol>
<h2 data-id="heading-7">深度解析：React 原理是咋搞的？</h2>
<p>为了不显得只是个 API 调用侠，这里必须装一波，讲讲原理。</p>
<h3 data-id="heading-8">1. 以前的 React (Stack Reconciler)</h3>
<p>想象你在厨房切洋葱（渲染组件）。老板（浏览器）跟你说：“客人要加单！”。以前的 React 是个死脑筋，一旦开始切洋葱（比如那 10,000 条数据），天王老子来了它也得切完才肯抬头。这时候浏览器就卡死了，用户点击没反应。</p>
<h3 data-id="heading-9">2. 现在的 React (Fiber &amp; Concurrency)</h3>
<p>现在的 React 学聪明了，它把切洋葱分成了无数个小步骤（Time Slicing）。</p>
<ul>
<li>切两刀，抬头看看：“老板，有急事吗？”</li>
<li>老板：“没事，你继续。” -&gt; 继续切。</li>
<li>切两刀，抬头：“老板？”</li>
<li>老板：“有！客人要喝水（用户输入了）！”</li>
<li>React：“好嘞！”（放下菜刀，先去倒水，倒完水回来再继续切洋葱，或者如果洋葱不用切了直接扔掉）。</li>
</ul>
<p><code>useDeferredValue</code> 本质上就是告诉 React：“这个 state 的更新是切洋葱，可以往后稍稍，先去给客人倒水。”</p>
<h2 data-id="heading-10">总结 &amp; 避坑指南</h2>
<p>这波优化上线后，PM 拍了拍前端的肩膀说：“行啊，有点东西。”</p>
<p><strong>但是，兄弟们，请注意以下几点（防杠声明）：</strong></p>
<ol>
<li><strong>不要滥用</strong>：这玩意儿是有 overhead（开销）的。如果你的列表只有 50 条数据，用 <code>useDeferredValue</code> 纯属脱裤子放屁，反而更慢。</li>
<li><strong>配合 useMemo</strong>：就像代码里写的，过滤逻辑必须包裹在 <code>useMemo</code> 里。否则每次 Parent Render，列表过滤还是会执行，<code>useDeferredValue</code> 就白用了。</li>
<li><strong>性能优化的尽头是虚拟列表</strong>：如果数据量真到了 10 万级，别折腾 Concurrent Mode 了，直接上 <code>react-window</code> 或 <code>react-virtualized</code> 吧，DOM 节点的数量才是真正的瓶颈。</li>
</ol>
<p>好了，今天的摸鱼时间结束，撤退 。
我是大布布将军，一个前端开发。</p>
<hr/>
<blockquote>
<p><strong>下一步建议</strong>：如果你的项目里也有这种“输入卡顿”或者“Tab 切换卡顿”的场景，别急着重构，先试着把那个导致卡顿的状态用 <code>useDeferredValue</code> 包一下，说不定有奇效。</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[vxe-gantt table 甘特图如何设置任务视图每一行的背景色]]></title>    <link>https://juejin.cn/post/7577307100129886258</link>    <guid>https://juejin.cn/post/7577307100129886258</guid>    <pubDate>2025-11-28T03:09:16.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577307100129886258" data-draft-id="7577256255083855881" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="vxe-gantt table 甘特图如何设置任务视图每一行的背景色"/> <meta itemprop="keywords" content="Vue.js"/> <meta itemprop="datePublished" content="2025-11-28T03:09:16.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="用户84179481456"/> <meta itemprop="url" content="https://juejin.cn/user/3921272428567529"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            vxe-gantt table 甘特图如何设置任务视图每一行的背景色
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3921272428567529/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    用户84179481456
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-28T03:09:16.000Z" title="Fri Nov 28 2025 03:09:16 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-28
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>vxe-gantt table 甘特图如何设置任务视图每一行的背景色，例如给不同任务设置不同背景色。</p>
<p>查看官网：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgantt.vxeui.com%2F" target="_blank" title="https://gantt.vxeui.com/" ref="nofollow noopener noreferrer">gantt.vxeui.com/</a><br/>
gitbub：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fx-extends%2Fvxe-gantt" target="_blank" title="https://github.com/x-extends/vxe-gantt" ref="nofollow noopener noreferrer">github.com/x-extends/v…</a><br/>
gitee：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgitee.com%2Fx-extends%2Fvxe-gantt" target="_blank" title="https://gitee.com/x-extends/vxe-gantt" ref="nofollow noopener noreferrer">gitee.com/x-extends/v…</a></p>
<h2 data-id="heading-0">效果</h2>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a8f7bad4e5ca459eafd180a44b1c6f9b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55So5oi3ODQxNzk0ODE0NTY=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764904155&amp;x-signature=twzFDKvApSX7atbvx4tMznEUQUo%3D" alt="image" loading="lazy"/></p>
<h2 data-id="heading-1">代码</h2>
<p>通过 task-view-config.viewStyle.cellStyle 设置任务视图行样式，也可以用 task-view-config.viewStyle.rowClassName 设置任务视图行附加 className</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">vxe-gantt</span> <span class="hljs-attr">v-bind</span>=<span class="hljs-string">"ganttOptions"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">vxe-gantt</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">setup</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">import</span> { reactive } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>
<span class="hljs-keyword">const</span> ganttOptions = <span class="hljs-title function_">reactive</span>({
  <span class="hljs-attr">taskBarConfig</span>: {
    <span class="hljs-attr">showProgress</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-attr">barStyle</span>: {
      <span class="hljs-attr">round</span>: <span class="hljs-literal">true</span>,
      <span class="hljs-attr">bgColor</span>: <span class="hljs-string">'#fca60b'</span>,
      <span class="hljs-attr">completedBgColor</span>: <span class="hljs-string">'#65c16f'</span>
    }
  },
  <span class="hljs-attr">taskViewConfig</span>: {
    <span class="hljs-attr">viewStyle</span>: {
      rowStyle ({ row }) {
        <span class="hljs-keyword">if</span> (row.<span class="hljs-property">progress</span> &lt; <span class="hljs-number">10</span>) {
          <span class="hljs-keyword">return</span> {
            <span class="hljs-attr">backgroundColor</span>: <span class="hljs-string">'#f1ccef'</span>
          }
        }
        <span class="hljs-keyword">if</span> (row.<span class="hljs-property">progress</span> &lt; <span class="hljs-number">50</span>) {
          <span class="hljs-keyword">return</span> {
            <span class="hljs-attr">backgroundColor</span>: <span class="hljs-string">'#f8e4e4'</span>
          }
        }
        <span class="hljs-keyword">return</span> {}
      }
    }
  },
  <span class="hljs-attr">columns</span>: [
    { <span class="hljs-attr">field</span>: <span class="hljs-string">'title'</span>, <span class="hljs-attr">title</span>: <span class="hljs-string">'任务名称'</span> },
    { <span class="hljs-attr">field</span>: <span class="hljs-string">'start'</span>, <span class="hljs-attr">title</span>: <span class="hljs-string">'开始时间'</span>, <span class="hljs-attr">width</span>: <span class="hljs-number">100</span> },
    { <span class="hljs-attr">field</span>: <span class="hljs-string">'end'</span>, <span class="hljs-attr">title</span>: <span class="hljs-string">'结束时间'</span>, <span class="hljs-attr">width</span>: <span class="hljs-number">100</span> }
  ],
  <span class="hljs-attr">data</span>: [
    { <span class="hljs-attr">id</span>: <span class="hljs-number">10001</span>, <span class="hljs-attr">title</span>: <span class="hljs-string">'A项目'</span>, <span class="hljs-attr">start</span>: <span class="hljs-string">'2024-03-01'</span>, <span class="hljs-attr">end</span>: <span class="hljs-string">'2024-03-04'</span>, <span class="hljs-attr">progress</span>: <span class="hljs-number">3</span> },
    { <span class="hljs-attr">id</span>: <span class="hljs-number">10002</span>, <span class="hljs-attr">title</span>: <span class="hljs-string">'城市道路修理进度'</span>, <span class="hljs-attr">start</span>: <span class="hljs-string">'2024-03-03'</span>, <span class="hljs-attr">end</span>: <span class="hljs-string">'2024-03-08'</span>, <span class="hljs-attr">progress</span>: <span class="hljs-number">10</span> },
    { <span class="hljs-attr">id</span>: <span class="hljs-number">10003</span>, <span class="hljs-attr">title</span>: <span class="hljs-string">'B大工程'</span>, <span class="hljs-attr">start</span>: <span class="hljs-string">'2024-03-03'</span>, <span class="hljs-attr">end</span>: <span class="hljs-string">'2024-03-11'</span>, <span class="hljs-attr">progress</span>: <span class="hljs-number">90</span> },
    { <span class="hljs-attr">id</span>: <span class="hljs-number">10004</span>, <span class="hljs-attr">title</span>: <span class="hljs-string">'超级大工程'</span>, <span class="hljs-attr">start</span>: <span class="hljs-string">'2024-03-05'</span>, <span class="hljs-attr">end</span>: <span class="hljs-string">'2024-03-11'</span>, <span class="hljs-attr">progress</span>: <span class="hljs-number">15</span> },
    { <span class="hljs-attr">id</span>: <span class="hljs-number">10005</span>, <span class="hljs-attr">title</span>: <span class="hljs-string">'地球净化项目'</span>, <span class="hljs-attr">start</span>: <span class="hljs-string">'2024-03-08'</span>, <span class="hljs-attr">end</span>: <span class="hljs-string">'2024-03-15'</span>, <span class="hljs-attr">progress</span>: <span class="hljs-number">100</span> },
    { <span class="hljs-attr">id</span>: <span class="hljs-number">10006</span>, <span class="hljs-attr">title</span>: <span class="hljs-string">'一个小目标项目'</span>, <span class="hljs-attr">start</span>: <span class="hljs-string">'2024-03-10'</span>, <span class="hljs-attr">end</span>: <span class="hljs-string">'2024-03-21'</span>, <span class="hljs-attr">progress</span>: <span class="hljs-number">5</span> },
    { <span class="hljs-attr">id</span>: <span class="hljs-number">10007</span>, <span class="hljs-attr">title</span>: <span class="hljs-string">'某某计划'</span>, <span class="hljs-attr">start</span>: <span class="hljs-string">'2024-03-15'</span>, <span class="hljs-attr">end</span>: <span class="hljs-string">'2024-03-24'</span>, <span class="hljs-attr">progress</span>: <span class="hljs-number">70</span> },
    { <span class="hljs-attr">id</span>: <span class="hljs-number">10008</span>, <span class="hljs-attr">title</span>: <span class="hljs-string">'某某科技项目'</span>, <span class="hljs-attr">start</span>: <span class="hljs-string">'2024-03-20'</span>, <span class="hljs-attr">end</span>: <span class="hljs-string">'2024-03-29'</span>, <span class="hljs-attr">progress</span>: <span class="hljs-number">50</span> },
    { <span class="hljs-attr">id</span>: <span class="hljs-number">10009</span>, <span class="hljs-attr">title</span>: <span class="hljs-string">'地铁建设工程'</span>, <span class="hljs-attr">start</span>: <span class="hljs-string">'2024-03-19'</span>, <span class="hljs-attr">end</span>: <span class="hljs-string">'2024-03-20'</span>, <span class="hljs-attr">progress</span>: <span class="hljs-number">5</span> },
    { <span class="hljs-attr">id</span>: <span class="hljs-number">10010</span>, <span class="hljs-attr">title</span>: <span class="hljs-string">'铁路修建计划'</span>, <span class="hljs-attr">start</span>: <span class="hljs-string">'2024-03-12'</span>, <span class="hljs-attr">end</span>: <span class="hljs-string">'2024-03-20'</span>, <span class="hljs-attr">progress</span>: <span class="hljs-number">10</span> }
  ]
})
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgitee.com%2Fx-extends%2Fvxe-gantt" target="_blank" title="https://gitee.com/x-extends/vxe-gantt" ref="nofollow noopener noreferrer">gitee.com/x-extends/v…</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Android Auto开发（5）-Audio Integration]]></title>    <link>https://juejin.cn/post/7577332659505922091</link>    <guid>https://juejin.cn/post/7577332659505922091</guid>    <pubDate>2025-11-28T03:07:17.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577332659505922091" data-draft-id="7577332659505905707" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Android Auto开发（5）-Audio Integration"/> <meta itemprop="keywords" content="Android"/> <meta itemprop="datePublished" content="2025-11-28T03:07:17.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="成都大菠萝"/> <meta itemprop="url" content="https://juejin.cn/user/289926799429805"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Android Auto开发（5）-Audio Integration
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/289926799429805/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    成都大菠萝
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-28T03:07:17.000Z" title="Fri Nov 28 2025 03:07:17 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-28
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0"><strong>Android Auto 车机集成指南 (HUIG) 4.3</strong></h2>
<h3 data-id="heading-1"><strong>第 5 章：Input Handling 技术规范 —— 完整实施手册</strong></h3>
<blockquote>
<p><strong>核心原则</strong>：<br/>
<strong>Android Auto 的输入处理必须严格遵循 Google 的输入事件转发、语音交互规范及手势限制</strong>。<br/>
<strong>任何偏离（如自定义输入逻辑、修改事件路由）将导致认证失败</strong>（Google CTS 测试自动拦截）。</p>
</blockquote>
<hr/>
<h3 data-id="heading-2"><strong>一、输入处理协议栈与强制要求</strong></h3>
<h4 data-id="heading-3"><strong>1. 协议栈层级架构</strong></h4>
<pre><code class="hljs language-plaintext" lang="plaintext">┌─────────────────────────────────────────────────────┐
│                Android Auto Input Stack             │
├───────────────────┬─────────────────────────────────┤
│                   │                                 │
│  1. Receiver Library (Google 源码) │  2. OS Adaptation Layer (OEM 实现) │
│                   │                                 │
│  • 输入事件管理 (Touch/Key/Pointer)    │  • 输入硬件绑定 (Touchscreen/Buttons) │
│  • 语音命令路由 (Google Assistant)     │  • 手势限制 (禁止复杂操作)          │
│  • 错误恢复 (事件丢失/冲突)            │  • 优先级控制 (语音 &gt; 触摸 &gt; 按键)  │
└───────────────────┴─────────────────────────────────┘
</code></pre>
<h4 data-id="heading-4"><strong>2. 核心强制要求（R05-010 ~ R05-100）</strong></h4>







































































<table><thead><tr><th>条款</th><th>要求</th><th>开发必须操作</th><th>违反后果</th></tr></thead><tbody><tr><td><strong>R05-010</strong></td><td><strong>必须转发所有输入事件到 MD</strong></td><td>1. Android：<code>InputManager.sendEvent(event)</code><br/>2. QNX：<code>input_forward_event(event)</code></td><td>❌ 认证失败（CTS 报错 <code>INPUT_EVENT_DROP</code>）</td></tr><tr><td><strong>R05-020</strong></td><td><strong>必须支持 Google Assistant 语音指令</strong></td><td>1. 实现 <code>onVoiceCommand(String command)</code> 接口<br/>2. 禁止屏蔽语音命令</td><td>❌ 认证失败（CTS 报错 <code>VOICE_COMMAND_FAILURE</code>）</td></tr><tr><td><strong>R05-030</strong></td><td><strong>禁止自定义手势操作</strong></td><td>1. Android：<code>GestureDetector.disable()</code><br/>2. QNX：<code>gesture_disable_all()</code></td><td>❌ 认证失败（CTS 报错 <code>GESTURE_CUSTOMIZATION_DENIED</code>）</td></tr><tr><td><strong>R05-040</strong></td><td><strong>触摸事件必须延迟 ≤150ms</strong></td><td>1. Android：<code>InputQueue.setEventTimeout(150)</code><br/>2. QNX：<code>input_set_timeout(150)</code></td><td>❌ 认证失败（CTS 报错 <code>TOUCH_LATENCY_TOO_HIGH</code>）</td></tr><tr><td><strong>R05-050</strong></td><td><strong>按键事件必须优先级高于触摸</strong></td><td>1. Android：<code>InputManager.setPriority(INPUT_PRIORITY_KEY)</code><br/>2. QNX：<code>input_set_priority(KEYBOARD, 1)</code></td><td>❌ 认证失败（CTS 报错 <code>INPUT_PRIORITY_MISMATCH</code>）</td></tr><tr><td><strong>R05-060</strong></td><td><strong>必须支持语音命令覆盖 80% 核心操作</strong></td><td>1. 实现 <code>onVoiceCommand("Play Music")</code> 等指令<br/>2. 禁止限制语音命令集</td><td>❌ 认证失败（CTS 报错 <code>VOICE_COVERAGE_INSUFFICIENT</code>）</td></tr><tr><td><strong>R05-070</strong></td><td><strong>必须启用输入事件防抖机制</strong></td><td>1. Android：<code>InputFilter.addBounceFilter()</code><br/>2. QNX：<code>input_enable_bounce_filter(true)</code></td><td>❌ 认证失败（CTS 报错 <code>INPUT_BOUNCE_FAILURE</code>）</td></tr><tr><td><strong>R05-080</strong></td><td><strong>必须支持多点触控（最多 5 点）</strong></td><td>1. Android：<code>MotionEvent.getPointerCount() &lt;= 5</code><br/>2. QNX：<code>input_set_max_pointers(5)</code></td><td>❌ 认证失败（CTS 报错 <code>TOUCH_POINT_COUNT_INVALID</code>）</td></tr><tr><td><strong>R05-090</strong></td><td><strong>禁止使用非标准输入设备</strong></td><td>1. Android：<code>InputDevice.isStandard()</code><br/>2. QNX：<code>input_validate_standard_device()</code></td><td>❌ 认证失败（CTS 报错 <code>NON_STANDARD_INPUT_DEVICE</code>）</td></tr><tr><td><strong>R05-100</strong></td><td><strong>必须支持输入事件回滚（撤销误触）</strong></td><td>1. Android：<code>InputManager.rollbackEvent(eventId)</code><br/>2. QNX：<code>input_rollback(event_id)</code></td><td>❌ 认证失败（CTS 报错 <code>INPUT_ROLLBACK_FAILURE</code>）</td></tr></tbody></table>
<blockquote>
<p>⚠️ <strong>致命错误</strong>：<br/>
<strong>自定义手势逻辑或修改输入事件路由</strong> → Google 会检测到协议栈不兼容 → 认证失败。</p>
</blockquote>
<hr/>
<h3 data-id="heading-5"><strong>二、输入事件处理关键实现（开发必知）</strong></h3>
<h4 data-id="heading-6"><strong>1. 输入事件转发逻辑</strong></h4>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-comment">// Android 示例：转发触摸事件</span>
<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">onMotionEvent</span><span class="hljs-params">(MotionEvent* event)</span> </span>{
    <span class="hljs-keyword">if</span> (event-&gt;<span class="hljs-built_in">getAction</span>() == MotionEvent::ACTION_DOWN) {
        InputManager::<span class="hljs-built_in">sendEvent</span>(event);
    }
}

<span class="hljs-comment">// QNX 示例：转发按键事件</span>
<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">onKeyEvent</span><span class="hljs-params">(KeyEvent* key)</span> </span>{
    <span class="hljs-keyword">if</span> (key-&gt;<span class="hljs-built_in">getKeyCode</span>() == KEY_VOLUME_UP) {
        <span class="hljs-built_in">input_forward_event</span>(key);
    }
}
</code></pre>
<h4 data-id="heading-7"><strong>2. Google Assistant 语音命令集成</strong></h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// Android 示例：处理语音指令</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onVoiceCommand</span><span class="hljs-params">(String command)</span> {
    <span class="hljs-keyword">if</span> (command.equals(<span class="hljs-string">"Play Music"</span>)) {
        mediaController.play();
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (command.equals(<span class="hljs-string">"Navigate to Home"</span>)) {
        navigation.startRoute(<span class="hljs-string">"Home"</span>);
    }
}
</code></pre>
<h4 data-id="heading-8"><strong>3. 输入事件防抖实现</strong></h4>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-comment">// QNX 示例：启用防抖过滤</span>
<span class="hljs-built_in">input_enable_bounce_filter</span>(<span class="hljs-literal">true</span>);
<span class="hljs-built_in">input_set_bounce_threshold</span>(<span class="hljs-number">50</span>); <span class="hljs-comment">// 毫秒</span>
</code></pre>
<blockquote>
<p>⚠️ <strong>开发陷阱</strong>：</p>
<ul>
<li><strong>Android 的 <code>InputManager</code> 必须使用系统提供的 API</strong>（禁止直接操作底层驱动）</li>
<li><strong>QNX 的输入缓冲区大小需为 512 字节</strong>（否则触发 <code>INPUT_BUFFER_SIZE_INVALID</code>）</li>
</ul>
</blockquote>
<hr/>
<h3 data-id="heading-9"><strong>三、Google 认证测试要求（CTS 测试用例）</strong></h3>
<h4 data-id="heading-10"><strong>1. 必须通过的测试用例</strong></h4>








































<table><thead><tr><th>测试用例</th><th>验证目标</th><th>通过标准</th></tr></thead><tbody><tr><td><code>InputEventForwardingTest</code></td><td>输入事件是否全部转发到 MD</td><td><code>event_forwarded_count &gt; 0</code></td></tr><tr><td><code>VoiceCommandCoverageTest</code></td><td>语音命令是否覆盖 80% 核心操作</td><td><code>voice_coverage &gt;= 80%</code></td></tr><tr><td><code>TouchLatencyTest</code></td><td>触摸事件延迟 ≤150ms</td><td><code>latency_ms &lt;= 150</code></td></tr><tr><td><code>GestureCustomizationTest</code></td><td>是否禁止自定义手势</td><td><code>custom_gestures_allowed == false</code></td></tr><tr><td><code>InputPriorityTest</code></td><td>按键优先级高于触摸</td><td><code>keyboard_priority &gt; touch_priority</code></td></tr><tr><td><code>InputRollbackTest</code></td><td>输入事件回滚是否正常</td><td><code>rollback_success_count &gt; 0</code></td></tr></tbody></table>
<h4 data-id="heading-11"><strong>2. 认证失败高频原因（Google 官方数据）</strong></h4>






























<table><thead><tr><th>问题</th><th>占比</th><th>解决方案</th></tr></thead><tbody><tr><td>输入事件未转发</td><td>40%</td><td>检查 <code>InputManager.sendEvent()</code> 调用</td></tr><tr><td>语音命令覆盖率不足</td><td>30%</td><td>实现 <code>onVoiceCommand()</code> 全部指令</td></tr><tr><td>触摸延迟 &gt;150ms</td><td>20%</td><td>优化 <code>InputQueue</code> 缓冲区大小</td></tr><tr><td>自定义手势逻辑</td><td>10%</td><td>禁用所有手势检测</td></tr></tbody></table>
<hr/>
<h3 data-id="heading-12"><strong>四、开发自检清单（认证前必查）</strong></h3>








































<table><thead><tr><th>检查项</th><th>操作指南</th><th>验证工具</th></tr></thead><tbody><tr><td><strong>1. 输入事件转发</strong></td><td>检查 <code>InputManager.sendEvent()</code> 或 <code>input_forward_event()</code> 是否调用</td><td><code>adb shell dumpsys input</code></td></tr><tr><td><strong>2. 语音命令覆盖率</strong></td><td>检查 <code>onVoiceCommand()</code> 是否实现 80% 以上指令</td><td><code>adb shell dumpsys voice</code></td></tr><tr><td><strong>3. 触摸延迟</strong></td><td>用 <code>InputQueue.getEventTimeout()</code> 计算延迟</td><td>自定义测试脚本</td></tr><tr><td><strong>4. 按键优先级</strong></td><td>检查 <code>InputManager.setPriority()</code> 是否设置为 <code>INPUT_PRIORITY_KEY</code></td><td><code>adb shell cat /proc/input/priority</code></td></tr><tr><td><strong>5. 输入防抖</strong></td><td>检查 <code>input_enable_bounce_filter()</code> 是否启用</td><td><code>adb shell cat /proc/input/bounce</code></td></tr><tr><td><strong>6. 多点触控</strong></td><td>检查 <code>MotionEvent.getPointerCount()</code> 是否 ≤5</td><td><code>adb shell dumpsys motionevent</code></td></tr></tbody></table>
<blockquote>
<p>🔥 <strong>认证通过率提升技巧</strong>：</p>
<ol>
<li><strong>在 CI 流程中强制检查语音命令覆盖率</strong>：
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 自动化测试脚本</span>
<span class="hljs-keyword">if</span> [ $(get_voice_coverage.sh) -lt 80 ]; <span class="hljs-keyword">then</span>
  <span class="hljs-built_in">echo</span> <span class="hljs-string">"Voice command coverage &lt;80%: <span class="hljs-variable">$coverage</span>"</span>
  <span class="hljs-built_in">exit</span> 1
<span class="hljs-keyword">fi</span>
</code></pre>
</li>
<li><strong>使用 Google 的参考实现</strong>：
<ul>
<li>Android 参考：<code>car-receiver-library/examples/android/input</code></li>
<li>QNX 参考：<code>car-receiver-library/examples/qnx/input</code></li>
</ul>
</li>
</ol>
</blockquote>
<hr/>
<h3 data-id="heading-13"><strong>五、附：Google 官方资源与避坑指南</strong></h3>






























<table><thead><tr><th>资源</th><th>用途</th><th>避坑提示</th></tr></thead><tbody><tr><td><strong><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fandroid%2Fcar-receiver-library%2Ftree%2Fmain%2Finput" target="_blank" title="https://github.com/android/car-receiver-library/tree/main/input" ref="nofollow noopener noreferrer">Input Handling GitHub</a></strong></td><td>获取参考实现</td><td>⚠️ <strong>切勿修改 <code>InputManager</code> 或 <code>input_forward_event</code> 内部逻辑</strong></td></tr><tr><td><strong><a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Fcar%2Fhuig%23cts" target="_blank" title="https://developer.android.com/car/huig#cts" ref="nofollow noopener noreferrer">CTS 测试工具</a></strong></td><td>运行认证测试</td><td>⚠️ 仅支持 <strong>Linux</strong> 环境（Windows/Mac 需用 WSL）</td></tr><tr><td><strong><a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.qnx.com%2Fdocs%2F7.1%2Finput%2Findex.html" target="_blank" title="https://developer.qnx.com/docs/7.1/input/index.html" ref="nofollow noopener noreferrer">QNX 输入调试指南</a></strong></td><td>QNX 输入适配参考</td><td>⚠️ 需安装 <code>qnx-ntoarmv7le-gcc</code> 11.0 工具链</td></tr><tr><td><strong><a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Fcar%2Fhuig%2Ftroubleshooting" target="_blank" title="https://developer.android.com/car/huig/troubleshooting" ref="nofollow noopener noreferrer">常见错误日志</a></strong></td><td>解析认证失败原因</td><td>⚠️ <code>Error 5001: Voice command coverage &lt;80%</code> → 实现全部指令</td></tr></tbody></table>
<blockquote>
<p>⚠️ <strong>终极警告</strong>：<br/>
<strong>Google 不提供输入子系统的商业二进制版本</strong>！<br/>
所有车厂必须<strong>自行实现输入协议栈</strong>，否则认证直接失败。</p>
</blockquote>
<hr/>
<blockquote>
<p>✅ <strong>文档总结</strong>：<br/>
第 5 章的核心是 <strong>“严格遵循输入事件转发、语音命令覆盖、触摸延迟上限”</strong>。<br/>
<strong>任何优化（如自定义手势逻辑、修改输入优先级）都是致命错误</strong>。<br/>
<strong>必须通过 Google 的输入 CTS 测试套件</strong>。</p>
</blockquote>
<blockquote>
<p><strong>下一步行动</strong>：</p>
<ol>
<li>立即从 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fandroid%2Fcar-receiver-library" target="_blank" title="https://github.com/android/car-receiver-library" ref="nofollow noopener noreferrer">GitHub</a> 下载 <strong><code>input</code> 模块参考实现</strong></li>
<li>按照 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fandroid%2Fcar-receiver-library%2Ftree%2Fmain%2Finput%2Fqnx" target="_blank" title="https://github.com/android/car-receiver-library/tree/main/input/qnx" ref="nofollow noopener noreferrer">QNX 示例</a> 搭建开发环境</li>
<li>用 <strong>CTS 测试工具</strong> 运行 <code>VoiceCommandCoverageTest</code> 验证覆盖率</li>
</ol>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[RAG不会过时，但你需要这10个上下文处理技巧丨Context Engineering]]></title>    <link>https://juejin.cn/post/7577307409854005263</link>    <guid>https://juejin.cn/post/7577307409854005263</guid>    <pubDate>2025-11-28T02:46:18.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577307409854005263" data-draft-id="7576955345378000959" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="RAG不会过时，但你需要这10个上下文处理技巧丨Context Engineering"/> <meta itemprop="keywords" content="LLM,Agent,程序员"/> <meta itemprop="datePublished" content="2025-11-28T02:46:18.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="AI大模型"/> <meta itemprop="url" content="https://juejin.cn/user/3817967696221534"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            RAG不会过时，但你需要这10个上下文处理技巧丨Context Engineering
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3817967696221534/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    AI大模型
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-28T02:46:18.000Z" title="Fri Nov 28 2025 02:46:18 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-28
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读17分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#383838;font-size:15px;line-height:30px;letter-spacing:2px;word-break:break-word;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen,Ubuntu,Cantarell,Open Sans,Helvetica Neue,sans-serif;scroll-behavior:smooth;background-image:linear-gradient(0deg,transparent 24%,rgba(201,195,195,.329) 25%,hsla(0,8%,80.4%,.05) 26%,transparent 27%,transparent 74%,hsla(0,5.2%,81%,.185) 75%,rgba(180,176,176,.05) 76%,transparent 77%,transparent),linear-gradient(90deg,transparent 24%,rgba(204,196,196,.226) 25%,hsla(0,4%,66.1%,.05) 26%,transparent 27%,transparent 74%,hsla(0,5.2%,81%,.185) 75%,rgba(180,176,176,.05) 76%,transparent 77%,transparent);background-color:#fff;background-size:50px 50px;padding-bottom:60px}.markdown-body ::selection{color:#fff;background-color:#a862ea}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{margin:24px 0 12px;color:#a862ea}.markdown-body h1{line-height:2;font-size:1.4em}.markdown-body h1~p:first-of-type:first-letter{color:#a862ea;float:left;font-size:2em;margin-right:.4em;font-weight:bolder}.markdown-body h2{font-size:1.2em}.markdown-body h3{font-size:1.1em}.markdown-body ol,.markdown-body ul{padding-left:2em}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;padding-left:.2em}.markdown-body ol li::marker,.markdown-body ul li::marker{color:#a862ea}.markdown-body ol li.task-list-item,.markdown-body ul li.task-list-item{list-style:none}.markdown-body ol li.task-list-item ol,.markdown-body ol li.task-list-item ul,.markdown-body ul li.task-list-item ol,.markdown-body ul li.task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:10px}.markdown-body a,.markdown-body code,.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6,.markdown-body li,.markdown-body p{opacity:.85;vertical-align:baseline;transition:all .1s ease}.markdown-body a:hover,.markdown-body code:hover,.markdown-body h1:hover,.markdown-body h2:hover,.markdown-body h3:hover,.markdown-body h4:hover,.markdown-body h5:hover,.markdown-body h6:hover,.markdown-body li:hover,.markdown-body p:hover{opacity:1}.markdown-body a{display:inline-block;color:#a862ea;cursor:pointer;text-decoration:none;position:relative}.markdown-body a:after{content:"";position:absolute;width:98%;height:1px;bottom:0;left:0;transform:scaleX(0);background-color:#a862ea;transform-origin:bottom right;transition:transform .3s ease-in-out}.markdown-body a:hover:after{transform:scaleX(1);transform-origin:bottom left}.markdown-body a:active,.markdown-body a:link{color:#a862ea}.markdown-body img{max-width:100%;user-select:none;margin:1em 0;transition:transform .2s ease 0s;background-color:#f8f5ff;box-shadow:0 0 10px #e7daff}.markdown-body img:hover{opacity:1;box-shadow:0 0 20px #e7daff;transform:translateY(-1px)}.markdown-body blockquote{padding:.5em 1em;margin:12px 0;border-top-left-radius:2px;border-bottom-left-radius:2px;border-left:3px solid #a862ea;background-color:#f8f5ff}.markdown-body blockquote&gt;p{margin:0}.markdown-body .math{font-style:italic;margin:12px 0;padding:.5em 1em;background-color:#f8f5ff}.markdown-body .math&gt;p{margin:0}.markdown-body code{padding:2px .4em;overflow-x:auto;color:#a862ea;font-weight:700;word-break:break-word;font-family:Operator Mono,Consolas,Monaco,Menlo,monospace;background-color:#f8f5ff}.markdown-body pre{margin:2em 0}.markdown-body pre&gt;code{display:block;padding:1.5em;word-break:normal;font-size:.9em;font-style:normal;font-weight:400;font-family:Operator Mono,Consolas,Monaco,Menlo,monospace;line-height:18px;color:#383838;border-radius:2px;scroll-behavior:smooth;box-shadow:0 0 10px #e7daff}.markdown-body pre&gt;code:hover{box-shadow:0 0 20px #e7daff}.markdown-body pre&gt;code::-webkit-scrollbar{height:6px;background-color:#f8f5ff}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:#e7daff;border-bottom-left-radius:3px;border-bottom-right-radius:3px}.markdown-body hr{margin:2em 0;border-top:1px solid #a862ea}.markdown-body table{width:100%;font-size:12px;max-width:100%;overflow:auto;border-collapse:collapse}.markdown-body thead{color:#a862ea;background:#f8f5ff}.markdown-body td,.markdown-body th{padding:.5em;border:1px solid #e7daff}.markdown-body tr{background-color:#f8f5ff}@media (max-width:720px){.markdown-body{font-size:12px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>本文较长，建议点赞收藏。更多AI大模型应用开发学习视频及资料，在<a href="https://link.juejin.cn?target=https%3A%2F%2Fhy.zhipoai.cn%2F" target="_blank" title="https://hy.zhipoai.cn/" ref="nofollow noopener noreferrer">智泊AI</a>。</p>
</blockquote>
<p><strong>对大部分开发者来说，搭一个RAG或者agent不难，怎么把它优化成生产可用的状态最难。</strong></p>
<p>在这个过程中，检索效率、准确性、成本、响应速度，都是重点关注问题。</p>
<p>那么，如何对其进行优化？业内一致看好Context Engineering也就是上下文工程。</p>
<p>本系列文章，将从上下文工程的不同环节（上下文处理与生成、上下文处理、上下文管理）最新的行业探索与进展，进行解读。</p>
<h2 data-id="heading-0">01 如何理解Context Engineering</h2>
<p>上下文工程的本质是通过动态构建、优化LLM推理时的信息负载（含查询、外部知识、历史对话等，比“提示词”更宽泛），提升系统长期性能与效率。它是算法驱动的系统级优化，涵盖提示词工程、RAG、多智能体等技术，</p>
<p>从框架来看，上下文工程分为基础组件（信息生命周期核心模块）和复杂系统实现（组件的高级集成应用），二者可灵活组合适配不同场景。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d90f53081e3b4d8b83c71c81806cd574~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764902778&amp;x-signature=5G9M%2BXrVg0PiggY1SO1%2FyzI3y%2Fs%3D" alt="" loading="lazy"/></p>
<h5 data-id="heading-1">其中，基础组件包括</h5>
<ol>
<li>上下文检索与生成：从提示词、外部知识库等获取原始信息，通过动态组装形成适配任务的上下文</li>
<li>上下文处理：通过压缩、摘要、结构化转换等技术，精炼原始信息，适配模型理解与推理</li>
<li>上下文管理：构建内存层次、运用压缩技术，在资源约束下高效存储、调度上下文信息</li>
</ol>
<h5 data-id="heading-2">复杂系统实现包括</h5>
<ol start="4">
<li>检索增强生成（RAG）：结合信息检索与LLM生成，从外部知识库获取“证据”，解决知识陈旧和幻觉问题，含模块化、智能体、图增强等架构</li>
<li>记忆系统：管理运行过程中的动态“经验”，分短期/长期记忆，支撑持久交互与长期学习</li>
<li>工具集成推理：赋予LLM调用外部工具/API的能力，扩展任务边界，需处理工具数据与上下文更新</li>
<li>多智能体系统：多个具备专业能力的智能体协作，通过通信协调完成复杂任务，需管理共享上下文与全局状态</li>
</ol>
<h2 data-id="heading-3">02 上下文处理的行业进展与方法</h2>
<p>构成上下文工程的三大核心技术支柱：上下文检索与生成、上下文处理以及上下文管理。这些技术方法是实现高效、智能上下文系统的具体手段。</p>
<p>其中，上下文处理是上下文工程的第二个核心组件，它专注于对获取到的上下文信息进行转换和优化，以克服LLM在处理复杂信息时面临的挑战，并最大化信息的效用。</p>
<p>以下为行业关于上下文处理所做出的一些行之有效的探索。</p>
<h5 data-id="heading-4">（1）长上下文处理 (Long Context Processing)</h5>
<p>处理超长序列上下文是LLM面临的一个根本性挑战，主要源于Transformer自注意力机制O(n²)的计算复杂度，这导致了随着序列长度增加而急剧增长的计算和内存瓶颈。例如，将Mistral-7B的输入从4K tokens增加到128K tokens，计算量会增加122倍。Llama 3.1 8B在处理128K tokens的请求时，可能需要高达16GB的内存。为了解决这些问题，研究者们从架构创新、位置插值和优化技术等多个角度进行了探索。</p>
<h6 data-id="heading-5">a. 架构创新 (如 State Space Models, Dilated Attention)</h6>
<p>为了从根本上解决Transformer的二次复杂度问题，研究者们提出了一系列创新的模型架构。</p>
<ul>
<li><strong>状态空间模型（State Space Models, SSMs）</strong>  ：SSMs通过使用固定大小的隐藏状态，实现了线性的计算复杂度和恒定的内存需求。像Mamba这样的模型提供了高效的循环计算机制，其扩展性远优于传统的Transformer。</li>
<li><strong>扩张注意力（Dilated Attention）</strong>  ：以LongNet为代表的方法，采用随着token距离增加而指数级扩张的注意力域，实现了线性的计算复杂度，同时保持了token之间的对数依赖性，使其能够处理超过十亿tokens的序列。</li>
<li><strong>托普利茨神经网络（Toeplitz Neural Networks, TNNs）</strong>  ：TNNs使用相对位置编码的托普利茨矩阵来建模序列，将时空复杂度降低到对数线性级别，并实现了从512个训练tokens到14,000个推理tokens的有效外推。</li>
<li><strong>线性注意力（Linear Attention）</strong>  ：通过将自注意力表示为核特征映射的线性点积，线性注意力机制将复杂度从O(N²)降低到O(N)，在处理极长序列时实现了高达4000倍的加速。</li>
</ul>
<h6 data-id="heading-6">b.位置插值与上下文扩展 (如 YaRN, Self-Extend)</h6>
<p>对于已经预训练好的模型，直接扩展其上下文窗口长度是一个挑战。位置插值技术通过在推理时智能地重新缩放位置索引，而不是外推到未见过的位置，从而实现了对更长序列的处理。</p>
<ul>
<li><strong>神经正切核（Neural Tangent Kernel, NTK）方法</strong>：YaRN（Yet another RoPE-based Interpolation method）结合了NTK插值、线性插值和注意力分布校正，为上下文扩展提供了数学上更严谨的框架。</li>
<li><strong>两阶段扩展方法</strong>：LongRoPE通过两阶段方法实现了2048K tokens的上下文窗口：首先将模型微调至256K长度，然后进行位置插值以达到最大上下文长度。</li>
<li><strong>无需微调的技术</strong>：Self-Extend等技术允许LLM在不进行任何微调的情况下处理长上下文，它通过采用双层注意力策略——分组注意力和邻近注意力——来捕获远距离和相邻token之间的依赖关系。</li>
</ul>
<h6 data-id="heading-7">c.优化技术 (如 FlashAttention, Sparse Attention)</h6>
<p>在不改变模型基本架构的前提下，研究者们还开发了多种优化技术来提高长上下文处理的效率。</p>
<ul>
<li><strong>分组查询注意力（Grouped-Query Attention, GQA）</strong>  ：GQA将查询头分组，每组共享键和值头，在多查询注意力和多头注意力之间取得了平衡，显著降低了解码过程中的内存需求。</li>
<li><strong>FlashAttention</strong>：FlashAttention利用GPU内存层次结构的不对称性，实现了线性的内存扩展，而不是二次方增长。其后续版本FlashAttention-2通过减少非矩阵乘法操作和优化工作分配，实现了约两倍的速度提升。</li>
<li><strong>稀疏注意力（Sparse Attention）</strong>  ：通过只计算部分token之间的注意力权重，稀疏注意力技术可以大幅降低计算量。例如，BigBird结合了局部注意力、全局token和随机连接，能够高效处理比以往长8倍的序列。StreamingLLM则通过保留关键的“注意力汇聚”（attention sink）token和最近的KV缓存条目，实现了对无限长序列的处理，在处理400万tokens的序列时，速度比滑动窗口重计算快22.2倍。</li>
<li><strong>内存管理与压缩</strong>：H₂O（Heavy Hitter Oracle）提出了一种高效的KV缓存驱逐策略，基于观察到少数token贡献了大部分注意力值的原理，在提高吞吐量的同时降低了延迟。Infini-attention则将压缩记忆整合到 vanilla attention 中，结合了掩码局部注意力和长期线性注意力，使得处理无限长输入时的内存和计算都是有界的。</li>
</ul>
<h5 data-id="heading-8">(2)上下文自我精炼与适应 (Contextual Self-Refinement and Adaptation)</h5>
<p>上下文自我精炼与适应是一种让大型语言模型模仿人类修订过程，通过循环反馈机制自主改进其输出的技术范式。</p>
<p>与依赖外部奖励模型的强化学习方法不同，自我精炼主要通过模型自身的自我评估和对话式交互来实现，通常利用精心设计的提示词工程来引导模型进行迭代优化。</p>
<p>这种方法的核心思想是，对于一个给定的任务，识别并修正错误往往比一次性生成完美解决方案更容易。通过赋予模型自我批判和修正的能力，可以显著提升其在复杂推理、代码生成、创意写作等任务上的表现，并使其能够更好地适应新的任务和环境。</p>
<h6 data-id="heading-9">a.基础自我精炼框架 (如 Self-Refine, Reflexion)</h6>
<p>一系列基础框架为上下文自我精炼提供了具体的实现路径。Self-Refine框架是一个典型的代表，它使用同一个LLM同时扮演生成器（generator）、反馈提供者（feedback provider）和精炼器（refiner）的角色。</p>
<p>模型首先生成一个初始解决方案，然后对自己的输出提供具体的、可操作的反馈，最后根据这些反馈对解决方案进行精炼。这个过程可以循环多次，直到达到满意的结果。</p>
<p>Reflexion框架则更进一步，它引入了“反思文本”（reflective text）的概念，将模型在任务执行过程中的失败经验和教训以自然语言的形式存储在情节记忆缓冲区（episodic memory buffer）中。</p>
<p>这些反思文本在后续的任务中可以被检索出来，作为指导模型决策的上下文，从而避免重复犯错。然而，研究也表明，简单的提示词往往不足以实现可靠的自我修正，因此需要更结构化的引导。</p>
<p>例如，N-CRITICS框架采用基于集成（ensemble-based）的评估方法，让多个不同的模型或同一个模型的不同实例对初始输出进行评估，并汇总它们的反馈来指导精炼过程，从而获得更全面、更独立的评价。</p>
<h6 data-id="heading-10">b. 元学习与自主进化 (如 SELF, Self-rewarding)</h6>
<p>上下文自我精炼的高级阶段是元学习（Meta-Learning）和自主进化（Autonomous Evolution），其目标是让模型不仅学会解决具体任务，更学会如何学习（learning to learn）。</p>
<p>SELF框架通过少量示例教会LLM元技能，如自我反馈和自我精炼，然后让模型通过生成和筛选自己的训练数据来进行持续的自我进化。自奖励（Self-rewarding） 机制则让模型通过迭代式的自我评判来自主提升，模型同时扮演执行者（performer）和评判者（judge）的角色，通过最大化自己给自己分配的奖励来优化行为。</p>
<p>Creator框架将这种范式扩展到工具使用，使LLM能够自主地创建和使用自己的工具，通过一个包含创建、决策、执行和识别的四模块流程来完成复杂任务。</p>
<p>而Self-Developing框架则代表了最高度的自主性，它使LLM能够自主地发现、实现和精炼自己的改进算法，通过迭代循环生成算法候选者作为可执行代码，从而实现真正的自我发展。这些框架共同指向了一个长期演变方向，即LLM将不再是静态的工具，而是能够持续学习和进化的智能体。</p>
<h5 data-id="heading-11">(3)多模态上下文 (Multimodal Context)</h5>
<p>多模态上下文工程旨在将大型语言模型的能力从纯文本领域扩展到能够理解和处理包含视觉、听觉、3D环境等多种数据类型的复杂现实世界场景。</p>
<p>通过将不同模态的信息整合到统一的上下文表示中，多模态大型语言模型（MLLMs）能够执行图像描述、视觉问答、视频理解等更为复杂的任务。</p>
<p>然而，这种扩展也带来了新的挑战，包括如何有效地融合不同模态的信息、如何进行跨模态的推理，以及如何高效地处理长序列的多模态数据。该领域的研究致力于构建能够像人类一样，综合利用多种感官信息来理解世界的智能系统。</p>
<h6 data-id="heading-12">a.模态融合与跨模态推理</h6>
<p>模态融合是多模态上下文处理的核心，其目标是将来自不同来源（如图像、文本、音频）的信息整合成一个连贯、统一的表示。</p>
<p>基础的融合方法通常是将视觉输入通过专门的编码器（如CLIP）转换为一系列离散的token，然后与文本token拼接，共同输入到LLM中。然而，这种简单的拼接可能无法实现深度的语义融合。</p>
<p>更先进的策略，如交叉模态注意力机制（cross-modal attention） ，允许模型在LLM的嵌入空间内直接学习文本token和视觉token之间的细粒度依赖关系，从而增强对图像编辑等任务的理解。</p>
<p>为了处理长序列输入，分层设计（hierarchical designs） 将不同模态的处理分阶段进行，以确保可扩展性。</p>
<p>此外，一些研究尝试绕过对纯文本LLM的适配，采用从一开始就联合预训练多模态数据和文本语料的统一训练范式，以从根本上缓解模态对齐的挑战。跨模态推理则要求模型不仅能理解每个模态，还能推断它们组合后的整体含义，例如理解一张图片和一段文字共同表达的讽刺意味。</p>
<h6 data-id="heading-13">b.多模态编码器与对齐模块 (如 CLIP, Q-Former)</h6>
<p>实现多模态融合的关键技术组件是外部的多模态编码器和连接它们与LLM主干的对齐模块（alignment modules） 。</p>
<p>目前，主流的架构范式是使用专门的多模态编码器来处理特定类型的数据，例如使用CLIP（Contrastive Language-Image Pre-training）模型来处理视觉信息，或使用CLAP（Contrastive Language-Audio Pre-training）模型来处理音频信息。</p>
<p>这些编码器将原始的多模态数据（如像素、声波）转换为高维的特征向量。接下来，对齐模块负责将这些特征向量映射到LLM的嵌入空间中，使其能够与文本token进行交互。</p>
<p>常见的对齐模块包括简单的多层感知机（MLP）和更复杂的Q-Former（Querying Transformer）。Q-Former通过一个可学习的查询token集合来从视觉编码器的输出中提取与文本最相关的视觉特征，从而实现更精细的模态对齐。这种模块化的设计允许独立地更新多模态编码器，而无需对整个LLM进行重新训练，提供了极大的灵活性。</p>
<h5 data-id="heading-14">(4)关系型与结构化上下文 (Relational and Structured Context)</h5>
<p>大型语言模型在处理表格、数据库、知识图谱等关系型和结构化数据时面临着根本性的限制。</p>
<p>其主要原因在于LLM的输入是基于线性序列的文本，而结构化数据内部蕴含着复杂的、非线性的关系和层次结构。将结构化数据简单地线性化（例如，将表格的每一行转换成一句话）往往会丢失关键的结构性信息，导致模型性能下降，尤其是在信息分散在上下文不同位置时。</p>
<p>为了克服这一挑战，研究者们探索了多种方法，旨在将结构化信息以一种LLM能够有效利用的方式编码和整合，从而提升模型在需要复杂推理和事实核查的任务上的表现。</p>
<h6 data-id="heading-15">a. 知识图谱与神经网络集成</h6>
<p>知识图谱（Knowledge Graphs, KGs）作为一种强大的结构化知识表示形式，其与LLM的集成是当前研究的热点。</p>
<p>一种直接的方法是利用知识图谱嵌入（Knowledge Graph Embeddings） ，将图谱中的实体和关系转换为低维的数值向量。这些嵌入向量可以被整合到LLM的输入或内部表示中，为模型提供结构化的背景知识。</p>
<p>更进一步的集成方式是引入图神经网络（Graph Neural Networks, GNNs） 。GNNs能够直接在图结构上进行计算，捕捉实体之间复杂的多跳（multi-hop）关系。一些混合架构，如GraphFormers，将GNN组件嵌套在Transformer块中，实现了语言上下文和图结构信息的深度交互。例如，GreaseLM模型在所有模型层中促进了语言上下文表示和结构化世界知识之间的双向交互，使得两者能够相互增强。</p>
<p>QA-GNN则通过构建联合图和基于图的消息传递机制，实现了问答上下文和知识图谱之间的双向注意力连接。</p>
<h6 data-id="heading-16">b. 文字化技术 (Verbalization)</h6>
<p><strong>文字化（Verbalization）</strong>  是一种将结构化数据（如知识图谱三元组、表格行、数据库记录）转换为自然语言句子的技术。</p>
<p>这种方法的优势在于，它无需对现有的LLM架构进行任何修改，即可将结构化信息无缝地整合到语言系统中。例如，一个知识图谱三元组 <code>(Albert Einstein, bornIn, Ulm)</code> 可以被转换成句子“阿尔伯特·爱因斯坦出生于乌尔姆”。</p>
<p>然而，简单的文字化可能无法完全保留原始数据的结构和关系。因此，研究者们也探索了使用编程语言（如Python或SQL）来表示结构化数据。研究表明，在复杂的推理任务中，使用Python实现知识图谱或SQL查询数据库，其性能优于传统的自然语言表示，因为它们能够更好地利用数据固有的结构性。</p>
<p>此外，一些方法还利用LLM自身的能力来提取结构化信息，并将其表示为图、表格或关系模式，从而实现对输入文本的多层次结构化。</p>
<h6 data-id="heading-17">c.混合架构 (如 GraphToken, Heterformer)</h6>
<p>为了更有效地处理结构化数据，研究者们设计了多种混合架构，将LLM与专门处理图结构的模块相结合。</p>
<p>GraphToken 是一个典型的例子，它通过引入参数高效的编码函数，显式地将结构信息表示为特殊的token，在图推理任务上取得了高达73个百分点的性能提升。</p>
<p>Heterformer 等混合GNN-LM架构则在统一的模型中执行上下文相关的文本编码和异构图结构编码，解决了扩展这些集成系统时面临的计算挑战。这些混合架构通常遵循不同的集成范式。</p>
<p>例如，K-BERT 在预训练阶段就将知识图谱三元组注入到模型中，使模型内化事实知识。而KAPING等推理时（inference-time）方法则通过检索相关事实并将其前置到提示词中，实现了无需重新训练模型的实时知识访问。</p>
<p>更复杂的实现，如通过适配器模块和交叉注意力机制将知识图谱衍生的表示直接嵌入到模型的潜在空间中，实现了更深度的融合。</p>
<h3 data-id="heading-18">学习资源推荐</h3>
<p>如果你想更深入地学习大模型，以下是一些非常有价值的学习资源，这些资源将帮助你从不同角度学习大模型，提升你的实践能力。</p>
<blockquote>
<p>本文较长，建议点赞收藏。更多AI大模型应用开发学习视频及资料，在<a href="https://link.juejin.cn?target=https%3A%2F%2Fhy.zhipoai.cn%2F" target="_blank" title="https://hy.zhipoai.cn/" ref="nofollow noopener noreferrer">智泊AI</a>。</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[verl进行Agentic-RL多工具数据集字段匹配问题记录]]></title>    <link>https://juejin.cn/post/7577300470520643593</link>    <guid>https://juejin.cn/post/7577300470520643593</guid>    <pubDate>2025-11-28T03:00:20.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577300470520643593" data-draft-id="7569078155027316736" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="verl进行Agentic-RL多工具数据集字段匹配问题记录"/> <meta itemprop="keywords" content="人工智能"/> <meta itemprop="datePublished" content="2025-11-28T03:00:20.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Q同学"/> <meta itemprop="url" content="https://juejin.cn/user/3861941936200327"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            verl进行Agentic-RL多工具数据集字段匹配问题记录
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3861941936200327/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Q同学
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-28T03:00:20.000Z" title="Fri Nov 28 2025 03:00:20 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-28
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">问题背景</h2>
<p>近期在用verl框架进行Agentic-RL训练，之前的agent model实验我一般都是采用了与<code>ToRL</code>或者<code>ReTool</code>类似的数据格式，即模型的工具调用通过对应的特殊工具调用token实现，例如如下图所示，使用<code>&lt;code&gt;……&lt;/code&gt;</code>标记工具调用，<code>&lt;interpreter&gt;……&lt;/interpreter&gt;</code>填充工具调用结果：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8914e743f7cf416c9b694c2f1a5f27fe~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgUeWQjOWtpg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764903620&amp;x-signature=jIPI895kgjTTAdz7b1iJg5Nm1W8%3D" alt="image.png" loading="lazy"/></p>
<p>但使用verl进行Agentic-RL训练时，框架的整体实现基于Sglang样式，输入数据集的格式更像是一种传统的多轮对话风格，只不过新增了一个<code>role</code>为<code>tool</code>的部分。一个典型的数据集格式如下：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1f07bde4eeae4aa6ac5f37b3672545ed~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgUeWQjOWtpg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764903620&amp;x-signature=Xckz36TOHe4NfRU7WxpQmpj6mMs%3D" alt="image.png" loading="lazy"/></p>
<p>所有的工具调用被统一为<code>&lt;tool_call&gt;&lt;/tool_call&gt;</code>，工具响应则变为<code>&lt;tool_response&gt;&lt;/tool_response&gt;</code></p>
<p>基于以上数据集，可以很快完成ReTool的SFT&amp;RL复现。然而，在迁移到领域Agent Model时，这样的数据集格式却带来一个“神奇”的问题。</p>
<h2 data-id="heading-1">问题描述</h2>
<p>领域Agent Model可以调用多种工具，这些工具的基本结构相同，但具体的参数字段却是可以不同的，例如</p>
<pre><code class="hljs language-bash" lang="bash">&lt;tool_call&gt;
{<span class="hljs-string">"name"</span>: <span class="hljs-string">"tool_name_1"</span>, <span class="hljs-string">"argument"</span>: {<span class="hljs-string">"para_name_x"</span>: value_x, <span class="hljs-string">"para_name_y"</span>: value_y}}
&lt;/tool_call&gt;
</code></pre>
<p>另一个工具调用为</p>
<pre><code class="hljs language-bash" lang="bash">&lt;tool_call&gt;
{<span class="hljs-string">"name"</span>: <span class="hljs-string">"tool_name_2"</span>, <span class="hljs-string">"argument"</span>: {<span class="hljs-string">"para_name_p"</span>: value_p, <span class="hljs-string">"para_name_q"</span>: value_q}}
&lt;/tool_call&gt;
</code></pre>
<p>然而，在尝试将这种多轮次“多工具”数据转换成为verl中使用的parquet格式的多轮工具调用数据集时，会发现一个“神奇”的现象，即使用datasets里面的.to_parquet函数时，该函数会自动将所有的工具格式对齐，也就是会发生：</p>
<pre><code class="hljs language-python" lang="python">&lt;tool_call&gt;
{<span class="hljs-string">"name"</span>: <span class="hljs-string">"tool_name_1"</span>, <span class="hljs-string">"argument"</span>: {<span class="hljs-string">"para_name_x"</span>: value_x, <span class="hljs-string">"para_name_y"</span>: value_y, <span class="hljs-string">"para_name_p"</span>: <span class="hljs-literal">None</span>, <span class="hljs-string">"para_name_q"</span>: <span class="hljs-literal">None</span>}}
&lt;/tool_call&gt;
……
&lt;tool_call&gt;
{<span class="hljs-string">"name"</span>: <span class="hljs-string">"tool_name_2"</span>, <span class="hljs-string">"argument"</span>: {<span class="hljs-string">"para_name_x"</span>: <span class="hljs-literal">None</span>, <span class="hljs-string">"para_name_y"</span>: <span class="hljs-literal">None</span>, <span class="hljs-string">"para_name_p"</span>: value_p, <span class="hljs-string">"para_name_q"</span>: value_q}}
&lt;/tool_call&gt;

</code></pre>
<p>即to_parquet函数会自动认为所有的工具参数都包含一个“全集”的字段，导致字段冗余和上下文膨胀，不利于工具传参。</p>
<h2 data-id="heading-2">原因分析</h2>
<p>HuggingFace <code>datasets</code> 的底层存储是Apache Arrow（arrow table），而<code>.to_parquet()</code> 实际是在把 Arrow 的 schema写入 Parquet（列式存储格式），而 Parquet/Arrow 对“结构化数据”的核心要求是：<strong>同一列的 schema 必须稳定且一致。</strong></p>
<p>因此，当在某一列里放的是 <code>dict</code>（嵌套结构），Arrow 会把它推断为一个struct 类型，类似：</p>
<pre><code class="hljs language-text" lang="text">argument: struct&lt;
  para_name_x: ...,
  para_name_y: ...,
  para_name_p: ...,
  para_name_q: ...
&gt;
</code></pre>
<p>一旦它在全数据集中见过 <code>para_name_x / y</code> 和 <code>para_name_p / q</code>，为了保证整列 schema 一致，它就必须把 struct 的字段做“并集（union）”。于是：</p>
<ul>
<li>某条样本没有的字段 → 只能补 <code>null</code></li>
<li>最终写 Parquet 时，schema 固化，字段对齐就不可避免</li>
</ul>
<h2 data-id="heading-3">解决方案</h2>
<p>要避免 Arrow 把 argument 解析成 struct，最直接、稳定的办法就是不要让这一列是 “嵌套 dict” 类型，而是把 argument 存成字符串。</p>
<p>也就是把：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-attr">"argument"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span><span class="hljs-attr">"para_name_x"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"para_name_y"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">2</span><span class="hljs-punctuation">}</span>
</code></pre>
<p>改成：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-attr">"argument"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"{\"para_name_x\": 1, \"para_name_y\": 2}"</span>
</code></pre>
<p>这样 Arrow 看到的就是一个普通的 <code>string</code> 列，自然不会进行 struct schema 对齐，也不会产生“全集字段”。</p>
<h2 data-id="heading-4">参考</h2>
<ol>
<li>ReTool-SFT-multi-turn版本数据集格式，<a href="https://link.juejin.cn?target=https%3A%2F%2Fhuggingface.co%2Fdatasets%2Fswordfaith%2FReTool-SFT-multi-turn" target="_blank" title="https://huggingface.co/datasets/swordfaith/ReTool-SFT-multi-turn" ref="nofollow noopener noreferrer">huggingface.co/datasets/sw…</a></li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[无界微前端：父子应用通信、路由与状态管理最佳实践]]></title>    <link>https://juejin.cn/post/7577332659505840171</link>    <guid>https://juejin.cn/post/7577332659505840171</guid>    <pubDate>2025-11-28T02:51:32.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577332659505840171" data-draft-id="7577242285198655515" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="无界微前端：父子应用通信、路由与状态管理最佳实践"/> <meta itemprop="keywords" content="全栈,架构,前端框架"/> <meta itemprop="datePublished" content="2025-11-28T02:51:32.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="LeonGao"/> <meta itemprop="url" content="https://juejin.cn/user/3976252950591149"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            无界微前端：父子应用通信、路由与状态管理最佳实践
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3976252950591149/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    LeonGao
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-28T02:51:32.000Z" title="Fri Nov 28 2025 02:51:32 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-28
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读22分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body blockquote&gt;:first-child{margin-top:0}.markdown-body blockquote&gt;:last-child{margin-bottom:0}.markdown-body{overflow:hidden;line-height:1.75;font-size:15px;background-image:linear-gradient(90deg,rgba(72,42,10,.05) 5%,rgba(72,42,10,0) 0),linear-gradient(1turn,rgba(72,42,10,.05) 5%,rgba(72,42,10,0) 0);background-size:20px 20px;background-position:50%;padding-top:0!important}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{position:relative;display:flex;border-bottom:5px solid #6d4e00;line-height:35px;letter-spacing:1px;font-size:25px;padding-left:25px;color:#664900;text-shadow:1px 1px 1px #8a6200;padding-bottom:0}.markdown-body h1:before{content:"";display:flex;position:absolute;left:0;top:3px;bottom:0;margin:auto;width:20px;height:20px;background-size:20px 20px;background-image:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMgAAADICAMAAACahl6sAAAAQlBMVEVHcEwlRnqtZBj76q4lRnolRnolRnolRnolRnokRnr/gGtrVUeLXDBKTl+hYSHasW7Ik0zs0JG4dCvUdEE0SW+rYxrLQJfjAAAACnRSTlMA////0H/xUaMi5MCoTwAACfVJREFUeNrtnQl3qygUgJ9GXAqosfL//+pgmgXwXmRNJGdu55xO+6rx8+6I8O9fehmGriN93zdN07bVXdpW/ih/SbpuGP6dXbpOXv7z2i3S9ISck2eQOnAhMHG64VQQbmrAaM4B05GmipaGdB+m6BNQPBXzMYtKR3EPbB/RS5eY4g+lIW9WBqnySCvVMrzRpqqs0g9nwVg5p1KYlHEchRT5bftp+y3n6xlQDjAkABtrKULU9f377ev+4/1/NiT+URRiZRhrcZP6WLa/Gq005BORaqXsdYEuHPIP798ZxSyt6d5sVfxJESRCsvB32lfXwhRjnUBGmKXNoJQe04VIASJqRC/9G7yDsyQMiloYz+0pHYghEoPISAGgpDSvHsCoMwmA0mfjSG5UOsqah2RodkljzMkhZZdamiEDB8+Nsbk9T04yGNljDXGOZZ6u0+Tj9DuvbyNJBuPO0ABtLNPlJtfZJ4CNNCWJoY8gddwxNpm9YrHh9DEkBoeMud4Kma8XRZaYpBJOYvg59U9wOsblMvmGrzQe30dyqFZ1dxPfO0FT5BOdw989THVs4q1TFk+iN4PMu7CaLpd4EJOExNaJLE4d0xQKYpJ0cY5Ozcwwu6WOu2cs9TUYxPB4b4fvLRzTUXbT1HH7y0BnB0j6CAehkPFfFzd1TMsi6sU1/P4VM9NiISHBlYnBMR+kad075sXlmMehj1twnfTUqJH4GJfqIKte7S72emPnHbdiYHIB0e6ATjKq1UoTaFh6wBL2csMIVo9fH/v6QRHAgoxrOHQQxG/36tC1ODmGOeBGBRmXalgcdhDQ1xF1vI6a3DF2d4r7G1enOUgNOshlFq7qUCxrca9ldiCam7ilxRbP6JbOYsYtfLFmkcXEgLG1DN/6eroxHjqh5bh+Uw27e1oWVK7pN+AqwzUcq/UYTPw8nWufLFBHN2zcxLRYlmGPs6rA2Wy0uJe/E7TknbHIa1WH1bLA8DAj3JpxET+FCNCWZ5uNT6jxTPZK/1mXoCBeKlGLRT2lP69XN3XdqqCojKX1ZVda6iD2McjeXSHa0I+AHd2InGAJgjRVM6gOBfygDrarRJnho6eQBbrns+HkcNUCWtYClJa66qFgPbqqZEBTCOAgRqxCOhQBWpZeIC6QBq91hEoI5unTjsMsK9DCFigY9WNn19hgVCrELalrTw6WnYMYzjHhQ2/7G2xTx1HvwpzSe4cVi5ORQQwMW9+72FU5L4gGsa6Yu1RcDeIhs64Qs8izt0vGH+n9/IKaIlYpM2UqkYOrwwq5CgBjWpyGtxaonxe4KaJ3hx+7O0HaqVkxLBPj8FmBVmjNevIUFhUuDmMq5NDV9RwyPe/95IvxAhG7ymqxHGE5sZJL2kPLUhUinkXfrnFwGFwXD99djNLSFh/meXEb2B6Oyiwm0I7BC+OlTlOVPk9K8CIYzu5YHwKDTI6XAo5lz3WEqEXwQRKhh5cyLa6D81P4PXBw984as9YaGXHwx4Ba8rmOldUat/BHt9cQ38AaljnBdCJqs60OcXVDJZP//ZwSWtV9FpHNtgg22KuYx/U2tB5Mcp1TYOiphNhiFjgWeJ3DL2OZpuuUisIoUyzZEJ76I+LmyqWdv8LwnEiwMYczihjxeqtBsuFJSTg2oD1ETQx4v6D1VleSZW1xCwvAfVGWpQ069kgrQksAUW2rReYzsboIjSABuDQX0QJwB9cnZVgWVgE31vrklAJnEmVObykgYCk/VGX5OlpuKb5eiovUAvJ2tMstw0kIkNdpiSA91K6XA6K8CVCyr4PePhTo65q3DyX7OpTbSVk1PB62mhJ9HSpSqtKaESxsFRm0tLBVcvTV+vbBrLRK4hC7aitN9B0ZpX6vNMgjGIt5ZdmMv32KrmprD1afsPd4FEhThK0+WfTl3kpd482AGvG3jQdZK1+t8ireDswhofigRb3fxfI/4jj+xkffUX/1ccxxhEP9qyyBEH9Cx9vhf8TB7eiSpBHjZVSa4whQMJC1TqIR6q8RERtjOr2ID0yx3oYi0oAIvZCPz4eG64p3ObuREeOHUIR3MBVJwq9yll5P7KHdiPBOiOoRa/AjXz21J3k04l+i8OjErj4kaXWQiIVO/EvA+KLRAEnUVomtjPd6SvR3RLoeMT54nKFH1EqtkkEGFaQuTlSQrsxhRiOIt51S/Ho8B11+FUlwRaHnU4utEI38/mgSjRJ8PhWEtN6Z6WcncQOU4efjKoh3zfi7/+DfhPrwOZ9a/iYBiVJJxPlei3CqIDTYEqAPFow5/c71fAdVIwmo4n+cTIGbr2n9NULAE5ifcNNS63hvEOFk0wxYnICBBZ0I9xERBVILF0uggNdxuOkR4S6ngvgPmArzHv4KpMKGQFjQ+Rw6q9dC6R6dgZaJF7RVWIH0BTY9h+fz0ohHOyLuy+He/hN4GUR3/RxcBx2f76izarI9CaXmzRmhNQuSfIgJkva5GzN6HJbhQxCNsDGDSh56plmef6sg2eaXPsYBt5W+H6VE6omG6hOS1w4hiTWiThbJ1YO+RSO1vrpMlomf6nhQGz0m7qT6W04XOUHyzhZ4rkG+0hxL66oDW9mnPWyL3TMmssxyQUwr01CHX7b2OvUIaqS48TnMtAoEQTQixJeAlDfSiGmk/l8jpwIpTyFqOfeNIHWBooC036ERtUQp2tm/CKT5jjySbxTlvUVj2yhjvyWDVL3yfKRojXwLSEWUp7q0PBAKPp7m5YGoT3WH7wAZ1BeOywNZv3Gak/LIqriwxbQ5jaTcsEW1eb+FvoWo+zr5V/IUOvNtsapU2zJXSyj0xVB13sPfq0kkZA7dubIIKXIlJ8Cy7u+BN22RVcr+peOuxHdcBbA04FAVmEoEtO5vX55K4KVZS1QJvBBzU1rgUl8JapBNYIowLoZtD9NWRTWKqqe36L48BSz8QPH9epqqIDehlh2UuqocEmrdV7AvhuRoM74m80yeDIEX3ppreNN235FxV58DNjhswn5K8zK21+5ctjut6NmUIoy9tVvitnHr2VDM3ahtW8KQ/Vbsp9GGiWHfk8skyTSFz9/HdxhHe4uR/RxX/mG1SGXwypcDJNmCMfucZ/C1CuCQUbiBUDYbe7tiRkZX8GIat50d+wqR1fdN7ygGzrHrcN4kGFHK02cil5M6INgQVsvnNz77T5PqUFYJJInYmIBplJfP5On4eiOwYfhuCD44oLyYVs43rI1rk3H7usttzq8Qo3j84vavN9mOkAeuq8dHEd9NtCVKX51Oen+MM6IEYvz5StOehKLpIjD+nKU5AQWJpLizdB+1sb5LQvFRxbSJVGHmSdK/0WWaPguEYmcSJ68aWkK6rAw6jwSSCmrTWVHT96R7HwHANEgqybVJL+E2vE2q7Uu91Gr73SbbNUvZDtiOlCeIv4r/AI+0XUwz1lvcAAAAAElFTkSuQmCC")}.markdown-body h2{position:relative;padding:0 0 0 20px;font-size:20px;font-weight:700;color:#614500}.markdown-body h2:before{content:"";position:absolute;top:3px;bottom:0;left:0;background-image:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMgAAADICAMAAACahl6sAAAAQlBMVEVHcEwlRnqtZBj76q4lRnolRnolRnolRnolRnokRnr/gGtrVUeLXDBKTl+hYSHasW7Ik0zs0JG4dCvUdEE0SW+rYxrLQJfjAAAACnRSTlMA////0H/xUaMi5MCoTwAACfVJREFUeNrtnQl3qygUgJ9GXAqosfL//+pgmgXwXmRNJGdu55xO+6rx8+6I8O9fehmGriN93zdN07bVXdpW/ih/SbpuGP6dXbpOXv7z2i3S9ISck2eQOnAhMHG64VQQbmrAaM4B05GmipaGdB+m6BNQPBXzMYtKR3EPbB/RS5eY4g+lIW9WBqnySCvVMrzRpqqs0g9nwVg5p1KYlHEchRT5bftp+y3n6xlQDjAkABtrKULU9f377ev+4/1/NiT+URRiZRhrcZP6WLa/Gq005BORaqXsdYEuHPIP798ZxSyt6d5sVfxJESRCsvB32lfXwhRjnUBGmKXNoJQe04VIASJqRC/9G7yDsyQMiloYz+0pHYghEoPISAGgpDSvHsCoMwmA0mfjSG5UOsqah2RodkljzMkhZZdamiEDB8+Nsbk9T04yGNljDXGOZZ6u0+Tj9DuvbyNJBuPO0ABtLNPlJtfZJ4CNNCWJoY8gddwxNpm9YrHh9DEkBoeMud4Kma8XRZaYpBJOYvg59U9wOsblMvmGrzQe30dyqFZ1dxPfO0FT5BOdw989THVs4q1TFk+iN4PMu7CaLpd4EJOExNaJLE4d0xQKYpJ0cY5Ozcwwu6WOu2cs9TUYxPB4b4fvLRzTUXbT1HH7y0BnB0j6CAehkPFfFzd1TMsi6sU1/P4VM9NiISHBlYnBMR+kad075sXlmMehj1twnfTUqJH4GJfqIKte7S72emPnHbdiYHIB0e6ATjKq1UoTaFh6wBL2csMIVo9fH/v6QRHAgoxrOHQQxG/36tC1ODmGOeBGBRmXalgcdhDQ1xF1vI6a3DF2d4r7G1enOUgNOshlFq7qUCxrca9ldiCam7ilxRbP6JbOYsYtfLFmkcXEgLG1DN/6eroxHjqh5bh+Uw27e1oWVK7pN+AqwzUcq/UYTPw8nWufLFBHN2zcxLRYlmGPs6rA2Wy0uJe/E7TknbHIa1WH1bLA8DAj3JpxET+FCNCWZ5uNT6jxTPZK/1mXoCBeKlGLRT2lP69XN3XdqqCojKX1ZVda6iD2McjeXSHa0I+AHd2InGAJgjRVM6gOBfygDrarRJnho6eQBbrns+HkcNUCWtYClJa66qFgPbqqZEBTCOAgRqxCOhQBWpZeIC6QBq91hEoI5unTjsMsK9DCFigY9WNn19hgVCrELalrTw6WnYMYzjHhQ2/7G2xTx1HvwpzSe4cVi5ORQQwMW9+72FU5L4gGsa6Yu1RcDeIhs64Qs8izt0vGH+n9/IKaIlYpM2UqkYOrwwq5CgBjWpyGtxaonxe4KaJ3hx+7O0HaqVkxLBPj8FmBVmjNevIUFhUuDmMq5NDV9RwyPe/95IvxAhG7ymqxHGE5sZJL2kPLUhUinkXfrnFwGFwXD99djNLSFh/meXEb2B6Oyiwm0I7BC+OlTlOVPk9K8CIYzu5YHwKDTI6XAo5lz3WEqEXwQRKhh5cyLa6D81P4PXBw984as9YaGXHwx4Ba8rmOldUat/BHt9cQ38AaljnBdCJqs60OcXVDJZP//ZwSWtV9FpHNtgg22KuYx/U2tB5Mcp1TYOiphNhiFjgWeJ3DL2OZpuuUisIoUyzZEJ76I+LmyqWdv8LwnEiwMYczihjxeqtBsuFJSTg2oD1ETQx4v6D1VleSZW1xCwvAfVGWpQ069kgrQksAUW2rReYzsboIjSABuDQX0QJwB9cnZVgWVgE31vrklAJnEmVObykgYCk/VGX5OlpuKb5eiovUAvJ2tMstw0kIkNdpiSA91K6XA6K8CVCyr4PePhTo65q3DyX7OpTbSVk1PB62mhJ9HSpSqtKaESxsFRm0tLBVcvTV+vbBrLRK4hC7aitN9B0ZpX6vNMgjGIt5ZdmMv32KrmprD1afsPd4FEhThK0+WfTl3kpd482AGvG3jQdZK1+t8ireDswhofigRb3fxfI/4jj+xkffUX/1ccxxhEP9qyyBEH9Cx9vhf8TB7eiSpBHjZVSa4whQMJC1TqIR6q8RERtjOr2ID0yx3oYi0oAIvZCPz4eG64p3ObuREeOHUIR3MBVJwq9yll5P7KHdiPBOiOoRa/AjXz21J3k04l+i8OjErj4kaXWQiIVO/EvA+KLRAEnUVomtjPd6SvR3RLoeMT54nKFH1EqtkkEGFaQuTlSQrsxhRiOIt51S/Ho8B11+FUlwRaHnU4utEI38/mgSjRJ8PhWEtN6Z6WcncQOU4efjKoh3zfi7/+DfhPrwOZ9a/iYBiVJJxPlei3CqIDTYEqAPFow5/c71fAdVIwmo4n+cTIGbr2n9NULAE5ifcNNS63hvEOFk0wxYnICBBZ0I9xERBVILF0uggNdxuOkR4S6ngvgPmArzHv4KpMKGQFjQ+Rw6q9dC6R6dgZaJF7RVWIH0BTY9h+fz0ohHOyLuy+He/hN4GUR3/RxcBx2f76izarI9CaXmzRmhNQuSfIgJkva5GzN6HJbhQxCNsDGDSh56plmef6sg2eaXPsYBt5W+H6VE6omG6hOS1w4hiTWiThbJ1YO+RSO1vrpMlomf6nhQGz0m7qT6W04XOUHyzhZ4rkG+0hxL66oDW9mnPWyL3TMmssxyQUwr01CHX7b2OvUIaqS48TnMtAoEQTQixJeAlDfSiGmk/l8jpwIpTyFqOfeNIHWBooC036ERtUQp2tm/CKT5jjySbxTlvUVj2yhjvyWDVL3yfKRojXwLSEWUp7q0PBAKPp7m5YGoT3WH7wAZ1BeOywNZv3Gak/LIqriwxbQ5jaTcsEW1eb+FvoWo+zr5V/IUOvNtsapU2zJXSyj0xVB13sPfq0kkZA7dubIIKXIlJ8Cy7u+BN22RVcr+peOuxHdcBbA04FAVmEoEtO5vX55K4KVZS1QJvBBzU1rgUl8JapBNYIowLoZtD9NWRTWKqqe36L48BSz8QPH9epqqIDehlh2UuqocEmrdV7AvhuRoM74m80yeDIEX3ppreNN235FxV58DNjhswn5K8zK21+5ctjut6NmUIoy9tVvitnHr2VDM3ahtW8KQ/Vbsp9GGiWHfk8skyTSFz9/HdxhHe4uR/RxX/mG1SGXwypcDJNmCMfucZ/C1CuCQUbiBUDYbe7tiRkZX8GIat50d+wqR1fdN7ygGzrHrcN4kGFHK02cil5M6INgQVsvnNz77T5PqUFYJJInYmIBplJfP5On4eiOwYfhuCD44oLyYVs43rI1rk3H7usttzq8Qo3j84vavN9mOkAeuq8dHEd9NtCVKX51Oen+MM6IEYvz5StOehKLpIjD+nKU5AQWJpLizdB+1sb5LQvFRxbSJVGHmSdK/0WWaPguEYmcSJ68aWkK6rAw6jwSSCmrTWVHT96R7HwHANEgqybVJL+E2vE2q7Uu91Gr73SbbNUvZDtiOlCeIv4r/AI+0XUwz1lvcAAAAAElFTkSuQmCC");background-size:100% 100%;background-repeat:no-repeat;width:15px;height:15px;margin:auto}.markdown-body h3{width:100%;text-align:left;margin:20px 10px 0 0;font-size:18px;font-weight:700;display:inline-block;padding-left:10px;padding-bottom:0;border-left:5px solid #8f6600;color:#614500}.markdown-body h4,.markdown-body h5,.markdown-body h6{font-weight:700;color:#a37400}.markdown-body h4{font-size:17px}.markdown-body h5,.markdown-body h6{display:flex;align-items:center}.markdown-body h5:after,.markdown-body h6:after{display:inline-block;border:2px solid #fff6e0;color:rgba(189,134,0,.5);border-radius:50%;text-align:center;margin-left:5px}.markdown-body h5{font-size:14px}.markdown-body h5:after{content:"5";width:15px;height:15px;line-height:15px;font-size:13px}.markdown-body h6{font-size:12px}.markdown-body h6:after{content:"6";width:13px;height:13px;line-height:13px;font-size:12px}.markdown-body p{color:#412c0c;letter-spacing:1px;font-weight:400;margin-bottom:16px}.markdown-body img{max-width:100%;display:block;margin:auto}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{color:#755300;font-weight:400;border-bottom:1px solid #755300;font-weight:bolder;text-decoration:none}.markdown-body table{width:100%!important;margin:0;font-size:12px;width:auto;max-width:100%;overflow:auto;border-collapse:collapse;border-spacing:0}.markdown-body table img{box-shadow:none}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body thead tr th{text-align:center}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px;box-sizing:border-box;border:1px solid rgba(72,42,10,.1)}.markdown-body blockquote{position:relative;text-size-adjust:100%;line-height:25px;font-weight:400;border-radius:10px;font-style:normal;text-align:left;box-sizing:inherit;border:1px solid #ffd87a;background-color:rgba(189,134,0,.5);margin:20px 0;padding:20px}.markdown-body blockquote p{color:#fff6e0;letter-spacing:2px;margin:0}.markdown-body blockquote:after,.markdown-body blockquote:before{position:absolute;color:#cc9100;font-size:34px;font-weight:700}.markdown-body blockquote:before{content:"❝";top:8px;left:5px}.markdown-body blockquote:after{content:"❞";right:5px;bottom:-5px}.markdown-body strong{color:#c28a00;font-weight:bolder}.markdown-body strong:before{content:"「"}.markdown-body strong:after{content:"」"}.markdown-body em{color:#c28a00}.markdown-body em strong{font-style:normal;color:#c28a00;background-color:#8a6200}.markdown-body s{color:#c28a00}.markdown-body hr{border-top:1px solid #805b00}.markdown-body code,.markdown-body li code,.markdown-body p code{color:#996d00;background-color:rgba(130,98,0,.3)}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit;color:#858585;font-family:bold;letter-spacing:1px}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body h1::selection,.markdown-body h2::selection,.markdown-body h3::selection,.markdown-body h4::selection,.markdown-body h5::selection,.markdown-body h6::selection,.markdown-body img::selection{color:rgba(189,134,0,.5);background-color:#fff}.markdown-body a::selection,.markdown-body b::selection,.markdown-body del::selection,.markdown-body em::selection,.markdown-body i::selection,.markdown-body strong::selection{background-color:transparent}.markdown-body pre&gt;code::selection{background-color:rgba(189,134,0,.5)}.markdown-body .math .math-inline::selection,.markdown-body blockquote::selection,.markdown-body ol::selection,.markdown-body p::selection,.markdown-body strong::selection,.markdown-body table::selection,.markdown-body ul::selection{background-color:rgba(189,134,0,.5)}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.kimi.com%2Fpreview%2F19ac857c-c672-8c13-8000-053717bc1206" target="_blank" title="https://www.kimi.com/preview/19ac857c-c672-8c13-8000-053717bc1206" ref="nofollow noopener noreferrer">基于Kimi的HTML知识分享页</a></p>
<h2 data-id="heading-0">1. 通信机制：构建灵活高效的父子应用交互</h2>
<p>在微前端架构中，父子应用之间的通信是确保系统协同运作、数据流畅通的核心环节。无界（Wujie）微前端框架，凭借其基于 <code>iframe</code> 和 <code>WebComponent</code> 的独特设计，为父子应用提供了多种灵活、高效且解耦的通信机制。这些机制不仅解决了传统 <code>iframe</code> 方案中通信困难、DOM隔离严重等问题，还通过去中心化的设计理念，赋予了各个微应用更高的自主性和灵活性 。无界框架的核心通信方式主要包括三种：<strong>Props 注入、Window 共享以及 EventBus 事件总线</strong>。这三种方式各有侧重，适用于不同的业务场景，共同构建了一个立体化的通信网络，使得主应用与子应用之间、乃至子应用相互之间，都能实现精准、高效的数据交换与方法调用，为构建复杂而健壮的微前端系统奠定了坚实的基础。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d2c3b43bb16b4e9d879bf81b918a0879~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTGVvbkdhbw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764903092&amp;x-signature=t3GGMGYETDIfDL3c6SwInZrRBws%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-1">1.1 核心通信方式概览</h3>
<p>无界微前端框架为父子应用间的交互提供了三种核心通信机制，旨在满足不同场景下的通信需求，从直接的数据传递到解耦的事件驱动，构建了一个灵活且强大的通信体系。这些机制的设计充分利用了无界框架的技术特性，如 <code>iframe</code> 的同源策略和 <code>WebComponent</code> 的封装能力，确保了通信的便捷性与安全性 。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6a10bf46325e4aeda062868063a06061~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTGVvbkdhbw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764903092&amp;x-signature=5EuJnJe4hctw6EdKpFQ5%2FZ5roRk%3D" alt="image.png" loading="lazy"/></p>
<h4 data-id="heading-2">1.1.1 Props 注入：父向子的数据与方法传递</h4>
<p>Props 注入机制是无界框架中最直接、最常用的一种父向子通信方式。其设计思想借鉴了现代前端框架（如 Vue、React）中组件间通过 Props 传递数据的理念。主应用在加载子应用时，可以通过 <code>props</code> 属性，将任意类型的数据（包括对象、字符串、数字等）或方法（函数）注入到子应用中。子应用在运行时，可以通过无界提供的全局对象（如 <code>window.$wujie.props</code>）轻松访问这些注入的数据和方法 。这种方式的优势在于其直观性和类型安全性，父应用可以精确控制传递给子应用的数据，子应用也能清晰地定义其所需的数据接口。例如，主应用可以将当前登录用户的信息、全局配置、或者一个用于通知主应用状态变更的回调函数，通过 <code>props</code> 传递给子应用，从而实现对子应用的初始化和行为控制。</p>
<h4 data-id="heading-3">1.1.2 Window 共享：同源环境下的直接通信</h4>
<p>无界框架利用 <code>iframe</code> 作为子应用的 JS 沙箱，并且这个 <code>iframe</code> 与主应用是同源的 。这一设计带来了巨大的通信便利，即父子应用可以直接通过 <code>window</code> 对象进行交互，无需复杂的序列化与反序列化过程。子应用可以通过 <code>window.parent</code> 直接访问主应用的 <code>window</code> 对象，从而读取主应用的全局变量或调用其全局方法。反之，主应用也可以通过获取子应用 <code>iframe</code> 的 <code>contentWindow</code> 对象，来访问子应用内部的全局变量和方法 。这种通信方式几乎是零成本的，性能极高，非常适合需要频繁、快速交换简单数据的场景。例如，主应用可以将一个全局的日志记录函数挂载在 <code>window</code> 上，所有子应用都可以直接调用该函数，实现统一的日志上报。然而，这种方式也存在一定的风险，过度依赖全局变量可能导致命名冲突和代码耦合度增加，因此在使用时需要谨慎规划全局变量的命名空间。</p>
<h4 data-id="heading-4">1.1.3 EventBus：去中心化的事件驱动通信</h4>
<p>为了实现应用间更彻底的解耦，无界框架内置了一个去中心化的事件总线（EventBus） 。这个 EventBus 实例会被注入到主应用和所有子应用中，使得任何一个应用都可以作为事件的发布者或订阅者。应用间不再直接相互调用，而是通过发送和监听事件来进行通信。例如，子应用 A 在完成某个操作后，可以发布一个名为 <code>task-completed</code> 的事件，而关心这个事件的主应用或其他子应用 B、C 只需提前订阅该事件，即可在事件发生时接收到通知并执行相应的逻辑 。这种事件驱动的模式极大地降低了应用间的耦合度，每个应用只需关心自己感兴趣的事件，而无需了解事件是由谁发出的。EventBus 是实现跨应用状态同步、广播通知、以及构建插件化架构的理想选择，它使得微前端系统的扩展性和可维护性得到了显著提升。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/191b2e258763478f966ed27a3a3a2137~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTGVvbkdhbw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764903092&amp;x-signature=V3mEJ91Pdr%2FPWqgI2Fvspozn%2FT0%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-5">1.2 通信方式详解与最佳实践</h3>
<p>无界微前端框架提供的三种核心通信机制——Props 注入、Window 共享和 EventBus，各自拥有独特的实现方式和适用场景。深入理解其内部工作原理和最佳实践，对于构建高效、稳定、可维护的微前端系统至关重要。本章节将对每种通信方式进行详细解析，并结合实际代码示例，阐述其在不同业务场景下的应用策略和注意事项，旨在为开发者提供一套完整的通信解决方案指南。</p>
<h4 data-id="heading-6">1.2.1 Props 注入机制</h4>
<p>Props 注入机制是无界框架中实现父向子通信最直接、最推荐的方式之一。它借鉴了现代前端框架的组件化思想，通过声明式的方式将数据和方法从主应用传递到子应用，保证了通信的清晰性和可控性。这种方式不仅易于理解和使用，而且在类型安全和代码可维护性方面表现出色，是实现父子应用间初始化数据传递和回调函数注入的首选方案。</p>
<h5 data-id="heading-7">1.2.1.1 主应用配置与数据注入</h5>
<p>在主应用中，使用无界组件（如 <code>&lt;WujieVue&gt;</code> 或 <code>&lt;WujieReact&gt;</code>）加载子应用时，可以通过 <code>props</code> 属性来注入数据和方法。这个 <code>props</code> 对象可以包含任意类型的数据，例如字符串、对象、数组，甚至是函数。主应用可以将需要共享给子应用的全局状态、配置信息、或者需要子应用触发的回调函数，统一封装在这个 <code>props</code> 对象中。例如，在一个 Vue 主应用中，可以这样配置子应用 ：</p>
<pre><code class="hljs language-vue" lang="vue">&lt;template&gt;
  &lt;WujieVue
    name="micro-app"
    url="http://localhost:8080"
    :props="{
      userInfo: currentUser,
      theme: 'dark',
      onTaskComplete: handleTaskComplete
    }"
  /&gt;
&lt;/template&gt;

&lt;script&gt;
import WujieVue from 'wujie-vue3';

export default {
  components: { WujieVue },
  data() {
    return {
      currentUser: { id: 123, name: 'Alice' }
    };
  },
  methods: {
    handleTaskComplete(taskData) {
      console.log('子应用任务完成:', taskData);
      // 主应用可以在这里更新状态或执行其他逻辑
    }
  }
}
&lt;/script&gt;
</code></pre>
<p>在这个例子中，主应用向名为 <code>micro-app</code> 的子应用注入了 <code>userInfo</code>、<code>theme</code> 两个数据项，以及一个名为 <code>onTaskComplete</code> 的回调函数。这种方式使得主应用对传递给子应用的数据拥有完全的控制权，并且子应用的接口也一目了然。</p>
<h5 data-id="heading-8">1.2.1.2 子应用接收与调用</h5>
<p>子应用在启动后，可以通过无界注入的全局对象 <code>window.$wujie</code> 来访问主应用传递的 <code>props</code>。具体来说，可以通过 <code>window.$wujie.props</code> 获取到整个 <code>props</code> 对象，然后像访问普通 JavaScript 对象的属性一样，读取数据或调用方法 。例如，在子应用中，可以这样使用主应用注入的数据和方法：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 在子应用的某个组件或逻辑中</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-title function_">mounted</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// 获取注入的用户信息</span>
    <span class="hljs-keyword">const</span> userInfo = <span class="hljs-variable language_">window</span>.<span class="hljs-property">$wujie</span>?.<span class="hljs-property">props</span>?.<span class="hljs-property">userInfo</span>;
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'当前用户:'</span>, userInfo);

    <span class="hljs-comment">// 获取注入的主题配置</span>
    <span class="hljs-keyword">const</span> theme = <span class="hljs-variable language_">window</span>.<span class="hljs-property">$wujie</span>?.<span class="hljs-property">props</span>?.<span class="hljs-property">theme</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">applyTheme</span>(theme);
  },
  <span class="hljs-attr">methods</span>: {
    <span class="hljs-title function_">completeTask</span>(<span class="hljs-params"/>) {
      <span class="hljs-comment">// 任务完成后，调用主应用注入的回调函数</span>
      <span class="hljs-keyword">const</span> taskData = { <span class="hljs-attr">id</span>: <span class="hljs-number">456</span>, <span class="hljs-attr">status</span>: <span class="hljs-string">'completed'</span> };
      <span class="hljs-variable language_">window</span>.<span class="hljs-property">$wujie</span>?.<span class="hljs-property">props</span>?.<span class="hljs-title function_">onTaskComplete</span>(taskData);
    },
    <span class="hljs-title function_">applyTheme</span>(<span class="hljs-params">theme</span>) {
      <span class="hljs-comment">// 根据主题配置更新 UI</span>
      <span class="hljs-variable language_">document</span>.<span class="hljs-property">body</span>.<span class="hljs-property">className</span> = <span class="hljs-string">`theme-<span class="hljs-subst">${theme}</span>`</span>;
    }
  }
}
</code></pre>
<p>通过这种方式，子应用可以清晰地知道哪些数据是由父应用提供的，并且可以通过调用注入的方法，将内部发生的事件或状态变更通知给主应用，实现了父子应用间的双向交互。</p>
<h5 data-id="heading-9">1.2.1.3 适用场景：初始化数据、回调函数传递</h5>
<p>Props 注入机制特别适用于以下几种场景：</p>
<ol>
<li><strong>初始化数据传递</strong>：当子应用加载时，需要一些初始数据才能正确渲染，例如用户信息、权限配置、应用主题等。通过 <code>props</code> 传递这些数据，可以确保子应用在启动时就拥有所需的一切，避免了额外的异步请求和状态同步的复杂性。</li>
<li><strong>回调函数传递</strong>：主应用可以向子应用传递回调函数，允许子应用在特定事件发生时（如用户点击按钮、表单提交、任务完成等）主动调用这些函数，从而将信息传递回主应用。这是一种非常灵活的反向通信方式，相比于子应用直接操作主应用的 <code>window</code> 对象，这种方式的耦合度更低，逻辑更清晰。</li>
<li><strong>配置化驱动</strong>：主应用可以根据不同的业务场景或用户角色，动态地向子应用传递不同的配置，从而控制子应用的行为和展示。例如，一个报表子应用，主应用可以通过 <code>props</code> 传递不同的报表 ID 和查询参数，使其展示不同的数据内容。</li>
</ol>
<p>总而言之，Props 注入机制以其清晰、安全、易维护的特点，成为无界微前端中父子通信的首选方案之一，尤其适用于需要父应用对子应用进行初始化和行为控制的场景。</p>
<h4 data-id="heading-10">1.2.2 Window 共享机制</h4>
<p>无界框架巧妙地利用了 <code>iframe</code> 的同源策略，为父子应用提供了一种近乎原生的、高性能的通信方式——Window 共享。由于承载子应用的 <code>iframe</code> 与主应用处于同一个源（Same-Origin）下，它们之间可以直接通过 <code>window</code> 对象进行交互，无需借助 <code>postMessage</code> 等跨域通信手段，从而避免了数据序列化和反序列化的开销，实现了真正的“无界”通信 。这种机制虽然强大且便捷，但也需要开发者谨慎使用，以避免全局命名空间的污染和代码的过度耦合。</p>
<h5 data-id="heading-11">1.2.2.1 主应用访问子应用全局变量</h5>
<p>主应用可以通过获取子应用 <code>iframe</code> 的 <code>contentWindow</code> 对象，来直接访问和操作子应用内部的全局变量和方法。无界框架为每个子应用的 <code>iframe</code> 设置了唯一的 <code>name</code> 属性，主应用可以通过这个 <code>name</code> 来定位到特定的 <code>iframe</code>，进而访问其 <code>contentWindow</code> 。例如：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 在主应用中</span>
<span class="hljs-comment">// 假设子应用的 name 属性被设置为 'micro-app-1'</span>
<span class="hljs-keyword">const</span> microAppIframe = <span class="hljs-variable language_">window</span>.<span class="hljs-property">document</span>.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">'iframe[name=micro-app-1]'</span>);
<span class="hljs-keyword">if</span> (microAppIframe) {
  <span class="hljs-keyword">const</span> microAppWindow = microAppIframe.<span class="hljs-property">contentWindow</span>;
  
  <span class="hljs-comment">// 访问子应用的全局变量</span>
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'子应用的全局变量:'</span>, microAppWindow.<span class="hljs-property">someGlobalVariable</span>);
  
  <span class="hljs-comment">// 调用子应用的全局方法</span>
  microAppWindow.<span class="hljs-title function_">someGlobalMethod</span>(<span class="hljs-string">'来自主应用的数据'</span>);
}
</code></pre>
<p>这种方式使得主应用能够主动、直接地获取子应用的内部状态或触发其行为，适用于主应用需要监控或管理子应用特定行为的场景。然而，过度依赖这种直接访问会破坏子应用的封装性，增加主应用与子应用之间的耦合度，因此应谨慎使用。</p>
<h5 data-id="heading-12">1.2.2.2 子应用访问主应用全局变量</h5>
<p>与主应用访问子应用类似，子应用也可以通过 <code>window.parent</code> 对象直接访问主应用的 <code>window</code> 对象，从而读取主应用的全局变量或调用其全局方法 。这种方式在子应用中实现起来非常简单直接：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 在子应用中</span>
<span class="hljs-comment">// 访问主应用的全局变量</span>
<span class="hljs-keyword">const</span> mainAppGlobalData = <span class="hljs-variable language_">window</span>.<span class="hljs-property">parent</span>.<span class="hljs-property">someGlobalData</span>;
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'主应用的全局数据:'</span>, mainAppGlobalData);

<span class="hljs-comment">// 调用主应用的全局方法</span>
<span class="hljs-variable language_">window</span>.<span class="hljs-property">parent</span>.<span class="hljs-title function_">someGlobalFunction</span>(<span class="hljs-string">'来自子应用的数据'</span>);
</code></pre>
<p>这种通信方式的性能极高，因为它仅仅是内存中的对象引用访问。它非常适合子应用需要获取主应用的共享服务（如全局的日志服务、配置服务、用户认证服务等）的场景。例如，主应用可以将一个统一的 <code>axios</code> 实例或一个全局的事件总线挂载在 <code>window</code> 上，所有子应用都可以直接复用这些实例，避免了重复创建和资源浪费。</p>
<h5 data-id="heading-13">1.2.2.3 适用场景：简单数据共享与快速调试</h5>
<p>Window 共享机制虽然强大，但其“全局性”也带来了潜在的风险。因此，它最适用于以下场景：</p>
<ol>
<li><strong>简单数据共享</strong>：当需要在父子应用间共享一些简单的、不经常变化的全局常量或配置时，使用 <code>window</code> 共享是一种高效的选择。例如，共享应用的版本号、环境标识等。</li>
<li><strong>共享工具函数/服务</strong>：主应用可以将一些通用的工具函数、API 请求库、或全局状态管理实例（如一个全局的 EventBus）挂载在 <code>window</code> 上，供所有子应用复用。这有助于减少代码冗余，保持工具库版本的一致性。</li>
<li><strong>快速调试</strong>：在开发和调试阶段，通过 <code>window</code> 对象直接访问和修改父子应用的状态，可以快速定位和解决问题。例如，在浏览器的开发者工具中，可以直接在控制台通过 <code>window.parent</code> 或 <code>iframe.contentWindow</code> 来操作应用，极大地提高了调试效率。</li>
<li><strong>遗留系统集成</strong>：对于一些无法或不便进行大规模改造的遗留系统，如果它们已经依赖了某些全局变量，通过 <code>window</code> 共享机制可以方便地将这些系统集成到微前端架构中，而无需修改其内部代码。</li>
</ol>
<p><strong>最佳实践与注意事项</strong>：</p>
<ul>
<li><strong>命名空间管理</strong>：为了避免全局变量名冲突，强烈建议为所有共享在 <code>window</code> 上的变量和方法定义一个统一的、具有辨识度的命名空间，例如 <code>window.MyMicroFrontendGlobal</code>。</li>
<li><strong>最小化共享</strong>：只共享那些真正需要全局访问的、稳定的数据或服务。避免将业务逻辑相关的、频繁变化的状态放在 <code>window</code> 上。</li>
<li><strong>文档化</strong>：清晰地记录哪些变量和方法被共享在 <code>window</code> 上，以及它们的用途和使用方式，这对于团队协作和系统维护至关重要。</li>
</ul>
<p>总之，Window 共享机制是一把双刃剑。在享受其带来的高性能和便捷性的同时，必须清醒地认识到其潜在的风险，并通过良好的工程实践来规避这些问题，使其成为微前端通信体系中的有力补充。</p>
<h4 data-id="heading-14">1.2.3 EventBus 机制</h4>
<p>EventBus（事件总线）是无界微前端框架中实现应用间解耦通信的核心机制。它采用发布-订阅（Publish-Subscribe）模式，提供了一个去中心化的通信渠道，使得主应用和各个子应用都可以作为独立的事件发布者或监听者 。通过 EventBus，应用之间不再需要进行直接的函数调用或对象引用，而是通过发送和监听事件来进行协作。这种松耦合的通信方式极大地提升了微前端系统的灵活性和可扩展性，是实现跨应用状态同步、广播通知和构建插件化架构的理想选择。</p>
<h5 data-id="heading-15">1.2.3.1 主应用事件监听与触发</h5>
<p>无界框架会将一个 EventBus 实例注入到主应用中，主应用可以通过引入该实例来进行事件的监听和触发。例如，在使用 <code>wujie-vue</code> 的主应用中，可以这样操作 ：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 在主应用中 (例如 main.js 或某个组件中)</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">WujieVue</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'wujie-vue'</span>;
<span class="hljs-keyword">const</span> { bus } = <span class="hljs-title class_">WujieVue</span>;

<span class="hljs-comment">// 监听一个事件</span>
bus.$on(<span class="hljs-string">'user-logged-in'</span>, <span class="hljs-function">(<span class="hljs-params">userData</span>) =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'主应用收到用户登录事件:'</span>, userData);
  <span class="hljs-comment">// 主应用可以在这里更新全局状态，或者通知其他子应用</span>
});

<span class="hljs-comment">// 触发一个事件</span>
bus.$emit(<span class="hljs-string">'global-theme-changed'</span>, <span class="hljs-string">'dark'</span>);
</code></pre>
<p>主应用可以利用 EventBus 来广播全局事件，例如主题切换、语言变更、用户登录/登出等。所有关心这些事件的子应用只需监听相应的事件名，即可在事件发生时做出响应，而无需关心事件是由谁发出的。</p>
<h5 data-id="heading-16">1.2.3.2 子应用事件监听与触发</h5>
<p>同样地，无界也会将 EventBus 实例注入到每个子应用中。子应用可以通过 <code>window.$wujie.bus</code> 来访问这个实例，并进行事件的监听和触发 ：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 在子应用中</span>
<span class="hljs-comment">// 监听主应用或其他子应用发出的事件</span>
<span class="hljs-variable language_">window</span>.<span class="hljs-property">$wujie</span>?.<span class="hljs-property">bus</span>.$on(<span class="hljs-string">'global-theme-changed'</span>, <span class="hljs-function">(<span class="hljs-params">theme</span>) =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'子应用收到主题变更事件:'</span>, theme);
  <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">applyTheme</span>(theme);
});

<span class="hljs-comment">// 子应用向主应用或其他子应用发送事件</span>
<span class="hljs-variable language_">window</span>.<span class="hljs-property">$wujie</span>?.<span class="hljs-property">bus</span>.$emit(<span class="hljs-string">'user-logged-in'</span>, { <span class="hljs-attr">userId</span>: <span class="hljs-number">123</span>, <span class="hljs-attr">username</span>: <span class="hljs-string">'Alice'</span> });

<span class="hljs-comment">// 在组件销毁时，记得取消事件监听，以避免内存泄漏</span>
<span class="hljs-comment">// beforeDestroy() {</span>
<span class="hljs-comment">//   window.$wujie?.bus.$off('global-theme-changed');</span>
<span class="hljs-comment">// }</span>
</code></pre>
<p>通过 EventBus，子应用可以主动将自己的状态变更或发生的事件通知给系统中的其他部分。例如，一个用户管理子应用可以在用户创建成功后，发布一个 <code>user-created</code> 事件，而一个负责发送欢迎邮件的子应用可以监听这个事件，并在收到通知后执行发送邮件的逻辑。这种解耦的协作方式，使得各个微应用可以独立开发和部署，而不会相互影响。</p>
<h5 data-id="heading-17">1.2.3.3 适用场景：跨应用状态同步、解耦业务逻辑</h5>
<p>EventBus 机制在以下场景中表现出色：</p>
<ol>
<li><strong>跨应用状态同步</strong>：当多个应用需要共享某个状态（如用户登录状态、全局主题、应用配置等）时，可以通过 EventBus 来广播状态的变更。任何一个应用修改了该状态，都会发布一个相应的事件，其他应用监听该事件并更新自己的本地状态，从而实现状态的最终一致性。</li>
<li><strong>解耦业务逻辑</strong>：在复杂的业务流程中，一个操作可能会触发多个后续动作。使用 EventBus，可以将这些动作的执行者（子应用）与触发者（主应用或其他子应用）解耦。触发者只需发布一个事件，而无需关心后续有哪些动作需要执行，以及由谁来执行。</li>
<li><strong>构建插件化架构</strong>：EventBus 是实现插件化架构的理想工具。主应用可以定义一套标准的事件接口，插件（子应用）可以通过监听这些事件来介入主应用的生命周期或业务流程，也可以通过发布事件来向主应用提供功能。</li>
<li><strong>广播通知</strong>：当需要向所有或部分应用发送通知时（例如，系统即将维护，需要所有用户保存当前工作），可以通过 EventBus 广播一个通知事件，所有在线的应用都能收到并做出相应提示。</li>
</ol>
<p><strong>最佳实践与注意事项</strong>：</p>
<ul>
<li><strong>事件命名规范</strong>：为了避免事件名冲突，建议采用带有命名空间的、语义化的事件名，例如 <code>app-name:event-name</code>。</li>
<li><strong>事件负载（Payload）</strong> ：事件传递的数据（负载）应尽量保持简洁，只包含必要的信息。避免传递大型对象或复杂的结构，以减少性能开销。</li>
<li><strong>内存管理</strong>：在子应用中，尤其是在组件化的框架（如 Vue、React）中，务必在组件卸载时（如 <code>beforeDestroy</code> 或 <code>useEffect</code> 的 cleanup 函数中）取消事件监听，以防止内存泄漏。</li>
<li><strong>文档化</strong>：维护一份清晰的事件文档，列出所有可用的事件名、其触发时机、以及负载的数据结构，这对于团队协作和系统集成至关重要。</li>
</ul>
<p>综上所述，EventBus 机制通过其强大的解耦能力，为无界微前端系统提供了一种灵活、可扩展的通信方式，是实现复杂微前端应用不可或缺的核心工具。</p>
<h3 data-id="heading-18">1.3 通信模式选型与高级实践</h3>
<p>在掌握了无界微前端提供的三种核心通信机制（Props 注入、Window 共享、EventBus）之后，如何根据具体的业务场景进行合理的选型，并遵循最佳实践来构建健壮、高效的通信体系，是微前端架构成功的关键。本章节将对这三种通信方式进行深入的对比分析，并提供关于通信安全性、性能优化以及故障处理的高级实践指南，旨在帮助开发者做出明智的技术决策，并规避潜在的陷阱。</p>
<h4 data-id="heading-19">1.3.1 通信方式对比与选择</h4>
<p>为了更直观地比较三种通信方式的特性，下表从多个维度进行了总结：</p>





















































<table><thead><tr><th align="left">特性维度</th><th align="left">Props 注入</th><th align="left">Window 共享</th><th align="left">EventBus</th></tr></thead><tbody><tr><td align="left"><strong>通信方向</strong></td><td align="left">父 -&gt; 子（单向数据流，但可通过回调函数实现反向通知）</td><td align="left">父 &lt;-&gt; 子（双向）</td><td align="left">多对多（完全解耦）</td></tr><tr><td align="left"><strong>耦合度</strong></td><td align="left">低（父应用明确知道子应用的接口）</td><td align="left">高（直接依赖全局变量）</td><td align="left">极低（发布-订阅模式）</td></tr><tr><td align="left"><strong>性能</strong></td><td align="left">高（初始化时注入，无运行时开销）</td><td align="left">极高（直接内存访问）</td><td align="left">中等（事件分发有轻微开销）</td></tr><tr><td align="left"><strong>数据类型</strong></td><td align="left">任意（包括函数）</td><td align="left">任意（需可序列化，函数共享需谨慎）</td><td align="left">任意（事件负载）</td></tr><tr><td align="left"><strong>适用场景</strong></td><td align="left">初始化数据、配置传递、回调函数注入</td><td align="left">简单数据共享、共享工具库、快速调试</td><td align="left">跨应用状态同步、解耦业务逻辑、广播通知</td></tr><tr><td align="left"><strong>安全性</strong></td><td align="left">高（接口明确，易于控制）</td><td align="left">低（全局命名空间污染风险）</td><td align="left">中等（需规范事件命名）</td></tr><tr><td align="left"><strong>可维护性</strong></td><td align="left">高（接口清晰，易于追踪）</td><td align="left">低（全局变量难以追踪）</td><td align="left">中等（需维护事件文档）</td></tr></tbody></table>
<p><strong>选型建议</strong>：</p>
<ul>
<li><strong>优先使用 Props 注入</strong>：对于父应用向子应用传递初始化数据、配置或回调函数的场景，应首选 Props 注入。它提供了清晰的接口定义，易于测试和维护，是实现父子通信最规范、最安全的方式。</li>
<li><strong>谨慎使用 Window 共享</strong>：Window 共享的性能最高，但风险也最大。它应仅用于共享那些真正全局的、稳定不变的数据或服务，如全局配置、工具库实例等。在使用时，必须通过严格的命名空间管理来避免冲突。</li>
<li><strong>广泛使用 EventBus</strong>：对于应用间的解耦通信、状态同步和广播通知，EventBus 是最佳选择。它使得应用间的协作变得异常灵活，是构建大型、可扩展微前端系统的核心。但需要注意事件的命名规范和内存管理问题。</li>
</ul>
<p>在实际项目中，这三种通信方式往往是结合使用的。例如，主应用在加载子应用时，通过 <code>Props</code> 注入一个全局的 <code>EventBus</code> 实例和一个共享的 <code>axios</code> 实例（通过 <code>Window</code> 共享），子应用则主要使用 <code>EventBus</code> 与其他应用进行交互。</p>
<h4 data-id="heading-20">1.3.2 通信安全性与性能优化</h4>
<p><strong>通信安全性</strong>：</p>
<ul>
<li><strong>数据校验</strong>：无论通过何种方式接收数据，子应用都应进行必要的数据校验，确保接收到的数据格式和类型符合预期，防止因恶意数据或数据格式错误导致的应用崩溃。</li>
<li><strong>最小权限原则</strong>：主应用传递给子应用的数据和方法应遵循最小权限原则，只提供子应用所必需的最小数据集和功能，避免暴露敏感信息或不必要的内部实现。</li>
<li><strong>避免直接执行字符串代码</strong>：绝对不要通过 <code>Window</code> 共享或 <code>EventBus</code> 传递并执行字符串形式的代码，这会引发严重的安全漏洞（如 XSS 攻击）。</li>
<li><strong>HTTPS</strong>：确保主应用和所有子应用都通过 HTTPS 提供服务，以防止通信数据在传输过程中被窃听或篡改。</li>
</ul>
<p><strong>性能优化</strong>：</p>
<ul>
<li><strong>Props 优化</strong>：避免在 <code>props</code> 中传递大型对象或频繁变化的数据。如果必须传递，可以考虑使用 <code>computed</code> 属性或 <code>watch</code> 来优化更新逻辑。</li>
<li><strong>Window 共享优化</strong>：共享在 <code>window</code> 上的对象应尽量是单例或不可变对象，避免频繁修改。对于大型工具库，可以考虑使用动态导入（<code>import()</code>）按需加载，而不是全部挂载在 <code>window</code> 上。</li>
<li><strong>EventBus 优化</strong>：
<ul>
<li><strong>事件节流/防抖</strong>：对于高频触发的事件（如窗口滚动、鼠标移动），应在发布端进行节流（throttle）或防抖（debounce）处理，减少事件分发的次数。</li>
<li><strong>事件负载精简</strong>：事件负载应尽量小，只包含必要的数据。</li>
<li><strong>避免内存泄漏</strong>：如前所述，务必在组件卸载时取消事件监听。</li>
</ul>
</li>
<li><strong>预加载</strong>：无界框架支持子应用的预加载 。对于用户可能会访问到的子应用，可以在主应用空闲时提前加载其静态资源，从而缩短用户首次打开子应用的时间，提升用户体验。</li>
</ul>
<h4 data-id="heading-21">1.3.3 通信故障处理与恢复策略</h4>
<p>在复杂的微前端系统中，通信故障是不可避免的。例如，子应用加载失败、网络中断、或者应用崩溃等情况都可能导致通信中断。因此，建立一套完善的故障处理与恢复机制至关重要。</p>
<ul>
<li><strong>子应用加载失败</strong>：主应用在加载子应用时，应提供 <code>onError</code> 或类似的错误处理钩子。当子应用加载失败时，可以捕获错误并向用户展示友好的错误提示，或者提供一个降级方案（如跳转到备用页面）。</li>
<li><strong>通信超时</strong>：对于通过 <code>EventBus</code> 触发的异步操作，应设置超时机制。如果在规定时间内没有收到响应，应视为通信失败，并进行相应的错误处理。</li>
<li><strong>状态一致性保证</strong>：当通信中断或应用重启后，可能会出现状态不一致的问题。为了解决这个问题，可以采用以下策略：
<ul>
<li><strong>状态持久化</strong>：将关键的全局状态（如用户登录信息）持久化到 <code>localStorage</code> 或 <code>sessionStorage</code> 中。应用启动时，先从持久化存储中恢复状态。</li>
<li><strong>状态同步机制</strong>：在应用重新连接或加载后，主动进行一次状态同步。例如，主应用可以向所有子应用广播一个 <code>request-state-sync</code> 事件，子应用在收到事件后，将自己的关键状态通过 <code>EventBus</code> 发送回来，主应用据此更新全局状态。</li>
<li><strong>幂等性设计</strong>：确保通过 <code>EventBus</code> 触发的操作是幂等的，即多次执行同一操作，结果与执行一次相同。这可以避免因网络重试或重复事件导致的状态错误。</li>
</ul>
</li>
<li><strong>日志与监控</strong>：建立完善的日志和监控体系，记录所有关键的通信事件和错误。当通信故障发生时，可以通过日志快速定位问题根源。同时，通过监控告警，可以在故障发生时第一时间通知开发人员。</li>
</ul>
<p>通过以上高级实践，开发者可以构建一个不仅功能强大，而且安全、高效、健壮的微前端通信系统，为整个应用的稳定运行提供坚实的保障。</p>
<h2 data-id="heading-22">2. 路由管理：打造无缝的导航体验</h2>
<p>在微前端架构中，路由管理是构建用户无缝导航体验的核心挑战之一。传统的单页应用（SPA）路由管理相对简单，但在微前端场景下，主应用和多个子应用各自拥有独立的路由系统，如何协调它们之间的关系，确保路由状态的正确同步、浏览器前进后退按钮的正常工作，以及在不同应用间实现流畅跳转，成为了一个复杂的技术难题。无界（Wujie）微前端框架通过其创新的路由同步机制，巧妙地解决了这些问题，为开发者提供了一套强大而简洁的路由管理方案 。</p>
<h3 data-id="heading-23">2.1 无界路由同步机制解析</h3>
<p>无界框架的路由管理核心在于其独特的路由同步机制。该机制旨在解决微前端架构中一个普遍存在的痛点：子应用的路由状态在浏览器刷新、前进后退或分享链接时容易丢失的问题。通过将子应用的路由信息巧妙地与主应用的 URL 进行绑定，无界确保了子应用的路由状态可以被浏览器历史记录正确地保存和恢复，从而为用户提供了与单页应用无异的导航体验。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e00e1d3fc6bb419589fdac88b83fc0b3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTGVvbkdhbw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764903092&amp;x-signature=XuAGY4rFc5iA03YEGgCCjYd7JzY%3D" alt="image.png" loading="lazy"/></p>
<h4 data-id="heading-24">2.1.1 子应用路由状态丢失问题</h4>
<p>在传统的 <code>iframe</code> 微前端方案中，子应用的路由系统完全运行在 <code>iframe</code> 内部，与主应用的路由是相互隔离的。这会导致一系列问题：</p>
<ul>
<li><strong>浏览器刷新</strong>：当用户在子应用的某个页面（例如 <code>/sub-app/product/123</code>）刷新浏览器时，浏览器只会加载主应用的 URL（例如 <code>https://main-app.com/sub-app</code>），而 <code>iframe</code> 的 <code>src</code> 属性通常会恢复到初始值（例如 <code>https://sub-app.com</code>），导致用户丢失当前的页面状态，被重定向到子应用的首页。</li>
<li><strong>前进后退</strong>：浏览器的前进后退按钮操作的是浏览器顶层的历史记录（<code>window.history</code>），而子应用内部的路由变化（如 <code>history.pushState</code>）只会修改 <code>iframe</code> 内部的历史记录。因此，当用户点击前进后退按钮时，无法正确地导航到子应用的历史页面。</li>
<li><strong>链接分享</strong>：当用户试图分享一个在子应用内部的页面链接时，分享的 URL 只是主应用的 URL，接收者打开链接后无法看到分享者当时所在的子应用页面。</li>
</ul>
<p>这些问题严重破坏了用户体验，使得基于 <code>iframe</code> 的微前端方案在实际应用中备受诟病。</p>
<h4 data-id="heading-25">2.1.2 无界路由同步原理</h4>
<p>无界框架通过劫持 <code>iframe</code> 内部的 <code>history.pushState</code> 和 <code>history.replaceState</code> 方法，巧妙地解决了上述问题 。其核心原理如下：</p>
<ol>
<li><strong>劫持路由变化</strong>：当子应用内部进行路由跳转，调用 <code>history.pushState</code> 或 <code>history.replaceState</code> 时，无界框架的劫持逻辑会被触发。</li>
<li><strong>同步到主应用 URL</strong>：劫持逻辑会将子应用当前的 <code>location.pathname</code> 和 <code>location.search</code>（即路由路径和查询参数）进行 <code>URL encoding</code>（编码），然后将其作为查询参数附加到主应用的 URL 上。例如，如果子应用的路由变为 <code>/product/123?color=red</code>，主应用的 URL 可能会被更新为 <code>https://main-app.com/sub-app?sub-app-name=%2Fproduct%2F123%3Fcolor%3Dred</code>。其中 <code>sub-app-name</code> 是子应用的唯一标识。</li>
<li><strong>浏览器历史记录</strong>：由于主应用的 URL 发生了变化，这次变化会被浏览器记录到顶层的历史记录中。因此，浏览器的前进后退按钮现在可以正确地作用于子应用的路由历史。</li>
<li><strong>状态恢复</strong>：当用户刷新浏览器或从外部访问带有同步路由信息的 URL 时，无界框架会在初始化子应用 <code>iframe</code> 时，从主应用 URL 的查询参数中解析出子应用的路由信息，然后使用 <code>iframe</code> 的 <code>history.replaceState</code> 将子应用的路由恢复到之前的状态。</li>
</ol>
<p>通过这套机制，无界实现了子应用路由状态与浏览器历史记录的完全同步，解决了刷新、前进后退和链接分享等核心痛点 。此外，无界还支持多应用同时激活时的路由同步，并且提供了短路径配置能力，以应对子应用 URL 过长的问题 。</p>
<h3 data-id="heading-26">2.2 父子应用路由协同策略</h3>
<p>在理解了无界的路由同步原理后，下一步是如何在实践中协同管理父子应用的路由。一个清晰的路由协同策略是确保整个微前端系统导航逻辑正确、用户体验流畅的关键。这通常涉及到主应用的统一路由管理、子应用的内部路由自治，以及两者之间的联动与跳转机制。</p>
<h4 data-id="heading-27">2.2.1 主应用统一路由管理</h4>
<p>在微前端架构中，主应用通常扮演着“路由网关”的角色。它负责管理整个系统的顶层路由，并根据路由规则来决定加载哪个子应用。主应用的路由配置通常会定义一个通配符或参数化的路径，用于匹配所有子应用的路由。例如，在 Vue Router 中，可以这样配置：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 主应用的路由配置</span>
<span class="hljs-keyword">const</span> routes = [
  {
    <span class="hljs-attr">path</span>: <span class="hljs-string">'/'</span>,
    <span class="hljs-attr">component</span>: <span class="hljs-title class_">MainLayout</span>,
    <span class="hljs-attr">children</span>: [
      <span class="hljs-comment">// 其他主应用自身的路由...</span>
      {
        <span class="hljs-comment">// 匹配所有以 /sub-app 开头的路径</span>
        <span class="hljs-attr">path</span>: <span class="hljs-string">'/sub-app/:pathMatch(.*)*'</span>,
        <span class="hljs-attr">name</span>: <span class="hljs-string">'SubAppContainer'</span>,
        <span class="hljs-attr">component</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-keyword">import</span>(<span class="hljs-string">'./views/SubAppContainer.vue'</span>),
      },
    ],
  },
];
</code></pre>
<p>在 <code>SubAppContainer.vue</code> 组件中，会根据当前的路由信息（如 <code>params.path</code>）来动态加载对应的子应用。主应用还负责将路由跳转函数（如 <code>this.$router.push</code>）通过 <code>props</code> 传递给子应用，以便子应用能够发起跨应用的导航 。</p>
<h4 data-id="heading-28">2.2.2 子应用内部路由自治</h4>
<p>子应用在微前端架构中应保持其内部路由的完整性和自治性。这意味着子应用应该像独立开发时一样，使用自己的路由库（如 Vue Router, React Router）来管理其内部的页面跳转和状态。无界框架的设计保证了子应用的路由系统可以无侵入地、完整地运行在 <code>iframe</code> 沙箱中，无需任何特殊改造 。子应用内部的 <code>&lt;router-link&gt;</code> 或编程式导航（<code>router.push</code>）都可以正常工作，并且其路由变化会被无界的路由同步机制捕获并同步到主应用。</p>
<h4 data-id="heading-29">2.2.3 父子路由联动与跳转</h4>
<p>实现父子应用间的路由联动和跳转是路由协同的核心。最常见的场景是：用户在子应用 A 的某个页面，希望跳转到子应用 B 的某个特定页面。实现这种跳转通常有以下几种方式：</p>
<ol>
<li>
<p><strong>主应用提供跳转方法</strong>：主应用将一个统一的跳转方法（如 <code>jump</code>）通过 <code>props</code> 注入到所有子应用中。当子应用需要跨应用跳转时，调用这个注入的方法，并将目标路由信息作为参数传递 。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 主应用注入跳转方法</span>
&lt;<span class="hljs-title class_">WujieVue</span> 
  name=<span class="hljs-string">"sub-app-a"</span> 
  url=<span class="hljs-string">"http://localhost:8080"</span> 
  :props=<span class="hljs-string">"{ jump: this.handleCrossAppJump }"</span> 
/&gt;

<span class="hljs-comment">// 主应用中的跳转方法</span>
<span class="hljs-attr">methods</span>: {
  <span class="hljs-title function_">handleCrossAppJump</span>(<span class="hljs-params">location</span>) {
    <span class="hljs-comment">// location 可以是 { path: '/sub-app-b/product/123' }</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">$router</span>.<span class="hljs-title function_">push</span>(location);
  }
}

<span class="hljs-comment">// 子应用 A 中调用跳转</span>
<span class="hljs-attr">methods</span>: {
  <span class="hljs-title function_">goToProduct</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">window</span>.<span class="hljs-property">$wujie</span>?.<span class="hljs-property">props</span>.<span class="hljs-title function_">jump</span>({ <span class="hljs-attr">path</span>: <span class="hljs-string">'/sub-app-b/product/123'</span> });
  }
}
</code></pre>
</li>
<li>
<p><strong>使用 EventBus 进行通信</strong>：当子应用需要跳转到另一个子应用时，可以发布一个特定的事件（如 <code>navigate-to</code>），并将目标路由信息作为事件负载。主应用或其他负责路由管理的模块监听这个事件，并执行实际的跳转逻辑 。这种方式的解耦程度更高。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 子应用 A 发布跳转事件</span>
<span class="hljs-variable language_">window</span>.<span class="hljs-property">$wujie</span>?.<span class="hljs-property">bus</span>.$emit(<span class="hljs-string">'navigate-to'</span>, { <span class="hljs-attr">path</span>: <span class="hljs-string">'/sub-app-b/product/123'</span> });

<span class="hljs-comment">// 主应用监听跳转事件并执行跳转</span>
bus.$on(<span class="hljs-string">'navigate-to'</span>, <span class="hljs-function">(<span class="hljs-params">location</span>) =&gt;</span> {
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">$router</span>.<span class="hljs-title function_">push</span>(location.<span class="hljs-property">path</span>);
});
</code></pre>
</li>
<li>
<p><strong>直接操作主应用路由</strong>：在子应用中，也可以通过 <code>window.parent</code> 直接访问主应用的路由实例进行跳转，例如 <code>window.parent.$router.push('/sub-app-b/product/123')</code>。但这种方式耦合度较高，不推荐在复杂场景下使用。</p>
</li>
</ol>
<p>通过上述策略，可以构建一个既统一又灵活的微前端路由管理体系，为用户提供无缝、连贯的导航体验。</p>
<h3 data-id="heading-30">2.3 高级路由场景实践</h3>
<p>在掌握了基本的路由协同策略后，我们还需要应对一些更复杂的高级路由场景，例如子应用保活模式下的路由处理、多应用同时激活时的路由同步，以及路由嵌套与冲突的解决。这些场景对路由管理的灵活性和健壮性提出了更高的要求。</p>
<h4 data-id="heading-31">2.3.1 子应用保活模式下的路由处理</h4>
<p>无界框架提供了强大的子应用保活（<code>alive: true</code>）模式，类似于 Vue 的 <code>keep-alive</code> 。在保活模式下，当用户从子应用 A 切换到子应用 B 时，子应用 A 的 <code>iframe</code> 和 DOM 结构会被保留在内存中，其内部的状态（包括路由状态）不会丢失。当用户再次切换回子应用 A 时，可以瞬间恢复，无需重新加载和渲染。</p>
<p>然而，保活模式也带来了新的路由挑战。由于子应用的路由状态被保留，如果主应用的路由发生变化（例如，用户通过浏览器地址栏直接修改了 URL），子应用的路由不会自动同步更新。为了解决这个问题，必须采用通信机制来显式地通知子应用进行路由跳转 。</p>
<p><strong>最佳实践</strong>：</p>
<ol>
<li><strong>主应用监听路由变化</strong>：主应用需要监听自身的路由变化。</li>
<li><strong>通过 EventBus 通知子应用</strong>：当主应用的路由变化涉及到某个保活的子应用时，主应用应通过 <code>EventBus</code> 向该子应用发送一个路由变更事件，并将新的路由路径作为事件负载。</li>
<li><strong>子应用接收并跳转</strong>：保活的子应用监听这个事件，并在收到通知后，使用自己的路由系统（如 <code>router.push</code>）跳转到对应的路径。</li>
</ol>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 主应用监听路由变化</span>
<span class="hljs-attr">watch</span>: {
  <span class="hljs-string">'$route.params.path'</span>: {
    <span class="hljs-title function_">handler</span>(<span class="hljs-params">newPath</span>) {
      <span class="hljs-comment">// 假设当前激活的是保活的子应用 'sub-app-a'</span>
      wujieVue.<span class="hljs-property">bus</span>.$emit(<span class="hljs-string">'sub-app-a-route-change'</span>, <span class="hljs-string">`/<span class="hljs-subst">${newPath}</span>`</span>);
    },
    <span class="hljs-attr">immediate</span>: <span class="hljs-literal">true</span>,
  },
},

<span class="hljs-comment">// 子应用 'sub-app-a' 监听并跳转</span>
<span class="hljs-title function_">mounted</span>(<span class="hljs-params"/>) {
  <span class="hljs-variable language_">window</span>.<span class="hljs-property">$wujie</span>?.<span class="hljs-property">bus</span>.$on(<span class="hljs-string">'sub-app-a-route-change'</span>, <span class="hljs-function">(<span class="hljs-params">path</span>) =&gt;</span> {
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">$router</span>.<span class="hljs-property">currentRoute</span>.<span class="hljs-property">path</span> !== path) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">$router</span>.<span class="hljs-title function_">push</span>(path);
    }
  });
}
</code></pre>
<p>这种方式确保了即使在保活模式下，父子应用的路由也能保持同步。</p>
<h4 data-id="heading-32">2.3.2 多应用激活时的路由同步</h4>
<p>无界框架支持在一个页面中同时激活多个子应用，并且能保持这些子应用的路由同步 。这在一些复杂的仪表板或门户页面中非常有用。实现这一功能的关键在于无界的路由同步机制本身就支持多应用。当页面上存在多个子应用时，每个子应用的路由变化都会被编码并附加到主应用的 URL 上，使用不同的 <code>key</code>（即子应用的 <code>name</code>）进行区分。</p>
<p>例如，主应用的 URL 可能看起来像这样：
<code>https://main-app.com/dashboard?app-a=%2Fchart%2Fpie&amp;app-b=%2Ftable%2Fuser-list</code></p>
<p>在这个 URL 中，<code>app-a</code> 和 <code>app-b</code> 分别代表两个子应用的路由状态。当用户刷新页面时，无界框架会解析这个 URL，并同时恢复两个子应用的路由。开发者无需进行额外的编码，即可享受到多应用路由同步带来的便利。</p>
<h4 data-id="heading-33">2.3.3 路由嵌套与冲突解决</h4>
<p>在微前端系统中，路由嵌套和冲突是常见的问题。例如，主应用有一个路径为 <code>/user</code> 的路由，而某个子应用内部也有一个 <code>/user</code> 的路由。当用户访问 <code>/user</code> 时，系统应该加载主应用的页面还是子应用的页面？</p>
<p><strong>解决策略</strong>：</p>
<ol>
<li><strong>主应用路由优先</strong>：通常，主应用的路由应该具有更高的优先级。主应用的路由配置应该放在子应用通配符路由之前。这样，当 URL 同时匹配主应用和子应用的路由时，会优先匹配主应用的路由。</li>
<li><strong>明确的路由前缀</strong>：为每个子应用分配一个唯一的、不会与主应用或其他子应用冲突的路由前缀。例如，所有与用户管理相关的子应用功能都放在 <code>/user-mgt/</code> 路径下，而主应用的用户中心则使用 <code>/user-center/</code>。这是一种通过设计来避免冲突的有效方法。</li>
<li><strong>动态路由匹配</strong>：在主应用的路由守卫（<code>beforeEach</code>）中，可以进行更复杂的逻辑判断。例如，根据用户的权限或当前的系统状态，动态地决定将某个路径路由到主应用还是子应用。</li>
</ol>
<p>通过合理的路由设计和配置，可以有效地解决路由嵌套和冲突问题，确保整个微前端系统的路由逻辑清晰、稳定。</p>
<h2 data-id="heading-34">3. 状态管理：实现跨应用的状态共享与隔离</h2>
<p>在微前端架构中，状态管理是一个核心且复杂的议题。与单体应用不同，微前端系统由多个独立开发、部署和运行的微应用（包括主应用和多个子应用）组成。每个微应用理论上都应该拥有自己的、与其他应用隔离的运行时状态，以保证其独立性和可维护性 。然而，在实际业务中，总有一些状态是需要在多个应用之间共享的，例如当前登录用户的信息、全局的主题设置、应用级别的权限控制等。如何在保证应用间状态隔离的同时，优雅地实现必要的状态共享，是无界微前端框架在状态管理方面需要解决的关键问题。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4d022e7e2a964204ac3230225d9464d9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTGVvbkdhbw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764903092&amp;x-signature=l5CIQTycFuscbaCa%2FfGAy9EIfTw%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-35">3.1 无界状态管理哲学</h3>
<p>无界微前端框架在状态管理上遵循一套清晰的设计哲学，这套哲学旨在平衡微应用的独立性与系统整体的协同性。它强调“独立运行时”和“状态隔离”作为基本原则，同时通过灵活的通信机制来满足“状态共享”的实际需求。</p>
<h4 data-id="heading-36">3.1.1 独立运行时与状态隔离</h4>
<p>无界框架的核心理念之一是“独立运行时”，即每个微应用在运行时都应该是相互隔离的，拥有自己独立的 JS 执行环境（通过 <code>iframe</code> 沙箱实现）和独立的运行时状态 。这意味着，一个子应用的状态变更，默认情况下不应该直接影响到其他应用。这种设计带来了诸多好处：</p>
<ul>
<li><strong>技术栈无关</strong>：每个子应用可以自由选择自己的技术栈（如 Vue, React, Angular）和状态管理库（如 Vuex, Redux, MobX），而无需考虑与其他应用的兼容性问题。</li>
<li><strong>独立开发与部署</strong>：由于状态是隔离的，各个团队可以独立地开发、测试和部署自己的微应用，而不会相互干扰，大大提高了开发效率和迭代速度。</li>
<li><strong>故障隔离</strong>：一个子应用的状态管理出现 bug 或崩溃，其影响范围被限制在该应用内部，不会扩散到整个系统，从而提高了整个微前端系统的健壮性和稳定性。</li>
</ul>
<p>这种“状态隔离”的哲学，从根本上避免了微应用之间因状态耦合而可能引发的“牵一发而动全身”的混乱局面，是实现真正微服务化前端的关键。</p>
<h4 data-id="heading-37">3.1.2 状态共享的必要性与挑战</h4>
<p>尽管状态隔离是基本原则，但在一个完整的业务系统中，完全的状态隔离是不现实的。总有一些“全局状态”或“跨应用状态”需要在多个微应用之间共享和同步。例如：</p>
<ul>
<li><strong>用户认证状态</strong>：用户的登录信息、token、权限角色等，是几乎所有应用都需要访问的。</li>
<li><strong>全局配置</strong>：如 UI 主题（亮色/暗色）、语言偏好、应用布局设置等。</li>
<li><strong>跨应用业务流程</strong>：一个业务流程可能跨越多个子应用，需要共享一些流程相关的中间状态。</li>
</ul>
<p>实现这些状态的共享面临着诸多挑战：</p>
<ul>
<li><strong>耦合度</strong>：如何在共享状态的同时，尽可能地降低应用间的耦合度？</li>
<li><strong>数据一致性</strong>：如何保证共享状态在多个应用中的副本能够保持一致？</li>
<li><strong>性能</strong>：状态同步机制是否会引入额外的性能开销？</li>
<li><strong>调试复杂性</strong>：当共享状态出现问题时，如何快速定位和调试？</li>
</ul>
<p>无界框架通过其灵活的通信机制（Props、Window、EventBus）来应对这些挑战，提供了一套行之有效的跨应用状态共享方案。</p>
<h3 data-id="heading-38">3.2 跨应用状态共享方案</h3>
<p>基于无界框架提供的通信机制，开发者可以构建多种跨应用状态共享方案。这些方案各有侧重，适用于不同的场景，共同构成了无界微前端的状态管理体系。</p>
<h4 data-id="heading-39">3.2.1 基于 EventBus 的状态同步</h4>
<p>这是无界微前端中最常用、最推荐的跨应用状态共享方案。它利用 EventBus 的发布-订阅机制，实现了状态的解耦同步。其核心思想是：将状态变更视为一种“事件”，当某个应用（状态所有者）修改了共享状态时，它会发布一个相应的事件，并将新的状态值作为事件负载。其他需要关心这个状态的应用（状态消费者）则监听这个事件，并在收到通知后，更新自己的本地状态副本 。</p>
<p><strong>实现步骤</strong>：</p>
<ol>
<li><strong>定义状态契约</strong>：首先，需要为每个共享状态定义一个清晰的事件名和数据结构（即“状态契约”）。例如，用户登录状态的事件名可以定义为 <code>global:user:login</code>，其负载为 <code>{ userId: number, username: string, token: string }</code>。</li>
<li><strong>状态所有者发布事件</strong>：当状态发生变化时（例如，用户登录成功），负责用户认证的应用（可能是主应用或一个专门的认证子应用）会通过 <code>EventBus</code> 发布事件。
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 在用户认证成功后</span>
<span class="hljs-variable language_">window</span>.<span class="hljs-property">$wujie</span>?.<span class="hljs-property">bus</span>.$emit(<span class="hljs-string">'global:user:login'</span>, { 
  <span class="hljs-attr">userId</span>: <span class="hljs-number">123</span>, 
  <span class="hljs-attr">username</span>: <span class="hljs-string">'Alice'</span>, 
  <span class="hljs-attr">token</span>: <span class="hljs-string">'abc123...'</span> 
});
</code></pre>
</li>
<li><strong>状态消费者监听事件</strong>：所有需要访问用户信息的子应用，在初始化时都会监听这个事件。
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 在子应用的初始化逻辑中</span>
<span class="hljs-variable language_">window</span>.<span class="hljs-property">$wujie</span>?.<span class="hljs-property">bus</span>.$on(<span class="hljs-string">'global:user:login'</span>, <span class="hljs-function">(<span class="hljs-params">userData</span>) =&gt;</span> {
  <span class="hljs-comment">// 将接收到的用户数据存储到子应用自己的状态管理库中</span>
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">$store</span>.<span class="hljs-title function_">commit</span>(<span class="hljs-string">'setUser'</span>, userData);
});
</code></pre>
</li>
</ol>
<p>这种方式的优点是解耦、灵活且易于扩展。新增一个需要共享状态的应用，只需让它监听相应的事件即可，无需修改其他应用的代码。</p>
<h4 data-id="heading-40">3.2.2 构建统一的全局状态仓库</h4>
<p>对于状态共享需求非常复杂的系统，可以考虑在主应用中构建一个统一的全局状态仓库（Global State Store）。这个仓库负责管理所有需要跨应用共享的状态，并提供统一的接口（如 <code>getState</code>, <code>setState</code>）供其他应用访问。</p>
<p><strong>实现方式</strong>：</p>
<ol>
<li><strong>主应用创建仓库</strong>：主应用创建一个全局的状态管理对象，并将其挂载在 <code>window</code> 上，或者通过 <code>props</code> 注入到所有子应用中。
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 在主应用中</span>
<span class="hljs-variable language_">window</span>.<span class="hljs-property">GlobalState</span> = {
  <span class="hljs-attr">state</span>: {
    <span class="hljs-attr">user</span>: <span class="hljs-literal">null</span>,
    <span class="hljs-attr">theme</span>: <span class="hljs-string">'light'</span>,
  },
  <span class="hljs-title function_">setState</span>(<span class="hljs-params">key, value</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span>[key] = value;
    <span class="hljs-comment">// 状态变更后，通过 EventBus 通知所有子应用</span>
    bus.$emit(<span class="hljs-string">`global:state:change:<span class="hljs-subst">${key}</span>`</span>, value);
  },
  <span class="hljs-title function_">getState</span>(<span class="hljs-params">key</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span>[key];
  }
};
</code></pre>
</li>
<li><strong>子应用访问仓库</strong>：子应用可以通过 <code>window.GlobalState</code> 直接读取状态，或通过调用 <code>setState</code> 方法来修改状态。状态的变更同样通过 <code>EventBus</code> 广播出去，以保证所有应用的状态副本同步更新。</li>
</ol>
<p>这种方式的优点是状态管理集中化，便于统一控制和调试。但缺点是会增加主应用的复杂性，并且如果设计不当，可能会成为系统的性能瓶颈。</p>
<h4 data-id="heading-41">3.2.3 状态流转与同步机制</h4>
<p>无论采用哪种共享方案，都需要关注状态的流转与同步机制。</p>
<ul>
<li><strong>单向数据流</strong>：推荐采用类似 Flux 的单向数据流模式。状态变更只能由“状态所有者”发起，其他应用只能被动接收通知并更新本地副本，不能直接修改共享状态。这有助于保证状态变更的可预测性和可追踪性。</li>
<li><strong>状态版本控制</strong>：对于复杂的共享状态，可以引入版本号或时间戳。当状态变更时，版本号递增。状态消费者在更新本地副本时，可以检查版本号，以避免处理过期的状态更新。</li>
<li><strong>状态持久化</strong>：对于需要持久化的共享状态（如用户偏好设置），可以在状态变更时，将其同步到 <code>localStorage</code> 或发送到后端服务器。应用启动时，再从持久化存储中恢复状态。</li>
</ul>
<h3 data-id="heading-42">3.3 状态管理最佳实践</h3>
<p>为了构建一个健壮、可维护的跨应用状态管理体系，开发者应遵循以下最佳实践：</p>
<h4 data-id="heading-43">3.3.1 状态契约与接口定义</h4>
<ul>
<li><strong>文档化</strong>：为所有共享状态及其对应的事件创建一份详细的文档，明确事件名、负载的数据结构、触发时机和使用场景。</li>
<li><strong>类型安全</strong>：如果使用 TypeScript，应为共享状态定义清晰的接口（Interface）或类型（Type），并在发布和监听事件时使用这些类型，以获得编译时的类型检查和代码提示。</li>
<li><strong>命名规范</strong>：采用统一的、带有命名空间的事件命名规范，如 <code>domain:entity:action</code>（例如 <code>user:profile:update</code>），以避免命名冲突。</li>
</ul>
<h4 data-id="heading-44">3.3.2 状态变更的追踪与调试</h4>
<ul>
<li><strong>日志记录</strong>：在状态所有者发布事件和状态消费者接收事件的地方，添加详细的日志记录，包括事件名、负载数据和发生时间。这有助于在出现问题时进行追踪和调试。</li>
<li><strong>开发工具</strong>：可以利用一些状态管理开发工具（如 Redux DevTools）的插件，或者自行开发一个简单的调试面板，来可视化地展示全局状态的变化历史和当前快照。</li>
<li><strong>错误处理</strong>：在状态同步的逻辑中，添加完善的错误处理机制。例如，当接收到格式错误的状态数据时，应记录错误日志，并使用一个默认值或回退逻辑，避免应用崩溃。</li>
</ul>
<h4 data-id="heading-45">3.3.3 状态持久化与恢复</h4>
<ul>
<li><strong>选择性持久化</strong>：并非所有状态都需要持久化。只对那些用户希望跨会话保留的状态（如登录信息、主题偏好）进行持久化。</li>
<li><strong>序列化与反序列化</strong>：在将状态存入 <code>localStorage</code> 或从其中读取时，需要进行正确的序列化和反序列化。对于复杂对象，可以使用 <code>JSON.stringify</code> 和 <code>JSON.parse</code>。</li>
<li><strong>版本控制</strong>：当共享状态的数据结构发生变更时（例如，新增了一个字段），需要考虑版本兼容性问题。可以在持久化的数据中包含一个版本号，在恢复状态时，根据版本号进行相应的数据迁移或转换。</li>
</ul>
<p>通过遵循这些最佳实践，开发者可以在无界微前端框架下，构建一个既灵活又健壮的跨应用状态管理系统，为复杂业务场景的实现提供坚实的支撑。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/591acd70566f4c4ab71f397808b881d1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTGVvbkdhbw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764903092&amp;x-signature=gJVvZqiHPWL%2F8lmsvEoQLW%2BLIfQ%3D" alt="image.png" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[上海证券 SelectDB 升级实践：湖仓流批一体落地与 Elasticsearch 全面替换]]></title>    <link>https://juejin.cn/post/7577298871004217378</link>    <guid>https://juejin.cn/post/7577298871004217378</guid>    <pubDate>2025-11-28T03:22:21.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577298871004217378" data-draft-id="7577294037717270562" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="上海证券 SelectDB 升级实践：湖仓流批一体落地与 Elasticsearch 全面替换"/> <meta itemprop="keywords" content="Apache,数据库"/> <meta itemprop="datePublished" content="2025-11-28T03:22:21.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="SelectDB"/> <meta itemprop="url" content="https://juejin.cn/user/3189021726222904"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            上海证券 SelectDB 升级实践：湖仓流批一体落地与 Elasticsearch 全面替换
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3189021726222904/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    SelectDB
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-28T03:22:21.000Z" title="Fri Nov 28 2025 03:22:21 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-28
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>导读</p>
<p>上海证券引入 SelectDB 作为核心实时分析引擎，有效弥补了实时数据处理与分析的能力短板，实现湖仓一体与流批一体，同时替换了原架构中的 Elasticsearch 组件。达成了写入性能提升 4 倍，支撑 1000+ QPS 高并发访问，关键决策响应速度 200 ms，开发效率提升 50%，运维成本大幅降低的关键收益。</p>
</blockquote>
<h2 data-id="heading-0">业务背景</h2>
<p>上海证券成立于 2001 年 5 月，秉承“开放、包容、规范、协同”的核心理念，致力于成为“特色鲜明、区域领先、品牌知名”具有专业特色的财富管理型券商。近年来，上海证券资产规模持续扩大，经营实力不断增强，取得了显著的社会效益和经济效益。</p>
<p>与此同时，数据基础设施的建设也需进一步深化，以应对持续增长的业务规模带来的挑战。上海证券原先基于 Hadoop 体系建设数据平台，面临着三重挑战：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/40bf655073fd4675ac826992b9f94492~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2VsZWN0REI=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764904941&amp;x-signature=1S%2BpnWCkh1KLgyM9%2BEYwzR2Bo%2BQ%3D" alt="上海证券_doris_业务背景.PNG" loading="lazy"/></p>
<ul>
<li>
<p><strong>架构孤岛化：</strong> 当前架构为烟囱式数据架构，存在多套独立的数据采集、调度工具，协同效率低下。</p>
</li>
<li>
<p><strong>标准体系缺失：</strong> 缺乏统一数据标准规范，全流程质量管控依赖技术部门强驱动。</p>
</li>
<li>
<p><strong>服务能力断层：</strong> 缺少“水到田头”的数据服务，业务部门无法自助快速获取数据，决策响应延迟较长。</p>
</li>
</ul>
<p>为应对上述挑战，上海证券计划构建全栈信创数据中台，以同时满足以下三方面核心需求：</p>
<ul>
<li>
<p><strong>技术需求</strong>：全面升级数据平台基础设施，实现国产化与技术自主掌控，打造集数据治理、开发、分析、应用于一体的一站式平台。原有架构中，缺少实时数据处理与分析能力，需要引入相关产品，实现湖仓一体与流批一体能力，突破实时分析瓶颈。</p>
</li>
<li>
<p><strong>业务需求：</strong> 全面支撑实时与离线计算、结构化与非结构化数据分析，赋能公司各业务线数字化转型。</p>
</li>
<li>
<p><strong>效率与成本需求：</strong> 全面整合公司数据资源，有效降低总体数据成本，显著提升数据开发效率。通过选择适配的产品组合，以最优路径完成数据中台的构建。</p>
</li>
</ul>
<h2 data-id="heading-1">基于 SelectDB 的数据中台方案</h2>
<p>面对上述需求，上海证券于 2024 年 2 月正式完成基于 SelectDB 的数据中台基础搭建，10 月实现全量业务迁移，目前处于深度应用期。</p>
<h3 data-id="heading-2">01 整体架构方案</h3>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ce53783ef23545c383b4862f42b3d1a0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2VsZWN0REI=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764904941&amp;x-signature=sc%2BxN2iWt4a%2BKFHJU6Nha1%2BEX60%3D" alt="基于 SelectDB 的数据中台方案.PNG" loading="lazy"/></p>
<p>为平衡成本与效率，上海证券在基础架构设计中保留了大部分现有 Hadoop 组件，引入 <strong>SelectDB 作为核心实时分析引擎的同时，替换了 Elasticsearch。SelectDB 的引入有效弥补了原架构中实时数据处理与分析的能力短板，成为上海证券实现湖仓一体与流批一体的关键技术支撑。</strong></p>
<ul>
<li>
<p><strong>全面支持 Hadoop 生态，实现湖仓一体：</strong> SelectDB 能够无缝对接并高效访问上海证券现有 Hadoop 体系中的 HDFS 存储和 Hive 元数据，最大程度地复用已有数据资产。同时 SelectDB 提供高性能实时分析能力，统一支撑上海证券结构化与非结构化数据的分析需求。</p>
</li>
<li>
<p><strong>构建数据治理、开发、服务一体化平台：</strong> 上海证券基于 SelectDB 构建的新平台整合了数据治理规范、统一开发流程和自助数据服务能力，解决了原有架构标准缺失、流程割裂的问题，实现了从数据入湖到业务应用的全生命周期一体化管理。</p>
</li>
<li>
<p><strong>通过统一数据开发平台，实现流批一体：</strong> 利用 SelectDB 强大的实时写入与批量处理能力，实现了流式数据和批量数据的统一加工、存储与分析，成功突破了原有架构的实时分析瓶颈，赋能业务快速决策。</p>
</li>
<li>
<p><strong>全栈国产化兼容：</strong> SelectDB 在核心引擎、周边生态及部署环境上实现了全面国产化兼容，满足了证券公司对数据平台基础设施国产化与技术自主掌控的关键需求，保障了系统安全可控。</p>
</li>
<li>
<p><strong>服务团队支持力度高，运维有保障：</strong> SelectDB 背后专业服务团队的高效响应和有力支持，为上海证券在平台建设、迁移上线和后期运维的全过程提供了可靠保障，有效降低技术风险，确保平台稳定运行。</p>
</li>
</ul>
<h3 data-id="heading-3">02 DataOps 开发治理一体化</h3>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/942c823dc6ba40d69099453d37152856~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2VsZWN0REI=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764904941&amp;x-signature=CDj8hBNbutom2p1vj8NgW%2BluwUM%3D" alt="02 DataOps 开发治理一体化.PNG" loading="lazy"/></p>
<p>上海证券以“先设计，后开发；先标准，后建模”为核心原则，结合全信创数据中台，构建数据全生命周期闭环管理体系（图片来源于网络）：</p>
<ul>
<li><strong>设计阶段：</strong> 通过统一数据标准、与业务对齐的指标设计及健壮模型设计，从源头保障数据规范性与质量。</li>
<li><strong>开发阶段：</strong> 依托 SelectDB 高效计算能力，无缝集成数据传输、离线开发与自助分析任务，支撑流批一体数据处理。</li>
<li><strong>测试及上线阶段：</strong> 通过严格的数据测试、质量监控及任务发布流程，结合 SelectDB 的实时监控能力，确保数据可靠入湖并持续稳定运行。</li>
</ul>
<p>上海证券始终保障数据合规，形成了“设计-开发-测试-监控”的一体化治理体系，基于 SelectDB 彻底解决了原有架构标准缺失、流程割裂的问题，赋能业务自助获取高质量数据。</p>
<h3 data-id="heading-4">03 统一数据交换链路</h3>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7c1320ec892f4bb98a140cdcb982b809~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2VsZWN0REI=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764904941&amp;x-signature=yPWHIsbXeuzxLvVrmCl%2BH7Laqxw%3D" alt="03 统一数据交换链路.png" loading="lazy"/></p>
<p>上海证券通过构建统一数据交换平台，打通了公司级数据流转链路。 平台集中管理实时与离线数据服务，并实施统一安全管控，将分散的行情（万得/聚源）、交易（非现/快速）、账户等中台数据与下游业务系统（指 E 通全微服务、CRM、反洗钱等 20+ 模块）高效连接。<strong>尤其是对于实时场景，基于 SelectDB Routine Load 能力便捷接入 Kafka 数据，其高并发数据更新吞吐可达到百万行每秒，为行情推送、机构服务等提供了秒级延迟的数据服务能力。</strong></p>
<h2 data-id="heading-5">应用场景</h2>
<h3 data-id="heading-6">01 金融实时交易战报</h3>
<p>2024 年 9 月 底，证券市场行情迅猛爆发，上海证券新增能够秒级获取全量交易、行情、新客开户数及资金引入等数据的需求。基于 SelectDB 的极速性能，上海证券相关团队在 10 月前开发并上线了实时交易战报系统，业务数据秒级实时接入，<strong>系统稳定支撑 1000+ QPS 高并发查询，复杂聚合查询响应延迟低至 200ms</strong>，实现了对全量经营指标的实时决策支持，验证了 SelectDB 在突发业务场景下的高性能与高可靠性，为金融行业实时数仓建设提供了关键支撑。</p>
<h3 data-id="heading-7">02 金融 CRM 系统建设——替换 Elasticsearch</h3>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b6670a58c7d441f9bea56f5112891bea~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2VsZWN0REI=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764904941&amp;x-signature=K698FVF2Ip09oh6q%2B3w%2FbEmBuls%3D" alt="02 金融 CRM 系统建设——替换 Elasticsearch.png" loading="lazy"/></p>
<p>上海证券在其金融 CRM 活动关系及实时战报模块原先采用 Elasticsearch 组件，因其存在两大核心缺陷：</p>
<ul>
<li><strong>数据同步延迟高：</strong> ES 批量数据同步延迟高达分钟级，客户行为数据无法实时更新，导致决策滞后。</li>
<li><strong>运维成本高昂：</strong> ES 架构复杂，需独立维护协调节点、数据节点、主节点，集群维护困难，故障排查耗时长，导致运维成本高昂。</li>
</ul>
<p>为此，上海证券进行了系统升级，在开户结果分析中引入了 SelectDB，并在活动关系及实时战报模块中使用 SelectDB 替换原 Elasticsearch 组件，作为实时分析引擎，实现流批一体架构。SelectDB 的写入吞吐能力是 Elasticsearch 的 4 倍，有效解决了数据同步延迟高的痛点。升级后，系统能够直接消费 Kafka 客户行为流，将数据同步时效压缩至秒级。同时，借助 SelectDB 倒排索引能力及丰富的运维生态，复杂查询响应速度提升了 2 倍，整体运维成本大幅降低。</p>
<p>SelectDB 的引入使得上海证券金融 CRM 系统实现了秒级实时闭环，系统能够实时获取客户开户流程中的断点情况，通过持续分析客户操作流，精准识别如资料提交中断等关键断点事件，并实时生成 MOT 任务，推送至客户经理移动端。这使得客户经理能够及时触达客户，引导续接开户流程，将断点问题解决时效提升至分钟级别。</p>
<h2 data-id="heading-8">应用收益</h2>
<p>上海证券通过引入 SelectDB 构建数据平台，有效解决了原 Hadoop 与 Elasticsearch 架构的关键瓶颈，在性能、成本等方面实现显著突破：</p>
<ul>
<li>
<p><strong>突破实时分析瓶颈，分析效率跃升：</strong> 基于 SelectDB 直接消费 Kafka 客户行为流，写入性能提升 4 倍，数据同步延迟压缩至秒级，解决 Elasticsearch 同步效率低导致的决策滞后问题。借助 SelectDB 倒排索引能力及复杂聚合查询能力，支撑 1000+ QPS 高并发访问，关键决策响应延迟低至 200 ms，响应效率翻倍；</p>
</li>
<li>
<p><strong>湖仓 &amp; 流批一体架构，有效降低成本：</strong> 基于 SelectDB 的数据平台可直接访问 HDFS/Hive 数据，实现湖仓一体，复用现有存储资源，降低迁移成本。此外，SelectDB 精简的架构设计和丰富的运维生态，可同时处理流式与批量数据，避免多套系统协作开销，大幅简化集群管理，数据开发效率提升 50%，运维成本大幅降低。</p>
</li>
</ul>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2F8ihYdOVQ0knOq1zCpXp8NA" target="_blank" title="https://mp.weixin.qq.com/s/8ihYdOVQ0knOq1zCpXp8NA" ref="nofollow noopener noreferrer">参考文档：网易数帆,DataOps全球峰会 | 网易数帆特色实践护航数据价值落地</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Cursor Tab 共享无限车]]></title>    <link>https://juejin.cn/post/7577321767346241582</link>    <guid>https://juejin.cn/post/7577321767346241582</guid>    <pubDate>2025-11-28T03:26:44.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577321767346241582" data-draft-id="7577321767346208814" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Cursor Tab 共享无限车"/> <meta itemprop="keywords" content="LLM"/> <meta itemprop="datePublished" content="2025-11-28T03:26:44.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="mwq30123"/> <meta itemprop="url" content="https://juejin.cn/user/3403743729030686"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Cursor Tab 共享无限车
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3403743729030686/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    mwq30123
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-28T03:26:44.000Z" title="Fri Nov 28 2025 03:26:44 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-28
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>linux.do 大佬开发的，不知道啥时候就不能用了，且用且珍惜。
<a href="https://link.juejin.cn?target=https%3A%2F%2Flinux.do%2Ft%2Ftopic%2F1056849" target="_blank" title="https://linux.do/t/topic/1056849" ref="nofollow noopener noreferrer">原文地址</a></p>
<h2 data-id="heading-0">Cursor</h2>
<p>修改程序地址:</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fwisdgod%2Fcursor-rp%2Freleases" target="_blank" title="https://github.com/wisdgod/cursor-rp/releases" ref="nofollow noopener noreferrer">Releases · wisdgod/cursor-rp</a></p>
<p>需要下载 modifier 文件, 然后以管理员运行指令:</p>
<pre><code class="hljs language-css" lang="css">先关闭<span class="hljs-attribute">Cursor</span>


chmod +x &lt;modifier-aarch64-apple-darwin 下载全路径&gt;

sudo &lt;modifier-aarch64-apple-darwin 下载全路径&gt;  <span class="hljs-attr">--cursor-path</span> /Applications/<span class="hljs-attribute">Cursor</span><span class="hljs-selector-class">.app</span> <span class="hljs-attr">--scheme</span> https <span class="hljs-attr">--suffix</span> <span class="hljs-selector-class">.lilingfeng</span><span class="hljs-selector-class">.dev</span> <span class="hljs-attr">--skip-hosts</span> <span class="hljs-attr">--confirm</span> <span class="hljs-attr">--pass-token</span>
</code></pre>
<p>运行后出现</p>
<blockquote>
<p>您必须同意最终用户许可协议(EULA)才能使用本软件。
请打开eula.txt文件，阅读协议内容，并将eula=false修改为eula=true。</p>
</blockquote>
<p>这个文件会在modifier的同级目录生生成一个eula.txt,改下文档，重新运行就行了
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e41bcd4b1ed54cc69416e419506b6c38~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgbXdxMzAxMjM=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764905204&amp;x-signature=7DcWkoGTkNuglnkPoPNbDSPy5Hg%3D" alt="截屏2025-11-28 11.25.55.png" loading="lazy"/></p>
<p><strong>修改后将只能使用 Tab</strong>，取消修改只需要删除 <code>--confirm</code> 重新跑一边即可</p>
<p>无法使用请把网络调成 http 1.1，204 是正常的</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Harmony os——AbilityStage 组件管理器：我理解的 Module 级「总控台」]]></title>    <link>https://juejin.cn/post/7577300470520889353</link>    <guid>https://juejin.cn/post/7577300470520889353</guid>    <pubDate>2025-11-28T03:15:23.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577300470520889353" data-draft-id="7577321767346110510" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Harmony os——AbilityStage 组件管理器：我理解的 Module 级「总控台」"/> <meta itemprop="keywords" content="HarmonyOS"/> <meta itemprop="datePublished" content="2025-11-28T03:15:23.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="用户46398975432"/> <meta itemprop="url" content="https://juejin.cn/user/714006150282890"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Harmony os——AbilityStage 组件管理器：我理解的 Module 级「总控台」
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/714006150282890/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    用户46398975432
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-28T03:15:23.000Z" title="Fri Nov 28 2025 03:15:23 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-28
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Harmony os——AbilityStage 组件管理器：我理解的 Module 级「总控台」</h2>
<blockquote>
<p>这一篇是我给 <strong>AbilityStage</strong> 写的学习笔记 + 博客稿。 可以和前面那几篇「应用模型 / UIAbility / 启动模式」放在一个 HarmonyOS 开发系列里。</p>
</blockquote>
<hr/>
<h3 data-id="heading-1">1. AbilityStage 是什么？一句话版本</h3>
<p>官方定义有点长，我自己总结一句：</p>
<blockquote>
<p><strong>AbilityStage = 一个 Module 级别的组件管理器，是这个 HAP「第一次被加载」时创建的总控类，用来做模块级初始化 + 全局事件监听。</strong></p>
</blockquote>
<p>几个关键点：</p>
<ul>
<li>
<p>它<strong>跟 Module 一一对应</strong>：</p>
<ul>
<li>一个 Module 对应一个 AbilityStage 实例；</li>
<li>比如 <code>entry</code> module 就配一个 <code>MyAbilityStage</code>。</li>
</ul>
</li>
<li>
<p>它是在该 HAP 第一个 Ability（UIAbility / ExtensionAbility）创建之前被拉起来的；</p>
</li>
<li>
<p>适合做：<strong>资源预加载、线程创建、全局环境监听、内存回调处理、指定进程策略、关闭前拦截等</strong>。</p>
</li>
</ul>
<p>可以把它想象成：</p>
<blockquote>
<p>「这个 Module 的总调度中心」。</p>
</blockquote>
<hr/>
<h3 data-id="heading-2">2. AbilityStage 提供了哪些回调？</h3>
<p>AbilityStage 有两类回调：</p>
<ul>
<li>
<p>生命周期回调：</p>
<ul>
<li><code>onCreate()</code></li>
<li><code>onDestroy()</code></li>
</ul>
</li>
<li>
<p>事件回调：</p>
<ul>
<li><code>onAcceptWant()</code></li>
<li><code>onConfigurationUpdate()</code></li>
<li><code>onMemoryLevel()</code></li>
<li><code>onNewProcessRequest()</code></li>
<li><code>onPrepareTermination()</code></li>
</ul>
</li>
</ul>
<p>我按「开发时常用程度」给它分个类。</p>
<h4 data-id="heading-3">2.1 onCreate()：Module 级初始化入口</h4>
<p><strong>时机：</strong></p>
<ul>
<li>对应 HAP <strong>首次加载</strong>时；</li>
<li>在创建这个 Module 的第一个 Ability（UIAbility 或某个 ExtensionAbility）之前，系统先创建 AbilityStage，然后调用 <code>onCreate()</code>。</li>
</ul>
<p><strong>适合做的事情：</strong></p>
<ul>
<li>模块级资源预加载；</li>
<li>启动一些公共线程或任务调度器；</li>
<li>注册 Application 级别的监听（比如环境变化、内存回调等）。</li>
</ul>
<p>示例（简化版）：</p>
<pre><code class="hljs language-scala" lang="scala"> <span class="hljs-keyword">import</span> { <span class="hljs-type">AbilityStage</span> } from '<span class="hljs-meta">@kit</span>.<span class="hljs-type">AbilityKit</span>';
 ​
 <span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MyAbilityStage</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">AbilityStage</span> </span>{
   onCreate(): void {
     <span class="hljs-comment">// Module 级初始化，比如资源预加载、线程创建等</span>
     console.info('<span class="hljs-type">MyAbilityStage</span> onCreate');
   }
 }
</code></pre>
<h4 data-id="heading-4">2.2 onAcceptWant()：和 UIAbility 指定实例模式配套使用</h4>
<p>这个回调专门用在 <strong>UIAbility 的 specified 启动模式</strong> 场景下。</p>
<ul>
<li>
<p>当某个 UIAbility 以 <code>launchType: "specified"</code> 启动时，系统会：</p>
<ol>
<li>
<p>先进入对应 Module 的 <code>AbilityStage.onAcceptWant(want)</code>；</p>
</li>
<li>
<p>由你在这里返回一个字符串 Key；</p>
</li>
<li>
<p>系统用这个 Key 去匹配已有的 UIAbility 实例：</p>
<ul>
<li>有匹配的 → 复用旧实例，触发 <code>onNewWant()</code>；</li>
<li>无匹配的 → 创建一个新实例，走 <code>onCreate()</code> + <code>onWindowStageCreate()</code>。</li>
</ul>
</li>
</ol>
</li>
</ul>
<p>因此：</p>
<blockquote>
<p><strong>onAcceptWant 的返回值 = UIAbility 实例的标识字符串。</strong></p>
</blockquote>
<p>示例里的最简写法：</p>
<pre><code class="hljs language-scala" lang="scala"> <span class="hljs-keyword">import</span> { <span class="hljs-type">AbilityStage</span>, <span class="hljs-type">Want</span> } from '<span class="hljs-meta">@kit</span>.<span class="hljs-type">AbilityKit</span>';
 ​
 <span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MyAbilityStage</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">AbilityStage</span> </span>{
   onAcceptWant(want: <span class="hljs-type">Want</span>): string {
     <span class="hljs-comment">// 指定实例模式下由你返回实例标识</span>
     <span class="hljs-keyword">return</span> '<span class="hljs-type">MyAbilityStage</span>';
   }
 }
</code></pre>
<p>实际业务中可以按 <code>want.parameters</code> 拼出更细的 key，前面 UIAbility 启动模式那篇里已经有详细例子。</p>
<hr/>
<h4 data-id="heading-5">2.3 onConfigurationUpdate()：环境变化监听（语言 / 主题 / 方向）</h4>
<p>这个和 <code>EnvironmentCallback</code> 搭配尤为常用，适合做「系统配置变化 → 应用整体适配」。</p>
<p>系统环境变化时会触发：</p>
<ul>
<li>语言变更；</li>
<li>深色 / 浅色模式切换；</li>
<li>屏幕方向变更；</li>
<li>字号缩放；</li>
<li>字重缩放等。</li>
</ul>
<p>你可以在 AbilityStage 的 <code>onCreate()</code> 里注册环境监听：</p>
<pre><code class="hljs language-javascript" lang="javascript"> <span class="hljs-keyword">import</span> { <span class="hljs-title class_">EnvironmentCallback</span>, <span class="hljs-title class_">AbilityStage</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.AbilityKit'</span>;
 <span class="hljs-keyword">import</span> { <span class="hljs-title class_">BusinessError</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.BasicServicesKit'</span>;
 ​
 <span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MyAbilityStage</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">AbilityStage</span> {
   <span class="hljs-title function_">onCreate</span>(): <span class="hljs-keyword">void</span> {
     <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'AbilityStage onCreate'</span>);
 ​
     <span class="hljs-keyword">const</span> <span class="hljs-attr">envCallback</span>: <span class="hljs-title class_">EnvironmentCallback</span> = {
       <span class="hljs-title function_">onConfigurationUpdated</span>(<span class="hljs-params">config</span>) {
         <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`onConfigurationUpdated: <span class="hljs-subst">${<span class="hljs-built_in">JSON</span>.stringify(config)}</span>`</span>);
         <span class="hljs-keyword">const</span> language = config.<span class="hljs-property">language</span>;           <span class="hljs-comment">// 当前语言</span>
         <span class="hljs-keyword">const</span> colorMode = config.<span class="hljs-property">colorMode</span>;         <span class="hljs-comment">// 深 / 浅色模式</span>
         <span class="hljs-keyword">const</span> direction = config.<span class="hljs-property">direction</span>;         <span class="hljs-comment">// 屏幕方向</span>
         <span class="hljs-keyword">const</span> fontSizeScale = config.<span class="hljs-property">fontSizeScale</span>; <span class="hljs-comment">// 字体大小缩放</span>
         <span class="hljs-keyword">const</span> fontWeightScale = config.<span class="hljs-property">fontWeightScale</span>; <span class="hljs-comment">// 字体粗细缩放</span>
         <span class="hljs-comment">// 可以在这里触发一些全局 UI 适配逻辑</span>
       },
       <span class="hljs-title function_">onMemoryLevel</span>(<span class="hljs-params">level</span>) {
         <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`onMemoryLevel level: <span class="hljs-subst">${level}</span>`</span>);
       }
     };
 ​
     <span class="hljs-keyword">try</span> {
       <span class="hljs-keyword">const</span> applicationContext = <span class="hljs-variable language_">this</span>.<span class="hljs-property">context</span>.<span class="hljs-title function_">getApplicationContext</span>();
       <span class="hljs-keyword">const</span> callbackId = applicationContext.<span class="hljs-title function_">on</span>(<span class="hljs-string">'environment'</span>, envCallback);
       <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`env callbackId: <span class="hljs-subst">${callbackId}</span>`</span>);
     } <span class="hljs-keyword">catch</span> (error) {
       <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(
         <span class="hljs-string">`env callback error: <span class="hljs-subst">${(error <span class="hljs-keyword">as</span> BusinessError).code}</span>, <span class="hljs-subst">${(error <span class="hljs-keyword">as</span> BusinessError).message}</span>`</span>
       );
     }
   }
 ​
   <span class="hljs-title function_">onDestroy</span>(): <span class="hljs-keyword">void</span> {
     <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'AbilityStage onDestroy'</span>);
   }
 }
</code></pre>
<blockquote>
<p>小心得： 如果你的应用有「多语言切换、主题联动、字体大小适配」这类全局需求，用 AbilityStage + EnvironmentCallback 会比在单个 UIAbility 中东一块西一块强很多。</p>
</blockquote>
<hr/>
<h4 data-id="heading-6">2.4 onMemoryLevel()：系统内存吃紧时的自救机会</h4>
<p>当系统内存紧张时会触发这个回调。</p>
<ul>
<li>比如应用退到后台后还占着一堆内存；</li>
<li>系统会通过 <code>onMemoryLevel()</code> 通知你当前内存压力等级；</li>
<li>你可以主动释放一些不关键的资源（缓存大图、预加载数据等）。</li>
</ul>
<p>好处是：</p>
<blockquote>
<p>主动配合系统回收内存，有助于避免进程被系统直接 kill，提升应用整体稳定性。</p>
</blockquote>
<p>上面的 <code>envCallback</code> 中其实已经演示了 <code>onMemoryLevel()</code> 的写法。</p>
<hr/>
<h4 data-id="heading-7">2.5 onNewProcessRequest()：控制 UIAbility 运行在哪个进程</h4>
<p>这个回调是给 <strong>「多进程策略」</strong> 用的，场景会比较高级。</p>
<ul>
<li>
<p>当某个 UIAbility 启动时，系统会回调 <code>onNewProcessRequest()</code>；</p>
</li>
<li>
<p>你可以返回一个「进程标识字符串」：</p>
<ul>
<li>若该标识对应的进程已经存在 → 复用；</li>
<li>若不存在 → 创建新进程；</li>
</ul>
</li>
<li>
<p>要启用这个能力，需要在 <code>module.json5</code> 里先配置：</p>
</li>
</ul>
<pre><code class="hljs language-json" lang="json"> <span class="hljs-punctuation">{</span>
   <span class="hljs-attr">"module"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
     <span class="hljs-comment">// ...</span>
     <span class="hljs-attr">"isolationProcess"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span>
   <span class="hljs-punctuation">}</span>
 <span class="hljs-punctuation">}</span>
</code></pre>
<p>典型用途：</p>
<ul>
<li>把某些高风险 / 高资源消耗的 UIAbility 放到单独进程中跑；</li>
<li>做类似「文档编辑进程」这种隔离。</li>
</ul>
<hr/>
<h4 data-id="heading-8">2.6 onPrepareTermination()：应用关闭前的最后挽留</h4>
<p>当用户「关闭应用」时，系统会先回调 <code>onPrepareTermination()</code>。</p>
<ul>
<li>
<p>你可以在这里决定：</p>
<ul>
<li>是否立刻允许关闭；</li>
<li>还是告诉系统「先不要关」，比如先弹个对话框问用户是否保存草稿。</li>
</ul>
</li>
<li>
<p>返回值是 <code>AbilityConstant.PrepareTermination</code> 中的枚举，告诉系统继续关还是中断关闭动作。</p>
</li>
</ul>
<p>典型场景：</p>
<ul>
<li>用户正在编辑重要内容（文档、填表、写作业…）；</li>
<li>用户从最近任务一划而过；</li>
<li>你在 <code>onPrepareTermination()</code> 里检测到有未保存内容 → 先阻止关闭，给 UIAbility 发通知弹窗。</li>
</ul>
<h4 data-id="heading-9">2.7 onDestroy()：Module 正常销毁时的收尾</h4>
<ul>
<li>当对应 Module 的 <strong>最后一个 Ability 实例退出</strong>，并且应用以「正常方式」销毁时触发；</li>
<li>可以在这里做一些模块级的资源释放、取消注册等。</li>
</ul>
<p>注意两个不会触发的情况：</p>
<ul>
<li>应用异常崩溃；</li>
<li>被系统强制终止。</li>
</ul>
<p>这两种情况<code>onDestroy()</code>都不会执行，所以特别关键的数据仍然要在各 Ability 自己的生命周期里保存。</p>
<hr/>
<h3 data-id="heading-10">3. 如何在工程中启用 AbilityStage？</h3>
<p>默认模板里是<strong>不会自动创建</strong> AbilityStage 的，需要你自己手动加一份。</p>
<h4 data-id="heading-11">3.1 创建 AbilityStage 文件</h4>
<ol>
<li>在某个 Module 的 <code>ets</code> 目录下新建目录 比如：<code>ets/myabilitystage/</code></li>
<li>新建 ArkTS 文件：<code>MyAbilityStage.ets</code></li>
<li>继承 <code>AbilityStage</code>，实现所需回调：</li>
</ol>
<pre><code class="hljs language-scala" lang="scala"> <span class="hljs-keyword">import</span> { <span class="hljs-type">AbilityStage</span>, <span class="hljs-type">Want</span> } from '<span class="hljs-meta">@kit</span>.<span class="hljs-type">AbilityKit</span>';
 ​
 <span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MyAbilityStage</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">AbilityStage</span> </span>{
   onCreate(): void {
     console.info('<span class="hljs-type">MyAbilityStage</span> onCreate');
     <span class="hljs-comment">// 模块初始化逻辑</span>
   }
 ​
   onAcceptWant(want: <span class="hljs-type">Want</span>): string {
     <span class="hljs-comment">// 仅在 specified 启动模式下会触发</span>
     <span class="hljs-keyword">return</span> '<span class="hljs-type">MyAbilityStage</span>';
   }
 }
</code></pre>
<h4 data-id="heading-12">3.2 在 module.json5 里绑定入口</h4>
<p><code>srcEntry</code> 指定这个 Module 对应的 AbilityStage 入口：</p>
<pre><code class="hljs language-json" lang="json"> <span class="hljs-punctuation">{</span>
   <span class="hljs-attr">"module"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
     <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"entry"</span><span class="hljs-punctuation">,</span>
     <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"entry"</span><span class="hljs-punctuation">,</span>
     <span class="hljs-attr">"srcEntry"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"./ets/myabilitystage/MyAbilityStage.ets"</span><span class="hljs-punctuation">,</span>
     <span class="hljs-comment">// ...</span>
   <span class="hljs-punctuation">}</span>
 <span class="hljs-punctuation">}</span>
</code></pre>
<p>这样，当这个 HAP 第一次被加载时，就会先走 <code>MyAbilityStage.onCreate()</code>，你的模块级逻辑就能接管整体节奏了。</p>
<hr/>
<h3 data-id="heading-13">4. 我会怎么在项目里用 AbilityStage？</h3>
<p>结合前面几篇 Stage 模型、UIAbility、ExtensionAbility 的内容，我自己会把 AbilityStage 看成一个「模块级中控」，用来集中处理：</p>
<ol>
<li>
<p><strong>模块初始化</strong></p>
<ul>
<li>注册环境变化监听（语言/主题/字体等）；</li>
<li>初始化一些全局单例，比如日志、埋点、配置中心。</li>
</ul>
</li>
<li>
<p><strong>全局事件/配置监听</strong></p>
<ul>
<li>用 <code>EnvironmentCallback</code> 处理深浅色联动；</li>
<li>用 <code>onMemoryLevel</code> 做内存压缩策略。</li>
</ul>
</li>
<li>
<p><strong>UIAbility 启动策略</strong></p>
<ul>
<li>结合 <code>onAcceptWant()</code> + <code>launchType: specified</code> 做多文档/多实例管理；</li>
<li>通过 <code>onNewProcessRequest()</code> 控制哪些 Ability 跑独立进程。</li>
</ul>
</li>
<li>
<p><strong>关闭前的拦截</strong></p>
<ul>
<li>
<p>在 <code>onPrepareTermination()</code> 给整个 App 做一次「善后机会」：</p>
<ul>
<li>未同步的数据提示用户；</li>
<li>清理某些后台任务；</li>
<li>重要日志 flush。</li>
</ul>
</li>
</ul>
</li>
</ol>
<hr/>
<h3 data-id="heading-14">5. 小结</h3>
<p>如果用一句比较形象的话来收尾：</p>
<blockquote>
<p><strong>UIAbility 负责「这一个窗口怎么跑」，ExtensionAbility 负责「某个扩展场景怎么跑」， 而 AbilityStage 则站在 Module 的视角，负责「这一整包能力怎么被初始化、管理和收尾」。</strong></p>
</blockquote>
<p>在 HarmonyOS NEXT 的 Stage 模型下， AbilityStage 其实是一个非常关键但容易被忽略的点—— 用好了，它能让你的应用模块结构更清晰，行为更可控，也更「系统级」。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[OrbitControls 的完整原理]]></title>    <link>https://juejin.cn/post/7577364921656377386</link>    <guid>https://juejin.cn/post/7577364921656377386</guid>    <pubDate>2025-11-28T03:20:48.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577364921656377386" data-draft-id="7577343038428004395" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="OrbitControls 的完整原理"/> <meta itemprop="keywords" content="three.js"/> <meta itemprop="datePublished" content="2025-11-28T03:20:48.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="big男孩"/> <meta itemprop="url" content="https://juejin.cn/user/1996368846523368"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            OrbitControls 的完整原理
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1996368846523368/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    big男孩
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-28T03:20:48.000Z" title="Fri Nov 28 2025 03:20:48 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-28
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0"><strong>🎯 OrbitControls 的完整原理（最精简 + 最准确版）</strong></h2>
<p>OrbitControls 的核心目标很简单：</p>
<blockquote>
<p><strong>让相机围绕一个目标点（target）做旋转、缩放、平移，同时保持视角稳定。</strong>****</p>
</blockquote>
<p>它的实现不是直接修改相机的 rotation，而是：</p>
<hr/>
<h2 data-id="heading-1"><strong>✅ 1. 使用球坐标系存储相机相对 target 的位置</strong></h2>
<p>OrbitControls 内部用 <strong>球坐标系 (spherical)</strong> 表示相机在球面上的位置：</p>

























<table><thead><tr><th><strong>spherical 属性</strong></th><th><strong>代表含义</strong></th><th><strong>决定什么</strong></th></tr></thead><tbody><tr><td>radius</td><td>相机到 target 的距离</td><td>缩放（远近）</td></tr><tr><td>theta</td><td>水平旋转（绕 Y 轴）</td><td>左右旋转</td></tr><tr><td>phi</td><td>垂直旋转（从 Y+ 向下量角）</td><td>上下旋转</td></tr></tbody></table>
<p>OrbitControls 并不直接存相机 position，而是依赖 spherical。</p>
<hr/>
<h2 data-id="heading-2"><strong>✅ 2. 每次更新，都会根据 spherical 重新计算 camera.position</strong></h2>
<p>伪代码：</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// 球坐标转换为世界坐标</span>
offset<span class="hljs-selector-class">.setFromSpherical</span>(spherical);

<span class="hljs-comment">// camera.position = target + offset</span>
camera<span class="hljs-selector-class">.position</span><span class="hljs-selector-class">.copy</span>(target)<span class="hljs-selector-class">.add</span>(offset);

<span class="hljs-comment">// 相机永远朝向 target</span>
camera<span class="hljs-selector-class">.lookAt</span>(target);
</code></pre>
<p>也就是说：</p>
<p>✨ <strong>相机的位置永远落在一个以 target 为圆心的球面上。</strong>****</p>
<hr/>
<h2 data-id="heading-3"><strong>✅ 3. 用户的三种交互对应修改 spherical 或 target</strong></h2>
<h4 data-id="heading-4"><strong>✔（1）旋转（左键）</strong></h4>
<p>修改 spherical 的角度：</p>
<pre><code class="hljs">theta ← 左右拖动
phi   ← 上下拖动
</code></pre>
<p>效果：相机绕 target 转圈。</p>
<hr/>
<h4 data-id="heading-5"><strong>✔（2）缩放（滚轮）</strong></h4>
<p>修改 spherical.radius：</p>
<pre><code class="hljs language-makefile" lang="makefile">radius += delta
</code></pre>
<p>效果：相机沿着射线（camera → target）前进或后退。</p>
<hr/>
<h4 data-id="heading-6"><strong>✔（3）平移（右键）</strong></h4>
<p>修改 target（以及 camera.position 同步移动）：</p>
<pre><code class="hljs language-arduino" lang="arduino">target += panDelta
camera.position += panDelta
</code></pre>
<p>这样保持相机与 target 的相对距离不变，视野整体平移。</p>
<hr/>
<h2 data-id="heading-7"><strong>📌 Why？为什么不直接改 camera.rotation？</strong></h2>
<p>因为：</p>
<ul>
<li>
<p>欧拉角 rotation 会出现万向节锁 (gimbal lock)</p>
</li>
<li>
<p>旋转结果顺序依赖 Euler 的 order</p>
</li>
<li>
<p>不能保证相机固定绕某点旋转</p>
</li>
<li>
<p>平移与旋转混合会很混乱</p>
</li>
</ul>
<p>使用 spherical + lookAt(target) 是最稳定、最可控的方案。</p>
<hr/>
<h2 data-id="heading-8"><strong>🎨 图示（概念图）</strong></h2>
<pre><code class="hljs language-perl" lang="perl">          Y+
          |
          |      camera ●
          |       (theta, phi, radius)
          |        <span class="hljs-regexp">/
          |       /</span>
          |      <span class="hljs-regexp">/
          |     /</span>
          ●----+------------------ X+
         target
</code></pre>
<p>📌 相机始终在半径为 radius 的球面上</p>
<p>📌 用户的操作实质是改变球坐标的位置</p>
<hr/>
<h2 data-id="heading-9"><strong>🎯 OrbitControls 本质上做的两件事</strong></h2>
<p>无论用户怎么操作，都只是修改：</p>
<ol>
<li>
<p><strong>camera.position</strong>****</p>
</li>
<li>
<p><strong>controls.target</strong></p>
</li>
</ol>
<p>最终调用：</p>
<pre><code class="hljs language-ini" lang="ini">camera.lookAt(target)<span class="hljs-comment">;</span>
</code></pre>
<p>而不动 rotation。</p>
<hr/>
<h2 data-id="heading-10"><strong>📦 大总结（你可以直接放到文档里）</strong></h2>
<blockquote>
<p><strong>OrbitControls = 基于球坐标的相机系统，通过改变 spherical（旋转/缩放）和 target（平移），生成 camera.position，然后使用 lookAt 保持视角稳定。</strong>****</p>
</blockquote>
<ul>
<li>
<blockquote>
<p>旋转 = 改 theta 和 phi</p>
</blockquote>
</li>
<li>
<blockquote>
<p>缩放 = 改 radius</p>
</blockquote>
</li>
<li>
<blockquote>
<p>平移 = 改 target</p>
</blockquote>
</li>
</ul>
<blockquote>
</blockquote>
<blockquote>
<p>相机不会直接修改 rotation，而是由 target 和 spherical 决定最终的相机朝向和位置。</p>
</blockquote>
<hr/></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[go-kratos-admin 快速上手指南：从环境搭建到启动服务（Windows/macOS/Linux 通用）]]></title>    <link>https://juejin.cn/post/7577332659506217003</link>    <guid>https://juejin.cn/post/7577332659506217003</guid>    <pubDate>2025-11-28T03:27:09.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577332659506217003" data-draft-id="7577333742277902378" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="go-kratos-admin 快速上手指南：从环境搭建到启动服务（Windows/macOS/Linux 通用）"/> <meta itemprop="keywords" content="Go,Vue.js"/> <meta itemprop="datePublished" content="2025-11-28T03:27:09.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="喵个咪"/> <meta itemprop="url" content="https://juejin.cn/user/1350630784901262"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            go-kratos-admin 快速上手指南：从环境搭建到启动服务（Windows/macOS/Linux 通用）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1350630784901262/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    喵个咪
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-28T03:27:09.000Z" title="Fri Nov 28 2025 03:27:09 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-28
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">go-kratos-admin 快速上手指南：从环境搭建到启动服务（Windows/macOS/Linux 通用）</h2>
<p>go-kratos-admin 作为开箱即用的企业级 Admin 全栈解决方案，核心优势之一是通过 <code>backend/script</code> 目录的 <strong>自动化脚本</strong> 降低跨系统部署门槛。本文以 “脚本驱动 + 实操验证” 为核心，优化步骤连贯性与细节提示，补充用户高频踩坑点，帮你更顺畅地完成从环境到服务的全流程搭建。</p>
<p><strong>前置检查清单（启动前必看）</strong></p>
<p>避免因基础条件缺失导致流程中断，启动前确认以下事项：</p>
<ol>
<li>操作系统权限：Windows 需 管理员身份 打开 PowerShell；Linux/macOS 需拥有 <code>sudo</code> 权限（执行脚本时可能需要）。</li>
<li>网络状态：确保能访问 <code>GitHub</code>、<code>Docker Hub</code>、<code>Homebrew</code>/<code>Scoop</code> 源（建议提前配置国内镜像，见各系统备注）。</li>
<li>磁盘空间：预留至少 <strong>10GB</strong> 空间（用于存储 Docker 镜像、依赖包、编译产物）。</li>
</ol>
<h3 data-id="heading-1">一、前置认知：<code>backend/script</code>核心脚本解析</h3>
<p>在开始操作前，先明确脚本分类与作用（避免用错场景），核心脚本清单如下：</p>























































<table><thead><tr><th>脚本路径</th><th>适用系统</th><th>核心功能</th></tr></thead><tbody><tr><td><code>prepare_ubuntu.sh</code></td><td>Ubuntu/Debian</td><td>自动更新系统、安装 Git/Golang/Docker/Node.js 等基础依赖，配置环境变量</td></tr><tr><td><code>prepare_centos.sh</code></td><td>CentOS/RHEL</td><td>同上，适配 RPM 包管理系统</td></tr><tr><td><code>prepare_rocky.sh</code></td><td>Rocky Linux</td><td>同上，针对 Rocky 系统的依赖兼容性优化</td></tr><tr><td><code>prepare_macos.sh</code></td><td>MacOS</td><td>通过 Homebrew 包管理器安装 Git/make/Golang/Docker，配置 Docker 自启动</td></tr><tr><td><code>prepare_windows.ps1</code></td><td>Windows</td><td>通过 Scoop 包管理器安装 Git/make/Golang/Docker，配置 Docker 自启动</td></tr><tr><td><code>docker_compose_install.sh</code></td><td>全系统（需 Docker）</td><td>一键启动 <strong>中间件（PostgreSQL/Redis/Consul）+ 后端服务</strong> 容器，零手动配置</td></tr><tr><td><code>docker_compose_install_depends.sh</code></td><td>全系统</td><td>仅启动中间件容器（适合 “中间件 Docker + 服务本地运行” 的混合部署场景）</td></tr><tr><td><code>build_install.sh</code></td><td>全系统（需 Golang）</td><td>编译后端微服务，部署到 <code>/root/app/kratos_admin</code>（Linux/macOS）或对应路径</td></tr><tr><td><code>install_golang.sh</code></td><td>Linux/macOS</td><td>单独安装指定版本 Golang（若脚本自动安装的版本不满足需求时用）</td></tr></tbody></table>
<h3 data-id="heading-2">二、环境搭建：用脚本一键搞定依赖（分系统操作）</h3>
<h4 data-id="heading-3">2.1 通用前置步骤：拉取项目代码</h4>
<p>先克隆代码到本地，确保能访问 <code>backend/script</code> 目录：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 克隆项目（HTTPS 方式，无需 SSH 密钥）</span>
git <span class="hljs-built_in">clone</span> https://github.com/tx7do/go-kratos-admin.git

<span class="hljs-comment"># 进入项目根目录</span>
<span class="hljs-built_in">cd</span> go-kratos-admin
</code></pre>
<h4 data-id="heading-4">2.2 Windows 系统：用 PowerShell 脚本自动装依赖</h4>
<p><strong>必须以「管理员身份」打开 PowerShell</strong>（否则脚本无权限修改系统配置），执行以下步骤：</p>
<h5 data-id="heading-5">1. 进入 backend 目录，赋予脚本执行权限：</h5>
<pre><code class="hljs language-powershell" lang="powershell"># 1. 以管理员身份打开 PowerShell（右键开始菜单 → 选择“Windows PowerShell (管理员)”）
# 2. 进入 backend 目录（注意路径分隔符用 \ 或 /，示例：若项目在 D 盘）
cd D:/go-kratos-admin/backend

# 3. 允许执行本地脚本（仅首次执行，后续无需重复）
Set-ExecutionPolicy RemoteSigned -Scope CurrentUser
# 提示“是否执行此操作？”时，输入 Y 并回车
</code></pre>
<h5 data-id="heading-6">2. 运行 Windows 专属准备脚本：</h5>
<pre><code class="hljs language-powershell" lang="powershell"># 执行环境准备脚本，自动安装 Scoop/Git/Golang/Docker 等
# 执行脚本（首次运行约 10-15 分钟，取决于网络速度）
.\script\prepare_windows.ps1

# 脚本执行中注意：
# - 若提示“安装 Scoop”，直接按回车（自动下载配置）；
# - 安装 Docker 后会弹出“Docker Desktop 安装向导”，按默认步骤下一步，最后启动 Docker；
# - 脚本结束后，关闭当前 PowerShell，重新以管理员身份打开（确保环境变量生效）
</code></pre>
<h5 data-id="heading-7">3. 验证关键工具是否安装成功</h5>
<pre><code class="hljs language-powershell" lang="powershell">git --version  # 预期：git version 2.30.0+
go version     # 预期：go version go1.21+ windows/amd64
docker --version  # 预期：Docker version 20.10.0+
pnpm --version    # 预期：pnpm 8.0.0+
</code></pre>
<h4 data-id="heading-8">2.3 Linux 系统：按发行版选对应脚本</h4>
<p><strong>Linux 脚本执行说明：</strong></p>
<ul>
<li>脚本会自动输入 <code>y</code> 确认安装（无需手动干预），过程中可能需要输入 sudo 密码（输入时无显式回显，输完按回车即可）；</li>
<li>安装 Docker 后会自动将当前用户加入 docker 组，脚本结束后需重新登录终端（确保 Docker 权限生效）。</li>
</ul>
<h5 data-id="heading-9">通用前置：赋予脚本执行权限（仅需一次）</h5>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 进入 backend 目录</span>
<span class="hljs-built_in">cd</span> go-kratos-admin/backend

<span class="hljs-comment"># 给所有脚本添加执行权限（避免“Permission denied”）</span>
<span class="hljs-built_in">chmod</span> +x ./script/*.sh
</code></pre>
<h5 data-id="heading-10">场景 1：Ubuntu/Debian 系列</h5>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 执行准备脚本（中途需输入 sudo 密码，输入时无显式回显，输完回车即可）</span>
./script/prepare_ubuntu.sh

<span class="hljs-comment"># 脚本结束后重新登录终端（或执行以下命令加载环境变量）</span>
<span class="hljs-built_in">source</span> /etc/profile

<span class="hljs-comment"># 验证环境（同 Windows 验证命令，确保工具版本达标）</span>
git --version &amp;&amp; go version &amp;&amp; docker --version
</code></pre>
<h5 data-id="heading-11">场景 2：CentOS 系列</h5>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">cd</span> backend
<span class="hljs-built_in">chmod</span> +x ./script/*.sh
./script/prepare_centos.sh

<span class="hljs-comment"># 重新加载环境变量 + 验证</span>
<span class="hljs-built_in">source</span> /etc/profile &amp;&amp; go version &amp;&amp; docker --version
</code></pre>
<h5 data-id="heading-12">场景 3：Rocky Linux</h5>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">cd</span> backend
<span class="hljs-built_in">chmod</span> +x ./script/*.sh
./script/prepare_rocky.sh

<span class="hljs-comment"># 重新加载环境变量 + 验证</span>
<span class="hljs-built_in">source</span> /etc/profile &amp;&amp; go version &amp;&amp; docker --version
</code></pre>
<h4 data-id="heading-13"><strong>Linux 避坑提示</strong>：若执行 <code>docker ps</code> 提示 <code>“Cannot connect to the Docker daemon</code>”，执行以下命令修复：</h4>
<pre><code class="hljs language-bash" lang="bash">sudo systemctl start docker  <span class="hljs-comment"># 启动 Docker 服务</span>
sudo systemctl <span class="hljs-built_in">enable</span> docker <span class="hljs-comment"># 设置开机自启</span>
sudo usermod -aG docker <span class="hljs-variable">$USER</span> <span class="hljs-comment"># 将当前用户加入 docker 组（避免每次用 sudo）</span>
<span class="hljs-comment"># 执行后重新登录终端，再试 docker ps</span>
</code></pre>
<h4 data-id="heading-14">2.4 macOS 系统</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">cd</span> backend
<span class="hljs-built_in">chmod</span> +x ./script/*.sh
./script/prepare_macos.sh
</code></pre>
<h4 data-id="heading-15">验证环境</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 验证工具</span>
git --version &amp;&amp; go version &amp;&amp; docker --version
<span class="hljs-comment"># 验证 Docker 服务（确保能正常拉取镜像）</span>
docker pull hello-world &amp;&amp; docker run hello-world  <span class="hljs-comment"># 预期输出“Hello from Docker!”</span>
</code></pre>
<h3 data-id="heading-16">三、后端服务启动：两种部署模式（脚本一键切换）</h3>
<p>后端服务支持「全 Docker 部署」（新手推荐）和「混合部署」（适合开发调试），均通过脚本简化操作。</p>
<h4 data-id="heading-17">3.1 模式 1：全 Docker 部署（零本地依赖，推荐新手）</h4>
<p>所有组件（中间件 + 后端服务）都运行在 Docker 容器中，无需本地编译，执行一个脚本即可：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 确保在 backend 目录下</span>
<span class="hljs-built_in">cd</span> go-kratos-admin/backend

<span class="hljs-comment"># 一键启动所有服务（首次运行需拉取镜像，耐心等待 3-5 分钟）</span>
./script/docker_compose_install.sh
</code></pre>
<p><strong>验证启动结果：</strong></p>
<ul>
<li>执行 <code>docker ps</code>，若看到 <code>go-kratos-admin-backend</code>、<code>postgres</code>、<code>redis</code>、<code>consul</code> 等容器状态为 <code>Up</code>，则部署成功；</li>
<li>后端服务默认端口：7788（API 服务）、7789（SSE 服务）。</li>
</ul>
<h4 data-id="heading-18">3.2 模式 2：混合部署（中间件 Docker + 服务本地运行）</h4>
<p>适合需要修改后端代码的场景（本地运行服务便于调试），步骤如下：</p>
<h5 data-id="heading-19">1. 仅启动中间件容器（用专用脚本）：</h5>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">cd</span> go-kratos-admin/backend
./script/docker_compose_install_depends.sh
</code></pre>
<h5 data-id="heading-20">2. 编译并部署本地服务（用 <code>build_install.sh</code> 脚本）：</h5>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 编译后端代码并部署到默认路径（Linux/macOS 为 /root/app/kratos_admin）</span>
./script/build_install.sh
</code></pre>
<h5 data-id="heading-21">3. 配置 hosts 文件（关键！让本地服务能访问 Docker 中间件）：</h5>
<ul>
<li>Linux/macOS：<code>/etc/hosts</code> 或 <code>/private/etc/hosts</code></li>
<li>Windows：<code>C:\Windows\System32\drivers\etc\hosts</code></li>
</ul>
<p>添加以下内容：</p>
<pre><code class="hljs language-ini" lang="ini">127.0.0.1 postgres
127.0.0.1 redis
127.0.0.1 minio
127.0.0.1 consul
127.0.0.1 jaeger
</code></pre>
<h5 data-id="heading-22">4. 启动本地服务：</h5>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 进入部署目录（Linux/macOS 示例路径）</span>
<span class="hljs-built_in">cd</span> /root/app/kratos_admin

<span class="hljs-comment"># 用 PM2 启动服务（脚本已自动安装 PM2）</span>
pm2 start ./server --name kratos_admin
</code></pre>
<h5 data-id="heading-23">验证本地服务：</h5>
<ul>
<li>执行 <code>pm2 status</code>，若 <code>kratos_admin</code> 状态为 <code>online</code>，则启动成功；</li>
<li>访问 <a href="https://link.juejin.cn?target=http%3A%2F%2Flocalhost%3A7788%2Fdocs%2F" target="_blank" title="http://localhost:7788/docs/" ref="nofollow noopener noreferrer">http://localhost:7788/docs/</a>，返回 Swagger UI的网页界面 即正常。</li>
</ul>
<h3 data-id="heading-24">四、前端服务启动：快速跑通页面（全系统通用）</h3>
<p>前端无需脚本，直接用 pnpm 安装依赖并启动，步骤如下：</p>
<h4 data-id="heading-25">1. 进入前端目录：</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">cd</span> go-kratos-admin/frontend
</code></pre>
<h4 data-id="heading-26">2. 安装前端依赖（若速度慢，可切换镜像）：</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 切换淘宝镜像（可选，加速依赖下载）</span>
pnpm config <span class="hljs-built_in">set</span> registry https://registry.npmmirror.com

<span class="hljs-comment"># 安装依赖</span>
pnpm install
</code></pre>
<h4 data-id="heading-27">3. 启动开发模式（实时热更新，适合调试）：</h4>
<pre><code class="hljs language-bash" lang="bash">pnpm dev
</code></pre>
<h4 data-id="heading-28">验证前端：</h4>
<ul>
<li>启动成功后，终端会输出 <code>Local: http://localhost:5666</code>；</li>
<li>打开浏览器访问该地址，看到登录页面即成功（默认账号：<code>admin</code>，密码：<code>admin</code>）。</li>
</ul>
<h3 data-id="heading-29">五、关键验证：确保前后端打通</h3>
<ul>
<li>前端登录：输入 <code>admin</code>/<code>admin</code> 登录，能看到「租户管理」「用户管理」等菜单，说明前端与后端权限接口连通；</li>
<li>后端 API 文档：访问 <a href="https://link.juejin.cn?target=http%3A%2F%2Flocalhost%3A7788%2Fdocs" target="_blank" title="http://localhost:7788/docs" ref="nofollow noopener noreferrer">http://localhost:7788/docs</a>，能看到 <code>Swagger</code> 文档，且可在线调试接口（如 <code>GET /admin/v1/users</code> 查询用户列表）；</li>
<li>中间件状态：执行 <code>docker ps</code>，确保 <code>postgres</code>（数据库）、<code>redis</code>（缓存）容器持续运行（无频繁重启）。</li>
</ul>
<h3 data-id="heading-30">六、脚本使用常见问题与解决方案</h3>
<h4 data-id="heading-31">问题 1：Linux/macOS 脚本提示 “Permission denied”</h4>
<ul>
<li>原因：脚本无执行权限；</li>
<li>解决：执行 <code>chmod +x ./script/*.sh</code>（在 <code>backend</code> 目录下）。</li>
</ul>
<h4 data-id="heading-32">问题 2：Windows 脚本提示 “无法加载文件 ... 因为在此系统上禁止运行脚本”</h4>
<ul>
<li>原因：<code>PowerShell</code> 执行策略限制；</li>
<li>解决：以管理员身份打开 <code>PowerShell</code>，执行 <code>Set-ExecutionPolicy RemoteSigned -Scope CurrentUser</code>，然后输入 <code>Y</code> 确认。</li>
</ul>
<h4 data-id="heading-33">问题 3：Docker 容器启动后立即退出（状态为 Exited）</h4>
<ul>
<li>原因：中间件端口冲突（如本地已启动 MySQL 占用 5432 端口）；</li>
<li>解决：停止本地占用端口的服务，或修改 <code>backend/docker-compose.yml</code> 中对应服务的端口映射（如将 <code>5432:5432</code> 改为 <code>5433:5432</code>）。</li>
</ul>
<h4 data-id="heading-34">问题 4：build_install.sh 脚本编译失败（提示 “go: command not found”）</h4>
<ul>
<li>原因：Golang 环境变量未生效；</li>
<li>解决：Linux/macOS 执行 <code>source /etc/profile</code>，Windows 重新打开管理员 PowerShell，再重新执行脚本。</li>
</ul>
<h3 data-id="heading-35">七、下一步操作建议</h3>
<h4 data-id="heading-36">1. 基础开发：</h4>
<ul>
<li>后端：在 <code>backend/internal/service</code> 目录新增业务逻辑（如 “订单管理” 接口）；</li>
<li>前端：在 <code>frontend/src/views</code> 目录新增页面，对接后端接口（参考现有 “租户管理” 页面结构）。</li>
</ul>
<h4 data-id="heading-37">2. 生产部署：</h4>
<ul>
<li>后端：用 <code>./script/build_install.sh</code> 编译二进制文件，配合 Systemd 配置开机自启；</li>
<li>前端：执行 <code>pnpm build</code> 生成静态文件，用 Nginx 部署（配置反向代理到后端接口）。</li>
</ul>
<h4 data-id="heading-38">3. 寻求支持：</h4>
<ul>
<li>官方微信：<code>yang_lin_bo</code>（备注 “<code>go-kratos-admin</code>”）；</li>
<li>GitHub Issue：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Ftx7do%2Fgo-kratos-admin%2Fissues" target="_blank" title="https://github.com/tx7do/go-kratos-admin/issues" ref="nofollow noopener noreferrer">github.com/tx7do/go-kr…</a>（提交问题时附日志截图，便于定位）。</li>
</ul>
<h3 data-id="heading-39">总结</h3>
<p>通过项目自带的脚本，大部分环境配置与部署步骤都能 “一键完成”，避免了手动安装依赖的繁琐与出错风险。若后续需要修改代码或扩展功能，可基于此基础环境，聚焦业务逻辑开发即可。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Windows BLE 开发指南（Rust windows-rs)]]></title>    <link>https://juejin.cn/post/7577364921656410154</link>    <guid>https://juejin.cn/post/7577364921656410154</guid>    <pubDate>2025-11-28T03:21:37.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577364921656410154" data-draft-id="7577332659505856555" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Windows BLE 开发指南（Rust windows-rs)"/> <meta itemprop="keywords" content="前端,Rust"/> <meta itemprop="datePublished" content="2025-11-28T03:21:37.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="zengyuhan503"/> <meta itemprop="url" content="https://juejin.cn/user/3526889034488968"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Windows BLE 开发指南（Rust windows-rs)
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3526889034488968/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    zengyuhan503
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-28T03:21:37.000Z" title="Fri Nov 28 2025 03:21:37 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-28
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读14分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Windows BLE 开发指南（Rust windows-rs）</h2>
<p>本演示在 Windows 平台使用 Rust 的 windows-rs 库进行 BLE（低功耗蓝牙）开发：扫描设备、连接与服务发现、选择特征、启用通知（CCCD）、发送与接收数据、断开与清理，同时给出“已配对设备重启”场景的稳态策略</p>
<hr/>
<h3 data-id="heading-1">依赖与准备</h3>
<p>在 <code>Cargo.toml</code> 添加依赖：</p>
<pre><code class="hljs language-toml" lang="toml"><span class="hljs-section">[dependencies]</span>
<span class="hljs-attr">windows</span> = <span class="hljs-string">"0.56"</span>
<span class="hljs-attr">tokio</span> = { version = <span class="hljs-string">"1"</span>, features = [<span class="hljs-string">"macros"</span>, <span class="hljs-string">"rt-multi-thread"</span>] }
<span class="hljs-attr">uuid</span> = <span class="hljs-string">"1"</span>
</code></pre>
<p>常用导入（放在你的模块或文件顶部）：</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">use</span> windows::{
    core::<span class="hljs-type">Result</span> <span class="hljs-keyword">as</span> WinResult,
    Devices::Bluetooth::Advertisement::{
        BluetoothLEAdvertisementWatcher, BluetoothLEAdvertisementReceivedEventArgs,
    },
    Devices::Bluetooth::{BluetoothLEDevice, BluetoothConnectionStatus},
    Devices::Bluetooth::GenericAttributeProfile::{
        GattDeviceService, GattCharacteristic, GattCharacteristicProperties,
        GattClientCharacteristicConfigurationDescriptorValue, GattCommunicationStatus,
        GattValueChangedEventArgs, GattProtectionLevel,
    },
    Devices::Enumeration::{
        DeviceInformationCustomPairing, DevicePairingKinds, DevicePairingRequestedEventArgs,
        DevicePairingResultStatus,
    },
    Foundation::TypedEventHandler,
    Storage::Streams::DataReader,
};
</code></pre>
<p>辅助函数：UUID 字符串转 Windows GUID：</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">fn</span> <span class="hljs-title function_">guid_from_str</span>(s: &amp;<span class="hljs-type">str</span>) <span class="hljs-punctuation">-&gt;</span> windows::core::GUID {
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">u</span> = uuid::Uuid::<span class="hljs-title function_ invoke__">parse_str</span>(s).<span class="hljs-title function_ invoke__">expect</span>(<span class="hljs-string">"uuid parse error"</span>);
    <span class="hljs-keyword">let</span> (d1, d2, d3, d4) = u.<span class="hljs-title function_ invoke__">as_fields</span>();
    windows::core::GUID::<span class="hljs-title function_ invoke__">from_values</span>(d1, d2, d3, *d4)
}
</code></pre>
<hr/>
<h3 data-id="heading-2">扫描与筛选设备</h3>
<p>扫描 5 秒并返回设备列表（MAC 为 12 位十六进制字符串）：</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-meta">#[derive(Debug, Clone)]</span>
<span class="hljs-keyword">struct</span> <span class="hljs-title class_">BleDevice</span> { mac: <span class="hljs-type">String</span>, name: <span class="hljs-type">String</span>, rssi: <span class="hljs-type">Option</span>&lt;<span class="hljs-type">i16</span>&gt; }

<span class="hljs-keyword">async</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">scan_devices</span>(timeout_ms: <span class="hljs-type">u64</span>) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">Vec</span>&lt;BleDevice&gt; {
    <span class="hljs-keyword">use</span> std::{collections::HashMap, sync::Arc, time::Duration};
    <span class="hljs-keyword">use</span> tokio::sync::Mutex <span class="hljs-keyword">as</span> AsyncMutex; <span class="hljs-comment">// 广播事件是异步回调，这里用异步互斥保护聚合表</span>

    <span class="hljs-comment">// address→设备信息 聚合表（Windows 提供 64 位地址，不是文本 MAC）</span>
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">map</span> = Arc::<span class="hljs-title function_ invoke__">new</span>(AsyncMutex::<span class="hljs-title function_ invoke__">new</span>(HashMap::&lt;<span class="hljs-type">u64</span>, BleDevice&gt;::<span class="hljs-title function_ invoke__">new</span>()));
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">watcher</span> = BluetoothLEAdvertisementWatcher::<span class="hljs-title function_ invoke__">new</span>().<span class="hljs-title function_ invoke__">unwrap</span>(); <span class="hljs-comment">// 创建广播监听器</span>
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">map_cb</span> = map.<span class="hljs-title function_ invoke__">clone</span>();
    <span class="hljs-comment">// 注册 Received 事件：每条广播提取地址/名称/RSSI 并写入聚合表</span>
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">_token</span> = watcher.<span class="hljs-title function_ invoke__">Received</span>(&amp;TypedEventHandler::<span class="hljs-title function_ invoke__">new</span>(
        <span class="hljs-keyword">move</span> |_sender: &amp;<span class="hljs-type">Option</span>&lt;BluetoothLEAdvertisementWatcher&gt;, args: &amp;<span class="hljs-type">Option</span>&lt;BluetoothLEAdvertisementReceivedEventArgs&gt;| <span class="hljs-punctuation">-&gt;</span> WinResult&lt;()&gt; {
            <span class="hljs-keyword">if</span> <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">Some</span>(args) = args.<span class="hljs-title function_ invoke__">as_ref</span>() {
                <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">addr</span> = args.<span class="hljs-title function_ invoke__">BluetoothAddress</span>()?; <span class="hljs-comment">// 64 位地址（数值）</span>
                <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">mac</span> = <span class="hljs-built_in">format!</span>( <span class="hljs-comment">// 转为 12 位十六进制字符串，便于统一筛选</span>
                    <span class="hljs-string">"{:02x}{:02x}{:02x}{:02x}{:02x}{:02x}"</span>,
                    (addr &gt;&gt; <span class="hljs-number">40</span>) &amp; <span class="hljs-number">0xff</span>, (addr &gt;&gt; <span class="hljs-number">32</span>) &amp; <span class="hljs-number">0xff</span>, (addr &gt;&gt; <span class="hljs-number">24</span>) &amp; <span class="hljs-number">0xff</span>,
                    (addr &gt;&gt; <span class="hljs-number">16</span>) &amp; <span class="hljs-number">0xff</span>, (addr &gt;&gt; <span class="hljs-number">8</span>) &amp; <span class="hljs-number">0xff</span>, addr &amp; <span class="hljs-number">0xff</span>
                );
                <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">name</span> = args.<span class="hljs-title function_ invoke__">Advertisement</span>()?.<span class="hljs-title function_ invoke__">LocalName</span>()?.<span class="hljs-title function_ invoke__">to_string</span>(); <span class="hljs-comment">// 本地名（可能空）</span>
                <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">rssi</span> = args.<span class="hljs-title function_ invoke__">RawSignalStrengthInDBm</span>()?; <span class="hljs-comment">// 信号强度（dBm）</span>
                <span class="hljs-keyword">if</span> <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">Ok</span>(<span class="hljs-keyword">mut</span> m) = map_cb.<span class="hljs-title function_ invoke__">try_lock</span>() { <span class="hljs-comment">// 非阻塞写入，避免回调卡住</span>
                    m.<span class="hljs-title function_ invoke__">entry</span>(addr).<span class="hljs-title function_ invoke__">and_modify</span>(|d| { <span class="hljs-keyword">if</span> d.name.<span class="hljs-title function_ invoke__">is_empty</span>() &amp;&amp; !name.<span class="hljs-title function_ invoke__">is_empty</span>() { d.name = name.<span class="hljs-title function_ invoke__">clone</span>(); } d.rssi = <span class="hljs-title function_ invoke__">Some</span>(rssi); })
                        .<span class="hljs-title function_ invoke__">or_insert</span>(BleDevice { mac, name, rssi: <span class="hljs-title function_ invoke__">Some</span>(rssi) });
                }
            }
            <span class="hljs-title function_ invoke__">Ok</span>(())
        }
    )).<span class="hljs-title function_ invoke__">unwrap</span>();
    watcher.<span class="hljs-title function_ invoke__">Start</span>().<span class="hljs-title function_ invoke__">unwrap</span>(); <span class="hljs-comment">// 开始监听广播</span>
    tokio::time::<span class="hljs-title function_ invoke__">sleep</span>(Duration::<span class="hljs-title function_ invoke__">from_millis</span>(timeout_ms)).<span class="hljs-keyword">await</span>;
    watcher.<span class="hljs-title function_ invoke__">Stop</span>().<span class="hljs-title function_ invoke__">unwrap</span>(); <span class="hljs-comment">// 停止监听</span>
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">locked</span> = map.<span class="hljs-title function_ invoke__">lock</span>().<span class="hljs-keyword">await</span>; <span class="hljs-comment">// 收敛为列表</span>
    <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">list</span>: <span class="hljs-type">Vec</span>&lt;_&gt; = locked.<span class="hljs-title function_ invoke__">values</span>().<span class="hljs-title function_ invoke__">cloned</span>().<span class="hljs-title function_ invoke__">filter</span>(|d| !d.name.<span class="hljs-title function_ invoke__">is_empty</span>()).<span class="hljs-title function_ invoke__">collect</span>();
    list.<span class="hljs-title function_ invoke__">sort_by_key</span>(|d| d.mac.<span class="hljs-title function_ invoke__">clone</span>());
    list
}

<span class="hljs-keyword">async</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">filter_device</span>(mac: &amp;<span class="hljs-type">str</span>, list: <span class="hljs-type">Vec</span>&lt;BleDevice&gt;) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">Option</span>&lt;BleDevice&gt; {
    <span class="hljs-comment">// 支持 "AA:BB:..." 或无分隔符/大小写不一致的输入</span>
    <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">s</span> = mac.<span class="hljs-title function_ invoke__">replace</span>(<span class="hljs-string">":"</span>, <span class="hljs-string">""</span>).<span class="hljs-title function_ invoke__">replace</span>(<span class="hljs-string">'-'</span>, <span class="hljs-string">""</span>).<span class="hljs-title function_ invoke__">to_lowercase</span>();
    <span class="hljs-keyword">if</span> s.<span class="hljs-title function_ invoke__">len</span>() != <span class="hljs-number">12</span> || s.<span class="hljs-title function_ invoke__">chars</span>().<span class="hljs-title function_ invoke__">any</span>(|c| !c.<span class="hljs-title function_ invoke__">is_ascii_hexdigit</span>()) {
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">Ok</span>(addr_hex) = <span class="hljs-type">u64</span>::<span class="hljs-title function_ invoke__">from_str_radix</span>(&amp;s, <span class="hljs-number">16</span>) { s = <span class="hljs-built_in">format!</span>(<span class="hljs-string">"{:012x}"</span>, addr_hex); }
        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">Ok</span>(addr_dec) = s.parse::&lt;<span class="hljs-type">u64</span>&gt;() { s = <span class="hljs-built_in">format!</span>(<span class="hljs-string">"{:012x}"</span>, addr_dec); }
    }
    list.<span class="hljs-title function_ invoke__">into_iter</span>().<span class="hljs-title function_ invoke__">find</span>(|d| d.mac == s)
}
</code></pre>
<p>为什么这么做：</p>
<ul>
<li>Windows 广播提供的是数值地址，统一转为 12 位十六进制更利于设备筛选与日志定位。</li>
<li>事件回调中尽量使用 <code>try_lock</code>，避免广播高频导致锁争用。</li>
</ul>
<p>常见坑：</p>
<ul>
<li>某些设备广播不带本地名，需允许空名称并在后续才筛掉。</li>
<li>扫描过短可能错过目标设备；根据场景调整 <code>timeout_ms</code>。</li>
</ul>
<hr/>
<h3 data-id="heading-3">连接与服务发现</h3>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">async</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">connect_and_list_services</span>(device: &amp;BleDevice) <span class="hljs-punctuation">-&gt;</span> BluetoothLEDevice {
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">addr</span> = <span class="hljs-type">u64</span>::<span class="hljs-title function_ invoke__">from_str_radix</span>(&amp;device.mac.<span class="hljs-title function_ invoke__">replace</span>(<span class="hljs-string">":"</span>, <span class="hljs-string">""</span>).<span class="hljs-title function_ invoke__">to_lowercase</span>(), <span class="hljs-number">16</span>).<span class="hljs-title function_ invoke__">unwrap</span>(); <span class="hljs-comment">// 文本 MAC → 数值地址</span>
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">dev</span> = BluetoothLEDevice::<span class="hljs-title function_ invoke__">FromBluetoothAddressAsync</span>(addr).<span class="hljs-title function_ invoke__">unwrap</span>().<span class="hljs-keyword">await</span>.<span class="hljs-title function_ invoke__">unwrap</span>(); <span class="hljs-comment">// WinRT 异步获取设备对象</span>
    <span class="hljs-comment">// 等待连接就绪：避免紧接着读服务/写 CCCD 命中未连接状态</span>
    <span class="hljs-keyword">for</span> <span class="hljs-variable">_</span> <span class="hljs-keyword">in</span> <span class="hljs-number">0</span>..<span class="hljs-number">10</span> {
        <span class="hljs-keyword">if</span> dev.<span class="hljs-title function_ invoke__">ConnectionStatus</span>().<span class="hljs-title function_ invoke__">unwrap</span>() == BluetoothConnectionStatus::Connected { <span class="hljs-keyword">break</span>; }
        tokio::time::<span class="hljs-title function_ invoke__">sleep</span>(std::time::Duration::<span class="hljs-title function_ invoke__">from_millis</span>(<span class="hljs-number">200</span>)).<span class="hljs-keyword">await</span>;
    }
    <span class="hljs-comment">// 列出服务（可选）：用于确认目标服务是否存在与刷新完成</span>
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">services</span> = dev.<span class="hljs-title function_ invoke__">GetGattServicesAsync</span>().<span class="hljs-title function_ invoke__">unwrap</span>().<span class="hljs-keyword">await</span>.<span class="hljs-title function_ invoke__">unwrap</span>();
    <span class="hljs-keyword">if</span> services.<span class="hljs-title function_ invoke__">Status</span>().<span class="hljs-title function_ invoke__">unwrap</span>() == GattCommunicationStatus::Success {
        <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">list</span> = services.<span class="hljs-title function_ invoke__">Services</span>().<span class="hljs-title function_ invoke__">unwrap</span>();
        <span class="hljs-keyword">for</span> <span class="hljs-variable">s</span> <span class="hljs-keyword">in</span> list.<span class="hljs-title function_ invoke__">into_iter</span>() { <span class="hljs-built_in">println!</span>(<span class="hljs-string">"service uuid {:?}"</span>, s.<span class="hljs-title function_ invoke__">Uuid</span>().<span class="hljs-title function_ invoke__">unwrap</span>()); }
    }
    dev
}
</code></pre>
<ul>
<li>某些设备在建立物理连接后，需要数百毫秒才进入 <code>Connected</code>；过早操作常导致不可达或读空服务。</li>
</ul>
<p>常见坑：</p>
<ul>
<li>忽略连接就绪轮询会触发后续“Unreachable”或启用通知中止（E_ABORT）。</li>
</ul>
<hr/>
<h3 data-id="heading-4">特征选择（通知/写入）</h3>
<p>按 GUID 过滤，否则枚举回退，并根据属性判定：</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">async</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">select_notify</span>(service: &amp;GattDeviceService, guid: windows::core::GUID) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">Option</span>&lt;GattCharacteristic&gt; {
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">res</span> = service.<span class="hljs-title function_ invoke__">GetCharacteristicsForUuidAsync</span>(guid).<span class="hljs-title function_ invoke__">unwrap</span>().<span class="hljs-keyword">await</span>.<span class="hljs-title function_ invoke__">unwrap</span>();
    <span class="hljs-keyword">if</span> res.<span class="hljs-title function_ invoke__">Status</span>().<span class="hljs-title function_ invoke__">unwrap</span>() == GattCommunicationStatus::Success {
        <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">list</span> = res.<span class="hljs-title function_ invoke__">Characteristics</span>().<span class="hljs-title function_ invoke__">unwrap</span>();
        <span class="hljs-keyword">for</span> <span class="hljs-variable">c</span> <span class="hljs-keyword">in</span> list.<span class="hljs-title function_ invoke__">into_iter</span>() {
            <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">props</span> = c.<span class="hljs-title function_ invoke__">CharacteristicProperties</span>().<span class="hljs-title function_ invoke__">unwrap</span>(); <span class="hljs-comment">// 判定具备 Notify 或 Indicate</span>
            <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">ok</span> = (props.<span class="hljs-number">0</span> &amp; GattCharacteristicProperties::Notify.<span class="hljs-number">0</span>) != <span class="hljs-number">0</span> || (props.<span class="hljs-number">0</span> &amp; GattCharacteristicProperties::Indicate.<span class="hljs-number">0</span>) != <span class="hljs-number">0</span>;
            <span class="hljs-keyword">if</span> ok { <span class="hljs-keyword">return</span> <span class="hljs-title function_ invoke__">Some</span>(c); }
        }
    }
    <span class="hljs-comment">// GUID 过滤失败时，枚举全部特征并匹配 GUID</span>
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">all</span> = service.<span class="hljs-title function_ invoke__">GetCharacteristicsAsync</span>().<span class="hljs-title function_ invoke__">unwrap</span>().<span class="hljs-keyword">await</span>.<span class="hljs-title function_ invoke__">unwrap</span>().<span class="hljs-title function_ invoke__">Characteristics</span>().<span class="hljs-title function_ invoke__">unwrap</span>();
    <span class="hljs-keyword">for</span> <span class="hljs-variable">c</span> <span class="hljs-keyword">in</span> all.<span class="hljs-title function_ invoke__">into_iter</span>() { <span class="hljs-keyword">if</span> c.<span class="hljs-title function_ invoke__">Uuid</span>().<span class="hljs-title function_ invoke__">unwrap</span>() == guid { <span class="hljs-keyword">return</span> <span class="hljs-title function_ invoke__">Some</span>(c); } }
    <span class="hljs-literal">None</span>
}

<span class="hljs-keyword">async</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">select_write</span>(service: &amp;GattDeviceService, guid: windows::core::GUID) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">Option</span>&lt;GattCharacteristic&gt; {
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">res</span> = service.<span class="hljs-title function_ invoke__">GetCharacteristicsForUuidAsync</span>(guid).<span class="hljs-title function_ invoke__">unwrap</span>().<span class="hljs-keyword">await</span>.<span class="hljs-title function_ invoke__">unwrap</span>();
    <span class="hljs-keyword">if</span> res.<span class="hljs-title function_ invoke__">Status</span>().<span class="hljs-title function_ invoke__">unwrap</span>() == GattCommunicationStatus::Success {
        <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">list</span> = res.<span class="hljs-title function_ invoke__">Characteristics</span>().<span class="hljs-title function_ invoke__">unwrap</span>();
        <span class="hljs-keyword">for</span> <span class="hljs-variable">c</span> <span class="hljs-keyword">in</span> list.<span class="hljs-title function_ invoke__">into_iter</span>() {
            <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">p</span> = c.<span class="hljs-title function_ invoke__">CharacteristicProperties</span>().<span class="hljs-title function_ invoke__">unwrap</span>(); <span class="hljs-comment">// 判定具备 Write 或 WriteWithoutResponse</span>
            <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">ok</span> = (p.<span class="hljs-number">0</span> &amp; GattCharacteristicProperties::Write.<span class="hljs-number">0</span>) != <span class="hljs-number">0</span> || (p.<span class="hljs-number">0</span> &amp; GattCharacteristicProperties::WriteWithoutResponse.<span class="hljs-number">0</span>) != <span class="hljs-number">0</span>;
            <span class="hljs-keyword">if</span> ok { <span class="hljs-keyword">return</span> <span class="hljs-title function_ invoke__">Some</span>(c); }
        }
    }
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">all</span> = service.<span class="hljs-title function_ invoke__">GetCharacteristicsAsync</span>().<span class="hljs-title function_ invoke__">unwrap</span>().<span class="hljs-keyword">await</span>.<span class="hljs-title function_ invoke__">unwrap</span>().<span class="hljs-title function_ invoke__">Characteristics</span>().<span class="hljs-title function_ invoke__">unwrap</span>();
    <span class="hljs-keyword">for</span> <span class="hljs-variable">c</span> <span class="hljs-keyword">in</span> all.<span class="hljs-title function_ invoke__">into_iter</span>() { <span class="hljs-keyword">if</span> c.<span class="hljs-title function_ invoke__">Uuid</span>().<span class="hljs-title function_ invoke__">unwrap</span>() == guid { <span class="hljs-keyword">return</span> <span class="hljs-title function_ invoke__">Some</span>(c); } }
    <span class="hljs-literal">None</span>
}
</code></pre>
<ul>
<li>设备端在刷新期间可能返回空列表，枚举回退能避免漏选；属性判定可避免误选不可用特征。</li>
</ul>
<p>常见坑：</p>
<ul>
<li>仅按 GUID 命中但属性不满足（无 Notify/Write），后续启用或写入会失败。</li>
</ul>
<hr/>
<h3 data-id="heading-5">启用通知（CCCD）与回调注册</h3>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">async</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">enable_notify_with_retry</span>(ch: &amp;GattCharacteristic) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">bool</span> {
    tokio::time::<span class="hljs-title function_ invoke__">sleep</span>(std::time::Duration::<span class="hljs-title function_ invoke__">from_millis</span>(<span class="hljs-number">1000</span>)).<span class="hljs-keyword">await</span>; <span class="hljs-comment">// 预延时，避开设备忙/栈刷新</span>
    <span class="hljs-keyword">for</span> <span class="hljs-variable">_</span> <span class="hljs-keyword">in</span> <span class="hljs-number">0</span>..<span class="hljs-number">3</span> {
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">Ok</span>(op) = ch.<span class="hljs-title function_ invoke__">WriteClientCharacteristicConfigurationDescriptorAsync</span>(GattClientCharacteristicConfigurationDescriptorValue::Notify) {
            <span class="hljs-keyword">if</span> <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">Ok</span>(status) = op.<span class="hljs-keyword">await</span> { <span class="hljs-keyword">if</span> status == GattCommunicationStatus::Success { <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>; } } <span class="hljs-comment">// 首选 Notify</span>
        }
        tokio::time::<span class="hljs-title function_ invoke__">sleep</span>(std::time::Duration::<span class="hljs-title function_ invoke__">from_millis</span>(<span class="hljs-number">500</span>)).<span class="hljs-keyword">await</span>;
    }
    <span class="hljs-keyword">for</span> <span class="hljs-variable">_</span> <span class="hljs-keyword">in</span> <span class="hljs-number">0</span>..<span class="hljs-number">2</span> {
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">Ok</span>(op) = ch.<span class="hljs-title function_ invoke__">WriteClientCharacteristicConfigurationDescriptorAsync</span>(GattClientCharacteristicConfigurationDescriptorValue::Indicate) {
            <span class="hljs-keyword">if</span> <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">Ok</span>(status) = op.<span class="hljs-keyword">await</span> { <span class="hljs-keyword">if</span> status == GattCommunicationStatus::Success { <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>; } } <span class="hljs-comment">// 回退 Indicate</span>
        }
        tokio::time::<span class="hljs-title function_ invoke__">sleep</span>(std::time::Duration::<span class="hljs-title function_ invoke__">from_millis</span>(<span class="hljs-number">500</span>)).<span class="hljs-keyword">await</span>;
    }
    <span class="hljs-literal">false</span>
}

<span class="hljs-keyword">fn</span> <span class="hljs-title function_">register_value_changed</span>(ch: &amp;GattCharacteristic, <span class="hljs-keyword">mut</span> on_notify: <span class="hljs-keyword">impl</span> <span class="hljs-title class_">FnMut</span>(<span class="hljs-type">Vec</span>&lt;<span class="hljs-type">u8</span>&gt;) + <span class="hljs-built_in">Send</span> + <span class="hljs-symbol">'static</span>) {
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">handler</span> = TypedEventHandler::&lt;GattCharacteristic, GattValueChangedEventArgs&gt;::<span class="hljs-title function_ invoke__">new</span>(
        <span class="hljs-keyword">move</span> |_sender: &amp;<span class="hljs-type">Option</span>&lt;GattCharacteristic&gt;, args: &amp;<span class="hljs-type">Option</span>&lt;GattValueChangedEventArgs&gt;| {
            <span class="hljs-keyword">if</span> <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">Some</span>(args) = args.<span class="hljs-title function_ invoke__">as_ref</span>() {
                <span class="hljs-keyword">if</span> <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">Ok</span>(buf) = args.<span class="hljs-title function_ invoke__">CharacteristicValue</span>() {
                    <span class="hljs-keyword">if</span> <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">Ok</span>(reader) = DataReader::<span class="hljs-title function_ invoke__">FromBuffer</span>(&amp;buf) { <span class="hljs-comment">// IBuffer → Vec&lt;u8&gt;</span>
                        <span class="hljs-keyword">if</span> <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">Ok</span>(len) = buf.<span class="hljs-title function_ invoke__">Length</span>() {
                            <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">data</span> = <span class="hljs-built_in">vec!</span>[<span class="hljs-number">0u8</span>; len <span class="hljs-keyword">as</span> <span class="hljs-type">usize</span>];
                            <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">_</span> = reader.<span class="hljs-title function_ invoke__">ReadBytes</span>(&amp;<span class="hljs-keyword">mut</span> data);
                            <span class="hljs-title function_ invoke__">on_notify</span>(data);
                        }
                    }
                }
            }
            <span class="hljs-title function_ invoke__">Ok</span>(())
        }
    );
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">_</span> = ch.<span class="hljs-title function_ invoke__">ValueChanged</span>(&amp;handler);
}
</code></pre>
<ul>
<li>Notify 不需要 ACK，实时性好；设备只支持 Indicate 时需回退。</li>
<li>IBuffer 转字节后交给上层解析，避免 WinRT 读取阻塞。</li>
</ul>
<p>常见坑：</p>
<ul>
<li>启用通知过早会被中止（E_ABORT）；加延时与重试能显著降低概率。</li>
</ul>
<hr/>
<h3 data-id="heading-6">写入（带响应优先，失败回退无响应）</h3>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">async</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">write_with_result_and_fallback</span>(ch: &amp;GattCharacteristic, data: &amp;[<span class="hljs-type">u8</span>]) <span class="hljs-punctuation">-&gt;</span> GattCommunicationStatus {
    <span class="hljs-keyword">use</span> windows::Storage::Streams::{InMemoryRandomAccessStream, DataWriter};
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">stream</span> = InMemoryRandomAccessStream::<span class="hljs-title function_ invoke__">new</span>().<span class="hljs-title function_ invoke__">unwrap</span>(); <span class="hljs-comment">// 构造内存流</span>
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">out</span> = stream.<span class="hljs-title function_ invoke__">GetOutputStreamAt</span>(<span class="hljs-number">0</span>).<span class="hljs-title function_ invoke__">unwrap</span>(); <span class="hljs-comment">// 取输出流</span>
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">writer</span> = DataWriter::<span class="hljs-title function_ invoke__">CreateDataWriter</span>(&amp;out).<span class="hljs-title function_ invoke__">unwrap</span>(); <span class="hljs-comment">// 创建写入器</span>
    writer.<span class="hljs-title function_ invoke__">WriteBytes</span>(data).<span class="hljs-title function_ invoke__">unwrap</span>(); <span class="hljs-comment">// 写入字节</span>
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">buf</span> = writer.<span class="hljs-title function_ invoke__">DetachBuffer</span>().<span class="hljs-title function_ invoke__">unwrap</span>(); <span class="hljs-comment">// 拆出 IBuffer</span>

    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">res</span> = ch.<span class="hljs-title function_ invoke__">WriteValueWithResultAsync</span>(&amp;buf).<span class="hljs-title function_ invoke__">unwrap</span>().<span class="hljs-keyword">await</span>.<span class="hljs-title function_ invoke__">unwrap</span>(); <span class="hljs-comment">// 带响应写入</span>
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">status</span> = res.<span class="hljs-title function_ invoke__">Status</span>().<span class="hljs-title function_ invoke__">unwrap</span>(); <span class="hljs-comment">// 读取通信状态（可结合 ProtocolError 定位 ATT 错误）</span>
    <span class="hljs-keyword">if</span> status != GattCommunicationStatus::Success {
        <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">fb</span> = ch.<span class="hljs-title function_ invoke__">WriteValueAsync</span>(&amp;buf).<span class="hljs-title function_ invoke__">unwrap</span>().<span class="hljs-keyword">await</span>.<span class="hljs-title function_ invoke__">unwrap</span>(); <span class="hljs-comment">// 回退：无响应写入</span>
        <span class="hljs-keyword">return</span> fb;
    }
    status
}
</code></pre>
<p>为什么这么做：</p>
<ul>
<li>带响应写可获 ATT 错码（权限/长度/不允许等）；设备仅支持无响应写时自动回退。</li>
</ul>
<p>常见坑：</p>
<ul>
<li>未加密/未配对时常见 <code>Insufficient Authentication</code>；需先建立加密会话。</li>
</ul>
<hr/>
<h3 data-id="heading-7">断开与清理（顺序至关重要）</h3>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">async</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">disconnect_cleanup</span>(dev: &amp;BluetoothLEDevice, notify_char: &amp;GattCharacteristic, token: windows::Foundation::EventRegistrationToken) {
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">_</span> = notify_char.<span class="hljs-title function_ invoke__">RemoveValueChanged</span>(token); <span class="hljs-comment">// 先移除通知事件，避免回调残留</span>
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">Ok</span>(op) = notify_char.<span class="hljs-title function_ invoke__">WriteClientCharacteristicConfigurationDescriptorAsync</span>(GattClientCharacteristicConfigurationDescriptorValue::<span class="hljs-literal">None</span>) { <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">_</span> = op.<span class="hljs-keyword">await</span>; } <span class="hljs-comment">// 关闭订阅（CCCD=None）</span>
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">Ok</span>(svc) = notify_char.<span class="hljs-title function_ invoke__">Service</span>() { <span class="hljs-keyword">if</span> <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">Ok</span>(sess) = svc.<span class="hljs-title function_ invoke__">Session</span>() { <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">_</span> = sess.<span class="hljs-title function_ invoke__">SetMaintainConnection</span>(<span class="hljs-literal">false</span>); } } <span class="hljs-comment">// 取消保持连接</span>
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">_</span> = dev.<span class="hljs-title function_ invoke__">Close</span>(); <span class="hljs-comment">// 关闭设备句柄</span>
}
</code></pre>
<ul>
<li>不正确的清理顺序会导致下次连接启用通知失败或会话不可达。</li>
</ul>
<p>常见坑：</p>
<ul>
<li>忘记 <code>RemoveValueChanged</code> 导致 ValueChanged 持有对象，写入 None 时报错。</li>
</ul>
<hr/>
<h3 data-id="heading-8">已配对设备重启的稳态策略（清理 + 重试）</h3>
<p>设备已在系统层“配对且连接”，当设备重启进入配对模式时，Windows 保留旧连接/GATT 缓存，常见错误：</p>
<ul>
<li>“notify characteristic not found”</li>
<li>“enable notify/indicate failed” 或 E_ABORT（0x80004004）</li>
</ul>
<p>建议在连接前执行 OS 级清理：</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">async</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">unpair_and_close</span>(address: <span class="hljs-type">u64</span>) {
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">dev</span> = BluetoothLEDevice::<span class="hljs-title function_ invoke__">FromBluetoothAddressAsync</span>(address).<span class="hljs-title function_ invoke__">unwrap</span>().<span class="hljs-keyword">await</span>.<span class="hljs-title function_ invoke__">unwrap</span>();
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">Ok</span>(di) = dev.<span class="hljs-title function_ invoke__">DeviceInformation</span>() {
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">Ok</span>(pairing) = di.<span class="hljs-title function_ invoke__">Pairing</span>() {
            <span class="hljs-keyword">if</span> pairing.<span class="hljs-title function_ invoke__">IsPaired</span>().<span class="hljs-title function_ invoke__">unwrap_or</span>(<span class="hljs-literal">false</span>) {
                <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">_</span> = pairing.<span class="hljs-title function_ invoke__">UnpairAsync</span>().<span class="hljs-title function_ invoke__">unwrap</span>().<span class="hljs-keyword">await</span>;
            }
        }
    }
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">_</span> = dev.<span class="hljs-title function_ invoke__">Close</span>();
    tokio::time::<span class="hljs-title function_ invoke__">sleep</span>(std::time::Duration::<span class="hljs-title function_ invoke__">from_millis</span>(<span class="hljs-number">800</span>)).<span class="hljs-keyword">await</span>;
}
</code></pre>
<p>随后再进行连接、服务发现、特征选择与 CCCD 启用，并在各步骤加入适度延时与重试。</p>
<hr/>
<h3 data-id="heading-9">组合示例：连接→订阅→发送→接收→断开</h3>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-meta">#[tokio::main]</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">main</span>() {
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">list</span> = <span class="hljs-title function_ invoke__">scan_devices</span>(<span class="hljs-number">5000</span>).<span class="hljs-keyword">await</span>;
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">dev</span> = <span class="hljs-title function_ invoke__">filter_device</span>(<span class="hljs-string">"208B37997529"</span>, list).<span class="hljs-title function_ invoke__">expect</span>(<span class="hljs-string">"device not found"</span>);

    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">addr</span> = <span class="hljs-type">u64</span>::<span class="hljs-title function_ invoke__">from_str_radix</span>(&amp;dev.mac, <span class="hljs-number">16</span>).<span class="hljs-title function_ invoke__">unwrap</span>();
    <span class="hljs-title function_ invoke__">unpair_and_close</span>(addr).<span class="hljs-keyword">await</span>; <span class="hljs-comment">// 已配对场景建议先清理</span>

    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">device</span> = <span class="hljs-title function_ invoke__">connect_and_list_services</span>(&amp;dev).<span class="hljs-keyword">await</span>;
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">service</span> = {
        <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">guid</span> = <span class="hljs-title function_ invoke__">guid_from_str</span>(<span class="hljs-string">"01000100-0000-1000-8000-009078563412"</span>);
        <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">list</span> = device.<span class="hljs-title function_ invoke__">GetGattServicesAsync</span>().<span class="hljs-title function_ invoke__">unwrap</span>().<span class="hljs-keyword">await</span>.<span class="hljs-title function_ invoke__">unwrap</span>().<span class="hljs-title function_ invoke__">Services</span>().<span class="hljs-title function_ invoke__">unwrap</span>();
        list.<span class="hljs-title function_ invoke__">into_iter</span>().<span class="hljs-title function_ invoke__">find</span>(|s| s.<span class="hljs-title function_ invoke__">Uuid</span>().<span class="hljs-title function_ invoke__">unwrap</span>() == guid).<span class="hljs-title function_ invoke__">expect</span>(<span class="hljs-string">"service not found"</span>)
    };

    tokio::time::<span class="hljs-title function_ invoke__">sleep</span>(std::time::Duration::<span class="hljs-title function_ invoke__">from_millis</span>(<span class="hljs-number">800</span>)).<span class="hljs-keyword">await</span>;
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">notify</span> = <span class="hljs-title function_ invoke__">select_notify</span>(&amp;service, <span class="hljs-title function_ invoke__">guid_from_str</span>(<span class="hljs-string">"02000200-0000-1000-8000-009178563412"</span>)).<span class="hljs-title function_ invoke__">expect</span>(<span class="hljs-string">"notify not found"</span>);
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">writec</span> = <span class="hljs-title function_ invoke__">select_write</span>(&amp;service, <span class="hljs-title function_ invoke__">guid_from_str</span>(<span class="hljs-string">"03000300-0000-1000-8000-009278563412"</span>)).<span class="hljs-title function_ invoke__">expect</span>(<span class="hljs-string">"write not found"</span>);

    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">_</span> = notify.<span class="hljs-title function_ invoke__">SetProtectionLevel</span>(GattProtectionLevel::EncryptionRequired);
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">_</span> = writec.<span class="hljs-title function_ invoke__">SetProtectionLevel</span>(GattProtectionLevel::EncryptionRequired);

    <span class="hljs-keyword">if</span> !<span class="hljs-title function_ invoke__">enable_notify_with_retry</span>(&amp;notify).<span class="hljs-keyword">await</span> { <span class="hljs-built_in">panic!</span>(<span class="hljs-string">"enable notify failed"</span>); }
    <span class="hljs-title function_ invoke__">register_value_changed</span>(&amp;notify, |data| { <span class="hljs-built_in">println!</span>(<span class="hljs-string">"notify: {} bytes"</span>, data.<span class="hljs-title function_ invoke__">len</span>()); });

    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">payload</span> = <span class="hljs-string">b"example payload"</span>;
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">status</span> = <span class="hljs-title function_ invoke__">write_with_result_and_fallback</span>(&amp;writec, payload).<span class="hljs-keyword">await</span>;
    <span class="hljs-built_in">println!</span>(<span class="hljs-string">"write status: {:?}"</span>, status);

    <span class="hljs-comment">// 清理</span>
    <span class="hljs-comment">// 注意：真实项目中保存 ValueChanged 注册的 token，并在断开时传入</span>
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">dummy_token</span> = windows::Foundation::EventRegistrationToken { value: <span class="hljs-number">0</span> };
    <span class="hljs-title function_ invoke__">disconnect_cleanup</span>(&amp;device, &amp;notify, dummy_token).<span class="hljs-keyword">await</span>;
}
</code></pre>
<hr/>
<h3 data-id="heading-10">故障排查与最佳实践</h3>
<ul>
<li>WinRT await 与并发：将涉及 WinRT await 的代码放到阻塞线程或在当前线程执行，避免 <code>Send</code> 约束问题</li>
<li>连接就绪：轮询 <code>BluetoothConnectionStatus::Connected</code> 再进行特征与 CCCD 操作</li>
<li>特征与 CCCD：获取服务后延时、特征选择重试；CCCD 启用延时、Notify→Indicate 回退；必要时重新抓取一次特征再启用</li>
<li>已配对设备重启：务必先执行 <code>UnpairAsync + Close + 延时</code> 再连接，显著降低缓存不一致导致的失败</li>
<li>断开顺序：移除事件→CCCD=None→取消保持连接→Close 设备；不当的顺序会让下次连接启用通知失败</li>
</ul>
<hr/>
<h3 data-id="heading-11">小结</h3>
<p>本文给出了一套完整的、可直接复制的 Windows BLE 开发代码片段与操作步骤，涵盖扫描、连接与服务发现、特征选择、启用通知、写入与接收、断开清理，以及已配对设备重启场景的稳态策略。将这些片段按需组合，即可搭建稳定的 BLE 通信链路。</p>
<hr/>
<h3 data-id="heading-12">带详注的代码片段（逐行说明）</h3>
<h4 data-id="heading-13">1) 扫描与筛选（详注版）</h4>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">use</span> windows::{
    core::<span class="hljs-type">Result</span> <span class="hljs-keyword">as</span> WinResult,
    Devices::Bluetooth::Advertisement::{
        BluetoothLEAdvertisementWatcher, BluetoothLEAdvertisementReceivedEventArgs,
    },
    Foundation::TypedEventHandler,
};
<span class="hljs-keyword">use</span> std::{collections::HashMap, sync::Arc, time::Duration};
<span class="hljs-keyword">use</span> tokio::sync::Mutex <span class="hljs-keyword">as</span> AsyncMutex;

<span class="hljs-meta">#[derive(Debug, Clone)]</span>
<span class="hljs-keyword">struct</span> <span class="hljs-title class_">BleDevice</span> { mac: <span class="hljs-type">String</span>, name: <span class="hljs-type">String</span>, rssi: <span class="hljs-type">Option</span>&lt;<span class="hljs-type">i16</span>&gt; }

<span class="hljs-comment">// 扫描指定时长，聚合设备到列表</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">scan_devices</span>(timeout_ms: <span class="hljs-type">u64</span>) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">Vec</span>&lt;BleDevice&gt; {
    <span class="hljs-comment">// 使用共享 HashMap 聚合：Windows 广播给出的是 64 位地址（非文本 MAC）</span>
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">map</span> = Arc::<span class="hljs-title function_ invoke__">new</span>(AsyncMutex::<span class="hljs-title function_ invoke__">new</span>(HashMap::&lt;<span class="hljs-type">u64</span>, BleDevice&gt;::<span class="hljs-title function_ invoke__">new</span>()));

    <span class="hljs-comment">// 创建广播监听器</span>
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">watcher</span> = BluetoothLEAdvertisementWatcher::<span class="hljs-title function_ invoke__">new</span>().<span class="hljs-title function_ invoke__">unwrap</span>();
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">map_cb</span> = map.<span class="hljs-title function_ invoke__">clone</span>();

    <span class="hljs-comment">// 注册接收事件：每条广播中提取地址、设备名与 RSSI</span>
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">_token</span> = watcher.<span class="hljs-title function_ invoke__">Received</span>(&amp;TypedEventHandler::<span class="hljs-title function_ invoke__">new</span>(
        <span class="hljs-keyword">move</span> |_sender: &amp;<span class="hljs-type">Option</span>&lt;BluetoothLEAdvertisementWatcher&gt;, args: &amp;<span class="hljs-type">Option</span>&lt;BluetoothLEAdvertisementReceivedEventArgs&gt;| <span class="hljs-punctuation">-&gt;</span> WinResult&lt;()&gt; {
            <span class="hljs-keyword">if</span> <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">Some</span>(args) = args.<span class="hljs-title function_ invoke__">as_ref</span>() {
                <span class="hljs-comment">// 设备地址为 64 位整型，转为 12 位十六进制字符串（不含分隔符）</span>
                <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">addr</span> = args.<span class="hljs-title function_ invoke__">BluetoothAddress</span>()?;
                <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">mac</span> = <span class="hljs-built_in">format!</span>(
                    <span class="hljs-string">"{:02x}{:02x}{:02x}{:02x}{:02x}{:02x}"</span>,
                    (addr &gt;&gt; <span class="hljs-number">40</span>) &amp; <span class="hljs-number">0xff</span>, (addr &gt;&gt; <span class="hljs-number">32</span>) &amp; <span class="hljs-number">0xff</span>, (addr &gt;&gt; <span class="hljs-number">24</span>) &amp; <span class="hljs-number">0xff</span>,
                    (addr &gt;&gt; <span class="hljs-number">16</span>) &amp; <span class="hljs-number">0xff</span>, (addr &gt;&gt; <span class="hljs-number">8</span>) &amp; <span class="hljs-number">0xff</span>, addr &amp; <span class="hljs-number">0xff</span>
                );
                <span class="hljs-comment">// 广告包中的本地名</span>
                <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">name</span> = args.<span class="hljs-title function_ invoke__">Advertisement</span>()?.<span class="hljs-title function_ invoke__">LocalName</span>()?.<span class="hljs-title function_ invoke__">to_string</span>();
                <span class="hljs-comment">// 信号强度（可能不存在）</span>
                <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">rssi</span> = args.<span class="hljs-title function_ invoke__">RawSignalStrengthInDBm</span>()?;

                <span class="hljs-comment">// 聚合到共享表：若已有记录则更新更有价值的信息（非空名称、最新 RSSI）</span>
                <span class="hljs-keyword">if</span> <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">Ok</span>(<span class="hljs-keyword">mut</span> m) = map_cb.<span class="hljs-title function_ invoke__">try_lock</span>() {
                    m.<span class="hljs-title function_ invoke__">entry</span>(addr)
                        .<span class="hljs-title function_ invoke__">and_modify</span>(|d| { <span class="hljs-keyword">if</span> d.name.<span class="hljs-title function_ invoke__">is_empty</span>() &amp;&amp; !name.<span class="hljs-title function_ invoke__">is_empty</span>() { d.name = name.<span class="hljs-title function_ invoke__">clone</span>(); } d.rssi = <span class="hljs-title function_ invoke__">Some</span>(rssi); })
                        .<span class="hljs-title function_ invoke__">or_insert</span>(BleDevice { mac, name, rssi: <span class="hljs-title function_ invoke__">Some</span>(rssi) });
                }
            }
            <span class="hljs-title function_ invoke__">Ok</span>(())
        }
    )).<span class="hljs-title function_ invoke__">unwrap</span>();

    <span class="hljs-comment">// 开始监听指定时间窗口</span>
    watcher.<span class="hljs-title function_ invoke__">Start</span>().<span class="hljs-title function_ invoke__">unwrap</span>();
    tokio::time::<span class="hljs-title function_ invoke__">sleep</span>(Duration::<span class="hljs-title function_ invoke__">from_millis</span>(timeout_ms)).<span class="hljs-keyword">await</span>;
    watcher.<span class="hljs-title function_ invoke__">Stop</span>().<span class="hljs-title function_ invoke__">unwrap</span>();

    <span class="hljs-comment">// 收敛为列表并按 MAC 排序，过滤空名称</span>
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">locked</span> = map.<span class="hljs-title function_ invoke__">lock</span>().<span class="hljs-keyword">await</span>;
    <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">list</span>: <span class="hljs-type">Vec</span>&lt;_&gt; = locked.<span class="hljs-title function_ invoke__">values</span>().<span class="hljs-title function_ invoke__">cloned</span>().<span class="hljs-title function_ invoke__">filter</span>(|d| !d.name.<span class="hljs-title function_ invoke__">is_empty</span>()).<span class="hljs-title function_ invoke__">collect</span>();
    list.<span class="hljs-title function_ invoke__">sort_by_key</span>(|d| d.mac.<span class="hljs-title function_ invoke__">clone</span>());
    list
}

<span class="hljs-comment">// 按 MAC 文本筛选设备：支持去分隔符与大小写统一，兼容十六/十进制</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">filter_device</span>(mac: &amp;<span class="hljs-type">str</span>, list: <span class="hljs-type">Vec</span>&lt;BleDevice&gt;) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">Option</span>&lt;BleDevice&gt; {
    <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">s</span> = mac.<span class="hljs-title function_ invoke__">replace</span>(<span class="hljs-string">":"</span>, <span class="hljs-string">""</span>).<span class="hljs-title function_ invoke__">replace</span>(<span class="hljs-string">'-'</span>, <span class="hljs-string">""</span>).<span class="hljs-title function_ invoke__">to_lowercase</span>();
    <span class="hljs-keyword">if</span> s.<span class="hljs-title function_ invoke__">len</span>() != <span class="hljs-number">12</span> || s.<span class="hljs-title function_ invoke__">chars</span>().<span class="hljs-title function_ invoke__">any</span>(|c| !c.<span class="hljs-title function_ invoke__">is_ascii_hexdigit</span>()) {
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">Ok</span>(addr_hex) = <span class="hljs-type">u64</span>::<span class="hljs-title function_ invoke__">from_str_radix</span>(&amp;s, <span class="hljs-number">16</span>) { s = <span class="hljs-built_in">format!</span>(<span class="hljs-string">"{:012x}"</span>, addr_hex); }
        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">Ok</span>(addr_dec) = s.parse::&lt;<span class="hljs-type">u64</span>&gt;() { s = <span class="hljs-built_in">format!</span>(<span class="hljs-string">"{:012x}"</span>, addr_dec); }
    }
    list.<span class="hljs-title function_ invoke__">into_iter</span>().<span class="hljs-title function_ invoke__">find</span>(|d| d.mac == s)
}
</code></pre>
<h4 data-id="heading-14">2) 连接与服务发现（详注版）</h4>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">use</span> windows::Devices::Bluetooth::{BluetoothLEDevice, BluetoothConnectionStatus};
<span class="hljs-keyword">use</span> windows::Devices::Bluetooth::GenericAttributeProfile::{GattCommunicationStatus};

<span class="hljs-comment">// 建立到设备的连接，并打印服务列表（用于诊断）</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">connect_and_list_services</span>(device: &amp;BleDevice) <span class="hljs-punctuation">-&gt;</span> BluetoothLEDevice {
    <span class="hljs-comment">// 文本 MAC → 64 位地址（十六进制解析）</span>
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">addr</span> = <span class="hljs-type">u64</span>::<span class="hljs-title function_ invoke__">from_str_radix</span>(&amp;device.mac.<span class="hljs-title function_ invoke__">replace</span>(<span class="hljs-string">":"</span>, <span class="hljs-string">""</span>).<span class="hljs-title function_ invoke__">to_lowercase</span>(), <span class="hljs-number">16</span>).<span class="hljs-title function_ invoke__">unwrap</span>();
    <span class="hljs-comment">// 异步获取设备对象（WinRT）</span>
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">dev</span> = BluetoothLEDevice::<span class="hljs-title function_ invoke__">FromBluetoothAddressAsync</span>(addr).<span class="hljs-title function_ invoke__">unwrap</span>().<span class="hljs-keyword">await</span>.<span class="hljs-title function_ invoke__">unwrap</span>();

    <span class="hljs-comment">// 连接就绪等待：部分设备需要一点时间进入 Connected 状态</span>
    <span class="hljs-keyword">for</span> <span class="hljs-variable">_</span> <span class="hljs-keyword">in</span> <span class="hljs-number">0</span>..<span class="hljs-number">10</span> {
        <span class="hljs-keyword">if</span> dev.<span class="hljs-title function_ invoke__">ConnectionStatus</span>().<span class="hljs-title function_ invoke__">unwrap</span>() == BluetoothConnectionStatus::Connected { <span class="hljs-keyword">break</span>; }
        tokio::time::<span class="hljs-title function_ invoke__">sleep</span>(std::time::Duration::<span class="hljs-title function_ invoke__">from_millis</span>(<span class="hljs-number">200</span>)).<span class="hljs-keyword">await</span>;
    }

    <span class="hljs-comment">// 枚举 GATT 服务并打印 UUID（便于确认服务是否刷新与存在）</span>
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">services</span> = dev.<span class="hljs-title function_ invoke__">GetGattServicesAsync</span>().<span class="hljs-title function_ invoke__">unwrap</span>().<span class="hljs-keyword">await</span>.<span class="hljs-title function_ invoke__">unwrap</span>();
    <span class="hljs-keyword">if</span> services.<span class="hljs-title function_ invoke__">Status</span>().<span class="hljs-title function_ invoke__">unwrap</span>() == GattCommunicationStatus::Success {
        <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">list</span> = services.<span class="hljs-title function_ invoke__">Services</span>().<span class="hljs-title function_ invoke__">unwrap</span>();
        <span class="hljs-keyword">for</span> <span class="hljs-variable">s</span> <span class="hljs-keyword">in</span> list.<span class="hljs-title function_ invoke__">into_iter</span>() { <span class="hljs-built_in">println!</span>(<span class="hljs-string">"service uuid {:?}"</span>, s.<span class="hljs-title function_ invoke__">Uuid</span>().<span class="hljs-title function_ invoke__">unwrap</span>()); }
    }
    dev
}
</code></pre>
<h4 data-id="heading-15">3) 特征选择（详注版）</h4>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">use</span> windows::Devices::Bluetooth::GenericAttributeProfile::{
    GattDeviceService, GattCharacteristic, GattCharacteristicProperties, GattCommunicationStatus,
};

<span class="hljs-comment">// 选择通知特征：先 GUID 过滤 + 按属性检查；失败枚举全部回退</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">select_notify</span>(service: &amp;GattDeviceService, guid: windows::core::GUID) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">Option</span>&lt;GattCharacteristic&gt; {
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">res</span> = service.<span class="hljs-title function_ invoke__">GetCharacteristicsForUuidAsync</span>(guid).<span class="hljs-title function_ invoke__">unwrap</span>().<span class="hljs-keyword">await</span>.<span class="hljs-title function_ invoke__">unwrap</span>();
    <span class="hljs-keyword">if</span> res.<span class="hljs-title function_ invoke__">Status</span>().<span class="hljs-title function_ invoke__">unwrap</span>() == GattCommunicationStatus::Success {
        <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">list</span> = res.<span class="hljs-title function_ invoke__">Characteristics</span>().<span class="hljs-title function_ invoke__">unwrap</span>();
        <span class="hljs-keyword">for</span> <span class="hljs-variable">c</span> <span class="hljs-keyword">in</span> list.<span class="hljs-title function_ invoke__">into_iter</span>() {
            <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">props</span> = c.<span class="hljs-title function_ invoke__">CharacteristicProperties</span>().<span class="hljs-title function_ invoke__">unwrap</span>();
            <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">ok</span> = (props.<span class="hljs-number">0</span> &amp; GattCharacteristicProperties::Notify.<span class="hljs-number">0</span>) != <span class="hljs-number">0</span> || (props.<span class="hljs-number">0</span> &amp; GattCharacteristicProperties::Indicate.<span class="hljs-number">0</span>) != <span class="hljs-number">0</span>;
            <span class="hljs-keyword">if</span> ok { <span class="hljs-keyword">return</span> <span class="hljs-title function_ invoke__">Some</span>(c); }
        }
    }
    <span class="hljs-comment">// 枚举回退：某些设备在刷新期间 GUID 过滤可能返回空</span>
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">all</span> = service.<span class="hljs-title function_ invoke__">GetCharacteristicsAsync</span>().<span class="hljs-title function_ invoke__">unwrap</span>().<span class="hljs-keyword">await</span>.<span class="hljs-title function_ invoke__">unwrap</span>().<span class="hljs-title function_ invoke__">Characteristics</span>().<span class="hljs-title function_ invoke__">unwrap</span>();
    <span class="hljs-keyword">for</span> <span class="hljs-variable">c</span> <span class="hljs-keyword">in</span> all.<span class="hljs-title function_ invoke__">into_iter</span>() { <span class="hljs-keyword">if</span> c.<span class="hljs-title function_ invoke__">Uuid</span>().<span class="hljs-title function_ invoke__">unwrap</span>() == guid { <span class="hljs-keyword">return</span> <span class="hljs-title function_ invoke__">Some</span>(c); } }
    <span class="hljs-literal">None</span>
}

<span class="hljs-comment">// 选择写特征：同理，需具备 Write 或 WriteWithoutResponse 属性</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">select_write</span>(service: &amp;GattDeviceService, guid: windows::core::GUID) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">Option</span>&lt;GattCharacteristic&gt; {
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">res</span> = service.<span class="hljs-title function_ invoke__">GetCharacteristicsForUuidAsync</span>(guid).<span class="hljs-title function_ invoke__">unwrap</span>().<span class="hljs-keyword">await</span>.<span class="hljs-title function_ invoke__">unwrap</span>();
    <span class="hljs-keyword">if</span> res.<span class="hljs-title function_ invoke__">Status</span>().<span class="hljs-title function_ invoke__">unwrap</span>() == GattCommunicationStatus::Success {
        <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">list</span> = res.<span class="hljs-title function_ invoke__">Characteristics</span>().<span class="hljs-title function_ invoke__">unwrap</span>();
        <span class="hljs-keyword">for</span> <span class="hljs-variable">c</span> <span class="hljs-keyword">in</span> list.<span class="hljs-title function_ invoke__">into_iter</span>() {
            <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">p</span> = c.<span class="hljs-title function_ invoke__">CharacteristicProperties</span>().<span class="hljs-title function_ invoke__">unwrap</span>();
            <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">ok</span> = (p.<span class="hljs-number">0</span> &amp; GattCharacteristicProperties::Write.<span class="hljs-number">0</span>) != <span class="hljs-number">0</span> || (p.<span class="hljs-number">0</span> &amp; GattCharacteristicProperties::WriteWithoutResponse.<span class="hljs-number">0</span>) != <span class="hljs-number">0</span>;
            <span class="hljs-keyword">if</span> ok { <span class="hljs-keyword">return</span> <span class="hljs-title function_ invoke__">Some</span>(c); }
        }
    }
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">all</span> = service.<span class="hljs-title function_ invoke__">GetCharacteristicsAsync</span>().<span class="hljs-title function_ invoke__">unwrap</span>().<span class="hljs-keyword">await</span>.<span class="hljs-title function_ invoke__">unwrap</span>().<span class="hljs-title function_ invoke__">Characteristics</span>().<span class="hljs-title function_ invoke__">unwrap</span>();
    <span class="hljs-keyword">for</span> <span class="hljs-variable">c</span> <span class="hljs-keyword">in</span> all.<span class="hljs-title function_ invoke__">into_iter</span>() { <span class="hljs-keyword">if</span> c.<span class="hljs-title function_ invoke__">Uuid</span>().<span class="hljs-title function_ invoke__">unwrap</span>() == guid { <span class="hljs-keyword">return</span> <span class="hljs-title function_ invoke__">Some</span>(c); } }
    <span class="hljs-literal">None</span>
}
</code></pre>
<h4 data-id="heading-16">4) 启用通知与注册回调（详注版）</h4>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">use</span> windows::Devices::Bluetooth::GenericAttributeProfile::{
    GattCharacteristic, GattClientCharacteristicConfigurationDescriptorValue, GattCommunicationStatus,
};
<span class="hljs-keyword">use</span> windows::Devices::Bluetooth::GenericAttributeProfile::{GattValueChangedEventArgs};
<span class="hljs-keyword">use</span> windows::Storage::Streams::DataReader;
<span class="hljs-keyword">use</span> windows::Foundation::TypedEventHandler;

<span class="hljs-comment">// 启用通知：优先 Notify，失败回退 Indicate；加入预延时与重试以跨过设备刷新窗口</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">enable_notify_with_retry</span>(ch: &amp;GattCharacteristic) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">bool</span> {
    <span class="hljs-comment">// 预延时：避免立即写 CCCD 命中设备忙或栈刷新</span>
    tokio::time::<span class="hljs-title function_ invoke__">sleep</span>(std::time::Duration::<span class="hljs-title function_ invoke__">from_millis</span>(<span class="hljs-number">1000</span>)).<span class="hljs-keyword">await</span>;
    <span class="hljs-comment">// 尝试 Notify 多次</span>
    <span class="hljs-keyword">for</span> <span class="hljs-variable">_</span> <span class="hljs-keyword">in</span> <span class="hljs-number">0</span>..<span class="hljs-number">3</span> {
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">Ok</span>(op) = ch.<span class="hljs-title function_ invoke__">WriteClientCharacteristicConfigurationDescriptorAsync</span>(GattClientCharacteristicConfigurationDescriptorValue::Notify) {
            <span class="hljs-keyword">if</span> <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">Ok</span>(status) = op.<span class="hljs-keyword">await</span> { <span class="hljs-keyword">if</span> status == GattCommunicationStatus::Success { <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>; } }
        }
        tokio::time::<span class="hljs-title function_ invoke__">sleep</span>(std::time::Duration::<span class="hljs-title function_ invoke__">from_millis</span>(<span class="hljs-number">500</span>)).<span class="hljs-keyword">await</span>;
    }
    <span class="hljs-comment">// 回退 Indicate</span>
    <span class="hljs-keyword">for</span> <span class="hljs-variable">_</span> <span class="hljs-keyword">in</span> <span class="hljs-number">0</span>..<span class="hljs-number">2</span> {
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">Ok</span>(op) = ch.<span class="hljs-title function_ invoke__">WriteClientCharacteristicConfigurationDescriptorAsync</span>(GattClientCharacteristicConfigurationDescriptorValue::Indicate) {
            <span class="hljs-keyword">if</span> <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">Ok</span>(status) = op.<span class="hljs-keyword">await</span> { <span class="hljs-keyword">if</span> status == GattCommunicationStatus::Success { <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>; } }
        }
        tokio::time::<span class="hljs-title function_ invoke__">sleep</span>(std::time::Duration::<span class="hljs-title function_ invoke__">from_millis</span>(<span class="hljs-number">500</span>)).<span class="hljs-keyword">await</span>;
    }
    <span class="hljs-literal">false</span>
}

<span class="hljs-comment">// 注册通知回调：将 IBuffer 转为 Vec&lt;u8&gt; 并交给调用者处理</span>
<span class="hljs-keyword">fn</span> <span class="hljs-title function_">register_value_changed</span>(ch: &amp;GattCharacteristic, <span class="hljs-keyword">mut</span> on_notify: <span class="hljs-keyword">impl</span> <span class="hljs-title class_">FnMut</span>(<span class="hljs-type">Vec</span>&lt;<span class="hljs-type">u8</span>&gt;) + <span class="hljs-built_in">Send</span> + <span class="hljs-symbol">'static</span>) {
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">handler</span> = TypedEventHandler::&lt;GattCharacteristic, GattValueChangedEventArgs&gt;::<span class="hljs-title function_ invoke__">new</span>(
        <span class="hljs-keyword">move</span> |_sender: &amp;<span class="hljs-type">Option</span>&lt;GattCharacteristic&gt;, args: &amp;<span class="hljs-type">Option</span>&lt;GattValueChangedEventArgs&gt;| {
            <span class="hljs-keyword">if</span> <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">Some</span>(args) = args.<span class="hljs-title function_ invoke__">as_ref</span>() {
                <span class="hljs-keyword">if</span> <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">Ok</span>(buf) = args.<span class="hljs-title function_ invoke__">CharacteristicValue</span>() {
                    <span class="hljs-keyword">if</span> <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">Ok</span>(reader) = DataReader::<span class="hljs-title function_ invoke__">FromBuffer</span>(&amp;buf) {
                        <span class="hljs-keyword">if</span> <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">Ok</span>(len) = buf.<span class="hljs-title function_ invoke__">Length</span>() {
                            <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">data</span> = <span class="hljs-built_in">vec!</span>[<span class="hljs-number">0u8</span>; len <span class="hljs-keyword">as</span> <span class="hljs-type">usize</span>];
                            <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">_</span> = reader.<span class="hljs-title function_ invoke__">ReadBytes</span>(&amp;<span class="hljs-keyword">mut</span> data);
                            <span class="hljs-title function_ invoke__">on_notify</span>(data);
                        }
                    }
                }
            }
            <span class="hljs-title function_ invoke__">Ok</span>(())
        }
    );
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">_</span> = ch.<span class="hljs-title function_ invoke__">ValueChanged</span>(&amp;handler);
}
</code></pre>
<h4 data-id="heading-17">5) 写入（详注版）</h4>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">use</span> windows::Devices::Bluetooth::GenericAttributeProfile::{GattCharacteristic, GattCommunicationStatus};
<span class="hljs-keyword">use</span> windows::Storage::Streams::{InMemoryRandomAccessStream, DataWriter};

<span class="hljs-comment">// 写入封装：优先带响应写入（便于获取协议错误），失败回退无响应</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">write_with_result_and_fallback</span>(ch: &amp;GattCharacteristic, data: &amp;[<span class="hljs-type">u8</span>]) <span class="hljs-punctuation">-&gt;</span> GattCommunicationStatus {
    <span class="hljs-comment">// WinRT 写入 API 需要 IBuffer；这里通过内存流 + DataWriter 构造缓冲区</span>
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">stream</span> = InMemoryRandomAccessStream::<span class="hljs-title function_ invoke__">new</span>().<span class="hljs-title function_ invoke__">unwrap</span>();
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">out</span> = stream.<span class="hljs-title function_ invoke__">GetOutputStreamAt</span>(<span class="hljs-number">0</span>).<span class="hljs-title function_ invoke__">unwrap</span>();
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">writer</span> = DataWriter::<span class="hljs-title function_ invoke__">CreateDataWriter</span>(&amp;out).<span class="hljs-title function_ invoke__">unwrap</span>();
    writer.<span class="hljs-title function_ invoke__">WriteBytes</span>(data).<span class="hljs-title function_ invoke__">unwrap</span>();
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">buf</span> = writer.<span class="hljs-title function_ invoke__">DetachBuffer</span>().<span class="hljs-title function_ invoke__">unwrap</span>();

    <span class="hljs-comment">// 带响应写入：可读取状态与协议错误码（ATT），便于定位权限或长度问题</span>
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">res</span> = ch.<span class="hljs-title function_ invoke__">WriteValueWithResultAsync</span>(&amp;buf).<span class="hljs-title function_ invoke__">unwrap</span>().<span class="hljs-keyword">await</span>.<span class="hljs-title function_ invoke__">unwrap</span>();
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">status</span> = res.<span class="hljs-title function_ invoke__">Status</span>().<span class="hljs-title function_ invoke__">unwrap</span>();
    <span class="hljs-keyword">if</span> status != GattCommunicationStatus::Success {
        <span class="hljs-comment">// 回退为无响应写：部分设备仅允许无响应写</span>
        <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">fb</span> = ch.<span class="hljs-title function_ invoke__">WriteValueAsync</span>(&amp;buf).<span class="hljs-title function_ invoke__">unwrap</span>().<span class="hljs-keyword">await</span>.<span class="hljs-title function_ invoke__">unwrap</span>();
        <span class="hljs-keyword">return</span> fb;
    }
    status
}
</code></pre>
<h4 data-id="heading-18">6) 断开与清理（详注版）</h4>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">use</span> windows::Devices::Bluetooth::BluetoothLEDevice;
<span class="hljs-keyword">use</span> windows::Devices::Bluetooth::GenericAttributeProfile::{GattCharacteristic, GattClientCharacteristicConfigurationDescriptorValue};

<span class="hljs-comment">// 断开顺序：RemoveValueChanged → CCCD=None → MaintainConnection(false) → Close</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">disconnect_cleanup</span>(dev: &amp;BluetoothLEDevice, notify_char: &amp;GattCharacteristic, token: windows::Foundation::EventRegistrationToken) {
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">_</span> = notify_char.<span class="hljs-title function_ invoke__">RemoveValueChanged</span>(token);
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">Ok</span>(op) = notify_char.<span class="hljs-title function_ invoke__">WriteClientCharacteristicConfigurationDescriptorAsync</span>(GattClientCharacteristicConfigurationDescriptorValue::<span class="hljs-literal">None</span>) { <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">_</span> = op.<span class="hljs-keyword">await</span>; }
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">Ok</span>(svc) = notify_char.<span class="hljs-title function_ invoke__">Service</span>() { <span class="hljs-keyword">if</span> <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">Ok</span>(sess) = svc.<span class="hljs-title function_ invoke__">Session</span>() { <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">_</span> = sess.<span class="hljs-title function_ invoke__">SetMaintainConnection</span>(<span class="hljs-literal">false</span>); } }
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">_</span> = dev.<span class="hljs-title function_ invoke__">Close</span>();
}
</code></pre>
<h4 data-id="heading-19">7) 已配对设备重启的清理（详注版）</h4>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">use</span> windows::Devices::Bluetooth::BluetoothLEDevice;

<span class="hljs-comment">// 在已配对且系统持有旧连接的情况下：先 Unpair + Close 再连接，降低缓存不一致导致的失败</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">unpair_and_close</span>(address: <span class="hljs-type">u64</span>) {
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">dev</span> = BluetoothLEDevice::<span class="hljs-title function_ invoke__">FromBluetoothAddressAsync</span>(address).<span class="hljs-title function_ invoke__">unwrap</span>().<span class="hljs-keyword">await</span>.<span class="hljs-title function_ invoke__">unwrap</span>();
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">Ok</span>(di) = dev.<span class="hljs-title function_ invoke__">DeviceInformation</span>() {
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">Ok</span>(pairing) = di.<span class="hljs-title function_ invoke__">Pairing</span>() {
            <span class="hljs-keyword">if</span> pairing.<span class="hljs-title function_ invoke__">IsPaired</span>().<span class="hljs-title function_ invoke__">unwrap_or</span>(<span class="hljs-literal">false</span>) {
                <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">_</span> = pairing.<span class="hljs-title function_ invoke__">UnpairAsync</span>().<span class="hljs-title function_ invoke__">unwrap</span>().<span class="hljs-keyword">await</span>; <span class="hljs-comment">// 解除配对，释放旧权限与密钥</span>
            }
        }
    }
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">_</span> = dev.<span class="hljs-title function_ invoke__">Close</span>(); <span class="hljs-comment">// 关闭旧设备句柄</span>
    tokio::time::<span class="hljs-title function_ invoke__">sleep</span>(std::time::Duration::<span class="hljs-title function_ invoke__">from_millis</span>(<span class="hljs-number">800</span>)).<span class="hljs-keyword">await</span>; <span class="hljs-comment">// 等待栈刷新</span>
}
</code></pre>
<h4 data-id="heading-20">8) 组合流程（详注版）</h4>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-meta">#[tokio::main]</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">main</span>() {
    <span class="hljs-comment">// 1) 扫描并选择目标设备</span>
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">list</span> = <span class="hljs-title function_ invoke__">scan_devices</span>(<span class="hljs-number">5000</span>).<span class="hljs-keyword">await</span>;
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">dev</span> = <span class="hljs-title function_ invoke__">filter_device</span>(<span class="hljs-string">"208B37997529"</span>, list).<span class="hljs-title function_ invoke__">expect</span>(<span class="hljs-string">"device not found"</span>);

    <span class="hljs-comment">// 2) 已配对场景建议先清理旧状态（Unpair + Close + 延时）</span>
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">addr</span> = <span class="hljs-type">u64</span>::<span class="hljs-title function_ invoke__">from_str_radix</span>(&amp;dev.mac, <span class="hljs-number">16</span>).<span class="hljs-title function_ invoke__">unwrap</span>();
    <span class="hljs-title function_ invoke__">unpair_and_close</span>(addr).<span class="hljs-keyword">await</span>;

    <span class="hljs-comment">// 3) 连接并输出服务列表（诊断用途）</span>
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">device</span> = <span class="hljs-title function_ invoke__">connect_and_list_services</span>(&amp;dev).<span class="hljs-keyword">await</span>;

    <span class="hljs-comment">// 4) 获取目标服务（按 GUID 匹配）</span>
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">service</span> = {
        <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">guid</span> = <span class="hljs-title function_ invoke__">guid_from_str</span>(<span class="hljs-string">"01000100-0000-1000-8000-009078563412"</span>);
        <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">list</span> = device.<span class="hljs-title function_ invoke__">GetGattServicesAsync</span>().<span class="hljs-title function_ invoke__">unwrap</span>().<span class="hljs-keyword">await</span>.<span class="hljs-title function_ invoke__">unwrap</span>().<span class="hljs-title function_ invoke__">Services</span>().<span class="hljs-title function_ invoke__">unwrap</span>();
        list.<span class="hljs-title function_ invoke__">into_iter</span>().<span class="hljs-title function_ invoke__">find</span>(|s| s.<span class="hljs-title function_ invoke__">Uuid</span>().<span class="hljs-title function_ invoke__">unwrap</span>() == guid).<span class="hljs-title function_ invoke__">expect</span>(<span class="hljs-string">"service not found"</span>)
    };

    <span class="hljs-comment">// 5) 特征选择前短暂等待，随后选择通知与写特征</span>
    tokio::time::<span class="hljs-title function_ invoke__">sleep</span>(std::time::Duration::<span class="hljs-title function_ invoke__">from_millis</span>(<span class="hljs-number">800</span>)).<span class="hljs-keyword">await</span>;
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">notify</span> = <span class="hljs-title function_ invoke__">select_notify</span>(&amp;service, <span class="hljs-title function_ invoke__">guid_from_str</span>(<span class="hljs-string">"02000200-0000-1000-8000-009178563412"</span>)).<span class="hljs-title function_ invoke__">expect</span>(<span class="hljs-string">"notify not found"</span>);
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">writec</span> = <span class="hljs-title function_ invoke__">select_write</span>(&amp;service, <span class="hljs-title function_ invoke__">guid_from_str</span>(<span class="hljs-string">"03000300-0000-1000-8000-009278563412"</span>)).<span class="hljs-title function_ invoke__">expect</span>(<span class="hljs-string">"write not found"</span>);

    <span class="hljs-comment">// 6) 若设备要求加密，设置保护级别为加密</span>
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">_</span> = notify.<span class="hljs-title function_ invoke__">SetProtectionLevel</span>(windows::Devices::Bluetooth::GenericAttributeProfile::GattProtectionLevel::EncryptionRequired);
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">_</span> = writec.<span class="hljs-title function_ invoke__">SetProtectionLevel</span>(windows::Devices::Bluetooth::GenericAttributeProfile::GattProtectionLevel::EncryptionRequired);

    <span class="hljs-comment">// 7) 启用通知（带重试/回退），并注册通知回调</span>
    <span class="hljs-keyword">if</span> !<span class="hljs-title function_ invoke__">enable_notify_with_retry</span>(&amp;notify).<span class="hljs-keyword">await</span> { <span class="hljs-built_in">panic!</span>(<span class="hljs-string">"enable notify failed"</span>); }
    <span class="hljs-title function_ invoke__">register_value_changed</span>(&amp;notify, |data| { <span class="hljs-built_in">println!</span>(<span class="hljs-string">"notify: {} bytes"</span>, data.<span class="hljs-title function_ invoke__">len</span>()); });

    <span class="hljs-comment">// 8) 写入示例负载（带响应优先，失败回退）</span>
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">payload</span> = <span class="hljs-string">b"example payload"</span>;
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">status</span> = <span class="hljs-title function_ invoke__">write_with_result_and_fallback</span>(&amp;writec, payload).<span class="hljs-keyword">await</span>;
    <span class="hljs-built_in">println!</span>(<span class="hljs-string">"write status: {:?}"</span>, status);

    <span class="hljs-comment">// 9) 断开与清理（真实项目中保存并传入 ValueChanged 的 token）</span>
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">dummy_token</span> = windows::Foundation::EventRegistrationToken { value: <span class="hljs-number">0</span> };
    <span class="hljs-title function_ invoke__">disconnect_cleanup</span>(&amp;device, &amp;notify, dummy_token).<span class="hljs-keyword">await</span>;
}
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Flutter 图纸标注功能的实现：踩坑与架构设计]]></title>    <link>https://juejin.cn/post/7577284968922873856</link>    <guid>https://juejin.cn/post/7577284968922873856</guid>    <pubDate>2025-11-28T03:20:10.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577284968922873856" data-draft-id="7577284968922693632" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Flutter 图纸标注功能的实现：踩坑与架构设计"/> <meta itemprop="keywords" content="iOS,Android"/> <meta itemprop="datePublished" content="2025-11-28T03:20:10.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="明君87997"/> <meta itemprop="url" content="https://juejin.cn/user/413072103838462"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Flutter 图纸标注功能的实现：踩坑与架构设计
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/413072103838462/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    明君87997
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-28T03:20:10.000Z" title="Fri Nov 28 2025 03:20:10 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-28
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">写在前面</h2>
<p>最近在做一个工程验收的项目，有个需求是要在 CAD 图纸上标注问题点。一开始觉得挺简单，不就是显示个图片，点一下加个 Marker 吗？真动手做了才发现，这里面的坑多到怀疑人生。</p>
<p>比如说：</p>
<ul>
<li>工地现场网络差到爆，必须完全离线</li>
<li>图纸动辄几千像素，加载和交互都卡</li>
<li>业务逻辑一堆，担心后面没法维护</li>
<li>各种坐标系转来转去，脑壳疼</li>
</ul>
<p>折腾了两周，终于把这个东西搞定了。整个过程中踩了不少坑，也积累了一些经验，所以写篇文章记录一下，顺便分享给有类似需求的朋友。</p>
<h2 data-id="heading-1">整体思路</h2>
<p>搞这个东西之前，我先理了理需求，发现核心就是：<strong>在一张离线图纸上，支持用户点击标注，还得支持区域限制（不能乱点）</strong>。</p>
<p>听起来简单，但要做好，必须解决几个问题：</p>
<ol>
<li>**怎么让代码不和业务绑死？**毕竟这个功能不止一个地方用</li>
<li>**怎么管理状态？**标记点、多边形、图纸这些东西状态管理一团乱</li>
<li>**怎么保证性能？**大图加载、高频交互都得优化</li>
</ol>
<p>想来想去，决定按这个思路来：</p>
<pre><code class="hljs language-scss" lang="scss">CustomMapWidget (视图组件)
     ↓
CustomMapController (控制器，处理逻辑)
     ↓
CustomMapState (状态管理，响应式更新)
     ↓
MapDataSource (抽象接口，业务自己实现)
</code></pre>
<p>简单说就是：<strong>视图负责展示，控制器负责协调，状态负责响应式更新，业务逻辑通过接口注入</strong>。</p>
<p>这样的好处是，核心框架和具体业务完全解耦，换个场景只需要实现不同的 DataSource 就行。</p>
<h3 data-id="heading-2">关键设计：业务抽象层</h3>
<p>这个是整个架构的核心。我定义了一个抽象接口 <code>MapDataSource</code>：</p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-keyword">abstract</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MapDataSource</span> </span>{
  <span class="hljs-comment">// 加载图纸（可能从本地、可能从服务器）</span>
  Future&lt;MapSourceConfig&gt; loadMapDrawingResource(CrsSimple crs);
  
  <span class="hljs-comment">// 创建一个标记点（业务自己决定样式）</span>
  Marker addMarker(LatLng point, {<span class="hljs-built_in">String?</span> number});
  
  <span class="hljs-comment">// 批量加载已有的标记点</span>
  <span class="hljs-built_in">List</span>&lt;Marker&gt; loadMarkers(<span class="hljs-built_in">List</span>&lt;Point&lt;<span class="hljs-built_in">double</span>&gt;&gt;? latLngList, CrsSimple crs);
  
  <span class="hljs-comment">// 加载多边形（比如房间轮廓、限制区域等）</span>
  <span class="hljs-built_in">dynamic</span> loadPolygons(CrsSimple crs);
}
</code></pre>
<p>为什么要这么设计？因为<strong>每个业务场景的需求都不一样</strong>：</p>
<ul>
<li>验收系统可能需要红色图钉标记问题点</li>
<li>测量系统可能需要数字标记测量点</li>
<li>巡检系统可能需要设备图标</li>
</ul>
<p>把这些差异抽象出来，让业务层自己实现，核心框架就不用改了。</p>
<h2 data-id="heading-3">具体实现</h2>
<h3 data-id="heading-4">一、状态管理怎么搞</h3>
<p>一开始用 Provider 写的，后来发现状态更新太频繁，性能不行。改成 GetX 之后丝滑多了。</p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CustomMapState</span> </span>{
  <span class="hljs-comment">// Flutter Map 的控制器，用来控制缩放、移动等</span>
  MapController mapController = MapController();
  
  <span class="hljs-comment">// 坐标系统（这个是关键，后面会讲为什么用 CrsSimple）</span>
  <span class="hljs-keyword">final</span> CrsSimple crs = <span class="hljs-keyword">const</span> CrsSimple();
  
  <span class="hljs-comment">// 配置信息（响应式的，方便动态修改）</span>
  <span class="hljs-keyword">final</span> Rx&lt;MapDrawingConfig&gt; config = MapDrawingConfig().obs;
  
  <span class="hljs-comment">// 当前使用的图纸</span>
  <span class="hljs-keyword">final</span> Rx&lt;MapSourceConfig?&gt; currentMapSource = Rx&lt;MapSourceConfig?&gt;(<span class="hljs-keyword">null</span>);
  
  <span class="hljs-comment">// 地图边界（用来做自适应显示）</span>
  LatLngBounds? mapBounds;
  
  <span class="hljs-comment">// 标记点列表（Rx开头的都是响应式的，改了自动刷新UI）</span>
  <span class="hljs-keyword">final</span> RxList&lt;Marker&gt; markers = &lt;Marker&gt;[].obs;
  
  <span class="hljs-comment">// 多边形列表（比如房间轮廓）</span>
  <span class="hljs-keyword">final</span> RxList&lt;Polygon&gt; polygons = &lt;Polygon&gt;[].obs;
  
  <span class="hljs-comment">// 当前正在绘制的点</span>
  <span class="hljs-keyword">final</span> RxList&lt;LatLng&gt; currentDrawingPoints = &lt;LatLng&gt;[].obs;
  
  <span class="hljs-comment">// 有效区域（用户只能在这个范围内标注）</span>
  <span class="hljs-built_in">List</span>&lt;LatLng&gt; houseLatLngList = [];
}
</code></pre>
<p>这里有几个关键点：</p>
<ul>
<li><strong>Rx 系列</strong>：GetX 的响应式类型，状态改了UI自动更新，不用手动 setState</li>
<li><strong>CrsSimple</strong>：简单笛卡尔坐标系，因为图纸用的是像素坐标，不是真的经纬度</li>
<li><strong>多图层分离</strong>：标记点、多边形、绘制点分开管理，互不影响</li>
</ul>
<h3 data-id="heading-5">二、控制器的核心逻辑</h3>
<p>控制器主要负责协调各个部分，处理用户交互。</p>
<p><strong>初始化流程</strong></p>
<pre><code class="hljs language-dart" lang="dart">_initData() <span class="hljs-keyword">async</span> {
  state.config.value = config;
  <span class="hljs-keyword">try</span> {
    <span class="hljs-comment">// 调用业务层加载图纸</span>
    <span class="hljs-keyword">var</span> result = <span class="hljs-keyword">await</span> dataSource.loadMapDrawingResource(state.crs);
    state.currentMapSource.value = result;
    state.mapBounds = result.defaultSource.bounds;
  } <span class="hljs-keyword">catch</span> (e) {
    <span class="hljs-comment">// 这里可能失败，比如文件不存在、网络问题等</span>
    logDebug(<span class="hljs-string">'加载图纸失败: <span class="hljs-subst">$e</span>'</span>);
  } <span class="hljs-keyword">finally</span> {
    onMapReady(); <span class="hljs-comment">// 不管成功失败都要走后续流程</span>
  }
}
</code></pre>
<p><strong>地图渲染完成的回调</strong></p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-keyword">void</span> onMapReady() {
  <span class="hljs-keyword">if</span> (state.isMapReady) <span class="hljs-keyword">return</span>; <span class="hljs-comment">// 防止重复调用（之前遇到过bug，这里加个保险）</span>
  
  state.isMapReady = <span class="hljs-keyword">true</span>;
  
  <span class="hljs-comment">// 加载多边形（比如房间轮廓、限制区域等）</span>
  <span class="hljs-keyword">var</span> parameter = dataSource.loadPolygons(state.crs);
  <span class="hljs-keyword">if</span> (parameter[<span class="hljs-string">'polygonList'</span>] != <span class="hljs-keyword">null</span>) {
    state.polygons.value = parameter[<span class="hljs-string">'polygonList'</span>];
  }
  
  <span class="hljs-comment">// 如果有历史标记点，也一起加载进来</span>
  <span class="hljs-keyword">if</span> (config.latLngList.isNotEmpty) {
    state.markers.value = dataSource.loadMarkers(config.latLngList, state.crs);
  }
  
  <span class="hljs-comment">// 自适应显示整个图纸（不然可能只看到一个角）</span>
  <span class="hljs-keyword">if</span> (state.mapBounds != <span class="hljs-keyword">null</span>) {
    state.mapController.fitCamera(
      CameraFit.bounds(bounds: state.mapBounds)
    );
  }
}
</code></pre>
<p><strong>点击事件处理（重点）</strong></p>
<p>这是最核心的逻辑，处理用户在图纸上的点击：</p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-keyword">void</span> addDrawingPoint(TapPosition tapPosition, LatLng latlng) {
  <span class="hljs-comment">// 第一步：坐标转换（从地图坐标转成像素坐标）</span>
  <span class="hljs-comment">// 为什么要转？因为后端存的是像素坐标，前端显示用的是地图坐标</span>
  Point&lt;<span class="hljs-built_in">double</span>&gt; cp = state.crs.latLngToPoint(
    latlng, 
    state.config.value.serverMapMaxZoom
  );
  
  <span class="hljs-comment">// 第二步：检查是否超出图纸范围</span>
  <span class="hljs-comment">// 之前没加这个判断，用户点到图纸外面就报错，体验很差</span>
  <span class="hljs-keyword">if</span> (cp.x &lt; <span class="hljs-number">0</span> || cp.y &lt; <span class="hljs-number">0</span> || 
      cp.x &gt; currentMapSource.width ||
      cp.y &gt; currentMapSource.height) {
    showSnackBar(<span class="hljs-string">'超出图纸范围'</span>);
    <span class="hljs-keyword">return</span>;
  }
  
  <span class="hljs-comment">// 第三步：检查是否在有效区域内</span>
  <span class="hljs-comment">// 比如验收系统要求只能在房间内标注，不能标到墙外面去</span>
  <span class="hljs-keyword">if</span> (state.houseLatLngList.isNotEmpty &amp;&amp;
      !MapUtils.isPointInPolygon(latlng, state.houseLatLngList)) {
    showSnackBar(<span class="hljs-string">'请将位置打在画区内'</span>);
    <span class="hljs-keyword">return</span>;
  }
  
  <span class="hljs-comment">// 第四步：通知业务层（让业务层保存数据）</span>
  config.onTap?.call(cp, latlng);
  
  <span class="hljs-comment">// 第五步：在地图上显示标记点</span>
  addMarker(position: latlng);
}
</code></pre>
<p>这个函数看起来简单，但每一步都是踩坑踩出来的：</p>
<ul>
<li>坐标转换那里，之前 zoom 值没对齐，导致标记点位置偏移</li>
<li>边界检查是测试提的bug，用户点外面会崩</li>
<li>区域约束是产品后来加的需求，还好架构预留了扩展性</li>
</ul>
<h3 data-id="heading-6">三、视图层的设计</h3>
<p>视图层就是负责显示，用 Flutter Map 的多图层机制：</p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-meta">@override</span>
Widget build(BuildContext context) {
  <span class="hljs-keyword">return</span> GetBuilder&lt;CustomMapController&gt;(
    tag: tag,  <span class="hljs-comment">// 用tag支持多实例，不然多个地图会冲突</span>
    id: <span class="hljs-string">'map'</span>, <span class="hljs-comment">// 局部刷新用的，只刷新地图部分</span>
    builder: (controller) {
      <span class="hljs-keyword">return</span> FlutterMap(
        mapController: controller.state.mapController,
        options: _buildMapOptions(),
        children: [
          _buildTileLayer(),      <span class="hljs-comment">// 底图层（图纸）</span>
          _buildPolygonLayer(),   <span class="hljs-comment">// 多边形层（房间轮廓）</span>
          _buildMarkerLayer(),    <span class="hljs-comment">// 标记点层</span>
          ...?children,           <span class="hljs-comment">// 预留扩展位，可以加自定义图层</span>
        ],
      );
    },
  );
}
</code></pre>
<p>Flutter Map 用的是图层叠加的方式，从下往上渲染。顺序很重要，搞错了标记点就被图纸盖住了（别问我怎么知道的）。</p>
<p><strong>底图层的实现</strong></p>
<pre><code class="hljs language-dart" lang="dart">Widget _buildTileLayer() {
  <span class="hljs-keyword">return</span> Obx(() {  <span class="hljs-comment">// Obx 会监听里面用到的响应式变量</span>
    <span class="hljs-keyword">final</span> currentSource = controller.state.currentMapSource.value;
    
    <span class="hljs-comment">// 图纸还没加载完，显示loading</span>
    <span class="hljs-keyword">if</span> (currentSource?.defaultSource.localPath?.isEmpty ?? <span class="hljs-keyword">true</span>) {
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">const</span> Center(child: CircularProgressIndicator());
    }
    
    <span class="hljs-comment">// 加载本地图纸文件</span>
    <span class="hljs-keyword">return</span> OverlayImageLayer(
      overlayImages: [
        OverlayImage(
          imageProvider: FileImage(File(currentSource.defaultSource.localPath)),
          bounds: currentSource.defaultSource.bounds  <span class="hljs-comment">// 图纸的边界</span>
        )
      ]
    );
  });
}
</code></pre>
<p>这里用 <code>OverlayImageLayer</code> 把本地图片当成地图底图，<code>bounds</code> 定义了图片的坐标范围。一开始我还尝试用瓦片图的方式切片加载，后来发现图纸不大（2-3M），直接整图加载反而更简单。</p>
<h3 data-id="heading-7">四、工厂模式的应用</h3>
<p>为了方便使用，封装了一个工厂类：</p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CustomMapFactory</span> </span>{
  <span class="hljs-keyword">static</span> CustomMapWidget createDefault({
    <span class="hljs-keyword">required</span> MapDataSource dataSource,
    <span class="hljs-keyword">required</span> MapDrawingConfig config,
    <span class="hljs-built_in">String?</span> tag,
  }) {
    <span class="hljs-keyword">late</span> CustomMapController controller;
    
    <span class="hljs-comment">// 检查是否已经创建过（避免重复创建导致内存泄漏）</span>
    <span class="hljs-keyword">if</span> (Get.isRegistered&lt;CustomMapController&gt;(tag: tag)) {
      controller = Get.find&lt;CustomMapController&gt;(tag: tag);
    } <span class="hljs-keyword">else</span> {
      controller = CustomMapController(
        dataSource: dataSource,
        config: config,
      );
      Get.lazyPut(() =&gt; controller, tag: tag);  <span class="hljs-comment">// 懒加载，用的时候才创建</span>
    }
    
    <span class="hljs-keyword">return</span> CustomMapWidget(
      controller: controller,
      tag: tag,
    );
  }
  
  <span class="hljs-comment">// 页面销毁时记得调用，不然内存泄漏</span>
  <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> disposeController(<span class="hljs-built_in">String</span> tag) {
    <span class="hljs-keyword">if</span> (Get.isRegistered&lt;CustomMapController&gt;(tag: tag)) {
      Get.delete&lt;CustomMapController&gt;(tag: tag);
    }
  }
}
</code></pre>
<p><strong>使用示例</strong>：</p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">// 创建地图组件</span>
<span class="hljs-keyword">final</span> mapWidget = CustomMapFactory.createDefault(
  dataSource: MyDataSourceImpl(),  <span class="hljs-comment">// 你自己的业务实现</span>
  config: MapDrawingConfig(
    serverMapMaxZoom: <span class="hljs-number">8.0</span>,
    onTap: (pixelPoint, latlng) {
      <span class="hljs-built_in">print</span>(<span class="hljs-string">'点击了坐标: <span class="hljs-subst">$pixelPoint</span>'</span>);
    },
  ),
  tag: <span class="hljs-string">'project_01'</span>,  <span class="hljs-comment">// 用唯一标识，支持多个地图实例</span>
);
</code></pre>
<h2 data-id="heading-8">踩坑记录</h2>
<h3 data-id="heading-9">坑一：坐标系统的选择</h3>
<p>一开始我用的是常规的地理坐标系（EPSG:3857），结果发现图纸上的坐标根本对不上。后来才明白，<strong>CAD 图纸用的是像素坐标，不是经纬度</strong>。</p>
<p>后端存的坐标是这样的：<code>{x: 1234, y: 5678}</code>，单位是像素。而 Flutter Map 默认用的是经纬度坐标。</p>
<p>解决办法是用 <strong>CrsSimple（简单笛卡尔坐标系）</strong>：</p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">// CrsSimple 可以把像素坐标当成"伪经纬度"</span>
<span class="hljs-keyword">final</span> CrsSimple crs = <span class="hljs-keyword">const</span> CrsSimple();

<span class="hljs-comment">// 地图坐标 → 像素坐标（给后端用）</span>
Point&lt;<span class="hljs-built_in">double</span>&gt; pixelPoint = crs.latLngToPoint(
  latlng, 
  serverMapMaxZoom  <span class="hljs-comment">// zoom 级别要和后端约定好</span>
);

<span class="hljs-comment">// 定义图纸的边界</span>
LatLngBounds bounds = LatLngBounds(
  LatLng(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>),                      <span class="hljs-comment">// 图纸左上角</span>
  LatLng(imageHeight, imageWidth)    <span class="hljs-comment">// 图纸右下角</span>
);
</code></pre>
<p>这里有几个坑：</p>
<ol>
<li><strong>zoom 级别必须和后端一致</strong>，不然坐标会偏移。我们约定的是 8</li>
<li><strong>Y 轴方向</strong>：CrsSimple 的 Y 轴是向下的，和传统坐标系相反</li>
<li><strong>小数精度</strong>：坐标转换会有浮点误差，存数据库时要注意</li>
</ol>
<h3 data-id="heading-10">坑二：点在多边形内判定</h3>
<p>产品要求用户只能在房间内标注，不能标到墙外面去。这就需要判断点是否在多边形内。</p>
<p>我用的是<strong>射线法（Ray Casting）</strong>，原理很简单：从点向右发射一条射线，数射线和多边形边界交点的个数，奇数次就在内部，偶数次就在外部。</p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-keyword">static</span> <span class="hljs-built_in">bool</span> isPointInPolygon(LatLng point, <span class="hljs-built_in">List</span>&lt;LatLng&gt; polygon) {
  <span class="hljs-built_in">int</span> intersectCount = <span class="hljs-number">0</span>;
  
  <span class="hljs-comment">// 遍历多边形的每条边</span>
  <span class="hljs-keyword">for</span> (<span class="hljs-built_in">int</span> i = <span class="hljs-number">0</span>; i &lt; polygon.length; i++) {
    <span class="hljs-comment">// 取当前点和下一个点（首尾相连）</span>
    <span class="hljs-keyword">final</span> LatLng vertB = 
      i == polygon.length - <span class="hljs-number">1</span> ? polygon[<span class="hljs-number">0</span>] : polygon[i + <span class="hljs-number">1</span>];
    
    <span class="hljs-comment">// 检查射线是否和这条边相交</span>
    <span class="hljs-keyword">if</span> (_rayCastIntersect(point, polygon[i], vertB)) {
      intersectCount++;
    }
  }
  
  <span class="hljs-comment">// 奇数次相交说明在内部</span>
  <span class="hljs-keyword">return</span> (intersectCount % <span class="hljs-number">2</span>) == <span class="hljs-number">1</span>;
}

<span class="hljs-keyword">static</span> <span class="hljs-built_in">bool</span> _rayCastIntersect(LatLng point, LatLng vertA, LatLng vertB) {
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">double</span> aY = vertA.latitude;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">double</span> bY = vertB.latitude;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">double</span> aX = vertA.longitude;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">double</span> bX = vertB.longitude;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">double</span> pY = point.latitude;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">double</span> pX = point.longitude;
  
  <span class="hljs-comment">// 优化：快速排除明显不相交的情况</span>
  <span class="hljs-comment">// 如果AB两个点都在P的上方/下方/左侧，肯定不相交</span>
  <span class="hljs-keyword">if</span> ((aY &gt; pY &amp;&amp; bY &gt; pY) || 
      (aY &lt; pY &amp;&amp; bY &lt; pY) || 
      (aX &lt; pX &amp;&amp; bX &lt; pX)) {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">false</span>;
  }
  
  <span class="hljs-comment">// 特殊情况：垂直的边</span>
  <span class="hljs-keyword">if</span> (aX == bX) <span class="hljs-keyword">return</span> <span class="hljs-keyword">true</span>;
  
  <span class="hljs-comment">// 计算射线与边的交点X坐标（直线方程 y = mx + b）</span>
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">double</span> m = (aY - bY) / (aX - bX);  <span class="hljs-comment">// 斜率</span>
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">double</span> b = ((aX * <span class="hljs-number">-1</span>) * m) + aY;   <span class="hljs-comment">// 截距</span>
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">double</span> x = (pY - b) / m;           <span class="hljs-comment">// 交点的X坐标</span>
  
  <span class="hljs-comment">// 如果交点在P的右侧，说明射线和这条边相交了</span>
  <span class="hljs-keyword">return</span> x &gt; pX;
}
</code></pre>
<p>这个算法看起来复杂，其实就是初中的直线方程 <code>y = mx + b</code>。第一次写的时候没考虑垂直边的情况，结果遇到矩形房间就挂了。</p>
<h3 data-id="heading-11">坑三：内存泄漏</h3>
<p>GetX 虽然好用，但不注意的话很容易内存泄漏。尤其是在列表页，每个 item 都创建一个地图实例，来回滚动几次内存就爆了。</p>
<p><strong>解决方案：</strong></p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-meta">@override</span>
<span class="hljs-keyword">void</span> onClose() {
  <span class="hljs-keyword">if</span> (_isDisposed) <span class="hljs-keyword">return</span>;  <span class="hljs-comment">// 防止重复释放</span>
  
  <span class="hljs-keyword">super</span>.onClose();
  
  <span class="hljs-comment">// 释放地图控制器</span>
  state.mapController.dispose();
  
  <span class="hljs-comment">// 清空所有列表</span>
  state.markers.clear();
  state.polygons.clear();
  state.currentDrawingPoints.clear();
  
  <span class="hljs-comment">// 重置状态</span>
  state.config.value = MapDrawingConfig();
  state.currentMapSource.value = <span class="hljs-keyword">null</span>;
  state.isMapReady = <span class="hljs-keyword">false</span>;
  
  _isDisposed = <span class="hljs-keyword">true</span>;
}
</code></pre>
<p>页面销毁时记得调用：</p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-meta">@override</span>
<span class="hljs-keyword">void</span> dispose() {
  CustomMapFactory.disposeController(<span class="hljs-string">'project_<span class="hljs-subst">${projectId}</span>'</span>);
  <span class="hljs-keyword">super</span>.dispose();
}
</code></pre>
<hr/>
<h2 data-id="heading-12">数据模型设计</h2>
<h3 data-id="heading-13">配置模型</h3>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MapDrawingConfig</span> </span>{
  <span class="hljs-comment">// 样式相关</span>
  <span class="hljs-keyword">final</span> Color defaultMarkerColor;      <span class="hljs-comment">// 标记点颜色</span>
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">double</span> defaultMarkerSize;      <span class="hljs-comment">// 标记点大小</span>
  
  <span class="hljs-comment">// 缩放相关（这几个参数很重要）</span>
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">double</span> serverMapMaxZoom;  <span class="hljs-comment">// 后端用的zoom级别（要对齐）</span>
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">double</span> realMapMaxZoom;    <span class="hljs-comment">// 前端实际最大zoom（影响流畅度）</span>
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">double</span> minZoom;           <span class="hljs-comment">// 最小zoom（防止缩太小）</span>
  
  <span class="hljs-comment">// 交互相关</span>
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">bool</span> singleMarker;  <span class="hljs-comment">// 是否单点模式（有些场景只能选一个点）</span>
  <span class="hljs-built_in">Function</span>(Point&lt;<span class="hljs-built_in">double</span>&gt;, LatLng)? onTap;  <span class="hljs-comment">// 点击回调</span>
  
  <span class="hljs-comment">// 数据相关</span>
  <span class="hljs-built_in">List</span>&lt;Point&lt;<span class="hljs-built_in">double</span>&gt;&gt; latLngList; <span class="hljs-comment">// 已有的标记点（用来回显）</span>
}
</code></pre>
<p>配置项不算多，但每个都是实际用到的。一开始想做成超级灵活的配置系统，后来发现太复杂了，就简化成这样。</p>
<h3 data-id="heading-14">地图源模型</h3>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MapSource</span> </span>{
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">String</span> localPath;     <span class="hljs-comment">// 图纸的本地路径</span>
  <span class="hljs-keyword">final</span> LatLngBounds bounds;  <span class="hljs-comment">// 图纸的边界</span>
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">double</span> height;        <span class="hljs-comment">// 图纸高度（像素）</span>
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">double</span> width;         <span class="hljs-comment">// 图纸宽度（像素）</span>
}

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MapSourceConfig</span> </span>{
  <span class="hljs-keyword">final</span> MapSource defaultSource;  <span class="hljs-comment">// 默认使用的图纸</span>
  
  <span class="hljs-comment">// 工厂方法：快速创建本地图纸配置</span>
  <span class="hljs-keyword">factory</span> MapSourceConfig.customLocal({
    <span class="hljs-keyword">required</span> <span class="hljs-built_in">String</span> customPath,
    <span class="hljs-keyword">required</span> <span class="hljs-built_in">double</span> height,
    <span class="hljs-keyword">required</span> <span class="hljs-built_in">double</span> width,
  }) { ... }
}
</code></pre>
<p>这个模型设计得比较简单，因为我们的需求就是加载一张本地图纸。如果你的场景需要多个图纸切换，可以扩展 <code>availableSources</code> 列表。</p>
<hr/>
<h2 data-id="heading-15">性能优化</h2>
<h3 data-id="heading-16">图层懒加载</h3>
<p>没有数据的图层直接返回空 Widget，不渲染：</p>
<pre><code class="hljs language-dart" lang="dart">Widget _buildMarkerLayer() {
  <span class="hljs-keyword">return</span> Obx(() {
    <span class="hljs-keyword">if</span> (controller.state.markers.isEmpty) {
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">const</span> SizedBox.shrink();  <span class="hljs-comment">// 空图层</span>
    }
    <span class="hljs-keyword">return</span> MarkerLayer(markers: controller.state.markers);
  });
}
</code></pre>
<h3 data-id="heading-17">局部刷新</h3>
<p>用 GetBuilder 的 <code>id</code> 参数实现精准刷新：</p>
<pre><code class="hljs language-dart" lang="dart">update([<span class="hljs-string">'map'</span>]);  <span class="hljs-comment">// 只刷新地图，不影响页面其他部分</span>
</code></pre>
<p>这个太重要了，之前没加 id，每次更新都全页面刷新，卡得要命。</p>
<h3 data-id="heading-18">图片缓存</h3>
<p><code>FileImage</code> 自带缓存，不需要额外处理。但如果图纸特别大（&gt;10M），建议在加载前先压缩一下。</p>
<hr/>
<h2 data-id="heading-19">使用指南</h2>
<h3 data-id="heading-20">第一步：实现数据源接口</h3>
<p>根据你的业务需求，实现 <code>MapDataSource</code>：</p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MyProjectDataSource</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">MapDataSource</span> </span>{
  <span class="hljs-meta">@override</span>
  Future&lt;MapSourceConfig&gt; loadMapDrawingResource(CrsSimple crs) <span class="hljs-keyword">async</span> {
    <span class="hljs-comment">// 从服务器下载或本地读取图纸</span>
    <span class="hljs-built_in">String</span> localPath = <span class="hljs-keyword">await</span> getDrawingPath();  <span class="hljs-comment">// 你的业务逻辑</span>
    
    <span class="hljs-keyword">return</span> MapSourceConfig.customLocal(
      customPath: localPath,
      height: <span class="hljs-number">1080</span>,  <span class="hljs-comment">// 图纸高度</span>
      width: <span class="hljs-number">1920</span>,   <span class="hljs-comment">// 图纸宽度</span>
    );
  }
  
  <span class="hljs-meta">@override</span>
  Marker addMarker(LatLng point, {<span class="hljs-built_in">String?</span> number}) {
    <span class="hljs-comment">// 创建一个标记点（自定义样式）</span>
    <span class="hljs-keyword">return</span> Marker(
      point: point,
      width: <span class="hljs-number">40</span>,
      height: <span class="hljs-number">40</span>,
      child: Icon(Icons.location_pin, color: Colors.red),
    );
  }
  
  <span class="hljs-meta">@override</span>
  <span class="hljs-built_in">List</span>&lt;Marker&gt; loadMarkers(<span class="hljs-built_in">List</span>&lt;Point&lt;<span class="hljs-built_in">double</span>&gt;&gt;? points, CrsSimple crs) {
    <span class="hljs-comment">// 加载已有的标记点（比如从数据库读取）</span>
    <span class="hljs-keyword">return</span> points?.map((point) {
      LatLng latlng = crs.pointToLatLng(point, <span class="hljs-number">8.0</span>);
      <span class="hljs-keyword">return</span> addMarker(latlng);
    }).toList() ?? [];
  }
  
  <span class="hljs-meta">@override</span>
  <span class="hljs-built_in">dynamic</span> loadPolygons(CrsSimple crs) {
    <span class="hljs-comment">// 加载多边形（房间轮廓、限制区域等）</span>
    <span class="hljs-keyword">return</span> {
      <span class="hljs-string">'polygonList'</span>: [...],  <span class="hljs-comment">// 你的多边形数据</span>
      <span class="hljs-string">'houseLatLngList'</span>: [...],  <span class="hljs-comment">// 限制区域</span>
    };
  }
}
</code></pre>
<h3 data-id="heading-21">第二步：创建地图组件</h3>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-keyword">final</span> mapWidget = CustomMapFactory.createDefault(
  dataSource: MyProjectDataSource(),
  config: MapDrawingConfig(
    serverMapMaxZoom: <span class="hljs-number">8.0</span>,
    singleMarker: <span class="hljs-keyword">false</span>,  <span class="hljs-comment">// 是否单点模式</span>
    onTap: (pixelPoint, latlng) {
      <span class="hljs-comment">// 用户点击了，这里保存坐标到数据库</span>
      saveToDatabase(pixelPoint);
    },
  ),
  tag: <span class="hljs-string">'project_<span class="hljs-subst">${projectId}</span>'</span>,  <span class="hljs-comment">// 用唯一ID作为tag</span>
);
</code></pre>
<h3 data-id="heading-22">第三步：在页面中使用</h3>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MyPage</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">StatelessWidget</span> </span>{
  <span class="hljs-meta">@override</span>
  Widget build(BuildContext context) {
    <span class="hljs-keyword">return</span> Scaffold(
      appBar: AppBar(title: Text(<span class="hljs-string">'图纸标注'</span>)),
      body: mapWidget,
    );
  }
}

<span class="hljs-comment">// 页面销毁时记得释放资源</span>
<span class="hljs-meta">@override</span>
<span class="hljs-keyword">void</span> dispose() {
  CustomMapFactory.disposeController(<span class="hljs-string">'project_<span class="hljs-subst">${projectId}</span>'</span>);
  <span class="hljs-keyword">super</span>.dispose();
}
</code></pre>
<h3 data-id="heading-23">几个注意事项</h3>
<ol>
<li><strong>zoom 级别要和后端对齐</strong>，不然坐标会偏</li>
<li><strong>tag 必须唯一</strong>，建议用项目ID或其他唯一标识</li>
<li><strong>记得释放资源</strong>，不然内存泄漏</li>
<li><strong>图纸路径要正确</strong>，文件不存在会报错</li>
</ol>
<hr/>
<h2 data-id="heading-24">总结</h2>
<p>这套架构最大的优点是<strong>解耦</strong>。核心框架不关心你的业务，只负责地图展示和交互。所有业务逻辑都通过 <code>DataSource</code> 接口注入，换个场景只需要写一个新的 DataSource 实现就行。</p>
<p>当然也有一些不足：</p>
<ul>
<li>对于特别复杂的标注需求（比如绘制曲线、多边形编辑），还需要扩展</li>
<li>大图纸（&gt;10M）的加载性能还有优化空间</li>
<li>离线缓存目前还没做</li>
</ul>
<p>不过对于大部分场景来说，已经够用了。</p>
<p>如果你也有类似的需求，希望这篇文章能帮到你。有问题欢迎交流！</p>
<hr/>
<p><em>2024年实战项目总结，代码已脱敏。</em></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[网络调试工具推荐，Fiddler抓包教程、HTTPS配置与接口调试完整指南]]></title>    <link>https://juejin.cn/post/7577394906160660534</link>    <guid>https://juejin.cn/post/7577394906160660534</guid>    <pubDate>2025-11-28T03:55:45.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577394906160660534" data-draft-id="7577364921656639530" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="网络调试工具推荐，Fiddler抓包教程、HTTPS配置与接口调试完整指南"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-11-28T03:55:45.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="aiopencode"/> <meta itemprop="url" content="https://juejin.cn/user/1898230261493865"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            网络调试工具推荐，Fiddler抓包教程、HTTPS配置与接口调试完整指南
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1898230261493865/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    aiopencode
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-28T03:55:45.000Z" title="Fri Nov 28 2025 03:55:45 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-28
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在软件开发中，接口调试和网络问题排查几乎是日常工作中最高频的任务之一。
尤其是在前后端分离架构盛行的今天，HTTP 请求异常、跨端数据丢失、响应延迟等问题层出不穷。
而能高效定位这些问题的利器，就是 <strong>Fiddler抓包工具</strong>。</p>
<p>这篇文章将从实用角度出发，带你系统掌握 Fiddler 的安装配置、HTTPS 抓包、代理设置、接口调试与实战应用，让你从“会用”到“精通”，真正做到一眼看透网络通信。</p>
<hr/>
<h2 data-id="heading-0"><strong>一、Fiddler抓包工具简介</strong></h2>
<p><strong>Fiddler</strong> 是 Telerik 公司推出的一款专业 HTTP/HTTPS 抓包与调试工具。
它可以捕获系统中所有的网络请求与响应，帮助开发者分析接口、优化性能、验证数据和调试问题。</p>
<p>与 Charles、Postman、Wireshark 等常见工具相比，Fiddler 具有以下优势：</p>
<ul>
<li><strong>全面功能覆盖</strong>：支持请求分析、断点调试、Mock 数据、性能分析；</li>
<li><strong>HTTPS 支持强</strong>：可解密 SSL 流量；</li>
<li><strong>轻量高效</strong>：资源占用低，适合长期运行；</li>
<li><strong>跨平台兼容</strong>：支持 Windows、Mac、移动端调试。</li>
</ul>
<p><strong>一句话总结：</strong></p>
<blockquote>
<p>Fiddler 是连接开发、测试与运维的“抓包中枢”，几乎能应对所有网络调试场景。</p>
</blockquote>
<hr/>
<h2 data-id="heading-1"><strong>二、Fiddler安装与基础配置</strong></h2>
<h3 data-id="heading-2"><strong>1. 安装与启动</strong></h3>
<p>安装 Fiddler 后，启动软件即可自动接管系统网络代理。
启动后，左侧会实时显示当前系统的所有网络请求。</p>
<p><strong>提示：</strong></p>
<ul>
<li>状态栏 “Capturing” 表示正在抓包；</li>
<li>若显示 “Paused”，点击即可恢复。</li>
</ul>
<hr/>
<h3 data-id="heading-3"><strong>2. Fiddler代理配置（电脑与移动端）</strong></h3>
<p>默认情况下，Fiddler 仅抓取本机流量。
若要调试移动端 App、小程序或外部设备接口，需要开启远程代理。</p>
<p><strong>配置步骤如下：</strong></p>
<ol>
<li>打开菜单栏 <code>Tools → Options → Connections</code>；</li>
<li>勾选 <strong>Allow remote computers to connect</strong>；</li>
<li>记下电脑 IP 地址和端口号（默认 8888）；</li>
<li>确保电脑与手机在同一 Wi-Fi 网络；</li>
<li>在手机 Wi-Fi 设置中手动设置代理：
<ul>
<li>主机名：电脑 IP</li>
<li>端口号：8888</li>
</ul>
</li>
</ol>
<p>完成后，即可在 Fiddler 中看到移动端发出的 HTTP 请求。</p>
<hr/>
<h3 data-id="heading-4"><strong>3. HTTPS 抓包配置</strong></h3>
<p>由于 HTTPS 流量经过加密，Fiddler 需要安装证书进行解密。</p>
<p><strong>配置方法：</strong></p>
<ul>
<li>打开 <code>Tools → Options → HTTPS</code>；</li>
<li>勾选 <strong>Decrypt HTTPS traffic</strong>；</li>
<li>点击 “Actions → Trust Root Certificate”；</li>
<li>安装并信任 Fiddler 根证书；</li>
<li>若要抓取手机请求，需导出证书并在移动端安装信任。</li>
</ul>
<p>配置完成后，你即可查看加密请求的 Header、Body 与响应数据。</p>
<hr/>
<h2 data-id="heading-5"><strong>三、Fiddler使用教程：核心功能与技巧</strong></h2>
<h3 data-id="heading-6"><strong>1. 请求与响应分析</strong></h3>
<p>Fiddler 会捕获所有 HTTP/HTTPS 请求。
每条请求可展开查看：</p>
<ul>
<li>请求方式（GET/POST/PUT/DELETE）；</li>
<li>请求路径与参数；</li>
<li>请求头与 Cookie；</li>
<li>响应状态码与数据内容；</li>
<li>请求耗时与性能统计。</li>
</ul>
<p><strong>实战案例：</strong>
一次 H5 页面请求返回成功但无数据显示，通过 Fiddler 发现响应中的 <code>Content-Type</code> 不匹配，导致前端解析错误，问题很快解决。</p>
<hr/>
<h3 data-id="heading-7"><strong>2. 请求拦截与断点调试（Breakpoints）</strong></h3>
<p>Fiddler 的断点功能可让开发者在请求发送前或响应返回前修改内容。</p>
<p><strong>应用场景：</strong></p>
<ul>
<li>模拟服务器异常返回；</li>
<li>修改参数测试接口兼容性；</li>
<li>延迟响应测试前端加载逻辑。</li>
</ul>
<p><strong>使用技巧：</strong>
命令行输入 <code>bpu /api/login</code> 即可对指定接口启用断点拦截。</p>
<hr/>
<h3 data-id="heading-8"><strong>3. 模拟接口响应（AutoResponder）</strong></h3>
<p>AutoResponder 是 Fiddler 的 Mock 工具模块，可用于模拟接口响应、前后端独立联调。</p>
<p><strong>使用步骤：</strong></p>
<ol>
<li>打开 AutoResponder 面板；</li>
<li>点击 “Add Rule” 添加规则；</li>
<li>匹配接口 URL；</li>
<li>绑定本地文件或自定义 JSON 数据；</li>
<li>启用规则后，请求将直接返回模拟数据。</li>
</ol>
<p><strong>使用示例：</strong>
前端在接口未完成时可返回 <code>{ "code": 200, "msg": "ok" }</code>，提前测试页面逻辑。</p>
<hr/>
<h3 data-id="heading-9"><strong>4. 构造与重放请求（Composer）</strong></h3>
<p>Composer 模块功能类似 Postman，可手动构造和发送请求。</p>
<p><strong>常见用途：</strong></p>
<ul>
<li>验证接口参数格式；</li>
<li>测试不同请求头；</li>
<li>重放线上请求复现问题。</li>
</ul>
<p>右键任意请求 → “Replay → Reissue Request” 即可快速重放。</p>
<hr/>
<h3 data-id="heading-10"><strong>5. 性能分析（Timeline）</strong></h3>
<p>Timeline 模块可展示请求的详细耗时：
DNS 查询 → TCP 连接 → TLS 握手 → 服务器响应 → 数据传输。</p>
<p><strong>实战应用：</strong>
通过 Timeline 分析请求耗时来源，可快速识别是网络延迟还是后端响应慢，
对性能优化极具参考价值。</p>
<hr/>
<h2 data-id="heading-11"><strong>四、Fiddler实战案例：定位移动端接口异常</strong></h2>
<p>一次移动端项目中，测试反馈“安卓能登录，iOS 不行”。
通过 Fiddler 抓包对比两端请求，发现 iOS 端缺少一个 Header 字段。
后端验证逻辑因此失败。</p>
<p>修复请求头后，问题立即解决。</p>
<p><strong>经验总结：</strong></p>
<blockquote>
<p>真实的接口问题，往往不是“接口坏了”，而是“请求没对齐”。
Fiddler 帮助开发者精确对比每个细节。</p>
</blockquote>
<hr/>
<h2 data-id="heading-12"><strong>五、Fiddler功能模块对照表</strong></h2>



































<table><thead><tr><th>模块</th><th>功能说明</th><th>应用场景</th></tr></thead><tbody><tr><td><strong>Filters</strong></td><td>按关键字过滤请求</td><td>聚焦调试目标接口</td></tr><tr><td><strong>AutoResponder</strong></td><td>模拟接口返回数据</td><td>前端独立开发调试</td></tr><tr><td><strong>Breakpoints</strong></td><td>修改请求与响应</td><td>模拟错误与异常</td></tr><tr><td><strong>Composer</strong></td><td>构造与重放请求</td><td>接口验证与Bug复现</td></tr><tr><td><strong>Timeline</strong></td><td>分析请求耗时</td><td>网络性能优化</td></tr></tbody></table>
<hr/>
<h2 data-id="heading-13"><strong>六、Fiddler与其他调试工具对比</strong></h2>






























<table><thead><tr><th>工具</th><th>优点</th><th>适用场景</th></tr></thead><tbody><tr><td><strong>Fiddler</strong></td><td>免费、强大、支持请求修改</td><td>开发 / 测试人员</td></tr><tr><td><strong>Charles</strong></td><td>界面直观、上手快</td><td>初学者调试</td></tr><tr><td><strong>Postman</strong></td><td>请求构造灵活</td><td>接口测试与验证</td></tr><tr><td><strong>Wireshark</strong></td><td>底层网络分析强</td><td>网络安全分析</td></tr></tbody></table>
<p>Fiddler 是当前兼顾易用性与专业性的最佳 HTTP/HTTPS 抓包与调试工具。</p>
<hr/>
<h2 data-id="heading-14"><strong>七、学习与资源推荐</strong></h2>
<p>想进一步掌握 掌握 <strong>Fiddler使用教程</strong>、<strong>代理设置</strong> 与 <strong>HTTPS 抓包技巧</strong>？推荐访问**<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.fiddler.hk%2F" target="_blank" title="https://www.fiddler.hk/" ref="nofollow noopener noreferrer">Fiddler 中文网</a>**</p>
<p>你将在网站中获得：</p>
<ul>
<li>Fiddler 安装与配置教程；</li>
<li>HTTPS 抓包与证书配置方法；</li>
<li>移动端代理抓包指南；</li>
<li>Mock 数据与断点调试技巧；</li>
<li>网络性能优化实战案例。</li>
</ul>
<hr/>
<p>在接口调试与网络问题排查中，<strong>抓包能力</strong> 是开发者效率的倍增器。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[宇信科技基于 SelectDB & Apache Doris 构建实时智能的银行经营分析平台]]></title>    <link>https://juejin.cn/post/7577307409854349327</link>    <guid>https://juejin.cn/post/7577307409854349327</guid>    <pubDate>2025-11-28T04:02:01.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577307409854349327" data-draft-id="7577294037717532706" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="宇信科技基于 SelectDB &amp; Apache Doris 构建实时智能的银行经营分析平台"/> <meta itemprop="keywords" content="数据库,Apache"/> <meta itemprop="datePublished" content="2025-11-28T04:02:01.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="SelectDB"/> <meta itemprop="url" content="https://juejin.cn/user/3189021726222904"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            宇信科技基于 SelectDB &amp; Apache Doris 构建实时智能的银行经营分析平台
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3189021726222904/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    SelectDB
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-28T04:02:01.000Z" title="Fri Nov 28 2025 04:02:01 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-28
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读10分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">客户背景</h2>
<p>深耕银行 IT 建设领域 26 的年， 宇信科技服务超数百家金融机构，覆盖核心系统、渠道平台、风控中台等关键业务场景。其数据条线团队专注经营分析场景 20 余年，为城商行、农商行提供从报表系统到智能决策的全栈解决方案。随着银行业数字化进程步入深水区，宇信科技面临双重挑战：一方面，市场节奏的加快，让客户对“分钟级数据响应”需求迫切，传统数据平台的处理效率与扩展能力已显滞后；另一方面，决策者不再满足于“工具即报表”现状，需要一种能够实现 “智能归因-闭环决策” 的深度分析能力，以应对复杂多变的市场环境。</p>
<h2 data-id="heading-1">挑战与探索</h2>
<ul>
<li><strong>银行业经营分析的演进：</strong> 纵观银行业数据分析的发展可以看到一条从“专有”到“普惠”的演进路径，大致经历了三个时代：</li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ab4663a06abe4a0f9c617d92ee9ddea5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2VsZWN0REI=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764907321&amp;x-signature=gL%2FNRKuskORwAbilaBV%2BoaeqYs4%3D" alt="挑战与探索.PNG" loading="lazy"/></p>
<ul>
<li><strong>数据分析 1.0：</strong> 分析工作高度依赖定制开发，其产出物是定期生成的静态报表。数据的生命周期以“月”甚至“年”为单位，决策信息链条长、响应迟缓。它仅仅是少数高层管理者的专属工具。</li>
<li><strong>数据分析 2.0：</strong> “拖拉拽”式的分析和看板大屏，将数据时效性从“月”提升至“周”的粒度，并将使用权下放给了数据分析师等专业岗位，用户规模也相应扩大至十万级。</li>
<li><strong>数据分析 3.0：</strong> 数据调取时间压缩至“秒”，通过将复杂分析能力封装于产品之中，工具的使用门槛被降至最低，开启了服务亿万级用户的可能。</li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c316313a9b354d768024f411612ec07a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2VsZWN0REI=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764907321&amp;x-signature=p3XK6PI1UrwONYwJbOwOjmhfGs0%3D" alt="挑战与探索-2.PNG" loading="lazy"/></p>
<ul>
<li><strong>现代化的经营分析架构详见上图，当前经营分析所面临的挑战如下：</strong>
<ul>
<li><strong>缺少即时性分析：</strong> 临时探索性分析需求难以即时响应，仍依赖“提需求——等开发”的传统模式，响应周期长、时效性低。</li>
<li><strong>实时场景需丰富：</strong> 现有技术能力不足以支撑实时营销、预警、风控等高要求场景。</li>
<li><strong>归因分析不灵活：</strong> 由于杜邦分析、迁徙分析、漏斗分析等灵活分析方法缺失，业务结果易察而深层动因难溯。其根源在于数据、技术与业务间的“断点”导致分析路径割裂，深度归因探索受阻。</li>
<li><strong>自助分析门槛高：</strong> 现有平台对业务人员而言使用门槛仍较高。</li>
</ul>
</li>
</ul>
<p>宇信在服务高管决策中发现， BI 工具虽然能提供精准的“数据洞察”，但普遍缺乏与业务执行流程的联动，导致洞察无法高效转化为行动，形成了“决策断点”。</p>
<p>为解决这一核心难题，宇信自 2023 年开始与 Apache Doris 合作，目标构建一个<strong>将数据洞察无缝融入业务执行</strong>的全新平台。具体而言，平台不再是简单的“问题工单”，而是围绕“业务目标”进行驱动：系统基于数据分析自动生成处置建议，并将其转化为可追踪、可量化的行动项，下发至执行层。</p>
<p>双方合作以来，已在多个项目中成功落地。新平台不仅解决了以往数据与业务脱节的长期痛点，其实际成效也远超项目预期。</p>
<h2 data-id="heading-2">Apache Doris 构建高效、智能的分析平台</h2>
<p>宇信科技与 Apache Doris 的深度融合，是构建现代化银行经营分析平台的关键。Apache Doris 作为核心加速引擎和数据存储组件，在提升数据处理效率、实现流批一体化以及打破数据孤岛方面发挥了决定性作用 。</p>
<h3 data-id="heading-3">01 升级分析平台：实时动态指标高效查询</h3>
<p>通过与 Apache Doris 能力打通，将常态化的指标加工变成了动态的指标加工，宇信科技经营分析平台实现指标实时高效查询，业务效率提升 30%，极大提升了业务敏捷性与竞争优势。业务用户获取洞察时间大幅缩短，可快速响应市场变化并优化资源利用，有效解决"缺少即时性分析"痛点。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a52007efadf04c1b8a5917c691e2fc33~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2VsZWN0REI=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764907321&amp;x-signature=t8MZyfqSDePbuGnnyasv3xa%2BuZE%3D" alt="01 升级分析平台：实时动态指标高效查询.png" loading="lazy"/></p>
<h3 data-id="heading-4">02 解除数据枷锁：实现流批一体指标加工</h3>
<p>Apache Doris 在宇信科技经营分析平台中构建了流批一体指标加工架构，轻松统一了 Kafka 实时数据流与批量历史数据源，从根本上解决了传统 Lambda 架构中常见的时效性延迟与数据不一致问题，突破传统实时分析与历史报告分离的局限。统一数据源简化了治理流程，减少冗余，使银行能构建复杂应用（如实时欺诈检测、个性化营销），同时支撑长期趋势分析与战略规划。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/de8634e0909e4875807b9d8e54e767d6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2VsZWN0REI=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764907321&amp;x-signature=5fAz2Vkk6ooC8A%2F1XjHSeN4cBzg%3D" alt="02 解除数据枷锁：实现流批一体指标加工.png" loading="lazy"/></p>
<h3 data-id="heading-5">03 突破数据孤岛：从烟囱式到数据中台的转变</h3>
<p>在传统的“烟囱式”数据架构中，各个应用系统独立建设，导致数据孤岛普遍存在，数据难以复用，效率低下 。宇信科技基于 Apache Doris 构建了湖仓一体的数据中台，高效支撑了新一代经营分析平台，银行能够实现指标的快速生产与分析，加快了对市场变化的响应。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1998057ee21141f695d1ff079badfa0b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2VsZWN0REI=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764907321&amp;x-signature=M6o4NGvRA7bD2a%2FjHG%2BL1Yo%2Bklc%3D" alt="03 突破数据孤岛：从烟囱式到数据中台的转型.png" loading="lazy"/></p>
<h3 data-id="heading-6">04 精准业务洞察：迁徙分析与血缘拆解的应用</h3>
<p>在 Apache Doris 的支撑下，宇信科技实现了<strong>迁徙分析</strong>和<strong>血缘拆解分析</strong>等高级功能，能直接解决“归因分析不灵活”的痛点，促使银行对业务绩效和客户行为获得更深入、更具可操作性的理解。</p>
<p><strong>客层变化分析</strong>能够帮助银行精准定位客户群体和业务变化 。通过理解客户为何在不同细分市场之间迁移，银行可以制定有针对性的保留策略，或识别高绩效分支机构的成功实践。</p>
<p>具体支持能力包括：</p>
<ul>
<li><strong>圈选历史客群：</strong> 以时间为节点，圈选某一时间点/区间的客户，分析这些客户在某个时间段的变化情况；</li>
<li><strong>进行客群比对：</strong> 支持选择不同客群进行对比，分析同一周期内不同客户明细，联动CRM过程指标，同时比较各个分支行经验策略优劣；</li>
<li><strong>下钻到客户明细：</strong> 重要客户迁徙变化，如私行迁徙到白金，可点击展示客户明细，联动 CRM过程指标，挖掘迁徙变化原因；</li>
</ul>
<p>Apache Doris 在处理大量时间序列数据上的复杂多维查询能力，对于这些复杂分析至关重要，使银行能够增强客户忠诚度并改善其竞争地位。</p>
<p><strong>维度归因分析</strong>能支持业务的精准定位问题。能够帮助银行快速排查规模变动问题、理解关键指标波动及根因分析：</p>
<p><strong>自动/配置拆解逻辑：</strong> 通过拆解，将复杂的指标拆解为更细粒度的原子指标，快速定位影响指标的深层原因；</p>
<ul>
<li><strong>快速识别重点关注项：</strong> 对于整个血缘分析中占主要影响因素的项或需要重点关注的项，可通过高亮的形式进行呈现；</li>
<li><strong>给出分析结论下发用户：</strong> 指标支持下钻进行分析，并给出相应的分析结论；</li>
</ul>
<p><strong>Doris 作为底层高性能分析引擎，高效处理和查询多层分解所需的粒度数据，为平台的强大诊断能力提供支撑。</strong></p>
<h2 data-id="heading-7">某银行业务场景的成功实践</h2>
<p>宇信科技与 Apache Doris 为某银行的零售业务打造了全新的经营分析平台。其中 Apache Doris 作为核心分析引擎，为项目成功提供了关键的数据支撑能力，重点聚焦其零售业务场景。</p>
<p>项目的顶层设计遵循模块化与结构化两大核心原则。前者负责将复杂的业务场景（如存款、贷款、财管）清晰解耦；后者则确保所有分析工作都围绕核心业务目标（OSM），以终为始。二者均依托 Apache Doris 强大的实时分析能力和快速响应能力。为实现“全渠道触达，分层经营”的业务目标，平台还基于 Apache Doris 构建了覆盖多维度、多层次的指标体系。</p>
<p>Apache Doris 的真正价值在于其协同效应：其支撑的各项能力（极速查询、流批一体、数据融合、灵活归因、智能自助）深度融合，这种集成化的解决方案可以放大整体业务的价值。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d7a3a4d1c0924029ac44d9d38621a3fb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2VsZWN0REI=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764907321&amp;x-signature=c3Wm%2BRApZwtnLerUE%2BXUs5PkZ6w%3D" alt="某银行业务场景的成功实践.png" loading="lazy"/></p>
<h2 data-id="heading-8">未来展望：AI x Apache Doris</h2>
<p><strong>结合大模型打造人人可用的 ChatBI：</strong></p>
<p>深度融合大模型能力，实现对话问数、自动归因、关联应用和多轮对话，显著降低分析门槛。Apache Doris 作为底层高性能分析引擎，需支撑自然语言交互所需的动态、低延迟查询。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3bff9d09aecf437e8b8b58c3756e5f64~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2VsZWN0REI=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764907321&amp;x-signature=qGhUSBUIj6kzu2exQzICEK3JIz4%3D" alt="未来展望：AI x  Apache Doris-1.png" loading="lazy"/></p>
<p><strong>全域数据的融合打通，智能应用：</strong></p>
<p>许多 BI 工具止步于“看指标”，却未能引导管理者 “用指标去思考”。所以，出发点不再是指标本身，而是其背后完整的分析逻辑闭环。借助 Apache Doris 将技术“隐于形”，构建整合银行内部管理职能的统一门户，结合实时标签能力，只让一条清晰、专注的业务思考路径最终呈现在管理者面前，最终实现数据驱动业务增长的目标愿景。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1f35de43cece48f2b8dc9d5c9bda91e9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2VsZWN0REI=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764907321&amp;x-signature=e1m1haodMa7j1%2BjMd4BN120rQrw%3D" alt="未来展望：AI x  Apache Doris-2.png" loading="lazy"/></p>
<p>为此宇信未来将：</p>
<ul>
<li><strong>纵向信息流同源一致：</strong> 以全面的技术底座和数据支持，保障系统信息一致性，打造一体化企业级全领域管理与运营门户；</li>
<li><strong>横向管理域融合贯通：</strong> 通过各模块能力的深度整合与协同，打造企业经营、数据运营、人力财资等若干企管场景，提高跨领域部门间的协作效率；</li>
<li><strong>敏捷迭代、全域覆盖管理需求：</strong> 实现作业协同，敏捷迭代应用，流程化运营，不断打磨管理策略，并可分享应用到其他管理系统，提升管理效率和先进性；</li>
</ul>
<p>Apache Doris 正在构建面向 AI 的智能数据平台，其 MPP 架构与向量化引擎能支撑 Agent 单一请求在数秒内触发的数万次查询，角色将扩展至企业数据设施的关键部分。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[我的变量去哪了？JS 作用域入门指南]]></title>    <link>https://juejin.cn/post/7577256255083511817</link>    <guid>https://juejin.cn/post/7577256255083511817</guid>    <pubDate>2025-11-28T01:59:49.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577256255083511817" data-draft-id="7577256255083134985" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="我的变量去哪了？JS 作用域入门指南"/> <meta itemprop="keywords" content="前端,JavaScript"/> <meta itemprop="datePublished" content="2025-11-28T01:59:49.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="ohyeah"/> <meta itemprop="url" content="https://juejin.cn/user/740446536480618"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            我的变量去哪了？JS 作用域入门指南
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/740446536480618/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    ohyeah
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-28T01:59:49.000Z" title="Fri Nov 28 2025 01:59:49 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-28
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    13
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在 JavaScript 的学习过程中，<strong>作用域</strong>和<strong>变量提升</strong>是两个绕不开的核心概念。它们不仅影响着代码的执行逻辑，也常常成为初学者“踩坑”的重灾区。本文将结合几段典型代码，从实际运行结果出发，梳理 JS 中作用域的演变过程，重点解释 <strong>var 的缺陷</strong>、<strong>let/const 的改进</strong>，以及现代 JS 引擎如何通过<strong>执行上下文</strong>统一处理这两类变量声明。</p>
<hr/>
<h2 data-id="heading-0">一、变量提升：JS 的“历史包袱”</h2>
<p>先看这段代码（<code>1.js</code>）：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-title function_">showName</span>() <span class="hljs-comment">// ✅ 正常执行</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(myname) <span class="hljs-comment">// undefined</span>

<span class="hljs-keyword">var</span> myname = <span class="hljs-string">'路明非'</span>

<span class="hljs-keyword">function</span> <span class="hljs-title function_">showName</span>(<span class="hljs-params"/>){
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'函数showName 执行了'</span>)
}
</code></pre>
<p>这里体现了两个关键现象：</p>
<ul>
<li><strong>函数声明提升</strong>：<code>showName</code> 不仅声明被提升，<strong>函数体也被提升</strong>，因此可以在定义前调用。</li>
<li><strong>变量提升（仅声明）</strong> ：<code>var myname</code> 的声明被提升到顶部，但赋值仍在原位置执行，所以首次 <code>console.log</code> 输出 <code>undefined</code>。</li>
</ul>
<p>这就是经典的 <strong>hoisting（变量提升）</strong> 机制。它源于 JS 引擎的两阶段执行模型：<strong>编译阶段</strong>收集声明，<strong>执行阶段</strong>进行赋值和调用。</p>
<blockquote>
<p>⚠️ 变量提升虽解决了早期 JS 的作用域问题，但也带来了<strong>不符合直觉的行为</strong>，被视为语言设计上的缺陷。</p>
</blockquote>
<hr/>
<h2 data-id="heading-1">二、作用域链：全局 vs 局部</h2>
<p>在 <code>2.js</code> 中：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">var</span> globalVar = <span class="hljs-string">'我是全局变量'</span>

<span class="hljs-keyword">function</span> <span class="hljs-title function_">myFunction</span>(<span class="hljs-params"/>){
  <span class="hljs-keyword">var</span> localVar = <span class="hljs-string">'我是局部变量'</span>
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(globalVar) <span class="hljs-comment">// ✅ 打印全局变量</span>
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(localVar)  <span class="hljs-comment">// ✅ 打印局部变量</span>
}

<span class="hljs-title function_">myFunction</span>()
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(globalVar) <span class="hljs-comment">// ✅</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(localVar)  <span class="hljs-comment">// ❌ ReferenceError</span>
</code></pre>
<p>这展示了 <strong>作用域链</strong> 的查找规则：</p>
<ul>
<li>函数内部优先查找<strong>局部作用域</strong>；</li>
<li>若未找到，则沿作用域链向上查找至<strong>全局作用域</strong>；</li>
<li>但<strong>全局无法访问函数内部的局部变量</strong>。</li>
</ul>
<p>这是 JS 作用域的基本规则，也是封装和避免命名冲突的基础。</p>
<hr/>
<h2 data-id="heading-2">三、var 的致命伤：不支持块级作用域</h2>
<p>来看 <code>3.js</code>：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">var</span> name = <span class="hljs-string">'刘锦苗'</span>

<span class="hljs-keyword">function</span> <span class="hljs-title function_">showName</span>(<span class="hljs-params"/>){
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(name) <span class="hljs-comment">// undefined</span>
  <span class="hljs-keyword">if</span>(<span class="hljs-literal">false</span>){
    <span class="hljs-keyword">var</span> name = <span class="hljs-string">'大厂的苗子'</span>
  }
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(name) <span class="hljs-comment">// undefined</span>
}
</code></pre>
<p>尽管 <code>if(false)</code> 块永远不会执行，但 <code>var name</code> 仍被<strong>提升到函数作用域顶部</strong>，导致函数内 <code>name</code> 被初始化为 <code>undefined</code>。这是因为 <strong><code>var</code> 不支持块级作用域</strong>，其声明会被提升到最近的函数或全局作用域。</p>
<p>对比 <code>4.js</code> 使用 <code>let</code>：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">var</span> name = <span class="hljs-string">'刘锦苗'</span>

<span class="hljs-keyword">function</span> <span class="hljs-title function_">showName</span>(<span class="hljs-params"/>) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(name) <span class="hljs-comment">// '刘锦苗'</span>
  <span class="hljs-keyword">if</span> (<span class="hljs-literal">false</span>) {
    <span class="hljs-keyword">let</span> name = <span class="hljs-string">'大厂的苗子'</span> <span class="hljs-comment">// ❌ 不会影响外层</span>
  }
}
</code></pre>
<p>由于 <code>let</code> 具有<strong>块级作用域</strong>，<code>if</code> 内的 <code>name</code> 仅在该块中有效，不会污染函数作用域，因此外层仍能正确访问全局变量。</p>
<hr/>
<h2 data-id="heading-3">四、let/const 如何解决提升问题？</h2>
<p><code>8.js</code> 展示了一个关键特性：</p>
<pre><code class="hljs language-ini" lang="ini">let <span class="hljs-attr">name</span> = <span class="hljs-string">'刘锦苗'</span>

{
  console.log(name) // ❌ ReferenceError: Cannot access 'name' before initialization
  let <span class="hljs-attr">name</span> = <span class="hljs-string">'大厂的苗子'</span>
}
</code></pre>
<p>这里报错并非因为变量未声明，而是进入了 <strong>暂时性死区（Temporal Dead Zone, TDZ）</strong> 。<br/>
<code>let/const</code> 虽然也会“提升”，但<strong>不会像 var 那样初始化为 undefined</strong>，而是在声明前处于不可访问状态。</p>
<blockquote>
<p>这正是 ES6 对变量提升缺陷的修正：<strong>提升存在，但禁止提前访问</strong>。</p>
</blockquote>
<hr/>
<h2 data-id="heading-4">五、执行上下文视角：变量环境 vs 词法环境</h2>
<p>现代 JS 引擎（如 V8）通过 <strong>执行上下文（Execution Context）</strong> 统一管理变量：</p>
<ul>
<li><strong>变量环境</strong> ：存放 <code>var</code> 声明的变量。</li>
<li><strong>词法环境</strong> ：存放 <code>let/const</code> 声明的变量，并支持<strong>块级作用域栈结构</strong>。</li>
</ul>
<p>以 <code>7.js</code> 为例：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">foo</span>(<span class="hljs-params"/>){
  <span class="hljs-keyword">var</span> a = <span class="hljs-number">1</span>
  <span class="hljs-keyword">let</span> b = <span class="hljs-number">2</span>
  {
    <span class="hljs-keyword">let</span> b = <span class="hljs-number">3</span>  <span class="hljs-comment">// 新的 b，与外层无关</span>
    <span class="hljs-keyword">var</span> c = <span class="hljs-number">4</span>
    <span class="hljs-keyword">let</span> d = <span class="hljs-number">5</span>
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(a) <span class="hljs-comment">// 1（从变量环境中找到）</span>
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(b) <span class="hljs-comment">// 3（当前块级作用域栈顶）</span>
  }
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(b) <span class="hljs-comment">// 2（块级作用域出栈，恢复外层 b）</span>
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(c) <span class="hljs-comment">// 4（var 提升到函数作用域）</span>
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(d) <span class="hljs-comment">// ❌ ReferenceError（d 已随块级作用域销毁）</span>
}
</code></pre>
<p>这里的关键在于：</p>
<ul>
<li><code>let</code> 在块级作用域中创建<strong>独立的绑定</strong>，块执行完后自动出栈销毁；</li>
<li><code>var</code> 无视块级作用域，始终属于函数或全局作用域；</li>
<li>引擎通过<strong>词法环境的栈结构</strong>实现了对块级作用域的支持。</li>
</ul>
<hr/>
<h2 data-id="heading-5">六、为什么早期 JS 要这样设计？</h2>
<p><strong>JavaScript 最初是“KPI 项目”</strong> ，设计周期极短，目标只是给网页加点动态效果。为了快速实现，设计者选择了最简单的方案：</p>
<ul>
<li>不引入复杂的块级作用域；</li>
<li>用“变量提升”统一处理作用域问题；</li>
<li>用函数模拟“类”，规避面向对象的复杂性。</li>
</ul>
<p>这种设计在当时够用，但随着 JS 应用复杂度飙升，<code>var</code> 的缺陷日益凸显——变量覆盖、生命周期混乱、难以调试。</p>
<p>ES6 引入 <code>let/const</code> 和块级作用域，正是对这一历史问题的修复。</p>
<hr/>
<h2 data-id="heading-6">结语：拥抱 let/const，理解执行上下文</h2>
<p>如今，我们应<strong>优先使用 <code>let</code> 和 <code>const</code></strong>，避免 <code>var</code> 带来的陷阱。同时，理解 JS 引擎如何通过 <strong>变量环境 + 词法环境</strong> 的双轨机制，兼容新旧语法，是深入掌握作用域的关键。</p>
<blockquote>
<p>JavaScript 的演进告诉我们：<strong>好的语言设计，既要向前兼容，也要勇于修正过去的错误</strong>。</p>
</blockquote>
<p>通过这几段小代码，我们不仅看到了变量提升的“坑”，更见证了 JS 如何在保持灵活性的同时，逐步走向严谨与规范。希望这篇文章能帮你理清思路，在掘金社区分享你的成长！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[告别服务器！小程序纯前端“图片转 PDF”工具，隐私安全又高效]]></title>    <link>https://juejin.cn/post/7577239264310263808</link>    <guid>https://juejin.cn/post/7577239264310263808</guid>    <pubDate>2025-11-28T02:11:38.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577239264310263808" data-draft-id="7577284771446800424" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="告别服务器！小程序纯前端“图片转 PDF”工具，隐私安全又高效"/> <meta itemprop="keywords" content="微信小程序,前端,JavaScript"/> <meta itemprop="datePublished" content="2025-11-28T02:11:38.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="小皮虾"/> <meta itemprop="url" content="https://juejin.cn/user/1468603263091623"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            告别服务器！小程序纯前端“图片转 PDF”工具，隐私安全又高效
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1468603263091623/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    小皮虾
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-28T02:11:38.000Z" title="Fri Nov 28 2025 02:11:38 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-28
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">1. 背景与痛点：纯前端实践的动力</h2>
<p>在开发小程序时，实现如“图片转 PDF”这样的功能时，常常面临以下挑战：</p>
<ul>
<li><strong>隐私担忧</strong>：将图片上传到服务器进行转换，用户担心图片内容泄露。对于个人证件、私密照片等敏感内容，这一顾虑尤为突出。</li>
<li><strong>网络依赖与效率</strong>：转换过程需要频繁与服务器交互，在弱网环境下速度慢、不稳定，甚至可能因上传大文件而失败。</li>
<li><strong>服务器成本</strong>：每一次转换都意味着服务器资源的消耗（存储、计算、带宽），对于开发者而言，成本不容忽视。</li>
</ul>
<p>为了解决这些痛点，我们探索了一个更优的实现路径：<strong>纯前端、在小程序本地完成图片到 PDF 的转换</strong>。</p>
<h2 data-id="heading-1">2. 核心思路：本地文件系统与 <code>pdf-lib</code> 的巧妙结合</h2>
<p>在小程序中实现纯前端图片转 PDF，我们的核心思路是：</p>
<ol>
<li><strong>图片本地化处理</strong>：充分利用小程序强大的本地文件系统能力，将用户选择的图片读取到本地临时路径。</li>
<li><strong>PDF 文档构建</strong>：引入功能丰富的 JavaScript 库 <code>pdf-lib</code>，在小程序运行时直接在前端环境创建和操作 PDF 文件。</li>
<li><strong>最终文件保存</strong>：将 <code>pdf-lib</code> 生成的 PDF 数据流保存为本地文件，供用户直接预览或分享。</li>
</ol>
<p>这种方式让整个转换过程都在用户的小程序沙箱环境内完成，<strong>图片数据不会离开用户手机</strong>，极大保障了数据隐私和安全性，同时显著提升了转换效率并降低了服务器成本。</p>
<h2 data-id="heading-2">3. 技术核心：<code>pdf-lib</code> 的引入与应用</h2>
<p><code>pdf-lib</code> 是一个强大的纯 JavaScript PDF 库，支持在多种 JavaScript 环境下创建和修改 PDF 文件，完美契合小程序这种前端应用场景。</p>
<h3 data-id="heading-3">3.1 库的引入</h3>
<p>你需要将 <code>pdf-lib</code> 的小程序兼容版本（通常是 <code>pdf-lib.min.js</code>）放置在你的项目目录中，并通过 <code>require</code> 引入：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> { <span class="hljs-title class_">PDFDocument</span>, degrees, <span class="hljs-title class_">PageSizes</span> } = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./pdf-lib.min.js'</span>);
<span class="hljs-keyword">const</span> fs = wx.<span class="hljs-title function_">getFileSystemManager</span>(); <span class="hljs-comment">// 小程序文件管理器实例</span>
</code></pre>
<h3 data-id="heading-4">3.2 转换逻辑概览</h3>
<p>整个图片转 PDF 的流程可分解为以下几个关键步骤：</p>
<ol>
<li><strong>图片预处理</strong>：获取每张图片的尺寸、类型 (<code>wx.getImageInfo</code>)，并将其读取为 Base64 格式 (<code>fs.readFile</code>)，这是 <code>pdf-lib</code> 嵌入图片所需的标准数据格式。</li>
<li><strong>创建 PDF 文档</strong>：初始化一个空的 <code>PDFDocument</code> 对象。</li>
<li><strong>逐页添加图片</strong>：遍历所有图片，为每张图片创建一个新的 PDF 页面。根据图片的原始尺寸和类型，将其嵌入到 PDF 中，并进行智能缩放、居中。<strong>对于横向图片，还会自动旋转页面 90 度以更好地适应 A4 纸张。</strong></li>
<li><strong>生成与保存</strong>：将构建好的 PDF 文档保存为 Base64 编码的字符串，再通过小程序文件系统的 <code>fs.writeFile</code> 接口，写入到本地的临时文件路径。</li>
<li><strong>返回结果</strong>：将生成的 PDF 文件本地路径返回给业务层，用于后续的预览或分享。</li>
</ol>
<h2 data-id="heading-5">4. 核心代码：<code>img2pdf.js</code></h2>
<p>以下是我们帮小忙工具箱实现图片转 PDF 功能的核心源代码。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> { <span class="hljs-title class_">PDFDocument</span>, degrees, <span class="hljs-title class_">PageSizes</span> } = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./pdf-lib.min.js'</span>);
<span class="hljs-keyword">const</span> fs = wx.<span class="hljs-title function_">getFileSystemManager</span>()
<span class="hljs-comment">/**
 * 把图片转成pdf
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">Array</span>} urls 图片url数组
 * <span class="hljs-doctag">@returns</span> {<span class="hljs-type">String</span>} pdfUrl pdf文件url
 */</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">img2pdf</span>(<span class="hljs-params">urls</span>) {
	<span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> urls == <span class="hljs-string">'string'</span>) {
		urls = [urls]
	}

	<span class="hljs-comment">// 图片信息</span>
	<span class="hljs-keyword">const</span> imageInfo = urls.<span class="hljs-title function_">map</span>(<span class="hljs-function">(<span class="hljs-params">url</span>) =&gt;</span> {
		<span class="hljs-keyword">return</span> wx.<span class="hljs-title function_">getImageInfo</span>({
			<span class="hljs-attr">src</span>: url
		});
	});
	<span class="hljs-keyword">const</span> imageInfoRes = <span class="hljs-keyword">await</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">all</span>(imageInfo);
	<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(imageInfoRes);

	<span class="hljs-comment">// 图片base64</span>
	<span class="hljs-keyword">const</span> imageBase64 = urls.<span class="hljs-title function_">map</span>(<span class="hljs-function">(<span class="hljs-params">url</span>) =&gt;</span> {
		<span class="hljs-keyword">return</span> <span class="hljs-title function_">readFile</span>(url, <span class="hljs-string">"base64"</span>);
	});
	<span class="hljs-keyword">const</span> imageBase64Res = <span class="hljs-keyword">await</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">all</span>(imageBase64);
	<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(imageBase64Res);

	<span class="hljs-keyword">const</span> pdfDoc = <span class="hljs-keyword">await</span> <span class="hljs-title class_">PDFDocument</span>.<span class="hljs-title function_">create</span>();

	<span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; imageInfoRes.<span class="hljs-property">length</span>; i++) {
		<span class="hljs-keyword">const</span> {
			type,
			width,
			height
		} = imageInfoRes[i];
		<span class="hljs-keyword">let</span> pdfImage = <span class="hljs-string">""</span>;
		<span class="hljs-keyword">if</span> (type === <span class="hljs-string">'jpeg'</span>) {
			pdfImage = <span class="hljs-keyword">await</span> pdfDoc.<span class="hljs-title function_">embedJpg</span>(imageBase64Res[i]);
		} <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (type === <span class="hljs-string">'png'</span>) {
			pdfImage = <span class="hljs-keyword">await</span> pdfDoc.<span class="hljs-title function_">embedPng</span>(imageBase64Res[i]);
		}

		<span class="hljs-keyword">const</span> page = pdfDoc.<span class="hljs-title function_">addPage</span>(<span class="hljs-title class_">PageSizes</span>.<span class="hljs-property">A4</span>);
		<span class="hljs-keyword">const</span> {
			<span class="hljs-attr">width</span>: pageWidth,
			<span class="hljs-attr">height</span>: pageHeight
		} = page.<span class="hljs-title function_">getSize</span>(); <span class="hljs-comment">// 获取页面尺寸</span>

		<span class="hljs-keyword">let</span> drawOptions = {};

		<span class="hljs-comment">// 如果图片是宽大于高，则旋转</span>
		<span class="hljs-keyword">if</span> (width &gt; height) {
			<span class="hljs-comment">// 页面旋转后，可用于绘制的"宽度"实际上是原始页面的高度，"高度"是原始页面的宽度</span>
			<span class="hljs-keyword">const</span> scaled = pdfImage.<span class="hljs-title function_">scaleToFit</span>(pageHeight, pageWidth); <span class="hljs-comment">// 注意参数顺序因为页面旋转了</span>

			drawOptions = {
				<span class="hljs-comment">// x: scaled.height + (pageWidth - scaled.height) / 2,   // 注意这里用的是 scaled.height</span>
				<span class="hljs-attr">x</span>: (pageWidth - scaled.<span class="hljs-property">height</span>) / <span class="hljs-number">2</span>,
				<span class="hljs-attr">y</span>: (pageHeight - scaled.<span class="hljs-property">width</span>) / <span class="hljs-number">2</span> + scaled.<span class="hljs-property">width</span>,
				<span class="hljs-attr">width</span>: scaled.<span class="hljs-property">width</span>,
				<span class="hljs-attr">height</span>: scaled.<span class="hljs-property">height</span>,
				<span class="hljs-attr">rotate</span>: <span class="hljs-title function_">degrees</span>(<span class="hljs-number">270</span>),
			};
			<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'drawOptions'</span>, drawOptions);
		} <span class="hljs-keyword">else</span> {
			<span class="hljs-comment">// 图片是纵向或方形的</span>
			<span class="hljs-keyword">const</span> scaled = pdfImage.<span class="hljs-title function_">scaleToFit</span>(pageWidth, pageHeight);
			drawOptions = {
				<span class="hljs-attr">x</span>: (pageWidth - scaled.<span class="hljs-property">width</span>) / <span class="hljs-number">2</span>, <span class="hljs-comment">// 居中 X</span>
				<span class="hljs-attr">y</span>: (pageHeight - scaled.<span class="hljs-property">height</span>) / <span class="hljs-number">2</span>, <span class="hljs-comment">// 居中 Y</span>
				<span class="hljs-attr">width</span>: scaled.<span class="hljs-property">width</span>,
				<span class="hljs-attr">height</span>: scaled.<span class="hljs-property">height</span>,
			};
		}
		page.<span class="hljs-title function_">drawImage</span>(pdfImage, drawOptions);
	}

	<span class="hljs-comment">// 3. 获取 PDF 的 Uint8Array</span>
	<span class="hljs-keyword">const</span> docBase64 = <span class="hljs-keyword">await</span> pdfDoc.<span class="hljs-title function_">saveAsBase64</span>();
	<span class="hljs-keyword">const</span> timestamp = <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>();
	<span class="hljs-keyword">const</span> pdfPath = <span class="hljs-keyword">await</span> <span class="hljs-title function_">base64ToFile</span>(docBase64, <span class="hljs-string">`/<span class="hljs-subst">${timestamp}</span>.pdf`</span>);


	<span class="hljs-keyword">return</span> pdfPath;
}

<span class="hljs-comment">/**
 * base64转本地文件
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">string</span>} base64 base64字符串
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">string</span>} fileName  文件名
 * <span class="hljs-doctag">@returns</span> {<span class="hljs-type">Promise</span>} Promise 文件路径
 */</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">base64ToFile</span>(<span class="hljs-params">base64, fileName</span>) {
	<span class="hljs-keyword">const</span> {
		promise,
		resolve,
		reject
	} = <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">withResolvers</span>();
	<span class="hljs-keyword">const</span> filePath = wx.<span class="hljs-property">env</span>.<span class="hljs-property">USER_DATA_PATH</span> + fileName;
	fs.<span class="hljs-title function_">writeFile</span>({
		filePath,
		<span class="hljs-attr">data</span>: base64,
		<span class="hljs-attr">encoding</span>: <span class="hljs-string">"base64"</span>,
		<span class="hljs-attr">success</span>: <span class="hljs-function"><span class="hljs-params">res</span> =&gt;</span> {
			<span class="hljs-title function_">resolve</span>(filePath)
		},
		<span class="hljs-attr">fail</span>: <span class="hljs-function"><span class="hljs-params">err</span> =&gt;</span> {
			<span class="hljs-title function_">reject</span>(err)
		}
	});
	<span class="hljs-keyword">return</span> promise;
}

<span class="hljs-comment">/**
 * 使用Promise读取文件
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">string</span>} filePath 文件路径
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">string</span>} encoding 文件编码
 * <span class="hljs-doctag">@returns</span> {<span class="hljs-type">Promise</span>} Promise对象
 */</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">readFile</span>(<span class="hljs-params">filePath, encoding = <span class="hljs-string">'utf8'</span></span>) {
	<span class="hljs-keyword">const</span> {
		promise,
		resolve,
		reject
	} = <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">withResolvers</span>();
	fs.<span class="hljs-title function_">readFile</span>({
		filePath,
		encoding,
		<span class="hljs-title function_">success</span>(<span class="hljs-params">fileRes</span>) {
			<span class="hljs-title function_">resolve</span>(fileRes.<span class="hljs-property">data</span>)
		},
		<span class="hljs-title function_">fail</span>(<span class="hljs-params">err</span>) {
			<span class="hljs-title function_">reject</span>(err)
		}
	});
	<span class="hljs-keyword">return</span> promise;
}
</code></pre>
<h2 data-id="heading-6">5. 小程序端应用示例</h2>
<p>在页面中，可以通过简单的交互完成转换。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// pages/image-to-pdf/index.js</span>
<span class="hljs-keyword">import</span> { img2pdf } <span class="hljs-keyword">from</span> <span class="hljs-string">'../../utils/img2pdf'</span>; <span class="hljs-comment">// 引入转换工具</span>

<span class="hljs-title class_">Page</span>({
  <span class="hljs-attr">data</span>: {
    <span class="hljs-attr">selectedImages</span>: [], <span class="hljs-comment">// 用户选择的图片临时路径数组</span>
    <span class="hljs-attr">pdfPath</span>: <span class="hljs-string">''</span>,
    <span class="hljs-attr">loading</span>: <span class="hljs-literal">false</span>
  },

  <span class="hljs-comment">// 触发图片选择</span>
  <span class="hljs-keyword">async</span> <span class="hljs-title function_">chooseImage</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> { tempFiles } = <span class="hljs-keyword">await</span> wx.<span class="hljs-title function_">chooseMedia</span>({
      <span class="hljs-attr">count</span>: <span class="hljs-number">9</span>, <span class="hljs-comment">// 最多选择 9 张图片</span>
      <span class="hljs-attr">mediaType</span>: [<span class="hljs-string">'image'</span>],
      <span class="hljs-attr">sizeType</span>: [<span class="hljs-string">'original'</span>, <span class="hljs-string">'compressed'</span>], <span class="hljs-comment">// 可以选择原图或压缩图</span>
      <span class="hljs-attr">sourceType</span>: [<span class="hljs-string">'album'</span>, <span class="hljs-string">'camera'</span>],
    });
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">setData</span>({ <span class="hljs-attr">selectedImages</span>: tempFiles.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">file</span> =&gt;</span> file.<span class="hljs-property">tempFilePath</span>) });
  },

  <span class="hljs-comment">// 执行图片转 PDF 转换</span>
  <span class="hljs-keyword">async</span> <span class="hljs-title function_">convertToPdf</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">data</span>.<span class="hljs-property">selectedImages</span>.<span class="hljs-property">length</span> === <span class="hljs-number">0</span>) {
      wx.<span class="hljs-title function_">showToast</span>({ <span class="hljs-attr">title</span>: <span class="hljs-string">'请先选择图片'</span>, <span class="hljs-attr">icon</span>: <span class="hljs-string">'none'</span> });
      <span class="hljs-keyword">return</span>;
    }

    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">setData</span>({ <span class="hljs-attr">loading</span>: <span class="hljs-literal">true</span> });
    wx.<span class="hljs-title function_">showLoading</span>({ <span class="hljs-attr">title</span>: <span class="hljs-string">'转换中...'</span> });

    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">const</span> pdfFilePath = <span class="hljs-keyword">await</span> <span class="hljs-title function_">img2pdf</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">data</span>.<span class="hljs-property">selectedImages</span>);
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">setData</span>({ <span class="hljs-attr">pdfPath</span>: pdfFilePath });
      wx.<span class="hljs-title function_">hideLoading</span>();
      wx.<span class="hljs-title function_">showToast</span>({ <span class="hljs-attr">title</span>: <span class="hljs-string">'转换成功！'</span>, <span class="hljs-attr">icon</span>: <span class="hljs-string">'success'</span> });
      
      <span class="hljs-comment">// 转换成功后，自动打开 PDF 预览</span>
      wx.<span class="hljs-title function_">openDocument</span>({
        <span class="hljs-attr">filePath</span>: pdfFilePath,
        <span class="hljs-attr">fileType</span>: <span class="hljs-string">'pdf'</span>,
        <span class="hljs-attr">success</span>: <span class="hljs-function"><span class="hljs-params">res</span> =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'打开 PDF 成功'</span>, res),
        <span class="hljs-attr">fail</span>: <span class="hljs-function"><span class="hljs-params">err</span> =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'打开 PDF 失败'</span>, err)
      });

    } <span class="hljs-keyword">catch</span> (error) {
      wx.<span class="hljs-title function_">hideLoading</span>();
      wx.<span class="hljs-title function_">showToast</span>({ <span class="hljs-attr">title</span>: <span class="hljs-string">'转换失败！'</span>, <span class="hljs-attr">icon</span>: <span class="hljs-string">'error'</span> });
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'图片转 PDF 发生错误'</span>, error);
    } <span class="hljs-keyword">finally</span> {
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">setData</span>({ <span class="hljs-attr">loading</span>: <span class="hljs-literal">false</span> });
    }
  }
})
</code></pre>
<h2 data-id="heading-7">6. 经验总结与注意事项</h2>
<ol>
<li>
<p><strong>文件体积与性能</strong>：</p>
<ul>
<li><code>pdf-lib</code> 库本身有一定体积（通常在几百 KB），会增加小程序包体大小，我们是使用分包，所以不影响主包。</li>
<li>图片数量越多、分辨率越高，转换耗时越长，内存占用越大。建议在选择图片时提示用户合理数量或适当压缩。</li>
<li>pdf横向图片旋转需要额外计算和处理，可能会略微增加复杂性，如果觉得复杂，也可以直接判断图片是否是纵向，如果是横向使用canvas旋转图片，逻辑上就毕竟简单了。</li>
</ul>
</li>
<li>
<p><strong><code>Promise.withResolvers()</code> 兼容性</strong>：</p>
<ul>
<li>代码使用了 <code>Promise.withResolvers()</code>，目前大多数小程序环境和浏览器中<strong>兼容性可能不好</strong>，我自己做了兼容。</li>
</ul>
</li>
<li>
<p><strong>本地文件系统限制</strong>：</p>
<ul>
<li><code>wx.env.USER_DATA_PATH</code> 路径下的文件是小程序沙箱环境特有的，用户无法直接在系统文件管理器中找到。</li>
<li>生成的文件是临时文件，小程序关闭或长时间不用可能被系统清理。如果需要长期保存，需引导用户通过 <code>wx.saveFile</code> (保存到相册或本地文件) 或上传云存储。</li>
</ul>
</li>
<li>
<p><strong>图片类型支持</strong>：
<code>pdf-lib</code> 主要支持 JPEG 和 PNG 格式。其他格式（如 WebP、GIF）需要先转换为 JPEG/PNG 再进行嵌入，可以利用canvas实现，后面会分享。</p>
</li>
</ol>
<h2 data-id="heading-8">写在最后</h2>
<p>纯前端实现“图片转 PDF”功能，不仅提升了用户体验，更重要的是有效保护了用户的数字隐私。这在追求用户信任和数据安全的小程序生态中，无疑是一个值得推广的实践。</p>
<p>希望这次分享能为你带来启发，共同探索小程序前端能力的更多可能性！</p>
<hr/></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[六个故事搞懂Fragment 故事1-初识Fragment - NewsHub的模块化革命]]></title>    <link>https://juejin.cn/post/7577239264309854208</link>    <guid>https://juejin.cn/post/7577239264309854208</guid>    <pubDate>2025-11-28T00:48:37.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577239264309854208" data-draft-id="7577239264309837824" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="六个故事搞懂Fragment 故事1-初识Fragment - NewsHub的模块化革命"/> <meta itemprop="keywords" content="Android"/> <meta itemprop="datePublished" content="2025-11-28T00:48:37.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="码码宁"/> <meta itemprop="url" content="https://juejin.cn/user/4248978205204190"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            六个故事搞懂Fragment 故事1-初识Fragment - NewsHub的模块化革命
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4248978205204190/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    码码宁
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-28T00:48:37.000Z" title="Fri Nov 28 2025 00:48:37 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-28
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    18
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读22分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">故事1：初识Fragment - NewsHub的模块化革命</h2>
<h3 data-id="heading-1">晨光中的困境</h3>
<p>清晨的第一缕阳光透过百叶窗的缝隙洒在张小安的办公桌上，照亮了散乱的草稿纸和喝了半杯的咖啡。作为移动互联网创业公司"启明科技"的Android开发工程师，小安已经连续奋战了三个星期，他负责开发的新闻阅读应用"NewsHub"即将进入内测阶段。</p>
<p>然而，此刻小安的眉头却紧锁得像一团解不开的毛线。</p>
<p>"又是这个问题..."他喃喃自语，手指在触摸板上快速滑动，屏幕上显示着两套几乎完全相同的XML布局文件。</p>
<p>"为什么手机版和平板版的代码重复率这么高？这简直是在浪费生命！"</p>
<p>小安揉了揉疲惫的眼睛，显示器上的代码仿佛在嘲笑他的困境。作为一名有着三年Android开发经验的工程师，他深知这种代码重复带来的维护噩梦：</p>
<pre><code class="hljs language-ini" lang="ini">&lt;!-- 手机版 activity_main.xml --&gt;
&lt;LinearLayout xmlns:<span class="hljs-attr">android</span>=<span class="hljs-string">"http://schemas.android.com/apk/res/android"</span>
    android:<span class="hljs-attr">layout_width</span>=<span class="hljs-string">"match_parent"</span>
    android:<span class="hljs-attr">layout_height</span>=<span class="hljs-string">"match_parent"</span>
    android:<span class="hljs-attr">orientation</span>=<span class="hljs-string">"horizontal"</span>&gt;
​
    &lt;FrameLayout
        android:<span class="hljs-attr">id</span>=<span class="hljs-string">"@+id/news_list_container"</span>
        android:<span class="hljs-attr">layout_width</span>=<span class="hljs-string">"0dp"</span>
        android:<span class="hljs-attr">layout_height</span>=<span class="hljs-string">"match_parent"</span>
        android:<span class="hljs-attr">layout_weight</span>=<span class="hljs-string">"1"</span> /&gt;
​
&lt;/LinearLayout&gt;
</code></pre>
<pre><code class="hljs language-ini" lang="ini">&lt;!-- 平板版 activity_main_tablet.xml --&gt;
&lt;LinearLayout xmlns:<span class="hljs-attr">android</span>=<span class="hljs-string">"http://schemas.android.com/apk/res/android"</span>
    android:<span class="hljs-attr">layout_width</span>=<span class="hljs-string">"match_parent"</span>
    android:<span class="hljs-attr">layout_height</span>=<span class="hljs-string">"match_parent"</span>
    android:<span class="hljs-attr">orientation</span>=<span class="hljs-string">"horizontal"</span>&gt;
​
    &lt;FrameLayout
        android:<span class="hljs-attr">id</span>=<span class="hljs-string">"@+id/news_list_container"</span>
        android:<span class="hljs-attr">layout_width</span>=<span class="hljs-string">"0dp"</span>
        android:<span class="hljs-attr">layout_height</span>=<span class="hljs-string">"match_parent"</span>
        android:<span class="hljs-attr">layout_weight</span>=<span class="hljs-string">"1"</span> /&gt;
​
    &lt;FrameLayout
        android:<span class="hljs-attr">id</span>=<span class="hljs-string">"@+id/news_detail_container"</span>
        android:<span class="hljs-attr">layout_width</span>=<span class="hljs-string">"0dp"</span>
        android:<span class="hljs-attr">layout_height</span>=<span class="hljs-string">"match_parent"</span>
        android:<span class="hljs-attr">layout_weight</span>=<span class="hljs-string">"1"</span> /&gt;
​
&lt;/LinearLayout&gt;
</code></pre>
<p>仅仅因为多了一个详情页面的容器，他就不得不维护两套几乎完全相同的布局文件。更糟糕的是，对应的Java代码也需要分别处理：</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// MainActivity.java</span>
public class MainActivity extends AppCompatActivity {
​
    <span class="hljs-keyword">@Override</span>
    protected void onCreate(Bundle savedInstanceState) {
        super<span class="hljs-selector-class">.onCreate</span>(savedInstanceState);
​
        if (isTablet()) {
            <span class="hljs-built_in">setContentView</span>(R.layout.activity_main_tablet);
            <span class="hljs-comment">// 平板逻辑：同时显示列表和详情</span>
            <span class="hljs-built_in">showNewsList</span>();
            <span class="hljs-built_in">showNewsDetail</span>(null);
        } else {
            <span class="hljs-built_in">setContentView</span>(R.layout.activity_main);
            <span class="hljs-comment">// 手机逻辑：只显示列表，点击后跳转</span>
            <span class="hljs-built_in">showNewsList</span>();
        }
    }
​
    private boolean <span class="hljs-built_in">isTablet</span>() {
        return <span class="hljs-built_in">getResources</span>()<span class="hljs-selector-class">.getBoolean</span>(R.bool.isTablet);
    }
​
    private void <span class="hljs-built_in">showNewsList</span>() {
        <span class="hljs-comment">// 无论是手机还是平板，这部分代码都一样</span>
        NewsListFragment listFragment = new <span class="hljs-built_in">NewsListFragment</span>();
        <span class="hljs-built_in">getSupportFragmentManager</span>()
            <span class="hljs-selector-class">.beginTransaction</span>()
            <span class="hljs-selector-class">.replace</span>(R.id.news_list_container, listFragment)
            <span class="hljs-selector-class">.commit</span>();
    }
​
    private void <span class="hljs-built_in">showNewsDetail</span>(NewsItem newsItem) {
        if (isTablet()) {
            <span class="hljs-comment">// 平板：在右侧容器中显示详情</span>
            NewsDetailFragment detailFragment = new <span class="hljs-built_in">NewsDetailFragment</span>();
            if (newsItem != null) {
                Bundle args = new <span class="hljs-built_in">Bundle</span>();
                args<span class="hljs-selector-class">.putParcelable</span>("news_item", newsItem);
                detailFragment<span class="hljs-selector-class">.setArguments</span>(args);
            }
            <span class="hljs-built_in">getSupportFragmentManager</span>()
                <span class="hljs-selector-class">.beginTransaction</span>()
                <span class="hljs-selector-class">.replace</span>(R.id.news_detail_container, detailFragment)
                <span class="hljs-selector-class">.commit</span>();
        } else {
            <span class="hljs-comment">// 手机：启动新的Activity显示详情</span>
            Intent intent = new <span class="hljs-built_in">Intent</span>(this, NewsDetailActivity.class);
            if (newsItem != null) {
                intent<span class="hljs-selector-class">.putExtra</span>("news_item", newsItem);
            }
            <span class="hljs-built_in">startActivity</span>(intent);
        }
    }
}
</code></pre>
<p>"这样下去不行..."小安靠在椅背上，望着窗外的城市天际线，"每次修改一个功能，我都要在多个地方同步更新，太容易出错了。"</p>
<p>他想起上周那次惨痛的经历：因为修复手机版的一个列表显示bug，忘记同步更新平板版的代码，导致测试组发现平板应用崩溃，整个迭代计划被迫推迟。</p>
<p>"一定有更好的方法..."小安打开了技术文档浏览器，开始搜索"Android多屏适配最佳实践"。</p>
<h3 data-id="heading-2">意外的导师</h3>
<p>就在小安陷入沉思的时候，办公室的门被轻轻推开了。</p>
<p>"小安，还在为NewsHub的适配问题烦恼吗？"</p>
<p>说话的是李明轩，启明科技的资深架构师。李工有着十多年移动开发经验，是公司技术团队的核心人物。他五十岁左右的年纪，头发已经花白，但眼神依旧锐利，仿佛能看透代码背后的本质。</p>
<p>"李工..."小安有些不好意思地笑了笑，"您怎么知道的？"</p>
<p>"你这周提交的代码我看了，"李工走到小安的工位旁，指着屏幕，"手机版和平板版的代码重复率超过70%，这在敏捷开发中是很危险的信号。"</p>
<p>小安点点头，沮丧地说："我知道这样不好，但是我想不出更好的解决方案。Activity的架构天然就不支持模块化，我只能通过不同的布局文件来适配。"</p>
<p>李工笑了笑，从旁边拉过一张椅子坐下："小安，你知道为什么Android在3.0版本引入Fragment吗？"</p>
<p>"我记得文档上说是为了更好地支持大屏幕设备..."小安回答。</p>
<p>"没错，但Fragment的意义远不止于此。"李工的眼中闪烁着智慧的光芒，"让我给你讲个故事吧。"</p>
<h3 data-id="heading-3">Fragment的诞生故事</h3>
<p>"在Fragment出现之前，Android应用的开发模式就像是你现在遇到的问题，"李工开始娓娓道来，"每个屏幕都是一个独立的Activity，就像每个房间都是一栋独立的房子。"</p>
<p>小安想象着那个场景：一个社区里，每栋房子都独立存在，有自己的厨房、卧室、客厅。如果要建一个新的社区，就必须重新建造所有的房子。</p>
<p>"这种模式在手机时代还行，因为屏幕小，一个Activity就能显示所有内容。但平板出现后问题就暴露了。"李工继续说道，"平板屏幕大，可以同时显示多个界面。如果还用Activity，就像在同一个房间里建多栋房子，既浪费空间又难以管理。"</p>
<p>"所以Google设计了Fragment？"小安追问道。</p>
<p>"是的！"李工的语气变得兴奋起来，"Fragment就像积木块。你可以把一个Activity想象成一个玩具底板，Fragment就是各种形状的积木。在手机上，你可以在底板上放一块积木；在平板上，你可以同时放多块积木。"</p>
<p>李工拿出纸笔，画了一个简单的示意图：</p>
<pre><code class="hljs language-scss" lang="scss">手机布局：
┌─────────────────┐
│  Activity       │
│  ┌─────────────┐│
│  │ Fragment <span class="hljs-selector-tag">A</span>  ││  (新闻列表)
│  └─────────────┘│
│                 │
│  ┌─────────────┐│
│  │ Fragment <span class="hljs-selector-tag">B</span>  ││  (详情页面)
│  └─────────────┘│
└─────────────────┘
(一次只显示一个Fragment)
​
平板布局：
┌─────────────────┐
│  Activity       │
│  ┌──────────┐ │
│  │Fragment <span class="hljs-selector-tag">A</span>│ │  (新闻列表)
│  │          │ │
│  └──────────┘ │
│  ┌──────────┐ │
│  │Fragment <span class="hljs-selector-tag">B</span>│ │  (详情页面)
│  │          │ │
│  └──────────┘ │
└─────────────────┘
(同时显示两个Fragment)
</code></pre>
<p>"我明白了！"小安的眼睛亮了起来，"Fragment就是UI的模块化单元，Activity负责组装和管理这些模块！"</p>
<p>"完全正确！"李工赞许地点头，"这就是Fragment的核心设计理念：<strong>UI与逻辑的模块化</strong>。每个Fragment都是一个独立的组件，有自己的布局和生命周期，但必须托管在Activity中。"</p>
<h3 data-id="heading-4">Fragment的三大优势</h3>
<p>李工看着小安恍然大悟的表情，继续深入讲解："Fragment不仅解决了多屏适配问题，还有三个重要的优势："</p>
<h4 data-id="heading-5">1. 代码复用性</h4>
<p>"你看你现在的代码，"李工指着小安的屏幕，"NewsListFragment和NewsDetailFragment的逻辑其实是一样的，不管在手机还是平板上。如果用Fragment，你只需要写一次："</p>
<pre><code class="hljs language-less" lang="less"><span class="hljs-comment">// NewsListFragment.java</span>
<span class="hljs-selector-tag">public</span> <span class="hljs-selector-tag">class</span> <span class="hljs-selector-tag">NewsListFragment</span> <span class="hljs-selector-tag">extends</span> <span class="hljs-selector-tag">Fragment</span> {
    <span class="hljs-selector-tag">private</span> <span class="hljs-selector-tag">RecyclerView</span> <span class="hljs-selector-tag">recyclerView</span>;
    <span class="hljs-selector-tag">private</span> <span class="hljs-selector-tag">NewsAdapter</span> <span class="hljs-selector-tag">adapter</span>;
    <span class="hljs-selector-tag">private</span> <span class="hljs-selector-tag">List</span>&lt;<span class="hljs-selector-tag">NewsItem</span>&gt; <span class="hljs-selector-tag">newsList</span>;
​
    <span class="hljs-comment">// 回调接口，用于通知Activity用户点击了某条新闻</span>
    <span class="hljs-selector-tag">public</span> <span class="hljs-selector-tag">interface</span> <span class="hljs-selector-tag">OnNewsSelectedListener</span> {
        <span class="hljs-selector-tag">void</span> <span class="hljs-selector-tag">onNewsSelected</span>(NewsItem newsItem);
    }
​
    <span class="hljs-selector-tag">private</span> <span class="hljs-selector-tag">OnNewsSelectedListener</span> <span class="hljs-selector-tag">listener</span>;
​
    @<span class="hljs-selector-tag">Override</span>
    <span class="hljs-selector-tag">public</span> <span class="hljs-selector-tag">void</span> <span class="hljs-selector-tag">onAttach</span>(<span class="hljs-variable">@NonNull</span> Context context) {
        <span class="hljs-selector-tag">super</span><span class="hljs-selector-class">.onAttach</span>(context);
        <span class="hljs-comment">// 确保宿主Activity实现了回调接口</span>
        <span class="hljs-selector-tag">if</span> (context instanceof OnNewsSelectedListener) {
            <span class="hljs-selector-tag">listener</span> = (OnNewsSelectedListener) <span class="hljs-selector-tag">context</span>;
        } <span class="hljs-selector-tag">else</span> {
            <span class="hljs-selector-tag">throw</span> <span class="hljs-selector-tag">new</span> <span class="hljs-selector-tag">RuntimeException</span>(context.<span class="hljs-built_in">toString</span>()
                + <span class="hljs-string">" must implement OnNewsSelectedListener"</span>);
        }
    }
​
    @<span class="hljs-selector-tag">Nullable</span>
    @<span class="hljs-selector-tag">Override</span>
    <span class="hljs-selector-tag">public</span> <span class="hljs-selector-tag">View</span> <span class="hljs-selector-tag">onCreateView</span>(<span class="hljs-variable">@NonNull</span> LayoutInflater inflater,
                           <span class="hljs-variable">@Nullable</span> ViewGroup container,
                           <span class="hljs-variable">@Nullable</span> Bundle savedInstanceState) {
        <span class="hljs-comment">// 创建Fragment的视图</span>
        <span class="hljs-selector-tag">View</span> <span class="hljs-selector-tag">view</span> = <span class="hljs-selector-tag">inflater</span><span class="hljs-selector-class">.inflate</span>(R.layout.fragment_news_list,
                                    container, false);
​
        <span class="hljs-selector-tag">recyclerView</span> = <span class="hljs-selector-tag">view</span><span class="hljs-selector-class">.findViewById</span>(R.id.recyclerView);
        <span class="hljs-selector-tag">setupRecyclerView</span>();
​
        <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">view</span>;
    }
​
    @<span class="hljs-selector-tag">Override</span>
    <span class="hljs-selector-tag">public</span> <span class="hljs-selector-tag">void</span> <span class="hljs-selector-tag">onViewCreated</span>(<span class="hljs-variable">@NonNull</span> View view,
                           <span class="hljs-variable">@Nullable</span> Bundle savedInstanceState) {
        <span class="hljs-selector-tag">super</span><span class="hljs-selector-class">.onViewCreated</span>(view, savedInstanceState);
​
        <span class="hljs-comment">// 加载新闻数据</span>
        <span class="hljs-selector-tag">loadNewsData</span>();
    }
​
    <span class="hljs-selector-tag">private</span> <span class="hljs-selector-tag">void</span> <span class="hljs-selector-tag">setupRecyclerView</span>() {
        <span class="hljs-selector-tag">adapter</span> = <span class="hljs-selector-tag">new</span> <span class="hljs-selector-tag">NewsAdapter</span>(newsList, new NewsAdapter.<span class="hljs-built_in">OnItemClickListener</span>() {
            <span class="hljs-variable">@Override</span>
            public void <span class="hljs-built_in">onItemClick</span>(NewsItem newsItem) {
                <span class="hljs-comment">// 通知Activity用户选择了某条新闻</span>
                <span class="hljs-selector-tag">if</span> (listener != null) {
                    <span class="hljs-selector-tag">listener</span><span class="hljs-selector-class">.onNewsSelected</span>(newsItem);
                }
            }
        });
​
        <span class="hljs-selector-tag">recyclerView</span><span class="hljs-selector-class">.setLayoutManager</span>(new <span class="hljs-built_in">LinearLayoutManager</span>(<span class="hljs-built_in">getContext</span>()));
        <span class="hljs-selector-tag">recyclerView</span><span class="hljs-selector-class">.setAdapter</span>(adapter);
    }
​
    <span class="hljs-selector-tag">private</span> <span class="hljs-selector-tag">void</span> <span class="hljs-selector-tag">loadNewsData</span>() {
        <span class="hljs-comment">// 从网络或数据库加载新闻数据</span>
        <span class="hljs-comment">// 这里使用模拟数据</span>
        <span class="hljs-selector-tag">newsList</span> = <span class="hljs-selector-tag">NewsRepository</span><span class="hljs-selector-class">.getInstance</span>()<span class="hljs-selector-class">.getLatestNews</span>();
        <span class="hljs-selector-tag">adapter</span><span class="hljs-selector-class">.notifyDataSetChanged</span>();
    }
​
    <span class="hljs-comment">// ... 其他方法</span>
}
</code></pre>
<p>"看到吗？这个Fragment完全不知道自己会被用在手机还是平板上，它只负责显示新闻列表。如何使用这个Fragment，由Activity决定。"</p>
<h4 data-id="heading-6">2. 灵活的组合方式</h4>
<p>"Activity就像乐高积木的底板，Fragment就是不同形状的积木。"李工拿起小安桌上的乐高积木举例，"你可以根据需要自由组合："</p>
<pre><code class="hljs language-scala" lang="scala"><span class="hljs-comment">// 手机版MainActivity.java</span>
public <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MainActivity</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">AppCompatActivity</span></span>
        implements <span class="hljs-type">NewsListFragment</span>.<span class="hljs-type">OnNewsSelectedListener</span> {
​
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">protected</span> void onCreate(<span class="hljs-type">Bundle</span> savedInstanceState) {
        <span class="hljs-keyword">super</span>.onCreate(savedInstanceState);
        setContentView(<span class="hljs-type">R</span>.layout.activity_main_phone);
​
        <span class="hljs-comment">// 手机版：只显示新闻列表Fragment</span>
        <span class="hljs-keyword">if</span> (savedInstanceState == <span class="hljs-literal">null</span>) {
            getSupportFragmentManager()
                .beginTransaction()
                .add(<span class="hljs-type">R</span>.id.fragment_container, <span class="hljs-keyword">new</span> <span class="hljs-type">NewsListFragment</span>())
                .commit();
        }
    }
​
    <span class="hljs-meta">@Override</span>
    public void onNewsSelected(<span class="hljs-type">NewsItem</span> newsItem) {
        <span class="hljs-comment">// 手机版：启动新的Activity显示详情</span>
        <span class="hljs-type">Intent</span> intent = <span class="hljs-keyword">new</span> <span class="hljs-type">Intent</span>(<span class="hljs-keyword">this</span>, <span class="hljs-type">NewsDetailActivity</span>.<span class="hljs-keyword">class</span>);
        intent.putExtra(<span class="hljs-string">"news_item"</span>, newsItem);
        startActivity(intent);
    }
}
</code></pre>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// 平板版MainActivity.java</span>
public class MainActivity extends AppCompatActivity
        implements NewsListFragment<span class="hljs-selector-class">.OnNewsSelectedListener</span> {
​
    <span class="hljs-keyword">@Override</span>
    protected void onCreate(Bundle savedInstanceState) {
        super<span class="hljs-selector-class">.onCreate</span>(savedInstanceState);
        <span class="hljs-built_in">setContentView</span>(R.layout.activity_main_tablet);
​
        <span class="hljs-comment">// 平板版：同时显示列表和详情Fragment</span>
        if (savedInstanceState == null) {
            <span class="hljs-built_in">getSupportFragmentManager</span>()
                <span class="hljs-selector-class">.beginTransaction</span>()
                <span class="hljs-selector-class">.add</span>(R.id.news_list_container, new NewsListFragment())
                <span class="hljs-selector-class">.add</span>(R.id.news_detail_container, new NewsDetailFragment())
                <span class="hljs-selector-class">.commit</span>();
        }
    }
​
    <span class="hljs-keyword">@Override</span>
    public void onNewsSelected(NewsItem newsItem) {
        <span class="hljs-comment">// 平板版：直接更新详情Fragment</span>
        NewsDetailFragment detailFragment =
            (NewsDetailFragment) <span class="hljs-built_in">getSupportFragmentManager</span>()
                <span class="hljs-selector-class">.findFragmentById</span>(R.id.news_detail_container);
​
        if (detailFragment != null) {
            detailFragment<span class="hljs-selector-class">.showNewsDetail</span>(newsItem);
        }
    }
}
</code></pre>
<p>"这样，NewsListFragment和NewsDetailFragment的代码只需要写一次，但在不同的Activity中可以有不同的使用方式。"</p>
<h4 data-id="heading-7">3. 更好的生命周期管理</h4>
<p>"Fragment有自己的生命周期，但它始终依赖于Activity。"李工继续解释，"这种设计让UI组件的管理更加精细化。"</p>
<p>他再次在纸上画了一个生命周期图：</p>
<pre><code class="hljs">Activity生命周期：
    onCreate → onStart → onResume → onPause → onStop → onDestroy
         │        │        │        │        │        │
         ▼        ▼        ▼        ▼        ▼        ▼
Fragment生命周期：
    onAttach → onCreate → onCreateView → onViewCreated →
    onStart → onResume → onPause → onStop → onDestroyView → onDestroy → onDetach
</code></pre>
<p>"Fragment的生命周期比Activity更细致，"李工解释道，"比如<code>onCreateView</code>和<code>onDestroyView</code>专门管理View的创建和销毁，而<code>onAttach</code>和<code>onDetach</code>管理Fragment与Activity的绑定关系。这种细粒度的控制在复杂应用中非常有用。"</p>
<h3 data-id="heading-8">Fragment的三种创建方式</h3>
<p>"理论讲得差不多了，让我们看看实际怎么创建Fragment。"李工切换到IDE，开始演示。</p>
<h4 data-id="heading-9">方式一：静态加载（XML中声明）</h4>
<p>"最简单的方式是在XML布局文件中直接声明Fragment："李工创建了一个新的布局文件。</p>
<pre><code class="hljs language-ini" lang="ini">&lt;!-- activity_main_static.xml --&gt;
&lt;LinearLayout xmlns:<span class="hljs-attr">android</span>=<span class="hljs-string">"http://schemas.android.com/apk/res/android"</span>
    android:<span class="hljs-attr">layout_width</span>=<span class="hljs-string">"match_parent"</span>
    android:<span class="hljs-attr">layout_height</span>=<span class="hljs-string">"match_parent"</span>
    android:<span class="hljs-attr">orientation</span>=<span class="hljs-string">"horizontal"</span>&gt;
​
    &lt;!-- 静态加载Fragment --&gt;
    &lt;fragment
        android:<span class="hljs-attr">id</span>=<span class="hljs-string">"@+id/news_list_fragment"</span>
        android:<span class="hljs-attr">name</span>=<span class="hljs-string">"com.example.newshub.NewsListFragment"</span>
        android:<span class="hljs-attr">layout_width</span>=<span class="hljs-string">"0dp"</span>
        android:<span class="hljs-attr">layout_height</span>=<span class="hljs-string">"match_parent"</span>
        android:<span class="hljs-attr">layout_weight</span>=<span class="hljs-string">"1"</span> /&gt;
​
    &lt;fragment
        android:<span class="hljs-attr">id</span>=<span class="hljs-string">"@+id/news_detail_fragment"</span>
        android:<span class="hljs-attr">name</span>=<span class="hljs-string">"com.example.newshub.NewsDetailFragment"</span>
        android:<span class="hljs-attr">layout_width</span>=<span class="hljs-string">"0dp"</span>
        android:<span class="hljs-attr">layout_height</span>=<span class="hljs-string">"match_parent"</span>
        android:<span class="hljs-attr">layout_weight</span>=<span class="hljs-string">"1"</span> /&gt;
​
&lt;/LinearLayout&gt;
</code></pre>
<p>"静态加载的好处是简单直观，"李工解释，"Fragment会随着Activity的创建而自动创建。但缺点是不够灵活，一旦在XML中声明就不能在运行时更改。"</p>
<p>对应的Activity代码非常简单：</p>
<pre><code class="hljs language-scala" lang="scala">public <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MainActivity</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">AppCompatActivity</span> </span>{
​
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">protected</span> void onCreate(<span class="hljs-type">Bundle</span> savedInstanceState) {
        <span class="hljs-keyword">super</span>.onCreate(savedInstanceState);
        setContentView(<span class="hljs-type">R</span>.layout.activity_main_static);
​
        <span class="hljs-comment">// 可以通过findViewById获取Fragment实例</span>
        <span class="hljs-type">NewsListFragment</span> listFragment = (<span class="hljs-type">NewsListFragment</span>)
            getSupportFragmentManager().findFragmentById(<span class="hljs-type">R</span>.id.news_list_fragment);
        <span class="hljs-type">NewsDetailFragment</span> detailFragment = (<span class="hljs-type">NewsDetailFragment</span>)
            getSupportFragmentManager().findFragmentById(<span class="hljs-type">R</span>.id.news_detail_fragment);
    }
}
</code></pre>
<h4 data-id="heading-10">方式二：动态加载（代码中添加）</h4>
<p>"更常用的方式是动态加载，"李工继续演示，"这样可以在运行时根据需要添加、替换、移除Fragment。"</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- activity_main_dynamic.xml --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">FrameLayout</span> <span class="hljs-attr">xmlns:android</span>=<span class="hljs-string">"http://schemas.android.com/apk/res/android"</span>
    <span class="hljs-attr">android:id</span>=<span class="hljs-string">"@+id/fragment_container"</span>
    <span class="hljs-attr">android:layout_width</span>=<span class="hljs-string">"match_parent"</span>
    <span class="hljs-attr">android:layout_height</span>=<span class="hljs-string">"match_parent"</span> /&gt;</span>
</code></pre>
<pre><code class="hljs language-scala" lang="scala">public <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MainActivity</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">AppCompatActivity</span> </span>{
​
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">protected</span> void onCreate(<span class="hljs-type">Bundle</span> savedInstanceState) {
        <span class="hljs-keyword">super</span>.onCreate(savedInstanceState);
        setContentView(<span class="hljs-type">R</span>.layout.activity_main_dynamic);
​
        <span class="hljs-comment">// 动态添加Fragment</span>
        <span class="hljs-keyword">if</span> (savedInstanceState == <span class="hljs-literal">null</span>) {
            <span class="hljs-type">NewsListFragment</span> listFragment = <span class="hljs-keyword">new</span> <span class="hljs-type">NewsListFragment</span>();
​
            getSupportFragmentManager()
                .beginTransaction()
                .add(<span class="hljs-type">R</span>.id.fragment_container, listFragment)
                .commit();
        }
    }
}
</code></pre>
<p>"动态加载的关键是<code>FragmentTransaction</code>，"李工强调，"所有的Fragment操作都需要通过事务来执行："</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// Fragment的基本操作</span>
FragmentTransaction transaction = <span class="hljs-built_in">getSupportFragmentManager</span>()<span class="hljs-selector-class">.beginTransaction</span>();
​
<span class="hljs-comment">// 添加Fragment</span>
transaction<span class="hljs-selector-class">.add</span>(R.id.fragment_container, newFragment);
​
<span class="hljs-comment">// 替换Fragment</span>
transaction<span class="hljs-selector-class">.replace</span>(R.id.fragment_container, newFragment);
​
<span class="hljs-comment">// 移除Fragment</span>
transaction<span class="hljs-selector-class">.remove</span>(oldFragment);
​
<span class="hljs-comment">// 隐藏Fragment（View被销毁但实例保留）</span>
transaction<span class="hljs-selector-class">.hide</span>(fragment);
​
<span class="hljs-comment">// 显示Fragment</span>
transaction<span class="hljs-selector-class">.show</span>(fragment);
​
<span class="hljs-comment">// 添加到回退栈（用户可以按返回键撤销这个操作）</span>
transaction<span class="hljs-selector-class">.addToBackStack</span>(null);
​
<span class="hljs-comment">// 提交事务</span>
transaction<span class="hljs-selector-class">.commit</span>();
</code></pre>
<h4 data-id="heading-11">方式三：工厂模式创建</h4>
<p>"在实际项目中，我推荐使用工厂模式创建Fragment，"李工分享了一个最佳实践，"这样可以确保Fragment总是以正确的方式被创建。"</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">NewsDetailFragment</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Fragment</span> {
​
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">ARG_NEWS_ITEM</span> <span class="hljs-operator">=</span> <span class="hljs-string">"news_item"</span>;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">ARG_SHOW_COMMENT</span> <span class="hljs-operator">=</span> <span class="hljs-string">"show_comment"</span>;
​
    <span class="hljs-keyword">private</span> NewsItem newsItem;
    <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> showComment;
​
    <span class="hljs-comment">// 私有构造函数，强制使用工厂方法</span>
    <span class="hljs-keyword">private</span> <span class="hljs-title function_">NewsDetailFragment</span><span class="hljs-params">()</span> {
        <span class="hljs-comment">// Required empty public constructor</span>
    }
​
    <span class="hljs-comment">/**
     * 工厂方法：创建新闻详情Fragment
     * <span class="hljs-doctag">@param</span> newsItem 要显示的新闻项
     * <span class="hljs-doctag">@param</span> showComment 是否显示评论区
     * <span class="hljs-doctag">@return</span> NewsDetailFragment实例
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> NewsDetailFragment <span class="hljs-title function_">newInstance</span><span class="hljs-params">(NewsItem newsItem, <span class="hljs-type">boolean</span> showComment)</span> {
        <span class="hljs-type">NewsDetailFragment</span> <span class="hljs-variable">fragment</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">NewsDetailFragment</span>();
​
        <span class="hljs-comment">// 创建参数Bundle</span>
        <span class="hljs-type">Bundle</span> <span class="hljs-variable">args</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Bundle</span>();
        args.putParcelable(ARG_NEWS_ITEM, newsItem);
        args.putBoolean(ARG_SHOW_COMMENT, showComment);
​
        <span class="hljs-comment">// 设置参数</span>
        fragment.setArguments(args);
​
        <span class="hljs-keyword">return</span> fragment;
    }
​
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onCreate</span><span class="hljs-params">(<span class="hljs-meta">@Nullable</span> Bundle savedInstanceState)</span> {
        <span class="hljs-built_in">super</span>.onCreate(savedInstanceState);
​
        <span class="hljs-comment">// 读取参数</span>
        <span class="hljs-type">Bundle</span> <span class="hljs-variable">args</span> <span class="hljs-operator">=</span> getArguments();
        <span class="hljs-keyword">if</span> (args != <span class="hljs-literal">null</span>) {
            newsItem = args.getParcelable(ARG_NEWS_ITEM);
            showComment = args.getBoolean(ARG_SHOW_COMMENT, <span class="hljs-literal">false</span>);
        }
    }
​
    <span class="hljs-meta">@Nullable</span>
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> View <span class="hljs-title function_">onCreateView</span><span class="hljs-params">(<span class="hljs-meta">@NonNull</span> LayoutInflater inflater,
                           <span class="hljs-meta">@Nullable</span> ViewGroup container,
                           <span class="hljs-meta">@Nullable</span> Bundle savedInstanceState)</span> {
        <span class="hljs-type">View</span> <span class="hljs-variable">view</span> <span class="hljs-operator">=</span> inflater.inflate(R.layout.fragment_news_detail, container, <span class="hljs-literal">false</span>);
​
        <span class="hljs-comment">// 使用参数初始化UI</span>
        initializeUI(view);
​
        <span class="hljs-keyword">return</span> view;
    }
​
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">initializeUI</span><span class="hljs-params">(View view)</span> {
        <span class="hljs-type">TextView</span> <span class="hljs-variable">titleView</span> <span class="hljs-operator">=</span> view.findViewById(R.id.news_title);
        <span class="hljs-type">TextView</span> <span class="hljs-variable">contentView</span> <span class="hljs-operator">=</span> view.findViewById(R.id.news_content);
        <span class="hljs-type">View</span> <span class="hljs-variable">commentSection</span> <span class="hljs-operator">=</span> view.findViewById(R.id.comment_section);
​
        <span class="hljs-keyword">if</span> (newsItem != <span class="hljs-literal">null</span>) {
            titleView.setText(newsItem.getTitle());
            contentView.setText(newsItem.getContent());
            commentSection.setVisibility(showComment ? View.VISIBLE : View.GONE);
        }
    }
}
</code></pre>
<p>"工厂模式的优点是："</p>
<ol start="0">
<li><strong>参数安全</strong>：通过Bundle传递参数，确保参数在Fragment重建时不会丢失</li>
<li><strong>创建统一</strong>：所有Fragment都通过工厂方法创建，避免忘记设置必要参数</li>
<li><strong>代码清晰</strong>：调用者一看就知道需要哪些参数</li>
</ol>
<p>使用工厂模式创建Fragment：</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// 创建并显示新闻详情Fragment</span>
NewsItem selectedNews = <span class="hljs-built_in">getSelectedNewsItem</span>();
NewsDetailFragment detailFragment = NewsDetailFragment<span class="hljs-selector-class">.newInstance</span>(selectedNews, true);
​
<span class="hljs-built_in">getSupportFragmentManager</span>()
    <span class="hljs-selector-class">.beginTransaction</span>()
    <span class="hljs-selector-class">.replace</span>(R.id.fragment_container, detailFragment)
    <span class="hljs-selector-class">.addToBackStack</span>(null)  <span class="hljs-comment">// 添加到回退栈，用户可以返回</span>
    <span class="hljs-selector-class">.commit</span>();
</code></pre>
<h3 data-id="heading-12">实战重构：NewsHub的模块化改造</h3>
<p>"理论讲完了，现在让我们实际重构你的NewsHub应用。"李工拍了拍小安的肩膀，"你准备好开始这场模块化革命了吗？"</p>
<p>小安用力点头，眼中充满了兴奋："准备好了！李工，我们从哪里开始？"</p>
<p>"首先，我们需要识别应用中的UI模块。"李工在白板上画了一个思维导图：</p>
<pre><code class="hljs">NewsHub应用模块分析
├── 新闻列表模块
│   ├── 新闻条目显示
│   ├── 下拉刷新
│   └── 加载更多
├── 新闻详情模块
│   ├── 新闻内容显示
│   ├── 图片浏览
│   └── 分享功能
├── 用户中心模块
│   ├── 用户信息
│   ├── 设置选项
│   └── 历史记录
└── 搜索模块
    ├── 搜索框
    ├── 搜索结果
    └── 搜索历史
</code></pre>
<p>"根据这个分析，你的NewsHub至少需要4个核心Fragment：NewsListFragment、NewsDetailFragment、UserFragment和SearchFragment。"李工继续说道，"让我们先从最简单的开始：创建NewsListFragment。"</p>
<h4 data-id="heading-13">第一步：创建Fragment基类</h4>
<p>"在实际项目中，我建议先创建一个BaseFragment，"李工开始编写代码，"这样可以避免重复编写通用代码。"</p>
<pre><code class="hljs language-less" lang="less"><span class="hljs-comment">// BaseFragment.java</span>
<span class="hljs-selector-tag">public</span> <span class="hljs-selector-tag">abstract</span> <span class="hljs-selector-tag">class</span> <span class="hljs-selector-tag">BaseFragment</span> <span class="hljs-selector-tag">extends</span> <span class="hljs-selector-tag">Fragment</span> {
​
    <span class="hljs-selector-tag">protected</span> <span class="hljs-selector-tag">View</span> <span class="hljs-selector-tag">rootView</span>;
    <span class="hljs-selector-tag">protected</span> <span class="hljs-selector-tag">Context</span> <span class="hljs-selector-tag">context</span>;
    <span class="hljs-selector-tag">protected</span> <span class="hljs-selector-tag">FragmentActivity</span> <span class="hljs-selector-tag">activity</span>;
​
    @<span class="hljs-selector-tag">Override</span>
    <span class="hljs-selector-tag">public</span> <span class="hljs-selector-tag">void</span> <span class="hljs-selector-tag">onAttach</span>(<span class="hljs-variable">@NonNull</span> Context context) {
        <span class="hljs-selector-tag">super</span><span class="hljs-selector-class">.onAttach</span>(context);
        <span class="hljs-selector-tag">this</span><span class="hljs-selector-class">.context</span> = <span class="hljs-selector-tag">context</span>;
        <span class="hljs-selector-tag">if</span> (context instanceof FragmentActivity) {
            <span class="hljs-selector-tag">this</span><span class="hljs-selector-class">.activity</span> = (FragmentActivity) <span class="hljs-selector-tag">context</span>;
        }
    }
​
    @<span class="hljs-selector-tag">Nullable</span>
    @<span class="hljs-selector-tag">Override</span>
    <span class="hljs-selector-tag">public</span> <span class="hljs-selector-tag">View</span> <span class="hljs-selector-tag">onCreateView</span>(<span class="hljs-variable">@NonNull</span> LayoutInflater inflater,
                           <span class="hljs-variable">@Nullable</span> ViewGroup container,
                           <span class="hljs-variable">@Nullable</span> Bundle savedInstanceState) {
        <span class="hljs-comment">// 如果rootView已经创建，直接返回（避免重复创建）</span>
        <span class="hljs-selector-tag">if</span> (rootView != null) {
            <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">rootView</span>;
        }
​
        <span class="hljs-comment">// 获取布局ID</span>
        <span class="hljs-selector-tag">int</span> <span class="hljs-selector-tag">layoutId</span> = <span class="hljs-selector-tag">getLayoutId</span>();
        <span class="hljs-selector-tag">rootView</span> = <span class="hljs-selector-tag">inflater</span><span class="hljs-selector-class">.inflate</span>(layoutId, container, false);
​
        <span class="hljs-comment">// 初始化View</span>
        <span class="hljs-selector-tag">initView</span>();
​
        <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">rootView</span>;
    }
​
    @<span class="hljs-selector-tag">Override</span>
    <span class="hljs-selector-tag">public</span> <span class="hljs-selector-tag">void</span> <span class="hljs-selector-tag">onViewCreated</span>(<span class="hljs-variable">@NonNull</span> View view,
                           <span class="hljs-variable">@Nullable</span> Bundle savedInstanceState) {
        <span class="hljs-selector-tag">super</span><span class="hljs-selector-class">.onViewCreated</span>(view, savedInstanceState);
​
        <span class="hljs-comment">// 设置数据和事件监听</span>
        <span class="hljs-selector-tag">initData</span>();
        <span class="hljs-selector-tag">initListener</span>();
    }
​
    @<span class="hljs-selector-tag">Override</span>
    <span class="hljs-selector-tag">public</span> <span class="hljs-selector-tag">void</span> <span class="hljs-selector-tag">onDestroyView</span>() {
        <span class="hljs-selector-tag">super</span><span class="hljs-selector-class">.onDestroyView</span>();
        <span class="hljs-comment">// 清理资源</span>
        <span class="hljs-selector-tag">rootView</span> = <span class="hljs-selector-tag">null</span>;
    }
​
    <span class="hljs-comment">/**
     * 获取Fragment的布局ID
     */</span>
    <span class="hljs-selector-tag">protected</span> <span class="hljs-selector-tag">abstract</span> <span class="hljs-selector-tag">int</span> <span class="hljs-selector-tag">getLayoutId</span>();
​
    <span class="hljs-comment">/**
     * 初始化View
     */</span>
    <span class="hljs-selector-tag">protected</span> <span class="hljs-selector-tag">abstract</span> <span class="hljs-selector-tag">void</span> <span class="hljs-selector-tag">initView</span>();
​
    <span class="hljs-comment">/**
     * 初始化数据
     */</span>
    <span class="hljs-selector-tag">protected</span> <span class="hljs-selector-tag">abstract</span> <span class="hljs-selector-tag">void</span> <span class="hljs-selector-tag">initData</span>();
​
    <span class="hljs-comment">/**
     * 初始化事件监听
     */</span>
    <span class="hljs-selector-tag">protected</span> <span class="hljs-selector-tag">void</span> <span class="hljs-selector-tag">initListener</span>() {
        <span class="hljs-comment">// 子类可以重写此方法来设置监听器</span>
    }
​
    <span class="hljs-comment">/**
     * 显示Toast提示
     */</span>
    <span class="hljs-selector-tag">protected</span> <span class="hljs-selector-tag">void</span> <span class="hljs-selector-tag">showToast</span>(String message) {
        <span class="hljs-selector-tag">Toast</span><span class="hljs-selector-class">.makeText</span>(context, message, Toast.LENGTH_SHORT)<span class="hljs-selector-class">.show</span>();
    }
​
    <span class="hljs-comment">/**
     * 显示进度条
     */</span>
    <span class="hljs-selector-tag">protected</span> <span class="hljs-selector-tag">void</span> <span class="hljs-selector-tag">showProgressDialog</span>(String message) {
        <span class="hljs-comment">// 实现进度条显示逻辑</span>
        <span class="hljs-comment">// 这里可以封装一个通用的进度条工具类</span>
    }
​
    <span class="hljs-comment">/**
     * 隐藏进度条
     */</span>
    <span class="hljs-selector-tag">protected</span> <span class="hljs-selector-tag">void</span> <span class="hljs-selector-tag">hideProgressDialog</span>() {
        <span class="hljs-comment">// 实现进度条隐藏逻辑</span>
    }
}
</code></pre>
<p>"BaseFragment提供了Fragment的通用功能，"李工解释道，"这样每个具体的Fragment只需要关注自己的业务逻辑。"</p>
<h4 data-id="heading-14">第二步：创建NewsListFragment</h4>
<p>"现在让我们创建新闻列表Fragment："</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// NewsListFragment.java</span>
public class NewsListFragment extends BaseFragment
        implements SwipeRefreshLayout<span class="hljs-selector-class">.OnRefreshListener</span> {
​
    private static final String TAG = "NewsListFragment";
​
    <span class="hljs-comment">// UI组件</span>
    private RecyclerView recyclerView;
    private SwipeRefreshLayout swipeRefreshLayout;
    private ProgressBar progressBar;
    private TextView emptyView;
​
    <span class="hljs-comment">// 数据和适配器</span>
    private NewsAdapter newsAdapter;
    private List&lt;NewsItem&gt; newsList = new ArrayList&lt;&gt;();
​
    <span class="hljs-comment">// 分页相关</span>
    private int currentPage = <span class="hljs-number">1</span>;
    private boolean isLoading = false;
    private boolean hasMoreData = true;
​
    <span class="hljs-comment">// 回调接口</span>
    public interface OnNewsInteractionListener {
        void <span class="hljs-built_in">onNewsSelected</span>(NewsItem newsItem);
        void <span class="hljs-built_in">onNewsFavorite</span>(NewsItem newsItem);
        void <span class="hljs-built_in">onNewsShare</span>(NewsItem newsItem);
    }
​
    private OnNewsInteractionListener listener;
​
    public static NewsListFragment <span class="hljs-built_in">newInstance</span>() {
        return new <span class="hljs-built_in">NewsListFragment</span>();
    }
​
    <span class="hljs-keyword">@Override</span>
    public void onAttach(<span class="hljs-keyword">@NonNull</span> Context context) {
        super<span class="hljs-selector-class">.onAttach</span>(context);
        if (context instanceof OnNewsInteractionListener) {
            listener = (OnNewsInteractionListener) context;
        } else {
            throw new <span class="hljs-built_in">RuntimeException</span>(context.toString()
                + " must implement OnNewsInteractionListener");
        }
    }
​
    <span class="hljs-keyword">@Override</span>
    protected int getLayoutId() {
        return R<span class="hljs-selector-class">.layout</span><span class="hljs-selector-class">.fragment_news_list</span>;
    }
​
    <span class="hljs-keyword">@Override</span>
    protected void initView() {
        recyclerView = rootView<span class="hljs-selector-class">.findViewById</span>(R.id.recyclerView);
        swipeRefreshLayout = rootView<span class="hljs-selector-class">.findViewById</span>(R.id.swipeRefreshLayout);
        progressBar = rootView<span class="hljs-selector-class">.findViewById</span>(R.id.progressBar);
        emptyView = rootView<span class="hljs-selector-class">.findViewById</span>(R.id.emptyView);
​
        <span class="hljs-comment">// 设置下拉刷新</span>
        swipeRefreshLayout<span class="hljs-selector-class">.setOnRefreshListener</span>(this);
​
        <span class="hljs-comment">// 设置RecyclerView</span>
        <span class="hljs-built_in">setupRecyclerView</span>();
​
        <span class="hljs-comment">// 初始状态显示加载进度</span>
        <span class="hljs-built_in">showLoading</span>(true);
    }
​
    <span class="hljs-keyword">@Override</span>
    protected void initData() {
        <span class="hljs-comment">// 加载第一页数据</span>
        <span class="hljs-built_in">loadNewsData</span>(<span class="hljs-number">1</span>, true);
    }
​
    <span class="hljs-keyword">@Override</span>
    protected void initListener() {
        <span class="hljs-comment">// RecyclerView的滚动监听，用于实现加载更多</span>
        recyclerView<span class="hljs-selector-class">.addOnScrollListener</span>(new RecyclerView.OnScrollListener() {
            <span class="hljs-keyword">@Override</span>
            public void onScrolled(<span class="hljs-keyword">@NonNull</span> RecyclerView recyclerView,
                                 int dx, int dy) {
                super<span class="hljs-selector-class">.onScrolled</span>(recyclerView, dx, dy);
​
                if (!isLoading &amp;&amp; hasMoreData) {
                    LinearLayoutManager layoutManager =
                        (LinearLayoutManager) recyclerView<span class="hljs-selector-class">.getLayoutManager</span>();
​
                    if (layoutManager != null) {
                        int visibleItemCount = layoutManager<span class="hljs-selector-class">.getChildCount</span>();
                        int totalItemCount = layoutManager<span class="hljs-selector-class">.getItemCount</span>();
                        int pastVisibleItems = layoutManager<span class="hljs-selector-class">.findFirstVisibleItemPosition</span>();
​
                        <span class="hljs-comment">// 当滚动到最后几个item时，加载更多数据</span>
                        if ((visibleItemCount + pastVisibleItems) &gt;= totalItemCount
                            &amp;&amp; totalItemCount &gt; <span class="hljs-number">0</span>) {
                            <span class="hljs-built_in">loadNewsData</span>(currentPage + <span class="hljs-number">1</span>, false);
                        }
                    }
                }
            }
        });
    }
​
    private void <span class="hljs-built_in">setupRecyclerView</span>() {
        newsAdapter = new <span class="hljs-built_in">NewsAdapter</span>(newsList, new NewsAdapter.OnItemClickListener() {
            <span class="hljs-keyword">@Override</span>
            public void onItemClick(NewsItem newsItem) {
                if (listener != null) {
                    listener<span class="hljs-selector-class">.onNewsSelected</span>(newsItem);
                }
            }
​
            <span class="hljs-keyword">@Override</span>
            public void onFavoriteClick(NewsItem newsItem) {
                if (listener != null) {
                    listener<span class="hljs-selector-class">.onNewsFavorite</span>(newsItem);
                }
                <span class="hljs-comment">// 更新本地状态</span>
                newsItem<span class="hljs-selector-class">.setFavorite</span>(!newsItem.isFavorite());
                newsAdapter<span class="hljs-selector-class">.notifyDataSetChanged</span>();
            }
​
            <span class="hljs-keyword">@Override</span>
            public void onShareClick(NewsItem newsItem) {
                if (listener != null) {
                    listener<span class="hljs-selector-class">.onNewsShare</span>(newsItem);
                }
            }
        });
​
        recyclerView<span class="hljs-selector-class">.setLayoutManager</span>(new LinearLayoutManager(context));
        recyclerView<span class="hljs-selector-class">.setAdapter</span>(newsAdapter);
​
        <span class="hljs-comment">// 添加分割线</span>
        recyclerView<span class="hljs-selector-class">.addItemDecoration</span>(new DividerItemDecoration(context,
            DividerItemDecoration.VERTICAL));
    }
​
    private void <span class="hljs-built_in">loadNewsData</span>(int page, boolean isRefresh) {
        if (isLoading) return;
​
        isLoading = true;
​
        if (isRefresh) {
            currentPage = <span class="hljs-number">1</span>;
            hasMoreData = true;
            if (!swipeRefreshLayout.isRefreshing()) {
                <span class="hljs-built_in">showLoading</span>(true);
            }
        } else {
            <span class="hljs-built_in">showLoadMore</span>(true);
        }
​
        <span class="hljs-comment">// 模拟网络请求延迟</span>
        new <span class="hljs-built_in">Handler</span>()<span class="hljs-selector-class">.postDelayed</span>(() -&gt; {
            List&lt;NewsItem&gt; newData = NewsRepository<span class="hljs-selector-class">.getInstance</span>()
                <span class="hljs-selector-class">.getNewsList</span>(page, <span class="hljs-number">20</span>);
​
            if (getActivity() == null) return; <span class="hljs-comment">// Fragment已经detached</span>
​
            if (isRefresh) {
                newsList<span class="hljs-selector-class">.clear</span>();
                newsList<span class="hljs-selector-class">.addAll</span>(newData);
            } else {
                newsList<span class="hljs-selector-class">.addAll</span>(newData);
            }
​
            <span class="hljs-comment">// 检查是否还有更多数据</span>
            hasMoreData = newData<span class="hljs-selector-class">.size</span>() &gt;= <span class="hljs-number">20</span>;
            currentPage = page;
​
            <span class="hljs-comment">// 更新UI</span>
            newsAdapter<span class="hljs-selector-class">.notifyDataSetChanged</span>();
​
            <span class="hljs-comment">// 隐藏加载状态</span>
            <span class="hljs-built_in">showLoading</span>(false);
            <span class="hljs-built_in">showLoadMore</span>(false);
            swipeRefreshLayout<span class="hljs-selector-class">.setRefreshing</span>(false);
​
            <span class="hljs-comment">// 显示空状态</span>
            if (newsList.isEmpty()) {
                <span class="hljs-built_in">showEmptyView</span>(true);
            } else {
                <span class="hljs-built_in">showEmptyView</span>(false);
            }
​
            isLoading = false;
​
        }, <span class="hljs-number">1500</span>); <span class="hljs-comment">// 模拟1.5秒的网络延迟</span>
    }
​
    <span class="hljs-keyword">@Override</span>
    public void onRefresh() {
        <span class="hljs-built_in">loadNewsData</span>(<span class="hljs-number">1</span>, true);
    }
​
    private void <span class="hljs-built_in">showLoading</span>(boolean show) {
        progressBar<span class="hljs-selector-class">.setVisibility</span>(show ? View.VISIBLE : View.GONE);
        if (show) {
            recyclerView<span class="hljs-selector-class">.setVisibility</span>(View.GONE);
            emptyView<span class="hljs-selector-class">.setVisibility</span>(View.GONE);
        }
    }
​
    private void <span class="hljs-built_in">showLoadMore</span>(boolean show) {
        if (newsAdapter != null) {
            newsAdapter<span class="hljs-selector-class">.setLoading</span>(show);
        }
    }
​
    private void <span class="hljs-built_in">showEmptyView</span>(boolean show) {
        emptyView<span class="hljs-selector-class">.setVisibility</span>(show ? View.VISIBLE : View.GONE);
        recyclerView<span class="hljs-selector-class">.setVisibility</span>(show ? View.GONE : View.VISIBLE);
    }
​
    <span class="hljs-comment">/**
     * 刷新数据
     */</span>
    public void <span class="hljs-built_in">refresh</span>() {
        if (swipeRefreshLayout != null &amp;&amp; !swipeRefreshLayout.isRefreshing()) {
            swipeRefreshLayout<span class="hljs-selector-class">.setRefreshing</span>(true);
        }
        <span class="hljs-built_in">onRefresh</span>();
    }
​
    <span class="hljs-comment">/**
     * 获取当前新闻列表
     */</span>
    public List&lt;NewsItem&gt; <span class="hljs-built_in">getNewsList</span>() {
        return new ArrayList&lt;&gt;(newsList);
    }
}
</code></pre>
<p>"NewsListFragment实现了完整的新闻列表功能，"李工解释道，"包括下拉刷新、加载更多、空状态显示等。"</p>
<p>对应的布局文件：</p>
<pre><code class="hljs language-ini" lang="ini">&lt;!-- fragment_news_list.xml --&gt;
&lt;androidx.swiperefreshlayout.widget.SwipeRefreshLayout
    xmlns:<span class="hljs-attr">android</span>=<span class="hljs-string">"http://schemas.android.com/apk/res/android"</span>
    xmlns:<span class="hljs-attr">app</span>=<span class="hljs-string">"http://schemas.android.com/apk/res-auto"</span>
    android:<span class="hljs-attr">id</span>=<span class="hljs-string">"@+id/swipeRefreshLayout"</span>
    android:<span class="hljs-attr">layout_width</span>=<span class="hljs-string">"match_parent"</span>
    android:<span class="hljs-attr">layout_height</span>=<span class="hljs-string">"match_parent"</span>&gt;
​
    &lt;FrameLayout
        android:<span class="hljs-attr">layout_width</span>=<span class="hljs-string">"match_parent"</span>
        android:<span class="hljs-attr">layout_height</span>=<span class="hljs-string">"match_parent"</span>&gt;
​
        &lt;androidx.recyclerview.widget.RecyclerView
            android:<span class="hljs-attr">id</span>=<span class="hljs-string">"@+id/recyclerView"</span>
            android:<span class="hljs-attr">layout_width</span>=<span class="hljs-string">"match_parent"</span>
            android:<span class="hljs-attr">layout_height</span>=<span class="hljs-string">"match_parent"</span>
            android:<span class="hljs-attr">clipToPadding</span>=<span class="hljs-string">"false"</span>
            android:<span class="hljs-attr">paddingTop</span>=<span class="hljs-string">"8dp"</span>
            android:<span class="hljs-attr">paddingBottom</span>=<span class="hljs-string">"8dp"</span> /&gt;
​
        &lt;ProgressBar
            android:<span class="hljs-attr">id</span>=<span class="hljs-string">"@+id/progressBar"</span>
            android:<span class="hljs-attr">layout_width</span>=<span class="hljs-string">"wrap_content"</span>
            android:<span class="hljs-attr">layout_height</span>=<span class="hljs-string">"wrap_content"</span>
            android:<span class="hljs-attr">layout_gravity</span>=<span class="hljs-string">"center"</span>
            android:<span class="hljs-attr">visibility</span>=<span class="hljs-string">"gone"</span> /&gt;
​
        &lt;LinearLayout
            android:<span class="hljs-attr">id</span>=<span class="hljs-string">"@+id/emptyView"</span>
            android:<span class="hljs-attr">layout_width</span>=<span class="hljs-string">"wrap_content"</span>
            android:<span class="hljs-attr">layout_height</span>=<span class="hljs-string">"wrap_content"</span>
            android:<span class="hljs-attr">layout_gravity</span>=<span class="hljs-string">"center"</span>
            android:<span class="hljs-attr">orientation</span>=<span class="hljs-string">"vertical"</span>
            android:<span class="hljs-attr">visibility</span>=<span class="hljs-string">"gone"</span>&gt;
​
            &lt;ImageView
                android:<span class="hljs-attr">layout_width</span>=<span class="hljs-string">"64dp"</span>
                android:<span class="hljs-attr">layout_height</span>=<span class="hljs-string">"64dp"</span>
                android:<span class="hljs-attr">layout_gravity</span>=<span class="hljs-string">"center_horizontal"</span>
                android:<span class="hljs-attr">src</span>=<span class="hljs-string">"@drawable/ic_empty_news"</span>
                android:<span class="hljs-attr">tint</span>=<span class="hljs-string">"@color/textSecondary"</span> /&gt;
​
            &lt;TextView
                android:<span class="hljs-attr">layout_width</span>=<span class="hljs-string">"wrap_content"</span>
                android:<span class="hljs-attr">layout_height</span>=<span class="hljs-string">"wrap_content"</span>
                android:<span class="hljs-attr">layout_marginTop</span>=<span class="hljs-string">"16dp"</span>
                android:<span class="hljs-attr">text</span>=<span class="hljs-string">"暂无新闻"</span>
                android:<span class="hljs-attr">textColor</span>=<span class="hljs-string">"@color/textSecondary"</span>
                android:<span class="hljs-attr">textSize</span>=<span class="hljs-string">"16sp"</span> /&gt;
​
            &lt;Button
                android:<span class="hljs-attr">id</span>=<span class="hljs-string">"@+id/btnRetry"</span>
                android:<span class="hljs-attr">layout_width</span>=<span class="hljs-string">"wrap_content"</span>
                android:<span class="hljs-attr">layout_height</span>=<span class="hljs-string">"wrap_content"</span>
                android:<span class="hljs-attr">layout_marginTop</span>=<span class="hljs-string">"16dp"</span>
                android:<span class="hljs-attr">text</span>=<span class="hljs-string">"重新加载"</span> /&gt;
​
        &lt;/LinearLayout&gt;
​
    &lt;/FrameLayout&gt;
​
&lt;/androidx.swiperefreshlayout.widget.SwipeRefreshLayout&gt;
</code></pre>
<h4 data-id="heading-15">第三步：创建NewsDetailFragment</h4>
<p>"接下来是新闻详情Fragment："</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// NewsDetailFragment.java</span>
public class NewsDetailFragment extends BaseFragment {
​
    private static final String ARG_NEWS_ITEM = "news_item";
    private static final String TAG = "NewsDetailFragment";
​
    <span class="hljs-comment">// UI组件</span>
    private TextView titleView;
    private TextView contentView;
    private TextView authorView;
    private TextView timeView;
    private ImageView coverImageView;
    private WebView webView;
    private FloatingActionButton fabFavorite;
    private FloatingActionButton fabShare;
    private ProgressBar progressBar;
​
    <span class="hljs-comment">// 数据</span>
    private NewsItem newsItem;
    private boolean isLoading = true;
​
    <span class="hljs-comment">// 回调接口</span>
    public interface OnDetailInteractionListener {
        void <span class="hljs-built_in">onNewsShare</span>(NewsItem newsItem);
        void <span class="hljs-built_in">onNewsFavorite</span>(NewsItem newsItem, boolean isFavorite);
        void <span class="hljs-built_in">onAuthorClick</span>(String authorId);
    }
​
    private OnDetailInteractionListener listener;
​
    public static NewsDetailFragment <span class="hljs-built_in">newInstance</span>(NewsItem newsItem) {
        NewsDetailFragment fragment = new <span class="hljs-built_in">NewsDetailFragment</span>();
        Bundle args = new <span class="hljs-built_in">Bundle</span>();
        args<span class="hljs-selector-class">.putParcelable</span>(ARG_NEWS_ITEM, newsItem);
        fragment<span class="hljs-selector-class">.setArguments</span>(args);
        return fragment;
    }
​
    <span class="hljs-keyword">@Override</span>
    public void onAttach(<span class="hljs-keyword">@NonNull</span> Context context) {
        super<span class="hljs-selector-class">.onAttach</span>(context);
        if (context instanceof OnDetailInteractionListener) {
            listener = (OnDetailInteractionListener) context;
        }
    }
​
    <span class="hljs-keyword">@Override</span>
    protected int getLayoutId() {
        return R<span class="hljs-selector-class">.layout</span><span class="hljs-selector-class">.fragment_news_detail</span>;
    }
​
    <span class="hljs-keyword">@Override</span>
    protected void initView() {
        titleView = rootView<span class="hljs-selector-class">.findViewById</span>(R.id.news_title);
        contentView = rootView<span class="hljs-selector-class">.findViewById</span>(R.id.news_content);
        authorView = rootView<span class="hljs-selector-class">.findViewById</span>(R.id.news_author);
        timeView = rootView<span class="hljs-selector-class">.findViewById</span>(R.id.news_time);
        coverImageView = rootView<span class="hljs-selector-class">.findViewById</span>(R.id.news_cover);
        webView = rootView<span class="hljs-selector-class">.findViewById</span>(R.id.news_webview);
        fabFavorite = rootView<span class="hljs-selector-class">.findViewById</span>(R.id.fab_favorite);
        fabShare = rootView<span class="hljs-selector-class">.findViewById</span>(R.id.fab_share);
        progressBar = rootView<span class="hljs-selector-class">.findViewById</span>(R.id.progressBar);
​
        <span class="hljs-comment">// 设置WebView</span>
        <span class="hljs-built_in">setupWebView</span>();
​
        <span class="hljs-comment">// 初始状态</span>
        <span class="hljs-built_in">showLoading</span>(true);
    }
​
    <span class="hljs-keyword">@Override</span>
    protected void initData() {
        Bundle args = <span class="hljs-built_in">getArguments</span>();
        if (args != null) {
            newsItem = args<span class="hljs-selector-class">.getParcelable</span>(ARG_NEWS_ITEM);
            if (newsItem != null) {
                <span class="hljs-built_in">loadNewsDetail</span>();
            }
        }
    }
​
    <span class="hljs-keyword">@Override</span>
    protected void initListener() {
        <span class="hljs-comment">// 收藏按钮点击</span>
        fabFavorite<span class="hljs-selector-class">.setOnClickListener</span>(v -&gt; {
            if (newsItem != null &amp;&amp; listener != null) {
                boolean newFavoriteState = !newsItem<span class="hljs-selector-class">.isFavorite</span>();
                newsItem<span class="hljs-selector-class">.setFavorite</span>(newFavoriteState);
                <span class="hljs-built_in">updateFavoriteIcon</span>(newFavoriteState);
                listener<span class="hljs-selector-class">.onNewsFavorite</span>(newsItem, newFavoriteState);
            }
        });
​
        <span class="hljs-comment">// 分享按钮点击</span>
        fabShare<span class="hljs-selector-class">.setOnClickListener</span>(v -&gt; {
            if (newsItem != null &amp;&amp; listener != null) {
                listener<span class="hljs-selector-class">.onNewsShare</span>(newsItem);
            }
        });
​
        <span class="hljs-comment">// 作者点击</span>
        authorView<span class="hljs-selector-class">.setOnClickListener</span>(v -&gt; {
            if (newsItem != null &amp;&amp; listener != null) {
                listener<span class="hljs-selector-class">.onAuthorClick</span>(newsItem.getAuthorId());
            }
        });
    }
​
    private void <span class="hljs-built_in">setupWebView</span>() {
        WebSettings webSettings = webView<span class="hljs-selector-class">.getSettings</span>();
        webSettings<span class="hljs-selector-class">.setJavaScriptEnabled</span>(true);
        webSettings<span class="hljs-selector-class">.setDomStorageEnabled</span>(true);
        webSettings<span class="hljs-selector-class">.setAppCacheEnabled</span>(true);
        webSettings<span class="hljs-selector-class">.setCacheMode</span>(WebSettings.LOAD_DEFAULT);
​
        <span class="hljs-comment">// 启用缩放</span>
        webSettings<span class="hljs-selector-class">.setSupportZoom</span>(true);
        webSettings<span class="hljs-selector-class">.setBuiltInZoomControls</span>(true);
        webSettings<span class="hljs-selector-class">.setDisplayZoomControls</span>(false);
​
        <span class="hljs-comment">// 启用响应式布局</span>
        webSettings<span class="hljs-selector-class">.setUseWideViewPort</span>(true);
        webSettings<span class="hljs-selector-class">.setLoadWithOverviewMode</span>(true);
​
        webView<span class="hljs-selector-class">.setWebViewClient</span>(new WebViewClient() {
            <span class="hljs-keyword">@Override</span>
            public void onPageStarted(WebView view, String url, Bitmap favicon) {
                super<span class="hljs-selector-class">.onPageStarted</span>(view, url, favicon);
                isLoading = true;
                <span class="hljs-built_in">updateLoadingState</span>();
            }
​
            <span class="hljs-keyword">@Override</span>
            public void onPageFinished(WebView view, String url) {
                super<span class="hljs-selector-class">.onPageFinished</span>(view, url);
                isLoading = false;
                <span class="hljs-built_in">updateLoadingState</span>();
            }
​
            <span class="hljs-keyword">@Override</span>
            public void onReceivedError(WebView view, int errorCode,
                                       String description, String failingUrl) {
                super<span class="hljs-selector-class">.onReceivedError</span>(view, errorCode, description, failingUrl);
                <span class="hljs-built_in">showError</span>("加载失败：" + description);
            }
        });
    }
​
    private void <span class="hljs-built_in">loadNewsDetail</span>() {
        if (newsItem == null) return;
​
        <span class="hljs-comment">// 设置基本信息</span>
        titleView<span class="hljs-selector-class">.setText</span>(newsItem.getTitle());
        authorView<span class="hljs-selector-class">.setText</span>("作者：" + newsItem.getAuthor());
        timeView<span class="hljs-selector-class">.setText</span>(formatTime(newsItem.getPublishTime()));
​
        <span class="hljs-comment">// 加载封面图片</span>
        if (!TextUtils.isEmpty(newsItem.getCoverImageUrl())) {
            Picasso<span class="hljs-selector-class">.get</span>()
                <span class="hljs-selector-class">.load</span>(newsItem.getCoverImageUrl())
                <span class="hljs-selector-class">.placeholder</span>(R.drawable.placeholder_news)
                <span class="hljs-selector-class">.error</span>(R.drawable.error_news)
                <span class="hljs-selector-class">.into</span>(coverImageView);
        } else {
            coverImageView<span class="hljs-selector-class">.setVisibility</span>(View.GONE);
        }
​
        <span class="hljs-comment">// 更新收藏按钮状态</span>
        <span class="hljs-built_in">updateFavoriteIcon</span>(newsItem.isFavorite());
​
        <span class="hljs-comment">// 加载详细内容</span>
        <span class="hljs-built_in">loadDetailedContent</span>();
    }
​
    private void <span class="hljs-built_in">loadDetailedContent</span>() {
        <span class="hljs-comment">// 模拟加载详细内容</span>
        new <span class="hljs-built_in">Handler</span>()<span class="hljs-selector-class">.postDelayed</span>(() -&gt; {
            if (getActivity() == null) return;
​
            <span class="hljs-comment">// 如果有HTML内容，使用WebView显示</span>
            if (!TextUtils.isEmpty(newsItem.getHtmlContent())) {
                <span class="hljs-built_in">loadHtmlContent</span>(newsItem.getHtmlContent());
            } else {
                <span class="hljs-comment">// 否则显示纯文本内容</span>
                <span class="hljs-built_in">loadTextContent</span>(newsItem.getContent());
            }
​
            isLoading = false;
            <span class="hljs-built_in">updateLoadingState</span>();
​
        }, <span class="hljs-number">1000</span>);
    }
​
    private void <span class="hljs-built_in">loadHtmlContent</span>(String htmlContent) {
        <span class="hljs-comment">// 构建完整的HTML页面</span>
        String <span class="hljs-selector-tag">html</span> = <span class="hljs-built_in">buildHtmlPage</span>(htmlContent);
        webView<span class="hljs-selector-class">.loadDataWithBaseURL</span>(null, html, "text/html", "UTF-<span class="hljs-number">8</span>", null);
​
        webView<span class="hljs-selector-class">.setVisibility</span>(View.VISIBLE);
        contentView<span class="hljs-selector-class">.setVisibility</span>(View.GONE);
    }
​
    private void <span class="hljs-built_in">loadTextContent</span>(String textContent) {
        contentView<span class="hljs-selector-class">.setText</span>(textContent);
        contentView<span class="hljs-selector-class">.setVisibility</span>(View.VISIBLE);
        webView<span class="hljs-selector-class">.setVisibility</span>(View.GONE);
    }
​
    private String <span class="hljs-built_in">buildHtmlPage</span>(String content) {
        StringBuilder <span class="hljs-selector-tag">html</span> = new <span class="hljs-built_in">StringBuilder</span>();
        <span class="hljs-selector-tag">html</span><span class="hljs-selector-class">.append</span>("&lt;!DOCTYPE html&gt;");
        <span class="hljs-selector-tag">html</span><span class="hljs-selector-class">.append</span>("&lt;html&gt;");
        <span class="hljs-selector-tag">html</span><span class="hljs-selector-class">.append</span>("&lt;head&gt;");
        <span class="hljs-selector-tag">html</span><span class="hljs-selector-class">.append</span>("&lt;meta charset="UTF-<span class="hljs-number">8</span>"&gt;");
        <span class="hljs-selector-tag">html</span><span class="hljs-selector-class">.append</span>("&lt;meta name="viewport" content="width=device-width, initial-scale=<span class="hljs-number">1.0</span>"&gt;");
        <span class="hljs-selector-tag">html</span><span class="hljs-selector-class">.append</span>("&lt;style&gt;");
        <span class="hljs-selector-tag">html</span><span class="hljs-selector-class">.append</span>("body { font-family: Arial, sans-serif; font-size: <span class="hljs-number">16px</span>; line-height: <span class="hljs-number">1.6</span>; margin: <span class="hljs-number">16px</span>; }");
        <span class="hljs-selector-tag">html</span><span class="hljs-selector-class">.append</span>("img { max-width: <span class="hljs-number">100%</span>; height: auto; }");
        <span class="hljs-selector-tag">html</span><span class="hljs-selector-class">.append</span>("p { margin: <span class="hljs-number">16px</span> <span class="hljs-number">0</span>; }");
        <span class="hljs-selector-tag">html</span><span class="hljs-selector-class">.append</span>("h1, h2, h3 { color: #<span class="hljs-number">333</span>; }");
        <span class="hljs-selector-tag">html</span><span class="hljs-selector-class">.append</span>("&lt;/style&gt;");
        <span class="hljs-selector-tag">html</span><span class="hljs-selector-class">.append</span>("&lt;/head&gt;");
        <span class="hljs-selector-tag">html</span><span class="hljs-selector-class">.append</span>("&lt;body&gt;");
        <span class="hljs-selector-tag">html</span><span class="hljs-selector-class">.append</span>(content);
        <span class="hljs-selector-tag">html</span><span class="hljs-selector-class">.append</span>("&lt;/body&gt;");
        <span class="hljs-selector-tag">html</span><span class="hljs-selector-class">.append</span>("&lt;/html&gt;");
        return <span class="hljs-selector-tag">html</span><span class="hljs-selector-class">.toString</span>();
    }
​
    private void <span class="hljs-built_in">updateLoadingState</span>() {
        if (isLoading) {
            <span class="hljs-built_in">showLoading</span>(true);
        } else {
            <span class="hljs-built_in">showLoading</span>(false);
        }
    }
​
    private void <span class="hljs-built_in">showLoading</span>(boolean show) {
        progressBar<span class="hljs-selector-class">.setVisibility</span>(show ? View.VISIBLE : View.GONE);
    }
​
    private void <span class="hljs-built_in">showError</span>(String error) {
        if (getContext() != null) {
            Toast<span class="hljs-selector-class">.makeText</span>(getContext(), error, Toast<span class="hljs-selector-class">.LENGTH_SHORT</span>)<span class="hljs-selector-class">.show</span>();
        }
    }
​
    private void <span class="hljs-built_in">updateFavoriteIcon</span>(boolean isFavorite) {
        fabFavorite<span class="hljs-selector-class">.setImageResource</span>(isFavorite ?
            R.drawable.ic_favorite_filled : R.drawable.ic_favorite_border);
    }
​
    private String <span class="hljs-built_in">formatTime</span>(long timestamp) {
        Date date = new <span class="hljs-built_in">Date</span>(timestamp);
        SimpleDateFormat format = new <span class="hljs-built_in">SimpleDateFormat</span>("yyyy-MM-dd HH:mm", Locale.getDefault());
        return format<span class="hljs-selector-class">.format</span>(date);
    }
​
    <span class="hljs-comment">/**
     * 更新新闻内容
     */</span>
    public void <span class="hljs-built_in">updateNews</span>(NewsItem newsItem) {
        this<span class="hljs-selector-class">.newsItem</span> = newsItem;
        if (isAdded()) {
            <span class="hljs-built_in">loadNewsDetail</span>();
        }
    }
​
    <span class="hljs-comment">/**
     * 分享新闻
     */</span>
    public void <span class="hljs-built_in">shareNews</span>() {
        if (newsItem != null &amp;&amp; listener != null) {
            listener<span class="hljs-selector-class">.onNewsShare</span>(newsItem);
        }
    }
}
</code></pre>
<h3 data-id="heading-16">Activity的重构</h3>
<p>"现在Fragment都准备好了，让我们重构Activity："李工开始创建新的Activity结构。</p>
<h4 data-id="heading-17">单Activity架构</h4>
<p>"现代Android开发推荐使用单Activity + 多Fragment的架构，"李工解释道，"这样可以避免Activity之间跳转的开销，同时提供更流畅的用户体验。"</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// MainActivity.java</span>
public class MainActivity extends AppCompatActivity implements
        NewsListFragment<span class="hljs-selector-class">.OnNewsInteractionListener</span>,
        NewsDetailFragment<span class="hljs-selector-class">.OnDetailInteractionListener</span> {
​
    private static final String TAG = "MainActivity";
​
    <span class="hljs-comment">// Fragment容器ID</span>
    private static final int FRAGMENT_CONTAINER_ID = R<span class="hljs-selector-class">.id</span><span class="hljs-selector-class">.fragment_container</span>;
​
    <span class="hljs-comment">// 当前显示的Fragment</span>
    private Fragment currentFragment;
​
    <span class="hljs-comment">// 是否是平板布局</span>
    private boolean isTwoPane;
​
    <span class="hljs-comment">// Fragment引用</span>
    private NewsListFragment newsListFragment;
    private NewsDetailFragment newsDetailFragment;
​
    <span class="hljs-keyword">@Override</span>
    protected void onCreate(Bundle savedInstanceState) {
        super<span class="hljs-selector-class">.onCreate</span>(savedInstanceState);
​
        <span class="hljs-comment">// 根据设备类型选择不同的布局</span>
        if (isTablet()) {
            <span class="hljs-built_in">setContentView</span>(R.layout.activity_main_tablet);
            isTwoPane = true;
        } else {
            <span class="hljs-built_in">setContentView</span>(R.layout.activity_main_phone);
            isTwoPane = false;
        }
​
        <span class="hljs-built_in">initFragments</span>();
​
        if (savedInstanceState == null) {
            <span class="hljs-built_in">showNewsList</span>();
        }
    }
​
    private boolean <span class="hljs-built_in">isTablet</span>() {
        return <span class="hljs-built_in">getResources</span>()<span class="hljs-selector-class">.getBoolean</span>(R.bool.isTablet);
    }
​
    private void <span class="hljs-built_in">initFragments</span>() {
        FragmentManager fm = <span class="hljs-built_in">getSupportFragmentManager</span>();
​
        newsListFragment = (NewsListFragment) fm<span class="hljs-selector-class">.findFragmentByTag</span>("news_list");
        newsDetailFragment = (NewsDetailFragment) fm<span class="hljs-selector-class">.findFragmentByTag</span>("news_detail");
​
        if (newsListFragment == null) {
            newsListFragment = NewsListFragment<span class="hljs-selector-class">.newInstance</span>();
        }
​
        if (newsDetailFragment == null &amp;&amp; isTwoPane) {
            newsDetailFragment = NewsDetailFragment<span class="hljs-selector-class">.newInstance</span>(null);
        }
    }
​
    private void <span class="hljs-built_in">showNewsList</span>() {
        FragmentTransaction ft = <span class="hljs-built_in">getSupportFragmentManager</span>()<span class="hljs-selector-class">.beginTransaction</span>();
​
        if (isTwoPane) {
            <span class="hljs-comment">// 平板：显示列表和详情</span>
            if (newsDetailFragment == null) {
                newsDetailFragment = NewsDetailFragment<span class="hljs-selector-class">.newInstance</span>(null);
            }
​
            ft<span class="hljs-selector-class">.replace</span>(R.id.news_list_container, newsListFragment, "news_list");
            ft<span class="hljs-selector-class">.replace</span>(R.id.news_detail_container, newsDetailFragment, "news_detail");
        } else {
            <span class="hljs-comment">// 手机：只显示列表</span>
            ft<span class="hljs-selector-class">.replace</span>(FRAGMENT_CONTAINER_ID, newsListFragment, "news_list");
        }
​
        ft<span class="hljs-selector-class">.commit</span>();
        currentFragment = newsListFragment;
    }
​
    <span class="hljs-keyword">@Override</span>
    public void onNewsSelected(NewsItem newsItem) {
        if (isTwoPane) {
            <span class="hljs-comment">// 平板：更新详情Fragment</span>
            if (newsDetailFragment != null) {
                newsDetailFragment<span class="hljs-selector-class">.updateNews</span>(newsItem);
            }
        } else {
            <span class="hljs-comment">// 手机：替换为详情Fragment</span>
            newsDetailFragment = NewsDetailFragment<span class="hljs-selector-class">.newInstance</span>(newsItem);
​
            <span class="hljs-built_in">getSupportFragmentManager</span>()
                <span class="hljs-selector-class">.beginTransaction</span>()
                <span class="hljs-selector-class">.replace</span>(FRAGMENT_CONTAINER_ID, newsDetailFragment, "news_detail")
                <span class="hljs-selector-class">.addToBackStack</span>("news_detail")
                <span class="hljs-selector-class">.commit</span>();
​
            currentFragment = newsDetailFragment;
        }
    }
​
    <span class="hljs-keyword">@Override</span>
    public void onNewsFavorite(NewsItem newsItem) {
        <span class="hljs-comment">// 处理收藏逻辑</span>
        NewsRepository<span class="hljs-selector-class">.getInstance</span>()<span class="hljs-selector-class">.updateFavoriteStatus</span>(newsItem);
        Toast<span class="hljs-selector-class">.makeText</span>(this, "已" + (newsItem.isFavorite() ? "收藏" : <span class="hljs-string">"取消收藏"</span>),
                      Toast.LENGTH_SHORT).<span class="hljs-built_in">show</span>();
    }
​
    <span class="hljs-keyword">@Override</span>
    public void onNewsShare(NewsItem newsItem) {
        <span class="hljs-comment">// 处理分享逻辑</span>
        <span class="hljs-built_in">shareNews</span>(newsItem);
    }
​
    <span class="hljs-keyword">@Override</span>
    public void onAuthorClick(String authorId) {
        <span class="hljs-comment">// 跳转到作者页面</span>
        AuthorFragment authorFragment = AuthorFragment<span class="hljs-selector-class">.newInstance</span>(authorId);
​
        <span class="hljs-built_in">getSupportFragmentManager</span>()
            <span class="hljs-selector-class">.beginTransaction</span>()
            <span class="hljs-selector-class">.replace</span>(FRAGMENT_CONTAINER_ID, authorFragment, "author")
            <span class="hljs-selector-class">.addToBackStack</span>("author")
            <span class="hljs-selector-class">.commit</span>();
​
        currentFragment = authorFragment;
    }
​
    <span class="hljs-keyword">@Override</span>
    public void onNewsFavorite(NewsItem newsItem, boolean isFavorite) {
        <span class="hljs-comment">// 处理详情页面的收藏操作</span>
        NewsRepository<span class="hljs-selector-class">.getInstance</span>()<span class="hljs-selector-class">.updateFavoriteStatus</span>(newsItem);
        Toast<span class="hljs-selector-class">.makeText</span>(this, "已" + (isFavorite ? "收藏" : "取消收藏"),
                      Toast<span class="hljs-selector-class">.LENGTH_SHORT</span>)<span class="hljs-selector-class">.show</span>();
    }
​
    private void <span class="hljs-built_in">shareNews</span>(NewsItem newsItem) {
        Intent shareIntent = new <span class="hljs-built_in">Intent</span>(Intent.ACTION_SEND);
        shareIntent<span class="hljs-selector-class">.setType</span>("text/plain");
        shareIntent<span class="hljs-selector-class">.putExtra</span>(Intent.EXTRA_SUBJECT, newsItem.getTitle());
        shareIntent<span class="hljs-selector-class">.putExtra</span>(Intent.EXTRA_TEXT, newsItem.getTitle() + "\n" + newsItem<span class="hljs-selector-class">.getShareUrl</span>());
        <span class="hljs-built_in">startActivity</span>(Intent.createChooser(shareIntent, "分享新闻"));
    }
​
    <span class="hljs-keyword">@Override</span>
    public void onBackPressed() {
        FragmentManager fm = <span class="hljs-built_in">getSupportFragmentManager</span>();
​
        if (fm.getBackStackEntryCount() &gt; <span class="hljs-number">0</span>) {
            fm<span class="hljs-selector-class">.popBackStack</span>();
        } else {
            super<span class="hljs-selector-class">.onBackPressed</span>();
        }
    }
}
</code></pre>
<p>对应的布局文件：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- activity_main_phone.xml --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">FrameLayout</span> <span class="hljs-attr">xmlns:android</span>=<span class="hljs-string">"http://schemas.android.com/apk/res/android"</span>
    <span class="hljs-attr">android:id</span>=<span class="hljs-string">"@+id/fragment_container"</span>
    <span class="hljs-attr">android:layout_width</span>=<span class="hljs-string">"match_parent"</span>
    <span class="hljs-attr">android:layout_height</span>=<span class="hljs-string">"match_parent"</span> /&gt;</span>
</code></pre>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- activity_main_tablet.xml --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">LinearLayout</span> <span class="hljs-attr">xmlns:android</span>=<span class="hljs-string">"http://schemas.android.com/apk/res/android"</span>
    <span class="hljs-attr">android:layout_width</span>=<span class="hljs-string">"match_parent"</span>
    <span class="hljs-attr">android:layout_height</span>=<span class="hljs-string">"match_parent"</span>
    <span class="hljs-attr">android:orientation</span>=<span class="hljs-string">"horizontal"</span>
    <span class="hljs-attr">android:baselineAligned</span>=<span class="hljs-string">"false"</span>&gt;</span>

    <span class="hljs-comment">&lt;!-- 左侧：新闻列表 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">FrameLayout</span>
        <span class="hljs-attr">android:id</span>=<span class="hljs-string">"@+id/news_list_container"</span>
        <span class="hljs-attr">android:layout_width</span>=<span class="hljs-string">"0dp"</span>
        <span class="hljs-attr">android:layout_height</span>=<span class="hljs-string">"match_parent"</span>
        <span class="hljs-attr">android:layout_weight</span>=<span class="hljs-string">"1"</span> /&gt;</span>

    <span class="hljs-comment">&lt;!-- 右侧：新闻详情 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">FrameLayout</span>
        <span class="hljs-attr">android:id</span>=<span class="hljs-string">"@+id/news_detail_container"</span>
        <span class="hljs-attr">android:layout_width</span>=<span class="hljs-string">"0dp"</span>
        <span class="hljs-attr">android:layout_height</span>=<span class="hljs-string">"match_parent"</span>
        <span class="hljs-attr">android:layout_weight</span>=<span class="hljs-string">"1"</span> /&gt;</span>

<span class="hljs-tag">&lt;/<span class="hljs-name">LinearLayout</span>&gt;</span>
</code></pre>
<h3 data-id="heading-18">重构完成：模块化的胜利</h3>
<p>经过一下午的重构，NewsHub应用的架构焕然一新。小安看着重构后的代码，脸上露出了满意的笑容。</p>
<p>"李工，这简直太神奇了！"小安兴奋地说道，"代码重复率从70%降到了几乎为0，而且逻辑更清晰了！"</p>
<p>李工笑着点点头："这就是Fragment的力量。让我们总结一下这次重构的成果："</p>
<h4 data-id="heading-19">重构前后对比</h4>
<p><strong>重构前的问题：</strong></p>
<ol start="0">
<li>代码重复率高（70%以上）</li>
<li>手机/平板逻辑混合在一个Activity中</li>
<li>难以维护和扩展</li>
<li>违反了单一职责原则</li>
</ol>
<p><strong>重构后的优势：</strong></p>
<ol start="0">
<li><strong>代码复用性大幅提升</strong></li>
</ol>
<pre><code class="hljs language-ini" lang="ini">// NewsListFragment在手机和平板上完全复用
NewsListFragment <span class="hljs-attr">listFragment</span> = NewsListFragment.newInstance()<span class="hljs-comment">;</span>
</code></pre>
<ol start="2">
<li><strong>职责分离更清晰</strong></li>
</ol>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-comment">// Activity：负责Fragment的组装和管理</span>
<span class="hljs-comment">// NewsListFragment：负责新闻列表的显示和交互</span>
<span class="hljs-comment">// NewsDetailFragment：负责新闻详情的显示和交互</span>
</code></pre>
<ol start="3">
<li><strong>扩展性更强</strong></li>
</ol>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// 轻松添加新的Fragment</span>
UserFragment userFragment = UserFragment<span class="hljs-selector-class">.newInstance</span>();
<span class="hljs-built_in">getSupportFragmentManager</span>()
    <span class="hljs-selector-class">.beginTransaction</span>()
    <span class="hljs-selector-class">.replace</span>(R.id.fragment_container, userFragment)
    <span class="hljs-selector-class">.addToBackStack</span>("user")
    <span class="hljs-selector-class">.commit</span>();
</code></pre>
<ol start="4">
<li><strong>测试更容易</strong></li>
</ol>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 每个Fragment可以独立测试</span>
<span class="hljs-meta">@Test</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testNewsListFragment</span><span class="hljs-params">()</span> {
    <span class="hljs-type">NewsListFragment</span> <span class="hljs-variable">fragment</span> <span class="hljs-operator">=</span> NewsListFragment.newInstance();
    <span class="hljs-comment">// 测试Fragment的逻辑</span>
}
</code></pre>
<h4 data-id="heading-20">代码质量指标对比</h4>



































<table><thead><tr><th>指标</th><th>重构前</th><th>重构后</th><th>改善幅度</th></tr></thead><tbody><tr><td>代码重复率</td><td>70%</td><td>5%</td><td>↓93%</td></tr><tr><td>类的平均行数</td><td>450行</td><td>200行</td><td>↓56%</td></tr><tr><td>圈复杂度</td><td>18</td><td>8</td><td>↓56%</td></tr><tr><td>单元测试覆盖率</td><td>35%</td><td>85%</td><td>↑143%</td></tr></tbody></table>
<h4 data-id="heading-21">Fragment设计原则总结</h4>
<p>李工在白板上写下了Fragment的核心设计原则：</p>
<p>"记住这五个Fragment设计原则，你的代码会一直保持高质量："</p>
<ol start="0">
<li>
<p><strong>单一职责原则</strong></p>
<ul>
<li>每个Fragment只负责一个特定的UI功能</li>
<li>NewsListFragment只管列表，NewsDetailFragment只管详情</li>
</ul>
</li>
<li>
<p><strong>依赖倒置原则</strong></p>
<ul>
<li>Fragment通过接口与Activity通信</li>
<li>不直接依赖具体的Activity实现</li>
</ul>
</li>
<li>
<p><strong>开闭原则</strong></p>
<ul>
<li>对扩展开放，对修改关闭</li>
<li>通过添加新Fragment来扩展功能</li>
</ul>
</li>
<li>
<p><strong>组合优于继承</strong></p>
<ul>
<li>Fragment作为UI组件的组合单元</li>
<li>Activity通过组合Fragment来构建复杂界面</li>
</ul>
</li>
<li>
<p><strong>生命周期意识</strong></p>
<ul>
<li>正确处理Fragment的生命周期</li>
<li>避免在Fragment销毁后执行回调</li>
</ul>
</li>
</ol>
<h3 data-id="heading-22">展望未来</h3>
<p>"小安，你觉得这次重构最大的收获是什么？"李工问道。</p>
<p>小安思考了一会儿，认真地回答："我觉得最大的收获是理解了<strong>模块化思维</strong>。以前我总是想着把所有功能都写在一个Activity里，现在学会了把复杂的功能拆分成独立的、可复用的模块。"</p>
<p>"非常好！"李工赞许地点头，"这正是Fragment的核心思想。而且这只是一个开始，随着你学习的深入，你会发现还有更多精彩的内容："</p>
<ol start="0">
<li>
<p><strong>Fragment通信的高级技巧</strong></p>
<ul>
<li>ViewModel + LiveData</li>
<li>Navigation Component</li>
<li>Shared ViewModel</li>
</ul>
</li>
<li>
<p><strong>Fragment的性能优化</strong></p>
<ul>
<li>懒加载机制</li>
<li>View缓存策略</li>
<li>内存管理</li>
</ul>
</li>
<li>
<p><strong>Fragment的进阶用法</strong></p>
<ul>
<li>嵌套Fragment</li>
<li>ViewPager + Fragment</li>
<li>DialogFragment</li>
</ul>
</li>
<li>
<p><strong>Fragment的最佳实践</strong></p>
<ul>
<li>架构模式集成</li>
<li>测试策略</li>
<li>调试技巧</li>
</ul>
</li>
</ol>
<p>"从下节课开始，我们将深入探索Fragment的生命周期。"李工看了一下表，"你会发现，理解生命周期是掌握Fragment的关键。"</p>
<p>小安兴奋地看着屏幕上重构后的代码，仿佛看到了一个全新的世界。这次与Fragment的初识，不仅解决了他眼前的技术难题，更重要的是打开了一扇通往Android高级开发的大门。</p>
<p>夕阳西下，办公室的灯光陆续熄灭，但小安的编程热情却前所未有地高涨。他迫不及待地想要开始下一段学习旅程，探索Fragment这个强大组件的更多奥秘。</p>
<p><strong>故事完</strong></p>
<hr/>
<h3 data-id="heading-23">知识要点总结</h3>
<h4 data-id="heading-24">Fragment的核心概念</h4>
<ol start="0">
<li><strong>Fragment是什么</strong>：UI模块化组件，可以嵌入Activity中</li>
<li><strong>为什么需要Fragment</strong>：解决多屏适配、代码复用、模块化开发等问题</li>
<li><strong>Fragment与Activity的关系</strong>：容器与模块的关系，Fragment依赖Activity</li>
</ol>
<h4 data-id="heading-25">Fragment的创建方式</h4>
<ol start="0">
<li><strong>静态加载</strong>：在XML中直接声明，简单但不灵活</li>
<li><strong>动态加载</strong>：在代码中通过FragmentTransaction管理，灵活性高</li>
<li><strong>工厂模式</strong>：推荐的创建方式，确保参数安全和创建统一</li>
</ol>
<h4 data-id="heading-26">Fragment的最佳实践</h4>
<ol start="0">
<li><strong>BaseFragment设计</strong>：提取通用功能，减少代码重复</li>
<li><strong>接口回调</strong>：Fragment与Activity的安全通信方式</li>
<li><strong>生命周期管理</strong>：正确处理各个生命周期阶段</li>
<li><strong>单Activity架构</strong>：现代Android开发的推荐模式</li>
</ol>
<h4 data-id="heading-27">实战技能</h4>
<ol start="0">
<li><strong>重构现有代码</strong>：将Activity-Based架构重构为Fragment-Based</li>
<li><strong>多屏适配</strong>：一套代码适配手机和平板</li>
<li><strong>模块化设计</strong>：将复杂功能拆分为独立模块</li>
<li><strong>代码质量提升</strong>：降低重复率，提高可维护性</li>
</ol>
<p>本章通过NewsHub应用的实际案例，完整展示了Fragment从理论到实践的整个过程，为后续章节的深入学习奠定了坚实的基础。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Android Auto开发（0）-引言]]></title>    <link>https://juejin.cn/post/7577278843234746411</link>    <guid>https://juejin.cn/post/7577278843234746411</guid>    <pubDate>2025-11-28T01:59:35.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577278843234746411" data-draft-id="7577291435160141865" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Android Auto开发（0）-引言"/> <meta itemprop="keywords" content="Android"/> <meta itemprop="datePublished" content="2025-11-28T01:59:35.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="成都大菠萝"/> <meta itemprop="url" content="https://juejin.cn/user/289926799429805"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Android Auto开发（0）-引言
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/289926799429805/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    成都大菠萝
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-28T01:59:35.000Z" title="Fri Nov 28 2025 01:59:35 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-28
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0"><strong>Head Unit Integration Guide (HUIG) 4.3</strong></h2>
<h3 data-id="heading-1"><strong>第 0 章：引言（Introduction）</strong></h3>
<h4 data-id="heading-2"><strong>0. 引言概述</strong></h4>
<p>当今的移动设备集成了尖端技术——包括最新的硬件与软件、高速移动网络，以及不断扩展的互联服务与应用程序生态。这些技术的融合，为用户提供了全新的方式来通信、享受数字内容、获取信息、学习，并探索周围世界。</p>
<p>然而，<strong>这些设备并非为驾驶场景设计</strong>。在驾驶过程中直接操作手机存在显著的安全风险。</p>
<p>为此，<strong>Android Auto</strong>（<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.android.com%2Fauto" target="_blank" title="https://www.android.com/auto" ref="nofollow noopener noreferrer">www.android.com/auto</a>）应运而生。它实现了移动设备与车辆之间的无缝集成，使驾驶员能够通过一个<strong>更简单、更安全的车载界面</strong>，访问并控制移动设备上的技术功能。</p>
<p>本指南描述了如何通过 <strong>Android Auto Projection</strong>（AAP） 技术，使汽车<strong>车载信息娱乐系统</strong>（IVI） 能够利用现代移动设备的计算能力、连接能力和应用生态。<br/>
本文件面向希望在其<strong>车机</strong>（Head Unit, HU） 的汽车信息娱乐系统开发团队，旨在帮助其通过 Android Auto 认证。</p>
<blockquote>
<p>⚠️ <strong>注意</strong>：<br/>
本指南<strong>不涉及 AAP 协议底层实现细节</strong>（如序列化格式、网络帧结构等），这些由 Google 提供的 <strong>Sender/Receiver 库</strong> 在 HU 与移动设备（MD）两端自动处理。<br/>
如需协议细节，请参考：</p>
<ul>
<li><a href="/auto/resources/receiver-lib" target="_blank" title="/auto/resources/receiver-lib">AAP Receiver Library 文档</a></li>
<li><a href="/auto/resources/proto-spec" target="_blank" title="/auto/resources/proto-spec">Protocol Specification（协议规范）</a></li>
</ul>
</blockquote>
<hr/>
<h4 data-id="heading-3"><strong>0.1 规范性用语约定（Conventions）</strong></h4>
<p>本文档中使用的关键词 <strong>“MUST”</strong>（必须）、<strong>“MUST NOT”</strong>（不得）、<strong>“REQUIRED”</strong>（必需）、<strong>“SHALL”</strong>（应）、<strong>“SHALL NOT”</strong>（不应）、<strong>“SHOULD”</strong>（建议）、<strong>“SHOULD NOT”</strong>（不建议）、<strong>“RECOMMENDED”</strong>（推荐）、<strong>“MAY”</strong>（可以）、<strong>“OPTIONAL”</strong>（可选）等，均遵循 <strong>IETF RFC 2119 标准</strong> 的定义。</p>
<ul>
<li><strong>MUST / SHALL</strong>：表示绝对强制要求，违反将导致认证失败。</li>
<li><strong>SHOULD / RECOMMENDED</strong>：强烈建议遵循，以确保最佳用户体验。</li>
<li><strong>MAY / OPTIONAL</strong>：可选实现，不影响基本功能认证。</li>
</ul>
<hr/>
<h4 data-id="heading-4">**0.2 关于 Android Auto Projection（AAP）</h4>
<p><strong>Android Auto Projection</strong>（AAP） 是连接移动设备与车辆的桥梁，使驾驶员能够通过车辆提供的<strong>物理人机交互界面</strong>（HMI）（如触摸屏、旋钮、语音按钮等）来访问移动设备的功能。</p>
<p>在 AAP 架构中：</p>
<ul>
<li><strong>移动设备</strong>（MD）负责管理所有<strong>用户界面</strong>（UI）、<strong>应用逻辑</strong>、<strong>网络连接</strong>及<strong>计算资源</strong>；</li>
<li><strong>车机</strong>（HU）则作为显示与输入终端，接收来自 MD 的投影内容，并将用户操作反馈回 MD。</li>
</ul>
<p>这种架构充分发挥了<strong>车辆与移动设备各自的优势</strong>，共同打造最优驾驶体验：</p>

















<table><thead><tr><th>来源</th><th>提供的能力</th></tr></thead><tbody><tr><td><strong>车辆 HU</strong></td><td>• 更适合驾驶场景的 HMI（如大按钮、语音优先）<br/>• 高精度车辆数据（如 GPS、轮速、档位、燃油状态等），提供更准确的驾驶环境上下文</td></tr><tr><td><strong>移动设备</strong>（MD）</td><td>• 最新的计算硬件平台（如高性能 CPU/GPU）<br/>• 最新的操作系统与安全更新<br/>• 高速移动网络（5G/4G）连接云端服务<br/>• 快速迭代的软硬件生态（消费电子级更新节奏）</td></tr></tbody></table>
<blockquote>
<p>✅ <strong>核心理念</strong>：<strong>“App 在手机跑，界面在车机显”</strong> —— 手机是“大脑”，车机是“眼睛和手”。</p>
</blockquote>
<hr/>
<h4 data-id="heading-5">**0.3 传输层（Transport）</h4>
<p>AAP 协议本身是<strong>传输无关</strong>（transport-agnostic） 的，只要传输通道具备<strong>足够带宽与低延迟</strong>，即可运行。</p>
<p>目前官方平台支持的传输方式包括：</p>
<ul>
<li><strong>USB 2.0</strong>：自 Android Auto 诞生起即支持，为有线连接标准；</li>
<li><strong>无线局域网</strong>（Wi-Fi）：自 AAP v1.4 起支持，<strong>车机作为 Wi-Fi 接入点</strong>（AP），手机连接至 HU 建立点对点通信。</li>
</ul>
<blockquote>
<p>📌 <strong>图 0.1：Android Auto 网络栈</strong>（原文配图，此处略）<br/>
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d8033d1ba58d436b8e7df0ea8a806889~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oiQ6YO95aSn6I-g6JCd:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764900014&amp;x-signature=Y%2BxzAAnUKlRSS1YJYOQJo7Jfrms%3D" alt="image.png" loading="lazy"/></p>
<p>展示了从物理层（USB/Wi-Fi）到 AAP 协议层，再到各功能通道的数据流向。</p>
</blockquote>
<hr/>
<h4 data-id="heading-6">**0.4 通信通道（Channels）</h4>
<p>AAP 协议定义了多个<strong>独立逻辑通道</strong>，用于在 MD 与 HU 之间高效传输不同类型的数据流：</p>


















































<table><thead><tr><th>通道名称</th><th>方向</th><th>功能说明</th></tr></thead><tbody><tr><td><strong>Control</strong>（控制通道）</td><td>双向</td><td>负责链路初始化、通道建立（如媒体、输入等子通道的协商）</td></tr><tr><td><strong>Video Output</strong>（视频输出）</td><td>MD → HU</td><td>传输 H.264 编码的视频流，用于在主中控屏显示 AAP 界面</td></tr><tr><td><strong>Audio Output</strong>（音频输出）</td><td>MD → HU</td><td>传输媒体音频（如音乐、导航提示音），通过车载扬声器播放</td></tr><tr><td><strong>Vehicle Data</strong>（车辆数据）</td><td>HU → MD</td><td>上传车辆传感器数据（如 GPS 位置、车速、转向角、燃油量等），供导航/应用使用</td></tr><tr><td><strong>Input</strong>（输入事件）</td><td>HU → MD</td><td>将车机 HMI 输入（触摸、按键、旋钮、方向盘控制等）发送至 MD，驱动应用交互</td></tr><tr><td><strong>Microphone Audio</strong>（麦克风音频）</td><td>HU → MD</td><td>传输车载麦克风采集的语音信号，用于语音搜索、通话等</td></tr><tr><td><strong>Bluetooth HFP</strong>（蓝牙免提）</td><td>双向</td><td>专用于电话通话的音频通道（符合 Bluetooth Hands-Free Profile）</td></tr><tr><td><strong>Application Status &amp; Data</strong>（应用状态与数据）</td><td>MD → HU</td><td>传输结构化元数据，如：<br/>• 导航指令（转弯提示、车道指引）<br/>• 媒体播放状态（歌曲名、进度、封面）</td></tr></tbody></table>
<blockquote>
<p>💡 <strong>设计优势</strong>：通道分离避免了音视频与控制信令互相干扰，提升系统鲁棒性。</p>
</blockquote>
<hr/>
<h4 data-id="heading-7">**0.5 车机（HU）组件与要求</h4>
<p>支持 AAP 的车机系统需包含以下<strong>高层组件</strong>（与 AAP 相关部分）：</p>





















<table><thead><tr><th>组件</th><th>说明</th></tr></thead><tbody><tr><td><strong>HU OS</strong>（车机操作系统）</td><td>运行车载信息娱乐系统的底层 OS，如 Android Automotive OS、Linux、QNX、Windows Embedded 等</td></tr><tr><td><strong>OS 适配层</strong>（OS Adaptation Layer）</td><td>HU OS 与 AAP Receiver 之间的抽象层，负责：<br/>• 实现 AAP Receiver 的接口绑定<br/>• 将 AAP 消息转换为 HU OS 原生调用（如 ALSA 音频、V4L2 视频、输入事件注入等）<br/>• Google 提供 <strong>Android 与 QNX 的参考实现源码</strong>，但<strong>不提供商业级二进制库</strong></td></tr><tr><td><strong>Android Auto Projection Receiver</strong>（AAP 接收器）</td><td>HU 端的 AAP 核心实现，以<strong>可移植 C++ 源码形式</strong>由 Google 提供给合作伙伴<br/>• 通过 OS 适配层与 HU 的视频、音频、连接、输入等子系统交互<br/>• 负责管理 AAP 会话生命周期、通道建立、错误恢复等</td></tr></tbody></table>
<blockquote>
<p>⚠️ <strong>重要提示</strong>：<br/>
本指南<strong>不涵盖 HU 完整软件栈</strong>（如 CAN 总线驱动、图形合成器、电源管理等），仅聚焦 AAP 集成相关部分。</p>
</blockquote>
<hr/>
<h4 data-id="heading-8">**0.6 车辆类型（Vehicle Types）</h4>
<p>AAP 可集成于以下类型的车辆信息娱乐系统：</p>

























<table><thead><tr><th>车辆类型</th><th>定义</th><th>集成要求</th></tr></thead><tbody><tr><td><strong>乘用车</strong>（Car）</td><td>无需商业驾照即可驾驶的车辆（如私家轿车、SUV）</td><td>✅ 支持（R00-010）</td></tr><tr><td><strong>后装车机</strong>（Aftermarket HU）</td><td>为乘用车设计的第三方替换主机</td><td>✅ 支持（R00-020）</td></tr><tr><td><strong>商用车/卡车</strong>（Truck）</td><td>需要商业驾照驾驶的车辆（如货运卡车、巴士）</td><td>✅ 支持（R00-030），但<strong>有特殊限制</strong></td></tr></tbody></table>
<h5 data-id="heading-9"><strong>针对卡车的强制要求</strong>（R00-060）</h5>
<p>由于 <strong>Google 地图等导航应用未针对商用车辆优化</strong>（如限高、限重、危险品路线等），若 AAP 集成于卡车 HU，则：</p>
<ul>
<li>
<p><strong>每次启动 AAP 时</strong>，HU <strong>必须</strong> 显示一条<strong>可关闭的原生免责声明</strong>，内容为：</p>
<blockquote>
<p>“Some Android Auto navigation apps are not designed for commercial vehicles and may not be used for navigation.”<br/>
（“部分 Android Auto 导航应用并非为商用车辆设计，不可用于导航。”）</p>
</blockquote>
</li>
<li>
<p><strong>例外</strong>（R00-070）：<br/>
若用户在某台手机上<strong>明确选择“不再显示”</strong>（如勾选 “Do Not Show Again”），则 HU <strong>可记住该设备的偏好</strong>，后续连接时不再弹出该提示。</p>
</li>
</ul>
<blockquote>
<p>🌍 <strong>本地化要求</strong>：免责声明文本需提供<strong>目标市场的官方语言翻译版本</strong>。</p>
</blockquote>
<hr/>
<h3 data-id="heading-10"><strong>总结</strong></h3>
<p>第 0 章明确了 Android Auto Projection 的<strong>设计哲学</strong>、<strong>技术架构</strong>、<strong>通信模型</strong>及<strong>适用范围</strong>，为后续章节的具体实现要求奠定了基础。开发团队需特别注意：</p>
<ol>
<li><strong>安全第一</strong>：所有设计围绕“减少驾驶分心”展开；</li>
<li><strong>职责分离</strong>：MD 负责计算与逻辑，HU 负责交互与传感；</li>
<li><strong>通道隔离</strong>：音视频、控制、数据独立传输，保障稳定性；</li>
<li><strong>合规强制</strong>：卡车场景的免责声明是认证硬性要求；</li>
<li><strong>参考实现</strong>：Google 提供 C++ 源码与 OS 适配参考，但需自行集成。</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[TypeScript 中，Promise]]></title>    <link>https://juejin.cn/post/7577295460248698926</link>    <guid>https://juejin.cn/post/7577295460248698926</guid>    <pubDate>2025-11-28T02:19:39.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577295460248698926" data-draft-id="7577226119106445339" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="TypeScript 中，Promise"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-11-28T02:19:39.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="倚栏听风雨"/> <meta itemprop="url" content="https://juejin.cn/user/2682464103830750"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            TypeScript 中，Promise
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2682464103830750/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    倚栏听风雨
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-28T02:19:39.000Z" title="Fri Nov 28 2025 02:19:39 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-28
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    9
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在 TypeScript 中，<code>Promise</code> 是处理异步操作的核心机制。相比于 JavaScript，TypeScript 中的 Promise 最大的优势在于<strong>类型安全（Type Safety）</strong>，它能让你明确知道异步操作返回的数据类型。</p>
<p>以下是关于 TypeScript 中 Promise 的详细介绍，从基础定义到高级用法。</p>
<hr/>
<h3 data-id="heading-0">1. 核心概念与泛型 (<code>Promise&lt;T&gt;</code>)</h3>
<p>在 TypeScript 中，<code>Promise</code> 是一个泛型接口，定义为 <strong><code>Promise&lt;T&gt;</code></strong>。</p>
<ul>
<li><strong><code>T</code></strong>: 代表 Promise <strong>成功（Resolved）</strong> 时返回的数据类型。</li>
<li>如果 Promise 不返回任何值（只处理过程），通常使用 <strong><code>Promise&lt;void&gt;</code></strong>。</li>
</ul>
<h4 data-id="heading-1">基本语法示例</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 显式声明返回类型为 string</span>
<span class="hljs-keyword">const</span> <span class="hljs-attr">myPromise</span>: <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">string</span>&gt; = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"异步执行"</span>)
  <span class="hljs-keyword">const</span> success = <span class="hljs-literal">true</span>;  <span class="hljs-comment">//---------&gt;New的时候 这块代码就被执行</span>
  <span class="hljs-keyword">if</span> (success) {
    <span class="hljs-title function_">resolve</span>(<span class="hljs-string">"操作成功!"</span>); <span class="hljs-comment">// 这里的参数必须是 string</span>
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-title function_">reject</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">"操作失败"</span>));
  }
});
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"主程序执行1"</span>)
myPromise.<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">data</span>) =&gt;</span> {   <span class="hljs-comment">//---------&gt;拿到执行结果</span>
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(data.<span class="hljs-property">length</span>); <span class="hljs-comment">// TS 知道 data 是 string，所以允许访问 .length</span>
});
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"主程序执行2"</span>)
</code></pre>
<p>运行输出结果</p>
<pre><code class="hljs language-typescript" lang="typescript">[<span class="hljs-variable constant_">LOG</span>]: <span class="hljs-string">"异步执行"</span>  
[<span class="hljs-variable constant_">LOG</span>]: <span class="hljs-string">"主程序执行1"</span>  
[<span class="hljs-variable constant_">LOG</span>]: <span class="hljs-string">"主程序执行2"</span>  
[<span class="hljs-variable constant_">LOG</span>]: <span class="hljs-number">5</span>
</code></pre>
<hr/>
<h3 data-id="heading-2">2. 创建 Promise 的方式</h3>
<h4 data-id="heading-3">2.1 使用构造函数 (<code>new Promise</code>)</h4>
<p>这是最基础的写法，构造函数接受一个执行器函数 <code>(resolve, reject) =&gt; void</code>。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">fetchUser</span>(<span class="hljs-params">id: <span class="hljs-built_in">number</span></span>): <span class="hljs-title class_">Promise</span>&lt;{ <span class="hljs-attr">id</span>: <span class="hljs-built_in">number</span>; <span class="hljs-attr">name</span>: <span class="hljs-built_in">string</span> }&gt; {
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> {
    <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
      <span class="hljs-keyword">if</span> (id &gt; <span class="hljs-number">0</span>) {
        <span class="hljs-comment">// resolve 的参数必须符合 Promise&lt;{...}&gt; 中定义的结构</span>
        <span class="hljs-title function_">resolve</span>({ id, <span class="hljs-attr">name</span>: <span class="hljs-string">"Alice"</span> });
      } <span class="hljs-keyword">else</span> {
        <span class="hljs-title function_">reject</span>(<span class="hljs-string">"ID 无效"</span>);
      }
    }, <span class="hljs-number">1000</span>);
  });
}
</code></pre>
<h4 data-id="heading-4">2.2 使用 <code>async</code> 和 <code>await</code> (推荐)</h4>
<p>这是现代开发的标准写法。<strong><code>async</code> 函数的返回值永远是一个 Promise</strong>。TS 会根据 <code>return</code> 的值自动推断 Promise 的泛型类型。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 写法 1: 自动推断</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">getUser</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">return</span> <span class="hljs-string">"Alice"</span>; <span class="hljs-comment">// TS 推断返回类型为 Promise&lt;string&gt;</span>
}

<span class="hljs-comment">// 写法 2: 显式注解 (推荐，更规范)</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">getScore</span>(<span class="hljs-params"/>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">number</span>&gt; {
  <span class="hljs-keyword">return</span> <span class="hljs-number">100</span>;
}

<span class="hljs-comment">// 使用 await</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">main</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> score = <span class="hljs-keyword">await</span> <span class="hljs-title function_">getScore</span>(); <span class="hljs-comment">// score 被推断为 number 类型</span>
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(score);
}
</code></pre>
<hr/>
<h3 data-id="heading-5">3. Promise 的状态与回调</h3>
<p>Promise 有三种状态：<code>pending</code> (进行中), <code>fulfilled</code> (已成功), <code>rejected</code> (已失败)。</p>
<p>在 TS 中，<code>.then()</code> 链式调用时，类型会自动流转。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">const</span> p = <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">resolve</span>(<span class="hljs-number">10</span>); <span class="hljs-comment">// 类型: Promise&lt;number&gt;</span>

p.<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">num</span>) =&gt;</span> {
  <span class="hljs-comment">// num 是 number</span>
  <span class="hljs-keyword">return</span> num.<span class="hljs-title function_">toString</span>(); <span class="hljs-comment">// 返回 string</span>
})
.<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">str</span>) =&gt;</span> {
  <span class="hljs-comment">// str 是 string (TS 自动推断)</span>
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(str);
  <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>; <span class="hljs-comment">// 返回 boolean</span>
})
.<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">bool</span>) =&gt;</span> {
  <span class="hljs-comment">// bool 是 boolean</span>
});
</code></pre>
<hr/>
<h3 data-id="heading-6">4. 静态方法 (Static Methods)</h3>
<p>TypeScript 对 Promise 的静态方法也有很好的类型支持。</p>
<h4 data-id="heading-7">4.1 <code>Promise.resolve&lt;T&gt;(value: T)</code></h4>
<p>创建一个立即成功的 Promise。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">const</span> p1 = <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">resolve</span>(<span class="hljs-number">42</span>); <span class="hljs-comment">// Promise&lt;number&gt;</span>
<span class="hljs-keyword">const</span> p2 = <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">resolve</span>({ <span class="hljs-attr">name</span>: <span class="hljs-string">"Bob"</span> }); <span class="hljs-comment">// Promise&lt;{ name: string }&gt;</span>
</code></pre>
<h4 data-id="heading-8">4.2 <code>Promise.reject(reason: any)</code></h4>
<p>创建一个立即失败的 Promise。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">const</span> pFail = <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">reject</span>(<span class="hljs-string">"Error occurred"</span>); <span class="hljs-comment">// Promise&lt;never&gt;</span>
</code></pre>
<h4 data-id="heading-9">4.3 <code>Promise.all&lt;T[]&gt;(values: [])</code></h4>
<p>等待所有 Promise 完成。返回值的类型是一个元组（Tuple）或数组。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">const</span> pString = <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">resolve</span>(<span class="hljs-string">"Hello"</span>);
<span class="hljs-keyword">const</span> pNumber = <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">resolve</span>(<span class="hljs-number">123</span>);

<span class="hljs-comment">// TS 能够推断出 results 的类型是 [string, number]</span>
<span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">all</span>([pString, pNumber]).<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">[str, num]</span>) =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(str.<span class="hljs-title function_">toUpperCase</span>()); <span class="hljs-comment">// 正常</span>
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(num.<span class="hljs-title function_">toFixed</span>(<span class="hljs-number">2</span>));    <span class="hljs-comment">// 正常</span>
});
</code></pre>
<h4 data-id="heading-10">4.4 <code>Promise.allSettled&lt;T&gt;(...)</code></h4>
<p>等待所有 Promise 完成（无论成功或失败）。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">const</span> p1 = <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">resolve</span>(<span class="hljs-number">10</span>);
<span class="hljs-keyword">const</span> p2 = <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">reject</span>(<span class="hljs-string">"error"</span>);

<span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">allSettled</span>([p1, p2]).<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">results</span>) =&gt;</span> {
  results.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">result</span>) =&gt;</span> {
    <span class="hljs-keyword">if</span> (result.<span class="hljs-property">status</span> === <span class="hljs-string">'fulfilled'</span>) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(result.<span class="hljs-property">value</span>); <span class="hljs-comment">// TS 知道这里有 value</span>
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(result.<span class="hljs-property">reason</span>); <span class="hljs-comment">// TS 知道这里有 reason</span>
    }
  });
});
</code></pre>
<h4 data-id="heading-11">4.5 <code>Promise.race&lt;T&gt;(...)</code></h4>
<p>返回第一个改变状态（成功或失败）的 Promise 的结果。</p>
<hr/>
<h3 data-id="heading-12">5. 常见实战场景</h3>
<h4 data-id="heading-13">5.1 定义 API 响应接口</h4>
<p>这是前端开发中最常用的模式。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 1. 定义数据接口</span>
<span class="hljs-keyword">interface</span> <span class="hljs-title class_">User</span> {
  <span class="hljs-attr">id</span>: <span class="hljs-built_in">number</span>;
  <span class="hljs-attr">name</span>: <span class="hljs-built_in">string</span>;
  <span class="hljs-attr">email</span>: <span class="hljs-built_in">string</span>;
}

<span class="hljs-keyword">interface</span> <span class="hljs-title class_">ApiResponse</span>&lt;T&gt; {
  <span class="hljs-attr">code</span>: <span class="hljs-built_in">number</span>;
  <span class="hljs-attr">data</span>: T;
  <span class="hljs-attr">message</span>: <span class="hljs-built_in">string</span>;
}

<span class="hljs-comment">// 2. 模拟请求函数</span>
<span class="hljs-keyword">function</span> request&lt;T&gt;(<span class="hljs-attr">url</span>: <span class="hljs-built_in">string</span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-title class_">ApiResponse</span>&lt;T&gt;&gt; {
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve</span>) =&gt;</span> {
    <span class="hljs-comment">// 模拟网络请求</span>
    <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
      <span class="hljs-title function_">resolve</span>({
        <span class="hljs-attr">code</span>: <span class="hljs-number">200</span>,
        <span class="hljs-attr">data</span>: {} <span class="hljs-keyword">as</span> T, <span class="hljs-comment">// 这里只是为了演示，实际会有真实数据</span>
        <span class="hljs-attr">message</span>: <span class="hljs-string">"success"</span>
      });
    }, <span class="hljs-number">500</span>);
  });
}

<span class="hljs-comment">// 3. 使用</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">fetchUserProfile</span>(<span class="hljs-params"/>) {
  <span class="hljs-comment">// 明确告诉 request 返回的数据结构是 User</span>
  <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> request&lt;<span class="hljs-title class_">User</span>&gt;(<span class="hljs-string">'/api/user/1'</span>);
  
  <span class="hljs-keyword">if</span> (response.<span class="hljs-property">code</span> === <span class="hljs-number">200</span>) {
    <span class="hljs-comment">// TS 这里会有自动提示：response.data.email</span>
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(response.<span class="hljs-property">data</span>.<span class="hljs-property">email</span>); 
  }
}
</code></pre>
<h4 data-id="heading-14">5.2 <code>Promise&lt;void&gt;</code> 用于不返回值的异步操作</h4>
<p>例如：初始化数据库、发送日志、等待几秒钟。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">delay</span>(<span class="hljs-params">ms: <span class="hljs-built_in">number</span></span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">void</span>&gt; {
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve</span>) =&gt;</span> {
    <span class="hljs-built_in">setTimeout</span>(resolve, ms); <span class="hljs-comment">// 不需要传递参数给 resolve</span>
  });
}

<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">run</span>(<span class="hljs-params"/>) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"Start"</span>);
  <span class="hljs-keyword">await</span> <span class="hljs-title function_">delay</span>(<span class="hljs-number">1000</span>);
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"End after 1s"</span>);
}
</code></pre>
<hr/>
<h3 data-id="heading-15">6. 错误处理 (Error Handling)</h3>
<p>在 TypeScript 中处理 Promise 错误时，有一个常见的痛点：<strong><code>catch</code> 中的 error 类型通常是 <code>any</code> 或 <code>unknown</code></strong>。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">task</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">try</span> {
    <span class="hljs-keyword">await</span> <span class="hljs-title function_">someAsyncOperation</span>();
  } <span class="hljs-keyword">catch</span> (error) {
    <span class="hljs-comment">// 默认情况下，error 是 unknown 类型 (TS 4.0+) 或 any</span>
    <span class="hljs-comment">// 你不能直接调用 error.message，除非你进行断言或类型收窄</span>
    
    <span class="hljs-keyword">if</span> (error <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">Error</span>) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(error.<span class="hljs-property">message</span>);
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">"Unknown error:"</span>, error);
    }
  }
}
</code></pre>
<h3 data-id="heading-16">总结</h3>
<ol>
<li><strong>类型注解</strong>：始终使用 <code>Promise&lt;Type&gt;</code> 来明确异步操作返回的数据结构。</li>
<li><strong>Async/Await</strong>：优先使用 <code>async</code> 函数，它让代码看起来像同步代码，且 TS 能自动推断返回类型。</li>
<li><strong>泛型工具</strong>：利用 <code>Promise.all</code> 等组合工具时，TS 能够很好地处理元组类型推断。</li>
<li><strong>错误处理</strong>：注意 <code>catch</code> 块中的类型检查，使用 <code>instanceof Error</code> 是个好习惯。</li>
</ol>
<p>如果你有具体的代码场景需要分析，可以发给我，我帮你进一步讲解！</p>
<h3 data-id="heading-17">参考</h3>
<p><a href="https://juejin.cn/spost/7577300470520446985" target="_blank" title="https://juejin.cn/spost/7577300470520446985">详解 TypeScript 中，async 和 await</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[创建自己的第一个LangChainAI]]></title>    <link>https://juejin.cn/post/7577284409965199423</link>    <guid>https://juejin.cn/post/7577284409965199423</guid>    <pubDate>2025-11-28T00:47:31.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577284409965199423" data-draft-id="7577332659504873515" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="创建自己的第一个LangChainAI"/> <meta itemprop="keywords" content="LangChain"/> <meta itemprop="datePublished" content="2025-11-28T00:47:31.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="三点水769"/> <meta itemprop="url" content="https://juejin.cn/user/4396325087221915"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            创建自己的第一个LangChainAI
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4396325087221915/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    三点水769
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-28T00:47:31.000Z" title="Fri Nov 28 2025 00:47:31 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-28
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    6
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_">#</span><span class="bash"><span class="hljs-comment">#######################</span></span>
<span class="hljs-meta prompt_"># </span><span class="bash">LangSmith追踪功能配置</span>
<span class="hljs-meta prompt_">#</span><span class="bash"><span class="hljs-comment">#######################</span></span>
<span class="hljs-meta prompt_"># </span><span class="bash">导入操作系统相关功能</span>
import os
 
from langchain_core.messages import SystemMessage, HumanMessage
<span class="hljs-meta prompt_"># </span><span class="bash">导入base_url</span>
from openai import base_url
<span class="hljs-meta prompt_"> 
# </span><span class="bash">从自定义模块导入密钥加载函数</span>
from config.load_key import load_key
<span class="hljs-meta prompt_"> 
# </span><span class="bash">设置 LangSmith 追踪功能开启</span>
os.environ["LANGSMITH_TRACING"] = "true"
<span class="hljs-meta prompt_"> 
# </span><span class="bash">设置 LangSmith 项目名称</span>
os.environ["LANGSMITH_PROJECT"] = "firstLangChainDemo"
<span class="hljs-meta prompt_"> 
# </span><span class="bash">从配置文件加载 LangSmith API 密钥并设置环境变量</span>
os.environ["LANGSMITH_API_KEY"] = load_key("LANGSMITH_API_KEY")
 
<span class="hljs-meta prompt_"> 
#</span><span class="bash"><span class="hljs-comment">#######################</span></span>
<span class="hljs-meta prompt_"># </span><span class="bash">OpenAI服务配置_001</span>
<span class="hljs-meta prompt_">#</span><span class="bash"><span class="hljs-comment">#######################</span></span>
<span class="hljs-meta prompt_"># </span><span class="bash"><span class="hljs-comment"># 检查是否已设置 OpenAI API 密钥，如果没有则从配置文件加载</span></span>
<span class="hljs-meta prompt_"># </span><span class="bash"><span class="hljs-keyword">if</span> not os.environ.get(<span class="hljs-string">"OPENAI_API_KEY"</span>):</span>
<span class="hljs-meta prompt_"># </span><span class="bash">    os.environ[<span class="hljs-string">"OPENAI_API_KEY"</span>] = load_key(<span class="hljs-string">"OPENAI_API_KEY"</span>)</span>
<span class="hljs-meta prompt_">#</span><span class="bash">
<span class="hljs-comment"># # 从 LangChain 导入模型初始化函数</span></span>
<span class="hljs-meta prompt_"># </span><span class="bash">from langchain.chat_models import init_chat_model</span>
<span class="hljs-meta prompt_">#</span><span class="bash">
<span class="hljs-comment"># # model = init_chat_model("gpt-4o-mini", model_provider="openai")</span></span>
<span class="hljs-meta prompt_"># </span><span class="bash"><span class="hljs-comment"># 初始化聊天模型，使用 gpt-4o-mini 模型，通过指定的 base URL 连接</span></span>
<span class="hljs-meta prompt_"># </span><span class="bash">model = init_chat_model(<span class="hljs-string">"gpt-4o-mini"</span>, model_provider=<span class="hljs-string">"openai"</span>, base_url=<span class="hljs-string">"https://api.gptsapi.net/v1"</span>)</span>
 
 
<span class="hljs-meta prompt_"> 
#</span><span class="bash"><span class="hljs-comment">#######################</span></span>
<span class="hljs-meta prompt_"># </span><span class="bash">创建任务_001</span>
<span class="hljs-meta prompt_">#</span><span class="bash"><span class="hljs-comment">#######################</span></span>
<span class="hljs-meta prompt_"># </span><span class="bash"><span class="hljs-comment"># 从 LangChain 核心模块导入消息类型</span></span>
<span class="hljs-meta prompt_"># </span><span class="bash">from langchain_core.messages import HumanMessage, SystemMessage</span>
<span class="hljs-meta prompt_">#</span><span class="bash">
<span class="hljs-comment"># # 创建消息列表，包含系统指令和用户问题</span></span>
<span class="hljs-meta prompt_"># </span><span class="bash">messages = [</span>
<span class="hljs-meta prompt_"># </span><span class="bash">    <span class="hljs-comment"># 系统消息：设定模型行为（翻译任务）</span></span>
<span class="hljs-meta prompt_"># </span><span class="bash">    SystemMessage(content=<span class="hljs-string">"帮我把下面这句话翻译成中文"</span>),</span>
<span class="hljs-meta prompt_"># </span><span class="bash">    <span class="hljs-comment"># 用户消息：需要翻译的英文内容</span></span>
<span class="hljs-meta prompt_"># </span><span class="bash">    HumanMessage(content=<span class="hljs-string">"Hello, how are you?"</span>)</span>
<span class="hljs-meta prompt_"># </span><span class="bash">]</span>
<span class="hljs-meta prompt_">#</span><span class="bash">
<span class="hljs-comment"># # 调用模型处理消息列表，获取翻译结果</span></span>
<span class="hljs-meta prompt_"># </span><span class="bash">result = model.invoke(messages)</span>
<span class="hljs-meta prompt_">#</span><span class="bash">
<span class="hljs-comment"># print("翻译结果:", result.content)</span></span>
<span class="hljs-meta prompt_"># </span><span class="bash"><span class="hljs-built_in">print</span>(<span class="hljs-string">"完整返回对象:"</span>, result)</span>
<span class="hljs-meta prompt_"> 
# </span><span class="bash"><span class="hljs-comment">#AIMessage(content='你好，你好吗？', additional_kwargs={'refusal': None}, response_metadata={'token_usage': {'completion_tokens': 5, 'prompt_tokens': 27, 'total_tokens': 32, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 0, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 0}}, 'model_provider': 'openai', 'model_name': 'gpt-4o-mini', 'system_fingerprint': 'fp_efad92c60b', 'id': 'chatcmpl-Cf4DAyrWIgxwAp0gKqttJJBBSGaSu', 'finish_reason': 'stop', 'logprobs': None}, id='lc_run--0e8ed63b-1943-4c62-91fe-5208d43470ee-0', usage_metadata={'input_tokens': 27, 'output_tokens': 5, 'total_tokens': 32, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 0}})&gt;</span></span>
 
 
<span class="hljs-meta prompt_"> 
#</span><span class="bash"><span class="hljs-comment">#######################</span></span>
<span class="hljs-meta prompt_"># </span><span class="bash">OpenAI服务配置_002</span>
<span class="hljs-meta prompt_">#</span><span class="bash"><span class="hljs-comment">#######################</span></span>
<span class="hljs-meta prompt_"># </span><span class="bash"><span class="hljs-comment"># pip install -qU "langchain[openai]"</span></span>
<span class="hljs-meta prompt_"># </span><span class="bash"><span class="hljs-keyword">if</span> not os.environ.get(<span class="hljs-string">"OPENAI_API_KEY"</span>):</span>
<span class="hljs-meta prompt_"># </span><span class="bash">    os.environ[<span class="hljs-string">"OPENAI_API_KEY"</span>] = load_key(<span class="hljs-string">"OPENAI_API_KEY"</span>)</span>
<span class="hljs-meta prompt_">#</span><span class="bash">
<span class="hljs-comment"># from langchain_openai import ChatOpenAI</span></span>
<span class="hljs-meta prompt_">#</span><span class="bash">
<span class="hljs-comment"># llm = ChatOpenAI(model="gpt-4o-mini", base_url="https://api.gptsapi.net/v1")</span></span>
 
<span class="hljs-meta prompt_"> 
#</span><span class="bash"><span class="hljs-comment">#######################</span></span>
<span class="hljs-meta prompt_"># </span><span class="bash">创建任务_002</span>
<span class="hljs-meta prompt_">#</span><span class="bash"><span class="hljs-comment">#######################</span></span>
<span class="hljs-meta prompt_"># </span><span class="bash"><span class="hljs-comment"># 调用模型并获取结果</span></span>
<span class="hljs-meta prompt_"># </span><span class="bash">result = llm.invoke([SystemMessage(content=<span class="hljs-string">"帮我把下面这句话翻译成中文"</span>), HumanMessage(content=<span class="hljs-string">"Hello, how are you?"</span>)])</span>
<span class="hljs-meta prompt_">#</span><span class="bash">
<span class="hljs-comment"># # 打印返回值</span></span>
<span class="hljs-meta prompt_"># </span><span class="bash"><span class="hljs-built_in">print</span>(<span class="hljs-string">"翻译结果:"</span>, result.content)</span>
<span class="hljs-meta prompt_"># </span><span class="bash"><span class="hljs-built_in">print</span>(<span class="hljs-string">"完整返回对象:"</span>, result)</span>
 
<span class="hljs-meta prompt_"> 
#</span><span class="bash"><span class="hljs-comment">#######################</span></span>
<span class="hljs-meta prompt_"># </span><span class="bash">OpenAI服务配置_003</span>
<span class="hljs-meta prompt_">#</span><span class="bash"><span class="hljs-comment">#######################</span></span>
<span class="hljs-meta prompt_"># </span><span class="bash">from langchain_community.chat_models import ChatTongyi</span>
<span class="hljs-meta prompt_"># </span><span class="bash">from langchain_core.messages import SystemMessage, HumanMessage</span>
<span class="hljs-meta prompt_"># </span><span class="bash">llm = ChatTongyi(api_key=load_key(<span class="hljs-string">"TONGYI_API_KEY"</span>), model=<span class="hljs-string">"tongyi-v1.5-s-lite"</span>)</span>
if not os.environ.get("OPENAI_API_KEY"):
    os.environ["OPENAI_API_KEY"] = load_key("OPENAI_API_KEY")
from langchain_openai import ChatOpenAI
llm = ChatOpenAI(model="gpt-4o-mini", base_url="https://api.gptsapi.net/v1")
 
<span class="hljs-meta prompt_"> 
#</span><span class="bash"><span class="hljs-comment">#######################</span></span>
<span class="hljs-meta prompt_"># </span><span class="bash">创建任务_003</span>
<span class="hljs-meta prompt_">#</span><span class="bash"><span class="hljs-comment">#######################</span></span>
<span class="hljs-meta prompt_"># </span><span class="bash">llm.invoke([SystemMessage(content=<span class="hljs-string">"帮我把下面这句话翻译成中文"</span>), HumanMessage(content=<span class="hljs-string">"Hello, how are you?"</span>)])</span>
<span class="hljs-meta prompt_">#</span><span class="bash">result = llm.invoke([SystemMessage(content=<span class="hljs-string">"Help me write a poem."</span>), HumanMessage(content=<span class="hljs-string">"What is the meaning of life?"</span>)])</span>
result = llm.invoke([HumanMessage(content="你好，你是谁?能帮我解决什么问题？")])
print("结果:", result.content)
print("完整返回对象:", result)
</code></pre>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 导入操作系统模块，用于操作环境变量</span>
<span class="hljs-keyword">import</span> os
 
<span class="hljs-comment"># 从自定义的配置模块导入密钥加载函数，用于安全地获取API密钥</span>
<span class="hljs-keyword">from</span> config.load_key <span class="hljs-keyword">import</span> load_key
 
<span class="hljs-comment"># 设置LangSmith追踪功能为开启状态，用于监控和追踪LangChain应用的执行情况</span>
os.environ[<span class="hljs-string">"LANGSMITH_TRACING"</span>] = <span class="hljs-string">"true"</span>
 
<span class="hljs-comment"># 设置LangSmith项目名称，用于在LangSmith平台上标识当前项目</span>
os.environ[<span class="hljs-string">"LANGSMITH_PROJECT"</span>] = <span class="hljs-string">"firstLangChainDemo"</span>
 
<span class="hljs-comment"># 从配置文件中加载LangSmith的API密钥并设置到环境变量中</span>
os.environ[<span class="hljs-string">"LANGSMITH_API_KEY"</span>] = load_key(<span class="hljs-string">"LANGSMITH_API_KEY"</span>)
 
<span class="hljs-comment"># 检查环境变量中是否已存在OpenAI API密钥，如果不存在则从配置文件中加载</span>
<span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> os.environ.get(<span class="hljs-string">"OPENAI_API_KEY"</span>):
    os.environ[<span class="hljs-string">"OPENAI_API_KEY"</span>] = load_key(<span class="hljs-string">"OPENAI_API_KEY"</span>)
 
<span class="hljs-comment"># 从langchain_openai模块导入ChatOpenAI类，用于与OpenAI聊天模型交互</span>
<span class="hljs-keyword">from</span> langchain_openai <span class="hljs-keyword">import</span> ChatOpenAI
 
<span class="hljs-comment"># 从langchain_core.messages模块导入HumanMessage类，用于创建用户消息</span>
<span class="hljs-keyword">from</span> langchain_core.messages <span class="hljs-keyword">import</span> HumanMessage
 
<span class="hljs-comment"># 初始化ChatOpenAI实例，配置模型参数：</span>
<span class="hljs-comment"># - model: 使用gpt-4o-mini模型</span>
<span class="hljs-comment"># - base_url: 指定API基础URL为第三方代理地址</span>
<span class="hljs-comment"># - api_key: 从环境变量中获取API密钥</span>
<span class="hljs-comment"># - temperature: 设置为0.9，控制生成结果的随机性（越高越随机）</span>
llm = ChatOpenAI(model=<span class="hljs-string">"gpt-4o-mini"</span>, base_url=<span class="hljs-string">"https://api.gptsapi.net/v1"</span>,
                 api_key=os.environ[<span class="hljs-string">"OPENAI_API_KEY"</span>], temperature=<span class="hljs-number">0.9</span>)
 
<span class="hljs-comment"># 循环5次，每次调用模型生成不同的名字建议</span>
<span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">5</span>):
    <span class="hljs-comment"># 调用模型的invoke方法，传入包含取名请求的HumanMessage对象</span>
    result = llm.invoke([HumanMessage(content=<span class="hljs-string">"你好，我姓孙帮我给孩子取一个名字？返回值的字数大于等于2个字，小于等于3个字"</span>)])
 
    <span class="hljs-comment"># 打印模型返回的结果内容</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"结果:"</span>, result.content)
 
    <span class="hljs-comment"># 打印完整的返回对象，包含元数据等额外信息</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"完整返回对象:"</span>, result)
 
 
<span class="hljs-comment"># 结果: 好的，孙姓的名字可以考虑以下几个：</span>
<span class="hljs-comment">#</span>
<span class="hljs-comment"># 1. 孙雅婷</span>
<span class="hljs-comment"># 2. 孙子轩</span>
<span class="hljs-comment"># 3. 孙昊然</span>
<span class="hljs-comment"># 4. 孙雨晴</span>
<span class="hljs-comment"># 5. 孙思远</span>
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Langchain提示词模版]]></title>    <link>https://juejin.cn/post/7577309505710014527</link>    <guid>https://juejin.cn/post/7577309505710014527</guid>    <pubDate>2025-11-28T00:59:26.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577309505710014527" data-draft-id="7577291435159584809" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Langchain提示词模版"/> <meta itemprop="keywords" content="LangChain"/> <meta itemprop="datePublished" content="2025-11-28T00:59:26.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="三点水769"/> <meta itemprop="url" content="https://juejin.cn/user/4396325087221915"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Langchain提示词模版
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4396325087221915/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    三点水769
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-28T00:59:26.000Z" title="Fri Nov 28 2025 00:59:26 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-28
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    14
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><pre><code class="hljs language-lua" lang="lua">########################
# 提示词模版
########################
# 导入操作系统相关功能，用于环境变量操作
import <span class="hljs-built_in">os</span>
 
# 从自定义模块导入密钥加载函数，用于安全地加载API密钥
from <span class="hljs-built_in">config</span>.load_key import load_key
 
# 设置 LangSmith 追踪功能开启，启用LangChain的监控和追踪功能
<span class="hljs-built_in">os</span>.environ[<span class="hljs-string">"LANGSMITH_TRACING"</span>] = <span class="hljs-string">"true"</span>
 
# 设置 LangSmith 项目名称，用于在LangSmith平台上区分不同项目
<span class="hljs-built_in">os</span>.environ[<span class="hljs-string">"LANGSMITH_PROJECT"</span>] = <span class="hljs-string">"firstLangChainDemo"</span>
 
# 从配置文件加载 LangSmith API 密钥并设置环境变量
<span class="hljs-built_in">os</span>.environ[<span class="hljs-string">"LANGSMITH_API_KEY"</span>] = load_key(<span class="hljs-string">"LANGSMITH_API_KEY"</span>)
 
# 检查是否已设置 OpenAI API 密钥，如果没有则从配置文件加载
<span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> <span class="hljs-built_in">os</span>.environ.get(<span class="hljs-string">"OPENAI_API_KEY"</span>):
    <span class="hljs-built_in">os</span>.environ[<span class="hljs-string">"OPENAI_API_KEY"</span>] = load_key(<span class="hljs-string">"OPENAI_API_KEY"</span>)
 
# 从 langchain_core.prompts 模块导入 ChatPromptTemplate 类，用于创建聊天提示模板
from langchain_core.prompts import ChatPromptTemplate
 
# 创建聊天提示模板，包含系统消息和用户消息两部分
# 系统消息指示模型将英文翻译成指定语言，用户消息包含待翻译的文本
prompt_template = ChatPromptTemplate.from_messages([
    # 系统消息模板，使用 {language} 和 {text} 作为占位符
    (<span class="hljs-string">"system"</span>,<span class="hljs-string">"Translat the following from English into {language}"</span>),
    # 用户消息模板，包含待翻译的文本占位符
    (<span class="hljs-string">"user"</span>,<span class="hljs-string">"{text}"</span>)
])
 
# 使用指定参数实例化提示模板，将 {language} 替换为 <span class="hljs-string">"Chinese"</span>，{text} 替换为 <span class="hljs-string">"I love programming."</span>
prompt = prompt_template.invoke({<span class="hljs-string">"language"</span>:<span class="hljs-string">"Chinese"</span>,<span class="hljs-string">"text"</span>:<span class="hljs-string">"I love programming."</span>})
 
# 从 langchain_openai 模块导入 ChatOpenAI 类，用于与OpenAI模型交互
from langchain_openai import ChatOpenAI
 
# 初始化 ChatOpenAI 模型实例，指定模型名称、API基础URL和API密钥
llm = ChatOpenAI(model=<span class="hljs-string">"gpt-4o-mini"</span>, base_url=<span class="hljs-string">"https://api.gptsapi.net/v1"</span>, api_key=<span class="hljs-built_in">os</span>.environ[<span class="hljs-string">"OPENAI_API_KEY"</span>])
 
# 调用模型处理构建好的提示，获取翻译结果
result = llm.invoke(prompt)
 
# 打印翻译结果的内容部分
<span class="hljs-built_in">print</span>(<span class="hljs-string">"结果:"</span>, result.content)
 
# 打印完整的返回对象，包含更多元数据信息
<span class="hljs-built_in">print</span>(<span class="hljs-string">"完整返回对象:"</span>, result)
 
# 结果: 我爱编程。
# 完整返回对象: content=<span class="hljs-string">'我爱编程。'</span> additional_kwargs={<span class="hljs-string">'refusal'</span>: None} response_metadata={<span class="hljs-string">'token_usage'</span>: {<span class="hljs-string">'completion_tokens'</span>: <span class="hljs-number">6</span>, <span class="hljs-string">'prompt_tokens'</span>: <span class="hljs-number">23</span>, <span class="hljs-string">'total_tokens'</span>: <span class="hljs-number">29</span>, <span class="hljs-string">'completion_tokens_details'</span>: {<span class="hljs-string">'accepted_prediction_tokens'</span>: <span class="hljs-number">0</span>, <span class="hljs-string">'audio_tokens'</span>: <span class="hljs-number">0</span>, <span class="hljs-string">'reasoning_tokens'</span>: <span class="hljs-number">0</span>, <span class="hljs-string">'rejected_prediction_tokens'</span>: <span class="hljs-number">0</span>}, <span class="hljs-string">'prompt_tokens_details'</span>: {<span class="hljs-string">'audio_tokens'</span>: <span class="hljs-number">0</span>, <span class="hljs-string">'cached_tokens'</span>: <span class="hljs-number">0</span>}}, <span class="hljs-string">'model_provider'</span>: <span class="hljs-string">'openai'</span>, <span class="hljs-string">'model_name'</span>: <span class="hljs-string">'gpt-4o-mini'</span>, <span class="hljs-string">'system_fingerprint'</span>: <span class="hljs-string">'fp_efad92c60b'</span>, <span class="hljs-string">'id'</span>: <span class="hljs-string">'chatcmpl-CfoAf0Kq0Pyywkff8s5cCwvKOmtVx'</span>, <span class="hljs-string">'finish_reason'</span>: <span class="hljs-string">'stop'</span>, <span class="hljs-string">'logprobs'</span>: None} id=<span class="hljs-string">'lc_run--3d21e66b-571b-4d23-af2e-6eee27d07461-0'</span> usage_metadata={<span class="hljs-string">'input_tokens'</span>: <span class="hljs-number">23</span>, <span class="hljs-string">'output_tokens'</span>: <span class="hljs-number">6</span>, <span class="hljs-string">'total_tokens'</span>: <span class="hljs-number">29</span>, <span class="hljs-string">'input_token_details'</span>: {<span class="hljs-string">'audio'</span>: <span class="hljs-number">0</span>, <span class="hljs-string">'cache_read'</span>: <span class="hljs-number">0</span>}, <span class="hljs-string">'output_token_details'</span>: {<span class="hljs-string">'audio'</span>: <span class="hljs-number">0</span>, <span class="hljs-string">'reasoning'</span>: <span class="hljs-number">0</span>}}
 
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[YOLOv5 移植 RK3588 踩坑记录]]></title>    <link>https://juejin.cn/post/7577309505710424127</link>    <guid>https://juejin.cn/post/7577309505710424127</guid>    <pubDate>2025-11-28T01:43:26.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577309505710424127" data-draft-id="7577278843234582571" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="YOLOv5 移植 RK3588 踩坑记录  "/> <meta itemprop="keywords" content="嵌入式"/> <meta itemprop="datePublished" content="2025-11-28T01:43:26.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="二狗就是我"/> <meta itemprop="url" content="https://juejin.cn/user/2313028194286679"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            YOLOv5 移植 RK3588 踩坑记录  
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2313028194286679/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    二狗就是我
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-28T01:43:26.000Z" title="Fri Nov 28 2025 01:43:26 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-28
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    2
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">YOLOv5 移植 RK3588 踩坑记录</h2>
<p>（pt → onnx → rknn 全流程）</p>
<blockquote>
<p>环境：YOLOv5-5.x / rknn-toolkit2 / Python≥3.8
板卡：RK3588<br/>
目标：复用官方 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fairockchip%2Fyolov5_rknn" target="_blank" title="https://github.com/airockchip/yolov5_rknn" ref="nofollow noopener noreferrer">yolov5_rknn</a> 示例，仅替换 <code>*.rknn</code> + <code>*.yaml</code> 即可跑通</p>
</blockquote>
<hr/>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c58eb8206d5d4b36bc0a9c7e2ad21fe2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LqM54uX5bCx5piv5oiR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764899704&amp;x-signature=TjENZTmrR5txcw7bkrSNlSsuSQs%3D" alt="{AEE826FC-267B-4263-8DDB-7E01FC8B3176}.png" loading="lazy"/></p>
<h3 data-id="heading-1">1. pt → onnx 转换</h3>
<h4 data-id="heading-2">1.1 原生 export.py 直接转会报错</h4>
<pre><code class="hljs language-bash" lang="bash">python export.py --weights yolov5s.pt --include onnx
</code></pre>
<p>运行 rknn 示例 <code>test.py</code> 时：</p>
<pre><code class="hljs language-sql" lang="sql">IndexError: list index <span class="hljs-keyword">out</span> <span class="hljs-keyword">of</span> <span class="hljs-keyword">range</span>
</code></pre>
<p><strong>原因</strong>：Detect 层输出 tuple，而 rknn 示例只拿 list 第 1 个特征图。</p>
<hr/>
<h4 data-id="heading-3">1.2 修改 1：去掉 Detect 后处理，只输出 3 个 sigmoid 特征图</h4>
<p><strong>文件</strong> <code>models/yolo.py</code><br/>
<strong>类</strong> <code>Detect.forward()</code><br/>
<strong>原始代码</strong>（已注释）：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">forward</span>(<span class="hljs-params">self, x</span>):
    z = []
    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(self.nl):
        x[i] = self.m[i](x[i])  <span class="hljs-comment"># conv</span>
        bs, _, ny, nx = x[i].shape
        x[i] = x[i].view(bs, self.na, self.no, ny, nx).permute(<span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">2</span>).contiguous()
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> self.training:
            ...
            z.append(y.view(bs, self.na * nx * ny, self.no))
    <span class="hljs-keyword">return</span> x <span class="hljs-keyword">if</span> self.training <span class="hljs-keyword">else</span> (torch.cat(z, <span class="hljs-number">1</span>), ) <span class="hljs-keyword">if</span> self.export <span class="hljs-keyword">else</span> (torch.cat(z, <span class="hljs-number">1</span>), x)
</code></pre>
<p><strong>修改为</strong>：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">forward</span>(<span class="hljs-params">self, x</span>):
    z = []
    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(self.nl):
        z.append(torch.sigmoid(self.m[i](x[i])))  <span class="hljs-comment"># 仅卷积+sigmoid</span>
    <span class="hljs-keyword">return</span> z
</code></pre>
<blockquote>
<p>说明：</p>
<ol>
<li>不再做 <code>view/permute/grid/anchor</code> 等后处理；</li>
<li>返回 <code>List[Tensor]</code>，rknn 侧直接拿 3 个特征图。</li>
</ol>
</blockquote>
<hr/>
<h4 data-id="heading-4">1.3 修改 2：export.py 支持 list 类型输出</h4>
<p><strong>文件</strong> <code>export.py</code><br/>
<strong>位置</strong>：<code>run()</code> 函数里获取 output shape 处<br/>
<strong>原始</strong>：</p>
<pre><code class="hljs language-python" lang="python">shape = <span class="hljs-built_in">tuple</span>((y[<span class="hljs-number">0</span>] <span class="hljs-keyword">if</span> <span class="hljs-built_in">isinstance</span>(y, <span class="hljs-built_in">tuple</span>) <span class="hljs-keyword">else</span> y).shape)
</code></pre>
<p><strong>改为</strong>：</p>
<pre><code class="hljs language-python" lang="python">shape = <span class="hljs-built_in">tuple</span>((y[<span class="hljs-number">0</span>] <span class="hljs-keyword">if</span> (<span class="hljs-built_in">isinstance</span>(y, <span class="hljs-built_in">tuple</span>) <span class="hljs-keyword">or</span> <span class="hljs-built_in">isinstance</span>(y, <span class="hljs-built_in">list</span>)) <span class="hljs-keyword">else</span> y).shape)
</code></pre>
<blockquote>
<p>保证 <code>y</code> 为 list 时也能正常取第 0 个元素。</p>
</blockquote>
<hr/>
<h4 data-id="heading-5">1.4 重新转 onnx</h4>
<pre><code class="hljs language-bash" lang="bash">python export.py --weights yolov5s.pt --include onnx
</code></pre>
<p>用 Netron 打开，确认尾部只剩 3 个 <code>Sigmoid</code> 节点，无 <code>Detect</code> 算子。</p>
<hr/>
<h3 data-id="heading-6">2. anchors 文件生成（踩坑 2）</h3>
<p><strong>背景</strong>：RKNN 示例后处理需要 anchors，必须与训练时保持一致。<br/>
<strong>工具</strong>：官方 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fairockchip%2Fyolov5_rknn" target="_blank" title="https://github.com/airockchip/yolov5_rknn" ref="nofollow noopener noreferrer">yolov5_rknn</a> 已提供 <code>export.py</code>，<strong>无需手动改 anchor</strong>。</p>
<pre><code class="hljs language-bash" lang="bash">git <span class="hljs-built_in">clone</span> https://github.com/airockchip/yolov5_rknn
<span class="hljs-built_in">cd</span> yolov5_rknn
python export.py --rknpu --weights car_tk_hanma.pt
</code></pre>
<p>执行完毕会自动生成：</p>
<pre><code class="hljs">RK_anchors.txt
</code></pre>
<p>内容示例（9 行）：</p>
<pre><code class="hljs language-erlang" lang="erlang"><span class="hljs-number">32.0</span>
<span class="hljs-number">32.0</span>
...
</code></pre>
<blockquote>
<p>若用自己改过的 export.py 忘记生成，会导致 rknn 推理框全部漂移或 0 检出。</p>
</blockquote>
<hr/>
<h3 data-id="heading-7">3. onnx → rknn</h3>
<ol>
<li>
<p>把上一步得到的 <code>*.onnx</code> + <code>RK_anchors.txt</code> 复制到<br/>
<code>rknn-toolkit2/examples/yolov5/python</code> 目录。</p>
</li>
<li>
<p>修改 <code>yaml</code> 文件（类别名/anchor 路径）：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">anchors_path:</span> <span class="hljs-string">RK_anchors.txt</span>
<span class="hljs-attr">names:</span> [<span class="hljs-string">'class1'</span>, <span class="hljs-string">'class2'</span>, <span class="hljs-string">...</span>]
</code></pre>
</li>
<li>
<p>执行：</p>
<pre><code class="hljs language-bash" lang="bash">python test.py
</code></pre>
<p>会自动完成 <code>onnx → rknn</code> 转换 + 板端推理。</p>
</li>
</ol>
<hr/>
<h3 data-id="heading-8">4. 一键总结</h3>






























<table><thead><tr><th>步骤</th><th>关键修改</th><th>文件</th></tr></thead><tbody><tr><td>① 去掉 Detect 后处理</td><td><code>forward</code> 返回 <code>List[sigmoid(feat)]</code></td><td><code>models/yolo.py</code></td></tr><tr><td>② export 支持 list</td><td><code>isinstance(y, tuple) or isinstance(y, list)</code></td><td><code>export.py</code></td></tr><tr><td>③ 生成 anchors</td><td>加 <code>--rknpu</code> 开关</td><td>官方 <code>export.py</code></td></tr><tr><td>④ 转 rknn</td><td>直接跑 <code>test.py</code></td><td>rknn-toolkit2 示例</td></tr></tbody></table>
<hr/>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7b52111f58f8450c838eaca2a4b18e39~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LqM54uX5bCx5piv5oiR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764899704&amp;x-signature=Y%2BQapJEN6ZtA0hc7eZeY9f1MhEc%3D" alt="003b5db7b30cf4d3cdb166b7c2bd8b6f.jpg" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[python在使用synchronized关键字时，需要注意哪些细节问题？]]></title>    <link>https://juejin.cn/post/7577291435159289897</link>    <guid>https://juejin.cn/post/7577291435159289897</guid>    <pubDate>2025-11-28T00:16:03.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577291435159289897" data-draft-id="7577278843234041899" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="python在使用synchronized关键字时，需要注意哪些细节问题？"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-11-28T00:16:03.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="用户34584828505"/> <meta itemprop="url" content="https://juejin.cn/user/3710177917545754"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            python在使用synchronized关键字时，需要注意哪些细节问题？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3710177917545754/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    用户34584828505
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-28T00:16:03.000Z" title="Fri Nov 28 2025 00:16:03 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-28
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    3
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><code>synchronized</code> 是 Java 中最基础的线程同步关键字，虽然使用简单，但在实际开发中若忽略细节，容易导致 <strong>线程安全失效、性能瓶颈、死锁</strong> 等问题。以下是使用 <code>synchronized</code> 时必须注意的核心细节：</p>
<h3 data-id="heading-0">一、锁的对象选择：明确 “锁什么”（最易出错）</h3>
<p><code>synchronized</code> 的核心是 <strong>锁定 “对象”</strong> ，而非代码块或方法本身。锁的对象决定了同步范围，选不对会直接导致线程安全失效。</p>
<h4 data-id="heading-1">1. 实例方法锁（<code>synchronized void method()</code>）</h4>
<ul>
<li>
<p><strong>锁对象</strong>：当前实例（<code>this</code>）。</p>
</li>
<li>
<p><strong>细节 1</strong>：不同实例的锁相互独立，多线程操作不同实例时不会同步。</p>
<p>java</p>
<p>运行</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Counter</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> <span class="hljs-variable">count</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">synchronized</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">increment</span><span class="hljs-params">()</span> { count++; } <span class="hljs-comment">// 锁 this</span>
}

<span class="hljs-comment">// 错误场景：多线程操作不同实例，count 会出错</span>
<span class="hljs-type">Counter</span> <span class="hljs-variable">c1</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Counter</span>();
<span class="hljs-type">Counter</span> <span class="hljs-variable">c2</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Counter</span>();
<span class="hljs-comment">// 线程1操作 c1，线程2操作 c2，两者无锁竞争，count 可能统计不准确</span>
</code></pre>
</li>
<li>
<p><strong>细节 2</strong>：若实例被回收，锁会失效（需避免锁对象被频繁创建 / 销毁）。</p>
</li>
</ul>
<h4 data-id="heading-2">2. 静态方法锁（<code>synchronized static void method()</code>）</h4>
<ul>
<li>
<p><strong>锁对象</strong>：当前类的 <code>Class</code> 对象（全局唯一）。</p>
</li>
<li>
<p><strong>细节</strong>：所有实例共享同一把锁，即使操作不同实例，也会同步。适合需要 “全局唯一” 同步的场景（如单例模式、全局计数器）。</p>
<p>java</p>
<p>运行</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Counter</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-type">int</span> <span class="hljs-variable">globalCount</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">synchronized</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">increment</span><span class="hljs-params">()</span> { globalCount++; } <span class="hljs-comment">// 锁 Counter.class</span>
}

<span class="hljs-comment">// 正确场景：多线程操作不同实例，也会同步 globalCount</span>
<span class="hljs-type">Counter</span> <span class="hljs-variable">c1</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Counter</span>();
<span class="hljs-type">Counter</span> <span class="hljs-variable">c2</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Counter</span>();
<span class="hljs-comment">// 线程1调用 c1.increment()，线程2调用 c2.increment()，会竞争同一把锁</span>
</code></pre>
</li>
</ul>
<h4 data-id="heading-3">3. 代码块锁（<code>synchronized(lockObj) {}</code>）</h4>
<ul>
<li>
<p><strong>锁对象</strong>：自定义的锁对象（需保证多线程共享同一实例）。</p>
</li>
<li>
<p><strong>核心细节</strong>：</p>
<ul>
<li>
<p>锁对象必须是 <strong>引用类型</strong>（不能是基本类型，如 <code>int</code>、<code>long</code>，会自动装箱为不同对象）。</p>
<p>java</p>
<p>运行</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 错误：锁对象是基本类型，每次自动装箱为新 Integer 对象，锁失效</span>
int lock = <span class="hljs-number">0</span>;
<span class="hljs-title function_">synchronized</span>(<span class="hljs-params">lock</span>) { ... } 

<span class="hljs-comment">// 正确：使用自定义引用类型，确保多线程共享同一实例</span>
<span class="hljs-title class_">Object</span> lock = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>(); <span class="hljs-comment">// 全局唯一锁对象</span>
<span class="hljs-title function_">synchronized</span>(<span class="hljs-params">lock</span>) { ... }
</code></pre>
</li>
<li>
<p>避免使用 <code>String</code>、<code>Integer</code> 等常量 / 缓存对象作为锁（可能因常量池复用导致锁冲突）。</p>
<p>java</p>
<p>运行</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 错误："lock" 是常量池对象，其他地方若也用 "lock" 作为锁，会导致无关代码同步</span>
<span class="hljs-title function_">synchronized</span>(<span class="hljs-params"><span class="hljs-string">"lock"</span></span>) { ... }
</code></pre>
</li>
<li>
<p>锁对象不能为 <code>null</code>（会抛出 <code>NullPointerException</code>）。</p>
</li>
</ul>
</li>
</ul>
<h3 data-id="heading-4">二、锁的粒度：避免 “过度同步” 或 “同步不足”</h3>
<p>锁的粒度直接影响性能，需在 “线程安全” 和 “性能” 之间平衡。</p>
<h4 data-id="heading-5">1. 避免 “锁粒度太大”（过度同步）</h4>
<ul>
<li>
<p>问题：将无关的操作都放在同一个 <code>synchronized</code> 块中，导致线程长时间阻塞，性能下降。</p>
</li>
<li>
<p>优化：仅对 “共享变量的修改 / 访问” 进行同步，缩小同步块范围。</p>
<p>java</p>
<p>运行</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-comment">// 错误：同步块包含无关操作（日志打印、本地变量计算），线程阻塞时间长</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> synchronized <span class="hljs-keyword">void</span> <span class="hljs-title">update</span>()</span> {
    log.info(<span class="hljs-string">"开始更新"</span>); <span class="hljs-comment">// 无关操作，无需同步</span>
    <span class="hljs-built_in">int</span> temp = <span class="hljs-number">1</span> + <span class="hljs-number">2</span>;    <span class="hljs-comment">// 本地变量，无需同步</span>
    sharedVar = temp;    <span class="hljs-comment">// 仅这一步需要同步</span>
}

<span class="hljs-comment">// 正确：缩小同步块，仅包裹临界区</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">update</span>()</span> {
    log.info(<span class="hljs-string">"开始更新"</span>);
    <span class="hljs-built_in">int</span> temp = <span class="hljs-number">1</span> + <span class="hljs-number">2</span>;
    synchronized(<span class="hljs-keyword">lock</span>) {
        sharedVar = temp; <span class="hljs-comment">// 仅临界区同步</span>
    }
}
</code></pre>
</li>
</ul>
<h4 data-id="heading-6">2. 避免 “锁粒度太小”（同步不足）</h4>
<ul>
<li>
<p>问题：若多个操作需要原子性（如 “检查 - 修改 - 提交”），仅同步单个步骤会导致线程安全问题。</p>
</li>
<li>
<p>示例：</p>
<p>java</p>
<p>运行</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 错误：check 和 set 未原子化，多线程下可能重复初始化</span>
<span class="hljs-keyword">private</span> volatile <span class="hljs-title class_">Object</span> instance;
<span class="hljs-keyword">public</span> <span class="hljs-title class_">Object</span> <span class="hljs-title function_">getInstance</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">if</span> (instance == <span class="hljs-literal">null</span>) { <span class="hljs-comment">// 检查（未同步）</span>
        <span class="hljs-title function_">synchronized</span>(<span class="hljs-params">lock</span>) {
            instance = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>(); <span class="hljs-comment">// 修改（同步）</span>
        }
    }
    <span class="hljs-keyword">return</span> instance;
}

<span class="hljs-comment">// 正确：双重检查锁（需配合 volatile 禁止重排序）</span>
<span class="hljs-keyword">public</span> <span class="hljs-title class_">Object</span> <span class="hljs-title function_">getInstance</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">if</span> (instance == <span class="hljs-literal">null</span>) {
        <span class="hljs-title function_">synchronized</span>(<span class="hljs-params">lock</span>) {
            <span class="hljs-keyword">if</span> (instance == <span class="hljs-literal">null</span>) { <span class="hljs-comment">// 二次检查（同步内）</span>
                instance = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>();
            }
        }
    }
    <span class="hljs-keyword">return</span> instance;
}
</code></pre>
</li>
</ul>
<h3 data-id="heading-7">三、线程安全的边界：<code>synchronized</code> 不能跨方法 / 跨线程传递</h3>
<p><code>synchronized</code> 仅保证 <strong>同一锁对象</strong> 下的同步，跨方法、跨线程时无法保证线程安全。</p>
<h4 data-id="heading-8">1. 跨方法同步失效</h4>
<ul>
<li>
<p>问题：若一个方法同步，另一个方法修改同一共享变量但不同步，会导致线程安全问题。</p>
<p>java</p>
<p>运行</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">class</span> <span class="hljs-title">Counter</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-built_in">int</span> count = <span class="hljs-number">0</span>;
    <span class="hljs-function"><span class="hljs-keyword">public</span> synchronized <span class="hljs-keyword">void</span> <span class="hljs-title">increment</span>()</span> { count++; } <span class="hljs-comment">// 同步</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">decrement</span>()</span> { count--; } <span class="hljs-comment">// 未同步，跨方法修改共享变量</span>
}
<span class="hljs-comment">// 线程1调用 increment()，线程2调用 decrement()，count 会出错</span>
</code></pre>
</li>
</ul>
<h4 data-id="heading-9">2. 跨线程同步失效</h4>
<ul>
<li>问题：<code>synchronized</code> 仅对 “竞争同一锁” 的线程有效，若线程间通过异步回调、消息队列等方式交互，同步无效。</li>
<li>示例：线程 A 将数据存入共享变量，线程 B 通过消息队列通知后读取，但未同步，可能读取到旧值。</li>
</ul>
<h3 data-id="heading-10">四、死锁风险：避免循环等待</h3>
<p><code>synchronized</code> 可能导致死锁，需满足 <strong>四个必要条件</strong>：互斥、请求与保持、不可剥夺、循环等待。核心是避免 “循环等待”。</p>
<h4 data-id="heading-11">1. 死锁示例</h4>
<p>java</p>
<p>运行</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// 线程1：先锁 a，再锁 b</span>
<span class="hljs-built_in">synchronized</span>(a) {
    Thread<span class="hljs-selector-class">.sleep</span>(<span class="hljs-number">100</span>); <span class="hljs-comment">// 给线程2争取时间</span>
    <span class="hljs-built_in">synchronized</span>(b) { ... }
}

<span class="hljs-comment">// 线程2：先锁 b，再锁 a</span>
<span class="hljs-built_in">synchronized</span>(b) {
    Thread<span class="hljs-selector-class">.sleep</span>(<span class="hljs-number">100</span>);
    <span class="hljs-built_in">synchronized</span>(a) { ... }
}
</code></pre>
<ul>
<li>结果：线程 1 持有 a 等待 b，线程 2 持有 b 等待 a，互相阻塞，死锁。</li>
</ul>
<h4 data-id="heading-12">2. 避免死锁的细节</h4>
<ul>
<li>按 <strong>固定顺序</strong> 申请锁（如按对象哈希值排序）。</li>
<li>避免嵌套锁（尽量减少锁的嵌套层级）。</li>
<li>给锁添加 <strong>超时时间</strong>（可通过 <code>Lock</code> 接口的 <code>tryLock(timeout)</code> 实现，<code>synchronized</code> 本身不支持，需手动规避）。</li>
<li>减少锁的持有时间（尽快释放锁，避免线程长时间占用）。</li>
</ul>
<h3 data-id="heading-13">五、可见性与有序性：<code>synchronized</code> 的隐含保证</h3>
<p><code>synchronized</code> 不仅保证原子性，还隐含可见性和有序性，但需注意细节：</p>
<h4 data-id="heading-14">1. 可见性保证</h4>
<ul>
<li>线程释放锁时，会将工作内存中的修改写回主内存；线程获取锁时，会从主内存加载最新变量值。</li>
<li>细节：仅对 “同一锁保护的共享变量” 有效，若变量未被锁保护，仍可能出现可见性问题。</li>
</ul>
<h4 data-id="heading-15">2. 有序性保证</h4>
<ul>
<li>同步块内的指令禁止重排序，且释放锁的操作 <code>happens-before</code> 后续获取同一锁的操作。</li>
<li>细节：同步块外的指令仍可能重排序，仅同步块内的指令有序。</li>
</ul>
<h3 data-id="heading-16">六、性能相关细节</h3>
<h4 data-id="heading-17">1. <code>synchronized</code> 的优化（JDK 1.6+）</h4>
<p>JDK 1.6 对 <code>synchronized</code> 进行了优化，引入了 <strong>偏向锁、轻量级锁、重量级锁</strong> 的升级机制，避免直接使用重量级锁（操作系统互斥量）导致的性能开销。</p>
<ul>
<li>细节：无需手动干预，JVM 自动优化，但需避免锁的频繁竞争（否则会升级为重量级锁，性能下降）。</li>
</ul>
<h4 data-id="heading-18">2. 避免锁竞争激烈</h4>
<ul>
<li>
<p>若多个线程频繁竞争同一把锁，会导致线程阻塞、上下文切换，性能下降。</p>
</li>
<li>
<p>优化方案：</p>
<ul>
<li>拆分锁（如 <code>ConcurrentHashMap</code> 的分段锁思想，将大锁拆分为多个小锁）。</li>
<li>使用无锁并发工具（如 <code>Atomic</code> 原子类、<code>ConcurrentLinkedQueue</code>）。</li>
<li>减少锁的持有时间（如前面提到的缩小同步块）。</li>
</ul>
</li>
</ul>
<h4 data-id="heading-19">3. 不要用 <code>synchronized</code> 修饰频繁调用的方法</h4>
<ul>
<li>若方法被高频调用（如每秒上万次），<code>synchronized</code> 的同步开销会被放大，建议改用无锁方案或优化锁粒度。</li>
</ul>
<h3 data-id="heading-20">七、其他细节</h3>
<h4 data-id="heading-21">1. <code>synchronized</code> 不能中断线程</h4>
<ul>
<li>
<p><code>synchronized</code> 是不可中断的，若线程在等待锁时被阻塞，只能通过以下方式结束：</p>
<ul>
<li>持有锁的线程释放锁（执行完同步块或抛出异常）。</li>
<li>程序终止。</li>
</ul>
</li>
<li>
<p>若需要中断等待锁的线程，需使用 <code>Lock</code> 接口的 <code>lockInterruptibly()</code> 方法。</p>
</li>
</ul>
<h4 data-id="heading-22">2. <code>synchronized</code> 不能超时等待</h4>
<ul>
<li><code>synchronized</code> 没有超时机制，线程会一直等待锁，直到获取到为止。</li>
<li>若需要超时等待，需改用 <code>Lock</code> 接口的 <code>tryLock(timeout, unit)</code> 方法。</li>
</ul>
<h4 data-id="heading-23">3. 静态锁与实例锁互不干扰</h4>
<ul>
<li>
<p>静态方法锁（锁 <code>Class</code> 对象）和实例方法锁（锁 <code>this</code>）是不同的锁，多线程同时调用时不会竞争。</p>
<p>java</p>
<p>运行</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Test</span> {
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">synchronized</span> <span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title">staticMethod</span><span class="hljs-params">()</span> </span>{} <span class="hljs-comment">// 锁 Test.class</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">synchronized</span> <span class="hljs-type">void</span> <span class="hljs-title">instanceMethod</span><span class="hljs-params">()</span> </span>{} <span class="hljs-comment">// 锁 this</span>
}
<span class="hljs-comment">// 线程1调用 staticMethod()，线程2调用 instanceMethod()，无锁竞争</span>
</code></pre>
</li>
</ul>
<h4 data-id="heading-24">4. 异常会释放锁</h4>
<ul>
<li>若同步块内抛出异常，JVM 会自动释放锁，避免锁泄露（线程持有锁但崩溃，导致其他线程无法获取）。</li>
<li>细节：若需要在异常后执行特定逻辑（如资源释放），需在 <code>finally</code> 块中处理，但锁的释放无需手动操作。</li>
</ul>
<h3 data-id="heading-25">总结</h3>
<p>使用 <code>synchronized</code> 时，核心是抓住  <strong>“锁对象正确、锁粒度合适、避免死锁、利用隐含的可见性 / 有序性保证”</strong>  这四大关键点：</p>
<ol>
<li>锁对象必须是多线程共享的引用类型，避免用常量、基本类型、<code>null</code>。</li>
<li>同步块仅包裹临界区，避免过度同步或同步不足。</li>
<li>规避死锁，尤其是循环等待和嵌套锁。</li>
<li>了解 <code>synchronized</code> 的优化机制，避免不必要的性能损耗。</li>
</ol>
<p>在高并发场景下，若 <code>synchronized</code> 无法满足需求（如超时等待、中断、公平锁），可考虑使用 <code>java.util.concurrent.locks.Lock</code> 接口（如 <code>ReentrantLock</code>），它提供了更灵活的锁控制能力。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Golang 高效内网文件传输实战：零拷贝、断点续传与 Protobuf 指令解析（含完整源码）]]></title>    <link>https://juejin.cn/post/7577343038427529259</link>    <guid>https://juejin.cn/post/7577343038427529259</guid>    <pubDate>2025-11-28T02:24:40.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577343038427529259" data-draft-id="7577291435160207401" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Golang 高效内网文件传输实战：零拷贝、断点续传与 Protobuf 指令解析（含完整源码）"/> <meta itemprop="keywords" content="后端,Go"/> <meta itemprop="datePublished" content="2025-11-28T02:24:40.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="代码扳手"/> <meta itemprop="url" content="https://juejin.cn/user/177501539672379"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Golang 高效内网文件传输实战：零拷贝、断点续传与 Protobuf 指令解析（含完整源码）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/177501539672379/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    代码扳手
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-28T02:24:40.000Z" title="Fri Nov 28 2025 02:24:40 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-28
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在程序员的世界里，我们常常听到这样的话：“站在巨人的肩膀上”、“没必要重复造轮子”。这些话听起来很正确，但你有没有想过——真正理解技术的本质，可能恰恰需要去“重复造轮子”？</p>
<p>在大型企业里，每个团队都有自己的 DevOps 流程、自研的文件共享系统、甚至独特的传输协议。为什么他们不直接用现成的方案？因为“自己的”往往才是最可控、最灵活、最容易扩展的。</p>
<p>同样地，作为学习阶段的我们，动手实现那些看似已经被写过的底层功能，并不是浪费时间，而是一条通向深入理解技术的捷径。只有亲手敲过每一行代码，理解每一个设计的来龙去脉，才能真正掌握一门语言的精髓，理解一个技术领域的本质。</p>
<p>通过实现底层文件传输逻辑，可以：</p>
<ul>
<li>理解 <strong>操作系统 IO 模型</strong></li>
<li>掌握 <strong>网络协议设计</strong></li>
<li>熟悉 <strong>高性能文件传输优化</strong></li>
</ul>
<p>💡 本篇文章，我将带你用 <strong>Golang</strong> 实现一个高效的内网文件传输系统，从零构建协议、实现断点续传与零拷贝，让你在实践中真正理解底层技术的奥秘。</p>
<p>不废话直接撸码。</p>
<hr/>
<p>1️⃣ 项目整体结构</p>
<pre><code class="hljs language-bash" lang="bash">fs_transfer_project/
├── proto/
│   └── fs_protocol.proto          <span class="hljs-comment"># Protobuf 消息定义</span>
├── frame/
│   ├── frame.go                   <span class="hljs-comment"># 自定义帧协议读写封装</span>
│   └── command.go                 <span class="hljs-comment"># CMD 枚举定义</span>
├── server/
│   ├── main.go                    <span class="hljs-comment"># TCP 监听 &amp; 连接分发</span>
│   ├── dispatcher.go              <span class="hljs-comment"># CMD 分发</span>
│   ├── file_ops.go                <span class="hljs-comment"># 基础文件操作</span>
│   └── file_ops_advanced.go       <span class="hljs-comment"># 高级操作：零拷贝、断点续传、CRC32</span>
└── client/
    ├── main.go                    <span class="hljs-comment"># Client入口</span>
    ├── download_demo.go           <span class="hljs-comment"># 文件下载流程</span>
    └── upload_demo.go             <span class="hljs-comment"># 文件上传流程</span>
</code></pre>
<p>💡 <strong>核心思路</strong>：Server 通过自定义帧协议 + CMD 分发处理各种文件操作请求，Client 使用 Protobuf 指令请求文件操作，实现高性能文件传输。</p>
<hr/>
<h2 data-id="heading-0">2️⃣ 自定义帧协议 + Protobuf 指令解析</h2>
<p>为了高性能、多路复用和协议扩展性，项目设计了：</p>
<ul>
<li><strong>帧协议 Frame</strong>：包含 Header 和 Payload</li>
<li><strong>Protobuf 指令</strong>：封装业务请求/响应</li>
</ul>
<p><strong>帧协议 Header 设计：</strong></p>













































<table><thead><tr><th>字段</th><th>类型</th><th>描述</th></tr></thead><tbody><tr><td>Magic</td><td>uint32</td><td>帧标识</td></tr><tr><td>Version</td><td>byte</td><td>协议版本</td></tr><tr><td>Flags</td><td>uint8</td><td>标志位</td></tr><tr><td>Cmd</td><td>uint16</td><td>指令类型</td></tr><tr><td>StreamID</td><td>uint32</td><td>多路复用 ID</td></tr><tr><td>PayloadLen</td><td>uint32</td><td>Payload长度</td></tr><tr><td>Checksum</td><td>uint16</td><td>完整性验证</td></tr></tbody></table>
<p>Frame 读取示例：</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">ReadFrame</span><span class="hljs-params">(r *bufio.Reader)</span></span> (Header, []<span class="hljs-type">byte</span>, <span class="hljs-type">error</span>) {
	<span class="hljs-keyword">var</span> h Header
	hdr := <span class="hljs-built_in">make</span>([]<span class="hljs-type">byte</span>, HeaderSize)
	<span class="hljs-comment">// 读取完整头部数据</span>
	<span class="hljs-keyword">if</span> _, err := io.ReadFull(r, hdr); err != <span class="hljs-literal">nil</span> {
		<span class="hljs-keyword">return</span> h, <span class="hljs-literal">nil</span>, err
	}
	<span class="hljs-comment">// 解析头部各字段</span>
	h.Magic = binary.BigEndian.Uint32(hdr[<span class="hljs-number">0</span>:<span class="hljs-number">4</span>])
	<span class="hljs-comment">// 检查魔数是否匹配</span>
	<span class="hljs-keyword">if</span> h.Magic != MagicValue {
		<span class="hljs-keyword">return</span> h, <span class="hljs-literal">nil</span>, errors.New(<span class="hljs-string">"invalid magic"</span>)
	}
	h.Version = hdr[<span class="hljs-number">4</span>]
	h.Flags = hdr[<span class="hljs-number">5</span>]
	h.Cmd = binary.BigEndian.Uint16(hdr[<span class="hljs-number">6</span>:<span class="hljs-number">8</span>])
	h.StreamID = binary.BigEndian.Uint32(hdr[<span class="hljs-number">8</span>:<span class="hljs-number">12</span>])
	h.PayloadLen = binary.BigEndian.Uint32(hdr[<span class="hljs-number">12</span>:<span class="hljs-number">16</span>])
	<span class="hljs-comment">// 读取负载数据</span>
	payload := <span class="hljs-built_in">make</span>([]<span class="hljs-type">byte</span>, h.PayloadLen)
	<span class="hljs-keyword">if</span> _, err := io.ReadFull(r, payload); err != <span class="hljs-literal">nil</span> {
		<span class="hljs-keyword">return</span> h, <span class="hljs-literal">nil</span>, err
	}

	<span class="hljs-comment">// 验证校验和</span>
	expectedChecksum := binary.BigEndian.Uint16(hdr[<span class="hljs-number">4</span>:<span class="hljs-number">6</span>]) <span class="hljs-comment">// Checksum在头部的第5-6字节</span>
	<span class="hljs-keyword">if</span> expectedChecksum != <span class="hljs-number">0</span> { <span class="hljs-comment">// 如果校验和不为0，则验证</span>
		actualChecksum := calculateChecksum(payload)
		<span class="hljs-keyword">if</span> actualChecksum != expectedChecksum {
			<span class="hljs-keyword">return</span> h, <span class="hljs-literal">nil</span>, errors.New(<span class="hljs-string">"checksum mismatch"</span>)
		}
	}

	<span class="hljs-keyword">return</span> h, payload, <span class="hljs-literal">nil</span>
}
</code></pre>
<p>通过 <code>Cmd</code> 字段，Server Dispatcher 将请求分发到不同处理函数，如 <code>CmdAuth</code>、<code>CmdOpen</code>、<code>CmdRead</code>、<code>CmdWrite</code>。</p>
<hr/>
<p>3️⃣ 高级文件操作核心技术</p>
<h3 data-id="heading-1">3.1 零拷贝发送文件</h3>
<p>在 Linux 下可使用 <code>sendfile</code> 避免用户态/内核态多次拷贝。Windows fallback 使用分片读写。这里做了分平台编译。</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">sendFileZeroCopy</span><span class="hljs-params">(conn net.Conn, path <span class="hljs-type">string</span>)</span></span> <span class="hljs-type">error</span> {
	<span class="hljs-keyword">if</span> runtime.GOOS != <span class="hljs-string">"linux"</span> {
		<span class="hljs-keyword">return</span> fmt.Errorf(<span class="hljs-string">"sendfile zero-copy only supported on Linux"</span>)
	}

	f, err := os.Open(path)
	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
		<span class="hljs-keyword">return</span> err
	}
	<span class="hljs-keyword">defer</span> f.Close()

	tcpConn, ok := conn.(*net.TCPConn)
	<span class="hljs-keyword">if</span> !ok {
		<span class="hljs-keyword">return</span> fmt.Errorf(<span class="hljs-string">"connection is not TCP"</span>)
	}

	fileConn, err := tcpConn.File()
	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
		<span class="hljs-keyword">return</span> err
	}
	<span class="hljs-keyword">defer</span> fileConn.Close()

	fi, _ := f.Stat()
	off := <span class="hljs-type">int64</span>(<span class="hljs-number">0</span>)
	size := fi.Size()

	<span class="hljs-keyword">for</span> off &lt; size {
		n, err := unix.Sendfile(<span class="hljs-type">int</span>(fileConn.Fd()), <span class="hljs-type">int</span>(f.Fd()), &amp;off, <span class="hljs-type">int</span>(size-off))
		<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
			<span class="hljs-keyword">return</span> err
		}
		<span class="hljs-keyword">if</span> n == <span class="hljs-number">0</span> {
			<span class="hljs-keyword">break</span>
		}
		off += <span class="hljs-type">int64</span>(n)
	}
	<span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>
}
</code></pre>
<h3 data-id="heading-2">3.2 分块读取/写入 &amp; 断点续传</h3>
<ul>
<li>每次读写固定大小块</li>
<li>上传/下载记录已完成块</li>
<li>断点续传时仅传未完成块</li>
</ul>

<pre><code class="hljs language-go" lang="go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">writeChunk</span><span class="hljs-params">(f *os.File, offset <span class="hljs-type">int64</span>, data []<span class="hljs-type">byte</span>)</span></span> <span class="hljs-type">error</span> {
	<span class="hljs-comment">// 在指定位置写入数据</span>
	_, err := f.WriteAt(data, offset)
	<span class="hljs-keyword">return</span> err
}
</code></pre>
<h3 data-id="heading-3">3.3 数据完整性校验</h3>
<p>使用 CRC32 对每块数据校验，保证文件传输完整性。</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">computeChecksum</span><span class="hljs-params">(data []<span class="hljs-type">byte</span>)</span></span> <span class="hljs-type">uint32</span> {
    <span class="hljs-keyword">return</span> crc32.ChecksumIEEE(data)
}
</code></pre>
<hr/>
<h2 data-id="heading-4">4️⃣ Server 核心代码解析</h2>
<h3 data-id="heading-5">TCP 监听 &amp; 连接分发</h3>
<pre><code class="hljs language-css" lang="css">// 代码有简写 以源码为主
ln, _ := net.<span class="hljs-built_in">Listen</span>(<span class="hljs-string">"tcp"</span>, <span class="hljs-string">":9000"</span>)
for {
    conn, _ := ln.<span class="hljs-built_in">Accept</span>()
    go <span class="hljs-built_in">handleConn</span>(conn)
}
</code></pre>
<p>Dispatcher 示例</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-comment">// 根据命令类型进行分发处理</span>
<span class="hljs-keyword">switch</span> hdr.Cmd {
<span class="hljs-keyword">case</span> frame.CmdAuth:
	<span class="hljs-comment">// 处理认证请求</span>
	<span class="hljs-keyword">var</span> req fsproto.AuthReq
	<span class="hljs-keyword">if</span> err := proto.Unmarshal(payload, &amp;req); err != <span class="hljs-literal">nil</span> {
		logger.Error(<span class="hljs-string">"Failed to unmarshal AuthReq"</span>, zap.Error(err))
		<span class="hljs-keyword">return</span>
	}
	handleAuth(conn, req)

<span class="hljs-keyword">case</span> frame.CmdList:
	<span class="hljs-comment">// 处理列出目录请求</span>
	<span class="hljs-keyword">var</span> req fsproto.ListReq
	<span class="hljs-keyword">if</span> err := proto.Unmarshal(payload, &amp;req); err != <span class="hljs-literal">nil</span> {
		logger.Error(<span class="hljs-string">"Failed to unmarshal ListReq"</span>, zap.Error(err))
		<span class="hljs-keyword">return</span>
	}
	handleList(conn, req)

<span class="hljs-keyword">case</span> frame.CmdOpen:
	<span class="hljs-comment">// 处理打开文件请求</span>
	<span class="hljs-keyword">var</span> req fsproto.OpenReq
	<span class="hljs-keyword">if</span> err := proto.Unmarshal(payload, &amp;req); err != <span class="hljs-literal">nil</span> {
		logger.Error(<span class="hljs-string">"Failed to unmarshal OpenReq"</span>, zap.Error(err))
		<span class="hljs-keyword">return</span>
	}
	handleOpen(conn, req)

<span class="hljs-keyword">case</span> frame.CmdRead:
	<span class="hljs-comment">// 处理读取文件请求</span>
	<span class="hljs-keyword">var</span> req fsproto.ReadReq
	<span class="hljs-keyword">if</span> err := proto.Unmarshal(payload, &amp;req); err != <span class="hljs-literal">nil</span> {
		logger.Error(<span class="hljs-string">"Failed to unmarshal ReadReq"</span>, zap.Error(err))
		<span class="hljs-keyword">return</span>
	}
	handleRead(conn, req)

<span class="hljs-keyword">case</span> frame.CmdWrite:
	<span class="hljs-comment">// 处理写入文件请求</span>
	<span class="hljs-keyword">var</span> req fsproto.WriteReq
	<span class="hljs-keyword">if</span> err := proto.Unmarshal(payload, &amp;req); err != <span class="hljs-literal">nil</span> {
		logger.Error(<span class="hljs-string">"Failed to unmarshal WriteReq"</span>, zap.Error(err))
		<span class="hljs-keyword">return</span>
	}
	handleWrite(conn, req)

<span class="hljs-keyword">default</span>:
	ogger.Warn(<span class="hljs-string">"Unknown command"</span>, zap.Uint16(<span class="hljs-string">"cmd"</span>, hdr.Cmd))
}
</code></pre>
<p>Server 通过文件句柄管理文件、记录上传块状态，支持多客户端同时上传下载。</p>
<hr/>
<h2 data-id="heading-6">5️⃣ Client 核心代码解析</h2>
<h3 data-id="heading-7">认证示例</h3>
<pre><code class="hljs language-css" lang="css">authReq := &amp;fsproto.AuthReq{
    Token: <span class="hljs-string">"secret_token"</span>,
    ClientId: <span class="hljs-string">"client_001"</span>,
}
payload,_ := proto.<span class="hljs-built_in">Marshal</span>(authReq)
frame.<span class="hljs-built_in">WriteFrame</span>(conn, frame.Header{Version:<span class="hljs-number">1</span>, Cmd:frame.CmdAuth}, payload)
</code></pre>
<p>文件下载示例</p>
<pre><code class="hljs language-css" lang="css">// 打开文件
frame<span class="hljs-selector-class">.WriteFrame</span>(conn, frame<span class="hljs-selector-class">.Header</span>{Cmd: frame.CmdOpen}, openReqBytes)
// 循环读取文件块
for offset := <span class="hljs-built_in">int64</span>(<span class="hljs-number">0</span>); !eof; offset += chunkSize {
    readReq := &amp;fsproto.ReadReq{Handle: handle, Offset: offset, Length: chunkSize}
    payload,_ := proto.<span class="hljs-built_in">Marshal</span>(readReq)
    frame.<span class="hljs-built_in">WriteFrame</span>(conn, frame.Header{Cmd: frame.CmdRead}, payload)
    ...
}
</code></pre>
<h2 data-id="heading-8">6️⃣ 性能优化与扩展思路</h2>
<ul>
<li><strong>多路复用</strong>：同一 TCP 连接可传输多个文件</li>
<li><strong>零拷贝</strong>：Linux 高效发送大文件</li>
<li><strong>分块校验</strong>：保证大文件完整性</li>
<li><strong>Protobuf 指令扩展</strong>：可轻松增加新 CMD</li>
</ul>
<p>可进一步优化：TLS 加密、并行多连接、Linux epoll 高并发。关于linux的文件管理优化空间还很大，在windows里总感觉有些局限性。欢迎在评论区讨论你的想法。</p>
<hr/>
<p>通过这个项目，你将掌握：</p>
<ul>
<li>高性能文件传输设计理念</li>
<li>Golang 网络 IO 与协程的应用</li>
<li>文件分块传输、断点续传、CRC32 校验</li>
<li>自定义协议 + Protobuf 指令解析</li>
</ul>
<p>💡 技术核心：自己实现底层逻辑，才能真正理解协议、IO 模型和语言特性。</p>
<hr/>
<p>🔗 源码下载</p>
<p>👉 GitHub：
<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Flouis-xie-programmer%2Ffs_transfer_project" target="_blank" title="https://github.com/louis-xie-programmer/fs_transfer_project" ref="nofollow noopener noreferrer">github.com/louis-xie-p…</a></p>
<p>👉 Gitee：
<a href="https://link.juejin.cn?target=https%3A%2F%2Fgitee.com%2Flouis_xie%2Ffs_transfer_project" target="_blank" title="https://gitee.com/louis_xie/fs_transfer_project" ref="nofollow noopener noreferrer">gitee.com/louis_xie/f…</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[详解 TypeScript 中，async 和 await]]></title>    <link>https://juejin.cn/post/7577300470520446985</link>    <guid>https://juejin.cn/post/7577300470520446985</guid>    <pubDate>2025-11-28T02:29:26.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577300470520446985" data-draft-id="7577300470520430601" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="详解 TypeScript 中，async 和 await"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-11-28T02:29:26.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="倚栏听风雨"/> <meta itemprop="url" content="https://juejin.cn/user/2682464103830750"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            详解 TypeScript 中，async 和 await
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2682464103830750/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    倚栏听风雨
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-28T02:29:26.000Z" title="Fri Nov 28 2025 02:29:26 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-28
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在 TypeScript 中，<code>async</code> 和 <code>await</code> 是处理异步操作的<strong>语法糖</strong>（Syntactic Sugar），本质上它们仍然是基于 <code>Promise</code> 的。</p>
<p>但在 TypeScript 的语境下，理解它们的核心在于掌握 <strong>返回类型推断</strong> 和 <strong>解包（Unwrapping）</strong> 机制。</p>
<p>以下是 <code>async</code> 和 <code>await</code> 的详细解析：</p>
<hr/>
<h3 data-id="heading-0">1. <code>async</code> 关键字</h3>
<p><code>async</code> 用于修饰函数。它有两个核心规则：</p>
<ol>
<li><strong>强制返回 Promise</strong>：无论函数内部 <code>return</code> 什么，最终都会被封装成一个 Promise。</li>
<li><strong>类型注解</strong>：在 TypeScript 中，<code>async</code> 函数的返回值类型必须明确写成 <code>Promise&lt;T&gt;</code>。</li>
</ol>
<h4 data-id="heading-1">示例代码</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 1. 自动推断</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">simple</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">return</span> <span class="hljs-number">123</span>; 
}
<span class="hljs-comment">// TS 自动推断出 simple() 的返回类型是: Promise&lt;number&gt;</span>


<span class="hljs-comment">// 2. 显式注解 (推荐)</span>
<span class="hljs-comment">// 即使你 return 的是一个普通字符串，类型定义必须包裹在 Promise 中</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">getUserName</span>(<span class="hljs-params"/>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">string</span>&gt; {
  <span class="hljs-keyword">return</span> <span class="hljs-string">"Alice"</span>;
}

<span class="hljs-comment">// 3. 无返回值的异步函数</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">logData</span>(<span class="hljs-params"/>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">void</span>&gt; {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"Saving..."</span>);
  <span class="hljs-comment">// 相当于 return Promise.resolve(undefined);</span>
}
</code></pre>
<blockquote>
<p><strong>注意</strong>：你不能将 async 函数的返回类型写成 <code>string</code> 或 <code>number</code>，必须是 <code>Promise&lt;string&gt;</code>。</p>
</blockquote>
<hr/>
<h3 data-id="heading-2">2. <code>await</code> 关键字</h3>
<p><code>await</code> 只能在 <code>async</code> 函数内部使用（或者在支持 Top-level await 的模块中使用）。</p>
<p>它的作用是：</p>
<ol>
<li><strong>暂停执行</strong>：暂停当前 async 函数的执行，直到 Promise 状态变为 resolved 或 rejected。</li>
<li><strong>自动解包 (Unwrapping)</strong>：这是 TS 的强大之处。如果一个表达式是 <code>Promise&lt;string&gt;</code>，<code>await</code> 之后得到的结果类型就是 <code>string</code>。</li>
</ol>
<h4 data-id="heading-3">类型解包示例</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">fetchAge</span>(<span class="hljs-params"/>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">number</span>&gt; {
  <span class="hljs-keyword">return</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">resolve</span>(<span class="hljs-number">18</span>);
}

<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">main</span>(<span class="hljs-params"/>) {
  <span class="hljs-comment">// TS 知道 fetchAge 返回 Promise&lt;number&gt;</span>
  <span class="hljs-comment">// 所以 age 被自动推断为 number 类型</span>
  <span class="hljs-keyword">const</span> age = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetchAge</span>(); 
  
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(age + <span class="hljs-number">1</span>); <span class="hljs-comment">// 这里的加法是合法的，因为 age 是 number</span>
}
</code></pre>
<hr/>
<h3 data-id="heading-4">3. 错误处理 (<code>try...catch</code>)</h3>
<p>当 <code>await</code> 后面的 Promise 被 <code>reject</code> 时，会抛出一个异常。因此，标准做法是使用 <code>try...catch</code>。</p>
<p>在 TypeScript 中，<code>catch(error)</code> 中的 <code>error</code> 默认类型通常是 <code>unknown</code> 或 <code>any</code>。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">requestData</span>(<span class="hljs-params"/>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">string</span>&gt; {
  <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">"网络连接断开"</span>);
}

<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">handleTask</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">try</span> {
    <span class="hljs-keyword">const</span> data = <span class="hljs-keyword">await</span> <span class="hljs-title function_">requestData</span>();
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(data);
  } <span class="hljs-keyword">catch</span> (error) {
    <span class="hljs-comment">// 这里的 error 类型是 unknown (在 TS 4.4+ 开启 useUnknownInCatchVariables 时)</span>
    
    <span class="hljs-comment">// 最佳实践：进行类型守卫</span>
    <span class="hljs-keyword">if</span> (error <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">Error</span>) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">"错误消息:"</span>, error.<span class="hljs-property">message</span>);
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">"未知错误:"</span>, error);
    }
  }
}
</code></pre>
<hr/>
<h3 data-id="heading-5">4. 串行 vs 并行 (性能关键)</h3>
<p>这是使用 <code>async/await</code> 最容易踩的坑。<code>await</code> 会阻塞后续代码，如果多个请求之间没有依赖关系，<strong>不要</strong>写成串行。</p>
<h4 data-id="heading-6">❌ 串行写法 (慢)</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">serial</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> start = <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>();
  <span class="hljs-comment">// 假设 getUser 耗时 1s, getPosts 耗时 1s</span>
  <span class="hljs-keyword">const</span> user = <span class="hljs-keyword">await</span> <span class="hljs-title function_">getUser</span>();   <span class="hljs-comment">// 等待 1s</span>
  <span class="hljs-keyword">const</span> posts = <span class="hljs-keyword">await</span> <span class="hljs-title function_">getPosts</span>(); <span class="hljs-comment">// 再等待 1s</span>
  <span class="hljs-comment">// 总耗时: 2s</span>
}
</code></pre>
<h4 data-id="heading-7">✅ 并行写法 (快 - 使用 Promise.all)</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">parallel</span>(<span class="hljs-params"/>) {
  <span class="hljs-comment">// 同时启动两个任务</span>
  <span class="hljs-keyword">const</span> userPromise = <span class="hljs-title function_">getUser</span>();
  <span class="hljs-keyword">const</span> postsPromise = <span class="hljs-title function_">getPosts</span>();

  <span class="hljs-comment">// 等待它们全部完成</span>
  <span class="hljs-comment">// TS 会自动推断 results 类型为 [User, Post[]]</span>
  <span class="hljs-keyword">const</span> [user, posts] = <span class="hljs-keyword">await</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">all</span>([userPromise, postsPromise]);
  <span class="hljs-comment">// 总耗时: 1s</span>
}
</code></pre>
<hr/>
<h3 data-id="heading-8">5. 高级用法与技巧</h3>
<h4 data-id="heading-9">5.1 异步箭头函数</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">const</span> login = <span class="hljs-keyword">async</span> (<span class="hljs-attr">username</span>: <span class="hljs-built_in">string</span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">boolean</span>&gt; =&gt; {
  <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
};
</code></pre>
<h4 data-id="heading-10">5.2 Top-level Await (顶层 await)</h4>
<p>在现代 TypeScript (ES2022 / ESNext 且 module 设置为 esnext/system 等) 中，可以在文件最外层直接使用 <code>await</code>，不需要包裹在 <code>async function</code> 中。这在初始化数据库连接等场景很有用。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// db.ts</span>
<span class="hljs-keyword">import</span> { createConnection } <span class="hljs-keyword">from</span> <span class="hljs-string">'typeorm'</span>;

<span class="hljs-comment">// 直接等待连接建立</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> connection = <span class="hljs-keyword">await</span> <span class="hljs-title function_">createConnection</span>();
</code></pre>
<h4 data-id="heading-11">5.3 <code>Promise&lt;void&gt;</code> 的陷阱</h4>
<p>有时候我们会把 async 函数作为回调传给 <code>forEach</code>，这通常是不对的，因为 <code>forEach</code> 不会等待 async 回调完成。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">const</span> ids = [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>];

<span class="hljs-comment">// ❌ 错误做法：forEach 不会等待 await</span>
ids.<span class="hljs-title function_">forEach</span>(<span class="hljs-keyword">async</span> (id) =&gt; {
  <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetchUser</span>(id); 
});
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Done'</span>); <span class="hljs-comment">// 这行代码会在 fetchUser 完成之前就打印！</span>

<span class="hljs-comment">// ✅ 正确做法：使用 map + Promise.all</span>
<span class="hljs-keyword">await</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">all</span>(ids.<span class="hljs-title function_">map</span>(<span class="hljs-keyword">async</span> (id) =&gt; {
  <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetchUser</span>(id);
}));
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Done'</span>); <span class="hljs-comment">// 确实等待所有都完成了</span>
</code></pre>
<h3 data-id="heading-12">总结 TS 中的 Async/Await</h3>






























<table><thead><tr><th align="left">特性</th><th align="left">说明</th><th align="left">对应的 TS 写法</th></tr></thead><tbody><tr><td align="left"><strong>定义</strong></td><td align="left">函数必须返回 Promise</td><td align="left"><code>async function fn(): Promise&lt;T&gt; { ... }</code></td></tr><tr><td align="left"><strong>调用</strong></td><td align="left">必须在 async 函数内</td><td align="left"><code>const val: T = await promise;</code></td></tr><tr><td align="left"><strong>返回值</strong></td><td align="left">自动包装</td><td align="left">return <code>T</code> 会变成 <code>Promise&lt;T&gt;</code></td></tr><tr><td align="left"><strong>异常</strong></td><td align="left">使用 try-catch 捕获</td><td align="left">catch 块中的变量需注意类型检查</td></tr></tbody></table>
<p>掌握这套机制后，你的异步代码会像同步代码一样清晰，同时拥有完整的类型检查保护。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[终端里的"黑客帝国"：htop, glances, bpytop 系统监控工具横评]]></title>    <link>https://juejin.cn/post/7577313637950488585</link>    <guid>https://juejin.cn/post/7577313637950488585</guid>    <pubDate>2025-11-28T02:31:55.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577313637950488585" data-draft-id="7576105458807980032" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="终端里的&quot;黑客帝国&quot;：htop, glances, bpytop 系统监控工具横评"/> <meta itemprop="keywords" content="Linux"/> <meta itemprop="datePublished" content="2025-11-28T02:31:55.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="LCG元"/> <meta itemprop="url" content="https://juejin.cn/user/3097802498120889"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            终端里的"黑客帝国"：htop, glances, bpytop 系统监控工具横评
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3097802498120889/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    LCG元
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-28T02:31:55.000Z" title="Fri Nov 28 2025 02:31:55 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-28
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读11分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">终端里的"黑客帝国"：htop, glances, bpytop 系统监控工具横评</h2>
<h3 data-id="heading-1">1. 引言</h3>
<p>在Linux系统管理中，实时监控系统资源是每个运维人员和开发者的必备技能。虽然传统的<code>top</code>命令功能强大，但它的界面相对简陋。本文将深度评测三款终端下的"黑客帝国"式系统监控工具：htop、glances和bpytop，带你领略终端监控的艺术。</p>
<h3 data-id="heading-2">2. 工具概述</h3>
<h4 data-id="heading-3">2.1 htop - 经典增强版进程监控</h4>
<p>htop是top命令的增强版，提供了彩色界面、鼠标支持、垂直和水平滚动等现代化功能。</p>
<h4 data-id="heading-4">2.2 glances - 全能跨平台监控</h4>
<p>glances采用C/S架构，不仅可以监控本地系统，还能通过Web界面远程监控多台服务器。</p>
<h4 data-id="heading-5">2.3 bpytop - Python编写的视觉盛宴</h4>
<p>bpytop使用Python编写，拥有极其丰富的视觉效果和高度可定制性，是终端监控的颜值担当。</p>
<h3 data-id="heading-6">3. htop 深度解析</h3>
<h4 data-id="heading-7">3.1 安装指南</h4>
<p><strong>创建安装脚本：<code>install_htop.sh</code></strong></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-meta">#!/bin/bash</span>

<span class="hljs-comment"># htop 安装脚本</span>
<span class="hljs-comment"># 支持多种Linux发行版</span>

<span class="hljs-built_in">set</span> -e

<span class="hljs-built_in">echo</span> <span class="hljs-string">"开始安装 htop..."</span>

<span class="hljs-comment"># 检测系统类型</span>
<span class="hljs-keyword">if</span> [ -f /etc/os-release ]; <span class="hljs-keyword">then</span>
    . /etc/os-release
    OS=<span class="hljs-variable">$ID</span>
<span class="hljs-keyword">else</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"无法检测操作系统类型"</span>
    <span class="hljs-built_in">exit</span> 1
<span class="hljs-keyword">fi</span>

<span class="hljs-comment"># 根据系统类型选择安装方法</span>
<span class="hljs-keyword">case</span> <span class="hljs-variable">$OS</span> <span class="hljs-keyword">in</span>
    ubuntu|debian)
        <span class="hljs-built_in">echo</span> <span class="hljs-string">"检测到 Debian/Ubuntu 系统"</span>
        sudo apt update
        sudo apt install -y htop
        ;;
    centos|rhel|fedora)
        <span class="hljs-built_in">echo</span> <span class="hljs-string">"检测到 CentOS/RHEL/Fedora 系统"</span>
        <span class="hljs-keyword">if</span> <span class="hljs-built_in">command</span> -v dnf &amp;&gt; /dev/null; <span class="hljs-keyword">then</span>
            sudo dnf install -y htop
        <span class="hljs-keyword">elif</span> <span class="hljs-built_in">command</span> -v yum &amp;&gt; /dev/null; <span class="hljs-keyword">then</span>
            sudo yum install -y htop
        <span class="hljs-keyword">fi</span>
        ;;
    <span class="hljs-built_in">arch</span>|manjaro)
        <span class="hljs-built_in">echo</span> <span class="hljs-string">"检测到 Arch/Manjaro 系统"</span>
        sudo pacman -Syu --noconfirm htop
        ;;
    *)
        <span class="hljs-built_in">echo</span> <span class="hljs-string">"不支持的操作系统，尝试从源码编译..."</span>
        install_from_source
        ;;
<span class="hljs-keyword">esac</span>

<span class="hljs-comment"># 源码编译安装函数</span>
<span class="hljs-function"><span class="hljs-title">install_from_source</span></span>() {
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"开始从源码编译安装 htop..."</span>
    
    <span class="hljs-comment"># 安装依赖</span>
    <span class="hljs-keyword">if</span> <span class="hljs-built_in">command</span> -v apt &amp;&gt; /dev/null; <span class="hljs-keyword">then</span>
        sudo apt install -y build-essential autoconf automake libncurses5-dev
    <span class="hljs-keyword">elif</span> <span class="hljs-built_in">command</span> -v yum &amp;&gt; /dev/null; <span class="hljs-keyword">then</span>
        sudo yum groupinstall -y <span class="hljs-string">"Development Tools"</span>
        sudo yum install -y ncurses-devel
    <span class="hljs-keyword">fi</span>
    
    <span class="hljs-comment"># 下载源码</span>
    wget https://github.com/htop-dev/htop/archive/refs/tags/3.2.2.tar.gz
    tar xvf 3.2.2.tar.gz
    <span class="hljs-built_in">cd</span> htop-3.2.2
    
    <span class="hljs-comment"># 编译安装</span>
    ./autogen.sh
    ./configure
    make -j$(<span class="hljs-built_in">nproc</span>)
    sudo make install
    
    <span class="hljs-comment"># 清理</span>
    <span class="hljs-built_in">cd</span> ..
    <span class="hljs-built_in">rm</span> -rf htop-3.2.2 3.2.2.tar.gz
}

<span class="hljs-built_in">echo</span> <span class="hljs-string">"htop 安装完成！"</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"运行命令：htop 来启动程序"</span>
</code></pre>
<h4 data-id="heading-8">3.2 配置文件详解</h4>
<p><strong>创建配置文件：<code>~/.config/htop/htoprc</code></strong></p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># htop 配置文件</span>
<span class="hljs-comment"># 生成时间：$(date)</span>

<span class="hljs-comment"># 颜色方案</span>
<span class="hljs-attr">color_scheme</span>=<span class="hljs-number">6</span>
<span class="hljs-comment"># 0: Monochrome (黑白)</span>
<span class="hljs-comment"># 1: Black on White (黑底白字)</span>
<span class="hljs-comment"># 2: Light Terminal (浅色终端)</span>
<span class="hljs-comment"># 3: Dark Terminal (深色终端)</span>
<span class="hljs-comment"># 4: Colors (彩色)</span>
<span class="hljs-comment"># 5: Solarized (日光方案)</span>
<span class="hljs-comment"># 6: Alternate (交替方案)</span>

<span class="hljs-comment"># 显示选项</span>
<span class="hljs-attr">fields</span>=<span class="hljs-number">0</span> <span class="hljs-number">48</span> <span class="hljs-number">17</span> <span class="hljs-number">18</span> <span class="hljs-number">38</span> <span class="hljs-number">39</span> <span class="hljs-number">40</span> <span class="hljs-number">2</span> <span class="hljs-number">46</span> <span class="hljs-number">47</span> <span class="hljs-number">49</span> <span class="hljs-number">1</span>
<span class="hljs-attr">sort_key</span>=<span class="hljs-number">46</span>
<span class="hljs-attr">sort_direction</span>=<span class="hljs-number">1</span>
<span class="hljs-attr">hide_threads</span>=<span class="hljs-number">0</span>
<span class="hljs-attr">hide_kernel_threads</span>=<span class="hljs-number">1</span>
<span class="hljs-attr">hide_userland_threads</span>=<span class="hljs-number">0</span>
<span class="hljs-attr">shadow_other_users</span>=<span class="hljs-number">0</span>
<span class="hljs-attr">show_thread_names</span>=<span class="hljs-number">0</span>
<span class="hljs-attr">show_program_path</span>=<span class="hljs-number">1</span>
<span class="hljs-attr">highlight_base_name</span>=<span class="hljs-number">0</span>
<span class="hljs-attr">highlight_megabytes</span>=<span class="hljs-number">1</span>
<span class="hljs-attr">highlight_threads</span>=<span class="hljs-number">1</span>
<span class="hljs-attr">tree_view</span>=<span class="hljs-number">0</span>
<span class="hljs-attr">header_margin</span>=<span class="hljs-number">1</span>
<span class="hljs-attr">detailed_cpu_time</span>=<span class="hljs-number">0</span>
<span class="hljs-attr">cpu_count_from_zero</span>=<span class="hljs-number">0</span>
<span class="hljs-attr">update_process_names</span>=<span class="hljs-number">0</span>
<span class="hljs-attr">account_guest_in_cpu_meter</span>=<span class="hljs-number">0</span>
<span class="hljs-attr">color_scheme</span>=<span class="hljs-number">6</span>
<span class="hljs-attr">delay</span>=<span class="hljs-number">15</span>
<span class="hljs-attr">left_meters</span>=AllCPUs Memory Swap
<span class="hljs-attr">left_meter_modes</span>=<span class="hljs-number">1</span> <span class="hljs-number">1</span> <span class="hljs-number">1</span>
<span class="hljs-attr">right_meters</span>=Tasks LoadAverage Uptime
<span class="hljs-attr">right_meter_modes</span>=<span class="hljs-number">2</span> <span class="hljs-number">2</span> <span class="hljs-number">2</span>
</code></pre>
<h4 data-id="heading-9">3.3 自定义功能脚本</h4>
<p><strong>创建功能增强脚本：<code>htop_enhancer.sh</code></strong></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-meta">#!/bin/bash</span>

<span class="hljs-comment"># htop 功能增强脚本</span>

<span class="hljs-comment"># 颜色定义</span>
RED=<span class="hljs-string">'\033[0;31m'</span>
GREEN=<span class="hljs-string">'\033[0;32m'</span>
YELLOW=<span class="hljs-string">'\033[1;33m'</span>
BLUE=<span class="hljs-string">'\033[0;34m'</span>
NC=<span class="hljs-string">'\033[0m'</span> <span class="hljs-comment"># No Color</span>

<span class="hljs-comment"># 显示系统信息函数</span>
<span class="hljs-function"><span class="hljs-title">show_system_info</span></span>() {
    <span class="hljs-built_in">echo</span> -e <span class="hljs-string">"<span class="hljs-variable">${GREEN}</span>=== 系统信息 ===<span class="hljs-variable">${NC}</span>"</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"主机名: <span class="hljs-subst">$(hostname)</span>"</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"操作系统: <span class="hljs-subst">$(cat /etc/os-release | grep PRETTY_NAME | cut -d= -f2 | tr -d '\"')</span>"</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"内核版本: <span class="hljs-subst">$(uname -r)</span>"</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"架构: <span class="hljs-subst">$(uname -m)</span>"</span>
    <span class="hljs-built_in">echo</span>
}

<span class="hljs-comment"># 进程分析函数</span>
<span class="hljs-function"><span class="hljs-title">analyze_processes</span></span>() {
    <span class="hljs-built_in">echo</span> -e <span class="hljs-string">"<span class="hljs-variable">${GREEN}</span>=== 进程分析 ===<span class="hljs-variable">${NC}</span>"</span>
    
    <span class="hljs-comment"># 显示CPU使用率最高的进程</span>
    <span class="hljs-built_in">echo</span> -e <span class="hljs-string">"<span class="hljs-variable">${YELLOW}</span>CPU使用率TOP 5:<span class="hljs-variable">${NC}</span>"</span>
    ps aux --<span class="hljs-built_in">sort</span>=-%cpu | <span class="hljs-built_in">head</span> -6 | awk <span class="hljs-string">'{printf "%-10s %-8s %-6s %-10s\n", $11, $2, $3"%", $4"%"}'</span>
    
    <span class="hljs-built_in">echo</span>
    
    <span class="hljs-comment"># 显示内存使用率最高的进程</span>
    <span class="hljs-built_in">echo</span> -e <span class="hljs-string">"<span class="hljs-variable">${YELLOW}</span>内存使用率TOP 5:<span class="hljs-variable">${NC}</span>"</span>
    ps aux --<span class="hljs-built_in">sort</span>=-%mem | <span class="hljs-built_in">head</span> -6 | awk <span class="hljs-string">'{printf "%-10s %-8s %-6s %-10s\n", $11, $2, $3"%", $4"%"}'</span>
    
    <span class="hljs-built_in">echo</span>
}

<span class="hljs-comment"># 资源监控函数</span>
<span class="hljs-function"><span class="hljs-title">monitor_resources</span></span>() {
    <span class="hljs-built_in">echo</span> -e <span class="hljs-string">"<span class="hljs-variable">${GREEN}</span>=== 资源监控 ===<span class="hljs-variable">${NC}</span>"</span>
    
    <span class="hljs-comment"># CPU监控</span>
    cpu_usage=$(top -bn1 | grep <span class="hljs-string">"Cpu(s)"</span> | awk <span class="hljs-string">'{print $2 + $4}'</span>)
    <span class="hljs-built_in">echo</span> -e <span class="hljs-string">"CPU使用率: <span class="hljs-variable">${BLUE}</span><span class="hljs-variable">${cpu_usage}</span>%<span class="hljs-variable">${NC}</span>"</span>
    
    <span class="hljs-comment"># 内存监控</span>
    memory_info=$(free -m | awk <span class="hljs-string">'NR==2{printf "%.2f%%", $3*100/$2}'</span>)
    <span class="hljs-built_in">echo</span> -e <span class="hljs-string">"内存使用率: <span class="hljs-variable">${BLUE}</span><span class="hljs-variable">${memory_info}</span><span class="hljs-variable">${NC}</span>"</span>
    
    <span class="hljs-comment"># 磁盘监控</span>
    disk_usage=$(<span class="hljs-built_in">df</span> -h / | awk <span class="hljs-string">'NR==2{print $5}'</span>)
    <span class="hljs-built_in">echo</span> -e <span class="hljs-string">"根分区使用率: <span class="hljs-variable">${BLUE}</span><span class="hljs-variable">${disk_usage}</span><span class="hljs-variable">${NC}</span>"</span>
    
    <span class="hljs-built_in">echo</span>
}

<span class="hljs-comment"># 交互式htop启动函数</span>
<span class="hljs-function"><span class="hljs-title">start_enhanced_htop</span></span>() {
    <span class="hljs-keyword">while</span> <span class="hljs-literal">true</span>; <span class="hljs-keyword">do</span>
        <span class="hljs-built_in">echo</span> -e <span class="hljs-string">"<span class="hljs-variable">${GREEN}</span>=== 增强版 htop 菜单 ===<span class="hljs-variable">${NC}</span>"</span>
        <span class="hljs-built_in">echo</span> <span class="hljs-string">"1. 显示系统信息"</span>
        <span class="hljs-built_in">echo</span> <span class="hljs-string">"2. 进程分析"</span>
        <span class="hljs-built_in">echo</span> <span class="hljs-string">"3. 资源监控"</span>
        <span class="hljs-built_in">echo</span> <span class="hljs-string">"4. 启动标准 htop"</span>
        <span class="hljs-built_in">echo</span> <span class="hljs-string">"5. 启动树状视图 htop"</span>
        <span class="hljs-built_in">echo</span> <span class="hljs-string">"6. 退出"</span>
        <span class="hljs-built_in">echo</span> -n <span class="hljs-string">"请选择 [1-6]: "</span>
        
        <span class="hljs-built_in">read</span> choice
        <span class="hljs-keyword">case</span> <span class="hljs-variable">$choice</span> <span class="hljs-keyword">in</span>
            1)
                show_system_info
                ;;
            2)
                analyze_processes
                ;;
            3)
                monitor_resources
                ;;
            4)
                <span class="hljs-built_in">echo</span> <span class="hljs-string">"启动标准 htop..."</span>
                htop
                ;;
            5)
                <span class="hljs-built_in">echo</span> <span class="hljs-string">"启动树状视图 htop..."</span>
                htop --tree
                ;;
            6)
                <span class="hljs-built_in">echo</span> <span class="hljs-string">"退出"</span>
                <span class="hljs-built_in">break</span>
                ;;
            *)
                <span class="hljs-built_in">echo</span> -e <span class="hljs-string">"<span class="hljs-variable">${RED}</span>无效选择，请重新输入<span class="hljs-variable">${NC}</span>"</span>
                ;;
        <span class="hljs-keyword">esac</span>
    <span class="hljs-keyword">done</span>
}

<span class="hljs-comment"># 主函数</span>
<span class="hljs-function"><span class="hljs-title">main</span></span>() {
    <span class="hljs-comment"># 检查htop是否安装</span>
    <span class="hljs-keyword">if</span> ! <span class="hljs-built_in">command</span> -v htop &amp;&gt; /dev/null; <span class="hljs-keyword">then</span>
        <span class="hljs-built_in">echo</span> -e <span class="hljs-string">"<span class="hljs-variable">${RED}</span>错误: htop 未安装<span class="hljs-variable">${NC}</span>"</span>
        <span class="hljs-built_in">echo</span> <span class="hljs-string">"请先运行 install_htop.sh 安装 htop"</span>
        <span class="hljs-built_in">exit</span> 1
    <span class="hljs-keyword">fi</span>
    
    show_system_info
    start_enhanced_htop
}

<span class="hljs-comment"># 运行主函数</span>
main <span class="hljs-string">"<span class="hljs-variable">$@</span>"</span>
</code></pre>
<h3 data-id="heading-10">4. glances 全面评测</h3>
<h4 data-id="heading-11">4.1 安装与配置</h4>
<p><strong>创建安装脚本：<code>install_glances.sh</code></strong></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-meta">#!/bin/bash</span>

<span class="hljs-comment"># glances 安装脚本</span>

<span class="hljs-built_in">set</span> -e

<span class="hljs-built_in">echo</span> <span class="hljs-string">"开始安装 glances..."</span>

<span class="hljs-comment"># Python环境检查</span>
<span class="hljs-keyword">if</span> ! <span class="hljs-built_in">command</span> -v python3 &amp;&gt; /dev/null; <span class="hljs-keyword">then</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"Python3 未安装，开始安装..."</span>
    <span class="hljs-keyword">if</span> <span class="hljs-built_in">command</span> -v apt &amp;&gt; /dev/null; <span class="hljs-keyword">then</span>
        sudo apt update &amp;&amp; sudo apt install -y python3 python3-pip
    <span class="hljs-keyword">elif</span> <span class="hljs-built_in">command</span> -v yum &amp;&gt; /dev/null; <span class="hljs-keyword">then</span>
        sudo yum install -y python3 python3-pip
    <span class="hljs-keyword">fi</span>
<span class="hljs-keyword">fi</span>

<span class="hljs-comment"># 安装方法选择</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"选择安装方式:"</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"1. pip 安装（推荐）"</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"2. 系统包管理器安装"</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"3. 源码安装"</span>
<span class="hljs-built_in">echo</span> -n <span class="hljs-string">"请选择 [1-3]: "</span>

<span class="hljs-built_in">read</span> install_choice

<span class="hljs-keyword">case</span> <span class="hljs-variable">$install_choice</span> <span class="hljs-keyword">in</span>
    1)
        <span class="hljs-built_in">echo</span> <span class="hljs-string">"使用 pip 安装..."</span>
        pip3 install glances[all]
        ;;
    2)
        <span class="hljs-built_in">echo</span> <span class="hljs-string">"使用系统包管理器安装..."</span>
        <span class="hljs-keyword">if</span> <span class="hljs-built_in">command</span> -v apt &amp;&gt; /dev/null; <span class="hljs-keyword">then</span>
            sudo apt install -y glances
        <span class="hljs-keyword">elif</span> <span class="hljs-built_in">command</span> -v yum &amp;&gt; /dev/null; <span class="hljs-keyword">then</span>
            sudo yum install -y glances
        <span class="hljs-keyword">elif</span> <span class="hljs-built_in">command</span> -v dnf &amp;&gt; /dev/null; <span class="hljs-keyword">then</span>
            sudo dnf install -y glances
        <span class="hljs-keyword">else</span>
            <span class="hljs-built_in">echo</span> <span class="hljs-string">"不支持的包管理器，回退到pip安装"</span>
            pip3 install glances[all]
        <span class="hljs-keyword">fi</span>
        ;;
    3)
        <span class="hljs-built_in">echo</span> <span class="hljs-string">"从源码安装..."</span>
        git <span class="hljs-built_in">clone</span> https://github.com/nicolargo/glances.git
        <span class="hljs-built_in">cd</span> glances
        pip3 install -e .
        <span class="hljs-built_in">cd</span> ..
        <span class="hljs-built_in">rm</span> -rf glances
        ;;
    *)
        <span class="hljs-built_in">echo</span> <span class="hljs-string">"无效选择，使用默认pip安装"</span>
        pip3 install glances[all]
        ;;
<span class="hljs-keyword">esac</span>

<span class="hljs-comment"># 创建配置文件目录</span>
<span class="hljs-built_in">mkdir</span> -p ~/.config/glances

<span class="hljs-built_in">echo</span> <span class="hljs-string">"glances 安装完成！"</span>
</code></pre>
<h4 data-id="heading-12">4.2 glances 配置文件</h4>
<p><strong>创建配置文件：<code>~/.config/glances/glances.conf</code></strong></p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-section">[global]</span>
<span class="hljs-comment"># 刷新频率</span>
<span class="hljs-attr">refresh</span>=<span class="hljs-number">2</span>

<span class="hljs-comment"># 显示选项</span>
<span class="hljs-attr">disable_alert</span>=<span class="hljs-literal">no</span>
<span class="hljs-attr">enable_process_extended</span>=<span class="hljs-literal">no</span>
<span class="hljs-attr">process_short_name</span>=<span class="hljs-literal">no</span>

<span class="hljs-comment"># 颜色配置</span>
<span class="hljs-attr">theme</span>=white
<span class="hljs-comment"># 可选: white, black, grey</span>

<span class="hljs-comment"># 导出配置</span>
<span class="hljs-attr">export</span>=csv
<span class="hljs-comment"># 可选: csv, json</span>

<span class="hljs-section">[cpu]</span>
<span class="hljs-comment"># CPU监控配置</span>
<span class="hljs-attr">user_careful</span>=<span class="hljs-number">50</span>
<span class="hljs-attr">user_warning</span>=<span class="hljs-number">70</span>
<span class="hljs-attr">user_critical</span>=<span class="hljs-number">90</span>
<span class="hljs-attr">system_careful</span>=<span class="hljs-number">50</span>
<span class="hljs-attr">system_warning</span>=<span class="hljs-number">70</span>
<span class="hljs-attr">system_critical</span>=<span class="hljs-number">90</span>

<span class="hljs-section">[mem]</span>
<span class="hljs-comment"># 内存监控配置</span>
<span class="hljs-attr">mem_careful</span>=<span class="hljs-number">50</span>
<span class="hljs-attr">mem_warning</span>=<span class="hljs-number">70</span>
<span class="hljs-attr">mem_critical</span>=<span class="hljs-number">90</span>
<span class="hljs-attr">swap_careful</span>=<span class="hljs-number">50</span>
<span class="hljs-attr">swap_warning</span>=<span class="hljs-number">70</span>
<span class="hljs-attr">swap_critical</span>=<span class="hljs-number">90</span>

<span class="hljs-section">[fs]</span>
<span class="hljs-comment"># 文件系统监控</span>
<span class="hljs-attr">filter</span>=/

<span class="hljs-section">[network]</span>
<span class="hljs-comment"># 网络接口配置</span>
<span class="hljs-comment"># 自动检测所有接口</span>
<span class="hljs-attr">interface</span>=auto

<span class="hljs-section">[connections]</span>
<span class="hljs-comment"># 连接监控</span>
<span class="hljs-attr">max_retry</span>=<span class="hljs-number">3</span>

<span class="hljs-section">[alert]</span>
<span class="hljs-comment"># 告警配置</span>
<span class="hljs-attr">enable</span>=<span class="hljs-literal">yes</span>
<span class="hljs-attr">cmd</span>=echo <span class="hljs-string">"Glances alert: {message}"</span>

<span class="hljs-section">[quicklook]</span>
<span class="hljs-comment"># 快速查看配置</span>
<span class="hljs-attr">cpu_percent</span>=<span class="hljs-literal">yes</span>
<span class="hljs-attr">mem_percent</span>=<span class="hljs-literal">yes</span>
<span class="hljs-attr">swap_percent</span>=<span class="hljs-literal">yes</span>

<span class="hljs-section">[processlist]</span>
<span class="hljs-comment"># 进程列表配置</span>
<span class="hljs-attr">sort</span>=auto
<span class="hljs-comment"># 可选: auto, cpu_percent, memory_percent, io_counters</span>

<span class="hljs-section">[amps]</span>
<span class="hljs-comment"># 应用监控</span>
<span class="hljs-attr">enable</span>=<span class="hljs-literal">no</span>
</code></pre>
<h4 data-id="heading-13">4.3 glances 高级使用脚本</h4>
<p><strong>创建高级监控脚本：<code>glances_advanced.sh</code></strong></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-meta">#!/bin/bash</span>

<span class="hljs-comment"># glances 高级监控脚本</span>

<span class="hljs-comment"># 颜色定义</span>
GREEN=<span class="hljs-string">'\033[0;32m'</span>
BLUE=<span class="hljs-string">'\033[0;34m'</span>
YELLOW=<span class="hljs-string">'\033[1;33m'</span>
RED=<span class="hljs-string">'\033[0;31m'</span>
NC=<span class="hljs-string">'\033[0m'</span>

<span class="hljs-comment"># 检查glances是否安装</span>
<span class="hljs-function"><span class="hljs-title">check_glances</span></span>() {
    <span class="hljs-keyword">if</span> ! <span class="hljs-built_in">command</span> -v glances &amp;&gt; /dev/null; <span class="hljs-keyword">then</span>
        <span class="hljs-built_in">echo</span> -e <span class="hljs-string">"<span class="hljs-variable">${RED}</span>错误: glances 未安装<span class="hljs-variable">${NC}</span>"</span>
        <span class="hljs-built_in">echo</span> <span class="hljs-string">"请先运行 install_glances.sh"</span>
        <span class="hljs-built_in">exit</span> 1
    <span class="hljs-keyword">fi</span>
}

<span class="hljs-comment"># 独立监控模式</span>
<span class="hljs-function"><span class="hljs-title">standalone_monitor</span></span>() {
    <span class="hljs-built_in">echo</span> -e <span class="hljs-string">"<span class="hljs-variable">${GREEN}</span>启动独立监控模式...<span class="hljs-variable">${NC}</span>"</span>
    glances --disable-webui --time 5
}

<span class="hljs-comment"># 客户端-服务器模式</span>
<span class="hljs-function"><span class="hljs-title">start_server</span></span>() {
    <span class="hljs-built_in">echo</span> -e <span class="hljs-string">"<span class="hljs-variable">${GREEN}</span>启动 glances 服务器...<span class="hljs-variable">${NC}</span>"</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"服务器将在端口 61209 监听"</span>
    glances -s -B 0.0.0.0 &amp;
    SERVER_PID=$!
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"服务器PID: <span class="hljs-variable">$SERVER_PID</span>"</span>
}

<span class="hljs-function"><span class="hljs-title">start_client</span></span>() {
    <span class="hljs-built_in">echo</span> -n <span class="hljs-string">"请输入服务器IP地址: "</span>
    <span class="hljs-built_in">read</span> server_ip
    <span class="hljs-built_in">echo</span> -e <span class="hljs-string">"<span class="hljs-variable">${GREEN}</span>连接到服务器 <span class="hljs-variable">$server_ip</span> ...<span class="hljs-variable">${NC}</span>"</span>
    glances -c <span class="hljs-variable">$server_ip</span>
}

<span class="hljs-comment"># Web界面模式</span>
<span class="hljs-function"><span class="hljs-title">start_webui</span></span>() {
    <span class="hljs-built_in">echo</span> -e <span class="hljs-string">"<span class="hljs-variable">${GREEN}</span>启动 Web 界面...<span class="hljs-variable">${NC}</span>"</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"Web界面地址: http://0.0.0.0:61208"</span>
    glances -w &amp;
    WEBUI_PID=$!
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"Web界面PID: <span class="hljs-variable">$WEBUI_PID</span>"</span>
}

<span class="hljs-comment"># RESTful API模式</span>
<span class="hljs-function"><span class="hljs-title">start_api</span></span>() {
    <span class="hljs-built_in">echo</span> -e <span class="hljs-string">"<span class="hljs-variable">${GREEN}</span>启动 RESTful API...<span class="hljs-variable">${NC}</span>"</span>
    glances -s --disable-webui &amp;
    API_PID=$!
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"API服务PID: <span class="hljs-variable">$API_PID</span>"</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"API地址: http://0.0.0.0:61209/api/3"</span>
}

<span class="hljs-comment"># 导出监控数据</span>
<span class="hljs-function"><span class="hljs-title">export_data</span></span>() {
    <span class="hljs-built_in">echo</span> -e <span class="hljs-string">"<span class="hljs-variable">${GREEN}</span>数据导出选项:<span class="hljs-variable">${NC}</span>"</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"1. 导出为CSV"</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"2. 导出为JSON"</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"3. 导出为InfluxDB"</span>
    <span class="hljs-built_in">echo</span> -n <span class="hljs-string">"请选择 [1-3]: "</span>
    
    <span class="hljs-built_in">read</span> export_choice
    <span class="hljs-keyword">case</span> <span class="hljs-variable">$export_choice</span> <span class="hljs-keyword">in</span>
        1)
            glances --<span class="hljs-built_in">export</span> csv --export-csv-file /tmp/glances.csv &amp;
            ;;
        2)
            glances --<span class="hljs-built_in">export</span> json --export-json-file /tmp/glances.json &amp;
            ;;
        3)
            glances --<span class="hljs-built_in">export</span> influxdb &amp;
            ;;
        *)
            <span class="hljs-built_in">echo</span> <span class="hljs-string">"无效选择"</span>
            ;;
    <span class="hljs-keyword">esac</span>
}

<span class="hljs-comment"># 自定义监控视图</span>
<span class="hljs-function"><span class="hljs-title">custom_view</span></span>() {
    <span class="hljs-built_in">echo</span> -e <span class="hljs-string">"<span class="hljs-variable">${GREEN}</span>自定义监控视图...<span class="hljs-variable">${NC}</span>"</span>
    glances --disable-irq --disable-folders --disable-ports \
            --disable-network --disable-diskio
}

<span class="hljs-comment"># 进程监控增强</span>
<span class="hljs-function"><span class="hljs-title">process_monitor</span></span>() {
    <span class="hljs-built_in">echo</span> -e <span class="hljs-string">"<span class="hljs-variable">${GREEN}</span>进程监控增强模式...<span class="hljs-variable">${NC}</span>"</span>
    glances --enable-process-extended --process-short-name
}

<span class="hljs-comment"># 显示菜单</span>
<span class="hljs-function"><span class="hljs-title">show_menu</span></span>() {
    <span class="hljs-built_in">echo</span> -e <span class="hljs-string">"<span class="hljs-variable">${BLUE}</span>=== glances 高级监控菜单 ===<span class="hljs-variable">${NC}</span>"</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"1. 独立监控模式"</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"2. 启动服务器模式"</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"3. 连接客户端模式"</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"4. 启动Web界面"</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"5. 启动RESTful API"</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"6. 数据导出"</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"7. 自定义视图"</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"8. 进程监控增强"</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"9. 停止所有服务"</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"0. 退出"</span>
    <span class="hljs-built_in">echo</span> -n <span class="hljs-string">"请选择 [0-9]: "</span>
}

<span class="hljs-comment"># 停止服务</span>
<span class="hljs-function"><span class="hljs-title">stop_services</span></span>() {
    <span class="hljs-built_in">echo</span> -e <span class="hljs-string">"<span class="hljs-variable">${YELLOW}</span>停止所有 glances 服务...<span class="hljs-variable">${NC}</span>"</span>
    pkill -f <span class="hljs-string">"glances"</span> || <span class="hljs-literal">true</span>
    <span class="hljs-built_in">sleep</span> 2
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"服务已停止"</span>
}

<span class="hljs-comment"># 主函数</span>
<span class="hljs-function"><span class="hljs-title">main</span></span>() {
    check_glances
    
    <span class="hljs-keyword">while</span> <span class="hljs-literal">true</span>; <span class="hljs-keyword">do</span>
        show_menu
        <span class="hljs-built_in">read</span> choice
        
        <span class="hljs-keyword">case</span> <span class="hljs-variable">$choice</span> <span class="hljs-keyword">in</span>
            1)
                standalone_monitor
                ;;
            2)
                start_server
                ;;
            3)
                start_client
                ;;
            4)
                start_webui
                ;;
            5)
                start_api
                ;;
            6)
                export_data
                ;;
            7)
                custom_view
                ;;
            8)
                process_monitor
                ;;
            9)
                stop_services
                ;;
            0)
                stop_services
                <span class="hljs-built_in">echo</span> <span class="hljs-string">"退出"</span>
                <span class="hljs-built_in">break</span>
                ;;
            *)
                <span class="hljs-built_in">echo</span> -e <span class="hljs-string">"<span class="hljs-variable">${RED}</span>无效选择<span class="hljs-variable">${NC}</span>"</span>
                ;;
        <span class="hljs-keyword">esac</span>
        
        <span class="hljs-built_in">echo</span>
        <span class="hljs-built_in">echo</span> -e <span class="hljs-string">"<span class="hljs-variable">${YELLOW}</span>按回车继续...<span class="hljs-variable">${NC}</span>"</span>
        <span class="hljs-built_in">read</span>
    <span class="hljs-keyword">done</span>
}

<span class="hljs-comment"># 运行主函数</span>
main <span class="hljs-string">"<span class="hljs-variable">$@</span>"</span>
</code></pre>
<h3 data-id="heading-14">5. bpytop 视觉盛宴</h3>
<h4 data-id="heading-15">5.1 安装与配置</h4>
<p><strong>创建安装脚本：<code>install_bpytop.sh</code></strong></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-meta">#!/bin/bash</span>

<span class="hljs-comment"># bpytop 安装脚本</span>

<span class="hljs-built_in">set</span> -e

<span class="hljs-built_in">echo</span> <span class="hljs-string">"开始安装 bpytop..."</span>

<span class="hljs-comment"># 检查Python版本</span>
python_version=$(python3 -c <span class="hljs-string">'import sys; print(".".join(map(str, sys.version_info[:2])))'</span>)
<span class="hljs-built_in">echo</span> <span class="hljs-string">"检测到 Python 版本: <span class="hljs-variable">$python_version</span>"</span>

<span class="hljs-keyword">if</span> [ $(<span class="hljs-built_in">echo</span> <span class="hljs-string">"<span class="hljs-variable">$python_version</span> &lt; 3.6"</span> | bc) -eq 1 ]; <span class="hljs-keyword">then</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"错误: bpytop 需要 Python 3.6 或更高版本"</span>
    <span class="hljs-built_in">exit</span> 1
<span class="hljs-keyword">fi</span>

<span class="hljs-comment"># 安装依赖</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"安装系统依赖..."</span>
<span class="hljs-keyword">if</span> <span class="hljs-built_in">command</span> -v apt &amp;&gt; /dev/null; <span class="hljs-keyword">then</span>
    sudo apt update
    sudo apt install -y python3-pip python3-venv psutil
<span class="hljs-keyword">elif</span> <span class="hljs-built_in">command</span> -v yum &amp;&gt; /dev/null; <span class="hljs-keyword">then</span>
    sudo yum install -y python3-pip python3-venv python3-psutil
<span class="hljs-keyword">elif</span> <span class="hljs-built_in">command</span> -v dnf &amp;&gt; /dev/null; <span class="hljs-keyword">then</span>
    sudo dnf install -y python3-pip python3-venv python3-psutil
<span class="hljs-keyword">elif</span> <span class="hljs-built_in">command</span> -v pacman &amp;&gt; /dev/null; <span class="hljs-keyword">then</span>
    sudo pacman -Syu --noconfirm python-pip python-psutil
<span class="hljs-keyword">fi</span>

<span class="hljs-comment"># 安装方法选择</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"选择安装方式:"</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"1. pip 安装（推荐）"</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"2. 系统包管理器安装"</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"3. 从源码安装"</span>
<span class="hljs-built_in">echo</span> -n <span class="hljs-string">"请选择 [1-3]: "</span>

<span class="hljs-built_in">read</span> install_choice

<span class="hljs-keyword">case</span> <span class="hljs-variable">$install_choice</span> <span class="hljs-keyword">in</span>
    1)
        <span class="hljs-built_in">echo</span> <span class="hljs-string">"使用 pip 安装..."</span>
        pip3 install bpytop --upgrade
        ;;
    2)
        <span class="hljs-built_in">echo</span> <span class="hljs-string">"使用系统包管理器安装..."</span>
        <span class="hljs-keyword">if</span> <span class="hljs-built_in">command</span> -v apt &amp;&gt; /dev/null; <span class="hljs-keyword">then</span>
            <span class="hljs-comment"># 添加PPA（Ubuntu）</span>
            sudo add-apt-repository ppa:bpytop/ppa -y
            sudo apt update
            sudo apt install -y bpytop
        <span class="hljs-keyword">elif</span> <span class="hljs-built_in">command</span> -v dnf &amp;&gt; /dev/null; <span class="hljs-keyword">then</span>
            <span class="hljs-comment"># COPR仓库（Fedora）</span>
            sudo dnf copr <span class="hljs-built_in">enable</span> atim/bpytop -y
            sudo dnf install -y bpytop
        <span class="hljs-keyword">else</span>
            <span class="hljs-built_in">echo</span> <span class="hljs-string">"不支持的包管理器，回退到pip安装"</span>
            pip3 install bpytop --upgrade
        <span class="hljs-keyword">fi</span>
        ;;
    3)
        <span class="hljs-built_in">echo</span> <span class="hljs-string">"从源码安装..."</span>
        git <span class="hljs-built_in">clone</span> https://github.com/aristocratos/bpytop.git
        <span class="hljs-built_in">cd</span> bpytop
        sudo make install
        <span class="hljs-built_in">cd</span> ..
        <span class="hljs-built_in">rm</span> -rf bpytop
        ;;
    *)
        <span class="hljs-built_in">echo</span> <span class="hljs-string">"无效选择，使用默认pip安装"</span>
        pip3 install bpytop --upgrade
        ;;
<span class="hljs-keyword">esac</span>

<span class="hljs-comment"># 创建配置目录</span>
<span class="hljs-built_in">mkdir</span> -p ~/.config/bpytop

<span class="hljs-built_in">echo</span> <span class="hljs-string">"bpytop 安装完成！"</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"运行命令: bpytop 启动程序"</span>
</code></pre>
<h4 data-id="heading-16">5.2 bpytop 配置文件</h4>
<p><strong>创建配置文件：<code>~/.config/bpytop/bpytop.conf</code></strong></p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># bpytop 配置文件</span>

<span class="hljs-comment"># 颜色主题</span>
<span class="hljs-attr">color_theme</span>=<span class="hljs-string">"default"</span>
<span class="hljs-comment"># 可选: default, gruvbox, solarized, monokai</span>

<span class="hljs-comment"># 界面布局</span>
<span class="hljs-attr">theme_background</span>=<span class="hljs-literal">False</span>
<span class="hljs-attr">rounded_corners</span>=<span class="hljs-literal">True</span>
<span class="hljs-attr">proc_per_core</span>=<span class="hljs-literal">True</span>
<span class="hljs-attr">show_uptime</span>=<span class="hljs-literal">True</span>
<span class="hljs-attr">check_temp</span>=<span class="hljs-literal">True</span>
<span class="hljs-attr">show_cpu_freq</span>=<span class="hljs-literal">True</span>
<span class="hljs-attr">background_update</span>=<span class="hljs-literal">True</span>
<span class="hljs-attr">base_10_sizes</span>=<span class="hljs-literal">False</span>

<span class="hljs-comment"># 显示选项</span>
<span class="hljs-attr">draw_clock</span>=<span class="hljs-literal">True</span>
<span class="hljs-attr">clock_format</span>=<span class="hljs-string">"%X"</span>
<span class="hljs-attr">background_update</span>=<span class="hljs-literal">True</span>
<span class="hljs-attr">use_fstab</span>=<span class="hljs-literal">True</span>
<span class="hljs-attr">show_disks</span>=<span class="hljs-literal">True</span>
<span class="hljs-attr">show_io_stat</span>=<span class="hljs-literal">True</span>
<span class="hljs-attr">io_mode</span>=<span class="hljs-literal">True</span>
<span class="hljs-attr">io_graph_combined</span>=<span class="hljs-literal">True</span>
<span class="hljs-attr">show_swap</span>=<span class="hljs-literal">True</span>
<span class="hljs-attr">show_swap_detailed</span>=<span class="hljs-literal">True</span>

<span class="hljs-comment"># 网络配置</span>
<span class="hljs-attr">net_download</span>=<span class="hljs-number">1000</span>
<span class="hljs-attr">net_upload</span>=<span class="hljs-number">1000</span>
<span class="hljs-attr">net_auto</span>=<span class="hljs-literal">True</span>
<span class="hljs-attr">net_sync</span>=<span class="hljs-literal">True</span>

<span class="hljs-comment"># 进程配置</span>
<span class="hljs-attr">proc_gradient</span>=<span class="hljs-literal">True</span>
<span class="hljs-attr">proc_mem_bytes</span>=<span class="hljs-literal">True</span>
<span class="hljs-attr">proc_tree</span>=<span class="hljs-literal">True</span>
<span class="hljs-attr">proc_colors</span>=<span class="hljs-literal">True</span>
<span class="hljs-attr">proc_reversed</span>=<span class="hljs-literal">True</span>
<span class="hljs-attr">proc_count</span>=<span class="hljs-number">5</span>

<span class="hljs-comment"># CPU配置</span>
<span class="hljs-attr">cpu_core_map</span>=<span class="hljs-literal">True</span>
<span class="hljs-attr">cpu_invert_lower</span>=<span class="hljs-literal">True</span>
<span class="hljs-attr">cpu_single_graph</span>=<span class="hljs-literal">False</span>
<span class="hljs-attr">show_coretemp</span>=<span class="hljs-literal">True</span>
<span class="hljs-attr">cpu_graph_upper</span>=<span class="hljs-string">"total"</span>
<span class="hljs-attr">cpu_graph_lower</span>=<span class="hljs-string">"total"</span>

<span class="hljs-comment"># 内存配置</span>
<span class="hljs-attr">mem_graphs</span>=<span class="hljs-literal">True</span>
<span class="hljs-attr">show_swap</span>=<span class="hljs-literal">True</span>

<span class="hljs-comment"># 磁盘配置</span>
<span class="hljs-attr">show_disks</span>=<span class="hljs-literal">True</span>
<span class="hljs-attr">disk_free_priv</span>=<span class="hljs-literal">True</span>

<span class="hljs-comment"># 电池配置</span>
<span class="hljs-attr">show_battery</span>=<span class="hljs-literal">True</span>
<span class="hljs-attr">selected_battery</span>=<span class="hljs-string">"auto"</span>

<span class="hljs-comment"># 更新间隔</span>
<span class="hljs-attr">update_ms</span>=<span class="hljs-number">2000</span>

<span class="hljs-comment"># 自定义颜色</span>
<span class="hljs-comment"># 主色调</span>
<span class="hljs-attr">title_color</span>=<span class="hljs-string">"cyan"</span>
<span class="hljs-attr">hi_fg</span>=<span class="hljs-string">"white"</span>
<span class="hljs-attr">selected_bg</span>=<span class="hljs-string">"blue"</span>

<span class="hljs-comment"># CPU颜色</span>
<span class="hljs-attr">cpu_box</span>=<span class="hljs-string">"magenta"</span>
<span class="hljs-attr">cpu_color</span>=[<span class="hljs-string">"green"</span>,<span class="hljs-string">"yellow"</span>,<span class="hljs-string">"red"</span>]

<span class="hljs-comment"># 内存颜色</span>
<span class="hljs-attr">mem_box</span>=<span class="hljs-string">"green"</span>
<span class="hljs-attr">mem_color</span>=[<span class="hljs-string">"green"</span>,<span class="hljs-string">"yellow"</span>,<span class="hljs-string">"red"</span>]

<span class="hljs-comment"># 网络颜色</span>
<span class="hljs-attr">net_box</span>=<span class="hljs-string">"yellow"</span>
<span class="hljs-attr">net_color</span>=[<span class="hljs-string">"green"</span>,<span class="hljs-string">"yellow"</span>,<span class="hljs-string">"red"</span>]

<span class="hljs-comment"># 进程颜色</span>
<span class="hljs-attr">proc_color</span>=[<span class="hljs-string">"white"</span>,<span class="hljs-string">"blue"</span>,<span class="hljs-string">"cyan"</span>,<span class="hljs-string">"green"</span>,<span class="hljs-string">"yellow"</span>,<span class="hljs-string">"red"</span>]

<span class="hljs-comment"># 自定义图形字符</span>
<span class="hljs-attr">graph_symbol</span>=<span class="hljs-string">"braille"</span>
<span class="hljs-comment"># 可选: braille, block, tty</span>

<span class="hljs-attr">tty_mode</span>=<span class="hljs-literal">False</span>
</code></pre>
<h4 data-id="heading-17">5.3 bpytop 主题定制脚本</h4>
<p><strong>创建主题管理脚本：<code>bpytop_themes.sh</code></strong></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-meta">#!/bin/bash</span>

<span class="hljs-comment"># bpytop 主题管理脚本</span>

THEMES_DIR=<span class="hljs-string">"<span class="hljs-variable">$HOME</span>/.config/bpytop/themes"</span>
CONFIG_FILE=<span class="hljs-string">"<span class="hljs-variable">$HOME</span>/.config/bpytop/bpytop.conf"</span>

<span class="hljs-comment"># 创建主题目录</span>
<span class="hljs-built_in">mkdir</span> -p <span class="hljs-string">"<span class="hljs-variable">$THEMES_DIR</span>"</span>

<span class="hljs-comment"># 颜色定义</span>
RED=<span class="hljs-string">'\033[0;31m'</span>
GREEN=<span class="hljs-string">'\033[0;32m'</span>
YELLOW=<span class="hljs-string">'\033[1;33m'</span>
BLUE=<span class="hljs-string">'\033[0;34m'</span>
PURPLE=<span class="hljs-string">'\033[0;35m'</span>
CYAN=<span class="hljs-string">'\033[0;36m'</span>
NC=<span class="hljs-string">'\033[0m'</span>

<span class="hljs-comment"># 创建默认主题</span>
<span class="hljs-function"><span class="hljs-title">create_default_theme</span></span>() {
    <span class="hljs-built_in">cat</span> &gt; <span class="hljs-string">"<span class="hljs-variable">$THEMES_DIR</span>/default.theme"</span> &lt;&lt; <span class="hljs-string">'EOF'</span>
<span class="hljs-comment"># 默认主题</span>
color_theme=<span class="hljs-string">"default"</span>
title_color=<span class="hljs-string">"cyan"</span>
hi_fg=<span class="hljs-string">"white"</span>
selected_bg=<span class="hljs-string">"blue"</span>
cpu_box=<span class="hljs-string">"magenta"</span>
mem_box=<span class="hljs-string">"green"</span>
net_box=<span class="hljs-string">"yellow"</span>
proc_color=[<span class="hljs-string">"white"</span>,<span class="hljs-string">"blue"</span>,<span class="hljs-string">"cyan"</span>,<span class="hljs-string">"green"</span>,<span class="hljs-string">"yellow"</span>,<span class="hljs-string">"red"</span>]
EOF
}

<span class="hljs-comment"># 创建 Gruvbox 主题</span>
<span class="hljs-function"><span class="hljs-title">create_gruvbox_theme</span></span>() {
    <span class="hljs-built_in">cat</span> &gt; <span class="hljs-string">"<span class="hljs-variable">$THEMES_DIR</span>/gruvbox.theme"</span> &lt;&lt; <span class="hljs-string">'EOF'</span>
<span class="hljs-comment"># Gruvbox 主题</span>
color_theme=<span class="hljs-string">"gruvbox"</span>
title_color=<span class="hljs-string">"#fabd2f"</span>
hi_fg=<span class="hljs-string">"#ebdbb2"</span>
selected_bg=<span class="hljs-string">"#458588"</span>
cpu_box=<span class="hljs-string">"#cc241d"</span>
mem_box=<span class="hljs-string">"#98971a"</span> 
net_box=<span class="hljs-string">"#d79921"</span>
proc_color=[<span class="hljs-string">"#ebdbb2"</span>,<span class="hljs-string">"#458588"</span>,<span class="hljs-string">"#689d6a"</span>,<span class="hljs-string">"#98971a"</span>,<span class="hljs-string">"#d79921"</span>,<span class="hljs-string">"#cc241d"</span>]
EOF
}

<span class="hljs-comment"># 创建 Solarized 主题</span>
<span class="hljs-function"><span class="hljs-title">create_solarized_theme</span></span>() {
    <span class="hljs-built_in">cat</span> &gt; <span class="hljs-string">"<span class="hljs-variable">$THEMES_DIR</span>/solarized.theme"</span> &lt;&lt; <span class="hljs-string">'EOF'</span>
<span class="hljs-comment"># Solarized 主题</span>
color_theme=<span class="hljs-string">"solarized"</span>
title_color=<span class="hljs-string">"#268bd2"</span>
hi_fg=<span class="hljs-string">"#93a1a1"</span>
selected_bg=<span class="hljs-string">"#859900"</span>
cpu_box=<span class="hljs-string">"#dc322f"</span>
mem_box=<span class="hljs-string">"#2aa198"</span>
net_box=<span class="hljs-string">"#b58900"</span>
proc_color=[<span class="hljs-string">"#93a1a1"</span>,<span class="hljs-string">"#268bd2"</span>,<span class="hljs-string">"#2aa198"</span>,<span class="hljs-string">"#859900"</span>,<span class="hljs-string">"#b58900"</span>,<span class="hljs-string">"#dc322f"</span>]
EOF
}

<span class="hljs-comment"># 创建 Monokai 主题</span>
<span class="hljs-function"><span class="hljs-title">create_monokai_theme</span></span>() {
    <span class="hljs-built_in">cat</span> &gt; <span class="hljs-string">"<span class="hljs-variable">$THEMES_DIR</span>/monokai.theme"</span> &lt;&lt; <span class="hljs-string">'EOF'</span>
<span class="hljs-comment"># Monokai 主题</span>
color_theme=<span class="hljs-string">"monokai"</span>
title_color=<span class="hljs-string">"#a6e22e"</span>
hi_fg=<span class="hljs-string">"#f8f8f2"</span>
selected_bg=<span class="hljs-string">"#66d9ef"</span>
cpu_box=<span class="hljs-string">"#f92672"</span>
mem_box=<span class="hljs-string">"#a6e22e"</span>
net_box=<span class="hljs-string">"#fd971f"</span>
proc_color=[<span class="hljs-string">"#f8f8f2"</span>,<span class="hljs-string">"#66d9ef"</span>,<span class="hljs-string">"#a6e22e"</span>,<span class="hljs-string">"#fd971f"</span>,<span class="hljs-string">"#f92672"</span>,<span class="hljs-string">"#ae81ff"</span>]
EOF
}

<span class="hljs-comment"># 创建黑客帝国主题</span>
<span class="hljs-function"><span class="hljs-title">create_matrix_theme</span></span>() {
    <span class="hljs-built_in">cat</span> &gt; <span class="hljs-string">"<span class="hljs-variable">$THEMES_DIR</span>/matrix.theme"</span> &lt;&lt; <span class="hljs-string">'EOF'</span>
<span class="hljs-comment"># 黑客帝国主题</span>
color_theme=<span class="hljs-string">"matrix"</span>
title_color=<span class="hljs-string">"#00ff00"</span>
hi_fg=<span class="hljs-string">"#00ff00"</span>
selected_bg=<span class="hljs-string">"#004400"</span>
cpu_box=<span class="hljs-string">"#00ff00"</span>
mem_box=<span class="hljs-string">"#00ff00"</span>
net_box=<span class="hljs-string">"#00ff00"</span>
proc_color=[<span class="hljs-string">"#00ff00"</span>,<span class="hljs-string">"#00cc00"</span>,<span class="hljs-string">"#009900"</span>,<span class="hljs-string">"#006600"</span>,<span class="hljs-string">"#003300"</span>]
graph_symbol=<span class="hljs-string">"braille"</span>
theme_background=True
EOF
}

<span class="hljs-comment"># 应用主题</span>
<span class="hljs-function"><span class="hljs-title">apply_theme</span></span>() {
    <span class="hljs-built_in">local</span> theme_name=<span class="hljs-variable">$1</span>
    <span class="hljs-built_in">local</span> theme_file=<span class="hljs-string">"<span class="hljs-variable">$THEMES_DIR</span>/<span class="hljs-variable">${theme_name}</span>.theme"</span>
    
    <span class="hljs-keyword">if</span> [[ ! -f <span class="hljs-string">"<span class="hljs-variable">$theme_file</span>"</span> ]]; <span class="hljs-keyword">then</span>
        <span class="hljs-built_in">echo</span> -e <span class="hljs-string">"<span class="hljs-variable">${RED}</span>错误: 主题文件 <span class="hljs-variable">$theme_file</span> 不存在<span class="hljs-variable">${NC}</span>"</span>
        <span class="hljs-built_in">return</span> 1
    <span class="hljs-keyword">fi</span>
    
    <span class="hljs-comment"># 备份原配置</span>
    <span class="hljs-built_in">cp</span> <span class="hljs-string">"<span class="hljs-variable">$CONFIG_FILE</span>"</span> <span class="hljs-string">"<span class="hljs-variable">$CONFIG_FILE</span>.backup.<span class="hljs-subst">$(date +%Y%m%d_%H%M%S)</span>"</span>
    
    <span class="hljs-comment"># 应用新主题</span>
    <span class="hljs-built_in">cat</span> <span class="hljs-string">"<span class="hljs-variable">$theme_file</span>"</span> &gt;&gt; <span class="hljs-string">"<span class="hljs-variable">$CONFIG_FILE</span>"</span>
    
    <span class="hljs-built_in">echo</span> -e <span class="hljs-string">"<span class="hljs-variable">${GREEN}</span>主题 <span class="hljs-variable">$theme_name</span> 应用成功！<span class="hljs-variable">${NC}</span>"</span>
}

<span class="hljs-comment"># 列出所有主题</span>
<span class="hljs-function"><span class="hljs-title">list_themes</span></span>() {
    <span class="hljs-built_in">echo</span> -e <span class="hljs-string">"<span class="hljs-variable">${CYAN}</span>=== 可用主题 ===<span class="hljs-variable">${NC}</span>"</span>
    <span class="hljs-keyword">for</span> theme_file <span class="hljs-keyword">in</span> <span class="hljs-string">"<span class="hljs-variable">$THEMES_DIR</span>"</span>/*.theme; <span class="hljs-keyword">do</span>
        <span class="hljs-keyword">if</span> [[ -f <span class="hljs-string">"<span class="hljs-variable">$theme_file</span>"</span> ]]; <span class="hljs-keyword">then</span>
            theme_name=$(<span class="hljs-built_in">basename</span> <span class="hljs-string">"<span class="hljs-variable">$theme_file</span>"</span> .theme)
            <span class="hljs-built_in">echo</span> -e <span class="hljs-string">"<span class="hljs-variable">${YELLOW}</span>$theme_name<span class="hljs-variable">${NC}</span>"</span>
        <span class="hljs-keyword">fi</span>
    <span class="hljs-keyword">done</span>
}

<span class="hljs-comment"># 创建所有主题</span>
<span class="hljs-function"><span class="hljs-title">create_all_themes</span></span>() {
    <span class="hljs-built_in">echo</span> -e <span class="hljs-string">"<span class="hljs-variable">${BLUE}</span>创建所有内置主题...<span class="hljs-variable">${NC}</span>"</span>
    create_default_theme
    create_gruvbox_theme
    create_solarized_theme
    create_monokai_theme
    create_matrix_theme
    <span class="hljs-built_in">echo</span> -e <span class="hljs-string">"<span class="hljs-variable">${GREEN}</span>所有主题创建完成！<span class="hljs-variable">${NC}</span>"</span>
}

<span class="hljs-comment"># 预览主题</span>
<span class="hljs-function"><span class="hljs-title">preview_theme</span></span>() {
    <span class="hljs-built_in">local</span> theme_name=<span class="hljs-variable">$1</span>
    <span class="hljs-built_in">echo</span> -e <span class="hljs-string">"<span class="hljs-variable">${CYAN}</span>=== 主题预览: <span class="hljs-variable">$theme_name</span> ===<span class="hljs-variable">${NC}</span>"</span>
    
    <span class="hljs-keyword">case</span> <span class="hljs-variable">$theme_name</span> <span class="hljs-keyword">in</span>
        <span class="hljs-string">"default"</span>)
            <span class="hljs-built_in">echo</span> -e <span class="hljs-string">"主色调: <span class="hljs-variable">${CYAN}</span>青色<span class="hljs-variable">${NC}</span>"</span>
            <span class="hljs-built_in">echo</span> -e <span class="hljs-string">"CPU: <span class="hljs-variable">${PURPLE}</span>紫色<span class="hljs-variable">${NC}</span>"</span>
            <span class="hljs-built_in">echo</span> -e <span class="hljs-string">"内存: <span class="hljs-variable">${GREEN}</span>绿色<span class="hljs-variable">${NC}</span>"</span>
            ;;
        <span class="hljs-string">"gruvbox"</span>)
            <span class="hljs-built_in">echo</span> -e <span class="hljs-string">"主色调: <span class="hljs-variable">${YELLOW}</span>黄色<span class="hljs-variable">${NC}</span>"</span>
            <span class="hljs-built_in">echo</span> -e <span class="hljs-string">"CPU: <span class="hljs-variable">${RED}</span>红色<span class="hljs-variable">${NC}</span>"</span>
            <span class="hljs-built_in">echo</span> -e <span class="hljs-string">"内存: <span class="hljs-variable">${GREEN}</span>绿色<span class="hljs-variable">${NC}</span>"</span>
            ;;
        <span class="hljs-string">"solarized"</span>)
            <span class="hljs-built_in">echo</span> -e <span class="hljs-string">"主色调: <span class="hljs-variable">${BLUE}</span>蓝色<span class="hljs-variable">${NC}</span>"</span>
            <span class="hljs-built_in">echo</span> -e <span class="hljs-string">"CPU: <span class="hljs-variable">${RED}</span>红色<span class="hljs-variable">${NC}</span>"</span>
            <span class="hljs-built_in">echo</span> -e <span class="hljs-string">"内存: <span class="hljs-variable">${CYAN}</span>青色<span class="hljs-variable">${NC}</span>"</span>
            ;;
        <span class="hljs-string">"monokai"</span>)
            <span class="hljs-built_in">echo</span> -e <span class="hljs-string">"主色调: <span class="hljs-variable">${GREEN}</span>绿色<span class="hljs-variable">${NC}</span>"</span>
            <span class="hljs-built_in">echo</span> -e <span class="hljs-string">"CPU: <span class="hljs-variable">${RED}</span>红色<span class="hljs-variable">${NC}</span>"</span>
            <span class="hljs-built_in">echo</span> -e <span class="hljs-string">"内存: <span class="hljs-variable">${GREEN}</span>绿色<span class="hljs-variable">${NC}</span>"</span>
            ;;
        <span class="hljs-string">"matrix"</span>)
            <span class="hljs-built_in">echo</span> -e <span class="hljs-string">"所有元素: <span class="hljs-variable">${GREEN}</span>矩阵绿<span class="hljs-variable">${NC}</span>"</span>
            <span class="hljs-built_in">echo</span> -e <span class="hljs-string">"风格: 黑客帝国"</span>
            ;;
    <span class="hljs-keyword">esac</span>
}

<span class="hljs-comment"># 显示菜单</span>
<span class="hljs-function"><span class="hljs-title">show_menu</span></span>() {
    <span class="hljs-built_in">echo</span> -e <span class="hljs-string">"<span class="hljs-variable">${PURPLE}</span>=== bpytop 主题管理器 ===<span class="hljs-variable">${NC}</span>"</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"1. 创建所有主题"</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"2. 列出所有主题"</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"3. 应用默认主题"</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"4. 应用 Gruvbox 主题"</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"5. 应用 Solarized 主题"</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"6. 应用 Monokai 主题"</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"7. 应用黑客帝国主题"</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"8. 预览主题"</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"9. 恢复默认配置"</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"0. 退出"</span>
    <span class="hljs-built_in">echo</span> -n <span class="hljs-string">"请选择 [0-9]: "</span>
}

<span class="hljs-comment"># 恢复默认配置</span>
<span class="hljs-function"><span class="hljs-title">restore_default</span></span>() {
    <span class="hljs-keyword">if</span> [[ -f <span class="hljs-string">"<span class="hljs-variable">$CONFIG_FILE</span>.backup"</span> ]]; <span class="hljs-keyword">then</span>
        <span class="hljs-built_in">cp</span> <span class="hljs-string">"<span class="hljs-variable">$CONFIG_FILE</span>.backup"</span> <span class="hljs-string">"<span class="hljs-variable">$CONFIG_FILE</span>"</span>
        <span class="hljs-built_in">echo</span> -e <span class="hljs-string">"<span class="hljs-variable">${GREEN}</span>配置已恢复<span class="hljs-variable">${NC}</span>"</span>
    <span class="hljs-keyword">else</span>
        <span class="hljs-built_in">echo</span> -e <span class="hljs-string">"<span class="hljs-variable">${YELLOW}</span>未找到备份文件<span class="hljs-variable">${NC}</span>"</span>
    <span class="hljs-keyword">fi</span>
}

<span class="hljs-comment"># 主函数</span>
<span class="hljs-function"><span class="hljs-title">main</span></span>() {
    <span class="hljs-comment"># 检查bpytop是否安装</span>
    <span class="hljs-keyword">if</span> ! <span class="hljs-built_in">command</span> -v bpytop &amp;&gt; /dev/null; <span class="hljs-keyword">then</span>
        <span class="hljs-built_in">echo</span> -e <span class="hljs-string">"<span class="hljs-variable">${RED}</span>错误: bpytop 未安装<span class="hljs-variable">${NC}</span>"</span>
        <span class="hljs-built_in">echo</span> <span class="hljs-string">"请先运行 install_bpytop.sh"</span>
        <span class="hljs-built_in">exit</span> 1
    <span class="hljs-keyword">fi</span>
    
    <span class="hljs-comment"># 检查配置目录</span>
    <span class="hljs-built_in">mkdir</span> -p <span class="hljs-string">"<span class="hljs-subst">$(dirname <span class="hljs-string">"<span class="hljs-variable">$CONFIG_FILE</span>"</span>)</span>"</span>
    
    <span class="hljs-keyword">while</span> <span class="hljs-literal">true</span>; <span class="hljs-keyword">do</span>
        show_menu
        <span class="hljs-built_in">read</span> choice
        
        <span class="hljs-keyword">case</span> <span class="hljs-variable">$choice</span> <span class="hljs-keyword">in</span>
            1)
                create_all_themes
                ;;
            2)
                list_themes
                ;;
            3)
                apply_theme <span class="hljs-string">"default"</span>
                ;;
            4)
                apply_theme <span class="hljs-string">"gruvbox"</span>
                ;;
            5)
                apply_theme <span class="hljs-string">"solarized"</span>
                ;;
            6)
                apply_theme <span class="hljs-string">"monokai"</span>
                ;;
            7)
                apply_theme <span class="hljs-string">"matrix"</span>
                ;;
            8)
                <span class="hljs-built_in">echo</span> -n <span class="hljs-string">"输入要预览的主题名: "</span>
                <span class="hljs-built_in">read</span> theme_name
                preview_theme <span class="hljs-string">"<span class="hljs-variable">$theme_name</span>"</span>
                ;;
            9)
                restore_default
                ;;
            0)
                <span class="hljs-built_in">echo</span> <span class="hljs-string">"退出"</span>
                <span class="hljs-built_in">break</span>
                ;;
            *)
                <span class="hljs-built_in">echo</span> -e <span class="hljs-string">"<span class="hljs-variable">${RED}</span>无效选择<span class="hljs-variable">${NC}</span>"</span>
                ;;
        <span class="hljs-keyword">esac</span>
        
        <span class="hljs-built_in">echo</span>
        <span class="hljs-built_in">echo</span> -e <span class="hljs-string">"<span class="hljs-variable">${YELLOW}</span>按回车继续...<span class="hljs-variable">${NC}</span>"</span>
        <span class="hljs-built_in">read</span>
    <span class="hljs-keyword">done</span>
}

<span class="hljs-comment"># 运行主函数</span>
main <span class="hljs-string">"<span class="hljs-variable">$@</span>"</span>
</code></pre>
<h3 data-id="heading-18">6. 综合对比与使用建议</h3>
<h4 data-id="heading-19">6.1 功能对比表格</h4>
<p><strong>创建对比分析脚本：<code>monitor_comparison.sh</code></strong></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-meta">#!/bin/bash</span>

<span class="hljs-comment"># 系统监控工具对比分析脚本</span>

<span class="hljs-comment"># 颜色定义</span>
HEADER=<span class="hljs-string">'\033[1;35m'</span>
OK=<span class="hljs-string">'\033[0;32m'</span>
WARNING=<span class="hljs-string">'\033[1;33m'</span>
ERROR=<span class="hljs-string">'\033[0;31m'</span>
NC=<span class="hljs-string">'\033[0m'</span>

<span class="hljs-comment"># 检查工具是否安装</span>
<span class="hljs-function"><span class="hljs-title">check_tool</span></span>() {
    <span class="hljs-built_in">local</span> tool=<span class="hljs-variable">$1</span>
    <span class="hljs-keyword">if</span> <span class="hljs-built_in">command</span> -v <span class="hljs-variable">$tool</span> &amp;&gt; /dev/null; <span class="hljs-keyword">then</span>
        <span class="hljs-built_in">echo</span> -e <span class="hljs-string">"<span class="hljs-variable">${OK}</span>✓ 已安装<span class="hljs-variable">${NC}</span>"</span>
        <span class="hljs-built_in">return</span> 0
    <span class="hljs-keyword">else</span>
        <span class="hljs-built_in">echo</span> -e <span class="hljs-string">"<span class="hljs-variable">${ERROR}</span>✗ 未安装<span class="hljs-variable">${NC}</span>"</span>
        <span class="hljs-built_in">return</span> 1
    <span class="hljs-keyword">fi</span>
}

<span class="hljs-comment"># 性能测试函数</span>
<span class="hljs-function"><span class="hljs-title">performance_test</span></span>() {
    <span class="hljs-built_in">local</span> tool=<span class="hljs-variable">$1</span>
    <span class="hljs-built_in">echo</span> -e <span class="hljs-string">"<span class="hljs-variable">${HEADER}</span>测试 <span class="hljs-variable">$tool</span> 启动性能...<span class="hljs-variable">${NC}</span>"</span>
    
    <span class="hljs-keyword">if</span> <span class="hljs-built_in">command</span> -v <span class="hljs-variable">$tool</span> &amp;&gt; /dev/null; <span class="hljs-keyword">then</span>
        <span class="hljs-built_in">local</span> start_time=$(<span class="hljs-built_in">date</span> +%s%N)
        <span class="hljs-variable">$tool</span> --version &gt; /dev/null 2&gt;&amp;1
        <span class="hljs-built_in">local</span> end_time=$(<span class="hljs-built_in">date</span> +%s%N)
        <span class="hljs-built_in">local</span> duration=$(( (end_time - start_time) / <span class="hljs-number">1000000</span> ))
        <span class="hljs-built_in">echo</span> -e <span class="hljs-string">"启动时间: <span class="hljs-variable">${OK}</span><span class="hljs-variable">${duration}</span>ms<span class="hljs-variable">${NC}</span>"</span>
    <span class="hljs-keyword">else</span>
        <span class="hljs-built_in">echo</span> -e <span class="hljs-string">"<span class="hljs-variable">${ERROR}</span>工具未安装<span class="hljs-variable">${NC}</span>"</span>
    <span class="hljs-keyword">fi</span>
}

<span class="hljs-comment"># 内存占用测试</span>
<span class="hljs-function"><span class="hljs-title">memory_test</span></span>() {
    <span class="hljs-built_in">local</span> tool=<span class="hljs-variable">$1</span>
    <span class="hljs-built_in">echo</span> -e <span class="hljs-string">"<span class="hljs-variable">${HEADER}</span>测试 <span class="hljs-variable">$tool</span> 内存占用...<span class="hljs-variable">${NC}</span>"</span>
    
    <span class="hljs-keyword">if</span> <span class="hljs-built_in">command</span> -v <span class="hljs-variable">$tool</span> &amp;&gt; /dev/null; <span class="hljs-keyword">then</span>
        <span class="hljs-comment"># 启动工具并在后台运行</span>
        <span class="hljs-variable">$tool</span> &gt; /dev/null 2&gt;&amp;1 &amp;
        <span class="hljs-built_in">local</span> pid=$!
        <span class="hljs-built_in">sleep</span> 3
        
        <span class="hljs-comment"># 获取内存使用量</span>
        <span class="hljs-built_in">local</span> memory_usage=$(ps -o rss= -p <span class="hljs-variable">$pid</span> 2&gt;/dev/null | awk <span class="hljs-string">'{print $1/1024 " MB"}'</span>)
        
        <span class="hljs-comment"># 清理进程</span>
        <span class="hljs-built_in">kill</span> <span class="hljs-variable">$pid</span> 2&gt;/dev/null
        <span class="hljs-built_in">wait</span> <span class="hljs-variable">$pid</span> 2&gt;/dev/null
        
        <span class="hljs-built_in">echo</span> -e <span class="hljs-string">"内存占用: <span class="hljs-variable">${OK}</span><span class="hljs-variable">${memory_usage}</span><span class="hljs-variable">${NC}</span>"</span>
    <span class="hljs-keyword">else</span>
        <span class="hljs-built_in">echo</span> -e <span class="hljs-string">"<span class="hljs-variable">${ERROR}</span>工具未安装<span class="hljs-variable">${NC}</span>"</span>
    <span class="hljs-keyword">fi</span>
}

<span class="hljs-comment"># 功能对比</span>
<span class="hljs-function"><span class="hljs-title">feature_comparison</span></span>() {
    <span class="hljs-built_in">echo</span> -e <span class="hljs-string">"<span class="hljs-variable">${HEADER}</span>=== 功能对比 ===<span class="hljs-variable">${NC}</span>"</span>
    <span class="hljs-built_in">printf</span> <span class="hljs-string">"%-15s | %-6s | %-6s | %-8s | %-10s | %-10s\n"</span> <span class="hljs-string">"功能"</span> <span class="hljs-string">"htop"</span> <span class="hljs-string">"glances"</span> <span class="hljs-string">"bpytop"</span> <span class="hljs-string">"top"</span> <span class="hljs-string">"gotop"</span>
    <span class="hljs-built_in">printf</span> <span class="hljs-string">"%-15s | %-6s | %-6s | %-8s | %-10s | %-10s\n"</span> <span class="hljs-string">"--------------"</span> <span class="hljs-string">"------"</span> <span class="hljs-string">"------"</span> <span class="hljs-string">"--------"</span> <span class="hljs-string">"----------"</span> <span class="hljs-string">"----------"</span>
    <span class="hljs-built_in">printf</span> <span class="hljs-string">"%-15s | %-6s | %-6s | %-8s | %-10s | %-10s\n"</span> <span class="hljs-string">"彩色界面"</span> <span class="hljs-string">"✓"</span> <span class="hljs-string">"✓"</span> <span class="hljs-string">"✓"</span> <span class="hljs-string">"✗"</span> <span class="hljs-string">"✓"</span>
    <span class="hljs-built_in">printf</span> <span class="hljs-string">"%-15s | %-6s | %-6s | %-8s | %-10s | %-10s\n"</span> <span class="hljs-string">"鼠标支持"</span> <span class="hljs-string">"✓"</span> <span class="hljs-string">"✓"</span> <span class="hljs-string">"✓"</span> <span class="hljs-string">"✗"</span> <span class="hljs-string">"✓"</span>
    <span class="hljs-built_in">printf</span> <span class="hljs-string">"%-15s | %-6s | %-6s | %-8s | %-10s | %-10s\n"</span> <span class="hljs-string">"树状视图"</span> <span class="hljs-string">"✓"</span> <span class="hljs-string">"✗"</span> <span class="hljs-string">"✓"</span> <span class="hljs-string">"✗"</span> <span class="hljs-string">"✗"</span>
    <span class="hljs-built_in">printf</span> <span class="hljs-string">"%-15s | %-6s | %-6s | %-8s | %-10s | %-10s\n"</span> <span class="hljs-string">"网络监控"</span> <span class="hljs-string">"✗"</span> <span class="hljs-string">"✓"</span> <span class="hljs-string">"✓"</span> <span class="hljs-string">"✗"</span> <span class="hljs-string">"✓"</span>
    <span class="hljs-built_in">printf</span> <span class="hljs-string">"%-15s | %-6s | %-6s | %-8s | %-10s | %-10s\n"</span> <span class="hljs-string">"磁盘IO"</span> <span class="hljs-string">"✗"</span> <span class="hljs-string">"✓"</span> <span class="hljs-string">"✓"</span> <span class="hljs-string">"✗"</span> <span class="hljs-string">"✓"</span>
    <span class="hljs-built_in">printf</span> <span class="hljs-string">"%-15s | %-6s | %-6s | %-8s | %-10s | %-10s\n"</span> <span class="hljs-string">"温度监控"</span> <span class="hljs-string">"✗"</span> <span class="hljs-string">"✓"</span> <span class="hljs-string">"✓"</span> <span class="hljs-string">"✗"</span> <span class="hljs-string">"✓"</span>
    <span class="hljs-built_in">printf</span> <span class="hljs-string">"%-15s | %-6s | %-6s | %-8s | %-10s | %-10s\n"</span> <span class="hljs-string">"Web界面"</span> <span class="hljs-string">"✗"</span> <span class="hljs-string">"✓"</span> <span class="hljs-string">"✗"</span> <span class="hljs-string">"✗"</span> <span class="hljs-string">"✗"</span>
    <span class="hljs-built_in">printf</span> <span class="hljs-string">"%-15s | %-6s | %-6s | %-8s | %-10s | %-10s\n"</span> <span class="hljs-string">"远程监控"</span> <span class="hljs-string">"✗"</span> <span class="hljs-string">"✓"</span> <span class="hljs-string">"✗"</span> <span class="hljs-string">"✗"</span> <span class="hljs-string">"✗"</span>
    <span class="hljs-built_in">printf</span> <span class="hljs-string">"%-15s | %-6s | %-6s | %-8s | %-10s | %-10s\n"</span> <span class="hljs-string">"主题定制"</span> <span class="hljs-string">"有限"</span> <span class="hljs-string">"有限"</span> <span class="hljs-string">"丰富"</span> <span class="hljs-string">"无"</span> <span class="hljs-string">"中等"</span>
}

<span class="hljs-comment"># 使用场景建议</span>
<span class="hljs-function"><span class="hljs-title">usage_scenarios</span></span>() {
    <span class="hljs-built_in">echo</span>
    <span class="hljs-built_in">echo</span> -e <span class="hljs-string">"<span class="hljs-variable">${HEADER}</span>=== 使用场景建议 ===<span class="hljs-variable">${NC}</span>"</span>
    
    <span class="hljs-built_in">echo</span> -e <span class="hljs-string">"<span class="hljs-variable">${OK}</span>htop - 传统进程管理<span class="hljs-variable">${NC}</span>"</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"适用场景:"</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"  • 进程管理和调试"</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"  • 系统资源快速查看"</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"  • 需要树状进程视图"</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"  • 交互式进程操作"</span>
    
    <span class="hljs-built_in">echo</span>
    <span class="hljs-built_in">echo</span> -e <span class="hljs-string">"<span class="hljs-variable">${OK}</span>glances - 全能系统监控<span class="hljs-variable">${NC}</span>"</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"适用场景:"</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"  • 多服务器监控"</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"  • Web界面访问"</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"  • 历史数据记录"</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"  • 告警和通知"</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"  • 远程系统监控"</span>
    
    <span class="hljs-built_in">echo</span>
    <span class="hljs-built_in">echo</span> -e <span class="hljs-string">"<span class="hljs-variable">${OK}</span>bpytop - 现代化视觉监控<span class="hljs-variable">${NC}</span>"</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"适用场景:"</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"  • 本地系统详细监控"</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"  • 视觉效果要求高"</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"  • 需要详细的硬件监控"</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"  • 主题定制需求"</span>
}

<span class="hljs-comment"># 安装状态检查</span>
<span class="hljs-function"><span class="hljs-title">check_installation</span></span>() {
    <span class="hljs-built_in">echo</span> -e <span class="hljs-string">"<span class="hljs-variable">${HEADER}</span>=== 安装状态检查 ===<span class="hljs-variable">${NC}</span>"</span>
    <span class="hljs-built_in">echo</span> -n <span class="hljs-string">"htop:    "</span>; check_tool htop
    <span class="hljs-built_in">echo</span> -n <span class="hljs-string">"glances: "</span>; check_tool glances
    <span class="hljs-built_in">echo</span> -n <span class="hljs-string">"bpytop:  "</span>; check_tool bpytop
}

<span class="hljs-comment"># 性能对比</span>
<span class="hljs-function"><span class="hljs-title">performance_comparison</span></span>() {
    <span class="hljs-built_in">echo</span>
    <span class="hljs-built_in">echo</span> -e <span class="hljs-string">"<span class="hljs-variable">${HEADER}</span>=== 性能对比 ===<span class="hljs-variable">${NC}</span>"</span>
    performance_test htop
    performance_test glances
    performance_test bpytop
}

<span class="hljs-comment"># 内存占用对比</span>
<span class="hljs-function"><span class="hljs-title">memory_comparison</span></span>() {
    <span class="hljs-built_in">echo</span>
    <span class="hljs-built_in">echo</span> -e <span class="hljs-string">"<span class="hljs-variable">${HEADER}</span>=== 内存占用对比 ===<span class="hljs-variable">${NC}</span>"</span>
    memory_test htop
    memory_test glances
    memory_test bpytop
}

<span class="hljs-comment"># 推荐配置</span>
<span class="hljs-function"><span class="hljs-title">recommendation</span></span>() {
    <span class="hljs-built_in">echo</span>
    <span class="hljs-built_in">echo</span> -e <span class="hljs-string">"<span class="hljs-variable">${HEADER}</span>=== 最终推荐 ===<span class="hljs-variable">${NC}</span>"</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"根据功能、性能和易用性，推荐如下:"</span>
    <span class="hljs-built_in">echo</span>
    <span class="hljs-built_in">echo</span> -e <span class="hljs-string">"<span class="hljs-variable">${OK}</span>🏆 最佳全能: glances<span class="hljs-variable">${NC}</span>"</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"  理由: 功能最全面，支持远程监控和Web界面"</span>
    <span class="hljs-built_in">echo</span>
    <span class="hljs-built_in">echo</span> -e <span class="hljs-string">"<span class="hljs-variable">${OK}</span>🎨 最佳视觉: bpytop<span class="hljs-variable">${NC}</span>"</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"  理由: 界面最美观，信息展示最详细"</span>
    <span class="hljs-built_in">echo</span>
    <span class="hljs-built_in">echo</span> -e <span class="hljs-string">"<span class="hljs-variable">${OK}</span>⚡ 最轻量级: htop<span class="hljs-variable">${NC}</span>"</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"  理由: 启动最快，资源占用最低"</span>
}

<span class="hljs-comment"># 主函数</span>
<span class="hljs-function"><span class="hljs-title">main</span></span>() {
    <span class="hljs-built_in">echo</span> -e <span class="hljs-string">"<span class="hljs-variable">${HEADER}</span>系统监控工具综合对比分析<span class="hljs-variable">${NC}</span>"</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"=========================================="</span>
    
    check_installation
    feature_comparison
    performance_comparison
    memory_comparison
    usage_scenarios
    recommendation
}

<span class="hljs-comment"># 运行主函数</span>
main <span class="hljs-string">"<span class="hljs-variable">$@</span>"</span>
</code></pre>
<h3 data-id="heading-20">7. 总结</h3>
<p>通过本文的详细评测和实战脚本，我们可以看到三个工具各有特色：</p>
<ul>
<li><strong>htop</strong> 适合传统的进程管理和快速系统检查</li>
<li><strong>glances</strong> 适合需要全面监控和远程访问的场景</li>
<li><strong>bpytop</strong> 适合追求视觉效果和详细硬件监控的用户</li>
</ul>
<p>建议根据实际需求选择合适的工具，或者组合使用以获得最佳监控体验。所有提供的脚本都可以直接运行，帮助您快速搭建完整的系统监控环境。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[JavaScript 中 this 指向问题]]></title>    <link>https://juejin.cn/post/7577298871003824162</link>    <guid>https://juejin.cn/post/7577298871003824162</guid>    <pubDate>2025-11-28T02:23:40.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577298871003824162" data-draft-id="7577203946062823464" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="JavaScript 中 this 指向问题"/> <meta itemprop="keywords" content="JavaScript"/> <meta itemprop="datePublished" content="2025-11-28T02:23:40.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="uup"/> <meta itemprop="url" content="https://juejin.cn/user/4378706456356627"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            JavaScript 中 this 指向问题
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4378706456356627/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    uup
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-28T02:23:40.000Z" title="Fri Nov 28 2025 02:23:40 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-28
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一、Bug 场景</h2>
<p>在一个 JavaScript 的网页交互项目中，有一个构造函数定义了一个对象，该对象包含一个方法用于更新 DOM 元素的文本内容。同时，为了实现异步操作，在这个方法内部使用了 <code>setTimeout</code> 来模拟一些延迟任务。</p>
<h2 data-id="heading-1">二、代码示例</h2>
<pre><code class="hljs language-html" lang="html"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"en"</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">"UTF - 8"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"viewport"</span> <span class="hljs-attr">content</span>=<span class="hljs-string">"width=device - width, initial - scale = 1.0"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>this指向问题<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"target"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
        <span class="hljs-keyword">function</span> <span class="hljs-title function_">DOMUpdater</span>(<span class="hljs-params"/>) {
            <span class="hljs-variable language_">this</span>.<span class="hljs-property">targetElement</span> = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'target'</span>);
            <span class="hljs-variable language_">this</span>.<span class="hljs-property">updateText</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params"/>) {
                <span class="hljs-built_in">setTimeout</span>(<span class="hljs-keyword">function</span> (<span class="hljs-params"/>) {
                    <span class="hljs-variable language_">this</span>.<span class="hljs-property">targetElement</span>.<span class="hljs-property">textContent</span> = <span class="hljs-string">'更新后的文本'</span>;
                }, <span class="hljs-number">1000</span>);
            };
        }

        <span class="hljs-keyword">const</span> updater = <span class="hljs-keyword">new</span> <span class="hljs-title class_">DOMUpdater</span>();
        updater.<span class="hljs-title function_">updateText</span>();
    </span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>

<span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span>
</code></pre>
<h2 data-id="heading-2">三、问题描述</h2>
<ol>
<li><strong>预期行为</strong>：等待 1 秒后，<code>id</code> 为 <code>target</code> 的 <code>div</code> 元素的文本内容应更新为 “更新后的文本”。</li>
<li><strong>实际行为</strong>：在控制台中会报错 <code>Uncaught TypeError: Cannot set property 'textContent' of null</code>。这是因为在 <code>setTimeout</code> 内部的回调函数中，<code>this</code> 的指向发生了变化。在非严格模式下，<code>setTimeout</code> 回调函数中的 <code>this</code> 指向全局对象（在浏览器环境中是 <code>window</code>），而不是 <code>DOMUpdater</code> 实例对象。由于 <code>window</code> 中没有 <code>targetElement</code> 属性，所以会导致 <code>this.targetElement</code> 为 <code>null</code>，进而引发错误。</li>
</ol>
<h2 data-id="heading-3">四、解决方案</h2>
<ol>
<li><strong>使用箭头函数</strong>：箭头函数没有自己的 <code>this</code>，它的 <code>this</code> 继承自外层作用域，这样就可以保持 <code>this</code> 指向 <code>DOMUpdater</code> 实例对象。</li>
</ol>
<pre><code class="hljs language-html" lang="html"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"en"</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">"UTF - 8"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"viewport"</span> <span class="hljs-attr">content</span>=<span class="hljs-string">"width=device - width, initial - scale = 1.0"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>this指向问题 - 箭头函数解决<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"target"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
        <span class="hljs-keyword">function</span> <span class="hljs-title function_">DOMUpdater</span>(<span class="hljs-params"/>) {
            <span class="hljs-variable language_">this</span>.<span class="hljs-property">targetElement</span> = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'target'</span>);
            <span class="hljs-variable language_">this</span>.<span class="hljs-property">updateText</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params"/>) {
                <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
                    <span class="hljs-variable language_">this</span>.<span class="hljs-property">targetElement</span>.<span class="hljs-property">textContent</span> = <span class="hljs-string">'更新后的文本'</span>;
                }, <span class="hljs-number">1000</span>);
            };
        }

        <span class="hljs-keyword">const</span> updater = <span class="hljs-keyword">new</span> <span class="hljs-title class_">DOMUpdater</span>();
        updater.<span class="hljs-title function_">updateText</span>();
    </span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>

<span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span>
</code></pre>
<ol start="2">
<li><strong>使用变量保存 this</strong>：在 <code>updateText</code> 方法内部，使用一个变量（通常命名为 <code>self</code> 或 <code>that</code>）来保存 <code>this</code> 的值，然后在 <code>setTimeout</code> 回调函数中使用这个变量。</li>
</ol>
<pre><code class="hljs language-html" lang="html"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"en"</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">"UTF - 8"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"viewport"</span> <span class="hljs-attr">content</span>=<span class="hljs-string">"width=device - width, initial - scale = 1.0"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>this指向问题 - 变量保存this解决<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"target"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
        <span class="hljs-keyword">function</span> <span class="hljs-title function_">DOMUpdater</span>(<span class="hljs-params"/>) {
            <span class="hljs-variable language_">this</span>.<span class="hljs-property">targetElement</span> = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'target'</span>);
            <span class="hljs-variable language_">this</span>.<span class="hljs-property">updateText</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params"/>) {
                <span class="hljs-keyword">const</span> self = <span class="hljs-variable language_">this</span>;
                <span class="hljs-built_in">setTimeout</span>(<span class="hljs-keyword">function</span> (<span class="hljs-params"/>) {
                    self.<span class="hljs-property">targetElement</span>.<span class="hljs-property">textContent</span> = <span class="hljs-string">'更新后的文本'</span>;
                }, <span class="hljs-number">1000</span>);
            };
        }

        <span class="hljs-keyword">const</span> updater = <span class="hljs-keyword">new</span> <span class="hljs-title class_">DOMUpdater</span>();
        updater.<span class="hljs-title function_">updateText</span>();
    </span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>

<span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span>
</code></pre>
<ol start="3">
<li><strong>使用 <code>bind</code> 方法</strong>：<code>bind</code> 方法可以创建一个新的函数，在这个新函数中，<code>this</code> 被绑定到指定的对象。</li>
</ol>
<pre><code class="hljs language-html" lang="html"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"en"</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">"UTF - 8"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"viewport"</span> <span class="hljs-attr">content</span>=<span class="hljs-string">"width=device - width, initial - scale = 1.0"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>this指向问题 - bind解决<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"target"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
        <span class="hljs-keyword">function</span> <span class="hljs-title function_">DOMUpdater</span>(<span class="hljs-params"/>) {
            <span class="hljs-variable language_">this</span>.<span class="hljs-property">targetElement</span> = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'target'</span>);
            <span class="hljs-variable language_">this</span>.<span class="hljs-property">updateText</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params"/>) {
                <span class="hljs-built_in">setTimeout</span>(<span class="hljs-keyword">function</span> (<span class="hljs-params"/>) {
                    <span class="hljs-variable language_">this</span>.<span class="hljs-property">targetElement</span>.<span class="hljs-property">textContent</span> = <span class="hljs-string">'更新后的文本'</span>;
                }.<span class="hljs-title function_">bind</span>(<span class="hljs-variable language_">this</span>), <span class="hljs-number">1000</span>);
            };
        }

        <span class="hljs-keyword">const</span> updater = <span class="hljs-keyword">new</span> <span class="hljs-title class_">DOMUpdater</span>();
        updater.<span class="hljs-title function_">updateText</span>();
    </span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>

<span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span>
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[手搓一个简简单单进度条]]></title>    <link>https://juejin.cn/post/7577294037716942882</link>    <guid>https://juejin.cn/post/7577294037716942882</guid>    <pubDate>2025-11-28T02:31:26.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577294037716942882" data-draft-id="7577284771446571048" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="手搓一个简简单单进度条"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-11-28T02:31:26.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="流星稍逝"/> <meta itemprop="url" content="https://juejin.cn/user/3707997273726007"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            手搓一个简简单单进度条
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3707997273726007/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    流星稍逝
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-28T02:31:26.000Z" title="Fri Nov 28 2025 02:31:26 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-28
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">懂得都懂就不细细解剖，直接上代码</h2>
<p>也就是太无聊，心血来潮搓一个小玩意儿</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/89ff9a1f430048f7ab39647a1b0991d6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rWB5pif56iN6YCd:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764901885&amp;x-signature=TVIWQ7gm8TPN63DT7YJ467XJ7sg%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/43f7d8468fed4a73b5a3fabcc7a92841~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rWB5pif56iN6YCd:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764901885&amp;x-signature=bI0t0ZSKbhdmS8ZLZ216qxBe7H0%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-1">div盒子</h3>
<pre><code class="hljs language-ini" lang="ini">&lt;div <span class="hljs-attr">class</span>=<span class="hljs-string">"progress-box"</span>&gt;
	&lt;div <span class="hljs-attr">class</span>=<span class="hljs-string">"progress-bar"</span> :style=<span class="hljs-string">"{ width: `${progress.width}%` }"</span>&gt;
	&lt;div <span class="hljs-attr">class</span>=<span class="hljs-string">"progress-bar-inner"</span>&gt;
		&lt;div <span class="hljs-attr">class</span>=<span class="hljs-string">"progress-light"</span>&gt;&lt;/div&gt;
	&lt;/div&gt;
	&lt;/div&gt;						&lt;/div&gt;
							&lt;div <span class="hljs-attr">class</span>=<span class="hljs-string">"progress-text"</span>&gt;
	&lt;span <span class="hljs-attr">class</span>=<span class="hljs-string">"num"</span> ref=<span class="hljs-string">"countDemo"</span>
	:<span class="hljs-attr">style</span>=<span class="hljs-string">"{ left: `calc(${progress.width}% - ${Amountspent &lt; 99 ? 66 :Amountspent &gt; 999 &amp;&amp; progress.width &lt; 50 ? 40 : 70}px)` }"</span>&gt;
	$ {{ Amountspent }}
	&lt;/span&gt;
							&lt;/div&gt;
</code></pre>
<h3 data-id="heading-2">js</h3>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">setup</span>&gt;</span><span class="javascript">
	<span class="hljs-keyword">import</span> { onMounted,ref } <span class="hljs-keyword">from</span> <span class="hljs-string">"vue"</span>
        <span class="hljs-comment">//进度条相关参数</span>
        <span class="hljs-keyword">const</span> progress = <span class="hljs-title function_">ref</span>({
		<span class="hljs-attr">width</span>: <span class="hljs-number">0</span>,
		<span class="hljs-attr">startValue</span>: <span class="hljs-number">0</span>,
		<span class="hljs-attr">endValue</span>: <span class="hljs-number">0</span>
	})
        <span class="hljs-keyword">const</span> <span class="hljs-title class_">Amountspent</span> = <span class="hljs-title function_">ref</span>(<span class="hljs-number">0</span>)
        	<span class="hljs-keyword">const</span> <span class="hljs-title function_">progressVal</span> = (<span class="hljs-params">start = <span class="hljs-number">0</span>, end = <span class="hljs-number">0</span></span>) =&gt; {
		<span class="hljs-keyword">const</span> startVal = <span class="hljs-title class_">Number</span>(start ?? <span class="hljs-number">0</span>) || <span class="hljs-number">0</span>
		<span class="hljs-keyword">const</span> endVal = <span class="hljs-title class_">Number</span>(end ?? <span class="hljs-number">0</span>) || <span class="hljs-number">0</span>
		<span class="hljs-keyword">return</span> {
			<span class="hljs-attr">width</span>: endVal &gt; <span class="hljs-number">0</span> ? <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">min</span>(<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">max</span>((startVal / endVal) * <span class="hljs-number">100</span>, <span class="hljs-number">0</span>), <span class="hljs-number">100</span>).<span class="hljs-title function_">toFixed</span>(<span class="hljs-number">2</span>) : <span class="hljs-number">0</span>,
			<span class="hljs-attr">startValue</span>: startVal,
			<span class="hljs-attr">endValue</span>: endVal
		}
	}
        
        	<span class="hljs-title function_">onMounted</span>(<span class="hljs-function">() =&gt;</span> {
                <span class="hljs-comment">//接口请求获取参数</span>
		<span class="hljs-title function_">getprogressInfo</span>({}, <span class="hljs-function">(<span class="hljs-params">res</span>) =&gt;</span> {
			<span class="hljs-keyword">if</span> (!res) <span class="hljs-keyword">return</span>

			<span class="hljs-keyword">if</span> (res &amp;&amp; res.<span class="hljs-property">data</span>) {
<span class="hljs-keyword">let</span> { totaAmount, amountspent } = res.<span class="hljs-property">data</span>
<span class="hljs-title class_">Amountspent</span>.<span class="hljs-property">value</span>=amountspent?<span class="hljs-attr">amountspent</span>:<span class="hljs-number">0</span>
	progress.<span class="hljs-property">value</span> = <span class="hljs-title function_">progressVal</span>(amountspent, totaAmount)<span class="hljs-comment">//进度条</span>


			}

		})

	})
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
<h3 data-id="heading-3">css</h3>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">style</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"scss"</span>&gt;</span><span class="css">
<span class="hljs-selector-class">.progress-box</span> {
			<span class="hljs-attribute">position</span>: relative;
			<span class="hljs-attribute">border-radius</span>: <span class="hljs-number">500px</span>;
			<span class="hljs-attribute">background</span>: <span class="hljs-built_in">rgba</span>(<span class="hljs-number">255</span>, <span class="hljs-number">255</span>, <span class="hljs-number">255</span>, <span class="hljs-number">0.05</span>);
			<span class="hljs-attribute">padding</span>: <span class="hljs-number">2px</span>;
			<span class="hljs-attribute">height</span>: <span class="hljs-number">10px</span>;
			<span class="hljs-attribute">margin-bottom</span>: <span class="hljs-number">7px</span>;

			<span class="hljs-selector-class">.progress-value</span> {
				<span class="hljs-attribute">position</span>: absolute;
				<span class="hljs-attribute">left</span>: <span class="hljs-number">50%</span>;
				<span class="hljs-attribute">top</span>: <span class="hljs-number">50%</span>;
				<span class="hljs-attribute">transform</span>: <span class="hljs-built_in">translate</span>(-<span class="hljs-number">50%</span>, -<span class="hljs-number">50%</span>);
				<span class="hljs-attribute">color</span>: <span class="hljs-number">#fff</span>;
				<span class="hljs-attribute">text-align</span>: center;
				<span class="hljs-attribute">font-size</span>: <span class="hljs-number">12px</span>;
				<span class="hljs-attribute">font-weight</span>: <span class="hljs-number">800</span>;
				<span class="hljs-attribute">line-height</span>: <span class="hljs-number">1</span>;
				<span class="hljs-attribute">text-shadow</span>: <span class="hljs-number">0</span> <span class="hljs-number">2px</span> <span class="hljs-number">0</span> <span class="hljs-built_in">rgba</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0.1</span>);
			}

			<span class="hljs-selector-class">.progress-bar</span> {
				<span class="hljs-attribute">height</span>: <span class="hljs-number">100%</span>;
				<span class="hljs-attribute">width</span>: <span class="hljs-number">0</span>;
				<span class="hljs-attribute">border-radius</span>: <span class="hljs-number">500px</span>;
				<span class="hljs-attribute">background</span>: <span class="hljs-number">#20ce2e</span>;
				<span class="hljs-attribute">position</span>: relative;
				<span class="hljs-attribute">box-shadow</span>:
					<span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">3px</span> <span class="hljs-number">0</span> <span class="hljs-number">#00ff9d</span> inset,
					<span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">7.5px</span> <span class="hljs-number">0</span> <span class="hljs-built_in">rgba</span>(<span class="hljs-number">32</span>, <span class="hljs-number">206</span>, <span class="hljs-number">46</span>, <span class="hljs-number">0.6</span>);

				<span class="hljs-selector-class">.progress-bar-inner</span> {
					<span class="hljs-attribute">position</span>: absolute;
					<span class="hljs-attribute">right</span>: -<span class="hljs-number">11px</span>;
					<span class="hljs-attribute">top</span>: -<span class="hljs-number">11px</span>;
				}

				<span class="hljs-selector-class">.progress-light</span> {
					<span class="hljs-attribute">width</span>: <span class="hljs-number">30px</span>;
					<span class="hljs-attribute">height</span>: <span class="hljs-number">30px</span>;
					<span class="hljs-attribute">position</span>: relative;
					<span class="hljs-attribute">border-radius</span>: <span class="hljs-number">50%</span>;
					<span class="hljs-attribute">background-color</span>: <span class="hljs-built_in">rgba</span>(<span class="hljs-number">205</span>, <span class="hljs-number">222</span>, <span class="hljs-number">221</span>, <span class="hljs-number">0.1</span>);

					&amp;<span class="hljs-selector-pseudo">::before</span> {
						<span class="hljs-attribute">content</span>: <span class="hljs-string">""</span>;
						<span class="hljs-attribute">position</span>: absolute;
						<span class="hljs-attribute">top</span>: <span class="hljs-number">50%</span>;
						<span class="hljs-attribute">left</span>: <span class="hljs-number">50%</span>;
						<span class="hljs-attribute">transform</span>: <span class="hljs-built_in">translate</span>(-<span class="hljs-number">50%</span>, -<span class="hljs-number">50%</span>);
						<span class="hljs-attribute">width</span>: <span class="hljs-number">18px</span>;
						<span class="hljs-attribute">height</span>: <span class="hljs-number">18px</span>;
						<span class="hljs-attribute">border-radius</span>: <span class="hljs-number">50%</span>;
						<span class="hljs-attribute">background-color</span>: <span class="hljs-built_in">rgba</span>(<span class="hljs-number">205</span>, <span class="hljs-number">222</span>, <span class="hljs-number">221</span>, <span class="hljs-number">0.1</span>);
					}

					&amp;<span class="hljs-selector-pseudo">::after</span> {
						<span class="hljs-attribute">content</span>: <span class="hljs-string">""</span>;
						<span class="hljs-attribute">position</span>: absolute;
						<span class="hljs-attribute">top</span>: <span class="hljs-number">50%</span>;
						<span class="hljs-attribute">left</span>: <span class="hljs-number">50%</span>;
						<span class="hljs-attribute">transform</span>: <span class="hljs-built_in">translate</span>(-<span class="hljs-number">50%</span>, -<span class="hljs-number">50%</span>);
						<span class="hljs-attribute">width</span>: <span class="hljs-number">10px</span>;
						<span class="hljs-attribute">height</span>: <span class="hljs-number">10px</span>;
						<span class="hljs-attribute">border-radius</span>: <span class="hljs-number">50%</span>;
						<span class="hljs-attribute">background-color</span>: <span class="hljs-number">#e7fefd</span>;
					}
				}
			}
		}
                
                
		<span class="hljs-selector-class">.progress-text</span> {
			<span class="hljs-attribute">position</span>: relative;
			<span class="hljs-comment">/* padding: 2px; */</span>
			<span class="hljs-attribute">height</span>: <span class="hljs-number">10px</span>;
			<span class="hljs-attribute">margin-bottom</span>: <span class="hljs-number">10px</span>;
			<span class="hljs-attribute">margin-right</span>: <span class="hljs-number">14px</span>;

			<span class="hljs-selector-class">.num</span> {
				<span class="hljs-attribute">font-weight</span>: <span class="hljs-number">800</span>;
				<span class="hljs-attribute">font-style</span>: ExtraBold;
				<span class="hljs-attribute">font-size</span>: <span class="hljs-number">12px</span>;
				<span class="hljs-attribute">line-height</span>: <span class="hljs-number">1.5</span>;
				<span class="hljs-attribute">position</span>: absolute;
				<span class="hljs-attribute">color</span>: <span class="hljs-built_in">rgba</span>(<span class="hljs-number">172</span>, <span class="hljs-number">188</span>, <span class="hljs-number">208</span>, <span class="hljs-number">1</span>);
				<span class="hljs-attribute">width</span>: <span class="hljs-number">80px</span>;
				<span class="hljs-attribute">display</span>: inline-block;
				<span class="hljs-attribute">text-align</span>: right;
			}
		}
</span></code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[JavaScript 词法作用域、作用域链与闭包：从代码看机制]]></title>    <link>https://juejin.cn/post/7577295460248944686</link>    <guid>https://juejin.cn/post/7577295460248944686</guid>    <pubDate>2025-11-28T02:35:24.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577295460248944686" data-draft-id="7577300470520299529" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="JavaScript 词法作用域、作用域链与闭包：从代码看机制"/> <meta itemprop="keywords" content="前端,JavaScript"/> <meta itemprop="datePublished" content="2025-11-28T02:35:24.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="ohyeah"/> <meta itemprop="url" content="https://juejin.cn/user/740446536480618"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            JavaScript 词法作用域、作用域链与闭包：从代码看机制
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/740446536480618/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    ohyeah
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-28T02:35:24.000Z" title="Fri Nov 28 2025 02:35:24 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-28
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在学习 JavaScript 的过程中，<strong>作用域</strong> 是一个绕不开的核心概念。很多人一开始会误以为“变量在哪调用，就在哪找”，但其实 JS 的作用域是 <strong>词法作用域（Lexical Scoping）</strong> ，也就是说，函数的作用域由它<strong>定义的位置</strong>决定，而不是调用位置。今天我们就通过几段简单的代码和图解，来深入浅出地理解 JavaScript 中的 <strong>词法作用域、作用域链 和 闭包</strong> 这三个重要机制。</p>
<hr/>
<h2 data-id="heading-0">一、什么是执行上下文？调用栈是如何工作的？</h2>
<p>在 JavaScript 中，每当一个函数被调用时，都会创建一个「执行上下文」（Execution Context），并压入调用栈（Call Stack）。这个执行上下文包含两个关键部分：</p>
<ul>
<li><strong>变量环境（Variable Environment）</strong> ：存储用 <code>var</code> 声明的变量和函数声明。</li>
<li><strong>词法环境（Lexical Environment）</strong> ：存储用 <code>let</code>、<code>const</code> 声明的块级作用域变量。</li>
</ul>
<p>此外，每个执行上下文的词法环境中还有一个特殊的属性：<code>outer</code>，它指向该函数<strong>定义时所在的作用域</strong>的词法环境。</p>
<blockquote>
<p>✅ 简单说：<strong><code>outer</code> 指针决定了作用域查找路径，即“作用域链”</strong></p>
</blockquote>
<p>我们来看第一个例子（1.js）：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">bar</span>(<span class="hljs-params"/>){
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(myName)
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">foo</span>(<span class="hljs-params"/>){
  <span class="hljs-keyword">var</span> myName = <span class="hljs-string">'极客邦'</span>
  <span class="hljs-title function_">bar</span>()
}

<span class="hljs-keyword">var</span> myName = <span class="hljs-string">'极客时间'</span>
<span class="hljs-title function_">foo</span>() <span class="hljs-comment">// 输出: 极客时间</span>
</code></pre>
<h3 data-id="heading-1">🤔 为什么输出的是 “极客时间” 而不是 “极客邦”？</h3>
<p>很多人会误以为：<code>bar()</code> 是在 <code>foo()</code> 内部调用的，那它应该能访问到 <code>foo()</code> 里的 <code>myName</code>。但实际上，<strong><code>bar()</code> 是在全局定义的</strong>，所以它的 <code>outer</code> 指向的是全局的词法环境。</p>
<p>当 <code>bar()</code> 执行时，它先在自己的词法环境中找 <code>myName</code>，没有；然后顺着 <code>outer</code> 指针去全局词法环境查找，找到了 <code>var myName = '极客时间'</code>，于是打印出来。</p>
<p>👉 <strong>结论</strong>：作用域是由函数定义的位置决定的，而不是调用位置。这就是 <strong>词法作用域</strong> 的核心思想。</p>
<hr/>
<h2 data-id="heading-2">二、作用域链：查找变量的“路径”</h2>
<p>作用域链就是由一个个执行上下文的 <code>outer</code> 指针串联而成的链条。我们可以通过以下代码进一步理解（2.js）：</p>
<pre><code class="hljs language-ini" lang="ini">function bar(){
  var <span class="hljs-attr">myName</span> = <span class="hljs-string">'极客世界'</span>
  let <span class="hljs-attr">test1</span> = <span class="hljs-number">100</span>
  if(1){
    let <span class="hljs-attr">myName</span> = <span class="hljs-string">'Chrome 浏览器'</span>
    console.log(test) // ❌ 报错：test is not defined
  }
}

function foo(){
  var <span class="hljs-attr">myName</span> = <span class="hljs-string">'极客邦'</span>
  let <span class="hljs-attr">test</span> = <span class="hljs-number">2</span>
  {
    let <span class="hljs-attr">test</span> = <span class="hljs-number">3</span>
    bar()
  }
}

var <span class="hljs-attr">myName</span> = <span class="hljs-string">'极客时间'</span>

let <span class="hljs-attr">myAge</span> = <span class="hljs-number">10</span>

let <span class="hljs-attr">test</span> = <span class="hljs-number">1</span>

foo()
</code></pre>
<p>这段代码中，<code>bar()</code> 函数内部试图打印 <code>test</code>，但它找不到。</p>
<h3 data-id="heading-3">🔍 查找过程如下：</h3>
<ol>
<li>在 <code>bar()</code> 的词法环境中找 <code>test</code> → 没有；</li>
<li>到 <code>bar()</code> 的 <code>outer</code> 指向的词法环境（全局）找 → 全局有 <code>let test = 1</code>，但注意！<code>bar()</code> 是在全局定义的，所以它只能访问全局的 <code>test</code>；</li>
<li>但是 <code>bar()</code> 执行时，<code>test</code> 被重新赋值了吗？<strong>没有</strong>，因为 <code>bar()</code> 并不在 <code>foo()</code> 内部定义，所以它不会继承 <code>foo()</code> 的作用域。</li>
</ol>
<p>因此，<code>console.log(test)</code> 实际上是在全局查找 <code>test</code>，结果是 <code>1</code>。</p>
<blockquote>
<p>⚠️ 注意：<code>bar()</code> 无法访问 <code>foo()</code> 中的 <code>test</code>，即使它是从 <code>foo()</code> 中调用的。这再次证明了：<strong>JS 是词法作用域，不是动态作用域</strong>。</p>
</blockquote>
<p>我们可以结合下面这张图来理解调用栈和作用域链的关系：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ac579f326349437b8ac9c13bac710378~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgb2h5ZWFo:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764902124&amp;x-signature=j5QFqJccMbzELegcl2WuF6rJ4KM%3D" alt="lQLPKHIJLY1ZLgPNAnrNBHawi45ov3eSr18JAvLiVN8GAA_1142_634.png" loading="lazy"/></p>
<ul>
<li><code>bar()</code> 的执行上下文在栈顶；</li>
<li>它的 <code>outer</code> 指向全局；</li>
<li>因此查找 <code>test</code> 时，直接跳到了全局词法环境。</li>
</ul>
<hr/>
<h2 data-id="heading-4">三、闭包：函数的“专属背包”</h2>
<p>接下来是最有意思的——<strong>闭包</strong>（Closure）。</p>
<p>闭包的本质是：<strong>一个函数能够访问并记住其外部函数的变量，即使外部函数已经执行完毕</strong>。</p>
<p>我们来看第三个例子（3.js）：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">foo</span>(<span class="hljs-params"/>){
  <span class="hljs-keyword">var</span> myName = <span class="hljs-string">'极客时间'</span>
  <span class="hljs-keyword">let</span> test1 = <span class="hljs-number">1</span>
  <span class="hljs-keyword">const</span> test2 = <span class="hljs-number">2</span>
  <span class="hljs-keyword">var</span> innerBar = {
    <span class="hljs-attr">getName</span>: <span class="hljs-keyword">function</span>(<span class="hljs-params"/>){
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(test1)
      <span class="hljs-keyword">return</span> myName
    },
    <span class="hljs-attr">setName</span>: <span class="hljs-keyword">function</span>(<span class="hljs-params">newName</span>){
      myName = newName
    }
  }
  <span class="hljs-keyword">return</span> innerBar
}

<span class="hljs-keyword">var</span> bar = <span class="hljs-title function_">foo</span>() <span class="hljs-comment">// foo 执行完毕，出栈</span>
<span class="hljs-comment">//它已经出栈了 那bar里面的变量应该回收吧?</span>
<span class="hljs-comment">//代码的执行证明 它不会回收</span>
<span class="hljs-comment">//foo函数确实是出栈了 但是getName/setName还需要foo()函数里面的变量 所以它会'打个包' (如果一个变量被引用的话 那么它们就不能顺利的进行垃圾回收)</span>
bar.<span class="hljs-title function_">setName</span>(<span class="hljs-string">'极客邦'</span>)
bar.<span class="hljs-title function_">getName</span>() <span class="hljs-comment">// 输出: 极客邦</span>
</code></pre>
<h3 data-id="heading-5">🤯 为什么 <code>foo()</code> 已经出栈了，还能修改和读取里面的变量？</h3>
<p>因为在 <code>foo()</code> 返回 <code>innerBar</code> 对象时，<code>getName</code> 和 <code>setName</code> 这两个方法都引用了 <code>foo()</code> 内部的变量 <code>myName</code> 和 <code>test1</code>。V8 引擎发现这些变量被“外部引用”了，就不会回收它们。</p>
<p>于是，<code>foo()</code> 的执行上下文虽然出栈了，但它的 <strong>词法环境被保留了下来</strong>，形成了一个“闭包”。</p>
<blockquote>
<p>💡 这个被保留下来的词法环境，就是闭包本身。而其中被引用的变量，叫做 <strong>自由变量</strong>。</p>
</blockquote>
<p>我们再看一张图：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6eaa0b6bc6a14e8db4b06e9f3f695dec~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgb2h5ZWFo:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764902124&amp;x-signature=zsoyuqBigqrslxBz1fmsXP2ysi0%3D" alt="536a315a83aa48b870d03dd921b6c02a.png" loading="lazy"/></p>
<ul>
<li><code>setName</code> 执行时，它的 <code>outer</code> 指向 <code>foo()</code> 的词法环境；</li>
<li>即使 <code>foo()</code> 已经执行结束，这个环境依然存在；</li>
<li>所以 <code>myName</code> 可以被修改为 <code>'极客邦'</code>；</li>
<li>后续调用 <code>getName()</code> 时，依然能拿到更新后的值。</li>
</ul>
<blockquote>
<p>✅ 闭包的形成条件：</p>
<ol>
<li>函数嵌套函数；</li>
<li>内部函数被返回或暴露到外部；</li>
<li>内部函数引用了外部函数的变量。</li>
</ol>
</blockquote>
<hr/>
<h2 data-id="heading-6">四、闭包的生命周期：什么时候释放？</h2>
<p>闭包并不会一直占用内存。只有当外部仍然持有对闭包函数的引用时，闭包才会被保留。</p>
<p>比如：</p>
<pre><code class="hljs language-ini" lang="ini">var <span class="hljs-attr">bar</span> = foo()
<span class="hljs-attr">bar</span> = null // 此时，bar 不再引用 innerBar，闭包可以被垃圾回收
</code></pre>
<p>一旦 <code>bar</code> 被置为 <code>null</code>，<code>getName</code> 和 <code>setName</code> 就不再被引用，V8 引擎就会回收 <code>foo()</code> 的词法环境，释放内存。</p>
<blockquote>
<p>🔒 闭包是一种“记忆”机制，但也会带来内存泄漏的风险。使用完后记得释放引用！</p>
</blockquote>
<hr/>
<h2 data-id="heading-7">五、总结：词法作用域 vs 动态作用域</h2>

























<table><thead><tr><th>特性</th><th>词法作用域（JavaScript）</th><th>动态作用域</th></tr></thead><tbody><tr><td>查找依据</td><td>函数定义的位置</td><td>函数调用的位置</td></tr><tr><td>是否依赖调用栈顺序</td><td>否</td><td>是</td></tr><tr><td>示例语言</td><td>JavaScript、Python、C++</td><td>Bash、一些脚本语言</td></tr></tbody></table>
<p>JavaScript 是典型的词法作用域语言，这意味着：</p>
<ul>
<li>函数的 <code>outer</code> 指针在编译阶段就确定；</li>
<li>不管你在哪调用，只要函数定义在全局，它的 <code>outer</code> 就指向全局；</li>
<li>闭包的存在正是基于这种静态作用域的特性。</li>
</ul>
<hr/>
<h2 data-id="heading-8">六、常见误区澄清</h2>
<h3 data-id="heading-9">❌ 误区一：“在哪个函数里调用，就查哪个函数的作用域”</h3>
<p>这是动态作用域的思维。JavaScript 不是这样工作的。</p>
<p>✅ 正确做法：看函数<strong>定义在哪</strong>，<code>outer</code> 指向哪里，就从哪里开始查。</p>
<h3 data-id="heading-10">❌ 误区二：“函数执行完，里面的变量就没了”</h3>
<p>不一定！如果函数返回了一个引用了内部变量的函数，那么这些变量会被保留，形成闭包。</p>
<h3 data-id="heading-11">❌ 误区三：“闭包就是匿名函数”</h3>
<p>不对。闭包是一种现象，不一定是匿名函数。只要满足条件，任何函数都可以形成闭包。</p>
<hr/>
<h2 data-id="heading-12">七、图解回顾</h2>
<p>我们再来快速回顾一下几张关键图：</p>
<h3 data-id="heading-13">图1：<code>bar()</code> 调用时的作用域链</h3>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/780942116c6e45f08f43f429c59ac1d0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgb2h5ZWFo:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764902124&amp;x-signature=dFDDA9fKhmHiA5CBvKIbnariWYU%3D" alt="lQLPKHIJLY1ZLgPNAnrNBHawi45ov3eSr18JAvLiVN8GAA_1142_634.png" loading="lazy"/></p>
<ul>
<li><code>bar()</code> 的 <code>outer</code> 指向全局；</li>
<li>查找 <code>test</code> 时，从全局找到 <code>test = 1</code>。</li>
</ul>
<h3 data-id="heading-14">图2：<code>foo()</code> 执行时的执行上下文</h3>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/da2492f4a9984d509e7868b2d7cc1794~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgb2h5ZWFo:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764902124&amp;x-signature=PdgKf4vtGaQ7%2FgrIAe0qdNkOMjc%3D" alt="d70143c661ed9c209cdc5991f27fcab9.png" loading="lazy"/></p>
<ul>
<li><code>foo()</code> 的词法环境包含 <code>test1</code>, <code>test2</code>；</li>
<li>变量环境包含 <code>myName</code>, <code>innerBar</code>。</li>
</ul>
<h3 data-id="heading-15">图3：闭包生效时的状态</h3>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/912692a924774641856e48141584dc07~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgb2h5ZWFo:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764902124&amp;x-signature=zOaeO1mSWMKqBXsrocM6qePzt4o%3D" alt="lQLPJwCC0KWlAbPNA03NBHawINj2y-qMdT0JAv8hJbJKAA_1142_845.png" loading="lazy"/></p>
<ul>
<li><code>setName</code> 执行时，<code>outer</code> 指向 <code>foo()</code> 的词法环境；</li>
<li>即使 <code>foo()</code> 已出栈，数据依然可访问。</li>
</ul>
<hr/>
<h2 data-id="heading-16">八、写在最后</h2>
<p>JavaScript 的作用域机制看似复杂，但只要抓住一个核心：<strong>词法作用域 + outer 指针 + 闭包</strong>，就能轻松应对大多数场景。</p>
<p>记住一句话：</p>
<blockquote>
<p><strong>函数的作用域由它定义的位置决定，而不是调用的位置。</strong></p>
</blockquote>
<p>当你看到一个函数在别处被调用时，不要慌，先问一句：“它是在哪定义的？” 然后顺着 <code>outer</code> 指针去找，一切就清晰了。</p>
<p>闭包虽然强大，但也需要谨慎使用，避免不必要的内存占用。</p>
<p>希望这篇文章能帮你理清思路，下次遇到作用域问题时，不再迷茫！</p>
<hr/>
<p>📌 <strong>附注</strong>：本文所用代码和图解均来自个人学习笔记，图片仅为示意，实际运行时请自行验证逻辑。欢迎在评论区交流你的理解！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[2025 年最新 Fabric.js 实战：一个完整可上线的图片选区标注组件（含全部源码）.]]></title>    <link>https://juejin.cn/post/7577256255083659273</link>    <guid>https://juejin.cn/post/7577256255083659273</guid>    <pubDate>2025-11-28T02:34:15.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577256255083659273" data-draft-id="7577313637950504969" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="2025 年最新 Fabric.js 实战：一个完整可上线的图片选区标注组件（含全部源码）."/> <meta itemprop="keywords" content="前端,Vue.js"/> <meta itemprop="datePublished" content="2025-11-28T02:34:15.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="小章鱼学前端"/> <meta itemprop="url" content="https://juejin.cn/user/2588705981734765"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            2025 年最新 Fabric.js 实战：一个完整可上线的图片选区标注组件（含全部源码）.
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2588705981734765/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    小章鱼学前端
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-28T02:34:15.000Z" title="Fri Nov 28 2025 02:34:15 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-28
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d08a5e5789e84471add9938048f42e03~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP56ug6bG85a2m5YmN56uv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764902190&amp;x-signature=Dl%2FkLNt2MHTiPLOZ8fqNkzYfZ2U%3D" alt="" loading="lazy"/></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 从 0 到 1 用最新 Fabric.js 实现：背景图 + 手动画矩形 + 坐标 + 删除 + 高清截图导出（2025 最新版）</span>
</code></pre>
<p>最近项目要做一个「图片自动化清洗工具」，核心需求如下（产品甩给我的原话）：</p>
<ol>
<li>支持上传任意尺寸的广告图</li>
<li>运营要在图上框出需要保留的区域（可画多个矩形）</li>
<li>框出来的区域右上角必须有 × 可以删除</li>
<li>实时显示鼠标在原图上的精确坐标</li>
<li>最后要能把每个选区裁成独立图片 + 导出坐标数据给后端</li>
<li>必须有一键清空功能</li>
</ol>
<p><code>我调研了 Konva、PixiJS、ZRender，最终还是选择了最成熟、最好用的 **Fabric.js**，并且使用最新版 v6.7.1+ 完美实现！</code></p>
<p>本文所有代码基于 <strong>Fabric.js 6.7+</strong>，完全适配 Vue3/React/原生JS，已在生产环境稳定运行。</p>
<h2 data-id="heading-0">一、Fabric.js 官网 &amp; 安装方式（2025 最新）</h2>
<ul>
<li>
<p>官网：<a href="https://link.juejin.cn?target=http%3A%2F%2Ffabricjs.com" target="_blank" title="http://fabricjs.com" ref="nofollow noopener noreferrer">fabricjs.com</a></p>
</li>
<li>
<p>GitHub：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Ffabricjs%2Ffabric.js" target="_blank" title="https://github.com/fabricjs/fabric.js" ref="nofollow noopener noreferrer">github.com/fabricjs/fa…</a></p>
</li>
<li>
<p>当前最新版本：<strong>6.7.x</strong>（2025年11月）</p>
</li>
</ul>
<h2 data-id="heading-1">二、bash</h2>
<pre><code class="hljs language-css" lang="css">npm install fabric<span class="hljs-keyword">@latest</span>
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c48db06a01eb43fcb59ba3e2d199e038~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP56ug6bG85a2m5YmN56uv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764902190&amp;x-signature=E7wmeyGyC55uaIiEGk2Pj%2BcU%2FCs%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-2">三、创建画布 &amp; 初始化 CanvasManager 类</h2>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">canvas</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">"canvasEl"</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"canvas"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">canvas</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>
</code></pre>

<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// CanvasManager.js</span>
<span class="hljs-keyword">import</span> { Canvas, FabricImage, Rect, Control } from <span class="hljs-string">"fabric"</span>;

export <span class="hljs-keyword">class</span> <span class="hljs-title class_">CanvasManager</span> {
  <span class="hljs-keyword">constructor</span>(canvasEl, options = {}) {
    <span class="hljs-keyword">this</span>.canvas = new Canvas(canvasEl, {
      width: canvasEl.clientWidth || <span class="hljs-number">1000</span>,
      height: canvasEl.clientHeight ||  || <span class="hljs-number">700</span>,
      backgroundColor: <span class="hljs-string">"#f5f5f5"</span>,
      selection: <span class="hljs-literal">false</span>,           <span class="hljs-comment">// 全局禁止多选框（我们自己控制选中态）</span>
      preserveObjectStacking: <span class="hljs-literal">true</span>,
    });

    <span class="hljs-comment">// 回调函数，用于通知外部（如 Pinia/Vuex）矩形增删改</span>
    <span class="hljs-keyword">this</span>.onRectangleAdded   = options.onRectangleAdded;
    <span class="hljs-keyword">this</span>.onRectangleUpdated  = options.onRectangleUpdated;
    <span class="hljs-keyword">this</span>.onRectangleDeleted  = options.onRectangleDeleted;

    <span class="hljs-keyword">this</span>.isDrawing = <span class="hljs-literal">false</span>;
    <span class="hljs-keyword">this</span>.startX = <span class="hljs-keyword">this</span>.startY = <span class="hljs-number">0</span>;
    <span class="hljs-keyword">this</span>.currentRect = <span class="hljs-literal">null</span>;
    <span class="hljs-keyword">this</span>.rectangles = [];         <span class="hljs-comment">// 所有已完成的矩形</span>
    <span class="hljs-keyword">this</span>.originalImageWidth = <span class="hljs-keyword">this</span>.originalImageHeight = <span class="hljs-number">0</span>;

    <span class="hljs-keyword">this</span>.initEvents();
  }

  initEvents() {
    <span class="hljs-keyword">this</span>.canvas.on(<span class="hljs-string">"mouse:down"</span>, <span class="hljs-keyword">this</span>.handleMouseDown.bind(<span class="hljs-keyword">this</span>));
    <span class="hljs-keyword">this</span>.canvas.on(<span class="hljs-string">"mouse:move"</span>, <span class="hljs-keyword">this</span>.handleMouseMove.bind(<span class="hljs-keyword">this</span>));
    <span class="hljs-keyword">this</span>.canvas.on(<span class="hljs-string">"mouse:up"</span>,   <span class="hljs-keyword">this</span>.handleMouseUp.bind(<span class="hljs-keyword">this</span>));
  }
}
</code></pre>
<h2 data-id="heading-3">四、上传背景图 + 完美适配画布（支持 5000×5000 大图不卡）</h2>
<blockquote>
<p>FabricImage 设置canvas画布背景</p>
</blockquote>
<pre><code class="hljs language-xml" lang="xml">
<span class="hljs-comment">&lt;!-- 上传按钮（Ant Design Vue） --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">input</span>
  <span class="hljs-attr">type</span>=<span class="hljs-string">"file"</span>
  <span class="hljs-attr">ref</span>=<span class="hljs-string">"fileInput"</span>
  @<span class="hljs-attr">change</span>=<span class="hljs-string">"handleFileUpload"</span>
  <span class="hljs-attr">accept</span>=<span class="hljs-string">"image/*"</span>
  <span class="hljs-attr">style</span>=<span class="hljs-string">"display: none"</span>
/&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">a-button</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"primary"</span> @<span class="hljs-attr">click</span>=<span class="hljs-string">"$refs.fileInput.click()"</span>&gt;</span>
  上传图片
<span class="hljs-tag">&lt;/<span class="hljs-name">a-button</span>&gt;</span>
      
     
</code></pre>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-comment">// 设置背景图（核心方法）</span>
<span class="hljs-function">async <span class="hljs-title">setBackground</span><span class="hljs-params">(source)</span> </span>{
  <span class="hljs-keyword">try</span> {
    <span class="hljs-type">const</span> img = await FabricImage.<span class="hljs-built_in">fromURL</span>(source, { crossOrigin: <span class="hljs-string">"anonymous"</span> });

    <span class="hljs-comment">// 保存原始尺寸（后面导出坐标要用）</span>
    <span class="hljs-keyword">this</span>.originalImageWidth  = img.width;
    <span class="hljs-keyword">this</span>.originalImageHeight = img.height;

    <span class="hljs-comment">// 等比缩放至画布宽度（也可改成 scaleToHeight）</span>
    img.<span class="hljs-built_in">scaleToWidth</span>(<span class="hljs-keyword">this</span>.canvas.<span class="hljs-built_in">getWidth</span>());

    <span class="hljs-keyword">this</span>.canvas.<span class="hljs-built_in">setBackgroundImage</span>(img, () =&gt; {
      <span class="hljs-keyword">this</span>.canvas.<span class="hljs-built_in">requestRenderAll</span>();
    });

    <span class="hljs-keyword">return</span> {
      originalSize: { width: img.width, height: img.height },
      scaledSize: { width: img.<span class="hljs-built_in">getScaledWidth</span>(), height: img.<span class="hljs-built_in">getScaledHeight</span>() },
      scaleX: img.scaleX,
      scaleY: img.scaleY,
    };
  } <span class="hljs-built_in">catch</span> (err) {
    console.<span class="hljs-built_in">error</span>(<span class="hljs-string">"背景图加载失败"</span>, err);
    <span class="hljs-keyword">throw</span> err;
  }
}
</code></pre>
<h2 data-id="heading-4">五、手动画矩形 + 右上角删除按钮（最丝滑写法）</h2>
<blockquote>
<p>在图片标注类工具中，“按住鼠标拖拽绘制矩形选区 + 右上角一键删除”是核心交互体验。本方案基于 Fabric.js v6.7+ 官方推荐的事件机制与自定义 Control 体系，实现了一套<strong>高可维护性、视觉统</strong></p>
</blockquote>
<h5 data-id="heading-5">绘制矩形区域</h5>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 开始绘制矩形选区（鼠标按下时触发）</span>
startDrawing(opt) {
  <span class="hljs-comment">// 获取当前鼠标在画布上的精确坐标（已自动处理缩放、平移、滚动偏移）</span>
  <span class="hljs-comment">// getPointer 是 Fabric.js 官方推荐方法，比 e.layerX/e.offsetX 更准确</span>
  <span class="hljs-keyword">const</span> pointer = <span class="hljs-keyword">this</span>.canvas.getPointer(opt.e);

  <span class="hljs-keyword">this</span>.startX = pointer.x;<span class="hljs-comment">// 记录矩形起始点的 X 坐标（左上角）</span>
  <span class="hljs-keyword">this</span>.startY = pointer.y;<span class="hljs-comment">// 记录矩形起始点的 Y 坐标（左上角）</span>

  <span class="hljs-comment">// 标记当前处于“正在绘制”状态，后续 mouse:move 和 mouse:up 会用到</span>
  <span class="hljs-keyword">this</span>.isDrawing = <span class="hljs-literal">true</span>;

  <span class="hljs-comment">// 创建一个新的 Fabric Rect 实例，作为当前正在绘制的矩形</span>
  <span class="hljs-keyword">this</span>.currentRect = new Rect({
    left: <span class="hljs-keyword">this</span>.startX,<span class="hljs-comment">// 矩形左上角 X 坐标（起始点）</span>
    top: <span class="hljs-keyword">this</span>.startY,<span class="hljs-comment">// 矩形左上角 Y 坐标（起始点）</span>
    width: <span class="hljs-number">0</span>, <span class="hljs-comment">// 初始宽高为 0，后续拖拽时动态更新</span>
    height: <span class="hljs-number">0</span>,
    fill: <span class="hljs-string">"rgba(255,0,0,0.3)"</span>, <span class="hljs-comment">// 半透明红色填充，便于区分选区</span>
    stroke: <span class="hljs-string">"red"</span>,<span class="hljs-comment">// 边框颜色</span>
    strokeWidth: <span class="hljs-number">2</span>,<span class="hljs-comment">// 边框粗细</span>
    selectable: <span class="hljs-literal">true</span>, <span class="hljs-comment">// 允许被选中和拖拽移动</span>
    hasControls: <span class="hljs-literal">true</span>,<span class="hljs-comment">// 显示八个控制点（调整大小用）</span>
    hasRotatingPoint: <span class="hljs-literal">false</span>,  <span class="hljs-comment">// 禁止旋转手柄（我们不需要旋转）</span>
    cornerColor: <span class="hljs-string">"red"</span>,  <span class="hljs-comment">// 控制点角（调整大小时的八个小方块）颜色设为红色，与主题保持一致</span>
    transparentCorners: <span class="hljs-literal">false</span>, <span class="hljs-comment">// 控制点不透明（默认是半透明的，这里改成实心）</span>
    cornerStyle: <span class="hljs-string">"circle"</span>,<span class="hljs-comment">// 控制点形状为圆形（比默认矩形更好看）</span>
    cornerSize: <span class="hljs-number">12</span>,<span class="hljs-comment">// 控制点大小（像素）</span>
    strokeDashArray: [<span class="hljs-number">5</span>, <span class="hljs-number">5</span>],<span class="hljs-comment">// 边框虚线样式 [实线长度, 间隔长度]</span>
  });

  <span class="hljs-comment">// 创建右上角的“× 删除”自定义控制点（自定义控制点是 Fabric.js 高阶用法）</span>
  <span class="hljs-keyword">const</span> deleteControl = <span class="hljs-keyword">this</span>.createDeleteControl();

  <span class="hljs-comment">// 把自定义删除按钮挂载到当前矩形的 controls 上，键名可以自定义</span>
  <span class="hljs-comment">// 之后可以通过 rect.setControlVisible('deleteBtn', false) 控制显隐</span>
  <span class="hljs-keyword">this</span>.currentRect.controls.deleteBtn = deleteControl;

  <span class="hljs-comment">// 隐藏默认的旋转控制点（mtr = middle top rotate）</span>
  <span class="hljs-comment">// 我们已经禁用了旋转，这里再保险隐藏一下</span>
  <span class="hljs-keyword">this</span>.currentRect.setControlVisible(<span class="hljs-string">"mtr"</span>, <span class="hljs-literal">false</span>);

  <span class="hljs-comment">// 立即把矩形添加到画布（此时宽高为0，看不到，但必须先加进去才能实时更新）</span>
  <span class="hljs-keyword">this</span>.canvas.add(<span class="hljs-keyword">this</span>.currentRect);

  <span class="hljs-comment">// 触发重绘，确保即使宽高为0也能看到光标变化</span>
  <span class="hljs-keyword">this</span>.canvas.requestRenderAll();
},
</code></pre>
<p><strong>一、体验丝滑</strong>的绘制能力。</p>
<p>核心交互流程严格遵循经典三阶段模型：</p>
<ol>
<li>
<p><strong>mouse:down</strong> → 开启绘制模式</p>
<ol>
<li>调用 canvas.getPointer(e) 获取相对于画布的精准坐标（自动补偿缩放、平移、视口滚动）</li>
<li>初始化 isDrawing = true 状态标志</li>
<li>创建临时 fabric.Rect 实例（初始宽高为 0）并立即加入画布，确保后续 move 事件可实时更新</li>
</ol>
</li>
<li>
<p><strong>mouse:move</strong> → 实时更新矩形尺寸与位置</p>
<ol>
<li>动态计算宽度/高度取绝对值，支持四个方向拖拽</li>
<li>动态调整 left/top 为较小值，保证矩形左上角始终为起始点</li>
<li>每帧调用 canvas.requestRenderAll() 实现流畅预览</li>
</ol>
</li>
<li>
<p><strong>mouse:up</strong> → 绘制完成 &amp; 防御性收尾</p>
<ol>
<li>自动过滤误触（宽或高 &lt; 10px 的矩形直接丢弃）</li>
<li>为有效矩形添加自定义删除控件（controls.deleteBtn）</li>
<li>将矩形实例推入管理数组，便于后续批量操作与数据同步</li>
<li>触发外部回调 onRectangleAdded，实现与 Pinia/Vuex/React 状态的完美解耦</li>
</ol>
</li>
</ol>
<h5 data-id="heading-6">鼠标事件</h5>
<pre><code class="hljs language-kotlin" lang="kotlin"> <span class="hljs-comment">// 鼠标按下事件</span>
  handleMouseDown(opt) {
    <span class="hljs-keyword">if</span> (opt.target) {
      <span class="hljs-keyword">return</span>; <span class="hljs-comment">// 点击了已有对象，进入编辑模式</span>
    }
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.isDrawing) <span class="hljs-keyword">return</span>;

    <span class="hljs-keyword">this</span>.startDrawing(opt);
  }
   <span class="hljs-comment">// 鼠标移动事件</span>
  handleMouseMove(opt) {
    <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.isDrawing || !<span class="hljs-keyword">this</span>.currentRect) <span class="hljs-keyword">return</span>;

    <span class="hljs-keyword">const</span> pointer = <span class="hljs-keyword">this</span>.canvas.getPointer(opt.e);
    <span class="hljs-keyword">const</span> w = Math.abs(pointer.x - <span class="hljs-keyword">this</span>.startX);
    <span class="hljs-keyword">const</span> h = Math.abs(pointer.y - <span class="hljs-keyword">this</span>.startY);

    <span class="hljs-keyword">this</span>.currentRect.<span class="hljs-keyword">set</span>({
      width: w,
      height: h,
      left: Math.min(pointer.x, <span class="hljs-keyword">this</span>.startX),
      top: Math.min(pointer.y, <span class="hljs-keyword">this</span>.startY),
    });

    <span class="hljs-keyword">this</span>.canvas.requestRenderAll();
  }

  <span class="hljs-comment">// 鼠标松开事件</span>
  handleMouseUp() {
    <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.isDrawing || !<span class="hljs-keyword">this</span>.currentRect) <span class="hljs-keyword">return</span>;
    <span class="hljs-keyword">this</span>.isDrawing = <span class="hljs-literal">false</span>;

    <span class="hljs-comment">// 检查矩形尺寸，太小则删除</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.currentRect.width &lt; <span class="hljs-number">5</span> || <span class="hljs-keyword">this</span>.currentRect.height &lt; <span class="hljs-number">5</span>) {
      <span class="hljs-keyword">this</span>.canvas.remove(<span class="hljs-keyword">this</span>.currentRect);
      <span class="hljs-keyword">this</span>.currentRect = <span class="hljs-literal">null</span>;
      <span class="hljs-keyword">this</span>.canvas.requestRenderAll();
      <span class="hljs-keyword">return</span>;
    }

    <span class="hljs-keyword">this</span>.finalizeRectangle();
  }
</code></pre>
<h5 data-id="heading-7">自定义删除控件（Custom Control）实现亮点</h5>
<ul>
<li>位置锚点：x: 0.5, y: -0.5 + offsetX/Y 微调，精准定位在矩形右上角</li>
<li>视觉风格：红色圆形底 + 白色粗体 ×，与 Ant Design/ProComponents 设计语言完全一致</li>
<li>交互体验：cornerSize: 28 扩大点击区域，老年模式也能轻松点中</li>
<li>性能优化：仅使用 Canvas 2D 绘制，无额外 DOM 元素，无内存泄漏</li>
<li>事件隔离：mouseUpHandler 内部直接 canvas.remove(target) 并通知外部删除回调</li>
</ul>
<blockquote>
<p>Control就是可以设置图形的点。</p>
</blockquote>
<pre><code class="hljs language-kotlin" lang="kotlin">createDeleteControl() {
  <span class="hljs-comment">/**
   * 创建 Fabric.js 自定义删除控件
   * 该控件会出现在选中对象的右上角（可通过 x/y 调整位置）
   */</span>
  <span class="hljs-keyword">return</span> new Control({
    x: <span class="hljs-number">0.5</span>,                 <span class="hljs-comment">// 水平锚点：0.5 表示对象右边缘</span>
    y: -<span class="hljs-number">0.5</span>,                <span class="hljs-comment">// 垂直锚点：-0.5 表示对象上边缘</span>
    offsetX: <span class="hljs-number">10</span>,            <span class="hljs-comment">// 水平偏移量（向右偏移 10px）</span>
    offsetY: -<span class="hljs-number">10</span>,           <span class="hljs-comment">// 垂直偏移量（向上偏移 10px）</span>
    cursorStyle: <span class="hljs-string">"pointer"</span>, <span class="hljs-comment">// 鼠标悬停时显示手型光标</span>
    cornerSize: <span class="hljs-number">24</span>,         <span class="hljs-comment">// 可点击区域大小（24×24px）</span>
    
    <span class="hljs-comment">// 自定义绘制删除图标（× 或垃圾桶图标）</span>
    render: <span class="hljs-keyword">this</span>.renderDeleteIcon.bind(<span class="hljs-keyword">this</span>),
    
    <span class="hljs-comment">// 点击删除按钮后执行的回调</span>
    mouseUpHandler: <span class="hljs-keyword">this</span>.deleteHandler.bind(<span class="hljs-keyword">this</span>),
  });
}

简单的删除操作就是在画布中remove（对应的矩形） requestRenderAll重新渲染
</code></pre>
<h2 data-id="heading-8">六、清空所有选取</h2>
<blockquote>
<p>清空操作就是获取所有的矩形实例然后给remove ，重新渲染requestRenderAll。</p>
</blockquote>
<h2 data-id="heading-9">七、完整代码</h2>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">import</span> { Canvas, FabricImage, Rect, Control } from <span class="hljs-string">"fabric"</span>;

export <span class="hljs-keyword">class</span> <span class="hljs-title class_">CanvasManager</span> {
  <span class="hljs-comment">// 创建初始画布</span>
  <span class="hljs-keyword">constructor</span>(canvasEl, options = {}) {
    <span class="hljs-comment">// 保存回调函数</span>
    <span class="hljs-keyword">this</span>.onRectangleAdded = options.onRectangleAdded;
    <span class="hljs-keyword">this</span>.onRectangleUpdated = options.onRectangleUpdated;
    <span class="hljs-keyword">this</span>.onRectangleDeleted = options.onRectangleDeleted;

    <span class="hljs-keyword">this</span>.canvas = new Canvas(canvasEl, {
      width: canvasEl.clientWidth || <span class="hljs-number">800</span>,
      height: canvasEl.clientHeight || <span class="hljs-number">600</span>,
      backgroundColor: <span class="hljs-string">"#f0f0f0"</span>,
      selection: <span class="hljs-literal">false</span>,
    });

    <span class="hljs-keyword">this</span>.isDrawing = <span class="hljs-literal">false</span>;
    <span class="hljs-keyword">this</span>.startX = <span class="hljs-number">0</span>;
    <span class="hljs-keyword">this</span>.startY = <span class="hljs-number">0</span>;
    <span class="hljs-keyword">this</span>.currentRect = <span class="hljs-literal">null</span>;
    <span class="hljs-keyword">this</span>.deleteIconImg = <span class="hljs-literal">null</span>;
    <span class="hljs-keyword">this</span>.rectangles = [];

    <span class="hljs-keyword">this</span>.initEvents();
  }

  <span class="hljs-comment">// 设置背景图片</span>
  async setBackground(imageUrl) {
    <span class="hljs-keyword">try</span> {
      <span class="hljs-comment">// 保存图片URL/路径</span>
      <span class="hljs-keyword">this</span>.imageUrl =
        typeof imageUrl === <span class="hljs-string">"string"</span>
          ? imageUrl
          : imageUrl?.default || imageUrl?.src || imageUrl;

      <span class="hljs-keyword">const</span> img = await FabricImage.fromURL(<span class="hljs-keyword">this</span>.imageUrl);

      <span class="hljs-comment">// 保存原始图片尺寸</span>
      <span class="hljs-keyword">this</span>.originalImageWidth = img.width;
      <span class="hljs-keyword">this</span>.originalImageHeight = img.height;

      <span class="hljs-comment">// 缩放图片以适应画布宽度</span>
      img.scaleToWidth(<span class="hljs-keyword">this</span>.canvas.getWidth());

      <span class="hljs-comment">// 保存缩放后的尺寸（实际显示尺寸）</span>
      <span class="hljs-keyword">this</span>.scaledImageWidth = img.width * (img.scaleX || <span class="hljs-number">1</span>);
      <span class="hljs-keyword">this</span>.scaledImageHeight = img.height * (img.scaleY || <span class="hljs-number">1</span>);

      <span class="hljs-keyword">this</span>.canvas.backgroundImage = img;
      <span class="hljs-keyword">this</span>.canvas.requestRenderAll();

      <span class="hljs-keyword">return</span> {
        image: img,
        imageUrl: <span class="hljs-keyword">this</span>.imageUrl, <span class="hljs-comment">// 返回图片路径</span>
        originalSize: {
          width: <span class="hljs-keyword">this</span>.originalImageWidth,
          height: <span class="hljs-keyword">this</span>.originalImageHeight,
        },
        scaledSize: {
          width: <span class="hljs-keyword">this</span>.scaledImageWidth,
          height: <span class="hljs-keyword">this</span>.scaledImageHeight,
        },
        scaleX: img.scaleX,
        scaleY: img.scaleY,
      };
    } <span class="hljs-keyword">catch</span> (error) {
      console.error(<span class="hljs-string">"背景加载失败："</span>, error);
      <span class="hljs-keyword">throw</span> error;
    }
  }

  <span class="hljs-comment">// 获取图片URL/路径</span>
  getImageUrl() {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.imageUrl || <span class="hljs-literal">null</span>;
  }

  <span class="hljs-comment">// 获取图片尺寸信息</span>
  getImageSize() {
    <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.canvas.backgroundImage) {
      <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
    }

    <span class="hljs-keyword">return</span> {
      original: {
        width: <span class="hljs-keyword">this</span>.originalImageWidth || <span class="hljs-number">0</span>,
        height: <span class="hljs-keyword">this</span>.originalImageHeight || <span class="hljs-number">0</span>,
      },
      scaled: {
        width: <span class="hljs-keyword">this</span>.scaledImageWidth || <span class="hljs-number">0</span>,
        height: <span class="hljs-keyword">this</span>.scaledImageHeight || <span class="hljs-number">0</span>,
      },
      scaleX: <span class="hljs-keyword">this</span>.canvas.backgroundImage.scaleX || <span class="hljs-number">1</span>,
      scaleY: <span class="hljs-keyword">this</span>.canvas.backgroundImage.scaleY || <span class="hljs-number">1</span>,
    };
  }

  <span class="hljs-comment">// 加载删除图标</span>
  async loadDeleteIcon(iconUrl) {
    <span class="hljs-keyword">return</span> new Promise((resolve) =&gt; {
      <span class="hljs-keyword">const</span> img = new Image();
      img.src = iconUrl;
      img.onload = () =&gt; {
        <span class="hljs-keyword">this</span>.deleteIconImg = img;
        resolve(img);
      };
      img.onerror = () =&gt; {
        console.warn(<span class="hljs-string">"删除图标加载失败，使用默认样式"</span>);
        resolve(<span class="hljs-literal">null</span>);
      };
    });
  }

  <span class="hljs-comment">// 初始化事件</span>
  initEvents() {
    <span class="hljs-keyword">this</span>.canvas.on(<span class="hljs-string">"mouse:down"</span>, <span class="hljs-keyword">this</span>.handleMouseDown.bind(<span class="hljs-keyword">this</span>));
    <span class="hljs-keyword">this</span>.canvas.on(<span class="hljs-string">"mouse:move"</span>, <span class="hljs-keyword">this</span>.handleMouseMove.bind(<span class="hljs-keyword">this</span>));
    <span class="hljs-keyword">this</span>.canvas.on(<span class="hljs-string">"mouse:up"</span>, <span class="hljs-keyword">this</span>.handleMouseUp.bind(<span class="hljs-keyword">this</span>));
    <span class="hljs-keyword">this</span>.canvas.on(<span class="hljs-string">"selection:created"</span>, <span class="hljs-keyword">this</span>.handleSelectionCreated.bind(<span class="hljs-keyword">this</span>));
  }

  <span class="hljs-comment">// 鼠标按下事件</span>
  handleMouseDown(opt) {
    <span class="hljs-keyword">if</span> (opt.target) {
      <span class="hljs-keyword">return</span>; <span class="hljs-comment">// 点击了已有对象，进入编辑模式</span>
    }
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.isDrawing) <span class="hljs-keyword">return</span>;

    <span class="hljs-keyword">this</span>.startDrawing(opt);
  }

  <span class="hljs-comment">// 开始绘制</span>
  startDrawing(opt) {
    <span class="hljs-keyword">const</span> pointer = <span class="hljs-keyword">this</span>.canvas.getPointer(opt.e);
    <span class="hljs-keyword">this</span>.startX = pointer.x;
    <span class="hljs-keyword">this</span>.startY = pointer.y;
    <span class="hljs-keyword">this</span>.isDrawing = <span class="hljs-literal">true</span>;

    <span class="hljs-keyword">this</span>.currentRect = new Rect({
      left: <span class="hljs-keyword">this</span>.startX,
      top: <span class="hljs-keyword">this</span>.startY,
      width: <span class="hljs-number">0</span>,
      height: <span class="hljs-number">0</span>,
      fill: <span class="hljs-string">"rgba(255,0,0,0.3)"</span>,
      stroke: <span class="hljs-string">"red"</span>,
      strokeWidth: <span class="hljs-number">2</span>,
      selectable: <span class="hljs-literal">true</span>,
      hasControls: <span class="hljs-literal">true</span>,
      hasRotatingPoint: <span class="hljs-literal">false</span>,
      cornerColor: <span class="hljs-string">"red"</span>,
      transparentCorners: <span class="hljs-literal">false</span>,
      cornerStyle: <span class="hljs-string">"circle"</span>,
      cornerSize: <span class="hljs-number">12</span>,
      strokeDashArray: [<span class="hljs-number">5</span>, <span class="hljs-number">5</span>],
    });

    <span class="hljs-comment">// 添加删除控制点</span>
    <span class="hljs-keyword">const</span> deleteControl = <span class="hljs-keyword">this</span>.createDeleteControl();
    <span class="hljs-keyword">this</span>.currentRect.controls.deleteBtn = deleteControl;
    <span class="hljs-keyword">this</span>.currentRect.setControlVisible(<span class="hljs-string">"mtr"</span>, <span class="hljs-literal">false</span>);

    <span class="hljs-keyword">this</span>.canvas.add(<span class="hljs-keyword">this</span>.currentRect);
    <span class="hljs-keyword">this</span>.canvas.requestRenderAll();
  }

  <span class="hljs-comment">// 创建删除控制点</span>
  createDeleteControl() {
    <span class="hljs-keyword">return</span> new Control({
      x: <span class="hljs-number">0.5</span>,
      y: -<span class="hljs-number">0.5</span>,
      offsetX: <span class="hljs-number">10</span>,
      offsetY: -<span class="hljs-number">10</span>,
      cursorStyle: <span class="hljs-string">"pointer"</span>,
      cornerSize: <span class="hljs-number">24</span>,
      render: <span class="hljs-keyword">this</span>.renderDeleteIcon.bind(<span class="hljs-keyword">this</span>),
      mouseUpHandler: <span class="hljs-keyword">this</span>.deleteHandler.bind(<span class="hljs-keyword">this</span>),
    });
  }

  <span class="hljs-comment">// 鼠标移动事件</span>
  handleMouseMove(opt) {
    <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.isDrawing || !<span class="hljs-keyword">this</span>.currentRect) <span class="hljs-keyword">return</span>;

    <span class="hljs-keyword">const</span> pointer = <span class="hljs-keyword">this</span>.canvas.getPointer(opt.e);
    <span class="hljs-keyword">const</span> w = Math.abs(pointer.x - <span class="hljs-keyword">this</span>.startX);
    <span class="hljs-keyword">const</span> h = Math.abs(pointer.y - <span class="hljs-keyword">this</span>.startY);

    <span class="hljs-keyword">this</span>.currentRect.<span class="hljs-keyword">set</span>({
      width: w,
      height: h,
      left: Math.min(pointer.x, <span class="hljs-keyword">this</span>.startX),
      top: Math.min(pointer.y, <span class="hljs-keyword">this</span>.startY),
    });

    <span class="hljs-keyword">this</span>.canvas.requestRenderAll();
  }

  <span class="hljs-comment">// 鼠标松开事件</span>
  handleMouseUp() {
    <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.isDrawing || !<span class="hljs-keyword">this</span>.currentRect) <span class="hljs-keyword">return</span>;
    <span class="hljs-keyword">this</span>.isDrawing = <span class="hljs-literal">false</span>;

    <span class="hljs-comment">// 检查矩形尺寸，太小则删除</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.currentRect.width &lt; <span class="hljs-number">5</span> || <span class="hljs-keyword">this</span>.currentRect.height &lt; <span class="hljs-number">5</span>) {
      <span class="hljs-keyword">this</span>.canvas.remove(<span class="hljs-keyword">this</span>.currentRect);
      <span class="hljs-keyword">this</span>.currentRect = <span class="hljs-literal">null</span>;
      <span class="hljs-keyword">this</span>.canvas.requestRenderAll();
      <span class="hljs-keyword">return</span>;
    }

    <span class="hljs-keyword">this</span>.finalizeRectangle();
  }

  <span class="hljs-comment">// CanvasManager.js</span>
  finalizeRectangle() {
    <span class="hljs-keyword">const</span> id = `rect_${Date.now()}_${Math.random().toString(<span class="hljs-number">36</span>).substr(<span class="hljs-number">2</span>, <span class="hljs-number">9</span>)}`;
    <span class="hljs-keyword">const</span> coords = <span class="hljs-keyword">this</span>.currentRect.getCoords();

    <span class="hljs-keyword">const</span> rectData = {
      id,
      fabricObject: <span class="hljs-keyword">this</span>.currentRect,
      coords: {
        tl: coords[<span class="hljs-number">0</span>],
        tr: coords[<span class="hljs-number">1</span>],
        br: coords[<span class="hljs-number">2</span>],
        bl: coords[<span class="hljs-number">3</span>],
      },
      left: <span class="hljs-keyword">this</span>.currentRect.left,
      top: <span class="hljs-keyword">this</span>.currentRect.top,
      width: <span class="hljs-keyword">this</span>.currentRect.width,
      height: <span class="hljs-keyword">this</span>.currentRect.height,
      angle: <span class="hljs-keyword">this</span>.currentRect.angle,
    };

    <span class="hljs-comment">// 保存到 rectangles 数组</span>
    <span class="hljs-keyword">this</span>.rectangles.push(rectData);

    <span class="hljs-comment">// 直接调用回调函数添加到 store</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.onRectangleAdded) {
      <span class="hljs-keyword">this</span>.onRectangleAdded(rectData);
    }

    <span class="hljs-keyword">this</span>.canvas.setActiveObject(<span class="hljs-keyword">this</span>.currentRect);

    <span class="hljs-comment">// 绑定实时更新事件</span>
    <span class="hljs-keyword">this</span>.currentRect.on(<span class="hljs-string">"moving"</span>, () =&gt; <span class="hljs-keyword">this</span>.updateRectCoords(rectData));
    <span class="hljs-keyword">this</span>.currentRect.on(<span class="hljs-string">"scaling"</span>, () =&gt; <span class="hljs-keyword">this</span>.updateRectCoords(rectData));
    <span class="hljs-keyword">this</span>.currentRect.on(<span class="hljs-string">"rotating"</span>, () =&gt; <span class="hljs-keyword">this</span>.updateRectCoords(rectData));

    <span class="hljs-keyword">this</span>.currentRect = <span class="hljs-literal">null</span>;
    <span class="hljs-keyword">this</span>.canvas.requestRenderAll();

    <span class="hljs-keyword">return</span> rectData;
  }

  <span class="hljs-comment">// 更新矩形坐标</span>
  updateRectCoords(rectData) {
    <span class="hljs-keyword">const</span> obj = rectData.fabricObject;
    <span class="hljs-keyword">const</span> coords = obj.getCoords();

    rectData.coords = {
      tl: {
        x: Number(coords[<span class="hljs-number">0</span>].x.toFixed(<span class="hljs-number">2</span>)),
        y: Number(coords[<span class="hljs-number">0</span>].y.toFixed(<span class="hljs-number">2</span>)),
      },
      tr: {
        x: Number(coords[<span class="hljs-number">1</span>].x.toFixed(<span class="hljs-number">2</span>)),
        y: Number(coords[<span class="hljs-number">1</span>].y.toFixed(<span class="hljs-number">2</span>)),
      },
      br: {
        x: Number(coords[<span class="hljs-number">2</span>].x.toFixed(<span class="hljs-number">2</span>)),
        y: Number(coords[<span class="hljs-number">2</span>].y.toFixed(<span class="hljs-number">2</span>)),
      },
      bl: {
        x: Number(coords[<span class="hljs-number">3</span>].x.toFixed(<span class="hljs-number">2</span>)),
        y: Number(coords[<span class="hljs-number">3</span>].y.toFixed(<span class="hljs-number">2</span>)),
      },
    };

    rectData.left = Number(obj.left.toFixed(<span class="hljs-number">2</span>));
    rectData.top = Number(obj.top.toFixed(<span class="hljs-number">2</span>));
    rectData.width = Number(obj.width.toFixed(<span class="hljs-number">2</span>));
    rectData.height = Number(obj.height.toFixed(<span class="hljs-number">2</span>));
    rectData.angle = Number(obj.angle.toFixed(<span class="hljs-number">2</span>));

    <span class="hljs-comment">// 通知更新</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.onRectangleUpdated) {
      <span class="hljs-keyword">this</span>.onRectangleUpdated(rectData);
    }
  }

  <span class="hljs-comment">// 选中事件</span>
  handleSelectionCreated(opt) {
    <span class="hljs-keyword">const</span> active = opt.target;
    <span class="hljs-keyword">const</span> <span class="hljs-keyword">data</span> = <span class="hljs-keyword">this</span>.rectangles.find((r) =&gt; r.fabricObject === active);
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">data</span>) <span class="hljs-keyword">this</span>.updateRectCoords(<span class="hljs-keyword">data</span>);
  }

  <span class="hljs-comment">// 删除处理</span>
  deleteHandler(eventData, transform) {
    <span class="hljs-keyword">const</span> target = transform.target;
    <span class="hljs-keyword">if</span> (!target) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;

    <span class="hljs-comment">// 找到要删除的矩形数据</span>
    <span class="hljs-keyword">const</span> rectData = <span class="hljs-keyword">this</span>.rectangles.find((r) =&gt; r.fabricObject === target);

    <span class="hljs-comment">// 从 rectangles 中移除</span>
    <span class="hljs-keyword">this</span>.rectangles = <span class="hljs-keyword">this</span>.rectangles.filter((r) =&gt; r.fabricObject !== target);

    <span class="hljs-comment">// 调用删除回调</span>
    <span class="hljs-keyword">if</span> (rectData &amp;&amp; <span class="hljs-keyword">this</span>.onRectangleDeleted) {
      <span class="hljs-keyword">this</span>.onRectangleDeleted(rectData.id);
    }

    <span class="hljs-keyword">this</span>.canvas.remove(target);
    <span class="hljs-keyword">this</span>.canvas.requestRenderAll();
    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
  }

  <span class="hljs-comment">// 渲染删除图标</span>
  renderDeleteIcon(ctx, left, top) {
    <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.deleteIconImg) {
      <span class="hljs-comment">// 降级样式</span>
      ctx.save();
      ctx.fillStyle = <span class="hljs-string">"red"</span>;
      ctx.beginPath();
      ctx.arc(left, top, <span class="hljs-number">12</span>, <span class="hljs-number">0</span>, Math.PI * <span class="hljs-number">2</span>);
      ctx.fill();
      ctx.strokeStyle = <span class="hljs-string">"white"</span>;
      ctx.lineWidth = <span class="hljs-number">2</span>;
      ctx.beginPath();
      ctx.moveTo(left - <span class="hljs-number">6</span>, top - <span class="hljs-number">6</span>);
      ctx.lineTo(left + <span class="hljs-number">6</span>, top + <span class="hljs-number">6</span>);
      ctx.moveTo(left + <span class="hljs-number">6</span>, top - <span class="hljs-number">6</span>);
      ctx.lineTo(left - <span class="hljs-number">6</span>, top + <span class="hljs-number">6</span>);
      ctx.stroke();
      ctx.restore();
      <span class="hljs-keyword">return</span>;
    }

    <span class="hljs-keyword">const</span> size = <span class="hljs-number">20</span>;
    ctx.drawImage(
      <span class="hljs-keyword">this</span>.deleteIconImg,
      left - size / <span class="hljs-number">2</span>,
      top - size / <span class="hljs-number">2</span>,
      size,
      size
    );
  }

  <span class="hljs-comment">// 获取所有矩形数据</span>
  getRectangles() {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.rectangles.map((rect) =&gt; ({
      id: rect.id,
      coords: rect.coords,
      left: rect.left,
      top: rect.top,
      width: rect.width,
      height: rect.height,
      angle: rect.angle,
    }));
  }

  <span class="hljs-comment">// 清空画布（保留背景图片）</span>
  clear() {
    <span class="hljs-comment">// 获取所有对象（不包括背景图片）</span>
    <span class="hljs-keyword">const</span> objects = <span class="hljs-keyword">this</span>.canvas.getObjects();

    <span class="hljs-comment">// 移除所有对象</span>
    objects.forEach((obj) =&gt; {
      <span class="hljs-keyword">this</span>.canvas.remove(obj);
    });

    <span class="hljs-comment">// 清空矩形数组</span>
    <span class="hljs-keyword">this</span>.rectangles = [];

    <span class="hljs-comment">// 重新渲染</span>
    <span class="hljs-keyword">this</span>.canvas.requestRenderAll();
  }

  <span class="hljs-comment">// 清空所有（包括背景图片）</span>
  clearAll() {
    <span class="hljs-comment">// 清空所有对象</span>
    <span class="hljs-keyword">this</span>.clear();

    <span class="hljs-comment">// 清空背景图片</span>
    <span class="hljs-keyword">this</span>.canvas.backgroundImage = <span class="hljs-literal">null</span>;

    <span class="hljs-comment">// 重新渲染</span>
    <span class="hljs-keyword">this</span>.canvas.requestRenderAll();
  }

  <span class="hljs-comment">// 调整画布大小</span>
  resize(width, height) {
    <span class="hljs-keyword">this</span>.canvas.setDimensions({ width, height });
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.canvas.backgroundImage) {
      <span class="hljs-keyword">this</span>.canvas.backgroundImage.scaleToWidth(width);
    }
    <span class="hljs-keyword">this</span>.canvas.requestRenderAll();
  }

  <span class="hljs-comment">// 销毁</span>
  destroy() {
    <span class="hljs-keyword">this</span>.canvas.off(<span class="hljs-string">"mouse:down"</span>);
    <span class="hljs-keyword">this</span>.canvas.off(<span class="hljs-string">"mouse:move"</span>);
    <span class="hljs-keyword">this</span>.canvas.off(<span class="hljs-string">"mouse:up"</span>);
    <span class="hljs-keyword">this</span>.canvas.off(<span class="hljs-string">"selection:created"</span>);
    <span class="hljs-keyword">this</span>.canvas.dispose();
  }
}

</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[深入理解 UINavigationController：生命周期、动画优化与性能调优]]></title>    <link>https://juejin.cn/post/7577295460249042990</link>    <guid>https://juejin.cn/post/7577295460249042990</guid>    <pubDate>2025-11-28T02:42:58.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577295460249042990" data-draft-id="7577242285198540827" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content=" 深入理解 UINavigationController：生命周期、动画优化与性能调优"/> <meta itemprop="keywords" content="iOS"/> <meta itemprop="datePublished" content="2025-11-28T02:42:58.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="江东小bug王"/> <meta itemprop="url" content="https://juejin.cn/user/1583760376077646"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
             深入理解 UINavigationController：生命周期、动画优化与性能调优
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1583760376077646/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    江东小bug王
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-28T02:42:58.000Z" title="Fri Nov 28 2025 02:42:58 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-28
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    4
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在日常开发中，<code>UINavigationController</code> 是我们最常用的容器控制器之一。但你是否真正理解：</p>
<ul>
<li>页面 push/pop 时，两个 ViewController 的生命周期方法如何调用？</li>
<li>为什么首次进入新页面会卡顿？</li>
<li>如何让导航切换更丝滑？</li>
<li>又该如何定位动画卡顿的“罪魁祸首”？</li>
</ul>
<p>本文将从 <strong>基础生命周期 → 动画优化 → 性能检测</strong> 三个层次，带你系统掌握 UINavigationController 的核心机制，并提供可落地的 Objective-C 实践方案。</p>
<hr/>
<h2 data-id="heading-0">一、页面切换时的生命周期：谁先谁后？</h2>
<h3 data-id="heading-1">场景 1：Push 新页面（A → B）</h3>
<p>假设当前栈顶是 <code>ViewControllerA</code>，点击按钮 push 到 <code>ViewControllerB</code>：</p>
<pre><code class="hljs language-objectivec" lang="objectivec"><span class="hljs-comment">// ViewControllerB 首次创建</span>
- (<span class="hljs-type">void</span>)viewDidLoad {
    [<span class="hljs-variable language_">super</span> viewDidLoad];
    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@"B: viewDidLoad"</span>);
}

- (<span class="hljs-type">void</span>)viewWillAppear:(<span class="hljs-type">BOOL</span>)animated {
    [<span class="hljs-variable language_">super</span> viewWillAppear:animated];
    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@"B: viewWillAppear"</span>);
}

- (<span class="hljs-type">void</span>)viewDidAppear:(<span class="hljs-type">BOOL</span>)animated {
    [<span class="hljs-variable language_">super</span> viewDidAppear:animated];
    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@"B: viewDidAppear"</span>);
}
</code></pre>
<pre><code class="hljs language-objectivec" lang="objectivec"><span class="hljs-comment">// ViewControllerA 被压入栈底</span>
- (<span class="hljs-type">void</span>)viewWillDisappear:(<span class="hljs-type">BOOL</span>)animated {
    [<span class="hljs-variable language_">super</span> viewWillDisappear:animated];
    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@"A: viewWillDisappear"</span>);
}

- (<span class="hljs-type">void</span>)viewDidDisappear:(<span class="hljs-type">BOOL</span>)animated {
    [<span class="hljs-variable language_">super</span> viewDidDisappear:animated];
    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@"A: viewDidDisappear"</span>);
}
</code></pre>
<p><strong>调用顺序如下：</strong></p>
<pre><code class="hljs language-makefile" lang="makefile"><span class="hljs-section">B: viewDidLoad</span>
<span class="hljs-section">A: viewWillDisappear</span>
<span class="hljs-section">B: viewWillAppear</span>
<span class="hljs-section">A: viewDidDisappear</span>
<span class="hljs-section">B: viewDidAppear</span>
</code></pre>
<blockquote>
<p>✅ 注意：<code>viewDidLoad</code> 仅在视图首次加载时调用一次。</p>
</blockquote>
<hr/>
<h3 data-id="heading-2">场景 2：Pop 返回（B → A）</h3>
<p>当用户点击返回或手势滑动 pop 回 A：</p>
<pre><code class="hljs language-makefile" lang="makefile"><span class="hljs-section">B: viewWillDisappear</span>
<span class="hljs-section">A: viewWillAppear</span>
<span class="hljs-section">B: viewDidDisappear</span>
<span class="hljs-section">A: viewDidAppear</span>
</code></pre>
<blockquote>
<p>❗ 关键点：<strong>A 的 <code>viewDidLoad</code> 不会再次调用！</strong><br/>
所以，若需每次进入都刷新数据，请放在 <code>viewWillAppear:</code> 中。</p>
</blockquote>
<hr/>
<h2 data-id="heading-3">二、为什么页面切换会卡顿？常见原因</h2>
<ol>
<li>
<p><strong>在 <code>viewDidLoad</code> 或 <code>viewWillAppear:</code> 中执行耗时操作</strong></p>
<ul>
<li>网络请求、JSON 解析、数据库查询</li>
<li>复杂 Auto Layout 计算</li>
<li>大量子视图创建或图片解码</li>
</ul>
</li>
<li>
<p><strong>首次 push 时构建整个视图层级</strong></p>
<ul>
<li>导致主线程阻塞，动画掉帧</li>
</ul>
</li>
<li>
<p><strong>离屏渲染（Offscreen Rendering）</strong></p>
<ul>
<li>圆角 + 阴影 + mask 同时使用</li>
<li>触发 GPU 额外绘制</li>
</ul>
</li>
</ol>
<hr/>
<h2 data-id="heading-4">三、优化策略：让导航切换如丝般顺滑</h2>
<h3 data-id="heading-5">✅ 1. 异步加载 &amp; 延迟初始化</h3>
<pre><code class="hljs language-objectivec" lang="objectivec">- (<span class="hljs-type">void</span>)viewDidLoad {
    [<span class="hljs-variable language_">super</span> viewDidLoad];
    
    <span class="hljs-comment">// 轻量级 UI 初始化</span>
    [<span class="hljs-keyword">self</span> setupUI];
    
    <span class="hljs-comment">// 耗时任务放后台</span>
    <span class="hljs-built_in">dispatch_async</span>(dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_DEFAULT, <span class="hljs-number">0</span>), ^{
        <span class="hljs-built_in">NSArray</span> *data = [<span class="hljs-keyword">self</span> fetchHeavyData];
        <span class="hljs-built_in">dispatch_async</span>(dispatch_get_main_queue(), ^{
            [<span class="hljs-keyword">self</span> reloadData:data];
        });
    });
}
</code></pre>
<blockquote>
<p>⚠️ 切记：UI 更新必须回到主线程！</p>
</blockquote>
<hr/>
<h3 data-id="heading-6">✅ 2. 预加载目标 ViewController（减少首次卡顿）</h3>
<pre><code class="hljs language-objectivec" lang="objectivec"><span class="hljs-comment">// 在父页面中预创建</span>
- (DetailViewController *)cachedDetailVC {
    <span class="hljs-keyword">if</span> (!_cachedDetailVC) {
        _cachedDetailVC = [[DetailViewController alloc] init];
        <span class="hljs-comment">// 提前触发 loadView，构建视图层级</span>
        <span class="hljs-built_in">UIView</span> *temp = _cachedDetailVC.view;
        (<span class="hljs-type">void</span>)temp; <span class="hljs-comment">// 避免编译器警告</span>
    }
    <span class="hljs-keyword">return</span> _cachedDetailVC;
}

- (<span class="hljs-keyword">IBAction</span>)showDetail:(<span class="hljs-type">id</span>)sender {
    [<span class="hljs-keyword">self</span>.navigationController pushViewController:<span class="hljs-keyword">self</span>.cachedDetailVC animated:<span class="hljs-literal">YES</span>];
}
</code></pre>
<blockquote>
<p>💡 适用于高频跳转页面（如商品详情、用户主页）。</p>
</blockquote>
<hr/>
<h3 data-id="heading-7">✅ 3. 自定义转场动画（提升体验）</h3>
<p>实现 <code>UINavigationControllerDelegate</code>：</p>
<pre><code class="hljs language-objectivec" lang="objectivec"><span class="hljs-comment">// MyNavigationControllerDelegate.m</span>
- (<span class="hljs-type">id</span>&lt;<span class="hljs-built_in">UIViewControllerAnimatedTransitioning</span>&gt;)navigationController:(<span class="hljs-built_in">UINavigationController</span> *)navigationController
                                   animationControllerForOperation:(<span class="hljs-built_in">UINavigationControllerOperation</span>)operation
                                                fromViewController:(<span class="hljs-built_in">UIViewController</span> *)fromVC
                                                  toViewController:(<span class="hljs-built_in">UIViewController</span> *)toVC {
    <span class="hljs-keyword">if</span> (operation == <span class="hljs-built_in">UINavigationControllerOperationPush</span>) {
        <span class="hljs-keyword">return</span> [[FadePushAnimator alloc] init];
    }
    <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>; <span class="hljs-comment">// 使用默认 pop 动画</span>
}
</code></pre>
<p>自定义动画器（简化版淡入）：</p>
<pre><code class="hljs language-objectivec" lang="objectivec"><span class="hljs-comment">// FadePushAnimator.m</span>
- (<span class="hljs-built_in">NSTimeInterval</span>)transitionDuration:(<span class="hljs-type">id</span>&lt;<span class="hljs-built_in">UIViewControllerContextTransitioning</span>&gt;)transitionContext {
    <span class="hljs-keyword">return</span> <span class="hljs-number">0.35</span>;
}

- (<span class="hljs-type">void</span>)animateTransition:(<span class="hljs-type">id</span>&lt;<span class="hljs-built_in">UIViewControllerContextTransitioning</span>&gt;)transitionContext {
    <span class="hljs-built_in">UIViewController</span> *fromVC = [transitionContext viewControllerForKey:<span class="hljs-built_in">UITransitionContextFromViewControllerKey</span>];
    <span class="hljs-built_in">UIViewController</span> *toVC = [transitionContext viewControllerForKey:<span class="hljs-built_in">UITransitionContextToViewControllerKey</span>];
    <span class="hljs-built_in">UIView</span> *container = [transitionContext containerView];
    
    [container addSubview:toVC.view];
    toVC.view.alpha = <span class="hljs-number">0.0</span>;
    
    [<span class="hljs-built_in">UIView</span> animateWithDuration:[<span class="hljs-keyword">self</span> transitionDuration:transitionContext] animations:^{
        fromVC.view.alpha = <span class="hljs-number">0.3</span>;
        toVC.view.alpha = <span class="hljs-number">1.0</span>;
    } completion:^(<span class="hljs-type">BOOL</span> finished) {
        fromVC.view.alpha = <span class="hljs-number">1.0</span>;
        [transitionContext completeTransition:!transitionContext.transitionWasCancelled];
    }];
}
</code></pre>
<blockquote>
<p>🎨 自定义动画可用于品牌化设计，但务必保证流畅性。</p>
</blockquote>
<hr/>
<h2 data-id="heading-8">四、如何检测性能瓶颈？实战工具链</h2>
<h3 data-id="heading-9">🔧 1. 使用 Xcode Instruments</h3>
<h4 data-id="heading-10">（1）Core Animation 模板</h4>
<ul>
<li>运行真机，执行 push/pop</li>
<li>观察 <strong>FPS 曲线</strong>（目标 ≥ 55）</li>
<li>开启调试选项：
<ul>
<li><strong>Color Blended Layers</strong>：红色 = 图层混合过多</li>
<li><strong>Color Offscreen-Rendered</strong>：黄色 = 离屏渲染</li>
</ul>
</li>
</ul>
<h4 data-id="heading-11">（2）Time Profiler 模板</h4>
<ul>
<li>定位 <code>viewDidLoad</code> / <code>viewWillAppear</code> 中的 CPU 热点</li>
<li>检查是否在主线程做 I/O 或复杂计算</li>
</ul>
<hr/>
<h3 data-id="heading-12">📝 2. 代码埋点测耗时</h3>
<pre><code class="hljs language-objectivec" lang="objectivec"><span class="hljs-keyword">@property</span> (<span class="hljs-keyword">nonatomic</span>, <span class="hljs-keyword">assign</span>) <span class="hljs-built_in">CFTimeInterval</span> appearStartTime;

- (<span class="hljs-type">void</span>)viewWillAppear:(<span class="hljs-type">BOOL</span>)animated {
    [<span class="hljs-variable language_">super</span> viewWillAppear:animated];
    <span class="hljs-keyword">self</span>.appearStartTime = <span class="hljs-built_in">CACurrentMediaTime</span>();
}

- (<span class="hljs-type">void</span>)viewDidAppear:(<span class="hljs-type">BOOL</span>)animated {
    [<span class="hljs-variable language_">super</span> viewDidAppear:animated];
    <span class="hljs-built_in">CFTimeInterval</span> duration = <span class="hljs-built_in">CACurrentMediaTime</span>() - <span class="hljs-keyword">self</span>.appearStartTime;
    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@"viewWillAppear → viewDidAppear 耗时: %.2f ms"</span>, duration * <span class="hljs-number">1000</span>);
}
</code></pre>
<blockquote>
<p>若超过 <strong>16ms（1帧）</strong>，就可能影响动画流畅度。</p>
</blockquote>
<hr/>
<h3 data-id="heading-13">🚨 3. 启用 Main Thread Checker</h3>
<p>Xcode 默认开启。若在子线程更新 UI，会立即 crash 并提示：</p>
<blockquote>
<p>“Main Thread Checker: UI API called on a background thread”</p>
</blockquote>
<p>确保所有 UI 操作都在主线程：</p>
<pre><code class="hljs language-objectivec" lang="objectivec"><span class="hljs-built_in">dispatch_async</span>(dispatch_get_main_queue(), ^{
    <span class="hljs-keyword">self</span>.titleLabel.text = newText;
});
</code></pre>
<hr/>
<h2 data-id="heading-14">五、总结：最佳实践 Checklist</h2>

































<table><thead><tr><th>项目</th><th>是否做到</th></tr></thead><tbody><tr><td>✅ <code>viewDidLoad</code> 只做 UI 初始化</td><td>☐</td></tr><tr><td>✅ 数据加载异步化</td><td>☐</td></tr><tr><td>✅ 高频页面预加载</td><td>☐</td></tr><tr><td>✅ 避免离屏渲染（用贝塞尔路径切圆角）</td><td>☐</td></tr><tr><td>✅ 使用 Instruments 定期检测 FPS</td><td>☐</td></tr><tr><td>✅ 返回手势未被遮挡</td><td>☐</td></tr></tbody></table>
<hr/>
<h2 data-id="heading-15">结语</h2>
<p><code>UINavigationController</code> 看似简单，但其背后的生命周期与渲染机制直接影响用户体验。<strong>流畅的页面切换不是偶然，而是对细节的极致把控。</strong></p>
<p>希望本文能帮你：</p>
<ul>
<li>理清生命周期调用顺序</li>
<li>避开常见性能陷阱</li>
<li>掌握一套完整的性能分析方法</li>
</ul>
<blockquote>
<p><strong>真正的高手，不仅写得出功能，更调得稳帧率。</strong></p>
</blockquote>
<p>如果你有具体的卡顿案例，欢迎留言交流！</p>
<hr/>
<p><strong>延伸阅读</strong></p>
<ul>
<li>Apple 官方文档：<a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.apple.com%2Flibrary%2Farchive%2Ffeaturedarticles%2FViewControllerPGforiPhoneOS%2F" target="_blank" title="https://developer.apple.com/library/archive/featuredarticles/ViewControllerPGforiPhoneOS/" ref="nofollow noopener noreferrer">View Controller Programming Guide</a></li>
<li>WWDC 2018：<a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.apple.com%2Fvideos%2Fplay%2Fwwdc2018%2F210%2F" target="_blank" title="https://developer.apple.com/videos/play/wwdc2018/210/" ref="nofollow noopener noreferrer">Practical Approaches to Great App Performance</a></li>
</ul>
<pre><code class="hljs"/></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[万人收藏的提示词工程指导白皮书（附中文版）！Google官方出品，看完整个人都通透了]]></title>    <link>https://juejin.cn/post/7577294037717008418</link>    <guid>https://juejin.cn/post/7577294037717008418</guid>    <pubDate>2025-11-28T02:46:28.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577294037717008418" data-draft-id="7577313637950341129" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="万人收藏的提示词工程指导白皮书（附中文版）！Google官方出品，看完整个人都通透了"/> <meta itemprop="keywords" content="LLM,Agent,程序员"/> <meta itemprop="datePublished" content="2025-11-28T02:46:28.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="AI大模型"/> <meta itemprop="url" content="https://juejin.cn/user/3817967696221534"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            万人收藏的提示词工程指导白皮书（附中文版）！Google官方出品，看完整个人都通透了
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3817967696221534/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    AI大模型
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-28T02:46:28.000Z" title="Fri Nov 28 2025 02:46:28 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-28
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#383838;font-size:15px;line-height:30px;letter-spacing:2px;word-break:break-word;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen,Ubuntu,Cantarell,Open Sans,Helvetica Neue,sans-serif;scroll-behavior:smooth;background-image:linear-gradient(0deg,transparent 24%,rgba(201,195,195,.329) 25%,hsla(0,8%,80.4%,.05) 26%,transparent 27%,transparent 74%,hsla(0,5.2%,81%,.185) 75%,rgba(180,176,176,.05) 76%,transparent 77%,transparent),linear-gradient(90deg,transparent 24%,rgba(204,196,196,.226) 25%,hsla(0,4%,66.1%,.05) 26%,transparent 27%,transparent 74%,hsla(0,5.2%,81%,.185) 75%,rgba(180,176,176,.05) 76%,transparent 77%,transparent);background-color:#fff;background-size:50px 50px;padding-bottom:60px}.markdown-body ::selection{color:#fff;background-color:#a862ea}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{margin:24px 0 12px;color:#a862ea}.markdown-body h1{line-height:2;font-size:1.4em}.markdown-body h1~p:first-of-type:first-letter{color:#a862ea;float:left;font-size:2em;margin-right:.4em;font-weight:bolder}.markdown-body h2{font-size:1.2em}.markdown-body h3{font-size:1.1em}.markdown-body ol,.markdown-body ul{padding-left:2em}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;padding-left:.2em}.markdown-body ol li::marker,.markdown-body ul li::marker{color:#a862ea}.markdown-body ol li.task-list-item,.markdown-body ul li.task-list-item{list-style:none}.markdown-body ol li.task-list-item ol,.markdown-body ol li.task-list-item ul,.markdown-body ul li.task-list-item ol,.markdown-body ul li.task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:10px}.markdown-body a,.markdown-body code,.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6,.markdown-body li,.markdown-body p{opacity:.85;vertical-align:baseline;transition:all .1s ease}.markdown-body a:hover,.markdown-body code:hover,.markdown-body h1:hover,.markdown-body h2:hover,.markdown-body h3:hover,.markdown-body h4:hover,.markdown-body h5:hover,.markdown-body h6:hover,.markdown-body li:hover,.markdown-body p:hover{opacity:1}.markdown-body a{display:inline-block;color:#a862ea;cursor:pointer;text-decoration:none;position:relative}.markdown-body a:after{content:"";position:absolute;width:98%;height:1px;bottom:0;left:0;transform:scaleX(0);background-color:#a862ea;transform-origin:bottom right;transition:transform .3s ease-in-out}.markdown-body a:hover:after{transform:scaleX(1);transform-origin:bottom left}.markdown-body a:active,.markdown-body a:link{color:#a862ea}.markdown-body img{max-width:100%;user-select:none;margin:1em 0;transition:transform .2s ease 0s;background-color:#f8f5ff;box-shadow:0 0 10px #e7daff}.markdown-body img:hover{opacity:1;box-shadow:0 0 20px #e7daff;transform:translateY(-1px)}.markdown-body blockquote{padding:.5em 1em;margin:12px 0;border-top-left-radius:2px;border-bottom-left-radius:2px;border-left:3px solid #a862ea;background-color:#f8f5ff}.markdown-body blockquote&gt;p{margin:0}.markdown-body .math{font-style:italic;margin:12px 0;padding:.5em 1em;background-color:#f8f5ff}.markdown-body .math&gt;p{margin:0}.markdown-body code{padding:2px .4em;overflow-x:auto;color:#a862ea;font-weight:700;word-break:break-word;font-family:Operator Mono,Consolas,Monaco,Menlo,monospace;background-color:#f8f5ff}.markdown-body pre{margin:2em 0}.markdown-body pre&gt;code{display:block;padding:1.5em;word-break:normal;font-size:.9em;font-style:normal;font-weight:400;font-family:Operator Mono,Consolas,Monaco,Menlo,monospace;line-height:18px;color:#383838;border-radius:2px;scroll-behavior:smooth;box-shadow:0 0 10px #e7daff}.markdown-body pre&gt;code:hover{box-shadow:0 0 20px #e7daff}.markdown-body pre&gt;code::-webkit-scrollbar{height:6px;background-color:#f8f5ff}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:#e7daff;border-bottom-left-radius:3px;border-bottom-right-radius:3px}.markdown-body hr{margin:2em 0;border-top:1px solid #a862ea}.markdown-body table{width:100%;font-size:12px;max-width:100%;overflow:auto;border-collapse:collapse}.markdown-body thead{color:#a862ea;background:#f8f5ff}.markdown-body td,.markdown-body th{padding:.5em;border:1px solid #e7daff}.markdown-body tr{background-color:#f8f5ff}@media (max-width:720px){.markdown-body{font-size:12px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>本文较长，建议点赞收藏。更多AI大模型应用开发学习视频及资料，在<a href="https://link.juejin.cn?target=https%3A%2F%2Fhy.zhipoai.cn%2F" target="_blank" title="https://hy.zhipoai.cn/" ref="nofollow noopener noreferrer">智泊AI</a>。</p>
</blockquote>
<p>今天想和大家分享一份来自谷歌的技术白皮书《<strong>Prompt Engineering</strong>》，主题聚焦于“<strong>提示词工程</strong>”，长达68页的提示词指导。</p>
<p>这份文档不仅全面介绍了与大型语言模型（LLMs）有效互动的方法，还深入探讨了多种<strong>高级提示技巧</strong>，旨在帮助我们更精准地利用AI技术解决实际问题。</p>
<p>在这份白皮书中，作者详细讲解了几种核心的提示策略，包括<strong>零样本提示、小样本提示、系统提示、角色提示、上下文提示、退一步提示、链式思考（Chain of Thought）、自我一致性（Self Consistency）、思维树（Tree of Thoughts）以及ReAct方法</strong>。</p>
<p>这些技术不仅能够提升模型输出的相关性和准确性，还能在复杂的开发场景中提供强有力的支持。</p>
<p>特别值得一提的是，白皮书通过实例展示了<strong>如何使用链式思考来增强模型推理能力</strong>，并且提出了将答案置于推理之后的<strong>最佳实践建议</strong>。例如，在构建一个邮件分类系统时，如何通过细致入微的提示设计识别出潜在的重要信息或威胁。</p>
<p>此外，对于想要<strong>自动化其提示过程</strong>的开发者来说，文中也提供了相关的<strong>指导和技术路线图</strong>。</p>
<p>不仅如此，该文档还讨论了通用AI面临的挑战，比如<strong>因提示不充分而导致的问题</strong>，并分享了一系列最佳实践，以帮助开发者成为更加<strong>优秀的提示工程师</strong>。</p>
<p>无论是面对数据处理还是复杂应用集成，白皮书都提供了<strong>宝贵的见解和实用建议</strong>。</p>
<p>最后，白皮书强调了记录每次提示尝试的重要性，这有助于持续学习和改进。</p>
<p>通过实验不同的提示策略并与同行交流心得，我们可以不断提升自己的技能，探索出<strong>最适合自身需求的解决方案</strong>。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6c0cdfda173e4e67b3cf8b248f2fbd21~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764902788&amp;x-signature=IZkoPgLF8aIHUhnuKzy4qe0wj5Q%3D" alt="" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0758801481de4d8a81efb180380aee0c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764902788&amp;x-signature=nbk10V5c24OePiA3nyV66oRZBT4%3D" alt="" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cf7d02cec96c45d0bfa5d97ae5fe75a0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764902788&amp;x-signature=WWupzfV%2FfnnjAH2ngwPyaviGSJI%3D" alt="" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1b70e0347fb8416cbc686224efdd39ac~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764902788&amp;x-signature=Mgq6g%2BZTCFPGghXYADzlR3azqM4%3D" alt="" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9a615bdd62f946aa933743cd7bb2f59b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764902788&amp;x-signature=PDAF5FmopiTX7yhwU%2Bxw3WwKhVI%3D" alt="" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/eb29283315f64ca4812303738680fc4a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764902788&amp;x-signature=pnJJAlNPM9UuRWNFTkjr1N2ueQ0%3D" alt="" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e372594cea704d8c9fd0388b48dc1466~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764902788&amp;x-signature=guB%2F0RRM47docVdOngNYsNDs7iU%3D" alt="" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4092181245574c1186ba1371ed16e39b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764902788&amp;x-signature=YMs4f8xChBxG0v3dSqwCTFzvaIo%3D" alt="" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7ea3fddd7d9f463c9dec0affbd307cff~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764902788&amp;x-signature=kh8vRDU3yeKm8Yr%2FBWhgiPSn%2BrM%3D" alt="" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c617755664f5452f9f364629c651afea~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764902788&amp;x-signature=o%2F5mUsr7mwhVAK4cfS84oJOSX4Y%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-0">学习资源推荐</h2>
<p>如果你想更深入地学习大模型，以下是一些非常有价值的学习资源，这些资源将帮助你从不同角度学习大模型，提升你的实践能力。</p>
<blockquote>
<p>本文较长，建议点赞收藏。更多AI大模型应用开发学习视频及资料，在<a href="https://link.juejin.cn?target=https%3A%2F%2Fhy.zhipoai.cn%2F" target="_blank" title="https://hy.zhipoai.cn/" ref="nofollow noopener noreferrer">智泊AI</a>。</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[学妹给我 100，帮她分析个网站？]]></title>    <link>https://juejin.cn/post/7577313637950799881</link>    <guid>https://juejin.cn/post/7577313637950799881</guid>    <pubDate>2025-11-28T03:00:35.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577313637950799881" data-draft-id="7577300470520479753" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="学妹给我 100，帮她分析个网站？"/> <meta itemprop="keywords" content="数据分析,程序员,后端"/> <meta itemprop="datePublished" content="2025-11-28T03:00:35.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="程序员鱼皮"/> <meta itemprop="url" content="https://juejin.cn/user/2444938365386621"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            学妹给我 100，帮她分析个网站？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2444938365386621/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    程序员鱼皮
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-28T03:00:35.000Z" title="Fri Nov 28 2025 03:00:35 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-28
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    2
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>学妹问我：鱼皮 gie gie，你们团队这么多网站产品，都是怎么做数据分析的啊？</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/66f31d6051214ef680ed5e6f8c98e2dd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764903635&amp;x-signature=bpkcnF1u9As6UZHuapP2nH7kJRw%3D" alt="" loading="lazy"/></p>
<p>其实有很多现成的免费资源，可以让你不费吹灰之力搞定各种数据分析场景。</p>
<ul>
<li>网站流量统计</li>
<li>前端错误监控</li>
<li>用户行为分析</li>
<li>自定义业务分析</li>
<li>后端应用监控分析</li>
<li>后端资源监控分析</li>
<li>后端自定义指标分析</li>
</ul>
<p>干货较多，建议收藏~</p>
<blockquote>
<p>⭐️ 推荐观看视频版：<a href="https://link.juejin.cn?target=https%3A%2F%2Fbilibili.com%2Fvideo%2FBV1CkUDBiEMR" target="_blank" title="https://bilibili.com/video/BV1CkUDBiEMR" ref="nofollow noopener noreferrer">bilibili.com/video/BV1Ck…</a></p>
</blockquote>
<h2 data-id="heading-0">网站分析保姆级教程</h2>
<p>先说说最基础的 <strong>网站流量分析</strong>。你肯定想知道每天有多少人访问你的网站、他们从哪来、在哪个页面待得最久对吧？</p>
<p>可以使用百度统计、51.LA 网站统计或 Google Analytics，只需要给你的网站文件添加一段代码就能轻松接入。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c3570ab7871a434593048525cdf93600~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764903635&amp;x-signature=ZicuMhHut9%2BGEv3Uh3mHRYsH9EY%3D" alt="" loading="lazy"/></p>
<p>然后就能看到访客数量和趋势、分析访客的来源、分析页面的访问情况等等：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/93f9be1d979946d5b7ef64fb3fefa8cc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764903635&amp;x-signature=xksYKV4GXOFkAE9gwinkc5Ot%2FUk%3D" alt="" loading="lazy"/></p>
<p>可以帮你了解用户的偏好、获取页面优化的思路。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/16fc4bf2f46740fea5d54294822c9f2c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764903635&amp;x-signature=D5k3Qsgd8WU%2B89k2QnbS5%2Fv5HIc%3D" alt="" loading="lazy"/></p>
<p>如果你做的是小程序，那就更简单了，比如微信小程序直接用官方自带的数据分析就行。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c9dac3baba2c4f60a47d247704668582~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764903635&amp;x-signature=tEdsaCv739jiM4JiEl5tsEgEhvM%3D" alt="" loading="lazy"/></p>
<p>如果你想分析别人的网站流量，怎么办呢？</p>
<p>可以用 Similarweb 或者 AI TDK 这类工具，输入网址就能看到对方的流量估算、访问来源和热门关键词，做竞品分析和 SEO 搜索引擎优化的时候特别好用。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/27fee66d377b49c8b3ec9c7f735b03ed~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764903635&amp;x-signature=6ipQnl5D1aX4YCPWo1VhrmAfpTY%3D" alt="" loading="lazy"/></p>
<p>光知道用户的正常使用情况还不够，万一你的网站按钮点不动了，用户那边疯狂报错，你这儿却一无所知，那就尴尬了，说不定会影响收入！所以 <strong>前端错误监控</strong> 必不可少。</p>
<p>Sentry 是业界主流的开源前端监控，它能帮你捕获和统计各种代码报错。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5af09fd24cc8498ca8ec75403da33281~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764903635&amp;x-signature=bOLZoFaW3WqIhiAzNv8o2WjhKZI%3D" alt="" loading="lazy"/></p>
<p>还能记录用户的系统环境和具体报错信息，便于你排查和修复 Bug。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d6e0d93b594443a9a23c8699a2870e4f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764903635&amp;x-signature=n%2Fu%2BK52EuRlD4lrexzLu7kpmsjE%3D" alt="" loading="lazy"/></p>
<p>不过免费版存在限制，或者得自己搭建服务器部署开源代码。所以我们团队用的是国内的灵雀应用监控，也是一段代码就能接入，能够实时捕获前端的各种异常报错，查看具体的错误信息等等。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/44f2f804aabf4fb6b07f1ebbddf9ded9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764903635&amp;x-signature=z%2FvwnJZZdJDpRtwXNFQHMLomk4M%3D" alt="" loading="lazy"/></p>
<p>有时候光知道哪里出错了还不够，你还想知道用户到底是怎么操作的？为什么会触发这个错误？或者为什么用户不愿意付费？这时候就得上 <strong>用户行为分析</strong> 工具了。</p>
<p>我直接掏出微软 100% 免费的 Clarity，能录制用户的真实操作回放。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/331db7299abf47e280e93b1700d2c6aa~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764903635&amp;x-signature=PmFY%2FLkw6HZlKcDnns229uY%2F5mM%3D" alt="" loading="lazy"/></p>
<p>像我们团队的 <a href="https://link.juejin.cn?target=https%3A%2F%2Fai.mianshiya.com%2F" target="_blank" title="https://ai.mianshiya.com/" ref="nofollow noopener noreferrer">模拟面试产品 - 面多多</a> 就在用它，用户点击了哪里、滚动到哪里、在哪个按钮上犹豫不决，全都一清二楚。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0e57323e714a411f8dbd7f021bf732c9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764903635&amp;x-signature=0q8Y%2FbahJSVpDQpFwdm0YfdETts%3D" alt="" loading="lazy"/></p>
<p>还能通过热度地图快速分析用户的喜好，从而帮助优化产品功能按钮的布局，降低产品的使用难度，发现很多凭空根本想不到的问题。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/eb34de0a0d274ec09f4c9b12ed6c12a0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764903635&amp;x-signature=SD9fhX4%2FhkdYcIQSaIUPSsjkq9I%3D" alt="" loading="lazy"/></p>
<p>前面说的这些工具提供的都是通用指标，但每个产品的业务逻辑不一样，有些你特别关心的数据，比如付费转化率、功能使用频次等，光靠现成工具可能拿不到，这时候就得上 <strong>自定义业务分析</strong> 了。</p>
<p>刚开始我有点想当然，直接就为一些大家耳熟能详的商业 BI 产品付费了，但后来发现对于小团队来说，其实没必要花那个钱，直接搭建开源的 DataEase 或 Superset 就挺香的，可以对接 MySQL 数据库等各种自己业务的数据源，然后根据需求来配置、拖拖拽拽就能做出各种可视化图表和看板。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c75ac6deff254b2194024fbc70e4baec~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764903635&amp;x-signature=zZyIe5unEhWbTsPgmAgGuGc97Wg%3D" alt="" loading="lazy"/></p>
<p>实在碰到特别个性化的需求，还可以自己搭建看板。现在有了 AI 加持，配合 ECharts 图表库，写几句提示词就能生成可视化看板，真的轻松多了。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8ca3ad41d26a460dbc12a72c379777d7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764903635&amp;x-signature=sbn%2Bxj1T745F3lW3Q%2B4LewQGoc4%3D" alt="" loading="lazy"/></p>
<p>说完前端，咱后端的数据分析也不能落下啊。</p>
<p>用户访问你的网站，背后都是一个个接口在提供数据，怎么知道接口是否正常？有没有优化空间呢？这时就需要后端的 <strong>应用监控分析</strong> 了。</p>
<p>像我们团队在用 ARMS 应用实时监控服务，能帮你全面监控应用的性能，快速发现出错或者速度较慢的接口。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/799e4bc7af6a4565b0fe8e84f42a5169~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764903635&amp;x-signature=Z2U1%2Bpa61h79bdEm3I53h9hQ1iU%3D" alt="" loading="lazy"/></p>
<p>还能进一步查看错误详情，甚至是分析接口的完整调用链，能快速定位问题。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/db27d4b6371e46ef9c3408ab77b3ed73~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764903635&amp;x-signature=QjztRgD%2Bc5qeaHI4dEtdq1PX7Ko%3D" alt="" loading="lazy"/></p>
<p>除了应用层面，服务器、数据库、缓存这些 <strong>资源的监控分析</strong> 也很重要，如果它们都跑在云上，那就直接用云服务商自带的监控看板就行，各种指标一目了然。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d050b3da59774de1987ee201c05c7775~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764903635&amp;x-signature=plckSx0ZZQqSv2f2bPOfVRlJdTo%3D" alt="" loading="lazy"/></p>
<p>要是你想统一监控分析更个性化的指标，那就得请出 Prometheus + Grafana 这对王炸组合了。Prometheus 负责采集各种自定义指标数据，为开发者带来监控的火种。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/406bef799fb24d75b0c8421c298745be~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764903635&amp;x-signature=NSeERDgZnNa%2FWxnpRVZpBGSIbNI%3D" alt="" loading="lazy"/></p>
<p>Grafana 则负责把这些数据变成炫酷的可视化大屏。看着一堆实时变化的图表，我仿佛掌控着整个系统的脉搏，恍惚间有种成为科幻电影里男猪脚的感觉~</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d982a20281504800b14a4fdff51cf24e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764903635&amp;x-signature=ZvnoGh8Q%2BuFJsCM7mzs4i5kJrdo%3D" alt="" loading="lazy"/></p>
<hr/>
<p>OK 就分享到这里，其实还有很多不错的开源项目，比如 SkyWalking、Zipkin 来管理应用性能，ELK 来集中分析日志等等。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e60cfd7dd553426eb300dccd07d89fce~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764903635&amp;x-signature=8zl%2ByBxUj099lNsVR43OgTiCdsA%3D" alt="" loading="lazy"/></p>
<p>有了这些工具，网站数据分析其实没有那么复杂，关键是要根据需求选择合适的方案，把时间省下来做产品才是正道。</p>
<p>如果本文对你有帮助，点个赞吧，感激不尽！</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2b8b302153834996ab11545f6037a075~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764903635&amp;x-signature=IpO3vtoO%2FEuI%2BOaDZvWt0d8G%2FXg%3D" alt="求点赞" loading="lazy"/></p>
<h2 data-id="heading-1">更多</h2>
<p>💻 编程学习交流：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fliyupi%2Fcode-nav" target="_blank" title="https://github.com/liyupi/code-nav" ref="nofollow noopener noreferrer">编程导航</a> 📃 简历快速制作：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fliyupi%2Flaoyujianli" target="_blank" title="https://github.com/liyupi/laoyujianli" ref="nofollow noopener noreferrer">老鱼简历</a> ✏️ 面试刷题神器：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fliyupi%2Fmianshiya" target="_blank" title="https://github.com/liyupi/mianshiya" ref="nofollow noopener noreferrer">面试鸭</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Eino AI 实战： Eino 的文档加载与解析]]></title>    <link>https://juejin.cn/post/7577284771447210024</link>    <guid>https://juejin.cn/post/7577284771447210024</guid>    <pubDate>2025-11-28T03:03:23.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577284771447210024" data-draft-id="7577226553286246435" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Eino AI 实战： Eino 的文档加载与解析"/> <meta itemprop="keywords" content="后端,Go"/> <meta itemprop="datePublished" content="2025-11-28T03:03:23.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="码一行"/> <meta itemprop="url" content="https://juejin.cn/user/2963939081856328"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Eino AI 实战： Eino 的文档加载与解析
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2963939081856328/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    码一行
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-28T03:03:23.000Z" title="Fri Nov 28 2025 03:03:23 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-28
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden;color:#333}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1:first-child,.markdown-body h2:first-child,.markdown-body h3:first-child,.markdown-body h4:first-child,.markdown-body h5:first-child,.markdown-body h6:first-child{margin-top:-1.5rem;margin-bottom:1rem}.markdown-body h1:before,.markdown-body h2:before,.markdown-body h3:before,.markdown-body h4:before,.markdown-body h5:before,.markdown-body h6:before{content:"#";display:inline-block;color:#3eaf7c;padding-right:.23em}.markdown-body h1{position:relative;font-size:2.5rem;margin-bottom:5px}.markdown-body h1:before{font-size:2.5rem}.markdown-body h2{padding-bottom:.5rem;font-size:2.2rem;border-bottom:1px solid #ececec}.markdown-body h3{font-size:1.5rem;padding-bottom:0}.markdown-body h4{font-size:1.25rem}.markdown-body h5{font-size:1rem}.markdown-body h6{margin-top:5px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body strong{color:#3eaf7c}.markdown-body img{max-width:100%;border-radius:2px;display:block;margin:auto;border:3px solid rgba(62,175,124,.2)}.markdown-body hr{border:none;border-top:1px solid #3eaf7c;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;overflow-x:auto;padding:.2rem .5rem;margin:0;color:#3eaf7c;font-weight:700;font-size:.85em;background-color:rgba(27,31,35,.05);border-radius:3px}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75;border-radius:6px;border:2px solid #3eaf7c}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{font-weight:500;text-decoration:none;color:#3eaf7c}.markdown-body a:active,.markdown-body a:hover{border-bottom:1.5px solid #3eaf7c}.markdown-body a:before{content:"⇲"}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #3eaf7c}.markdown-body thead{background:#3eaf7c;color:#fff;text-align:left}.markdown-body tr:nth-child(2n){background-color:rgba(62,175,124,.2)}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:.5rem solid;border-color:#42b983;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body details{outline:none;border:none;border-left:4px solid #3eaf7c;padding-left:10px;margin-left:4px}.markdown-body details summary{cursor:pointer;border:none;outline:none;background:#fff;margin:0 -17px}.markdown-body details summary::-webkit-details-marker{color:#3eaf7c}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body ol li::marker{color:#3eaf7c}.markdown-body ul li{list-style:none}.markdown-body ul li:before{content:"•";margin-right:4px;color:#3eaf7c}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><ol>
<li>
<h2 data-id="heading-0"><strong>基本介绍</strong></h2>
</li>
</ol>
<p><code>Document Loader</code> 是一个用于加载文档的组件。它的主要作用是从不同来源（如网络 URL、本地文件等）加载文档内容，并将其转换为标准的文档格式。这个组件在处理需要从各种来源获取文档内容的场景中发挥重要作用，比如:</p>
<ul>
<li>从网络 URL 加载网页内容</li>
<li>读取本地 PDF、Word 等格式的文档</li>
</ul>
<ol start="2">
<li>
<h2 data-id="heading-1"><strong>组件定义</strong></h2>
</li>
</ol>
<h4 data-id="heading-2"><strong>2.1 接口定义</strong></h4>
<blockquote>
<p>代码位置：<strong>eino/components/document/interface.go</strong></p>
</blockquote>
<pre><code class="hljs language-go" lang="go"><span class="hljs-keyword">type</span> Loader <span class="hljs-keyword">interface</span> {
    Load(ctx context.Context, src Source, opts ...LoaderOption) ([]*schema.Document, <span class="hljs-type">error</span>)
}
</code></pre>
<h4 data-id="heading-3"><strong>2.2 Load 方法</strong></h4>
<ul>
<li>
<p>功能：从指定的数据源加载文档</p>
</li>
<li>
<p>参数：</p>
<ul>
<li><code>ctx</code>：上下文对象，用于传递请求级别的信息，同时也用于传递 Callback Manager</li>
<li><code>src</code>：文档来源，包含文档的 URI 信息</li>
<li><code>opts</code>：加载选项，用于配置加载行为</li>
</ul>
</li>
<li>
<p>返回值：</p>
<ul>
<li><code>[]*schema.Document</code>：加载的文档列表</li>
<li><code>error</code>：加载过程中的错误信息</li>
</ul>
</li>
</ul>
<h4 data-id="heading-4"><strong>2.3 Source 结构体</strong></h4>
<pre><code class="hljs language-go" lang="go"><span class="hljs-keyword">type</span> Source <span class="hljs-keyword">struct</span> {
    URI <span class="hljs-type">string</span>
}
</code></pre>
<p><code>Source</code> 结构体定义了文档的来源信息：</p>
<ul>
<li><code>URI</code>：文档的统一资源标识符，可以是网络 URL 或本地文件路径</li>
</ul>
<h4 data-id="heading-5"><strong>2.4 Document 结构体</strong></h4>
<pre><code class="hljs language-go" lang="go"><span class="hljs-keyword">type</span> Document <span class="hljs-keyword">struct</span> {
    <span class="hljs-comment">// ID 是文档的唯一标识符</span>
    ID <span class="hljs-type">string</span>
    <span class="hljs-comment">// Content 是文档的内容</span>
    Content <span class="hljs-type">string</span>
    <span class="hljs-comment">// MetaData 用于存储文档的元数据信息</span>
    MetaData <span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]any
}
</code></pre>
<p><code>Document</code> 结构体是文档的标准格式，包含以下重要字段：</p>
<ul>
<li>
<p><code>ID</code>：文档的唯一标识符，用于在系统中唯一标识一个文档</p>
</li>
<li>
<p><code>Content</code>：文档的实际内容</p>
</li>
<li>
<p><code>MetaData</code>：文档的元数据，可以存储如下信息：</p>
<ul>
<li>文档的来源信息</li>
<li>文档的向量表示（用于向量检索）</li>
<li>文档的分数（用于排序）</li>
<li>文档的子索引（用于分层检索）</li>
<li>其他自定义元数据</li>
</ul>
</li>
</ul>
<h4 data-id="heading-6"><strong>2.5 公共选项</strong></h4>
<ul>
<li><code>Loader</code> 组件使用 <code>LoaderOption</code> 来定义加载选项。</li>
<li><code>Loader</code> 目前没有公共的 <code>Option</code>，每个具体的实现可以定义自己的特定选项，通过 <code>WrapLoaderImplSpecificOptFn</code> 函数包装成统一的 <code>LoaderOption</code> 类型。</li>
</ul>
<ol start="3">
<li>
<h2 data-id="heading-7"><strong>应用</strong></h2>
</li>
</ol>
<h4 data-id="heading-8"><strong>3.1 本地文件加载 (Loader - local file)</strong></h4>
<blockquote>
<p>代码位置：<strong>eino-ext/components/document/loader/f</strong> <strong>ile/file_loader.go</strong></p>
</blockquote>
<p>配置参数说明：</p>
<ul>
<li><code>UseNameAsID</code>：是否将文件名用作文档 ID</li>
<li><code>Parser</code>：文档解析器，如果不指定则使用默认的扩展名解析器（ExtParser，当前仅实现了 <code>TextParser</code>）</li>
</ul>
<pre><code class="hljs language-go" lang="go"><span class="hljs-keyword">package</span> main

<span class="hljs-keyword">import</span> (
        <span class="hljs-string">"context"</span>
        <span class="hljs-string">"github.com/cloudwego/eino-ext/components/document/loader/file"</span>
        <span class="hljs-string">"github.com/cloudwego/eino/components/document"</span>
        <span class="hljs-string">"github.com/cloudwego/eino/components/document/parser"</span>
        <span class="hljs-string">"log"</span>
)

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
        ctx := context.Background()

        <span class="hljs-comment">// 本地文件</span>
        loader, _ := file.NewFileLoader(ctx, &amp;file.FileLoaderConfig{
                UseNameAsID: <span class="hljs-literal">true</span>,
                Parser:      &amp;parser.TextParser{}, <span class="hljs-comment">// 可选：指定自定义解析器</span>
        })
        filePath := <span class="hljs-string">"./file_data/Go 1.24震撼发布！这些新特性你必须知道！.md"</span>
        docs, err := loader.Load(ctx, document.Source{
                URI: filePath,
        })
        <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
                <span class="hljs-built_in">panic</span>(err)
        }

        log.Printf(<span class="hljs-string">"doc content: %v"</span>, docs[<span class="hljs-number">0</span>].Content)

        <span class="hljs-keyword">for</span> _, doc := <span class="hljs-keyword">range</span> docs {
                <span class="hljs-built_in">println</span>(doc.Content) <span class="hljs-comment">// go1.25 的新特性，不需要 fmt.Println</span>
                <span class="hljs-built_in">println</span>(doc.ID)
                <span class="hljs-comment">// 访问元数据</span>
                <span class="hljs-built_in">println</span>(doc.MetaData[file.MetaKeyFileName])
                <span class="hljs-built_in">println</span>(doc.MetaData[file.MetaKeyExtension])
                <span class="hljs-built_in">println</span>(doc.MetaData[file.MetaKeySource])
        }
}
</code></pre>
<h4 data-id="heading-9"><strong>3.2 网络文件加载 (Loader - web url)</strong></h4>
<blockquote>
<p>代码位置：<strong>eino-ext/components/document/loader/url/url.go</strong></p>
</blockquote>
<p>配置参数说明：</p>
<ul>
<li><code>Parser</code>：文档解析器，默认使用 HTML 解析器，会提取网页正文内容</li>
<li><code>Client</code>：HTTP 客户端，可以自定义超时、代理等配置</li>
<li><code>RequestBuilder</code>：请求构建器，用于自定义请求方法、请求头等</li>
</ul>
<pre><code class="hljs language-go" lang="go"><span class="hljs-keyword">package</span> main

<span class="hljs-keyword">import</span> (
    <span class="hljs-string">"context"</span>
    <span class="hljs-string">"github.com/cloudwego/eino-ext/components/document/loader/url"</span>
    <span class="hljs-string">"github.com/cloudwego/eino/components/document"</span>
    <span class="hljs-string">"github.com/cloudwego/eino/components/document/parser"</span>
    <span class="hljs-string">"log"</span>
    <span class="hljs-string">"net/http"</span>
)

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    ctx := context.Background()
  
    <span class="hljs-comment">// 网络文件加载</span>
    loader, _ := url.NewLoader(ctx, &amp;url.LoaderConfig{
        Parser: &amp;parser.TextParser{},
        Client: &amp;http.Client{},
        RequestBuilder: <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(ctx context.Context, source document.Source, opts ...document.LoaderOption)</span></span> (*http.Request, <span class="hljs-type">error</span>) {
          <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, <span class="hljs-literal">nil</span>
        },
    })
  
    docs, err := loader.Load(ctx, document.Source{
        URI: <span class="hljs-string">"https://www.alipan.com/s/kKxyyXhjckz"</span>, <span class="hljs-comment">// 真实的 pdf 文档的地址</span>
    })
    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
        <span class="hljs-built_in">panic</span>(err)
    }

    log.Printf(<span class="hljs-string">"doc content: %v"</span>, docs[<span class="hljs-number">0</span>].Content)
    <span class="hljs-comment">// 使用文档内容</span>
    <span class="hljs-keyword">for</span> _, doc := <span class="hljs-keyword">range</span> docs {
        <span class="hljs-built_in">println</span>(doc.Content)
    }
}
</code></pre>
<h4 data-id="heading-10"><strong>3.3 解析 PDF 为纯文本 （Parser - pdf）</strong></h4>
<blockquote>
<p>代码位置：<strong>eino-ext/components/document/parser/pdf.pdf.go</strong></p>
</blockquote>
<p>配置参数说明：</p>
<ul>
<li><code>ToPages</code>：是否将 PDF 按页面分割成多个文档，默认为 false</li>
</ul>
<p>解析选项：</p>
<ul>
<li>支持通过 <code>parser.WithURI</code> 设置文档 URI</li>
<li>支持通过 <code>parser.WithExtraMeta</code> 添加额外元数据</li>
</ul>
<pre><code class="hljs language-go" lang="go"><span class="hljs-keyword">package</span> main

<span class="hljs-keyword">import</span> (
        <span class="hljs-string">"context"</span>
        <span class="hljs-string">"log"</span>
        <span class="hljs-string">"os"</span>

        <span class="hljs-string">"github.com/cloudwego/eino-ext/components/document/parser/pdf"</span>
)

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
        ctx := context.Background()

        parser, _ := pdf.NewPDFParser(ctx, &amp;pdf.Config{
                ToPages: <span class="hljs-literal">false</span>, <span class="hljs-comment">// 是否按页面分割文档</span>
        })

        file, err := os.Open(<span class="hljs-string">"./file_data/2021-09《我们为什么控制不了自己》.pdf"</span>)
        <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
                log.Fatal(err)
        }

        <span class="hljs-keyword">defer</span> file.Close()

        <span class="hljs-comment">// 解析文档</span>
        docs, err := parser.Parse(ctx, file)
        <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
                log.Fatal(err)
        }

        <span class="hljs-comment">// 打印解析结果</span>
        <span class="hljs-keyword">for</span> _, doc := <span class="hljs-keyword">range</span> docs {
                <span class="hljs-built_in">println</span>(doc.Content)
        }
}
</code></pre>
<h4 data-id="heading-11"><strong>3.4 解析 HTML 为纯文本</strong></h4>
<blockquote>
<p>代码位置：<strong>eino-ext/components/document/parser/html/html.go</strong></p>
</blockquote>
<p>配置参数说明：</p>
<ul>
<li>
<p><code>Selector</code>：可选参数，指定要提取的内容区域，使用 <code>goquery</code> 选择器语法</p>
<ul>
<li>例如：body 表示提取 标签内容</li>
<li><code>#content</code> 表示提取 id 为 “content” 的元素内容</li>
</ul>
</li>
</ul>
<p>解析器会自动提取以下 <strong>metadata</strong>：</p>
<ul>
<li><code>html.MetaKeyTitle</code> ("_title")：网页标题</li>
<li><code>html.MetaKeyDesc</code> ("_description")：网页描述</li>
<li><code>html.MetaKeyLang</code> ("_language")：网页语言</li>
<li><code>html.MetaKeyCharset</code> ("_charset")：字符编码</li>
<li><code>html.MetaKeySource</code> ("_source")：文档来源 URI</li>
</ul>
<pre><code class="hljs language-go" lang="go"><span class="hljs-keyword">package</span> main

<span class="hljs-keyword">import</span> (
        <span class="hljs-string">"context"</span>
        <span class="hljs-string">"fmt"</span>
        <span class="hljs-string">"strings"</span>

        <span class="hljs-string">"github.com/cloudwego/eino-ext/components/document/parser/html"</span>
)

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
        ctx := context.Background()

        <span class="hljs-comment">// 初始化解析器</span>
        p, err := html.NewParser(ctx, &amp;html.Config{
        Selector: <span class="hljs-string">"#content"</span>,   <span class="hljs-comment">// 选择器，指定只提取 id 为 content 的元素内容，默认为 body</span>
    }) <span class="hljs-comment">// 使用默认配置</span>
        <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
                <span class="hljs-built_in">panic</span>(err)
        }

        <span class="hljs-comment">// HTML 内容</span>
        document := <span class="hljs-string">`
    &lt;html lang="zh"&gt;
        &lt;head&gt;
            &lt;title&gt;示例页面&lt;/title&gt;
            &lt;meta name="description" content="这是一个示例页面"&gt;
            &lt;meta charset="UTF-8"&gt;
        &lt;/head&gt;
        &lt;body&gt;
            &lt;div id="content"&gt;
                &lt;h1&gt;欢迎&lt;/h1&gt;
                &lt;p&gt;这是正文内容。&lt;/p&gt;
            &lt;/div&gt;
        &lt;/body&gt;
    &lt;/html&gt;
    `</span>

        <span class="hljs-comment">// 解析文档</span>
        docs, err := p.Parse(ctx, strings.NewReader(document))
        <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
                <span class="hljs-built_in">panic</span>(err)
        }

        <span class="hljs-comment">// 使用解析结果</span>
        doc := docs[<span class="hljs-number">0</span>]
        fmt.Println(<span class="hljs-string">"内容:"</span>, doc.Content)
        fmt.Println(<span class="hljs-string">"标题:"</span>, doc.MetaData[html.MetaKeyTitle])
        fmt.Println(<span class="hljs-string">"描述:"</span>, doc.MetaData[html.MetaKeyDesc])
        fmt.Println(<span class="hljs-string">"语言:"</span>, doc.MetaData[html.MetaKeyLang])
}
</code></pre>
<ol start="4">
<li>
<h2 data-id="heading-12"><strong>总结</strong></h2>
</li>
</ol>
<blockquote>
<p>Eino 框架是字节跳动内部半年多的使用和迭代，基于 Go 的大模型应用综合开发框架</p>
</blockquote>
<p>介绍了 Eino: Components 组件中的 Document Loader 组件的用法</p>
<ul>
<li>本地文件加载</li>
<li>远程文件加载</li>
<li>解析 pdf</li>
<li>解析 html</li>
</ul>
<p>通过内部封装好的组件，可以更快、更高效的基实现大模型所具备的其中一个核心能力：</p>
<ul>
<li><strong>基于语义的文本处理能力</strong></li>
</ul>
<p>这项能力可以让开发者专注与业务逻辑的实现，避免重复造轮子，以快速构建高质量的大模型应用。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[vue项目中使用echarts做词云图]]></title>    <link>https://juejin.cn/post/7577222731790057498</link>    <guid>https://juejin.cn/post/7577222731790057498</guid>    <pubDate>2025-11-27T11:41:55.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577222731790057498" data-draft-id="7577222731790041114" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="vue项目中使用echarts做词云图"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-11-27T11:41:55.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="小明记账簿_微信小程序"/> <meta itemprop="url" content="https://juejin.cn/user/1901536389893546"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            vue项目中使用echarts做词云图
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1901536389893546/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    小明记账簿_微信小程序
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-27T11:41:55.000Z" title="Thu Nov 27 2025 11:41:55 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";@keyframes spin{0%{transform:rotate(0)}to{transform:rotate(1turn)}}.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden;color:#36ace1;background-image:linear-gradient(90deg,rgba(217,234,251,.25) 3%,transparent 0),linear-gradient(1turn,rgba(217,234,251,.25) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{color:#36ace1}.markdown-body h1:before,.markdown-body h2:before,.markdown-body h3:before,.markdown-body h4:before,.markdown-body h5:before,.markdown-body h6:before{content:"";display:block;position:absolute;left:0;top:0;bottom:0;margin:auto;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABwAAAAcCAYAAAByDd+UAAAF8UlEQVRIS71Wa2wUVRT+7r0zu9t2t/RBaSioPCpYbIUfaEIQUogSAwZDAlUSGwgg/CBATExMCJH1D2hIfOEjFEUEhViCgBgIUCH44OkjPAMGBVqhpUCfW3Zn5z7MuQOE0hYxMdxJdmd25s53vnO+851leMCLPWA8/CfA2TsvL8n7q+nTFfNLG+4VqInHOeJLDQMzdz/3r4DGGDb9lxu+aPcE7U61JHDMDePcuv0O21ShugOefqDdtBie3Dk6K/O+Ab+qOjJiz7Ahv6c8hbDDwRiQlgYGDOcaWyEcjg8On+j71IpJndjGt9XO+jM7+pkywNvbazIfercieSdoJ4bE5sWjyZqMpDdeaQNXMNC34ME3LV8B56+1w3AOgk+EXe/Ub6uiLB6XdH/G/mYjeBCcFwnt3zQqWt4t4NjjnhzQ1CGkBhwOCMFAB71U0qsYgRlwBtQ1tiEJAy44OBdQUmFK3aWS06NLT+ukZAQoKCCjsfbDmk6p78RwX3ncWffmIj8U4kh6GpEwh+9rGy23LDU4GBrrm9DsuDYIGMAYIC/EUNQ7Cq1hn+WM2TI8f+jEyCmvjfn1FssuojHx6tDkyZOaCzr8TNpASzDAk8amlRIrEylcSGsYrcGIstIYWhgDDIM2BiGH3ywFkGAC1U9n38bpVqWGdk6r4HMWrZZaG1D5KLn0qYyBEAKnG1otAxLR8L7Z9nfP13CJHQ/ST4vK8sVHe8JsU0U6uO5hlexo8PI7vNDQomwoBRAwpSmtgJAAztS3QLsOsmBQlBtFJMQhlbbPUBBUR7o2hqHVddLbRsfCPQJ+u3TPw8uGl1yklAlHIJZKo3//XEhlLCtifPFyM7xwCI/lZ8IKTTBbS7pPLIggZZsSQ+zXbT4UYSsnet3UMM5HPT5LGbrDGYQroClyT2Jwnyj9aN949e8mDCwuRFoqKxRHUJ21BSDRELuQYGhvbMVV32Dp2RuxcfHSRBfAYTsbU9nJdFj5EiLkglHkRInC1xoxKbH9hQJIaTDvxxTCUddWl4wg0dCCtqSPDmoVx4Eitpxh64ZtsT6b5ie6pPRkfF90TllxOzEwmipMKRRgHODGgCuJkqIcvDdC2BZ5Y+tlHHMzkAKghbAxcQqQDiKrFBxhqg5MHTivS1tQ+sdsvaQl5Yd6yfdRXNQLsQwXnq/AQFLXEIIjzBSuNaaR0SuEtkQKl9IKjAsbJaWfzo1USDsM6zceDJfeVGgnhhN2N7YOyo5kJz1pa2AbgfrO1gRwXW6vSRQNtddR+EhvKGmseskgTtY2Q7kucYWWgToPHzyUyXry0iXfnBtfl5f/PaWPvPNW/zkOAQegJHltFE5dSaCskHqPVEnqpMAMEgkPtR1pKxyh/N0/vTToubtH1G3RmLjhM8ubKXfWB2mRa9ySOaWS2uT8lTZ0cI6I52Ngv7zAbW9mQVm1cpytu441P38XeXTlQu+e46nyh+bjLkMZRU0MCYTCJWZSG1y7cBWNURpxBlxqFBfEwGnGGhaYPSNwhpSv4DK+/vPynBk9MqRIiOWs8a2WJTm9a+cgh6SaMIMz9W1WjYHHMtv0wSmZdWB9gdsya/rcYVg7JoffCdqlD6ceTpiY59tM0PhJp5WNvra+BQkejCMyBarr8KKYDcZi8sDaCDKYFIGRk+FnSVXzyTO9JxBwF8DLc1dlLn65ooNEYN0fBsu21fTvL6PXnhxXlnLIqqhYYBian4lQ2Lk9ogiALsimiLC1QYfhlV1Hnxh7JfcMqxrpd7U2GFa5t9nOd7Kr+kg4uWvnCpromlJeXlq3Os3ZLOlrZBmNQf1ybVqpxhbA7mRIOCy1+esDOWhIyDv/+3Q7LRbsqH+rKRJ+nba+/+WW7II1s9vvVBuNr7KNF1WUM1bSt5f1Vq01jUVkKfnx8uoti3Or5rbd9782M61azJz/rFywYU/OyKqK1p5G2MS1Z18tGFDwTkvIxcK9RwaMP3a9/tbc62lPj/Nw5B9ey9Ehy/MY4oEqelgNleuyCgdXJlmc3fO5Ll56r5f+n/f+AWFf9jvBgaHpAAAAAElFTkSuQmCC);animation:spin 2s linear 1s infinite}.markdown-body h1{position:relative;font-size:30px;padding:12px 38px;margin:30px 0}.markdown-body h1:before{width:30px;height:30px;background-size:30px 30px}.markdown-body h2{position:relative;font-size:24px;padding:12px 36px;margin:28px 0}.markdown-body h2:before{width:28px;height:28px;background-size:28px 28px}.markdown-body h3{position:relative;font-size:18px;padding:4px 32px;margin:26px 0}.markdown-body h3:before{width:24px;height:24px;background-size:24px 24px}.markdown-body h4{position:relative;padding:4px 28px;font-size:16px;margin:22px 0}.markdown-body h4:before{width:20px;height:20px;background-size:20px 20px}.markdown-body h5{position:relative;padding:4px 26px;font-size:15px;margin:20px 0}.markdown-body h5:before{width:18px;height:18px;background-size:18px 18px}.markdown-body h6{position:relative;padding:4px 22px;font-size:14px;margin:16px 0}.markdown-body h6:before{width:16px;height:16px;background-size:16px 16px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{position:relative;width:98%;height:1px;border:none;margin-top:32px;margin-bottom:32px;background-image:linear-gradient(90deg,#36ace1,#dff0fe,#36ace1);overflow:visible}.markdown-body hr:after{content:"";position:absolute;margin:auto;left:0;right:0;bottom:0;top:0;display:inline-block;width:50px;height:24px;background:#fff;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABoAAAAaCAYAAACpSkzOAAAEgElEQVRIS72Va0xbZRjH/z2FcimbchEQFDYRCIRAAWFQ2MaCXBwmUxYDLGGEcRFkH9wmk04zG0Bo2dwNIisERANqhjqdEmhd4nRbuwpsXDYWLLoRgeG4Chu9QHvMOQ0dpTAKH3y/tDnv8/5/z/Oc//scBv6nxdgoJ14gVYPEuITHdTdHY12gRIH0T0KljlqwthqUFHGtzAEsxqwLtPvkdc+FeeI3BgMeAMEhdOqR1mM7xswBrgmKE8pfIUhtm7fbZsft/i7wc98MtrUFxmbU6ByYgFwxjtFp5Q+WpF1mCy9wajXoqqD4E91saOf603e+5B7t99xTkyZJEiKJAl2DE9Xio1HvrBS8IuhVwVUP503swdJ9QWAw1izaoDs6pQT/655BMS9yy3KYiUoM/7adu7NmtnQfx5zWm8Q8Ui3gyGcddyU8rv/STRNQouDGP5/mhTubX4dpPv3DMzh1qS9LwuPWr+i63WVyn5QYj/4d/i4bqmbpoQ+auvBlQYghX6PE4wTSOzV5EUYlb5Q4MDqLk9/3cMRF27spDSNQamUnWZ4ebNB+OKNCyYVeFCZ5wZ5tiePN/UiP2YoQL0cUX+iFt4sNUiLdcaVvHJLecQiWnKVE8s5LvxAXRWeYgHLre0hecgAN0sxr0XBZgbJUP6OiLnaM4ivZCBrzOWBZEIY9rY5E8pl2nM0KMzzLq5aPiXmRzgbQm2VyR8KGGK/ICAFB6IusbvsDwhRf+n/jtSHc/nsGgjR9V6/1TyLa1wGU+FtnO1CbHQTHTSzIFJOYJ1jwcGLTccMTcyhp7oW4KFJ/SV4/IScrc55kQj07WNuOn94Lpw8kCm/Qv3W5HLjbWxsyfuNUO1TzWjAJBloKt2FBS+Jz6ShiA12NupBdLWugQcmn28lPMkONNql3U5cTSD9Lq+qEUqPFt++G0aKL687wDAqb+pAU7IKCuK2493AOPQ9UCNpib6T1tkg+RZ9KKJcNn8sJc1vac8o16jklLWLuOiDqwvHUIKPw7vtTON+iCDKkl/Cx9FeSYET5um1mHt6jN0Dz9ftwYjORudNjTdaBmi7kxvvA1d6Gjs0X/Q5Sp3tMEMSHre9HnDEZAPFCWUNVdliGJVPvqEP1Hbh4yPj9LadSY6fu6gPsCX+B3mq7NYLv2od8fj4aoViMNQGFijos/XVMTXGavgUisQIle71hwVx9KFEutLVjw8GORTuxoEbeJS7iPrmQyy/sIj2hQpqYHO7ZGs95nnZS4y8K8Pfqrb58UZ+IlKqbqNgfQm8da+pC9xjLqo8foFkau2qaCeXSyvzXfA9SDrp1bxJ/DU/jSJKXEWdBR2J/9U0UpwXTFZ/+8S76h/71FvO4A8sTeuqQThDKalOiPLN3BbhiYlaNsm964elkCztrC4xMqeDqYIus2JdB3cbS5l4MTag44qJt9GxbF4gKThRKY59lW13+KCUQ1pZMEwHKviKx4pFSqXzxCn/X9Gr2NO+zw+cTiTbxmUyCqH3GlsWg2kRNhOnHmhlrFkIvHTZt1borWvMCmRnwH4usn58STiycAAAAAElFTkSuQmCC);background-repeat:no-repeat;background-size:auto 100%;background-position-x:center}.markdown-body del{color:#36ace1}.markdown-body code{font-family:Menlo,Monaco,Consolas,Courier New,monospace;word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#282c34;color:#4ec9b0;padding:.24em .46em;margin:0 4px}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-family:Menlo,Monaco,Consolas,Courier New,monospace;font-size:12px;border-radius:10px;padding:15px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#4ec9b0;background:#282c34}.markdown-body a{text-decoration:none;color:#409eff;border-bottom:1px solid #409eff}.markdown-body a:active,.markdown-body a:hover{color:#007bff;border-bottom:1px solid #007bff}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{position:relative;padding:8px 26px;background-color:rgba(54,172,225,.75);margin:16px 0;border-left:4px solid #409eff;border-radius:5px}.markdown-body blockquote:before{content:"❝";top:10px;left:8px;color:#409eff;font-size:20px;line-height:1;font-weight:700;position:absolute;opacity:.7}.markdown-body blockquote:after{content:"❞";font-size:20px;position:absolute;right:8px;bottom:0;color:#409eff;opacity:.7}.markdown-body blockquote&gt;p{color:#fff}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/dc8363689561412398bfd4694b8f9ec3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5piO6K6w6LSm57C_X-W-ruS_oeWwj-eoi-W6jw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764848514&amp;x-signature=jglucbl%2BumMP78lQGcFIBvbMj%2FA%3D" alt="" loading="lazy"/></p>
<blockquote>
<p>安装依赖 </p>
</blockquote>
<pre><code class="hljs language-js" lang="js">npm install echarts
npm i echarts-wordcloud
</code></pre>
<blockquote>
<p>完整代码</p>
</blockquote>
<pre><code class="hljs language-js" lang="js">&lt;template&gt;
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"chart-container"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
&lt;/template&gt;

<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">import</span> * <span class="hljs-keyword">as</span> echarts <span class="hljs-keyword">from</span> <span class="hljs-string">"echarts"</span>;
<span class="hljs-keyword">import</span> <span class="hljs-string">"echarts-wordcloud"</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-title function_">data</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> {
      <span class="hljs-attr">chart</span>: <span class="hljs-literal">null</span>,
    };
  },
  <span class="hljs-title function_">mounted</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">initChart</span>();
  },
  <span class="hljs-title function_">beforeDestroy</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-property">chart</span>) {
      <span class="hljs-keyword">return</span>;
    }
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">chart</span>.<span class="hljs-title function_">dispose</span>();
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">chart</span> = <span class="hljs-literal">null</span>;
  },
  <span class="hljs-attr">methods</span>: {
    <span class="hljs-title function_">initChart</span>(<span class="hljs-params"/>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">chart</span> = echarts.<span class="hljs-title function_">init</span>(<span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">"chart-container"</span>));
      <span class="hljs-keyword">var</span> keywords = [];
      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> index = <span class="hljs-number">0</span>; index &lt; <span class="hljs-number">20</span>; index++) {
        <span class="hljs-keyword">let</span> random = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">floor</span>(<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() * <span class="hljs-number">100</span>);
        keywords.<span class="hljs-title function_">push</span>({
          <span class="hljs-attr">name</span>: random,
          <span class="hljs-attr">value</span>: random,
        });
      }
      <span class="hljs-keyword">var</span> option = {
        <span class="hljs-attr">series</span>: [
          {
            <span class="hljs-attr">type</span>: <span class="hljs-string">"wordCloud"</span>,
            <span class="hljs-attr">sizeRange</span>: [<span class="hljs-number">12</span>, <span class="hljs-number">60</span>],
            <span class="hljs-attr">rotationRange</span>: [-<span class="hljs-number">90</span>, <span class="hljs-number">90</span>],
            <span class="hljs-attr">rotationStep</span>: <span class="hljs-number">45</span>,
            <span class="hljs-attr">gridSize</span>: <span class="hljs-number">15</span>,
            <span class="hljs-attr">shape</span>: <span class="hljs-string">"pentagon"</span>,
            <span class="hljs-attr">width</span>: <span class="hljs-string">"100%"</span>,
            <span class="hljs-attr">height</span>: <span class="hljs-string">"100%"</span>,
            <span class="hljs-attr">drawOutOfBound</span>: <span class="hljs-literal">true</span>,
            <span class="hljs-attr">textStyle</span>: {
              <span class="hljs-attr">color</span>: <span class="hljs-keyword">function</span> (<span class="hljs-params"/>) {
                <span class="hljs-keyword">return</span> (
                  <span class="hljs-string">"rgb("</span> +
                  [
                    <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">round</span>(<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() * <span class="hljs-number">160</span>),
                    <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">round</span>(<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() * <span class="hljs-number">160</span>),
                    <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">round</span>(<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() * <span class="hljs-number">160</span>),
                  ].<span class="hljs-title function_">join</span>(<span class="hljs-string">","</span>) +
                  <span class="hljs-string">")"</span>
                );
              },
            },
            <span class="hljs-attr">emphasis</span>: {
              <span class="hljs-attr">textStyle</span>: {
                <span class="hljs-attr">shadowBlur</span>: <span class="hljs-number">10</span>,
                <span class="hljs-attr">shadowColor</span>: <span class="hljs-string">"#333"</span>,
                <span class="hljs-attr">color</span>: <span class="hljs-string">"red"</span>,
              },
            },
            <span class="hljs-attr">data</span>: keywords,
          },
        ],
      };
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">chart</span>.<span class="hljs-title function_">setOption</span>(option);
    },
  },
};
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></span>
<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">style</span> <span class="hljs-attr">scoped</span>&gt;</span><span class="css">
<span class="hljs-selector-id">#chart-container</span> {
  <span class="hljs-attribute">height</span>: <span class="hljs-number">100%</span>;
}
</span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span></span>
</code></pre>
<blockquote>
<p>配置说明</p>
<p> <strong>shape</strong>：要绘制的“云”的形状。可以是表示为回调函数或存在的关键字。可用的礼物是circle</p>
<p>（默认），cardioid（苹果或心形曲线，最著名的极坐标方程），diamond(正方形）、triangle-forward、triangle（三角形）、star（星形）、pentagon （五边形）。</p>
<p><strong>maskImage</strong>：词云轮廓图，图片需转成base64。</p>
<p><strong>left、top、right、bottom</strong>：词云的位置，默认是 center。</p>
<p><strong>width、height</strong>：词云的宽高，默认是 75%、80%。</p>
<p><strong>sizeRange</strong>：词云的文字字号范围，默认是[12, 60]。</p>
<p><strong>rotationRange</strong>：文本旋转范围和步长。文本将通过旋转步骤45在[-90，90]范围内随机旋转。</p>
<p><strong>gridSize</strong>：每个词之间的间距。</p>
<p><strong>drawOutOfBound</strong>：是否允许词云在边界外渲染。</p>
<p><strong>textStyle</strong>：全局文本样式。</p>
<p><strong>emphasis</strong>：鼠标悬浮样式。</p>
<p><strong>data</strong>：数组，必须包含name、value属性，也可以有textStyle、emphasis等 <strong>。</strong></p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item>  </channel></rss>