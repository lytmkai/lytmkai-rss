<?xml version="1.0" encoding="UTF-8"?><rss version="2.0">  <channel>      <title>掘金文章推荐</title>      <link>https://juejin.cn/recommended?sort=newest</link>      <description>一个帮助开发者成长的社区</description>      <generator>python juejin_recom.py @Pi20</generator>      <item>    <title><![CDATA[mysql在查询的时候走索引比不走索引一定快吗？]]></title>    <link>https://juejin.cn/post/7575807729722753058</link>    <guid>https://juejin.cn/post/7575807729722753058</guid>    <pubDate>2025-11-23T14:06:17.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7575807729722753058" data-draft-id="7575363120798597120" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="mysql在查询的时候走索引比不走索引一定快吗？"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-11-23T14:06:17.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="随风飘的云"/> <meta itemprop="url" content="https://juejin.cn/user/361110952753560"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            mysql在查询的时候走索引比不走索引一定快吗？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/361110952753560/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    随风飘的云
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-23T14:06:17.000Z" title="Sun Nov 23 2025 14:06:17 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    4
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>索引的核心价值是<strong>减少数据库扫描的数据量</strong>，从而提升查询效率，但这并非绝对规律。当索引的 “额外开销” 超过其 “扫描优化收益” 时，走索引反而会比全表扫描更慢。</p>
<h2 data-id="heading-0">一、核心前提：索引的 “收益” 与 “开销”</h2>
<p>要理解 “走索引不一定快”，首先要明确索引的本质是「trade-off」（权衡）：</p>
<h3 data-id="heading-1">1. 索引的 “收益”</h3>
<ul>
<li>减少扫描行数：通过索引树快速定位目标数据，避免全表遍历（如千万级表中查询 1 条数据，索引可直接命中，扫描行数 = 1）；</li>
<li>避免排序 / 临时表：若<code>ORDER BY</code>/<code>GROUP BY</code>字段在索引中，可直接利用索引顺序，避免<code>Using filesort</code>/<code>Using temporary</code>。</li>
</ul>
<h3 data-id="heading-2">2. 索引的 “开销”</h3>
<ul>
<li>索引维护开销：索引是独立的数据结构（如 B + 树），查询时需先遍历索引树，再通过索引指向的 “行指针” 回表查询完整数据（聚簇索引除外）；</li>
<li>IO 开销：索引文件会占用额外磁盘空间，查询时需读取索引文件 + 数据文件（全表扫描仅需读取数据文件）；</li>
<li>优化器判断开销：数据库优化器需计算 “走索引的成本” 和 “全表扫描的成本”，再选择更优方案（若统计信息过时，可能误判）。</li>
</ul>
<p>当「开销 &gt; 收益」时，走索引会更慢；只有当「收益 &gt; 开销」时，索引才能发挥作用。</p>
<h2 data-id="heading-3">二、走索引比全表扫描慢的 5 种典型场景（含原理 + 案例）</h2>
<h3 data-id="heading-4">场景 1：查询数据量占比极高（高选择性差）</h3>
<h4 data-id="heading-5">核心逻辑：</h4>
<p>索引的优势在 “过滤少量数据”，若查询需要返回表中<strong>大部分数据</strong>（如 30% 以上），索引的 “减少扫描行数” 收益会完全抵消，而 “索引遍历 + 回表” 的开销会凸显。</p>
<ul>
<li>全表扫描：数据库采用「顺序 IO」读取数据（机械硬盘 / SSD 的顺序 IO 效率远高于随机 IO），无需额外遍历索引；</li>
<li>走索引：需先遍历索引树（随机 IO），再根据索引中的行指针回表读取数据（多次随机 IO），总 IO 开销反而更大。</li>
</ul>
<h4 data-id="heading-6">案例（MySQL InnoDB）：</h4>
<p>假设有一张<code>user</code>表（100 万行数据），查询 “所有年龄大于 18 岁的用户”（占比约 80%）：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 场景：age字段有索引，但查询数据占比80%</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> <span class="hljs-keyword">user</span> <span class="hljs-keyword">WHERE</span> age <span class="hljs-operator">&gt;</span> <span class="hljs-number">18</span>;
</code></pre>
<ul>
<li>走索引：遍历索引树找到所有满足<code>age&gt;18</code>的行指针（80 万条），再逐行回表读取完整数据（80 万次随机 IO）；</li>
<li>全表扫描：顺序读取整个数据文件（1 次连续 IO），直接过滤数据。此时优化器会自动选择全表扫描，而非走索引。</li>
</ul>
<h4 data-id="heading-7">关键概念：索引选择性</h4>
<ul>
<li>选择性 = 字段唯一值数量 / 总记录数（选择性越高，索引越有用）；</li>
<li>例：<code>id</code>（主键，选择性 = 100%）&gt; <code>phone</code>（唯一索引，选择性≈99%）&gt; <code>age</code>（选择性≈10%）&gt; <code>gender</code>（性别，选择性≈2%）；</li>
<li>低选择性字段（如<code>gender</code>）：即使查询占比 20%，走索引也可能比全表扫描慢。</li>
</ul>
<h3 data-id="heading-8">场景 2：表数据量极小（如几百行）</h3>
<h4 data-id="heading-9">核心逻辑：</h4>
<p>小表的全表扫描开销极低（如 100 行数据，全表扫描仅需读取 1 个数据页），而索引的 “遍历索引树 + 回表” 开销相对更高，完全没必要走索引。</p>
<h4 data-id="heading-10">案例：</h4>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 表：user_small（仅50行数据，age有索引）</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> user_small <span class="hljs-keyword">WHERE</span> age <span class="hljs-operator">=</span> <span class="hljs-number">25</span>;
</code></pre>
<ul>
<li>全表扫描：直接读取 1 个数据页（InnoDB 默认页大小 16KB），遍历 50 行数据，耗时 &lt; 1ms；</li>
<li>走索引：先读取索引页（1 个），找到<code>age=25</code>的行指针，再回表读取数据页（1 个），总 IO 次数与全表扫描相同，但多了索引树遍历的逻辑开销。优化器会直接选择全表扫描，忽略索引。</li>
</ul>
<h3 data-id="heading-11">场景 3：索引失效导致 “伪走索引”</h3>
<h4 data-id="heading-12">核心逻辑：</h4>
<p>看似 “走了索引”，但实际是「全索引扫描」（<code>type=index</code>），而非「索引精准命中」（<code>type=ref/range</code>）。全索引扫描需要遍历整个索引树，若索引文件比数据文件更大，耗时会超过全表扫描。</p>
<h4 data-id="heading-13">典型案例（索引失效场景）：</h4>
<ol>
<li>
<p>索引字段被函数操作（如<code>DATE(create_time)</code>）：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- create_time有索引，但函数操作导致索引失效，实际走全索引扫描</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> <span class="hljs-keyword">order</span> <span class="hljs-keyword">WHERE</span> <span class="hljs-type">DATE</span>(create_time) <span class="hljs-operator">=</span> <span class="hljs-string">'2025-11-23'</span>;
</code></pre>
</li>
<li>
<p>隐式类型转换（如<code>phone</code>是<code>INT</code>，查询用字符串）：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- phone是INT类型，'13800138000'是字符串，隐式转换导致索引失效</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> <span class="hljs-keyword">user</span> <span class="hljs-keyword">WHERE</span> phone <span class="hljs-operator">=</span> <span class="hljs-string">'13800138000'</span>;
</code></pre>
</li>
<li>
<p>联合索引不满足最左前缀原则：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 联合索引：idx_age_name(age, name)，查询无age，仅查name</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> <span class="hljs-keyword">user</span> <span class="hljs-keyword">WHERE</span> name <span class="hljs-operator">=</span> <span class="hljs-string">'张三'</span>; <span class="hljs-comment">-- 走全索引扫描（type=index）</span>
</code></pre>
</li>
</ol>
<h4 data-id="heading-14">对比：</h4>
<ul>
<li>全索引扫描（<code>type=index</code>）：遍历整个索引树（如索引文件 100MB），耗时久；</li>
<li>全表扫描（<code>type=ALL</code>）：遍历数据文件（如数据文件 80MB），耗时更短。</li>
</ul>
<h3 data-id="heading-15">场景 4：需要 “回表” 且数据分散</h3>
<h4 data-id="heading-16">核心逻辑：</h4>
<p>非聚簇索引（如普通索引、联合索引）的叶子节点存储的是「主键值」，而非完整数据。查询时需先通过索引找到主键，再到聚簇索引（主键索引）中查询完整数据，这个过程叫「回表」。若查询的数据分散在表中多个数据页，回表会产生大量「随机 IO」（每个数据页需单独读取），而全表扫描是「顺序 IO」（连续读取数据页），效率更高。</p>
<h4 data-id="heading-17">案例：</h4>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 表：order（10万行，普通索引idx_user_id(user_id)，非聚簇索引）</span>
<span class="hljs-comment">-- 查询：用户ID在100-200之间的所有订单（共5000条，分散在100个数据页）</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> <span class="hljs-keyword">order</span> <span class="hljs-keyword">WHERE</span> user_id <span class="hljs-keyword">BETWEEN</span> <span class="hljs-number">100</span> <span class="hljs-keyword">AND</span> <span class="hljs-number">200</span>;
</code></pre>
<ul>
<li>走索引：遍历 idx_user_id 找到 5000 个主键→回表查询 100 个数据页（100 次随机 IO）；</li>
<li>全表扫描：顺序读取 50 个数据页（覆盖所有目标数据），1 次连续 IO。此时随机 IO 的开销远大于顺序 IO，走索引更慢。</li>
</ul>
<h3 data-id="heading-18">场景 5：写入操作（INSERT/UPDATE/DELETE）—— 索引反而拖慢速度</h3>
<h4 data-id="heading-19">核心逻辑：</h4>
<p>索引对「查询」是优化，但对「写入」是负担。写入时，数据库不仅要修改数据文件，还要同步维护所有相关索引（如 B + 树的分裂、合并、排序），索引越多，写入开销越大。</p>
<h4 data-id="heading-20">案例：</h4>
<p>一张表有 5 个索引，插入 1 条数据时：</p>
<ul>
<li>无索引：仅需在数据文件末尾插入（或指定位置修改），耗时 1ms；</li>
<li>有索引：需修改 5 个索引树（每个索引树都要找到对应位置插入 / 更新），耗时 5ms+。此时索引越多，写入越慢，甚至可能导致锁等待时间延长。</li>
</ul>
<h2 data-id="heading-21">三、数据库优化器的 “决策逻辑”：何时选择走索引 / 全表扫描？</h2>
<p>数据库不会盲目走索引，而是通过「成本计算」决定最优方案（以 MySQL 为例）：</p>
<h3 data-id="heading-22">1. 优化器的 “成本模型”</h3>
<ul>
<li>全表扫描成本 = 数据文件大小 × 每页 IO 成本 + 扫描行数 × 行过滤成本；</li>
<li>走索引成本 = 索引文件大小 × 每页 IO 成本 + 索引扫描行数 × 行过滤成本 + 回表行数 × 回表成本。</li>
</ul>
<p>优化器会对比两者成本，选择成本更低的方案。</p>
<h3 data-id="heading-23">2. 影响决策的关键因素</h3>
<ul>
<li>统计信息：数据库会记录表的行数、数据页数量、索引选择性等统计信息（通过<code>ANALYZE TABLE</code>更新），统计信息过时会导致误判；</li>
<li>查询条件：<code>WHERE</code>子句的过滤条件（如<code>=</code>vs<code>&gt;</code>）、返回字段（<code>SELECT *</code>vs<code>SELECT 主键</code>）；</li>
<li>索引类型：聚簇索引（无需回表）比非聚簇索引更易被选择，覆盖索引（无需回表）成本最低。</li>
</ul>
<h4 data-id="heading-24">例子：统计信息过时导致的误判</h4>
<p>若表中实际数据 100 万行，但统计信息显示仅 1 万行，优化器可能误判 “走索引成本更低”，但实际查询时回表开销极大，导致走索引比全表扫描慢。此时需执行<code>ANALYZE TABLE 表名</code>更新统计信息。</p>
<h2 data-id="heading-25">四、面试高频考点：如何判断 “是否该走索引”？（实用技巧）</h2>
<ol>
<li>
<p><strong>看查询数据占比</strong>：返回数据占比 &lt;10%→走索引；占比&gt; 30%→全表扫描更优；</p>
</li>
<li>
<p><strong>看索引选择性</strong>：选择性 &gt; 30%→索引有用；选择性 &lt; 10%→低选择性字段（如性别），走索引可能更慢；</p>
</li>
<li>
<p><strong>看是否回表</strong>：覆盖索引（查询字段均在索引中）→ 必走索引（无回表开销）；<code>SELECT *</code>+ 非聚簇索引→ 需回表，需评估成本；</p>
</li>
<li>
<p><strong>用 EXPLAIN 验证</strong>：</p>
<ul>
<li><code>type</code>字段：<code>ref</code>/<code>range</code>→ 有效索引（快）；<code>index</code>→ 全索引扫描（可能比<code>ALL</code>慢）；</li>
<li><code>rows</code>字段：预估扫描行数越少，走索引越优；</li>
<li><code>Extra</code>字段：<code>Using index</code>（覆盖索引，最优）、<code>Using index condition</code>（ICP 优化，较优）。</li>
</ul>
</li>
</ol>
<h2 data-id="heading-26">五、总结：核心原则与避坑指南</h2>
<h3 data-id="heading-27">1. 核心结论</h3>
<ul>
<li>走索引不一定比全表扫描快，关键看「收益（减少扫描行数）是否大于开销（索引遍历 + 回表）」；</li>
<li>索引的价值是 “过滤少量、高选择性数据”，而非 “万能优化”。</li>
</ul>
<h3 data-id="heading-28">2. 避坑指南</h3>
<ul>
<li>避免给低选择性字段建索引（如性别、状态），反而会拖慢写入和查询；</li>
<li>小表无需建索引（全表扫描效率足够），索引只会增加维护开销；</li>
<li>避免<code>SELECT *</code>：优先用覆盖索引（查询字段 = 索引字段），减少回表开销；</li>
<li>定期更新统计信息（<code>ANALYZE TABLE</code>），避免优化器误判；</li>
<li>用<code>EXPLAIN</code>分析执行计划，若发现<code>type=index</code>但<code>rows</code>极大，可能是全索引扫描，需优化查询或索引。</li>
</ul>
<h3 data-id="heading-29">3. 一句话记忆</h3>
<p>「索引适合 “精准打击”（少量数据、高选择性），全表扫描适合 “地毯式搜索”（大量数据、低选择性）」。</p>
<h2 data-id="heading-30">面试真题演练</h2>
<h3 data-id="heading-31">问题 1：为什么查询 “性别 = 男” 时，优化器选择全表扫描而非走索引？</h3>
<p>答：因为 “性别” 是低选择性字段（选择性≈2%），查询数据占比高（约 50%）。走索引需遍历索引树 + 大量回表（随机 IO），而全表扫描是顺序 IO，成本更低，因此优化器选择全表扫描。</p>
<h3 data-id="heading-32">问题 2：小表（100 行）中，给<code>name</code>字段建索引，查询<code>SELECT * FROM 表 WHERE name='张三'</code>，会走索引吗？</h3>
<p>答：大概率不会。小表全表扫描仅需读取 1 个数据页，开销极低；走索引需遍历索引树 + 回表，额外开销超过收益，优化器会选择全表扫描。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[结合Condition实现生产者与消费者示例，来进一步分析AbstractQueuedSynchronizer的内部工作机制]]></title>    <link>https://juejin.cn/post/7575182522411810854</link>    <guid>https://juejin.cn/post/7575182522411810854</guid>    <pubDate>2025-11-23T14:19:56.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7575182522411810854" data-draft-id="7575182522411794470" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="结合Condition实现生产者与消费者示例，来进一步分析AbstractQueuedSynchronizer的内部工作机制"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-11-23T14:19:56.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="kevinzeng"/> <meta itemprop="url" content="https://juejin.cn/user/1964143993949127"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            结合Condition实现生产者与消费者示例，来进一步分析AbstractQueuedSynchronizer的内部工作机制
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1964143993949127/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    kevinzeng
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-23T14:19:56.000Z" title="Sun Nov 23 2025 14:19:56 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    6
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">生产者 - 消费者示例代码</h2>
<p>我们将创建一个有界缓冲区（Bounded Buffer），生产者线程向缓冲区中放入数据，消费者线程从中取出数据。当缓冲区满时，生产者会被阻塞；当缓冲区空时，消费者会被阻塞。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> java.util.LinkedList;
<span class="hljs-keyword">import</span> java.util.Queue;
<span class="hljs-keyword">import</span> java.util.concurrent.locks.Condition;
<span class="hljs-keyword">import</span> java.util.concurrent.locks.ReentrantLock;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BoundedBuffer</span>&lt;T&gt; {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Queue&lt;T&gt; queue;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> capacity;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> ReentrantLock lock;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Condition notFull;  <span class="hljs-comment">// 条件：缓冲区未满</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Condition notEmpty; <span class="hljs-comment">// 条件：缓冲区未空</span>

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">BoundedBuffer</span><span class="hljs-params">(<span class="hljs-type">int</span> capacity)</span> {
        <span class="hljs-built_in">this</span>.capacity = capacity;
        <span class="hljs-built_in">this</span>.queue = <span class="hljs-keyword">new</span> <span class="hljs-title class_">LinkedList</span>&lt;&gt;();
        <span class="hljs-built_in">this</span>.lock = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ReentrantLock</span>();
        <span class="hljs-built_in">this</span>.notFull = lock.newCondition();
        <span class="hljs-built_in">this</span>.notEmpty = lock.newCondition();
    }

    <span class="hljs-comment">// 生产者放入数据</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">put</span><span class="hljs-params">(T item)</span> <span class="hljs-keyword">throws</span> InterruptedException {
        lock.lock(); <span class="hljs-comment">// 1. 获取独占锁</span>
        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// 2. 检查条件，如果缓冲区已满，则等待</span>
            <span class="hljs-keyword">while</span> (queue.size() == capacity) {
                System.out.println(Thread.currentThread().getName() + <span class="hljs-string">"：缓冲区已满，等待消费者消费..."</span>);
                notFull.await(); <span class="hljs-comment">// 3. 释放锁并阻塞当前线程</span>
            }

            <span class="hljs-comment">// 4. 条件满足，执行生产操作</span>
            queue.add(item);
            System.out.println(Thread.currentThread().getName() + <span class="hljs-string">"：生产了 "</span> + item + <span class="hljs-string">"，当前缓冲区大小："</span> + queue.size());

            <span class="hljs-comment">// 5. 唤醒等待"非空"条件的消费者线程</span>
            notEmpty.signal();
        } <span class="hljs-keyword">finally</span> {
            lock.unlock(); <span class="hljs-comment">// 6. 释放锁</span>
        }
    }

    <span class="hljs-comment">// 消费者取出数据</span>
    <span class="hljs-keyword">public</span> T <span class="hljs-title function_">take</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> InterruptedException {
        lock.lock(); <span class="hljs-comment">// 1. 获取独占锁</span>
        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// 2. 检查条件，如果缓冲区为空，则等待</span>
            <span class="hljs-keyword">while</span> (queue.isEmpty()) {
                System.out.println(Thread.currentThread().getName() + <span class="hljs-string">"：缓冲区为空，等待生产者生产..."</span>);
                notEmpty.await(); <span class="hljs-comment">// 3. 释放锁并阻塞当前线程</span>
            }

            <span class="hljs-comment">// 4. 条件满足，执行消费操作</span>
            <span class="hljs-type">T</span> <span class="hljs-variable">item</span> <span class="hljs-operator">=</span> queue.poll();
            System.out.println(Thread.currentThread().getName() + <span class="hljs-string">"：消费了 "</span> + item + <span class="hljs-string">"，当前缓冲区大小："</span> + queue.size());

            <span class="hljs-comment">// 5. 唤醒等待"非满"条件的生产者线程</span>
            notFull.signal();

            <span class="hljs-keyword">return</span> item;
        } <span class="hljs-keyword">finally</span> {
            lock.unlock(); <span class="hljs-comment">// 6. 释放锁</span>
        }
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        BoundedBuffer&lt;Integer&gt; buffer = <span class="hljs-keyword">new</span> <span class="hljs-title class_">BoundedBuffer</span>&lt;&gt;(<span class="hljs-number">5</span>);

        <span class="hljs-comment">// 启动3个生产者线程</span>
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">3</span>; i++) {
            <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">producerId</span> <span class="hljs-operator">=</span> i;
            <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(() -&gt; {
                <span class="hljs-keyword">try</span> {
                    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">j</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; j &lt; <span class="hljs-number">5</span>; j++) {
                        <span class="hljs-type">int</span> <span class="hljs-variable">item</span> <span class="hljs-operator">=</span> producerId * <span class="hljs-number">100</span> + j;
                        buffer.put(item);
                        Thread.sleep(<span class="hljs-number">100</span>); <span class="hljs-comment">// 模拟生产耗时</span>
                    }
                } <span class="hljs-keyword">catch</span> (InterruptedException e) {
                    Thread.currentThread().interrupt();
                }
            }, <span class="hljs-string">"生产者-"</span> + i).start();
        }

        <span class="hljs-comment">// 启动2个消费者线程</span>
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">2</span>; i++) {
            <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">consumerId</span> <span class="hljs-operator">=</span> i;
            <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(() -&gt; {
                <span class="hljs-keyword">try</span> {
                    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">j</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; j &lt; <span class="hljs-number">7</span>; j++) {
                        buffer.take();
                        Thread.sleep(<span class="hljs-number">150</span>); <span class="hljs-comment">// 模拟消费耗时</span>
                    }
                } <span class="hljs-keyword">catch</span> (InterruptedException e) {
                    Thread.currentThread().interrupt();
                }
            }, <span class="hljs-string">"消费者-"</span> + i).start();
        }
    }
}
</code></pre>
<h4 data-id="heading-1">AQS 内部工作机制分析</h4>
<p><code>ReentrantLock</code> 和 <code>Condition</code> 都是基于 AQS 实现的。我们来分步解析上述代码中 AQS 的工作流程。</p>
<h5 data-id="heading-2">1. <code>lock.lock()</code> - 获取独占锁</h5>
<p>当一个线程调用 <code>lock.lock()</code> 时，它实际上是在调用 AQS 的 <code>acquire(1)</code> 方法。</p>
<ul>
<li>
<p><strong>AQS 状态 (<code>state</code>)</strong> :</p>
<ul>
<li>
<p><code>state</code> 初始值为 0，表示锁未被持有。</p>
</li>
<li>
<p>第一个线程调用 <code>tryAcquire(1)</code>（由 <code>ReentrantLock</code> 实现）：</p>
<ul>
<li>它会检查 <code>state</code> 是否为 0。</li>
<li>如果是，它会使用 CAS (Compare-and-Swap) 操作将 <code>state</code> 从 0 修改为 1。</li>
<li>如果 CAS 成功，它会将 <code>exclusiveOwnerThread</code>（AQS 的一个属性）设置为当前线程，表示当前线程已获取锁。</li>
</ul>
</li>
</ul>
</li>
<li>
<p><strong>如果获取成功</strong>：线程继续执行 <code>put</code> 或 <code>take</code> 方法的后续逻辑。</p>
</li>
<li>
<p><strong>如果获取失败</strong>（即 <code>state</code> 不为 0，且持有锁的不是当前线程）：</p>
<ul>
<li>AQS 会创建一个<strong>独占模式</strong>的 <code>Node</code> 对象，将当前线程封装进去。</li>
<li>这个 <code>Node</code> 会被加入到 AQS 内部维护的一个<strong>FIFO 阻塞队列</strong>（CLH 队列）的尾部。</li>
<li>然后，当前线程会调用 <code>LockSupport.park()</code> 方法将自己阻塞。</li>
</ul>
</li>
</ul>
<h5 data-id="heading-3">2. <code>condition.await()</code> - 等待条件</h5>
<p>当线程获取锁后，进入 <code>put</code> 或 <code>take</code> 方法，发现条件不满足（如缓冲区满或空），它会调用 <code>condition.await()</code>。</p>
<ul>
<li>
<p><strong>创建条件队列节点</strong>:</p>
<ul>
<li><code>Condition</code> 对象内部也维护着一个<strong>条件队列</strong>。这个队列和 AQS 的主阻塞队列是分开的。</li>
<li><code>await()</code> 方法会创建一个新的 <code>Node</code>（其 <code>waitStatus</code> 为 <code>Node.CONDITION</code>），并将当前线程放入这个条件队列中。</li>
</ul>
</li>
<li>
<p><strong>释放锁</strong>:</p>
<ul>
<li>这是关键一步。<code>await()</code> 会调用 AQS 的 <code>release(1)</code> 方法，<strong>释放当前线程持有的锁</strong>。</li>
<li><code>release</code> 方法会调用 <code>tryRelease(1)</code>（由 <code>ReentrantLock</code> 实现），将 <code>state</code> 从 1 减回 0，并清空 <code>exclusiveOwnerThread</code>。</li>
<li>然后，它会检查 AQS 主队列是否为空。如果不为空，它会唤醒队列头部的线程，让它有机会去竞争锁。</li>
</ul>
</li>
<li>
<p><strong>阻塞线程</strong>:</p>
<ul>
<li>在释放锁之后，调用 <code>await()</code> 的线程会再次调用 <code>LockSupport.park()</code> 将自己阻塞。此时，它等待的不再是锁，而是等待其他线程的唤醒信号。</li>
</ul>
</li>
</ul>
<h5 data-id="heading-4">3. <code>condition.signal()</code> - 唤醒等待条件的线程</h5>
<p>当另一个线程（比如消费者）执行了 <code>notFull.signal()</code> 或 <code>notEmpty.signal()</code> 时：</p>
<ul>
<li>
<p><strong>从条件队列转移到主队列</strong>:</p>
<ul>
<li><code>signal()</code> 方法会从它的条件队列中取出一个等待最久的 <code>Node</code>（通常是头部节点）。</li>
<li>它会将这个 <code>Node</code> 的状态从 <code>Node.CONDITION</code> 改变为 <code>Node.SIGNAL</code>。</li>
<li>然后，这个 <code>Node</code> 会被<strong>转移</strong>到 AQS 的<strong>主阻塞队列</strong>的尾部。</li>
</ul>
</li>
<li>
<p><strong>等待再次竞争锁</strong>:</p>
<ul>
<li>被转移的线程此时仍然是阻塞状态。它需要等待主队列中排在它前面的线程都处理完，并且当它自己成为队列头部时，才有机会被唤醒，重新去竞争锁。</li>
</ul>
</li>
</ul>
<h5 data-id="heading-5">4. <code>lock.unlock()</code> - 释放锁</h5>
<p>当线程完成 <code>put</code> 或 <code>take</code> 操作后，会在 <code>finally</code> 块中调用 <code>lock.unlock()</code>。</p>
<ul>
<li>这同样会调用 AQS 的 <code>release(1)</code> 方法。</li>
<li><code>tryRelease(1)</code> 会减少 <code>state</code>。对于非重入锁，<code>state</code> 变为 0。</li>
<li>AQS 会检查主阻塞队列。如果队列不为空，它会唤醒队列头部的线程，让它尝试获取锁。</li>
</ul>
<h4 data-id="heading-6">总结：AQS 的核心角色</h4>
<p>在这个生产者 - 消费者示例中，AQS 扮演了以下几个关键角色：</p>
<ol>
<li><strong>同步状态管理器 (<code>state</code>)</strong> : 通过一个简单的整数 <code>state</code> 和 CAS 操作，高效地管理锁的获取与释放。</li>
<li><strong>独占锁持有者记录器 (<code>exclusiveOwnerThread</code>)</strong> : 记录当前持有独占锁的线程，用于实现重入和锁释放的正确性。</li>
<li><strong>线程阻塞队列 (CLH Queue)</strong> : 当线程获取锁失败时，AQS 将其封装成 <code>Node</code> 放入此队列，并阻塞线程。这是线程的 “候客厅”。</li>
<li><strong>条件变量支持</strong>: <code>Condition</code> 对象利用 AQS 的基础功能，实现了独立的条件等待队列。它允许线程在某个条件不满足时，暂时放弃锁并等待，直到被其他线程唤醒。</li>
</ol>
<p>整个过程就像是：</p>
<ul>
<li><strong>线程</strong>是想要进入房间（临界区）的人。</li>
<li><strong>AQS 的 <code>state</code></strong> 是房间的钥匙。</li>
<li><strong>AQS 主队列</strong>是房间外的等候队伍。</li>
<li><strong><code>Condition</code> 的条件队列</strong>是一个特殊的休息室，当房间里的人发现 “咖啡还没煮好”（条件不满足），他会暂时把钥匙还给前台（释放锁），然后去休息室等待，直到有人通知他 “咖啡煮好了”（<code>signal</code>），他才会回到等候队伍的末尾，重新排队等待进入房间。</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[前端卷Java系列之一个接口的诞生]]></title>    <link>https://juejin.cn/post/7575412016404430858</link>    <guid>https://juejin.cn/post/7575412016404430858</guid>    <pubDate>2025-11-23T14:26:24.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7575412016404430858" data-draft-id="7575456858427129902" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="前端卷Java系列之一个接口的诞生"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-11-23T14:26:24.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="戴着眼镜的平头哥"/> <meta itemprop="url" content="https://juejin.cn/user/2471357868159544"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            前端卷Java系列之一个接口的诞生
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2471357868159544/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    戴着眼镜的平头哥
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-23T14:26:24.000Z" title="Sun Nov 23 2025 14:26:24 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    4
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><ol>
<li>
<h2 data-id="heading-0">摘要</h2>
</li>
</ol>
<p>本文以若依框架为例，阐述使用Java后端的一系列技术实现一个后端接口，为什么要基于若依框架，因为还是想从真实工程的角度描述Java后端实现接口的流程，如果仅仅是实现一个简单的接口，我相信你可以用很多技术实现，比如用原生Node的Http模块或者使用Express、Koa等前端框架。虽然网上对若依框架褒贬不一样，但是学东西还是要用人之长的眼光去看待。标题名称虽然是前端卷Java，并不代表是Java小白系列文章，因为笔者工作偏向前端，所以标题是前端卷Java，不过还是需要一些Java基础的，另外这是一篇Java技术普及的文章，揭示真实工程中实现一个接口到底用到了哪些Java技术，对于某个技术的深入研究，笔者后续会慢慢拆解。</p>
<ol start="2">
<li>
<h2 data-id="heading-1">目标聚焦</h2>
</li>
</ol>
<p>实现一个根据Id查询一条问候语的接口，熟悉接口开发流程和使用的框架，接口如下：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/33615c8b6d7e4dc298ebb4251033f202~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oi0552A55y86ZWc55qE5bmz5aS05ZOl:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764514090&amp;x-signature=xDyC4iu4UfbBk6Px5l5eE3o5l5g%3D" alt="560928daa2f6d92e7d32fe898fbfbc86.png" loading="lazy"/></p>
<p>这是一个GET接口，通过在url上拼接查询参数id向后端传递参数，以便查询这条id对应的问候语，没错就是这么简单，我们的重点是熟悉基本的开发流程和使用的框架，因此例子越简单越好。</p>
<ol start="3">
<li>
<h2 data-id="heading-2">具体实现</h2>
</li>
</ol>
<p>先看下这个接口在代码中的实现如下所示：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@RestController</span>
<span class="hljs-meta">@RequestMapping("/system/greeting")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">GreetingController</span> {
    <span class="hljs-meta">@Resource</span>
    <span class="hljs-keyword">private</span> GreetingService greetingService;
    <span class="hljs-meta">@GetMapping("/getGreetingById")</span>
    <span class="hljs-keyword">public</span> CommonResult&lt;GreetingDO&gt; <span class="hljs-title function_">getGreetingById</span><span class="hljs-params">(<span class="hljs-meta">@RequestParam("id")</span> Long id)</span> {
        <span class="hljs-type">GreetingDO</span> <span class="hljs-variable">greeting</span> <span class="hljs-operator">=</span> greetingService.getGreetingById(id);
        <span class="hljs-keyword">return</span> success(greeting);
    }}
</code></pre>
<p>这里牵扯到很多注解(@开头的)，我们先不看，最核心的代码是第11句，调用了greetingService的getGreetingById方法查询得到了一条问候语。greetingService是一个GreetingService的实例（对象），这里为什么没有new呢，为什么没有创建这个对象，这是因为Spring框架帮我们自动创建了一个，得益于@Resource这个注解，Spring有个魔法叫依赖注入，就是你需要什么样的对象，你不用自己创建，你就告诉Spring，Spring帮你创建。不过这有个前提，就是你要告诉Spring这个对象是什么样子的，也就是GreetingService。</p>
<p>GreetingService如下：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">GreetingService</span> {
    GreetingDO  <span class="hljs-title function_">getGreetingById</span><span class="hljs-params">(Long id)</span>;
}
</code></pre>
<p>这是一个接口，类似TypeScript中的接口一样，定义了这个对象的形状，但这个仅仅是对象的形状，就像是一个汽车的结构图一样，缺少具体的实现，我们需要一个具体的模子，让Spring用这个模子，造一个汽车出来，这个具体的模子是GreetingServiceImpl，它实现了GreetingService这个接口。</p>
<p>GreetingServiceImpl如下：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">GreetingServiceImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">GreetingService</span>{
    <span class="hljs-meta">@Resource</span>
    <span class="hljs-keyword">private</span> GreetingMapper greetingMapper;
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> GreetingDO <span class="hljs-title function_">getGreetingById</span><span class="hljs-params">(Long id)</span> {
        <span class="hljs-keyword">return</span> greetingMapper.selectById(id);
    }
}
</code></pre>
<p>GreetingServiceImpl这个类中最关键的是第5句使用了greetingMapper调用了selectById方法查询问候语，那greetingMapper是从哪里来的呢，没错，通过第4句的声明，Spring帮我们创建造出来的，同样我们也需要一个GreetingMapper的模子告诉Spring照着这个模子造一个greetingMapper实例(对象)出来。</p>
<p>GreetingMapper如下所示：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Mapper</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">GreetingMapper</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">BaseMapperX</span>&lt;GreetingDO&gt; {
}
</code></pre>
<p>懵了，为什么没有selectById这个方法，聪明的你肯定发现了extends(继承)，这个方法是从BaseMapperX继承过来，BaseMapperX是若依框架封装的，它在MybatisPlus的BaseMapper又添加了一些方法。MyBatis-Plus是MyBatis的增强版，MyBatis是一个Java持久层框架，意思就是它帮你把内存中处理操作的对象放到数据库中保存起来或者从数据库中查询到你需要的数据放到内存中来，也就是我们在数据库中保存的问候语数据。至此，这个方法基本结束。</p>
<ol start="4">
<li>
<h2 data-id="heading-3">整体流程</h2>
</li>
</ol>
<p>我把步骤3的流程绘制成了如下的UML交互图，以便更清晰的描述整个接口实现的流程。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/78bb376e78d14b64a34d1978a716633e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oi0552A55y86ZWc55qE5bmz5aS05ZOl:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764514090&amp;x-signature=VFq9LpN4cqUteXS%2FyFtlHQjMVbA%3D" alt="" loading="lazy"/></p>
<p>从这个图可以看出，这是一个典型的三层架构，分为Controller层、Service层、DAL层</p>
<p>Controller层(控制层)：接受客户端的请求，调用Service层的方法的得到结果，将结果返回给客户端。</p>
<p>Service层(业务逻辑层)：接受控制层的传参，处理业务逻辑，调用DAL层的方法，将结果返回给Controller层。</p>
<p>DAL层(数据访问层或叫Mapper)：接受Service层的传参，调用JDBC完成数据库的数据操作，将结果返回给Service层。</p>
<p>上图中还有一些模块没有介绍</p>
<p>GreetingSaveReqVO：问候语请求实体对象，用于接受客户端传递过来的问候语实体，就是一个Java类。</p>
<p>GreetingDO: 问候语数据对象，是和数据库表中的字段一一对象的Java原生对象，有些规范中叫PO，也是一个Java类。</p>
<p>BaseDO：若依框架封装的一个DO，包含了一个公用的字段比如createTime创建时间、updateTime更新时间、creator创建人、updater更新人、deleted逻辑删除字段。</p>
<p>关于这些O的概念，我总结了一下：</p>





























































<table><thead><tr><th>全称</th><th>简称</th><th>中文</th><th>用途</th><th>是否暴漏给前端</th><th>是否映射数据库</th></tr></thead><tbody><tr><td>Plain Old Java Object</td><td>POJO</td><td>简单Java对象</td><td>无特殊限制的普通Java类</td><td>否</td><td>否</td></tr><tr><td>Persistent Object</td><td>PO</td><td>持久化对象</td><td>与数据库表一一对象，通常与ORM映射</td><td>否</td><td>是</td></tr><tr><td>View Object</td><td>VO</td><td>视图对象</td><td>展示层数据，用于向前端返回数据</td><td>是</td><td>否</td></tr><tr><td>Business Object</td><td>BO</td><td>业务对象</td><td>封装核心业务逻辑的对象</td><td>否</td><td>否</td></tr><tr><td>Data Transfer Object</td><td>DTO</td><td>数据传输对象</td><td>用于不同层或服务之间传递数据</td><td>是</td><td>否</td></tr><tr><td>Data Access Object</td><td>DAO</td><td>数据访问对象</td><td>与数据库交互的接口或类，负责持久化操作</td><td>否</td><td>是</td></tr></tbody></table>
<p>POJO：泛指Java中的对象，其他对象如PO、BO、DTO等都可以是POJO</p>
<p>PO：与数据库表一一映射，通常使用JPA注解或MyBatis注解</p>
<p>DO: 数据对象，业务对象，领域模型，用于业务处理，有些项目会当PO使用。</p>
<p>VO: 用于返回给前端展示的数据结构，可以包含多个对象的组合数据</p>
<p>BO: 封装业务逻辑的对象，通常用于Service层内部处理</p>
<p>DTO：用于接口参数传递和跨层数据传输，如Controller接受前端传递过来对象，或者微服务之间调用传参</p>
<p>DAO：用于操作数据库的接口或类。</p>
<p>为了更清楚地展现整体流程，方便理解，我绘制了时序图如下所示：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bd727ecb1e1d44eeafcf00074969bde3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oi0552A55y86ZWc55qE5bmz5aS05ZOl:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764514090&amp;x-signature=vkbuNHOnpiZklthF%2FD%2BPQYmaCNU%3D" alt="" loading="lazy"/></p>
<p>上面这个图应该清晰地展现了getGreetingById接口牵扯到的各个模块(类)之间的调用流程。</p>
<blockquote>
<p>人生是一个漫长而艰辛的接力赛，有时领先，有时落后，但是你只要在路上，就有机会，及时行乐，就像是一支兴奋剂，它能够点燃幸福的华彩，也能加速生命的衰败，所以人还是要适当的有一些节制。</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[六边形架构？小白也能秒懂的「抗造代码秘诀」]]></title>    <link>https://juejin.cn/post/7575468252656222249</link>    <guid>https://juejin.cn/post/7575468252656222249</guid>    <pubDate>2025-11-23T14:31:58.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7575468252656222249" data-draft-id="7575425466905362495" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="六边形架构？小白也能秒懂的「抗造代码秘诀」"/> <meta itemprop="keywords" content="后端,架构,Java"/> <meta itemprop="datePublished" content="2025-11-23T14:31:58.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="我叫黑大帅"/> <meta itemprop="url" content="https://juejin.cn/user/1678295463898875"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            六边形架构？小白也能秒懂的「抗造代码秘诀」
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1678295463898875/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    我叫黑大帅
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-23T14:31:58.000Z" title="Sun Nov 23 2025 14:31:58 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读10分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">六边形架构？小白也能秒懂的「抗造代码秘诀」</h2>
<h4 data-id="heading-1">😩 开篇暴击：为啥改一行代码，崩了三个服务？</h4>
<p>做开发最崩溃的时刻：产品说 “加个小程序端”，你改完前端改后端，改完后端改数据库，最后发现订单逻辑崩了；测试说 “换个缓存中间件”，你扒着代码改了三天，还把用户数据搞丢了… 这就是传统代码 “牵一发而动全身” 的坑！今天要讲的「六边形架构」，就是专治这种 “代码骨质疏松” 的神药✨ 别被名字吓到，它本质是个 “让业务当老大，技术当小弟” 的设计思路。</p>
<h4 data-id="heading-2">🔷 为啥叫 “六边形”？不是因为程序员爱几何！</h4>
<p>2005 年有个叫 Alistair Cockburn 的大神发明这架构时，画了张图：核心业务逻辑蹲在正中间，周围伸出六个 “接口触角” 连接外界，看起来像个六边形。这图藏着个关键思想：<strong>所有外部系统（网页、数据库、第三方接口）都得 “低头” 通过统一接口找核心，核心却从不搭理它们的 “小脾气”</strong> 。</p>
<p>打个比方：核心逻辑是你家客厅🍻，六边形的六条边是家门🚪（端口），门口的鞋架、门禁、快递柜就是 “适配器”🔌。不管是外卖小哥（API）、修水管的（数据库）还是串门的邻居（第三方服务），都得走门、用门口的设备，绝不会让他们直接砸墙进客厅 —— 这就是 “解耦” 的精髓！</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1f484aa7d5b04241868b0309388859e6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oiR5Y-r6buR5aSn5biF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764513117&amp;x-signature=gt4mhUREP%2Bebrt2YJxn2XM1xOno%3D" alt="六边形架构.png" loading="lazy"/></p>
<h4 data-id="heading-3">🧠 三分钟看透核心三要素：谁是 “话事人”？</h4>
<h5 data-id="heading-4">1. 核心域：业务逻辑的 “独立王国” 👑</h5>
<p>核心域是整个架构的灵魂，只干一件事：实现业务规则，比如 “订单满 200 减 50”“余额不足不能转账”。它有两个超能力：</p>
<ul>
<li>🌰 不碰任何技术细节：不管你用 MySQL 还是 Excel 存数据，不管前端是网页还是 APP，它都漠不关心；</li>
<li>🧪 能单独测试：不用连数据库、开服务器，直接给它传数据就能测业务逻辑对不对。</li>
</ul>
<p>伪代码长这样（看懂逻辑就行，不用管语法）：</p>
<pre><code class="hljs language-scss" lang="scss"> <span class="hljs-comment">// 核心业务逻辑：订单处理系统</span>
 ​
 定义 订单服务：
 ​
    <span class="hljs-comment">// 只关心业务规则，不关心数据存在哪</span>
 ​
    方法 创建订单(用户, 商品列表)：
 ​
        如果 商品库存不足 → 报错“库存不够啦”
 ​
        计算 总价 = 商品列表求和 - 优惠金额
 ​
        如果 总价 &lt; <span class="hljs-number">0</span> → 报错“优惠不能超总价”
 ​
        调用 订单存储接口.保存订单(订单信息)  <span class="hljs-comment">// 只喊接口，不喊具体数据库</span>
 ​
        返回 订单编号
</code></pre>
<h5 data-id="heading-5">2. 端口：核心域的 “沟通暗号” 🚪</h5>
<p>核心域不想和外界直接说话，于是搞了套 “暗号本”—— 端口，本质是定义 “怎么对话” 的接口。分两种：</p>
<ul>
<li>输入端口（驱动端口）：别人找核心办事的暗号，比如 “创建订单”“查询余额”；</li>
<li>输出端口（被驱动端口）：核心找别人办事的暗号，比如 “保存数据”“发送短信”。</li>
</ul>
<p>端口的关键是：<strong>用业务语言说话，不说技术术语</strong>！比如叫 “保存订单” 而不是 “执行 SQL 插入”。</p>
<p>伪代码示例：</p>
<pre><code class="hljs language-scss" lang="scss"> <span class="hljs-comment">// 输入端口：外部调用核心的接口</span>
 ​
 定义 订单操作接口：
 ​
    方法 创建订单(用户, 商品列表) → 订单编号
 ​
    方法 取消订单(订单编号) → 布尔值
 ​
 <span class="hljs-comment">// 输出端口：核心调用外部的接口</span>
 ​
 定义 订单存储接口：
 ​
    方法 保存订单(订单信息) → 成功/失败
 ​
    方法 查订单(订单编号) → 订单信息
</code></pre>
<h5 data-id="heading-6">3. 适配器：外界的 “翻译官” 🔌</h5>
<p>端口是暗号本，但外界不懂暗号啊！比如网页前端只会发 HTTP 请求，数据库只会认 SQL—— 这时候就需要适配器当翻译。适配器也分两种：</p>
<ul>
<li>输入适配器：把外界请求转成核心能懂的暗号，比如把网页的 “下单按钮点击” 转成 “调用订单操作接口。创建订单”；</li>
<li>输出适配器：把核心的暗号转成外界能懂的指令，比如把 “保存订单” 转成 MySQL 的 INSERT 语句，或 MongoDB 的 save 命令。</li>
</ul>
<p>最牛的是：<strong>换外界系统只需换适配器，核心不动！</strong> 比如从 MySQL 换成 PostgreSQL，只改 “数据库适配器”，核心的 “保存订单” 逻辑一毛钱不用改。</p>
<p>伪代码演示：</p>
<pre><code class="hljs language-scss" lang="scss"> <span class="hljs-comment">// 输入适配器：网页前端的翻译官</span>
 ​
 定义 网页订单适配器：
 ​
    方法 处理网页下单请求(网页参数)：
 ​
        解析 参数 → 用户信息、商品列表
 ​
        调用 订单操作接口.创建订单(用户信息, 商品列表)  <span class="hljs-comment">// 转成核心能懂的暗号</span>
 ​
        把 订单编号 转成网页能显示的格式 → 返回给用户
 ​
 <span class="hljs-comment">// 输出适配器：MySQL数据库的翻译官</span>
 ​
 定义 MySQL订单适配器 实现 订单存储接口：
 ​
    方法 保存订单(订单信息)：
 ​
        把 订单信息 转成 SQL语句 → "INSERT INTO 订单表 VALUES (...)"
 ​
        执行 SQL → 返回 成功/失败
</code></pre>
<h4 data-id="heading-7">🛠️ 手把手搭架构：用伪代码建个订单系统</h4>
<p>光说不练假把式！咱们用上面的三要素搭个简化版订单系统，全程无具体代码：</p>
<h5 data-id="heading-8">第一步：写核心业务逻辑（不管外界）</h5>
<pre><code class="hljs language-scss" lang="scss"> <span class="hljs-comment">// 核心域：订单服务（实现输入端口的逻辑）</span>
 ​
 定义 订单服务 实现 订单操作接口：
 ​
    <span class="hljs-comment">// 依赖输出端口的接口，不是具体实现！</span>
 ​
    接收 订单存储接口 实例 → 存在自己这里
 ​
    方法 创建订单(用户, 商品列表)：
 ​
        <span class="hljs-number">1</span>. 调用 库存服务接口.查库存(商品列表) → 若不足报错
 ​
        <span class="hljs-number">2</span>. 计算 总价 = 商品金额总和 - 用户优惠券
 ​
        <span class="hljs-number">3</span>. 调用 自己存的订单存储接口.保存订单(订单信息)
 ​
        <span class="hljs-number">4</span>. 调用 消息发送接口.发消息(用户ID, "订单创建成功")
 ​
        <span class="hljs-number">5</span>. 返回 订单编号
 ​
    方法 取消订单(订单编号)：
 ​
        <span class="hljs-number">1</span>. 调用 订单存储接口.查订单(订单编号) → 若不存在报错
 ​
        <span class="hljs-number">2</span>. 若 订单已发货 → 报错“不能取消”
 ​
        <span class="hljs-number">3</span>. 调用 订单存储接口.更新订单状态(订单编号, "已取消")
 ​
        <span class="hljs-number">4</span>. 调用 库存服务接口.加库存(商品列表)
 ​
        <span class="hljs-number">5</span>. 返回 成功
</code></pre>
<h5 data-id="heading-9">第二步：接前端（加输入适配器）</h5>
<pre><code class="hljs language-scss" lang="scss"> <span class="hljs-comment">// 输入适配器1：APP适配器</span>
 ​
 定义 APP订单适配器：
 ​
    方法 处理APP下单请求(APP参数)：
 ​
        解析 参数 → 用户ID、商品ID列表
 ​
        调用 订单服务.创建订单(用户ID, 商品ID列表)
 ​
        返回 JSON格式的订单编号
 ​
 <span class="hljs-comment">// 输入适配器2：小程序适配器</span>
 ​
 定义 小程序订单适配器：
 ​
    方法 处理小程序下单请求(小程序参数)：
 ​
        解析 参数 → 用户ID、商品ID列表  <span class="hljs-comment">// 和APP解析方式不同</span>
 ​
        调用 订单服务.创建订单(用户ID, 商品ID列表)  <span class="hljs-comment">// 但调用核心的方式一样</span>
 ​
        返回 小程序能识别的响应格式
</code></pre>
<h5 data-id="heading-10">第三步：接后端（加输出适配器）</h5>
<pre><code class="hljs language-json" lang="json"> <span class="hljs-comment">// 输出适配器1：Redis缓存适配器</span>
 ​
 定义 Redis订单适配器 实现 订单存储接口：
 ​
    方法 保存订单(订单信息)：
 ​
        把 订单信息 转成 Redis的键值对 → <span class="hljs-string">"订单:123"</span> → <span class="hljs-punctuation">{</span><span class="hljs-attr">"用户"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"张三"</span><span class="hljs-punctuation">,</span> ...<span class="hljs-punctuation">}</span>
 ​
        存入 Redis → 返回 成功
 ​
 <span class="hljs-comment">// 输出适配器2：短信通知适配器</span>
 ​
 定义 短信适配器 实现 消息发送接口：
 ​
    方法 发消息(用户ID<span class="hljs-punctuation">,</span> 内容)：
 ​
        查 用户手机号 → 从用户服务接口拿
 ​
        调用 短信平台API → 发送内容
 ​
        返回 发送结果
</code></pre>
<p>看到没？不管前端加多少端（APP、小程序、网页），后端换多少存储（Redis、MySQL、MongoDB），核心的订单服务永远稳如老狗🐶！</p>
<h4 data-id="heading-11">🎯 这些场景闭眼用：六边形架构的 “舒适区”</h4>
<p>不是所有项目都需要这架构，找对场景才能事半功倍：</p>
<h5 data-id="heading-12">1. 多端适配的系统 📱💻</h5>
<p>比如电商系统要支持网页、APP、小程序、第三方 API—— 输入适配器多开几个就行，核心逻辑一次写完。就像餐厅开了堂食、外卖、团餐窗口，厨房还是同一个🍳。</p>
<h5 data-id="heading-13">2. 频繁换外部依赖的项目 🔄</h5>
<p>比如老板今天说 “用 MySQL 存数据”，明天说 “换 MongoDB”，后天说 “加个 Redis 缓存”—— 只需换输出适配器，不用改核心。搜索到的阿里案例里，迁移数据库时六边形架构的成本只有传统架构的 1/10！</p>
<h5 data-id="heading-14">3. 复杂业务系统 🧩</h5>
<p>比如银行的交易系统、医院的挂号系统，业务规则一大堆（满减、折扣、权限控制）。核心域单独维护业务逻辑，测试时不用连数据库，直接 Mock 一个适配器就能测，效率翻倍🚀。</p>
<h5 data-id="heading-15">❌ 这些场景别瞎用：杀鸡不用牛刀</h5>
<ul>
<li>小工具：比如写个批量重命名文件的脚本，业务逻辑就一行，用这架构纯属给自己找罪受；</li>
<li>一次性项目：比如临时做个活动页面，用完就扔，简单的线性代码更快；</li>
<li>技术验证原型：重点在试技术，不是稳架构，先跑通再说。</li>
</ul>
<h4 data-id="heading-16">🆚 传统架构 VS 六边形架构：差在哪？</h4>
<p>用个通俗比喻：</p>
<ul>
<li>传统分层架构像串糖葫芦🍡：UI 层依赖服务层，服务层依赖 DAO 层，DAO 层依赖数据库 —— 改数据库，从 DAO 到 UI 全得动；</li>
<li>六边形架构像积木城堡🏰：核心是地基，端口是接口，适配器是积木块 —— 想换窗户（数据库）、门（前端），直接拆旧积木换新品，地基不动。</li>
</ul>
<p>看个真实对比：电商系统从 MySQL 迁移到 PostgreSQL</p>






























<table><thead><tr><th>对比项</th><th>传统架构</th><th>六边形架构</th></tr></thead><tbody><tr><td>核心逻辑修改</td><td>要改（DAO 层、服务层都碰）</td><td>不改（核心域稳如泰山）</td></tr><tr><td>测试范围</td><td>全系统重测</td><td>只测新适配器</td></tr><tr><td>迁移时间</td><td>3 天</td><td>2 小时</td></tr><tr><td>风险</td><td>可能改崩业务逻辑</td><td>几乎零风险</td></tr></tbody></table>
<h5 data-id="heading-17">代码对比</h5>
<h6 data-id="heading-18">🍡 传统三层流式架构示例</h6>
<pre><code class="hljs language-scss" lang="scss"> <span class="hljs-comment">// Controller 层 (UI 层)</span>
 <span class="hljs-keyword">@RestController</span>
 public class OrderController {
     private final OrderService orderService; <span class="hljs-comment">// 直接依赖 Service</span>
 ​
     <span class="hljs-keyword">@PostMapping</span>(<span class="hljs-string">"/orders"</span>)
     public String createOrder(<span class="hljs-keyword">@RequestBody</span> OrderRequest request) {
         return orderService<span class="hljs-selector-class">.createOrder</span>(request.getUser(), request<span class="hljs-selector-class">.getItems</span>());
     }
 }
 ​
 <span class="hljs-comment">// Service 层 (业务逻辑 + 技术耦合)</span>
 <span class="hljs-keyword">@Service</span>
 public class OrderService {
     private final OrderDao orderDao; <span class="hljs-comment">// 直接依赖 DAO</span>
 ​
     public String <span class="hljs-built_in">createOrder</span>(User user, List&lt;Item&gt; items) {
         double total = items<span class="hljs-selector-class">.stream</span>()<span class="hljs-selector-class">.mapToDouble</span>(Item::getPrice)<span class="hljs-selector-class">.sum</span>();
         <span class="hljs-attribute">Order</span> <span class="hljs-attribute">order</span> = new <span class="hljs-attribute">Order</span>(user, items, total);
 ​
         <span class="hljs-comment">// 直接调用 DAO 层，耦合数据库</span>
         orderDao<span class="hljs-selector-class">.insert</span>(order);
 ​
         return <span class="hljs-attribute">order</span><span class="hljs-selector-class">.getId</span>();
     }
 }
 ​
 <span class="hljs-comment">// DAO 层 (数据库操作)</span>
 <span class="hljs-keyword">@Repository</span>
 public class OrderDao {
     private final JdbcTemplate jdbc;
 ​
     public void <span class="hljs-built_in">insert</span>(Order order) {
         jdbc<span class="hljs-selector-class">.update</span>("INSERT INTO orders (id, user, total) VALUES (?, ?, ?)",
                     <span class="hljs-attribute">order</span><span class="hljs-selector-class">.getId</span>(), <span class="hljs-attribute">order</span><span class="hljs-selector-class">.getUser</span>()<span class="hljs-selector-class">.getId</span>(), <span class="hljs-attribute">order</span><span class="hljs-selector-class">.getTotal</span>());
     }
 }
 ​
</code></pre>
<p>👉 特点：Service 层直接依赖 DAO，DAO 直接依赖数据库。换数据库时，Service 和 DAO 都可能要改。</p>
<h5 data-id="heading-19">🏰 六边形架构示例</h5>
<pre><code class="hljs language-java" lang="java"> <span class="hljs-comment">// 输入端口 (业务接口)</span>
 <span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">OrderUseCase</span> {
     String <span class="hljs-title function_">createOrder</span><span class="hljs-params">(User user, List&lt;Item&gt; items)</span>;
 }
 ​
 <span class="hljs-comment">// 输出端口 (抽象接口)</span>
 <span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">OrderRepository</span> {
     <span class="hljs-keyword">void</span> <span class="hljs-title function_">save</span><span class="hljs-params">(Order order)</span>;
 }
 ​
 <span class="hljs-comment">// 核心域 (业务逻辑，只依赖端口)</span>
 <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderService</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">OrderUseCase</span> {
     <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> OrderRepository orderRepository;
 ​
     <span class="hljs-keyword">public</span> <span class="hljs-title function_">OrderService</span><span class="hljs-params">(OrderRepository orderRepository)</span> {
         <span class="hljs-built_in">this</span>.orderRepository = orderRepository;
     }
 ​
     <span class="hljs-meta">@Override</span>
     <span class="hljs-keyword">public</span> String <span class="hljs-title function_">createOrder</span><span class="hljs-params">(User user, List&lt;Item&gt; items)</span> {
         <span class="hljs-type">double</span> <span class="hljs-variable">total</span> <span class="hljs-operator">=</span> items.stream().mapToDouble(Item::getPrice).sum();
         <span class="hljs-type">Order</span> <span class="hljs-variable">order</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Order</span>(user, items, total);
 ​
         <span class="hljs-comment">// 调用抽象接口，不关心具体数据库</span>
         orderRepository.save(order);
 ​
         <span class="hljs-keyword">return</span> order.getId();
     }
 }
 ​
 <span class="hljs-comment">// 输入适配器 (API 层)</span>
 <span class="hljs-meta">@RestController</span>
 <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderController</span> {
     <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> OrderUseCase orderService;
 ​
     <span class="hljs-meta">@PostMapping("/orders")</span>
     <span class="hljs-keyword">public</span> String <span class="hljs-title function_">createOrder</span><span class="hljs-params">(<span class="hljs-meta">@RequestBody</span> OrderRequest request)</span> {
         <span class="hljs-keyword">return</span> orderService.createOrder(request.getUser(), request.getItems());
     }
 }
 ​
 <span class="hljs-comment">// 输出适配器 (数据库实现)</span>
 <span class="hljs-meta">@Repository</span>
 <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MySqlOrderRepository</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">OrderRepository</span> {
     <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> JdbcTemplate jdbc;
 ​
     <span class="hljs-meta">@Override</span>
     <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">save</span><span class="hljs-params">(Order order)</span> {
         jdbc.update(<span class="hljs-string">"INSERT INTO orders (id, user, total) VALUES (?, ?, ?)"</span>,
                     order.getId(), order.getUser().getId(), order.getTotal());
     }
 }
 ​
</code></pre>
<p>👉 特点：核心域只依赖抽象接口 <code>OrderRepository</code>，具体数据库实现由适配器提供。换数据库时，只需写一个新的适配器（比如 <code>MongoOrderRepository</code>），核心域完全不用改。</p>
<h4 data-id="heading-20">📝 最后总结：别被名字吓到！</h4>
<p>六边形架构的核心不是 “六边形” 这个形状，而是 “业务优先，技术靠边” 的设计思想 —— 让最有价值的业务逻辑摆脱技术的束缚，想怎么折腾技术细节就怎么折腾，核心永远安全。</p>
<p>对小白来说，不用一开始就完美实现，先记住三个原则：</p>
<ol start="0">
<li>核心只干业务的事，别碰技术；</li>
<li>对外只通过端口说话，别直接唠；</li>
<li>适配交给适配器，别让核心当翻译。</li>
</ol>
<p>下次再遇到 “改一行崩全服” 的坑，试试用六边形架构搭个骨架 —— 相信我，测试小哥会少追杀你好几次😉！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[@NotBlank 不生效报错 No validator could be found：Hibernate Validator 版本匹配指北]]></title>    <link>https://juejin.cn/post/7575937594337673257</link>    <guid>https://juejin.cn/post/7575937594337673257</guid>    <pubDate>2025-11-23T15:26:20.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7575937594337673257" data-draft-id="7575425466905493567" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="@NotBlank 不生效报错 No validator could be found：Hibernate Validator 版本匹配指北"/> <meta itemprop="keywords" content="后端,面试,程序员"/> <meta itemprop="datePublished" content="2025-11-23T15:26:20.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="9号达人"/> <meta itemprop="url" content="https://juejin.cn/user/2450136052270077"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            @NotBlank 不生效报错 No validator could be found：Hibernate Validator 版本匹配指北
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2450136052270077/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    9号达人
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-23T15:26:20.000Z" title="Sun Nov 23 2025 15:26:20 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#595959;font-size:15px;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(60,10,30,.04) 3%,transparent 0),linear-gradient(1turn,rgba(60,10,30,.04) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body p{color:#595959;font-size:15px;line-height:2;font-weight:400}.markdown-body p+p{margin-top:16px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin:0;color:#135ce0}.markdown-body h1{position:relative;text-align:center;font-size:22px;margin:50px 0}.markdown-body h1:before{position:absolute;content:"";top:-10px;left:50%;width:32px;height:32px;transform:translateX(-50%);background-size:100% 100%;opacity:.36;background-repeat:no-repeat;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC)}.markdown-body h2{position:relative;font-size:20px;border-left:4px solid;padding:0 0 0 10px;margin:30px 0}.markdown-body h3{font-size:16px}.markdown-body ul{list-style:disc outside;margin-left:2em;margin-top:1em}.markdown-body li{line-height:2;color:#595959}.markdown-body img.loaded{margin:0 auto;display:block}.markdown-body blockquote{background:#fff9f9;margin:2em 0;padding:2px 20px;border-left:4px solid #b2aec5}.markdown-body blockquote p{color:#666;line-height:2}.markdown-body a{color:#036aca;border-bottom:1px solid rgba(3,106,202,.8);font-weight:400;text-decoration:none}.markdown-body em strong,.markdown-body strong{color:#036aca}.markdown-body hr{border-top:1px solid #135ce0}.markdown-body pre{overflow:auto}.markdown-body code,.markdown-body pre{overflow:auto;position:relative;line-height:1.75;font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body table{border-collapse:collapse;margin:1rem 0;overflow-x:auto}.markdown-body table td,.markdown-body table th{border:1px solid #dfe2e5;padding:.6em 1em}.markdown-body table tr{border-top:1px solid #dfe2e5}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">问题背景</h2>
<p>最近在写接口的时候，遇到了一个看似简单但实际很坑的参数校验问题。代码是这样的：</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-comment">/**
 * 关键词
 */</span>
@NotBlank
<span class="hljs-keyword">private</span> <span class="hljs-type">String</span> keywords;
</code></pre>
<p>看起来很完美对吧？使用的是 <code>javax.validation.constraints.NotBlank</code> 注解来校验字符串不能为空。</p>
<p>结果一测试，直接给我来了个异常：</p>
<pre><code class="hljs language-rust" lang="rust">javax.validation.UnexpectedTypeException: HV000030: No validator could be found <span class="hljs-keyword">for</span> <span class="hljs-title class_">constraint</span> <span class="hljs-symbol">'javax</span>.validation.constraints.NotBlank' validating <span class="hljs-keyword">type</span> <span class="hljs-symbol">'java</span>.lang.<span class="hljs-type">String</span>'. Check configuration <span class="hljs-keyword">for</span> <span class="hljs-symbol">'keywords</span>'
</code></pre>
<h2 data-id="heading-1">异常分析</h2>
<p>看到这个异常信息，第一反应是：<strong>什么鬼？@NotBlank 不就是用来校验 String 的吗？怎么还找不到验证器？</strong></p>
<p>去网上搜了一圈，发现众说纷纭：</p>
<ul>
<li>有人说 String 不能配置 @NotBlank（这明显是错的）</li>
<li>有人说缺少 <code>validation-api</code> 依赖</li>
<li>有人说缺少 <code>hibernate-validator</code> 依赖</li>
<li>还有人说版本不匹配</li>
</ul>
<h2 data-id="heading-2">根本原因</h2>
<p>检查项目依赖后发现了问题所在：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- 项目中的实际依赖 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>javax.validation<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>validation-api<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>2.0.x<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>  
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.hibernate.validator<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>hibernate-validator<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>5.4.1<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span> 
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
</code></pre>
<p><strong>看出问题了吗？看到了心里打个扣</strong></p>
<ul>
<li><code>@NotNull</code> 能用：因为它是 Bean Validation 1.1 就有的注解，hibernate-validator 5.x 支持</li>
<li><code>@NotBlank</code> 不能用：因为它是 Bean Validation 2.0 新增的注解，需要 hibernate-validator 6.x 才支持</li>
</ul>
<p>虽然引入了 <code>validation-api 2.0</code>（有 @NotBlank 注解定义），但运行时用的是 <code>hibernate-validator 5.4.1</code>（没有 @NotBlank 的验证器实现），所以编译能通过，运行时却找不到验证器！</p>
<h3 data-id="heading-3">为什么会抛出异常？</h3>
<p>我们直接来看看异常抛出的源码（hibernate-validator 5.x）：</p>
<pre><code class="hljs language-scss" lang="scss">private &lt;T, V&gt; ConstraintValidator&lt;<span class="hljs-selector-tag">A</span>, V&gt; <span class="hljs-built_in">getConstraintValidatorNoUnwrapping</span>(
        ValidationContext&lt;T&gt; validationContext,
        ValueContext&lt;?, V&gt; valueContext) {
    <span class="hljs-comment">// 确保没有设置 unwrapper</span>
    valueContext<span class="hljs-selector-class">.setValidatedValueHandler</span>(null);

    Type validatedValueType = valueContext<span class="hljs-selector-class">.getDeclaredTypeOfValidatedElement</span>();

    <span class="hljs-comment">// 关键：从 ConstraintValidatorManager 中获取已初始化的验证器</span>
    ConstraintValidator&lt;<span class="hljs-selector-tag">A</span>, V&gt; validator = validationContext
        <span class="hljs-selector-class">.getConstraintValidatorManager</span>()
        <span class="hljs-selector-class">.getInitializedValidator</span>(
            validatedValueType,      // String.class
            descriptor,              // @NotBlank 注解描述符
            validationContext.getConstraintValidatorFactory()
        );

    <span class="hljs-comment">// 如果找不到对应的验证器实现，抛出异常</span>
    if (validator == null) {
        <span class="hljs-built_in">throwExceptionForNullValidator</span>(validatedValueType,
            valueContext.getPropertyPath()<span class="hljs-selector-class">.asString</span>());
    }

    return validator;
}
</code></pre>
<p><strong>流程解析：</strong></p>
<ol>
<li>获取被校验字段的类型：<code>String.class</code></li>
<li>从 <code>ConstraintValidatorManager</code> 中查找能处理 <code>@NotBlank + String</code> 组合的验证器</li>
<li><strong>在 hibernate-validator 5.x 中找不到 <code>NotBlankValidator</code></strong>，返回 null</li>
<li>抛出 <code>UnexpectedTypeException</code> 异常</li>
</ol>
<h4 data-id="heading-4">为什么会返回 null？</h4>
<p>继续追踪 <code>getInitializedValidator</code> 方法的实现：</p>
<pre><code class="hljs language-ini" lang="ini">public &lt;V, A extends Annotation&gt; ConstraintValidator&lt;A, V&gt; getInitializedValidator(
        Type validatedValueType,
        ConstraintDescriptorImpl&lt;A&gt; descriptor,
        ConstraintValidatorFactory constraintFactory) {

    Contracts.assertNotNull(validatedValueType)<span class="hljs-comment">;</span>
    Contracts.assertNotNull(descriptor)<span class="hljs-comment">;</span>
    Contracts.assertNotNull(constraintFactory)<span class="hljs-comment">;</span>

    // 1. 首先尝试从缓存中获取
    CacheKey <span class="hljs-attr">key</span> = new CacheKey(descriptor.getAnnotation(), validatedValueType, constraintFactory)<span class="hljs-comment">;</span>

    ConstraintValidator&lt;A, V&gt; <span class="hljs-attr">constraintValidator</span> =
        (ConstraintValidator&lt;A, V&gt;) constraintValidatorCache.get(key)<span class="hljs-comment">;</span>

    // 2. 缓存中没有，创建并初始化验证器
    if (<span class="hljs-attr">constraintValidator</span> == null) {
        <span class="hljs-attr">constraintValidator</span> = createAndInitializeValidator(
            constraintFactory, validatedValueType, descriptor)<span class="hljs-comment">;</span>
        <span class="hljs-attr">constraintValidator</span> = cacheValidator(key, constraintValidator)<span class="hljs-comment">;</span>
    } else {
        LOG.tracef("Constraint validator %s found in cache.", constraintValidator)<span class="hljs-comment">;</span>
    }

    // 3. 关键：如果是 DUMMY_CONSTRAINT_VALIDATOR，返回 null！
    return <span class="hljs-attr">DUMMY_CONSTRAINT_VALIDATOR</span> == constraintValidator ? null : constraintValidator<span class="hljs-comment">;</span>
}
</code></pre>
<p><strong>注意最后一行</strong>：如果 <code>constraintValidator</code> 是 <code>DUMMY_CONSTRAINT_VALIDATOR</code>，就返回 null！</p>
<p>那么什么时候会创建 <code>DUMMY_CONSTRAINT_VALIDATOR</code> 呢？继续看 <code>createAndInitializeValidator</code> 方法：</p>
<pre><code class="hljs language-ini" lang="ini">private &lt;V, A extends Annotation&gt; ConstraintValidator&lt;A, V&gt; createAndInitializeValidator(
        ConstraintValidatorFactory constraintFactory,
        Type validatedValueType,
        ConstraintDescriptorImpl&lt;A&gt; descriptor) {

    // 1. 核心：查找匹配的验证器类
    Class&lt;? extends ConstraintValidator&lt;A, V&gt;&gt; <span class="hljs-attr">validatorClass</span> =
        (Class&lt;? extends ConstraintValidator&lt;A, V&gt;&gt;)
        findMatchingValidatorClass(descriptor, validatedValueType)<span class="hljs-comment">;</span>

    ConstraintValidator&lt;A, V&gt; constraintValidator<span class="hljs-comment">;</span>

    // 2. 如果找不到匹配的验证器类，返回 DUMMY！
    if (<span class="hljs-attr">validatorClass</span> == null) {
        <span class="hljs-attr">constraintValidator</span> = (ConstraintValidator&lt;A, V&gt;) DUMMY_CONSTRAINT_VALIDATOR<span class="hljs-comment">;</span>
    } else {
        // 3. 找到了验证器类，创建实例并初始化
        <span class="hljs-attr">constraintValidator</span> = constraintFactory.getInstance(validatorClass)<span class="hljs-comment">;</span>

        if (<span class="hljs-attr">constraintValidator</span> == null) {
            throw LOG.getConstraintFactoryMustNotReturnNullException(validatorClass)<span class="hljs-comment">;</span>
        }

        initializeValidator(descriptor, constraintValidator)<span class="hljs-comment">;</span>
    }

    return constraintValidator<span class="hljs-comment">;</span>
}
</code></pre>
<p><strong>关键在于 <code>findMatchingValidatorClass</code> 方法！</strong></p>
<p>这个方法会在 hibernate-validator 内部注册的验证器列表中查找：</p>
<ul>
<li>
<p>输入：<code>@NotBlank</code> 注解 + <code>String</code> 类型</p>
</li>
<li>
<p>查找：能处理这个组合的 <code>ConstraintValidator</code> 实现类</p>
</li>
<li>
<p>结果：</p>
<ul>
<li><strong>Hibernate Validator 6.x</strong>：找到 <code>org.hibernate.validator.internal.constraintvalidators.bv.NotBlankValidator</code></li>
<li><strong>Hibernate Validator 5.x</strong>：找不到（因为根本没有实现这个类），返回 null</li>
</ul>
</li>
</ul>
<p><strong>完整调用链：</strong></p>
<pre><code class="hljs language-scss" lang="scss">验证触发
  ↓
<span class="hljs-built_in">getConstraintValidatorNoUnwrapping</span>()
  ↓
<span class="hljs-built_in">getInitializedValidator</span>()  <span class="hljs-comment">// 从缓存或创建验证器</span>
  ↓
<span class="hljs-built_in">createAndInitializeValidator</span>()
  ↓
<span class="hljs-built_in">findMatchingValidatorClass</span>()  <span class="hljs-comment">// 查找验证器类</span>
  ↓
在 Hibernate Validator <span class="hljs-number">5</span><span class="hljs-selector-class">.x</span> 的验证器注册表中查找
  ↓
找不到 NotBlankValidator（因为 <span class="hljs-number">5</span><span class="hljs-selector-class">.x</span> 没有实现）
  ↓
返回 null
  ↓
创建 DUMMY_CONSTRAINT_VALIDATOR
  ↓
缓存并返回 DUMMY
  ↓
<span class="hljs-built_in">getInitializedValidator</span>() 检测到是 DUMMY，返回 null
  ↓
<span class="hljs-built_in">getConstraintValidatorNoUnwrapping</span>() 检测到 validator == null
  ↓
抛出 UnexpectedTypeException 异常
</code></pre>
<h4 data-id="heading-5">验证器是如何加载的？</h4>
<p>既然 <code>findMatchingValidatorClass</code> 方法找不到验证器，那么验证器列表是从哪里来的呢？我们可以通过 <strong>Java Field Watchpoints</strong> 来监控验证器列表的构建过程。</p>
<p>在 IDE 中对 <code>matchingConstraintValidatorClasses</code> 字段设置 Field Watchpoint，观察它何时被赋值：</p>
<p>你会发现断点停在了 <code>ConstraintHelper</code> 类的 <code>findValidatorClasses</code> 方法：</p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-comment">/**
 * 查找能够处理指定注解类型的所有验证器类
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-operator">&lt;</span><span class="hljs-type">A</span> extends <span class="hljs-type">Annotation</span><span class="hljs-operator">&gt;</span> <span class="hljs-type">List</span>&lt;<span class="hljs-type">Class</span>&lt;? extends <span class="hljs-type">ConstraintValidator</span>&lt;<span class="hljs-type">A</span>, ?&gt;&gt;&gt;
        findValidatorClasses(<span class="hljs-type">Class</span>&lt;<span class="hljs-type">A</span>&gt; annotationType, <span class="hljs-type">ValidationTarget</span> validationTarget) {

    <span class="hljs-comment">// 1. 获取该注解类型对应的所有验证器类（关键方法！）</span>
    <span class="hljs-type">List</span>&lt;<span class="hljs-type">Class</span>&lt;? extends <span class="hljs-type">ConstraintValidator</span>&lt;<span class="hljs-type">A</span>, ?&gt;&gt;&gt; validatorClasses <span class="hljs-operator">=</span>
        getAllValidatorClasses(annotationType);

    <span class="hljs-comment">// 2. 过滤出匹配的验证器类</span>
    <span class="hljs-type">List</span>&lt;<span class="hljs-type">Class</span>&lt;? extends <span class="hljs-type">ConstraintValidator</span>&lt;<span class="hljs-type">A</span>, ?&gt;&gt;&gt; matchingValidatorClasses <span class="hljs-operator">=</span>
        newArrayList();

    <span class="hljs-keyword">for</span> (<span class="hljs-type">Class</span>&lt;? extends <span class="hljs-type">ConstraintValidator</span>&lt;<span class="hljs-type">A</span>, ?&gt;&gt; validatorClass : validatorClasses) {
        <span class="hljs-comment">// 检查验证器是否支持指定的验证目标（方法参数、返回值等）</span>
        <span class="hljs-keyword">if</span> (supportsValidationTarget(validatorClass, validationTarget)) {
            matchingValidatorClasses.add(validatorClass);
        }
    }

    <span class="hljs-keyword">return</span> matchingValidatorClasses;
}
</code></pre>
<p><strong>关键在于 <code>getAllValidatorClasses</code> 方法！</strong></p>
<p>这个方法从内部的验证器注册表中查找：</p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">private</span> <span class="hljs-operator">&lt;</span><span class="hljs-type">A</span> extends <span class="hljs-type">Annotation</span><span class="hljs-operator">&gt;</span> <span class="hljs-type">List</span>&lt;<span class="hljs-type">Class</span>&lt;? extends <span class="hljs-type">ConstraintValidator</span>&lt;<span class="hljs-type">A</span>, ?&gt;&gt;&gt;
        getAllValidatorClasses(<span class="hljs-type">Class</span>&lt;<span class="hljs-type">A</span>&gt; annotationType) {

    <span class="hljs-comment">// 从 builtinConstraints 映射表中查找</span>
    <span class="hljs-type">List</span>&lt;<span class="hljs-type">Class</span>&lt;? extends <span class="hljs-type">ConstraintValidator</span>&lt;?, ?&gt;&gt;&gt; validatorClasses <span class="hljs-operator">=</span>
        builtinConstraints.get(annotationType);

    <span class="hljs-keyword">if</span> (validatorClasses <span class="hljs-operator">==</span> null) {
        <span class="hljs-comment">// 如果不是内置约束，尝试从注解的 @Constraint 元注解中获取</span>
        validatorClasses <span class="hljs-operator">=</span> getValidatorClassesFromConstraintAnnotation(annotationType);
    }

    <span class="hljs-keyword">return</span> (<span class="hljs-type">List</span>) validatorClasses;
}
</code></pre>
<h4 data-id="heading-6">验证器注册表：builtinConstraints 的初始化</h4>
<p><code>builtinConstraints</code> 是一个 <code>Map&lt;Class&lt;? extends Annotation&gt;, List&lt;Class&lt;? extends ConstraintValidator&lt;?, ?&gt;&gt;&gt;&gt;</code> 映射表，在 <code>ConstraintHelper</code> 构造函数中初始化。</p>
<p><strong>Hibernate Validator 5.x 的注册表：</strong></p>
<pre><code class="hljs language-ruby" lang="ruby"><span class="hljs-keyword">public</span> <span class="hljs-title class_">ConstraintHelper</span>() {
    <span class="hljs-title class_">Map</span>&lt;<span class="hljs-title class_">Class</span>&lt;? extends <span class="hljs-title class_">Annotation</span>&gt;, <span class="hljs-title class_">List</span>&lt;<span class="hljs-title class_">Class</span>&lt;? extends <span class="hljs-title class_">ConstraintValidator</span>&lt;<span class="hljs-string">?,</span> <span class="hljs-string">?&gt;</span>&gt;&gt;&gt;
        tmpConstraints = newHashMap();

    <span class="hljs-regexp">//</span> 注册 <span class="hljs-variable">@NotNull</span> 验证器
    putConstraint(tmpConstraints, <span class="hljs-title class_">NotNull</span>.<span class="hljs-keyword">class</span>,
        <span class="hljs-title class_">NotNullValidator</span>.<span class="hljs-keyword">class</span>);

    <span class="hljs-regexp">//</span> 注册 <span class="hljs-variable">@Size</span> 验证器（多个实现）
    putConstraints(tmpConstraints, <span class="hljs-title class_">Size</span>.<span class="hljs-keyword">class</span>,
        <span class="hljs-title class_">Arrays</span>.asList(
            <span class="hljs-title class_">SizeValidatorForCharSequence</span>.<span class="hljs-keyword">class</span>,
            <span class="hljs-title class_">SizeValidatorForCollection</span>.<span class="hljs-keyword">class</span>,
            <span class="hljs-title class_">SizeValidatorForArray</span>.<span class="hljs-keyword">class</span>,
            <span class="hljs-title class_">SizeValidatorForMap</span>.<span class="hljs-keyword">class</span>
        )
    );

    <span class="hljs-regexp">//</span> 注册 <span class="hljs-variable">@Min</span>, <span class="hljs-variable">@Max</span>, <span class="hljs-variable">@Pattern</span> 等...
    putConstraint(tmpConstraints, <span class="hljs-title class_">Min</span>.<span class="hljs-keyword">class</span>, <span class="hljs-title class_">MinValidatorForNumber</span>.<span class="hljs-keyword">class</span>);
    putConstraint(tmpConstraints, <span class="hljs-title class_">Max</span>.<span class="hljs-keyword">class</span>, <span class="hljs-title class_">MaxValidatorForNumber</span>.<span class="hljs-keyword">class</span>);
    putConstraint(tmpConstraints, <span class="hljs-title class_">Pattern</span>.<span class="hljs-keyword">class</span>, <span class="hljs-title class_">PatternValidator</span>.<span class="hljs-keyword">class</span>);

    <span class="hljs-regexp">//</span>注意：这里没有 <span class="hljs-title class_">NotBlank</span> 的注册！

    this.builtinConstraints = <span class="hljs-title class_">Collections</span>.unmodifiableMap(tmpConstraints);
}
</code></pre>
<h4 data-id="heading-7">完整的验证器查找流程</h4>
<p>现在我们可以把整个流程串起来了：</p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-number">1.</span> 应用启动
   ↓
<span class="hljs-number">2.</span> ConstraintHelper 初始化
   ↓
<span class="hljs-number">3.</span> 构建 builtinConstraints 映射表
   - Hibernate Validator <span class="hljs-number">5.</span>x: 没有 NotBlank.<span class="hljs-keyword">class</span> → NotBlankValidator.<span class="hljs-keyword">class</span> 映射
   - Hibernate Validator <span class="hljs-number">6.</span>x: 有 NotBlank.<span class="hljs-keyword">class</span> → NotBlankValidator.<span class="hljs-keyword">class</span> 映射
   ↓
<span class="hljs-number">4.</span> 触发字段校验（<span class="hljs-meta">@NotBlank</span> <span class="hljs-built_in">String</span> keywords）
   ↓
<span class="hljs-number">5.</span> findMatchingValidatorClass() 被调用
   ↓
<span class="hljs-number">6.</span> 调用 findValidatorClasses(NotBlank.<span class="hljs-keyword">class</span>, ...)
   ↓
<span class="hljs-number">7.</span> 调用 getAllValidatorClasses(NotBlank.<span class="hljs-keyword">class</span>)
   ↓
<span class="hljs-number">8.</span> 从 builtinConstraints.<span class="hljs-keyword">get</span>(NotBlank.<span class="hljs-keyword">class</span>) 查找
   - Hibernate Validator <span class="hljs-number">5.</span>x: 返回 <span class="hljs-keyword">null</span>（映射表中没有）
   - Hibernate Validator <span class="hljs-number">6.</span>x: 返回 [NotBlankValidator.<span class="hljs-keyword">class</span>]
   ↓
<span class="hljs-number">9.</span> Hibernate Validator <span class="hljs-number">5.</span>x 路径：
   validatorClasses == <span class="hljs-keyword">null</span>
   → matchingValidatorClasses 为空
   → findMatchingValidatorClass 返回 <span class="hljs-keyword">null</span>
   → 创建 DUMMY_CONSTRAINT_VALIDATOR
   → getInitializedValidator 返回 <span class="hljs-keyword">null</span>
   → 抛出 UnexpectedTypeException
</code></pre>
<p><strong>通过调试验证：</strong></p>
<p>你可以在以下位置打断点验证整个流程：</p>
<ol>
<li><code>ConstraintHelper</code> 构造函数 - 查看 <code>builtinConstraints</code> 的内容</li>
<li><code>getAllValidatorClasses</code> - 查看查找结果</li>
<li><code>findValidatorClasses</code> - 查看 <code>matchingValidatorClasses</code> 的构建</li>
<li><code>createAndInitializeValidator</code> - 查看 <code>validatorClass</code> 是否为 null</li>
</ol>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9dce800a6b9f4df399fcab760516837b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgOeWPt-i-vuS6ug==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764516380&amp;x-signature=cKfjRAcm80KkY63ndjenUIKeA0s%3D" alt="" loading="lazy"/></p>
<p>从调试截图可以清楚地看到：</p>
<ol>
<li>
<p><strong>有 <code>javax.validation.constraints.NotNull</code></strong></p>
<ul>
<li>这是标准 Bean Validation 注解</li>
<li>Hibernate Validator 5.x 支持</li>
</ul>
</li>
<li>
<p><strong>有 <code>org.hibernate.validator.constraints.NotBlank</code></strong></p>
<ul>
<li>注意包名！这是 <code>org.hibernate.validator.constraints</code></li>
<li>不是标准的 <code>javax.validation.constraints</code></li>
<li>这是 Hibernate Validator 自己扩展的注解，不是 Bean Validation 2.0 标准</li>
</ul>
</li>
<li>
<p><strong>没有 <code>javax.validation.constraints.NotBlank</code></strong></p>
<ul>
<li>标准的 Bean Validation 2.0 <code>@NotBlank</code> 不在映射表中</li>
<li>所以使用 <code>javax.validation.constraints.NotBlank</code> 会找不到验证器</li>
</ul>
</li>
</ol>
<p><strong>两个不同的 @NotBlank</strong></p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// ❌ 在 Hibernate Validator 5.x 中不支持（Bean Validation 2.0 标准）</span>
<span class="hljs-keyword">import</span> javax.<span class="hljs-property">validation</span>.<span class="hljs-property">constraints</span>.<span class="hljs-property">NotBlank</span>;

<span class="hljs-meta">@NotBlank</span>  <span class="hljs-comment">// 抛出异常：找不到验证器</span>
<span class="hljs-keyword">private</span> <span class="hljs-title class_">String</span> keywords;
</code></pre>

<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 在 Hibernate Validator 5.x 中支持（Hibernate 自定义扩展）</span>
<span class="hljs-keyword">import</span> org.<span class="hljs-property">hibernate</span>.<span class="hljs-property">validator</span>.<span class="hljs-property">constraints</span>.<span class="hljs-property">NotBlank</span>;

<span class="hljs-meta">@NotBlank</span>  <span class="hljs-comment">// 可以正常工作</span>
<span class="hljs-keyword">private</span> <span class="hljs-title class_">String</span> keywords;
</code></pre>
<p><strong>为什么会有两个 @NotBlank？</strong></p>
<ul>
<li><strong>Hibernate Validator 5.x 时代</strong>：<code>@NotBlank</code> 是 Hibernate 的自定义扩展，位于 <code>org.hibernate.validator.constraints</code> 包</li>
<li><strong>Bean Validation 2.0 时代</strong>：<code>@NotBlank</code> 被纳入标准规范，位于 <code>javax.validation.constraints</code> 包</li>
<li><strong>Hibernate Validator 6.x</strong>：同时支持两个包的 <code>@NotBlank</code>，建议使用标准包</li>
</ul>
<h2 data-id="heading-8">解决方案</h2>
<h3 data-id="heading-9">方案一：检查并添加依赖（推荐）</h3>
<p>确保 <code>pom.xml</code> 中包含正确版本的依赖：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- Bean Validation API --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>javax.validation<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>validation-api<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>2.0.1.Final<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>

<span class="hljs-comment">&lt;!-- Hibernate Validator 实现 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.hibernate.validator<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>hibernate-validator<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>6.2.5.Final<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
</code></pre>
<p><strong>注意版本对应关系：</strong></p>
<ul>
<li><code>validation-api 2.0.x</code> 对应 <code>hibernate-validator 6.x</code></li>
<li><code>validation-api 1.1.x</code> 对应 <code>hibernate-validator 5.x</code>（不支持 @NotBlank）</li>
</ul>
<h3 data-id="heading-10">方案二：使用 Spring Boot Starter</h3>
<p>如果是 Spring Boot 项目，推荐使用官方 starter：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-validation<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
</code></pre>
<p>这个 starter 会自动引入兼容版本的 <code>validation-api</code> 和 <code>hibernate-validator</code>。</p>
<h3 data-id="heading-11">方案三：降级使用 @NotEmpty 或 @NotNull + @Size</h3>
<p>如果暂时无法升级依赖，可以使用旧版本支持的注解组合：</p>
<pre><code class="hljs language-less" lang="less"><span class="hljs-comment">// 方式1：使用 @NotEmpty（Bean Validation 2.0）</span>
<span class="hljs-variable">@NotEmpty</span>
private String keywords;

<span class="hljs-comment">// 方式2：使用组合注解（Bean Validation 1.1）</span>
<span class="hljs-variable">@NotNull</span>
<span class="hljs-variable">@Size</span>(min = <span class="hljs-number">1</span>)
private String keywords;
</code></pre>
<h2 data-id="heading-12">总结</h2>
<p>这次踩坑让我深刻理解了：</p>
<ol>
<li><strong>注解定义和注解实现是分离的</strong>：validation-api 只提供规范，hibernate-validator 提供实现</li>
<li><strong>版本匹配很关键</strong>：Bean Validation 1.1 不支持 @NotBlank</li>
<li><strong>依赖管理要规范</strong>：使用 Spring Boot Starter 可以避免很多版本冲突问题</li>
<li><strong>错误信息要仔细读</strong>：<code>No validator could be found</code> 其实已经明确指出是缺少验证器实现</li>
</ol>
<p>普通公司开发确实需要注意这些细节，毕竟没有专门的架构组来统一管理依赖版本，踩过坑才能记得更牢。</p>
<hr/>
<p><strong>相关资源：</strong></p>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fbeanvalidation.org%2F2.0%2F" target="_blank" title="https://beanvalidation.org/2.0/" ref="nofollow noopener noreferrer">Bean Validation 2.0 规范</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fhibernate.org%2Fvalidator%2F" target="_blank" title="https://hibernate.org/validator/" ref="nofollow noopener noreferrer">Hibernate Validator 文档</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fspring.io%2Fguides%2Fgs%2Fvalidating-form-input%2F" target="_blank" title="https://spring.io/guides/gs/validating-form-input/" ref="nofollow noopener noreferrer">Spring Boot Validation 文档</a></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[深入解析 @DataScope 数据权限注解]]></title>    <link>https://juejin.cn/post/7575412016404742154</link>    <guid>https://juejin.cn/post/7575412016404742154</guid>    <pubDate>2025-11-23T15:36:52.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7575412016404742154" data-draft-id="7575438636331434035" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="深入解析 @DataScope 数据权限注解"/> <meta itemprop="keywords" content="Spring Boot"/> <meta itemprop="datePublished" content="2025-11-23T15:36:52.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="元Y亨H"/> <meta itemprop="url" content="https://juejin.cn/user/2839351584888617"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            深入解析 @DataScope 数据权限注解
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2839351584888617/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    元Y亨H
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-23T15:36:52.000Z" title="Sun Nov 23 2025 15:36:52 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    6
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><hr/>
<h2 data-id="heading-0">RuoYi 框架实战笔记：深入解析 @DataScope 数据权限注解</h2>
<h3 data-id="heading-1">1. 前言：为什么需要 @DataScope？</h3>
<p>在企业级后台管理系统中，权限控制通常分为两个维度：</p>
<ul>
<li><strong>功能权限</strong>：控制用户能看到哪些菜单、点击哪些按钮（通常通过 RBAC 模型 + <code>@PreAuthorize</code> 实现）。</li>
<li><strong>数据权限</strong>：控制用户能看到<strong>哪几行数据</strong>。例如：销售总监能看全公司的订单，部门经理只能看本部门的订单，普通销售只能看自己的订单。</li>
</ul>
<p>如果要在业务代码中通过 <code>if (user.isManager()) { ... }</code> 这种方式手动拼接 SQL，代码将变得极其臃肿且难以维护。RuoYi 框架提供的 <code>@DataScope</code> 注解，正是利用 <strong>AOP（面向切面编程）</strong> 技术，优雅地解决了这个问题。</p>
<hr/>
<h3 data-id="heading-2">2. 核心原理</h3>
<p><code>@DataScope</code> 的核心思想是：<strong>“在 SQL 执行前，根据当前登录用户的角色权限，动态拼接 SQL 过滤条件。”</strong></p>
<h4 data-id="heading-3">工作流程</h4>
<ol>
<li><strong>AOP 拦截</strong>：<code>DataScopeAspect</code> 切面拦截所有标记了 <code>@DataScope</code> 的方法。</li>
<li><strong>获取角色</strong>：获取当前登录用户及其绑定的角色信息。</li>
<li><strong>生成 SQL</strong>：根据角色配置的“数据范围”（Data Scope），生成一段 SQL 片段（如 <code>AND dept_id = 100</code>）。</li>
<li><strong>参数注入</strong>：将这段 SQL 注入到参数对象（需继承 <code>BaseEntity</code>）的 <code>params</code> 属性中。</li>
<li><strong>MyBatis 执行</strong>：在 XML 中通过 <code>${params.dataScope}</code> 将过滤条件拼接到主 SQL 后面。</li>
</ol>
<hr/>
<h3 data-id="heading-4">3. 支持的数据权限模式</h3>
<p>RuoYi 在“角色管理”中默认支持 5 种数据范围，底层逻辑如下：</p>









































<table><thead><tr><th align="left">权限名称</th><th align="left">对应代码</th><th align="left">逻辑描述</th><th align="left">SQL 示例片段</th></tr></thead><tbody><tr><td align="left"><strong>全部数据权限</strong></td><td align="left"><code>DATA_SCOPE_ALL</code></td><td align="left">不进行过滤，可查看所有数据</td><td align="left">(无拼接)</td></tr><tr><td align="left"><strong>自定数据权限</strong></td><td align="left"><code>DATA_SCOPE_CUSTOM</code></td><td align="left">根据角色配置的部门列表过滤</td><td align="left"><code>OR d.dept_id IN (SELECT dept_id FROM sys_role_dept WHERE role_id = X)</code></td></tr><tr><td align="left"><strong>部门数据权限</strong></td><td align="left"><code>DATA_SCOPE_DEPT</code></td><td align="left">仅查看本部门数据</td><td align="left"><code>OR d.dept_id = 101</code></td></tr><tr><td align="left"><strong>部门及以下</strong></td><td align="left"><code>DATA_SCOPE_DEPT_AND_CHILD</code></td><td align="left">查看本部门及所有子部门数据</td><td align="left"><code>OR d.dept_id IN (SELECT dept_id FROM sys_dept WHERE find_in_set(101, ancestors))</code></td></tr><tr><td align="left"><strong>仅本人数据</strong></td><td align="left"><code>DATA_SCOPE_SELF</code></td><td align="left">仅查看自己创建的数据</td><td align="left"><code>OR u.user_id = 1</code></td></tr></tbody></table>
<hr/>
<h3 data-id="heading-5">4. 使用指南（三步走）</h3>
<h4 data-id="heading-6">第一步：Service 层添加注解</h4>
<p>在需要过滤数据的业务方法上添加注解。</p>
<ul>
<li><strong><code>deptAlias</code></strong>：指定 SQL 中部门表的别名（默认 <code>d</code>）。</li>
<li><strong><code>userAlias</code></strong>：指定 SQL 中用户表的别名（默认 <code>u</code>）。</li>
</ul>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SysUserServiceImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">ISysUserService</span> {
    
    <span class="hljs-meta">@Override</span>
    <span class="hljs-comment">// 告诉切面：SQL里部门表别名是 d，用户表别名是 u</span>
    <span class="hljs-meta">@DataScope(deptAlias = "d", userAlias = "u")</span> 
    <span class="hljs-keyword">public</span> List&lt;SysUser&gt; <span class="hljs-title function_">selectUserList</span><span class="hljs-params">(SysUser user)</span> {
        <span class="hljs-keyword">return</span> userMapper.selectUserList(user);
    }
}
</code></pre>
<h4 data-id="heading-7">第二步：Entity 类继承 BaseEntity</h4>
<p>查询参数对象（如 <code>SysUser</code>）必须继承 <code>BaseEntity</code>，因为切面是将生成的 SQL 存入 <code>BaseEntity</code> 的 <code>params</code> map 中。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SysUser</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">BaseEntity</span> {
    <span class="hljs-comment">// ... 属性定义</span>
}
</code></pre>
<h4 data-id="heading-8">第三步：Mapper XML 拼接 SQL</h4>
<p>在 MyBatis 的 XML 文件中，将生成的 SQL 片段拼接到 <code>WHERE</code> 子句的最后。</p>
<blockquote>
<p><strong>注意</strong>：必须使用 <code>$</code> 符号（文本替换），不能使用 <code>#</code>（预编译）。</p>
</blockquote>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">select</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"selectUserList"</span> <span class="hljs-attr">parameterType</span>=<span class="hljs-string">"SysUser"</span> <span class="hljs-attr">resultMap</span>=<span class="hljs-string">"SysUserResult"</span>&gt;</span>
    SELECT u.user_id, u.dept_id, u.nick_name, d.dept_name
    FROM sys_user u
    LEFT JOIN sys_dept d ON u.dept_id = d.dept_id
    WHERE u.del_flag = '0'
    
    <span class="hljs-comment">&lt;!-- 关键点：动态拼接数据权限过滤 SQL --&gt;</span>
    ${params.dataScope}
    
<span class="hljs-tag">&lt;/<span class="hljs-name">select</span>&gt;</span>
</code></pre>
<hr/>
<h3 data-id="heading-9">5. 避坑指南与注意事项</h3>
<ol>
<li>
<p><strong>别名必须匹配</strong></p>
<ul>
<li>注解中的 <code>deptAlias="d"</code> 必须与 XML 中 <code>LEFT JOIN sys_dept d</code> 的别名严格一致。如果 XML 中写的是 <code>LEFT JOIN sys_dept sd</code>，则注解必须改为 <code>deptAlias="sd"</code>，否则会报 <code>Unknown column 'd.dept_id'</code> 错误。</li>
</ul>
</li>
<li>
<p><strong>超级管理员特权</strong></p>
<ul>
<li>如果是超级管理员（<code>admin</code> 或拥有所有权限的角色），切面逻辑通常会直接跳过，不拼接任何 SQL，从而拥有查看所有数据的权限。</li>
</ul>
</li>
<li>
<p><strong>数据表关联</strong></p>
<ul>
<li>如果要使用部门权限，主查询表必须包含 <code>dept_id</code> 或者关联了 <code>sys_dept</code> 表。</li>
<li>如果要使用“仅本人”权限，主查询表必须包含 <code>user_id</code> 或者关联了 <code>sys_user</code> 表。</li>
</ul>
</li>
<li>
<p><strong>参数对象限制</strong></p>
<ul>
<li>如果是自定义的 DTO 对象作为查询参数，务必确保它继承了 <code>BaseEntity</code>，或者你自己手动在 DTO 中添加 <code>Map&lt;String, Object&gt; params</code> 字段，否则切面无法注入 SQL。</li>
</ul>
</li>
<li>
<p><strong>多表连接时的歧义</strong></p>
<ul>
<li>如果多个表都有 <code>dept_id</code> 字段，务必通过 <code>deptAlias</code> 明确指定使用哪张表的字段进行过滤，防止 SQL 字段歧义（Ambiguous column）。</li>
</ul>
</li>
</ol>
<hr/>
<h3 data-id="heading-10">6. 总结</h3>
<p><code>@DataScope</code> 是 RuoYi 框架中解决数据隔离问题的“神兵利器”。它通过 <strong>解耦业务代码与权限逻辑</strong>，让开发者只需关注 SQL 关联关系，而无需关心复杂的权限判断，极大地提高了开发效率。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[MySQL性能优化处理]]></title>    <link>https://juejin.cn/post/7575119254314303514</link>    <guid>https://juejin.cn/post/7575119254314303514</guid>    <pubDate>2025-11-23T13:33:34.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7575119254314303514" data-draft-id="7575119254313467930" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="MySQL性能优化处理"/> <meta itemprop="keywords" content="MySQL"/> <meta itemprop="datePublished" content="2025-11-23T13:33:34.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="苏三的开发日记"/> <meta itemprop="url" content="https://juejin.cn/user/4248949048749213"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            MySQL性能优化处理
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4248949048749213/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    苏三的开发日记
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-23T13:33:34.000Z" title="Sun Nov 23 2025 13:33:34 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    2
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">✅ <strong>一、推荐的 my.cnf（生产环境优化模板）</strong></h2>
<blockquote>
<p>⚠️ 你只需要修改：</p>
<ul>
<li>内存大小（服务器内存 16G / 32G / 64G）</li>
<li>磁盘路径</li>
<li>InnoDB buffer pool size</li>
</ul>
</blockquote>
<p>下面的配置假设你的服务器 <strong>16GB RAM</strong></p>
<pre><code class="hljs language-js" lang="js">[client]
<span class="hljs-keyword">default</span>-character-set = utf8mb4

[mysql]
<span class="hljs-keyword">default</span>-character-set = utf8mb4

[mysqld]
# ========== 基础设置 ==========
user = mysql
port = <span class="hljs-number">3306</span>
basedir = <span class="hljs-regexp">/usr/</span>local/mysql
datadir = <span class="hljs-regexp">/data/my</span>sql
pid-file = <span class="hljs-regexp">/data/my</span>sql/mysqld.<span class="hljs-property">pid</span>
socket = <span class="hljs-regexp">/data/my</span>sql/mysql.<span class="hljs-property">sock</span>
character-set-server = utf8mb4
skip-name-resolve      # 禁止 <span class="hljs-variable constant_">DNS</span> 反查（性能明显提升）
sql_mode = <span class="hljs-variable constant_">STRICT_TRANS_TABLES</span>,<span class="hljs-variable constant_">NO_ENGINE_SUBSTITUTION</span>
table_open_cache = <span class="hljs-number">4096</span>
open_files_limit = <span class="hljs-number">8192</span>
# ========== <span class="hljs-title class_">InnoDB</span> 重要优化 ==========
innodb_buffer_pool_size = 8G     # 16G 机器设置为 8G（<span class="hljs-number">50</span>% 内存）
innodb_buffer_pool_instances = <span class="hljs-number">8</span> # buffer pool 分片（每G一个比较合适）
innodb_log_file_size = 1G        # redo log 单个大小，能减少 checkpoint 开销
innodb_log_buffer_size = 64M     # 写密集场景建议 64M~256M
innodb_flush_log_at_trx_commit = <span class="hljs-number">1</span> # 强一致性（建议生产默认 <span class="hljs-number">1</span>）
# 建议：高 <span class="hljs-variable constant_">QPS</span> 场景可改为 <span class="hljs-number">2</span>（性能提升<span class="hljs-number">10</span>倍，丢事务 <span class="hljs-string">"1s 内"</span>）
innodb_flush_method = <span class="hljs-variable constant_">O_DIRECT</span>   # 避免双缓存
innodb_file_per_table = <span class="hljs-number">1</span>        # 强烈推荐，表独立文件
innodb_io_capacity = <span class="hljs-number">4000</span>        # <span class="hljs-variable constant_">SSD</span> 建议 <span class="hljs-number">2000</span>~<span class="hljs-number">8000</span>
innodb_io_capacity_max = <span class="hljs-number">8000</span>

# ========== 连接管理 ==========
max_connections = <span class="hljs-number">2000</span>            # 大项目需要更高连接数
max_connect_errors = <span class="hljs-number">10</span>
wait_timeout = <span class="hljs-number">600</span>                # 空闲连接超时
interactive_timeout = <span class="hljs-number">600</span>

# ========== 查询缓存相关（<span class="hljs-title class_">MySQL</span> <span class="hljs-number">5.7</span> 才有） ==========
query_cache_type = <span class="hljs-number">0</span>
query_cache_size = <span class="hljs-number">0</span>

# ========== 日志设置 ==========
log_error = <span class="hljs-regexp">/data/my</span>sql/mysql-error.<span class="hljs-property">log</span>
slow_query_log = <span class="hljs-number">1</span>
slow_query_log_file = <span class="hljs-regexp">/data/my</span>sql/mysql-slow.<span class="hljs-property">log</span>
long_query_time = <span class="hljs-number">1</span>               # &gt;<span class="hljs-number">1</span> 秒记录慢 <span class="hljs-variable constant_">SQL</span>
log_queries_not_using_indexes = <span class="hljs-number">0</span> # 不建议开启，会爆日志

# ========== 临时表优化 ==========
tmp_table_size = 256M
max_heap_table_size = 256M

# ========== 排序 &amp; <span class="hljs-variable constant_">JOIN</span> 性能 ==========
sort_buffer_size = 4M
join_buffer_size = 4M
read_buffer_size = 4M
read_rnd_buffer_size = 4M

# ========== <span class="hljs-title class_">Binlog</span> ==========
server-id = <span class="hljs-number">1</span>
log_bin = mysql-bin
binlog_format = row
sync_binlog = <span class="hljs-number">1</span>      # 最安全，性能弱；高 <span class="hljs-variable constant_">QPS</span> 可设为 <span class="hljs-number">100</span>~<span class="hljs-number">1000</span>
expire_logs_days = <span class="hljs-number">7</span>
</code></pre>
<ul>
<li>
<p><strong>配置项:</strong> <code>innodb_flush_method</code></p>
</li>
<li>
<p><strong>作用:</strong> 控制数据和日志写入文件的方式。</p>
</li>
<li>
<p><strong>优化建议:</strong></p>
<ul>
<li>在 <strong>Linux/Unix</strong> 系统上，推荐使用 <strong><code>O_DIRECT</code></strong>。它绕过操作系统的文件系统缓存，直接写入磁盘，避免双重缓存，提高性能和稳定性。</li>
<li><strong>示例:</strong> <code>innodb_flush_method = O_DIRECT</code></li>
</ul>
</li>
<li>
<p><strong>配置项:</strong> <code>innodb_flush_log_at_trx_commit</code></p>
</li>
<li>
<p><strong>取值与含义:</strong></p>
<ul>
<li><strong><code>0</code> (性能最高):</strong> 每秒写入并刷新一次日志。有丢失一秒数据的风险。</li>
<li><strong><code>1</code> (默认，最安全):</strong> <strong>每次事务提交</strong>都写入并刷新日志到磁盘。<strong>最安全，但 I/O 开销最大</strong>。</li>
<li><strong><code>2</code> (折中):</strong> 每次提交写入日志，但只每秒刷新一次到磁盘。比 <code>1</code> 快，比 <code>0</code> 安全。</li>
</ul>
</li>
<li>
<p><strong>配置项:</strong> <code>sort_buffer_size</code></p>
</li>
<li>
<p><strong>作用:</strong> 用于处理需要排序的查询（如 <code>ORDER BY</code> 或 <code>GROUP BY</code>）。每个需要排序的连接都会分配这个大小的内存。</p>
</li>
<li>
<p><strong>优化建议:</strong></p>
<ul>
<li><strong>不应设置得太大</strong>，因为它分配给<strong>每个会话</strong>。</li>
<li>通常设置为 <strong>1MB 到 2MB</strong>。如果查询涉及大量排序，可以适当提高。</li>
</ul>
</li>
<li>
<p><strong>配置项:</strong> <code>join_buffer_size</code></p>
</li>
<li>
<p><strong>作用:</strong> 用于连接（JOIN）操作中无法使用索引时的缓冲区。</p>
</li>
<li>
<p><strong>优化建议:</strong></p>
<ul>
<li>和 <code>sort_buffer_size</code> 类似，也是每个连接分配。</li>
<li>通常设置为 <strong>128KB 到 1MB</strong>。</li>
<li><strong>示例:</strong> <code>join_buffer_size = 512K</code></li>
</ul>
</li>
<li>
<p><strong>配置项:</strong> <code>table_open_cache</code></p>
</li>
<li>
<p><strong>作用:</strong> 设置表打开缓存的大小，减少打开表时的磁盘I/O</p>
</li>
<li>
<p><strong>优化建议:</strong>: 设置为4096以提高表打开速度。</p>
</li>
<li>
<p><strong>配置项:</strong>  <code>open_files_limit</code></p>
</li>
<li>
<p><strong>作用:</strong> 决定了 MySQL 的文件 I/O 能力的边界</p>
</li>
<li>
<p><strong>优化建议:</strong> 通常建议将 open_files_limit 设置为 table_open_cache 值的 两倍或更高，并预留一些空间给其他日志和连接使用。</p>
</li>
</ul>
<blockquote>
<ul>
<li>操作系统限制：open_files_limit 的值不能超过操作系统为该用户或整个系统设置的硬性文件描述符限制（通过 ulimit -Hn 命令查看）。如果需要设置更大的值，您必须首先在操作系统的配置文件（如 /etc/security/limits.conf）中调整限制。</li>
</ul>
</blockquote>
<h2 data-id="heading-1">✅ <strong>二、关键优化参数详细解释（必须理解）</strong></h2>
<p>以下是性能提升最大的一些配置。</p>
<hr/>
<h3 data-id="heading-2"><strong>1）innodb_buffer_pool_size（最重要）</strong></h3>
<blockquote>
<p>InnoDB 的数据、索引都在这里缓存。<br/>
<strong>一般设置为机器内存 50%～70%。</strong></p>
</blockquote>





















<table><thead><tr><th>服务器内存</th><th>建议设置</th></tr></thead><tbody><tr><td>8GB</td><td>4G–5G</td></tr><tr><td>16GB</td><td>8G–12G</td></tr><tr><td>32GB</td><td>16G–26G</td></tr></tbody></table>
<h3 data-id="heading-3"><strong>2）innodb_log_file_size（事务写性能关键）</strong></h3>
<ul>
<li>默认只有几十 MB，非常低！</li>
<li>建议改成：</li>
</ul>
<pre><code class="hljs language-js" lang="js">1G ~ 4G（取决于你的写入量）
</code></pre>
<p>好处：减少 checkpoint，提升写性能（电商退款 / 订单高并发很关键）</p>
<h3 data-id="heading-4">3）innodb_flush_log_at_trx_commit（最重要的性能与安全开关）</h3>





























<table><thead><tr><th>值</th><th>说明</th><th>性能</th><th>风险</th></tr></thead><tbody><tr><td>1（默认）</td><td>每次事务提交都写磁盘</td><td>最慢</td><td>最安全</td></tr><tr><td>2</td><td>写 OS buffer，1 秒刷盘</td><td>⭐ 很快</td><td>崩溃丢失 1 秒数据</td></tr><tr><td>0</td><td>延迟写日志</td><td>⭐ 超快</td><td>可能丢大量事务</td></tr></tbody></table>
<p>你的场景（商城）推荐 1 或 2。</p>
<h3 data-id="heading-5"><strong>4）innodb_flush_method = O_DIRECT</strong></h3>
<p>防止双缓存（OS + MySQL），提升 IO 性能。</p>
<p>SSD 场景强烈推荐。</p>
<h3 data-id="heading-6"><strong>5）max_connections</strong></h3>
<p>很多项目默认只有 <em>151</em>，并发稍高立刻“Too many connections”。</p>
<p>一般：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-number">2000</span>（足够大部分互联网项目）
</code></pre>
<h3 data-id="heading-7"><strong>6）tmp_table_size &amp; max_heap_table_size</strong></h3>
<p>避免复杂 SQL（group by、order by）频繁写磁盘：</p>
<pre><code class="hljs language-js" lang="js">256M 对大部分业务够用了
</code></pre>
<h3 data-id="heading-8"><strong>7）sort_buffer_size / join_buffer_size</strong></h3>
<p>不要设置太大！！每个连接都会分配！</p>
<p>4M 是一个非常安全的值。</p>
<h3 data-id="heading-9"><strong>8）sync_binlog（主从复制 / 容灾）</strong></h3>
<ul>
<li>最安全：1</li>
<li>高吞吐：100～1000</li>
</ul>
<p>你做电商退款、支付，建议：</p>
<pre><code class="hljs language-js" lang="js">sync_binlog = <span class="hljs-number">1</span>
binlog_format = row
</code></pre>
<p>保证 binlog 一致性，方便恢复。</p>
<p>✅ <strong>三、常见优化场景建议</strong></p>
<ol>
<li>高读写电商系统（你的场景）</li>
</ol>
<pre><code class="hljs language-js" lang="js">innodb_buffer_pool_size = <span class="hljs-number">50</span>%-<span class="hljs-number">70</span>% 内存
innodb_log_file_size = 1G
innodb_flush_log_at_trx_commit = <span class="hljs-number">1</span>
innodb_io_capacity = <span class="hljs-number">4000</span>
sync_binlog = <span class="hljs-number">1</span>
max_connections = <span class="hljs-number">2000</span>
</code></pre>
<ol start="2">
<li>高并发服务接口（订单、支付、库存）</li>
</ol>
<pre><code class="hljs language-js" lang="js">join_buffer_size = 4M
sort_buffer_size = 4M
tmp_table_size = 256M
max_heap_table_size = 256M
</code></pre>
<h2 data-id="heading-10">✅ <strong>四、完整优化策略总结（一句话理解）</strong></h2>
<blockquote>
<p>MySQL 性能优化的核心：<br/>
<strong>让热数据都放在内存里，减少磁盘 IO，并减少每次事务刷盘次数</strong></p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Figma Vector Networks: 形状、填充及描边]]></title>    <link>https://juejin.cn/post/7575655132755460115</link>    <guid>https://juejin.cn/post/7575655132755460115</guid>    <pubDate>2025-11-23T12:12:25.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7575655132755460115" data-draft-id="7575655132755427347" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Figma Vector Networks: 形状、填充及描边"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-11-23T12:12:25.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="听风说图"/> <meta itemprop="url" content="https://juejin.cn/user/198345371681864"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Figma Vector Networks: 形状、填充及描边
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/198345371681864/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    听风说图
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-23T12:12:25.000Z" title="Sun Nov 23 2025 12:12:25 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言</h2>
<p>在<a href="https://link.juejin.cn?target=https%3A%2F%2F01joy.com%2Frww%2Ffigma-vector-networks.html" target="_blank" title="https://01joy.com/rww/figma-vector-networks.html" ref="nofollow noopener noreferrer">《Figma Vector Networks: 重新定义矢量图形编辑》</a>一文中，我们分析了Vector Networks (矢量网格)与SVG Path的根本差异。Vector Networks之所以被视为“更高维度”的表述，在于其独特的拓扑结构，这为矢量图形的编辑带来了前所未有的灵活性与效率。</p>
<p>本文将举例说明用Vector Networks表示下面图形的形状、填充及描边。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/47e9cc15c0d74f7d805b38f01f1ef7ec~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZCs6aOO6K-05Zu-:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764504745&amp;x-signature=JA8jY0g25QH9lgCNcqct19mtpj0%3D" alt="" loading="lazy"/></p>
<p>以上图形分为两类：左边是由直线组成的，右边是由曲线组成的，当然无论矢量图形有多复杂，都可以用Vector Networks表示。</p>
<h2 data-id="heading-1">概述</h2>
<p>文章以具体图形为例，详细解析了 Vector Networks 的组成结构——包括<strong>节点（vertices）</strong> 、<strong>线条（segments）</strong> 和<strong>区域（regions）</strong> ，并展示了如何通过 JSON 结构描述直线、矩形、三角形、五角星、曲线和椭圆等常见图形。</p>
<p>同时，文章还区分了底层矢量引擎与上层工具开发者的职责，强调了 Vector Networks 在简化矢量图形编辑复杂度方面的重要作用。</p>
<h2 data-id="heading-2">化繁为简</h2>
<p>Vector Networks主要由点、线、和区域组成。</p>
<p>对底层矢量引擎开发者来说，需要将Vector Networks这种描述协议转换成GPU可识别的渲染命令，而解析的核心功能是根据节点和线条自动识别区域。</p>
<p>对上层矢量工具开发者来说，不需要关心如何解析Vector Networks，只要关注矢量图形的编辑交互功能。</p>
<p>这样划分的好处是：底层矢量引擎将任意矢量图形抽象成Vector Networks，并自动识别出了矢量网格中的区域，暴露出矢量网格的点线编辑，大大简化了矢量图形编辑的复杂度。</p>
<h2 data-id="heading-3">公共部分</h2>
<ul>
<li>type 是图形类型</li>
<li>strokeWeight 描边线宽</li>
<li>strokeAlign 描边对齐方式，分为：Center、Inside、Outside</li>
<li>strokePaints 主要是描边颜色数组</li>
<li>fillPaints 主要是填充颜色数组</li>
<li>vectorNetwork存储的是矢量网格数据，包含节点数组、线条数组、区域数组</li>
</ul>

<ul>
<li>
<ul>
<li>vertices是节点数组，每个节点有自己的坐标和样式索引styleID (默认对应到strokePaints数组下标)</li>
<li>segments是线条数组，每个线条有起始节点的索引vertex，和对应的控制点dx/dy（曲线会用到），结束点的索引vertex，和对应的控制点dx/dy，以及样式索引styleID</li>
<li>regions是区域数组，包含多个区域。</li>
</ul>
</li>
</ul>

<ul>
<li>
<ul>
<li>
<ul>
<li>每个区域的styleID (填充样式索引) 定义了当前区域的填充，默认对应到fillPaints数组下标，也可以对应到styleOverrideTable样式覆盖表里</li>
<li>每个区域的loops (区域) 定义了当前区域的拓扑结构，由多个segments (环) 组成，如果只有一个segments则代表当前区域由一个环围城，多个segments一般代表由内环和外环共同围城的区域</li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 data-id="heading-4">直线</h2>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> line = {
    <span class="hljs-string">"type"</span>: <span class="hljs-string">"VECTOR"</span>, <span class="hljs-comment">// 图形类型是矢量网格</span>
    <span class="hljs-string">"strokeWeight"</span>: <span class="hljs-number">1</span>, <span class="hljs-comment">// 描边宽度为1个单位</span>
    <span class="hljs-string">"strokeAlign"</span>: <span class="hljs-string">"CENTER"</span>, <span class="hljs-comment">// 描边对齐方式为居中</span>
    <span class="hljs-string">"strokeJoin"</span>: <span class="hljs-string">"MITER"</span>, <span class="hljs-comment">// 描边连接方式为尖角连接</span>
    <span class="hljs-string">"strokePaints"</span>: [
        {
            <span class="hljs-string">"type"</span>: <span class="hljs-string">"SOLID"</span>,
            <span class="hljs-string">"color"</span>: { <span class="hljs-comment">// 描边颜色</span>
                <span class="hljs-string">"r"</span>: <span class="hljs-number">0</span>,
                <span class="hljs-string">"g"</span>: <span class="hljs-number">0</span>,
                <span class="hljs-string">"b"</span>: <span class="hljs-number">0</span>,
                <span class="hljs-string">"a"</span>: <span class="hljs-number">1</span>
            },
            <span class="hljs-string">"opacity"</span>: <span class="hljs-number">1</span>,
            <span class="hljs-string">"visible"</span>: <span class="hljs-literal">true</span>,
            <span class="hljs-string">"blendMode"</span>: <span class="hljs-string">"NORMAL"</span>
        }
    ],
    <span class="hljs-string">"vectorNetwork"</span>: { <span class="hljs-comment">// 矢量网络数据</span>
        <span class="hljs-string">"vertices"</span>: [ <span class="hljs-comment">// 顶点数组</span>
            {
                <span class="hljs-string">"styleID"</span>: <span class="hljs-number">0</span>, <span class="hljs-comment">// 顶点样式ID，对应描边样式数组的第一个样式</span>
                <span class="hljs-string">"x"</span>: <span class="hljs-number">0</span>,
                <span class="hljs-string">"y"</span>: <span class="hljs-number">1</span>
            },
            {
                <span class="hljs-string">"styleID"</span>: <span class="hljs-number">0</span>,
                <span class="hljs-string">"x"</span>: <span class="hljs-number">100</span>,
                <span class="hljs-string">"y"</span>: <span class="hljs-number">0</span>
            }
        ],
        <span class="hljs-string">"segments"</span>: [ <span class="hljs-comment">// 线条数组</span>
            {
                <span class="hljs-string">"styleID"</span>: <span class="hljs-number">0</span>, <span class="hljs-comment">// 线条样式ID，对应描边样式数组的第一个样式</span>
                <span class="hljs-string">"start"</span>: {
                    <span class="hljs-string">"vertex"</span>: <span class="hljs-number">0</span>,
                    <span class="hljs-string">"dx"</span>: <span class="hljs-number">0</span>,
                    <span class="hljs-string">"dy"</span>: <span class="hljs-number">0</span>
                },
                <span class="hljs-string">"end"</span>: {
                    <span class="hljs-string">"vertex"</span>: <span class="hljs-number">1</span>,
                    <span class="hljs-string">"dx"</span>: <span class="hljs-number">0</span>,
                    <span class="hljs-string">"dy"</span>: <span class="hljs-number">0</span>
                }
            }
        ],
        <span class="hljs-string">"regions"</span>: [] <span class="hljs-comment">// 区域数组为空，表示没有可填充区域</span>
    }
};
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> line;
</code></pre>
<h2 data-id="heading-5">矩形</h2>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> rectangle = {
    <span class="hljs-string">"type"</span>: <span class="hljs-string">"ROUNDED_RECTANGLE"</span>,
    <span class="hljs-string">"strokeWeight"</span>: <span class="hljs-number">1</span>,
    <span class="hljs-string">"strokeAlign"</span>: <span class="hljs-string">"INSIDE"</span>,
    <span class="hljs-string">"strokeJoin"</span>: <span class="hljs-string">"MITER"</span>,
    <span class="hljs-string">"fillPaints"</span>: [
        {
            <span class="hljs-string">"type"</span>: <span class="hljs-string">"SOLID"</span>,
            <span class="hljs-string">"color"</span>: { <span class="hljs-comment">// 填充颜色</span>
                <span class="hljs-string">"r"</span>: <span class="hljs-number">0.8509804010391235</span>,
                <span class="hljs-string">"g"</span>: <span class="hljs-number">0.8509804010391235</span>,
                <span class="hljs-string">"b"</span>: <span class="hljs-number">0.8509804010391235</span>,
                <span class="hljs-string">"a"</span>: <span class="hljs-number">1</span>
            },
            <span class="hljs-string">"opacity"</span>: <span class="hljs-number">1</span>,
            <span class="hljs-string">"visible"</span>: <span class="hljs-literal">true</span>,
            <span class="hljs-string">"blendMode"</span>: <span class="hljs-string">"NORMAL"</span>
        }
    ],
    <span class="hljs-string">"strokePaints"</span>: [
        {
            <span class="hljs-string">"type"</span>: <span class="hljs-string">"SOLID"</span>,
            <span class="hljs-string">"color"</span>: { <span class="hljs-comment">// 描边颜色</span>
                <span class="hljs-string">"r"</span>: <span class="hljs-number">0</span>,
                <span class="hljs-string">"g"</span>: <span class="hljs-number">0</span>,
                <span class="hljs-string">"b"</span>: <span class="hljs-number">0</span>,
                <span class="hljs-string">"a"</span>: <span class="hljs-number">1</span>
            },
            <span class="hljs-string">"opacity"</span>: <span class="hljs-number">1</span>,
            <span class="hljs-string">"visible"</span>: <span class="hljs-literal">true</span>,
            <span class="hljs-string">"blendMode"</span>: <span class="hljs-string">"NORMAL"</span>
        }
    ],
    <span class="hljs-string">"vectorNetwork"</span>: {
        <span class="hljs-string">"vertices"</span>: [
            {
                <span class="hljs-string">"styleID"</span>: <span class="hljs-number">0</span>,
                <span class="hljs-string">"x"</span>: <span class="hljs-number">0</span>,
                <span class="hljs-string">"y"</span>: <span class="hljs-number">0</span>
            },
            {
                <span class="hljs-string">"styleID"</span>: <span class="hljs-number">0</span>,
                <span class="hljs-string">"x"</span>: <span class="hljs-number">100</span>,
                <span class="hljs-string">"y"</span>: <span class="hljs-number">0</span>
            },
            {
                <span class="hljs-string">"styleID"</span>: <span class="hljs-number">0</span>,
                <span class="hljs-string">"x"</span>: <span class="hljs-number">100</span>,
                <span class="hljs-string">"y"</span>: <span class="hljs-number">50</span>
            },
            {
                <span class="hljs-string">"styleID"</span>: <span class="hljs-number">0</span>,
                <span class="hljs-string">"x"</span>: <span class="hljs-number">0</span>,
                <span class="hljs-string">"y"</span>: <span class="hljs-number">50</span>
            }
        ],
        <span class="hljs-string">"segments"</span>: [
            {
                <span class="hljs-string">"styleID"</span>: <span class="hljs-number">0</span>,
                <span class="hljs-string">"start"</span>: {
                    <span class="hljs-string">"vertex"</span>: <span class="hljs-number">0</span>,
                    <span class="hljs-string">"dx"</span>: <span class="hljs-number">0</span>,
                    <span class="hljs-string">"dy"</span>: <span class="hljs-number">0</span>
                },
                <span class="hljs-string">"end"</span>: {
                    <span class="hljs-string">"vertex"</span>: <span class="hljs-number">1</span>,
                    <span class="hljs-string">"dx"</span>: <span class="hljs-number">0</span>,
                    <span class="hljs-string">"dy"</span>: <span class="hljs-number">0</span>
                }
            },
            {
                <span class="hljs-string">"styleID"</span>: <span class="hljs-number">0</span>,
                <span class="hljs-string">"start"</span>: {
                    <span class="hljs-string">"vertex"</span>: <span class="hljs-number">1</span>,
                    <span class="hljs-string">"dx"</span>: <span class="hljs-number">0</span>,
                    <span class="hljs-string">"dy"</span>: <span class="hljs-number">0</span>
                },
                <span class="hljs-string">"end"</span>: {
                    <span class="hljs-string">"vertex"</span>: <span class="hljs-number">2</span>,
                    <span class="hljs-string">"dx"</span>: <span class="hljs-number">0</span>,
                    <span class="hljs-string">"dy"</span>: <span class="hljs-number">0</span>
                }
            },
            {
                <span class="hljs-string">"styleID"</span>: <span class="hljs-number">0</span>,
                <span class="hljs-string">"start"</span>: {
                    <span class="hljs-string">"vertex"</span>: <span class="hljs-number">2</span>,
                    <span class="hljs-string">"dx"</span>: <span class="hljs-number">0</span>,
                    <span class="hljs-string">"dy"</span>: <span class="hljs-number">0</span>
                },
                <span class="hljs-string">"end"</span>: {
                    <span class="hljs-string">"vertex"</span>: <span class="hljs-number">3</span>,
                    <span class="hljs-string">"dx"</span>: <span class="hljs-number">0</span>,
                    <span class="hljs-string">"dy"</span>: <span class="hljs-number">0</span>
                }
            },
            {
                <span class="hljs-string">"styleID"</span>: <span class="hljs-number">0</span>,
                <span class="hljs-string">"start"</span>: {
                    <span class="hljs-string">"vertex"</span>: <span class="hljs-number">3</span>,
                    <span class="hljs-string">"dx"</span>: <span class="hljs-number">0</span>,
                    <span class="hljs-string">"dy"</span>: <span class="hljs-number">0</span>
                },
                <span class="hljs-string">"end"</span>: {
                    <span class="hljs-string">"vertex"</span>: <span class="hljs-number">0</span>,
                    <span class="hljs-string">"dx"</span>: <span class="hljs-number">0</span>,
                    <span class="hljs-string">"dy"</span>: <span class="hljs-number">0</span>
                }
            }
        ],
        <span class="hljs-string">"regions"</span>: [ <span class="hljs-comment">// 区域数组里有一个区域</span>
            {
                <span class="hljs-string">"styleID"</span>: <span class="hljs-number">0</span>,
                <span class="hljs-string">"windingRule"</span>: <span class="hljs-string">"NONZERO"</span>,
                <span class="hljs-string">"loops"</span>: [ <span class="hljs-comment">// 当前区域由一个环围城</span>
                    {
                        <span class="hljs-string">"segments"</span>: [ <span class="hljs-comment">// 当前环由边 0/1/2/3 四条边围城</span>
                            <span class="hljs-number">0</span>,
                            <span class="hljs-number">1</span>,
                            <span class="hljs-number">2</span>,
                            <span class="hljs-number">3</span>
                        ]
                    }
                ]
            }
        ]
    }
};
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> rectangle;
</code></pre>
<h2 data-id="heading-6">三角形</h2>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> polygon = {
    <span class="hljs-string">"type"</span>: <span class="hljs-string">"REGULAR_POLYGON"</span>,
    <span class="hljs-string">"strokeWeight"</span>: <span class="hljs-number">1</span>,
    <span class="hljs-string">"strokeAlign"</span>: <span class="hljs-string">"INSIDE"</span>,
    <span class="hljs-string">"strokeJoin"</span>: <span class="hljs-string">"MITER"</span>,
    <span class="hljs-string">"fillPaints"</span>: [
        {
            <span class="hljs-string">"type"</span>: <span class="hljs-string">"SOLID"</span>,
            <span class="hljs-string">"color"</span>: {
                <span class="hljs-string">"r"</span>: <span class="hljs-number">0.8509804010391235</span>,
                <span class="hljs-string">"g"</span>: <span class="hljs-number">0.8509804010391235</span>,
                <span class="hljs-string">"b"</span>: <span class="hljs-number">0.8509804010391235</span>,
                <span class="hljs-string">"a"</span>: <span class="hljs-number">1</span>
            },
            <span class="hljs-string">"opacity"</span>: <span class="hljs-number">1</span>,
            <span class="hljs-string">"visible"</span>: <span class="hljs-literal">true</span>,
            <span class="hljs-string">"blendMode"</span>: <span class="hljs-string">"NORMAL"</span>
        }
    ],
    <span class="hljs-string">"strokePaints"</span>: [
        {
            <span class="hljs-string">"type"</span>: <span class="hljs-string">"SOLID"</span>,
            <span class="hljs-string">"color"</span>: {
                <span class="hljs-string">"r"</span>: <span class="hljs-number">0</span>,
                <span class="hljs-string">"g"</span>: <span class="hljs-number">0</span>,
                <span class="hljs-string">"b"</span>: <span class="hljs-number">0</span>,
                <span class="hljs-string">"a"</span>: <span class="hljs-number">1</span>
            },
            <span class="hljs-string">"opacity"</span>: <span class="hljs-number">1</span>,
            <span class="hljs-string">"visible"</span>: <span class="hljs-literal">true</span>,
            <span class="hljs-string">"blendMode"</span>: <span class="hljs-string">"NORMAL"</span>
        }
    ],
    <span class="hljs-string">"vectorNetwork"</span>: {
        <span class="hljs-string">"vertices"</span>: [
            {
                <span class="hljs-string">"styleID"</span>: <span class="hljs-number">0</span>,
                <span class="hljs-string">"x"</span>: <span class="hljs-number">50</span>,
                <span class="hljs-string">"y"</span>: <span class="hljs-number">0</span>
            },
            {
                <span class="hljs-string">"styleID"</span>: <span class="hljs-number">0</span>,
                <span class="hljs-string">"x"</span>: <span class="hljs-number">93.30126953125</span>,
                <span class="hljs-string">"y"</span>: <span class="hljs-number">75</span>
            },
            {
                <span class="hljs-string">"styleID"</span>: <span class="hljs-number">0</span>,
                <span class="hljs-string">"x"</span>: <span class="hljs-number">6.69873046875</span>,
                <span class="hljs-string">"y"</span>: <span class="hljs-number">75</span>
            }
        ],
        <span class="hljs-string">"segments"</span>: [
            {
                <span class="hljs-string">"styleID"</span>: <span class="hljs-number">0</span>,
                <span class="hljs-string">"start"</span>: {
                    <span class="hljs-string">"vertex"</span>: <span class="hljs-number">0</span>,
                    <span class="hljs-string">"dx"</span>: <span class="hljs-number">0</span>,
                    <span class="hljs-string">"dy"</span>: <span class="hljs-number">0</span>
                },
                <span class="hljs-string">"end"</span>: {
                    <span class="hljs-string">"vertex"</span>: <span class="hljs-number">1</span>,
                    <span class="hljs-string">"dx"</span>: <span class="hljs-number">0</span>,
                    <span class="hljs-string">"dy"</span>: <span class="hljs-number">0</span>
                }
            },
            {
                <span class="hljs-string">"styleID"</span>: <span class="hljs-number">0</span>,
                <span class="hljs-string">"start"</span>: {
                    <span class="hljs-string">"vertex"</span>: <span class="hljs-number">1</span>,
                    <span class="hljs-string">"dx"</span>: <span class="hljs-number">0</span>,
                    <span class="hljs-string">"dy"</span>: <span class="hljs-number">0</span>
                },
                <span class="hljs-string">"end"</span>: {
                    <span class="hljs-string">"vertex"</span>: <span class="hljs-number">2</span>,
                    <span class="hljs-string">"dx"</span>: <span class="hljs-number">0</span>,
                    <span class="hljs-string">"dy"</span>: <span class="hljs-number">0</span>
                }
            },
            {
                <span class="hljs-string">"styleID"</span>: <span class="hljs-number">0</span>,
                <span class="hljs-string">"start"</span>: {
                    <span class="hljs-string">"vertex"</span>: <span class="hljs-number">2</span>,
                    <span class="hljs-string">"dx"</span>: <span class="hljs-number">0</span>,
                    <span class="hljs-string">"dy"</span>: <span class="hljs-number">0</span>
                },
                <span class="hljs-string">"end"</span>: {
                    <span class="hljs-string">"vertex"</span>: <span class="hljs-number">0</span>,
                    <span class="hljs-string">"dx"</span>: <span class="hljs-number">0</span>,
                    <span class="hljs-string">"dy"</span>: <span class="hljs-number">0</span>
                }
            }
        ],
        <span class="hljs-string">"regions"</span>: [
            {
                <span class="hljs-string">"styleID"</span>: <span class="hljs-number">0</span>,
                <span class="hljs-string">"windingRule"</span>: <span class="hljs-string">"NONZERO"</span>,
                <span class="hljs-string">"loops"</span>: [
                    {
                        <span class="hljs-string">"segments"</span>: [ <span class="hljs-comment">// 当前环由三个边围成</span>
                            <span class="hljs-number">0</span>,
                            <span class="hljs-number">1</span>,
                            <span class="hljs-number">2</span>
                        ]
                    }
                ]
            }
        ]
    }
};
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> polygon;
</code></pre>
<h2 data-id="heading-7">五角星</h2>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> star = {
    <span class="hljs-string">"type"</span>: <span class="hljs-string">"STAR"</span>,
    <span class="hljs-string">"strokeWeight"</span>: <span class="hljs-number">1</span>,
    <span class="hljs-string">"strokeAlign"</span>: <span class="hljs-string">"INSIDE"</span>,
    <span class="hljs-string">"strokeJoin"</span>: <span class="hljs-string">"MITER"</span>,
    <span class="hljs-string">"fillPaints"</span>: [
        {
            <span class="hljs-string">"type"</span>: <span class="hljs-string">"SOLID"</span>,
            <span class="hljs-string">"color"</span>: {
                <span class="hljs-string">"r"</span>: <span class="hljs-number">0.8509804010391235</span>,
                <span class="hljs-string">"g"</span>: <span class="hljs-number">0.8509804010391235</span>,
                <span class="hljs-string">"b"</span>: <span class="hljs-number">0.8509804010391235</span>,
                <span class="hljs-string">"a"</span>: <span class="hljs-number">1</span>
            },
            <span class="hljs-string">"opacity"</span>: <span class="hljs-number">1</span>,
            <span class="hljs-string">"visible"</span>: <span class="hljs-literal">true</span>,
            <span class="hljs-string">"blendMode"</span>: <span class="hljs-string">"NORMAL"</span>
        }
    ],
    <span class="hljs-string">"strokePaints"</span>: [
        {
            <span class="hljs-string">"type"</span>: <span class="hljs-string">"SOLID"</span>,
            <span class="hljs-string">"color"</span>: {
                <span class="hljs-string">"r"</span>: <span class="hljs-number">0</span>,
                <span class="hljs-string">"g"</span>: <span class="hljs-number">0</span>,
                <span class="hljs-string">"b"</span>: <span class="hljs-number">0</span>,
                <span class="hljs-string">"a"</span>: <span class="hljs-number">1</span>
            },
            <span class="hljs-string">"opacity"</span>: <span class="hljs-number">1</span>,
            <span class="hljs-string">"visible"</span>: <span class="hljs-literal">true</span>,
            <span class="hljs-string">"blendMode"</span>: <span class="hljs-string">"NORMAL"</span>
        }
    ],
    <span class="hljs-string">"vectorNetwork"</span>: {
        <span class="hljs-string">"vertices"</span>: [
            {
                <span class="hljs-string">"styleID"</span>: <span class="hljs-number">0</span>,
                <span class="hljs-string">"x"</span>: <span class="hljs-number">50</span>,
                <span class="hljs-string">"y"</span>: <span class="hljs-number">0</span>
            },
            {
                <span class="hljs-string">"styleID"</span>: <span class="hljs-number">0</span>,
                <span class="hljs-string">"x"</span>: <span class="hljs-number">61.22570037841797</span>,
                <span class="hljs-string">"y"</span>: <span class="hljs-number">34.54914855957031</span>
            },
            {
                <span class="hljs-string">"styleID"</span>: <span class="hljs-number">0</span>,
                <span class="hljs-string">"x"</span>: <span class="hljs-number">97.55282592773438</span>,
                <span class="hljs-string">"y"</span>: <span class="hljs-number">34.54914855957031</span>
            },
            {
                <span class="hljs-string">"styleID"</span>: <span class="hljs-number">0</span>,
                <span class="hljs-string">"x"</span>: <span class="hljs-number">68.16356658935547</span>,
                <span class="hljs-string">"y"</span>: <span class="hljs-number">55.90169906616211</span>
            },
            {
                <span class="hljs-string">"styleID"</span>: <span class="hljs-number">0</span>,
                <span class="hljs-string">"x"</span>: <span class="hljs-number">79.38926696777344</span>,
                <span class="hljs-string">"y"</span>: <span class="hljs-number">90.45085144042969</span>
            },
            {
                <span class="hljs-string">"styleID"</span>: <span class="hljs-number">0</span>,
                <span class="hljs-string">"x"</span>: <span class="hljs-number">50</span>,
                <span class="hljs-string">"y"</span>: <span class="hljs-number">69.09829711914062</span>
            },
            {
                <span class="hljs-string">"styleID"</span>: <span class="hljs-number">0</span>,
                <span class="hljs-string">"x"</span>: <span class="hljs-number">20.610736846923828</span>,
                <span class="hljs-string">"y"</span>: <span class="hljs-number">90.45085144042969</span>
            },
            {
                <span class="hljs-string">"styleID"</span>: <span class="hljs-number">0</span>,
                <span class="hljs-string">"x"</span>: <span class="hljs-number">31.836435317993164</span>,
                <span class="hljs-string">"y"</span>: <span class="hljs-number">55.90169906616211</span>
            },
            {
                <span class="hljs-string">"styleID"</span>: <span class="hljs-number">0</span>,
                <span class="hljs-string">"x"</span>: <span class="hljs-number">2.447174072265625</span>,
                <span class="hljs-string">"y"</span>: <span class="hljs-number">34.54914855957031</span>
            },
            {
                <span class="hljs-string">"styleID"</span>: <span class="hljs-number">0</span>,
                <span class="hljs-string">"x"</span>: <span class="hljs-number">38.77429962158203</span>,
                <span class="hljs-string">"y"</span>: <span class="hljs-number">34.54914855957031</span>
            }
        ],
        <span class="hljs-string">"segments"</span>: [
            {
                <span class="hljs-string">"styleID"</span>: <span class="hljs-number">0</span>,
                <span class="hljs-string">"start"</span>: {
                    <span class="hljs-string">"vertex"</span>: <span class="hljs-number">0</span>,
                    <span class="hljs-string">"dx"</span>: <span class="hljs-number">0</span>,
                    <span class="hljs-string">"dy"</span>: <span class="hljs-number">0</span>
                },
                <span class="hljs-string">"end"</span>: {
                    <span class="hljs-string">"vertex"</span>: <span class="hljs-number">1</span>,
                    <span class="hljs-string">"dx"</span>: <span class="hljs-number">0</span>,
                    <span class="hljs-string">"dy"</span>: <span class="hljs-number">0</span>
                }
            },
            {
                <span class="hljs-string">"styleID"</span>: <span class="hljs-number">0</span>,
                <span class="hljs-string">"start"</span>: {
                    <span class="hljs-string">"vertex"</span>: <span class="hljs-number">1</span>,
                    <span class="hljs-string">"dx"</span>: <span class="hljs-number">0</span>,
                    <span class="hljs-string">"dy"</span>: <span class="hljs-number">0</span>
                },
                <span class="hljs-string">"end"</span>: {
                    <span class="hljs-string">"vertex"</span>: <span class="hljs-number">2</span>,
                    <span class="hljs-string">"dx"</span>: <span class="hljs-number">0</span>,
                    <span class="hljs-string">"dy"</span>: <span class="hljs-number">0</span>
                }
            },
            {
                <span class="hljs-string">"styleID"</span>: <span class="hljs-number">0</span>,
                <span class="hljs-string">"start"</span>: {
                    <span class="hljs-string">"vertex"</span>: <span class="hljs-number">2</span>,
                    <span class="hljs-string">"dx"</span>: <span class="hljs-number">0</span>,
                    <span class="hljs-string">"dy"</span>: <span class="hljs-number">0</span>
                },
                <span class="hljs-string">"end"</span>: {
                    <span class="hljs-string">"vertex"</span>: <span class="hljs-number">3</span>,
                    <span class="hljs-string">"dx"</span>: <span class="hljs-number">0</span>,
                    <span class="hljs-string">"dy"</span>: <span class="hljs-number">0</span>
                }
            },
            {
                <span class="hljs-string">"styleID"</span>: <span class="hljs-number">0</span>,
                <span class="hljs-string">"start"</span>: {
                    <span class="hljs-string">"vertex"</span>: <span class="hljs-number">3</span>,
                    <span class="hljs-string">"dx"</span>: <span class="hljs-number">0</span>,
                    <span class="hljs-string">"dy"</span>: <span class="hljs-number">0</span>
                },
                <span class="hljs-string">"end"</span>: {
                    <span class="hljs-string">"vertex"</span>: <span class="hljs-number">4</span>,
                    <span class="hljs-string">"dx"</span>: <span class="hljs-number">0</span>,
                    <span class="hljs-string">"dy"</span>: <span class="hljs-number">0</span>
                }
            },
            {
                <span class="hljs-string">"styleID"</span>: <span class="hljs-number">0</span>,
                <span class="hljs-string">"start"</span>: {
                    <span class="hljs-string">"vertex"</span>: <span class="hljs-number">4</span>,
                    <span class="hljs-string">"dx"</span>: <span class="hljs-number">0</span>,
                    <span class="hljs-string">"dy"</span>: <span class="hljs-number">0</span>
                },
                <span class="hljs-string">"end"</span>: {
                    <span class="hljs-string">"vertex"</span>: <span class="hljs-number">5</span>,
                    <span class="hljs-string">"dx"</span>: <span class="hljs-number">0</span>,
                    <span class="hljs-string">"dy"</span>: <span class="hljs-number">0</span>
                }
            },
            {
                <span class="hljs-string">"styleID"</span>: <span class="hljs-number">0</span>,
                <span class="hljs-string">"start"</span>: {
                    <span class="hljs-string">"vertex"</span>: <span class="hljs-number">5</span>,
                    <span class="hljs-string">"dx"</span>: <span class="hljs-number">0</span>,
                    <span class="hljs-string">"dy"</span>: <span class="hljs-number">0</span>
                },
                <span class="hljs-string">"end"</span>: {
                    <span class="hljs-string">"vertex"</span>: <span class="hljs-number">6</span>,
                    <span class="hljs-string">"dx"</span>: <span class="hljs-number">0</span>,
                    <span class="hljs-string">"dy"</span>: <span class="hljs-number">0</span>
                }
            },
            {
                <span class="hljs-string">"styleID"</span>: <span class="hljs-number">0</span>,
                <span class="hljs-string">"start"</span>: {
                    <span class="hljs-string">"vertex"</span>: <span class="hljs-number">6</span>,
                    <span class="hljs-string">"dx"</span>: <span class="hljs-number">0</span>,
                    <span class="hljs-string">"dy"</span>: <span class="hljs-number">0</span>
                },
                <span class="hljs-string">"end"</span>: {
                    <span class="hljs-string">"vertex"</span>: <span class="hljs-number">7</span>,
                    <span class="hljs-string">"dx"</span>: <span class="hljs-number">0</span>,
                    <span class="hljs-string">"dy"</span>: <span class="hljs-number">0</span>
                }
            },
            {
                <span class="hljs-string">"styleID"</span>: <span class="hljs-number">0</span>,
                <span class="hljs-string">"start"</span>: {
                    <span class="hljs-string">"vertex"</span>: <span class="hljs-number">7</span>,
                    <span class="hljs-string">"dx"</span>: <span class="hljs-number">0</span>,
                    <span class="hljs-string">"dy"</span>: <span class="hljs-number">0</span>
                },
                <span class="hljs-string">"end"</span>: {
                    <span class="hljs-string">"vertex"</span>: <span class="hljs-number">8</span>,
                    <span class="hljs-string">"dx"</span>: <span class="hljs-number">0</span>,
                    <span class="hljs-string">"dy"</span>: <span class="hljs-number">0</span>
                }
            },
            {
                <span class="hljs-string">"styleID"</span>: <span class="hljs-number">0</span>,
                <span class="hljs-string">"start"</span>: {
                    <span class="hljs-string">"vertex"</span>: <span class="hljs-number">8</span>,
                    <span class="hljs-string">"dx"</span>: <span class="hljs-number">0</span>,
                    <span class="hljs-string">"dy"</span>: <span class="hljs-number">0</span>
                },
                <span class="hljs-string">"end"</span>: {
                    <span class="hljs-string">"vertex"</span>: <span class="hljs-number">9</span>,
                    <span class="hljs-string">"dx"</span>: <span class="hljs-number">0</span>,
                    <span class="hljs-string">"dy"</span>: <span class="hljs-number">0</span>
                }
            },
            {
                <span class="hljs-string">"styleID"</span>: <span class="hljs-number">0</span>,
                <span class="hljs-string">"start"</span>: {
                    <span class="hljs-string">"vertex"</span>: <span class="hljs-number">9</span>,
                    <span class="hljs-string">"dx"</span>: <span class="hljs-number">0</span>,
                    <span class="hljs-string">"dy"</span>: <span class="hljs-number">0</span>
                },
                <span class="hljs-string">"end"</span>: {
                    <span class="hljs-string">"vertex"</span>: <span class="hljs-number">0</span>,
                    <span class="hljs-string">"dx"</span>: <span class="hljs-number">0</span>,
                    <span class="hljs-string">"dy"</span>: <span class="hljs-number">0</span>
                }
            }
        ],
        <span class="hljs-string">"regions"</span>: [
            {
                <span class="hljs-string">"styleID"</span>: <span class="hljs-number">0</span>,
                <span class="hljs-string">"windingRule"</span>: <span class="hljs-string">"NONZERO"</span>,
                <span class="hljs-string">"loops"</span>: [
                    {
                        <span class="hljs-string">"segments"</span>: [ 当前环由十条边围城
                            <span class="hljs-number">0</span>,
                            <span class="hljs-number">1</span>,
                            <span class="hljs-number">2</span>,
                            <span class="hljs-number">3</span>,
                            <span class="hljs-number">4</span>,
                            <span class="hljs-number">5</span>,
                            <span class="hljs-number">6</span>,
                            <span class="hljs-number">7</span>,
                            <span class="hljs-number">8</span>,
                            <span class="hljs-number">9</span>
                        ]
                    }
                ]
            }
        ]
    }
};
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> star;
</code></pre>
<h2 data-id="heading-8">曲线</h2>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> line2 = {
    <span class="hljs-string">"type"</span>: <span class="hljs-string">"VECTOR"</span>,
    <span class="hljs-string">"strokeWeight"</span>: <span class="hljs-number">1</span>,
    <span class="hljs-string">"strokeAlign"</span>: <span class="hljs-string">"CENTER"</span>,
    <span class="hljs-string">"strokeJoin"</span>: <span class="hljs-string">"MITER"</span>,
    <span class="hljs-string">"strokePaints"</span>: [
        {
            <span class="hljs-string">"type"</span>: <span class="hljs-string">"SOLID"</span>,
            <span class="hljs-string">"color"</span>: {
                <span class="hljs-string">"r"</span>: <span class="hljs-number">0</span>,
                <span class="hljs-string">"g"</span>: <span class="hljs-number">0</span>,
                <span class="hljs-string">"b"</span>: <span class="hljs-number">0</span>,
                <span class="hljs-string">"a"</span>: <span class="hljs-number">1</span>
            },
            <span class="hljs-string">"opacity"</span>: <span class="hljs-number">1</span>,
            <span class="hljs-string">"visible"</span>: <span class="hljs-literal">true</span>,
            <span class="hljs-string">"blendMode"</span>: <span class="hljs-string">"NORMAL"</span>
        }
    ],
    <span class="hljs-string">"vectorNetwork"</span>: {
        <span class="hljs-string">"vertices"</span>: [
            {
                <span class="hljs-string">"styleID"</span>: <span class="hljs-number">0</span>,
                <span class="hljs-string">"x"</span>: <span class="hljs-number">0</span>,
                <span class="hljs-string">"y"</span>: <span class="hljs-number">23.836986541748047</span>
            },
            {
                <span class="hljs-string">"styleID"</span>: <span class="hljs-number">0</span>,
                <span class="hljs-string">"x"</span>: <span class="hljs-number">100</span>,
                <span class="hljs-string">"y"</span>: <span class="hljs-number">22.8122615814209</span>
            },
            {
                <span class="hljs-string">"styleID"</span>: <span class="hljs-number">1</span>,
                <span class="hljs-string">"x"</span>: <span class="hljs-number">50</span>,
                <span class="hljs-string">"y"</span>: <span class="hljs-number">23.324623107910156</span>
            }
        ],
        <span class="hljs-string">"segments"</span>: [
            {
                <span class="hljs-string">"styleID"</span>: <span class="hljs-number">0</span>,
                <span class="hljs-string">"start"</span>: {
                    <span class="hljs-string">"vertex"</span>: <span class="hljs-number">0</span>,
                    <span class="hljs-string">"dx"</span>: <span class="hljs-number">19.28675651550293</span>, <span class="hljs-comment">// 起始点的控制点x坐标(相对于当前点偏移量)</span>
                    <span class="hljs-string">"dy"</span>: -<span class="hljs-number">29.784029006958008</span> <span class="hljs-comment">// 起始点的控制点y坐标(相对于当前点偏移量)</span>
                },
                <span class="hljs-string">"end"</span>: {
                    <span class="hljs-string">"vertex"</span>: <span class="hljs-number">2</span>,
                    <span class="hljs-string">"dx"</span>: -<span class="hljs-number">22.682817459106445</span>, <span class="hljs-comment">// 结束点的控制点x坐标(相对于当前点偏移量)</span>
                    <span class="hljs-string">"dy"</span>: -<span class="hljs-number">33.02580642700195</span> <span class="hljs-comment">// 结束点的控制点y坐标(相对于当前点偏移量)</span>
                }
            },
            {
                <span class="hljs-string">"styleID"</span>: <span class="hljs-number">0</span>,
                <span class="hljs-string">"start"</span>: {
                    <span class="hljs-string">"vertex"</span>: <span class="hljs-number">2</span>,
                    <span class="hljs-string">"dx"</span>: <span class="hljs-number">22.682817459106445</span>,
                    <span class="hljs-string">"dy"</span>: <span class="hljs-number">33.02580642700195</span>
                },
                <span class="hljs-string">"end"</span>: {
                    <span class="hljs-string">"vertex"</span>: <span class="hljs-number">1</span>,
                    <span class="hljs-string">"dx"</span>: -<span class="hljs-number">14.171252250671387</span>,
                    <span class="hljs-string">"dy"</span>: <span class="hljs-number">28.461177825927734</span>
                }
            }
        ],
        <span class="hljs-string">"regions"</span>: []
    }
};
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> line2;
</code></pre>
<h2 data-id="heading-9">椭圆</h2>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> ellipse = {
    <span class="hljs-string">"type"</span>: <span class="hljs-string">"ELLIPSE"</span>,
    <span class="hljs-string">"strokeWeight"</span>: <span class="hljs-number">1</span>,
    <span class="hljs-string">"strokeAlign"</span>: <span class="hljs-string">"INSIDE"</span>,
    <span class="hljs-string">"strokeJoin"</span>: <span class="hljs-string">"MITER"</span>,
    <span class="hljs-string">"fillPaints"</span>: [
        {
            <span class="hljs-string">"type"</span>: <span class="hljs-string">"SOLID"</span>,
            <span class="hljs-string">"color"</span>: {
                <span class="hljs-string">"r"</span>: <span class="hljs-number">0.8509804010391235</span>,
                <span class="hljs-string">"g"</span>: <span class="hljs-number">0.8509804010391235</span>,
                <span class="hljs-string">"b"</span>: <span class="hljs-number">0.8509804010391235</span>,
                <span class="hljs-string">"a"</span>: <span class="hljs-number">1</span>
            },
            <span class="hljs-string">"opacity"</span>: <span class="hljs-number">1</span>,
            <span class="hljs-string">"visible"</span>: <span class="hljs-literal">true</span>,
            <span class="hljs-string">"blendMode"</span>: <span class="hljs-string">"NORMAL"</span>
        }
    ],
    <span class="hljs-string">"strokePaints"</span>: [
        {
            <span class="hljs-string">"type"</span>: <span class="hljs-string">"SOLID"</span>,
            <span class="hljs-string">"color"</span>: {
                <span class="hljs-string">"r"</span>: <span class="hljs-number">0</span>,
                <span class="hljs-string">"g"</span>: <span class="hljs-number">0</span>,
                <span class="hljs-string">"b"</span>: <span class="hljs-number">0</span>,
                <span class="hljs-string">"a"</span>: <span class="hljs-number">1</span>
            },
            <span class="hljs-string">"opacity"</span>: <span class="hljs-number">1</span>,
            <span class="hljs-string">"visible"</span>: <span class="hljs-literal">true</span>,
            <span class="hljs-string">"blendMode"</span>: <span class="hljs-string">"NORMAL"</span>
        }
    ],
    <span class="hljs-string">"vectorNetwork"</span>: {
        <span class="hljs-string">"vertices"</span>: [
            {
                <span class="hljs-string">"styleID"</span>: <span class="hljs-number">0</span>,
                <span class="hljs-string">"x"</span>: <span class="hljs-number">100</span>,
                <span class="hljs-string">"y"</span>: <span class="hljs-number">25</span>
            },
            {
                <span class="hljs-string">"styleID"</span>: <span class="hljs-number">0</span>,
                <span class="hljs-string">"x"</span>: <span class="hljs-number">50</span>,
                <span class="hljs-string">"y"</span>: <span class="hljs-number">50</span>
            },
            {
                <span class="hljs-string">"styleID"</span>: <span class="hljs-number">0</span>,
                <span class="hljs-string">"x"</span>: <span class="hljs-number">0</span>,
                <span class="hljs-string">"y"</span>: <span class="hljs-number">25</span>
            },
            {
                <span class="hljs-string">"styleID"</span>: <span class="hljs-number">0</span>,
                <span class="hljs-string">"x"</span>: <span class="hljs-number">50</span>,
                <span class="hljs-string">"y"</span>: <span class="hljs-number">0</span>
            }
        ],
        <span class="hljs-string">"segments"</span>: [
            {
                <span class="hljs-string">"styleID"</span>: <span class="hljs-number">0</span>,
                <span class="hljs-string">"start"</span>: {
                    <span class="hljs-string">"vertex"</span>: <span class="hljs-number">0</span>,
                    <span class="hljs-string">"dx"</span>: <span class="hljs-number">0</span>,
                    <span class="hljs-string">"dy"</span>: <span class="hljs-number">13.80711841583252</span>
                },
                <span class="hljs-string">"end"</span>: {
                    <span class="hljs-string">"vertex"</span>: <span class="hljs-number">1</span>,
                    <span class="hljs-string">"dx"</span>: <span class="hljs-number">27.61423683166504</span>,
                    <span class="hljs-string">"dy"</span>: <span class="hljs-number">0</span>
                }
            },
            {
                <span class="hljs-string">"styleID"</span>: <span class="hljs-number">0</span>,
                <span class="hljs-string">"start"</span>: {
                    <span class="hljs-string">"vertex"</span>: <span class="hljs-number">1</span>,
                    <span class="hljs-string">"dx"</span>: -<span class="hljs-number">27.61423683166504</span>,
                    <span class="hljs-string">"dy"</span>: <span class="hljs-number">0</span>
                },
                <span class="hljs-string">"end"</span>: {
                    <span class="hljs-string">"vertex"</span>: <span class="hljs-number">2</span>,
                    <span class="hljs-string">"dx"</span>: <span class="hljs-number">0</span>,
                    <span class="hljs-string">"dy"</span>: <span class="hljs-number">13.80711841583252</span>
                }
            },
            {
                <span class="hljs-string">"styleID"</span>: <span class="hljs-number">0</span>,
                <span class="hljs-string">"start"</span>: {
                    <span class="hljs-string">"vertex"</span>: <span class="hljs-number">2</span>,
                    <span class="hljs-string">"dx"</span>: <span class="hljs-number">0</span>,
                    <span class="hljs-string">"dy"</span>: -<span class="hljs-number">13.80711841583252</span>
                },
                <span class="hljs-string">"end"</span>: {
                    <span class="hljs-string">"vertex"</span>: <span class="hljs-number">3</span>,
                    <span class="hljs-string">"dx"</span>: -<span class="hljs-number">27.61423683166504</span>,
                    <span class="hljs-string">"dy"</span>: <span class="hljs-number">0</span>
                }
            },
            {
                <span class="hljs-string">"styleID"</span>: <span class="hljs-number">0</span>,
                <span class="hljs-string">"start"</span>: {
                    <span class="hljs-string">"vertex"</span>: <span class="hljs-number">3</span>,
                    <span class="hljs-string">"dx"</span>: <span class="hljs-number">27.61423683166504</span>,
                    <span class="hljs-string">"dy"</span>: <span class="hljs-number">0</span>
                },
                <span class="hljs-string">"end"</span>: {
                    <span class="hljs-string">"vertex"</span>: <span class="hljs-number">0</span>,
                    <span class="hljs-string">"dx"</span>: <span class="hljs-number">0</span>,
                    <span class="hljs-string">"dy"</span>: -<span class="hljs-number">13.80711841583252</span>
                }
            }
        ],
        <span class="hljs-string">"regions"</span>: [
            {
                <span class="hljs-string">"styleID"</span>: <span class="hljs-number">0</span>,
                <span class="hljs-string">"windingRule"</span>: <span class="hljs-string">"NONZERO"</span>,
                <span class="hljs-string">"loops"</span>: [
                    {
                        <span class="hljs-string">"segments"</span>: [ <span class="hljs-comment">// 当前环由四条曲线组成</span>
                            <span class="hljs-number">0</span>,
                            <span class="hljs-number">1</span>,
                            <span class="hljs-number">2</span>,
                            <span class="hljs-number">3</span>
                        ]
                    }
                ]
            }
        ]
    }
};
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> ellipse;
</code></pre>
<h2 data-id="heading-10">总结</h2>
<p>Figma Vector Networks 提供了一种<strong>更高维度的矢量图形描述方式</strong>，它不仅突破了传统 SVG Path 的编辑限制，还通过其独特的<strong>拓扑结构</strong>实现了更灵活、高效的图形构建与渲染。本文通过多个实际图形示例，系统演示了如何使用 Vector Networks 的结构化数据（如 <code>vertices</code>、<code>segments</code>、<code>regions</code>）来定义图形的几何形状、描边样式与填充区域。无论是直线、多边形还是曲线图形，Vector Networks 都能以统一而强大的方式予以支持，极大地降低了矢量图形编辑的复杂度，为图形工具的开发与使用提供了新的可能性。</p>
<p><em>更多精彩内容可关注</em><a href="https://link.juejin.cn?target=https%3A%2F%2F01joy.com" target="_blank" title="https://01joy.com" ref="nofollow noopener noreferrer"><em>风起的博客</em></a> <em>，微信公众号：听风说图</em></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[CSS定位全解析：从static到sticky，彻底搞懂布局核心]]></title>    <link>https://juejin.cn/post/7572126996177141795</link>    <guid>https://juejin.cn/post/7572126996177141795</guid>    <pubDate>2025-11-14T05:09:35.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7572126996177141795" data-draft-id="7572141390857093120" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="CSS定位全解析：从static到sticky，彻底搞懂布局核心"/> <meta itemprop="keywords" content="前端,CSS"/> <meta itemprop="datePublished" content="2025-11-14T05:09:35.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="闲云ing"/> <meta itemprop="url" content="https://juejin.cn/user/2974655942502250"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            CSS定位全解析：从static到sticky，彻底搞懂布局核心
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2974655942502250/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    闲云ing
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-14T05:09:35.000Z" title="Fri Nov 14 2025 05:09:35 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-14
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读11分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">CSS定位全解析：从static到sticky，彻底搞懂布局核心</h2>
<p><strong>前端开发绕不开的坎</strong>：CSS定位是布局的灵魂，也是新手最容易混淆的知识点。本文用概念+案例+对比的形式，把static、relative、absolute、fixed、sticky讲透，每个特性都配可直接运行的代码，看完就能上手实战。</p>
<h2 data-id="heading-1">一、先搞懂基础：什么是文档流？</h2>
<p>在聊定位之前，必须先明确「文档流」这个核心概念——它是HTML元素默认的排列规则，就像人排队一样有章可循：</p>
<ul>
<li><strong>块级元素</strong>（div、p、h1等）：独占一行，垂直向下排列，默认宽度占满父容器</li>
<li><strong>行内元素</strong>（span、a、img等）：不独占一行，水平从左到右排列，宽度由内容决定</li>
<li><strong>核心特点</strong>：元素像流水一样依次排列，每个元素都占据自己的「位置」，不会重叠</li>
</ul>
<p>而CSS定位的核心作用，就是<strong>打破或改变这种默认的文档流规则</strong>。当元素「脱离文档流」时，它会像幽灵一样"飘起来"，不再占据原来的空间，甚至会覆盖其他元素——这也是定位布局的关键特性。</p>
<h2 data-id="heading-2">二、逐个击破：5种定位方式的核心用法</h2>
<p>CSS的<code>position</code>属性共有5个取值，每种取值对应完全不同的布局行为。我们从最基础的static开始，逐个拆解。</p>
<h3 data-id="heading-3">1. position: static 静态定位（默认值）</h3>
<p>static是所有元素的默认定位方式，意思是「遵循正常文档流」，就像排队时按顺序站好，不搞特殊化。</p>
<h4 data-id="heading-4">核心特性</h4>
<ul>
<li>完全遵循文档流，元素占据正常空间</li>
<li><code>top、bottom、left、right</code>和<code>z-index</code>属性完全无效（设置了也没用）</li>
<li>作用场景：通常用于「取消定位」，比如把之前设为absolute的元素改回static</li>
</ul>
<h4 data-id="heading-5">实战案例：元素回归文档流</h4>
<p>这个案例中，父元素初始是绝对定位，5秒后通过JS改为static，会自动回归文档流：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"en"</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">"UTF-8"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"viewport"</span> <span class="hljs-attr">content</span>=<span class="hljs-string">"width=device-width, initial-scale=1.0"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>Static 静态定位<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">style</span>&gt;</span><span class="css">
    * { <span class="hljs-attribute">margin</span>: <span class="hljs-number">0</span>; <span class="hljs-attribute">padding</span>: <span class="hljs-number">0</span>; } <span class="hljs-comment">/* 清除默认边距 */</span>
    <span class="hljs-selector-tag">body</span> { <span class="hljs-attribute">height</span>: <span class="hljs-number">2000px</span>; } <span class="hljs-comment">/* 让页面可滚动，方便观察 */</span>
    
    <span class="hljs-selector-class">.parent</span> {
      <span class="hljs-attribute">width</span>: <span class="hljs-number">500px</span>;
      <span class="hljs-attribute">height</span>: <span class="hljs-number">500px</span>;
      <span class="hljs-attribute">background-color</span>: <span class="hljs-number">#ffccd5</span>; <span class="hljs-comment">/* 浅粉色，更柔和 */</span>
      <span class="hljs-attribute">position</span>: absolute; <span class="hljs-comment">/* 初始为绝对定位，会脱离文档流 */</span>
      <span class="hljs-attribute">left</span>: <span class="hljs-number">100px</span>;
      <span class="hljs-attribute">top</span>: <span class="hljs-number">100px</span>;
    }
    
    <span class="hljs-selector-class">.child</span> {
      <span class="hljs-attribute">width</span>: <span class="hljs-number">300px</span>;
      <span class="hljs-attribute">height</span>: <span class="hljs-number">200px</span>;
      <span class="hljs-attribute">background-color</span>: <span class="hljs-number">#91c8e4</span>; <span class="hljs-comment">/* 浅蓝色 */</span>
    }
    
    <span class="hljs-selector-class">.box</span> {
      <span class="hljs-attribute">width</span>: <span class="hljs-number">100px</span>;
      <span class="hljs-attribute">height</span>: <span class="hljs-number">100px</span>;
      <span class="hljs-attribute">background-color</span>: <span class="hljs-number">#74c69d</span>; <span class="hljs-comment">/* 浅绿色 */</span>
    }
  </span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"parent"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"child"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"box"</span>&gt;</span>Hello CSS<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>

  <span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
    <span class="hljs-keyword">const</span> oParent = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">'.parent'</span>);
    <span class="hljs-comment">// 5秒后将父元素改为静态定位，回归文档流</span>
    <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
      oParent.<span class="hljs-property">style</span>.<span class="hljs-property">position</span> = <span class="hljs-string">'static'</span>;
      <span class="hljs-title function_">alert</span>(<span class="hljs-string">'父元素已改为static定位，回归文档流'</span>);
    }, <span class="hljs-number">5000</span>);
  </span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span>
</code></pre>
<h3 data-id="heading-6">2. position: relative 相对定位（微调神器）</h3>
<p>relative的核心是「相对自身」——元素先在文档流中占据正常位置，然后相对于这个原始位置进行偏移，就像排队时稍微挪一下脚步，但不离开自己的位置。</p>
<h4 data-id="heading-7">核心特性</h4>
<ul>
<li><strong>不脱离文档流</strong>：原始位置会被保留，其他元素不会"挤过来"</li>
<li><strong>定位基准</strong>：元素自身在文档流中的原始位置</li>
<li><strong>偏移控制</strong>：通过<code>top/bottom/left/right</code>设置偏移量（正值表示远离该方向，负值表示靠近）</li>
<li><strong>重要作用</strong>：给绝对定位的子元素充当「定位参考点」（这是它最常用的场景）</li>
</ul>
<h4 data-id="heading-8">实战案例：元素偏移与定位参考</h4>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"en"</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">"UTF-8"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"viewport"</span> <span class="hljs-attr">content</span>=<span class="hljs-string">"width=device-width, initial-scale=1.0"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>Relative 相对定位<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">style</span>&gt;</span><span class="css">
    * { <span class="hljs-attribute">margin</span>: <span class="hljs-number">0</span>; <span class="hljs-attribute">padding</span>: <span class="hljs-number">0</span>; }
    
    <span class="hljs-selector-class">.parent</span> {
      <span class="hljs-attribute">width</span>: <span class="hljs-number">500px</span>;
      <span class="hljs-attribute">height</span>: <span class="hljs-number">500px</span>;
      <span class="hljs-attribute">background-color</span>: <span class="hljs-number">#ffccd5</span>;
      <span class="hljs-attribute">position</span>: relative; <span class="hljs-comment">/* 相对定位，作为子元素的参考 */</span>
      <span class="hljs-attribute">left</span>: <span class="hljs-number">100px</span>; <span class="hljs-comment">/* 相对于自身原始位置，向右偏移100px */</span>
      <span class="hljs-attribute">top</span>: <span class="hljs-number">100px</span>;  <span class="hljs-comment">/* 相对于自身原始位置，向下偏移100px */</span>
    }
    
    <span class="hljs-selector-class">.child</span> {
      <span class="hljs-attribute">width</span>: <span class="hljs-number">300px</span>;
      <span class="hljs-attribute">height</span>: <span class="hljs-number">200px</span>;
      <span class="hljs-attribute">background-color</span>: <span class="hljs-number">#91c8e4</span>;
      <span class="hljs-attribute">position</span>: absolute; <span class="hljs-comment">/* 子元素绝对定位，参考父元素 */</span>
      <span class="hljs-attribute">bottom</span>: <span class="hljs-number">50px</span>; <span class="hljs-comment">/* 距离父元素底部50px */</span>
      <span class="hljs-attribute">right</span>: <span class="hljs-number">50px</span>; <span class="hljs-comment">/* 距离父元素右侧50px */</span>
    }
    
    <span class="hljs-selector-class">.box</span> {
      <span class="hljs-attribute">width</span>: <span class="hljs-number">100px</span>;
      <span class="hljs-attribute">height</span>: <span class="hljs-number">100px</span>;
      <span class="hljs-attribute">background-color</span>: <span class="hljs-number">#74c69d</span>;
      <span class="hljs-comment">/* 未设置定位，遵循文档流，父元素的偏移不影响它 */</span>
    }
  </span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"parent"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"child"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"box"</span>&gt;</span>我在文档流中<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span>
</code></pre>
<p><strong>新手避坑</strong>：relative的偏移不会影响其他元素的布局，因为它还在文档流中。如果发现元素偏移后"压"住了其他元素，那大概率是用了absolute/fixed，而不是relative。</p>
<h3 data-id="heading-9">3. position: absolute 绝对定位（独立布局之王）</h3>
<p>absolute是前端布局的明星属性，它能让元素完全脱离文档流，就像从排队队伍中走出来，自由移动，而且不会留下自己的位置（其他元素会补上来）。</p>
<h4 data-id="heading-10">核心特性</h4>
<ul>
<li><strong>完全脱离文档流</strong>：不占据任何空间，相当于页面中"不存在"这个元素（对其他元素而言）</li>
<li><strong>定位基准</strong>：<strong>最近的已定位祖先元素</strong>（即祖先元素的position不是static）；如果没有，就相对于浏览器窗口（初始包含块）</li>
<li><strong>偏移控制</strong>：通过<code>top/bottom/left/right</code>控制位置，相对于定位基准进行偏移</li>
<li><strong>层级问题</strong>：脱离文档流后会覆盖其他元素，可通过<code>z-index</code>调整层级（数值越大越靠上）</li>
</ul>
<h4 data-id="heading-11">实战案例1：子元素相对于父元素定位</h4>
<p>这是absolute最经典的用法——父元素设为relative，子元素设为absolute，实现子元素在父元素内的精准定位：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"en"</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">"UTF-8"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"viewport"</span> <span class="hljs-attr">content</span>=<span class="hljs-string">"width=device-width, initial-scale=1.0"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>Absolute 绝对定位（父元素参考）<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">style</span>&gt;</span><span class="css">
    * { <span class="hljs-attribute">margin</span>: <span class="hljs-number">0</span>; <span class="hljs-attribute">padding</span>: <span class="hljs-number">0</span>; }
    <span class="hljs-selector-tag">body</span> { <span class="hljs-attribute">background-color</span>: <span class="hljs-number">#e0f7fa</span>; }
    
    <span class="hljs-selector-class">.parent</span> {
      <span class="hljs-attribute">width</span>: <span class="hljs-number">550px</span>;
      <span class="hljs-attribute">height</span>: <span class="hljs-number">500px</span>;
      <span class="hljs-attribute">background-color</span>: <span class="hljs-number">#ffccd5</span>;
      <span class="hljs-attribute">margin</span>: <span class="hljs-number">50px</span> auto; <span class="hljs-comment">/* 水平居中，方便观察 */</span>
      <span class="hljs-attribute">position</span>: relative; <span class="hljs-comment">/* 关键：给子元素当参考 */</span>
      <span class="hljs-attribute">opacity</span>: <span class="hljs-number">0.9</span>; <span class="hljs-comment">/* 半透明，方便看到层级 */</span>
    }
    
    <span class="hljs-selector-class">.child</span> {
      <span class="hljs-attribute">width</span>: <span class="hljs-number">300px</span>;
      <span class="hljs-attribute">height</span>: <span class="hljs-number">200px</span>;
      <span class="hljs-attribute">background-color</span>: <span class="hljs-number">#91c8e4</span>;
      <span class="hljs-attribute">position</span>: absolute;
      <span class="hljs-attribute">right</span>: <span class="hljs-number">100px</span>; <span class="hljs-comment">/* 距离父元素右边缘100px */</span>
      <span class="hljs-attribute">top</span>: <span class="hljs-number">150px</span>; <span class="hljs-comment">/* 距离父元素上边缘150px */</span>
    }
    
    <span class="hljs-comment">/* 绝对定位居中技巧：left50% + transform(-50%) */</span>
    <span class="hljs-selector-class">.center-box</span> {
      <span class="hljs-attribute">width</span>: <span class="hljs-number">100px</span>;
      <span class="hljs-attribute">height</span>: <span class="hljs-number">100px</span>;
      <span class="hljs-attribute">background-color</span>: <span class="hljs-number">#74c69d</span>;
      <span class="hljs-attribute">position</span>: absolute;
      <span class="hljs-attribute">left</span>: <span class="hljs-number">50%</span>; <span class="hljs-comment">/* 相对于父元素左移50% */</span>
      <span class="hljs-attribute">top</span>: <span class="hljs-number">50%</span>; <span class="hljs-comment">/* 相对于父元素上移50% */</span>
      <span class="hljs-attribute">transform</span>: <span class="hljs-built_in">translate</span>(-<span class="hljs-number">50%</span>, -<span class="hljs-number">50%</span>); <span class="hljs-comment">/* 自身回移50%，实现完美居中 */</span>
      <span class="hljs-attribute">color</span>: white;
      <span class="hljs-attribute">display</span>: flex;
      <span class="hljs-attribute">align-items</span>: center;
      <span class="hljs-attribute">justify-content</span>: center;
    }
  </span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"parent"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"child"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"center-box"</span>&gt;</span>居中啦<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>我是父元素的文本，不会被绝对定位元素影响<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>我在文档流中，会补到父元素下方<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span>
</code></pre>
<h4 data-id="heading-12">实战案例2：无参考元素时的定位</h4>
<p>如果absolute元素没有已定位的祖先，就会相对于浏览器窗口定位，且会跟随页面滚动：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.float-box</span> {
  <span class="hljs-attribute">position</span>: absolute;
  <span class="hljs-attribute">top</span>: <span class="hljs-number">20px</span>;
  <span class="hljs-attribute">right</span>: <span class="hljs-number">20px</span>;
  <span class="hljs-attribute">width</span>: <span class="hljs-number">120px</span>;
  <span class="hljs-attribute">height</span>: <span class="hljs-number">40px</span>;
  <span class="hljs-attribute">background-color</span>: <span class="hljs-number">#f472b6</span>;
  <span class="hljs-attribute">color</span>: white;
  <span class="hljs-attribute">line-height</span>: <span class="hljs-number">40px</span>;
  <span class="hljs-attribute">text-align</span>: center;
}
</code></pre>
<h3 data-id="heading-13">4. position: fixed 固定定位（悬浮元素专属）</h3>
<p>fixed和absolute很像，都会脱离文档流，但它的定位基准是「浏览器窗口」（视口），而且<strong>不会随页面滚动而移动</strong>，就像粘在窗户上的便利贴。</p>
<h4 data-id="heading-14">核心特性</h4>
<ul>
<li><strong>脱离文档流</strong>：不占据空间，与absolute一致</li>
<li><strong>定位基准</strong>：浏览器视口（窗口），不受祖先元素影响</li>
<li><strong>滚动无关</strong>：页面滚动时，元素位置始终固定在视口的某个地方</li>
<li><strong>常见场景</strong>：顶部导航栏、右侧悬浮广告、回到顶部按钮、弹窗遮罩</li>
</ul>
<h4 data-id="heading-15">实战案例：右下角悬浮按钮</h4>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"en"</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">"UTF-8"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"viewport"</span> <span class="hljs-attr">content</span>=<span class="hljs-string">"width=device-width, initial-scale=1.0"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>Fixed 固定定位<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">style</span>&gt;</span><span class="css">
    * { <span class="hljs-attribute">margin</span>: <span class="hljs-number">0</span>; <span class="hljs-attribute">padding</span>: <span class="hljs-number">0</span>; }
    <span class="hljs-selector-tag">body</span> { <span class="hljs-attribute">height</span>: <span class="hljs-number">2000px</span>; <span class="hljs-comment">/* 制造长页面，方便测试滚动 */</span> }
    
    <span class="hljs-selector-class">.parent</span> {
      <span class="hljs-attribute">width</span>: <span class="hljs-number">500px</span>;
      <span class="hljs-attribute">height</span>: <span class="hljs-number">500px</span>;
      <span class="hljs-attribute">background-color</span>: <span class="hljs-number">#ffccd5</span>;
      <span class="hljs-attribute">margin</span>: <span class="hljs-number">50px</span> auto;
    }
    
    <span class="hljs-selector-class">.box</span> {
      <span class="hljs-attribute">width</span>: <span class="hljs-number">100px</span>;
      <span class="hljs-attribute">height</span>: <span class="hljs-number">100px</span>;
      <span class="hljs-attribute">background-color</span>: <span class="hljs-number">#74c69d</span>;
    }
    
    <span class="hljs-comment">/* 固定在右下角的悬浮按钮 */</span>
    <span class="hljs-selector-class">.fixed-btn</span> {
      <span class="hljs-attribute">width</span>: <span class="hljs-number">60px</span>;
      <span class="hljs-attribute">height</span>: <span class="hljs-number">60px</span>;
      <span class="hljs-attribute">background-color</span>: <span class="hljs-number">#2563eb</span>;
      <span class="hljs-attribute">border-radius</span>: <span class="hljs-number">50%</span>;
      <span class="hljs-attribute">position</span>: fixed;
      <span class="hljs-attribute">right</span>: <span class="hljs-number">30px</span>;
      <span class="hljs-attribute">bottom</span>: <span class="hljs-number">30px</span>;
      <span class="hljs-attribute">color</span>: white;
      <span class="hljs-attribute">display</span>: flex;
      <span class="hljs-attribute">align-items</span>: center;
      <span class="hljs-attribute">justify-content</span>: center;
      <span class="hljs-attribute">cursor</span>: pointer;
      <span class="hljs-attribute">box-shadow</span>: <span class="hljs-number">0</span> <span class="hljs-number">2px</span> <span class="hljs-number">10px</span> <span class="hljs-built_in">rgba</span>(<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0.2</span>);
    }
    
    <span class="hljs-comment">/* 固定在顶部的导航栏 */</span>
    <span class="hljs-selector-class">.nav</span> {
      <span class="hljs-attribute">height</span>: <span class="hljs-number">60px</span>;
      <span class="hljs-attribute">background-color</span>: <span class="hljs-number">#1e40af</span>;
      <span class="hljs-attribute">color</span>: white;
      <span class="hljs-attribute">line-height</span>: <span class="hljs-number">60px</span>;
      <span class="hljs-attribute">padding</span>: <span class="hljs-number">0</span> <span class="hljs-number">20px</span>;
      <span class="hljs-attribute">position</span>: fixed;
      <span class="hljs-attribute">top</span>: <span class="hljs-number">0</span>;
      <span class="hljs-attribute">left</span>: <span class="hljs-number">0</span>;
      <span class="hljs-attribute">right</span>: <span class="hljs-number">0</span>; <span class="hljs-comment">/* 左右设为0，实现宽度自适应 */</span>
    }
  </span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"nav"</span>&gt;</span>固定导航栏<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"parent"</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"margin-top: 80px;"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"box"</span>&gt;</span>Hello CSS<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"fixed-btn"</span>&gt;</span>回到顶部<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>

  <span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
    <span class="hljs-comment">// 实现回到顶部功能</span>
    <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">'.fixed-btn'</span>).<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'click'</span>, <span class="hljs-function">() =&gt;</span> {
      <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">scrollTo</span>({ <span class="hljs-attr">top</span>: <span class="hljs-number">0</span>, <span class="hljs-attr">behavior</span>: <span class="hljs-string">'smooth'</span> });
    });
  </span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span>
</code></pre>
<p><strong>移动端注意</strong>：fixed在iOS的Safari中可能会有滚动抖动问题，可通过给body添加<code>overflow-x: hidden;</code>或使用sticky替代（视场景而定）。</p>
<h3 data-id="heading-16">5. position: sticky 粘性定位（混合定位神器）</h3>
<p>sticky是relative和fixed的「混合体」，元素在滚动到某个阈值前表现为relative（遵循文档流），达到阈值后表现为fixed（固定在视口），就像贴在页面上的便利贴，滚动到特定位置才会"粘住"。</p>
<h4 data-id="heading-17">核心特性</h4>
<ul>
<li><strong>阈值触发</strong>：必须通过<code>top/bottom/left/right</code>设置触发阈值（否则无效）</li>
<li><strong>定位基准</strong>：未触发时是自身原始位置（relative），触发后是视口（fixed）</li>
<li><strong>父元素限制</strong>：sticky元素的固定范围不会超出它的父元素（这点和fixed不同）</li>
<li><strong>常见场景</strong>：表格标题、列表分类标题、滚动时跟随的侧边栏</li>
</ul>
<h4 data-id="heading-18">实战案例：滚动时粘住的标题</h4>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"en"</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">"UTF-8"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"viewport"</span> <span class="hljs-attr">content</span>=<span class="hljs-string">"width=device-width, initial-scale=1.0"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>Sticky 粘性定位<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">style</span>&gt;</span><span class="css">
    * { <span class="hljs-attribute">margin</span>: <span class="hljs-number">0</span>; <span class="hljs-attribute">padding</span>: <span class="hljs-number">0</span>; }
    <span class="hljs-selector-tag">body</span> { <span class="hljs-attribute">height</span>: <span class="hljs-number">2000px</span>; }
    
    <span class="hljs-selector-class">.container</span> {
      <span class="hljs-attribute">width</span>: <span class="hljs-number">800px</span>;
      <span class="hljs-attribute">margin</span>: <span class="hljs-number">50px</span> auto;
    }
    
    <span class="hljs-selector-class">.section</span> {
      <span class="hljs-attribute">margin-bottom</span>: <span class="hljs-number">30px</span>;
    }
    
    <span class="hljs-comment">/* 粘性标题：滚动到距离顶部50px时粘住 */</span>
    <span class="hljs-selector-class">.sticky-title</span> {
      <span class="hljs-attribute">height</span>: <span class="hljs-number">50px</span>;
      <span class="hljs-attribute">line-height</span>: <span class="hljs-number">50px</span>;
      <span class="hljs-attribute">padding</span>: <span class="hljs-number">0</span> <span class="hljs-number">20px</span>;
      <span class="hljs-attribute">background-color</span>: <span class="hljs-number">#2563eb</span>;
      <span class="hljs-attribute">color</span>: white;
      <span class="hljs-attribute">position</span>: sticky;
      <span class="hljs-attribute">top</span>: <span class="hljs-number">50px</span>; <span class="hljs-comment">/* 触发阈值：距离视口顶部50px */</span>
      <span class="hljs-attribute">border-radius</span>: <span class="hljs-number">4px</span> <span class="hljs-number">4px</span> <span class="hljs-number">0</span> <span class="hljs-number">0</span>;
    }
    
    <span class="hljs-selector-class">.content</span> {
      <span class="hljs-attribute">height</span>: <span class="hljs-number">300px</span>;
      <span class="hljs-attribute">background-color</span>: <span class="hljs-number">#eff6ff</span>;
      <span class="hljs-attribute">padding</span>: <span class="hljs-number">20px</span>;
      <span class="hljs-attribute">border-radius</span>: <span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">4px</span> <span class="hljs-number">4px</span>;
    }
    
    <span class="hljs-comment">/* 顶部占位，模拟页面内容 */</span>
    <span class="hljs-selector-class">.header</span> {
      <span class="hljs-attribute">height</span>: <span class="hljs-number">200px</span>;
      <span class="hljs-attribute">background-color</span>: <span class="hljs-number">#ffccd5</span>;
      <span class="hljs-attribute">display</span>: flex;
      <span class="hljs-attribute">align-items</span>: center;
      <span class="hljs-attribute">justify-content</span>: center;
      <span class="hljs-attribute">font-size</span>: <span class="hljs-number">24px</span>;
    }
  </span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"header"</span>&gt;</span>滚动页面，看下面的标题<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"container"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"section"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">h2</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"sticky-title"</span>&gt;</span>第一部分标题（会粘住）<span class="hljs-tag">&lt;/<span class="hljs-name">h2</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"content"</span>&gt;</span>第一部分内容...<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"section"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">h2</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"sticky-title"</span>&gt;</span>第二部分标题（会粘住）<span class="hljs-tag">&lt;/<span class="hljs-name">h2</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"content"</span>&gt;</span>第二部分内容...<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"section"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">h2</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"sticky-title"</span>&gt;</span>第三部分标题（会粘住）<span class="hljs-tag">&lt;/<span class="hljs-name">h2</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"content"</span>&gt;</span>第三部分内容...<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span>
</code></pre>
<p><strong>新手避坑</strong>：sticky的父元素不能有<code>overflow: hidden/auto/scroll</code>属性，否则粘性效果会失效（父元素的滚动会"困住"sticky元素）。</p>
<h2 data-id="heading-19">三、一张表理清5种定位的核心区别</h2>
<p>这张对比表是定位知识的「精华总结」，建议收藏起来，遇到布局问题时随时查阅：</p>















































<table><thead><tr><th>定位方式</th><th>是否脱离文档流</th><th>定位基准</th><th>偏移属性是否生效</th><th>核心应用场景</th></tr></thead><tbody><tr><td><code>static</code></td><td>否</td><td>正常文档流</td><td>无效</td><td>默认布局、取消定位</td></tr><tr><td><code>relative</code></td><td>否</td><td>自身原始位置</td><td>生效</td><td>微调位置、给absolute当参考</td></tr><tr><td><code>absolute</code></td><td>是</td><td>最近已定位祖先/视口</td><td>生效</td><td>弹出层、菜单、精准定位</td></tr><tr><td><code>fixed</code></td><td>是</td><td>浏览器视口</td><td>生效</td><td>导航栏、悬浮按钮、遮罩</td></tr><tr><td><code>sticky</code></td><td>否→是（阈值触发）</td><td>自身位置→视口</td><td>生效（需设阈值）</td><td>表格标题、滚动跟随标题</td></tr></tbody></table>
<h2 data-id="heading-20">四、实战技巧与常见问题</h2>
<h3 data-id="heading-21">1. 绝对定位元素居中的3种方法</h3>
<pre><code class="hljs language-css" lang="css"><span class="hljs-comment">/* 方法1：left/top 50% + transform（最推荐，支持自适应） */</span>
<span class="hljs-selector-class">.absolute-center</span> {
  <span class="hljs-attribute">position</span>: absolute;
  <span class="hljs-attribute">left</span>: <span class="hljs-number">50%</span>;
  <span class="hljs-attribute">top</span>: <span class="hljs-number">50%</span>;
  <span class="hljs-attribute">transform</span>: <span class="hljs-built_in">translate</span>(-<span class="hljs-number">50%</span>, -<span class="hljs-number">50%</span>);
}

<span class="hljs-comment">/* 方法2：margin auto + 四个方向设为0（需固定宽高） */</span>
<span class="hljs-selector-class">.absolute-center</span> {
  <span class="hljs-attribute">position</span>: absolute;
  <span class="hljs-attribute">top</span>: <span class="hljs-number">0</span>;
  <span class="hljs-attribute">bottom</span>: <span class="hljs-number">0</span>;
  <span class="hljs-attribute">left</span>: <span class="hljs-number">0</span>;
  <span class="hljs-attribute">right</span>: <span class="hljs-number">0</span>;
  <span class="hljs-attribute">width</span>: <span class="hljs-number">200px</span>;
  <span class="hljs-attribute">height</span>: <span class="hljs-number">200px</span>;
  <span class="hljs-attribute">margin</span>: auto;
}

<span class="hljs-comment">/* 方法3：calc计算（需固定宽高） */</span>
<span class="hljs-selector-class">.absolute-center</span> {
  <span class="hljs-attribute">position</span>: absolute;
  <span class="hljs-attribute">left</span>: <span class="hljs-built_in">calc</span>(<span class="hljs-number">50%</span> - <span class="hljs-number">100px</span>); <span class="hljs-comment">/* 宽200px，100px是宽的一半 */</span>
  <span class="hljs-attribute">top</span>: <span class="hljs-built_in">calc</span>(<span class="hljs-number">50%</span> - <span class="hljs-number">100px</span>);
  <span class="hljs-attribute">width</span>: <span class="hljs-number">200px</span>;
  <span class="hljs-attribute">height</span>: <span class="hljs-number">200px</span>;
}
</code></pre>
<h3 data-id="heading-22">2. 定位元素的层级问题（z-index）</h3>
<ul>
<li><strong>默认层级</strong>：脱离文档流的元素（absolute/fixed）层级高于文档流中的元素</li>
<li><strong>z-index作用</strong>：数值越大，层级越高（默认auto，等价于0），仅对已定位元素生效</li>
<li><strong>层级继承</strong>：子元素的层级受父元素影响，父元素层级低，子元素再高也无法超过父元素的同级元素</li>
</ul>
<h3 data-id="heading-23">3. 新手最容易踩的坑</h3>
<ol>
<li><strong>absolute元素找不到参考点</strong>：忘记给父元素设relative，导致元素相对于视口定位</li>
<li><strong>sticky效果失效</strong>：没设置top/bottom等阈值，或父元素有overflow属性</li>
<li><strong>relative元素压到其他元素</strong>：误以为relative会脱离文档流，其实它只是偏移，不会让其他元素补位</li>
<li><strong>fixed在移动端抖动</strong>：可尝试用sticky替代，或给body添加<code>position: fixed;</code>（视场景调整）</li>
</ol>
<h2 data-id="heading-24">五、总结：定位的核心使用原则</h2>
<p>CSS定位的核心不是死记硬背，而是根据场景选择合适的方式，记住这几个原则：</p>
<ul>
<li><strong>简单布局用默认</strong>：不需要特殊定位时，用static遵循文档流即可</li>
<li><strong>微调位置用relative</strong>：元素需要小幅度偏移，且不影响其他布局时用它</li>
<li><strong>独立组件用absolute</strong>：弹出层、下拉菜单等需要脱离文档流的组件用它，记得给父元素加relative</li>
<li><strong>悬浮元素用fixed</strong>：导航栏、回到顶部按钮等需要始终可见的元素用它</li>
<li><strong>滚动跟随用sticky</strong>：表格标题、分类标题等需要滚动到特定位置才固定的元素用它</li>
</ul>
<p>最后，定位布局没有绝对的"最佳方案"，只有"最适合场景"的方案。建议多写案例测试，亲手感受每种定位的差异——实践才是掌握CSS定位的最好方法。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[VUE后台管理系统：定制化、高可用前台样式处理方案]]></title>    <link>https://juejin.cn/post/7575112613778309154</link>    <guid>https://juejin.cn/post/7575112613778309154</guid>    <pubDate>2025-11-23T12:32:03.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7575112613778309154" data-draft-id="7575112613778194466" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="VUE后台管理系统：定制化、高可用前台样式处理方案"/> <meta itemprop="keywords" content="前端,JavaScript,Vue.js"/> <meta itemprop="datePublished" content="2025-11-23T12:32:03.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="默海笑"/> <meta itemprop="url" content="https://juejin.cn/user/3246223221632151"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            VUE后台管理系统：定制化、高可用前台样式处理方案
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3246223221632151/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    默海笑
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-23T12:32:03.000Z" title="Sun Nov 23 2025 12:32:03 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h3 data-id="heading-0">学习前提</h3>
<p>会基本的vue，会使用AI助手，<strong><code>学习本课本的人必须长得帅。</code></strong></p>
<h3 data-id="heading-1">安装tailwindcss</h3>
<pre><code class="hljs language-js" lang="js">npm install -D tailwindcss postcss autoprefixer

npx tailwindcss init -p
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bcc0001526ff48d38725eddd519d44c0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6buY5rW356yR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764505923&amp;x-signature=o25eaQkR1pxyzc7arJuhvU24qGo%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-2">配置文件说明</h2>
<p>tailwind.config.js - 已配置为扫描所有 Vue 文件：</p>
<ul>
<li>./index.html</li>
</ul>

<ul>
<li>./src/**/*.{vue,js,ts,jsx,tsx}</li>
</ul>
<p>postcss.config.js - 已配置 Tailwind 和 Autoprefixer 插件main.scss - 已添加 Tailwind 指令：</p>
<p>@tailwind base;</p>
<p>@tailwind components;</p>
<p>@tailwind utilities;</p>
<h2 data-id="heading-3">使用示例</h2>
<p>安装完成后，你可以在 Vue 组件中直接使用 Tailwind 类名：</p>

<p>完成后，Tailwind CSS 即可在项目中使用。</p>
<p>但是启动项目遇到了这个问题：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5605be957d7a402ca0720a5b104efa82~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6buY5rW356yR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764505923&amp;x-signature=GgBJNTwJBssvLO5QO%2FWQu9E3hq0%3D" alt="image.png" loading="lazy"/></p>
<p>这是 Tailwind CSS v4 的变化。检查当前安装的版本，然后提供解决方案：</p>
<p>安装的是 Tailwind CSS v4.1.17。v4 将 PostCSS 插件移到了 @tailwindcss/postcss，因此需要调整配置。提供两种方案：</p>
<ul>
<li>方案 1（推荐）：使用 Tailwind CSS v3（更稳定，兼容性更好）</li>
</ul>

<ul>
<li>方案 2：使用 Tailwind CSS v4（需要安装 @tailwindcss/postcss）</li>
</ul>
<p>先按方案 1 处理：降级到 v3 并更新配置。</p>
<p>所以我们现在使用方案1。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/81cee420cfc2452182e13639c83b51a2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6buY5rW356yR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764505923&amp;x-signature=mEevdJGK19fIM7XAnTZp13eebqs%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-4">小试牛刀</h3>
<p>现在安装好了，那么我们现在对老项目原来的传统的css的写法，修改切换成tailwindcss方式更新。</p>
<h3 data-id="heading-5">迁移策略概述</h3>
<p>迁移原则：</p>
<ol>
<li>保留必要的第三方组件样式覆盖（如 Element Plus）</li>
</ol>

<ol start="2">
<li>将可转换的样式改为 Tailwind 实用类</li>
</ol>

<ol start="3">
<li>使用 Tailwind 的配置系统管理设计变量</li>
</ol>

<ol start="4">
<li>利用 @layer 和 @apply 处理全局样式</li>
</ol>
<h4 data-id="heading-6">1. tailwind.config.js - 主题配置扩展</h4>
<p>目的：将 SCSS 变量映射为 Tailwind 主题，统一管理设计变量。改动内容：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-attr">theme</span>: {
  <span class="hljs-attr">extend</span>: {
    <span class="hljs-comment">// 自定义颜色系统</span>
    <span class="hljs-attr">colors</span>: {
      <span class="hljs-attr">menu</span>: {
        <span class="hljs-attr">text</span>: <span class="hljs-string">'#bfcbd9'</span>,           <span class="hljs-comment">// 菜单文字颜色</span>
        <span class="hljs-string">'active-text'</span>: <span class="hljs-string">'#ffffff'</span>,   <span class="hljs-comment">// 激活状态文字</span>
        <span class="hljs-attr">bg</span>: <span class="hljs-string">'#304156'</span>,              <span class="hljs-comment">// 菜单背景色</span>
        <span class="hljs-attr">hover</span>: <span class="hljs-string">'#263445'</span>,           <span class="hljs-comment">// 悬停状态</span>
        <span class="hljs-comment">// ...</span>
      },
      <span class="hljs-attr">login</span>: {
        <span class="hljs-attr">bg</span>: <span class="hljs-string">'#2d3a4b'</span>,
        <span class="hljs-string">'dark-gray'</span>: <span class="hljs-string">'#889aa4'</span>,
        <span class="hljs-comment">// ...</span>
      }
    },
    <span class="hljs-comment">// 自定义宽度</span>
    <span class="hljs-attr">width</span>: {
      <span class="hljs-attr">sidebar</span>: <span class="hljs-string">'210px'</span>,
      <span class="hljs-string">'sidebar-hide'</span>: <span class="hljs-string">'54px'</span>,
    },
    <span class="hljs-comment">// 自定义过渡时间</span>
    <span class="hljs-attr">transitionDuration</span>: {
      <span class="hljs-attr">sidebar</span>: <span class="hljs-string">'0.28s'</span>,
    },
    <span class="hljs-comment">// 自定义字体族</span>
    <span class="hljs-attr">fontFamily</span>: {
      <span class="hljs-attr">sans</span>: [<span class="hljs-string">'Helvetica Neue'</span>, <span class="hljs-string">'PingFang SC'</span>, ...],
    }
  }
}
</code></pre>
<p>教学要点：</p>
<ul>
<li>extend 用于扩展而非覆盖默认主题</li>
</ul>

<ul>
<li>嵌套对象会生成对应的类名，如 bg-menu-bg、text-menu-text</li>
</ul>

<ul>
<li>使用连字符的键名（如 'active-text'）需要用引号包裹</li>
</ul>
<p>使用示例：</p>

<p><code>&lt;div :style="{ backgroundColor: $menuBg }"&gt;</code></p>

<p><code>&lt;div class="bg-menu-bg text-menu-text"&gt;</code></p>
<hr/>
<h4 data-id="heading-7">2. postcss.config.js - PostCSS 配置</h4>
<p>目的：配置 PostCSS 处理 Tailwind CSS。改动内容：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-attr">plugins</span>: {
    <span class="hljs-attr">tailwindcss</span>: {},    <span class="hljs-comment">// Tailwind CSS 插件</span>
    <span class="hljs-attr">autoprefixer</span>: {},   <span class="hljs-comment">// 自动添加浏览器前缀</span>
  },
}
</code></pre>
<ul>
<li>Vite 会自动读取此文件</li>
</ul>

<ul>
<li>插件顺序很重要：先 Tailwind，后 Autoprefixer</li>
</ul>

<ul>
<li>Autoprefixer 会自动处理浏览器兼容性</li>
</ul>
<hr/>
<h3 data-id="heading-8">三、全局样式文件改动</h3>
<h4 data-id="heading-9">3. src/assets/main.scss - 全局样式重构</h4>
<p>改动前：</p>
<pre><code class="hljs language-js" lang="js">@<span class="hljs-keyword">import</span> <span class="hljs-string">'./styles/variables.scss'</span>;
@<span class="hljs-keyword">import</span> <span class="hljs-string">'./styles/mixin.scss'</span>;
@<span class="hljs-keyword">import</span> <span class="hljs-string">'./styles/sidebar.scss'</span>;

html, body {
  <span class="hljs-attr">height</span>: <span class="hljs-number">100</span>%;
  <span class="hljs-attr">margin</span>: <span class="hljs-number">0</span>;
  <span class="hljs-attr">padding</span>: <span class="hljs-number">0</span>;
  font-<span class="hljs-attr">family</span>: <span class="hljs-title class_">Helvetica</span> <span class="hljs-title class_">Neue</span>, ...;
}

.<span class="hljs-property">clearfix</span> {
  &amp;:after {
    <span class="hljs-attr">visibility</span>: hidden;
    <span class="hljs-attr">display</span>: block;
    font-<span class="hljs-attr">size</span>: <span class="hljs-number">0</span>;
    <span class="hljs-attr">content</span>: <span class="hljs-string">' '</span>;
    <span class="hljs-attr">clear</span>: both;
    <span class="hljs-attr">height</span>: <span class="hljs-number">0</span>;
  }
}
</code></pre>
<p>改动后：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 1. 引入 Tailwind 核心指令</span>
@tailwind base;
@tailwind components;
@tailwind utilities;

<span class="hljs-comment">// 2. 保留必要的 SCSS 文件（包含 Element Plus 样式覆盖）</span>
@<span class="hljs-keyword">import</span> <span class="hljs-string">'./styles/variables.scss'</span>;
@<span class="hljs-keyword">import</span> <span class="hljs-string">'./styles/sidebar.scss'</span>;

<span class="hljs-comment">// 3. 使用 @layer base 定义基础样式</span>
@layer base {
  html, body {
    @apply h-full m-<span class="hljs-number">0</span> p-<span class="hljs-number">0</span>;
    -moz-osx-font-<span class="hljs-attr">smoothing</span>: grayscale;
    -webkit-font-<span class="hljs-attr">smoothing</span>: antialiased;
    text-<span class="hljs-attr">rendering</span>: optimizeLegibility;
  }
  
  #app {
    @apply h-full;
  }
  
  <span class="hljs-comment">// 全局重置</span>
  *, *:before, *:after {
    @apply box-border m-<span class="hljs-number">0</span> p-<span class="hljs-number">0</span>;
  }
}

<span class="hljs-comment">// 4. 使用 @layer utilities 定义工具类</span>
@layer utilities {
  .<span class="hljs-property">clearfix</span> {
    &amp;::after {
      @apply invisible block clear-both h-<span class="hljs-number">0</span>;
      font-<span class="hljs-attr">size</span>: <span class="hljs-number">0</span>;  <span class="hljs-comment">// 注意：Tailwind 没有 text-0，需要直接写 CSS</span>
      <span class="hljs-attr">content</span>: <span class="hljs-string">' '</span>;
    }
  }
}
</code></pre>
<ol>
<li>Tailwind 指令顺序：</li>
</ol>
<ul>
<li>@tailwind base - 基础样式重置</li>
</ul>

<ul>
<li>@tailwind components - 组件层</li>
</ul>

<ul>
<li>@tailwind utilities - 工具类</li>
</ul>
<ol start="2">
<li>@layer 的作用：</li>
</ol>
<ul>
<li>@layer base：基础样式，优先级最低</li>
</ul>

<ul>
<li>@layer components：组件样式</li>
</ul>

<ul>
<li>@layer utilities：工具类，优先级最高</li>
</ul>
<ol start="3">
<li>@apply 的使用：</li>
</ol>
<ul>
<li>在 CSS 中使用 Tailwind 类</li>
</ul>

<ul>
<li>只能用于 @layer 内</li>
</ul>

<ul>
<li>不能用于伪类选择器（如 :hover）</li>
</ul>
<p>.  注意事项：</p>
<ul>
<li>移除了 mixin.scss 导入（clearfix 已用 Tailwind 实现）</li>
</ul>

<ul>
<li>保留了 variables.scss（可能被 JS 通过 :export 使用）</li>
</ul>

<ul>
<li>保留了 sidebar.scss（包含 Element Plus 样式覆盖）</li>
</ul>
<p>其次下面是一些基本的用法</p>
<ol>
<li>类名映射：</li>
</ol>
<pre><code class="hljs language-js" lang="js">       <span class="hljs-comment">// SCSS → Tailwind</span>
       <span class="hljs-attr">position</span>: relative;     → <span class="hljs-keyword">class</span>=<span class="hljs-string">"relative"</span>
       <span class="hljs-attr">height</span>: <span class="hljs-number">100</span>%;           → <span class="hljs-keyword">class</span>=<span class="hljs-string">"h-full"</span>
       <span class="hljs-attr">width</span>: <span class="hljs-number">100</span>%;            → <span class="hljs-keyword">class</span>=<span class="hljs-string">"w-full"</span>
       <span class="hljs-attr">position</span>: fixed;        → <span class="hljs-keyword">class</span>=<span class="hljs-string">"fixed"</span>
       <span class="hljs-attr">top</span>: <span class="hljs-number">0</span>;                 → <span class="hljs-keyword">class</span>=<span class="hljs-string">"top-0"</span>
       z-<span class="hljs-attr">index</span>: <span class="hljs-number">9</span>;             → <span class="hljs-keyword">class</span>=<span class="hljs-string">"z-[9]"</span>
</code></pre>

<ol>
<li>动态值处理：</li>
</ol>
<pre><code class="hljs language-js" lang="js">       <span class="hljs-comment">// SCSS 变量</span>

       <span class="hljs-attr">width</span>: <span class="hljs-title function_">calc</span>(<span class="hljs-number">100</span>% - #{$sideBarWidth});
       <span class="hljs-comment">// Tailwind 任意值语法</span>
       <span class="hljs-keyword">class</span>=<span class="hljs-string">"w-[calc(100%-210px)]"</span>
</code></pre>

<ol>
<li>过渡动画：</li>
</ol>
<pre><code class="hljs language-js" lang="js">       <span class="hljs-comment">// SCSS</span>
       <span class="hljs-attr">transition</span>: margin-left <span class="hljs-number">0.</span>28s;
       <span class="hljs-comment">// Tailwind</span>
       <span class="hljs-keyword">class</span>=<span class="hljs-string">"transition-[margin-left] duration-[0.28s]"</span>
</code></pre>

<ol>
<li>优势：</li>
</ol>
<ul>
<li>样式与 HTML 在一起，更直观</li>
</ul>

<ul>
<li>不需要在  和模板间切换
</li></ul>

<ul>
<li>减少文件体积（Tailwind 会 tree-shake 未使用的类）</li>
</ul>
<h3 data-id="heading-10">源码：</h3>
<p>升级安装：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fmohaixiao%2Fvue-admin%2Fcommit%2Ff006923ce7a4869ad71c4edf83a81f9bd34de37f" target="_blank" title="https://github.com/mohaixiao/vue-admin/commit/f006923ce7a4869ad71c4edf83a81f9bd34de37f" ref="nofollow noopener noreferrer">github.com/mohaixiao/v…</a></p>
<p>改造代码：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fmohaixiao%2Fvue-admin%2Fcommit%2Fb1bb1408975bde2fcb1de467d45d606d10b20c86" target="_blank" title="https://github.com/mohaixiao/vue-admin/commit/b1bb1408975bde2fcb1de467d45d606d10b20c86" ref="nofollow noopener noreferrer">github.com/mohaixiao/v…</a></p>
<p>源码：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fmohaixiao%2Fvue-admin" target="_blank" title="https://github.com/mohaixiao/vue-admin" ref="nofollow noopener noreferrer">github.com/mohaixiao/v…</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Vue3-toRef、toRefs、toRaw]]></title>    <link>https://juejin.cn/post/7575106644499529762</link>    <guid>https://juejin.cn/post/7575106644499529762</guid>    <pubDate>2025-11-23T12:37:13.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7575106644499529762" data-draft-id="7575162322240372736" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Vue3-toRef、toRefs、toRaw"/> <meta itemprop="keywords" content="前端,Vue.js"/> <meta itemprop="datePublished" content="2025-11-23T12:37:13.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="YaeZed"/> <meta itemprop="url" content="https://juejin.cn/user/3977350021390107"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Vue3-toRef、toRefs、toRaw
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3977350021390107/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    YaeZed
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-23T12:37:13.000Z" title="Sun Nov 23 2025 12:37:13 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    5
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body .octicon{display:inline-block;fill:currentColor;vertical-align:text-bottom}.markdown-body .anchor{float:left;line-height:1;margin-left:-20px;padding-right:4px}.markdown-body .anchor:focus{outline:none}.markdown-body h1 .octicon-link,.markdown-body h2 .octicon-link,.markdown-body h3 .octicon-link,.markdown-body h4 .octicon-link,.markdown-body h5 .octicon-link,.markdown-body h6 .octicon-link{color:#1b1f23;vertical-align:middle;visibility:hidden}.markdown-body h1:hover .anchor,.markdown-body h2:hover .anchor,.markdown-body h3:hover .anchor,.markdown-body h4:hover .anchor,.markdown-body h5:hover .anchor,.markdown-body h6:hover .anchor{text-decoration:none}.markdown-body h1:hover .anchor .octicon-link,.markdown-body h2:hover .anchor .octicon-link,.markdown-body h3:hover .anchor .octicon-link,.markdown-body h4:hover .anchor .octicon-link,.markdown-body h5:hover .anchor .octicon-link,.markdown-body h6:hover .anchor .octicon-link{visibility:visible}.markdown-body h1:hover .anchor .octicon-link:before,.markdown-body h2:hover .anchor .octicon-link:before,.markdown-body h3:hover .anchor .octicon-link:before,.markdown-body h4:hover .anchor .octicon-link:before,.markdown-body h5:hover .anchor .octicon-link:before,.markdown-body h6:hover .anchor .octicon-link:before{width:16px;height:16px;content:" ";display:inline-block;background-image:url("data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' aria-hidden='true'%3E%3Cpath fill-rule='evenodd' d='M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z'/%3E%3C/svg%3E")}.markdown-body{-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%;color:#24292e;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Helvetica,Arial,sans-serif,Apple Color Emoji,Segoe UI Emoji;font-size:16px;line-height:1.5;word-wrap:break-word}.markdown-body details{display:block}.markdown-body summary{display:list-item}.markdown-body a{background-color:initial}.markdown-body a:active,.markdown-body a:hover{outline-width:0}.markdown-body strong{font-weight:inherit;font-weight:bolder}.markdown-body h1{margin:.67em 0}.markdown-body img{border-style:none}.markdown-body code,.markdown-body kbd,.markdown-body pre{font-family:monospace,monospace;font-size:1em}.markdown-body hr{box-sizing:initial;overflow:visible}.markdown-body input{font:inherit;margin:0;overflow:visible}.markdown-body [type=checkbox]{box-sizing:border-box;padding:0}.markdown-body *{box-sizing:border-box}.markdown-body input{font-family:inherit;font-size:inherit;line-height:inherit}.markdown-body a{color:#0366d6;text-decoration:none}.markdown-body a:hover{text-decoration:underline}.markdown-body strong{font-weight:600}.markdown-body hr{height:0;margin:15px 0;overflow:hidden;background:transparent;border-bottom:1px solid #dfe2e5}.markdown-body hr:after,.markdown-body hr:before{display:table;content:""}.markdown-body hr:after{clear:both}.markdown-body table{border-spacing:0;border-collapse:collapse}.markdown-body td,.markdown-body th{padding:0}.markdown-body details summary{cursor:pointer}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{margin-top:0;margin-bottom:0}.markdown-body h1{font-size:32px}.markdown-body h1,.markdown-body h2{font-weight:600}.markdown-body h2{font-size:24px}.markdown-body h3{font-size:20px}.markdown-body h3,.markdown-body h4{font-weight:600}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:14px}.markdown-body h5,.markdown-body h6{font-weight:600}.markdown-body h6{font-size:12px}.markdown-body p{margin-top:0;margin-bottom:10px}.markdown-body blockquote{margin:0}.markdown-body ol,.markdown-body ul{padding-left:0;margin-top:0;margin-bottom:0}.markdown-body ol ol,.markdown-body ul ol{list-style-type:lower-roman}.markdown-body ol ol ol,.markdown-body ol ul ol,.markdown-body ul ol ol,.markdown-body ul ul ol{list-style-type:lower-alpha}.markdown-body dd{margin-left:0}.markdown-body code,.markdown-body pre{font-family:SFMono-Regular,Consolas,Liberation Mono,Menlo,monospace;font-size:12px}.markdown-body pre{margin-top:0;margin-bottom:0}.markdown-body input::-webkit-inner-spin-button,.markdown-body input::-webkit-outer-spin-button{margin:0;-webkit-appearance:none;appearance:none}.markdown-body :checked+.radio-label{position:relative;z-index:1;border-color:#0366d6}.markdown-body .border{border:1px solid #e1e4e8!important}.markdown-body .border-0{border:0!important}.markdown-body .border-bottom{border-bottom:1px solid #e1e4e8!important}.markdown-body .rounded-1{border-radius:3px!important}.markdown-body .bg-white{background-color:#fff!important}.markdown-body .bg-gray-light{background-color:#fafbfc!important}.markdown-body .text-gray-light{color:#6a737d!important}.markdown-body .pl-3,.markdown-body .px-3{padding-left:16px!important}.markdown-body .px-3{padding-right:16px!important}.markdown-body .f6{font-size:12px!important}.markdown-body .lh-condensed{line-height:1.25!important}.markdown-body .text-bold{font-weight:600!important}.markdown-body .pl-c{color:#6a737d}.markdown-body .pl-c1,.markdown-body .pl-s .pl-v{color:#005cc5}.markdown-body .pl-e,.markdown-body .pl-en{color:#6f42c1}.markdown-body .pl-s .pl-s1,.markdown-body .pl-smi{color:#24292e}.markdown-body .pl-ent{color:#22863a}.markdown-body .pl-k{color:#d73a49}.markdown-body .pl-pds,.markdown-body .pl-s,.markdown-body .pl-s .pl-pse .pl-s1,.markdown-body .pl-sr,.markdown-body .pl-sr .pl-cce,.markdown-body .pl-sr .pl-sra,.markdown-body .pl-sr .pl-sre{color:#032f62}.markdown-body .pl-smw,.markdown-body .pl-v{color:#e36209}.markdown-body .pl-bu{color:#b31d28}.markdown-body .pl-ii{color:#fafbfc;background-color:#b31d28}.markdown-body .pl-c2{color:#fafbfc;background-color:#d73a49}.markdown-body .pl-c2:before{content:"^M"}.markdown-body .pl-sr .pl-cce{font-weight:700;color:#22863a}.markdown-body .pl-ml{color:#735c0f}.markdown-body .pl-mh,.markdown-body .pl-mh .pl-en,.markdown-body .pl-ms{font-weight:700;color:#005cc5}.markdown-body .pl-mi{font-style:italic;color:#24292e}.markdown-body .pl-mb{font-weight:700;color:#24292e}.markdown-body .pl-md{color:#b31d28;background-color:#ffeef0}.markdown-body .pl-mi1{color:#22863a;background-color:#f0fff4}.markdown-body .pl-mc{color:#e36209;background-color:#ffebda}.markdown-body .pl-mi2{color:#f6f8fa;background-color:#005cc5}.markdown-body .pl-mdr{font-weight:700;color:#6f42c1}.markdown-body .pl-ba{color:#586069}.markdown-body .pl-sg{color:#959da5}.markdown-body .pl-corl{text-decoration:underline;color:#032f62}.markdown-body .mb-0{margin-bottom:0!important}.markdown-body .my-2{margin-bottom:8px!important;margin-top:8px!important}.markdown-body .pl-0{padding-left:0!important}.markdown-body .py-0{padding-top:0!important;padding-bottom:0!important}.markdown-body .pl-1{padding-left:4px!important}.markdown-body .pl-2{padding-left:8px!important}.markdown-body .py-2{padding-top:8px!important;padding-bottom:8px!important}.markdown-body .pl-3{padding-left:16px!important}.markdown-body .pl-4{padding-left:24px!important}.markdown-body .pl-5{padding-left:32px!important}.markdown-body .pl-6{padding-left:40px!important}.markdown-body .pl-7{padding-left:48px!important}.markdown-body .pl-8{padding-left:64px!important}.markdown-body .pl-9{padding-left:80px!important}.markdown-body .pl-10{padding-left:96px!important}.markdown-body .pl-11{padding-left:112px!important}.markdown-body .pl-12{padding-left:128px!important}.markdown-body hr{border-bottom-color:#eee}.markdown-body kbd{display:inline-block;padding:3px 5px;font:11px SFMono-Regular,Consolas,Liberation Mono,Menlo,monospace;line-height:10px;color:#444d56;vertical-align:middle;background-color:#fafbfc;border:1px solid #d1d5da;border-radius:3px;box-shadow:inset 0 -1px 0 #d1d5da}.markdown-body:after,.markdown-body:before{display:table;content:""}.markdown-body:after{clear:both}.markdown-body&gt;:first-child{margin-top:0!important}.markdown-body&gt;:last-child{margin-bottom:0!important}.markdown-body a:not([href]){color:inherit;text-decoration:none}.markdown-body blockquote,.markdown-body details,.markdown-body dl,.markdown-body ol,.markdown-body p,.markdown-body pre,.markdown-body table,.markdown-body ul{margin-top:0;margin-bottom:16px}.markdown-body hr{height:.25em;padding:0;margin:24px 0;background-color:#e1e4e8;border:0}.markdown-body blockquote{padding:0 1em;color:#6a737d;border-left:.25em solid #dfe2e5}.markdown-body blockquote&gt;:first-child{margin-top:0}.markdown-body blockquote&gt;:last-child{margin-bottom:0}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{margin-top:24px;margin-bottom:16px;font-weight:600;line-height:1.25}.markdown-body h1{font-size:2em}.markdown-body h1,.markdown-body h2{padding-bottom:.3em;border-bottom:1px solid #eaecef}.markdown-body h2{font-size:1.5em}.markdown-body h3{font-size:1.25em}.markdown-body h4{font-size:1em}.markdown-body h5{font-size:.875em}.markdown-body h6{font-size:.85em;color:#6a737d}.markdown-body ol,.markdown-body ul{padding-left:2em}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:0;margin-bottom:0}.markdown-body li{word-wrap:break-all}.markdown-body li&gt;p{margin-top:16px}.markdown-body li+li{margin-top:.25em}.markdown-body dl{padding:0}.markdown-body dl dt{padding:0;margin-top:16px;font-size:1em;font-style:italic;font-weight:600}.markdown-body dl dd{padding:0 16px;margin-bottom:16px}.markdown-body table{display:block;width:100%;overflow:auto}.markdown-body table th{font-weight:600}.markdown-body table td,.markdown-body table th{padding:6px 13px;border:1px solid #dfe2e5}.markdown-body table tr{background-color:#fff;border-top:1px solid #c6cbd1}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}.markdown-body img{max-width:100%;box-sizing:initial;background-color:#fff}.markdown-body img[align=right]{padding-left:20px}.markdown-body img[align=left]{padding-right:20px}.markdown-body code{padding:.2em .4em;margin:0;font-size:85%;background-color:rgba(27,31,35,.05);border-radius:3px}.markdown-body pre{word-wrap:normal}.markdown-body pre&gt;code{padding:0;margin:0;font-size:100%;word-break:normal;white-space:pre;background:transparent;border:0}.markdown-body .highlight{margin-bottom:16px}.markdown-body .highlight pre{margin-bottom:0;word-break:normal}.markdown-body .highlight pre,.markdown-body pre{padding:16px;overflow:auto;font-size:85%;line-height:1.45;background-color:#f6f8fa;border-radius:3px}.markdown-body pre code{display:inline;max-width:auto;padding:0;margin:0;overflow:visible;line-height:inherit;word-wrap:normal;background-color:initial;border:0}.markdown-body .commit-tease-sha{display:inline-block;font-family:SFMono-Regular,Consolas,Liberation Mono,Menlo,monospace;font-size:90%;color:#444d56}.markdown-body .full-commit .btn-outline:not(:disabled):hover{color:#005cc5;border-color:#005cc5}.markdown-body .blob-wrapper{overflow-x:auto;overflow-y:hidden}.markdown-body .blob-wrapper-embedded{max-height:240px;overflow-y:auto}.markdown-body .blob-num{width:1%;min-width:50px;padding-right:10px;padding-left:10px;font-family:SFMono-Regular,Consolas,Liberation Mono,Menlo,monospace;font-size:12px;line-height:20px;color:rgba(27,31,35,.3);text-align:right;white-space:nowrap;vertical-align:top;cursor:pointer;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}.markdown-body .blob-num:hover{color:rgba(27,31,35,.6)}.markdown-body .blob-num:before{content:attr(data-line-number)}.markdown-body .blob-code{position:relative;padding-right:10px;padding-left:10px;line-height:20px;vertical-align:top}.markdown-body .blob-code-inner{overflow:visible;font-family:SFMono-Regular,Consolas,Liberation Mono,Menlo,monospace;font-size:12px;color:#24292e;word-wrap:normal;white-space:pre}.markdown-body .pl-token.active,.markdown-body .pl-token:hover{cursor:pointer;background:#ffea7f}.markdown-body .tab-size[data-tab-size="1"]{-moz-tab-size:1;tab-size:1}.markdown-body .tab-size[data-tab-size="2"]{-moz-tab-size:2;tab-size:2}.markdown-body .tab-size[data-tab-size="3"]{-moz-tab-size:3;tab-size:3}.markdown-body .tab-size[data-tab-size="4"]{-moz-tab-size:4;tab-size:4}.markdown-body .tab-size[data-tab-size="5"]{-moz-tab-size:5;tab-size:5}.markdown-body .tab-size[data-tab-size="6"]{-moz-tab-size:6;tab-size:6}.markdown-body .tab-size[data-tab-size="7"]{-moz-tab-size:7;tab-size:7}.markdown-body .tab-size[data-tab-size="8"]{-moz-tab-size:8;tab-size:8}.markdown-body .tab-size[data-tab-size="9"]{-moz-tab-size:9;tab-size:9}.markdown-body .tab-size[data-tab-size="10"]{-moz-tab-size:10;tab-size:10}.markdown-body .tab-size[data-tab-size="11"]{-moz-tab-size:11;tab-size:11}.markdown-body .tab-size[data-tab-size="12"]{-moz-tab-size:12;tab-size:12}.markdown-body .task-list-item{list-style-type:none}.markdown-body .task-list-item+.task-list-item{margin-top:3px}.markdown-body .task-list-item input{margin:0 .2em .25em -1.6em;vertical-align:middle}</style><style data-highlight="" data-highlight-key="gml">.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#222;color:silver}.hljs-keyword{color:#ffb871;font-weight:700}.hljs-built_in{color:#ffb871}.hljs-literal{color:#ff8080}.hljs-symbol{color:#58e55a}.hljs-comment{color:#5b995b}.hljs-string{color:#ff0}.hljs-number{color:#ff8080}.hljs-addition,.hljs-attribute,.hljs-bullet,.hljs-code,.hljs-deletion,.hljs-doctag,.hljs-function,.hljs-link,.hljs-meta,.hljs-meta-keyword,.hljs-name,.hljs-quote,.hljs-regexp,.hljs-section,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-id,.hljs-selector-pseudo,.hljs-selector-tag,.hljs-subst,.hljs-template-tag,.hljs-template-variable,.hljs-title,.hljs-type,.hljs-variable{color:silver}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在 Vue 3 中，<code>toRef</code>、<code>toRefs</code> 和 <code>toRaw</code> 都是处理响应式系统的重要工具，它们提供了更灵活的方式来操作 <code>reactive</code> 对象。</p>
<h2 data-id="heading-0">1.toRef</h2>
<p><code>toRef</code> 用于为 <code>reactive</code> 对象上的<strong>单个属性</strong>创建一个<strong>响应式的 <code>ref</code></strong>。</p>
<p><code>toRef</code> 接收两个参数：源对象和属性名。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">import</span> { reactive, toRef, watchEffect, isRef } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>;

<span class="hljs-comment">// 1. 定义源对象</span>
<span class="hljs-keyword">const</span> state = <span class="hljs-title function_">reactive</span>({
  <span class="hljs-attr">foo</span>: <span class="hljs-string">'hello'</span>,
  <span class="hljs-attr">bar</span>: <span class="hljs-number">100</span>,
});

<span class="hljs-comment">// 2. 创建单个 ref</span>
<span class="hljs-comment">// const fooRef = toRef(state, 'foo');</span>
<span class="hljs-comment">// 使用 TS 泛型 (虽然通常会自动推断)</span>
<span class="hljs-keyword">const</span> fooRef = toRef&lt;<span class="hljs-keyword">typeof</span> state, <span class="hljs-string">'foo'</span>&gt;(state, <span class="hljs-string">'foo'</span>);

<span class="hljs-comment">// 3. 验证</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title function_">isRef</span>(fooRef)); <span class="hljs-comment">// true</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(fooRef.<span class="hljs-property">value</span>); <span class="hljs-comment">// 'hello'</span>

<span class="hljs-comment">// 4. 双向绑定特性</span>
<span class="hljs-comment">// 修改 toRef 创建的 ref 会更新原始对象</span>
fooRef.<span class="hljs-property">value</span> = <span class="hljs-string">'world'</span>;
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(state.<span class="hljs-property">foo</span>); <span class="hljs-comment">// 'world'</span>

<span class="hljs-comment">// 修改原始对象也会更新 ref</span>
state.<span class="hljs-property">foo</span> = <span class="hljs-string">'hello again'</span>;
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(fooRef.<span class="hljs-property">value</span>); <span class="hljs-comment">// 'hello again'</span>

<span class="hljs-comment">// 监听变化</span>
<span class="hljs-title function_">watchEffect</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`fooRef changed to: <span class="hljs-subst">${fooRef.value}</span>`</span>);
});

state.<span class="hljs-property">foo</span> = <span class="hljs-string">'Final value'</span>; <span class="hljs-comment">// watchEffect 会触发</span>
</code></pre>
<p><code>toRef</code> 最核心的用例是<strong>在不丢失响应性的情况下传递 <code>props</code></strong>。</p>
<blockquote>
<p>举个栗子：从父组件接收参数</p>
</blockquote>
<ul>
<li>当你在 <code>setup</code> 中解构 <code>props</code> 时，你会丢失响应性，因为你得到的是一个普通的 JavaScript 变量。</li>
</ul>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// MyComponent.vue</span>
<span class="hljs-keyword">import</span> { defineProps, watchEffect } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>;

<span class="hljs-keyword">const</span> props = defineProps&lt;{
  <span class="hljs-attr">count</span>: <span class="hljs-built_in">number</span>;
}&gt;();

<span class="hljs-comment">// 这样解构会丢失响应性</span>
<span class="hljs-keyword">let</span> { count } = props;
<span class="hljs-comment">// count 只是一个普通的 number，当 props.count 变化时，它不会更新</span>

<span class="hljs-title function_">watchEffect</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-comment">// 这个 effect 永远不会再次运行，即使 props.count 变了</span>
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`Count is: <span class="hljs-subst">${count}</span>`</span>); 
});
</code></pre>
<ul>
<li>正确示例（使用<code>toRef</code>）</li>
</ul>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// MyComponent.vue</span>
<span class="hljs-keyword">import</span> { defineProps, toRef, watchEffect } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>;

<span class="hljs-keyword">const</span> props = defineProps&lt;{
  <span class="hljs-attr">count</span>: <span class="hljs-built_in">number</span>;
}&gt;();

<span class="hljs-comment">// 使用 toRef 将 props.count 转换为一个 ref</span>
<span class="hljs-keyword">const</span> countRef = <span class="hljs-title function_">toRef</span>(props, <span class="hljs-string">'count'</span>);

<span class="hljs-title function_">watchEffect</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-comment">// 现在 countRef 是响应式的</span>
  <span class="hljs-comment">// 当 props.count 变化时，这个 effect 会重新运行</span>
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`Count is: <span class="hljs-subst">${countRef.value}</span>`</span>);
});
</code></pre>
<h2 data-id="heading-1">2.toRefs</h2>
<p><code>toRefs</code> 用于将一个 <code>reactive</code> 对象的<strong>所有属性</strong>转换为一个普通对象，其中<strong>每个属性都是一个 <code>ref</code></strong>。</p>
<p><code>toRefs</code> 接收一个 <code>reactive</code> 对象。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">import</span> { reactive, toRefs, <span class="hljs-title class_">ToRefs</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>;

<span class="hljs-keyword">interface</span> <span class="hljs-title class_">User</span> {
  <span class="hljs-attr">name</span>: <span class="hljs-built_in">string</span>;
  <span class="hljs-attr">age</span>: <span class="hljs-built_in">number</span>;
}

<span class="hljs-keyword">const</span> state = reactive&lt;<span class="hljs-title class_">User</span>&gt;({
  <span class="hljs-attr">name</span>: <span class="hljs-string">'Bob'</span>,
  <span class="hljs-attr">age</span>: <span class="hljs-number">25</span>,
});

<span class="hljs-comment">// 1. 转换整个对象</span>
<span class="hljs-comment">// stateAsRefs 的类型是 { name: Ref&lt;string&gt;, age: Ref&lt;number&gt; }</span>
<span class="hljs-keyword">const</span> stateAsRefs = <span class="hljs-title function_">toRefs</span>(state);

<span class="hljs-comment">// 2. 访问</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(stateAsRefs.<span class="hljs-property">name</span>.<span class="hljs-property">value</span>); <span class="hljs-comment">// 'Bob'</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(stateAsRefs.<span class="hljs-property">age</span>.<span class="hljs-property">value</span>); <span class="hljs-comment">// 25</span>

<span class="hljs-comment">// 3. 同样具有双向绑定特性</span>
stateAsRefs.<span class="hljs-property">name</span>.<span class="hljs-property">value</span> = <span class="hljs-string">'Charlie'</span>;
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(state.<span class="hljs-property">name</span>); <span class="hljs-comment">// 'Charlie'</span>

state.<span class="hljs-property">age</span> = <span class="hljs-number">26</span>;
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(stateAsRefs.<span class="hljs-property">age</span>.<span class="hljs-property">value</span>); <span class="hljs-comment">// 26</span>
</code></pre>
<blockquote>
<p>举个栗子：<code>toRefs</code> 最常见的场景是<strong>在 <code>setup</code> 函数中返回响应式对象时</strong>，允许你在模板中直接使用属性，或者在解构时保持响应性。</p>
</blockquote>
<ul>
<li><code>setup</code> 中返回对象
如果你直接返回一个 <code>reactive</code> 对象，你必须在模板中以 <code>state.name</code> 的方式访问它。</li>
</ul>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">import</span> { reactive, toRefs, toRef, toRaw } <span class="hljs-keyword">from</span> <span class="hljs-string">"vue"</span>;

<span class="hljs-keyword">interface</span> <span class="hljs-title class_">User</span> {
  <span class="hljs-attr">name</span>: <span class="hljs-built_in">string</span>;
  <span class="hljs-attr">age</span>: <span class="hljs-built_in">number</span>;
}

<span class="hljs-keyword">const</span> user = reactive&lt;<span class="hljs-title class_">User</span>&gt;({
  <span class="hljs-attr">name</span>: <span class="hljs-string">"YaeZed"</span>,
  <span class="hljs-attr">age</span>: <span class="hljs-number">25</span>,
});
<span class="hljs-comment">// 如果想直接结构reactive，会丢失响应性</span>
<span class="hljs-keyword">const</span> { name, age } = user;

<span class="hljs-comment">// 模板中: &lt;p&gt;{{ user.name }}&lt;/p&gt; &lt;p&gt;{{ user.age }}&lt;/p&gt;</span>
</code></pre>
<p>使用 <code>toRefs</code>，你可以"展开" (spread) 这个对象，使其属性在模板中顶层可用。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">import</span> { reactive, toRefs, toRef, toRaw } <span class="hljs-keyword">from</span> <span class="hljs-string">"vue"</span>;

<span class="hljs-keyword">interface</span> <span class="hljs-title class_">User</span> {
  <span class="hljs-attr">name</span>: <span class="hljs-built_in">string</span>;
  <span class="hljs-attr">age</span>: <span class="hljs-built_in">number</span>;
}

<span class="hljs-keyword">const</span> user = reactive&lt;<span class="hljs-title class_">User</span>&gt;({
  <span class="hljs-attr">name</span>: <span class="hljs-string">"YaeZed"</span>,
  <span class="hljs-attr">age</span>: <span class="hljs-number">25</span>,
});
<span class="hljs-comment">// 使用 toRefs 解构，将所有属性转换为ref</span>
<span class="hljs-keyword">const</span> { name, age } = <span class="hljs-title function_">toRefs</span>(user);

<span class="hljs-comment">// 模板中: &lt;p&gt;{{ name }}&lt;/p&gt; &lt;p&gt;{{ age }}&lt;/p&gt;</span>
<span class="hljs-comment">// (模板会自动解包 .value)</span>
</code></pre>
<ul>
<li>解构 <code>reactive</code> 对象
与 <code>toRef</code> 类似，如果你想解构一个 <code>reactive</code> 对象同时保持响应性，必须使用 <code>toRefs</code>。</li>
</ul>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">import</span> { reactive, toRefs, watchEffect } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>;

<span class="hljs-keyword">const</span> state = <span class="hljs-title function_">reactive</span>({
  <span class="hljs-attr">x</span>: <span class="hljs-number">1</span>,
  <span class="hljs-attr">y</span>: <span class="hljs-number">2</span>,
});

<span class="hljs-comment">// ❌ 错误：丢失响应性</span>
<span class="hljs-comment">// const { x, y } = state; </span>
<span class="hljs-comment">// x 和 y 只是数字 1 和 2</span>

<span class="hljs-comment">// ✅ 正确：使用 toRefs</span>
<span class="hljs-keyword">const</span> { x, y } = <span class="hljs-title function_">toRefs</span>(state);
<span class="hljs-comment">// x 和 y 现在是 Ref&lt;number&gt;</span>

<span class="hljs-title function_">watchEffect</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`x: <span class="hljs-subst">${x.value}</span>, y: <span class="hljs-subst">${y.value}</span>`</span>);
});

<span class="hljs-comment">// 修改 state 会触发 watchEffect</span>
state.<span class="hljs-property">x</span> = <span class="hljs-number">10</span>;
</code></pre>
<h2 data-id="heading-2">3.toRaw</h2>
<p><code>toRaw</code> 用于从 Vue 的<strong>响应式代理 (Proxy)</strong> 中获取<strong>原始的、非响应式的目标对象</strong>。</p>
<p><code>toRaw</code> 接收一个由 <code>reactive</code> 或 <code>readonly</code> 创建的代理。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">import</span> { reactive, toRaw, isReactive } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>;

<span class="hljs-keyword">interface</span> <span class="hljs-title class_">Data</span> {
  <span class="hljs-attr">count</span>: <span class="hljs-built_in">number</span>;
}

<span class="hljs-keyword">const</span> <span class="hljs-attr">data</span>: <span class="hljs-title class_">Data</span> = { <span class="hljs-attr">count</span>: <span class="hljs-number">0</span> };
<span class="hljs-keyword">const</span> state = reactive&lt;<span class="hljs-title class_">Data</span>&gt;(data);

<span class="hljs-comment">// 1. 获取原始对象</span>
<span class="hljs-keyword">const</span> rawData = <span class="hljs-title function_">toRaw</span>(state);

<span class="hljs-comment">// 2. 验证</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title function_">isReactive</span>(state)); <span class="hljs-comment">// true</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title function_">isReactive</span>(rawData)); <span class="hljs-comment">// false</span>

<span class="hljs-comment">// 3. 比较</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(rawData === data); <span class="hljs-comment">// true (它们是同一个原始对象)</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(state === data); <span class="hljs-comment">// false (state 是一个 Proxy)</span>

<span class="hljs-comment">// 4. 修改</span>
<span class="hljs-comment">// 修改原始对象 (raw) 仍然会通过引用改变代理对象 (state)</span>
rawData.<span class="hljs-property">count</span> = <span class="hljs-number">1</span>;
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(state.<span class="hljs-property">count</span>); <span class="hljs-comment">// 1</span>

<span class="hljs-comment">// **关键区别**:</span>
<span class="hljs-comment">// 通过 rawData 修改属性 *不会* 触发 Vue 的响应式系统</span>
<span class="hljs-comment">// (例如，依赖 state.count 的 watcher 不会运行，组件也不会重新渲染)</span>

<span class="hljs-comment">// 只有通过 state (代理) 修改才会触发更新</span>
state.<span class="hljs-property">count</span> = <span class="hljs-number">2</span>; <span class="hljs-comment">// 这将触发更新</span>
</code></pre>
<blockquote>
<p><code>toRaw</code> 应该<strong>谨慎使用</strong>，因为它会脱离 Vue 的响应式追踪。</p>
</blockquote>
<ul>
<li>
<p><strong>性能优化 (临时读取)</strong> : 当你需要读取 <code>reactive</code> 对象的数据，但你<strong>确定</strong>这个读取操作不需要被追踪（即不希望它触发 <code>watchEffect</code> 或组件更新）时。</p>
</li>
<li>
<p><strong>传递给外部库</strong>: 某些第三方库（如图表库）可能不应该接收 Vue 的 Proxy 对象。它们可能试图直接修改对象，或者 Vue 的代理可能会导致性能问题或意外行为。在这种情况下，你可以使用 <code>toRaw</code> 传递原始数据。</p>
</li>
<li>
<p><strong>调试</strong>: 在浏览器控制台中检查一个 <code>reactive</code> 对象时，它会被显示为 <code>Proxy</code>。使用 <code>toRaw(state)</code> 可以让你看到它背后的原始数据结构。</p>
</li>
</ul>
<h2 data-id="heading-3">4.总结</h2>

































<table><thead><tr><th align="center">API</th><th align="center">输入</th><th align="center">输出</th><th align="center">核心特点</th><th align="center">使用场景</th></tr></thead><tbody><tr><td align="center"><code>toRef</code></td><td align="center"><code>reactive</code> 对象, 属性名 (key)</td><td align="center">单个 <code>Ref</code></td><td align="center"><code>ref.value</code> 与 <code>state.key</code> 双向同步</td><td align="center">传递 <code>props</code> 给组合式函数，保持对单个 <code>prop</code> 的响应性</td></tr><tr><td align="center"><code>toRefs</code></td><td align="center"><code>reactive</code> 对象</td><td align="center">包含多个 <code>Ref</code> 的新对象</td><td align="center"><code>state</code> 的所有属性都变为 <code>Ref</code></td><td align="center">解构 <code>reactive</code> 对象时保持响应性</td></tr><tr><td align="center"><code>toRaw</code></td><td align="center"><code>reactive</code> 代理对象</td><td align="center">原始的、非响应式对象</td><td align="center">绕过响应式追踪的原生对象</td><td align="center">性能优化（避免追踪），传递数据给外部库</td></tr></tbody></table>
<p><code>参考文章</code></p>
<p>小满zs 学习Vue3 第八章（认识to系列全家桶）<a href="https://link.juejin.cn?target=https%3A%2F%2Fxiaoman.blog.csdn.net%2Farticle%2Fdetails%2F122791665" target="_blank" title="https://xiaoman.blog.csdn.net/article/details/122791665" ref="nofollow noopener noreferrer">xiaoman.blog.csdn.net/article/det…</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[WHM-PF：优化翻页体验的高性能React翻页插件]]></title>    <link>https://juejin.cn/post/7575102209606533146</link>    <guid>https://juejin.cn/post/7575102209606533146</guid>    <pubDate>2025-11-23T12:37:04.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7575102209606533146" data-draft-id="7575182522411499558" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="WHM-PF：优化翻页体验的高性能React翻页插件"/> <meta itemprop="keywords" content="React.js"/> <meta itemprop="datePublished" content="2025-11-23T12:37:04.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="我很忙65"/> <meta itemprop="url" content="https://juejin.cn/user/872334419564842"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            WHM-PF：优化翻页体验的高性能React翻页插件
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/872334419564842/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    我很忙65
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-23T12:37:04.000Z" title="Sun Nov 23 2025 12:37:04 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在数字阅读和在线文档场景中，流畅自然的翻页效果能极大提升用户体验。今天介绍一款基于PageFlip二次开发的翻页插件——WHM-PF，它解决了原版PageFlip的诸多痛点，提供了更优秀的翻页解决方案。插件地址<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.npmjs.com%2Fpackage%2Fwhm-pf" target="_blank" title="https://www.npmjs.com/package/whm-pf" ref="nofollow noopener noreferrer">www.npmjs.com/package/whm…</a></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/41516b558d5b4b93a47d82d0214138eb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oiR5b6I5b-ZNjU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764506223&amp;x-signature=HyXanfrTEajDQdwBmdd7EjesDMg%3D" alt="video.gif" loading="lazy"/></p>
<h3 data-id="heading-0">原版PageFlip的基本使用</h3>
<p>首先，让我们回顾一下原版PageFlip插件的使用方法：</p>
<pre><code class="hljs language-javascript" lang="javascript">&lt;div id=<span class="hljs-string">"book"</span>&gt;
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"my-page"</span> <span class="hljs-attr">data-density</span>=<span class="hljs-string">"hard"</span>&gt;</span>
        Page Cover
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"my-page"</span>&gt;</span>
        Page one
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"my-page"</span>&gt;</span>
        Page two
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"my-page"</span>&gt;</span>
        Page three
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"my-page"</span>&gt;</span>
        Page four
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"my-page"</span> <span class="hljs-attr">data-density</span>=<span class="hljs-string">"hard"</span>&gt;</span>
        Last page
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
&lt;/div&gt;
<span class="hljs-keyword">const</span> pageFlip = <span class="hljs-keyword">new</span> <span class="hljs-title class_">PageFlip</span>(<span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'book'</span>), {
    <span class="hljs-attr">width</span>: <span class="hljs-number">400</span>, <span class="hljs-comment">// required parameter - base page width</span>
    <span class="hljs-attr">height</span>: <span class="hljs-number">600</span>, <span class="hljs-comment">// required parameter - base page height</span>
});

pageFlip.<span class="hljs-title function_">loadFromHTML</span>(<span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelectorAll</span>(<span class="hljs-string">'.my-page'</span>));
</code></pre>
<p>通过简单的配置，PageFlip就能实现精美的翻页效果，这确实是一个优秀的翻页解决方案。然而，在实际应用场景中，我们发现PageFlip存在一些局限性：</p>
<ol>
<li>翻页触发区域固定，只能从页面左上角或右上角触发</li>
<li>不支持内容自动换行，需要手动计算和调整</li>
<li>图片处理能力有限，特别是在报告类页面中表现不佳</li>
<li>缺乏图片懒加载机制，大量图片时性能堪忧</li>
</ol>
<p>基于这些痛点，我们查阅了PageFlip的源码，并进行了二次开发，推出了WHM-PF插件。</p>
<h3 data-id="heading-1">WHM-PF的核心优势</h3>
<h4 data-id="heading-2">1. 全屏任意位置触发翻页</h4>
<p>WHM-PF打破了原版PageFlip的触发区域限制，用户可以从屏幕任何位置进行翻页操作，更符合真实阅读体验：</p>
<ul>
<li>左侧任意位置向右滑动 → 向前翻页</li>
<li>右侧任意位置向左滑动 → 向后翻页</li>
</ul>
<p>这种设计让用户无需精确寻找触发点，大大提升了操作便捷性。</p>
<h4 data-id="heading-3">2. 智能内容自动换行</h4>
<p>WHM-PF引入了智能内容处理机制：</p>
<ul>
<li>自动检测内容尺寸并适配页面</li>
<li>支持文本内容自动换行，无需手动调整</li>
<li>自适应不同屏幕尺寸和设备方向</li>
</ul>
<h4 data-id="heading-4">3. 强大的图片处理能力</h4>
<p>针对报告类页面和图文混排场景，WHM-PF提供了：</p>
<ul>
<li>原生图片翻页支持</li>
<li>自动图片懒加载机制，提升大量图片场景下的性能</li>
<li>图片预加载和缓存策略，确保翻页流畅性</li>
</ul>
<h4 data-id="heading-5">4. 零配置上手体验</h4>
<p>WHM-PF保留了PageFlip的简洁API设计，同时提供了更智能的默认配置：</p>
<p>javascript</p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">// 使用WHM-PF，无需复杂配置即可获得优秀体验</span>
<span class="hljs-keyword">const</span> pageFlip = <span class="hljs-keyword">new</span> WHMPageFlip(<span class="hljs-built_in">document</span>.getElementById(<span class="hljs-string">'book'</span>));
pageFlip.loadFromHTML(<span class="hljs-built_in">document</span>.<span class="hljs-built_in">querySelectorAll</span>(<span class="hljs-string">'.my-page'</span>));
</code></pre>
<h3 data-id="heading-6">实际应用场景</h3>
<p>WHM-PF特别适合以下场景：</p>
<ul>
<li>电子书和在线小说阅读器</li>
<li>企业报告和产品手册展示</li>
<li>数字杂志和期刊阅读</li>
<li>交互式教育材料</li>
</ul>
<h3 data-id="heading-7">总结</h3>
<p>WHM-PF在保留PageFlip优秀翻页效果的基础上，解决了实际应用中的痛点问题，提供了更自然、更便捷的翻页体验。无论是从交互设计还是性能优化角度，WHM-PF都展现出了明显的优势。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Vite的知识点]]></title>    <link>https://juejin.cn/post/7575442779039399978</link>    <guid>https://juejin.cn/post/7575442779039399978</guid>    <pubDate>2025-11-23T13:21:44.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7575442779039399978" data-draft-id="7575468252656042025" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Vite的知识点"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-11-23T13:21:44.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="面向div编程"/> <meta itemprop="url" content="https://juejin.cn/user/2195088949385101"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Vite的知识点
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2195088949385101/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    面向div编程
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-23T13:21:44.000Z" title="Sun Nov 23 2025 13:21:44 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">深入浅出 Vite：从双引擎架构到插件流水线全解</h2>
<h3 data-id="heading-1">前言</h3>
<p>作为一个前端开发者，我们每天都在用 Vite，但你真的了解它在 <code>npm run dev</code> 和 <code>npm run build</code> 时到底干了什么吗？为什么开发环境那么快？生产环境又为什么要换用 Rollup？插件钩子到底在什么时候执行？</p>
<p>本文将带你像剥洋葱一样，一层层揭开 Vite 的底层原理，从架构设计到插件开发实战，彻底搞懂这个现代前端构建工具。</p>
<hr/>
<h3 data-id="heading-2">一、 Vite 的核心架构：独特的“双引擎”</h3>
<p>Vite 之所以能兼顾<strong>极致的开发体验</strong>和<strong>稳定的生产产物</strong>，是因为它采用了一套“精神分裂”般的双引擎架构。</p>
<h4 data-id="heading-3">1. 开发环境 (Dev)：Esbuild + Native ESM</h4>
<ul>
<li><strong>核心策略</strong>：<strong>No-Bundle（不打包）</strong>。</li>
<li><strong>Esbuild 的角色</strong>：
<ul>
<li><strong>依赖预构建</strong>：启动时扫描 <code>package.json</code>，用 Esbuild 将 CommonJS 依赖转换为 ESM，并打包成单一文件（缓存到 <code>node_modules/.vite</code>）。</li>
<li><strong>单文件编译</strong>：将 TS/JSX 瞬间编译为 JS（只抹除类型，不进行类型检查），速度是 TS 官方编译器的 10-100 倍。</li>
</ul>
</li>
<li><strong>工作流</strong>：
<ul>
<li>利用浏览器原生的 ES Modules 能力。</li>
<li><strong>按需编译</strong>：浏览器请求什么文件，Vite 服务器才拦截、编译、返回什么文件。路由不访问，代码就不编译。</li>
</ul>
</li>
</ul>
<h4 data-id="heading-4">2. 生产环境 (Build)：Rollup + Esbuild</h4>
<ul>
<li><strong>核心策略</strong>：<strong>Bundle（全量打包）</strong>。</li>
<li><strong>Rollup 的角色</strong>：负责核心打包逻辑。提供强大的 Tree-Shaking（摇树优化）、Code Splitting（代码分割）和成熟的插件生态。</li>
<li><strong>Esbuild 的角色</strong>：在打包的最后阶段，替代 Terser 进行 <strong>Minification（代码压缩）</strong>，效率极大提升。</li>
</ul>
<hr/>
<h3 data-id="heading-5">二、 插件系统：Vite 的灵魂</h3>
<p>Vite 的插件系统是 <strong>Rollup 插件接口的超集</strong>。这意味着 Vite 在开发环境<strong>模拟</strong>了一个 Rollup 的执行环境（PluginContainer），而在生产环境直接调用 Rollup。</p>
<h4 data-id="heading-6">1. 钩子的执行阶段</h4>
<p>我们将插件的生命周期分为三个阶段：<strong>准备阶段</strong>、<strong>通用构建阶段</strong>、<strong>输出阶段</strong>。</p>
<h5 data-id="heading-7">🟢 第一阶段：准备与配置 (Setup)</h5>
<p>这是服务器启动或构建开始前的准备工作。</p>






























<table><thead><tr><th align="left">钩子</th><th align="left">来源</th><th align="left">说明</th></tr></thead><tbody><tr><td align="left"><code>config</code></td><td align="left">Vite</td><td align="left"><strong>修改配置</strong>。具有“滚雪球”特性，上一个插件修改的配置会传给下一个。</td></tr><tr><td align="left"><code>configResolved</code></td><td align="left">Vite</td><td align="left"><strong>读取配置</strong>。配置已冻结，只读，用于记录最终配置。</td></tr><tr><td align="left"><code>configureServer</code></td><td align="left">Vite</td><td align="left"><strong>Dev 独有</strong>。用于注册 Dev Server 的中间件（Middleware）。</td></tr><tr><td align="left"><code>buildStart</code></td><td align="left">Rollup</td><td align="left"><strong>构建开始</strong>。初始化工作，如打印 Log。</td></tr></tbody></table>
<h5 data-id="heading-8">🔵 第二阶段：核心编译 (The Loop)</h5>
<p>这是最繁忙的阶段。<strong>每个文件</strong>被引入时都会完整走一遍这个流程。</p>

























<table><thead><tr><th align="left">钩子</th><th align="left">来源</th><th align="left">作用与参数</th></tr></thead><tbody><tr><td align="left"><code>resolveId(source, importer)</code></td><td align="left">Rollup</td><td align="left"><strong>找文件</strong>。拦截 import 路径，告诉 Vite 文件在哪（或处理虚拟模块）。</td></tr><tr><td align="left"><code>load(id)</code></td><td align="left">Rollup</td><td align="left"><strong>读文件</strong>。加载源代码。如果返回 null，则读取硬盘文件。</td></tr><tr><td align="left"><code>transform(code, id)</code></td><td align="left">Rollup</td><td align="left"><strong>改代码</strong>。核心钩子。TS转JS、Vue模版编译、正则替换都在这里。</td></tr></tbody></table>
<p><strong>Dev 与 Build 的巨大差异：</strong></p>
<ul>
<li><strong>Dev (按需)</strong>：浏览器请求一次，执行一次。有缓存机制。</li>
<li><strong>Build (全量)</strong>：从入口文件开始递归分析依赖图，一次性处理所有关联文件。</li>
</ul>
<h5 data-id="heading-9">🔴 第三阶段：产物输出 (Output Generation)</h5>
<p>⚠️ <strong>注意：这些钩子只在 <code>npm run build</code> 生产打包时执行！</strong></p>

























<table><thead><tr><th align="left">钩子</th><th align="left">来源</th><th align="left">作用与场景</th></tr></thead><tbody><tr><td align="left"><code>renderChunk(code, chunk)</code></td><td align="left">Rollup</td><td align="left"><strong>精修代码</strong>。此时代码已合并、Tree-shaking 已完成。用于代码压缩、添加 Banner。</td></tr><tr><td align="left"><code>generateBundle(options, bundle)</code></td><td align="left">Rollup</td><td align="left"><strong>管理文件</strong>。<code>bundle</code> 对象包含所有将要生成的文件。用于生成 Manifest、删除文件、分析体积。</td></tr><tr><td align="left"><code>closeBundle</code></td><td align="left">Rollup</td><td align="left"><strong>收尾</strong>。文件写入硬盘后触发。用于清理缓存、上传 CDN。</td></tr></tbody></table>
<hr/>
<h3 data-id="heading-10">三、 深入解析：构建中的关键概念</h3>
<h4 data-id="heading-11">1. RenderChunk vs Transform</h4>
<ul>
<li><strong>Transform</strong>：是在<strong>做零件</strong>。处理的是源码（TS/Vue），此时文件之间是独立的。</li>
<li><strong>RenderChunk</strong>：是在<strong>拼乐高</strong>。此时模块已经被合并成 Chunk（JS 文件），<code>import</code> 语句已被拍平。</li>
</ul>
<h4 data-id="heading-12">2. 代码分割 (Code Splitting)</h4>
<p>为什么一个入口 (<code>main.ts</code>) 会打包出多个文件？</p>
<ul>
<li><strong>Vendor Splitting</strong>：将 <code>node_modules</code>（Vue/React）拆分为单独的 Chunk。利用浏览器强缓存，业务代码更新不影响第三方库的缓存。</li>
<li><strong>Dynamic Import</strong>：代码中出现 <code>import('./foo.vue')</code> 时，Vite 会自动将其拆分为独立的 Chunk，实现路由懒加载。</li>
</ul>
<h4 data-id="heading-13">3. Hash (文件指纹)</h4>
<p>文件名中的乱码（如 <code>index.a1b2c3d.js</code>）是为了<strong>长期缓存</strong>。
只要文件内容变了，Hash 必变 -&gt; URL 变了 -&gt; 浏览器重新下载。
如果内容没变，Hash 不变 -&gt; URL 不变 -&gt; 浏览器直接读本地缓存（速度极快）。</p>
<hr/>
<h3 data-id="heading-14">四、 实战：手写一个“间谍插件”</h3>
<p>最好的学习方式是把钩子打印出来。把这段代码放入 <code>vite.config.ts</code>，你将看清 Vite 的五脏六腑。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// vite-plugin-spy.ts</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">spyPlugin</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">return</span> {
    <span class="hljs-attr">name</span>: <span class="hljs-string">'vite-plugin-spy'</span>,
    <span class="hljs-comment">// 1. 修改配置阶段</span>
    <span class="hljs-title function_">config</span>(<span class="hljs-params">config</span>) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'🟢 [Config] 配置开始合并...'</span>);
    },
    <span class="hljs-comment">// 2. 核心编译阶段</span>
    <span class="hljs-title function_">transform</span>(<span class="hljs-params">code, id</span>) {
      <span class="hljs-keyword">if</span> (!id.<span class="hljs-title function_">includes</span>(<span class="hljs-string">'node_modules'</span>)) {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`🔵 [Transform] 正在转换: <span class="hljs-subst">${id.split(<span class="hljs-string">'/'</span>).pop()}</span>`</span>);
      }
    },
    <span class="hljs-comment">// 3. 产物输出阶段 (仅 Build 生效)</span>
    <span class="hljs-title function_">renderChunk</span>(<span class="hljs-params">code, chunk</span>) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`🔴 [RenderChunk] 生成文件: <span class="hljs-subst">${chunk.fileName}</span>`</span>);
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`   - 包含模块: <span class="hljs-subst">${<span class="hljs-built_in">Object</span>.keys(chunk.modules).length}</span> 个`</span>);
    },
    <span class="hljs-title function_">generateBundle</span>(<span class="hljs-params">options, bundle</span>) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'📦 [GenerateBundle] 最终产物清单:'</span>);
      <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">keys</span>(bundle).<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">file</span> =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`   📄 <span class="hljs-subst">${file}</span>`</span>));
    }
  };
}
</code></pre>
<hr/>
<h3 data-id="heading-15">五、 常见面试/疑难问题解答</h3>
<p><strong>Q1: 为什么开发环境不用 Rollup？</strong></p>
<blockquote>
<p>因为 Rollup 必须先分析完整个依赖图才能打包，启动慢。Vite 利用 Esbuild (Go语言) 和浏览器原生 ESM，实现了 O(1) 级别的启动速度。</p>
</blockquote>
<p><strong>Q2: 插件里的 <code>config</code> 钩子会被覆盖吗？</strong></p>
<blockquote>
<p>不会被“覆盖”，而是被“合并”。Vite 会按顺序执行所有插件的 config 钩子，并将返回的配置对象深度合并。</p>
</blockquote>
<p><strong>Q3: <code>generateBundle</code> 可以用来拆分代码吗？</strong></p>
<blockquote>
<p>不可以。执行到 <code>generateBundle</code> 时，代码拆分（Split Chunks）已经结束了。这里只能对生成好的文件列表进行增删改查（如删除不需要的文件，生成资源清单）。</p>
</blockquote>
<p><strong>Q4: <code>renderChunk</code> 里的 <code>code</code> 参数是什么？</strong></p>
<blockquote>
<p>是经过 Tree-Shaking、Scope Hoisting（作用域提升）合并后的 JS 字符串。所有的 <code>import</code> 本地模块语句都消失了，变成了函数定义。</p>
</blockquote>
<hr/>
<h3 data-id="heading-16">六、 总结图谱</h3>
<pre><code class="hljs language-scss" lang="scss">graph <span class="hljs-selector-tag">TD</span>
    <span class="hljs-built_in">Start</span>(npm run build) --&gt; Config<span class="hljs-selector-attr">[Config Hook: 修改配置]</span>
    Config --&gt; Options<span class="hljs-selector-attr">[Options Hook: Rollup配置]</span>
    Options --&gt; BuildStart<span class="hljs-selector-attr">[BuildStart Hook]</span>
    
    subgraph Build_Phase <span class="hljs-selector-attr">[核心编译阶段 (递归)]</span>
        Resolve<span class="hljs-selector-attr">[ResolveId: 找路径]</span> --&gt; Load<span class="hljs-selector-attr">[Load: 读源码]</span>
        Load --&gt; <span class="hljs-attribute">Transform</span><span class="hljs-selector-attr">[Transform: 源码转JS]</span>
    end
    
    BuildStart --&gt; Build_Phase
    
    subgraph Output_Phase <span class="hljs-selector-attr">[输出阶段]</span>
        RenderChunk<span class="hljs-selector-attr">[RenderChunk: 压缩/精修Chunk]</span> --&gt; GenerateBundle<span class="hljs-selector-attr">[GenerateBundle: 产物清单]</span>
        GenerateBundle --&gt; Write<span class="hljs-selector-attr">[写入硬盘 /dist]</span>
    end
    
    Build_Phase --&gt; Output_Phase
    Write --&gt; Close<span class="hljs-selector-attr">[CloseBundle: 结束]</span>
</code></pre>
<hr/>
<p>希望这篇文档能帮助你和更多掘金的小伙伴彻底掌握 Vite 的构建原理！🚀</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[【前端工程化】一文看懂现代Monorepo（npm）工程]]></title>    <link>https://juejin.cn/post/7575442779039432746</link>    <guid>https://juejin.cn/post/7575442779039432746</guid>    <pubDate>2025-11-23T13:35:23.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7575442779039432746" data-draft-id="7575655132755574803" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="【前端工程化】一文看懂现代Monorepo（npm）工程"/> <meta itemprop="keywords" content="前端,NPM,前端工程化"/> <meta itemprop="datePublished" content="2025-11-23T13:35:23.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="疯狂踩坑人"/> <meta itemprop="url" content="https://juejin.cn/user/1011206430698574"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            【前端工程化】一文看懂现代Monorepo（npm）工程
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1011206430698574/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    疯狂踩坑人
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-23T13:35:23.000Z" title="Sun Nov 23 2025 13:35:23 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    4
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读24分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>引言：本文介绍了目前流行的 <code>pnpm workspace</code> + <code>changesets</code> + <code>turborepo</code> 构建npm包项目的方案，这套方案也适用于其他大型Monorepo项目。此外，还补充了前端工程下<code>package.json</code>、<code>tsconfig</code>和<code>husky</code>等配置知识以及<code>CI/CD</code>相关常识。</p>
</blockquote>
<h2 data-id="heading-0">一、认识package.json</h2>
<p>一个package.json代表了一个项目，可以通过npm/yarn/pnpm命令初始化一个<code>package.json</code>:</p>
<pre><code class="hljs language-bash" lang="bash">pnpm init
</code></pre>
<p>然后自行完善package.json。下面我选举了几个著名npm包的<code>package.json</code>作为学习参考，并且重点介绍一些字段含义来帮我们理解项目。</p>
<p>1.比如 <code>vueuse</code>npm包的 <code>packages/shared/package.json</code></p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"@vueuse/shared"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"module"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"version"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"14.0.0"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"author"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Anthony Fu &lt;https://github.com/antfu&gt;"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"license"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"MIT"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"funding"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"https://github.com/sponsors/antfu"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"homepage"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"https://github.com/vueuse/vueuse/tree/main/packages/shared#readme"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"repository"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"git"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"url"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"git+https://github.com/vueuse/vueuse.git"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"directory"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"packages/shared"</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"bugs"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"url"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"https://github.com/vueuse/vueuse/issues"</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"keywords"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
    <span class="hljs-string">"vue"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-string">"vue-use"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"sideEffects"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">false</span></span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"exports"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"."</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"./dist/index.js"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"./*"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"./dist/*"</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"main"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"./dist/index.js"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"module"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"./dist/index.js"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"unpkg"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"./dist/index.iife.min.js"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"jsdelivr"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"./dist/index.iife.min.js"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"types"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"./dist/index.d.ts"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"files"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
    <span class="hljs-string">"dist"</span>
  <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"scripts"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"build"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"tsdown"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"prepack"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"pnpm run build"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"test:attw"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"attw --pack --config-path ../../.attw.json ."</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"peerDependencies"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"vue"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"^3.5.0"</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>2.比如<code>ahooks</code>的<code>packages/hooks/package.json</code></p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"ahooks"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"version"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"3.9.6"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"description"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"react hooks library"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"keywords"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
    <span class="hljs-string">"ahooks"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-string">"umi hooks"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-string">"react hooks"</span>
  <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"main"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"./lib/index.js"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"module"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"./es/index.js"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"types"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"./lib/index.d.ts"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"unpkg"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"dist/ahooks.js"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"sideEffects"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">false</span></span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"authors"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"brickspert"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"email"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"brickspert.fjl@alipay.com"</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"publishConfig"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"registry"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"https://registry.npmjs.org/"</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"repository"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"https://github.com/alibaba/hooks"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"homepage"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"https://github.com/alibaba/hooks"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"scripts"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"build"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"gulp &amp;&amp; webpack-cli"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"test"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"vitest run --color"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"test:cov"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"vitest run --color --coverage"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"tsc"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"tsc --noEmit"</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"files"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
    <span class="hljs-string">"dist"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-string">"lib"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-string">"es"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-string">"metadata.json"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-string">"package.json"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-string">"README.md"</span>
  <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"dependencies"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"peerDependencies"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"react"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"^16.8.0 || ^17.0.0 || ^18.0.0 || ^19.0.0"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"react-dom"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"^16.8.0 || ^17.0.0 || ^18.0.0 || ^19.0.0"</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"license"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"MIT"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"gitHead"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"11f6ad571bd365c95ecb9409ca3050cbbfc9b34a"</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>3.element-plus的<code>packages/element-plus/package.json</code></p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"element-plus"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"version"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"0.0.0-dev.1"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"description"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"A Component Library for Vue 3"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"keywords"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
    <span class="hljs-string">"element-plus"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"homepage"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"https://element-plus.org/"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"bugs"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"url"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"https://github.com/element-plus/element-plus/issues"</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"license"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"MIT"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"main"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"lib/index.js"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"module"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"es/index.mjs"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"types"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"es/index.d.ts"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"exports"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"."</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"types"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"./es/index.d.ts"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"import"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"./es/index.mjs"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"require"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"./lib/index.js"</span>
    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"./global"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"types"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"./global.d.ts"</span>
    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"./es"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"types"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"./es/index.d.ts"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"import"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"./es/index.mjs"</span>
    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"./lib"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"types"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"./lib/index.d.ts"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"require"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"./lib/index.js"</span>
    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"./es/*.mjs"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"types"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"./es/*.d.ts"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"import"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"./es/*.mjs"</span>
    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"./es/*"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"types"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
        <span class="hljs-string">"./es/*.d.ts"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-string">"./es/*/index.d.ts"</span>
      <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"import"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"./es/*.mjs"</span>
    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"./lib/*.js"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"types"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"./lib/*.d.ts"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"require"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"./lib/*.js"</span>
    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"./lib/*"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"types"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
        <span class="hljs-string">"./lib/*.d.ts"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-string">"./lib/*/index.d.ts"</span>
      <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"require"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"./lib/*.js"</span>
    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"./*"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"./*"</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"unpkg"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"dist/index.full.js"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"jsdelivr"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"dist/index.full.js"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"repository"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"git"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"url"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"git+https://github.com/element-plus/element-plus.git"</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"publishConfig"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"access"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"public"</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"style"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"dist/index.css"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"peerDependencies"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"vue"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"^3.2.0"</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"dependencies"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"devDependencies"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"web-types"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"web-types.json"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"browserslist"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
    <span class="hljs-string">"&gt; 1%"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-string">"not ie 11"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-string">"not op_mini all"</span>
  <span class="hljs-punctuation">]</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>4.比如 <code>naive-ui</code>的 <code>package.json</code>  （naive-ui项目不是monorepo）</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"naive-ui"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"version"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"2.43.1"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"packageManager"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"pnpm@9.5.0"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"description"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"A Vue 3 Component Library. Fairly Complete, Theme Customizable, Uses TypeScript, Fast"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"author"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"07akioni"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"license"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"MIT"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"homepage"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"https://www.naiveui.com"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"repository"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"git"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"url"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"https://github.com/tusen-ai/naive-ui"</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"keywords"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
    <span class="hljs-string">"naive-ui"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"sideEffects"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">false</span></span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"main"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"lib/index.js"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"module"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"es/index.mjs"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"unpkg"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"dist/index.js"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"jsdelivr"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"dist/index.js"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"types"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"es/index.d.ts"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"files"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
    <span class="hljs-string">"README.md"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-string">"dist"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-string">"es"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-string">"generic"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-string">"lib"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-string">"volar.d.ts"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-string">"web-types.json"</span>
  <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"scripts"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"start"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"pnpm run dev"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"dev"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"pnpm run clean &amp;&amp; pnpm run gen-version &amp;&amp; pnpm run gen-volar-dts &amp;&amp; NODE_ENV=development vite"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"web-types"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"./web-types.json"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"peerDependencies"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"vue"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"^3.0.0"</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"dependencies"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"devDependencies"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>

<span class="hljs-punctuation">}</span>
</code></pre>
<h3 data-id="heading-1">文件目录</h3>
<h4 data-id="heading-2">1.<code>"type"</code>字段</h4>
<p>可以设置<code>"type": "module"</code> 或者<code>"type": "commonjs"</code></p>
<p><strong>含义</strong>：这个字段指定了Node.js应该如何处理<code>.js</code>文件的模块系统。</p>
<p><strong>作用</strong>：</p>
<ul>
<li>当设置为<code>"module"</code>时，所有<code>.js</code>文件都会被当作ES模块处理</li>
<li>这意味着您可以使用<code>import/export</code>语法而不是<code>require/module.exports</code></li>
<li>如果没有设置或者设置为<code>"commonjs"</code>，则使用CommonJS模块系统</li>
</ul>
<p>但是你要注意：js/ts文件是"谁"运行的，如果是Node，自然遵循上述原则。但如果是webpack/vite/rollup/tsdown这类构建工具其实<code>"type"</code>这个字段对这类js/ts文件约束不到，因为此时不管是import还是require写的，构建工具都应该能识别并转换到target（target指配置打包cjs还是esm格式）</p>
<p>a. <code>vueuse</code>声明了<code>"type": "module"</code> ，然后采用<code>.js + "import"</code>语法
b. 你还会发现很多项目也不爱写type:"module"，然后有两种处理方式：</p>
<ul>
<li><code>.mjs + "import"</code>的语法，比如<code>element-plus</code></li>
<li><code>.js + "require"</code>的语法，比如<code>ahooks</code></li>
</ul>
<p><code>vueuse</code>项目部分截图</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0965c7a848a044f79f11a75ea89e7d89~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55av54uC6Lip5Z2R5Lq6:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764510392&amp;x-signature=H0HQ9meCbBteGtCKoTtukWK4Gcg%3D" alt="image.png" loading="lazy"/>
<code>ahooks</code>项目部分截图</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/19d00c5d41e243d48e2acd96de4e560a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55av54uC6Lip5Z2R5Lq6:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764510392&amp;x-signature=BYWfLnvNywRQD7TFhA8jHouT74I%3D" alt="image.png" loading="lazy"/></p>
<blockquote>
<p>P.S. 项目下<code>vitest.config.ts</code>种都是采用<code>import</code>语法，不管你声没声明<code>"type": "module"</code>，这是因为Node v12 模块系统就开始支持require和import两种语法了。</p>
</blockquote>
<h4 data-id="heading-3">2.<code>"module"</code>字段</h4>
<p><strong>含义</strong>：当使用<code>import ... from xx</code>导入包时，构建工具（如webpack、rollup或vite等）用来识别ES模块版本的入口文件。</p>
<p><strong>作用</strong>：</p>
<ul>
<li>当打包工具支持ES模块时，会优先使用这个字段指定的文件作为入口</li>
<li>有助于实现tree-shaking（摇树优化），因为ES模块是静态分析的</li>
</ul>
<p><strong>在您的项目中</strong>：<code>"module": "./dist/index.mjs"</code> 表示打包工具使用ESM导入时，从入口<code>./dist/index.mjs</code>这个文件导入。</p>
<h4 data-id="heading-4">3.<code>"main"</code>字段</h4>
<p><strong>含义</strong>：当使用<code>require()</code>导入包时，Node.js会查找这个字段指定的文件。</p>
<p><strong>作用</strong>：</p>
<ul>
<li><code>"main"</code>字段指定了包的CommonJS入口点。</li>
<li>这是传统的包入口点定义方式。</li>
</ul>
<p><strong>与<code>"module"</code>字段的区别</strong>：</p>
<ul>
<li><code>"main"</code>: CommonJS入口（用于Node.js的require）</li>
<li><code>"module"</code>: ES模块入口（用于打包工具的ESM的import/export）</li>
</ul>
<h4 data-id="heading-5">4.<code>"exports"</code>字段（现代替代方案）</h4>
<p><strong>含义</strong>：这是Node.js 12+引入的现代包入口点定义方式，提供了更精细的控制。</p>
<p>在您的项目中，可以这样配置</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-string">"exports"</span>: {
    <span class="hljs-string">"."</span>: {
	    <span class="hljs-string">"types"</span>: <span class="hljs-string">"./dist/index.d.ts"</span>,    // TypeScript类型定义
	    <span class="hljs-string">"import"</span>: <span class="hljs-string">"./dist/index.js"</span>     // ES模块导入入口
	}
    <span class="hljs-string">"./*"</span>: <span class="hljs-string">"./dist/*"</span>
  }
</code></pre>
<p>如果你同时提供了ESM和CommonJS产物导出，你可以这样配置</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-attr">"exports"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"."</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"types"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"./es/index.d.ts"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"import"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"./es/index.mjs"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"require"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"./lib/index.js"</span>
    <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p><strong>解释</strong></p>
<ul>
<li><code>".": "./dist/index.js"</code> - 当其他模块通过 <code>import ... from '@caikengren/uni-hooks'</code>导入您的包时，Node.js将使用 <code>index.js</code> 文件作为入口点。</li>
<li><code>"./*": "./dist/*" </code> - 这允许导入包的子路径，例如 <code>import useXXX from '@caikengren/uni-hooks/useXXX'</code> 。这种模式允许访问包内的特定文件或子模块。</li>
<li><code>"types": "./dist/index.d.ts"</code> - 告诉 TypeScript 编译器在哪里找到该包的类型声明文件。</li>
</ul>
<p><strong>补充说明</strong></p>
<ul>
<li><code>exports</code>应该比这比传统的 main/module 字段提供了更强大的控制能力。 <code>exports</code>比较新，为了兼容性，一般也需要对应配置好main/module。</li>
<li>控制包的访问边界。使用 exports 字段的一个重要好处是它可以保护包的内部文件。在没有 exports 字段的情况下，包的所有文件都可以被导入。而使用 exports 字段后，只有明确定义的路径才能被外部访问，这为包作者提供了更好的封装性。</li>
</ul>
<h4 data-id="heading-6">5.<code>"files"</code>字段</h4>
<p>定义了npm上传到仓库时，需要上传哪些文件（目录），通常包含你打包的代码文件、package.json、README还有其他运行时要用到的文件 。</p>
<p>例如：类似<code>ahooks</code>，它针对Node CJS、浏览器ESM和浏览器unpkg的形式打包了三份代码，分别放在三个不同文件夹，这些文件夹都是要上传的。所以<code>files</code>字段定义了dist、lib和es。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/29d2db0684f3495584f7387332ad8306~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55av54uC6Lip5Z2R5Lq6:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764510392&amp;x-signature=yvUv0Q9ttZKz8xtzshmrLgwE4Gk%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-7">发布配置</h3>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-string">"private"</span>: <span class="hljs-literal">true</span>,
<span class="hljs-string">"publishConfig"</span>: {
  <span class="hljs-string">"tag"</span>: <span class="hljs-string">"1.1.0"</span>,
  <span class="hljs-string">"registry"</span>: <span class="hljs-string">"https://registry.npmjs.org/"</span>,
  <span class="hljs-string">"access"</span>: <span class="hljs-string">"public"</span>
}
</code></pre>
<h4 data-id="heading-8">1.<code>"private"</code>字段</h4>
<p>1.<code>private</code>字段可以防止我们意外地将私有库发布到npm服务器。即当我们使用<code>npm publish</code>发布时不会被当做一个“npm包”被发布。 比如monorepo项目的根package.json文件（仅管理项目结构用，不是一个单独的npm包）。</p>
<p>2.但即使<code>"private": true</code>，当我配置了<code>publishConfig</code>，那么也是可以继续发布的。明确配置了<code>publishConfig</code>可以保证这个包是可以安全发布的。</p>
<p>3.默认 <code>"private"</code>字段为 <code>true</code>。</p>
<h4 data-id="heading-9">2.<code>"publishConfig"</code>字段</h4>
<p>1.当发布包时这个配置会起作用，在这里配置tag或仓库地址。</p>
<p>2.<code>"registry"</code>：你团队/公司的的npm仓库地址。</p>
<p>3.<code>"tag"</code>：默认就是 <code>latest</code>（表示发布的就是正式版）。有时候需要发布beta版本（公开测试），那么这个tag就起作用了。</p>
<p>4.假设我们的<code>version: 1.1.1-beta.0</code>，然后通过<code>npm publish --tag beta</code>发布（注意：此时发布命令多了一个--tag参数），如果不显示指定--tag，那么就会用到我们的<code>publishConfig.tag</code>作为这个tag值。</p>
<p>5.tag值的作用就是告诉仓库这是个<code>beta</code>版本。当有人如下安装时：</p>
<pre><code class="hljs language-bash" lang="bash">npm i your-package@latest
</code></pre>
<p>6.不会安装最近发布的beta版，而是安装最近最新发布的latest版（发行版）。
如果需要安装beta版，需要手动指定版本:</p>
<pre><code class="hljs language-bash" lang="bash">npm i your-package@1.1.1-beta.0
</code></pre>
<h3 data-id="heading-10">依赖配置</h3>
<h4 data-id="heading-11">1.<code>"dependencies"</code></h4>
<p><code>dependencies</code>：声明的是项目的生产环境中所必须的依赖包。打包时会把这些依赖的代码打包进去（这些包往往是运行时起作用）。</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-attr">"dependencies"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
   <span class="hljs-attr">"react"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"^18.0.2"</span><span class="hljs-punctuation">,</span>
   <span class="hljs-attr">"react-dom"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"~18.0.2"</span><span class="hljs-punctuation">,</span>
   <span class="hljs-attr">"lodash"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"4.17.21"</span> 
<span class="hljs-punctuation">}</span>
</code></pre>
<p>这里每一项配置都是一个键值对（key-value）， key表示模块名称，value表示模块的版本号。版本号遵循<code>主版本号.次版本号.修订号</code>的格式规定：</p>
<ul>
<li><strong>固定版本：</strong> <code>"lodash": "4.17.21"</code>表示安装时只安装这个指定的版本；</li>
<li><strong>波浪号：</strong> <code>"react-dom": "~18.0.2"</code>表示安装18.0.x的最新版本（不低于18.0.2），也就是说安装时不会改变主版本号和次版本号，修订号会安装最新的；</li>
<li><strong>插入号：</strong> <code>"react": "^18.0.2"</code>表示安装18.x.x的最新版本（不低于18.0.2），也就是说安装时不会改变主版本号，次版本号和修订号会安装最新的；</li>
</ul>
<p>通常推荐<code>"^18.0.2"</code>这种，保证大版本的最新。</p>
<h4 data-id="heading-12">2.<code>"devDependencies"</code></h4>
<p><code>devDependencies</code>：声明的是项目的开发环境、项目运行起来所必须的依赖包。打包时<strong>不会</strong>把这些依赖的代码打包进去（这些包往往是编译时起作用）。像<code>typescript</code>，<code>vite</code>还有一些vite plugin和type包。</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-attr">"devDependencies"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"@types/node"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"^20.10.0"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"@vitejs/plugin-vue"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"^6.0.1"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"tsdown"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"^0.15.12"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"typescript"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"^5.4.0"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"vite"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"^5.0.0"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-punctuation">}</span>
</code></pre>
<h4 data-id="heading-13">3.<code>"peerDependencies"</code></h4>
<p><code>peerDependencies</code>：这个专门用于npm包项目。我的npm包项目和安装这个npm的项目可能依赖同一个模块（另外一个npm包），那么我的npm包打包时就不需要把这个模块打包进去。比如：
我的npm包是依赖<code>vue</code>框架，所有安装我这个npm包的项目都应该安装了<code>vue</code>依赖，那么就有
我的npm包package.json:</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"my-package"</span><span class="hljs-punctuation">,</span>
<span class="hljs-attr">"peerDependencies"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"vue"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"^3.4.0"</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>a.当别人项目的vue的大版本 和 我的npm包相同</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-attr">"dependencies"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"vue"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"^3.4.1"</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>此时别人项目<code>npm i my-package</code>时可以安装成功的。<code>my-package</code>和别人项目一起依赖<code>vue@3.4.1</code>。</p>
<p>b.但是当别人项目的vue的大版本 和 我的npm包不同</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-attr">"dependencies"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"vue"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"^2.4.1"</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>此时别人项目<code>npm i my-package</code>时无法成功，会提示别人（报错）：</p>
<pre><code class="hljs language-perl" lang="perl">npm ERR! Could <span class="hljs-keyword">not</span> resolve dependency: npm ERR! peer vue@"^<span class="hljs-number">3.4</span>.<span class="hljs-number">0</span> from <span class="hljs-keyword">my</span>-<span class="hljs-keyword">package</span>@1.<span class="hljs-number">1.1</span>
</code></pre>
<p>此时有一些比较安全可以绕过的方式：</p>
<pre><code class="hljs language-ts" lang="ts">npm i my-package --legacy-peer-deps
</code></pre>
<p>👉 适用于你明确知道自己在干什么，比如“这个库虽然没声明支持 vue 2，但其实可以工作”。（这是有一定风险的）</p>
<h3 data-id="heading-14">参考</h3>
<p><a href="https://juejin.cn/post/7023539063424548872" target="_blank" title="https://juejin.cn/post/7023539063424548872">关于前端大管家 package.json，你知道多少？</a><br/>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fjaywcjlove%2Fpackage.json" target="_blank" title="https://github.com/jaywcjlove/package.json" ref="nofollow noopener noreferrer">PACKAGE.JSON</a><br/>
<a href="https://juejin.cn/post/6919306081164345351" target="_blank" title="https://juejin.cn/post/6919306081164345351">在NPM上发布beta或alpha版</a></p>
<h2 data-id="heading-15">二、认识tsconfig配置和eslint config</h2>
<h4 data-id="heading-16">tsconfig</h4>
<p><code>tsconfig.json</code> 是 TypeScript 项目的核心配置文件，用于控制 TypeScript 编译器（<code>tsc</code>）的行为。它决定了哪些文件会被编译、如何编译、以及输出结果的格式和位置。下面我将结合你的项目实际情况，详细解释常见的配置项及其作用：</p>
<h5 data-id="heading-17">1. <code>compilerOptions</code></h5>
<p>这是最重要的配置块，决定了编译器的具体行为。常见字段如下：</p>
<ul>
<li><strong><code>target</code></strong>：指定编译后的 JavaScript 版本，比如 <code>"ESNext"</code>、<code>"ES2020"</code>。影响新语法的支持。</li>
<li><strong><code>module</code></strong>：指定模块系统，如 <code>"ESNext"</code>、<code>"CommonJS"</code>。你的项目采用 ESM，通常设置为 <code>"ESNext"</code>。</li>
<li><strong><code>lib</code></strong>：指定要包含在编译中的库，比如 <code>["DOM", "ESNext"]</code>，决定可用的全局类型。</li>
<li><strong><code>declaration</code></strong>：是否生成类型声明文件（<code>.d.ts</code>），通常库项目会开启。</li>
<li><strong><code>outDir</code></strong>：编译输出目录，比如 <code>"dist"</code>。</li>
<li><code>baseUrl</code>:  通常设置为根目录<code>"."</code>，它是ts中识别路径的"起点"。比如<code>import ... from 'src/...'</code>，表示从<code>.</code>路径下找<code>src</code>目录。</li>
<li><strong><code>rootDir</code></strong>：源码根目录，决定哪些文件被编译。</li>
<li><strong><code>strict</code></strong>：开启所有严格类型检查选项，建议库项目开启。</li>
<li><strong><code>esModuleInterop</code></strong>：允许默认导入 CommonJS 模块，提升兼容性。</li>
<li><strong><code>skipLibCheck</code></strong>：跳过库文件的类型检查，加快编译速度。</li>
</ul>
<h5 data-id="heading-18">2.<code>paths</code>  别名</h5>
<p>TypeScript 仅在“编译期”识别路径别名，它不会影响运行时。要让别名在运行时也可用，需要让打包器（Vite/Rollup/tsdown）或 Node 的解析与之保持一致。<strong>必须先确保设置了baseUrl</strong></p>
<p>常见配置：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-comment">// tsconfig.json</span>
<span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"compilerOptions"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"baseUrl"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"."</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"paths"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"@caikengren/uni-hooks-shared"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"packages/uni-hooks-shared/index.ts"</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"@caikengren/uni-hooks"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"packages/uni-hooks/index.ts"</span><span class="hljs-punctuation">]</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>运行时配合（示例以 Vite 为例）：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// vite.config.ts</span>
<span class="hljs-keyword">import</span> { defineConfig } <span class="hljs-keyword">from</span> <span class="hljs-string">'vite'</span>
<span class="hljs-keyword">import</span> path <span class="hljs-keyword">from</span> <span class="hljs-string">'node:path'</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title function_">defineConfig</span>({
  <span class="hljs-attr">resolve</span>: {
    <span class="hljs-attr">alias</span>: {
      <span class="hljs-string">'@caikengren/uni-hooks-shared'</span>: path.<span class="hljs-title function_">resolve</span>(__dirname, <span class="hljs-string">'packages/uni-hooks-shared/index.ts'</span>),
      <span class="hljs-string">'@caikengren/uni-hooks'</span>: path.<span class="hljs-title function_">resolve</span>(__dirname, <span class="hljs-string">'packages/uni-hooks/index.ts'</span>),
    },
  },
})
</code></pre>
<p>在库项目中，<strong>更推荐通过“包名”引用，而不是源码别名</strong>：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-comment">// packages/hooks/package.json</span>
<span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"@caikengren/uni-hooks"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"dependencies"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"@caikengren/uni-hooks-shared"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"workspace:^"</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>这样在代码里直接：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">import</span> { foo } <span class="hljs-keyword">from</span> <span class="hljs-string">'@caikengren/uni-hooks-shared'</span>
</code></pre>
<p>避免了别名与打包器的双重维护。</p>
<h5 data-id="heading-19">3. <code>include</code> 和 <code>exclude</code></h5>
<ul>
<li><strong><code>include</code></strong>：指定要编译的文件或目录（如 <code>["src"]</code>）。</li>
<li><strong><code>exclude</code></strong>：指定不编译的文件或目录（如 <code>["node_modules", "dist"]</code>）。</li>
</ul>
<h5 data-id="heading-20">4.<code>extends</code></h5>
<p>用于“继承”一份基础配置，统一 Monorepo 多包的 TypeScript 行为。</p>
<p>推荐在根目录放置一份基准：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-comment">// tsconfig.json（根）</span>
<span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"compilerOptions"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"target"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"ES2020"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"module"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"ESNext"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"lib"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"ESNext"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"DOM"</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"strict"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"declaration"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"skipLibCheck"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>子包继承并按需覆盖：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-comment">// packages/uni-hooks-shared/tsconfig.json</span>
<span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"extends"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"../../tsconfig.json"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"compilerOptions"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"rootDir"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"src"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"outDir"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"dist"</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"include"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"src"</span><span class="hljs-punctuation">]</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>可以多层继承，但保持链路清晰，避免在各包内重复配置相同选项。</p>
<blockquote>
<p>P.S. 如果只有根目录有tsconfig.json，子包没有tsconfig.json，子包会受到根目录tsconfig.json的约束。</p>
</blockquote>
<h4 data-id="heading-21">eslint config</h4>
<p>关于js格式和规范上，传统都是<code>eslint + prettier</code>，但配置时比较繁琐，还要处理两者的冲突。参考<a href="https://juejin.cn/post/7149564942633402382?searchId=20240813144443B02734B5D5E5CB3ACD8F" title="https://juejin.cn/post/7149564942633402382?searchId=20240813144443B02734B5D5E5CB3ACD8F" target="_blank">antfu大佬的译文</a>，可以使用<code>@antfu/eslint-config</code>（vueuse项目就使用了这个）来做eslint检查。</p>
<p><code>@antfu/eslint-config</code>是由 Vue 核心团队成员、开源界大神 <strong>Anthony Fu</strong> 创建并维护的一套 <strong>ESLint 配置集合</strong>。它是目前社区中最流行的 ESLint 配置之一（GitHub Star 数非常高），其核心特点是“固执己见” (Opinionated) 且“开箱即用”。它采用了 ESLint 最新的 <strong>Flat Config (扁平化配置)</strong> 系统。</p>
<h5 data-id="heading-22">核心亮点：</h5>
<ol>
<li><strong>一站式解决方案</strong>：它不仅仅是一个 ESLint 配置，它集成了 Prettier 的功能（通过 ESLint Stylistic），你<strong>不需要</strong>再安装 Prettier。</li>
<li><strong>自动检测</strong>：它会自动检测你的项目中是否使用了 Vue、React、TypeScript、UnoCSS 等，并自动启用相关规则。</li>
<li><strong>代码风格</strong>：
<ul>
<li><strong>无分号</strong> (No Semicolons)</li>
<li><strong>单引号</strong> (Single Quotes)</li>
<li>尾随逗号 (Trailing Commas)</li>
</ul>
</li>
<li><strong>多文件支持</strong>：除了 JS/TS，还支持 JSON、YAML、Markdown、HTML 等文件的 lint 和格式化。</li>
<li><strong>导入排序</strong>：内置了 eslint-plugin-simple-import-sort，自动把 import 整理得干干净净。</li>
</ol>
<h5 data-id="heading-23">安装&amp;配置</h5>
<pre><code class="hljs language-bash" lang="bash">pnpm i -wD eslint @antfu/eslint-config
</code></pre>
<p>虽然这个包主打“零配置”，但实际开发中，我们通常需要根据团队习惯微调一些规则。</p>
<p>@antfu/eslint-config 的默认导出是一个<strong>工厂函数</strong>，它接受任意数量的参数。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// eslint.config.js</span>
<span class="hljs-keyword">import</span> antfu <span class="hljs-keyword">from</span> <span class="hljs-string">'@antfu/eslint-config'</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title function_">antfu</span>(
  {
    <span class="hljs-comment">// ============================================================</span>
    <span class="hljs-comment">// 1. 全局功能配置 (Options)</span>
    <span class="hljs-comment">// ============================================================</span>

    <span class="hljs-comment">// 显式启用/禁用特定框架支持（默认会自动检测，但显式写出更清晰）</span>
    <span class="hljs-attr">vue</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-attr">typescript</span>: <span class="hljs-literal">true</span>,

    <span class="hljs-comment">// 格式化风格配置 (替代 Prettier)</span>
    <span class="hljs-attr">stylistic</span>: {
      <span class="hljs-attr">indent</span>: <span class="hljs-number">2</span>, <span class="hljs-comment">// 缩进 2 空格</span>
      <span class="hljs-attr">quotes</span>: <span class="hljs-string">'single'</span>, <span class="hljs-comment">// 单引号</span>
      <span class="hljs-attr">jsx</span>: <span class="hljs-literal">true</span>, <span class="hljs-comment">// 支持 JSX</span>
    },

    <span class="hljs-comment">// 忽略文件 (相当于 .eslintignore)</span>
    <span class="hljs-attr">ignores</span>: [
      <span class="hljs-string">'patches'</span>,
      <span class="hljs-string">'playground'</span>,
      <span class="hljs-string">'playgrounds'</span>,
      <span class="hljs-string">'docs'</span>,
      <span class="hljs-string">'**/types'</span>,
      <span class="hljs-string">'**/cache'</span>,
      <span class="hljs-string">'**/*.svg'</span>,
      <span class="hljs-string">'.cursor'</span>,
      <span class="hljs-string">'.trae'</span>,
      <span class="hljs-string">'scripts'</span>,
    ],
  },

  <span class="hljs-comment">// ============================================================</span>
  <span class="hljs-comment">// 2. 具体规则覆盖 (Overrides)</span>
  <span class="hljs-comment">// ============================================================</span>

  <span class="hljs-comment">// 一般性规则覆盖</span>
  {
    <span class="hljs-attr">rules</span>: {
      <span class="hljs-comment">// 允许使用 console.log (默认是 warn 或 error)</span>
      <span class="hljs-string">'no-console'</span>: <span class="hljs-string">'off'</span>,
      <span class="hljs-comment">// 允许使用未使用的变量 (通常用于解构时忽略某些属性)</span>
      <span class="hljs-string">'unused-imports/no-unused-vars'</span>: <span class="hljs-string">'warn'</span>,
      <span class="hljs-comment">// 允许使用 @ts-ignore（覆盖 antfu 默认的禁用策略）</span>
      <span class="hljs-string">'ts/ban-ts-comment'</span>: [<span class="hljs-string">'error'</span>, { <span class="hljs-string">'ts-ignore'</span>: <span class="hljs-literal">false</span> }],
      <span class="hljs-comment">// 如果你真的想要分号 (虽然 antfu 默认是无分号的)</span>
      <span class="hljs-comment">// 'style/semi': ['error', 'always'],</span>
      <span class="hljs-string">'style/max-statements-per-line'</span>: <span class="hljs-string">'off'</span>,

      <span class="hljs-string">'ts/ban-types'</span>: <span class="hljs-string">'off'</span>,
      <span class="hljs-string">'node/no-callback-literal'</span>: <span class="hljs-string">'off'</span>,
      <span class="hljs-string">'import/namespace'</span>: <span class="hljs-string">'off'</span>,
      <span class="hljs-string">'import/default'</span>: <span class="hljs-string">'off'</span>,
      <span class="hljs-string">'import/no-named-as-default'</span>: <span class="hljs-string">'off'</span>,
      <span class="hljs-string">'import/no-named-as-default-member'</span>: <span class="hljs-string">'off'</span>,
      <span class="hljs-string">'node/prefer-global/process'</span>: <span class="hljs-string">'off'</span>,
      <span class="hljs-string">'ts/unified-signatures'</span>: <span class="hljs-string">'off'</span>,
      <span class="hljs-string">'ts/no-unsafe-function-type'</span>: <span class="hljs-string">'off'</span>,
      <span class="hljs-string">'ts/no-dynamic-delete'</span>: <span class="hljs-string">'off'</span>,
    },
  },

  <span class="hljs-comment">// 针对特定文件的规则覆盖</span>
  {
    <span class="hljs-attr">files</span>: [<span class="hljs-string">'**/*.vue'</span>],
    <span class="hljs-attr">rules</span>: {
      <span class="hljs-comment">// Vue 组件名必须由多个单词组成？关掉它</span>
      <span class="hljs-string">'vue/multi-word-component-names'</span>: <span class="hljs-string">'off'</span>,
    },
  },

  {
    <span class="hljs-attr">files</span>: [<span class="hljs-string">'**/*.json'</span>],
    <span class="hljs-attr">rules</span>: {
      <span class="hljs-comment">// 允许 JSON 文件末尾有逗号 (某些工具不支持，可能需要关掉)</span>
      <span class="hljs-string">'jsonc/comma-dangle'</span>: <span class="hljs-string">'off'</span>,
    },
  },
)
</code></pre>
<h5 data-id="heading-24">配置lint script</h5>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
	<span class="hljs-attr">"sciprts"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
		<span class="hljs-attr">"lint"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"eslint --cache ."</span><span class="hljs-punctuation">,</span>
		<span class="hljs-attr">"lint:fix"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"eslint --cache --fix ."</span><span class="hljs-punctuation">,</span>
	<span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<ul>
<li><code>--cache</code>启用缓存，缓存会把上次已通过的文件记住，下一次只对变更或受影响的文件重新检查，提升速度。检查的目标路径是当前目录<code>.</code>，具体包含哪些文件由 ESLint 配置决定。</li>
<li>加上<code>--fix</code> 自动修复可自动修复的 ESLint 违规（如缩进、引号、分号等）。不能自动修复的规则会保留为错误或警告，需要手动处理。</li>
</ul>
<h4 data-id="heading-25">pnpm-lock文件</h4>
<p>1.<code>pnpm-lock.yaml</code> 用于锁定整个 Workspace 的依赖树，保证“可重复安装”（同样的依赖版本与拓扑）。
2.如果没有这个lock文件，会发生什么呢？
比如我的依赖：</p>
<pre><code class="hljs language-makefile" lang="makefile"><span class="hljs-section">packageX: ^1.0.0</span>
</code></pre>
<p>当第三方包 <code>packageX</code>发布了新版：<code>1.1.0</code>，那么再次安装（pnpm/yarn install）时都会安装<code>1.1.0</code>新版本的库，有时候可能会带来问题（尤其生产环境不推荐这样）。</p>
<p>3.关键点：</p>
<ul>
<li>单仓 Monorepo 只有“根锁文件”，子包不生成独立锁；所有安装动作最终写回根锁。</li>
<li>锁文件应提交到仓库，CI/同事机器据此实现一致的安装结果。</li>
<li>发布到 npm 不会携带锁文件；库消费者不受你的锁文件影响。</li>
</ul>
<p>4.常用命令：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 严格模式（锁与 package.json 不一致时失败）</span>
pnpm install --frozen-lockfile

<span class="hljs-comment"># 仅更新锁文件（不下载依赖）</span>
pnpm install --lockfile-only
</code></pre>
<p>5.与 npm/yarn 的差异：</p>
<ul>
<li>pnpm 采用“内容寻址存储（Content-Addressable Store）”，远程包先存入全局 <code>.pnpm-store</code>，再以符号链接挂到 <code>node_modules</code>，磁盘占用更小。</li>
<li>Workspace 下通过 <code>workspace:</code> 协议把本地包也以符号链接方式关联，升级内部版本时，由根锁统一反映变更。</li>
</ul>
<p>6.多人协作建议：</p>
<ul>
<li>不手改锁文件；依赖升级统一用 <code>pnpm up &lt;pkg&gt;@&lt;range&gt;</code> 或在子包用 <code>--filter</code> 精准升级。</li>
<li>合并冲突时，优先保留最新一次“成功安装后”的锁版本。</li>
</ul>
<h3 data-id="heading-26">参考</h3>
<p><a href="https://juejin.cn/post/7149564942633402382" target="_blank" title="https://juejin.cn/post/7149564942633402382">【译】antfu博客：为什么我不用Prettier</a></p>
<h2 data-id="heading-27">三、认识monorepo和相关工具</h2>
<h3 data-id="heading-28">monorepo 介绍</h3>
<p>1.monorepo 是多个包在同一个项目中管理的方式，比较流行的一种管理方式。
软件项目管理经历了三个阶段：</p>





































<table><thead><tr><th>阶段</th><th>名称</th><th>管理方式</th><th>产生背景 / 特点</th><th>优势</th><th>劣势</th></tr></thead><tbody><tr><td>1​.</td><td>**Monolith (单体巨石应用)**​</td><td>单仓库管理所有项目代码</td><td>项目初期，业务复杂度低，所有代码集中在一个仓库中。</td><td>结构简单，初期管理方便。</td><td>1. 随着业务增长，代码量庞大，复杂度高。  2. 构建效率低下。</td></tr><tr><td>2.</td><td>**MultiRepo (多仓库多模块)**​</td><td>每个业务模块独立一个仓库</td><td>为解耦巨石应用，将项目拆分为多个模块，分别管理。</td><td>1. 模块解耦，复杂度降低。  2. 各模块可独立开发、测试、发布。  3. 构建效率提升。</td><td>1. <strong>跨仓库代码共享困难</strong>。  2. <strong>依赖管理复杂</strong>（底层模块升级，依赖方需手动更新）。  3. 仓库数量增多后，<strong>工程管理难度增加</strong>。  4. <strong>构建耗时增加</strong>（需按顺序构建多个仓库）。</td></tr><tr><td>3.​</td><td>**MonoRepo (单仓库多模块)**​</td><td>单一仓库中管理多个项目或模块</td><td>为解决MultiRepo在模块数量增多后产生的管理问题。</td><td>1. <strong>代码共享便捷</strong>。  2. <strong>共享依赖，减少包安装和包一致性</strong>。  3. <strong>共享工程配置</strong>，保证代码风格和质量一致。  4. <strong>便于构建工具优化</strong>（如增量构建、并行构建）。</td><td>1. 仓库体积较大。  2. 需要工具支持来管理权限和优化构建性能。</td></tr></tbody></table>
<p>2.<code>monorepo</code>项目目录结构：</p>
<pre><code class="hljs language-lua" lang="lua">|<span class="hljs-comment">-- node_modules</span>
|<span class="hljs-comment">-- packages</span>
|   |<span class="hljs-comment">-- packageA</span>
|   |   |<span class="hljs-comment">-- package.json</span>
|   |<span class="hljs-comment">-- packageB</span>
|   |   |<span class="hljs-comment">-- package.json</span>
|   |<span class="hljs-comment">-- packageC</span>
|   |   |<span class="hljs-comment">-- package.json</span>
|<span class="hljs-comment">-- eslint.config.js</span>
|<span class="hljs-comment">-- package.json</span>
</code></pre>
<p>1个package.json代表一个项目，最外面的package.json代表根项目，里面的package.json代表子包项目A、B和C等。
根项目存在的意义是：管理这些子包，比如<strong>共享根项目的依赖(npm包)</strong>、<strong>子包间依赖自动link</strong>和<strong>递归执行子包script命令</strong>等。</p>
<p>3.<code>monorepo</code>是一种管理规范，那么<code>pnpm workspace</code>协议就是用来支撑起这种规范的技术协议。具体做法：</p>
<p>根目录添加<code>pnpm-workspace.yaml</code> 配置文件：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">packages:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-string">'packages/*'</span>
</code></pre>
<p>这样一来，<code>/packages</code>下的所有项目都会被 pnpm 识别为 <strong>workspace 的成员包</strong></p>
<p>4.下面我们来看JS/TS项目领域，<code>monorepo</code>项目如何通过<code>pnpm</code>/<code>changeset</code>/<code>turbo</code>等工具解决下面三个问题：</p>
<ol>
<li><strong>共享代码/依赖，依赖管理</strong></li>
<li><strong>版本更新、自动tag和发布</strong></li>
<li><strong>并行/串行构建所有项目，处理构建顺序</strong></li>
</ol>
<p>5.后续我们用这个<code>monorepo</code>项目结构进行讲解。（<strong>记住这个结构，下面会多次用到</strong>）</p>
<pre><code class="hljs language-go" lang="go">|-- node_modules
|-- packages
|   |-- hooks
|   |   |-- <span class="hljs-keyword">package</span>.json （<span class="hljs-string">"name"</span>:<span class="hljs-string">"@caikengren/uni-hooks"</span>）
|   |-- shared
|   |   |-- <span class="hljs-keyword">package</span>.json （<span class="hljs-string">"name"</span>:<span class="hljs-string">"@caikengren/uni-hooks-shared"</span>）
|   |-- use-request
|   |   |-- <span class="hljs-keyword">package</span>.json  （<span class="hljs-string">"name"</span>:<span class="hljs-string">"@caikengren/uni-use-request"</span>）
|-- eslint.config.js
|-- <span class="hljs-keyword">package</span>.json
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/188081c9fc564ec0996f115e840e3ec2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55av54uC6Lip5Z2R5Lq6:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764510392&amp;x-signature=k%2BNIAMzlhdFcPHEPmaCHD3hbQn4%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-29">pnpm workspace 管理依赖</h3>
<blockquote>
<p>问题1：共享代码/依赖，依赖管理</p>
</blockquote>
<p>这个问题可以拆成两个子问题来看:</p>
<ol>
<li>多个子包依赖外部第三方npm包，比如依赖<code>vue</code>/<code>react</code>，那么这些这些包是不是可以共享(而不是每个子包项目都安装一遍)?</li>
<li>子包之间存在依赖，比如子包A依赖本地的子包B、C，但B、C都还没发布怎么依赖？能不能本地B、C链接到A的node_modules下呢？</li>
</ol>
<h4 data-id="heading-30">1.pnpm i 安装依赖</h4>
<p>针对上面的第一个问题，通过把依赖安装在根目录，那么子项目寻找依赖就会采用根目录的依赖，从而实现共享依赖
<strong>--workspace参数</strong>
根目录下安装<code>vue</code>：</p>
<pre><code class="hljs language-bash" lang="bash">pnpm i -w vue
</code></pre>
<p><code>-w</code>相当于<code>--workspace</code>，表示在根目录下安装依赖。</p>
<p>比如我要安装<code>typescript</code>：</p>
<pre><code class="hljs language-bash" lang="bash">pnpm i -wD typescript
</code></pre>
<p><code>-D</code>表示安装devDependencies，<code>-w</code>和<code>-D</code>可以合并为<code>-wD</code>。</p>
<p>安装完成后，只有根目录package.json会有依赖声明，如下：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-attr">"dependencies"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"vue"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"^3.4.0"</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"devDependencies"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"typescript"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"^5.4.0"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-punctuation">}</span>
</code></pre>
<p><strong>--filter参数</strong>
比如我有一个<code>@caikengren/uni-hooks</code>子包，依赖了另外两个子包</p>
<ul>
<li><code>@caikengren/uni-use-request</code></li>
<li><code>@caikengren/uni-hooks-shared</code>
那么可以通过下面的方式，表示在<code>@caikengren/uni-hooks</code>这个子包中安装另外两个依赖。</li>
</ul>
<pre><code class="hljs language-shell" lang="shell">pnpm i @caikengren/uni-use-request@workspace:^ --filter @caikengren/uni-hooks

pnpm i @caikengren/uni-hooks-shared@workspace:^ --filter @caikengren/uni-hooks
</code></pre>
<p><code>--filter xxx</code>表示在xxx子包下安装依赖，其中依赖的版本使用<code>@workspace:^</code>占位。</p>
<p>安装完成后 <code>packages/uni-hooks</code>目录的package.json会出现：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-attr">"dependencies"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"@caikengren/uni-hooks-shared"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"workspace:^"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"@caikengren/uni-use-request"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"workspace:^"</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p><strong>@workspace:^</strong>
<code>@workspace:^</code> 是一种特殊的协议前缀，用于在依赖声明中引用当前 workspace 中的本地包，并自动使用该包的版本号加上 <code>^</code> 语义化版本范围。</p>
<p>也就是说，pnpm 会：</p>
<ol>
<li>在当前 workspace 中查找名为 <code>my-local-pkg</code> 的本地包，不去远程下载了；</li>
<li>获取它在 <code>package.json</code> 中声明的版本号（比如 <code>1.2.3</code>）；</li>
<li>将依赖解析为 <code>^1.2.3</code>，即允许安装兼容的次要版本更新（遵循 semver 规范）；</li>
<li><strong>但前提是这个包必须存在于 workspace 中</strong>。如果不存在，构建会失败。</li>
</ol>
<h4 data-id="heading-31">2.pnpm自动link</h4>
<p>前面，我们利用<code>@workspace:^</code>在<code>uni-hooks</code>子包中安装了另外两个依赖：<code>@caikengren/uni-hooks-shared</code> 和<code>@caikengren/uni-use-request</code>，那么这两依赖实际是指向哪里呢？</p>
<p><strong>自动link原理</strong></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ddfedcc2c0ce482fb816925dc07e9f42~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55av54uC6Lip5Z2R5Lq6:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764510392&amp;x-signature=1iRRZNo%2BlQItXJfwDUuMGXLcZHk%3D" alt="image.png" loading="lazy"/></p>
<p>1.<code>pnpm i -w B@workspace:^ C@workspace:^ --filter A</code>
B,C被软链接到A的node_modules</p>
<p>2.<code>pnpm i -w Other@5.0.0</code>
Other实际上是安装到.pnpm store，.pnpm目录相当于.pnpm store的映射（内容同步的），.pnpm目录下的Other会被软链接到根目录的node_modules</p>
<blockquote>
<p>拓展补充：ln是shell命令（ln -s相当于windows的快捷方式）。
ln -s（软链接）的文件可读写（需要原文件允许软链接读写），本质不是同一文件，而是创建了一个链接符号。
ln （硬链接）的文件可以读写，和原文件本质上是同一个文件，仅在不同地方展示了。</p>
</blockquote>
<p><strong>区分:</strong></p>
<ul>
<li>pnpm 的特性：安装的远程依赖会被放到<code>.pnpm</code>目录，然后软链接到node_modules，从而依赖共享，节省磁盘空间。</li>
<li>pnpm workspace的特性： 自动link。通过<code>@workspace:^</code>安装的本地依赖，直接软链接到node_modules，即自动link。</li>
</ul>
<p><strong>我们的项目中:</strong><br/>
<code>uni-hooks</code>子包依赖本地<code>@caikengren/uni-hooks-shared</code> 和<code>@caikengren/uni-use-request</code> ，安装后你会发现node_modules下的依赖有箭头符号，说明是“符号链接”（软链接）</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d01f15a35d8c46469191934add9adc5f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55av54uC6Lip5Z2R5Lq6:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764510392&amp;x-signature=OneKQ16D5ezJNtV5lULJFQv97zs%3D" alt="image.png" loading="lazy"/></p>
<p><strong>疑问:</strong> <code>workspace:*</code>和<code>workspace:^</code>的区别?</p>
<p>1.<code>@caikengren/packageA@workspace:*</code>  打包后 (产物/发布到 npm):</p>
<p>pnpm 会将其替换为<strong>当前 workspace 中该包的精确版本</strong>。</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"dependencies"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"@caikengren/packageA"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"1.0.0"</span> 
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>2.<code>@caikengren/packageA@workspace:^</code>  打包后 (产物/发布到 npm):</p>
<p>pnpm 会将其替换为<strong>以当前版本为基准的 (^) 范围</strong>。</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"dependencies"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"@caikengren/packageA"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"^1.0.0"</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h3 data-id="heading-32">changeset 发布</h3>
<blockquote>
<p>问题2：版本更新、changelog、自动tag和发布</p>
</blockquote>
<p>changesets 主要关心 monorepo 项目下子项目版本的更新、changelog 文件生成、包的发布。一个 changeset 是个包含了在某个分支或者 commit 上改动信息的 md 文件，它会包含这样一些信息:</p>
<ul>
<li>需要发布的包</li>
<li>包版本的更新层级(遵循 semver 规范)</li>
<li>CHANGELOG 信息</li>
</ul>
<h4 data-id="heading-33">1.项目准备</h4>
<p>安装工具</p>
<pre><code class="hljs language-bash" lang="bash">pnpm i -wD @changesets/cli
</code></pre>
<p>安装完成后，会在<code>node_modules/.bin</code>目录（依赖包提供的命令会出现在这）看到<code>changeset</code>，意味着可以用<code>npx</code>来运行这个命令。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6e1f8a00a2b34dc6a18b779e2fd450d8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55av54uC6Lip5Z2R5Lq6:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764510392&amp;x-signature=7ZOH1ULqd6PAo5y5ySa1KnNsU%2B0%3D" alt="image.png" loading="lazy"/></p>
<p>初始化</p>
<pre><code class="hljs language-bash" lang="bash">npx changeset init
</code></pre>
<p>会多出一个<code>changeset</code>的文件，如下</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cdad1376174745658df2bfe77d246c90~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55av54uC6Lip5Z2R5Lq6:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764510392&amp;x-signature=bZmlfLMyw5CK3D2iRosvP80mxl4%3D" alt="image.png" loading="lazy"/></p>
<h4 data-id="heading-34">2.本地认证准备</h4>
<p>假设你已经注册了一个<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.npmjs.com%2F" target="_blank" title="https://www.npmjs.com/" ref="nofollow noopener noreferrer">npm</a>账号（或私有仓库账号），然后通过terminal登录，在终端输入</p>
<pre><code class="hljs language-bash" lang="bash">npm adduser
<span class="hljs-comment"># 或者（效果一样）</span>
npm login
</code></pre>
<h4 data-id="heading-35">3.发布流程</h4>
<p>假设你已经改过代码并且提交了，准备发布新版本。</p>
<p><strong>1.创建一个新的 changeset 文件</strong>。</p>
<pre><code class="hljs language-bash" lang="bash">npx changeset add
</code></pre>
<p><strong>说明</strong>：</p>
<ul>
<li>这个命令会交互式地让你选择要升级的包（在 monorepo 中）、版本类型（patch / minor / major）以及填写变更描述。</li>
<li>生成的文件会保存在 <code>.changeset/</code> 目录下，格式如 <code>clever-horses-fix.md</code>。</li>
<li>这些文件后续会被用来决定如何 bump 版本和生成 changelog。</li>
</ul>
<p>第一个问题：选择要改版的子包项目。「上下」键选择子包，「空格」键表示选择，「enter」确定最终选择。
<code>changeset add</code>是要依据commit提交信息</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8c56e9cd96b44eeb87a9a1e53c7a2838~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55av54uC6Lip5Z2R5Lq6:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764510392&amp;x-signature=3EByayeWA4J6yOJzwdxoUS0TWig%3D" alt="image.png" loading="lazy"/></p>
<p>进入第二个问题：选择要递增的版本级别（依次是major/minor/patch ）。按「enter」进入待办项目的下一个版本级别。（比如现在是major, 「enter」后进入minor）</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8fa3cb2e3dab4fb0a4615f22892cc795~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55av54uC6Lip5Z2R5Lq6:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764510392&amp;x-signature=bdC3sgWerGppBX3bOG%2BVvrtC4T0%3D" alt="image.png" loading="lazy"/></p>
<p>进入第三个问题：总结</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/12133338f3754446a57d4db3f37e8882~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55av54uC6Lip5Z2R5Lq6:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764510392&amp;x-signature=SnQC00aPdGujeb1%2FSjitHApDVjw%3D" alt="image.png" loading="lazy"/></p>
<p>进入第四个问题：是否确认</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3b43582dc3e849b6b082a3a3f4c55b6e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55av54uC6Lip5Z2R5Lq6:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764510392&amp;x-signature=rZuXQFfYUA5MTbdddqBBiA%2BorXc%3D" alt="image.png" loading="lazy"/></p>
<p>最后，会多出一个changeset文件（md文件），描述了版本变更、changelog内容</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d859f58f9006431d829f13e5af2195fe~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55av54uC6Lip5Z2R5Lq6:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764510392&amp;x-signature=Y2DAUx3IE29%2BzMbcipcZMhy%2BNms%3D" alt="image.png" loading="lazy"/></p>
<p><strong>2.根据 <code>.changeset/</code> 中的所有 changeset 文件，自动 bump 相关包的版本，并更新依赖关系。</strong></p>
<pre><code class="hljs">npx changeset version
</code></pre>
<p><strong>说明</strong>：</p>
<ul>
<li>它会读取所有未处理的 changeset，计算每个包的新版本号。</li>
<li>自动修改 <code>package.json</code> 中的版本字段。</li>
<li>如果是 monorepo，还会更新内部依赖的版本（比如 <code>pkg-a</code> 依赖 <code>pkg-b</code>，且 <code>pkg-b</code> 升级了，这里会自动更新引用）。</li>
<li>同时会删除已处理的 changeset 文件（或将其归档）。</li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/510cd918234041b498ed19265c9e0957~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55av54uC6Lip5Z2R5Lq6:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764510392&amp;x-signature=l5zca8RDmXIBpXFMRmVNXnMCthM%3D" alt="image.png" loading="lazy"/></p>
<p>可以看出子包下面都多了/修改了<code>CHANGELOG.md</code>文件，并且<code>package.json</code>的版本号发生了变化（<code>1.0.0</code>-&gt;<code>1.1.0</code>）</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8a9890452ec04f9a855d086cd2af553b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55av54uC6Lip5Z2R5Lq6:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764510392&amp;x-signature=y18WF8MVXyeLefdy57xG0T11LHo%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d9ceef8c5cfb43a991a27b5bdce5e100~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55av54uC6Lip5Z2R5Lq6:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764510392&amp;x-signature=wWLklyNyhWIuYP7YMvvbl1Ec36M%3D" alt="image.png" loading="lazy"/></p>
<p><strong>3.将新版本的包发布到npm仓库</strong></p>
<pre><code class="hljs language-bash" lang="bash">npx changeset publish
</code></pre>
<ul>
<li><strong>说明</strong>：
<ul>
<li>它会执行 <code>npm publish</code> 对每个需要发布的包。</li>
<li>默认只发布那些版本号发生变化的包。</li>
<li>需要你已经登录到 npm（<code>npm whoami</code>）。</li>
<li>此外，会给每个版本变动的包打tag.</li>
</ul>
</li>
</ul>
<p>先提交和push代码</p>
<pre><code class="hljs language-bash" lang="bash">git add .
git commit -m <span class="hljs-string">'chore(release): v1.1.0'</span>
git push
</code></pre>
<p>再发布（企业级发布，这一步通常属于CI，在云端流水线完成）</p>
<pre><code class="hljs language-bash" lang="bash">npx changeset publish
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/61dc2a2f41b44fccadfabc0d51463379~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55av54uC6Lip5Z2R5Lq6:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764510392&amp;x-signature=Lgi6qkuayZaGmdZ4e14oVS5hnMk%3D" alt="image.png" loading="lazy"/></p>
<p>然后在<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.npmjs.com%2Fpackage%2F%40caikengren%2Funi-hooks" target="_blank" title="https://www.npmjs.com/package/@caikengren/uni-hooks" ref="nofollow noopener noreferrer">npm仓库</a> 可以看到发布的三个包</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b4b2303780504952a5d6b7691a3c22b8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55av54uC6Lip5Z2R5Lq6:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764510392&amp;x-signature=baezVAvx%2FdVJVpjPXgKBl%2FkwjSM%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-36">turborepo 构建</h3>
<blockquote>
<p>问题3：并行/串行构建所有项目，处理构建顺序</p>
</blockquote>
<h4 data-id="heading-37">1.介绍</h4>
<p><strong>为什么需要 Turborepo</strong></p>
<ul>
<li>Monorepo 常见痛点：构建串行、慢；跨包依赖编排复杂；重复构建浪费时间。</li>
<li><code>yarn workspace</code> 通常串行构建，整体耗时长且不可控。</li>
<li><code>pnpm workspace</code> 能并行，但对复杂依赖拓扑的顺序编排有限，且缺少内建的强缓存机制。</li>
<li>Turborepo面向这些问题，提供有序并行、增量与缓存的组合解法。</li>
</ul>
<p><strong>它解决了什么问题</strong></p>
<ul>
<li>构建编排：用任务依赖图（DAG）明确“谁先谁后”，避免手工脚本胶水。</li>
<li>并行执行：独立包并行跑，依赖包按顺序跑，缩短全量构建时间。</li>
<li>增量构建：对输入做哈希，只重建被改动影响的任务，减少无效工作。</li>
<li>本地与远程缓存：同样输入直接复用产物；接入远程缓存后，CI 与开发者之间共享结果。</li>
</ul>
<h4 data-id="heading-38">2.并行和构建编排</h4>
<p>使用turbo初始化一个 Monorepo 的项目，有以下几个 package：</p>
<ul>
<li><code>apps/web</code>，依赖 shared</li>
<li><code>apps/docs</code>，依赖 shared</li>
<li><code>packages/shared</code>，被 web 和 docs 依赖</li>
</ul>
<p>目录如下：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/69cec10c303f43ccb0a4d763ce5c97d8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55av54uC6Lip5Z2R5Lq6:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764510392&amp;x-signature=LWHhSSRYj%2F%2BIi8wL3YiA86HR0oA%3D" alt="image.png" loading="lazy"/></p>
<p>yarn 命令 只能串行运行任务： <code>yarn workspaces run lint &amp;&amp; yarn workspaces run build &amp;&amp; yarn workspaces run test</code></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cc83456d6cab4bab8f271a5f28044e06~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55av54uC6Lip5Z2R5Lq6:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764510392&amp;x-signature=Nqnvf4KQ09v4PuIm8HOLs21cNkk%3D" alt="image.png" loading="lazy"/>
但是，要使用 Turborepo 可以<strong>更快地</strong>完成相同的工作，您可以使用 <code>turbo run lint build test</code>：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/73082cad3a814aaf9ef282e2f01541dd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55av54uC6Lip5Z2R5Lq6:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764510392&amp;x-signature=fhL435rwPqxaElvhl1jzwxzpI0A%3D" alt="image.png" loading="lazy"/>
你会发现有些任务是可以并行执行的——lint和test任务可以并行。还有些是执行顺序依赖的——web和docs 的构建依赖share构建完成。</p>
<p>配置如下：</p>
<pre><code class="hljs language-json:turbo.json" lang="json:turbo.json">{
  "$schema": "https://turbo.build/schema.json",
  "tasks": {
    "build": {
      "dependsOn": ["^build"],
      "outputs": ["dist/**"]
    },
    "test": {
      "dependsOn": ["^build"]
    },
    "lint": {},
  }
}
</code></pre>
<ul>
<li><code>tasks</code>：声明任务编排与产物输出，key是<code>turbo run Xxx</code>的<code>Xxx</code>。</li>
<li><code>dependsOn</code>：用 <code>^task</code> 表示“先跑上游依赖的同名任务”，自动根据依赖图排序。</li>
<li><code>outputs</code>：声明任务产物（如 <code>dist/**</code>），让 Turborepo准确缓存和复用构建结果。</li>
</ul>
<p>关于<code>^task</code>的理解是，不同包的任务编排：
当前 package 执行 <code>build</code> 任务之前，需要 <strong>先运行它依赖的包（dependencies / devDependencies / peerDependencies）</strong> 的 <code>build</code> 任务。
当你配置了<code>"dependsOn": ["^build"]</code>，那么「web和docs 的构建依赖share构建完成后，再执行」，否则不会。</p>
<p>关于<code>dependsOn</code>另外一种情况，没有<code>^</code>，表示同一个包中的任务编排。比如下面就表达了所有的<code>test</code>任务执行前，要先完成<code>build</code>命令。</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span> 
	<span class="hljs-attr">"tasks"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span> 
		<span class="hljs-attr">"test"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span> <span class="hljs-attr">"dependsOn"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"build"</span><span class="hljs-punctuation">]</span> <span class="hljs-punctuation">}</span> 
	<span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>进一步，你还可以限定到某个包的 任务编排。比如下面表达了</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-attr">"outputs"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"dist/**"</span><span class="hljs-punctuation">]</span>
    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"test"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"dependsOn"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"^build"</span><span class="hljs-punctuation">]</span>
    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"lint"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span><span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h4 data-id="heading-39">3.缓存和增量构建</h4>
<p>第一次<code>trubo run build</code>后，会生成缓存存放在 <code>node_modules/.cache/turbo/</code>目录下</p>
<p>第一次构建：还没产物（没有dist目录），记录子包项目文件的hash值。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7680c4c88ef741c6bb708c31ab66b380~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55av54uC6Lip5Z2R5Lq6:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764510392&amp;x-signature=RSK487cBWjHOBLQvd4VJHGHrqhc%3D" alt="image.png" loading="lazy"/></p>
<p>第二次构建：子包文件的hash标识和之前的比较，如果没变化，则跳过构建。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6fb3e76b4fe94dbb96ca4299cd59c99f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55av54uC6Lip5Z2R5Lq6:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764510392&amp;x-signature=efegy%2FQ4gTREFCReA2qb61I8IkE%3D" alt="image.png" loading="lazy"/></p>
<p>配置如下：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-comment">//turbo.json</span>
<span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"$schema"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"https://turbo.build/schema.json"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"tasks"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"build"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"dependsOn"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"^build"</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"outputs"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"dist/**"</span><span class="hljs-punctuation">]</span>
    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"test"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"dependsOn"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"^build"</span><span class="hljs-punctuation">]</span>
    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"lint"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span><span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<blockquote>
<p>P.S. <code>tasks</code>是新字段名，对应旧<code>pipeline</code>，含义一样。</p>
</blockquote>
<p>此外，还有<code>cache</code>配置和<code>--filter</code>命令参数：</p>
<p><code>cache</code>：默认开启；可对 <code>dev</code> 等任务关闭缓存，保证开发时的即时性。</p>
<pre><code class="hljs language-json:turbo.json" lang="json:turbo.json">{
  "$schema": "https://turbo.build/schema.json",
  "tasks": {
    "dev": {
      "cache": false
    },
  }
}
</code></pre>
<p><code>--filter</code>：按包名或路径过滤执行范围。</p>
<pre><code class="hljs language-bash" lang="bash">turbo run &lt;<span class="hljs-built_in">command</span>&gt; --filter=&lt;package name&gt;
</code></pre>
<h3 data-id="heading-40">构建（打包）工具</h3>
<h4 data-id="heading-41">tsdown的主要功能</h4>
<p>相关功能请查阅<a href="https://link.juejin.cn?target=https%3A%2F%2Ftsdown.dev%2Fzh-CN" target="_blank" title="https://tsdown.dev/zh-CN" ref="nofollow noopener noreferrer">tsdown中文文档</a>，目前可以看到<code>vueuse</code>项目已经采用了<code>tsdown</code>来打包库项目。</p>
<p>下面简单介绍下tsdown功能：</p>
<p><strong>1.零配置TypeScript支持</strong>
tsdown内置了对TypeScript的完整支持，无需额外的配置：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"scripts"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"build"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"tsdown"</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p><strong>2.多格式输出</strong>
支持同时生成多种模块格式：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"tsdown"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"format"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"esm"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"cjs"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"umd"</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"entry"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"src/index.ts"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"outDir"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"dist"</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>并且自动为每个输出格式生成对应的<code>.d.ts</code>声明文件：</p>
<pre><code class="hljs language-bash" lang="bash">dist/
├── index.esm.js
├── index.esm.d.ts
├── index.cjs.js
├── index.cjs.d.ts
├── index.umd.js
└── index.umd.d.ts
</code></pre>
<p><strong>3.Tree-shaking</strong>
极速Tree-shaking，自动移除未使用的代码：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// src/utils.ts</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">used</span>(<span class="hljs-params"/>) { <span class="hljs-keyword">return</span> <span class="hljs-string">'used'</span>; }
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">unused</span>(<span class="hljs-params"/>) { <span class="hljs-keyword">return</span> <span class="hljs-string">'unused'</span>; }

<span class="hljs-comment">// src/index.ts</span>
<span class="hljs-keyword">export</span> { used } <span class="hljs-keyword">from</span> <span class="hljs-string">'./utils'</span>;
<span class="hljs-comment">// unused函数会被自动移除</span>
</code></pre>
<p><strong>4.外部依赖处理</strong>
配置外部依赖，避免将依赖打包进输出文件：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"tsdown"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"external"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"react"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"vue"</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"globals"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"react"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"React"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"vue"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Vue"</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h4 data-id="heading-42">Rollup vs Vite vs tsdown</h4>
<h5 data-id="heading-43">Rollup - 经典选择</h5>
<p>Rollup是最早专注于ESM打包的工具之一，以其优秀的Tree-shaking能力而闻名。</p>
<p><strong>优势：</strong></p>
<ul>
<li>出色的Tree-shaking优化</li>
<li>生成简洁的ESM输出</li>
<li>丰富的插件生态系统</li>
<li>适合库开发</li>
</ul>
<p><strong>劣势：</strong></p>
<ul>
<li>配置相对复杂</li>
<li>开发模式下的HMR支持有限</li>
<li>构建速度相对较慢</li>
</ul>
<h5 data-id="heading-44">Vite - 现代开发体验</h5>
<p>Vite基于原生ESM，提供了极快的开发服务器和优化的构建流程。</p>
<p><strong>优势：</strong></p>
<ul>
<li>闪电般的冷启动速度</li>
<li>即时的热模块替换（HMR）</li>
<li>开箱即用的TypeScript支持</li>
<li>现代化的开发体验</li>
</ul>
<p><strong>劣势：</strong></p>
<ul>
<li>主要用于应用开发</li>
<li>对于纯库打包可能过于复杂</li>
<li>依赖Node.js环境</li>
</ul>
<h5 data-id="heading-45">tsdown - 专为ts库项目</h5>
<p>tsdown是一个新兴的基于rolldown（基于<strong>rust</strong>）的打包工具，专门为TypeScript项目设计，结合了现代打包工具的优点。</p>
<h5 data-id="heading-46">性能对比</h5>
<p>在实际项目中，三种工具的构建性能对比如下：</p>

































<table><thead><tr><th>工具</th><th>冷启动时间</th><th>HMR速度</th><th>输出大小</th><th>配置复杂度</th></tr></thead><tbody><tr><td>Rollup</td><td>中等</td><td>慢</td><td>小</td><td>高</td></tr><tr><td>Vite</td><td>快</td><td>极快</td><td>中等</td><td>低</td></tr><tr><td>tsdown</td><td>极快</td><td>快</td><td>小</td><td>极低</td></tr></tbody></table>
<h5 data-id="heading-47">选择建议</h5>
<ul>
<li><strong>库开发</strong>：推荐使用tsdown，零配置、多格式输出、类型声明自动生成</li>
<li><strong>应用开发</strong>：推荐使用Vite，优秀的开发体验和构建性能</li>
<li><strong>传统项目</strong>：如果已有Rollup配置且运行良好，可以继续使用</li>
</ul>
<h3 data-id="heading-48">参考</h3>
<p><a href="https://juejin.cn/post/7215886869199896637" target="_blank" title="https://juejin.cn/post/7215886869199896637">带你了解更全面的 Monorepo - 优劣、踩坑、选型</a><br/>
<a href="https://juejin.cn/post/7343156956665839651" target="_blank" title="https://juejin.cn/post/7343156956665839651">从零到一使用 turborepo + pnpm 搭建企业级 Monorepo 项目</a><br/>
<a href="https://juejin.cn/post/7024827345059971080" target="_blank" title="https://juejin.cn/post/7024827345059971080">Changesets: 流行的 monorepo 场景发包工具</a></p>
<h2 data-id="heading-49">五、CI/CD</h2>
<p>解释：</p>
<ul>
<li><strong>CI (Continuous Integration 持续整合)</strong></li>
<li><strong>CD (Continuous Delivery/Deployment 持续交付/部署)</strong></li>
</ul>
<h4 data-id="heading-50">CI</h4>
<p>CI的目标：</p>
<ul>
<li><strong>自动运行测试</strong>：自动执行单元测试、集成测试等。例如：<code>npm test</code></li>
<li><strong>代码质量检查</strong>：包括 ESLint、Prettier、TypeScript 类型检查等。例如：<code>npm run lint</code>、<code>npm run type-check</code></li>
<li><strong>构建验证</strong>：确保包可以正确构建（如编译 TypeScript 、打包等）。例如`npm run build</li>
</ul>
<p>其中<code>自动化测试</code>、<code>代码检查</code>和<code>构建验证</code>一般在什么时候触发？</p>
<ul>
<li>push到主分支 (main, master)之前。必须的</li>
<li>push到特征分支之前。可选</li>
<li>提PR之前。可选</li>
</ul>
<p>常用的CI平台 :</p>





















<table><thead><tr><th>平台</th><th>特点</th></tr></thead><tbody><tr><td><strong>GitHub Actions</strong></td><td>免费、与 GitHub 深度集成，YAML 配置，社区生态丰富</td></tr><tr><td><strong>GitLab CI</strong></td><td>内置于 GitLab，适合私有部署</td></tr><tr><td><strong>Travis CI</strong></td><td>曾经流行，现逐渐被 GitHub Actions 取代</td></tr></tbody></table>
<h4 data-id="heading-51">CD</h4>
<p><strong>1.产物管理 (Artifact Management)</strong>
下载构建产物： 从 CI 流程（如 Jenkins workspace、GitHub Actions artifacts）中拉取打包好的 dist 或 build 目录。给当前的发布包打上 Tag 或版本号。（如果是docker，则会构建镜像和推送到镜像仓库）</p>
<p><strong>2.环境配置与注入 (Configuration Injection)</strong></p>
<ul>
<li>构建时注入：如果是静态站点，通常在 CI 阶段就通过 DefinePlugin 或 import.meta.env 写入了。</li>
<li>运行时注入（CD 阶段） 如果是 Docker 容器化部署，通常在 CD 阶段通过 K8s ConfigMap 或环境变量将配置注入到容器中。</li>
</ul>
<p><strong>3.部署执行 (Deployment Execution)</strong></p>
<p>a. 静态资源部署 (SPA - Vue/React)</p>
<ul>
<li>上传对象存储： 将 HTML/CSS/JS 上传到云厂商的对象存储（AWS S3, Aliyun OSS, Tencent COS）。</li>
<li>更新CDN：为了防止用户在发布过程中访问到 404 文件，通常会先上传带 Hash 的静态资源（JS/CSS），最后上传入口文件（index.html）。</li>
</ul>
<p>b.服务端应用部署 (SSR - Next.js/Nuxt/Node BFF)</p>
<ul>
<li>容器更新： 更新 Kubernetes (K8s) 的 Deployment 镜像版本，执行滚动更新（Rolling Update）。</li>
<li>服务重启： 传统服务器上使用 PM2 reload。</li>
</ul>
<p>c.npm包这类工程产物</p>
<ul>
<li>上传到npm仓库。使用<code>npx changeset publish</code>或者<code>npm publish</code>完成上传。</li>
</ul>
<h3 data-id="heading-52">Git规范配置 - husky</h3>
<h4 data-id="heading-53">git规范方案</h4>
<p>该方案需要安装以下依赖</p>
<ul>
<li>husky</li>
<li>lint-staged</li>
<li>commitizen</li>
<li>cz-git</li>
<li>@commitlint/cli</li>
<li>@commitlint/config-conventional</li>
</ul>

<pre><code class="hljs language-bash" lang="bash">pnpm i -wD husky lint-staged commitizen cz-git @commitlint/cli @commitlint/config-conventional
</code></pre>
<p><strong>1.husky拦截Git hooks</strong></p>
<p><code>Git Hooks</code>：Git 原生就自带一套“钩子”机制。在 .git/hooks/ 目录下，有一堆脚本（如 pre-commit.sample）。</p>
<ul>
<li><strong>机制</strong>：当你执行特定的 Git 命令（如 commit、push、merge）时，Git 会自动去检查这个目录下有没有对应的脚本文件。如果有，就执行它。</li>
<li><strong>痛点</strong>：.git 目录是不会被提交到代码仓库的（它被 .gitignore 忽略）。这意味着，你在本地配置的钩子脚本，你的同事拉取代码后是看不到的，无法同步团队规范。</li>
</ul>
<p>Husky 的核心作用就是“篡改”Git 查找钩子的路径，并将其指向项目代码中的位置（通常是根目录下的 .husky/ 文件夹），这个文件夹是可以提交到 Git 仓库共享给所有人的。</p>
<p><strong>2.lint-staged 检查代码</strong></p>
<p>每次提交代码前，我们希望"提交的代码"能通过eslint检查。这里有两个关键词：<code>eslint检查</code>和<code>提交的代码</code>。<code>lint-staged</code>就是用来做提交的代码eslint检查（而不是全部代码检查）。</p>
<p><strong>3.commitlint校验commit信息</strong></p>
<p>所有的git项目，都应该去遵循一个git规范，这个规范之一就是<code>git commit</code>的message。你肯定见过很多这样的message：<code>chore(ci): xxx</code>， <code>feat(components): xxx</code>。下面就介绍下常用的一种规范结构。</p>
<p>Commit Message 结构：</p>
<ul>
<li><strong>Header（头部）</strong>: 必须包含，是Commit Message的核心部分。
<ul>
<li><strong>类型 (type)</strong>: 标记Commit的类别，例如 <code>feat</code> (新功能), <code>fix</code> (修复bug), <code>docs</code> (文档), <code>style</code> (代码风格) 等。</li>
<li><strong>范围 (scope)</strong>: 可选，用于说明Commit影响的范围，如文件、组件或模块。</li>
<li><strong>主题 (subject)</strong>: 简短地描述本次提交的内容，通常不超过50个字符，首字母小写。</li>
<li><strong>格式</strong>: <code>type(scope): subject</code>。</li>
</ul>
</li>
<li><strong>Body（描述）</strong>: 可选，对Commit进行详细描述，可以分成多行。
<ul>
<li>解释提交的动机、解决的问题等。</li>
<li>每行建议不超过72个字符，以避免自动换行影响可读性。</li>
</ul>
</li>
<li><strong>Footer（尾部）</strong>: 可选，用于关联Issue编号或标记重大性变更 (Breaking Changes)。
<ul>
<li><strong>关联Issue</strong>: 使用如 <code>Closes #123</code> 或 <code>Fixes #123</code>。</li>
</ul>
</li>
</ul>
<p><code>@commitlint/cli</code> 用来校验 Git 提交信息是否符合约定的格式。配合 <code>@commitlint/config-conventional</code> 使用，可强制统一提交类型（如 <code>feat</code>、<code>fix</code>、<code>docs</code>、<code>refactor</code>、<code>chore</code> 等）与消息结构，提升版本管理与自动化发布的可靠性。</p>
<p><strong>4.commitizen和cz-git 交互式提交</strong></p>
<p><code>commitizen</code>提供了cli（命令交互式）的方式来完成Commit Message填写。
<code>cz-git</code> 是 Commitizen 的一个适配器（adapter），通常配合 <code>commitizen</code> 使用。基于<code>cz-git</code>可以更灵活的控制你的提交Message规范。</p>
<h4 data-id="heading-54">配置工具</h4>
<p><strong>1.初始化husky目录</strong></p>
<pre><code class="hljs language-csharp" lang="csharp">npx husky <span class="hljs-keyword">init</span>
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/362f8a229b894592b5b5855a8b8f42d8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55av54uC6Lip5Z2R5Lq6:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764510392&amp;x-signature=hvPJOP8z7f9Hh04iqfjvY5blqQw%3D" alt="image.png" loading="lazy"/></p>
<p><code>pre-commit</code>是 Git 众多钩子中的一个，顾名思义，它在 <strong>Commit 之前</strong> 执行。也就是说这个文件里的脚本，会在<code>git commit</code>真正执行前执行，避免不规范的提交。</p>
<p><strong>2.commitizen 配置</strong></p>
<ul>
<li>Scripts: 添加 commit 命令来启动交互式提交。</li>
<li>Config: 指定 commitizen 使用 cz-git 适配器。
修改<code>package.json</code>:</li>
</ul>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"scripts"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"prepare"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"husky"</span><span class="hljs-punctuation">,</span> <span class="hljs-comment">//？</span>
    <span class="hljs-attr">"commit"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"git-cz"</span> <span class="hljs-comment">//使用git-cz 来做提交（多个git命令的组合）</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"config"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span> <span class="hljs-comment">//commitizen工具的配置</span>
    <span class="hljs-attr">"commitizen"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"path"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"node_modules/cz-git"</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<blockquote>
<p>请根据你项目中实际安装的 eslint/prettier 情况调整 lint-staged 里的命令)</p>
</blockquote>
<p><strong>2.lint-staged配置</strong></p>
<ul>
<li>Lint-staged: 配置暂存区文件的校验规则。
修改<code>package.json</code>:</li>
</ul>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"scripts"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"prepare"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"husky"</span><span class="hljs-punctuation">,</span> 
    <span class="hljs-attr">"commit"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"git-cz"</span> 
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"lint-staged"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span> <span class="hljs-comment">// lint-staged工具的配置</span>
    <span class="hljs-attr">"*.{js,ts,vue,jsx,tsx}"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
      <span class="hljs-string">"eslint --fix"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-string">"prettier --write"</span>
    <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"*.{json,md,css,scss}"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
      <span class="hljs-string">"prettier --write"</span>
    <span class="hljs-punctuation">]</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>添加husky钩子，pre-commit: 提交前执行 lint-staged（代码格式化/检查）。</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">echo</span> <span class="hljs-string">"npx lint-staged"</span> &gt; .husky/pre-commit
</code></pre>
<p><strong>3. Commitlint &amp; Cz-git配置</strong></p>
<p>cz-git 的强大之处在于它可以直接读取 commitlint 的配置，从而实现“一份配置，两处生效”。</p>
<p>在根目录新建文件 commitlint.config.js (如果是 type: module 项目则为 .mjs 或 .cjs)：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// commitlint.config.js</span>
<span class="hljs-comment">/** <span class="hljs-doctag">@type</span> {<span class="hljs-type">import('cz-git').UserConfig</span>} */</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-comment">// 继承的规则</span>
  <span class="hljs-attr">extends</span>: [<span class="hljs-string">'@commitlint/config-conventional'</span>],
  <span class="hljs-comment">// 自定义规则</span>
  <span class="hljs-attr">rules</span>: {
    <span class="hljs-comment">// type 类型定义，表示 git 提交的 type 必须在以下类型范围内</span>
    <span class="hljs-string">'type-enum'</span>: [
      <span class="hljs-number">2</span>,
      <span class="hljs-string">'always'</span>,
      [
        <span class="hljs-string">'feat'</span>, <span class="hljs-comment">// 新功能 feature</span>
        <span class="hljs-string">'fix'</span>, <span class="hljs-comment">// 修复 bug</span>
        <span class="hljs-string">'docs'</span>, <span class="hljs-comment">// 文档注释</span>
        <span class="hljs-string">'style'</span>, <span class="hljs-comment">// 代码格式(不影响代码运行的变动)</span>
        <span class="hljs-string">'refactor'</span>, <span class="hljs-comment">// 重构(既不增加新功能，也不是修复bug)</span>
        <span class="hljs-string">'perf'</span>, <span class="hljs-comment">// 性能优化</span>
        <span class="hljs-string">'test'</span>, <span class="hljs-comment">// 增加测试</span>
        <span class="hljs-string">'chore'</span>, <span class="hljs-comment">// 构建过程或辅助工具的变动</span>
        <span class="hljs-string">'revert'</span>, <span class="hljs-comment">// 回退</span>
        <span class="hljs-string">'build'</span> <span class="hljs-comment">// 打包</span>
      ]
    ],
    <span class="hljs-comment">// subject 大小写不做校验</span>
    <span class="hljs-string">'subject-case'</span>: [<span class="hljs-number">0</span>]
  },
  <span class="hljs-comment">// cz-git 的交互配置（可选，用于定制交互界面）</span>
  <span class="hljs-attr">prompt</span>: {
    <span class="hljs-attr">useEmoji</span>: <span class="hljs-literal">true</span>, <span class="hljs-comment">// 是否使用 emoji</span>
    <span class="hljs-comment">// 可以在这里自定义提示语，例如中文化</span>
    <span class="hljs-attr">messages</span>: {
      <span class="hljs-attr">type</span>: <span class="hljs-string">'选择你要提交的类型 :'</span>,
      <span class="hljs-attr">scope</span>: <span class="hljs-string">'选择一个提交范围（可选）:'</span>,
      <span class="hljs-attr">customScope</span>: <span class="hljs-string">'请输入自定义的提交范围 :'</span>,
      <span class="hljs-attr">subject</span>: <span class="hljs-string">'填写简短精炼的变更描述 :\n'</span>,
      <span class="hljs-attr">body</span>: <span class="hljs-string">'填写更加详细的变更描述（可选）。使用 "|" 换行 :\n'</span>,
      <span class="hljs-attr">breaking</span>: <span class="hljs-string">'列举非兼容性重大的变更（可选）。使用 "|" 换行 :\n'</span>,
      <span class="hljs-attr">footerPrefixsSelect</span>: <span class="hljs-string">'选择关联issue前缀（可选）:'</span>,
      <span class="hljs-attr">customFooterPrefix</span>: <span class="hljs-string">'输入自定义issue前缀 :'</span>,
      <span class="hljs-attr">footer</span>: <span class="hljs-string">'列举关联issue (可选) 例如: #31, #I3244 :\n'</span>,
      <span class="hljs-attr">confirmCommit</span>: <span class="hljs-string">'是否提交或修改commit ?'</span>
    },
    <span class="hljs-comment">// 设置 scope 范围（根据项目模块调整）</span>
    <span class="hljs-attr">scopes</span>: [<span class="hljs-string">'components'</span>, <span class="hljs-string">'hooks'</span>, <span class="hljs-string">'utils'</span>, <span class="hljs-string">'styles'</span>, <span class="hljs-string">'deps'</span>]
  }
}
</code></pre>
<p>添加 Husky钩子，提交时校验 commit message 格式。</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">echo</span> <span class="hljs-string">"npx --no-install commitlint --edit \$1"</span> &gt; .husky/commit-msg
</code></pre>
<h4 data-id="heading-55">结果演示</h4>
<p>现在有6个修改</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6d266c6c298a4044858ed6facd7ac01f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55av54uC6Lip5Z2R5Lq6:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764510392&amp;x-signature=KYI5Aj1KKpF5iigJbNDIiuZ6Sa0%3D" alt="image.png" loading="lazy"/></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment">#添加到暂存区</span>
git add .
<span class="hljs-comment"># 执行commit script（替代git commit）</span>
pnpm commit
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5b120e505595427a89519bf26ed2fb5d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55av54uC6Lip5Z2R5Lq6:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764510392&amp;x-signature=c6%2F30T2Tw1txwtgputowpGujZgU%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-56">六、实战monorepo形式的npm项目</h2>
<p>关于这一块，可以参考我的一个项目 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Ffkcaikengren%2Funi-hooks" target="_blank" title="https://github.com/fkcaikengren/uni-hooks" ref="nofollow noopener noreferrer">@caikengren/uni-hooks</a>，后续我会根据这个项目展开写几篇博客和大家一起交流学习。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[前端开发实战笔记：为什么从 Axios 到 TanStack Query，是工程化演进的必然？]]></title>    <link>https://juejin.cn/post/7575468252656123945</link>    <guid>https://juejin.cn/post/7575468252656123945</guid>    <pubDate>2025-11-23T13:42:39.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7575468252656123945" data-draft-id="7575655132755656723" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="前端开发实战笔记：为什么从 Axios 到 TanStack Query，是工程化演进的必然？"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-11-23T13:42:39.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="兔子零1024"/> <meta itemprop="url" content="https://juejin.cn/user/3743194047592062"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            前端开发实战笔记：为什么从 Axios 到 TanStack Query，是工程化演进的必然？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3743194047592062/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    兔子零1024
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-23T13:42:39.000Z" title="Sun Nov 23 2025 13:42:39 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    4
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读17分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{line-height:1.75;font-family:-apple-system-font,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei UI,Microsoft YaHei,Arial,sans-serif;letter-spacing:2px;background-image:linear-gradient(90deg,rgba(50,0,0,.05) 3%,transparent 0),linear-gradient(1turn,rgba(50,0,0,.05) 3%,transparent 0);background-size:20px 20px;background-position:50%;word-break:break-word;font-weight:400;font-size:15px;overflow-x:hidden;color:#333}.markdown-body h1{font-size:23px;margin-bottom:5px;font-weight:700;padding-left:10px;border-left:5px solid #773098}.markdown-body h2{font-size:19px;font-weight:700;padding-left:10px;border-left:5px solid #916dd5}.markdown-body h3{font-size:17px;font-weight:700;padding-left:10px;border-left:5px solid #d89cf6}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:15px}.markdown-body h6{font-size:14px;margin-top:5px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{display:block;max-width:100%;margin:1em 0;border-radius:6px;box-shadow:2px 4px 7px #999;user-select:none}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{padding:.2em .5em;font-weight:700;font-family:-apple-system-font,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei UI,Microsoft YaHei,Arial,sans-serif;font-size:1em;color:#916dd5;word-break:break-word;overflow-x:auto;background-color:none;border-radius:2px}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{display:block;font-family:-apple-system-font,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei UI,Microsoft YaHei,Arial,sans-serif;font-weight:400;font-size:.9em;padding:16px 12px;margin:0;color:#333;word-break:normal;overflow-x:auto;background:#f8f8f8;scroll-behavior:smooth}.markdown-body a{text-decoration:none;color:#916dd5;font-weight:700;border-bottom:1px solid #916dd5}.markdown-body a:active,.markdown-body a:hover{color:#773098}.markdown-body table{display:inline-block!important;font-size:14px;width:auto;max-width:100%;overflow:auto;border:1px solid #916dd5;border-collapse:collapse}.markdown-body thead{background-color:#916dd5;color:#fff;text-align:left}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px;border:1px solid #916dd5}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #d89cf6;background-color:#f4eeff}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0;line-height:26px}.markdown-body ol,.markdown-body ul{padding-left:28px;list-style-type:circle}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body b,.markdown-body strong{color:#916dd5;font-weight:700}.markdown-body b:before,.markdown-body strong:before{content:"「"}.markdown-body b:after,.markdown-body strong:after{content:"」"}.markdown-body em,.markdown-body i{color:#916dd5}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="github-gist">.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#fff;color:#333}.hljs-comment,.hljs-meta{color:#969896}.hljs-emphasis,.hljs-quote,.hljs-strong,.hljs-template-variable,.hljs-variable{color:#df5000}.hljs-keyword,.hljs-selector-tag,.hljs-type{color:#d73a49}.hljs-attribute,.hljs-bullet,.hljs-literal,.hljs-symbol{color:#0086b3}.hljs-name,.hljs-section{color:#63a35c}.hljs-tag{color:#333}.hljs-attr,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-id,.hljs-selector-pseudo,.hljs-title{color:#6f42c1}.hljs-addition{color:#55a532;background-color:#eaffea}.hljs-deletion{color:#bd2c00;background-color:#ffecec}.hljs-link{text-decoration:underline}.hljs-number{color:#005cc5}.hljs-string{color:#032f62}</style><p>关键词：Axios / TanStack Query / React Query / 前端工程化 / 数据缓存 / 接口抽象 / 并发控制 / 失效策略 / 中后台系统 / 长期维护</p>
<hr/>
<h2 data-id="heading-0">引言：从「手写请求」到「数据编排」的转折</h2>
<p>有一家做 B 端中后台的团队，技术栈很典型：React + TypeScript + Axios + 自己封一层 <code>request.ts</code>。<br/>
前两年业务快速增长，迭代飞快，大家都觉得这套组合<strong>简单、高效、够用</strong>。</p>
<p>直到系统规模上来，问题开始密集出现：</p>
<ul>
<li><strong>同一个接口被不同页面各自请求、各自缓存、各自处理 loading 和错误</strong></li>
<li><strong>列表、详情、弹窗之间的数据不同步，刷新页面才能「自愈」</strong></li>
<li><strong>分页、筛选、轮询、预加载逻辑散落在几十个组件里，没人敢动</strong></li>
<li><strong>埋点、重试、降级、超时策略，一半靠约定，一半靠运气</strong></li>
</ul>
<p>最后他们不得不做一个决策：<strong>把「请求」当成「数据源」，而不是工具函数</strong>，从手写 Axios 封装，走向 TanStack Query 这一类「数据获取框架」。</p>
<p>现实里，类似的迁移并不少见：</p>
<ul>
<li>很多早期用 Axios + Redux-Saga / MobX 的项目，后面把「服务端数据」统一迁到 React Query / TanStack Query</li>
<li>一些重前后端分离的 SaaS，把请求层收口到 Query 层，BFF、前端、移动端共享一套「数据契约」</li>
<li>一些大厂内部中台体系里，Axios 只负责传输，真正的「接口使用规范」全部写进 Query 层</li>
<li>甚至 Vue 生态也有 Vue Query、@tanstack/vue-query，走的是同一条路：<strong>从请求工具到数据编排层</strong></li>
</ul>
<p>问题从来不是「Axios 不行」，而是当系统变大之后，<strong>它本来不想管的那些东西，被无限放大</strong>。</p>
<blockquote>
<p><strong>这不是工具之争，而是：你把「服务端状态」当成什么来看。是一次调用，还是一个长期存在、需要被管理的资源。</strong></p>
</blockquote>
<hr/>
<h2 data-id="heading-1">一、黄金时代：只有 Axios 的那些年</h2>
<h3 data-id="heading-2">1.1 手写封装带来的掌控感</h3>
<p>大部分团队的起点都长这样：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// apiClient.ts</span>
<span class="hljs-keyword">import</span> axios <span class="hljs-keyword">from</span> <span class="hljs-string">'axios'</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> apiClient = axios.<span class="hljs-title function_">create</span>({
  <span class="hljs-attr">baseURL</span>: <span class="hljs-string">'/api'</span>,
  <span class="hljs-attr">timeout</span>: <span class="hljs-number">10000</span>,
});

apiClient.<span class="hljs-property">interceptors</span>.<span class="hljs-property">request</span>.<span class="hljs-title function_">use</span>(<span class="hljs-function">(<span class="hljs-params">config</span>) =&gt;</span> {
  <span class="hljs-comment">// 加 token、traceId、统一 header 等</span>
  <span class="hljs-keyword">return</span> config;
});

apiClient.<span class="hljs-property">interceptors</span>.<span class="hljs-property">response</span>.<span class="hljs-title function_">use</span>(
  <span class="hljs-function">(<span class="hljs-params">resp</span>) =&gt;</span> resp.<span class="hljs-property">data</span>,
  <span class="hljs-function">(<span class="hljs-params">error</span>) =&gt;</span> {
    <span class="hljs-comment">// 统一错误处理 / 弹 Toast / 上报</span>
    <span class="hljs-keyword">return</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">reject</span>(error);
  },
);
</code></pre>
<p>再往上封一层：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// userApi.ts</span>
<span class="hljs-keyword">import</span> { apiClient } <span class="hljs-keyword">from</span> <span class="hljs-string">'./apiClient'</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">getUser</span> = (<span class="hljs-params">id: <span class="hljs-built_in">string</span></span>) =&gt;
  apiClient.<span class="hljs-title function_">get</span>(<span class="hljs-string">`/users/<span class="hljs-subst">${id}</span>`</span>);

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">updateUser</span> = (<span class="hljs-params">id: <span class="hljs-built_in">string</span>, payload: UpdateUserDto</span>) =&gt;
  apiClient.<span class="hljs-title function_">put</span>(<span class="hljs-string">`/users/<span class="hljs-subst">${id}</span>`</span>, payload);
</code></pre>
<p>组件里直接用：</p>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-keyword">const</span> [user, setUser] = useState&lt;<span class="hljs-title class_">User</span> | <span class="hljs-literal">null</span>&gt;(<span class="hljs-literal">null</span>);

<span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-title function_">getUser</span>(userId).<span class="hljs-title function_">then</span>(setUser);
}, [userId]);
</code></pre>
<ul>
<li><strong>一切都很直观</strong>：<code>get</code> / <code>post</code> / <code>put</code>，「我调用，我拿结果」。</li>
<li><strong>封装成本很低</strong>：几百行就能搞出一套「全局请求体系」。</li>
<li><strong>前期非常高效</strong>：新接口只要在 <code>xxxApi.ts</code> 里加一个函数，回调里写逻辑就完事。</li>
</ul>
<p>这就是很多团队的「Axios 黄金时代」。</p>
<h3 data-id="heading-3">1.2 灵活自由背后的隐形复杂度</h3>
<p>问题是，你用 Axios 做了两件事：</p>
<ul>
<li><strong>把「网络请求」当工具函数用</strong></li>
<li><strong>把「服务端状态」当本地变量用</strong></li>
</ul>
<p>前期这么干没问题，但这些东西很容易失控：</p>
<ul>
<li>每个组件都可以随手发请求：<code>useEffect + axios</code> 到处都是</li>
<li>loading / error 各写一遍，风格不统一，还不一定都处理</li>
<li>数据生命周期全靠「人脑记忆」：需要刷新就 <code>refetch</code>，不需要就不管</li>
</ul>
<p><strong>当系统小的时候，这叫「灵活」；当系统大了，这叫「不可预测」。</strong></p>
<blockquote>
<p>「用 Axios，你拥有的是自由；<br/>
用多了，你发现自由本身就是复杂度。」</p>
</blockquote>
<hr/>
<h2 data-id="heading-4">二、当系统变大后，一切都变了：请求从「工具」变成「物理规律」</h2>
<h3 data-id="heading-5">2.1 并发和重复请求：带宽被你自己打爆</h3>
<p>典型场景：</p>
<ul>
<li>页面 A 列表请求 <code>/users</code></li>
<li>点击某行进入详情页 B，再请求一次 <code>/users/:id</code></li>
<li>右侧抽屉 C 也要同一个详情，再来一次 <code>/users/:id</code></li>
</ul>
<p>如果你只是「在需要的地方发请求」，很快就会出现：</p>
<ul>
<li><strong>同一资源被多处重复请求</strong>：浪费带宽和服务端资源</li>
<li>手动去重很难做统一：各处 <code>useRef</code> + <code>cancalToken</code>，代码风格完全不一样</li>
<li>滚动加载、预加载、轮询、并发组合请求，<strong>每一个都是专项工程</strong></li>
</ul>
<p>本质上：<strong>你在「点状」地用 Axios，而不是「面状」地管理数据源。</strong></p>
<h3 data-id="heading-6">2.2 数据过期与一致性：什么时候该刷新？</h3>
<p>当业务变复杂，你会碰到这些问题：</p>
<ul>
<li>A 页面改了用户信息，B 页面并不知道，要不要刷新？</li>
<li>Tab1 改了筛选条件，Tab2 里的图表要不要跟着更新？</li>
<li>详情弹窗关闭后，后面的列表是否需要重查一次？</li>
</ul>
<p>如果你用的是「组件内发请求 + 本地 state」，这些问题很难统一回答，因为：</p>
<ul>
<li>没有<strong>统一的「资源视角」</strong>：系统不知道「当前有哪些资源在用」「哪些已经 stale」</li>
<li>没有<strong>统一的「失效策略」</strong>：只能在「某个操作之后」凭经验 <code>reload</code> 一下</li>
<li>没有<strong>统一的「观察点」</strong>：也就谈不上可观测性和调试</li>
</ul>
<blockquote>
<p>「当你开始问『该不该重新请求？』的时候，<br/>
说明你需要的已经不是一个请求库，而是一个数据生命周期管理器。」</p>
</blockquote>
<h3 data-id="heading-7">2.3 加载与错误状态：被复制粘贴吃掉的可维护性</h3>
<p>几乎每个组件里，都能看到类似的模式：</p>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-keyword">const</span> [loading, setLoading] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">false</span>);
<span class="hljs-keyword">const</span> [error, setError] = useState&lt;<span class="hljs-title class_">Error</span> | <span class="hljs-literal">null</span>&gt;(<span class="hljs-literal">null</span>);

<span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-title function_">setLoading</span>(<span class="hljs-literal">true</span>);
  <span class="hljs-title function_">getUser</span>(userId)
    .<span class="hljs-title function_">then</span>(setUser)
    .<span class="hljs-keyword">catch</span>(setError)
    .<span class="hljs-title function_">finally</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">setLoading</span>(<span class="hljs-literal">false</span>));
}, [userId]);
</code></pre>
<p>当你有：</p>
<ul>
<li>50+ 页面</li>
<li>200+ 接口</li>
<li>10+ 人同时改 UI</li>
</ul>
<p>你会发现：</p>
<ul>
<li>loading / error 的逻辑到处都是 copy / paste</li>
<li>有人会忘记 <code>.finally</code>，有人会在 error 里直接 <code>message.error</code></li>
<li>出现「只加载不展示错误」或者「只展示错误不加载」的奇怪状态</li>
</ul>
<p><strong>这些都是工程债，但在 Axios 这个层面，你几乎无从约束。</strong></p>
<hr/>
<h2 data-id="heading-8">三、TanStack Query：克制到近乎啰嗦的艺术</h2>
<h3 data-id="heading-9">3.1 从「请求一次」到「声明数据源」</h3>
<p>TanStack Query（React Query）干的事非常直接：</p>
<blockquote>
<p><strong>把「服务端状态」抽出来，变成一个可以被声明、缓存、共享、失效和观察的「资源」。</strong></p>
</blockquote>
<p>一个最简单的例子：</p>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-keyword">import</span> { useQuery } <span class="hljs-keyword">from</span> <span class="hljs-string">'@tanstack/react-query'</span>;
<span class="hljs-keyword">import</span> { getUser } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/apis/user'</span>;

<span class="hljs-keyword">function</span> <span class="hljs-title function_">UserDetail</span>(<span class="hljs-params">{ userId }: { userId: <span class="hljs-built_in">string</span> }</span>) {
  <span class="hljs-keyword">const</span> { data, isLoading, error } = <span class="hljs-title function_">useQuery</span>({
    <span class="hljs-attr">queryKey</span>: [<span class="hljs-string">'user'</span>, userId],
    <span class="hljs-attr">queryFn</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">getUser</span>(userId),
    <span class="hljs-attr">staleTime</span>: <span class="hljs-number">5</span> * <span class="hljs-number">60</span> * <span class="hljs-number">1000</span>, <span class="hljs-comment">// 5 分钟内视为新鲜，不重新请求</span>
  });

  <span class="hljs-comment">// ...</span>
}
</code></pre>
<p>这里有几个工程上的关键点：</p>
<ul>
<li><strong>queryKey 是资源 ID</strong>：<code>['user', userId]</code> 把「这个用户」当成一个资源，而不仅是一次调用</li>
<li><strong>缓存与新鲜度有配置</strong>：<code>staleTime</code> 把「什么时候该重新请求」从组件逻辑里抽出来</li>
<li><strong>加载与错误状态集中管理</strong>：<code>isLoading</code> / <code>error</code> 的行为在整个项目里趋于一致</li>
</ul>
<p>这就是它看起来有点「啰嗦」的地方：<strong>你必须先把资源「命名」清楚，再去用它</strong>。</p>
<h3 data-id="heading-10">3.2 约束带来的工程收益：去重、缓存、失效统一化</h3>
<p>一旦有了统一的 Query 层，你可以获得一堆「不再重复造轮子」的能力：</p>
<ul>
<li><strong>请求去重</strong>：同一个 <code>queryKey</code> 在同一时间段内多次触发，TanStack Query 会自动合并</li>
<li><strong>缓存复用</strong>：页面 A 请求过的用户数据，页面 B 直接复用，甚至都不需要重新发请求</li>
<li><strong>失效策略统一</strong>：<code>queryClient.invalidateQueries(['user'])</code> 就可以让全局所有用户相关的数据按约定策略刷新</li>
<li><strong>重试 / 超时 / 退避</strong>：这些都被放进一套可配置的「物理规律」，而不是一家一个写法</li>
</ul>
<p>简单对比一下：</p>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-comment">// Axios 风格（伪代码）</span>
<span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-title function_">getUser</span>(userId).<span class="hljs-title function_">then</span>(setUser);
}, [userId]);

<span class="hljs-comment">// TanStack Query 风格</span>
<span class="hljs-keyword">const</span> { <span class="hljs-attr">data</span>: user } = <span class="hljs-title function_">useUserQuery</span>(userId);
</code></pre>
<p><code>useUserQuery</code> 里面可以内置：</p>
<ul>
<li>缓存时间</li>
<li>失败重试</li>
<li>错误上报</li>
<li>依赖的其他 Query（比如需要先拿到 token）</li>
</ul>
<p>这些东西一旦配好了，<strong>调用方就再也不用关心细节</strong>。</p>
<h3 data-id="heading-11">3.3 把「服务端状态」从本地状态管理里拆出去</h3>
<p>很多团队在用 Redux / MobX / Zustand，碰到一个经典问题：</p>
<ul>
<li>这个 state 是放全局 store 里，还是放组件内？</li>
<li>这个数据是「长期配置」，还是服务端返回的数据快照？</li>
</ul>
<p>TanStack Query 的核心观点是：</p>
<blockquote>
<p><strong>「服务端状态」是一类完全不同的状态。它有自己的生命周期、更新规律和一致性需求。</strong></p>
</blockquote>
<p>你不应该用同一套工具（Redux 等）去管理「按钮是否高亮」和「用户列表数据」这两种不同的东西。</p>
<p>更合理的分工是：</p>
<ul>
<li><strong>TanStack Query 管「服务端状态」</strong>：接口数据、缓存、失效、预取、并发控制</li>
<li><strong>本地状态库管「客户端状态」</strong>：UI 控制、临时表单、拖拽位置、筛选条件等</li>
</ul>
<p>这样一来：</p>
<ul>
<li>在 UI 代码里，你看见 Query 基本就知道「这是服务端数据」</li>
<li>Query 这一层可以集中做很多「全局优化」，而不用改每个组件</li>
</ul>
<blockquote>
<p>「成熟的工程，不是 state 写在哪，而是：<br/>
哪一类 state 有哪一类『物理规律』和『约束』。」</p>
</blockquote>
<hr/>
<h2 data-id="heading-12">四、技术债 + 业务债的交织：手写请求体系如何拖垮团队</h2>
<h3 data-id="heading-13">4.1 一次性 Demo 代码，被长期运营拖成泥潭</h3>
<p>几乎所有系统都经历过这个阶段：</p>
<ul>
<li>早期用 Axios 写的「Demo 级」代码，直接被拿来扩展</li>
<li>「先这样写着，后面有时间重构」这句话被说了很多遍</li>
<li>最后大家都默认「那块代码不能动」，因为一动就一堆回归问题</li>
</ul>
<p>在这个过程中，<strong>请求层是最被低估的复杂度来源之一</strong>：</p>
<ul>
<li>一开始只是十几个接口，每个组件各写各的</li>
<li>后面变成几百个接口，每个页面都有「自己那一套」请求逻辑</li>
<li>再往后，业务开始反复改版，接口升级 / 废弃交织在一起，你根本不知道哪些 API 还在用</li>
</ul>
<p>如果一开始就有一个「统一的数据获取层」（哪怕不是 TanStack Query），很多债可以少一半。</p>
<h3 data-id="heading-14">4.2 「约定优于配置」的失败：口头规范从来不靠谱</h3>
<p>你可能见过这些团队规范：</p>
<ul>
<li>所有请求都要走 <code>request.ts</code></li>
<li>不要在组件里直接用 Axios</li>
<li>所有接口都要写在 <code>apis/</code> 目录下</li>
<li>loading 一律用 <code>useLoading</code> 这个 hook</li>
</ul>
<p>听起来都很合理，但实际执行往往是：</p>
<ul>
<li>新人 copy 一段旧代码，里面直接 <code>axios.get</code>，没人注意</li>
<li>一些老代码来不及改，<code>request.ts</code> 和 <code>axios</code> 混用</li>
<li>某些特殊页面自己搞了一套 <code>fetchXXX</code> 工具，理由是「更灵活」</li>
</ul>
<p><strong>口头约定在 2 个人的项目里还行，在 20 个人的项目里几乎必然失效。</strong></p>
<p>TanStack Query 这种库，本质上是在帮你做一件事：</p>
<blockquote>
<p><strong>把「团队约定」写进「可执行的约束」里，而不是写进文档。</strong></p>
</blockquote>
<p>比如：</p>
<ul>
<li>所有读操作必须通过 <code>useQuery</code> / <code>useInfiniteQuery</code></li>
<li>所有写操作必须通过 <code>useMutation</code>，并且显式写明要 <code>invalidateQueries</code> 哪些资源</li>
<li>所有接口调用都必须声明 <code>queryKey</code>，否则根本没办法用</li>
</ul>
<p>这就是「硬约束」带来的工程收益。</p>
<h3 data-id="heading-15">4.3 可观测性与调试：当问题变成「这条数据是从哪来的？」</h3>
<p>大型前端系统里，一个非常典型的排查场景是：</p>
<blockquote>
<p>「为什么这个页面上的这个数据不对？」</p>
</blockquote>
<p>如果你用的是「到处手写 Axios」的模式，你需要：</p>
<ul>
<li>在代码里找「谁在请求这个接口」</li>
<li>再找「谁在改这个 state」</li>
<li>再找「是不是某个组件没刷 / 被缓存了」</li>
</ul>
<p>如果你有 Query 层，你可以：</p>
<ul>
<li>打开 React Query Devtools / 自己封装的调试面板</li>
<li>看看当前有哪些 Query，在什么时间被请求过</li>
<li>哪些被 mark 为 stale，哪些被 invalidate 过</li>
</ul>
<p><strong>起码你有一个观察「服务端状态」的统一入口。</strong></p>
<blockquote>
<p>「没有可观测性，就谈不上工程化。<br/>
你只是在用经验和直觉，硬抗系统复杂度。」</p>
</blockquote>
<hr/>
<h2 data-id="heading-16">五、为什么即使是顶尖前端团队，仍然会走向 TanStack Query</h2>
<h3 data-id="heading-17">5.1 并不是「它更潮」，而是「它更可控」</h3>
<p>顶尖的前端团队完全可以自己造一套「请求 + 缓存 + 失效 + 并发控制」框架。<br/>
很多团队也确实造过，但是：</p>
<ul>
<li>造出来的框架往往<strong>不可移植</strong>，换项目就重新造一次</li>
<li>文档跟不上迭代，<strong>只剩下口口相传的「内部 best practice」</strong></li>
<li>很多细节（比如 queryKey 命名规范、失效策略组合）没有被沉淀出来</li>
</ul>
<p>选择 TanStack Query，本质上是：</p>
<ul>
<li><strong>认同它的「服务端状态 = 一等公民」这个工程观</strong></li>
<li>不想再在「请求层」上无限造轮子，而是把精力放到业务和体验上</li>
</ul>
<h3 data-id="heading-18">5.2 物理规律不可对抗：延迟、抖动、失败率不会因为你用不用 Query 而改变</h3>
<p>不管你用不用 TanStack Query，后端系统都会有：</p>
<ul>
<li>延迟抖动（p99 比 p50 大一个量级）</li>
<li>短暂失败（网络、限流、瞬时错误）</li>
<li>冷启动、缓存失效、突发流量</li>
</ul>
<p>区别在于：</p>
<ul>
<li>用 Axios，<strong>每个页面都要自己应对这些「物理规律」</strong></li>
<li>用 TanStack Query，这些东西可以被<strong>抽象成统一的「策略」</strong></li>
</ul>
<p>例如：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// 全局配置：统一重试策略</span>
<span class="hljs-keyword">const</span> queryClient = <span class="hljs-keyword">new</span> <span class="hljs-title class_">QueryClient</span>({
  <span class="hljs-attr">defaultOptions</span>: {
    <span class="hljs-attr">queries</span>: {
      <span class="hljs-attr">retry</span>: <span class="hljs-number">2</span>,
      <span class="hljs-attr">retryDelay</span>: <span class="hljs-function">(<span class="hljs-params">attempt</span>) =&gt;</span> <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">min</span>(<span class="hljs-number">1000</span> * <span class="hljs-number">2</span> ** attempt, <span class="hljs-number">10000</span>),
      <span class="hljs-attr">staleTime</span>: <span class="hljs-number">60</span> * <span class="hljs-number">1000</span>,
    },
  },
});
</code></pre>
<p>你不用再一遍一遍地想：</p>
<ul>
<li>这个请求要不要重试？</li>
<li>要不要加退避？</li>
<li>要不要缓存？缓存多久？</li>
</ul>
<p><strong>大部分时候，全局默认值 + 个别 override 就够用了。</strong></p>
<blockquote>
<p>「真正拖垮系统的不是单次调用，而是『在真实物理世界中，成千上万次调用的叠加效应』。<br/>
TanStack Query 管的是后者。」</p>
</blockquote>
<h3 data-id="heading-19">5.3 「顶尖」的含义：不是代码写得多，而是系统写得少、错得少</h3>
<p>顶尖团队最终关心的是：</p>
<ul>
<li><strong>团队整体的交付速度，而不是某个接口写得有多花哨</strong></li>
<li><strong>系统整体的可预测性，而不是某个页面跑得有多快</strong></li>
</ul>
<p>在这个尺度下，TanStack Query 给的是：</p>
<ul>
<li>更可预测的「接口使用方式」</li>
<li>更可观测的「数据状态」</li>
<li>更容易被新同学理解和上手的「统一模式」</li>
</ul>
<blockquote>
<p>「成熟的工程，最重要的不是『我能做到什么』，<br/>
而是『我不需要再手动做到什么』。」</p>
</blockquote>
<hr/>
<h2 data-id="heading-20">真实案例：从 Axios 到 TanStack Query 的演进之路</h2>
<h3 data-id="heading-21">案例一：SaaS 中后台，从「到处 useEffect」到集中数据层</h3>
<ul>
<li><strong>原本方案</strong><br/>
React + Axios + 自封装 <code>request.ts</code>，几十个页面里充满了 <code>useEffect + axios</code> 调用，loading / error / empty 各写各的。</li>
<li><strong>遇到的瓶颈</strong><br/>
列表和详情页数据不同步，操作完需要手动刷新；<br/>
重复请求严重，同一个用户详情可以在多个地方被请求 3–4 次；<br/>
新人完全不知道「改哪一块会影响哪些页面」。</li>
<li><strong>迁移后的方案</strong><br/>
引入 TanStack Query，把所有「读接口」统一抽到 <code>queries/</code> 目录，导出 <code>useUserQuery / useUsersQuery / useProjectQuery</code> 等；<br/>
所有 mutation 都通过 <code>useMutation</code>，在 <code>onSuccess</code> 里统一 <code>invalidateQueries</code>。<br/>
<strong>收益</strong>：
<ul>
<li>接口相关 bug 数量 2 个月内下降约 40%</li>
<li>列表与详情页数据不一致的问题几乎消失</li>
<li>新人从「看不懂请求层」到「半天能上手改业务」</li>
</ul>
</li>
</ul>
<h3 data-id="heading-22">案例二：电商管理后台，从「乐观更新地狱」到统一失效策略</h3>
<ul>
<li><strong>原本方案</strong><br/>
用 Redux 管全局数据，接口调用通过 thunk/middleware 分发，手动写乐观更新逻辑。</li>
<li><strong>遇到的瓶颈</strong><br/>
乐观更新和实际返回不一致时，很难回滚；<br/>
多人同时操作库存 / 价格时，前端状态与后端状态不同步；<br/>
写一个复杂的「批量更新 + 撤销」功能需要在多个 reducer 之间来回跳。</li>
<li><strong>迁移后的方案</strong><br/>
把所有「服务端状态」从 Redux 迁到 React Query，Redux 仅保留 UI 控制和部分客户端配置；<br/>
批量操作用 <code>useMutation</code> + <code>onMutate / onError / onSettled</code> 写出标准化的乐观更新模板。<br/>
<strong>收益</strong>：
<ul>
<li>大部分乐观更新逻辑可以被复用</li>
<li>整体代码量减少约 20%（大量重复 case 被删掉）</li>
<li>回滚逻辑更集中，可测试性提高</li>
</ul>
</li>
</ul>
<h3 data-id="heading-23">案例三：内部运营工具，从「API 文档 != 真实使用方式」到「查询即文档」</h3>
<ul>
<li><strong>原本方案</strong><br/>
有 Swagger 文档，但每个前端项目（PC / H5 / 内嵌）各封一套 API，并各自拼装不同的查询参数。</li>
<li><strong>遇到的瓶颈</strong><br/>
文档更新和前端调用方式不同步；<br/>
很多接口有奇怪的「隐形字段」只有一个团队知道；<br/>
调试时经常需要「抓一遍请求」才能搞清楚到底传了啥。</li>
<li><strong>迁移后的方案</strong><br/>
以 TanStack Query 为中心，把每一个查询封成一个 <code>useXXXQuery</code>，这个 hook 本身就<strong>约束了参数、返回类型和使用场景</strong>；<br/>
给业务方的文档不再是「接口列表」，而是「可复用的查询能力」。<br/>
<strong>收益</strong>：
<ul>
<li>部门间的协作变成「对齐查询定义」而不是「对齐接口字段」</li>
<li>新增一个使用场景，只要复用已有的 Query 或在其基础上轻量扩展</li>
</ul>
</li>
</ul>
<blockquote>
<p>结论很一致：<strong>Axios 很好用，但不适合扛大梁。<br/>
真正扛大梁的，是围绕它之上的那层「数据编排和工程约束」。</strong></p>
</blockquote>
<hr/>
<h2 data-id="heading-24">最合理的平衡：分层协作，而非替代</h2>
<p>与其讨论「要不要抛弃 Axios」，不如把整个栈分层看：</p>



































<table><thead><tr><th>阶段 / 层级</th><th>推荐技术 / 方案</th><th>设计目标</th></tr></thead><tbody><tr><td>原型期 / 小项目</td><td>Axios + 轻量封装（<code>request.ts</code> + 少量 hooks）</td><td>快速试错，低心智负担</td></tr><tr><td>成长期中后台</td><td>Axios + TanStack Query（或 Vue Query 等）</td><td>把服务端状态抽象成「资源」</td></tr><tr><td>成熟期 / 多团队协作</td><td>Axios + TanStack Query + 约定式 queryKey / 目录规范</td><td>统一数据访问模式，降低协作成本</td></tr><tr><td>极致性能 / 特殊场景</td><td>Axios + TanStack Query + 自定义缓存层 / Streaming 方案</td><td>精细控制缓存、带宽与并发</td></tr><tr><td>渐进式改造遗留项目</td><td>保留原 Axios，新增功能全部走 TanStack Query</td><td>避免大手术式重构，渐进演进</td></tr></tbody></table>
<p>再细一点到前端内部职责：</p>






























<table><thead><tr><th>前端层级</th><th>推荐角色分工</th><th>关键词</th></tr></thead><tbody><tr><td>请求传输层</td><td>Axios / fetch / 自研 HTTP 客户端</td><td>传输、重试、统一 header</td></tr><tr><td>数据获取编排层</td><td>TanStack Query / Vue Query</td><td>缓存、去重、失效、并发控制</td></tr><tr><td>业务服务层（hooks）</td><td><code>useUserService</code> / <code>useOrderService</code> 等</td><td>聚合多个 Query + 业务规则</td></tr><tr><td>UI 组件层</td><td>只消费 hooks 暴露的数据和状态</td><td>关注展示与交互，不关心请求细节</td></tr></tbody></table>
<p><strong>不是「Axios vs TanStack Query」，而是：<br/>
Axios 负责「怎么发」，TanStack Query 负责「怎么用」，业务 hooks 负责「用来做什么」。</strong></p>
<hr/>
<h2 data-id="heading-25">总结：从 Axios 到 TanStack Query，从工具到工程</h2>
<ul>
<li><strong>Axios 代表局部的自由与掌控，TanStack Query 代表全局的约束与可预测性</strong>。</li>
<li><strong>问题不是 Axios 不行，而是当系统变大时，服务端状态的「物理规律」被无限放大</strong>。</li>
<li><strong>顶尖团队真正关心的是「系统写得少、错得少」，而不是「这个请求写得多帅」</strong>。</li>
<li><strong>成熟的前端架构，不再把「请求」当成一个工具调用，而是当成一个长期存在、被管理的资源</strong>。</li>
<li><strong>最合理的方案从来不是「替代」，而是「分层协作」：请求传输层、数据编排层、业务服务层各司其职。</strong></li>
</ul>
<blockquote>
<p>Axios 是起跑时的加速器，TanStack Query 是长跑时的配速器。<br/>
<strong>前者帮你快速上路，后者让你跑到终点。</strong></p>
</blockquote>
<blockquote>
<p>选择技术，其实是在选择你如何对待复杂度：是把它摊在每个组件里，<br/>
还是收口到一层可以被观察、被约束、被演进的工程抽象里。</p>
</blockquote>
<hr/>
<h2 data-id="heading-26">尾声：技术的尽头，是工程哲学</h2>
<ul>
<li><strong>稳定靠可预测性</strong>：同一类问题，在系统里应该有同一类解决方式。</li>
<li><strong>团队靠约束</strong>：越是大型系统，越需要把「约定」变成「可执行的规则」。</li>
<li><strong>成熟体现在写得少、错得少</strong>：少写一次 <code>useEffect + axios</code>，多用一次 <code>useXXXQuery</code>，就是把复杂度搬离业务代码一步。</li>
</ul>
<blockquote>
<p>Axios 让你随时可以写一行请求代码，TanStack Query 让这行代码背后有一整套「物理规律」兜底。<br/>
成熟的团队，既懂得什么时候该追求自由，也懂得什么时候该把自由托付给框架。</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[教程：如何修改 Docker 容器 bisheng-frontend 中的静态文件]]></title>    <link>https://juejin.cn/post/7575488180980465664</link>    <guid>https://juejin.cn/post/7575488180980465664</guid>    <pubDate>2025-11-24T01:54:50.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7575488180980465664" data-draft-id="7575644469711110163" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="教程：如何修改 Docker 容器 bisheng-frontend 中的静态文件"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-11-24T01:54:50.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="非优秀程序员"/> <meta itemprop="url" content="https://juejin.cn/user/3984285870341288"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            教程：如何修改 Docker 容器 bisheng-frontend 中的静态文件
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3984285870341288/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    非优秀程序员
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-24T01:54:50.000Z" title="Mon Nov 24 2025 01:54:50 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>教程将分为以下几个部分：</p>
<ol>
<li><strong>教程目标</strong>：明确说明本教程将教会你什么。</li>
<li><strong>前提条件</strong>：列出执行本教程所需的环境和工具。</li>
<li><strong>操作步骤</strong>：
<ul>
<li><strong>步骤一：进入容器并定位文件</strong></li>
<li><strong>步骤二：将容器内文件复制到本地</strong></li>
<li><strong>步骤三：在本地修改文件</strong></li>
<li><strong>步骤四：重新创建容器并挂载修改后的文件</strong></li>
</ul>
</li>
<li><strong>总结</strong>：简要回顾整个流程。</li>
</ol>
<hr/>
<h3 data-id="heading-0">教程：如何修改 Docker 容器 <code>bisheng-frontend</code> 中的静态文件</h3>
<h4 data-id="heading-1">一、教程目标</h4>
<p>本教程将指导你如何安全地修改运行中的 <code>bisheng-frontend</code> Docker 容器内的静态文件（如图片、SVG 等）。我们将采用“<strong>复制文件 -&gt; 本地修改 -&gt; 挂载重启</strong>”的最佳实践，以避免直接在容器内修改带来的风险。</p>
<h4 data-id="heading-2">二、前提条件</h4>
<ol>
<li>已安装 Docker 并能正常运行。</li>
<li>已安装 <code>docker-compose</code> (如果你的服务是通过 <code>docker-compose</code> 启动的)。</li>
<li>具有宿主机的命令行访问权限，并拥有 <code>sudo</code> 权限（用于创建目录和修改权限）。</li>
<li>确认 <code>bisheng-frontend</code> 容器正在运行：
<pre><code class="hljs language-bash" lang="bash">docker ps | grep bisheng-frontend
</code></pre>
</li>
</ol>
<hr/>
<h4 data-id="heading-3">三、操作步骤</h4>
<h5 data-id="heading-4">步骤一：进入容器并定位目标文件</h5>
<p>首先，我们需要进入容器内部，找到需要修改的文件的具体路径。</p>
<ol>
<li>
<p><strong>进入 <code>bisheng-frontend</code> 容器的交互式终端</strong>：</p>
<pre><code class="hljs language-bash" lang="bash">docker <span class="hljs-built_in">exec</span> -it bisheng-frontend /bin/bash
</code></pre>
<ul>
<li><code>-it</code>: 创建一个交互式的 TTY 终端。</li>
<li><code>bisheng-frontend</code>: 容器名称。</li>
<li><code>/bin/bash</code>: 要执行的命令。</li>
</ul>
</li>
<li>
<p><strong>在容器内搜索需要修改的文件</strong>：
例如，我们要搜索所有图片文件（<code>.png</code>, <code>.jpg</code>, <code>.svg</code>）：</p>
<pre><code class="hljs language-bash" lang="bash">find / -name <span class="hljs-string">"*.png"</span> -o -name <span class="hljs-string">"*.jpg"</span> -o -name <span class="hljs-string">"*.svg"</span> 2&gt;/dev/null
</code></pre>
<ul>
<li><code>2&gt;/dev/null</code>: 将无关的权限错误信息丢弃，使输出更干净。</li>
</ul>
</li>
<li>
<p><strong>记录文件路径</strong>：
从搜索结果中，找到你需要修改的文件，并记下它的完整路径。例如：</p>
<ul>
<li><code>/usr/share/nginx/html/platform/assets/male-technologist-CcgkZdXy.png</code></li>
<li><code>/usr/share/nginx/html/platform/assets/analysis.svg</code></li>
</ul>
</li>
<li>
<p><strong>退出容器</strong>：
完成文件定位后，退出容器终端。</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">exit</span>
</code></pre>
</li>
</ol>
<h5 data-id="heading-5">步骤二：将容器内的文件复制到本地宿主机</h5>
<p>为了安全地修改，我们将容器内的整个静态文件目录复制到本地。</p>
<ol>
<li>
<p><strong>在宿主机上创建一个本地目录</strong>，用于存放从容器中复制出来的文件：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">mkdir</span> -p /opt/bisheng-main/local-frontend
</code></pre>
<ul>
<li><code>-p</code>: 确保父目录存在，如果不存在则一并创建。</li>
</ul>
</li>
<li>
<p><strong>（可选）修改本地目录权限</strong>：
为了确保你当前的用户有权限读写该目录，可以修改其权限。</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 将目录所有者改为当前用户（推荐）</span>
sudo <span class="hljs-built_in">chown</span> -R <span class="hljs-variable">$USER</span>:<span class="hljs-variable">$USER</span> /opt/bisheng-main/local-frontend

<span class="hljs-comment"># 或者，给予更宽松的权限（不推荐，但简单）</span>
<span class="hljs-comment"># sudo chmod -R 775 /opt/bisheng-main/local-frontend</span>
</code></pre>
</li>
<li>
<p><strong>将容器内的文件目录复制到本地</strong>：
根据步骤一找到的路径，我们复制其上级目录（例如 <code>/usr/share/nginx/html</code>）到本地。</p>
<pre><code class="hljs language-bash" lang="bash">docker <span class="hljs-built_in">cp</span> bisheng-frontend:/usr/share/nginx/html /opt/bisheng-main/local-frontend
</code></pre>
<ul>
<li>这条命令会将容器内的 <code>/usr/share/nginx/html</code> 目录及其所有内容，复制到本地的 <code>/opt/bisheng-main/local-frontend/</code> 目录下。复制完成后，本地路径会是 <code>/opt/bisheng-main/local-frontend/html/...</code>。</li>
</ul>
</li>
<li>
<p><strong>验证文件是否复制成功</strong>：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">ls</span> -l /opt/bisheng-main/local-frontend/html/platform/assets/
</code></pre>
<p>你应该能看到你之前在容器内找到的那些文件。</p>
</li>
</ol>
<h5 data-id="heading-6">步骤三：在本地修改文件</h5>
<p>现在，你可以在本地对文件进行任意修改。</p>
<ol>
<li><strong>使用你喜欢的编辑器或工具</strong>，找到本地对应的文件并进行修改或替换。
<ul>
<li>本地文件路径示例：<code>/opt/bisheng-main/local-frontend/html/platform/assets/male-technologist-CcgkZdXy.png</code></li>
<li><strong>重要</strong>：修改后的文件请务必保持与原文件<strong>相同的文件名</strong>。</li>
</ul>
</li>
</ol>
<h5 data-id="heading-7">步骤四：重新创建容器并挂载修改后的文件</h5>
<p>这是最关键的一步。我们将停止并删除旧容器，然后创建一个新容器，并使用 Docker 的卷挂载功能，将我们修改好的本地目录挂载到容器内，从而覆盖原有的文件。</p>
<ol>
<li>
<p><strong>停止并删除正在运行的 <code>bisheng-frontend</code> 容器</strong>：</p>
<pre><code class="hljs language-bash" lang="bash">docker stop bisheng-frontend
docker <span class="hljs-built_in">rm</span> bisheng-frontend
</code></pre>
<ul>
<li>注意：这会短暂中断你的 <code>bisheng-frontend</code> 服务。</li>
</ul>
</li>
<li>
<p><strong>（重要）确认容器的网络</strong>：
为了确保新容器能和其他服务（如 <code>bisheng-backend</code>）通信，需要使用正确的网络。</p>
<ul>
<li>
<p><strong>如果你使用 <code>docker-compose</code></strong>：通常不需要手动指定网络，<code>docker-compose</code> 会自动管理。</p>
</li>
<li>
<p><strong>如果你手动运行容器</strong>：</p>
</li>
<li>
<p>a.  列出所有网络：
<code>bash       docker network ls       </code></p>
<p>b.  找到 <code>bisheng-frontend</code> 之前连接的网络（通常是 <code>bisheng_default</code> 或 <code>docker_default</code>）。你可以通过检查哪个网络包含 <code>bisheng-backend</code> 来确认：
<code>bash       docker network inspect docker_default | grep "bisheng-backend"       </code></p>
<p>c.  记下正确的网络名称，例如 <code>bisheng_default</code>。</p>
</li>
</ul>
</li>
<li>
<p><strong>重新启动容器，并挂载本地修改后的目录</strong>：
使用 <code>docker run</code> 命令创建一个新容器。<strong>关键在于 <code>-v</code> (volume) 参数</strong>。</p>
<pre><code class="hljs language-bash" lang="bash">docker run -d \
  --name bisheng-frontend \
  --network bisheng_default \  <span class="hljs-comment"># 替换为你在上一步确认的网络名称</span>
  -p 3001:3001 \
  -v /opt/bisheng-main/local-frontend/html/platform/assets:/usr/share/nginx/html/platform/assets \
  cr.dataelem.com/dataelement/bisheng-frontend:latest
</code></pre>
<ul>
<li><code>-v /local/path:/container/path</code>: 这是卷挂载命令。它将本地的 <code>/opt/bisheng-main/local-frontend/html/platform/assets</code> 目录，挂载到容器内的 <code>/usr/share/nginx/html/platform/assets</code> 目录。容器运行时，会优先读取挂载目录中的文件，从而实现了文件替换。</li>
<li><strong>路径映射技巧</strong>：尽量让本地挂载的目录结构与容器内的目录结构保持一致，这样不易出错。</li>
</ul>
</li>
<li>
<p><strong>检查容器是否成功启动</strong>：</p>
<pre><code class="hljs language-bash" lang="bash">docker ps | grep bisheng-frontend
</code></pre>
<p>如果能看到 <code>bisheng-frontend</code> 并且状态为 <code>Up</code>，则表示启动成功。</p>
</li>
<li>
<p><strong>验证修改</strong>：
打开浏览器或使用 <code>curl</code> 访问你的应用，查看相应的图片或静态资源是否已经更新为你修改后的版本。</p>
</li>
</ol>
<hr/>
<h4 data-id="heading-8">四、总结</h4>
<p>通过以上步骤，你已经成功地修改了 <code>bisheng-frontend</code> 容器中的静态文件。这种“复制-修改-挂载”的方法是 Docker 环境下更新容器内容的标准操作流程，它安全、可靠且易于管理。</p>
<p>如果你未来还需要修改其他文件，只需重复<strong>步骤三</strong>和<strong>步骤四</strong>即可，无需再重新复制整个目录（除非容器内的原始文件又发生了变化）。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[存储风暴下的边缘智能韧性：瑞芯微RK3588如何将供应链挑战转化为市场机遇]]></title>    <link>https://juejin.cn/post/7575469988737269769</link>    <guid>https://juejin.cn/post/7575469988737269769</guid>    <pubDate>2025-11-24T01:58:27.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7575469988737269769" data-draft-id="7575412016405299210" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="存储风暴下的边缘智能韧性：瑞芯微RK3588如何将供应链挑战转化为市场机遇"/> <meta itemprop="keywords" content="算法,计算机视觉,深度学习"/> <meta itemprop="datePublished" content="2025-11-24T01:58:27.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="CoovallyAIHub"/> <meta itemprop="url" content="https://juejin.cn/user/2461151071843739"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            存储风暴下的边缘智能韧性：瑞芯微RK3588如何将供应链挑战转化为市场机遇
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2461151071843739/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    CoovallyAIHub
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-24T01:58:27.000Z" title="Mon Nov 24 2025 01:58:27 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>近期的全球存储市场波动，为高速发展的边缘AI产业上了一堂生动的“供应链安全”课。DDR4颗粒从短缺到价格暴涨，如同一面镜子，照出了不同技术路线的抗风险能力。在这场考验中，瑞芯微旗舰芯片RK3588及其所代表的平台化思维，不仅展现了过硬的“技术韧性”，更揭示了国产边缘智能生态发展的新路径。瑞芯微三季报指出：“由于DDR4存储芯片从供应短缺到价格暴涨，促使部分客户中高端AIoT产品向DDR5转型，方案调整时间影响短期需求，导致第三季度收入增长略缓，随后会继续快速增长”。</p>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e52afb972bf24cabb5f402aa01f62791~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764554306&amp;x-signature=QG4g%2BHRuNJQ6R8Xg5FYLgIHmn18%3D" alt="图片1.png" loading="lazy"/></p>
<h2 data-id="heading-0"><strong>风暴眼中的“稳定器”：RK3588的多DDR支持能力成为边缘部署的压舱石</strong></h2>
<p>当行业普遍因DDR4短缺而面临项目延期、成本失控的困境时，瑞芯微官方公众号发布的《瑞芯微SoC平台DDR适配提速！》系列文章，指向了一个核心事实 <strong>：在边缘侧，算力很重要，但让算力稳定且经济地落地，更重要。</strong></p>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a89a81617886428f8bbacf863c8263c3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764554306&amp;x-signature=wWM2bmF71RE0TWXebpDxvn8ISN4%3D" alt="图片2.png" loading="lazy"/></p>
<p>RK3588作为边缘计算的核心引擎，其前瞻性的设计在此刻凸显价值。它原生支持LPDDR4/LPDDR4X/LPDDR5等多种内存规格。这意味着，当DDR4成为供应链的“瓶颈”时，客户可以几乎无缝地切换至LPDDR4X或LPDDR5方案，无需重新设计主板，无需更换主平台，最大程度地保障了产品研发和量产节奏。</p>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f89a5300f07e4c56935c04838523bcca~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764554306&amp;x-signature=38%2FcTafTXzzCg5lBzP14utQfvA8%3D" alt="图片3.png" loading="lazy"/></p>
<p>这种 <strong>“多一种选择，多一份保障”</strong> 的灵活性，对于工业质检、智能安防、车载设备等要求连续稳定运行的边缘场景而言，已从“技术亮点”升级为 <strong>“选型刚需”</strong> 。瑞芯微所言的“甜蜜的烦恼”，正是其通过技术储备将行业普适性风险转化为自身差异化优势的体现。</p>
<h2 data-id="heading-1"><strong>从硬件适配到生态协同：赋能边缘的“双核驱动”</strong></h2>
<p>RK3588提供的硬件级韧性，为边缘AI应用铺设了可靠的通路。然而，完整的边缘智能解决方案，离不开软件与算法的协同。这就构成了赋能边缘的“双核驱动”：</p>
<ul>
<li>硬件核心（RK3588）：提供算力基石与供应链韧性。其强大的NPU（6 TOPS AI算力）和丰富的接口，为模型推理提供了高性能、低功耗的硬件环境。</li>
<li>软件核心（算法平台与工具链）：释放硬件潜能的钥匙。在RK3588上高效部署AI模型，需要软件生态的紧密配合。</li>
</ul>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/898c17efffe54e7e8524749b2ad59579~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764554306&amp;x-signature=E%2BmffICZvZvG44ieZpOfkcRRowE%3D" alt="图片4.png" loading="lazy"/></p>
<p><strong>在这里，我们可以观察到一个积极的产业趋势：国产AI软件生态正与像RK3588这样的国产核心芯片加速融合。</strong> 例如，<strong>Coovally等AI模型训练平台</strong>，已经开始致力于将其模型优化和部署工具链与RK3588的NPU进行深度适配。这意味着，开发者利用此类平台训练出的AI模型，能够通过高效的量化与转换，直接调用RK3588的NPU进行加速推理，从而在边缘端实现最优的性能功耗比。</p>
<p>传统AI开发流程中，在云端训练好的模型，要部署到边缘设备上是一个复杂且充满挑战的过程，常被称为“最后一公里”难题。</p>
<p>对Coovally而言：RK3588是一个标准化、高性能、且得到市场验证的国产硬件标杆。Coovally通过深度适配RK3588，意味着其平台训练出的模型拥有了一个极其可靠和广泛的落地出口。这大大增强了Coovally平台对开发者的吸引力，因为他们可以“一次训练，多处部署”，并且能放心地部署在RK3588这个强大的硬件上。</p>
<p>对RK3588而言：Coovally这样的AI平台是一个强大的“算法生态赋能者”。它降低了RK3588的使用门槛，让更多不精通底层优化的应用开发者，也能轻松地将AI模型部署到RK3588上并充分发挥其性能。这极大地丰富了RK3588的应用生态，从“提供算力”升级为“提供算力+算法落地解决方案”。</p>
<h2 data-id="heading-2"><strong>结论：韧性生态是边缘智能未来的核心竞争力</strong></h2>
<p>DDR4短缺事件，是一次对国产芯片产业的压力测试。它证明，未来的竞争不再是单纯的算力竞赛，而是<strong>涵盖技术前瞻性、供应链韧性和生态协同力的综合较量。</strong></p>
<p>瑞芯微RK3588通过其多DDR支持能力，在硬件层面构建了第一道防线。而它与<strong>Coovally等AI模型训练与部署平台</strong>的协同，则是在构建一个更深层次的、软硬一体的韧性生态。这个生态的价值在于，它让终端客户能够专注于自身业务逻辑，而无需担忧底层的芯片供应、模型适配与性能调优。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[🎯 小说笔记编辑中的段落拖拽移动：基于 ProseMirror 的交互式重排技术]]></title>    <link>https://juejin.cn/post/7575363120798580736</link>    <guid>https://juejin.cn/post/7575363120798580736</guid>    <pubDate>2025-11-23T13:58:56.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7575363120798580736" data-draft-id="7575112613778440226" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content=" 🎯 小说笔记编辑中的段落拖拽移动：基于 ProseMirror 的交互式重排技术"/> <meta itemprop="keywords" content="前端,Electron"/> <meta itemprop="datePublished" content="2025-11-23T13:58:56.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="龙国浪子"/> <meta itemprop="url" content="https://juejin.cn/user/1943592291275886"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
             🎯 小说笔记编辑中的段落拖拽移动：基于 ProseMirror 的交互式重排技术
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1943592291275886/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    龙国浪子
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-23T13:58:56.000Z" title="Sun Nov 23 2025 13:58:56 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">🎯 小说笔记编辑中的段落拖拽移动：基于 ProseMirror 的交互式重排技术</h2>
<blockquote>
<p>💡 本文深入探讨了在小说写作软件的笔记编辑器中实现段落拖拽移动功能的技术方案，包括拖拽锚点、子段落联动、全局事件处理等核心功能的完整实现，为开发者提供一套完整的段落重排解决方案。</p>
</blockquote>
<h3 data-id="heading-1">📋 目录</h3>
<ul>
<li><a href="#%E9%A1%B9%E7%9B%AE%E8%83%8C%E6%99%AF" title="#%E9%A1%B9%E7%9B%AE%E8%83%8C%E6%99%AF">项目背景</a></li>
<li><a href="#%E6%8A%80%E6%9C%AF%E6%9E%B6%E6%9E%84%E8%AE%BE%E8%AE%A1" title="#%E6%8A%80%E6%9C%AF%E6%9E%B6%E6%9E%84%E8%AE%BE%E8%AE%A1">技术架构设计</a></li>
<li><a href="#%E6%A0%B8%E5%BF%83%E5%8A%9F%E8%83%BD%E5%AE%9E%E7%8E%B0" title="#%E6%A0%B8%E5%BF%83%E5%8A%9F%E8%83%BD%E5%AE%9E%E7%8E%B0">核心功能实现</a></li>
<li><a href="#%E6%8B%96%E6%8B%BD%E9%94%9A%E7%82%B9%E8%A3%85%E9%A5%B0%E7%B3%BB%E7%BB%9F" title="#%E6%8B%96%E6%8B%BD%E9%94%9A%E7%82%B9%E8%A3%85%E9%A5%B0%E7%B3%BB%E7%BB%9F">拖拽锚点装饰系统</a></li>
<li><a href="#%E6%AE%B5%E8%90%BD%E7%A7%BB%E5%8A%A8%E7%AE%97%E6%B3%95" title="#%E6%AE%B5%E8%90%BD%E7%A7%BB%E5%8A%A8%E7%AE%97%E6%B3%95">段落移动算法</a></li>
<li><a href="#%E5%85%A8%E5%B1%80%E4%BA%8B%E4%BB%B6%E5%A4%84%E7%90%86" title="#%E5%85%A8%E5%B1%80%E4%BA%8B%E4%BB%B6%E5%A4%84%E7%90%86">全局事件处理</a></li>
<li><a href="#%E6%8A%80%E6%9C%AF%E4%BA%AE%E7%82%B9%E6%80%BB%E7%BB%93" title="#%E6%8A%80%E6%9C%AF%E4%BA%AE%E7%82%B9%E6%80%BB%E7%BB%93">技术亮点总结</a></li>
<li><a href="#%E6%80%BB%E7%BB%93%E4%B8%8E%E5%B1%95%E6%9C%9B" title="#%E6%80%BB%E7%BB%93%E4%B8%8E%E5%B1%95%E6%9C%9B">总结与展望</a></li>
</ul>
<h3 data-id="heading-2">🎯 项目背景</h3>
<p>在小说创作过程中，作者经常需要调整笔记的结构和顺序。传统的文本编辑器通常只支持复制粘贴来移动段落，操作繁琐且容易出错。因此，我们在 51mazi 的笔记编辑器中设计了一个直观的段落拖拽移动功能，让作者能够通过拖拽快速调整段落顺序，提升创作效率。</p>
<h4 data-id="heading-3">🎨 段落拖拽功能展示</h4>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0a5438cfa9ae47bf9d8f02cc86f6f55e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6b6Z5Zu95rWq5a2Q:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764511136&amp;x-signature=sJgmBkR%2FOsgXPCg1pq4EEfgaNu4%3D" alt="笔记编辑器" loading="lazy"/></p>
<p><em>段落拖拽移动功能 - 支持拖拽锚点快速调整段落顺序</em></p>
<h4 data-id="heading-4">✨ 核心功能特性</h4>
<ul>
<li>🖱️ <strong>拖拽锚点</strong>: 每个段落左侧显示拖拽锚点（⋮⋮），悬停时显示</li>
<li>📦 <strong>子段落联动</strong>: 拖拽父段落时，所有子段落（缩进级别更大的段落）会一起移动</li>
<li>🎯 <strong>精确定位</strong>: 支持在段落上方或下方插入，根据鼠标位置自动判断</li>
<li>🌐 <strong>全局支持</strong>: 支持拖拽到编辑器外的区域（如侧边栏），仍能正确放置</li>
<li>🎨 <strong>视觉反馈</strong>: 拖拽时显示段落预览，提供清晰的视觉反馈</li>
</ul>
<h3 data-id="heading-5">🏗️ 技术架构设计</h3>
<h4 data-id="heading-6">核心技术栈</h4>
<ul>
<li><strong>TipTap 3.7.0</strong>: 基于 ProseMirror 的富文本编辑器框架</li>
<li><strong>ProseMirror</strong>: 底层文档模型和插件系统</li>
<li><strong>Vue 3.5.13</strong>: 渐进式 JavaScript 框架</li>
<li><strong>Decoration System</strong>: ProseMirror 的装饰系统，用于添加拖拽锚点</li>
</ul>
<h4 data-id="heading-7">系统架构设计</h4>
<pre><code class="hljs language-markdown" lang="markdown">┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   编辑器视图     │    │   ProseMirror   │    │   拖拽扩展      │
│   EditorView    │◄──►│   Plugin        │◄──►│ NoteDragHandle  │
└─────────────────┘    └─────────────────┘    └─────────────────┘
<span class="hljs-code">         │                       │                       │
         │                       │                       │
         ▼                       ▼                       ▼
    ┌─────────────────────────────────────────────────────┐
    │        拖拽事件处理与段落移动算法                     │
    └─────────────────────────────────────────────────────┘
</span></code></pre>
<h4 data-id="heading-8">📁 核心组件</h4>
<p>段落拖拽功能通过 TipTap Extension 实现，主要包含：</p>
<ul>
<li><strong>NoteDragHandle Extension</strong>: 拖拽锚点扩展</li>
<li><strong>Decoration System</strong>: 装饰系统，为每个段落添加拖拽锚点</li>
<li><strong>Event Handlers</strong>: 处理拖拽相关事件（mousedown, dragstart, dragover, drop, dragend）</li>
</ul>
<h3 data-id="heading-9">🔧 核心功能实现</h3>
<h4 data-id="heading-10">1. 拖拽扩展初始化</h4>
<p>段落拖拽功能通过 TipTap Extension 实现，在编辑器初始化时注册：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// src/renderer/src/components/NoteEditorContent.vue</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Extension</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@tiptap/core'</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Plugin</span>, <span class="hljs-title class_">PluginKey</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'prosemirror-state'</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Decoration</span>, <span class="hljs-title class_">DecorationSet</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'prosemirror-view'</span>

<span class="hljs-comment">// 段落拖拽锚点扩展</span>
<span class="hljs-keyword">const</span> <span class="hljs-title class_">NoteDragHandle</span> = <span class="hljs-title class_">Extension</span>.<span class="hljs-title function_">create</span>({
  <span class="hljs-attr">name</span>: <span class="hljs-string">'noteDragHandle'</span>,
  <span class="hljs-title function_">addProseMirrorPlugins</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> key = <span class="hljs-keyword">new</span> <span class="hljs-title class_">PluginKey</span>(<span class="hljs-string">'note-drag-handle'</span>)
    <span class="hljs-keyword">let</span> draggingPos = <span class="hljs-literal">null</span> <span class="hljs-comment">// 拖拽起点位置</span>
    
    <span class="hljs-comment">// 段落移动核心算法</span>
    <span class="hljs-keyword">function</span> <span class="hljs-title function_">moveParagraphAtPoint</span>(<span class="hljs-params">view, clientX, clientY</span>) {
      <span class="hljs-comment">// ... 移动逻辑</span>
    }
    
    <span class="hljs-keyword">return</span> [
      <span class="hljs-keyword">new</span> <span class="hljs-title class_">Plugin</span>({
        key,
        <span class="hljs-comment">// ... 插件配置</span>
      })
    ]
  }
})
</code></pre>
<h4 data-id="heading-11">2. 拖拽锚点装饰系统</h4>
<p>使用 ProseMirror 的 Decoration 系统为每个段落添加拖拽锚点：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 构建装饰（拖拽锚点）</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">buildDecorations</span>(<span class="hljs-params">doc, schema</span>) {
  <span class="hljs-keyword">const</span> decorations = []
  <span class="hljs-keyword">const</span> paragraphType = schema.<span class="hljs-property">nodes</span>.<span class="hljs-property">noteOutlineParagraph</span>
  
  doc.<span class="hljs-title function_">descendants</span>(<span class="hljs-function">(<span class="hljs-params">node, nodePos</span>) =&gt;</span> {
    <span class="hljs-keyword">if</span> (node.<span class="hljs-property">type</span> === paragraphType) {
      <span class="hljs-comment">// 为段落添加相对定位类</span>
      <span class="hljs-keyword">const</span> nodeDeco = <span class="hljs-title class_">Decoration</span>.<span class="hljs-title function_">node</span>(nodePos, nodePos + node.<span class="hljs-property">nodeSize</span>, {
        <span class="hljs-attr">class</span>: <span class="hljs-string">'has-note-drag-handle'</span>
      })
      decorations.<span class="hljs-title function_">push</span>(nodeDeco)
      
      <span class="hljs-comment">// 创建拖拽锚点元素</span>
      <span class="hljs-keyword">const</span> handle = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">'span'</span>)
      handle.<span class="hljs-property">className</span> = <span class="hljs-string">'note-outline-drag-handle'</span>
      handle.<span class="hljs-property">dataset</span>.<span class="hljs-property">pos</span> = <span class="hljs-title class_">String</span>(nodePos)
      handle.<span class="hljs-title function_">setAttribute</span>(<span class="hljs-string">'draggable'</span>, <span class="hljs-string">'true'</span>)
      handle.<span class="hljs-property">title</span> = <span class="hljs-string">'拖动以移动该段落'</span>
      handle.<span class="hljs-property">textContent</span> = <span class="hljs-string">'⋮⋮'</span>
      
      <span class="hljs-comment">// 将锚点作为 widget 挂载在段首</span>
      <span class="hljs-keyword">const</span> widget = <span class="hljs-title class_">Decoration</span>.<span class="hljs-title function_">widget</span>(nodePos + <span class="hljs-number">1</span>, handle, { <span class="hljs-attr">side</span>: -<span class="hljs-number">1</span> })
      decorations.<span class="hljs-title function_">push</span>(widget)
    }
    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>
  })
  
  <span class="hljs-keyword">return</span> <span class="hljs-title class_">DecorationSet</span>.<span class="hljs-title function_">create</span>(doc, decorations)
}
</code></pre>
<p><strong>关键点</strong>：</p>
<ul>
<li>使用 <code>Decoration.node</code> 为段落添加样式类</li>
<li>使用 <code>Decoration.widget</code> 在段首插入拖拽锚点</li>
<li>通过 <code>dataset.pos</code> 存储段落位置，便于后续定位</li>
</ul>
<h4 data-id="heading-12">3. 拖拽事件处理</h4>
<p>处理拖拽的各个阶段事件：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-attr">handleDOMEvents</span>: {
  <span class="hljs-comment">// 鼠标按下：初始化拖拽</span>
  <span class="hljs-attr">mousedown</span>: <span class="hljs-function">(<span class="hljs-params">view, event</span>) =&gt;</span> {
    <span class="hljs-keyword">const</span> target = event.<span class="hljs-property">target</span>
    <span class="hljs-keyword">if</span> (!target.<span class="hljs-property">classList</span>.<span class="hljs-title function_">contains</span>(<span class="hljs-string">'note-outline-drag-handle'</span>)) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>
    
    <span class="hljs-keyword">const</span> pos = <span class="hljs-title class_">Number</span>(target.<span class="hljs-property">dataset</span>.<span class="hljs-property">pos</span> || -<span class="hljs-number">1</span>)
    <span class="hljs-keyword">if</span> (pos &lt; <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>
    
    <span class="hljs-comment">// 选中整个段落节点</span>
    <span class="hljs-keyword">const</span> node = state.<span class="hljs-property">doc</span>.<span class="hljs-title function_">nodeAt</span>(pos)
    <span class="hljs-keyword">const</span> tr = state.<span class="hljs-property">tr</span>.<span class="hljs-title function_">setSelection</span>(<span class="hljs-title class_">NodeSelection</span>.<span class="hljs-title function_">create</span>(state.<span class="hljs-property">doc</span>, pos))
    view.<span class="hljs-title function_">dispatch</span>(tr)
    
    <span class="hljs-comment">// 记录拖拽起点</span>
    draggingPos = pos
    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>
  },
  
  <span class="hljs-comment">// 拖拽开始：设置拖拽预览</span>
  <span class="hljs-attr">dragstart</span>: <span class="hljs-function">(<span class="hljs-params">view, event</span>) =&gt;</span> {
    <span class="hljs-keyword">const</span> target = event.<span class="hljs-property">target</span>
    <span class="hljs-keyword">if</span> (!target.<span class="hljs-property">classList</span>.<span class="hljs-title function_">contains</span>(<span class="hljs-string">'note-outline-drag-handle'</span>)) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>
    
    <span class="hljs-keyword">const</span> pos = <span class="hljs-title class_">Number</span>(target.<span class="hljs-property">dataset</span>.<span class="hljs-property">pos</span> || -<span class="hljs-number">1</span>)
    <span class="hljs-keyword">const</span> nodeDom = view.<span class="hljs-title function_">nodeDOM</span>(pos)
    
    <span class="hljs-comment">// 克隆节点作为拖拽预览</span>
    <span class="hljs-keyword">const</span> clone = nodeDom.<span class="hljs-title function_">cloneNode</span>(<span class="hljs-literal">true</span>)
    clone.<span class="hljs-property">style</span>.<span class="hljs-property">position</span> = <span class="hljs-string">'fixed'</span>
    clone.<span class="hljs-property">style</span>.<span class="hljs-property">pointerEvents</span> = <span class="hljs-string">'none'</span>
    clone.<span class="hljs-property">style</span>.<span class="hljs-property">top</span> = <span class="hljs-string">'-10000px'</span>
    <span class="hljs-comment">// ... 设置样式</span>
    
    <span class="hljs-comment">// 设置拖拽预览图</span>
    event.<span class="hljs-property">dataTransfer</span>.<span class="hljs-title function_">setDragImage</span>(clone, <span class="hljs-number">8</span>, <span class="hljs-number">8</span>)
    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>
  },
  
  <span class="hljs-comment">// 拖拽悬停：允许放置</span>
  <span class="hljs-attr">dragover</span>: <span class="hljs-function">(<span class="hljs-params">view, event</span>) =&gt;</span> {
    <span class="hljs-keyword">if</span> (draggingPos != <span class="hljs-literal">null</span>) {
      event.<span class="hljs-title function_">preventDefault</span>()
      event.<span class="hljs-property">dataTransfer</span>.<span class="hljs-property">dropEffect</span> = <span class="hljs-string">'move'</span>
      <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>
    }
    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>
  },
  
  <span class="hljs-comment">// 放置：执行移动</span>
  <span class="hljs-attr">drop</span>: <span class="hljs-function">(<span class="hljs-params">view, event</span>) =&gt;</span> {
    <span class="hljs-keyword">if</span> (draggingPos == <span class="hljs-literal">null</span>) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>
    event.<span class="hljs-title function_">preventDefault</span>()
    <span class="hljs-title function_">moveParagraphAtPoint</span>(view, event.<span class="hljs-property">clientX</span>, event.<span class="hljs-property">clientY</span>)
    draggingPos = <span class="hljs-literal">null</span>
    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>
  }
}
</code></pre>
<h3 data-id="heading-13">🎯 段落移动算法</h3>
<h4 data-id="heading-14">核心移动逻辑</h4>
<p>段落移动的核心算法需要考虑多个因素：</p>
<ol>
<li><strong>子段落识别</strong>: 识别需要一起移动的子段落</li>
<li><strong>目标位置计算</strong>: 根据鼠标位置计算插入位置</li>
<li><strong>边界检查</strong>: 防止移动到无效位置</li>
</ol>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">moveParagraphAtPoint</span>(<span class="hljs-params">view, clientX, clientY</span>) {
  <span class="hljs-keyword">const</span> { state } = view
  <span class="hljs-keyword">const</span> rect = view.<span class="hljs-property">dom</span>.<span class="hljs-title function_">getBoundingClientRect</span>()
  
  <span class="hljs-comment">// 坐标限制在编辑器范围内</span>
  <span class="hljs-keyword">const</span> clampedX = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">max</span>(rect.<span class="hljs-property">left</span> + <span class="hljs-number">1</span>, <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">min</span>(clientX, rect.<span class="hljs-property">right</span> - <span class="hljs-number">1</span>))
  <span class="hljs-keyword">const</span> clampedY = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">max</span>(rect.<span class="hljs-property">top</span> + <span class="hljs-number">1</span>, <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">min</span>(clientY, rect.<span class="hljs-property">bottom</span> - <span class="hljs-number">1</span>))
  
  <span class="hljs-comment">// 获取鼠标位置对应的文档位置</span>
  <span class="hljs-keyword">const</span> posInfo = view.<span class="hljs-title function_">posAtCoords</span>({ <span class="hljs-attr">left</span>: clampedX, <span class="hljs-attr">top</span>: clampedY })
  <span class="hljs-keyword">if</span> (!posInfo) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>
  
  <span class="hljs-keyword">const</span> $from = state.<span class="hljs-property">doc</span>.<span class="hljs-title function_">resolve</span>(draggingPos)
  <span class="hljs-keyword">const</span> sourceIndex = $from.<span class="hljs-title function_">index</span>(<span class="hljs-number">0</span>)
  <span class="hljs-keyword">const</span> sourceNode = state.<span class="hljs-property">doc</span>.<span class="hljs-title function_">child</span>(sourceIndex)
  <span class="hljs-keyword">const</span> sourceLevel = sourceNode.<span class="hljs-property">attrs</span>.<span class="hljs-property">level</span> || <span class="hljs-number">0</span>
  
  <span class="hljs-comment">// 计算目标位置</span>
  <span class="hljs-keyword">const</span> $pos = state.<span class="hljs-property">doc</span>.<span class="hljs-title function_">resolve</span>(posInfo.<span class="hljs-property">pos</span>)
  <span class="hljs-keyword">let</span> targetIndex = $pos.<span class="hljs-title function_">index</span>(<span class="hljs-number">0</span>)
  
  <span class="hljs-comment">// 判断是插入在段落上方还是下方</span>
  <span class="hljs-keyword">const</span> domAt = view.<span class="hljs-title function_">nodeDOM</span>($pos.<span class="hljs-title function_">before</span>(<span class="hljs-number">1</span>))
  <span class="hljs-keyword">let</span> insertAfter = <span class="hljs-literal">false</span>
  <span class="hljs-keyword">if</span> (domAt) {
    <span class="hljs-keyword">const</span> tRect = domAt.<span class="hljs-title function_">getBoundingClientRect</span>()
    <span class="hljs-keyword">const</span> midY = tRect.<span class="hljs-property">top</span> + tRect.<span class="hljs-property">height</span> / <span class="hljs-number">2</span>
    insertAfter = clampedY &gt;= midY
  }
  
  <span class="hljs-comment">// 查找所有需要移动的子段落</span>
  <span class="hljs-keyword">let</span> moveCount = <span class="hljs-number">1</span> <span class="hljs-comment">// 至少移动源段落本身</span>
  <span class="hljs-keyword">let</span> nextIndex = sourceIndex + <span class="hljs-number">1</span>
  
  <span class="hljs-keyword">while</span> (nextIndex &lt; state.<span class="hljs-property">doc</span>.<span class="hljs-property">childCount</span>) {
    <span class="hljs-keyword">const</span> nextNode = state.<span class="hljs-property">doc</span>.<span class="hljs-title function_">child</span>(nextIndex)
    <span class="hljs-keyword">if</span> (nextNode.<span class="hljs-property">type</span>.<span class="hljs-property">name</span> === <span class="hljs-string">'noteOutlineParagraph'</span>) {
      <span class="hljs-keyword">const</span> nextLevel = nextNode.<span class="hljs-property">attrs</span>.<span class="hljs-property">level</span> || <span class="hljs-number">0</span>
      <span class="hljs-comment">// 如果下一段落的层级大于源段落，说明是子段落</span>
      <span class="hljs-keyword">if</span> (nextLevel &gt; sourceLevel) {
        moveCount++
        nextIndex++
      } <span class="hljs-keyword">else</span> {
        <span class="hljs-keyword">break</span> <span class="hljs-comment">// 遇到同级或更高级的段落，停止查找</span>
      }
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-keyword">break</span>
    }
  }
  
  <span class="hljs-comment">// 检查目标位置是否在移动范围内</span>
  <span class="hljs-keyword">if</span> (!insertAfter &amp;&amp; targetIndex &gt;= sourceIndex &amp;&amp; targetIndex &lt; sourceIndex + moveCount) {
    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span> <span class="hljs-comment">// 不需要移动</span>
  }
  
  <span class="hljs-comment">// 执行移动操作</span>
  <span class="hljs-keyword">const</span> children = []
  state.<span class="hljs-property">doc</span>.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">child</span>) =&gt;</span> {
    children.<span class="hljs-title function_">push</span>(child)
  })
  
  <span class="hljs-comment">// 移除源段落及其子段落</span>
  <span class="hljs-keyword">const</span> movedParagraphs = children.<span class="hljs-title function_">splice</span>(sourceIndex, moveCount)
  
  <span class="hljs-comment">// 计算目标插入位置</span>
  <span class="hljs-keyword">let</span> destIndex = targetIndex
  <span class="hljs-keyword">if</span> (sourceIndex &lt; targetIndex) {
    destIndex -= moveCount <span class="hljs-comment">// 调整目标位置</span>
  }
  
  <span class="hljs-comment">// 在目标位置插入</span>
  <span class="hljs-keyword">if</span> (insertAfter) {
    children.<span class="hljs-title function_">splice</span>(destIndex + <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, ...movedParagraphs)
  } <span class="hljs-keyword">else</span> {
    children.<span class="hljs-title function_">splice</span>(destIndex, <span class="hljs-number">0</span>, ...movedParagraphs)
  }
  
  <span class="hljs-comment">// 创建新文档并应用变更</span>
  <span class="hljs-keyword">const</span> newDoc = state.<span class="hljs-property">doc</span>.<span class="hljs-property">type</span>.<span class="hljs-title function_">create</span>(state.<span class="hljs-property">doc</span>.<span class="hljs-property">attrs</span>, <span class="hljs-title class_">Fragment</span>.<span class="hljs-title function_">from</span>(children))
  <span class="hljs-keyword">const</span> tr = state.<span class="hljs-property">tr</span>.<span class="hljs-title function_">replaceWith</span>(<span class="hljs-number">0</span>, state.<span class="hljs-property">doc</span>.<span class="hljs-property">content</span>.<span class="hljs-property">size</span>, newDoc.<span class="hljs-property">content</span>)
  view.<span class="hljs-title function_">dispatch</span>(tr.<span class="hljs-title function_">scrollIntoView</span>())
  <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>
}
</code></pre>
<p><strong>算法要点</strong>：</p>
<ul>
<li><strong>子段落识别</strong>: 通过比较 <code>level</code> 属性识别子段落</li>
<li><strong>位置计算</strong>: 根据鼠标 Y 坐标判断插入位置（上方/下方）</li>
<li><strong>边界处理</strong>: 防止移动到自身范围内</li>
<li><strong>文档重建</strong>: 使用 Fragment 重建文档结构</li>
</ul>
<h3 data-id="heading-15">🌐 全局事件处理</h3>
<p>为了支持拖拽到编辑器外的区域（如侧边栏），需要监听全局事件：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-title function_">view</span>(<span class="hljs-params">editorView</span>) {
  <span class="hljs-keyword">let</span> lastPoint = <span class="hljs-literal">null</span>
  
  <span class="hljs-comment">// 全局放置事件</span>
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">onDocDrop</span> = (<span class="hljs-params">e</span>) =&gt; {
    <span class="hljs-keyword">if</span> (draggingPos == <span class="hljs-literal">null</span>) <span class="hljs-keyword">return</span>
    e.<span class="hljs-title function_">preventDefault</span>()
    <span class="hljs-title function_">moveParagraphAtPoint</span>(editorView, e.<span class="hljs-property">clientX</span>, e.<span class="hljs-property">clientY</span>)
    draggingPos = <span class="hljs-literal">null</span>
  }
  
  <span class="hljs-comment">// 全局拖拽悬停事件</span>
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">onDocDragOver</span> = (<span class="hljs-params">e</span>) =&gt; {
    <span class="hljs-keyword">if</span> (draggingPos == <span class="hljs-literal">null</span>) <span class="hljs-keyword">return</span>
    e.<span class="hljs-title function_">preventDefault</span>()
    lastPoint = { <span class="hljs-attr">x</span>: e.<span class="hljs-property">clientX</span>, <span class="hljs-attr">y</span>: e.<span class="hljs-property">clientY</span> }
  }
  
  <span class="hljs-comment">// 全局拖拽结束事件（兜底处理）</span>
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">onDocDragEnd</span> = (<span class="hljs-params"/>) =&gt; {
    <span class="hljs-keyword">if</span> (draggingPos != <span class="hljs-literal">null</span> &amp;&amp; lastPoint) {
      <span class="hljs-comment">// 如果没有触发 drop，也在 dragend 时执行移动</span>
      <span class="hljs-title function_">moveParagraphAtPoint</span>(editorView, lastPoint.<span class="hljs-property">x</span>, lastPoint.<span class="hljs-property">y</span>)
    }
    draggingPos = <span class="hljs-literal">null</span>
    lastPoint = <span class="hljs-literal">null</span>
  }
  
  <span class="hljs-comment">// 注册全局事件监听</span>
  <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'drop'</span>, onDocDrop)
  <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'dragover'</span>, onDocDragOver)
  <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'dragend'</span>, onDocDragEnd)
  
  <span class="hljs-keyword">return</span> {
    <span class="hljs-title function_">destroy</span>(<span class="hljs-params"/>) {
      <span class="hljs-comment">// 清理事件监听</span>
      <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">removeEventListener</span>(<span class="hljs-string">'drop'</span>, onDocDrop)
      <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">removeEventListener</span>(<span class="hljs-string">'dragover'</span>, onDocDragOver)
      <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">removeEventListener</span>(<span class="hljs-string">'dragend'</span>, onDocDragEnd)
    }
  }
}
</code></pre>
<p><strong>关键点</strong>：</p>
<ul>
<li>使用 <code>document</code> 级别的事件监听，覆盖整个页面</li>
<li>在 <code>dragend</code> 中兜底处理，确保即使没有触发 <code>drop</code> 也能完成移动</li>
<li>在插件销毁时清理事件监听，避免内存泄漏</li>
</ul>
<h3 data-id="heading-16">🎨 样式设计</h3>
<p>拖拽锚点的样式设计需要考虑用户体验：</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// 拖拽锚点样式</span>
<span class="hljs-selector-class">.note-outline-drag-handle</span> {
  <span class="hljs-attribute">width</span>: <span class="hljs-number">12px</span>;
  <span class="hljs-attribute">height</span>: <span class="hljs-number">12px</span>;
  <span class="hljs-attribute">cursor</span>: grab <span class="hljs-meta">!important</span>;
  <span class="hljs-attribute">font-size</span>: <span class="hljs-number">10px</span>;
  <span class="hljs-attribute">color</span>: <span class="hljs-built_in">var</span>(--text-mute, <span class="hljs-number">#999</span>);
  <span class="hljs-attribute">display</span>: flex;
  <span class="hljs-attribute">align-items</span>: center;
  <span class="hljs-attribute">justify-content</span>: center;
  user-select: none;
  
  <span class="hljs-comment">// 悬停时显示</span>
  &amp;<span class="hljs-selector-pseudo">:hover</span> {
    <span class="hljs-attribute">cursor</span>: grab <span class="hljs-meta">!important</span>;
    <span class="hljs-attribute">color</span>: <span class="hljs-built_in">var</span>(--text-base, <span class="hljs-number">#333</span>);
  }
  
  <span class="hljs-comment">// 拖拽时显示抓取手势</span>
  &amp;<span class="hljs-selector-pseudo">:active</span> {
    <span class="hljs-attribute">cursor</span>: grabbing <span class="hljs-meta">!important</span>;
  }
}

<span class="hljs-comment">// 段落悬停时显示拖拽锚点</span>
<span class="hljs-selector-tag">p</span><span class="hljs-selector-attr">[data-note-outline]</span><span class="hljs-selector-pseudo">:hover</span> {
  <span class="hljs-selector-class">.note-outline-drag-handle</span> {
    <span class="hljs-attribute">opacity</span>: <span class="hljs-number">1</span>;
    <span class="hljs-attribute">pointer-events</span>: auto;
  }
}
</code></pre>
<h3 data-id="heading-17">🎯 技术亮点总结</h3>
<h4 data-id="heading-18">1. 基于 ProseMirror 插件系统</h4>
<ul>
<li><strong>扩展性强</strong>: 通过 Extension 机制，易于集成和维护</li>
<li><strong>性能优秀</strong>: 利用 ProseMirror 的文档模型，移动操作高效</li>
<li><strong>状态管理</strong>: 自动处理文档变更和装饰更新</li>
</ul>
<h4 data-id="heading-19">2. 子段落联动机制</h4>
<ul>
<li><strong>智能识别</strong>: 自动识别子段落（通过 level 属性）</li>
<li><strong>批量移动</strong>: 父段落移动时，所有子段落一起移动</li>
<li><strong>结构保持</strong>: 保持段落层级关系不变</li>
</ul>
<h4 data-id="heading-20">3. 全局事件支持</h4>
<ul>
<li><strong>跨区域拖拽</strong>: 支持拖拽到编辑器外的区域</li>
<li><strong>兜底处理</strong>: 在 dragend 中处理未触发 drop 的情况</li>
<li><strong>事件清理</strong>: 插件销毁时自动清理事件监听</li>
</ul>
<h4 data-id="heading-21">4. 用户体验优化</h4>
<ul>
<li><strong>视觉反馈</strong>: 拖拽时显示段落预览</li>
<li><strong>精确定位</strong>: 根据鼠标位置判断插入位置</li>
<li><strong>边界保护</strong>: 防止移动到无效位置</li>
</ul>
<h3 data-id="heading-22">🔮 总结与展望</h3>
<p>本文详细介绍了在小说写作软件的笔记编辑器中实现段落拖拽移动功能的技术方案。通过 ProseMirror 的插件系统、Decoration 装饰系统和精心设计的移动算法，我们实现了一个功能完善、用户体验优秀的段落重排功能。</p>
<h4 data-id="heading-23">技术优势</h4>
<ul>
<li>✅ <strong>基于标准</strong>: 使用 ProseMirror 标准 API，稳定可靠</li>
<li>✅ <strong>性能优秀</strong>: 利用文档模型，移动操作高效</li>
<li>✅ <strong>扩展性强</strong>: 易于扩展和维护</li>
<li>✅ <strong>用户友好</strong>: 直观的拖拽操作，支持子段落联动</li>
</ul>
<h4 data-id="heading-24">未来优化方向</h4>
<ul>
<li>🔮 <strong>动画效果</strong>: 添加平滑的移动动画</li>
<li>🔮 <strong>多选拖拽</strong>: 支持同时拖拽多个段落</li>
<li>🔮 <strong>撤销重做</strong>: 优化撤销重做机制</li>
<li>🔮 <strong>键盘快捷键</strong>: 支持键盘快捷键移动段落</li>
</ul>
<p>通过这套技术方案，我们为小说创作者提供了一个强大而直观的段落重排工具，大大提升了笔记整理的效率。</p>
<hr/>
<h4 data-id="heading-25">📚 相关链接</h4>
<ul>
<li><strong>项目地址</strong>: <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fxiaoshengxianjun%2F51mazi" target="_blank" title="https://github.com/xiaoshengxianjun/51mazi" ref="nofollow noopener noreferrer">GitHub - 51mazi</a>，给个 Star 哦~</li>
<li><strong>TipTap 官网</strong>: <a href="https://link.juejin.cn?target=https%3A%2F%2Ftiptap.dev" target="_blank" title="https://tiptap.dev" ref="nofollow noopener noreferrer">tiptap.dev</a></li>
<li><strong>ProseMirror 文档</strong>: <a href="https://link.juejin.cn?target=https%3A%2F%2Fprosemirror.net" target="_blank" title="https://prosemirror.net" ref="nofollow noopener noreferrer">prosemirror.net</a></li>
</ul>
<h4 data-id="heading-26">🏷️ 标签</h4>
<p><code>#ProseMirror</code> <code>#TipTap</code> <code>#段落拖拽</code> <code>#Vue3</code> <code>#Electron</code> <code>#小说写作</code> <code>#富文本编辑</code> <code>#前端开发</code></p>
<hr/>
<blockquote>
<p>💡 <strong>如果这篇文章对你有帮助，请给个 ⭐️ 支持一下！</strong></p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Charles抓包在复杂系统中的应用，高难度问题的诊断与验证方法]]></title>    <link>https://juejin.cn/post/7575412016405430282</link>    <guid>https://juejin.cn/post/7575412016405430282</guid>    <pubDate>2025-11-24T02:01:34.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7575412016405430282" data-draft-id="7575456858428031022" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Charles抓包在复杂系统中的应用，高难度问题的诊断与验证方法"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-11-24T02:01:34.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="bcbnb"/> <meta itemprop="url" content="https://juejin.cn/user/895474073078377"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Charles抓包在复杂系统中的应用，高难度问题的诊断与验证方法
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/895474073078377/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    bcbnb
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-24T02:01:34.000Z" title="Mon Nov 24 2025 02:01:34 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>当一个系统开始变得复杂，问题就很难再从代码层面简单判断。
你会遇到：</p>
<ul>
<li>明明相同请求，却在不同用户设备上表现不同</li>
<li>后端日志显示正常，但前端页面依旧失败</li>
<li>移动端接口偶发性返回错误，无法复现</li>
<li>多环境共存导致数据来源混乱</li>
<li>某些请求延迟极高，却找不到瓶颈点</li>
</ul>
<p>这些问题并不是简单“看接口文档”就能解决的。
要找到真正原因，你需要看到系统真实工作时的 <strong>网络行为</strong>——而 Charles 抓包，就是这样一种能够直接呈现“真实链路”的工具。</p>
<p>抓包的意义不只是查看请求，而是：<strong>把复杂系统的行为拆成可理解、可验证、可排查的片段。</strong></p>
<hr/>
<h2 data-id="heading-0">一、复杂问题为什么必须依赖抓包？</h2>
<p>在工程实践中，问题难排查往往因为：</p>
<ul>
<li>行为不可见</li>
<li>流程不可控</li>
<li>请求不可预测</li>
<li>环境不可确认</li>
</ul>
<p>而 Charles 抓包能让这些“不可见”变成“可视化”。</p>
<p>它能告诉你：</p>
<ul>
<li>系统到底发出了哪些网络请求</li>
<li>每条请求的发起、等待、响应是否正常</li>
<li>请求是否被篡改、缓存或代理影响</li>
<li>请求真正到达的服务器是哪一台</li>
<li>HTTPS 握手是否稳定</li>
<li>是否被网络中间层过滤</li>
</ul>
<p>这些信息直接决定了你能否快速定位一个高难度问题。</p>
<hr/>
<h2 data-id="heading-1">二、Charles 在复杂系统中的三类关键作用</h2>
<p>在多层架构、多环境系统中，抓包通常用于以下三类目标。</p>
<hr/>
<h3 data-id="heading-2"><strong>① 验证系统行为是否符合预期</strong></h3>
<p>例如：</p>
<ul>
<li>前端是否正确触发接口</li>
<li>App 是否重复发送请求</li>
<li>环境切换是否生效</li>
<li>请求链路是否异常跳转</li>
</ul>
<p>Sequence 视图能清楚展示请求顺序，有助于复盘用户行为。</p>
<hr/>
<h3 data-id="heading-3"><strong>② 判断链路延迟与失败点</strong></h3>
<p>不是所有“慢”都是后端慢。
Timeline 会告诉你延迟发生在：</p>
<ul>
<li>DNS</li>
<li>SSL</li>
<li>网络传输</li>
<li>服务端处理</li>
<li>下载阶段</li>
</ul>
<p>这一点在移动端尤为重要，因为弱网经常导致误判。</p>
<hr/>
<h3 data-id="heading-4"><strong>③ 还原真实数据流转过程</strong></h3>
<p>包括：</p>
<ul>
<li>参数是否经过中间层修改</li>
<li>Token 是否失效</li>
<li>Header 是否被过滤</li>
<li>Body 是否被压缩或编码</li>
<li>响应内容是否被缓存命中</li>
</ul>
<p>这些都是日志无法完全呈现的内容。</p>
<hr/>
<h2 data-id="heading-5">三、移动端复杂问题：Charles 的绝对优势</h2>
<p>许多高难度问题集中在移动端，而非 Web：</p>
<ul>
<li>不同品牌设备处理网络方式不同</li>
<li>Wi-Fi/4G/5G 网络变化频繁</li>
<li>App 会因后台机制中断请求</li>
<li>SSL Pinning 阻止抓包</li>
<li>移动端代理链路更复杂</li>
</ul>
<p>Charles 抓包对移动端的价值几乎是不可替代的。</p>
<h3 data-id="heading-6"><strong>典型移动端调试场景包括：</strong></h3>
<ul>
<li>登录流程偶发失败</li>
<li>Token 过期与刷新链路不一致</li>
<li>多接口并发触发顺序不同</li>
<li>App 在弱网条件下提前取消请求</li>
</ul>
<p>配合 Throttle（弱网模拟），甚至能复现用户极端环境下的行为</p>
<hr/>
<h2 data-id="heading-7">四、复杂问题诊断：Charles 的实际应用策略</h2>
<p>下面是一些真实项目中验证有效的方法。</p>
<hr/>
<h3 data-id="heading-8"><strong>① 请求参数“看似正确”，但链路中被修改</strong></h3>
<p>例如：</p>
<ul>
<li>API 网关自动格式化某些 Header</li>
<li>Nginx 自动添加或替换字段</li>
<li>App 二次封装导致编码错误</li>
</ul>
<p>通过 Charles 的 Raw 视图可以验证真正发送的内容。</p>
<p>这能避免前后端之间的参数争议。</p>
<hr/>
<h3 data-id="heading-9"><strong>② 多环境配置混乱导致数据异常</strong></h3>
<p>非常常见的情况：
开发环境 → 测试环境 → 预发布环境 → 生产环境</p>
<p>Charles 可以看到：</p>
<ul>
<li>请求到底到了哪个域名</li>
<li>是否被内部代理中转</li>
<li>是否发生了意外的重定向</li>
</ul>
<p>这类问题没有抓包几乎无法调查。</p>
<hr/>
<h3 data-id="heading-10"><strong>③ 页面加载慢，但不是后端性能问题</strong></h3>
<p>通过 Timeline 可以发现：</p>
<ul>
<li>DNS 慢</li>
<li>SSL 握手慢</li>
<li>客户端发送数据慢</li>
<li>网络环境造成传输延迟</li>
</ul>
<p>这类问题常被误判为“后端慢”。</p>
<p>实际原因可能是：</p>
<ul>
<li>CDN 路由异常</li>
<li>运营商网络抖动</li>
<li>移动端网络切换</li>
</ul>
<p>Charles 在链路分析中非常关键。</p>
<hr/>
<h3 data-id="heading-11"><strong>④ App 弱网场景下异常行为</strong></h3>
<p>使用 Throttle 模拟：</p>
<ul>
<li>3G</li>
<li>高延迟</li>
<li>随机丢包</li>
</ul>
<p>你会发现：</p>
<ul>
<li>某些请求会被 App 直接取消</li>
<li>某些 UI 动画导致请求中断</li>
<li>Token 刷新会变得不稳定</li>
</ul>
<p>这些都是用户真实会遇到的问题。</p>
<hr/>
<h2 data-id="heading-12">五、团队协作方式：如何让抓包提升整体效率？</h2>
<p>Charles 在团队中能扮演 “问题复现器” 的角色。</p>
<h3 data-id="heading-13"><strong>① 测试导出 .chls 文件</strong></h3>
<p>开发者只需导入即可 100% 重现用户问题。</p>
<h3 data-id="heading-14"><strong>② 前端使用 Mock 简化联调</strong></h3>
<p>Map Local 与 Rewrite 能显著提高效率。</p>
<h3 data-id="heading-15"><strong>③ 后端分析错误链路与代理行为</strong></h3>
<p>特别适合处理 Nginx / API Gateway / CDN 问题。</p>
<h3 data-id="heading-16"><strong>④ 移动端用于复现离散行为</strong></h3>
<p>例如间歇性失败、请求中断等。</p>
<hr/>
<h2 data-id="heading-17">六、抓包失败的常见原因与规避策略</h2>



































<table><thead><tr><th>问题</th><th>原因</th><th>解决方法</th></tr></thead><tbody><tr><td>HTTPS 无内容</td><td>SSL 证书未信任</td><td>重新安装 CA、启用 SSL Proxy</td></tr><tr><td>手机抓不到请求</td><td>Wi-Fi 不同网段</td><td>手动配置代理并检查 IP</td></tr><tr><td>抓包乱码</td><td>内容被压缩</td><td>开启解压缩功能</td></tr><tr><td>App 报安全错误</td><td>SSL Pinning</td><td>使用调试包或关闭 Pinning</td></tr><tr><td>请求消失</td><td>系统代理被其他软件覆盖</td><td>重启 Charles 并关闭冲突工具</td></tr></tbody></table>
<hr/>
<h2 data-id="heading-18">七、更多完整操作步骤</h2>
<p>可参考：<strong><a href="https://link.juejin.cn?target=https%3A%2F%2Fcharlesproxy.net%2F" target="_blank" title="https://charlesproxy.net/" ref="nofollow noopener noreferrer">Charles中文网</a></strong></p>
<p>提供：</p>
<ul>
<li>抓包流程图解</li>
<li>HTTPS 证书配置</li>
<li>手机抓包教程</li>
<li>Rewrite / Map Local 示例</li>
<li>常见问题排查逻辑</li>
</ul>
<hr/>
<h2 data-id="heading-19">抓包，是理解系统的最底层能力</h2>
<p>一个熟练使用 Charles 的工程师，往往比单纯会写代码的工程师更快找到根因。</p>
<p>因为抓包让你看清：</p>
<ul>
<li>请求路径</li>
<li>链路行为</li>
<li>参数传输</li>
<li>网络异常</li>
<li>环境偏差</li>
</ul>
<p>这些因素往往才是复杂问题的核心。</p>
<blockquote>
<p>Charles 真正带来的不是技能，而是洞察系统的能力。</p>
</blockquote>
<p>只要掌握抓包，系统就不再是黑箱。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Cursor 2.1 发布实测：计划能点了，审查能用了，CR 花多少？我也替你试了]]></title>    <link>https://juejin.cn/post/7575651989985591350</link>    <guid>https://juejin.cn/post/7575651989985591350</guid>    <pubDate>2025-11-24T02:02:58.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7575651989985591350" data-draft-id="7575751471841476644" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Cursor 2.1 发布实测：计划能点了，审查能用了，CR 花多少？我也替你试了"/> <meta itemprop="keywords" content="Cursor,AI编程,人工智能"/> <meta itemprop="datePublished" content="2025-11-24T02:02:58.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="飞哥数智谈"/> <meta itemprop="url" content="https://juejin.cn/user/3825956195409223"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Cursor 2.1 发布实测：计划能点了，审查能用了，CR 花多少？我也替你试了
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3825956195409223/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    飞哥数智谈
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-24T02:02:58.000Z" title="Mon Nov 24 2025 02:02:58 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>21号，<code>Cursor</code> 升级了 <code>2.1</code> 版本，给大家简单同步下升级内容。</p>
<h2 data-id="heading-0">改进的计划模式</h2>
<p>流程和定位没有改变，最大的改变是交互方式的优化。</p>
<p>原来的 <code>Plan</code> 模式是 <code>Cursor</code> 给出问题和带序号的答案，你可以响应问题题号和答案的序号，比如：<code>1:A,2:B</code>。</p>
<p>这次升级后，就不用手动录入了，直接通过<strong>图形交互</strong>点击选项即可。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/df240a005234462b8b658c6cba326122~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aOe5ZOl5pWw5pm66LCI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764554578&amp;x-signature=BZldWDZxOcHywR%2FRkI%2BnaO6s5iU%3D" alt="" loading="lazy"/></p>
<p>并且支持了多轮问答，这样生成的计划会更加准确和符合预期。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6b01bd6e574c461cb5a0d9392a2021b8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aOe5ZOl5pWw5pm66LCI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764554578&amp;x-signature=9hE4I9xfh6V4Ykqo3Q7YEbcxvRw%3D" alt="" loading="lazy"/></p>
<p>全部分析完成后，就会生成分析文档和计划，确认无误后，可以点击“Build”开始生成。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/514a5c2cc29440259f157fa9e76b0ea8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aOe5ZOl5pWw5pm66LCI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764554578&amp;x-signature=ZwubKZQxyV1qIszXwgdNGsvs%2FNI%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-1">AI 代码审查</h2>
<p>这个功能之前版本已经开始逐步上线，这次算是正式推出吧。</p>
<p>我现在使用 AI 协同研发的时候，AI 生成的代码是通过“<strong>人工</strong>”+“<strong>AI Commit Message</strong>”进行审查的。</p>
<p>现在可以直接使用 <code>AI Code Reviews</code> 进行了。</p>
<h3 data-id="heading-2">入口</h3>
<p><code>Agent Review</code> 有两个入口：</p>
<ul>
<li>一个是在生成结果最后的 <code>agent diff</code> 处。</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1822c3f938ba4d369bb812d0ed57280d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aOe5ZOl5pWw5pm66LCI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764554578&amp;x-signature=bi7tefD5yTQ8VY2aHNSC31ivmNg%3D" alt="" loading="lazy"/></p>
<ul>
<li>另一个是 <code>Source Control</code> 选项卡的 <code>Agent Review</code>。</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ed13a5dc36384ec690a2aca6bc6e9cd0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aOe5ZOl5pWw5pm66LCI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764554578&amp;x-signature=rIp%2ByfHkoQp1TyQTSuAYUpShOzo%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-3">Review 的效果</h3>
<p><code>Review</code> 后的效果如下。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2389eef2c60a4487b6d139cfe987b9f1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aOe5ZOl5pWw5pm66LCI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764554578&amp;x-signature=lKco8PGtWJ2GiPUSiJwhLJHAPPk%3D" alt="" loading="lazy"/></p>
<p>可以直接看到 AI 帮你找到的 <code>Issue</code>，支持单个修复，也支持一键全部修复。</p>
<h3 data-id="heading-4">计费方式</h3>
<p>按照 <code>Review</code> 中的<strong>实际使用量计费</strong>的。</p>
<p>我帮大家测试了一下，18 个前端文件 <code>Review</code> 了一次，<code>86.6</code>万 Token，<code>0.23</code>美元，不便宜呀，大家按需使用。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c1c6256dfbe543a89c94b67f31c09278~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aOe5ZOl5pWw5pm66LCI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764554578&amp;x-signature=htlnsY5Mb%2FBrMLJiVvhrZkfnyzk%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-5">即时grep</h2>
<p>我理解的是编辑器内手动搜索，或者模型在调用 <code>grep</code> 命令时，会触发“即时grep”的特性。</p>
<p>该特性可以提供一个<strong>超快的搜索功能</strong>，让你快速定位要找的文件，不需等待扫描整个代码库。</p>
<p>我问了 <code>Composer 1</code>，底层应该是集成了 <code>ripgrep</code>。</p>
<h2 data-id="heading-6">移除自定义智能体</h2>
<p>自定义 Agent 模式被移除，如果想用的话，可以使用<strong>自定义命令</strong>。</p>
<p>前几天刚实现的自定义智能体还得改下。</p>
<h2 data-id="heading-7">结语</h2>
<p>这次升级没有特别大的调整，但功能倒是挺实用的，大家可以酌情试用。</p>
<p>有什么疑问欢迎留言交流~</p>
<p>明天周一，加油！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[JavaScript 闭包通关指南：从作用域链到内存管理的8个核心知识点]]></title>    <link>https://juejin.cn/post/7575363120799088640</link>    <guid>https://juejin.cn/post/7575363120799088640</guid>    <pubDate>2025-11-24T00:16:59.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7575363120799088640" data-draft-id="7575363120799072256" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="JavaScript 闭包通关指南：从作用域链到内存管理的8个核心知识点"/> <meta itemprop="keywords" content="后端,前端,人工智能"/> <meta itemprop="datePublished" content="2025-11-24T00:16:59.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="IT_陈寒"/> <meta itemprop="url" content="https://juejin.cn/user/1638743356481367"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            JavaScript 闭包通关指南：从作用域链到内存管理的8个核心知识点
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1638743356481367/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    IT_陈寒
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-24T00:16:59.000Z" title="Mon Nov 24 2025 00:16:59 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0"><strong>JavaScript 闭包通关指南：从作用域链到内存管理的8个核心知识点</strong></h2>
<h2 data-id="heading-1">引言</h2>
<p>闭包（Closure）是 JavaScript 中最强大且最容易被误解的概念之一。它不仅是面试中的高频考点，更是实际开发中解决复杂问题的利器。理解闭包不仅需要掌握作用域链、执行上下文等基础概念，还需要深入思考内存管理、性能优化等高级话题。</p>
<p>本文将系统性地拆解闭包的8个核心知识点，从作用域链的底层机制到内存泄漏的实战排查，带你彻底掌握这一重要概念。无论你是初学者还是有一定经验的开发者，都能从中获得新的启发。</p>
<hr/>
<h2 data-id="heading-2">一、作用域链：闭包的理论基石</h2>
<h3 data-id="heading-3">1.1 词法作用域 vs 动态作用域</h3>
<p>JavaScript 采用的是词法作用域（Lexical Scope），这意味着变量的可访问性在代码编写阶段就已经确定。这与动态作用域语言（如 Bash）形成鲜明对比：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">outer</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> x = <span class="hljs-string">'outer'</span>;
  
  <span class="hljs-keyword">function</span> <span class="hljs-title function_">inner</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(x); <span class="hljs-comment">// "outer"（词法作用域）</span>
  }
  
  <span class="hljs-title function_">inner</span>();
}

<span class="hljs-keyword">const</span> x = <span class="hljs-string">'global'</span>;
<span class="hljs-title function_">outer</span>();
</code></pre>
<h3 data-id="heading-4">1.2 [[Scope]]内部属性</h3>
<p>每个函数在创建时都会记录自己的[[Scope]]内部属性，这是一个指向当前执行环境变量对象的引用链。这是理解闭包的关键：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">createCounter</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">let</span> count = <span class="hljs-number">0</span>;
  
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> ++count;
  };
}

<span class="hljs-keyword">const</span> counter = <span class="hljs-title function_">createCounter</span>();
<span class="hljs-comment">// counter.[[Scope]] -&gt; [createCounter的变量对象, global变量对象]</span>
</code></pre>
<hr/>
<h2 data-id="heading-5">二、执行上下文与闭包的形成</h2>
<h3 data-id="heading-6">2.1 EC/VO/AO三件套</h3>
<p>当函数执行时会创建：</p>
<ul>
<li>EC（Execution Context）：执行上下文</li>
<li>VO（Variable Object）：变量对象（全局环境下）</li>
<li>AO（Activation Object）：活动对象（函数环境下）</li>
</ul>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">foo</span>(<span class="hljs-params">a</span>) {
  <span class="hljs-keyword">var</span> b = a * <span class="hljs-number">2</span>;
  
  <span class="hljs-keyword">function</span> <span class="hljs-title function_">bar</span>(<span class="hljs-params">c</span>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(a, b, c);
  }
  
  <span class="hljs-title function_">bar</span>(b * <span class="hljs-number">3</span>);
}

<span class="hljs-title function_">foo</span>(<span class="hljs-number">2</span>); <span class="hljs-comment">// EC栈的变化过程值得深入研究</span>
</code></pre>
<h3 data-id="heading-7">2.2 Closure的形成时机</h3>
<p>严格来说，<strong>所有JavaScript函数都是闭包</strong>，因为它们都持有[[Scope]]引用。但我们通常讨论的是那些：</p>
<ol>
<li>访问了外层变量的内层函数</li>
<li>被外部引用的内层函数</li>
</ol>
<hr/>
<h2 data-id="heading-8">III. IIFE模式与模块化</h2>
<h3 data-id="heading-9">III.I Immediately Invoked Function Expression</h3>
<p>IIFE是早期实现模块化的利器：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> <span class="hljs-variable language_">module</span> = (<span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> privateVar = <span class="hljs-string">'secret'</span>;
  
  <span class="hljs-keyword">return</span> {
    <span class="hljs-attr">getSecret</span>: <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
      <span class="hljs-keyword">return</span> privateVar;
    }
  };
})();
</code></pre>
<h3 data-id="heading-10">III.II ES6之前的模块模拟</h3>
<p>通过组合IIFE和闭包可以实现完整的模块系统：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">var</span> <span class="hljs-title class_">MyModule</span> = (<span class="hljs-keyword">function</span> <span class="hljs-title function_">Manager</span>(<span class="hljs-params"/>) {
	<span class="hljs-keyword">var</span> modules = {};
	
	<span class="hljs-keyword">function</span> <span class="hljs-title function_">define</span>(<span class="hljs-params">name, deps, impl</span>) {
		<span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i=<span class="hljs-number">0</span>; i&lt;deps.<span class="hljs-property">length</span>; i++) {
			deps[i] = modules[deps[i]];
		}
		modules[name] = impl.<span class="hljs-title function_">apply</span>(impl, deps);
	}
	
	<span class="hljs-keyword">function</span> <span class="hljs-title function_">get</span>(<span class="hljs-params">name</span>) {
		<span class="hljs-keyword">return</span> modules[name];
	}
	
	<span class="hljs-keyword">return</span> { define, get };
})();
</code></pre>
<hr/>
<h2 data-id="heading-11">IV.  内存管理深度解析</h2>
<h3 data-id="heading-12">IV.I GC的标记清除算法</h3>
<p>现代JavaScript引擎采用标记清除算法：</p>
<ol>
<li>从根对象(window/global)出发标记可达对象</li>
<li>清除不可达对象</li>
</ol>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">createHugeArray</span>(<span class="hljs-params"/>) {
	<span class="hljs-keyword">const</span> arr = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Array</span>(<span class="hljs-number">1000000</span>).<span class="hljs-title function_">fill</span>(<span class="hljs-string">'*'</span>);
	
	<span class="hljs-keyword">return</span> <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
		<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(arr.<span class="hljs-property">length</span>);
	};
}

<span class="hljs-keyword">let</span> closureWithHugeData = <span class="hljs-title function_">createHugeArray</span>();

<span class="hljs-comment">// closureWithHugeData持有着百万级数组的引用！</span>
</code></pre>
<h3 data-id="heading-13">IV.II Chrome DevTools实战排查</h3>
<p>通过Memory面板可以捕获堆快照：</p>
<ol>
<li>查找Retainers链条中的closure引用</li>
<li>比对多次快照间的增量变化</li>
</ol>
<hr/>
<h2 data-id="heading-14">V.  性能优化策略</h2>
<h3 data-id="heading-15">V.I Smart Closures设计模式</h3>
<p>避免不必要的变量捕获：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// Bad: capture unused variable </span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">process</span>(<span class="hljs-params">data</span>) {
	<span class="hljs-keyword">const</span> unusedData = <span class="hljs-title function_">transform</span>(data);
	
	<span class="hljs-keyword">return</span> <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) { <span class="hljs-comment">/*...*/</span> };
}

<span class="hljs-comment">// Good: minimize captured variables </span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">processOptimized</span>(<span class="hljs-params">data</span>) {
	<span class="hljs-keyword">return</span> <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) { 
		<span class="hljs-keyword">const</span> neededData = <span class="hljs-title function_">transform</span>(data);
		<span class="hljs-comment">/*...*/</span> 
	};
}
</code></pre>
<h3 data-id="heading-16">V.I I V8引擎优化技巧</h3>
<p>V8对以下情况有特殊优化：</p>
<ol>
<li>只使用外层变量的初始值（不修改）</li>
<li>不超过一定数量的捕获变量（通常3-4个）</li>
</ol>
<hr/>
<h2 data-id="heading-17">VI . this绑定与闭包的微妙关系</h2>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> obj = {
	<span class="hljs-attr">name</span>: <span class="hljs-string">'Alice'</span>,
	<span class="hljs-attr">getName</span>: <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
		<span class="hljs-keyword">return</span> <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
			<span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span>; <span class="hljs-comment">// Wrong!</span>
		};
	},
	<span class="hljs-attr">getNameCorrect</span>: <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
		<span class="hljs-keyword">const</span> self = <span class="hljs-variable language_">this</span>;
		<span class="hljs-keyword">return</span> <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) { <span class="hljs-comment">// Closure captures self </span>
			<span class="hljs-keyword">return</span> self.<span class="hljs-property">name</span>;
		};
	}
};
</code></pre>
<p>箭头函数提供了更优雅的方案：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-attr">getNameArrow</span>: <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) { 
	<span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span>; 
}
</code></pre>
<hr/>
<h2 data-id="heading-18">VII . Real-World应用案例集锦</h2>
<h3 data-id="heading-19">VII.I Throttle/Debounce实现</h3>
<p>经典的防抖实现就是闭包的完美用例：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">debounce</span>(<span class="hljs-params">fn, delay</span>) {
	<span class="hljs-keyword">let</span> timer;
	
	<span class="hljs-keyword">return</span> <span class="hljs-function">(<span class="hljs-params">...args</span>) =&gt;</span> { <span class="hljs-comment">// Closure captures timer </span>
	  <span class="hljs-built_in">clearTimeout</span>(timer);
	  timer = <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">fn</span>(...args), delay);
	};
}
</code></pre>
<h3 data-id="heading-20">VII.I I React Hooks原理剖析</h3>
<p>useState的实现本质上依赖闭包：</p>
<pre><code class="hljs language-jsx{5}" lang="jsx{5}">function useState(initialValue) { // Simplified version 
	let state = initialValue;
	
	const setState = (newValue) =&gt; { state = newValue };
	
	return [state, setState]; // Both captured by closure 
}
</code></pre>
<hr/>
<h2 data-id="heading-21">VIII . ES6+新特性对闭包的影响</h2>
<h3 data-id="heading-22">VIII.I Block Scoping的革命</h3>
<p>let/const改变了传统的var捕获方式：</p>
<pre><code class="hljs language-javascript{4}" lang="javascript{4}">for(let i=0; i&lt;3; i++) { // Each iteration gets fresh binding! 
	setTimeout(() =&gt; console.log(i), i*1000); // Logs:0,1,2 
} 

for(var j=0; j&lt;3; j++) { // Traditional var sharing same binding 
	setTimeout(() =&gt; console.log(j), j*1000); // Logs:3,3,3 
}
</code></pre>
<h3 data-id="heading-23">VIII.I I WeakMap带来的新可能</h3>
<p>解决DOM节点关联问题的新思路：</p>
<pre><code class="hljs language-javascript{5}" lang="javascript{5}">const wm = new WeakMap();

function registerHandler(element) { /* ... */ }

wm.set(elementNode1234, bigClosure); // GC友好型关联存储 

wm.get(elementNode1234)?.(event); // Safe optional chaining call 
</code></pre>
<hr/>
<h2 data-id="heading-24">Conclusion</h2>
<p>JavaScript的闭包就像一把双刃剑——用得好可以斩断复杂问题，用得不当可能导致内存泄漏。通过本文的系统梳理，我们不仅理解了[[Scope]]的内部机制，还掌握了从IIFE到现代Hooks的应用演变历程。</p>
<p>记住这些关键点：<br/>
✔️ <strong>最小化捕获原则</strong> ——只保留必要的变量引用<br/>
✔️ <strong>工具链验证</strong> ——善用DevTools验证内存影响<br/>
✔️ <strong>拥抱新特性</strong> ——合理运用块级作用域和WeakMap</p>
<p>当你下次遇到需要状态保持的场景时，不妨自信地说："这里该用闭包！"</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[SpringCloud 常见面试题（三）]]></title>    <link>https://juejin.cn/post/7575456858427588654</link>    <guid>https://juejin.cn/post/7575456858427588654</guid>    <pubDate>2025-11-24T00:31:01.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7575456858427588654" data-draft-id="7575017581037469734" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content=" SpringCloud 常见面试题（三）"/> <meta itemprop="keywords" content="Java"/> <meta itemprop="datePublished" content="2025-11-24T00:31:01.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="SevenCoding"/> <meta itemprop="url" content="https://juejin.cn/user/3261615728242467"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
             SpringCloud 常见面试题（三）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3261615728242467/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    SevenCoding
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-24T00:31:01.000Z" title="Mon Nov 24 2025 00:31:01 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读37分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">服务网关</h2>
<h3 data-id="heading-1">在微服务架构中，网关的作用是什么</h3>
<p>在微服务架构中，网关（Gateway）具有以下作用：</p>
<ul>
<li>统一入口：网关为所有的微服务提供一个唯一的入口点，从而简化了客户端与服务的交互，同时保障了后台服务的安全性。</li>
<li>鉴权校验：网关能够识别每个进来的请求，并根据其权限进行校验，阻止不符合要求的请求通过。</li>
<li>动态路由：根据需要，网关可以动态地将请求路由到不同的后端集群中，实现服务的灵活调度。</li>
<li>降低耦合度：通过在网关层做映射，可以将客户端与服务解耦，使服务可以独立发展，减少两者之间的依赖。</li>
<li>提供附加功能：网关不仅可以保护微服务，还可以为服务提供和沉淀更多附加功能，如熔断、限流等。</li>
</ul>
<h3 data-id="heading-2">什么是API网关？</h3>
<p>API网关（API Gateway）是一种中间层服务器，用于集中管理、保护和路由对后端服务的访问。它充当了客户端与后端服务之间的入口点，提供了一组统一的接口来管理和控制API的访问。</p>
<p>API网关的主要功能包括：</p>
<ul>
<li>路由转发：API网关根据请求的URL路径或其他标识，将请求路由到相应的后端服务。通过配置路由规则，可以灵活地将请求分发给不同的后端服务。</li>
<li>负载均衡：API网关可以在后端服务之间实现负载均衡，将请求平均分发到多个实例上，提高系统的吞吐量和可扩展性。</li>
<li>安全认证与授权：API网关可以集中处理身份验证和授权，确保只有经过身份验证的客户端才能访问后端服务。它可以与身份提供者（如OAuth、OpenID Connect）集成，进行用户认证和授权操作。</li>
<li>缓存：API网关可以缓存后端服务的响应，减少对后端服务的请求次数，提高系统性能和响应速度。</li>
<li>监控与日志：API网关可以收集和记录请求的指标和日志，提供实时监控和分析，帮助开发人员和运维人员进行故障排查和性能优化。</li>
<li>数据转换与协议转换：API网关可以在客户端和后端服务之间进行数据格式转换和协议转换，如将请求从HTTP转换为WebSocket，或将请求的参数进行格式转换，以满足后端服务的需求。</li>
<li>API版本管理：API网关可以管理不同版本的API，允许同时存在多个API版本，并通过路由规则将请求正确地路由到相应的API版本上。<br/>
……</li>
</ul>
<p>通过使用API网关，可以简化前端与后端服务的交互，提供统一的接口和安全性保障，同时也方便了服务治理和监控。它是构建微服务架构和实现API管理的重要组件之一。</p>
<h3 data-id="heading-3">SpringCloud可以选择哪些API网关？</h3>
<p>使用SpringCloud开发，可以采用以下的API网关选型：</p>
<ul>
<li>Netflix Zuul（已停止更新）：Netflix Zuul是Spring Cloud早期版本中提供的默认API网关。它基于Servlet技术栈，可以进行路由、过滤、负载均衡等功能。然而，自2020年12月起，Netflix宣布停止对Zuul 1的维护，转而支持新的API网关项目。</li>
<li>Spring Cloud Gateway：Spring Cloud Gateway是Spring Cloud官方推荐的API网关，取代了Netflix Zuul。它基于非阻塞的WebFlux框架，充分利用了响应式编程的优势，并提供了路由、过滤、断路器、限流等特性。Spring Cloud Gateway还支持与Spring Cloud的其他组件集成，如服务发现、负载均衡等。</li>
<li>Kong：Kong是一个独立的、云原生的API网关和服务管理平台，可以与Spring Cloud集成。Kong基于Nginx，提供了强大的路由、认证、授权、监控和扩展能力。它支持多种插件和扩展，可满足不同的API管理需求。</li>
<li>APISIX：APISIX基于Nginx和Lua开发，它具有强大的路由、流量控制、插件扩展等功能。APISIX支持灵活的配置方式，可以根据需求进行动态路由、负载均衡和限流等操作。</li>
</ul>
<h3 data-id="heading-4">说说你对Spring Cloud Gateway的理解</h3>
<p>Spring Cloud Gateway是Spring Cloud官方推出的第二代网关框架，取代Zuul 1.0网关。网关作为流量的，在微服务系统中有着非常作用，网关常见的功能有路由转发、权限校验、限流控制等作用。</p>
<p>使用了一个RouteLocatorBuilder的bean去创建路由，除了创建路由RouteLocatorBuilder可以让你添加各种predicates和filters，predicates断言的意思，顾名思义就是根据具体的请求的规则，由具体的route去处理，filters是各种过滤器，用来对请求做各种判断和修改。</p>
<h3 data-id="heading-5">Spring Cloud Gateway核心概念？</h3>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/739df2fd88d44a80b6aff74c395e537a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2V2ZW5Db2Rpbmc=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764549061&amp;x-signature=XTmBeKBIIjmJCKcVn0irdQbcaEk%3D" alt="" loading="lazy"/></p>
<p>在Spring Cloud Gateway里，有三个关键组件：</p>
<ul>
<li>Route（路由）：路由是Spring Cloud Gateway的基本构建块，它定义了请求的匹配规则和转发目标。通过配置路由，可以将请求映射到后端的服务实例或URL上。路由规则可以根据请求的路径、方法、请求头等条件进行匹配，并指定转发的目标URI。</li>
<li>Predicate（断言）：断言用于匹配请求的条件，如果请求满足断言的条件，则会应用所配置的过滤器。Spring Cloud Gateway提供了多种内置的断言，如Path（路径匹配）、Method（请求方法匹配）、Header（请求头匹配）等，同时也支持自定义断言。</li>
<li>Filter（过滤器）：过滤器用于对请求进行处理和转换，可以修改请求、响应以及执行其他自定义逻辑。Spring Cloud Gateway提供了多个内置的过滤器，如请求转发、请求重试、请求限流等。同时也支持自定义过滤器，可以根据需求编写自己的过滤器逻辑。</li>
</ul>
<p>我们再来看下Spring Cloud Gateway的具体工作流程：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/55d51983374145579501ba79e01449ae~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2V2ZW5Db2Rpbmc=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764549061&amp;x-signature=IO8IAQoEABkyQT98UH7W7i8zlho%3D" alt="" loading="lazy"/></p>
<p>两个比较重要的概念：</p>
<ul>
<li>Gateway Handler（网关处理器）：网关处理器是Spring Cloud Gateway的核心组件，负责将请求转发到匹配的路由上。它根据路由配置和断言条件进行路由匹配，选择合适的路由进行请求转发。网关处理器还会依次应用配置的过滤器链，对请求进行处理和转换。</li>
<li>Gateway Filter Chain（网关过滤器链）：网关过滤器链由一系列过滤器组成，按照配置的顺序依次执行。每个过滤器可以在请求前、请求后或请求发生错误时进行处理。过滤器链的执行过程可以修改请求、响应以及执行其他自定义逻辑。</li>
</ul>
<h3 data-id="heading-6">什么是限流算法，网关如何实现限流</h3>
<p>限流算法是指用于限制单位时间内服务的请求数量的算法，目的是防止服务被过高的请求压力所击垮。常见的限流算法包括计数器算法、滑动窗口算法、漏桶算法、令牌桶算法。</p>
<p>网关如何实现限流：</p>
<ul>
<li>利用限流算法插件/模块：网关可以集成限流算法插件/模块，通过配置相关参数（如令牌桶大小、令牌生成速率等）来实现限流。例如，Spring Cloud Gateway可以使用Redis的RateLimiter限流算法插件来实现限流。</li>
<li>自定义限流逻辑：网关可以通过编程方式自定义实现限流逻辑。例如，在微服务架构中，可以在每个服务的网关层（如Nacos、Eureka等）实现限流逻辑，或者使用限流SDK（如Sentinel）对请求进行限流。</li>
<li>利用云平台提供的限流功能：一些云平台提供了自动化的限流功能，例如AWS CloudWatch、Azure Application Insights等，网关可以利用这些云平台的功能来实现限流。</li>
</ul>
<h3 data-id="heading-7">你项目里为什么选择 Gateway 作为网关?</h3>
<p>选择 Spring Cloud Gateway 的原因主要有两个：</p>
<ul>
<li>以前用得比较多的是 Spring Cloud 官方开源的Zuul，其用得比较多的还是1.0 的版本，不过1.0版本 Netflix很早就宣布进入维护状态了，虽然Zuul已经出了2.0版本，但是 Spring Cloud 官方团队好像没有整合的计划，并且 Netflix 很多相关的组件，如 Eureka、Hystrix 都已经进入维护期了，所以不知道前景如间，然后 Sping doud 官方自己研发了Spring Cloud  Gateway，并且大力支持和推荐，所以相比与Zuul， Gateway是一个更好的选择。</li>
<li>Spring Cloud Gateway 有很多的特性：
<ul>
<li>基于 Spring5和 Spring Boot 2 进行构建，与 Spring 生态兼容较好</li>
<li>动态路由：可以根据配置条件，如 URL、请求方法等实现动态配置</li>
<li>可以对路由指定断言(Predicate)和过滤器(Filter)</li>
<li>集成 Hystrix 断路器功能，可以实现服务熔断</li>
<li>集成 Spring Cloud 相关组件，如 Eureka、Nacos、Consule 等实现服务的注册与发现</li>
<li>内置了限流模块，可以根据配置实现服务限流</li>
</ul>
</li>
</ul>
<h3 data-id="heading-8">Dubbo和 Spring Cloud Gateway 有什么区别?</h3>
<p>Dubbo 是一个RPC(远程过程调用)框架，主要用于服务之间的通信。它提供高性能的 RPC 调用、负载均衡、服务发现、服务注册、服务治理等功能。适用于需要高性能 RPC 调用的分布式系统，常用于内部服务通信。</p>
<p>Spring Cloud Gateway是一个API 网关，用于处理外部客户端请求并将其路由到后端服务。它提供请求路由、负载均衡、协议转换、安全管理、流量控制、日志和监控等功能。适用于微服务架构中的统一入口管理，常用于外部请求的入口层。</p>
<p>所以说它们不是一个层级的东西。</p>
<h2 data-id="heading-9">链路追踪</h2>
<h3 data-id="heading-10">为什么要用微服务链路追踪？</h3>
<p>在微服务中，有的上下游可能有十几个服务，如果某一环出了问题，排查起来非常困难，所以，就需要进行链路追踪，来帮助排查问题。</p>
<p>通过链路追踪，可以可视化地追踪请求从一个微服务到另一个微服务的调用情况。除了排查问题，链路追踪黑还可以帮助优化性能，可视化依赖关系、服务监控和告警。</p>
<h3 data-id="heading-11">SpringCloud可以选择哪些微服务链路追踪方案？</h3>
<p>Spring Cloud提供了多种选择的微服务链路追踪方案。以下是一些常用的方案：</p>
<ul>
<li>Zipkin：Zipkin 是一个开源的分布式实时追踪系统，由 Twitter 开发并贡献给开源社区。Spring Cloud Sleuth 提供了与 Zipkin 的集成，可以通过在微服务中添加相应的依赖和配置，将追踪信息发送到 Zipkin 服务器，并通过 Zipkin UI 进行可视化展示和查询。</li>
<li>Jaeger：Jaeger 是 Uber 开源的分布式追踪系统，也被纳入了 CNCF（云原生计算基金会）的维护。通过使用 Spring Cloud Sleuth 和 Jaeger 客户端库，可以将追踪信息发送到 Jaeger 并进行可视化展示和查询。</li>
<li>SkyWalking：Apache SkyWalking 是一款开源的应用性能监控与分析系统，提供了对 Java、.NET 和 Node.js 等语言的支持。它可以与 Spring Cloud Sleuth 集成，将追踪数据发送到 SkyWalking 服务器进行可视化展示和分析。</li>
<li>Pinpoint：Pinpoint 是 Naver 开源的分布式应用性能监控系统，支持 Java 和 .NET。它提供了与 Spring Cloud Sleuth 的集成，可以将追踪数据发送到 Pinpoint 服务器，并通过其 UI 进行分析和监控。</li>
</ul>
<p>这些方案都可以与 Spring Cloud Sleuth 进行集成，Spring Cloud Sleuth 是 Spring Cloud 中的一个组件，提供了在微服务调用时生成追踪信息的能力。</p>
<h2 data-id="heading-12">分布式事务</h2>
<h3 data-id="heading-13">什么情况下需要用到分布式事务？有哪些方案？</h3>
<p>分布式事务是指在多个网络节点或服务之间进行数据一致性处理的情况。以下是一些可能需要使用分布式事务的场景：</p>
<ul>
<li>微服务之间通过远程调用完成事务操作：当不同的微服务之间需要进行数据一致性保证时，就需要使用分布式事务。例如，一个电商微服务中的订单服务和库存服务需要通过远程调用进行事务操作，保证库存数量和订单信息的同步更新，避免出现超卖或缺货的情况。</li>
<li>单体系统访问多个数据库实例：当一个系统需要访问多个数据库实例时，例如用户信息和订单信息分别存储在两个不同的数据库实例中，需要通过分布式事务保证数据一致性，避免出现数据不一致的情况。</li>
<li>多服务访问同一个数据库实例：当多个服务访问同一个数据库实例时，例如订单微服务和库存微服务都需要访问同一个数据库，也可能需要使用分布式事务。因为跨JVM进程的多个服务同时持有不同的数据库连接进行数据库操作，可能会出现数据不一致的情况。</li>
</ul>
<p>在这些场景下，我们需要使用分布式事务来保证数据的一致性。常用的分布式事务方案包括两阶段提交（2PC）、三阶段提交（3PC）、TCC、Saga、本地消息表等。其中，两阶段提交和三阶段提交都是基于锁机制实现的，而TCC、Saga和本地消息表则是基于业务逻辑实现的。选择哪种方案取决于业务需求、系统复杂性和性能等多个因素。</p>
<p>详情可以看这篇文章：<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.seven97.top%2Fmicroservices%2Fdistributed-system%2Fdistributedtransactions.html" target="_blank" title="https://www.seven97.top/microservices/distributed-system/distributedtransactions.html" ref="nofollow noopener noreferrer">深度解析分布式事务的七大核心方案</a></p>
<h3 data-id="heading-14">什么是分布式事务的防悬挂，空回滚?</h3>
<p>防悬挂是指在分布式事务的第一阶段，防止在没有对应的 Try 操作的情况下出现 Confirm 或 Cancel 操作。这是为了保证事务的正确性和一致性。</p>
<p>分布式事务中最常见的模型是 TCC(Try-Confirm-Cancel)模型。在 TCC 模型中，事务分为三个步骤：</p>
<ul>
<li>Try：资源的预留操作。</li>
<li>Confirm：确认操作，完成业务逻辑</li>
<li>Cancel：取消操作，回滚预留资源。</li>
</ul>
<p>防悬挂机制的作用是确保在分布式事务中，Confirm 和 Cancel 操作只会在 Try 操作成功执行后才会触发。</p>
<p>防悬挂的场景通常是以下情况：</p>
<ul>
<li>Confirm 操作悬挂：如果 Confirm 操作在没有执行过 Try 操作的情况下被调用，可能会导致数据不一致。</li>
<li>Cancel 操作悬挂：类似地，如果 Cancel 操作在没有 Try 操作的情况下被调用，也会破坏数据的一致性。</li>
</ul>
<p>为了防止这种情况，需要通过某些机制来检测和防止悬挂。例如:</p>
<ul>
<li>幂等性检查：Confirm 和 Cancel 操作应该具备幂等性，避免多次调用引发问题。</li>
<li>状态校验：在执行 Confirm 或 Cancel之前，可以先检査是否有对应的 Try 操作成功过，如果没有，则拒绝执行 Confirm 或 Cancel 操作</li>
</ul>
<p>空回滚是指在没有执行成功的Try操作时，Cancel 操作仍然被调用了。Cancel 操作实际上就是 Try操作的回滚操作，如果 Try 操作根本没有成功，则Cancel 操作实际不会对任问资源产生影响，这就是空回滚</p>
<p>空回滚一般发生在分布式系统中的异常情况下，比如：</p>
<ul>
<li>网络超时：Try 操作还没执行成功，网络就超时了，分布式事务协调器可能误认为 Try 操作失败，因此会调用 Cancel。</li>
<li>网络分区或中断：Try 操作请求未到达相应的服务端，客户端误认为 Try 操作已经失败并发起 Cancel。</li>
</ul>
<p>在这些情况下，Cancel 操作会被执行，但因为 Try 操作并没有成功，所以 Cancel 实际上什么都不需要做。这就是空回流,。为了支持空回滚，Cancel操作必须具备以下能力：</p>
<ul>
<li>幂等性：即使 Cancel 操作被多次调用，它的效果也只能是执行一次，不会对系统产生额外影响。</li>
<li>空回滚兼容性：Cancel 操作在发现没有Try 操作执行成功时，不做任何修改，直接返回成功状态</li>
</ul>
<h3 data-id="heading-15">什么是Seata？谈谈你对Seata的理解</h3>
<p>Seata是一款开源的分布式事务解决方案，它主要用于解决在分布式系统中全局事务的一致性问题。<br/>
在分布式系统中，由于一次业务操作需要跨多个数据源或进行远程调用，往往会产生分布式事务问题。例如，在一个电商微服务系统中，订单服务和库存服务需要协同工作，如果订单服务已经创建成功，但库存服务因为某些原因失败了，就会导致数据不一致的问题。Seata就是为解决这个问题而产生的。</p>
<p>Seata的主要特点是无侵入以及高性能。它对业务无侵入，可以减少技术架构上的微服务化所带来的分布式事务问题对业务的侵入，同时高性能则是减少分布式事务解决方案所带来的性能消耗。</p>
<p>在Seata的事务处理中主要有三个重要的角色：事务的协调者（TC）、事务的管理者（TM）和事务的作业管理器（RM）。</p>
<ul>
<li>事务协调者（TC）主要负责管理全局的分支事务的状态，用于全局性事务的提交和回滚。它会对所有的分支事务进行注册，然后根据各个分支事务的状态来决定是否提交或者回滚全局事务。</li>
<li>事务管理者（TM）用于开启、提交或回滚事务。它会根据业务逻辑来决定何时开启一个新的事务，并在适当的时候提交或回滚该事务。</li>
<li>资源管理器（RM）用于分支事务上的资源管理，向TC注册分支事务，上报分支事务的状态，接收TC的命令来提交或者回滚分支事务。</li>
</ul>
<h3 data-id="heading-16">Seata支持哪些模式的分布式事务？</h3>
<p>Seata以下几种模式的分布式事务：</p>
<ul>
<li>AT（Atomikos）模式：AT模式是Seata默认支持的模式，也是最常用的模式之一。在AT模式下，Seata通过在业务代码中嵌入事务上下文，实现对分布式事务的管理。Seata会拦截并解析业务代码中的SQL语句，通过对数据库连接进行拦截和代理，实现事务的管理和协调。</li>
<li>TCC（Try-Confirm-Cancel）模式：TCC模式是一种基于补偿机制的分布式事务模式。在TCC模式中，业务逻辑需要实现Try、Confirm和Cancel三个阶段的操作。Seata通过调用业务代码中的Try、Confirm和Cancel方法，并在每个阶段记录相关的操作日志，来实现分布式事务的一致性。</li>
<li>SAGA模式：SAGA模式是一种基于事件驱动的分布式事务模式。在SAGA模式中，每个服务都可以发布和订阅事件，通过事件的传递和处理来实现分布式事务的一致性。Seata提供了与SAGA模式兼容的Saga框架，用于管理和协调分布式事务的各个阶段。</li>
<li>XA模式：XA模式是一种基于两阶段提交（Two-Phase Commit）协议的分布式事务模式。在XA模式中，Seata通过与数据库的XA事务协议进行交互，实现对分布式事务的管理和协调。XA模式需要数据库本身支持XA事务，并且需要在应用程序中配置相应的XA数据源。</li>
</ul>
<h3 data-id="heading-17">了解Seata的实现原理吗？</h3>
<p>Seata的实现原理主要包括三个核心组件：事务协调器（Transaction Coordinator）、事务管理器（Transaction Manager）和资源管理器（Resource Manager）。</p>
<ul>
<li>事务协调器（Transaction Coordinator）：事务协调器负责协调和管理分布式事务的整个过程。它接收事务的开始和结束请求，并根据事务的状态进行协调和处理。事务协调器还负责记录和管理事务的全局事务 ID（Global Transaction ID）和分支事务 ID（Branch Transaction ID）。</li>
<li>事务管理器（Transaction Manager）：事务管理器负责全局事务的管理和控制。它协调各个分支事务的提交或回滚，并保证分布式事务的一致性和隔离性。事务管理器还负责与事务协调器进行通信，并将事务的状态变更进行持久化。</li>
<li>资源管理器（Resource Manager）：资源管理器负责管理和控制各个参与者（Participant）的事务操作。它与事务管理器进行通信，并根据事务管理器的指令执行相应的事务操作，包括提交和回滚。</li>
</ul>
<p>Seata的实现原理基于两阶段提交（Two-Phase Commit）协议，具体的机制如下：</p>
<ul>
<li>一阶段：在事务提交的过程中，首先进行预提交阶段。事务协调器向各个资源管理器发送预提交请求，资源管理器执行相应的事务操作并返回执行结果。在此阶段，业务数据和回滚日志记录在同一个本地事务中提交，并释放本地锁和连接资源。</li>
<li>二阶段：在预提交阶段成功后，进入真正的提交阶段。此阶段主要包括提交异步化和回滚反向补偿两个步骤：
<ul>
<li>提交异步化：事务协调器发出真正的提交请求，各个资源管理器执行最终的提交操作。这个阶段的操作是非常快速的，以确保事务的提交效率。</li>
<li>回滚反向补偿：如果在预提交阶段中有任何一个资源管理器返回失败结果，事务协调器发出回滚请求，各个资源管理器执行回滚操作，利用一阶段的回滚日志进行反向补偿。</li>
</ul>
</li>
</ul>
<h3 data-id="heading-18">Seata的事务执行流程是什么样的？</h3>
<p>Seata事务的执行流程可以简要概括为以下几个步骤：</p>
<ul>
<li>事务发起方（Transaction Starter）发起全局事务：事务发起方是指发起分布式事务的应用程序或服务。它向Seata的事务协调器发送全局事务的开始请求，生成全局事务ID（Global Transaction ID）。</li>
<li>事务协调器创建全局事务记录：事务协调器接收到全局事务的开始请求后，会为该事务创建相应的全局事务记录，并生成分支事务ID（Branch Transaction ID）。</li>
<li>分支事务注册：事务发起方将全局事务ID和分支事务ID发送给各个参与者（Participant），即资源管理器。参与者将分支事务ID注册到本地事务管理器，并将事务的执行结果反馈给事务协调器。</li>
<li>执行业务逻辑：在分布式事务的上下文中，各个参与者执行各自的本地事务，即执行业务逻辑和数据库操作。</li>
<li>预提交阶段：事务发起方向事务协调器发送预提交请求，事务协调器将预提交请求发送给各个参与者。</li>
<li>执行本地事务确认：参与者接收到预提交请求后，执行本地事务的确认操作，并将本地事务的执行结果反馈给事务协调器。</li>
<li>全局事务提交或回滚：事务协调器根据参与者反馈的结果进行判断，如果所有参与者的本地事务都执行成功，事务协调器发送真正的提交请求给参与者，参与者执行最终的提交操作；如果有任何一个参与者的本地事务执行失败，事务协调器发送回滚请求给参与者，参与者执行回滚操作。</li>
<li>完成全局事务：事务协调器接收到参与者的提交或回滚结果后，根据结果更新全局事务的状态，并通知事务发起方全局事务的最终结果。</li>
</ul>
<h3 data-id="heading-19">全局事务ID和分支事务ID是怎么传递的？</h3>
<p>全局事务ID和分支事务ID在分布式事务中通过上下文传递的方式进行传递。常见的传递方式包括参数传递、线程上下文传递和消息中间件传递。具体的传递方式可以根据业务场景和技术选型进行选择和调整。</p>
<h3 data-id="heading-20">Seata的事务回滚是怎么实现的？</h3>
<p>Seata的事务回滚是通过回滚日志实现的。每个参与者在执行本地事务期间生成回滚日志，记录了对数据的修改操作。</p>
<p>当需要回滚事务时，事务协调器向参与者发送回滚请求，参与者根据回滚日志中的信息执行撤销操作，将数据恢复到事务开始前的状态。</p>
<p>回滚日志的管理和存储是Seata的核心机制，可以选择将日志存储在不同的介质中。通过回滚日志的持久化和恢复，Seata确保了事务的一致性和恢复性。</p>
<h3 data-id="heading-21">Sentinel 与Hystrix的区别是什么</h3>
<p>Hystrix和Sentinel都是微服务架构中实现熔断和限流的工具，它们有以下区别和特点：</p>
<p>Hystrix是Netflix开源的熔断器实现，主要用于保护分布式系统中的服务调用。它的主要特点包括线程隔离、资源保护和降级处理。Hystrix通过将每个服务调用放入独立的线程池中来实现线程隔离，防止一个服务的延迟或故障影响其他服务。它通过监控服务调用的成功率、延迟等指标来保护后端资源，并在失败的请求或响应超时达到一定阈值时自动打开熔断器，避免连锁故障。此外，Hystrix还提供了降级处理功能，可以在服务不可用或响应过慢时返回预定义的降级响应，保证系统的可用性。</p>
<p>Sentinel是阿里巴巴开源的流量控制和系统保护工具，主要用于实现微服务架构中的流量控制、熔断、降级和系统负载保护等。它的主要特点包括实时监控和动态规则配置、丰富的流量控制策略、细粒度的服务保护以及支持多种编程语言。Sentinel可以实时监控服务的请求流量和各项指标，并提供实时的仪表盘和可视化的监控界面。它还支持通过API动态配置流量控制和熔断规则，可以根据实际情况进行动态调整。Sentinel提供了多种流量控制策略，包括基于QPS、线程数、并发连接数等多种指标进行的流量控制。此外，Sentinel还支持对每个具体的服务接口进行熔断、降级和限流等操作，以实现精确的服务保护策略。同时，Sentinel不仅支持Java，还支持Go、Python等多种编程语言，使其适用于跨语言的微服务架构。</p>
<p>总的来说，Hystrix注重线程隔离和资源保护，适用于保护单个服务调用。而Sentinel注重流量控制和动态规则配置，适用于对整个系统的流量进行监控和保护。根据实际需求和技术栈，可以选择适合的工具来实现微服务架构中的熔断和限流功能。</p>
<h3 data-id="heading-22">如果 Sentinel 的异常处理规则不满足需求，应该怎么办？</h3>
<p>如果 Sentinel 的默认异常处理机制无法满足需求，可以选择自定义异常处理规则。</p>
<p>Sentinel 允许通过自定义实现 BlockedExceptionHandler 接口，然后将自定义的异常处理器对象交给 Spring 容器进行管理。 可以根据实际业务需求，定制化异常处理策略，例如全局兜底处理、日志打印、空指针检查等。 同时，还可以在处理器中加入自定义的业务逻辑，例如对异常进行分类、统计和反馈等。 这样，可以根据具体的应用场景和业务需求，灵活地扩展 Sentinel 的异常处理能力。</p>
<h3 data-id="heading-23">什么是分布式事务的防悬挂，空回滚</h3>
<p>在分布式事务中，防悬挂和空回滚是两个重要的概念，它们通常在实现分布式事务时涉及的锁定机制、隔离性、错误处理等方面。下面对这两个概念进行详细解释</p>
<ol>
<li>防悬挂
防悬挂是指在分布式事务的第一阶段，防止在没有对应的 Try 操作的情况下出现 Confirm 或 Cancel操作。这是为了保证事务的正确性和一致性。</li>
</ol>
<p>分布式事务中最常见的模型是 TCC(Try-Confirm-Cancel)模型。在 TCC 模型中，事务通常分为三个步骤：</p>
<ul>
<li>Try：资源的预留操作。</li>
<li>Confirm：确认操作，完成业务逻辑</li>
<li>Cancel：取消操作，回滚预留资源。</li>
</ul>
<p>防悬挂机制的作用是确保在分布式事务中，Confirm 和 Cancel 操作只会在 Try 操作成功执行后才会触发。防悬挂的场景通常是以下情况：</p>
<ul>
<li>Confirm 操作悬挂：如果 Confirm 操作在没有执行过 Try 操作的情况下被调用，可能会导致数据不一致</li>
<li>Cancel 操作悬挂：类似地，如果 Cancel 操作在没有 Try 操作的情况下被调用，也会破坏数据的一致性。</li>
</ul>
<p>为了防止这种情况，通常需要通过某些机制来检测和防止悬挂。例如:</p>
<ul>
<li>幂等性检查：Confirm 和 Cancel 操作应该具备幂等性，避免多次调用引发问题。</li>
<li>状态校验：在执行 Confirm 或 Cancel 之前，可以先检查是否有对应的 Try 操作成功过，如果没有，则拒绝执行 Confirm 或 Cancel 操作</li>
</ul>
<ol start="2">
<li>空回滚
空回滚是指在没有执行成功的Try操作时，Cancel操作仍然被调用了。Cancel操作实际上就是 Try操作的回滚操作，如果 Try 操作很本没有成功，则 Cancel 操作实际不会对任何资源产生影响，这种情况下称为空回滚</li>
</ol>
<p>空回滚通常发生在分布式系统中的异常情况下，比如:</p>
<ul>
<li>网络超时：Try 操作还没执行成功，网络就超时了，分布式事务协调器可能误认为 Try 操作失败，因此会调用 Cancel。</li>
<li>网络分区或中断：Try 操作请求未到达相应的服务端，客户端误认为 Try 操作已经失败并发起 Cancel。</li>
</ul>
<p>在这些情况下，Cancel 操作会被执行，但因为 Try 操作并没有成功，所以 Cancel 实际上什么都不需要做。这就是空回滚。</p>
<p>为了支持空回滚，Cancel 操作必须具备以下能力:</p>
<ul>
<li>幂等性：即使 Cancel 操作被多次调用，它的效果也只能是执行一次，不会对系统产生额外影响。</li>
<li>空回滚兼容性：Cancel操作在发现没有 Try 操作执行成功时，不做任何修改，直接返回成功状态</li>
</ul>
<h3 data-id="heading-24">当前有个本地操作 A，远程操作 B，我需要保证 A和 B事务的一致性，你会如何实现？</h3>
<blockquote>
<p>这个题目经常有人会直接踩坑，然后就被面试官绕进去出不来了</p>
</blockquote>
<p>要保证本地操作A和远程操作B的事务一致性，这是一个分布式事务问题。不能在本地事务中直接嵌入远程 RPC调用(这就是坑)，而是通过异步解耦+补偿机制实现最终一致性。</p>
<p>常见方案是本地消息表：本地事务A执行时，先记录一条“待执行远程操作B”的日志(与A在同一事务中)，本地事务提交后，通过异步线程或消息队列触发远程调用B、若B失败，通过定时任务重试(因为有日志，可以扫描日志重试)，直到成功或人工介入。</p>
<p>为什么不能在本地事务中直接调用远程 RPC?</p>
<pre><code class="hljs language-text" lang="text">begin transaction
  update A 本地数据库
  调用远程服务B（RPC）
commit
</code></pre>
<p>举个例子：本地操作A是“扣库存”(数据库事务)，远程操作B是“调用支付接口扣款”。如果在本地事务中直接调用B，若 B超时 则本地事务回滚，但B实际执行了，导致库存与支付状态不一致。</p>
<p>除此之外，还有长事务问题，毕竟外部系统不可控(即使是公司其他部分的接口)，若B执行时间过长，会导致 A 操作本地事务锁持有时间延长，引发数据库连接耗尽或死锁问题。</p>
<p>所以，不建议将 RPC调用嵌入本地事务中。同理，像发MQ、更新外部系统(如缓存)等操作，都不建议放在事务内。</p>
<h3 data-id="heading-25">现在需要你设计一个将已登录的用户踢下线的功能，如何实现?</h3>
<p>可以通过标记用户 token 为失效或者直接移除其 session来实现踢下线功能</p>
<p>简单来说，就是让后续请求中带的登录凭证不再被系统接受。标记失效和直接删除都行，这样用户下次请求就会被拦截或要求重新登录</p>
<h2 data-id="heading-26">分布式系统</h2>
<h3 data-id="heading-27">把单体项目进行了多机部署，多台服务器是如何共享用户登录信息的？</h3>
<p>目前主流有两个方案：</p>
<ol>
<li>将 Session 放置第三方共享存储中，例如 Redis、Memcached 等分布式缓存 或数据库中，所有的服务器统一访问第三方。</li>
<li>JWT，即服务器不存储会话，用户登录后返回签名令牌(含用户信息)，每次请求携带令牌验证即可。不过现在很多项目会把 JWT 存在 Redis 中</li>
</ol>
<p>因为单机时候会话(Session)会存储在本地，比如 Tomcat 的 HttpSession 默认存在当前服务器内存中。多机部署后，同一个用户多次请求可能会被负载均衡到其他服务器，新服务器无法读取原会话数据，这时候登录态就丢了有些人会采用 粘性会话，比如利用 Nginx 根据用户 IP 或 Cookie 哈希固定转发到同一台服务器。这个方式有局限性，如果服务器宕机了会话就丢失(登录态就掉了)，且扩容缩容时会导致负载不均，无法实现真正的弹性伸缩。所以普遍会采用第三方共享存储 Session，比如用 Redis 存放 Session，这样一来所有的服务都可以共享访问到同一个 Session。</p>
<p>举个例子</p>
<ol>
<li>用户登录后，服务端生成 SessionID，并将用户数据(如用户ID、权限)写入Redis(Key=SessionID，Value=序列化数据)。</li>
<li>响应中设置 Cookie(如SESSION=abc123)或 Header 返回 Token。</li>
<li>用户下次请求携带 Session ID，任意服务器从 Redis 读取数据，还原用户上下文</li>
</ol>
<h2 data-id="heading-28">服务监控</h2>
<h3 data-id="heading-29">你们的服务怎么做监控和告警？</h3>
<p>我们使用Prometheus和Grafana来实现整个微服务集群的监控和告警：</p>
<ul>
<li>Prometheus：Prometheus 是一个开源的监控系统，具有灵活的数据模型和强大的查询语言，能够收集和存储时间序列数据。它可以通过HTTP协议定期拉取微服务的指标数据，并提供可扩展的存储和查询功能。</li>
<li>Grafana：Grafana 是一个开源的可视化仪表板工具，可以与 Prometheus 结合使用，创建实时和历史数据的仪表板。Grafana 提供了丰富的图表和可视化选项，可以帮助用户更好地理解和分析微服务的性能和状态。</li>
</ul>
<h3 data-id="heading-30">你们的服务怎么做日志收集？</h3>
<p>日志收集有很多种方案，我们用的是ELK：</p>
<ul>
<li>Elasticsearch：Elasticsearch是一个分布式搜索和分析引擎，用于存储和索引大量的日志数据。它提供了快速的搜索和聚合功能，可以高效地处理大规模的日志数据。</li>
<li>Logstash：Logstash是一个用于收集、过滤和转发日志数据的工具。它可以从各种来源（如文件、网络、消息队列等）收集日志数据，并对数据进行处理和转换，然后将其发送到Elasticsearch进行存储和索引。</li>
<li>Kibana：Kibana是一个用于日志数据可视化和分析的工具。它提供了丰富的图表、仪表盘和搜索功能，可以帮助用户实时监控和分析日志数据，发现潜在的问题和趋势。</li>
</ul>
<p>简单说，这三者里Elasticsearch提供数据存储和检索能力，Logstash负责将日志收集到ES，Kibana负责日志数据的可视化分析。</p>
<p>使用ELK进行微服务日志收集的一般流程如下：</p>
<ol>
<li>在每个微服务中配置日志输出：将微服务的日志输出到标准输出（stdout）或日志文件。</li>
<li>使用Logstash收集日志：配置Logstash收集器，通过配置输入插件（如文件输入、网络输入等）监听微服务的日志输出，并进行过滤和处理。</li>
<li>将日志数据发送到Elasticsearch：配置Logstash的输出插件，将经过处理的日志数据发送到Elasticsearch进行存储和索引。</li>
<li>使用Kibana进行可视化和分析：通过Kibana连接到Elasticsearch，创建仪表盘、图表和搜索查询，实时监控和分析微服务的日志数据。</li>
</ol>
<p>除了应用最广泛的ELK，还有一些其它的方案比如Fluentd、Graylog、Loki、Filebeat，一些云厂商也提供了付费方案，比如阿里云的sls。</p>
<h2 data-id="heading-31">其它</h2>
<h3 data-id="heading-32">说一下你对于 DDD 的了解?</h3>
<p>DDD全名叫做 Domain-driven design，即领域驱动设计，它是一种软件开发方法，其主要目的就是让开发人员和领域专家可以更好地协作，从而开发出满足业务需求的系统</p>
<p>DDD 的关键概念包括领域模型和限界上下文。</p>
<ul>
<li>领域模型描述了业务领域的规则和逻辑，让开发人员能够更好地理解业务需求。</li>
<li>限界上下文则定义了一个特定的业务领域内的模型和代码，使得其可以独立于其他上下文进行开发和维护。</li>
</ul>
<p>除此之外，DDD还强调分层架构和事件溯源的重要性，分层架构将系统划分为不同层次的结构，每个层次的职责和角色各有不同，从而方便业务代码的开发和维护。事件溯源则是一种存储和处理业务事件的技术，支持审计、合规和业务分析等需求。</p>
<p>总得来说，DOD是一种设计和开发复杂软件系统的方法，一般情况下 MVC 已经能够完成许多软件业务的开发了，如果项目本身比较简单，引入 DDD的话不仅不能降低开发成本，还会增加开发的复杂程度，所以 DDD 在使用之前需要一定的思考。</p>
<h3 data-id="heading-33">什么是灰度发布、金丝雀部署以及蓝绿部署?</h3>
<p>灰度发布、金丝雀部署和蓝绿部署是三种常见的软件发布策略，它们用于在系统升级时降低风险，确保在新版本上线过程中服务的稳定性和可控性</p>
<ul>
<li>灰度发布</li>
</ul>
<p>灰度发布是一种新进式的发布方式，它通过将新版本逐步推送给部分用户进行试用，逐步扩大使用范围，直到新版本完全替换旧版本，其目的是通过小范围的用户测试，验证新版本的稳定性，降低发布新版本的风验</p>
<p>实现方式：通常通过流量控制的方式，将一部分用户请求引导到新版本实例上。如果新版本表现正常，可以逐步增加新版本的用户群体，直到全量用户使用新版本。</p>
<p>适用场景：适合在业务逻辑变动较大的场景中使用，通过灰度发布可以发现新版本中的潜在问题，并在影响范围较小的情况下进行回滚。</p>
<ul>
<li>金丝雀部署</li>
</ul>
<p>金丝雀部署(Ccanary Deployment)是一种特殊的灰度发布策略，通常是指将新版本部署到少量的实例上，并仅将部分流量引导至这些实例，以验证新版本在实际生产环境中的表现。</p>
<p>和灰度发布的区别：金丝雀部署更强调在生产环境中逐步验证新版本的表现，类似于让“金丝雀”先进入矿井检测安全性，一旦检测到问题，可以快速回滚。</p>
<p>实现方式：可以通过负载均衡器或服务网格，将一定比例的流量引导到运行新版本的实例上。若新版本稳定，再逐步增加其流量占比。</p>
<p>适用场景：适用于需要在生产环境中验证新功能或配置变更的场景。通过金丝雀部署，可以提前发现新版本在生产环境中的潜在问题，降低对全量用户的影响,</p>
<ul>
<li>蓝绿部署</li>
</ul>
<p>蓝绿部署(Blue-Green Deployment)是一种无缝切换的部署策略，在这种模式下，生产环境中始终存在两个版本：蓝色版本(当前的生产版本)和绿色版本(新版本)。当绿色版本准备就绪时，通过负载均衡或路由切换，将所有流量从蓝色版本切换到绿色版本。</p>
<p>特点：在蓝绿部署中，旧版本(蓝色版本)始终保持可用，可以在新版本(绿色版本)出现问题时，快速切换回旧版本，实现快速回滚。</p>
<p>实现方式：通常通过负载均衡器、DNS 切换或 API网关，来切换蓝色版本和绿色版本之间的流量指向。</p>
<p>适用场景：适用于需要快速切换和回滚的场景，特别是在对系统稳定性要求较高的应用中，通过蓝绿部署，可以实现无停机升级。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[SwiftUI 状态管理极简之道：从“最小状态”到“状态树”]]></title>    <link>https://juejin.cn/post/7575456858427654190</link>    <guid>https://juejin.cn/post/7575456858427654190</guid>    <pubDate>2025-11-24T00:50:06.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7575456858427654190" data-draft-id="7552584517867241522" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="SwiftUI 状态管理极简之道：从“最小状态”到“状态树”"/> <meta itemprop="keywords" content="Swift"/> <meta itemprop="datePublished" content="2025-11-24T00:50:06.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="unravel2025"/> <meta itemprop="url" content="https://juejin.cn/user/1116759541421880"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            SwiftUI 状态管理极简之道：从“最小状态”到“状态树”
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1116759541421880/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    unravel2025
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-24T00:50:06.000Z" title="Mon Nov 24 2025 00:50:06 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">为什么“状态”是 SwiftUI 的牛顿第三定律？</h2>
<p>在物理学里，力与反作用力成对出现；在 SwiftUI 里，状态变化与UI 反应也成对出现。</p>
<p>用户每一次点击、每一次网络返回，都相当于给系统施加了一个“力”，而 UI 必须以某种“反作用力”做出响应。</p>
<p>因此，状态管理不是可选技能，而是 SwiftUI 世界的万有引力。</p>
<h2 data-id="heading-1">最小状态原则（Minimal State）</h2>
<p>先记住一句“咒语”： “<strong>能让 UI 正确且及时响应的最少状态到底是哪些？</strong>”</p>
<p>凡是不在这份清单里的数据，一律：</p>
<ul>
<li>计算得出 → 用 computed property</li>
<li>可推导 → 不用 @State</li>
<li>临时存活 → 用 let 或局部变量</li>
</ul>
<p>这样做的好处：</p>
<ol>
<li>减少无效刷新，提升性能</li>
<li>降低心智负担，代码更易读</li>
<li>为后续拆分模块、复用组件扫清障碍</li>
</ol>
<h2 data-id="heading-2">状态载具速查表</h2>















































<table><thead><tr><th>属性包装器</th><th>作用域</th><th>典型用途</th><th>备注</th></tr></thead><tbody><tr><td><code>@State</code></td><td>当前 View 私有</td><td>局部 UI 小数据（如 String、Bool、Int）</td><td>值类型</td></tr><tr><td><code>@Binding</code></td><td>父子共享</td><td>将“引用”传给子 View，使其能修改父数据</td><td>不拥有数据</td></tr><tr><td><code>@StateObject</code></td><td>当前 View 私有</td><td>创建并持有引用类型（如 ObservableObject）</td><td>生命周期与 View 一致</td></tr><tr><td><code>@ObservedObject</code></td><td>任意 View</td><td>外部传入的 ObservableObject</td><td>不创建，只引用</td></tr><tr><td><code>@Environment</code></td><td>全局</td><td>系统级值（如 colorScheme、locale 等）</td><td>通过 key 读取</td></tr><tr><td><code>@EnvironmentObject</code></td><td>全局</td><td>自定义共享对象</td><td>需提前注入</td></tr></tbody></table>
<blockquote>
<p>本文不讨论 MVVM / MVC / TCA 等架构，只聚焦“状态本身如何存在、如何流动”。</p>
</blockquote>
<h2 data-id="heading-3">从 0 到 1：状态是如何“被声明”的？</h2>
<h3 data-id="heading-4">静态单状态 —— 宇宙奇点</h3>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">struct</span> <span class="hljs-title class_">ContentView</span>: <span class="hljs-title class_">View</span> {
    <span class="hljs-keyword">var</span> body: <span class="hljs-keyword">some</span> <span class="hljs-type">View</span> {
        <span class="hljs-type">VStack</span> {
            <span class="hljs-type">Image</span>(systemName: <span class="hljs-string">"globe"</span>)
                .imageScale(.large)
                .foregroundStyle(.tint)
            <span class="hljs-type">Text</span>(<span class="hljs-string">"Hello, world!"</span>)
        }
        .padding()
    }
}
</code></pre>
<p>注释：没有 @State，UI 永远不变，宇宙一片死寂。</p>
<h3 data-id="heading-5">引入第一个 @State —— 宇宙大爆炸</h3>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">struct</span> <span class="hljs-title class_">ContentView</span>: <span class="hljs-title class_">View</span> {
    <span class="hljs-meta">@State</span> <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> statefulText: <span class="hljs-type">String</span> <span class="hljs-operator">=</span> <span class="hljs-string">"Stateful Text"</span>
    
    <span class="hljs-keyword">var</span> body: <span class="hljs-keyword">some</span> <span class="hljs-type">View</span> {
        <span class="hljs-type">VStack</span> {
            <span class="hljs-type">Image</span>(systemName: <span class="hljs-string">"globe"</span>)
                .imageScale(.large)
                .foregroundStyle(.tint)
            <span class="hljs-type">Text</span>(statefulText)          <span class="hljs-comment">// 依赖状态</span>
        }
        .padding()
    }
}
</code></pre>
<p>注释：现在 UI 可以随 <code>statefulText</code> 变化而刷新，但用户还没法干预。</p>
<h3 data-id="heading-6">让用户当“上帝”—— 引入交互</h3>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">struct</span> <span class="hljs-title class_">ContentView</span>: <span class="hljs-title class_">View</span> {
    <span class="hljs-meta">@State</span> <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> statefulText: <span class="hljs-type">String</span> <span class="hljs-operator">=</span> <span class="hljs-string">"Stateful Text"</span>
    
    <span class="hljs-keyword">var</span> body: <span class="hljs-keyword">some</span> <span class="hljs-type">View</span> {
        <span class="hljs-type">VStack</span> {
            <span class="hljs-type">Button</span> {
                statefulText <span class="hljs-operator">=</span> <span class="hljs-string">"Ouch!"</span>  <span class="hljs-comment">// 用户施加“力”</span>
            } label: {
                <span class="hljs-type">Image</span>(systemName: <span class="hljs-string">"globe"</span>)
                    .imageScale(.large)
                    .foregroundStyle(.tint)
            }
            <span class="hljs-type">Text</span>(statefulText)          <span class="hljs-comment">// 自动反应</span>
        }
        .padding()
    }
}
</code></pre>
<p>注释：状态变化 ⇄ UI 反应 的环路闭合，宇宙开始演化。</p>
<h3 data-id="heading-7">多状态宇宙：枚举扛起大旗</h3>
<p>把“加载中/加载成功/错误/哲学生命周期”抽象成枚举，一次性把状态机搬进 UI：</p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-comment">// 1. 定义状态机</span>
<span class="hljs-keyword">enum</span> <span class="hljs-title class_">ViewState</span> {
    <span class="hljs-keyword">case</span> loading
    <span class="hljs-keyword">case</span> loaded
    <span class="hljs-keyword">case</span> error
    <span class="hljs-keyword">case</span> whoami
}

<span class="hljs-keyword">struct</span> <span class="hljs-title class_">ContentView</span>: <span class="hljs-title class_">View</span> {
    <span class="hljs-comment">// 2. 最小状态：当前处于哪一步</span>
    <span class="hljs-meta">@State</span> <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> currentState: <span class="hljs-type">ViewState</span> <span class="hljs-operator">=</span> .loading
    <span class="hljs-comment">// 3. 仅 loaded 才关心的文字</span>
    <span class="hljs-meta">@State</span> <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> statefulText: <span class="hljs-type">String</span> <span class="hljs-operator">=</span> <span class="hljs-string">"We did it!"</span>
    
    <span class="hljs-keyword">var</span> body: <span class="hljs-keyword">some</span> <span class="hljs-type">View</span> {
        <span class="hljs-type">Group</span> {
            <span class="hljs-keyword">switch</span> currentState {
            <span class="hljs-keyword">case</span> .loading:
                <span class="hljs-type">ContentUnavailableView</span>(<span class="hljs-string">"One moment please..."</span>,
                                       systemImage: <span class="hljs-string">"hourglass"</span>)
            <span class="hljs-keyword">case</span> .loaded:
                loadedUI
            <span class="hljs-keyword">case</span> .error:
                <span class="hljs-type">ContentUnavailableView</span>(<span class="hljs-string">"Oops!"</span>,
                                       systemImage: <span class="hljs-string">"x.circle"</span>)
            <span class="hljs-keyword">case</span> .whoami:
                <span class="hljs-type">Text</span>(<span class="hljs-string">"Existential Crisis!"</span>)
            }
        }
        .task {
            <span class="hljs-comment">// 4. 模拟网络请求</span>
            <span class="hljs-keyword">do</span> {
                <span class="hljs-keyword">try</span> <span class="hljs-keyword">await</span> <span class="hljs-type">Task</span>.sleep(nanoseconds: <span class="hljs-number">2_000_000_000</span>)
                currentState <span class="hljs-operator">=</span> .loaded
            } <span class="hljs-keyword">catch</span> {
                currentState <span class="hljs-operator">=</span> .error
            }
        }
    }
    
    <span class="hljs-comment">// 把 loaded 状态 UI 拆成 computed property，可读性更好</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> loadedUI: <span class="hljs-keyword">some</span> <span class="hljs-type">View</span> {
        <span class="hljs-type">VStack</span> {
            <span class="hljs-type">Button</span>(<span class="hljs-string">"点我改文字"</span>) {
                statefulText <span class="hljs-operator">=</span> <span class="hljs-string">"Ouch!"</span>
            }
            <span class="hljs-type">Button</span>(<span class="hljs-string">"进入哲学模式"</span>) {
                currentState <span class="hljs-operator">=</span> .whoami
            }
            <span class="hljs-type">Text</span>(statefulText)
        }
        .padding()
    }
}
</code></pre>
<p>注释：</p>
<ul>
<li>用 <code>switch</code> 做穷尽式匹配，编译器帮你检查漏掉的状态</li>
<li><code>.task</code> 修饰符在视图出现时自动执行，离开即取消，比 <code>onAppear</code> 更安全</li>
</ul>
<h2 data-id="heading-8">状态树：像公司一样分部门治理</h2>
<p>当父 View 既要管“加载枚举”又要管“文字细节”时，责任过重。</p>
<p>把只跟 loaded 相关的状态下放给子 View，父级只保留“导航级”状态，形成状态树：</p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">struct</span> <span class="hljs-title class_">ContentView</span>: <span class="hljs-title class_">View</span> {
    <span class="hljs-meta">@State</span> <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> currentState: <span class="hljs-type">ViewState</span> <span class="hljs-operator">=</span> .loading
    
    <span class="hljs-keyword">var</span> body: <span class="hljs-keyword">some</span> <span class="hljs-type">View</span> {
        <span class="hljs-type">Group</span> {
            <span class="hljs-keyword">switch</span> currentState {
            <span class="hljs-keyword">case</span> .loading:
                <span class="hljs-type">ContentUnavailableView</span>(<span class="hljs-string">"One moment please..."</span>,
                                       systemImage: <span class="hljs-string">"hourglass"</span>)
            <span class="hljs-keyword">case</span> .loaded:
                <span class="hljs-type">LoadedView</span>(currentState: <span class="hljs-variable">$currentState</span>) <span class="hljs-comment">// 只传绑定</span>
            <span class="hljs-keyword">case</span> .error:
                <span class="hljs-type">ContentUnavailableView</span>(<span class="hljs-string">"Oops!"</span>,
                                       systemImage: <span class="hljs-string">"x.circle"</span>)
            <span class="hljs-keyword">case</span> .whoami:
                <span class="hljs-type">Text</span>(<span class="hljs-string">"Existential Crisis!"</span>)
            }
        }
        .task {
            <span class="hljs-keyword">do</span> {
                <span class="hljs-keyword">try</span> <span class="hljs-keyword">await</span> <span class="hljs-type">Task</span>.sleep(nanoseconds: <span class="hljs-number">2_000_000_000</span>)
                currentState <span class="hljs-operator">=</span> .loaded
            } <span class="hljs-keyword">catch</span> {
                currentState <span class="hljs-operator">=</span> .error
            }
        }
    }
}

<span class="hljs-comment">// 子 View：只关心 loaded 世界</span>
<span class="hljs-keyword">struct</span> <span class="hljs-title class_">LoadedView</span>: <span class="hljs-title class_">View</span> {
    <span class="hljs-meta">@Binding</span> <span class="hljs-keyword">var</span> currentState: <span class="hljs-type">ViewState</span> <span class="hljs-comment">// 需要回跳父级，用 Binding</span>
    <span class="hljs-meta">@State</span> <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> statefulText: <span class="hljs-type">String</span> <span class="hljs-operator">=</span> <span class="hljs-string">"We did it!"</span> <span class="hljs-comment">// 局部状态</span>
    
    <span class="hljs-keyword">var</span> body: <span class="hljs-keyword">some</span> <span class="hljs-type">View</span> {
        <span class="hljs-type">VStack</span>(spacing: <span class="hljs-number">20</span>) {
            <span class="hljs-type">Button</span>(<span class="hljs-string">"改文字"</span>) {
                statefulText <span class="hljs-operator">=</span> <span class="hljs-string">"Ouch!"</span>
            }
            <span class="hljs-type">Button</span>(<span class="hljs-string">"哲学模式"</span>) {
                currentState <span class="hljs-operator">=</span> .whoami
            }
            <span class="hljs-type">Text</span>(statefulText)
                .font(.title)
        }
        .padding()
    }
}
</code></pre>
<p>注释：</p>
<ul>
<li>父 View 代码量瞬间减半，职责单一</li>
<li>子 View 可独立预览、独立测试，甚至一键抽成 Swift Package给别的项目用</li>
</ul>
<h2 data-id="heading-9">递归地追问“最小状态”</h2>
<p>状态树不是一层就够。如果 <code>LoadedView</code> 里再出现子模块（比如点赞数、评论列表），继续问自己：</p>
<ol>
<li>这些子模块是否必须由父级驱动？</li>
<li>能否把“点赞数”做成 <code>@StateObject</code> 的 <code>LikesService</code>，通过 <code>@EnvironmentObject</code> 注入？</li>
<li>能否把“评论列表”做成纯粹 <code>@State</code> 的局部数组，只在进入评论区才初始化？</li>
</ol>
<p>每一层都回答一次“最小状态”问题，复杂度就被递归地压扁。</p>
<h2 data-id="heading-10">实战扩展：把状态树做成“可插拔”模块</h2>
<p>假设未来要加“夜间模式”全局开关：</p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">@main</span>
<span class="hljs-keyword">struct</span> <span class="hljs-title class_">MyApp</span>: <span class="hljs-title class_">App</span> {
    <span class="hljs-meta">@StateObject</span> <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> theme <span class="hljs-operator">=</span> <span class="hljs-type">ThemeService</span>() <span class="hljs-comment">// 遵循 ObservableObject</span>
    
    <span class="hljs-keyword">var</span> body: <span class="hljs-keyword">some</span> <span class="hljs-type">Scene</span> {
        <span class="hljs-type">WindowGroup</span> {
            <span class="hljs-type">ContentView</span>()
                .environmentObject(theme) <span class="hljs-comment">// 一次性注入</span>
        }
    }
}
</code></pre>
<p>任意深层子 View 只需：</p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">struct</span> <span class="hljs-title class_">DeepChild</span>: <span class="hljs-title class_">View</span> {
    <span class="hljs-meta">@EnvironmentObject</span> <span class="hljs-keyword">var</span> theme: <span class="hljs-type">ThemeService</span>
    
    <span class="hljs-keyword">var</span> body: <span class="hljs-keyword">some</span> <span class="hljs-type">View</span> {
        <span class="hljs-type">Text</span>(<span class="hljs-string">"深夜模式自动响应"</span>)
            .foregroundColor(theme.labelColor)
    }
}
</code></pre>
<p>关键点：</p>
<ul>
<li>全局状态绝不放在根 View 的 <code>@State</code>，而是 <code>@StateObject</code> + <code>@EnvironmentObject</code></li>
<li>业务层继续遵循“最小状态”，不依赖全局主题即可独立运行</li>
</ul>
<h2 data-id="heading-11">总结与 Checklist</h2>
<ol>
<li>先写“死”的 UI，再慢慢声明状态，而不是一上来就 <code>@State</code> 满天飞。</li>
<li>每一次加状态前，背一遍咒语：“这是让 UI 正确且及时响应的最小集合吗？”</li>
<li>当状态超过 3 个且互相耦合，立刻画状态树：
<ul>
<li>谁能独立？→ 拆子 View</li>
<li>谁需共享？→ 拆 ObservableObject</li>
<li>谁只读？→ 用 Environment</li>
</ul>
</li>
<li>把“枚举 + switch”当成状态机语法糖，穷尽所有 case，让编译器当你 QA。</li>
</ol>
<h2 data-id="heading-12">学习文章</h2>
<ol>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fcaptainswiftui.substack.com%2Fp%2Fswiftui-craftsmanship-state-management" target="_blank" title="https://captainswiftui.substack.com/p/swiftui-craftsmanship-state-management" ref="nofollow noopener noreferrer">captainswiftui.substack.com/p/swiftui-c…</a></li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[HTML的Video从基础使用到高级实战+兼容的完全指南]]></title>    <link>https://juejin.cn/post/7575468252657303593</link>    <guid>https://juejin.cn/post/7575468252657303593</guid>    <pubDate>2025-11-24T00:59:50.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7575468252657303593" data-draft-id="7569898158836432937" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="HTML的Video从基础使用到高级实战+兼容的完全指南"/> <meta itemprop="keywords" content="前端,JavaScript,Vue.js"/> <meta itemprop="datePublished" content="2025-11-24T00:59:50.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="鹏多多"/> <meta itemprop="url" content="https://juejin.cn/user/747323639737191"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            HTML的Video从基础使用到高级实战+兼容的完全指南
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/747323639737191/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    鹏多多
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-24T00:59:50.000Z" title="Mon Nov 24 2025 00:59:50 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读11分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:2;font-weight:400;font-size:15px;overflow-x:hidden;color:#333;letter-spacing:1.2px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1:first-child,.markdown-body h2:first-child,.markdown-body h3:first-child,.markdown-body h4:first-child,.markdown-body h5:first-child,.markdown-body h6:first-child{margin-top:-1.5rem;margin-bottom:1rem}.markdown-body h1:before,.markdown-body h2:before,.markdown-body h3:before,.markdown-body h4:before,.markdown-body h5:before,.markdown-body h6:before{content:"#";display:inline-block;color:#3eaf7c;padding-right:.23em}.markdown-body h1{position:relative;font-size:2.5rem;margin-bottom:5px}.markdown-body h1:before{font-size:2.5rem}.markdown-body h2{padding-bottom:.5rem;font-size:2.2rem;border-bottom:1px solid #ececec}.markdown-body h3{font-size:1.5rem;padding-bottom:0}.markdown-body h4{font-size:1.25rem}.markdown-body h5{font-size:1rem}.markdown-body h6{margin-top:5px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body strong{color:#3eaf7c}.markdown-body img{max-width:100%;border-radius:2px;display:block;margin:auto}.markdown-body hr{border:none;border-top:1px solid #3eaf7c;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;overflow-x:auto;padding:.2rem .5rem;margin:0;color:#3eaf7c;font-size:.85em;background-color:rgba(27,31,35,.05);border-radius:3px}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75;border:.5rem solid #3eaf7c}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{font-weight:500;text-decoration:none;color:#3eaf7c;margin:0 5px}.markdown-body a:active,.markdown-body a:hover{text-decoration:none;border-bottom:1.5px solid #3eaf7c}.markdown-body a[href^=http]:after{content:url("data:image/svg+xml;base64,PHN2ZyBjbGFzcz0iaWNvbiIgdmlld0JveD0iMCAwIDEwMjQgMTAyNCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB3aWR0aD0iMTQiIGhlaWdodD0iMTQiPjxkZWZzPjxzdHlsZS8+PC9kZWZzPjxwYXRoIGQ9Ik04MzIgMTI4SDY0MHY2NGgxNDYuNzUyTDUyMS4zNzYgNDU3LjM3Nmw0NS4yNDggNDUuMjQ4TDgzMiAyMzcuMjQ4VjM4NGg2NFYxMjh6IiBmaWxsPSIjM2VhZjdjIi8+PHBhdGggZD0iTTc2OCA4MzJIMTkyVjI1NmgzNTJ2LTY0SDE2MGEzMiAzMiAwIDAwLTMyIDMydjY0MGEzMiAzMiAwIDAwMzIgMzJoNjQwYTMyIDMyIDAgMDAzMi0zMlY0ODBoLTY0djM1MnoiIGZpbGw9IiMzZWFmN2MiLz48L3N2Zz4=");margin-left:2px}.markdown-body a[href^="#"]:before{content:"#"}.markdown-body table{display:inline-block!important;font-size:13px;width:auto;max-width:100%;overflow:auto;border:1px solid #3eaf7c;border-collapse:collapse}.markdown-body thead{background:#3eaf7c;color:#fff;text-align:left}.markdown-body tr:nth-child(2n){background-color:rgba(153,255,188,.1)}.markdown-body td,.markdown-body th{padding:4px 8px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#7b7878;padding:1px 23px;border-left:.5rem solid;border-color:#42b983;background-color:rgba(66,184,131,.1);position:relative;margin:14px 8px 0}.markdown-body blockquote:before{display:inline-block;position:absolute;content:url("data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjUiIGhlaWdodD0iMjUiIHZpZXdCb3g9IjAgMCAyNyAyNyIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48ZyB0cmFuc2Zvcm09InRyYW5zbGF0ZSgxLjg2MiAxLjg2MikiIGZpbGwtcnVsZT0ibm9uemVybyIgZmlsbD0ibm9uZSI+PGNpcmNsZSBzdHJva2U9IiNGRkYiIHN0cm9rZS13aWR0aD0iMS43MjQiIGZpbGw9IiM0MkI5ODMiIGN4PSIxMS42MzgiIGN5PSIxMS42MzgiIHI9IjExLjYzOCIvPjxwYXRoIGQ9Ik0xNC45NzggNi4yN0E1LjAwNiA1LjAwNiAwIDAwNi42NyA5LjQ2OGE0LjkwMSA0LjkwMSAwIDAwMS43NzMgNC4zNjJjLjMyMy4yNTguNTE0LjY0Ny41MjIgMS4wNnYxLjA2YTIuNjg1IDIuNjg1IDAgMDA1LjM3IDB2LTEuMDA4Yy4wMDItLjM5OC4xNzMtLjc3Ny40Ny0xLjA0MmE1LjAyMyA1LjAyMyAwIDAwLjE3My03LjYzem0tMy4zMzcgMTAuOTY3YTEuMzA0IDEuMzA0IDAgMDEtMS4yODYtMS4yODd2LS4yNzhoMi41NzJ2LjI2MWMwIC43MTMtLjU3MyAxLjI5NC0xLjI4NiAxLjMwNHptMi4yNi00LjQxNWMtLjQ0LjM4My0uNzUuODkzLS44ODcgMS40NmgtMi43NDZhMi44NjggMi44NjggMCAwMC0uOTM4LTEuNTNoLS4wMThhMy40NzYgMy40NzYgMCAwMS0xLjI2OS0zLjE0NSAzLjYxNSAzLjYxNSAwIDAxNy4xOTYuNCAzLjY1IDMuNjUgMCAwMS0xLjMzOCAyLjgxNXoiIGZpbGw9IiNGRkYiLz48L2c+PC9zdmc+");width:25px;height:25px;left:-16px;top:12px}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body details{outline:none;border:none;border-left:4px solid #3eaf7c;padding-left:10px;margin-left:4px}.markdown-body details summary{cursor:pointer;border:none;outline:none;background:#fff;margin:0 -17px}.markdown-body details summary::-webkit-details-marker{color:#3eaf7c}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body ol li::marker{color:#3eaf7c}.markdown-body ul li{list-style:none;padding-left:10px}.markdown-body ul li::marker{content:"•";color:#3eaf7c}.markdown-body ul li.task-list-item:before{content:"";margin-right:0}.markdown-body input[type=checkbox]{vertical-align:text-bottom;box-shadow:inset 0 0 0 10px #fff}.markdown-body input[type=checkbox]:before{content:url("data:image/svg+xml;base64,PHN2ZyBjbGFzcz0iaWNvbiIgdmlld0JveD0iMCAwIDEwMjQgMTAyNCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB3aWR0aD0iMTYiIGhlaWdodD0iMTYiPjxkZWZzPjxzdHlsZS8+PC9kZWZzPjxwYXRoIGQ9Ik04NzcuMDU2IDE0Ni45NDR2NzMwLjExMkgxNDYuOTQ0VjE0Ni45NDRoNzMwLjExMnptMC0xMDQuMjc3SDE0Ni45NDRjLTU3LjYyOCAwLTEwNC4yNzcgNDYuNjQ5LTEwNC4yNzcgMTA0LjI3N3Y3MzAuMTEyYzAgNTcuNjI4IDQ2LjY0OSAxMDQuMjc3IDEwNC4yNzcgMTA0LjI3N2g3MzAuMTEyYzU3LjYyOCAwIDEwNC4yNzctNDYuNjQ5IDEwNC4yNzctMTA0LjI3N1YxNDYuOTQ0YzAtNTcuNjI4LTQ2LjY0OS0xMDQuMjc3LTEwNC4yNzctMTA0LjI3N3oiIGZpbGw9IiMzZWFmN2MiLz48L3N2Zz4=");position:relative;top:-2px;right:2px}.markdown-body input[type=checkbox]:checked:before{content:url("data:image/svg+xml;base64,PHN2ZyBjbGFzcz0iaWNvbiIgdmlld0JveD0iMCAwIDEwMjQgMTAyNCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB3aWR0aD0iMTUiIGhlaWdodD0iMTUiPjxkZWZzPjxzdHlsZS8+PC9kZWZzPjxwYXRoIGQ9Ik05MTAuMjA4IDBIMTEzLjc2QTExNC4xMTIgMTE0LjExMiAwIDAwLS4wMzIgMTEzLjc5MlY5MTAuMjRjMCA2Mi41OTIgNTEuMiAxMTMuNzkyIDExMy43OTIgMTEzLjc5Mmg3OTYuNDQ4YzYyLjU5MiAwIDExMy43OTItNTEuMiAxMTMuNzkyLTExMy43OTJWMTEzLjc5MkMxMDI0IDUxLjIgOTcyLjggMCA5MTAuMjA4IDB6bS01MTIgNzk2LjQ0OEwxMTMuNzYgNTEybDc5LjY0OC03OS42NDggMjA0LjggMjA0LjhMODMwLjU2IDIwNC44bDc5LjY0OCA3OS42NDgtNTEyIDUxMnoiIGZpbGw9IiMzZWFmN2MiLz48L3N2Zz4=");position:relative;top:-2px;right:2px}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="agate">.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#333;color:#fff}.hljs-name,.hljs-strong{font-weight:700}.hljs-code,.hljs-emphasis{font-style:italic}.hljs-tag{color:#62c8f3}.hljs-selector-class,.hljs-selector-id,.hljs-template-variable,.hljs-variable{color:#ade5fc}.hljs-bullet,.hljs-string{color:#a2fca2}.hljs-attribute,.hljs-built_in,.hljs-builtin-name,.hljs-quote,.hljs-section,.hljs-title,.hljs-type{color:#ffa}.hljs-bullet,.hljs-number,.hljs-symbol{color:#d36363}.hljs-keyword,.hljs-literal,.hljs-selector-tag{color:#fcc28c}.hljs-code,.hljs-comment,.hljs-deletion{color:#888}.hljs-link,.hljs-regexp{color:#c6b4f0}.hljs-meta{color:#fc9b9b}.hljs-deletion{background-color:#fc9b9b;color:#333}.hljs-addition{background-color:#a2fca2;color:#333}.hljs a{color:inherit}.hljs a:focus,.hljs a:hover{color:inherit;text-decoration:underline}</style><p>HTML5 的 <code>&lt;video&gt;</code> 标签彻底改变了网页视频播放的实现方式——无需依赖 Flash 等第三方插件，原生支持跨平台视频播放，兼具轻量性与扩展性。本文将从标签基础、API 详解、事件体系、样式控制、兼容性处理等维度，全面解析 <code>&lt;video&gt;</code> 标签的技术细节与实战技巧。</p>
<h2 data-id="heading-0">1. 核心用法与属性</h2>
<p>下面是标签的核心用法与属性：</p>
<h3 data-id="heading-1">1.1. 基本语法结构</h3>
<p><code>&lt;video&gt;</code> 标签的核心作用是嵌入视频资源，最简用法如下：</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-comment">&lt;!-- 基础用法：指定视频源与基础控制 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">video</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"video.mp4"</span> <span class="hljs-attr">controls</span> <span class="hljs-attr">width</span>=<span class="hljs-string">"640"</span> <span class="hljs-attr">height</span>=<span class="hljs-string">"360"</span>&gt;</span>
  <span class="hljs-comment">&lt;!-- 降级提示：浏览器不支持 video 标签时显示 --&gt;</span>
  您的浏览器不支持 HTML5 视频播放，请升级浏览器或更换观看方式。
<span class="hljs-tag">&lt;/<span class="hljs-name">video</span>&gt;</span>
</code></pre>
<h3 data-id="heading-2">1.2. 核心属性详解</h3>




























































<table><thead><tr><th>属性名</th><th>取值</th><th>功能说明</th></tr></thead><tbody><tr><td><code>src</code></td><td>视频文件 URL</td><td>指定单个视频源（优先推荐使用 <code>&lt;source&gt;</code> 标签适配多格式）</td></tr><tr><td><code>controls</code></td><td>布尔值（省略则生效）</td><td>显示浏览器原生控制栏（播放/暂停、音量、进度条等）</td></tr><tr><td><code>autoplay</code></td><td>布尔值</td><td>页面加载完成后自动播放（注意：多数浏览器要求静音才能自动播放）</td></tr><tr><td><code>muted</code></td><td>布尔值</td><td>视频默认静音</td></tr><tr><td><code>loop</code></td><td>布尔值</td><td>视频播放完毕后自动循环</td></tr><tr><td><code>preload</code></td><td><code>auto</code>/<code>metadata</code>/<code>none</code></td><td>预加载策略：<br/>- <code>auto</code>：自动预加载整个视频（默认）<br/>- <code>metadata</code>：仅预加载元数据（时长、尺寸等）<br/>- <code>none</code>：不预加载任何内容</td></tr><tr><td><code>poster</code></td><td>图片 URL</td><td>视频加载完成前/未播放时显示的封面图</td></tr><tr><td><code>width</code>/<code>height</code></td><td>像素值（如 <code>640</code>）</td><td>视频播放器的宽高（建议通过 CSS 控制，更灵活）</td></tr><tr><td><code>playsinline</code></td><td>布尔值</td><td>允许视频在页面内播放（而非全屏，移动端必备）</td></tr><tr><td><code>webkit-playsinline</code></td><td>布尔值</td><td>iOS Safari 兼容属性（与 <code>playsinline</code> 配合使用）</td></tr></tbody></table>
<h3 data-id="heading-3">1.3. 多格式适配： 标签</h3>
<p>不同浏览器对视频格式支持存在差异（如 MP4 兼容所有现代浏览器，WebM 体积更小但兼容性较差），需通过 <code>&lt;source&gt;</code> 标签提供多格式备选：</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">video</span> <span class="hljs-attr">controls</span> <span class="hljs-attr">poster</span>=<span class="hljs-string">"cover.jpg"</span> <span class="hljs-attr">playsinline</span> <span class="hljs-attr">webkit-playsinline</span>&gt;</span>
  <span class="hljs-comment">&lt;!-- 浏览器会按顺序选择支持的格式 --&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">source</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"video.mp4"</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"video/mp4"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">source</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"video.webm"</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"video/webm"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">source</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"video.ogg"</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"video/ogg"</span>&gt;</span>
  您的浏览器不支持 HTML5 视频播放，请升级浏览器。
<span class="hljs-tag">&lt;/<span class="hljs-name">video</span>&gt;</span>
</code></pre>
<p><strong>推荐格式组合</strong>：MP4（主格式）+ WebM（备选），覆盖 99% 以上现代浏览器。</p>
<h2 data-id="heading-4">2. 核心 API：通过JavaScript控制</h2>
<p><code>&lt;video&gt;</code> 元素暴露了丰富的 JavaScript API，可实现自定义播放逻辑、状态查询等功能。获取视频元素后即可调用：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> video = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">'video'</span>); <span class="hljs-comment">// 获取视频元素</span>
</code></pre>
<h3 data-id="heading-5">2.1. 核心方法</h3>





























<table><thead><tr><th>方法名</th><th>功能说明</th></tr></thead><tbody><tr><td><code>play()</code></td><td>开始播放视频，返回 Promise（需处理播放失败场景）</td></tr><tr><td><code>pause()</code></td><td>暂停播放视频</td></tr><tr><td><code>load()</code></td><td>重新加载视频资源（常用于切换视频源后）</td></tr><tr><td><code>canPlayType(type)</code></td><td>检测浏览器是否支持指定视频格式（返回 <code>probably</code>/<code>maybe</code>/<code>""</code>）</td></tr><tr><td><code>requestFullscreen()</code></td><td>进入全屏模式（需兼容前缀：<code>webkitRequestFullscreen</code> 等）</td></tr></tbody></table>
<h3 data-id="heading-6">2.2. 关键属性（可读写/只读）</h3>
<h4 data-id="heading-7">（1）可读写属性（控制视频行为）</h4>



































<table><thead><tr><th>属性名</th><th>类型</th><th>说明</th></tr></thead><tbody><tr><td><code>currentTime</code></td><td>Number</td><td>当前播放位置（秒），可设置跳转</td></tr><tr><td><code>volume</code></td><td>Number</td><td>音量（0~1，0 为静音，1 为最大音量）</td></tr><tr><td><code>playbackRate</code></td><td>Number</td><td>播放速率（1 为正常，0.5 为慢放，2 为快放）</td></tr><tr><td><code>muted</code></td><td>Boolean</td><td>设置是否静音（与标签属性一致）</td></tr><tr><td><code>loop</code></td><td>Boolean</td><td>设置是否循环（与标签属性一致）</td></tr></tbody></table>
<h4 data-id="heading-8">（2）只读属性（获取视频状态）</h4>








































<table><thead><tr><th>属性名</th><th>类型</th><th>说明</th></tr></thead><tbody><tr><td><code>duration</code></td><td>Number</td><td>视频总时长（秒），未加载完成时为 NaN</td></tr><tr><td><code>paused</code></td><td>Boolean</td><td>是否处于暂停状态（true 为暂停）</td></tr><tr><td><code>playing</code></td><td>Boolean</td><td>是否正在播放（H5 新增，需兼容）</td></tr><tr><td><code>buffered</code></td><td>TimeRanges</td><td>已缓冲的时间范围（通过 <code>buffered.start(0)</code>/<code>buffered.end(0)</code> 获取）</td></tr><tr><td><code>readyState</code></td><td>Number</td><td>视频就绪状态：<br/>0 = 未就绪<br/>1 = 元数据就绪<br/>2 = 当前帧就绪<br/>3 = 可播放（已缓冲部分内容）<br/>4 = 完全就绪</td></tr><tr><td><code>networkState</code></td><td>Number</td><td>网络状态：<br/>0 = 未初始化<br/>1 = 正在加载<br/>2 = 加载完成<br/>3 = 加载失败</td></tr></tbody></table>
<h3 data-id="heading-9">2.3. API 实战示例</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> video = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">'video'</span>);

<span class="hljs-comment">// 1. 播放/暂停切换</span>
<span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'playBtn'</span>).<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'click'</span>, <span class="hljs-function">() =&gt;</span> {
  <span class="hljs-keyword">if</span> (video.<span class="hljs-property">paused</span>) {
    <span class="hljs-comment">// 处理自动播放限制（需静音或用户交互后）</span>
    video.<span class="hljs-title function_">play</span>().<span class="hljs-keyword">catch</span>(<span class="hljs-function"><span class="hljs-params">err</span> =&gt;</span> {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'播放失败：'</span>, err);
      video.<span class="hljs-property">muted</span> = <span class="hljs-literal">true</span>;
      video.<span class="hljs-title function_">play</span>(); <span class="hljs-comment">// 静音后重试自动播放</span>
    });
  } <span class="hljs-keyword">else</span> {
    video.<span class="hljs-title function_">pause</span>();
  }
});

<span class="hljs-comment">// 2. 跳转至指定时间（如 30 秒）</span>
<span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'jumpBtn'</span>).<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'click'</span>, <span class="hljs-function">() =&gt;</span> {
  video.<span class="hljs-property">currentTime</span> = <span class="hljs-number">30</span>;
});

<span class="hljs-comment">// 3. 调整音量（50%）</span>
video.<span class="hljs-property">volume</span> = <span class="hljs-number">0.5</span>;

<span class="hljs-comment">// 4. 快放（1.5 倍速）</span>
video.<span class="hljs-property">playbackRate</span> = <span class="hljs-number">1.5</span>;

<span class="hljs-comment">// 5. 检测格式支持</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'MP4 支持：'</span>, video.<span class="hljs-title function_">canPlayType</span>(<span class="hljs-string">'video/mp4'</span>) !== <span class="hljs-string">''</span>);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'WebM 支持：'</span>, video.<span class="hljs-title function_">canPlayType</span>(<span class="hljs-string">'video/webm'</span>) !== <span class="hljs-string">''</span>);
</code></pre>
<h2 data-id="heading-10">3. 监听视频生命周期与状态变化事件</h2>
<p><code>&lt;video&gt;</code> 标签提供了完整的事件机制，可监听播放状态、加载进度、错误等场景，是实现自定义控制逻辑的核心。</p>
<h3 data-id="heading-11">3.1. 核心事件分类与说明</h3>






































































<table><thead><tr><th>事件名</th><th>触发时机</th><th>应用场景</th></tr></thead><tbody><tr><td><code>loadedmetadata</code></td><td>视频元数据（时长、尺寸等）加载完成</td><td>获取视频总时长 <code>duration</code></td></tr><tr><td><code>loadeddata</code></td><td>第一帧视频加载完成并可显示</td><td>隐藏加载动画、显示视频画面</td></tr><tr><td><code>canplay</code></td><td>视频已缓冲足够数据，可开始播放（可能卡顿）</td><td>启用播放按钮</td></tr><tr><td><code>canplaythrough</code></td><td>视频已缓冲至末尾，可流畅播放</td><td>提示“可流畅观看”</td></tr><tr><td><code>play</code></td><td>调用 <code>play()</code> 后开始播放时</td><td>切换播放按钮状态（暂停图标）</td></tr><tr><td><code>pause</code></td><td>调用 <code>pause()</code> 或播放暂停时</td><td>切换播放按钮状态（播放图标）</td></tr><tr><td><code>timeupdate</code></td><td>播放位置 <code>currentTime</code> 变化时（约 250ms 一次）</td><td>更新进度条、显示当前播放时间</td></tr><tr><td><code>progress</code></td><td>视频缓冲时持续触发</td><td>更新缓冲进度条</td></tr><tr><td><code>ended</code></td><td>视频播放完毕时</td><td>显示“播放完成”提示、自动重播</td></tr><tr><td><code>error</code></td><td>视频加载/播放失败时</td><td>显示错误提示（通过 <code>error.code</code> 获取错误类型）</td></tr><tr><td><code>volumechange</code></td><td>音量/静音状态变化时</td><td>更新音量图标</td></tr><tr><td><code>fullscreenchange</code></td><td>全屏状态变化时</td><td>切换全屏/退出全屏按钮</td></tr></tbody></table>
<h3 data-id="heading-12">3.2. 事件监听实战示例</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> video = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">'video'</span>);
<span class="hljs-keyword">const</span> progressBar = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">'.progress-bar'</span>);
<span class="hljs-keyword">const</span> currentTimeText = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">'.current-time'</span>);
<span class="hljs-keyword">const</span> durationText = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">'.duration'</span>);

<span class="hljs-comment">// 1. 元数据加载完成：显示总时长</span>
video.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'loadedmetadata'</span>, <span class="hljs-function">() =&gt;</span> {
  durationText.<span class="hljs-property">textContent</span> = <span class="hljs-title function_">formatTime</span>(video.<span class="hljs-property">duration</span>);
});

<span class="hljs-comment">// 2. 播放位置更新：同步进度条</span>
video.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'timeupdate'</span>, <span class="hljs-function">() =&gt;</span> {
  <span class="hljs-keyword">const</span> progress = (video.<span class="hljs-property">currentTime</span> / video.<span class="hljs-property">duration</span>) * <span class="hljs-number">100</span>;
  progressBar.<span class="hljs-property">style</span>.<span class="hljs-property">width</span> = <span class="hljs-string">`<span class="hljs-subst">${progress}</span>%`</span>;
  currentTimeText.<span class="hljs-property">textContent</span> = <span class="hljs-title function_">formatTime</span>(video.<span class="hljs-property">currentTime</span>);
});

<span class="hljs-comment">// 3. 缓冲进度更新：显示缓冲条</span>
video.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'progress'</span>, <span class="hljs-function">() =&gt;</span> {
  <span class="hljs-keyword">if</span> (video.<span class="hljs-property">buffered</span>.<span class="hljs-property">length</span> &gt; <span class="hljs-number">0</span>) {
    <span class="hljs-keyword">const</span> bufferedEnd = video.<span class="hljs-property">buffered</span>.<span class="hljs-title function_">end</span>(video.<span class="hljs-property">buffered</span>.<span class="hljs-property">length</span> - <span class="hljs-number">1</span>);
    <span class="hljs-keyword">const</span> bufferedProgress = (bufferedEnd / video.<span class="hljs-property">duration</span>) * <span class="hljs-number">100</span>;
    <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">'.buffer-bar'</span>).<span class="hljs-property">style</span>.<span class="hljs-property">width</span> = <span class="hljs-string">`<span class="hljs-subst">${bufferedProgress}</span>%`</span>;
  }
});

<span class="hljs-comment">// 4. 播放完成：提示并重置</span>
video.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'ended'</span>, <span class="hljs-function">() =&gt;</span> {
  <span class="hljs-title function_">alert</span>(<span class="hljs-string">'视频播放完成！'</span>);
  video.<span class="hljs-property">currentTime</span> = <span class="hljs-number">0</span>; <span class="hljs-comment">// 重置播放位置</span>
});

<span class="hljs-comment">// 5. 错误处理：显示错误信息</span>
video.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'error'</span>, <span class="hljs-function">() =&gt;</span> {
  <span class="hljs-keyword">switch</span>(video.<span class="hljs-property">error</span>.<span class="hljs-property">code</span>) {
    <span class="hljs-keyword">case</span> <span class="hljs-number">1</span>: <span class="hljs-title function_">alert</span>(<span class="hljs-string">'视频加载中断'</span>); <span class="hljs-keyword">break</span>;
    <span class="hljs-keyword">case</span> <span class="hljs-number">2</span>: <span class="hljs-title function_">alert</span>(<span class="hljs-string">'不支持的视频格式'</span>); <span class="hljs-keyword">break</span>;
    <span class="hljs-keyword">case</span> <span class="hljs-number">3</span>: <span class="hljs-title function_">alert</span>(<span class="hljs-string">'视频解码失败'</span>); <span class="hljs-keyword">break</span>;
    <span class="hljs-keyword">case</span> <span class="hljs-number">4</span>: <span class="hljs-title function_">alert</span>(<span class="hljs-string">'视频加载超时'</span>); <span class="hljs-keyword">break</span>;
  }
});

<span class="hljs-comment">// 辅助函数：格式化时间（秒 → 分:秒，如 125 → 2:05）</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">formatTime</span>(<span class="hljs-params">seconds</span>) {
  <span class="hljs-keyword">if</span> (<span class="hljs-built_in">isNaN</span>(seconds)) <span class="hljs-keyword">return</span> <span class="hljs-string">'0:00'</span>;
  <span class="hljs-keyword">const</span> min = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">floor</span>(seconds / <span class="hljs-number">60</span>);
  <span class="hljs-keyword">const</span> sec = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">floor</span>(seconds % <span class="hljs-number">60</span>);
  <span class="hljs-keyword">return</span> <span class="hljs-string">`<span class="hljs-subst">${min}</span>:<span class="hljs-subst">${sec.toString().padStart(<span class="hljs-number">2</span>, <span class="hljs-string">'0'</span>)}</span>`</span>;
}
</code></pre>
<h2 data-id="heading-13">4. 自定义播放器外观样式</h2>
<p>浏览器原生控制栏样式难以适配不同网页设计，通过隐藏原生 <code>controls</code>，使用 CSS 自定义播放器界面是更常用的方案。</p>
<h3 data-id="heading-14">4.1. 基础样式控制</h3>
<pre><code class="hljs language-css" lang="css"><span class="hljs-comment">/* 1. 视频容器样式（统一尺寸、边框、圆角） */</span>
<span class="hljs-selector-class">.video-container</span> {
  <span class="hljs-attribute">position</span>: relative;
  <span class="hljs-attribute">width</span>: <span class="hljs-number">100%</span>;
  <span class="hljs-attribute">max-width</span>: <span class="hljs-number">1280px</span>;
  <span class="hljs-attribute">margin</span>: <span class="hljs-number">0</span> auto;
  <span class="hljs-attribute">border-radius</span>: <span class="hljs-number">8px</span>;
  <span class="hljs-attribute">overflow</span>: hidden;
  <span class="hljs-attribute">box-shadow</span>: <span class="hljs-number">0</span> <span class="hljs-number">2px</span> <span class="hljs-number">10px</span> <span class="hljs-built_in">rgba</span>(<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0.1</span>);
}

<span class="hljs-comment">/* 2. 视频元素样式（填充容器，避免变形） */</span>
<span class="hljs-selector-class">.video-container</span> <span class="hljs-selector-tag">video</span> {
  <span class="hljs-attribute">width</span>: <span class="hljs-number">100%</span>;
  <span class="hljs-attribute">height</span>: auto;
  <span class="hljs-attribute">object-fit</span>: cover; <span class="hljs-comment">/* 保持宽高比，填充容器（可能裁剪边缘） */</span>
  <span class="hljs-attribute">background</span>: <span class="hljs-number">#000</span>; <span class="hljs-comment">/* 未加载时显示黑色背景 */</span>
}

<span class="hljs-comment">/* 3. 封面图样式（与视频同尺寸） */</span>
<span class="hljs-selector-class">.video-container</span> poster {
  <span class="hljs-attribute">object-fit</span>: cover;
}
</code></pre>
<h3 data-id="heading-15">4.2. 自定义控制栏样式</h3>
<p>通过绝对定位在视频底部创建自定义控制栏，默认隐藏，鼠标悬浮时显示：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-comment">/* 控制栏容器 */</span>
<span class="hljs-selector-class">.video-controls</span> {
  <span class="hljs-attribute">position</span>: absolute;
  <span class="hljs-attribute">bottom</span>: <span class="hljs-number">0</span>;
  <span class="hljs-attribute">left</span>: <span class="hljs-number">0</span>;
  <span class="hljs-attribute">right</span>: <span class="hljs-number">0</span>;
  <span class="hljs-attribute">padding</span>: <span class="hljs-number">10px</span>;
  <span class="hljs-attribute">background</span>: <span class="hljs-built_in">linear-gradient</span>(transparent, <span class="hljs-built_in">rgba</span>(<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0.7</span>)); <span class="hljs-comment">/* 渐变背景 */</span>
  <span class="hljs-attribute">color</span>: <span class="hljs-number">#fff</span>;
  <span class="hljs-attribute">opacity</span>: <span class="hljs-number">0</span>;
  <span class="hljs-attribute">transition</span>: opacity <span class="hljs-number">0.3s</span> ease;
  <span class="hljs-attribute">display</span>: flex;
  <span class="hljs-attribute">flex-direction</span>: column;
  <span class="hljs-attribute">gap</span>: <span class="hljs-number">8px</span>;
}

<span class="hljs-comment">/* 鼠标悬浮时显示控制栏 */</span>
<span class="hljs-selector-class">.video-container</span><span class="hljs-selector-pseudo">:hover</span> <span class="hljs-selector-class">.video-controls</span> {
  <span class="hljs-attribute">opacity</span>: <span class="hljs-number">1</span>;
}

<span class="hljs-comment">/* 进度条容器 */</span>
<span class="hljs-selector-class">.progress-container</span> {
  <span class="hljs-attribute">height</span>: <span class="hljs-number">4px</span>;
  <span class="hljs-attribute">background</span>: <span class="hljs-built_in">rgba</span>(<span class="hljs-number">255</span>,<span class="hljs-number">255</span>,<span class="hljs-number">255</span>,<span class="hljs-number">0.3</span>);
  <span class="hljs-attribute">border-radius</span>: <span class="hljs-number">2px</span>;
  <span class="hljs-attribute">cursor</span>: pointer;
}

<span class="hljs-comment">/* 已播放进度条 */</span>
<span class="hljs-selector-class">.progress-bar</span> {
  <span class="hljs-attribute">height</span>: <span class="hljs-number">100%</span>;
  <span class="hljs-attribute">background</span>: <span class="hljs-number">#ff4400</span>;
  <span class="hljs-attribute">border-radius</span>: <span class="hljs-number">2px</span>;
  <span class="hljs-attribute">width</span>: <span class="hljs-number">0%</span>;
}

<span class="hljs-comment">/* 缓冲进度条（叠加在进度条下方） */</span>
<span class="hljs-selector-class">.buffer-bar</span> {
  <span class="hljs-attribute">height</span>: <span class="hljs-number">100%</span>;
  <span class="hljs-attribute">background</span>: <span class="hljs-built_in">rgba</span>(<span class="hljs-number">255</span>,<span class="hljs-number">255</span>,<span class="hljs-number">255</span>,<span class="hljs-number">0.5</span>);
  <span class="hljs-attribute">border-radius</span>: <span class="hljs-number">2px</span>;
  <span class="hljs-attribute">width</span>: <span class="hljs-number">0%</span>;
  <span class="hljs-attribute">position</span>: absolute;
  <span class="hljs-attribute">top</span>: <span class="hljs-number">0</span>;
  <span class="hljs-attribute">left</span>: <span class="hljs-number">0</span>;
  <span class="hljs-attribute">z-index</span>: <span class="hljs-number">1</span>;
}

<span class="hljs-comment">/* 控制按钮区域 */</span>
<span class="hljs-selector-class">.controls-buttons</span> {
  <span class="hljs-attribute">display</span>: flex;
  <span class="hljs-attribute">align-items</span>: center;
  <span class="hljs-attribute">gap</span>: <span class="hljs-number">16px</span>;
  <span class="hljs-attribute">font-size</span>: <span class="hljs-number">14px</span>;
}

<span class="hljs-comment">/* 按钮样式 */</span>
<span class="hljs-selector-class">.controls-btn</span> {
  <span class="hljs-attribute">background</span>: transparent;
  <span class="hljs-attribute">border</span>: none;
  <span class="hljs-attribute">color</span>: <span class="hljs-number">#fff</span>;
  <span class="hljs-attribute">cursor</span>: pointer;
  <span class="hljs-attribute">font-size</span>: <span class="hljs-number">16px</span>;
  <span class="hljs-attribute">transition</span>: color <span class="hljs-number">0.2s</span>;
}

<span class="hljs-selector-class">.controls-btn</span><span class="hljs-selector-pseudo">:hover</span> {
  <span class="hljs-attribute">color</span>: <span class="hljs-number">#ff4400</span>;
}

<span class="hljs-comment">/* 音量控制滑块 */</span>
<span class="hljs-selector-class">.volume-slider</span> {
  <span class="hljs-attribute">width</span>: <span class="hljs-number">60px</span>;
  <span class="hljs-attribute">height</span>: <span class="hljs-number">4px</span>;
  <span class="hljs-attribute">background</span>: <span class="hljs-built_in">rgba</span>(<span class="hljs-number">255</span>,<span class="hljs-number">255</span>,<span class="hljs-number">255</span>,<span class="hljs-number">0.3</span>);
  <span class="hljs-attribute">border-radius</span>: <span class="hljs-number">2px</span>;
  <span class="hljs-attribute">outline</span>: none;
  accent-<span class="hljs-attribute">color</span>: <span class="hljs-number">#ff4400</span>; <span class="hljs-comment">/* 自定义滑块颜色 */</span>
}
</code></pre>
<h3 data-id="heading-16">4.3. 自定义控制栏 HTML 结构</h3>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"video-container"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">video</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"video.mp4"</span> <span class="hljs-attr">poster</span>=<span class="hljs-string">"cover.jpg"</span> <span class="hljs-attr">playsinline</span> <span class="hljs-attr">webkit-playsinline</span>&gt;</span>
    您的浏览器不支持 HTML5 视频播放。
  <span class="hljs-tag">&lt;/<span class="hljs-name">video</span>&gt;</span>
  <span class="hljs-comment">&lt;!-- 自定义控制栏 --&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"video-controls"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"progress-container"</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"progressContainer"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"buffer-bar"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"progress-bar"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"controls-buttons"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"controls-btn"</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"playBtn"</span>&gt;</span>▶️<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"current-time"</span>&gt;</span>0:00<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span>/<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"duration"</span>&gt;</span>0:00<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"range"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"volume-slider"</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"volumeSlider"</span> <span class="hljs-attr">min</span>=<span class="hljs-string">"0"</span> <span class="hljs-attr">max</span>=<span class="hljs-string">"1"</span> <span class="hljs-attr">step</span>=<span class="hljs-string">"0.01"</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"1"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"controls-btn"</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"fullscreenBtn"</span>&gt;</span>⛶<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
</code></pre>
<h2 data-id="heading-17">5. 兼容性处理与常见问题</h2>
<p>下面是一些兼容性处理与常见问题：</p>
<h3 data-id="heading-18">5.1. 浏览器兼容性</h3>
<h4 data-id="heading-19">（1）核心兼容性现状</h4>
<ul>
<li><strong>现代浏览器</strong>：Chrome、Firefox、Safari、Edge 均完美支持 <code>&lt;video&gt;</code> 标签及核心 API。</li>
<li><strong>移动端</strong>：iOS Safari、Android Chrome 支持良好，但需注意 <code>playsinline</code> 属性（避免自动全屏）。</li>
<li><strong>旧浏览器</strong>：IE8 及以下不支持 <code>&lt;video&gt;</code> 标签，需通过降级提示或 Flash 备用方案（已不推荐）。</li>
</ul>
<h4 data-id="heading-20">（2）格式兼容性</h4>

























<table><thead><tr><th>视频格式</th><th>支持浏览器</th><th>优势</th></tr></thead><tbody><tr><td>MP4（H.264 + AAC）</td><td>所有现代浏览器、iOS、Android</td><td>兼容性最好，推荐主格式</td></tr><tr><td>WebM（VP8/VP9 + Vorbis）</td><td>Chrome、Firefox、Edge</td><td>体积小、开源，备选格式</td></tr><tr><td>OGG（Theora + Vorbis）</td><td>Chrome、Firefox</td><td>开源，兼容性较差（几乎不用）</td></tr></tbody></table>
<h4 data-id="heading-21">（3）API 兼容性处理</h4>
<p>部分 API 需添加浏览器前缀（如全屏、播放速率），示例如下：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 全屏兼容处理</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">toggleFullscreen</span>(<span class="hljs-params">video</span>) {
  <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">document</span>.<span class="hljs-property">fullscreenElement</span>) {
    <span class="hljs-comment">// 退出全屏</span>
    <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">exitFullscreen</span>().<span class="hljs-keyword">catch</span>(<span class="hljs-function"><span class="hljs-params">err</span> =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(err));
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-comment">// 进入全屏（兼容前缀）</span>
    <span class="hljs-keyword">if</span> (video.<span class="hljs-property">requestFullscreen</span>) {
      video.<span class="hljs-title function_">requestFullscreen</span>();
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (video.<span class="hljs-property">webkitRequestFullscreen</span>) { <span class="hljs-comment">// Safari</span>
      video.<span class="hljs-title function_">webkitRequestFullscreen</span>();
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (video.<span class="hljs-property">msRequestFullscreen</span>) { <span class="hljs-comment">// IE/Edge</span>
      video.<span class="hljs-title function_">msRequestFullscreen</span>();
    }
  }
}

<span class="hljs-comment">// 播放速率兼容性（部分旧浏览器不支持）</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">setPlaybackRate</span>(<span class="hljs-params">video, rate</span>) {
  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> video.<span class="hljs-property">playbackRate</span> !== <span class="hljs-string">'undefined'</span>) {
    video.<span class="hljs-property">playbackRate</span> = rate;
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-title function_">alert</span>(<span class="hljs-string">'您的浏览器不支持播放速率调整'</span>);
  }
}
</code></pre>
<h3 data-id="heading-22">5.2. 常见问题与解决方案</h3>
<h4 data-id="heading-23">（1）自动播放失败</h4>
<ul>
<li><strong>原因</strong>：现代浏览器限制“非静音自动播放”（需用户交互后才能播放有声视频）。</li>
<li><strong>解决方案</strong>：
<ol>
<li>默认静音自动播放（<code>muted autoplay</code>），提供“开启声音”按钮。</li>
<li>引导用户点击后播放（如“点击播放”封面图）。</li>
</ol>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">video</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"video.mp4"</span> <span class="hljs-attr">autoplay</span> <span class="hljs-attr">muted</span> <span class="hljs-attr">playsinline</span>&gt;</span>...<span class="hljs-tag">&lt;/<span class="hljs-name">video</span>&gt;</span>
</code></pre>
</li>
</ul>
<h4 data-id="heading-24">（2）视频加载缓慢/卡顿</h4>
<ul>
<li><strong>解决方案</strong>：
<ol>
<li>提供多码率视频（根据网络状况切换）。</li>
<li>使用 <code>preload="metadata"</code> 优化预加载策略。</li>
<li>显示缓冲进度条，提示用户“缓冲中”。</li>
<li>采用 CDN 分发视频资源，提升加载速度。</li>
</ol>
</li>
</ul>
<h4 data-id="heading-25">（3）视频比例变形</h4>
<ul>
<li><strong>原因</strong>：播放器宽高与视频原生宽高比不一致。</li>
<li><strong>解决方案</strong>：使用 <code>object-fit</code> 属性控制视频填充方式：
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-tag">video</span> {
  <span class="hljs-attribute">object-fit</span>: cover; <span class="hljs-comment">/* 保持宽高比，填充容器（裁剪边缘） */</span>
  <span class="hljs-comment">/* 或 object-fit: contain; 保持宽高比，完整显示（可能留黑边） */</span>
}
</code></pre>
</li>
</ul>
<h4 data-id="heading-26">（4）移动端自动全屏播放</h4>
<ul>
<li><strong>原因</strong>：iOS Safari 默认会将视频全屏播放（无 <code>playsinline</code> 属性时）。</li>
<li><strong>解决方案</strong>：添加 <code>playsinline</code> 和 <code>webkit-playsinline</code> 属性：
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">video</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"video.mp4"</span> <span class="hljs-attr">playsinline</span> <span class="hljs-attr">webkit-playsinline</span>&gt;</span>...<span class="hljs-tag">&lt;/<span class="hljs-name">video</span>&gt;</span>
</code></pre>
</li>
</ul>
<h2 data-id="heading-27">6. 总结</h2>
<p>HTML5 <code>&lt;video&gt;</code> 标签凭借原生、轻量、可扩展的特性，成为网页视频播放的标准方案。通过本文的讲解，你可以掌握：</p>
<ol>
<li>标签基础属性与多格式适配技巧；</li>
<li>核心 API 的使用的（播放控制、状态查询）；</li>
<li>完整事件体系的应用（监听播放状态、缓冲进度等）；</li>
<li>自定义播放器的样式设计与逻辑实现；</li>
<li>兼容性处理与常见问题解决方案。</li>
</ol>
<p>在实际开发中，可根据需求灵活组合上述技术——简单场景直接使用原生控制栏，复杂场景（如视频网站、教育平台）则通过自定义控制栏与 API 实现个性化功能（如倍速播放、弹幕、画中画等）。随着浏览器技术的迭代，<code>&lt;video&gt;</code> 标签的功能将持续完善，为网页视频体验带来更多可能。</p>
<hr/>
<blockquote>
<p>本次分享就到这儿啦，我是鹏多多，深耕前端的技术创作者，如果您看了觉得有帮助，欢迎评论，关注，点赞，转发，我们下次见~</p>
</blockquote>
<p>PS：在本页按F12，在console中输入document.getElementsByClassName('panel-btn')[0].click();有惊喜哦~</p>
<p><code>往期文章</code></p>
<ul>
<li><a href="https://juejin.cn/post/7568192652286754870" target="_blank" title="https://juejin.cn/post/7568192652286754870">纯前端提取图片颜色插件Color-Thief教学+实战完整指南</a></li>
<li><a href="https://juejin.cn/post/7565737512816771135" target="_blank" title="https://juejin.cn/post/7565737512816771135">react-konva实战指南：Canvas高性能+易维护的组件化图形开发实现教程</a></li>
<li><a href="https://juejin.cn/post/7560905838074462271" target="_blank" title="https://juejin.cn/post/7560905838074462271">React无限滚动插件react-infinite-scroll-component的配置+优化+避坑指南</a></li>
<li><a href="https://juejin.cn/post/7560542615484137491" target="_blank" title="https://juejin.cn/post/7560542615484137491">前端音频兼容解决：音频神器howler.js从基础到进阶完整使用指南</a></li>
<li><a href="https://juejin.cn/post/7559871680015024169" target="_blank" title="https://juejin.cn/post/7559871680015024169">使用React-OAuth进行Google/GitHub登录的教程和案例</a></li>
<li><a href="https://juejin.cn/post/7550585427834404927" target="_blank" title="https://juejin.cn/post/7550585427834404927">纯前端人脸识别利器：face-api.js手把手深入解析教学</a></li>
<li><a href="https://juejin.cn/post/7553865490732433462" target="_blank" title="https://juejin.cn/post/7553865490732433462">关于React父组件调用子组件方法forwardRef的详解和案例</a></li>
<li><a href="https://juejin.cn/post/7553484874609410074" target="_blank" title="https://juejin.cn/post/7553484874609410074">React跨组件数据共享useContext详解和案例</a></li>
<li><a href="https://juejin.cn/post/7545087762837815334" target="_blank" title="https://juejin.cn/post/7545087762837815334">Web图像编辑神器tui.image-editor从基础到进阶的实战指南</a></li>
<li><a href="https://juejin.cn/post/7544323659788288046" target="_blank" title="https://juejin.cn/post/7544323659788288046">开发个人微信小程序类目选择/盈利方式/成本控制与服务器接入指南</a></li>
<li><a href="https://juejin.cn/post/7541741121400864778" target="_blank" title="https://juejin.cn/post/7541741121400864778">前端图片裁剪Cropper.js核心功能与实战技巧详解</a></li>
<li><a href="https://juejin.cn/post/7536530451461472265" target="_blank" title="https://juejin.cn/post/7536530451461472265">编辑器也有邪修？盘点VS Code邪门/有趣的扩展</a></li>
<li><a href="https://juejin.cn/post/7535005018257981466" target="_blank" title="https://juejin.cn/post/7535005018257981466">js使用IntersectionObserver实现目标元素可见度的交互</a></li>
<li><a href="https://juejin.cn/post/7534547200330121225" target="_blank" title="https://juejin.cn/post/7534547200330121225">Web前端页面开发阿拉伯语种适配指南</a></li>
<li><a href="https://juejin.cn/post/7516122409948020736" target="_blank" title="https://juejin.cn/post/7516122409948020736">让网页拥有App体验？PWA 将网页变为桌面应用的保姆级教程PWA</a></li>
<li><a href="https://juejin.cn/post/6953803916484018206" target="_blank" title="https://juejin.cn/post/6953803916484018206">使用nvm管理node.js版本以及更换npm淘宝镜像源</a></li>
<li><a href="https://juejin.cn/post/7140443283209060383" target="_blank" title="https://juejin.cn/post/7140443283209060383">手把手教你搭建规范的团队vue项目，包含commitlint，eslint，prettier，husky，commitizen等等</a></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[栗子前端技术周刊第 107 期 - Angular v21、pnpm 10.22、React 2025 现状调查...]]></title>    <link>https://juejin.cn/post/7575458028255903787</link>    <guid>https://juejin.cn/post/7575458028255903787</guid>    <pubDate>2025-11-24T01:00:56.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7575458028255903787" data-draft-id="7575349314945384489" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="栗子前端技术周刊第 107 期 - Angular v21、pnpm 10.22、React 2025 现状调查..."/> <meta itemprop="keywords" content="前端,JavaScript,Angular.js"/> <meta itemprop="datePublished" content="2025-11-24T01:00:56.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="晓得迷路了"/> <meta itemprop="url" content="https://juejin.cn/user/2172290706715565"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            栗子前端技术周刊第 107 期 - Angular v21、pnpm 10.22、React 2025 现状调查...
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2172290706715565/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    晓得迷路了
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-24T01:00:56.000Z" title="Mon Nov 24 2025 01:00:56 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>🌰<strong>栗子前端技术周刊第 107 期 (2025.11.17 - 2025.11.23)</strong>：浏览前端一周最新消息，学习国内外优秀文章视频，让我们保持对前端的好奇心。</p>
<h2 data-id="heading-0">📰 技术资讯</h2>
<ol>
<li>
<p><strong><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.angular.dev%2Fannouncing-angular-v21-57946c34f14b" target="_blank" title="https://blog.angular.dev/announcing-angular-v21-57946c34f14b" ref="nofollow noopener noreferrer">Angular v21</a></strong>：谷歌发布 Angular v21 版本，本次更新不仅打造了一场复古游戏主题的探索之旅，用于展示新版本的各项新特性，还推出了一系列高质量视频，集中演示了以下功能：基于信号（signal-based）的表单处理新方案、支持 AI 驱动工作流的 MCP 服务器、专注于可访问性（无障碍性）的无头组件库，甚至还新增了一款“Angular AI 导师”工具，助力开发者快速上手新版本。</p>
</li>
<li>
<p><strong><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fpnpm%2Fpnpm%2Freleases%2Ftag%2Fv10.22.0" target="_blank" title="https://github.com/pnpm/pnpm/releases/tag/v10.22.0" ref="nofollow noopener noreferrer">pnpm 10.22</a></strong>： pnpm 10.22 发布，该版本新增 <code>trustPolicyExclude</code> 配置项，可用于指定“即便存在其他信任策略要求，仍需安装”的包。</p>
</li>
<li>
<p><strong><a href="https://link.juejin.cn?target=https%3A%2F%2Fsurvey.devographics.com%2Fen-US%2Fsurvey%2Fstate-of-react%2F2025" target="_blank" title="https://survey.devographics.com/en-US/survey/state-of-react/2025" ref="nofollow noopener noreferrer">React 2025 现状调查</a></strong>：React 2025 现状调查现已开启，问卷提交将于 11 月 25 日截止，有兴趣的可以参加。</p>
</li>
</ol>
<h2 data-id="heading-1">📒 技术文章</h2>
<ol>
<li>
<p><strong><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.readwriterachel.com%2Fthings-i-learned%2F2025%2F11%2F09%2Fdevtools-1.html" target="_blank" title="https://www.readwriterachel.com/things-i-learned/2025/11/09/devtools-1.html" ref="nofollow noopener noreferrer">Six Things I Bet You Didn't Know You Could Do With Chrome's Devtools, Part 1</a></strong>：你可能不知道的 Chrome 开发者工具六大用法（第一部分）- 本篇文章将介绍使用 <code>console.time ()</code> 和 <code>console.timeEnd ()</code> 的计时功能、监听任意 DOM 元素的变化和监控浏览器上下文环境中的任意函数，其他部分将在下篇文章介绍。</p>
</li>
<li>
<p><strong><a href="https://juejin.cn/post/7573193563053522985" target="_blank" title="https://juejin.cn/post/7573193563053522985">Cursor 一年深度开发实践：前端开发的效率革命</a></strong>：本文作者分享了使用 Cursor 进行前端开发的实践经验，展示了移动端、PC 端多个项目中 Cursor 的高效应用，还验证了其工程化处理能力。</p>
</li>
<li>
<p><strong><a href="https://juejin.cn/post/7574739133945675818" target="_blank" title="https://juejin.cn/post/7574739133945675818">转转 UI 自动化走查方案探索</a></strong>：文章围绕转转 UI 自动化走查方案展开，先指出当前 UI 走查存在效率低、还原度难控等问题。后经调研，选择基于前端与 UI 节点的比对方案，介绍了数据结构设计、归一化处理流程，包括处理行高、边距合并等问题。</p>
</li>
</ol>
<h2 data-id="heading-2">🔧 开发工具</h2>
<ol>
<li><strong><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fwebpack%2Fwebpack-bundle-analyzer" target="_blank" title="https://github.com/webpack/webpack-bundle-analyzer" ref="nofollow noopener noreferrer">Webpack Bundle Analyzer 5.0</a></strong>：可视化查看 Webpack 输出内容。</li>
</ol>
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9bb3a440bff345f0b03eba7d4aba6eab~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pmT5b6X6L-36Lev5LqG:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764550855&amp;x-signature=9je5azl1fJJrDcFMLFw%2FW9gchz8%3D" width="100%" alt="image-20251123131443566" loading="lazy"/>
<ol start="2">
<li><strong><a href="https://link.juejin.cn?target=https%3A%2F%2Fmarked.js.org%2F" target="_blank" title="https://marked.js.org/" ref="nofollow noopener noreferrer">Marked.js 17.0</a></strong>：快速的 Markdown 解析器与编译器，Marked.js 可作为客户端库、服务器端库使用，甚至还支持命令行界面（CLI）。</li>
</ol>
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4c8b7db9835e4222ba98e6cf9c833fdd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pmT5b6X6L-36Lev5LqG:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764550855&amp;x-signature=lkzYBVSsp5I5dWUUnfvV5AsHui8%3D" width="100%" alt="image-20251123131824469" loading="lazy"/>
<ol start="3">
<li><strong><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fsindresorhus%2Fis-online" target="_blank" title="https://github.com/sindresorhus/is-online" ref="nofollow noopener noreferrer">is-online 12.0</a></strong>：该工具可在 Node.js 环境与浏览器环境中运行，并通过多种方式判断互联网是否真正处于可用状态。</li>
</ol>
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2390c77a08cb4b4d84ed457f7bdd5b8d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pmT5b6X6L-36Lev5LqG:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764550855&amp;x-signature=YbfZ6viLVv%2F3tb3pczX6ciMA10E%3D" width="100%" alt="image-20251123132105379" loading="lazy"/>
<p>🚀🚀🚀 <em>以上资讯文章选自常见周刊，如 JavaScript Weekly 等，周刊内容也会不断优化改进，希望你们能够喜欢。</em></p>
<p>💖 <strong>欢迎关注微信公众号：栗子前端</strong></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[回顾 Flutter Flight Plans ，关于 Flutter 的现状和官方热门问题解答]]></title>    <link>https://juejin.cn/post/7575438636331630643</link>    <guid>https://juejin.cn/post/7575438636331630643</guid>    <pubDate>2025-11-23T23:10:03.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7575438636331630643" data-draft-id="7575182522412056614" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="回顾 Flutter Flight Plans ，关于 Flutter 的现状和官方热门问题解答"/> <meta itemprop="keywords" content="前端,Android,Flutter"/> <meta itemprop="datePublished" content="2025-11-23T23:10:03.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="恋猫de小郭"/> <meta itemprop="url" content="https://juejin.cn/user/817692379985752"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            回顾 Flutter Flight Plans ，关于 Flutter 的现状和官方热门问题解答
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/817692379985752/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    恋猫de小郭
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-23T23:10:03.000Z" title="Sun Nov 23 2025 23:10:03 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#595959;font-size:15px;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(60,10,30,.04) 3%,transparent 0),linear-gradient(1turn,rgba(60,10,30,.04) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body p{color:#595959;font-size:15px;line-height:2;font-weight:400}.markdown-body p+p{margin-top:16px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin:0;color:#135ce0}.markdown-body h1{position:relative;text-align:center;font-size:22px;margin:50px 0}.markdown-body h1:before{position:absolute;content:"";top:-10px;left:50%;width:32px;height:32px;transform:translateX(-50%);background-size:100% 100%;opacity:.36;background-repeat:no-repeat;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC)}.markdown-body h2{position:relative;font-size:20px;border-left:4px solid;padding:0 0 0 10px;margin:30px 0}.markdown-body h3{font-size:16px}.markdown-body ul{list-style:disc outside;margin-left:2em;margin-top:1em}.markdown-body li{line-height:2;color:#595959}.markdown-body img.loaded{margin:0 auto;display:block}.markdown-body blockquote{background:#fff9f9;margin:2em 0;padding:2px 20px;border-left:4px solid #b2aec5}.markdown-body blockquote p{color:#666;line-height:2}.markdown-body a{color:#036aca;border-bottom:1px solid rgba(3,106,202,.8);font-weight:400;text-decoration:none}.markdown-body em strong,.markdown-body strong{color:#036aca}.markdown-body hr{border-top:1px solid #135ce0}.markdown-body pre{overflow:auto}.markdown-body code,.markdown-body pre{overflow:auto;position:relative;line-height:1.75;font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body table{border-collapse:collapse;margin:1rem 0;overflow-x:auto}.markdown-body table td,.markdown-body table th{border:1px solid #dfe2e5;padding:.6em 1em}.markdown-body table tr{border-top:1px solid #dfe2e5}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在 Flutter 官方刚举行的 Flutter Flight Plans 直播里，除了发布 <a href="https://juejin.cn/post/7571693273728696356" target="_blank" title="https://juejin.cn/post/7571693273728696356">Flutter 3.38</a> 和 <a href="https://juejin.cn/post/7571693273728942116" target="_blank" title="https://juejin.cn/post/7571693273728942116">Dart 3.10</a> 之外，其实还有不少值得一聊的内容，例如企业级的 Flutter 案例展示，Flutter + AI 的场景，<strong>重点还有针对大量热门问题的 Q&amp;A（多窗口、GenUI、PC\Web 插件） 等</strong>。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/386bfd4bcee6451496243bacf8d47bff~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764544202&amp;x-signature=1muYt9WJ5nXNlKAeVA6jCmZ%2BHu4%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-0">NotebookLM</h2>
<p>首先，在经典案例展示上，本次 Flutter 官方展示的是今年谷歌刚发布的 Notebook LM ，这是一款由谷歌开发的 AI 驱动研究助手，核心是可以是基于用户提供的资料（如 PDF、网站、YouTube 视频等）生成信息，<strong>并提供准确的引用来源</strong>。</p>
<blockquote>
<p>提供准确和有效的引用来源这个在 AI 使用里很重要。</p>
</blockquote>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7eecd62716c943c58babe8d2042c098a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764544202&amp;x-signature=AITo%2Fj7WTzN5AmTc%2F8Rq7KnKtpk%3D" alt="" loading="lazy"/></p>
<p>年初，<strong>NotebookLM 桌面版应用因为它提供的 “音频概览”（Audio Overview，可生成逼真的双人对话播客）功能迅速走红</strong>，随着用户对移动应用的需求激增，团队决定加速开发，并选择了 Flutter ，这个案例展示了几个特点：</p>
<ul>
<li><strong>团队仅 4 名工程师</strong></li>
<li>基于社区插件，几乎不需触及原生层</li>
<li>全球 170 多个国家多语言同步上线</li>
<li><strong>7 个月内完成了产品的上线发布</strong></li>
<li>在 Google Play Store 和 Apple App Store 上均<strong>获得 4.8 的高分</strong>，同时成为 Apple App Store 推荐精品应用</li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/85629b46ad6144128ded70abfaae8196~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764544202&amp;x-signature=nv5uxpynYi68uvvrIgdqGGTNdPY%3D" alt="" loading="lazy"/></p>
<blockquote>
<p>这也是继 Google Pay、Google Earth、Google Ads、Google Classroom、Google Cloud 、YouTube Create、Google One、Google Analytics 之后谷歌采用 Flutter 开发的另一个经典应用。</p>
</blockquote>
<h2 data-id="heading-1">Flutter + AI</h2>
<p>在 Flutter + AI 的展示上，官方首先展示了 Gemini CLI + Flutter Extension for Gemini CLI （MCP）如何通过 AI 自动化从零开发一个 App 。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c580e387da7a4c29b3111ce19272478a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764544202&amp;x-signature=LqSMVH%2BGEfRh0BQP3wMxMGMc%2BVA%3D" alt="" loading="lazy"/></p>
<p>其核心主要是：</p>
<ul>
<li>利用 Gemini CLI 的“思维链” (Chain of Thought) 推理来执行任务</li>
<li>利用 Flutter Extension 的 Dart 和 Flutter MCP 服务提供检查 Dart 错误、连接运行中的应用进行热重载、最佳实践rules，以及 <strong><code>/create app</code>, <code>/modify</code>, <code>/commit</code></strong> 等命令来驱动规范化应用开发。</li>
</ul>
<p>整个流程从 <code>/create app</code> 开始，生成应用规格说明 (<code>design.md</code>) 和实现计划 (<code>implementation.md</code>)，然后逐步构建应用，这个过程 AI Agent 能自动执行任务、使用 <code>launch app</code> 工具启动应用，并在应用运行时进行热重载 。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/80263a3458b54ae384eb52a479ed94a6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764544202&amp;x-signature=zj%2FEyDw7RxHTCC3Xxw5qHzv%2FE%2FE%3D" alt="" loading="lazy"/></p>
<p>最后，团队还是演示了如何使用 Google 的另一款 AI 工具 Stitch 生成设计稿 HTML 和截图，然后将文件输入 Gemini CLI，Gemini 能够基于图像生成和更新 Dart 源代码，并自动触发热重载更新 App 。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/77f060e6b68646fdae379712d50117e6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764544202&amp;x-signature=wl%2B7AYajsDrx5NIc4K8w6vMn0ys%3D" alt="image-20251114091720980" loading="lazy"/></p>
<p>接着官方展示了两个 AI 驱动的 Demo ：</p>
<ul>
<li><strong>Gemini Live API</strong> 实现人性化的实时语音对话，技术栈依赖 Firebase AI Logic 和 pub 插件，仅仅通过更新 System Prompt 零代码，将一个原型转化为植物识别应用 <img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e9075b6329f84f869a137c7a7063f5f4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764544202&amp;x-signature=QMDF8i2uVXwZcJg3zLkiYCTBULI%3D" alt="" loading="lazy"/></li>
<li>另外一个是展示 AI 驱动的数独游戏，AI 代理通过 Firebase AI Logic 逐步分析、提取数据并解出答案 <img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/73a9494e9f53491b9517516b5b9e271c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764544202&amp;x-signature=G1PoXkIzxDfuTEVWCPPvIOqYxZ0%3D" alt="" loading="lazy"/></li>
</ul>
<p>最后，Flutter 团队还展示了 Flutter Gen UI ，这个我们在之前的 <a href="https://juejin.cn/post/7547639458385313855" target="_blank" title="https://juejin.cn/post/7547639458385313855">《Flutter 官方 LLM 动态 UI 库 flutter_genui 发布，让 App UI 自己生成 UI》</a> 有聊到过，<strong>Flutter Gen UI 包可以让 AI Agent 直接生成 Widget 而非纯文本，从而实现更动态、个性化的应用体验</strong>。</p>
<p>其核心理念就是，允许 AI Agent 使用开发者提供的一个 Widget 目录 (Catalog)，然后让 AI 根据用户需求生成和展示相应的 UI 组件 ，在展示里，官方演示了如何将 Gen UI 核心包和 Firebase 适配器集成到应用中，并创建了一个 自定义 Widget Catalog Item (WorkoutCard)，让 AI 代理能够根据用户提示生成包含自定义 UI 的健身计划 。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7cdb7992389c4c25bae9f56cacc14c73~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764544202&amp;x-signature=ZVubUawGa6fMh0b0kz2uiXvHPaw%3D" alt="" loading="lazy"/></p>
<blockquote>
<p>实际上， Flutter Gen UI 确实是一个不错的应用场景，特别是在 AI Chat 客服的场景下。</p>
</blockquote>
<h2 data-id="heading-2">Q&amp;A</h2>
<p>接着就是本次大家最关心的 Q&amp;A 环节，这里也问出了一些大家比较在意的热门问题。</p>
<h3 data-id="heading-3">1、GenUI 可以支持服务端实现吗？</h3>
<p>官方回答是可以的，这其实这也是他们已经考虑并支持的模式，Flutter 团队预计许多开发者希望在服务端运行自己的 Agent，因为这样可以：</p>
<ul>
<li>动态更新模型和逻辑</li>
<li>接入自定义数据源或私有 API</li>
<li>控制版本与安全</li>
<li>减少客户端负担</li>
</ul>
<p>而为了这个，目前正在尝试研发一种新协议：<strong>A2UI (Agent-to-UI Protocol)</strong> ，Gen UI 设计为模块化，可通过 <strong>A2UI 协议 (Agent-to-UI)</strong> 连接到服务器端代理，它允许服务端 Agent 将生成的 UI “片段”（Widget 树结构）直接推送到客户端，实现类似“前端由 AI 驱动的 “UI Streaming” 。</p>
<p>A2UI 协议会与 A2A (Agent-to-Agent) 协议协同开发（Google Labs 的 Opal 团队也参与），在目前已有官方示例项目就有一个 VUA demo（Python 服务端 + Flutter 客户端）。</p>
<blockquote>
<p>当然，Gen UI 理论上可以与本地 LLM API 一起使用，从而支持本地离线应用，但是建议用较小的 Widget 目录。</p>
</blockquote>
<h3 data-id="heading-4">2、Multi-window 功能进展如何？</h3>
<p>官方表示， 目前正在进行中，并且进展很大，桌面端多窗口功能持续有 Canonical 开发者推进：</p>
<ul>
<li><strong>Windows 平台</strong>：已有可用的实验性 API</li>
<li><strong>Linux / macOS</strong>：正在适配合并中</li>
</ul>
<p>虽然其实现在已经有可用的 API，但是还是有很多底层基础需要打包，后续的重点包括：可访问性（accessibility）、文本输入、子窗口（child windows）与模态对话框（modal dialogs）的优化。</p>
<blockquote>
<p>目标肯定是希望桌面端最终能提供原生应用那样弹出独立窗口（例如浮动菜单、调试面板等）。</p>
</blockquote>
<h3 data-id="heading-5">3、什么时候桌面和 Web 平台的核心插件能与移动端保持一致？</h3>
<p>官方表示，其实他们知道这是一直以来的痛点，而团队正在通过 Federated Plugins 来填补平台支持的空来尝试解决：</p>
<ul>
<li>允许社区/厂商分别维护平台子实现</li>
<li>官方提供统一接口与验证</li>
</ul>
<p>这样的话社区可为 macOS / Web / Linux 等补齐实现，而目前官方正优化相关的发布流程、代码审核和质量标准。</p>
<h3 data-id="heading-6">4、Native Interop (FFI Gen) 什么时候可用</h3>
<p>官方表示 Native Interop 明年将进入 Beta，提供更自动化、更安全的跨语言互操作，那 FFI Gen 解决什么？主要有：</p>
<ul>
<li>
<p>自动把 C/C++/Objective-C/Swift/Java/Kotlin 的声明转换成 Dart API</p>
</li>
<li>
<p>减少手写 FFI binding 的痛苦</p>
</li>
<li>
<p>更少错误（类型对齐、内存泄漏等）</p>
</li>
<li>
<p>有官方 workflow 和安全约束检查</p>
</li>
<li>
<p>主要用于：</p>
<ul>
<li>多媒体库</li>
<li>原生渲染器</li>
<li>加密库</li>
<li>自研底层 SDK</li>
</ul>
</li>
</ul>
<h3 data-id="heading-7">5、ARM Windows/Linux 支持</h3>
<p>官方表示，这个没有稳定时间表，因为 ARM Windows 市占不高，并且 QA 成本极高，多平台 CI 支持还需要需要扩容，从目前来看，不大可能有新的投入。</p>
<h3 data-id="heading-8">6、Flutter Web 未来 (Wasm/SEO)</h3>
<p>官方表示，目前重点工作在于改善 Web 集成（滚动、文本输入），以及 Wasm 方面的工作，包括支持延迟加载 (Deferred Loading)*和将生态系统迁移到新的 JS Interop 。</p>
<p>总结起来，Web SEO 仍是 Flutter Web 的弱项（结构化 HTML），这个也是未来需要调整的，但是看起来不会是近期的目标，而 Wasm-first 架构主要改善的是性能、内存和启动速度。</p>
<h3 data-id="heading-9">7、BuildRunner 性能</h3>
<p>官方表示，建议更新到最新版本 (2.10+) 可以得到增量改进，最重要的新特性是 <strong>AOT 编译 BuildRunner 代码</strong> (通过 opt-in 标志开启)，某些情况下可提速 <strong>5-10 倍</strong> ，新特性包括：</p>
<ul>
<li>对其 codegen 执行 AOT 编译</li>
<li>大幅减少重复扫描</li>
<li>“增量构建” 重度优化</li>
</ul>
<h3 data-id="heading-10">8、设计解耦 (Design Decoupling)</h3>
<p>官方表示，Material 和 Cupertino 解构，计划是年底拆底层、明年初正式独立包，将 Material 和 Cupertino 库从核心 SDK 移出 。</p>
<h3 data-id="heading-11">9、Swift Package Manager (SPM)</h3>
<p>官方表示，Cocoapods 进入维护期，SPM 将成为未来默认的 iOS 包管理工具，这也是 Apple 的强推方向，当然，后续 Plugin 生态需要全部迁移一遍，这也是成本。</p>
<h3 data-id="heading-12">10、<strong>AI 会不会取代开发者？</strong></h3>
<p>结论是不会，AI 是增强而不是取代，Gemini CLI 这种工具是开发者加速器，可以对比：</p>
<ul>
<li>AI 擅长：重复、枯燥、批量修改</li>
<li>人类擅长：结构、决策、设计、交互体验</li>
</ul>
<p>Flutter 开发者未来更多时间应该花在：架构、交互、Prompt 设计和 AI 协同流程上。</p>
<h3 data-id="heading-13">11、Native Assets / Hooks</h3>
<p>原 Native Assets 功能在 3.38 已正式发布，但改名为 Hooks，Hooks 解决的问题：</p>
<ul>
<li>
<p>提供构建期钩子</p>
</li>
<li>
<p>可接入：</p>
<ul>
<li>自定义构建脚本</li>
<li>原生资产构建</li>
<li>自定义编译器</li>
<li>生成 binding 文件等</li>
</ul>
</li>
</ul>
<p>Dart 团队内部认为 “Hooks” 比 “Native Assets” 更准确（因为用途不止于资产）。</p>
<h3 data-id="heading-14">12、其他问题</h3>
<h4 data-id="heading-15">为什么 Flutter 不推自己的状态管理框架</h4>
<p>因为这等于官方认定了某个方向才是对的，而现在状态管理框架百花齐放，你可以选择你自己的喜好，这才是官方认为最好的状态。</p>
<h4 data-id="heading-16">Flutter GPU 是否还在继续</h4>
<p>是的，但是目前暂停了，因为需要让 Impeller 在对应平台更稳定更成熟，才能给 Flutter GPU 提供更实用的场景支持。</p>
<h4 data-id="heading-17">CanvasKit 还能继续缩小吗？</h4>
<p>暂时给不出来时间表。</p>
<h4 data-id="heading-18">Flutter 是否使用 Gemini 处理和分类 Github 问题</h4>
<p>是的，但是还是需要有人监督。</p>
<h4 data-id="heading-19">augmentations 有时间表吗</h4>
<p>augmentations 就是一个新语言特性，可以把一个类拆分到多个文件，目前还在推进，目前还剩一些细节问题在调整，应该很快可以推出。</p>
<h4 data-id="heading-20">Dart 可以和 Kotlin 一样使用多线程吗？</h4>
<p>Dart 其实有多线程，支持多 isolate 、isolate background 、isolate group ，但是要不要实现内存共享，这个目前还没有计划。</p>
<h4 data-id="heading-21">jaspr 是官方支持的吗？</h4>
<p>这是一个 GDE 维护的项目，一个基于 Dart 的 DOM Web 框架，Flutter 团队已将其迁移用于文档基础设施。</p>
<h2 data-id="heading-22">最后</h2>
<p>其实本次 Flutter Flight Plans 里，除了发布了全新版本的 Flutter 和 Dart 之外，就是本次 Q&amp;A 环节最有意义，至少在官方的角度解答了许多大家关心的问题，当然，等 2026 Flutter 官方发布 Roadmap 后，我们就可以看看接下来的承诺是什么。</p>
<blockquote>
<p>关于 Gemini3、AntiGravity 和 Nona Banana Pro 可见：<a href="https://juejin.cn/post/7574745301725167622" target="_blank" title="https://juejin.cn/post/7574745301725167622">juejin.cn/post/757474…</a></p>
</blockquote>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fccdf9f932f04982b31d29196df272b7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764544202&amp;x-signature=05GDya1EncPNYxEs7rvz9yOmZoI%3D" alt="" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[FlutterUnit3.4.1 | 来场三方库的收录狂欢吧~]]></title>    <link>https://juejin.cn/post/7575413146922057743</link>    <guid>https://juejin.cn/post/7575413146922057743</guid>    <pubDate>2025-11-23T23:26:04.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7575413146922057743" data-draft-id="7575162322241028096" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="FlutterUnit3.4.1 | 来场三方库的收录狂欢吧~"/> <meta itemprop="keywords" content="Android,Flutter,前端"/> <meta itemprop="datePublished" content="2025-11-23T23:26:04.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="张风捷特烈"/> <meta itemprop="url" content="https://juejin.cn/user/149189281194766"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            FlutterUnit3.4.1 | 来场三方库的收录狂欢吧~
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/149189281194766/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    张风捷特烈
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-23T23:26:04.000Z" title="Sun Nov 23 2025 23:26:04 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:14px;overflow-x:hidden;color:var(--cyanosis-base-color);transition:color .35s;--cyanosis-base-color:#353535;--cyanosis-title-color:#005bb7;--cyanosis-strong-color:#2196f3;--cyanosis-em-color:#4fc3f7;--cyanosis-del-color:#ccc;--cyanosis-link-color:#3da8f5;--cyanosis-linkh-color:#007fff;--cyanosis-border-color:#bedcff;--cyanosis-border-color-2:#ececec;--cyanosis-bg-color:#fff;--cyanosis-blockquote-color:#8c8c8c;--cyanosis-blockquote-bg-color:#f0fdff;--cyanosis-code-color:#c2185b;--cyanosis-code-bg-color:#fff4f4;--cyanosis-code-pre-color:#f8f8f8;--cyanosis-table-border-color:#c3e0fd;--cyanosis-table-th-color:#dff0ff;--cyanosis-table-tht-color:#005bb7;--cyanosis-table-tr-nc-color:#f7fbff;--cyanosis-table-trh-color:#e0edf7;--cyanosis-slct-title-color:#005bb7;--cyanosis-slct-titlebg-color:rgba(175,207,247,0.25);--cyanosis-slct-text-color:#c80000;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#e8ebec;--cyanosis-slct-codebg-color:#ffeaeb;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body.__dark{--cyanosis-base-color:#cacaca;--cyanosis-title-color:#ddd;--cyanosis-strong-color:#fe9900;--cyanosis-em-color:#ffd28e;--cyanosis-del-color:#ccc;--cyanosis-link-color:#ffb648;--cyanosis-linkh-color:#fe9900;--cyanosis-border-color:#ffe3ba;--cyanosis-border-color-2:#ffcb7b;--cyanosis-bg-color:#2f2f2f;--cyanosis-blockquote-color:#c7c7c7;--cyanosis-blockquote-bg-color:rgba(255,199,116,0.1);--cyanosis-code-color:#000;--cyanosis-code-bg-color:#ffcb7b;--cyanosis-code-pre-color:rgba(255,227,185,0.5);--cyanosis-table-border-color:#fe9900;--cyanosis-table-th-color:#ffb648;--cyanosis-table-tht-color:#000;--cyanosis-table-tr-nc-color:#6d5736;--cyanosis-table-trh-color:#947443;--cyanosis-slct-title-color:#000;--cyanosis-slct-titlebg-color:#fe9900;--cyanosis-slct-text-color:#00c888;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#000;--cyanosis-slct-codebg-color:#ffcb7b;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body h1{padding-bottom:4px;font-size:30px}.markdown-body h1,.markdown-body h2{margin-top:36px;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);transition:color .35s}.markdown-body h2{position:relative;padding-left:10px;padding-right:10px;padding-bottom:10px;font-size:24px;border-bottom:1px solid var(--cyanosis-border-color-2)}.markdown-body h2:before{content:"「";position:absolute;top:-6px;left:-14px}.markdown-body h2:after{content:"」";position:relative;top:6px;right:auto}.markdown-body h3{position:relative;padding-bottom:0;margin-top:30px;margin-bottom:10px;font-size:20px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h3:before{content:"»";padding-right:6px;color:var(--cyanosis-strong-color)}.markdown-body h4{margin-top:24px;font-size:16px}.markdown-body h4,.markdown-body h5{padding-bottom:0;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h5{margin-top:18px;font-size:14px}.markdown-body h6{padding-bottom:0;margin-top:12px;margin-bottom:10px;font-size:12px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body p{line-height:inherit;margin-top:16px;margin-bottom:16px}.markdown-body img{max-width:100%}.markdown-body hr{position:relative;width:98%;height:1px;margin-top:32px;margin-bottom:32px;background-image:linear-gradient(90deg,var(--cyanosis-link-color),rgba(255,0,0,.3),hsla(0,0%,100%,.1),rgba(255,0,0,.3),var(--cyanosis-link-color));border-width:0;overflow:visible}.markdown-body hr:after{content:"";position:absolute;margin:auto;left:0;right:0;bottom:0;top:0;display:inline-block;width:60px;height:20px;background-color:var(--cyanosis-bg-color);background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAgCAYAAABgrToAAAADoklEQVRYR82XTYgcRRTHf2933Q1RjAa9eFO8JHoJ8RQVBQ2iBwXBET0YEUTXNVmNQtTpmeqaWV0XNRq/o4KoECSCEPSg4CF+BYUkIIiCoCJCPIhC/Ihh2Z0nVV27VnZnenumW9i6ddV7//frV69fVQurfMgq56NawFTPAU6QyomqXrw6wIZeyhCPebA5buNR+akKyGoAjd6BshthnYdSjqNcRVuOlIUsD2j0SuA94IwuMHdh5ZUykOUBXfSGbmKI54EtAeYIHSZoy5dl4JxvNYBOKdW1KE8BQ8AkVk6WhasWsAiN0TX9gveXQaPP+Aytpc4u+bMI06JNohsYYYYOR2lJWtS3OKDRfcAtQfgDoI6Vo4UCGb0OmAEuDvZvYmVbEd/igC3dzDz7gQu8sPA9kJDK27mBmjqBeLjTg90PDFOjWawFFQd06kZHEfaj3LAIpTRpSXsZ5E06zEYP9sDimnAApYaV2SLZG/wjMeqAkijwW4xQJ5Gf/ZzRC8OW3hiBTGGlURRswW55Bh/Ssxljrwew8l1PQaM14GngvGDzBUKdDsMeTtgU5o8B92PFlUf3YXUrHa7Fys6lBqcCGnX15YQ2A18FyPd7Crd1A3M8C1wdbH4DD3hWeP6IEXbQkG97ajR1HPFnuPP5jFFq1OWX7hl8WM9l1AO648uNfwLk7tytMeogty+xeQ4rO3r6bdcx1nuwOGsHmaXGtPzae4uzGnLH1kQkvpdZGrHjssBZJrL+pqS05KWc8tgITAPXRzYvYOXe/C2OV43eDcRBDtIhoS2f9wzc0Cv8Wls+zoFzUC5zF0U241h5uZtPfptp6OUM8wbK+cH5GEpCS17P3fJei0Z3+npTxryJ8CPzbKMtn/ZyWbkPGl0PuFPkmkjkcb4h4R2ZLwRq1H0ALmvjkf2HwK1Y+T1PY2XABe/sHJ6MxN5lnoSpnC/UGbsTaI5phK2R7x6s3Ffk5YoDOrWm3onwJHBmEP86bPmBrsGaenNoIdnxCH+gPEhLXi0Cl1VBvyPVLSh7gEuC62yAfOIUqabWEaaiucMIk6RyqJ+Q/QM69V26jjW86Gvov/EaoyT8zRCn+Xq7PVrbx0nuYUaO9wM3WAbjCE1NEUw09Um4UV+2OKfYfu5/S19gsAzGKqm6LE5FrShbdS0ku465DjDwKA/oQht19ejqbaEVuRbiLhuHByYLjtUAZpDutzP7cYdHsPJXWbjyNVgFwQoa1WXwf4Jd9YD/Ap80+yE7+u9aAAAAAElFTkSuQmCC);background-repeat:no-repeat;background-size:auto 100%;background-position-x:center;transition:background-color .5s}.markdown-body code{padding:.065em .4em;font-size:.87em;color:var(--cyanosis-code-color);word-break:break-word;overflow-x:auto;background-color:var(--cyanosis-code-bg-color);border-radius:2px}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{display:block;padding:16px 12px;margin:0;font-size:12px;color:#333;word-break:normal;overflow-x:auto;background:var(--cyanosis-code-pre-color)}.markdown-body pre&gt;code::-webkit-scrollbar{width:4px;height:4px}.markdown-body pre&gt;code::-webkit-scrollbar-track{background-color:var(--cyanosis-border-color)}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:var(--cyanosis-strong-color);border-radius:10px}.markdown-body a{position:relative;text-decoration:none;color:var(--cyanosis-link-color);border-bottom:1px solid var(--cyanosis-border-color)}.markdown-body a:hover{border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body a:active,.markdown-body a:hover{color:var(--cyanosis-linkh-color)}.markdown-body a:after{position:absolute;content:"";top:100%;left:0;width:100%;opacity:0;border-bottom:1px solid var(--cyanosis-border-color);transition:top .3s,opacity .3s;transform:translateZ(0)}.markdown-body a:hover:after{top:0;opacity:1;border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid var(--cyanosis-table-border-color);border-spacing:0;border-collapse:collapse}.markdown-body table thead{color:#000;text-align:left;font-size:14px;background:#f6f6f6}.markdown-body table tr:nth-child(2n){background-color:var(--cyanosis-table-tr-nc-color)}.markdown-body table tr:hover{background-color:var(--cyanosis-table-trh-color)}.markdown-body table td,.markdown-body table th{padding:12px 8px;line-height:24px;border:1px solid var(--cyanosis-table-border-color)}.markdown-body table th{color:var(--cyanosis-table-tht-color);background-color:var(--cyanosis-table-th-color)}.markdown-body table td{min-width:120px}.markdown-body blockquote{color:var(--cyanosis-blockquote-color);border-left:4px solid var(--cyanosis-strong-color);background-color:var(--cyanosis-blockquote-bg-color);padding:1px 20px;margin:22px 0;transition:color .35s}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body b,.markdown-body blockquote&gt;b,.markdown-body blockquote&gt;strong,.markdown-body strong{color:var(--cyanosis-strong-color)}.markdown-body em,.markdown-body i{color:var(--cyanosis-em-color)}.markdown-body del{color:var(--cyanosis-del-color)}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:4px}.markdown-body ol li{padding-left:6px}.markdown-body details&gt;summary{outline:none;color:var(--cyanosis-title-color);font-size:20px;font-weight:bolder;border-bottom:1px solid var(--cyanosis-border-color);cursor:pointer}.markdown-body details&gt;p{padding:10px 20px;margin:10px 0 0;color:#666;background-color:var(--cyanosis-blockquote-bg-color);border:2px dashed var(--cyanosis-strong-color)}.markdown-body h1::selection,.markdown-body h2::selection,.markdown-body h3::selection,.markdown-body h4::selection,.markdown-body h5::selection,.markdown-body h6::selection{color:var(--cyanosis-slct-title-color);background-color:var(--cyanosis-slct-titlebg-color)}.markdown-body ol li::selection,.markdown-body p::selection,.markdown-body ul li::selection{color:var(--cyanosis-slct-text-color);background-color:var(--cyanosis-slct-bg-color)}.markdown-body a::selection,.markdown-body b::selection,.markdown-body em::selection,.markdown-body i::selection,.markdown-body strong::selection{background-color:var(--cyanosis-slct-elbg-color)}.markdown-body del::selection{color:var(--cyanosis-slct-del-color);background-color:var(--cyanosis-slct-elbg-color)}.markdown-body table thead th::selection{background-color:transparent}.markdown-body table tbody td::selection{background-color:var(--cyanosis-slct-bg-color)}.markdown-body code::selection{background-color:var(--cyanosis-slct-codebg-color)}.markdown-body pre&gt;code::selection{background-color:var(--cyanosis-slct-prebg-color)}.markdown-body .contains-task-list{padding-left:14px;list-style:none}.markdown-body .contains-task-list input[type=checkbox]{position:relative}.markdown-body .contains-task-list input[type=checkbox]:before{content:"";position:absolute;top:0;left:0;right:0;bottom:0;width:inherit;height:inherit;background:#f0f8ff;border:1px solid #add6ff;border-radius:2px;box-sizing:border-box;z-index:1}.markdown-body .contains-task-list input[type=checkbox]:checked:after{content:"✓";position:absolute;top:-12px;left:0;right:0;bottom:0;width:0;height:0;color:#f55;font-size:20px;font-weight:700;z-index:2}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="atom-one-dark">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#abb2bf;background:#282c34}.hljs-comment,.hljs-quote{color:#5c6370;font-style:italic}.hljs-doctag,.hljs-formula,.hljs-keyword{color:#c678dd}.hljs-deletion,.hljs-name,.hljs-section,.hljs-selector-tag,.hljs-subst{color:#e06c75}.hljs-literal{color:#56b6c2}.hljs-addition,.hljs-attribute,.hljs-meta-string,.hljs-regexp,.hljs-string{color:#98c379}.hljs-built_in,.hljs-class .hljs-title{color:#e6c07b}.hljs-attr,.hljs-number,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-pseudo,.hljs-template-variable,.hljs-type,.hljs-variable{color:#d19a66}.hljs-bullet,.hljs-link,.hljs-meta,.hljs-selector-id,.hljs-symbol,.hljs-title{color:#61aeee}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}.hljs-link{text-decoration:underline}</style><p>对于一个技术框架的生态来说，三方库是非常非常重要的。Flutter 的朋友都知道 pub 作为官方的仓库，有海量的三方类库供开发者使用。FlutterUnit 作为 Flutter 技术的前沿营地，打算推出一个新的模块:</p>
<blockquote>
<p><strong>三方包</strong> : 在应用中，提供插件的推荐、搜索、分类、评价、国际化等，拓宽开发者接触插件的形式。让好的类库不被埋没。</p>
</blockquote>
<p><img src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/19db757a1da44df5a1748b9cc30e049d~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=971&amp;h=335&amp;s=39539&amp;e=png&amp;b=13212f" alt="" loading="lazy"/></p>
<h4 data-id="heading-0">1. 功能简介</h4>
<p>之前的留言板功能被放在了 <code>我的</code> 中，主界面的黄金地段增加了 <code>三方库</code> 一栏，目前收录了一百多个常用的三方类库。并将这些数据收集到了我的后端，并提供了<strong>分类展示</strong>和<strong>评论</strong> 两大功能，这样可以给大家一个讨论类库的场地，聊聊你对插件的看法，用途等。</p>













<table><thead><tr><th>包主页</th><th>包详情</th></tr></thead><tbody><tr><td><img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/e67acff2e0cf4f7cbb45d93a4f114be6~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=1080&amp;h=2400&amp;s=437010&amp;e=png&amp;b=fefefe" alt="" loading="lazy"/></td><td><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/0d54ad10683647948a6fd2b2913a3914~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=1080&amp;h=2400&amp;s=504741&amp;e=png&amp;b=ffffff" alt="" loading="lazy"/></td></tr></tbody></table>
<hr/>
<p>另外，还提供了推荐插件的入口，使用者可以在这里推荐一下目前没有收录，但你觉得很不错的插件。欢迎在这里和大家共享 ~<br/>
另外支持根据下载量、喜欢数、发布时间进行排序。</p>













<table><thead><tr><th>推荐创建</th><th>排序方式</th></tr></thead><tbody><tr><td><img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/e1233318a49e409d8fe43fe8adf9941f~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=1080&amp;h=2400&amp;s=98299&amp;e=png&amp;b=f1f3f7" alt="" loading="lazy"/></td><td><img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/0b7cadd98eb8463ca9f4b0030ef5055e~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=1080&amp;h=2400&amp;s=249954&amp;e=png&amp;b=757575" alt="" loading="lazy"/></td></tr></tbody></table>
<hr/>
<p>本次最大的亮点当属评论了，支持二级评论，大于两条的评论会展示查看更多评论。如果详情页评论总数大于 10 ，底部会有查看全部的评论，支持分页加载：</p>













<table><thead><tr><th>详情页评论</th><th>评论详情页</th></tr></thead><tbody><tr><td><img src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/16115f495ad6420f9da52ca55410d591~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=1080&amp;h=2400&amp;s=226253&amp;e=png&amp;b=ffffff" alt="" loading="lazy"/></td><td><img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/f94e1b46abf64565aaeb7bbfbf3f8f34~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=1080&amp;h=2400&amp;s=194367&amp;e=png&amp;b=ffffff" alt="" loading="lazy"/></td></tr></tbody></table>
<hr/>
<h4 data-id="heading-1">2. 关于后台</h4>
<p>目前后台基于 Rust 做的服务，也基本完成了模块化开发。package 模块负责当前功能相关的所有服务接口的。支持独立测试。分模块最大的好处是功能隔离，这样 AI 可以更高效地辅助编码，而且可以参考一个模块的功能，去开发别的模块。三方库相关的接口 95% 是由 AI 独立完成的：</p>
<p><img src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/0cc1ebf429a8476f8ee41feceaafeb59~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=1410&amp;h=807&amp;s=200149&amp;e=png&amp;b=fffefe" alt="" loading="lazy"/></p>
<p>不得不说，自从换上了 rust 服务，我的 2G 内存的小服务器也更能打一些了。之前使用 Java 的 Springboot 做的服务，上来就小几百兆，现在 rust 运行很久，也就 16 M.</p>
<p><img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/3f5a68123efc4bff9885708f75ff5a7c~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=938&amp;h=80&amp;s=16420&amp;e=png&amp;b=181818" alt="" loading="lazy"/></p>
<p>和 AI 讨论数据表的创建，也让我收益颇丰。特别是对于多语言的处理，分离出了 <strong>t_pkg_translations</strong> 表，可以在不侵入原表结构的情况下，增加字段级别的翻译映射关系。更利于其他字段、其他语言的支持:</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/256ac284b1ad46f9886ca47fd3f9ca08~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=1146&amp;h=308&amp;s=49549&amp;e=png&amp;b=ffffff" alt="" loading="lazy"/></p>
<p><img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/02df26142f46408cb72d0d331b74832a~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=1250&amp;h=387&amp;s=60413&amp;e=png&amp;b=fbfafa" alt="" loading="lazy"/></p>
<p>为了方便管理数据，我还让 AI 基于 VUE 顺手写了个后端管理系统 ~</p>
<p><img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/c48a19af12274510b65e99f306793ec7~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=2560&amp;h=1347&amp;s=182981&amp;e=png&amp;b=fefefe" alt="" loading="lazy"/></p>
<hr/>
<h4 data-id="heading-2">3. 关于前端</h4>
<p>前端也采用模块化开发，<code>pkg_player</code> 模块负责该功能的所有逻辑实现，另外它是一个可以独立运行的模块，这可以让它可以独立于 FlutterUnit 进行开发，开发阶段只需要运行 exsample 即可，可以让 AI 更聚焦于每个模块，减少其他信息干扰。当完成开发，进行组装到 FlutterUnit 即可。</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/4f96118aa2e540458a8911b9b2ea4ce2~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=1137&amp;h=683&amp;s=48593&amp;e=png&amp;b=eff6f9" alt="" loading="lazy"/></p>
<p>这种可插拔的模块化，可以最大程度复用模块。比如未来我有一个 <code>编程营地</code> 的应用, 只需要引入<code>pkg_player</code> 模块，然后拼装一下， 编程营地就有了当前的三方库的展示和交流能力。</p>
<hr/>
<p>由于引入了 AI 编程，我希望像流水线一样，AI 可以根据我的代码组织结构，进行代码的产出。使用我设计了三层的 MVVM 应用架构，其中:</p>
<ul>
<li><strong>bloc</strong> 状态维护的视图模型层,负责维护数据流转。</li>
<li><strong>repository</strong> 数据仓储层，负责实体类维护和数据获取，比如网络、数据库等。</li>
<li><strong>view</strong> 视图层，基于视图模型中的数据，进行界面构建，以及用户交互事件的入口。</li>
</ul>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/e22939ca0738479c9b749d31470e674c~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=1282&amp;h=646&amp;s=41251&amp;e=png&amp;b=f5f7fa" alt="" loading="lazy"/></p>
<p>我约定一般情况下 view 和 repository 之间不直接依赖，另外 repository 中的代码需要支持 <strong>脱离视图层</strong> 也可以独立运行，这样便于单元测试。</p>
<p>前端的代码大概 80% 也是由 AI 完成的，但这并不代表开发者什么都不要干。我的角色是从敲代码的，变成了指挥 AI 敲代码的。如何设计整体的功能、交互的细节、数据的结果，还是需要花费心力的。</p>
<blockquote>
<p>注： AI 的代码质量可以说中规中矩，还是有些需要优化的地方。良好的结构，可以让 AI 的洪水不至于肆意蔓延。约束它，引导它，受用于你。</p>
</blockquote>
<p>希望模块化的开发结构，可以在 AI 的浪潮下，让你的 Flutter 应用更加内聚，符合单一职责原则、合成复用原则。目前正在根据实践经验，设计 fx 通用应用架构，敬请期待~</p>
<hr/>
<h4 data-id="heading-3">4. 关于国际化</h4>
<p>为了便于包支持模块化，我写了一个 dart 脚本，可以分析统计模块中字符串，使用的非英文字符，及其在代码中的具体位置。</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/5cc3c5bb26344b6aa7287ea2a2420521~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=1565&amp;h=954&amp;s=166703&amp;e=png&amp;b=ffffff" alt="" loading="lazy"/></p>
<p>最后还会统计所有不同的字符串：</p>
<p><img src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/643e3a4b64b94a89bcb4bce6607a2475~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=1278&amp;h=696&amp;s=129858&amp;e=png&amp;b=ffffff" alt="" loading="lazy"/></p>
<p>你可以把这些丢给 AI ，让它生成 arb 文件，然后根据中文，再得到英文翻译：</p>
<p><img src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/4e54fc69a5344cb083bc0117bb51297d~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=1317&amp;h=660&amp;s=81442&amp;e=png&amp;b=f9f9f9" alt="" loading="lazy"/></p>
<p>最终就会得到可用的资源：</p>
<p><img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/4aeb487702ca4fa3a9c9571918fc5357~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=1019&amp;h=334&amp;s=18736&amp;e=png&amp;b=f3f5fa" alt="" loading="lazy"/></p>
<p>这样在数据层面和本地资源，都支持了国际化：</p>













<table><thead><tr><th>英文</th><th>中文</th></tr></thead><tbody><tr><td><img src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/1029410d7c87480591f22ef7ebc95d2f~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=1080&amp;h=2400&amp;s=440960&amp;e=png&amp;b=fefefe" alt="" loading="lazy"/></td><td><img src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/7b792b94c5344398a9d821d3490088fe~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=1080&amp;h=2400&amp;s=435716&amp;e=png&amp;b=fefefe" alt="" loading="lazy"/></td></tr></tbody></table>
<hr/>
<h4 data-id="heading-4">4. 尾声</h4>
<p>文章里就不说详细的代码实现了，<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Ftoly1994328%2FFlutterUnit" target="_blank" title="https://github.com/toly1994328/FlutterUnit" ref="nofollow noopener noreferrer">FlutterUnit</a>  是一个开源项目，大家可以自己去运行体验。最后，FlutterUnit3.4 版本， 三方库功能已经上线，大家可以在 github 上更新最新版的软件包体验，欢迎多多交流，为你喜欢的三方库打 call ~</p>
<p>更多文章和视频知识资讯，大家可以关注我的公众号、掘金和 B 站 。让我们一起成长，变得更强。我们下次再见~</p>
<ul>
<li><strong>鸿蒙纪元</strong> QQ交流群： 727300436</li>
<li>掘金账号： <a href="https://juejin.cn/user/149189281194766" title="https://juejin.cn/user/149189281194766" target="_blank">张风捷特烈</a></li>
<li>bilibli 账号： <a href="https://link.juejin.cn?target=https%3A%2F%2Fspace.bilibili.com%2F390457600" title="https://link.juejin.cn?target=https%3A%2F%2Fspace.bilibili.com%2F390457600" target="_blank">张风捷特烈</a></li>
<li>公众号： <a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2Fq8Vs5i3SU-4QPoU3-0xOSg" title="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2Fq8Vs5i3SU-4QPoU3-0xOSg" target="_blank">编程之王</a></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[从源码到npm：手把手带你发布Vue 3组件库]]></title>    <link>https://juejin.cn/post/7575937594338443305</link>    <guid>https://juejin.cn/post/7575937594338443305</guid>    <pubDate>2025-11-23T23:43:43.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7575937594338443305" data-draft-id="7575468252657008681" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="从源码到npm：手把手带你发布Vue 3组件库"/> <meta itemprop="keywords" content="Vue.js,NPM,前端"/> <meta itemprop="datePublished" content="2025-11-23T23:43:43.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="良山有风来"/> <meta itemprop="url" content="https://juejin.cn/user/3940246036939358"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            从源码到npm：手把手带你发布Vue 3组件库
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3940246036939358/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    良山有风来
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-23T23:43:43.000Z" title="Sun Nov 23 2025 23:43:43 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>还记得上次为了统一团队UI风格，你不得不把同一个按钮组件复制粘贴到十几个项目里的痛苦经历吗？每次修改都要同步更新所有项目，一不小心就漏掉一两个，测试同事追着你满公司跑……</p>
<p>今天，咱们就来彻底解决这个问题！我将带你从零开始，用最新的Vite工具链打包并发布一个专业的Vue 3组件库。学完这篇，你就能像Element Plus那样，让团队通过一句<code>npm install</code>就能使用你精心打造的组件库。</p>
<h2 data-id="heading-0">为什么你需要自建组件库？</h2>
<p>先别急着写代码，咱们聊聊为什么这事值得你花时间。想象一下这些场景：</p>
<p>早上刚优化了按钮的点击动效，下午就要在五个项目里手动更新；设计团队调整了主色调，你得逐个文件修改颜色变量；新人接手项目，因为组件规范不统一而频频踩坑……</p>
<p>有了自己的组件库，这些烦恼统统消失！更重要的是，这还能成为你的技术名片——想想看，当面试官看到你的GitHub主页有一个被下载了几千次的组件库时，那是什么感觉？</p>
<h2 data-id="heading-1">环境准备与项目初始化</h2>
<p>工欲善其事，必先利其器。确保你的环境满足以下要求：</p>
<p>Node.js版本18.0或更高，这是Vite顺畅运行的基础。pnpm作为包管理器，它比npm更快更节省磁盘空间。</p>
<p>接下来创建项目目录：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">mkdir</span> vue3-component-library
<span class="hljs-built_in">cd</span> vue3-component-library
pnpm init
</code></pre>
<p>初始化package.json后，安装核心依赖：</p>
<pre><code class="hljs language-bash" lang="bash">pnpm add vue@^3.3.0
pnpm add -D vite@^5.0.0 @vitejs/plugin-vue
</code></pre>
<p>创建基础的vite.config.js配置文件：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { defineConfig } <span class="hljs-keyword">from</span> <span class="hljs-string">'vite'</span>
<span class="hljs-keyword">import</span> vue <span class="hljs-keyword">from</span> <span class="hljs-string">'@vitejs/plugin-vue'</span>
<span class="hljs-keyword">import</span> { resolve } <span class="hljs-keyword">from</span> <span class="hljs-string">'path'</span>

<span class="hljs-comment">// 组件库入口文件路径</span>
<span class="hljs-keyword">const</span> entry = <span class="hljs-title function_">resolve</span>(__dirname, <span class="hljs-string">'src/index.js'</span>)

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title function_">defineConfig</span>({
  <span class="hljs-attr">plugins</span>: [<span class="hljs-title function_">vue</span>()],
  <span class="hljs-attr">build</span>: {
    <span class="hljs-attr">lib</span>: {
      entry,
      <span class="hljs-attr">name</span>: <span class="hljs-string">'MyComponentLibrary'</span>,
      <span class="hljs-attr">fileName</span>: <span class="hljs-string">'my-component-library'</span>
    },
    <span class="hljs-attr">rollupOptions</span>: {
      <span class="hljs-comment">// 确保外部化处理那些你不想打包进库的依赖</span>
      <span class="hljs-attr">external</span>: [<span class="hljs-string">'vue'</span>],
      <span class="hljs-attr">output</span>: {
        <span class="hljs-attr">globals</span>: {
          <span class="hljs-attr">vue</span>: <span class="hljs-string">'Vue'</span>
        }
      }
    }
  }
})
</code></pre>
<p>这个配置告诉Vite：我们要构建一个库而不是应用，Vue应该是外部依赖而不打包进最终产物。</p>
<h2 data-id="heading-2">设计组件库目录结构</h2>
<p>清晰的目录结构是成功的一半！这是我推荐的结构：</p>
<pre><code class="hljs language-csharp" lang="csharp">src/
├── components/     <span class="hljs-meta"># 所有组件源码</span>
│   ├── Button/
│   │   ├── Button.vue
│   │   └── index.js
│   └── Input/
│       ├── Input.vue
│       └── index.js
├── styles/         <span class="hljs-meta"># 样式文件</span>
│   ├── <span class="hljs-keyword">base</span>.css    <span class="hljs-meta"># 基础样式</span>
│   └── components/ <span class="hljs-meta"># 组件样式</span>
├── utils/          <span class="hljs-meta"># 工具函数</span>
└── index.js        <span class="hljs-meta"># 主入口文件</span>
</code></pre>
<p>让我解释几个关键点：每个组件都有自己的目录，里面包含Vue单文件组件和导出文件。样式集中管理，便于维护和主题定制。</p>
<h2 data-id="heading-3">编写你的第一个组件</h2>
<p>咱们从最常用的按钮组件开始。创建<code>src/components/Button/Button.vue</code>：</p>
<pre><code class="hljs language-vue" lang="vue">&lt;template&gt;
  &lt;button 
    :class="[
      'my-btn',
      `my-btn--${type}`,
      { 'my-btn--disabled': disabled }
    ]"
    :disabled="disabled"
    @click="handleClick"
  &gt;
    &lt;slot&gt;&lt;/slot&gt;
  &lt;/button&gt;
&lt;/template&gt;

&lt;script setup&gt;
// 定义组件接收的属性
const props = defineProps({
  type: {
    type: String,
    default: 'default', // default, primary, danger
    validator: (value) =&gt; {
      return ['default', 'primary', 'danger'].includes(value)
    }
  },
  disabled: {
    type: Boolean,
    default: false
  }
})

// 定义发射的事件
const emit = defineEmits(['click'])

const handleClick = (event) =&gt; {
  if (!props.disabled) {
    emit('click', event)
  }
}
&lt;/script&gt;

&lt;style scoped&gt;
.my-btn {
  padding: 8px 16px;
  border: 1px solid #dcdfe6;
  border-radius: 4px;
  background: white;
  cursor: pointer;
  transition: all 0.3s;
}

.my-btn:hover {
  opacity: 0.8;
}

.my-btn--primary {
  background: #409eff;
  color: white;
  border-color: #409eff;
}

.my-btn--danger {
  background: #f56c6c;
  color: white;
  border-color: #f56c6c;
}

.my-btn--disabled {
  opacity: 0.6;
  cursor: not-allowed;
}
&lt;/style&gt;
</code></pre>
<p>这个按钮组件支持三种类型和禁用状态，样式采用BEM命名规范，确保类名清晰可维护。</p>
<p>接下来创建组件的导出文件<code>src/components/Button/index.js</code>：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> <span class="hljs-title class_">Button</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'./Button.vue'</span>

<span class="hljs-comment">// 为组件添加install方法，使其能够被Vue.use()使用</span>
<span class="hljs-title class_">Button</span>.<span class="hljs-property">install</span> = <span class="hljs-function">(<span class="hljs-params">app</span>) =&gt;</span> {
  app.<span class="hljs-title function_">component</span>(<span class="hljs-title class_">Button</span>.<span class="hljs-property">name</span>, <span class="hljs-title class_">Button</span>)
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title class_">Button</span>
</code></pre>
<p>install方法很重要！它让用户可以通过<code>app.use(YourComponent)</code>的方式全局注册组件。</p>
<h2 data-id="heading-4">构建组件库入口文件</h2>
<p>现在是时候把各个组件统一导出了。创建<code>src/index.js</code>：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 导入所有组件</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">Button</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'./components/Button'</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">Input</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'./components/Input'</span>

<span class="hljs-comment">// 组件列表</span>
<span class="hljs-keyword">const</span> components = [
  <span class="hljs-title class_">Button</span>,
  <span class="hljs-title class_">Input</span>
]

<span class="hljs-comment">// 定义install方法，接收Vue实例作为参数</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">install</span> = (<span class="hljs-params">app</span>) =&gt; {
  <span class="hljs-comment">// 遍历注册所有组件</span>
  components.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">component</span> =&gt;</span> {
    app.<span class="hljs-title function_">component</span>(component.<span class="hljs-property">name</span>, component)
  })
}

<span class="hljs-comment">// 判断是否直接通过script标签引入，如果是，会自动安装</span>
<span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> <span class="hljs-variable language_">window</span> !== <span class="hljs-string">'undefined'</span> &amp;&amp; <span class="hljs-variable language_">window</span>.<span class="hljs-property">Vue</span>) {
  <span class="hljs-title function_">install</span>(<span class="hljs-variable language_">window</span>.<span class="hljs-property">Vue</span>)
}

<span class="hljs-comment">// 导出install方法和所有组件</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  install,
  <span class="hljs-title class_">Button</span>,
  <span class="hljs-title class_">Input</span>
}

<span class="hljs-comment">// 按需导出各个组件</span>
<span class="hljs-keyword">export</span> {
  <span class="hljs-title class_">Button</span>,
  <span class="hljs-title class_">Input</span>
}
</code></pre>
<p>这种设计让用户可以选择全量引入或按需引入，满足不同场景的需求。</p>
<h2 data-id="heading-5">配置多种构建格式</h2>
<p>不同的使用场景需要不同的构建格式。更新vite.config.js：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { defineConfig } <span class="hljs-keyword">from</span> <span class="hljs-string">'vite'</span>
<span class="hljs-keyword">import</span> vue <span class="hljs-keyword">from</span> <span class="hljs-string">'@vitejs/plugin-vue'</span>
<span class="hljs-keyword">import</span> { resolve } <span class="hljs-keyword">from</span> <span class="hljs-string">'path'</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title function_">defineConfig</span>({
  <span class="hljs-attr">plugins</span>: [<span class="hljs-title function_">vue</span>()],
  <span class="hljs-attr">build</span>: {
    <span class="hljs-attr">lib</span>: {
      <span class="hljs-attr">entry</span>: <span class="hljs-title function_">resolve</span>(__dirname, <span class="hljs-string">'src/index.js'</span>),
      <span class="hljs-attr">name</span>: <span class="hljs-string">'MyComponentLibrary'</span>,
      <span class="hljs-comment">// 生成多种格式的文件</span>
      <span class="hljs-attr">fileName</span>: <span class="hljs-function">(<span class="hljs-params">format</span>) =&gt;</span> <span class="hljs-string">`my-component-library.<span class="hljs-subst">${format}</span>.js`</span>
    },
    <span class="hljs-attr">rollupOptions</span>: {
      <span class="hljs-attr">external</span>: [<span class="hljs-string">'vue'</span>],
      <span class="hljs-attr">output</span>: [
        {
          <span class="hljs-attr">format</span>: <span class="hljs-string">'es'</span>, <span class="hljs-comment">// ES模块格式，适合现代打包工具</span>
          <span class="hljs-attr">globals</span>: {
            <span class="hljs-attr">vue</span>: <span class="hljs-string">'Vue'</span>
          }
        },
        {
          <span class="hljs-attr">format</span>: <span class="hljs-string">'umd'</span>, <span class="hljs-comment">// 通用模块定义，适合script标签直接引入</span>
          <span class="hljs-attr">globals</span>: {
            <span class="hljs-attr">vue</span>: <span class="hljs-string">'Vue'</span>
          }
        },
        {
          <span class="hljs-attr">format</span>: <span class="hljs-string">'cjs'</span>, <span class="hljs-comment">// CommonJS格式，适合Node环境</span>
          <span class="hljs-attr">globals</span>: {
            <span class="hljs-attr">vue</span>: <span class="hljs-string">'Vue'</span>
          }
        }
      ]
    }
  }
})
</code></pre>
<p>现在运行<code>pnpm build</code>，你会在dist目录看到三种格式的文件，满足各种使用需求。</p>
<h2 data-id="heading-6">样式构建与优化</h2>
<p>组件库的样式处理很关键。我们创建单独的样式构建流程：</p>
<p>首先安装相关依赖：</p>
<pre><code class="hljs language-bash" lang="bash">pnpm add -D sass
</code></pre>
<p>创建构建样式的脚本<code>scripts/build-styles.js</code>：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> fs = <span class="hljs-built_in">require</span>(<span class="hljs-string">'fs'</span>)
<span class="hljs-keyword">const</span> path = <span class="hljs-built_in">require</span>(<span class="hljs-string">'path'</span>)
<span class="hljs-keyword">const</span> { execSync } = <span class="hljs-built_in">require</span>(<span class="hljs-string">'child_process'</span>)

<span class="hljs-comment">// 递归读取目录下的所有scss文件</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">readStyles</span>(<span class="hljs-params">dir</span>) {
  <span class="hljs-keyword">let</span> results = []
  <span class="hljs-keyword">const</span> list = fs.<span class="hljs-title function_">readdirSync</span>(dir)
  
  list.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">file</span> =&gt;</span> {
    <span class="hljs-keyword">const</span> filePath = path.<span class="hljs-title function_">join</span>(dir, file)
    <span class="hljs-keyword">const</span> stat = fs.<span class="hljs-title function_">statSync</span>(filePath)
    
    <span class="hljs-keyword">if</span> (stat &amp;&amp; stat.<span class="hljs-title function_">isDirectory</span>()) {
      results = results.<span class="hljs-title function_">concat</span>(<span class="hljs-title function_">readStyles</span>(filePath))
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (file.<span class="hljs-title function_">endsWith</span>(<span class="hljs-string">'.scss'</span>) || file.<span class="hljs-title function_">endsWith</span>(<span class="hljs-string">'.css'</span>)) {
      results.<span class="hljs-title function_">push</span>(filePath)
    }
  })
  
  <span class="hljs-keyword">return</span> results
}

<span class="hljs-comment">// 构建完整样式文件</span>
<span class="hljs-keyword">const</span> styleFiles = <span class="hljs-title function_">readStyles</span>(path.<span class="hljs-title function_">join</span>(__dirname, <span class="hljs-string">'../src/styles'</span>))
<span class="hljs-keyword">let</span> fullStyleContent = <span class="hljs-string">''</span>

styleFiles.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">file</span> =&gt;</span> {
  <span class="hljs-keyword">const</span> content = fs.<span class="hljs-title function_">readFileSync</span>(file, <span class="hljs-string">'utf-8'</span>)
  fullStyleContent += content + <span class="hljs-string">'\n'</span>
})

<span class="hljs-comment">// 写入总样式文件</span>
<span class="hljs-keyword">const</span> outputPath = path.<span class="hljs-title function_">join</span>(__dirname, <span class="hljs-string">'../dist/style.css'</span>)
fs.<span class="hljs-title function_">writeFileSync</span>(outputPath, fullStyleContent)

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'样式构建完成！'</span>)
</code></pre>
<p>然后在package.json中添加构建命令：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"scripts"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"build"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"vite build &amp;&amp; node scripts/build-styles.js"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"dev"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"vite"</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h2 data-id="heading-7">完善package.json配置</h2>
<p>发布前，我们需要完善package.json的配置：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"my-component-library"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"version"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"1.0.0"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"description"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"A Vue 3 component library built with Vite"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"main"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"./dist/my-component-library.umd.js"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"module"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"./dist/my-component-library.es.js"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"exports"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"."</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"import"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"./dist/my-component-library.es.js"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"require"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"./dist/my-component-library.umd.js"</span>
    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"./style.css"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"./dist/style.css"</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"files"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
    <span class="hljs-string">"dist"</span>
  <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"keywords"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
    <span class="hljs-string">"vue3"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-string">"component-library"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-string">"ui"</span>
  <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"peerDependencies"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"vue"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"^3.3.0"</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>关键字段说明：main指向CommonJS版本，module指向ES模块版本，files指定发布时包含的文件。</p>
<h2 data-id="heading-8">TypeScript支持</h2>
<p>现在大家都用TypeScript，咱们的组件库也要提供类型支持。首先安装依赖：</p>
<pre><code class="hljs language-bash" lang="bash">pnpm add -D typescript @vue/tsconfig-node
</code></pre>
<p>创建<code>tsconfig.json</code>：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"compilerOptions"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"target"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"ES2020"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"useDefineForClassFields"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"lib"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"ES2020"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"DOM"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"DOM.Iterable"</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"module"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"ESNext"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"skipLibCheck"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"moduleResolution"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"bundler"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"allowImportingTsExtensions"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"resolveJsonModule"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"isolatedModules"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"noEmit"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"jsx"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"preserve"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"strict"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"noUnusedLocals"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"noUnusedParameters"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"noFallthroughCasesInSwitch"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"declaration"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"outDir"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"dist"</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"include"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"src/**/*.ts"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"src/**/*.d.ts"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"src/**/*.vue"</span><span class="hljs-punctuation">]</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>为按钮组件添加类型定义<code>src/components/Button/types.ts</code>：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">ButtonProps</span> {
  <span class="hljs-keyword">type</span>?: <span class="hljs-string">'default'</span> | <span class="hljs-string">'primary'</span> | <span class="hljs-string">'danger'</span>
  disabled?: <span class="hljs-built_in">boolean</span>
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">ButtonEmits</span> {
  (<span class="hljs-attr">e</span>: <span class="hljs-string">'click'</span>, <span class="hljs-attr">event</span>: <span class="hljs-title class_">MouseEvent</span>): <span class="hljs-built_in">void</span>
}
</code></pre>
<p>更新Button.vue使用TypeScript：</p>
<pre><code class="hljs language-vue" lang="vue">&lt;script setup lang="ts"&gt;
import type { ButtonProps, ButtonEmits } from './types'

defineProps&lt;ButtonProps&gt;()
const emit = defineEmits&lt;ButtonEmits&gt;()

const handleClick = (event: MouseEvent) =&gt; {
  emit('click', event)
}
&lt;/script&gt;
</code></pre>
<h2 data-id="heading-9">本地测试与调试</h2>
<p>发布前一定要充分测试！创建演示应用<code>playground/</code>：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">mkdir</span> playground
<span class="hljs-built_in">cd</span> playground
pnpm create vite . --template vue
</code></pre>
<p>在演示项目中链接本地组件库：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"dependencies"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"my-component-library"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"file:../"</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>创建测试页面<code>playground/src/App.vue</code>：</p>
<pre><code class="hljs language-vue" lang="vue">&lt;template&gt;
  &lt;div class="playground"&gt;
    &lt;h1&gt;组件库测试页面&lt;/h1&gt;
    &lt;MyButton type="primary" @click="handleClick"&gt;
      主要按钮
    &lt;/MyButton&gt;
    &lt;MyButton type="danger" disabled&gt;
      禁用按钮
    &lt;/MyButton&gt;
  &lt;/div&gt;
&lt;/template&gt;

&lt;script setup&gt;
import { MyButton } from 'my-component-library'

const handleClick = () =&gt; {
  console.log('按钮被点击了！')
}
&lt;/script&gt;
</code></pre>
<p>这样你就能实时测试组件效果了。</p>
<h2 data-id="heading-10">发布到npm</h2>
<p>测试通过后，就可以发布了！首先在npm官网注册账号，然后在终端登录：</p>
<pre><code class="hljs language-bash" lang="bash">npm login
</code></pre>
<p>构建最终版本：</p>
<pre><code class="hljs language-bash" lang="bash">pnpm build
</code></pre>
<p>发布！</p>
<pre><code class="hljs language-bash" lang="bash">npm publish
</code></pre>
<p>如果这是私有包想先测试，可以使用：</p>
<pre><code class="hljs language-bash" lang="bash">npm publish --tag beta
</code></pre>
<h2 data-id="heading-11">自动化与持续集成</h2>
<p>手动发布太麻烦了，咱们配置GitHub Actions自动化流程。创建<code>.github/workflows/publish.yml</code>：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">name:</span> <span class="hljs-string">Publish</span> <span class="hljs-string">to</span> <span class="hljs-string">npm</span>

<span class="hljs-attr">on:</span>
  <span class="hljs-attr">push:</span>
    <span class="hljs-attr">tags:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">'v*'</span>

<span class="hljs-attr">jobs:</span>
  <span class="hljs-attr">publish:</span>
    <span class="hljs-attr">runs-on:</span> <span class="hljs-string">ubuntu-latest</span>
    <span class="hljs-attr">steps:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">uses:</span> <span class="hljs-string">actions/checkout@v3</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">uses:</span> <span class="hljs-string">actions/setup-node@v3</span>
        <span class="hljs-attr">with:</span>
          <span class="hljs-attr">node-version:</span> <span class="hljs-string">'18'</span>
          <span class="hljs-attr">registry-url:</span> <span class="hljs-string">'https://registry.npmjs.org'</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">run:</span> <span class="hljs-string">npm</span> <span class="hljs-string">install</span> <span class="hljs-string">-g</span> <span class="hljs-string">pnpm</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">run:</span> <span class="hljs-string">pnpm</span> <span class="hljs-string">install</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">run:</span> <span class="hljs-string">pnpm</span> <span class="hljs-string">build</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">run:</span> <span class="hljs-string">npm</span> <span class="hljs-string">publish</span>
        <span class="hljs-attr">env:</span>
          <span class="hljs-attr">NODE_AUTH_TOKEN:</span> <span class="hljs-string">${{</span> <span class="hljs-string">secrets.NPM_TOKEN</span> <span class="hljs-string">}}</span>
</code></pre>
<p>这样每次打tag时就会自动发布新版本。</p>
<h2 data-id="heading-12">版本管理策略</h2>
<p>采用语义化版本控制：主版本号.次版本号.修订号（MAJOR.MINOR.PATCH）</p>
<ul>
<li>修订号：向后兼容的问题修复</li>
<li>次版本号：向后兼容的功能新增</li>
<li>主版本号：不兼容的API修改</li>
</ul>
<p>使用npm version命令管理版本：</p>
<pre><code class="hljs language-bash" lang="bash">npm version patch  <span class="hljs-comment"># 1.0.0 -&gt; 1.0.1</span>
npm version minor  <span class="hljs-comment"># 1.0.0 -&gt; 1.1.0  </span>
npm version major  <span class="hljs-comment"># 1.0.0 -&gt; 2.0.0</span>
</code></pre>
<h2 data-id="heading-13">高级技巧：按需加载与Tree Shaking</h2>
<p>为了让用户能按需引入组件，我们需要配置unplugin-vue-components：</p>
<p>首先在组件库中创建<code>components.d.ts</code>：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> <span class="hljs-keyword">type</span> { <span class="hljs-title class_">App</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">GlobalComponents</span> {
  <span class="hljs-title class_">MyButton</span>: <span class="hljs-keyword">typeof</span> <span class="hljs-keyword">import</span>(<span class="hljs-string">'./components/Button'</span>)[<span class="hljs-string">'default'</span>]
  <span class="hljs-title class_">MyInput</span>: <span class="hljs-keyword">typeof</span> <span class="hljs-keyword">import</span>(<span class="hljs-string">'./components/Input'</span>)[<span class="hljs-string">'default'</span>]
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-attr">install</span>: <span class="hljs-function">(<span class="hljs-params">app: App</span>) =&gt;</span> <span class="hljs-built_in">void</span>
</code></pre>
<p>然后在用户项目中配置vite.config.js：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> <span class="hljs-title class_">Components</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'unplugin-vue-components/vite'</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">MyComponentLibraryResolver</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'my-component-library/resolver'</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title function_">defineConfig</span>({
  <span class="hljs-attr">plugins</span>: [
    <span class="hljs-title class_">Components</span>({
      <span class="hljs-attr">resolvers</span>: [<span class="hljs-title class_">MyComponentLibraryResolver</span>()]
    })
  ]
})
</code></pre>
<h2 data-id="heading-14">常见问题与解决方案</h2>
<p><strong>问题1：组件样式不生效</strong>
解决方案：确保用户正确引入了样式文件，或在组件库中配置样式内联。</p>
<p><strong>问题2：TypeScript类型报错</strong>
解决方案：检查类型导出配置，确保declaration: true且类型文件在打包范围内。</p>
<p><strong>问题3：构建产物过大</strong>
解决方案：使用rollup-plugin-visualizer分析包大小，外部化依赖，代码分割。</p>
<h2 data-id="heading-15">维护与迭代</h2>
<p>组件库发布后，维护工作才刚刚开始：</p>
<p>建立变更日志CHANGELOG.md，记录每个版本的改动。收集用户反馈，建立Issue模板。定期更新依赖，保持技术栈的现代性。编写完善的文档，包括在线演示和API文档。</p>
<p>现在，你已经掌握了Vue 3组件库从开发到发布的完整流程。从今天开始，把那些重复的组件代码变成可复用的财富吧！</p>
<p>还记得开头那个被测试同事追着跑的尴尬场景吗？现在你可以优雅地告诉他："去npm上更新一下组件库版本就行"。这种感觉，是不是比复制粘贴爽多了？</p>
<p>如果你在实践过程中遇到任何问题，欢迎在评论区留言分享你的经历。也别忘了把这个工作流程分享给那些还在手动维护组件的小伙伴们，让他们也体验一下"一次构建，处处使用"的畅快感！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Python编程实战：Python常用命令速查表（超全整理）]]></title>    <link>https://juejin.cn/post/7575456858427523118</link>    <guid>https://juejin.cn/post/7575456858427523118</guid>    <pubDate>2025-11-23T23:52:15.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7575456858427523118" data-draft-id="7575456858427506734" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Python编程实战：Python常用命令速查表（超全整理）"/> <meta itemprop="keywords" content="后端,Python,Trae"/> <meta itemprop="datePublished" content="2025-11-23T23:52:15.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="程序员爱钓鱼"/> <meta itemprop="url" content="https://juejin.cn/user/2799775299157614"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Python编程实战：Python常用命令速查表（超全整理）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2799775299157614/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    程序员爱钓鱼
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-23T23:52:15.000Z" title="Sun Nov 23 2025 23:52:15 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>在 Python 开发过程中，很多命令与工具操作很容易忘记。无论你是新手还是经验开发者，拥有一份随手可查的“命令速查表”都能显著提升开发效率。</p>
</blockquote>
<p>本篇文章总结了 <strong>Python、pip、虚拟环境、包管理、文件操作、调试、格式化、性能测试、代码检查</strong> 等常用命令，是一份覆盖面非常全面的 Python 开发必备备忘录。</p>
<p>你可以将此文加入收藏夹或做成一页纸随身文档。</p>
<hr/>
<h2 data-id="heading-0">1. Python 命令速查</h2>
<h4 data-id="heading-1"><strong>基础命令</strong></h4>





























<table><thead><tr><th>用途</th><th>命令</th></tr></thead><tbody><tr><td>查看 Python 版本</td><td><code>python --version</code> / <code>python3 --version</code></td></tr><tr><td>进入交互式解释器</td><td><code>python</code></td></tr><tr><td>执行脚本</td><td><code>python script.py</code></td></tr><tr><td>执行一行代码</td><td><code>python -c "print('hello')"</code></td></tr><tr><td>以模块方式运行</td><td><code>python -m http.server 8000</code></td></tr></tbody></table>
<hr/>
<h2 data-id="heading-2">2. pip 包管理命令</h2>
<h4 data-id="heading-3"><strong>基本操作</strong></h4>





































<table><thead><tr><th>操作</th><th>命令</th></tr></thead><tbody><tr><td>查看 pip 版本</td><td><code>pip --version</code></td></tr><tr><td>安装包</td><td><code>pip install package_name</code></td></tr><tr><td>安装固定版本包</td><td><code>pip install package==1.2.3</code></td></tr><tr><td>升级包</td><td><code>pip install --upgrade package</code></td></tr><tr><td>卸载包</td><td><code>pip uninstall package</code></td></tr><tr><td>查看已安装包</td><td><code>pip list</code></td></tr><tr><td>列出可更新包</td><td><code>pip list --outdated</code></td></tr></tbody></table>
<hr/>
<h4 data-id="heading-4"><strong>导出/安装依赖清单</strong></h4>

















<table><thead><tr><th>功能</th><th>命令</th></tr></thead><tbody><tr><td>导出依赖</td><td><code>pip freeze &gt; requirements.txt</code></td></tr><tr><td>安装依赖</td><td><code>pip install -r requirements.txt</code></td></tr></tbody></table>
<hr/>
<h4 data-id="heading-5">国内镜像源（提高速度）</h4>













<table><thead><tr><th>镜像源</th><th>示例</th></tr></thead><tbody><tr><td>清华大学</td><td><code>pip install package -i https://pypi.tuna.tsinghua.edu.cn/simple</code></td></tr></tbody></table>
<hr/>
<h2 data-id="heading-6">3. 虚拟环境命令（venv）</h2>
<h4 data-id="heading-7"><strong>创建虚拟环境</strong></h4>
<pre><code class="hljs">python -m venv venv
</code></pre>
<h4 data-id="heading-8"><strong>激活虚拟环境</strong></h4>

















<table><thead><tr><th>系统</th><th>命令</th></tr></thead><tbody><tr><td>Windows</td><td><code>venv\Scripts\activate</code></td></tr><tr><td>macOS/Linux</td><td><code>source venv/bin/activate</code></td></tr></tbody></table>
<h4 data-id="heading-9"><strong>退出虚拟环境</strong></h4>
<pre><code class="hljs">deactivate
</code></pre>
<hr/>
<h2 data-id="heading-10">4. Poetry 命令（现代依赖管理工具）</h2>
<h4 data-id="heading-11"><strong>初始化项目</strong></h4>
<pre><code class="hljs language-csharp" lang="csharp">poetry <span class="hljs-keyword">init</span>
</code></pre>
<h4 data-id="heading-12"><strong>安装所有依赖</strong></h4>
<pre><code class="hljs">poetry install
</code></pre>
<h4 data-id="heading-13"><strong>安装依赖包</strong></h4>
<pre><code class="hljs language-csharp" lang="csharp">poetry <span class="hljs-keyword">add</span> requests
</code></pre>
<h4 data-id="heading-14"><strong>进入虚拟环境 shell</strong></h4>
<pre><code class="hljs">poetry shell
</code></pre>
<hr/>
<h2 data-id="heading-15">5. 常见 Python 模块常用命令</h2>
<h3 data-id="heading-16">（1）json 模块</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> json

json.dumps({<span class="hljs-string">"a"</span>: <span class="hljs-number">1</span>}, ensure_ascii=<span class="hljs-literal">False</span>)   <span class="hljs-comment"># dict → JSON</span>
json.loads(<span class="hljs-string">'{"a": 1}'</span>)                     <span class="hljs-comment"># JSON → dict</span>
</code></pre>
<hr/>
<h3 data-id="heading-17">（2）os 模块（文件与系统操作）</h3>





























<table><thead><tr><th>功能</th><th>命令</th></tr></thead><tbody><tr><td>当前路径</td><td><code>os.getcwd()</code></td></tr><tr><td>列出文件</td><td><code>os.listdir(path)</code></td></tr><tr><td>判断是否文件/文件夹</td><td><code>os.path.isfile()</code> / <code>os.path.isdir()</code></td></tr><tr><td>创建文件夹</td><td><code>os.makedirs(path, exist_ok=True)</code></td></tr><tr><td>删除文件</td><td><code>os.remove(file_path)</code></td></tr></tbody></table>
<hr/>
<h3 data-id="heading-18">（3）shutil（文件拷贝与移动）</h3>
<pre><code class="hljs language-python" lang="python">shutil.copy(src, dst)
shutil.move(src, dst)
shutil.rmtree(folder)
</code></pre>
<hr/>
<h2 data-id="heading-19">6. requests 常用语法速查</h2>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> requests

<span class="hljs-comment"># GET</span>
requests.get(url)

<span class="hljs-comment"># POST</span>
requests.post(url, data={<span class="hljs-string">"a"</span>: <span class="hljs-number">1</span>})

<span class="hljs-comment"># JSON</span>
requests.post(url, json={<span class="hljs-string">"key"</span>: <span class="hljs-string">"value"</span>})

<span class="hljs-comment"># 添加 headers</span>
requests.get(url, headers={<span class="hljs-string">"User-Agent"</span>: <span class="hljs-string">"Mozilla"</span>})

<span class="hljs-comment"># 下载文件</span>
requests.get(url).content
</code></pre>
<hr/>
<h2 data-id="heading-20">7. BeautifulSoup 常用命令</h2>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> bs4 <span class="hljs-keyword">import</span> BeautifulSoup

soup = BeautifulSoup(html, <span class="hljs-string">"lxml"</span>)

soup.title.text
soup.find(<span class="hljs-string">"div"</span>)
soup.find_all(<span class="hljs-string">"a"</span>)
soup.select(<span class="hljs-string">"div.classname"</span>)
</code></pre>
<hr/>
<h2 data-id="heading-21">8. Pandas 常用命令</h2>
<h4 data-id="heading-22"><strong>读取文件</strong></h4>
<pre><code class="hljs language-python" lang="python">pd.read_csv(<span class="hljs-string">"a.csv"</span>)
pd.read_excel(<span class="hljs-string">"a.xlsx"</span>)
</code></pre>
<h4 data-id="heading-23"><strong>常见操作</strong></h4>
<pre><code class="hljs language-python" lang="python">df.head()
df.info()
df.describe()
df.to_excel(<span class="hljs-string">"out.xlsx"</span>, index=<span class="hljs-literal">False</span>)
</code></pre>
<hr/>
<h2 data-id="heading-24">9. Numpy 常用命令</h2>
<pre><code class="hljs language-python" lang="python">np.array([...])
np.zeros((<span class="hljs-number">3</span>,<span class="hljs-number">3</span>))
np.ones((<span class="hljs-number">2</span>,<span class="hljs-number">4</span>))
np.random.rand(<span class="hljs-number">5</span>)
</code></pre>
<hr/>
<h2 data-id="heading-25">10. Debug 调试（pdb）</h2>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> pdb; pdb.set_trace()
</code></pre>
<p>常用调试指令：</p>

























<table><thead><tr><th>指令</th><th>含义</th></tr></thead><tbody><tr><td>n</td><td>下一行</td></tr><tr><td>c</td><td>继续执行</td></tr><tr><td>p 变量</td><td>打印变量</td></tr><tr><td>q</td><td>退出调试</td></tr></tbody></table>
<hr/>
<h2 data-id="heading-26">11. Logging 常用配置</h2>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> logging

logging.basicConfig(level=logging.INFO)

logging.info(<span class="hljs-string">"info msg"</span>)
logging.error(<span class="hljs-string">"error msg"</span>)
</code></pre>
<hr/>
<h2 data-id="heading-27">12. 性能测试命令（timeit）</h2>
<p>在命令行：</p>
<pre><code class="hljs language-ini" lang="ini">python -m timeit "<span class="hljs-attr">x</span>=<span class="hljs-number">5</span><span class="hljs-comment">; x*x"</span>
</code></pre>
<p>在代码中：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> timeit
timeit.timeit(<span class="hljs-string">"x=5; x*x"</span>)
</code></pre>
<hr/>
<h2 data-id="heading-28">13. 代码质量检查</h2>
<h4 data-id="heading-29"><strong>flake8（静态检查）</strong></h4>
<pre><code class="hljs">flake8 your_code.py
</code></pre>
<h4 data-id="heading-30"><strong>black（格式化）</strong></h4>
<pre><code class="hljs language-erlang" lang="erlang">black .
</code></pre>
<hr/>
<h2 data-id="heading-31">14. 打包与发布</h2>
<h4 data-id="heading-32"><strong>PyInstaller 打包</strong></h4>
<pre><code class="hljs language-r" lang="r">pyinstaller <span class="hljs-operator">-</span><span class="hljs-built_in">F</span> script.py
</code></pre>
<h4 data-id="heading-33"><strong>构建 pip 包</strong></h4>
<pre><code class="hljs language-arduino" lang="arduino">python setup.py sdist bdist_wheel
twine upload dist<span class="hljs-comment">/*
</span></code></pre>
<hr/>
<h2 data-id="heading-34">15. 其他常用命令集合</h2>
<h4 data-id="heading-35">查看模块安装位置</h4>
<pre><code class="hljs">python -m site
</code></pre>
<h4 data-id="heading-36">查找模块路径</h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> module; <span class="hljs-built_in">print</span>(module.__file__)
</code></pre>
<h4 data-id="heading-37">列出当前目录下所有 .py 文件</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">ls</span> *.py
</code></pre>
<hr/>
<h2 data-id="heading-38">结语</h2>
<p>这篇速查表涵盖了 Python 实战中最常用的命令、工具和库操作，从环境、包管理、常规编码，到性能调试、格式化、打包等多个方面。</p>
<p>无论你是在写脚本、做数据分析、搞爬虫、写后端 API，还是开发自动化工具，这些命令都能帮你节省大量时间。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Python 编程实战：常用第三方库清单]]></title>    <link>https://juejin.cn/post/7575367791273443366</link>    <guid>https://juejin.cn/post/7575367791273443366</guid>    <pubDate>2025-11-23T23:52:49.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7575367791273443366" data-draft-id="7575182522412072998" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Python 编程实战：常用第三方库清单"/> <meta itemprop="keywords" content="后端,Python,Trae"/> <meta itemprop="datePublished" content="2025-11-23T23:52:49.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="程序员爱钓鱼"/> <meta itemprop="url" content="https://juejin.cn/user/2799775299157614"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Python 编程实战：常用第三方库清单
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2799775299157614/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    程序员爱钓鱼
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-23T23:52:49.000Z" title="Sun Nov 23 2025 23:52:49 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>在 Python 编程实战中，除了掌握语言基础和标准库，熟悉一些常用的 <strong>第三方库</strong> 能极大提升开发效率。本文将从数据处理、科学计算、网络编程、爬虫、Web 开发、自动化、机器学习等几个方向，为你整理一份高效实用的第三方库清单。</p>
</blockquote>
<hr/>
<h2 data-id="heading-0">1. 数据处理与分析</h2>
<p>Python 在数据处理方面非常强大，这类库主要用于数据清洗、分析、处理和可视化。</p>
<ul>
<li><strong>Pandas</strong>：数据分析和处理神器，支持 DataFrame 和 Series，方便读写 Excel、CSV、SQL 数据。</li>
<li><strong>NumPy</strong>：科学计算基础库，提供高性能多维数组和矩阵操作。</li>
<li><strong>OpenPyXL / xlrd / xlwt</strong>：操作 Excel 文件的常用库。</li>
<li><strong>PyArrow</strong>：高性能列式存储库，用于大数据处理。</li>
<li><strong>Polars</strong>：类似 Pandas，但性能更高，适合大数据场景。</li>
</ul>
<hr/>
<h2 data-id="heading-1">2. 数据可视化</h2>
<p>可视化是数据分析不可或缺的一环，Python 提供了丰富的图表工具。</p>
<ul>
<li><strong>Matplotlib</strong>：经典绘图库，支持折线图、散点图、柱状图等。</li>
<li><strong>Seaborn</strong>：基于 Matplotlib 的高级绘图库，更美观，适合统计图表。</li>
<li><strong>Plotly</strong>：交互式图表库，可生成 Web 可交互图表。</li>
<li><strong>pyecharts</strong>：国内流行的可视化库，结合百度 ECharts，适合 Web 可视化。</li>
<li><strong>Altair</strong>：声明式可视化库，语法简洁，适合快速作图。</li>
</ul>
<hr/>
<h2 data-id="heading-2">3. 网络与爬虫</h2>
<p>Python 在网络请求和爬虫领域非常受欢迎。</p>
<ul>
<li><strong>Requests</strong>：最常用 HTTP 请求库，简单易用。</li>
<li><strong>httpx</strong>：异步 HTTP 客户端，支持 HTTP/2。</li>
<li><strong>BeautifulSoup</strong>：HTML/XML 解析库，适合网页数据提取。</li>
<li><strong>lxml</strong>：高性能解析库，比 BeautifulSoup 更快，支持 XPath。</li>
<li><strong>Scrapy</strong>：功能强大的爬虫框架，适合大规模数据抓取。</li>
<li><strong>Selenium</strong>：浏览器自动化工具，用于处理动态页面。</li>
</ul>
<hr/>
<h2 data-id="heading-3">4. Web 开发</h2>
<p>Python 在 Web 开发领域同样广泛应用。</p>
<ul>
<li><strong>Flask</strong>：轻量级 Web 框架，适合快速开发 API。</li>
<li><strong>Django</strong>：全功能 Web 框架，内置 ORM、Admin 等组件，适合大型项目。</li>
<li><strong>FastAPI</strong>：现代化高性能 Web 框架，支持异步和自动生成 API 文档。</li>
<li><strong>Tornado</strong>：支持高并发异步网络应用的 Web 框架。</li>
<li><strong>Jinja2</strong>：Python 模板引擎，常配合 Flask 使用。</li>
</ul>
<hr/>
<h2 data-id="heading-4">5. 自动化与脚本工具</h2>
<p>Python 的自动化能力是其核心优势之一。</p>
<ul>
<li><strong>PyAutoGUI</strong>：跨平台 GUI 自动化操作库。</li>
<li><strong>Selenium / Playwright</strong>：浏览器自动化，适合自动化测试和操作网页。</li>
<li><strong>openpyxl / xlwings</strong>：自动化操作 Excel 文件。</li>
<li><strong>schedule / APScheduler</strong>：任务调度库，轻松实现定时任务。</li>
<li><strong>shutil / pathlib</strong>：文件系统自动化操作，结合标准库使用。</li>
</ul>
<hr/>
<h2 data-id="heading-5">6. 机器学习与深度学习</h2>
<p>Python 是数据科学和 AI 的首选语言，各类库丰富完善。</p>
<ul>
<li><strong>scikit-learn</strong>：经典机器学习库，支持分类、回归、聚类等算法。</li>
<li><strong>XGBoost / LightGBM / CatBoost</strong>：高性能梯度提升算法库。</li>
<li><strong>TensorFlow / PyTorch</strong>：深度学习框架，支持 GPU 加速和复杂神经网络。</li>
<li><strong>Keras</strong>：基于 TensorFlow 的高级神经网络接口。</li>
<li><strong>Transformers</strong>：HuggingFace 提供的 NLP 模型库。</li>
</ul>
<hr/>
<h2 data-id="heading-6">7. 图像与多媒体处理</h2>
<ul>
<li><strong>Pillow</strong>：Python 图像处理库，支持基本图像操作。</li>
<li><strong>OpenCV</strong>：计算机视觉库，支持图像处理、视频分析、实时检测。</li>
<li><strong>moviepy</strong>：视频编辑和处理库。</li>
<li><strong>PyPDF2 / fitz (PyMuPDF)</strong>：PDF 操作库，支持合并、拆分、提取文本。</li>
</ul>
<hr/>
<h2 data-id="heading-7">8. 开发工具与效率提升</h2>
<ul>
<li><strong>Click / Typer</strong>：快速开发命令行工具。</li>
<li><strong>rich / textual</strong>：漂亮的终端输出和 TUI 应用。</li>
<li><strong>pytest</strong>：测试框架，支持单元测试和集成测试。</li>
<li><strong>black / isort / flake8</strong>：代码格式化与规范检查，提高团队开发效率。</li>
</ul>
<hr/>
<h2 data-id="heading-8">结语</h2>
<p>Python 的第三方库生态非常丰富，本篇文章列出的只是实战中最常用的部分。掌握这些库，可以大大提升你的开发效率和项目可维护性。</p>
<p>实践建议：</p>
<ol>
<li>根据项目需求选择最合适的库。</li>
<li>熟练掌握官方文档，避免盲目依赖示例。</li>
<li>尝试组合多个库，实现更高效的解决方案。</li>
</ol>
<p>掌握这些库，你就可以在数据分析、爬虫、Web 开发、自动化、机器学习等领域游刃有余，实现 Python 编程实战的真正价值。</p>
<hr/></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[不易懂你打我！写给前端和小白的 大模型(ChatGPT) 工作基本原理！]]></title>    <link>https://juejin.cn/post/7575162322241077248</link>    <guid>https://juejin.cn/post/7575162322241077248</guid>    <pubDate>2025-11-23T23:57:00.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7575162322241077248" data-draft-id="7558181864130953256" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="不易懂你打我！写给前端和小白的 大模型(ChatGPT) 工作基本原理！"/> <meta itemprop="keywords" content="前端,人工智能"/> <meta itemprop="datePublished" content="2025-11-23T23:57:00.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="孟祥_成都"/> <meta itemprop="url" content="https://juejin.cn/user/96412752684744"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            不易懂你打我！写给前端和小白的 大模型(ChatGPT) 工作基本原理！
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/96412752684744/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    孟祥_成都
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-23T23:57:00.000Z" title="Sun Nov 23 2025 23:57:00 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读10分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>本文承接上文<a href="https://juejin.cn/post/7573592127299108914" target="_blank" title="https://juejin.cn/post/7573592127299108914">打包票！前端和小白一定能明白的人工智能基础概念</a>，强烈建议大家阅读一下，文章采用层层递进的超级白话的方式，让我们了解机器学习，神经网络和深度学习的关系和概念。</p>
<h2 data-id="heading-0">前言</h2>
<p>实在是受够了很多文章写给小白的大模型工作原理的文章，看了还是觉得很多文章内部毫无逻辑可言，所以我觉得自己弄清楚后，写下这些留给跟我对这些文章同样一头雾水的伙伴！</p>
<h2 data-id="heading-1">从语言模型说起</h2>
<p>首先大模型一定要有自己的语言模型，才能理解人类语言的基本逻辑关系，并且输出对应的回答也是我们能看懂的。那大模型的语言模型是什么呢?如何做到好像类似 <code>ChatGPT</code>、<code>DeepSeek</code> 这样的聊天 <code>ai</code> 似乎理解我们人类语言似的，真的是这样吗？</p>
<p>先说答案，其实不是，这个语言模型简单来说就是：”预测下一个语素“（统计语言模型）。</p>
<p>什么意思呢，大家在使用输入法打字的时候，是不是很多时候，当你打一个字或者词的时候，输入法会帮你预测你下一个字是什么，这就是预测下一个元素，比如'鸡你太_'，如果你是小黑子，就可能出现什么字呢，你猜猜。。。</p>
<p>你可能会疑惑: 我去，这么暴力？这还是 <code>ai</code> 吗？看起来不太聪明的样子？！回答就是，你还真别小看这个模型，小小手机能收集你的语言习惯，同理是不是当你给 <code>ai</code> 足够的训练资料的时候，<code>ai</code> 能学习到大部分人的语言习惯呢？</p>
<p>很多人肯定还是疑惑，人类语言这么巧妙，这种粗暴的方式真的有效？我们举个例子</p>
<p>假设这样一句话：他放下了书，因为它太_。</p>
<p>在太后面可能是太重，可能是太难等等常见搭配，也就是当大模型猜测，是重或者难的时候，很可能前面表达的内容表达的是一种让人很不舒服的感觉，也是从某种角度理解了重和难在现实中的意思。</p>
<p>我们再来想一下，这个"太"字，在大模型见过的语料够多后，它也慢慢发现，原来"太"这个字后面经常跟形容词，这算不算某种程度上学习到了人类语言的语言规律呢？</p>
<p>但这里问题来了，基本的词性，比如一个词是形容词，还是名词，计算机是不是开始就要对我们输入的问题进行分词?然后理解分词的词语，然后建立一套模型，让这些词语之间建立联系，这样才能在自己输出"太"字的时候，知道后面往往跟 <code>难</code> 、<code>重</code> 或者其它意思？</p>
<p>在解释如何建立联系的之前，我们必须弄清楚计算机本身是如何处理文本的！</p>
<h2 data-id="heading-2">计算机如何处理文本</h2>
<p>计算机本质上就是计算器，它只能计算，无法理解文本，例如字母a，在ascii编码中，在计算机中用97来表示，比如让计算机算 字母a 和b的大小，只不过是在计算机内部比较了97和98的大小而已。</p>
<p>同理，大模型也需要把文字转为数字来处理（为什么？因为计算机只能计算数字！），例如”人“在计算机中如何表示，是不是可以这样，用一个数字填充的数组：<code>[0，175，60，20]</code></p>
<ul>
<li>数组第一位，0代表男生，1代表女生</li>
<li>数组第二位，175代表身高</li>
<li>数组第三位，60表示体重</li>
<li>数组第四位，20表示年龄</li>
</ul>
<p>这样就在 4 个维度描述了一个人，假设有这样一个数据，[0，170，50，20] ，在四维空间中其实跟上一个人产生了联系，也就是某些维度上是相近的。</p>
<p>因为现实世界特别复杂， 所以一个词的维度有非常多。我们这里只是很粗暴的用了 <code>4</code> 个维度，正常大模型可能认为一个词的维度能上千或者上万，这取决于大模型自己的算法如何理解这个世界。</p>
<p>现在解决了如何把文字转换为数字让计算机处理的问题，接下来新的问题又来了。如何给某个词设置合适的向量值。</p>
<p>这个专术语叫嵌入（Embedding），目的提取文本的特征，这里有特定的算法来解决，因为我也不是这方面专业人员，这里不做过多介绍，有兴趣的同学可以去搜索<code>词袋模型</code>,<code>TFFIDF</code>。</p>
<p>在给这些词语标注特定向量值的过程，使用的技术方法不同，最终效果也不同，比如 <code>ChatGPT</code> 使用了一种叫做“上下文词向量表示法”，这个方法标注的每个词的向量值不仅取决于这个单词本身，还取决于这个词在不同上下文中的意思。</p>
<p>例如 <code>苹果</code> 这个词讨论水果和电子产品（苹果手机）时的含义是完全不一样的。这就是很多文章说的<code>自注意力机制</code>。</p>
<p>那解决了基本词语在计算机中如何展示，并且映射现实语义的情况下，我们就该开始训练大模型能解决实际用户提出的问题了。</p>
<p>gpt 这个词就是根据上面我们说的模型原理命名的缩写 ，p 就是 pre–trained，预训练的意思，也就是要通过大量语料来给它学习，然后通过训练让其找到语言中很多词语搭配的规律。然后生成答案，这就是 gpt中字母 g 的意思，generative的意思。</p>
<p>也就是说，我们要开始 <code>预训练</code> 了。</p>
<h2 data-id="heading-3">预训练</h2>
<p>我们刚才说了，这种统计语言模型，是靠猜下一个字是什么来生成文字给用户的。这个训练的目的，就是让大模型知道"在什么情况下，下一个字应该是什么"。</p>
<p>所以预训练的过程，还会不断调整 <code>向量</code> 的值。</p>
<h3 data-id="heading-4">什么是预训练？</h3>
<p>想象一下，我们要培养一个<strong>文学大师</strong>：</p>
<p><strong>预训练</strong> = 让这个大师<strong>博览群书</strong>的阶段</p>
<p>在这个阶段，我们给模型喂食<strong>海量的文本数据</strong>——包括维基百科、新闻文章、小说、科技论文、论坛讨论等等。但注意：这时候我们<strong>不教它完成任何具体任务</strong>，比如回答问题或者写邮件。</p>
<p>我们只让它做一件事：<strong>不断地猜下一个字</strong>。</p>
<h3 data-id="heading-5">预训练的具体过程</h3>
<pre><code class="hljs language-arduino" lang="arduino">输入：<span class="hljs-string">"今天天气真"</span>
目标输出：<span class="hljs-string">"好"</span>  <span class="hljs-comment">// 模型要猜出这个字</span>

输入：<span class="hljs-string">"人工智能是"</span>
目标输出：<span class="hljs-string">"未"</span>  <span class="hljs-comment">// 接着猜"来"等</span>

输入：<span class="hljs-string">"中国的首都是"</span>
目标输出：<span class="hljs-string">"北"</span>  <span class="hljs-comment">// 接着猜"京"</span>
</code></pre>
<p>就这样，模型在数万亿个这样的例子上进行训练，逐渐学习到：</p>
<ul>
<li><strong>语法规则</strong>："的"后面通常跟名词</li>
<li><strong>常识知识</strong>："北京是中国的首都"</li>
<li><strong>逻辑推理</strong>："因为下雨，所以..."后面可能是"带伞"、"取消活动"</li>
<li><strong>文体风格</strong>：论文和社交媒体的语言风格差异</li>
</ul>
<p>总而言之，不断地猜下一个字的过程中，逐渐掌握基本的语言规律和表达能力。</p>
<p>预训练之后，还会有些一些调整，这时候尤其是人为的标注，可以极大让纠正和优化大模型的向量值。</p>
<p>如果你看过我上一篇文章，一定要理解权重这个概念，其实<code>chatGPT</code>的训练过程，同样是在调节权重：</p>
<p>上文写到：</p>
<blockquote>
<p>训练就是不断调整 w，使得模型能正确分类。</p>
</blockquote>
<p>这就是 ChatGPT 的训练过程（预训练）！</p>
<p>ChatGPT 训练时：</p>
<ul>
<li>输入大量文本</li>
<li>预测下一个词</li>
<li>如果预测错了 → 调整权重 w</li>
<li>重复 trillions 次 → 得到现在的能力</li>
</ul>
<p>那 <code>ChatGPT</code> 和基础的神经网络学习哪方面区别很大呢？</p>
<p>我们之前说了 <code>ChatGPT</code>(chat是聊天的意思)中 <code>G</code> 和 <code>P</code> 我们解释了，有人会说还有个 t 呢？它代表的是 <code>transformer</code> 的意思。这个 <code>tranformer</code> 就是与普通神经网络最大的区别。</p>
<h2 data-id="heading-6">ChatGPT 为什么突然这么聪明？</h2>
<p>我们前面一直在说：大模型预测下一个字，用的是“上下文词向量表示法”，也就是一个词在<strong>不同上下文</strong>里的含义不同。</p>
<p>问题来了：</p>
<blockquote>
<p><strong>模型如何知道“上下文”？</strong><br/>
也就是说，它怎么知道一句话里哪些词应该互相影响？</p>
</blockquote>
<p>这就是 <code>transformer</code> 出场的时刻了。</p>
<p>GPT 里的 <strong>T = Transformer</strong>，它是这十年来让所有大模型突然变强的“关键武器”，可以说是<strong>整个大模型爆发的核心技术</strong>。</p>
<p>下面我们用最简单方式讲明白它到底在干嘛。</p>
<h3 data-id="heading-7">Transformer 解决了一个什么痛点？</h3>
<p>在 Transformer 出现之前，模型主要靠 <strong>RNN/LSTM</strong> 来看上下文，但它有两个大毛病：</p>
<ol>
<li><strong>只能从前往后一个字一个字读，速度慢</strong></li>
<li><strong>距离远的词，很难建立联系</strong></li>
</ol>
<p>举例：</p>
<pre><code class="hljs">我买了一本书，它特别好看。
</code></pre>
<p>这里：</p>
<ul>
<li>“它” 指的是 “书”</li>
<li>“好看” 也和 “书” 对应</li>
</ul>
<p>但在旧模型里，这种“跨很多词”的关系会被稀释掉,也就无法联系上下文来理解长句子的意思。</p>
<p><code>Transformer</code> 说：</p>
<blockquote>
<p><strong>我一次性看整句话，不是一个字一个字扫！</strong><br/>
并且我会计算句子里每个字对每个字的重要程度。</p>
</blockquote>
<p>这能力就是传说中的 —— <strong>自注意力机制（Self-Attention）</strong></p>
<h2 data-id="heading-8">什么是自注意力机制？</h2>
<p>你可以把一整句话想象成一桌开会的人。</p>
<p>例如一句话：</p>
<blockquote>
<p><strong>“他放下了书，因为它太重。”</strong></p>
</blockquote>
<p>在 Transformer 的“会议”里，这些词会互相发消息：</p>
<ul>
<li>“它” 会问所有词：“我到底指的是谁？”</li>
<li>“重” 会问：“我应该描述哪个名词？”</li>
<li>“放下” 会问：“发生这个动作的原因是什么？”</li>
</ul>
<p>然后 <code>Transformer </code>会给这些联系打分，比如：</p>
<ul>
<li>“它” → “书”：权重很高（说明它指书）</li>
<li>“重” → “书”：权重很高（说明重描述书）</li>
<li>“因为” → “放下”：权重很高（说明因果关系）</li>
</ul>
<p>这套“你影响我，我影响你”的机制，就是<strong>自注意力</strong>。</p>
<p>一句话总结：</p>
<blockquote>
<p><strong>自注意力机制让模型自动找出句子里哪些词对当前词最重要</strong></p>
</blockquote>
<p>这就是 Transformer 的本事！</p>
<p><strong>GPT 的 G（生成）和 P（预训练）解决了“怎么学语言”，<br/>
但 Transformer（T）解决了“怎么理解上下文”。</strong></p>
<p>有了 Transformer，模型不再是“瞎猜下一个字”，<br/>
而是能基于全句、全段、全篇来猜。</p>
<p>这就是 ChatGPT 看起来像“能理解你”的原因。</p>
<h2 data-id="heading-9">小结</h2>
<p>我相信文章内容虽然没有很多专业人士高大上的描述，但用于入门 ai 基础知识，算是足够白话了！感谢大家！</p>
<p>我的 <code>ai</code> 学习记录</p>
<ul>
<li><a href="https://juejin.cn/post/7573592127299108914" target="_blank" title="https://juejin.cn/post/7573592127299108914">打包票！前端和小白一定能明白的人工智能基础概念</a></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Spring Boot拦截器结合HMAC-SHA256实现API安全验证]]></title>    <link>https://juejin.cn/post/7575468252657041449</link>    <guid>https://juejin.cn/post/7575468252657041449</guid>    <pubDate>2025-11-23T23:56:02.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7575468252657041449" data-draft-id="7574978545144987683" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Spring Boot拦截器结合HMAC-SHA256实现API安全验证"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-11-23T23:56:02.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="风象南"/> <meta itemprop="url" content="https://juejin.cn/user/2524134428655159"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Spring Boot拦截器结合HMAC-SHA256实现API安全验证
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2524134428655159/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    风象南
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-23T23:56:02.000Z" title="Sun Nov 23 2025 23:56:02 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言</h2>
<p>在开放平台和第三方集成的项目中，如何确保 API 调用的安全性和可靠性是一个重要课题。特别是对于没有用户登录场景的系统间调用，传统的session或token认证方式并不适用，数字签名技术就成为了一种理想的选择。</p>
<p>这种验证方式在开放平台、SaaS服务、微服务间调用等场景下特别实用，能够有效验证请求来源的合法性，防止参数被篡改和重放攻击。</p>
<p>本文将详细介绍如何基于 Spring Boot 拦截器和 HMAC-SHA256 算法，构建一套轻量级但足够安全的 API 验签机制。</p>
<h2 data-id="heading-1">什么是数字签名？</h2>
<p>数字签名是一种用于验证数据完整性和真实性的技术手段。在 API 调用中，数字签名通过以下方式保障安全：</p>
<ul>
<li><strong>1. 身份验证</strong>：确认请求方身份的合法性</li>
<li><strong>2. 数据完整性</strong>：确保请求参数在传输过程中未被篡改</li>
<li><strong>3. 防止重放攻击</strong>：通过时间戳等机制防止请求被重复使用</li>
</ul>
<h2 data-id="heading-2">整体设计</h2>
<h4 data-id="heading-3">设计思路</h4>
<p>我们的验签机制基于以下核心思想：</p>
<ul>
<li><strong>无侵入性</strong>：通过 Spring Boot 拦截器实现，业务代码无需改动</li>
<li><strong>算法安全性</strong>：采用业界成熟的 HMAC-SHA256 算法</li>
<li><strong>配置灵活</strong>：支持多客户端、多密钥管理</li>
</ul>
<h4 data-id="heading-4">架构流程图</h4>
<pre><code class="hljs language-css" lang="css">客户端请求 → 生成签名 → 发送请求 → 拦截器验证 → 业务处理
     ↓              ↓           ↓           ↓           ↓
  <span class="hljs-selector-attr">[参数整理]</span>    <span class="hljs-selector-attr">[HMAC加密]</span>  <span class="hljs-selector-attr">[携带签名头]</span>  <span class="hljs-selector-attr">[验签逻辑]</span>  <span class="hljs-selector-attr">[通过/拒绝]</span>
     ↓              ↓           ↓           ↓           ↓
   参数排序    +时间戳加密   X-API-Key    密钥匹配    正常响应
     ↓              ↓           ↓           ↓           ↓
   拼接参数    Base64编码   X-Timestamp  时间戳验证   或返回<span class="hljs-number">401</span>
     ↓              ↓           ↓           ↓
   待签字符串    完整签名     X-Signature  签名对比
</code></pre>
<h2 data-id="heading-5">HMAC-SHA256 签名原理</h2>
<p>HMAC（Hash-based Message Authentication Code，基于哈希的消息认证码）结合了哈希函数和密钥，提供了一种安全高效的消息认证方式。</p>
<h4 data-id="heading-6">签名生成算法</h4>
<pre><code class="hljs language-scss" lang="scss">签名 = <span class="hljs-built_in">Base64</span>(HMAC-SHA256(时间戳 + 排序后的请求参数, 密钥))
</code></pre>
<h4 data-id="heading-7">算法步骤</h4>
<ul>
<li><strong>1. 参数标准化</strong>：将所有请求参数按字典序排序</li>
<li><strong>2. 数据拼接</strong>：将时间戳和排序后的参数按规则拼接</li>
<li><strong>3. 签名运算</strong>：使用密钥对拼接字符串进行 HMAC-SHA256 运输</li>
<li><strong>4. 编码转换</strong>：对加密结果进行 Base64 编码生成最终签名</li>
</ul>
<h2 data-id="heading-8">核心组件实现</h2>
<h4 data-id="heading-9">1. 签名工具类</h4>
<p>签名工具类是整个机制的核心，负责签名的生成和验证逻辑</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SignatureUtil</span> {

    <span class="hljs-comment">/**
     * 生成签名
     * 签名算法：Base64(HMAC-SHA256(timestamp + sortedParams, secret))
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">generateSignature</span><span class="hljs-params">(Map&lt;String, Object&gt; params,
                                         String timestamp, String secret)</span> {
        <span class="hljs-comment">// 参数排序并拼接</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">sortedParams</span> <span class="hljs-operator">=</span> sortParams(params);
        <span class="hljs-type">String</span> <span class="hljs-variable">dataToSign</span> <span class="hljs-operator">=</span> timestamp + sortedParams;

        <span class="hljs-comment">// HMAC-SHA256加密并Base64编码</span>
        <span class="hljs-type">HMac</span> <span class="hljs-variable">hmac</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HMac</span>(HmacAlgorithm.HmacSHA256, secret.getBytes(StandardCharsets.UTF_8));
        <span class="hljs-type">byte</span>[] digest = hmac.digest(dataToSign);
        <span class="hljs-keyword">return</span> Base64.getEncoder().encodeToString(digest);
    }

    <span class="hljs-comment">/**
     * 验证时间戳有效性（防重放攻击）
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">validateTimestamp</span><span class="hljs-params">(String timestamp, <span class="hljs-type">long</span> tolerance)</span> {
        <span class="hljs-type">long</span> <span class="hljs-variable">requestTime</span> <span class="hljs-operator">=</span> Long.parseLong(timestamp);
        <span class="hljs-type">long</span> <span class="hljs-variable">currentTime</span> <span class="hljs-operator">=</span> System.currentTimeMillis() / <span class="hljs-number">1000</span>;
        <span class="hljs-keyword">return</span> Math.abs(currentTime - requestTime) &lt;= tolerance;
    }
}
</code></pre>
<h4 data-id="heading-10">2. 拦截器</h4>
<p>拦截器负责对所有受保护接口进行统一的签名验证</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SignatureValidationInterceptor</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">HandlerInterceptor</span> {

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">preHandle</span><span class="hljs-params">(HttpServletRequest request, HttpServletResponse response, Object handler)</span> {
        <span class="hljs-comment">// 1. 获取签名头信息</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">timestamp</span> <span class="hljs-operator">=</span> request.getHeader(<span class="hljs-string">"X-Timestamp"</span>);
        <span class="hljs-type">String</span> <span class="hljs-variable">signature</span> <span class="hljs-operator">=</span> request.getHeader(<span class="hljs-string">"X-Signature"</span>);
        <span class="hljs-type">String</span> <span class="hljs-variable">apiKey</span> <span class="hljs-operator">=</span> request.getHeader(<span class="hljs-string">"X-Api-Key"</span>);

        <span class="hljs-comment">// 2. 验证必要参数</span>
        <span class="hljs-keyword">if</span> (!StringUtils.hasText(timestamp) || !StringUtils.hasText(signature) || !StringUtils.hasText(apiKey)) {
            <span class="hljs-keyword">return</span> writeErrorResponse(response, <span class="hljs-string">"Missing required signature headers"</span>);
        }

        <span class="hljs-comment">// 3. 验证时间戳（防重放攻击）</span>
        <span class="hljs-keyword">if</span> (!SignatureUtil.validateTimestamp(timestamp, timeTolerance)) {
            <span class="hljs-keyword">return</span> writeErrorResponse(response, <span class="hljs-string">"Invalid timestamp"</span>);
        }

        <span class="hljs-comment">// 4. 获取密钥并验证签名</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">secret</span> <span class="hljs-operator">=</span> securityProperties.getApiSecret(apiKey);
        <span class="hljs-keyword">if</span> (secret == <span class="hljs-literal">null</span> || !SignatureUtil.verifySignature(extractParams(request), timestamp, secret, signature)) {
            <span class="hljs-keyword">return</span> writeErrorResponse(response, <span class="hljs-string">"Invalid signature"</span>);
        }

        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>; <span class="hljs-comment">// 验证通过，继续处理请求</span>
    }
}
</code></pre>
<h4 data-id="heading-11">3. 配置类（WebMvcConfig）</h4>
<p>配置类负责将拦截器集成到 Spring Boot 的请求处理链中：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Configuration</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">WebMvcConfig</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">WebMvcConfigurer</span> {

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">addInterceptors</span><span class="hljs-params">(InterceptorRegistry registry)</span> {
        registry.addInterceptor(signatureValidationInterceptor)
                .addPathPatterns(<span class="hljs-string">"/api/**"</span>)              <span class="hljs-comment">// 拦截所有API请求</span>
                .excludePathPatterns(<span class="hljs-string">"/api/public/**"</span>);  <span class="hljs-comment">// 排除公开接口</span>
    }
}
</code></pre>
<h2 data-id="heading-12">客户端调用示例</h2>
<h4 data-id="heading-13">请求头设置</h4>
<p>客户端需要在请求头中包含三个必要字段：</p>
<ul>
<li><code>X-Api-Key</code>：客户端标识</li>
<li><code>X-Timestamp</code>：当前时间戳（秒级）</li>
<li><code>X-Signature</code>：生成的签名</li>
</ul>
<h4 data-id="heading-14">完整调用流程</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 1. 准备请求参数</span>
Map&lt;String, Object&gt; params = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();
params.put(<span class="hljs-string">"userId"</span>, <span class="hljs-string">"12345"</span>);
params.put(<span class="hljs-string">"type"</span>, <span class="hljs-string">"profile"</span>);

<span class="hljs-comment">// 2. 生成签名</span>
<span class="hljs-type">String</span> <span class="hljs-variable">timestamp</span> <span class="hljs-operator">=</span> String.valueOf(System.currentTimeMillis() / <span class="hljs-number">1000</span>);
<span class="hljs-type">String</span> <span class="hljs-variable">signature</span> <span class="hljs-operator">=</span> SignatureUtil.generateSignature(params, timestamp, <span class="hljs-string">"your-secret"</span>);

<span class="hljs-comment">// 3. 设置请求头并发送请求</span>
<span class="hljs-type">Headers</span> <span class="hljs-variable">headers</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Headers</span>();
headers.set(<span class="hljs-string">"X-Api-Key"</span>, <span class="hljs-string">"client1"</span>);
headers.set(<span class="hljs-string">"X-Timestamp"</span>, timestamp);
headers.set(<span class="hljs-string">"X-Signature"</span>, signature);

<span class="hljs-comment">// GET /api/protected/data?userId=12345&amp;type=profile</span>
</code></pre>
<h2 data-id="heading-15">安全性设计要点</h2>
<h4 data-id="heading-16">1. 防重放攻击</h4>
<ul>
<li><strong>时间戳验证</strong>：服务端验证时间戳的有效性（默认容忍度5分钟）</li>
<li><strong>唯一性保证</strong>：相同参数在不同时间戳下生成不同签名</li>
<li><strong>配置灵活</strong>：可根据业务需求调整容忍时间</li>
</ul>
<h4 data-id="heading-17">2. 密钥管理</h4>
<ul>
<li><strong>多客户端支持</strong>：每个客户端使用独立的 API Key 和密钥</li>
<li><strong>配置化管理</strong>：通过配置文件或其他存储组件统一管理密钥映射</li>
<li><strong>定期轮换</strong>：建议定期更换密钥以提升安全性</li>
</ul>
<h4 data-id="heading-18">3. 日志审计</h4>
<ul>
<li><strong>请求日志</strong>：记录验证失败的关键信息（不包含完整签名）</li>
<li><strong>IP追踪</strong>：记录客户端真实IP地址</li>
<li><strong>安全预警</strong>：异常签名验证触发告警机制</li>
</ul>
<h2 data-id="heading-19">安全性增强建议</h2>
<h4 data-id="heading-20">1. 传输层安全</h4>
<ul>
<li><strong>HTTPS强制</strong>：所有API请求必须通过HTTPS传输</li>
<li><strong>证书验证</strong>：启用双向证书认证增加安全性</li>
<li><strong>协议升级</strong>：及时更新SSL/TLS协议版本</li>
</ul>
<h4 data-id="heading-21">2. 密钥管理优化</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 生成安全密钥（32位随机字符串）</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">generateSecureKey</span><span class="hljs-params">()</span> {
    <span class="hljs-type">String</span> <span class="hljs-variable">chars</span> <span class="hljs-operator">=</span> <span class="hljs-string">"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789"</span>;
    <span class="hljs-type">SecureRandom</span> <span class="hljs-variable">random</span> <span class="hljs-operator">=</span> SecureRandom.getInstanceStrong();
    <span class="hljs-type">StringBuilder</span> <span class="hljs-variable">sb</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuilder</span>();

    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">32</span>; i++) {
        sb.append(chars.charAt(random.nextInt(chars.length())));
    }

    <span class="hljs-keyword">return</span> sb.toString();
}
</code></pre>
<h4 data-id="heading-22">3. 请求限流</h4>
<p>建议结合 Redis 实现请求限流，防止暴力破解：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 简限流逻辑示例</span>
<span class="hljs-type">String</span> <span class="hljs-variable">rateLimitKey</span> <span class="hljs-operator">=</span> <span class="hljs-string">"api_limit:"</span> + apiKey;
<span class="hljs-type">long</span> <span class="hljs-variable">count</span> <span class="hljs-operator">=</span> redisTemplate.opsForValue().increment(rateLimitKey);
<span class="hljs-keyword">if</span> (count &gt; <span class="hljs-number">100</span>) { <span class="hljs-comment">// 每分钟限制100次请求</span>
    <span class="hljs-keyword">return</span> writeErrorResponse(response, <span class="hljs-string">"Too many requests"</span>);
}
</code></pre>
<h2 data-id="heading-23">测试验证</h2>
<h4 data-id="heading-24">正常流程测试</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 使用curl测试（需要先根据参数生成签名）</span>
timestamp=$(<span class="hljs-built_in">date</span> +%s)
signature=$(生成签名逻辑)
curl -X GET <span class="hljs-string">"http://localhost:8080/api/protected/data?userId=12345"</span> \
  -H <span class="hljs-string">"X-Api-Key: client1"</span> \
  -H <span class="hljs-string">"X-Timestamp: <span class="hljs-variable">$timestamp</span>"</span> \
  -H <span class="hljs-string">"X-Signature: <span class="hljs-variable">$signature</span>"</span>
</code></pre>
<h4 data-id="heading-25">异常场景测试</h4>
<ul>
<li><strong>签名错误</strong>：修改参数但不更新签名</li>
<li><strong>时间戳过期</strong>：使用过期的时间戳</li>
<li><strong>密钥错误</strong>：使用错误的API Key</li>
<li><strong>缺少头信息</strong>：缺少必要的请求头</li>
</ul>
<h2 data-id="heading-26">总结</h2>
<p>通过 Spring Boot 拦截器和 HMAC-SHA256 算法，我们实现了一套完整且实用的 API 签名验证方案。这套机制有效解决了系统间调用的安全问题，而且对现有代码几乎零侵入，直接复用即可。</p>
<p>在实际项目中，你可以根据具体需求调整时间戳容忍度、密钥管理策略等配置，实现灵活的安全控制。</p>
<h2 data-id="heading-27">仓库</h2>
<pre><code class="hljs language-ruby" lang="ruby"><span class="hljs-symbol">https:</span>/<span class="hljs-regexp">/github.com/yuboon</span><span class="hljs-regexp">/java-examples/tree</span><span class="hljs-regexp">/master/springboot</span>-api-signature
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[C#.NET 集合表达式详解：新时代的集合初始化方式]]></title>    <link>https://juejin.cn/post/7575469988736598025</link>    <guid>https://juejin.cn/post/7575469988736598025</guid>    <pubDate>2025-11-23T22:16:23.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7575469988736598025" data-draft-id="7575412016404807690" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="C#.NET 集合表达式详解：新时代的集合初始化方式"/> <meta itemprop="keywords" content="C#,.NET"/> <meta itemprop="datePublished" content="2025-11-23T22:16:23.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="唐青枫"/> <meta itemprop="url" content="https://juejin.cn/user/3737995266234280"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            C#.NET 集合表达式详解：新时代的集合初始化方式
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3737995266234280/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    唐青枫
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-23T22:16:23.000Z" title="Sun Nov 23 2025 22:16:23 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h3 data-id="heading-0">简介</h3>
<p>集合表达式（<code>Collection Expressions</code>）是 <code>C# 12.0</code>（随 <code>.NET 8.0</code> 发布于 2023 年）引入的一项新特性，用于以简洁、声明式的方式创建和初始化集合（如数组、列表、字典等）。集合表达式通过 [...] 语法提供了一种更直观的方式来定义集合，减少样板代码并提高可读性。</p>
<h3 data-id="heading-1">背景和作用</h3>
<p>集合表达式旨在解决传统集合初始化（如 <code>new List&lt;T&gt; { ... }</code> 或 <code>new[] { ... }</code>）的冗长和不一致问题，灵感来源于 <code>Python</code> 和 <code>JavaScript</code> 的列表推导式。它在以下场景中特别有用：</p>
<ul>
<li>
<p>数据初始化：快速定义数组、列表或字典。</p>
</li>
<li>
<p>批量操作：简化 <code>MySqlBulkLoader</code> 的数据表填充。</p>
</li>
<li>
<p><code>API</code> 输入/输出：处理 <code>JSON</code> 数据或响应集合。</p>
</li>
<li>
<p>缓存管理：初始化 <code>MemoryCache</code> 的键值对。</p>
</li>
<li>
<p>定时任务：结合 <code>Cronos</code> 处理批量数据。</p>
</li>
</ul>
<h3 data-id="heading-2">核心概念</h3>
<h4 data-id="heading-3">传统初始化 vs 集合表达式</h4>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-comment">// 传统方式  </span>
List&lt;<span class="hljs-built_in">int</span>&gt; list1 = <span class="hljs-keyword">new</span> List&lt;<span class="hljs-built_in">int</span>&gt; { <span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span> };  
<span class="hljs-built_in">int</span>[] array1 = <span class="hljs-keyword">new</span> <span class="hljs-built_in">int</span>[] { <span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span> };  

<span class="hljs-comment">// C# 12 集合表达式  </span>
List&lt;<span class="hljs-built_in">int</span>&gt; list2 = [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>];  
<span class="hljs-built_in">int</span>[] array2 = [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>];  
Span&lt;<span class="hljs-built_in">int</span>&gt; span = [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>];  
</code></pre>
<h4 data-id="heading-4">语法结构</h4>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-comment">// 基础形式  </span>
[<span class="hljs-meta">element1, element2, ..., elementN</span>]  

<span class="hljs-comment">// 空集合  </span>
<span class="hljs-keyword">var</span> empty = [];  

<span class="hljs-comment">// 嵌套集合  </span>
<span class="hljs-built_in">int</span>[][] matrix = [[<span class="hljs-number">1</span>, <span class="hljs-number">2</span>], [<span class="hljs-number">3</span>, <span class="hljs-number">4</span>], [<span class="hljs-number">5</span>, <span class="hljs-number">6</span>]];  
</code></pre>
<h3 data-id="heading-5">支持的所有集合类型</h3>








































<table><thead><tr><th>集合类型</th><th>示例</th><th>编译器转换机制</th></tr></thead><tbody><tr><td>数组</td><td>int[] arr = [1, 2, 3];</td><td>直接优化为 new int[] { ... }</td></tr><tr><td>List</td><td>List list = [1, 2, 3];</td><td>调用 List.CollectionsMarshalHelper.Create()</td></tr><tr><td>Span</td><td>Span span = [1, 2, 3];</td><td>栈分配或缓冲区重用</td></tr><tr><td>ReadOnlySpan</td><td>ReadOnlySpan ros = ['a','b'];</td><td>同 Span</td></tr><tr><td>ImmutableArray</td><td>ImmutableArray ia = [1,2,3];</td><td>调用 ImmutableArray.Create()</td></tr><tr><td>自定义集合</td><td>实现 IEnumerable + Add 方法</td><td>编译器生成 Add 调用序列</td></tr></tbody></table>
<blockquote>
<p>✅ 所有实现 IEnumerable 且有 Add 方法的类型都支持</p>
</blockquote>
<h3 data-id="heading-6">主要功能</h3>
<h4 data-id="heading-7">简洁语法：</h4>
<ul>
<li>
<p>使用 <code>[...]</code> 替代 <code>new List&lt;T&gt; { ... }</code> 或 <code>new[] { ... }</code>。</p>
</li>
<li>
<p>支持多种集合类型（数组、<code>List&lt;T&gt;</code>、<code>Span&lt;T&gt;</code>、字典等）。</p>
</li>
</ul>
<h4 data-id="heading-8">扩展运算符：</h4>
<ul>
<li>使用 <code>..</code> 展开现有集合（如合并数组或列表）。</li>
</ul>
<h4 data-id="heading-9">类型推断：</h4>
<ul>
<li>自动推断目标集合类型，减少显式类型声明。</li>
</ul>
<h4 data-id="heading-10">多场景支持：</h4>
<ul>
<li>
<p>初始化集合、传递参数、返回结果。</p>
</li>
<li>
<p>支持 <code>LINQ</code>、异步操作和并发场景。</p>
</li>
</ul>
<h4 data-id="heading-11">与现有集合兼容：</h4>
<ul>
<li>无缝转换到 <code>IEnumerable&lt;T&gt;</code>、<code>ICollection&lt;T&gt;</code> 等。</li>
</ul>
<h3 data-id="heading-12">核心语法</h3>
<p>集合表达式使用 <code>[...]</code> 语法，支持以下形式：</p>
<ul>
<li>基本初始化：</li>
</ul>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-built_in">int</span>[] numbers = [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>]; <span class="hljs-comment">// 等价于 new[] { 1, 2, 3 }</span>
List&lt;<span class="hljs-built_in">string</span>&gt; names = [<span class="hljs-string">"Alice"</span>, <span class="hljs-string">"Bob"</span>]; <span class="hljs-comment">// 等价于 new List&lt;string&gt; { "Alice", "Bob" }</span>
</code></pre>
<ul>
<li>扩展运算符（..）：</li>
</ul>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-built_in">int</span>[] moreNumbers = [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, ..numbers, <span class="hljs-number">4</span>]; <span class="hljs-comment">// 展开 numbers，生成 [1, 2, 1, 2, 3, 4]</span>
</code></pre>
<ul>
<li>空集合：</li>
</ul>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-built_in">int</span>[] empty = []; <span class="hljs-comment">// 等价于 Array.Empty&lt;int&gt;()</span>
</code></pre>
<ul>
<li>嵌套集合：</li>
</ul>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-built_in">int</span>[][] jagged = [[<span class="hljs-number">1</span>, <span class="hljs-number">2</span>], [<span class="hljs-number">3</span>, <span class="hljs-number">4</span>]]; <span class="hljs-comment">// 锯齿状数组</span>
</code></pre>
<ul>
<li>字典初始化：</li>
</ul>
<pre><code class="hljs language-csharp" lang="csharp">Dictionary&lt;<span class="hljs-built_in">string</span>, <span class="hljs-built_in">int</span>&gt; scores = [<span class="hljs-string">"Alice"</span>: <span class="hljs-number">90</span>, <span class="hljs-string">"Bob"</span>: <span class="hljs-number">85</span>]; <span class="hljs-comment">// 等价于 new Dictionary&lt;string, int&gt; { ["Alice"] = 90, ["Bob"] = 85 }</span>
</code></pre>
<ul>
<li>
<p>目标类型：</p>
<ul>
<li>
<p>支持 <code>IEnumerable&lt;T&gt;、ICollection&lt;T&gt;、List&lt;T&gt;、数组、Span&lt;T&gt;</code> 等。</p>
</li>
<li>
<p>编译器根据上下文推断类型：</p>
</li>
</ul>
<pre><code class="hljs language-csharp" lang="csharp">IEnumerable&lt;<span class="hljs-built_in">int</span>&gt; enumerable = [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>]; <span class="hljs-comment">// 推断为数组</span>
</code></pre>
</li>
<li>
<p>自定义集合支持</p>
</li>
</ul>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">CustomCollection</span>&lt;<span class="hljs-title">T</span>&gt; : <span class="hljs-title">IEnumerable</span>&lt;<span class="hljs-title">T</span>&gt;  
{  
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> List&lt;T&gt; _items = <span class="hljs-keyword">new</span>();  

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Add</span>(<span class="hljs-params">T item</span>)</span> =&gt; _items.Add(item);  

    <span class="hljs-function"><span class="hljs-keyword">public</span> IEnumerator&lt;T&gt; <span class="hljs-title">GetEnumerator</span>()</span> =&gt; _items.GetEnumerator();  
}  

<span class="hljs-comment">// 使用集合表达式初始化  </span>
CustomCollection&lt;<span class="hljs-built_in">string</span>&gt; tags = [<span class="hljs-string">"dotnet"</span>, <span class="hljs-string">"csharp"</span>];  
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Redis（142）Redis的Cluster的主从复制是如何实现的？]]></title>    <link>https://juejin.cn/post/7575363120799006720</link>    <guid>https://juejin.cn/post/7575363120799006720</guid>    <pubDate>2025-11-23T22:53:17.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7575363120799006720" data-draft-id="7575413146922041359" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Redis（142）Redis的Cluster的主从复制是如何实现的？"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-11-23T22:53:17.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Victor356"/> <meta itemprop="url" content="https://juejin.cn/user/3492507879476878"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Redis（142）Redis的Cluster的主从复制是如何实现的？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3492507879476878/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Victor356
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-23T22:53:17.000Z" title="Sun Nov 23 2025 22:53:17 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>Redis Cluster 的主从复制机制作为其高可用性和数据一致性的关键组件，确保了在主节点发生故障时，系统能够自动切换到从节点以继续提供服务。主从复制的实现包括数据同步、心跳检测、故障检测及自动故障转移等步骤。下面我们详细解析这些步骤，并结合代码示例进行深入探讨。</p>
<h3 data-id="heading-0">1. 主从节点定义</h3>
<p>在 Redis 集群中，每个节点可以是主节点（Master）或从节点（Slave）。从节点实时复制主节点的数据。</p>
<h4 data-id="heading-1">代码示例</h4>
<pre><code class="hljs language-c" lang="c"><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">clusterNode</span> {</span>
    <span class="hljs-type">char</span> name[<span class="hljs-number">40</span>];      <span class="hljs-comment">/* Node ID */</span>
    <span class="hljs-type">int</span> flags;          <span class="hljs-comment">/* Node flags: master, slave, fail, etc. */</span>
    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">clusterNode</span> *<span class="hljs-title">slaveof</span>;</span> <span class="hljs-comment">/* Master of this node if it's a slave */</span>
    <span class="hljs-comment">// other fields...</span>
} clusterNode;

<span class="hljs-meta">#<span class="hljs-keyword">define</span> CLUSTER_NODE_MASTER 0x01</span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> CLUSTER_NODE_SLAVE  0x02</span>
</code></pre>
<h3 data-id="heading-2">2. 数据同步</h3>
<p>当从节点启动或主节点发生变化时，从节点需要与其主节点进行数据同步。数据同步包括全量同步和增量同步。</p>
<h4 data-id="heading-3">代码示例</h4>
<pre><code class="hljs language-c" lang="c"><span class="hljs-comment">/* Function to initiate synchronization with master */</span>
<span class="hljs-type">void</span> <span class="hljs-title function_">syncWithMaster</span><span class="hljs-params">(clusterNode *slave, clusterNode *master)</span> {
    <span class="hljs-comment">// Send SYNC command to master</span>
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"Sending SYNC command to master %s\n"</span>, master-&gt;name);

    <span class="hljs-comment">// In a real implementation, here we would send a SYNC message over the network</span>
    <span class="hljs-comment">// to the master node and wait for its response.</span>
}

<span class="hljs-comment">/* Example usage */</span>
<span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span> {
    clusterNode master = {<span class="hljs-string">"master1"</span>, CLUSTER_NODE_MASTER, <span class="hljs-literal">NULL</span>};
    clusterNode slave = {<span class="hljs-string">"slave1"</span>, CLUSTER_NODE_SLAVE, &amp;master};

    syncWithMaster(&amp;slave, &amp;master);

    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}
</code></pre>
<h3 data-id="heading-4">3. 心跳检测</h3>
<p>主从节点之间会定期发送心跳消息，以确保节点之间的连接是活跃的，并且从节点可以及时知道主节点的状态。</p>
<h4 data-id="heading-5">代码示例</h4>
<pre><code class="hljs language-c" lang="c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;time.h&gt;</span></span>

<span class="hljs-meta">#<span class="hljs-keyword">define</span> HEARTBEAT_INTERVAL 1000  <span class="hljs-comment">// 1 second</span></span>

<span class="hljs-comment">/* Function to send heartbeat message */</span>
<span class="hljs-type">void</span> <span class="hljs-title function_">sendHeartbeat</span><span class="hljs-params">(clusterNode *node)</span> {
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"Sending heartbeat to node %s\n"</span>, node-&gt;name);
    <span class="hljs-comment">// In a real implementation, here we would send a PING message over the network.</span>
}

<span class="hljs-comment">/* Function to check for node failures based on heartbeat */</span>
<span class="hljs-type">void</span> <span class="hljs-title function_">checkHeartbeat</span><span class="hljs-params">(clusterNode *node)</span> {
    <span class="hljs-type">time_t</span> now = time(<span class="hljs-literal">NULL</span>);
    <span class="hljs-keyword">if</span> (now - node-&gt;last_heartbeat &gt; HEARTBEAT_INTERVAL) {
        <span class="hljs-built_in">printf</span>(<span class="hljs-string">"Node %s is not responding\n"</span>, node-&gt;name);
        <span class="hljs-comment">// Mark node as failed</span>
        node-&gt;flags |= CLUSTER_NODE_FAIL;
    }
}

<span class="hljs-comment">/* Example usage */</span>
<span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span> {
    clusterNode master = {<span class="hljs-string">"master1"</span>, CLUSTER_NODE_MASTER, <span class="hljs-literal">NULL</span>};
    master.last_heartbeat = time(<span class="hljs-literal">NULL</span>) - <span class="hljs-number">2</span>;  <span class="hljs-comment">// Simulate a delay in heartbeat</span>

    sendHeartbeat(&amp;master);
    checkHeartbeat(&amp;master);

    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}
</code></pre>
<h3 data-id="heading-6">4. 故障检测与故障转移</h3>
<p>当主节点被检测到故障时，从节点会自动接管主节点的角色。这包括选举新的主节点和更新集群状态。</p>
<h4 data-id="heading-7">代码示例</h4>
<pre><code class="hljs language-c" lang="c"><span class="hljs-comment">/* Function to handle failover */</span>
<span class="hljs-type">void</span> <span class="hljs-title function_">handleFailover</span><span class="hljs-params">(clusterNode *slave)</span> {
    <span class="hljs-keyword">if</span> (!(slave-&gt;flags &amp; CLUSTER_NODE_SLAVE)) <span class="hljs-keyword">return</span>;

    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"Failover initiated by slave %s\n"</span>, slave-&gt;name);

    <span class="hljs-comment">// Promote the slave to master</span>
    slave-&gt;flags &amp;= ~CLUSTER_NODE_SLAVE;
    slave-&gt;flags |= CLUSTER_NODE_MASTER;

    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"Slave %s promoted to master\n"</span>, slave-&gt;name);

    <span class="hljs-comment">// In a real implementation, we would also update the cluster state and notify other nodes.</span>
}

<span class="hljs-comment">/* Example usage */</span>
<span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span> {
    clusterNode master = {<span class="hljs-string">"master1"</span>, CLUSTER_NODE_MASTER, <span class="hljs-literal">NULL</span>};
    clusterNode slave = {<span class="hljs-string">"slave1"</span>, CLUSTER_NODE_SLAVE, &amp;master};

    <span class="hljs-comment">// Simulate master failure</span>
    master.flags |= CLUSTER_NODE_FAIL;

    <span class="hljs-keyword">if</span> (master.flags &amp; CLUSTER_NODE_FAIL) {
        handleFailover(&amp;slave);
    }

    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}
</code></pre>
<h3 data-id="heading-8">综合示例</h3>
<p>以下是一个综合示例，展示了如何定义主从节点、进行数据同步、发送心跳检测以及处理故障转移。</p>
<h4 data-id="heading-9">综合代码示例</h4>
<pre><code class="hljs language-c" lang="c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdint.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;time.h&gt;</span></span>

<span class="hljs-meta">#<span class="hljs-keyword">define</span> CLUSTER_NODE_MASTER 0x01</span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> CLUSTER_NODE_SLAVE  0x02</span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> CLUSTER_NODE_FAIL   0x04</span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> HEARTBEAT_INTERVAL  1000  <span class="hljs-comment">// 1 second</span></span>

<span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">clusterNode</span> {</span>
    <span class="hljs-type">char</span> name[<span class="hljs-number">40</span>];      <span class="hljs-comment">/* Node ID */</span>
    <span class="hljs-type">int</span> flags;          <span class="hljs-comment">/* Node flags: master, slave, fail, etc. */</span>
    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">clusterNode</span> *<span class="hljs-title">slaveof</span>;</span> <span class="hljs-comment">/* Master of this node if it's a slave */</span>
    <span class="hljs-type">time_t</span> last_heartbeat; <span class="hljs-comment">/* Last time a heartbeat was received */</span>
} clusterNode;

<span class="hljs-comment">/* Function to initiate synchronization with master */</span>
<span class="hljs-type">void</span> <span class="hljs-title function_">syncWithMaster</span><span class="hljs-params">(clusterNode *slave, clusterNode *master)</span> {
    <span class="hljs-comment">// Send SYNC command to master</span>
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"Sending SYNC command to master %s\n"</span>, master-&gt;name);

    <span class="hljs-comment">// In a real implementation, here we would send a SYNC message over the network</span>
    <span class="hljs-comment">// to the master node and wait for its response.</span>
}

<span class="hljs-comment">/* Function to send heartbeat message */</span>
<span class="hljs-type">void</span> <span class="hljs-title function_">sendHeartbeat</span><span class="hljs-params">(clusterNode *node)</span> {
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"Sending heartbeat to node %s\n"</span>, node-&gt;name);
    <span class="hljs-comment">// In a real implementation, here we would send a PING message over the network.</span>
    node-&gt;last_heartbeat = time(<span class="hljs-literal">NULL</span>);
}

<span class="hljs-comment">/* Function to check for node failures based on heartbeat */</span>
<span class="hljs-type">void</span> <span class="hljs-title function_">checkHeartbeat</span><span class="hljs-params">(clusterNode *node)</span> {
    <span class="hljs-type">time_t</span> now = time(<span class="hljs-literal">NULL</span>);
    <span class="hljs-keyword">if</span> (now - node-&gt;last_heartbeat &gt; HEARTBEAT_INTERVAL) {
        <span class="hljs-built_in">printf</span>(<span class="hljs-string">"Node %s is not responding\n"</span>, node-&gt;name);
        <span class="hljs-comment">// Mark node as failed</span>
        node-&gt;flags |= CLUSTER_NODE_FAIL;
    }
}

<span class="hljs-comment">/* Function to handle failover */</span>
<span class="hljs-type">void</span> <span class="hljs-title function_">handleFailover</span><span class="hljs-params">(clusterNode *slave)</span> {
    <span class="hljs-keyword">if</span> (!(slave-&gt;flags &amp; CLUSTER_NODE_SLAVE)) <span class="hljs-keyword">return</span>;

    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"Failover initiated by slave %s\n"</span>, slave-&gt;name);

    <span class="hljs-comment">// Promote the slave to master</span>
    slave-&gt;flags &amp;= ~CLUSTER_NODE_SLAVE;
    slave-&gt;flags |= CLUSTER_NODE_MASTER;

    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"Slave %s promoted to master\n"</span>, slave-&gt;name);

    <span class="hljs-comment">// In a real implementation, we would also update the cluster state and notify other nodes.</span>
}

<span class="hljs-comment">/* Example usage */</span>
<span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span> {
    clusterNode master = {<span class="hljs-string">"master1"</span>, CLUSTER_NODE_MASTER, <span class="hljs-literal">NULL</span>, time(<span class="hljs-literal">NULL</span>)};
    clusterNode slave = {<span class="hljs-string">"slave1"</span>, CLUSTER_NODE_SLAVE, &amp;master, time(<span class="hljs-literal">NULL</span>)};

    <span class="hljs-comment">// Initial synchronization</span>
    syncWithMaster(&amp;slave, &amp;master);

    <span class="hljs-comment">// Periodically send heartbeat</span>
    sendHeartbeat(&amp;master);

    <span class="hljs-comment">// Simulate master failure</span>
    master.flags |= CLUSTER_NODE_FAIL;
    master.last_heartbeat = time(<span class="hljs-literal">NULL</span>) - <span class="hljs-number">2</span>;  <span class="hljs-comment">// Simulate a delay in heartbeat</span>

    <span class="hljs-comment">// Check heartbeat and handle failover if necessary</span>
    checkHeartbeat(&amp;master);
    <span class="hljs-keyword">if</span> (master.flags &amp; CLUSTER_NODE_FAIL) {
        handleFailover(&amp;slave);
    }

    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}
</code></pre>
<p>这个综合示例展示了 Redis Cluster 主从复制的主要组件和流程：数据同步、心跳检测和故障转移。实际的 Redis 实现会更加复杂，包括网络通信、数据一致性保证以及更多的状态管理，以上示例为简化版，用于解释基本原理。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Redis（143）Redis的Cluster的重新分片是如何实现的？]]></title>    <link>https://juejin.cn/post/7575112613778735138</link>    <guid>https://juejin.cn/post/7575112613778735138</guid>    <pubDate>2025-11-23T22:54:01.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7575112613778735138" data-draft-id="7575112613778718754" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Redis（143）Redis的Cluster的重新分片是如何实现的？"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-11-23T22:54:01.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Victor356"/> <meta itemprop="url" content="https://juejin.cn/user/3492507879476878"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Redis（143）Redis的Cluster的重新分片是如何实现的？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3492507879476878/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Victor356
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-23T22:54:01.000Z" title="Sun Nov 23 2025 22:54:01 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>Redis Cluster 的重新分片（resharding）是指在集群中将哈希槽从一个节点迁移到另一个节点，以实现负载均衡或其他维护操作。重新分片的过程包括选择要迁移的槽、将槽的数据从源节点迁移到目标节点、更新集群状态等步骤。</p>
<h3 data-id="heading-0">重新分片的关键步骤</h3>
<ol>
<li><strong>选择要迁移的槽</strong>：决定哪些槽需要从源节点迁移到目标节点。</li>
<li><strong>迁移槽的数据</strong>：将槽的数据从源节点迁移到目标节点。</li>
<li><strong>更新集群状态</strong>：更新集群元数据，使其他节点知道槽的位置变化。</li>
</ol>
<h3 data-id="heading-1">详细实现步骤和代码示例</h3>
<h4 data-id="heading-2">1. 选择要迁移的槽</h4>
<p>首先，我们需要确定哪些槽需要迁移。这可以根据负载情况、节点容量等条件来决定。</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span>

<span class="hljs-meta">#<span class="hljs-keyword">define</span> HASH_SLOTS 16384</span>

<span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">clusterNode</span> {</span>
    <span class="hljs-type">char</span> name[<span class="hljs-number">40</span>];      <span class="hljs-comment">/* Node ID */</span>
    <span class="hljs-type">int</span> start_slot;     <span class="hljs-comment">/* Start hash slot */</span>
    <span class="hljs-type">int</span> end_slot;       <span class="hljs-comment">/* End hash slot */</span>
} clusterNode;

<span class="hljs-comment">/* Function to determine which slots to migrate */</span>
<span class="hljs-type">void</span> <span class="hljs-title function_">selectSlotsToMigrate</span><span class="hljs-params">(clusterNode *src, <span class="hljs-type">int</span> *slots_to_migrate, <span class="hljs-type">int</span> num_slots)</span> {
    <span class="hljs-type">int</span> index = <span class="hljs-number">0</span>;
    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = src-&gt;start_slot; i &lt;= src-&gt;end_slot &amp;&amp; index &lt; num_slots; i++) {
        slots_to_migrate[index++] = i;
    }
}

<span class="hljs-comment">/* Example usage */</span>
<span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span> {
    clusterNode src = {<span class="hljs-string">"source_node"</span>, <span class="hljs-number">0</span>, <span class="hljs-number">5460</span>};
    <span class="hljs-type">int</span> slots_to_migrate[<span class="hljs-number">10</span>];
    selectSlotsToMigrate(&amp;src, slots_to_migrate, <span class="hljs-number">10</span>);

    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"Slots to migrate: "</span>);
    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10</span>; i++) {
        <span class="hljs-built_in">printf</span>(<span class="hljs-string">"%d "</span>, slots_to_migrate[i]);
    }
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"\n"</span>);

    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}
</code></pre>
<h4 data-id="heading-3">2. 迁移槽的数据</h4>
<p>迁移槽的数据涉及将槽中的键值对从源节点发送到目标节点。这需要通过网络通信来实现。</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span>

<span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">clusterNode</span> {</span>
    <span class="hljs-type">char</span> name[<span class="hljs-number">40</span>];      <span class="hljs-comment">/* Node ID */</span>
    <span class="hljs-type">int</span> start_slot;     <span class="hljs-comment">/* Start hash slot */</span>
    <span class="hljs-type">int</span> end_slot;       <span class="hljs-comment">/* End hash slot */</span>
} clusterNode;

<span class="hljs-comment">/* Function to migrate a single slot's data */</span>
<span class="hljs-type">void</span> <span class="hljs-title function_">migrateSlotData</span><span class="hljs-params">(clusterNode *src, clusterNode *dst, <span class="hljs-type">int</span> slot)</span> {
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"Migrating data for slot %d from node %s to node %s\n"</span>, slot, src-&gt;name, dst-&gt;name);
    <span class="hljs-comment">// In a real implementation, here you would send the data over the network from src to dst.</span>
}

<span class="hljs-comment">/* Example usage */</span>
<span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span> {
    clusterNode src = {<span class="hljs-string">"source_node"</span>, <span class="hljs-number">0</span>, <span class="hljs-number">5460</span>};
    clusterNode dst = {<span class="hljs-string">"destination_node"</span>, <span class="hljs-number">5461</span>, <span class="hljs-number">10921</span>};

    <span class="hljs-type">int</span> slots_to_migrate[<span class="hljs-number">10</span>] = {<span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>, <span class="hljs-number">6</span>, <span class="hljs-number">7</span>, <span class="hljs-number">8</span>, <span class="hljs-number">9</span>};
    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10</span>; i++) {
        migrateSlotData(&amp;src, &amp;dst, slots_to_migrate[i]);
    }

    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}
</code></pre>
<h4 data-id="heading-4">3. 更新集群状态</h4>
<p>一旦数据迁移完成，需要更新集群的元数据，使集群内的所有节点都知道槽的新位置。</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span>

<span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">clusterNode</span> {</span>
    <span class="hljs-type">char</span> name[<span class="hljs-number">40</span>];      <span class="hljs-comment">/* Node ID */</span>
    <span class="hljs-type">int</span> start_slot;     <span class="hljs-comment">/* Start hash slot */</span>
    <span class="hljs-type">int</span> end_slot;       <span class="hljs-comment">/* End hash slot */</span>
} clusterNode;

<span class="hljs-comment">/* Function to update cluster state */</span>
<span class="hljs-type">void</span> <span class="hljs-title function_">updateClusterState</span><span class="hljs-params">(clusterNode *src, clusterNode *dst, <span class="hljs-type">int</span> *slots_to_migrate, <span class="hljs-type">int</span> num_slots)</span> {
    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; num_slots; i++) {
        <span class="hljs-type">int</span> slot = slots_to_migrate[i];
        <span class="hljs-keyword">if</span> (slot &gt;= src-&gt;start_slot &amp;&amp; slot &lt;= src-&gt;end_slot) {
            <span class="hljs-built_in">printf</span>(<span class="hljs-string">"Updating cluster state for slot %d: from node %s to node %s\n"</span>, slot, src-&gt;name, dst-&gt;name);
            <span class="hljs-comment">// Update the slot range in the source and destination nodes</span>
            <span class="hljs-keyword">if</span> (slot == src-&gt;start_slot) {
                src-&gt;start_slot++;
            } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (slot == src-&gt;end_slot) {
                src-&gt;end_slot--;
            }
            <span class="hljs-comment">// Update destination node's slot range</span>
            <span class="hljs-keyword">if</span> (dst-&gt;start_slot == <span class="hljs-number">-1</span> &amp;&amp; dst-&gt;end_slot == <span class="hljs-number">-1</span>) {
                dst-&gt;start_slot = slot;
                dst-&gt;end_slot = slot;
            } <span class="hljs-keyword">else</span> {
                <span class="hljs-keyword">if</span> (slot &lt; dst-&gt;start_slot) {
                    dst-&gt;start_slot = slot;
                }
                <span class="hljs-keyword">if</span> (slot &gt; dst-&gt;end_slot) {
                    dst-&gt;end_slot = slot;
                }
            }
        }
    }
}

<span class="hljs-comment">/* Example usage */</span>
<span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span> {
    clusterNode src = {<span class="hljs-string">"source_node"</span>, <span class="hljs-number">0</span>, <span class="hljs-number">5460</span>};
    clusterNode dst = {<span class="hljs-string">"destination_node"</span>, <span class="hljs-number">5461</span>, <span class="hljs-number">10921</span>};

    <span class="hljs-type">int</span> slots_to_migrate[<span class="hljs-number">10</span>] = {<span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>, <span class="hljs-number">6</span>, <span class="hljs-number">7</span>, <span class="hljs-number">8</span>, <span class="hljs-number">9</span>};
    updateClusterState(&amp;src, &amp;dst, slots_to_migrate, <span class="hljs-number">10</span>);

    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"Source node %s: slots %d - %d\n"</span>, src.name, src.start_slot, src.end_slot);
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"Destination node %s: slots %d - %d\n"</span>, dst.name, dst.start_slot, dst.end_slot);

    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}
</code></pre>
<h3 data-id="heading-5">综合示例</h3>
<p>以下是一个完整的示例，展示了如何选择要迁移的槽、迁移槽的数据以及更新集群状态。</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span>

<span class="hljs-meta">#<span class="hljs-keyword">define</span> HASH_SLOTS 16384</span>

<span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">clusterNode</span> {</span>
    <span class="hljs-type">char</span> name[<span class="hljs-number">40</span>];      <span class="hljs-comment">/* Node ID */</span>
    <span class="hljs-type">int</span> start_slot;     <span class="hljs-comment">/* Start hash slot */</span>
    <span class="hljs-type">int</span> end_slot;       <span class="hljs-comment">/* End hash slot */</span>
} clusterNode;

<span class="hljs-comment">/* Function to determine which slots to migrate */</span>
<span class="hljs-type">void</span> <span class="hljs-title function_">selectSlotsToMigrate</span><span class="hljs-params">(clusterNode *src, <span class="hljs-type">int</span> *slots_to_migrate, <span class="hljs-type">int</span> num_slots)</span> {
    <span class="hljs-type">int</span> index = <span class="hljs-number">0</span>;
    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = src-&gt;start_slot; i &lt;= src-&gt;end_slot &amp;&amp; index &lt; num_slots; i++) {
        slots_to_migrate[index++] = i;
    }
}

<span class="hljs-comment">/* Function to migrate a single slot's data */</span>
<span class="hljs-type">void</span> <span class="hljs-title function_">migrateSlotData</span><span class="hljs-params">(clusterNode *src, clusterNode *dst, <span class="hljs-type">int</span> slot)</span> {
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"Migrating data for slot %d from node %s to node %s\n"</span>, slot, src-&gt;name, dst-&gt;name);
    <span class="hljs-comment">// In a real implementation, here you would send the data over the network from src to dst.</span>
}

<span class="hljs-comment">/* Function to update cluster state */</span>
<span class="hljs-type">void</span> <span class="hljs-title function_">updateClusterState</span><span class="hljs-params">(clusterNode *src, clusterNode *dst, <span class="hljs-type">int</span> *slots_to_migrate, <span class="hljs-type">int</span> num_slots)</span> {
    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; num_slots; i++) {
        <span class="hljs-type">int</span> slot = slots_to_migrate[i];
        <span class="hljs-keyword">if</span> (slot &gt;= src-&gt;start_slot &amp;&amp; slot &lt;= src-&gt;end_slot) {
            <span class="hljs-built_in">printf</span>(<span class="hljs-string">"Updating cluster state for slot %d: from node %s to node %s\n"</span>, slot, src-&gt;name, dst-&gt;name);
            <span class="hljs-comment">// Update the slot range in the source and destination nodes</span>
            <span class="hljs-keyword">if</span> (slot == src-&gt;start_slot) {
                src-&gt;start_slot++;
            } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (slot == src-&gt;end_slot) {
                src-&gt;end_slot--;
            }
            <span class="hljs-comment">// Update destination node's slot range</span>
            <span class="hljs-keyword">if</span> (dst-&gt;start_slot == <span class="hljs-number">-1</span> &amp;&amp; dst-&gt;end_slot == <span class="hljs-number">-1</span>) {
                dst-&gt;start_slot = slot;
                dst-&gt;end_slot = slot;
            } <span class="hljs-keyword">else</span> {
                <span class="hljs-keyword">if</span> (slot &lt; dst-&gt;start_slot) {
                    dst-&gt;start_slot = slot;
                }
                <span class="hljs-keyword">if</span> (slot &gt; dst-&gt;end_slot) {
                    dst-&gt;end_slot = slot;
                }
            }
        }
    }
}

<span class="hljs-comment">/* Example usage */</span>
<span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span> {
    clusterNode src = {<span class="hljs-string">"source_node"</span>, <span class="hljs-number">0</span>, <span class="hljs-number">5460</span>};
    clusterNode dst = {<span class="hljs-string">"destination_node"</span>, <span class="hljs-number">5461</span>, <span class="hljs-number">10921</span>};

    <span class="hljs-type">int</span> slots_to_migrate[<span class="hljs-number">10</span>];
    selectSlotsToMigrate(&amp;src, slots_to_migrate, <span class="hljs-number">10</span>);

    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10</span>; i++) {
        migrateSlotData(&amp;src, &amp;dst, slots_to_migrate[i]);
    }

    updateClusterState(&amp;src, &amp;dst, slots_to_migrate, <span class="hljs-number">10</span>);

    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"Source node %s: slots %d - %d\n"</span>, src.name, src.start_slot, src.end_slot);
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"Destination node %s: slots %d - %d\n"</span>, dst.name, dst.start_slot, dst.end_slot);

    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}
</code></pre>
<p>这个完整的示例展示了 Redis Cluster 重新分片的基本流程，包括选择迁移的槽、迁移槽的数据以及更新集群状态。在实际的 Redis 实现中，这些操作会涉及网络通信和更多的错误处理逻辑，以确保数据的一致性和可靠性。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[【HarmonyOS 6】在UI控件上滑动也会触发onClick点击事件？]]></title>    <link>https://juejin.cn/post/7575413146921811983</link>    <guid>https://juejin.cn/post/7575413146921811983</guid>    <pubDate>2025-11-23T16:11:56.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7575413146921811983" data-draft-id="7575363120798892032" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="【HarmonyOS 6】在UI控件上滑动也会触发onClick点击事件？"/> <meta itemprop="keywords" content="HarmonyOS"/> <meta itemprop="datePublished" content="2025-11-23T16:11:56.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="GeorgePanda"/> <meta itemprop="url" content="https://juejin.cn/user/1239904847930654"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            【HarmonyOS 6】在UI控件上滑动也会触发onClick点击事件？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1239904847930654/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    GeorgePanda
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-23T16:11:56.000Z" title="Sun Nov 23 2025 16:11:56 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">【HarmonyOS 6】在UI控件上滑动也会触发onClick点击事件？</h2>
<h2 data-id="heading-1">一、问题背景</h2>
<p>最近忙了几个月的HarmonyOS 6 AI项目已提测。测试老铁们和领导们疯狂的使用，提出了很多奇奇怪怪的问题。</p>
<p>如题所述，项目中有个全屏提示遮罩，背景设置了点击事件。点击后隐藏遮罩。
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f7c94c7b78c04ced9b4fb31d083abc54~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgR2VvcmdlUGFuZGE=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764519115&amp;x-signature=o6nKU%2BF%2BaOXwNW0yfbI%2BfsbXemk%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p>测试代码如下：</p>
<pre><code class="hljs language-typescript" lang="typescript">
<span class="hljs-comment">/**
 * 点击测试页面
 */</span>
<span class="hljs-meta">@Entry</span>
<span class="hljs-meta">@Component</span>
struct <span class="hljs-title class_">ClickTestPage</span> {

  <span class="hljs-title function_">build</span>(<span class="hljs-params"/>) {
    <span class="hljs-title class_">Column</span>() {
      <span class="hljs-title class_">Text</span>(<span class="hljs-string">"提示文本123456"</span>)
        .<span class="hljs-title function_">fontSize</span>($r(<span class="hljs-string">'app.float.page_text_font_size'</span>))
        .<span class="hljs-title function_">fontWeight</span>(<span class="hljs-title class_">FontWeight</span>.<span class="hljs-property">Bold</span>)
    }
    .<span class="hljs-title function_">height</span>(<span class="hljs-string">'100%'</span>)
    .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)
    .<span class="hljs-title function_">justifyContent</span>(<span class="hljs-title class_">FlexAlign</span>.<span class="hljs-property">Center</span>)
    .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {
      <span class="hljs-comment">// 触发点击</span>
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getUIContext</span>().<span class="hljs-title function_">getPromptAction</span>().<span class="hljs-title function_">showToast</span>({
        <span class="hljs-attr">message</span>: <span class="hljs-string">"点击了！"</span>
      })
    })
    .<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-title class_">Color</span>.<span class="hljs-property">Red</span>)
  }
}
</code></pre>
<p>领导们体验时发现，在UI控件上滑动也会触发onClick点击事件，关闭提示遮罩。</p>
<p>按照我的定位思路，因为只有onclick触发了隐藏操作，所以加了日志去复现，发现果然如此。就把bug划分到非问题栏里了。</p>
<p>后来项目内技术大佬发现，该问题可解，由此产生本文解答。</p>
<p>自我检讨，对于问题的敏感性和探索性有所降低，需要警惕！</p>
<h2 data-id="heading-2">二、解决方案：</h2>
<p>因为onClick点击事件是组件被点击时触发的事件，因此滑动后抬起手指也会触发onClick事件。</p>
<p>不过从API12，新增distanceThreshold参数，设置点击手势移动阈值。手指移动超出阈值时，点击手势识别失败。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/83fc50be8d2c4c659d99ba11357967c0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgR2VvcmdlUGFuZGE=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764519115&amp;x-signature=2ZUK8IKAGKAC6bQklGHnM8Bh8x0%3D" alt="在这里插入图片描述" loading="lazy"/>
<strong>比起传统onclick事件，多了一个参数，可以设置移动阈值distanceThreshold。</strong></p>
<p>当点击事件，设置了移动阈值distanceThreshold。当设置的值小于等于0时，会被转化为默认值。默认值：2^31-1，单位：vp。</p>
<p>当手指的移动距离超出开发者预设的移动阈值时，点击识别失败。如果初始化为默认阈值时，手指移动超过组件热区范围，点击识别失败。</p>
<p>话说API12版本还是太权威了，去年居然没有注意到这些细节！！！</p>
<p>所以该问题如下修改测试代码即可:</p>
<pre><code class="hljs language-typescript" lang="typescript">
<span class="hljs-comment">/**
 * 点击测试页面
 */</span>
<span class="hljs-meta">@Entry</span>
<span class="hljs-meta">@Component</span>
struct <span class="hljs-title class_">ClickTestPage</span> {

  <span class="hljs-title function_">build</span>(<span class="hljs-params"/>) {
    <span class="hljs-title class_">Column</span>() {
      <span class="hljs-title class_">Text</span>(<span class="hljs-string">"提示文本123456"</span>)
        .<span class="hljs-title function_">fontSize</span>($r(<span class="hljs-string">'app.float.page_text_font_size'</span>))
        .<span class="hljs-title function_">fontWeight</span>(<span class="hljs-title class_">FontWeight</span>.<span class="hljs-property">Bold</span>)
    }
    .<span class="hljs-title function_">height</span>(<span class="hljs-string">'100%'</span>)
    .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)
    .<span class="hljs-title function_">justifyContent</span>(<span class="hljs-title class_">FlexAlign</span>.<span class="hljs-property">Center</span>)
    .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {
      <span class="hljs-comment">// 触发点击</span>
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getUIContext</span>().<span class="hljs-title function_">getPromptAction</span>().<span class="hljs-title function_">showToast</span>({
        <span class="hljs-attr">message</span>: <span class="hljs-string">"点击了！"</span>
      })
      <span class="hljs-comment">// 设置移动阈值distanceThreshol为1</span>
    },<span class="hljs-number">1</span>)
    .<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-title class_">Color</span>.<span class="hljs-property">Red</span>)
  }
}
</code></pre>
<p>onClick事件中增加distanceThreshold参数，将阈值设置为一个极小值1，当手指的移动距离超出预设的移动阈值时，点击识别失败，即不触发点击事件。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[C#/.NET/.NET Core技术前沿周刊 | 第 62 期（2025年11.17-11.23）]]></title>    <link>https://juejin.cn/post/7575468252656549929</link>    <guid>https://juejin.cn/post/7575468252656549929</guid>    <pubDate>2025-11-23T16:57:24.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7575468252656549929" data-draft-id="7575458028255199275" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="C#/.NET/.NET Core技术前沿周刊 | 第 62 期（2025年11.17-11.23）"/> <meta itemprop="keywords" content="后端,.NET"/> <meta itemprop="datePublished" content="2025-11-23T16:57:24.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="追逐时光者"/> <meta itemprop="url" content="https://juejin.cn/user/2770425031690333"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            C#/.NET/.NET Core技术前沿周刊 | 第 62 期（2025年11.17-11.23）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2770425031690333/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    追逐时光者
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-23T16:57:24.000Z" title="Sun Nov 23 2025 16:57:24 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d5b85cb096624ab891f08bf1747d1407~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L-96YCQ5pe25YWJ6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764521844&amp;x-signature=Zr%2FruMjduUBAWpR1QmVYIpGikjI%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-0">前言</h2>
<p>C#/.NET/.NET Core技术前沿周刊，你的每周技术指南针！记录、追踪C#/.NET/.NET Core领域、生态的每周最新、最实用、最有价值的技术文章、社区动态、优质项目和学习资源等。让你时刻站在技术前沿，助力技术成长与视野拓宽。</p>
<blockquote>
<p>欢迎投稿、推荐或自荐优质文章、项目、学习资源等。</p>
</blockquote>
<ul>
<li><strong>🏆技术前沿周刊Gitee开源地址：</strong> <a href="https://link.juejin.cn?target=https%3A%2F%2Fgitee.com%2Fysgdaydayup%2FDotNetGuide%2Fblob%2Fmain%2Fdocs%2FDotNet%2FDotNetWeekly.md" target="_blank" title="https://gitee.com/ysgdaydayup/DotNetGuide/blob/main/docs/DotNet/DotNetWeekly.md" ref="nofollow noopener noreferrer">gitee.com/ysgdaydayup…</a></li>
<li><strong>📰技术前沿周刊GitHub开源地址：</strong> <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FYSGStudyHards%2FDotNetGuide%2Fblob%2Fmain%2Fdocs%2FDotNet%2FDotNetWeekly.md" target="_blank" title="https://github.com/YSGStudyHards/DotNetGuide/blob/main/docs/DotNet/DotNetWeekly.md" ref="nofollow noopener noreferrer">github.com/YSGStudyHar…</a></li>
<li><strong>👪DotNetGuide技术社区：</strong> <a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2Frq-_dMpdLltPxvOdihl0UA" target="_blank" title="https://mp.weixin.qq.com/s/rq-_dMpdLltPxvOdihl0UA" ref="nofollow noopener noreferrer">mp.weixin.qq.com/s/rq-_dMpdL…</a></li>
</ul>
<h2 data-id="heading-1">更多议题来袭｜.NET Conf China 2025 大会日程即将公布！</h2>
<ul>
<li><strong>文章简介：</strong> 改变世界，改变自己——第七届 .NET 中国峰会 .NET Conf China 2025 将于 11月30日 在上海举办。本次大会将聚焦性能跃升、AI 融合、跨平台开发三大核心方向，为开发者提供实战洞见与未来视野，推动开源技术和社区协作的发展。通过一系列精彩的主题演讲、技术分享，我们希望与与会者共同探讨如何在现代开发中充分利用 .NET 的强大功能，提升开发效率与应用性能。</li>
<li><strong>文章地址：</strong> <a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FznvU3Sxq-lfL_uL9U9f5SQ" target="_blank" title="https://mp.weixin.qq.com/s/znvU3Sxq-lfL_uL9U9f5SQ" ref="nofollow noopener noreferrer">mp.weixin.qq.com/s/znvU3Sxq-…</a></li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5e4e978482684bb48b9a26de548e99a5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L-96YCQ5pe25YWJ6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764521844&amp;x-signature=LuPYe5Xi46tTuCtKb9IRaAVmLbA%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-2">深圳 .NET 初中高级岗位内推</h2>
<ul>
<li><strong>文章简介：</strong> C#/.NET/.NET Core开发者人才招聘专栏，本专栏致力于汇聚最新的C#/.NET/.NET Core相关岗位招聘信息，为C#/.NET/.NET Core技术爱好者、开发者及企业搭建一个高效、精准的招聘与求职平台。我们深知，在快速发展的技术领域中，优秀的人才是企业最宝贵的资源。因此，我们精心筛选并展示来自各行各业的C#/.NET/.NET Core岗位，旨在帮助求职者找到最适合自己的发展机会，同时助力企业吸引并留住顶尖技术人才。</li>
<li><strong>文章地址：</strong> <a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2Fe-4pYf7J6O9iMZhAR4fHcQ" target="_blank" title="https://mp.weixin.qq.com/s/e-4pYf7J6O9iMZhAR4fHcQ" ref="nofollow noopener noreferrer">mp.weixin.qq.com/s/e-4pYf7J6…</a></li>
</ul>
<h2 data-id="heading-3">快速构建一个基础、现代化的 WinForm 管理系统！</h2>
<ul>
<li><strong>文章简介：</strong> 前段时间有小伙伴在后台留言问：有没有好用的 WinForm 管理系统?今天大姚给大家分享一个基于 AntdUI 构建的 WinForm 管理系统，不需要我们写一行代码既能快速构建一个基础、现代化的 WinForm 管理系统。</li>
<li><strong>文章地址：</strong> <a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FVTBcoZZ2mNyuyV_s4fzsPA" target="_blank" title="https://mp.weixin.qq.com/s/VTBcoZZ2mNyuyV_s4fzsPA" ref="nofollow noopener noreferrer">mp.weixin.qq.com/s/VTBcoZZ2m…</a></li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/06fdf61928b742c9918c384554f03869~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L-96YCQ5pe25YWJ6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764521844&amp;x-signature=CwV41%2BGlSW%2B1H%2B1GuJBn8zIub90%3D" alt="" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6d0b54661bc34e58a09897cd3fbbe6d5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L-96YCQ5pe25YWJ6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764521844&amp;x-signature=KYaR2%2BHCS2PWZSrihPu9S3n0ITM%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-4">用 GitHub Copilot Testing for .NET 提升你的测试覆盖率</h2>
<ul>
<li><strong>文章简介：</strong> 今天我们很高兴地宣布，GitHub Copilot 的 .NET 测试现已在 Visual Studio Insiders 中提供。这一新功能将 AI 驱动的单元测试生成直接带入你的开发流程，帮助你在几次点击内从零覆盖到测试信心。</li>
<li><strong>文章地址：</strong> <a href="https://link.juejin.cn?target=https%3A%2F%2Fdevblogs.microsoft.com%2Fdotnet%2Fgithub-copilot-testing-for-dotnet%2F" target="_blank" title="https://devblogs.microsoft.com/dotnet/github-copilot-testing-for-dotnet/" ref="nofollow noopener noreferrer">devblogs.microsoft.com/dotnet/gith…</a></li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/426fb5b25f994778823d7fc1ba6b1cef~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L-96YCQ5pe25YWJ6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764521844&amp;x-signature=9ddR5LZbPhkCq4lMoFewM8Y3F8g%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-5">再次重塑 .NET 的构建和发布方式</h2>
<ul>
<li><strong>文章简介：</strong> 在我写完上一篇关于.NET 如何构建和发布的文章后，我谨慎乐观地认为自己不会再写一篇。或者至少不会再写一篇关于我们如何建造和运输的文章。这个问题已经解决了。.NET 做到了！我们在分布式仓库开发和快速编写产品以便发货之间取得了平衡。恭喜大家，现在基础设施团队可以专注于其他事情了。安全性、跨公司标准化、支持构建新功能。所有的好东西。</li>
<li><strong>文章地址：</strong> <a href="https://link.juejin.cn?target=https%3A%2F%2Fdevblogs.microsoft.com%2Fdotnet%2Freinventing-how-dotnet-builds-and-ships-again%2F" target="_blank" title="https://devblogs.microsoft.com/dotnet/reinventing-how-dotnet-builds-and-ships-again/" ref="nofollow noopener noreferrer">devblogs.microsoft.com/dotnet/rein…</a></li>
</ul>
<h2 data-id="heading-6">使用 GitHub Copilot 代理模式现代化 .NET 应用的逐步指南</h2>
<ul>
<li><strong>文章简介：</strong> 升级一个旧的.NET 应用不必非得去追逐破损的构建和隐晦的错误。然而对许多开发者来说，简单的版本提升往往会变成数小时的依赖冲突和手动修复。现代化不仅仅是保持潮流。旧框架可能带来安全风险、性能缓慢，并阻碍云的采用。升级解锁了现代 API、更好的工具以及云原生功能，如自动扩展和安全身份管理。</li>
<li><strong>文章地址：</strong> <a href="https://link.juejin.cn?target=https%3A%2F%2Fdevblogs.microsoft.com%2Fdotnet%2Fmodernizing-dotnet-with-github-copilot-agent-mode%2F" target="_blank" title="https://devblogs.microsoft.com/dotnet/modernizing-dotnet-with-github-copilot-agent-mode/" ref="nofollow noopener noreferrer">devblogs.microsoft.com/dotnet/mode…</a></li>
</ul>
<h2 data-id="heading-7">介绍 C# 14</h2>
<ul>
<li><strong>文章简介：</strong> C# 14 自带 .NET 10。亮点是新增的扩展成员，但还有更多功能让你作为开发者的工作更加高效。此外，我们还增加了新功能，使你能够实现.NET 10 中一些性能提升。继续阅读，了解所有新功能，并找到链接，深入了解并立即开始使用这些功能。</li>
<li><strong>文章地址：</strong> <a href="https://link.juejin.cn?target=https%3A%2F%2Fdevblogs.microsoft.com%2Fdotnet%2Fintroducing-csharp-14%2F" target="_blank" title="https://devblogs.microsoft.com/dotnet/introducing-csharp-14/" ref="nofollow noopener noreferrer">devblogs.microsoft.com/dotnet/intr…</a></li>
</ul>
<h2 data-id="heading-8">一款基于 .NET + 计算机视觉技术开源免费、功能强大的原神智能辅助工具，一键解放双手！</h2>
<ul>
<li><strong>文章简介：</strong> better-genshin-impact 是一款基于 .NET + 计算机视觉技术完全开源免费（GPL-3.0 license）、功能强大的原神智能辅助自动化工具，意图让原神变的更好的项目，包含：自动剧情、全自动钓鱼(AI)、全自动七圣召唤、自动伐木、自动刷本、自动采集/挖矿/锄地等功能。</li>
<li><strong>文章地址：</strong> <a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FwZ4d9baOO2RXsb6VCdSxHQ" target="_blank" title="https://mp.weixin.qq.com/s/wZ4d9baOO2RXsb6VCdSxHQ" ref="nofollow noopener noreferrer">mp.weixin.qq.com/s/wZ4d9baOO…</a></li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d6e2ae5f18e54e7fb36341d73f48bc96~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L-96YCQ5pe25YWJ6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764521844&amp;x-signature=g977OOWVgkj9jx%2BnDnd68npaWsg%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-9">从零开始: c#纯代码实现完整Json解析器的全过程及注释与自定义格式的支持实现</h2>
<ul>
<li><strong>文章简介：</strong> 我们要深入探讨一个非常常用的技术：JSON反序列化。别小看这个技术，它可是现代编程中不可或缺的一部。JSON解析不仅仅是简单的数据转换，它还涉及到复杂的词法分析和文法解析。这些技术是编译器设计的基础，但这不是我们今天要深入探讨的内容。</li>
<li><strong>文章地址：</strong> <a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FbiQK9mv10oK-vFw1N01bcg" target="_blank" title="https://mp.weixin.qq.com/s/biQK9mv10oK-vFw1N01bcg" ref="nofollow noopener noreferrer">mp.weixin.qq.com/s/biQK9mv10…</a></li>
</ul>
<h2 data-id="heading-10">精选 5 款 .NET 开源、实用的商城系统（Shop），快速商城二开利器！</h2>
<ul>
<li><strong>文章简介：</strong> 今天大姚给大家分享 5 款基于 .NET 开源、实用的商城系统（Shop），快速商城二开利器！希望可以帮助到有商城系统开发需求的同学。</li>
<li><strong>文章地址：</strong> <a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FjmACitN34VgTdy6ByDetvg" target="_blank" title="https://mp.weixin.qq.com/s/jmACitN34VgTdy6ByDetvg" ref="nofollow noopener noreferrer">mp.weixin.qq.com/s/jmACitN34…</a></li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a69929f042954aa094fc1dc39f082866~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L-96YCQ5pe25YWJ6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764521844&amp;x-signature=AZn91IFVep25yH0TVUkU4axf79k%3D" alt="" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/488fd0844a9443e483c8cdec0e7acaa0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L-96YCQ5pe25YWJ6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764521844&amp;x-signature=mM5xeHx%2BOhmESZNlM%2Fiy4tcwbWM%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-11">高效.NET编程实战：5个提升性能与可维护性的核心技巧</h2>
<ul>
<li><strong>文章简介：</strong> 在本文中，我们将介绍5个实用技巧，这些技巧可能不常被讨论，但能在实际项目中产生显著差异。这些不是华而不实的技巧；而是经验丰富的工程师悄悄使用的那种小而深思熟虑的更改，以保持其应用程序的精简和可预测性。</li>
<li><strong>文章地址：</strong> <a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2Fe9HptlxdZQPkCBlDC7hnCQ" target="_blank" title="https://mp.weixin.qq.com/s/e9HptlxdZQPkCBlDC7hnCQ" ref="nofollow noopener noreferrer">mp.weixin.qq.com/s/e9HptlxdZ…</a></li>
</ul>
<h2 data-id="heading-12">一款基于 .NET 开源免费、简单实用的数据库文档生成工具</h2>
<ul>
<li><strong>文章简介：</strong> DBCHM 是一款简单且实用的数据库文档生成工具，支持多种主流数据库，包括 SqlServer、MySQL、Oracle、PostgreSQL、DB2、SQLite 等，并能够导出多种格式的文档，如 CHM、Word、Excel、PDF、HTML、XML、Markdown 等。</li>
<li><strong>文章地址：</strong> <a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FnRSBj1i1qNuv0-ob4QDmow" target="_blank" title="https://mp.weixin.qq.com/s/nRSBj1i1qNuv0-ob4QDmow" ref="nofollow noopener noreferrer">mp.weixin.qq.com/s/nRSBj1i1q…</a></li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b1f9d2981a7a4932a1fcca49b1be9f00~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L-96YCQ5pe25YWJ6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764521844&amp;x-signature=F7hBjV8Ci%2FYRfCYa7zi6yNUxWvA%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-13"><code>Span&lt;T&gt;</code> 和 <code>Memory&lt;T&gt;</code> 到底该用哪个？一句话讲清楚</h2>
<ul>
<li><strong>文章简介：</strong> 上一篇文章《C#中的Span是啥？看完这篇你就懂了》介绍了Span使用，虽然 <code>Span&lt;T&gt;</code> 是处理连续内存的高性能方式，但它有个“硬伤”——它只能活在栈上（stack-only）。那问题来了：当你需要在更复杂的场景中使用“可切片、零拷贝”的结构时，怎么办？答案就是：Memory和 ReadOnlyMemory。</li>
<li><strong>文章地址：</strong> <a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FcFZS-yRoGxjyCgJQfOH3Fw" target="_blank" title="https://mp.weixin.qq.com/s/cFZS-yRoGxjyCgJQfOH3Fw" ref="nofollow noopener noreferrer">mp.weixin.qq.com/s/cFZS-yRoG…</a></li>
</ul>
<h2 data-id="heading-14">Serilog 日志库简单实践（三）集中式日志与分析平台 Sinks（.net8）</h2>
<ul>
<li><strong>文章简介：</strong> 本文继续对各种类型的 Sink 进行简单的实践，主题是集中式日志与分析平台 Sinks，供参考。</li>
<li><strong>文章地址：</strong> <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.cnblogs.com%2Fhnzhengfy%2Fp%2F19188548%2FSerilog_AnalysisPlantform" target="_blank" title="https://www.cnblogs.com/hnzhengfy/p/19188548/Serilog_AnalysisPlantform" ref="nofollow noopener noreferrer">www.cnblogs.com/hnzhengfy/p…</a></li>
</ul>
<h2 data-id="heading-15">使用.NET 8+ 与飞书API构建组织架构同步服务</h2>
<ul>
<li><strong>文章简介：</strong> 在现代企业数字化转型中，典型的.NET技术栈（如ASP.NET Core MVC/Web API, Entity Framework Core, SQL Server）构建的内部管理系统扮演着核心角色。这些系统承载着企业的关键业务流程，从人力资源管理到权限控制，从财务审批到业务数据分析。然而，一个普遍存在的痛点是：员工信息在飞书和自建.NET系统间存在严重的数据不一致问题。当新员工入职时，HR在飞书中录入信息，但各个.NET系统仍需手动重复录入；当员工离职或转岗时，权限更新往往滞后，存在安全隐患；部门架构调整时，各系统的数据更新更是不同步，导致报表统计不准确。</li>
<li><strong>文章地址：</strong> <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.cnblogs.com%2Fmudtools%2Fp%2F19255641" target="_blank" title="https://www.cnblogs.com/mudtools/p/19255641" ref="nofollow noopener noreferrer">www.cnblogs.com/mudtools/p/…</a></li>
</ul>
<h2 data-id="heading-16">C# 14 新功能全面解析：提升生产力与性能的革命性更新</h2>
<ul>
<li><strong>文章简介：</strong> C# 语言作为.NET生态的核心，始终致力于提升开发者的生产力与应用程序性能。C# 14带来了多项突破性特性，包括扩展成员、字段关键词、空条件赋值等，这些改进显著减少了样板代码，增强了类型系统的灵活性。本文将深入解析这些新功能的设计原理、应用场景及实际价值，帮助开发者快速掌握C# 14的核心优势。</li>
<li><strong>文章地址：</strong> <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.cnblogs.com%2Fpowertoolsteam%2Fp%2F19237152" target="_blank" title="https://www.cnblogs.com/powertoolsteam/p/19237152" ref="nofollow noopener noreferrer">www.cnblogs.com/powertoolst…</a></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Android模拟器检测全面指南：从基础到高级策略]]></title>    <link>https://juejin.cn/post/7575162322240880640</link>    <guid>https://juejin.cn/post/7575162322240880640</guid>    <pubDate>2025-11-23T17:01:32.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7575162322240880640" data-draft-id="7575413146921861135" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Android模拟器检测全面指南：从基础到高级策略"/> <meta itemprop="keywords" content="Android"/> <meta itemprop="datePublished" content="2025-11-23T17:01:32.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="陆业聪"/> <meta itemprop="url" content="https://juejin.cn/user/13629904404157"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Android模拟器检测全面指南：从基础到高级策略
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/13629904404157/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    陆业聪
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-23T17:01:32.000Z" title="Sun Nov 23 2025 17:01:32 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一、核心检测维度与方法</h2>
<p>检测Android模拟器的核心思路是识别其与真实设备在<strong>硬件、系统属性和行为特征</strong>上的差异。以下是经过实践验证的有效方法。</p>
<h3 data-id="heading-1">1.1 检查系统构建属性</h3>
<p>模拟器的<code>android.os.Build</code>类中的属性值通常包含特定标识符，这是最基础的检测方式。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isProbablyEmulator</span><span class="hljs-params">()</span> {
    <span class="hljs-type">String</span> <span class="hljs-variable">model</span> <span class="hljs-operator">=</span> Build.MODEL.toLowerCase();
    <span class="hljs-type">String</span> <span class="hljs-variable">manufacturer</span> <span class="hljs-operator">=</span> Build.MANUFACTURER.toLowerCase();
    <span class="hljs-type">String</span> <span class="hljs-variable">product</span> <span class="hljs-operator">=</span> Build.PRODUCT.toLowerCase();
    <span class="hljs-type">String</span> <span class="hljs-variable">fingerprint</span> <span class="hljs-operator">=</span> Build.FINGERPRINT.toLowerCase();
    <span class="hljs-type">String</span> <span class="hljs-variable">brand</span> <span class="hljs-operator">=</span> Build.BRAND.toLowerCase();
    <span class="hljs-type">String</span> <span class="hljs-variable">hardware</span> <span class="hljs-operator">=</span> Build.HARDWARE.toLowerCase();
    <span class="hljs-type">String</span> <span class="hljs-variable">device</span> <span class="hljs-operator">=</span> Build.DEVICE.toLowerCase();

    <span class="hljs-keyword">return</span> (model.contains(<span class="hljs-string">"google_sdk"</span>) ||
            model.contains(<span class="hljs-string">"droid4x"</span>) ||
            model.contains(<span class="hljs-string">"emulator"</span>) ||
            model.contains(<span class="hljs-string">"android sdk built for x86"</span>) ||
            manufacturer.contains(<span class="hljs-string">"genymotion"</span>) ||
            product.contains(<span class="hljs-string">"sdk_google"</span>) ||
            product.contains(<span class="hljs-string">"google_sdk"</span>) ||
            product.contains(<span class="hljs-string">"sdk"</span>) ||
            product.contains(<span class="hljs-string">"sdk_x86"</span>) ||
            product.contains(<span class="hljs-string">"vbox86p"</span>) ||
            product.contains(<span class="hljs-string">"emulator"</span>) ||
            fingerprint.contains(<span class="hljs-string">"generic"</span>) ||
            fingerprint.contains(<span class="hljs-string">"generic/sdk/generic"</span>) ||
            fingerprint.contains(<span class="hljs-string">"sdk_gphone"</span>) ||
            fingerprint.contains(<span class="hljs-string">"google/sdk_gphone"</span>) ||
            fingerprint.contains(<span class="hljs-string">"test-keys"</span>) ||
            brand.contains(<span class="hljs-string">"generic"</span>) ||
            hardware.contains(<span class="hljs-string">"goldfish"</span>) || <span class="hljs-comment">// 传统模拟器硬件</span>
            hardware.contains(<span class="hljs-string">"ranchu"</span>) ||   <span class="hljs-comment">// 较新模拟器硬件</span>
            device.contains(<span class="hljs-string">"generic"</span>));
}
</code></pre>
<p><strong>关键系统属性检查点</strong>：</p>
<ul>
<li><strong>ro.hardware</strong>：模拟器通常返回"goldfish"或"ranchu"</li>
<li><strong>ro.kernel.qemu</strong>：模拟器中常返回"1"，真机通常为空</li>
<li><strong>ro.product.model</strong>：Android模拟器通常为"sdk"或"google_sdk"</li>
</ul>
<h3 data-id="heading-2">1.2 检查特定系统文件与属性</h3>
<p>模拟器环境中存在真机没有的特殊文件和系统属性。</p>
<p><strong>通过反射读取系统属性</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">getSystemProperty</span><span class="hljs-params">(String key)</span> {
    <span class="hljs-keyword">try</span> {
        Class&lt;?&gt; systemPropertyClass = Class.forName(<span class="hljs-string">"android.os.SystemProperties"</span>);
        <span class="hljs-keyword">return</span> (String) systemPropertyClass.getMethod(<span class="hljs-string">"get"</span>, String.class).invoke(<span class="hljs-literal">null</span>, key);
    } <span class="hljs-keyword">catch</span> (Exception e) {
        e.printStackTrace();
        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
    }
}

<span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isEmulatorByProperties</span><span class="hljs-params">()</span> {
    <span class="hljs-type">String</span> <span class="hljs-variable">hardware</span> <span class="hljs-operator">=</span> getSystemProperty(<span class="hljs-string">"ro.hardware"</span>);
    <span class="hljs-type">String</span> <span class="hljs-variable">kernelQemu</span> <span class="hljs-operator">=</span> getSystemProperty(<span class="hljs-string">"ro.kernel.qemu"</span>);
    <span class="hljs-type">String</span> <span class="hljs-variable">hardwarePlatform</span> <span class="hljs-operator">=</span> getSystemProperty(<span class="hljs-string">"ro.boot.hardware.platform"</span>);

    <span class="hljs-keyword">return</span> <span class="hljs-string">"goldfish"</span>.equals(hardware) ||
           <span class="hljs-string">"ranchu"</span>.equals(hardware) ||
           <span class="hljs-string">"1"</span>.equals(kernelQemu) ||
           (hardwarePlatform != <span class="hljs-literal">null</span> &amp;&amp; hardwarePlatform.contains(<span class="hljs-string">"sdk"</span>));
}
</code></pre>
<p><strong>模拟器特有文件检测</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> String[] known_files = {
    <span class="hljs-string">"/system/lib/libc_malloc_debug_qemu.so"</span>,
    <span class="hljs-string">"/sys/qemu_trace"</span>, 
    <span class="hljs-string">"/system/bin/qemu-props"</span>,
    <span class="hljs-string">"/dev/socket/qemud"</span>,
    <span class="hljs-string">"/dev/qemu_pipe"</span>
};

<span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">hasQEmuFiles</span><span class="hljs-params">()</span> {
    <span class="hljs-keyword">for</span>(String filePath : known_files) {
        <span class="hljs-type">File</span> <span class="hljs-variable">targetFile</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(filePath);
        <span class="hljs-keyword">if</span> (targetFile.exists()) {
            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
        }
    }
    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
}
</code></pre>
<h3 data-id="heading-3">1.3 检查硬件与传感器信息</h3>
<p>模拟器通常无法完美模拟所有硬件特性，这为检测提供了多个切入点。</p>
<p><strong>传感器检测</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 检查光传感器是否存在</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Boolean <span class="hljs-title function_">notHasLightSensorManager</span><span class="hljs-params">(Context context)</span> {
    <span class="hljs-type">SensorManager</span> <span class="hljs-variable">sensorManager</span> <span class="hljs-operator">=</span> (SensorManager) context.getSystemService(SENSOR_SERVICE);
    <span class="hljs-type">Sensor</span> <span class="hljs-variable">lightSensor</span> <span class="hljs-operator">=</span> sensorManager.getDefaultSensor(Sensor.TYPE_LIGHT);
    <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span> == lightSensor;
}
</code></pre>
<p><strong>基带与电话状态检查</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">checkByTelephony</span><span class="hljs-params">(Context context)</span> {
    <span class="hljs-type">TelephonyManager</span> <span class="hljs-variable">tm</span> <span class="hljs-operator">=</span> (TelephonyManager) context.getSystemService(Context.TELEPHONY_SERVICE);
    <span class="hljs-type">String</span> <span class="hljs-variable">imei</span> <span class="hljs-operator">=</span> tm.getDeviceId();
    <span class="hljs-type">String</span> <span class="hljs-variable">networkOperator</span> <span class="hljs-operator">=</span> tm.getNetworkOperatorName();
    
    <span class="hljs-comment">// 模拟器IMEI通常为000000000000000，网络运营商为"Android"</span>
    <span class="hljs-keyword">return</span> (imei != <span class="hljs-literal">null</span> &amp;&amp; imei.equals(<span class="hljs-string">"000000000000000"</span>)) || 
           <span class="hljs-string">"android"</span>.equalsIgnoreCase(networkOperator);
}
</code></pre>
<p><strong>蓝牙检测</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">notHasBlueTooth</span><span class="hljs-params">()</span> {
    <span class="hljs-type">BluetoothAdapter</span> <span class="hljs-variable">ba</span> <span class="hljs-operator">=</span> BluetoothAdapter.getDefaultAdapter();
    <span class="hljs-keyword">if</span> (ba == <span class="hljs-literal">null</span>) {
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    } <span class="hljs-keyword">else</span> {
        <span class="hljs-comment">// 如果有蓝牙但名称为空，可能是模拟器</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">name</span> <span class="hljs-operator">=</span> ba.getName();
        <span class="hljs-keyword">return</span> TextUtils.isEmpty(name);
    }
}
</code></pre>
<h3 data-id="heading-4">1.4 检查CPU架构与信息</h3>
<p>模拟器通常运行在x86/x86_64架构的PC上，而真机多为ARM架构。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">readCpuInfo</span><span class="hljs-params">()</span> {
    <span class="hljs-type">String</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> <span class="hljs-string">""</span>;
    <span class="hljs-keyword">try</span> {
        String[] args = {<span class="hljs-string">"/system/bin/cat"</span>, <span class="hljs-string">"/proc/cpuinfo"</span>};
        <span class="hljs-type">ProcessBuilder</span> <span class="hljs-variable">cmd</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ProcessBuilder</span>(args);
        <span class="hljs-type">Process</span> <span class="hljs-variable">process</span> <span class="hljs-operator">=</span> cmd.start();
        <span class="hljs-type">StringBuffer</span> <span class="hljs-variable">sb</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuffer</span>();
        <span class="hljs-type">String</span> <span class="hljs-variable">readLine</span> <span class="hljs-operator">=</span> <span class="hljs-string">""</span>;
        <span class="hljs-type">BufferedReader</span> <span class="hljs-variable">responseReader</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BufferedReader</span>(
            <span class="hljs-keyword">new</span> <span class="hljs-title class_">InputStreamReader</span>(process.getInputStream(), <span class="hljs-string">"utf-8"</span>));
        <span class="hljs-keyword">while</span> ((readLine = responseReader.readLine()) != <span class="hljs-literal">null</span>) {
            sb.append(readLine);
        }
        responseReader.close();
        result = sb.toString().toLowerCase();
    } <span class="hljs-keyword">catch</span> (IOException ex) {
        <span class="hljs-comment">// 处理异常</span>
    }
    <span class="hljs-keyword">return</span> result;
}

<span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">checkByCpuInfo</span><span class="hljs-params">()</span> {
    <span class="hljs-type">String</span> <span class="hljs-variable">cpuInfo</span> <span class="hljs-operator">=</span> readCpuInfo();
    <span class="hljs-keyword">return</span> (cpuInfo.contains(<span class="hljs-string">"intel"</span>) || cpuInfo.contains(<span class="hljs-string">"amd"</span>));
}
</code></pre>
<h3 data-id="heading-5">1.5 电池状态检测</h3>
<p>模拟器的电池信息通常保持不变，而真机的电池状态会动态变化。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">checkBatteryStats</span><span class="hljs-params">(Context context)</span> {
    <span class="hljs-type">IntentFilter</span> <span class="hljs-variable">filter</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IntentFilter</span>(Intent.ACTION_BATTERY_CHANGED);
    <span class="hljs-type">Intent</span> <span class="hljs-variable">batteryStatus</span> <span class="hljs-operator">=</span> context.registerReceiver(<span class="hljs-literal">null</span>, filter);
    
    <span class="hljs-keyword">if</span> (batteryStatus == <span class="hljs-literal">null</span>) <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    
    <span class="hljs-type">int</span> <span class="hljs-variable">level</span> <span class="hljs-operator">=</span> batteryStatus.getIntExtra(BatteryManager.EXTRA_LEVEL, -<span class="hljs-number">1</span>);
    <span class="hljs-type">int</span> <span class="hljs-variable">scale</span> <span class="hljs-operator">=</span> batteryStatus.getIntExtra(BatteryManager.EXTRA_SCALE, -<span class="hljs-number">1</span>);
    <span class="hljs-type">int</span> <span class="hljs-variable">temperature</span> <span class="hljs-operator">=</span> batteryStatus.getIntExtra(BatteryManager.EXTRA_TEMPERATURE, -<span class="hljs-number">1</span>);
    
    <span class="hljs-comment">// 模拟器电池电量通常固定，温度常为0</span>
    <span class="hljs-keyword">return</span> (temperature == <span class="hljs-number">0</span> || (level &gt;= <span class="hljs-number">0</span> &amp;&amp; scale &gt; <span class="hljs-number">0</span> &amp;&amp; level == scale));
}
</code></pre>
<h2 data-id="heading-6">二、高级检测技术</h2>
<h3 data-id="heading-7">2.1 基于Cache行为的检测</h3>
<p>利用ARM与x86架构的缓存差异进行检测：</p>
<ul>
<li><strong>ARM架构</strong>：使用哈佛架构，指令缓存(I-Cache)和数据缓存(D-Cache)分离</li>
<li><strong>x86架构</strong>：使用冯·诺依曼结构，指令和数据共享缓存</li>
</ul>
<p>这种方法能准确识别底层架构，但需要编写汇编代码，兼容性需要考虑。</p>
<h3 data-id="heading-8">2.2 基带信息检测</h3>
<p>基带是手机的基本通信模块，模拟器通常没有真实的基带信息：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">checkBaseband</span><span class="hljs-params">()</span> {
    <span class="hljs-keyword">try</span> {
        Class&lt;?&gt; systemPropertyClass = Class.forName(<span class="hljs-string">"android.os.SystemProperties"</span>);
        <span class="hljs-type">Method</span> <span class="hljs-variable">getMethod</span> <span class="hljs-operator">=</span> systemPropertyClass.getMethod(<span class="hljs-string">"get"</span>, String.class);
        <span class="hljs-type">String</span> <span class="hljs-variable">baseband</span> <span class="hljs-operator">=</span> (String) getMethod.invoke(<span class="hljs-literal">null</span>, <span class="hljs-string">"gsm.version.baseband"</span>);
        <span class="hljs-keyword">return</span> (baseband == <span class="hljs-literal">null</span> || baseband.isEmpty());
    } <span class="hljs-keyword">catch</span> (Exception e) {
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    }
}
</code></pre>
<h3 data-id="heading-9">2.3 处理器信息一致性检查</h3>
<p>检测<code>ro.product.board</code>和<code>ro.board.platform</code>是否一致：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">checkProcessorConsistency</span><span class="hljs-params">()</span> {
    <span class="hljs-type">int</span> <span class="hljs-variable">suspectCount</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;
    
    <span class="hljs-type">String</span> <span class="hljs-variable">productBoard</span> <span class="hljs-operator">=</span> getSystemProperty(<span class="hljs-string">"ro.product.board"</span>);
    <span class="hljs-type">String</span> <span class="hljs-variable">boardPlatform</span> <span class="hljs-operator">=</span> getSystemProperty(<span class="hljs-string">"ro.board.platform"</span>);
    
    <span class="hljs-keyword">if</span> (productBoard == <span class="hljs-literal">null</span> || <span class="hljs-string">""</span>.equals(productBoard)) suspectCount++;
    <span class="hljs-keyword">if</span> (boardPlatform == <span class="hljs-literal">null</span> || <span class="hljs-string">""</span>.equals(boardPlatform)) suspectCount++;
    <span class="hljs-keyword">if</span> (productBoard != <span class="hljs-literal">null</span> &amp;&amp; boardPlatform != <span class="hljs-literal">null</span> &amp;&amp; 
        !productBoard.equals(boardPlatform)) suspectCount++;
    
    <span class="hljs-keyword">return</span> suspectCount;
}
</code></pre>
<h2 data-id="heading-10">三、集成检测策略与建议</h2>
<h3 data-id="heading-11">3.1 综合评分策略</h3>
<p>不要依赖单一检测方法，应采用<strong>多维度综合评分</strong>系统：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">EmulatorDetector</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">THRESHOLD</span> <span class="hljs-operator">=</span> <span class="hljs-number">3</span>; <span class="hljs-comment">// 阈值可根据需求调整</span>
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isRunningOnEmulator</span><span class="hljs-params">(Context context)</span> {
        <span class="hljs-type">int</span> <span class="hljs-variable">suspectScore</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;
        
        <span class="hljs-comment">// 系统属性检查</span>
        <span class="hljs-keyword">if</span> (checkBuildProperties()) suspectScore += <span class="hljs-number">2</span>;
        
        <span class="hljs-comment">// 文件检查</span>
        <span class="hljs-keyword">if</span> (hasQEmuFiles()) suspectScore += <span class="hljs-number">2</span>;
        
        <span class="hljs-comment">// 硬件检查</span>
        <span class="hljs-keyword">if</span> (checkByTelephony(context)) suspectScore += <span class="hljs-number">1</span>;
        <span class="hljs-keyword">if</span> (notHasLightSensorManager(context)) suspectScore += <span class="hljs-number">1</span>;
        <span class="hljs-keyword">if</span> (checkByCpuInfo()) suspectScore += <span class="hljs-number">2</span>;
        
        <span class="hljs-comment">// 电池状态检查</span>
        <span class="hljs-keyword">if</span> (checkBatteryStats(context)) suspectScore += <span class="hljs-number">1</span>;
        
        <span class="hljs-keyword">return</span> suspectScore &gt;= THRESHOLD;
    }
}
</code></pre>
<h3 data-id="heading-12">3.2 特定模拟器检测</h3>
<p>针对常见模拟器（如BlueStacks）的专项检测：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> String[] known_bluestacks = {
    <span class="hljs-string">"/data/app/com.bluestacks.appmart-1.apk"</span>,
    <span class="hljs-string">"/data/app/com.bluestacks.BstCommandProcessor-1.apk"</span>, 
    <span class="hljs-string">"/data/app/com.bluestacks.help-1.apk"</span>,
    <span class="hljs-string">"/data/bluestacks.prop"</span>
};

<span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">checkBlueStacksFiles</span><span class="hljs-params">()</span> {
    <span class="hljs-keyword">for</span> (String filePath : known_bluestacks) {
        <span class="hljs-type">File</span> <span class="hljs-variable">targetFile</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(filePath);
        <span class="hljs-keyword">if</span> (targetFile.exists()) {
            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
        }
    }
    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
}
</code></pre>
<h2 data-id="heading-13">四、重要注意事项</h2>
<h3 data-id="heading-14">4.1 权限与隐私合规</h3>
<p>部分检测方法需要申请权限：</p>
<ul>
<li><code>READ_PHONE_STATE</code>：用于读取IMEI、IMSI等设备标识</li>
<li><code>ACCESS_WIFI_STATE</code>：用于获取MAC地址信息</li>
<li><code>BLUETOOTH</code>：用于蓝牙检测</li>
</ul>
<p>确保遵循Google Play的隐私政策及相关法律法规（如GDPR）。</p>
<h3 data-id="heading-15">4.2 性能与兼容性考虑</h3>
<ul>
<li><strong>避免过度检测</strong>：检测逻辑应高效，不影响应用性能</li>
<li><strong>真机兼容性</strong>：在所有目标真机上充分测试，避免误判</li>
<li><strong>及时更新</strong>：模拟器技术不断进化，检测方法需定期更新</li>
</ul>
<h3 data-id="heading-16">4.3 服务端验证</h3>
<p>对于高安全性要求的应用，建议将关键检测逻辑放在服务端：</p>
<ul>
<li>防止客户端代码被篡改</li>
<li>动态更新检测规则</li>
<li>结合设备指纹技术</li>
</ul>
<h2 data-id="heading-17">五、总结</h2>
<p>Android模拟器检测是一场持续的"攻防战"。有效检测需要<strong>多维度、多方法结合</strong>，没有单一方法能100%准确识别所有模拟器。建议根据具体应用场景和安全要求，选择合适的检测方法组合，并建立综合评分机制。</p>
<p><strong>核心建议</strong>：</p>
<ol>
<li>优先使用系统属性检查等轻量级方法</li>
<li>结合文件检查、硬件信息验证等多维度检测</li>
<li>对高安全性场景，考虑使用专业设备指纹SDK</li>
<li>定期更新检测策略以应对新型模拟器</li>
</ol>
<p>通过系统化的检测方案，可以有效识别大多数模拟器环境，提升应用安全性。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[【HarmonyOS 6】为什么getContext 废弃，使用getHostContext说明]]></title>    <link>https://juejin.cn/post/7575413146921631759</link>    <guid>https://juejin.cn/post/7575413146921631759</guid>    <pubDate>2025-11-23T15:16:06.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7575413146921631759" data-draft-id="7575807729722802210" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="【HarmonyOS 6】为什么getContext 废弃，使用getHostContext说明"/> <meta itemprop="keywords" content="HarmonyOS"/> <meta itemprop="datePublished" content="2025-11-23T15:16:06.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="GeorgePanda"/> <meta itemprop="url" content="https://juejin.cn/user/1239904847930654"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            【HarmonyOS 6】为什么getContext 废弃，使用getHostContext说明
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1239904847930654/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    GeorgePanda
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-23T15:16:06.000Z" title="Sun Nov 23 2025 15:16:06 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">【HarmonyOS 6】为什么getContext 废弃，使用getHostContext说明</h2>
<h3 data-id="heading-1">一、问题背景：为什么要替换 getContext？</h3>
<p>最近这几个月在做HarmonyOS 6的新项目。从搭建项目框架，查看官方文档之初，就发现了一个非常有意思的点。发现获取上下文的写法又变了，第一瞬间，就对新旧两种写法有何区别产生了好奇。</p>
<pre><code class="hljs language-typescript" lang="typescript">    <span class="hljs-comment">// 新</span>
    <span class="hljs-keyword">let</span> <span class="hljs-attr">context</span>: <span class="hljs-title class_">Context</span> | <span class="hljs-literal">undefined</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getUIContext</span>().<span class="hljs-title function_">getHostContext</span>();
    <span class="hljs-comment">// 旧</span>
    <span class="hljs-keyword">const</span> context = <span class="hljs-title function_">getContext</span>(<span class="hljs-variable language_">this</span>) <span class="hljs-keyword">as</span> common.<span class="hljs-property">UIAbilityContext</span>;
</code></pre>
<p>我还特意在官方社区起了个话题。结果无人讨论。今天有时间就深入研究了下，发现官网有做出解释，但是给的理由太抽象了。这就是本文的由来，主要做详细的原因解释。
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a93768b467524cbb8cc90de5fc62d0f3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgR2VvcmdlUGFuZGE=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764515766&amp;x-signature=ewmTFqjQhEai1RqPPz2FcH80J74%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<pre><code class="hljs language-typescript" lang="typescript">官网原因解释参见以下链接：
<span class="hljs-attr">https</span>:<span class="hljs-comment">//developer.huawei.com/consumer/cn/doc/architecture-guides/tools-v1_2-ts_309-0000002443435465#section14148187125815</span>
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8a65ea236efc4bebaca873c6726a5b2b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgR2VvcmdlUGFuZGE=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764515766&amp;x-signature=8hoffoniqZrR0xU%2F98Ra6grOTxw%3D" alt="在这里插入图片描述" loading="lazy"/>
好家伙，差点给我绕进去。QAQ</p>
<h3 data-id="heading-2">二、getContext废弃的原因：</h3>
<p>废话不多说。查阅最新的官方文档，大家可以发现getContext方法从API version 18开始废弃，官方文档建议使用UIContext中的getHostContext替代。</p>
<p>其实从从API version 12开始，就可以通过使用UIContext中的getHostContext来获取UI的执行上下文。只是当时大家都没有太在意，因为getContext还没有提示过时。</p>
<h4 data-id="heading-3">返回值类型是关键差异</h4>
<p>根据getContext的使用习惯，很多开发者惯性的使用断言。这是导致编译报错的核心原因，必须重点关注：
<strong>1、旧方法 getContext：返回类型为 Context（非空）</strong><br/>
所以直接断言为 UIAbilityContext`不会有类型冲突。</p>
<p><strong>2、新方法 getHostContext：返回类型为 Context | undefined</strong><br/>
当组件未依附于有效 UIAbility 时，会返回 undefined。如果还像以前一样直接注解为 Context，编译器会提示“类型不兼容”。（“Type 'Context | undefined' is not assignable to type 'Context'”  ）</p>
<p>原来getContext的使用方式，某些情况下返回的上下文是错误的。最新的getHostContext进行了除了，当错误时，返回的是undefined。</p>
<p>至于为什么不直接改动原来的接口getContext来修复这个问题。那是因为很多既有的项目已经直接使用断言的方式获取上下文了。如果直接修改老接口，会导致老项目编译大面积报错。</p>
<h4 data-id="heading-4">废弃原因拆解：</h4>
<p>综上所述，在getContext 方法被废弃的核心原因源于其设计缺陷与鸿蒙系统架构演进的不兼容性，具体可归结为以下几方面：</p>
<p><strong>1、其首要问题是作用域的不稳定性</strong>
该方法通过组件实例直接获取上下文却无法动态跟踪 Ability 生命周期变化，例如在异步回调（如网络请求、定时器）中若页面已销毁，getContext 可能返回 undefined 导致空指针异常，跨页面跳转时旧上下文未及时释放还可能引发内存泄漏或权限校验错误，在折叠屏设备展开 / 折叠等 UI 容器动态调整场景中，更是无法感知新容器上下文而导致 UI 渲染异常。</p>
<p><strong>2、其次是类型安全层面的设计缺陷</strong>
getContext 返回通用 Context 类型，需开发者手动强制类型转换（如let context = getContext(this) as UIAbilityContext），若实际类型不匹配会引发运行时崩溃，而替代方案 getHostContext 通过 UIContext 明确返回与当前 UI 绑定的具体上下文类型，无需手动转换且编译时即可发现类型错误；</p>
<p><strong>3、从架构演进来看，getContext 作为全局方法与组件强耦合</strong>
难以适配分布式场景下的多设备协同，而 UIContext 体系通过分层设计将上下文管理抽象为独立模块，先通过this.getUIContext()获取当前 UI 的上下文容器，再由 getHostContext 从容器中提取上下文，确保作用域严格隔离，还能支持多线程渲染、跨设备协同等复杂场景（如分屏模式下不同区域 UI 可独立管理上下文）；</p>
<p>4、从官方标准化迁移来看，API 18 前 getContext 虽为推荐方法但已逐渐暴露缺陷，API 18 + 后被明确标记为废弃并推荐迁移至 UIContext 体系，且计划在未来版本完全移除，这一迁移还能带来性能优化（实测上下文查找运行时开销降低约 15%）和维护成本下降的优势，有效解决旧 API 导致的代码碎片化问题；</p>
<p>5、最后，随着鸿蒙支持折叠屏、多屏协同等多元设备形态，传统上下文管理模式已无法满足动态布局需求，而 getHostContext 通过 UIContext 可在折叠屏展开时自动切换至新窗口上下文，在应用从手机流转至平板时同步更新设备参数（如分辨率、DPI），完美适配新设备场景的使用需求。</p>
<h3 data-id="heading-5">二、getHostContext使用说明：</h3>
<h4 data-id="heading-6">场景1：组件内获取（最常用）</h4>
<p>适合在页面组件、自定义组件中获取上下文，需配合类型收窄处理空值：</p>
<pre><code class="hljs language-typescript" lang="typescript">
<span class="hljs-comment">// 1. 获取上下文（不直接注解类型，利用TS类型推断）</span>
<span class="hljs-keyword">const</span> context = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getUIContext</span>().<span class="hljs-title function_">getHostContext</span>();

<span class="hljs-comment">// 2. 类型收窄，确保上下文非空</span>
<span class="hljs-keyword">if</span> (context) {
  <span class="hljs-comment">// 3. 断言为 UIAbilityContext（如需调用startAbility等特有方法）</span>
  <span class="hljs-keyword">const</span> uiAbilityContext = context <span class="hljs-keyword">as</span> common.<span class="hljs-property">UIAbilityContext</span>;
  <span class="hljs-comment">// 4. 安全使用上下文</span>
  uiAbilityContext.<span class="hljs-title function_">startAbility</span>({
    <span class="hljs-attr">bundleName</span>: <span class="hljs-string">'com.example.myapp'</span>,
    <span class="hljs-attr">abilityName</span>: <span class="hljs-string">'SecondAbility'</span>
  });
} <span class="hljs-keyword">else</span> {
  <span class="hljs-comment">// 5. 异常处理：上下文获取失败</span>
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'获取宿主上下文失败，请检查组件是否已挂载'</span>);
}
</code></pre>
<h4 data-id="heading-7">场景2：非UI场景获取（如工具类）</h4>
<p>如果在工具类、服务等非UI环境中，无法通过 <code>getUIContext</code> 获取，可通过缓存方式获取：</p>
<ol>
<li>在 EntryAbility 初始化时缓存 Context：</li>
</ol>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">AppStorage</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@ohos/ui'</span>;
<span class="hljs-keyword">import</span> common <span class="hljs-keyword">from</span> <span class="hljs-string">'@ohos.app.ability.common'</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">EntryAbility</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">UIAbility</span> {
  <span class="hljs-title function_">onCreate</span>(<span class="hljs-attr">want</span>: <span class="hljs-title class_">Want</span>, <span class="hljs-attr">launchParam</span>: <span class="hljs-title class_">AbilityConstant</span>.<span class="hljs-property">LaunchParam</span>): <span class="hljs-built_in">void</span> {
    <span class="hljs-comment">// 缓存 UIAbility 的 Context 到 AppStorage</span>
    <span class="hljs-title class_">AppStorage</span>.<span class="hljs-title function_">setOrCreate</span>(<span class="hljs-string">'appContext'</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">context</span>);
  }
}
</code></pre>
<ol start="2">
<li>在需要的地方读取缓存：</li>
</ol>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">AppStorage</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@ohos/ui'</span>;
<span class="hljs-keyword">import</span> common <span class="hljs-keyword">from</span> <span class="hljs-string">'@ohos.app.ability.common'</span>;

<span class="hljs-comment">// 从缓存获取并断言类型</span>
<span class="hljs-keyword">const</span> context = <span class="hljs-title class_">AppStorage</span>.<span class="hljs-title function_">get</span>(<span class="hljs-string">'appContext'</span>) <span class="hljs-keyword">as</span> common.<span class="hljs-property">UIAbilityContext</span>;
<span class="hljs-keyword">if</span> (context) {
  <span class="hljs-comment">// 后续使用...</span>
}
</code></pre>
<p>在非UI场景（如工具类），可通过AppStorageV2或windowStage.getMainWindow()间接获取UIContext</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[适合iOS开发的一种缓存策略YYCache库 的原理]]></title>    <link>https://juejin.cn/post/7575458028255117355</link>    <guid>https://juejin.cn/post/7575458028255117355</guid>    <pubDate>2025-11-23T15:21:34.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7575458028255117355" data-draft-id="7575468252656402473" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="适合iOS开发的一种缓存策略YYCache库 的原理"/> <meta itemprop="keywords" content="架构,算法"/> <meta itemprop="datePublished" content="2025-11-23T15:21:34.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="sweet丶"/> <meta itemprop="url" content="https://juejin.cn/user/3227821869921646"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            适合iOS开发的一种缓存策略YYCache库 的原理
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3227821869921646/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    sweet丶
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-23T15:21:34.000Z" title="Sun Nov 23 2025 15:21:34 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>YYCache 是 iOS 上一个高性能的缓存框架，它由内存缓存 <code>YYMemoryCache</code> 和磁盘缓存 <code>YYDiskCache</code> 两部分组成。</p>
<h3 data-id="heading-0">核心总览</h3>
<p>YYCache 的核心设计目标是 <strong>高效、线程安全和高性能</strong>。它通过以下方式实现这一目标：</p>
<ol>
<li><strong>分层设计</strong>：内存缓存提供极速访问，磁盘缓存提供大容量存储。</li>
<li><strong>LRU 淘汰算法</strong>：两者都使用 LRU 算法来管理缓存项，确保高频数据留在缓存中。</li>
<li><strong>数据结构优化</strong>：
<ul>
<li><strong>内存缓存</strong>：结合 <code>NSDictionary</code> 和双向链表。</li>
<li><strong>磁盘缓存</strong>：结合 SQLite 和文件系统。</li>
</ul>
</li>
<li><strong>锁策略优化</strong>：使用 <code>pthread_mutex</code> 锁来保证线程安全，性能优于 <code>@synchronized</code> 和 <code>dispatch_semaphore</code>。</li>
</ol>
<hr/>
<p>为了更直观地理解其核心工作原理，我们可以用以下流程图来展示其数据结构和关键操作：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/684526c654234774ab3e476047583279~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgc3dlZXTkuLY=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764516094&amp;x-signature=S84ltNx4q8Cye7CF44vTvtZ%2FX8Q%3D" alt="image.png" loading="lazy"/></p>
<p>上图揭示了YYCache的核心架构，下面我们来详细拆解图中各个部分的工作原理。</p>
<h3 data-id="heading-1">一、YYMemoryCache (内存缓存) 原理</h3>
<p><code>YYMemoryCache</code> 使用了一种非常经典且高效的数据结构组合：<strong>双向链表 + 哈希表</strong>。</p>
<h4 data-id="heading-2">1. 核心数据结构：<code>_YYLinkedMapNode</code> 和 <code>_YYLinkedMap</code></h4>
<ul>
<li><code>_YYLinkedMapNode</code>：链表节点。
<pre><code class="hljs language-objc" lang="objc"><span class="hljs-class"><span class="hljs-keyword">@interface</span> <span class="hljs-title">_YYLinkedMapNode</span> : <span class="hljs-title">NSObject</span> </span>{
    <span class="hljs-keyword">@package</span>
    __<span class="hljs-keyword">unsafe_unretained</span> _YYLinkedMapNode *_prev; <span class="hljs-comment">// 指向上一节点</span>
    __<span class="hljs-keyword">unsafe_unretained</span> _YYLinkedMapNode *_next; <span class="hljs-comment">// 指向下一节点</span>
    <span class="hljs-type">id</span> _key;      <span class="hljs-comment">// 缓存的键</span>
    <span class="hljs-type">id</span> _value;    <span class="hljs-comment">// 缓存的值</span>
    <span class="hljs-built_in">NSUInteger</span> _cost;   <span class="hljs-comment">// 开销成本（用于成本计算）</span>
    <span class="hljs-built_in">NSTimeInterval</span> _time; <span class="hljs-comment">// 访问时间</span>
}
<span class="hljs-keyword">@end</span>
</code></pre>
</li>
<li><code>_YYLinkedMap</code>：一个双向链表，用于管理所有节点。
<pre><code class="hljs language-objc" lang="objc"><span class="hljs-class"><span class="hljs-keyword">@interface</span> <span class="hljs-title">_YYLinkedMap</span> : <span class="hljs-title">NSObject</span> </span>{
    <span class="hljs-keyword">@package</span>
    <span class="hljs-built_in">CFMutableDictionaryRef</span> _dic; <span class="hljs-comment">// 哈希表，用于O(1)的存取</span>
    <span class="hljs-built_in">NSUInteger</span> _totalCost;      <span class="hljs-comment">// 总开销</span>
    <span class="hljs-built_in">NSUInteger</span> _totalCount;     <span class="hljs-comment">// 总数量</span>
    _YYLinkedMapNode *_head;    <span class="hljs-comment">// 链表头（MRU，最近使用）</span>
    _YYLinkedMapNode *_tail;    <span class="hljs-comment">// 链表尾（LRU，最久未使用）</span>
}
<span class="hljs-keyword">@end</span>
</code></pre>
</li>
</ul>
<h4 data-id="heading-3">2. 工作原理</h4>
<p><strong>存取过程与LRU管理</strong></p>
<p>其工作流程可以精确地描述为以下步骤：</p>
<pre><code class="hljs language-mermaid" lang="mermaid">sequenceDiagram
    participant A as Client（客户端）
    participant M as YYMemoryCache
    participant D as _dic (哈希表)
    participant L as 双向链表

    A-&gt;&gt;M: setObject:forKey:
    M-&gt;&gt;D: 通过key查找节点
    alt 节点已存在
        M-&gt;&gt;L: 更新节点value，将节点移至_head
    else 节点不存在
        M-&gt;&gt;M: 创建新节点
        M-&gt;&gt;D: 插入新节点
        M-&gt;&gt;L: 将新节点插入至_head
        M-&gt;&gt;M: _totalCount++, _totalCost++
        loop 超过限制（count/cost）
            M-&gt;&gt;L: 移除_tail节点（LRU）
            M-&gt;&gt;D: 删除对应key
            M-&gt;&gt;M: 更新_totalCount, _totalCost
        end
    end

    A-&gt;&gt;M: objectForKey:
    M-&gt;&gt;D: 通过key查找节点
    alt 节点存在
        M-&gt;&gt;L: 将节点移至_head
        M-&gt;&gt;A: 返回value
    else 节点不存在
        M-&gt;&gt;A: 返回nil
    end
</code></pre>
<p><strong>线程安全</strong>：
<code>YYMemoryCache</code> 使用 <code>pthread_mutex</code> 锁来保证上述所有操作（<code>_dic</code> 的读写、链表的修改）的线程安全性。它在每个操作开始时加锁，结束时解锁。</p>
<hr/>
<h3 data-id="heading-4">二、YYDiskCache (磁盘缓存) 原理</h3>
<p><code>YYDiskCache</code> 的设计更为复杂，它采用了一种<strong>智能的混合存储策略</strong>，根据 value 的大小选择不同的存储方式，以在性能和空间之间取得平衡。</p>
<h4 data-id="heading-5">1. 核心思想：SQLite + 文件系统</h4>
<ul>
<li>
<p><strong>SQLite 数据库</strong>：</p>
<ul>
<li>存储所有的 <strong>元数据</strong>（key, 文件名，大小，访问时间等）。</li>
<li>如果 value 很小（例如小于 16KB），<strong>直接将其作为 BLOB 数据存储在数据库的某一列中</strong>。</li>
<li>优势：对于小数据，读写非常快，并且数据库事务保证了操作的原子性。</li>
<li>方便实现 <strong>LRU 淘汰算法</strong>，只需要通过 SQL 语句操作元数据即可。</li>
</ul>
</li>
<li>
<p><strong>文件系统</strong>：</p>
<ul>
<li>如果 value 很大（例如大于 16KB），则将其<strong>写入单独的文件</strong>，在数据库中只记录其文件名和路径。</li>
<li>优势：避免大文件塞满 SQLite 数据库，导致性能下降。文件系统对于大文件的读写效率更高。</li>
</ul>
</li>
</ul>
<h4 data-id="heading-6">2. 工作流程</h4>
<p><strong>存储过程：</strong></p>
<ol>
<li>根据 <code>key</code> 在数据库中查询记录。</li>
<li>判断 <code>value</code> 的数据大小。</li>
<li><strong>小数据</strong>：直接写入 SQLite 的 <code>data</code> 列。如果之前是文件存储，则删除对应的文件。</li>
<li><strong>大数据</strong>：将数据写入一个文件，并在数据库的 <code>filename</code> 列记录文件名。如果之前 SQLite 的 <code>data</code> 列有数据，则清空。</li>
<li>更新数据库中的元信息（大小、访问时间等）。</li>
</ol>
<p><strong>读取过程：</strong></p>
<ol>
<li>根据 <code>key</code> 从数据库中查询记录。</li>
<li>如果记录中有文件名（<code>filename</code> 不为空），则从文件系统中读取该文件。</li>
<li>如果记录中没有文件名，则直接从数据库的 <code>data</code> 列读取数据。</li>
<li><strong>更新访问时间</strong>：每次读取后，都会在数据库中更新该记录的 <code>last_access_time</code> 字段，这对于实现 LRU 至关重要。</li>
</ol>
<p><strong>淘汰机制：</strong></p>
<ol>
<li>当磁盘缓存的总大小或总数量超过限制时，触发清理。</li>
<li>通过一条 SQL 查询，按照 <code>last_access_time</code> 升序排列（最久未使用的在前），获取需要淘汰的项。</li>
<li>根据查询结果，如果该项有文件，则删除文件；最后，从数据库中删除该记录。</li>
</ol>
<h3 data-id="heading-7">三、YYCache 的整体协作</h3>
<ol>
<li>
<p><strong>写入缓存</strong>：</p>
<ul>
<li>先写入 <code>YYMemoryCache</code>。</li>
<li>再异步写入 <code>YYDiskCache</code>。</li>
</ul>
</li>
<li>
<p><strong>读取缓存</strong>：</p>
<ul>
<li>首先在 <code>YYMemoryCache</code> 中查找，找到则返回并更新链表。</li>
<li>如果内存中没有，则去 <code>YYDiskCache</code> 中查找。</li>
<li>如果在磁盘中找到，则将其返回给用户，并<strong>根据需要</strong>（可配置）写回 <code>YYMemoryCache</code>，以便下次快速访问。</li>
</ul>
</li>
</ol>
<h3 data-id="heading-8">总结</h3>








































<table><thead><tr><th align="left">特性</th><th align="left">YYMemoryCache</th><th align="left">YYDiskCache</th></tr></thead><tbody><tr><td align="left"><strong>存储介质</strong></td><td align="left">内存</td><td align="left">磁盘 (SQLite + 文件系统)</td></tr><tr><td align="left"><strong>数据结构</strong></td><td align="left">双向链表 + 哈希表</td><td align="left">数据库表 + 文件</td></tr><tr><td align="left"><strong>线程安全</strong></td><td align="left"><code>pthread_mutex</code></td><td align="left">串行队列 + <code>dispatch_semaphore</code></td></tr><tr><td align="left"><strong>淘汰算法</strong></td><td align="left">LRU (链表移动)</td><td align="left">LRU (SQL 按时间排序)</td></tr><tr><td align="left"><strong>性能</strong></td><td align="left">极快，O(1)</td><td align="left">较快，对小数据优化好</td></tr><tr><td align="left"><strong>容量</strong></td><td align="left">受内存限制</td><td align="left">受磁盘空间限制</td></tr></tbody></table>
<p>YYCache 的成功在于其对经典算法和数据结构的深刻理解，并结合 iOS 平台特性进行了精妙的工程优化，使其成为了一个非常出色和可靠的缓存组件。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[openstack 中的二层网络跟三层网络范围对比]]></title>    <link>https://juejin.cn/post/7575367791273181222</link>    <guid>https://juejin.cn/post/7575367791273181222</guid>    <pubDate>2025-11-23T14:13:46.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7575367791273181222" data-draft-id="7575119254314385434" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="openstack 中的二层网络跟三层网络范围对比"/> <meta itemprop="keywords" content="OpenStack"/> <meta itemprop="datePublished" content="2025-11-23T14:13:46.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="哈里谢顿"/> <meta itemprop="url" content="https://juejin.cn/user/3678304397695056"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            openstack 中的二层网络跟三层网络范围对比
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3678304397695056/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    哈里谢顿
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-23T14:13:46.000Z" title="Sun Nov 23 2025 14:13:46 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>是的，<strong>三层通信（L3）的范围确实比二层通信（L2）更大</strong>。这是计算机网络体系结构中的一个基本原理，也是为什么现代大规模网络（包括数据中心、云计算、互联网）必须依赖三层路由的原因。</p>
<p>下面从多个维度详细解释为什么 <strong>三层通信范围更大</strong>：</p>
<hr/>
<h2 data-id="heading-0">一、核心区别：作用域不同</h2>




















<table><thead><tr><th>层级</th><th>通信范围</th><th>关键限制</th></tr></thead><tbody><tr><td><strong>二层（L2）</strong></td><td><strong>广播域内</strong>（同一子网/VLAN）</td><td>❌ 无法跨越路由器；依赖 MAC 地址；广播风暴风险</td></tr><tr><td><strong>三层（L3）</strong></td><td><strong>全球可达</strong>（只要 IP 路由可达）</td><td>✅ 可跨子网、跨 VLAN、跨地域、跨互联网</td></tr></tbody></table>
<blockquote>
<p>🌐 <strong>简单说</strong>：</p>
<ul>
<li>L2 是“本地小区内喊话”（靠广播找人）</li>
<li>L3 是“全球寄信”（靠地址+邮局路由）</li>
</ul>
</blockquote>
<hr/>
<h2 data-id="heading-1">二、技术机制对比</h2>
<h3 data-id="heading-2">1. <strong>寻址方式</strong></h3>
<ul>
<li>
<p><strong>L2</strong>：使用 <strong>MAC 地址</strong>（48 位，如 <code>52:54:00:f6:f2:55</code>）</p>
<ul>
<li>MAC 地址只在<strong>本地链路有效</strong></li>
<li>跨设备后，帧会被重新封装，源/目的 MAC 改变</li>
</ul>
</li>
<li>
<p><strong>L3</strong>：使用 <strong>IP 地址</strong>（如 <code>192.168.1.10</code> 或 <code>2001:db8::1</code>）</p>
<ul>
<li>IP 地址具有<strong>全局（或逻辑）唯一性</strong></li>
<li>端到端不变（除非 NAT），路由器根据 IP 查路由表转发</li>
</ul>
</li>
</ul>
<h3 data-id="heading-3">2. <strong>转发设备</strong></h3>
<ul>
<li>
<p><strong>L2 转发</strong>：交换机（Switch）</p>
<ul>
<li>查 <strong>MAC 地址表（FDB）</strong></li>
<li>不认识的目标 → <strong>广播</strong>（泛洪）</li>
<li><strong>不会跨路由器</strong></li>
</ul>
</li>
<li>
<p><strong>L3 转发</strong>：路由器（Router）或三层交换机</p>
<ul>
<li>查 <strong>路由表（Routing Table）</strong></li>
<li>根据最长前缀匹配决定下一跳</li>
<li>可连接不同广播域、不同物理网络</li>
</ul>
</li>
</ul>
<h3 data-id="heading-4">3. <strong>广播 vs 路由</strong></h3>
<ul>
<li>
<p>L2 依赖 <strong>ARP 广播</strong> 解析 IP→MAC：</p>
<pre><code class="hljs">Who has 192.168.1.20? Tell 192.168.1.10
</code></pre>
<p>→ 广播只在本地有效，<strong>路由器不转发广播包</strong></p>
</li>
<li>
<p>L3 使用 <strong>路由协议</strong>（静态路由、OSPF、BGP 等）构建路径 → 可实现跨城市、跨国家通信</p>
</li>
</ul>
<hr/>
<h2 data-id="heading-5">三、实际场景举例</h2>
<h3 data-id="heading-6">场景 1：同一办公室</h3>
<ul>
<li>两台电脑在同一 VLAN（192.168.1.0/24）</li>
<li>通信走 L2：直接通过交换机，速度快、延迟低 ✅</li>
</ul>
<h3 data-id="heading-7">场景 2：跨部门（不同子网）</h3>
<ul>
<li>财务部：192.168.10.0/24</li>
<li>研发部：192.168.20.0/24</li>
<li>必须通过 <strong>路由器</strong> 转发 → L3 通信 ✅</li>
</ul>
<h3 data-id="heading-8">场景 3：访问百度</h3>
<ul>
<li>你的电脑 IP：192.168.1.10</li>
<li>百度服务器 IP：220.181.38.148</li>
<li>中间经过：家庭路由器 → 运营商骨干网 → BGP 路由 → 百度 IDC</li>
<li>全程 <strong>L3 路由</strong>，跨越成百上千个网络 ✅</li>
</ul>
<blockquote>
<p>❌ 如果只用 L2，你连隔壁公司的电脑都 ping 不通！</p>
</blockquote>
<hr/>
<h2 data-id="heading-9">四、在 OpenStack / 云环境中的体现</h2>




















<table><thead><tr><th>通信类型</th><th>实现方式</th><th>范围</th></tr></thead><tbody><tr><td><strong>L2 通信</strong></td><td>同一 Neutron Network 内的 VM</td><td>仅限该虚拟广播域（如一个 VXLAN）</td></tr><tr><td><strong>L3 通信</strong></td><td>通过 Neutron Router 连接不同 Subnet</td><td>可跨 Network、跨租户（策略允许下）、访问公网</td></tr></tbody></table>
<blockquote>
<p>🔸 即使两个 VM 在同一物理主机上，<strong>如果属于不同 Subnet</strong>，也必须走 L3（Router）通信。</p>
</blockquote>
<hr/>
<h2 data-id="heading-10">五、为什么不能全用 L3？为什么不全用 L2？</h2>

















<table><thead><tr><th>方案</th><th>问题</th></tr></thead><tbody><tr><td><strong>全 L2 网络</strong></td><td>广播域过大 → 广播风暴、ARP 表爆炸、安全隔离难（“大二层”仅用于特定场景如金融交易）</td></tr><tr><td><strong>全 L3 网络</strong></td><td>同一子网内通信效率略低（需查路由），但现代硬件已优化</td></tr></tbody></table>
<p>✅ <strong>最佳实践</strong>：</p>
<ul>
<li><strong>小范围用 L2</strong>（高性能、低延迟）</li>
<li><strong>大范围用 L3</strong>（可扩展、易管理、安全隔离）</li>
</ul>
<hr/>
<h2 data-id="heading-11">六、总结</h2>



































<table><thead><tr><th>对比项</th><th>二层通信（L2）</th><th>三层通信（L3）</th></tr></thead><tbody><tr><td><strong>范围</strong></td><td>有限（一个广播域）</td><td>无限（全球 IP 可达）</td></tr><tr><td><strong>设备</strong></td><td>交换机</td><td>路由器</td></tr><tr><td><strong>地址</strong></td><td>MAC 地址</td><td>IP 地址</td></tr><tr><td><strong>扩展性</strong></td><td>差（受广播域限制）</td><td>极强（互联网基础）</td></tr><tr><td><strong>OpenStack 中</strong></td><td>同一 Network 内 VM 互访</td><td>跨 Subnet、Floating IP、外网访问</td></tr></tbody></table>
<blockquote>
<p>✅ <strong>结论：三层通信的范围远大于二层通信，是构建大规模网络的基石。</strong></p>
</blockquote>
<p>理解这一点，就理解了为什么 OpenStack 需要 Neutron Router，也理解了互联网为何能连接数十亿设备 🌍✨</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[跨界颠覆！小米MiMo-Embodied如何重塑自动驾驶与具身智能？]]></title>    <link>https://juejin.cn/post/7575438636331139123</link>    <guid>https://juejin.cn/post/7575438636331139123</guid>    <pubDate>2025-11-23T14:19:49.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7575438636331139123" data-draft-id="7575412016404414474" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="跨界颠覆！小米MiMo-Embodied如何重塑自动驾驶与具身智能？"/> <meta itemprop="keywords" content="AIGC"/> <meta itemprop="datePublished" content="2025-11-23T14:19:49.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="墨风如雪"/> <meta itemprop="url" content="https://juejin.cn/user/4064249017803927"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            跨界颠覆！小米MiMo-Embodied如何重塑自动驾驶与具身智能？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4064249017803927/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    墨风如雪
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-23T14:19:49.000Z" title="Sun Nov 23 2025 14:19:49 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在人工智能的竞技场上，我们时常惊叹于技术迭代的速度。然而，2025年11月21日，小米抛出的重磅消息，却让整个AI圈为之振奋——他们正式发布了具身大模型 <strong>MiMo-Embodied</strong> 并宣布全面开源。这不仅仅是一次简单的模型更新，它标志着AI领域一个根深蒂固的界限被打破，预示着通用物理智能的新纪元或将提前到来。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.worldcodeing.com%2Fwp-content%2Fuploads%2F2025%2F11%2FG6XoQZibUAAIAeL-791x1024.jpeg" target="_blank" title="https://blog.worldcodeing.com/wp-content/uploads/2025/11/G6XoQZibUAAIAeL-791x1024.jpeg" ref="nofollow noopener noreferrer"><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3e0be14505464ce49798312993649bb0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aKo6aOO5aaC6Zuq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764512389&amp;x-signature=kCs9Cb%2BCtLc0yJAo2KDnQ7Divw8%3D" alt="G6XoQZibUAAIAeL" loading="lazy"/></a></p>
<h3 data-id="heading-0">两种智能，一个模型：弥合数字鸿沟</h3>
<p>长久以来，自动驾驶与具身智能，这两大看似亲密却又独立的领域，如同并行的两条铁轨，各有各的算法体系、数据范式与应用场景。汽车专注于道路上的决策与感知，机器人则忙于室内的交互与操作。它们的世界，鲜少交集。</p>
<p>但 MiMo-Embodied 的出现，就是要彻底改变这一局面。小米大胆设想：如果能用一个统一的模型，让AI既懂穿梭车流的智慧，又懂操作物体的灵巧，那将是何等的光景？这款模型正是全球首个尝试打通并成功连接这两大领域的跨域基座模型，其核心野心，便是让AI从“专才”迈向“全才”。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.worldcodeing.com%2Fwp-content%2Fuploads%2F2025%2F11%2Ffig3_img-1024x537.png" target="_blank" title="https://blog.worldcodeing.com/wp-content/uploads/2025/11/fig3_img-1024x537.png" ref="nofollow noopener noreferrer"><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a36c5ebed18548be96b3998a854a3467~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aKo6aOO5aaC6Zuq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764512389&amp;x-signature=kD8j5NBPKVvulbPNqd6Nf7XnMQM%3D" alt="fig3_img" loading="lazy"/></a></p>
<h3 data-id="heading-1">MiMo-Embodied 的三大核心突破</h3>
<p>要实现这样的“跨界融合”，绝非易事。MiMo-Embodied 凭借其独特的设计理念和训练策略，实现了以下三大核心突破：</p>
<ol>
<li>
<p><strong>跨域能力覆盖：室内外场景，一网打尽</strong> 想象一下，一个模型能同步理解你在客厅里如何拿起水杯（可供性推理）、规划打扫房间的步骤（任务规划）、以及判断桌椅的空间关系（空间理解），同时又能精准感知道路上的车辆行人（环境感知）、预测它们的下一步动作（状态预测），并安全高效地规划驾驶路径（驾驶规划）。MiMo-Embodied 正是构建了这样一套贯通室内外、覆盖所有关键任务的全链路智能支撑体系。</p>
</li>
<li>
<p><strong>双向协同赋能：知识的“奇妙漂流”</strong> 这或许是 MiMo-Embodied 最具创新性的地方。小米的团队验证了一个惊人的发现：机器人从室内交互中积累的对物体、空间和意图的理解，可以有效地迁移，帮助车辆在复杂的路口做出更鲁棒、更“人性化”的决策；反过来，自动驾驶系统处理动态交通场景的丰富经验，也能反哺机器人，让它在规划任务时更具预见性和适应性。这种“室内经验”与“室外智慧”的双向知识迁移，真正打破了传统AI的领域壁垒。</p>
</li>
<li>
<p><strong>全链路优化策略：稳定可靠，值得信赖</strong> 为了确保模型的稳定性和可靠性，MiMo-Embodied 采用了一套多阶段的严谨训练策略：“具身与驾驶能力预训练 → 思维链（CoT）推理增强 → 强化学习（RL）精细调优”。这种从宏观认知到精细操作的层层递进，让模型不仅能“想清楚”，还能“做得好”，在复杂真实环境中表现出卓越的稳定性和可靠性。</p>
</li>
</ol>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.worldcodeing.com%2Fwp-content%2Fuploads%2F2025%2F11%2FG6akPNDbkAAIxzd.png" target="_blank" title="https://blog.worldcodeing.com/wp-content/uploads/2025/11/G6akPNDbkAAIxzd.png" ref="nofollow noopener noreferrer"><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/15d8dc95d6b545d79602ca4a3af80d4c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aKo6aOO5aaC6Zuq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764512389&amp;x-signature=y3nF%2Bg6UhPe8AvZxTE4djXFm%2Ffo%3D" alt="G6akPNDbkAAIxzd" loading="lazy"/></a></p>
<h3 data-id="heading-2">性能表现：一份令人信服的成绩单</h3>
<p>谈及性能，MiMo-Embodied 拿出了一份亮眼的成绩单。在涵盖感知、决策与规划的 <strong>29项核心基准测试</strong>中，它整体表现领先，超越了当前主流的开源、闭源乃至专用模型。</p>
<p>具体来看，在 <strong>17项具身智能基准</strong>中，模型在任务规划、可供性预测与空间理解等核心指标上刷新了SOTA（最先进水平），例如能够从一组相似物体中精准识别目标，或根据文字描述定位物体坐标。而在 <strong>12项自动驾驶基准</strong>中，模型也实现了从环境感知到状态预测，再到驾驶规划的全流程性能突破，展现出精准感知复杂交通、预测行为并生成安全高效决策的能力。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.worldcodeing.com%2Fwp-content%2Fuploads%2F2025%2F11%2Ftable2-1024x594.png" target="_blank" title="https://blog.worldcodeing.com/wp-content/uploads/2025/11/table2-1024x594.png" ref="nofollow noopener noreferrer"><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cf8fe5bf6f8146f5b74385bc003ac367~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aKo6aOO5aaC6Zuq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764512389&amp;x-signature=Jd2tKdIVqRrtCLW24g7nyV3hPsY%3D" alt="table2" loading="lazy"/></a></p>
<h3 data-id="heading-3">开源的意义：AI普惠与生态共建</h3>
<p>小米一贯有开源的传统，MiMo-Embodied 也不例外。模型权重与代码已全面面向全球开发者在开源平台开放，并采用宽松的MIT协议。这一举措的战略意义不言而喻：它将极大降低各行各业进入跨域具身智能领域的门槛，促进技术普及，并加速全球开发者共同参与，推动通用物理智能技术的快速迭代和应用场景创新。</p>
<h3 data-id="heading-4">结语</h3>
<p>MiMo-Embodied 的发布，绝不仅仅是小米在AI领域秀肌肉那么简单。它更像是一盏探照灯，为未来通用人工智能的发展指明了方向。当一个AI既能灵巧地为你处理家务，又能安全高效地把你送到目的地时，我们离真正意义上的“通用物理智能”还会远吗？这不仅是技术的突破，更是对未来生活方式的一次大胆畅想。期待 MiMo-Embodied 及其开源社区能激发出更多令人惊喜的创新火花。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.worldcodeing.com%2Fwp-content%2Fuploads%2F2025%2F11%2Fafford-1.svg" target="_blank" title="https://blog.worldcodeing.com/wp-content/uploads/2025/11/afford-1.svg" ref="nofollow noopener noreferrer"><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cf3d9de15e61448ebca7f1a701c451f0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aKo6aOO5aaC6Zuq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764512389&amp;x-signature=T5cm1XaXa13EGmSS%2FVxsNvedt5U%3D" alt="afford-1" loading="lazy"/></a></p>
<p><strong>如果你也对最新的AI信息感兴趣或者有疑问 都可以加入我的大家庭 第一时间分享最新AI资讯、工具、教程、文档 欢迎你的加入！！！😉😉😉</strong></p>
<p>公众号：墨风如雪小站</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[屁股坏了，我硬抗了3天，差不多省了几千块这件事儿。]]></title>    <link>https://juejin.cn/post/7575438636331204659</link>    <guid>https://juejin.cn/post/7575438636331204659</guid>    <pubDate>2025-11-23T14:35:11.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7575438636331204659" data-draft-id="7575119254314336282" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="屁股坏了，我硬抗了3天，差不多省了几千块这件事儿。"/> <meta itemprop="keywords" content="iOS"/> <meta itemprop="datePublished" content="2025-11-23T14:35:11.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="iOS研究院"/> <meta itemprop="url" content="https://juejin.cn/user/1421041942671774"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            屁股坏了，我硬抗了3天，差不多省了几千块这件事儿。
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1421041942671774/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    iOS研究院
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-23T14:35:11.000Z" title="Sun Nov 23 2025 14:35:11 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">背景</h2>
<p>由于我媳妇怀了二宝，所以我把父母也接了过来，方便照顾月子。父母过来之后为了聊表孝心，连着吃了2周的涮羊肉。没想到命运的齿轮开始转动~</p>
<h3 data-id="heading-1">起因</h3>
<p>重庆步入立冬之后，又迎来了新的换季。阴雨绵绵不少同事都变成了病友，咳嗽发烧🤒、感冒🤧可谓各显神通。平时楼梯间闲聊，“今天吃啥饭？”。那几天都变成了，“吃药了么？”</p>
<p>以我为圆点周边的同事也有中招的迹象。上周五下班有点发烧的迹象，回来就吃了感冒药。周六就吃了涮羊肉，导火索就此点燃~</p>
<h3 data-id="heading-2">爆发点</h3>
<p>一开始以为只是单纯的上火，起了一个包不以为然。从这周一到周四接下来的几天不断扩散，从一个黄豆大小，变成鸡蛋🥚大小。<code>十分有九分的不对劲儿！</code></p>
<p>周四下班实在疼痛难忍，走路都只能小步挪。移动速度立减50%，完全是中了虚弱！</p>
<p>我父母见此情况，就建议我去医院🏥看看啥情况。没检查之前我以为就是普通的火疖子而已~</p>
<h3 data-id="heading-3">急诊外科</h3>
<p>晃晃悠悠走到医院基本上已经是晚上9点多。问了一下前台护士，询问了一下挂号流程。就开始漫长的等待，前前后后差不多等了40分钟。等的时候有腿瘸的，崴脚的，眼睛起包的，胳膊起痘的，腰杆痛的，看起来一个比一个急。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b42d0e6569f34fd185ac76825623b54b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgaU9T56CU56m26Zmi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764513310&amp;x-signature=d9Bj9FIgLx9VgOA9eBqs6L8UOZU%3D" alt="IMG_4695.JPG" loading="lazy"/></p>
<h3 data-id="heading-4">急诊诊断</h3>
<p>一看到医生就把基本情况大致讲了一下，医生的看了看表示很严重。当即就安排手术准备，打破伤风，然后去检查B超，再去抽血。医生说是：<strong>肛周囊肿</strong>，而且必须要开刀防毒。当即就要安排住院和开刀，秉着周五还要上班的原则，想想再忍忍。毕竟现在这狗日的大环境，<strong>请个假还看领导的*脸色</strong>，没意思。而且这个月工作日更实在，请假性价比更低。</p>
<p>我拒绝了医生的好意，医生备份方案是输液。我想了想还是开点药，虽然屁股也痛，但是能够小步移动。除了坐着站起来如同针扎，其他时候基本上还能接受。 医生甩给我一个免责声明一样的东西，表示我自愿放弃治疗。让医生开了点药，就拿着单子去付钱了。</p>
<p>大概是开了一盒头孢、一盒止痛药。</p>
<h3 data-id="heading-5">痛苦的周五</h3>
<p>因为屁股如同针扎，基本上平坐一会儿就痛苦难忍。旁边同事，还在说：你咋了这是？我只是简单说了声，屁股痛。实际上坐下来，站起来都需要左腿先发力，支撑全身。<code>从想站起来到站起来用了差不多2分半</code>。因为太痛了，站起来还要缓一缓。</p>
<p>周五下午大概4点多，应该是身体开启了自救模式。感觉自己开始头疼发烧，赶紧拿出止痛药和消炎药炫起来。因为我爸在家，到轻轨后回家路直接开车给我拉回家了。吃了饭，他们本着去小门诊输液控制下病情的原则，想让我输液缓解缓解。<strong>在公司渡劫了一天，我笑着说探探路我再去万一关门了~</strong></p>
<h3 data-id="heading-6">小门诊不敢接</h3>
<p>我父母溜了一圈，发现还开着门。喊我出门去看看医生，我父母一直在给医生解释。但是那个小门诊的医生只想下班。本着不给人添麻烦的原则，我就立马出门向小门诊进军。</p>
<p>等我火急火燎走到小门诊，已经看出来了医生的不耐烦！我用最简单的方式给门诊医生解释了一下。</p>
<p>门诊医生看了下伤口，说我这情况只能开刀。如果不早点开刀会形成肛瘘~</p>
<p><strong>我父母问我咋样？我说人家不敢给输液，让去来一刀。</strong> 于是就慢慢溜达回了家。</p>
<h3 data-id="heading-7">自救模式启动</h3>
<p>回家的路上，我走路的感觉有点奇怪。我以为是药物的反应，感觉湿漉漉的。毕竟这天为了控制消肿，连着上了几天“红霉素软膏”倒也习惯了。</p>
<p>结果回到家一爬到床上，就想着让我媳妇帮忙看一下消肿情况。结果吓了她一跳。内裤上都是血红色，悬着的心终于放下啦！</p>
<p><strong>肛周囊肿这种病情除了开刀就是自溃！</strong> 核心在于排毒环境，肿块的内部压力，从而减轻疼痛感。</p>
<h3 data-id="heading-8">基本康复</h3>
<p>从伤口自溃到截至发稿，感觉像来了2天大姨夫一样。但是痛苦确实减轻不少。基本上可以说是康复了。</p>
<p>这次的事情确实也给我自己敲了警钟！<code>千万不要熬夜！不要久坐！不要贪吃！</code></p>
<p><strong>多喝热水！有啥别有病，没啥别没钱！</strong></p>
<h3 data-id="heading-9">题外话</h3>
<p>之所以，我硬扛了几天。1是因为确实想省点钱，穷病闹得。2是因为小红书有前辈也扛过来了。3是因为基本手术动刀之后，依旧会反复犯病！</p>
<p>这里特别强调一下小红书的前辈，本来搜的时候屁股挺痛的。看到前辈的说楞是差点笑死🤣。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cde2900b684a4e6c8e0b8b3b29488932~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgaU9T56CU56m26Zmi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764513310&amp;x-signature=JsEwmsVM%2BmgMk%2FL1CVPCgSqcmqE%3D" alt="a8a6fd867251b3b2af20864362ad0952.JPG" loading="lazy"/></p>
<p><code>多喝热水，合理膳食</code>，最后祝大家身体健康，有个好屁股！</p>
<h3 data-id="heading-10">相关推荐</h3>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FURmC_4vxQv5ttOg8yYe7Eg" target="_blank" title="https://mp.weixin.qq.com/s/URmC_4vxQv5ttOg8yYe7Eg" ref="nofollow noopener noreferrer"># 苹果开发者续费大坑及成功续费方案！亲测有效</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2F1bAA90Tzpx03tTHZbdg3aw" target="_blank" title="https://mp.weixin.qq.com/s/1bAA90Tzpx03tTHZbdg3aw" ref="nofollow noopener noreferrer"># AppStore敏感词排查手册，多维度分析Guideline 2.3.1隐藏功能，轻松过审。</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzUxMTkxNzAzMw%3D%3D%26mid%3D2247484371%26idx%3D1%26sn%3D33568c58e90a5bf4d2612d803ecb2a27%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzUxMTkxNzAzMw==&amp;mid=2247484371&amp;idx=1&amp;sn=33568c58e90a5bf4d2612d803ecb2a27&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer"># 苹果加急审核是“绿色通道”还是“死亡陷阱”？</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzUxMTkxNzAzMw%3D%3D%26mid%3D2247484362%26idx%3D1%26sn%3Dea61bd42d5ae8b99d2a56cbfb8d91e88%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzUxMTkxNzAzMw==&amp;mid=2247484362&amp;idx=1&amp;sn=ea61bd42d5ae8b99d2a56cbfb8d91e88&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer"># 苹果开发者邮箱，突然收到11.2通知严重么？</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzUxMTkxNzAzMw%3D%3D%26mid%3D2247484413%26idx%3D1%26sn%3D82870d4c8892fa65803a8e05fd5ac938%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzUxMTkxNzAzMw==&amp;mid=2247484413&amp;idx=1&amp;sn=82870d4c8892fa65803a8e05fd5ac938&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer"># 不想被苹果卡审最好错开这两个提审时间</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzUxMTkxNzAzMw%3D%3D%26mid%3D2247484349%26idx%3D1%26sn%3D1c75a6b08cb5de64ddf41a88b61ff108%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzUxMTkxNzAzMw==&amp;mid=2247484349&amp;idx=1&amp;sn=1c75a6b08cb5de64ddf41a88b61ff108&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer"># 手撕苹果审核4.3是代码问题还是设计问题？</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzUxMTkxNzAzMw%3D%3D%26mid%3D2247484344%26idx%3D1%26sn%3D4399eb8d8bf82e9c5df26a18b8564cfb%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzUxMTkxNzAzMw==&amp;mid=2247484344&amp;idx=1&amp;sn=4399eb8d8bf82e9c5df26a18b8564cfb&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer"># 有幸和Appstore审核人员进行了一场视频会议特此记录。</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[国产终端编码神器，编程 CLI 大善人——IFlow CLI]]></title>    <link>https://juejin.cn/post/7575468252656304169</link>    <guid>https://juejin.cn/post/7575468252656304169</guid>    <pubDate>2025-11-23T14:47:05.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7575468252656304169" data-draft-id="7575468252656255017" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="国产终端编码神器，编程 CLI 大善人——IFlow CLI"/> <meta itemprop="keywords" content="AIGC,人工智能"/> <meta itemprop="datePublished" content="2025-11-23T14:47:05.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="三金得鑫"/> <meta itemprop="url" content="https://juejin.cn/user/4406498335130216"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            国产终端编码神器，编程 CLI 大善人——IFlow CLI
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4406498335130216/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    三金得鑫
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-23T14:47:05.000Z" title="Sun Nov 23 2025 14:47:05 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h3 data-id="heading-0">如果你没有条件使用国外的 AI 模型和 AI 工具，那你一定要试试这块国产 AI 终端 CLI，它源自阿里心流团队，免费为大家提供了包括 GLM 4.6、Kimi-K2-Thinking 和 Minimax-M2 等 6 块开源模型，功能上也和 Claude Code 看齐！YYDS！</h3>
<p>在之前的《<a href="https://juejin.cn/post/7572062035140411402" target="_blank" title="https://juejin.cn/post/7572062035140411402">十月份 AI Coding 实践！Qoder、CC、Codex 还是 iflow？</a>》文章中，三金分享了一些 AI Coding 的感悟与工具，其中有提到一款由阿里心流团队打造的终端编码工具——IFlow CLI，今天让我们来详细介绍一下它！</p>
<p>在前段时间阿里 Qoder 官方的直播中，有人问到：你们阿里出了通义灵码、Qoder 还有 IFlow CLI，哪个最好？各有什么优势？</p>
<p>当时官方的回答絮絮叨叨一大堆，我只记得对于 IFlow CLI 来说，最大的优势就是<strong>免费</strong>！而且免费的还是市面上综合评价比较好的几款模型：</p>
<ul>
<li>GML-4.6</li>
<li>Kimi-K2-Thinking</li>
<li>MiniMax-M2</li>
<li>Qwen3-Coder-Plus</li>
<li>DeepSeek-V3.2</li>
<li>Kimi-K2-0905</li>
</ul>
<p>除此之外，在用法和功能上，也是对齐 Claude Code，像快捷指令 Command、SubAgent 以及 MCP 集成，和 Claude Code 完全一致。在国内环境，我们可以很平滑地由 Claude Code 转移到 IFlow CLI 上，再加上这些免费模型，让开发者们可以实现开箱即用！</p>
<h3 data-id="heading-1">安装</h3>
<p>在安装之前，需要检查一下是否有 Node.js 20+ 的环境，以及机器配置是否满足 4GB+ 的内存。如果没有 Node.js 20+ 可以直接执行一键安装脚本：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 一键安装脚本，会安装全部所需依赖</span>
bash -c <span class="hljs-string">"<span class="hljs-subst">$(curl -fsSL https://gitee.com/iflow-ai/iflow-cli/raw/main/install.sh)</span>"</span>
</code></pre>
<p>而在已有 Node.js 20+ 的环境下，只需要执行：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 已有Node.js 20+</span>
npm i -g @iflow-ai/iflow-cli@latest
</code></pre>
<p>我们可以通过 <code>iflow --version</code> 来检查是否安装成功。</p>
<h3 data-id="heading-2">启动</h3>
<p>在终端输入 <code>iflow</code> 进行启动：</p>
<p>启动后，iFlow CLI 需要进行认证登录，官方提供了三种方式：</p>
<ul>
<li><strong>Login with IFlow 登录</strong>，会直接打开心流平台进行登录。最推荐这种方式，因为它能让你的 IFlow CLI 拥有完整的功能体验；</li>
<li><strong>心流 API Key 登录</strong>，适合无浏览器环境（比如服务器下）。也支持完整功能，但是每 7 天需要更新一次 API Key。</li>
<li><strong>OpenAI Compatlble API</strong>，使用第三方模型。不推荐，不细说了。</li>
</ul>
<p>而 IFlow CLI 的完整功能有：</p>
<ul>
<li><strong>WebSearch 服务</strong>：智能网络搜索，获取最新信息</li>
<li><strong>WebFetch 服务</strong>：网页内容抓取和分析</li>
<li><strong>多模态能力</strong>：内置图像理解等多模态功能</li>
<li><strong>工具调用优化</strong>：心流平台提供的模型经过专门优化，工具调用更加精准高效</li>
<li><strong>自动续期</strong>：令牌自动刷新，永不过期</li>
<li><strong>无缝连接</strong>：一次授权，持续使用</li>
</ul>
<h3 data-id="heading-3">核心概念</h3>

















































<table><thead><tr><th>术语</th><th>说明</th></tr></thead><tbody><tr><td>iFlow CLI</td><td>基于终端的AI助手工具</td></tr><tr><td>斜杠命令</td><td>以 <code>/</code> 开头的控制命令（如 <code>/init</code>、<code>/help</code>）</td></tr><tr><td>@</td><td>文件引用 @文件路径(如 <code>@src/App.tsx</code> )</td></tr><tr><td>$</td><td>以 <code>$</code> 开头执行某个subagent(如 <code>$code-reviewer</code> )</td></tr><tr><td>Shell命令</td><td>以 <code>!</code> 开头，可在CLI中执行系统命令</td></tr><tr><td>yolo</td><td>默认允许CLI执行所有操作的执行模式</td></tr><tr><td>MCP</td><td>模型上下文协议，用于扩展AI能力的服务器系统</td></tr><tr><td>Sub Agent</td><td>智能Agent系统,适用于执行不同专业的任务</td></tr><tr><td>Sub Command</td><td>命令行扩展</td></tr><tr><td>context left</td><td>CLI右下角的提示信息，代表模型在对话过程中剩余的上下文长度</td></tr></tbody></table>
<p>我们可以在 VSCode 编辑器中安装 IFlow CLI 插件来快速在项目中启动：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/74ca32359b764e43a34bdabb064cafcb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiJ6YeR5b6X6ZGr:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764514024&amp;x-signature=My15Try5Y1RbWIRl263m0sgS%2BCs%3D" alt="" loading="lazy"/></p>
<p>和 Claude Code 一样，我们可以通过 <code>/init</code> 指令来为项目生成完整的项目上下文。也可以在终端的右下角处看到当前对话的剩余上下文长度：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/24b4812946a3450b8858cd7551ec531e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiJ6YeR5b6X6ZGr:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764514024&amp;x-signature=ozz7d0VA6YXKgBRS10yP8MvCnxE%3D" alt="" loading="lazy"/></p>
<p>如果剩余上下文不多，可以选择使用 <code>/compress</code> 来压缩上下文或者直接 <code>/clear</code> 重置对话。</p>
<p>由于其模型免费的特点，非常建议无法使用 Claude、GPT5 以及 Gemini 的小伙伴进行下载安装。而有这些顶尖模型的小伙伴也可以选择搭配使用：</p>
<ul>
<li>复杂需求或疑难杂症使用 Claude 等模型 + Claude Code/Codex</li>
<li>一般需求使用 iflow</li>
</ul>
<p>这样下来既把活干了，又省 token，堪称最佳搭档～</p>
<p>对于 IFlow CLI 的高阶用法及最佳实践，推荐大家直接访问心流开放平台-<a href="https://link.juejin.cn?target=https%3A%2F%2Fplatform.iflow.com%2Fcli%2Fquickstart" target="_blank" title="https://platform.iflow.com/cli/quickstart" ref="nofollow noopener noreferrer">platform.iflow.com/cli/quickst…</a></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c61e7c860cc749ad968ea1f2c4d72ecc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiJ6YeR5b6X6ZGr:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764514024&amp;x-signature=hzNfhQ6E5Q4PTICIYAoYrwy4S90%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-4">心流家族</h3>
<p>除了给大家介绍的 IFlow CLI 之外，心流还提供了：</p>
<ul>
<li>API 调用，目前是免费使用的，大家可以在心流官网注册后申请使用，支持的模型可以在模型库进行查看（<a href="https://link.juejin.cn?target=https%3A%2F%2Fplatform.iflow.cn%2Fmodels%25EF%25BC%2589" target="_blank" title="https://platform.iflow.cn/models%EF%BC%89" ref="nofollow noopener noreferrer">platform.iflow.cn/models）</a></li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/46eda848d6e547ce8cc73dda065291d1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiJ6YeR5b6X6ZGr:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764514024&amp;x-signature=GNYYleoXlSTAw77p041TYkrT5YU%3D" alt="" loading="lazy"/></p>
<ul>
<li>搭扣，心流提供的一款 Agent 产品，可以实现一站式研发，比如官网开发或者小程序开发。体验地址：<strong><a href="https://link.juejin.cn?target=https%3A%2F%2Fdakou.iflow.cn%2F" target="_blank" title="https://dakou.iflow.cn/" ref="nofollow noopener noreferrer">dakou.iflow.cn/</a></strong></li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/521e11ed3bd24ecaa237ffd19dcd021c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiJ6YeR5b6X6ZGr:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764514024&amp;x-signature=p8%2FNx2ypFHJYvVhc9dRso%2FMe9a0%3D" alt="" loading="lazy"/></p>
<ul>
<li>MCP 市场（<a href="https://link.juejin.cn?target=https%3A%2F%2Fplatform.iflow.cn%2Fmcp%25EF%25BC%2589%25EF%25BC%258C%25E6%258F%2590%25E4%25BE%259B%25E4%25BA%2586%25E4%25B8%2580%25E7%25B3%25BB%25E5%2588%2597%25E5%25BD%2593%25E4%25B8%258B%25E6%25AF%2594%25E8%25BE%2583%25E7%2583%25AD%25E9%2597%25A8%25E7%259A%2584" target="_blank" title="https://platform.iflow.cn/mcp%EF%BC%89%EF%BC%8C%E6%8F%90%E4%BE%9B%E4%BA%86%E4%B8%80%E7%B3%BB%E5%88%97%E5%BD%93%E4%B8%8B%E6%AF%94%E8%BE%83%E7%83%AD%E9%97%A8%E7%9A%84" ref="nofollow noopener noreferrer">platform.iflow.cn/mcp），提供了一系列…</a> MCP 工具，大家可以根据引导提示一键进行安装；</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/77eeea44821248d08a64ce2b1af34dbd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiJ6YeR5b6X6ZGr:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764514024&amp;x-signature=wE3nEB62e3383yEFtYRJ4zoTQu4%3D" alt="" loading="lazy"/></p>
<ul>
<li>智能体扩展（<a href="https://link.juejin.cn?target=https%3A%2F%2Fplatform.iflow.cn%2Fagents%3Ftype%3Dagents%26category%3Dall%25EF%25BC%2589%25EF%25BC%258C%25E8%25BF%2599%25E4%25B8%25AA%25E9%2587%258C%25E9%259D%25A2%25E5%258C%2585%25E5%2590%25AB%25E4%25BA%2586%25E5%25B7%25A5%25E4%25BD%259C%25E6%25B5%2581" target="_blank" title="https://platform.iflow.cn/agents?type=agents&amp;category=all%EF%BC%89%EF%BC%8C%E8%BF%99%E4%B8%AA%E9%87%8C%E9%9D%A2%E5%8C%85%E5%90%AB%E4%BA%86%E5%B7%A5%E4%BD%9C%E6%B5%81" ref="nofollow noopener noreferrer">platform.iflow.cn/agents?type…</a> Workflow、智能体 Agent 和指令 Command，也是可以通过引导提示一键进行安装，非常方便；</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ea251dec50f648b7af38e84162eadaae~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiJ6YeR5b6X6ZGr:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764514024&amp;x-signature=otHlGK86IFORsZ3I2iA0iNo1GnM%3D" alt="" loading="lazy"/></p>
<ul>
<li>官方论坛（<a href="https://link.juejin.cn?target=https%3A%2F%2Fvibex.iflow.cn%2F%25EF%25BC%2589%25EF%25BC%258C%25E7%2594%25BB%25E9%25A3%258E%25E5%2592%258C" target="_blank" title="https://vibex.iflow.cn/%EF%BC%89%EF%BC%8C%E7%94%BB%E9%A3%8E%E5%92%8C" ref="nofollow noopener noreferrer">vibex.iflow.cn/），画风和</a> linuxDo 一样，用的是一套论坛模板，有很多大佬在里面进行交流。</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4b3570f524a7417e9b7e6a2222515775~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiJ6YeR5b6X6ZGr:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764514024&amp;x-signature=15LSplC00i%2BWigoayxSn%2Bp8x7Rw%3D" alt="" loading="lazy"/></p>
<p>除此之外，在心流官网（<a href="https://link.juejin.cn?target=https%3A%2F%2Fiflow.cn%2F%25EF%25BC%2589%25EF%25BC%258C%25E5%25AF%25B9%25E4%25BA%258E%25E5%2585%258D%25E8%25B4%25B9%25E7%2594%25A8%25E6%2588%25B7%25E6%259D%25A5%25E8%25AF%25B4%25EF%25BC%258C%25E6%25AF%258F%25E4%25B8%25AA%25E6%259C%2588%25E8%25BF%2598%25E6%258F%2590%25E4%25BE%259B%25E4%25BA%2586" target="_blank" title="https://iflow.cn/%EF%BC%89%EF%BC%8C%E5%AF%B9%E4%BA%8E%E5%85%8D%E8%B4%B9%E7%94%A8%E6%88%B7%E6%9D%A5%E8%AF%B4%EF%BC%8C%E6%AF%8F%E4%B8%AA%E6%9C%88%E8%BF%98%E6%8F%90%E4%BE%9B%E4%BA%86" ref="nofollow noopener noreferrer">iflow.cn/），对于免费用户来说，…</a> 30次高级研究以及 200 次 AI PPT 生成。</p>
<p>高级研究能做什么呢？比如你想做一个旅游攻略，这个时候就可以点击下图中的网页，并告诉它你想生成去重庆的旅游攻略，待几天？想做什么？想吃什么？等等越详细越好。</p>
<p>而它会在后台执行异步任务，根据任务的复杂度会在20-40分钟左右（自己测的，可能也不准）生成一个旅游攻略的网页给你。非常赞！！</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5ebfb23bd1ab47e18eaf030fcf74333e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiJ6YeR5b6X6ZGr:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764514024&amp;x-signature=jYD5XAcEZGb3qAcQpH4NNcgkCgQ%3D" alt="" loading="lazy"/></p>
<p>感兴趣的小伙伴可以去试试看了～</p>
<blockquote>
<p>PS：大家都在推 Gemini3，而我因为还没有测试完，所以后面再说</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[devstack重启恢复方案]]></title>    <link>https://juejin.cn/post/7575367791273279526</link>    <guid>https://juejin.cn/post/7575367791273279526</guid>    <pubDate>2025-11-23T14:55:23.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7575367791273279526" data-draft-id="7575438636331253811" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="devstack重启恢复方案"/> <meta itemprop="keywords" content="OpenStack"/> <meta itemprop="datePublished" content="2025-11-23T14:55:23.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="哈里谢顿"/> <meta itemprop="url" content="https://juejin.cn/user/3678304397695056"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            devstack重启恢复方案
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3678304397695056/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    哈里谢顿
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-23T14:55:23.000Z" title="Sun Nov 23 2025 14:55:23 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>这是一个非常实际且关键的问题！我们来一步步分析 <strong>“物理主机关机 → 重启”</strong> 对 <strong>嵌套虚拟机 + DevStack</strong> 的影响，并给出完整的恢复操作指南。</p>
<hr/>
<h2 data-id="heading-0">🧩 场景回顾</h2>
<ul>
<li><strong>物理主机（Host）</strong> ：运行 Linux（如 Ubuntu）</li>
<li><strong>虚拟机（VM）</strong> ：在 Host 上通过 KVM/QEMU、VirtualBox 或 VMware 创建</li>
<li><strong>DevStack</strong>：部署在该 VM 内部（单节点 OpenStack 开发环境）</li>
</ul>
<blockquote>
<p>✅ 典型拓扑：<br/>
<code>你的笔记本/服务器</code> → <code>KVM 虚拟机 (192.168.122.30)</code> → <code>DevStack (Keystone/Nova/Neutron...)</code></p>
</blockquote>
<hr/>
<h2 data-id="heading-1">🔌 一、关机对各层的影响</h2>





























<table><thead><tr><th>组件</th><th>关机时状态</th><th>开机后状态</th><th>是否自动恢复</th></tr></thead><tbody><tr><td><strong>物理主机</strong></td><td>正常关机</td><td>需手动开机</td><td>❌</td></tr><tr><td><strong>虚拟机（VM）</strong></td><td>被强制断电（除非优雅关机）</td><td><strong>默认不会自动启动</strong></td><td>❌（需配置）</td></tr><tr><td><strong>DevStack 服务</strong></td><td>进程被 kill</td><td><strong>不会自动启动</strong>（即使 VM 启动）</td><td>❌（需手动或配置 systemd）</td></tr></tbody></table>
<blockquote>
<p>⚠️ <strong>关键结论</strong>：<br/>
<strong>物理机重启后，VM 和 DevStack 都不会自动恢复运行！你需要手动干预。</strong></p>
</blockquote>
<hr/>
<h2 data-id="heading-2">🛠️ 二、开机后的完整恢复步骤</h2>
<h3 data-id="heading-3">✅ 步骤 1：启动虚拟机（VM）</h3>
<h4 data-id="heading-4">情况 A：你使用 <strong>libvirt/KVM（virsh）</strong></h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 查看 VM 状态</span>
virsh <span class="hljs-built_in">list</span> --<span class="hljs-built_in">all</span>

<span class="hljs-comment"># 启动 VM（假设名字是 devstack-vm）</span>
virsh start devstack-vm

<span class="hljs-comment"># （可选）设置开机自启（推荐！）</span>
virsh autostart devstack-vm
</code></pre>
<blockquote>
<p>💡 <code>autostart</code> 会让 VM 在 <strong>物理机启动后自动运行</strong>（但 DevStack 服务仍需单独处理）。</p>
</blockquote>
<h4 data-id="heading-5">情况 B：你使用 <strong>VirtualBox</strong></h4>
<pre><code class="hljs language-bash" lang="bash">VBoxManage startvm <span class="hljs-string">"devstack-vm"</span> --<span class="hljs-built_in">type</span> headless
</code></pre>
<h4 data-id="heading-6">情况 C：你使用 <strong>VMware Workstation / ESXi</strong></h4>
<ul>
<li>手动点击“开机”</li>
<li>或在 ESXi 中设置“随主机启动”</li>
</ul>
<hr/>
<h3 data-id="heading-7">✅ 步骤 2：登录虚拟机，检查 DevStack 服务状态</h3>
<pre><code class="hljs language-perl" lang="perl">ssh stack@192.<span class="hljs-number">168.122</span>.<span class="hljs-number">30</span>  <span class="hljs-comment"># 或你的 VM IP</span>
</code></pre>
<h4 data-id="heading-8">检查 systemd 服务（现代 DevStack 默认方式）：</h4>
<pre><code class="hljs language-perl" lang="perl"><span class="hljs-comment"># 查看所有 DevStack 服务状态</span>
systemctl list-units | <span class="hljs-keyword">grep</span> devstack

<span class="hljs-comment"># 检查 Keystone 是否运行</span>
systemctl is-active devstack@keystone
</code></pre>
<blockquote>
<p>❌ 如果返回 <code>inactive</code>，说明服务未启动。</p>
</blockquote>
<hr/>
<h3 data-id="heading-9">✅ 步骤 3：启动 DevStack 服务</h3>
<h4 data-id="heading-10">方式 A：如果你使用 <strong>systemd 模式（推荐）</strong></h4>
<p>只需启动所有 DevStack 服务：</p>
<pre><code class="hljs language-perl" lang="perl"><span class="hljs-comment"># 启动所有 DevStack 服务</span>
sudo systemctl start <span class="hljs-string">'devstack@*'</span>

<span class="hljs-comment"># 验证</span>
systemctl status devstack@keystone devstack@nova-api
</code></pre>
<blockquote>
<p>✅ 优势：服务会按依赖顺序启动，日志可通过 <code>journalctl</code> 查看。</p>
</blockquote>
<h4 data-id="heading-11">方式 B：如果你使用 <strong>传统模式（非 systemd）</strong></h4>
<p>需要重新运行 DevStack 脚本：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">cd</span> ~/devstack
./rejoin-stack.sh   <span class="hljs-comment"># 重新 attach 到已存在的服务（如果支持）</span>
<span class="hljs-comment"># 或</span>
./stack.sh          <span class="hljs-comment"># 重新完整部署（较慢，但可靠）</span>
</code></pre>
<blockquote>
<p>⚠️ 注意：<code>./stack.sh</code> 会重建数据库和网络，可能导致之前创建的虚拟机丢失！</p>
</blockquote>
<hr/>
<h3 data-id="heading-12">✅ 步骤 4：验证 OpenStack 功能</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">source</span> ~/devstack/openrc admin admin

<span class="hljs-comment"># 测试认证</span>
openstack token issue

<span class="hljs-comment"># 查看虚拟机（如果之前有）</span>
openstack server list

<span class="hljs-comment"># 访问 Dashboard</span>
curl -s http://localhost:8080/dashboard | <span class="hljs-built_in">head</span> -5
</code></pre>
<hr/>
<h2 data-id="heading-13">🔄 三、如何实现“全自动恢复”？（高级建议）</h2>
<p>如果你希望 <strong>物理机重启后，VM 和 DevStack 全自动恢复</strong>，可以这样做：</p>
<h3 data-id="heading-14">1. <strong>让 VM 开机自启</strong></h3>
<ul>
<li><strong>KVM/libvirt</strong>：<code>virsh autostart devstack-vm</code></li>
<li><strong>VirtualBox</strong>：需写 systemd 服务或 cron job</li>
<li><strong>VMware</strong>：在虚拟机设置中启用“随主机启动”</li>
</ul>
<h3 data-id="heading-15">2. <strong>让 DevStack 服务随 VM 启动</strong></h3>
<p>在 VM 内部执行：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 启用所有 DevStack 服务的开机自启</span>
sudo systemctl <span class="hljs-built_in">enable</span> <span class="hljs-string">'devstack@*'</span>
</code></pre>
<blockquote>
<p>✅ 这样，VM 启动后，systemd 会自动拉起 Keystone、Nova、Neutron 等服务。</p>
</blockquote>
<h3 data-id="heading-16">3. <strong>（可选）添加健康检查脚本</strong></h3>
<p>创建一个监控脚本 <code>/usr/local/bin/check-devstack.sh</code>：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-meta">#!/bin/bash</span>
<span class="hljs-keyword">if</span> ! systemctl is-active --quiet devstack@keystone; <span class="hljs-keyword">then</span>
    sudo systemctl start <span class="hljs-string">'devstack@*'</span>
<span class="hljs-keyword">fi</span>
</code></pre>
<p>并通过 cron 每分钟检查一次。</p>
<hr/>
<h2 data-id="heading-17">⚠️ 四、注意事项与风险</h2>






























<table><thead><tr><th>风险</th><th>说明</th><th>建议</th></tr></thead><tbody><tr><td><strong>IP 变更</strong></td><td>VM 重启后 IP 可能变化（如果 DHCP）</td><td>使用静态 IP 或更新 <code>local.conf</code> 中的 <code>HOST_IP</code></td></tr><tr><td><strong>数据库损坏</strong></td><td>强制断电可能导致 MariaDB 损坏</td><td>尽量优雅关机；定期备份 <code>/opt/stack/data/</code></td></tr><tr><td><strong>网络重置</strong></td><td>Neutron 的 Linux Bridge/OVS 可能需重建</td><td>DevStack 通常能自动恢复，若不行则 <code>./stack.sh</code></td></tr><tr><td><strong>资源不足</strong></td><td>物理机内存不足导致 VM 无法启动</td><td>确保 Host 有足够资源（建议 ≥16GB RAM）</td></tr></tbody></table>
<h3 data-id="heading-18">ip变更问题解决</h3>
<p>针对ip可能变化，做了以下配置
在 <strong>libvirt/KVM 中绑定 MAC → IP</strong>（适合 KVM 用户）</p>
<h4 data-id="heading-19">步骤 1：获取 VM 的 MAC 地址</h4>
<pre><code class="hljs language-perl" lang="perl">virsh dumpxml devstack-vm | <span class="hljs-keyword">grep</span> <span class="hljs-string">"mac address"</span> <span class="hljs-comment"># 输出：&lt;mac address='52:54:00:a1:b2:c3'/&gt;</span>
</code></pre>
<h4 data-id="heading-20">步骤 2：编辑 libvirt 网络配置（通常是 default 网络）</h4>
<pre><code class="hljs language-arduino" lang="arduino">virsh net-edit <span class="hljs-keyword">default</span>
</code></pre>
<p>在 <code>&lt;ip&gt;</code> 段内添加 <code>&lt;host&gt;</code> 条目：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">network</span>&gt;</span> <span class="hljs-tag">&lt;<span class="hljs-name">name</span>&gt;</span>default<span class="hljs-tag">&lt;/<span class="hljs-name">name</span>&gt;</span> <span class="hljs-tag">&lt;<span class="hljs-name">bridge</span> <span class="hljs-attr">name</span>=<span class="hljs-string">'virbr0'</span>/&gt;</span> <span class="hljs-tag">&lt;<span class="hljs-name">ip</span> <span class="hljs-attr">address</span>=<span class="hljs-string">'192.168.122.1'</span> <span class="hljs-attr">netmask</span>=<span class="hljs-string">'255.255.255.0'</span>&gt;</span> <span class="hljs-tag">&lt;<span class="hljs-name">dhcp</span>&gt;</span> <span class="hljs-tag">&lt;<span class="hljs-name">range</span> <span class="hljs-attr">start</span>=<span class="hljs-string">'192.168.122.2'</span> <span class="hljs-attr">end</span>=<span class="hljs-string">'192.168.122.254'</span>/&gt;</span> <span class="hljs-comment">&lt;!-- 添加这一行 --&gt;</span> <span class="hljs-tag">&lt;<span class="hljs-name">host</span> <span class="hljs-attr">mac</span>=<span class="hljs-string">'52:54:00:a1:b2:c3'</span> <span class="hljs-attr">ip</span>=<span class="hljs-string">'192.168.122.30'</span>/&gt;</span> <span class="hljs-tag">&lt;/<span class="hljs-name">dhcp</span>&gt;</span> <span class="hljs-tag">&lt;/<span class="hljs-name">ip</span>&gt;</span> <span class="hljs-tag">&lt;/<span class="hljs-name">network</span>&gt;</span>
</code></pre>
<h4 data-id="heading-21">步骤 3：重启网络</h4>
<pre><code class="hljs language-sql" lang="sql">virsh net<span class="hljs-operator">-</span>destroy <span class="hljs-keyword">default</span> virsh net<span class="hljs-operator">-</span><span class="hljs-keyword">start</span> <span class="hljs-keyword">default</span>
</code></pre>
<hr/>
<h2 data-id="heading-22">📌 五、最佳实践总结</h2>





























<table><thead><tr><th>操作</th><th>命令/配置</th></tr></thead><tbody><tr><td><strong>1. VM 开机自启</strong></td><td><code>virsh autostart devstack-vm</code></td></tr><tr><td><strong>2. DevStack 服务自启</strong></td><td><code>sudo systemctl enable 'devstack@*'</code></td></tr><tr><td><strong>3. 启用 journald 持久化</strong></td><td><code>sudo mkdir -p /var/log/journal</code></td></tr><tr><td><strong>4. 使用静态 IP</strong></td><td>在 VM 网络配置中固定 IP</td></tr><tr><td><strong>5. 关机前优雅停止</strong></td><td>在 VM 中执行 <code>./unstack.sh</code>（可选但推荐）</td></tr></tbody></table>
<blockquote>
<p>💡 <strong>理想流程</strong>：<br/>
物理机关机 → VM 自动保存状态（或优雅关机）→ 物理机开机 → VM 自动启动 → DevStack 服务自动恢复 → 一切如常！</p>
</blockquote>
<hr/>
<h2 data-id="heading-23">✅ 最终答案</h2>
<blockquote>
<p><strong>物理服务器关机再开机后：</strong></p>
<ol>
<li>
<p><strong>虚拟机不会自动启动</strong>（除非你配置了 <code>autostart</code>）</p>
</li>
<li>
<p><strong>DevStack 服务不会自动运行</strong>（即使 VM 启动了）</p>
</li>
<li>
<p><strong>你需要手动：</strong></p>
<ul>
<li>启动虚拟机</li>
<li>在 VM 中启动 DevStack 服务（<code>sudo systemctl start 'devstack@*'</code>）</li>
</ul>
</li>
<li>
<p><strong>为避免每次手动操作，建议配置：</strong></p>
<ul>
<li>VM 开机自启</li>
<li>DevStack 服务开机自启</li>
</ul>
</li>
</ol>
</blockquote>
<p>这样，重启物理机后，DevStack 环境就能“无缝恢复”了！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[前端性能优化之CSS篇]]></title>    <link>https://juejin.cn/post/7575655132755591187</link>    <guid>https://juejin.cn/post/7575655132755591187</guid>    <pubDate>2025-11-23T13:03:58.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7575655132755591187" data-draft-id="7575442779039350826" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="前端性能优化之CSS篇"/> <meta itemprop="keywords" content="前端,JavaScript,性能优化"/> <meta itemprop="datePublished" content="2025-11-23T13:03:58.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="程序员小寒"/> <meta itemprop="url" content="https://juejin.cn/user/694547078987287"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            前端性能优化之CSS篇
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/694547078987287/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    程序员小寒
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-23T13:03:58.000Z" title="Sun Nov 23 2025 13:03:58 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden;color:#2b2b2b;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(159,219,252,.15) 3%,transparent 0),linear-gradient(1turn,rgba(159,219,252,.15) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin-top:35px;margin-bottom:10px;color:#4dd0e1}.markdown-body h1{font-size:30px;text-align:center;position:relative;width:max-content;margin:0 auto}.markdown-body h1:before{position:absolute;content:"";z-index:-1;top:-20px;height:100%;width:100px;left:0;right:0;margin:0 auto;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADsAAAA6CAYAAAAOeSEWAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsQAAA7EAZUrDhsAABkLSURBVGhDtZoHnJ1llcbP3Om9ZiYzmfSQhCQQIbRQVQKI9CYC68qKriJK0UXcZRcINqStIoiIqKCi1NACQihBWiCkkJ5MJlMyvd7p7d759v989/sy34yTbIj48Atz71ff855znvOc971xDrB/EtoGI7a9Z8Aq+wZML0mNj7dE95NZ1OKsj1dHo1GbnJpss9OTbWJyonvun4VP1Njuoagtb+m0it4By0iIt8LEeMvkr8XFWcfgkA1gYDLf47i2PzpsyU7UspKSLDoctagTZ7Vc08MzClMS7awJ2ZaflBB78CeET8TYla1dtrKt2w5KS7YCDGzEoz2RqKUmhGw6x2bhuXyOp2BoRXef1Q1E7Lj8TIsMD1sbxu1kcnYSAX1810RMTUmyMB7f2j1gC7NS7byinNiL/kH8Q8a+2NRh77b32El56VaPAe0YeGR2mh2bm+FdMRqP1rbZe+3dFsHT35qcb/Oz0rwzo7Gxs9feYPLS4kM2h8lawee5hPmlJXneFQeGAzJ2F564v7rFzi7Msu3d/Xgjzq5g8ArX8VCNN2vJ28daey0zZJabmGCLslP5HOf+Oygr3UzDGOf+JxrauXfQjslJt+dbuuyMgiwmk+sPAB/b2Lt2NdoMZnuY21qHIvbvUyZ4Z0ZQiXGrWjvsmPxsK4R0nmHA8ZCTQvxVQn5eRipklIBtcVbV1WtHYsjati47ZWKuTUpP9Z4yGk/xDBGe3v1mW4/dOrvYO7P/2G9jRSjf31FnXyaUXiB8r51WaJkM3kcfOSa2FR6qarIenooTLQHPLcC4mYThyw1tVpKWYlVERlZ8nC3Oz3Jzdn1nn5uvQ8OOHYvhR/CvsqffJbkCkZTvcYZ6Z0WTfTovw5Y1dtjXp+TbFPhgf7FfxpYxuMfr2uwo8rEtMmwXF+d6Z8wGmIR2PLyjo8cqOFffP2SLGexJEJCP9R29thkPXlpa4A5Y3w/jmuVNYYwO2QkY7WMtz3mVcE1hkualJdmSolzX8GnpKd4VZq80d1o7zN0RdWxGaqItgbn3B/+vsasgh/UMNBOvzYMZDxtDKp289KGaVguFQvb1yQWWwuB97GaSXqUUnVaYbSUwrDCEBz/C2CM8EhNrP13fbkeSh3OJgCAe2N1CWXKsGOc6TOr5U4q8MwYhDtkTda02MyPN+nnGBQEH7A37NHYz5KOZVv08qyjbSseEzKauPnsMj98wc6Ibcj5UUv7M8QWZTE52jEwGOVaD8U1Dw1YNWX0qM8VKyb80L/TrOPYOzH4KBJQTrK8M7+7KZjuM63sHBt17FubGoibCuf+tarWFGUmuwWeT8/vCXo1tZOYeZcazCaez8MwEzzM+HqhqtiJI5twxL1jeGLYk7jmKMF1JOCbg6Qj5nAdRqX7q3BYm8VAmQvW1lfcMc58IT95uIA3q+gftrDHPXUXJWkVEHJme5Bp5UmHsvIZ/O3l8ECE/FWcsItX2hr0ae8O2Wjs+J43QTbOZzGYQ/7Wtxq6eXjRK3r0By4YJ6Ty8EiYSJqcm2eGeV4Pox/ANENJR49RiEdfqcLflUJrEBZqgxYHrBjn2ExFURqKdVETN9YirJxKxR2rbrYeQv5ISmB6IsiDGNfZGWPeMgkzr58xnPaJ5p6XDZPKz4T77wayJ7jGhhXLwanOHTWBgq5n5q6YUwNJ7l3kKcRl7OJ7fF56l1GzvHbSD8dghTPi0wIRfv6XafjJ3ssv0PnZQ7nZx/etwzO1zJ3lHR2OETTw8x0tOx1AN3De0D7YV+63oGthjaJQ5Ur7eVVZjcdGInUyuaT73ZWg3efV8fZs7cc2E777Qi5eunVbghvPPymrt/krKGfcLd8ybYjdxrK6333Z09rjHZkNuLYzz0uIc+xWCZzz8nbHbe4dsY1e/XUOY+nimvtUaSazv4jXhaQasSbmYmpuenGwHZ8TKggSEQm08rMD7ahBOoExcMqXQegjnZ+CEvaEa1ZQUQkt39dj0zDS7krq+ARmpdws/nlNqD9WFbWN7l5u3wr9MyrcXKUsqWy3jTOaoML4DdaQ83YIoT4VYpEXvYQZLmbX5SLohBrgOj186Kc/iKTUPUhq+Rrm5ekOl3TWv1Mr6hqwbY0VOQXwEo+Moq4Z47q5qsU489G944LyJOW4LOLZOKtT/iI6+nGe/0dhuEd4ltj2NmiuCU4hnk5fHIi7+RK4uTEu0e+s7rAiRcw1CYy3OejvcYz+eXeI9MYY9nu3lYZl0KavJJ7Vjibzgjp319rUZE20j7CkJqFr5JQYgQ39f3eQaKpQk0afy8nl4uBzvjUUTRk7k3iebOm0pabDiyFn2XGu3dRME41CGVeBVqSiVnc6hIUpekp1VjHLDSOEcQlui5W/U8C7IKREjv1Gabw3wRwUTvpv7jybPtzHmIPZ49q6KRjuccqBQVCOtGvqXhrCFUUXJzOYSHt7Kw5Ix9H08dSje1o1JyL73IYXpEMmE5CRbw6wuykx2pR+Pd6/J4JpLiJKV6N9OnrcQNfQ0Zem6qQX2MmFXyWTE+DMO0kGx4e08DEjnXbsYuOq7niHB8jdY/wQ8Srm2XCZZUrOakF1CY5EKX0h93Tu/1J4kRdbDMT8MamgZK9xe3uDcvrPe++Y4f61rcZr7B53rN1c5N2ytcV5rCrvHt3T2Og19g+5nH7dvq3bqunr4NOwgK2MHA1jeEDuG7HNuLmtw7qpocl5t6nCPvdTQ7v4N4u3WTqeyu9cZHIo4f6lqdFoHh7wzMbzDeeGv3Hvzjlrnh2W1zofhHuftxpFn3VFe7zxS0+p0DlKVPbhhvBxhvwiFMgfP+mjHA08gEC4pybeLyK1iZldh8zC5VJQyUl8l59KZ0WJk2xaiYWxNrkXXJhA8r3PvZRur7ZZZRfadaRPsfiTmX9HGajC2tXd6V8dQTMhX0h8rNdJx9Ra8F8SbRNLzhPRnJmTZIUTYueTyWxyr7uv3rjC3OkzE8495oS+4xq6D5WoI0bO5WVCOSerl8rIeBrOI/Hkaw6ME5W1zSuzx2la3CRdWi3zIG+FDBvUp9LMgI/vggUmE7KkT81yGvOOgEYa/aUahhRAF5xLec3OzbF1r2O17BbVxIi7hzJIC64IYhXdJA+nh/5xVbOmE9J0QqjSxWk0pp37M2YEtgjS8GpimACu7xkqxdKJ6fEXyYl2Lre0ZtC8yELVewtWUnbfCPIhrvgDFz8WI5yhJKgcnFMZWEFrwhgzo5uWDDDA1oGSOzcu0xfx7vTlsv6posIMpJ6cGWPiw/BxL4PU7vbrpjgf8bMdu5OYwOdhm83DARUSa0ELknYIeEAaILuWxlhGa0M8+EuJCrpJT+ymENhN60pXBxa3LZ5TsucnlGaCmIEQ4Evru91yuz0xMtKaeXluI5zdh9Mm8vAlBn4aR07X64EH3vEKdXQkZJXPP/JxMvNRpLxEtHZ5RQgmNewnpouvVTpYTHdfOnmy5kFUGnpRTfEhXD9DiBdFFJB0/YWS9aj6pmc89r0BaQmgTRkgI+EsdKsYasJZOBF+QqTH474NK7LbyBvf7W+RgOxNyxfQY2/2hrp2+NkroxrzrQ55fSZkpJIa28znCgF6rb7H1hOSslATyvNflAh9pvHcX3lVE/Ya8FjTJIexa2Rq77nfU96unTnD7aME3+TAm6BFKYrPnqCNIqV5sq0ZGCiEV+Db+qWMQqpFgb5KPx48R6omeDl2EuP9DTYt9iGA/f1KBS1w/La+H4ktsSmLItvZHXLUkrCeflVtJ9DVVg1H7+sxiGvVM975rZpfabuqHVhuP5F1vewav5O8GamUe91yDanoYw47FWzC929O+DJnKA2opFY1Rjru5CE7kOcO0jJtQVUIynzuZEMeb+1CEOFXN8iFSGeRpCm1BTlJxVg49Azm819SO7Bu0axEbwn27GuxMck+TMQHDP8fn48gfDVIL4R8xKVPJ73MQBUIfA/Z54LMw5vmlE+w+VFo2A78X/SsyPA/RMD0z3e2qVLtfo7aeBslpMX0N0TEnLcUlKym1jyBFqSohmYntI5enBhYB9CY/2kNarhwJhNiMtRGyWnkQdKaCFyQwgydjyNUw4VchKxXv2/DoKdC+lkQbCX1NlKCGvJiBJkSGbCus6jfo4yGBNySgr+u7e20BCsxdVAcFlJ/tHd32+cIsNxSXUULUUx+dg/d47g7OPYFw2MxkSuyMwLHVTI6PBN6dS8Sppw45zHJSgDXV3aQzmz40Z6fDgBfiAXU0uZxby2zejee+j3eltoQMzhV6qSBogXwrEXDj7ElWxUQ8RrnSaoU0dxIsKaiMvMykXTu90NqJsGHP4z78SdLigUrLKat32nFwy/E07pfDFRdQ/7N5r57pQ1482uvWhMGhQcviGkVrKDUp0ToCxfhQal5n4Hs/g1jOgH4LWdwFOd1b1WzHET4vLZppv+Czjxo840OrDlG8jAJzv2tp5mLK1dsU/lfIOeWy5NxFxfl2BoYImlQtx9QF6mJRQKBsQYYuO2yaLYPBUXvu/VqYPxtHhNy7Y4hCkNLGPtKSklzCVKSHtMQxcqm5Kw1DhI2PTGZtcGDAvoLQ/u7MifYtWFBlxz2H9zo8RkwKzC5UYiG+p44ccqE62YAxLeT/TOpf8MXx8Qk0IJFRY1Go+viQVJpE5Ehjf49xfAZeqGIy/7us3nqxwQfCkjZypPxobVr/6YpQHIalUvuCyEwbSXC9PC8QnkFcXlrgLpoLIhIfKuaqlQkYIAwQnr/f3eyu7KttOw2lNpv8/BPHyjzVNER3o72gvEBKqRMTflndbP8BMweRDyeciEj5bFayFXqTLzheivgYJC0jwzwHa0MDDEotm48ndze5BBBElAnxxcRYHAFh3FfZaA9UNRmC354kNwUx8eHkmVj5dcTE5ZMnuEyr1QqlhtaJLuOYZv4v3KNo0TKrGPUZ1NILPKuWcvVn5Trv10SMB6h0j/ARMnlOuafCBIfnSWEx/Raif3HDzofYMM31dOyY9LBaLK3TjoX2fEqT4+2qaUVWSTQvyM6wC8nNJyEetXIyuLKrx04P7MKNnbJZlKUtNAIHo7i2dA/YU3Vtdi5l6jCepXy8hOedSSSsI8/HQg5Q+gxTKXwkMHkbESo+hjG0lbRRzQ3Fc5LOzDuFhs3Ptumpie7ilRDhlEJOq/hjsZljCxjkt7fWuPS/EekpXMggJQIk0G+eN9Xu2VmHWIkJe0nJRN4ptBBit2yutG9ML7J1DHAxebiAMrZ4VZlduqGS8I2tJc2iborUxmIN79c+kTovFxivPvrcSaP3n7RSKYTUmKt4N3rMOcw4JOneD3sP956jNaMglIeTER5Xbdlt15Tm2W10NEsYrA/N5JLCHHsR9tSqwxq08G3bqm1ZTbOtagnbo6SLvH/VzBL7W7jPzqFea0LmMLFzUuLtdwumuO3i1Vtq7OK15Xgw3l1PDmIXak+6QBEkvB9YJIzBcc/L20JIYaSZ/qAzVm5Ut4oowk3QehC+N3xo/1wTqt7zsYawfX9no9XjqdPXVLhrwyo/wucJYQkE1e4j8rLcBuHUItQQKqgMXb6LGvxFQlXw33AdZLR0V5P9Fr29lP73scNnosoyvdWPv4fPJ+uJrLVtMakqaL1M1cTvv0OLIZE6wk2a2IcIRUQh+DaejpdcXepBa7bKDRGM9PIVxTl2EwarZ72rooVuY4RQtMypdk6e1lLLehhY2lt7QEd7WxlCDvdIli6E9B4+ZIodmZEMccUGqgiZOqru9tkR3iJ8nCcXRWRZCSPMLPEjlx2LjQL1OM5qKAm+vhSuRqSfV5Ttrg8FdWcrnhMqCTex7DEM6qTsVEuM1+8hovaHQ6e6a1Fz0xLd3nUt4ToWWuzWNkhcoAIIjUx2ZpxjLzWF9+SYmngR1lok4TEoJxGfuijhI/7OICoFmadl2llcL9b1oRVJtbD+JLlv1KrhHG5811t9ELbzgk14ICUwqE+TDzftqHPz98vUSy3jSIwP8dCpkNqLDPTx+rArz4T5qLG3G2PrvJKKPoLBWE501NC3ilUX5mVjVIb9nIbgWcpPMiSXjbcL8K62UkR86m1/yfkSeMaHFuK04X0CE3J6SWzFUxw0BSNHlSzi3RmIRJwHq5udO3c16quLp6sbnffbupxbt+12vzOrzuvNHc7ycRbIxuJHgYU7YSASdQgxp7qz2ynv6HJeqW91doa7nLruXof+17sqhhu31Xif9o7HalqczV29Dnrb/f5EXZvzdH27U98/6LR5i3N0UM5zjHU71/lwjRWWltU5CAIn7F1MqLp/r9hQ5RoaxG+qmrxP4yNKcfsFLwuiprffeb2l03m2scO5h3Or2rudzjGrhk8x4Cqu2xcexilBvNEcdi5Yu4tKF3Ue4tzPy+td5/1md4tzw5iJ27NuXEYobYUdlb8z6GTWkdxaCvk2zHjd5mpKQ459mv5TkAp6mQb9Aq9HHQ8S6mrZnuc6vUG6WHusIhCJGNXl9byvnJyaiE7+Eoz8c5TYNQiUveENGpJpcIJ+biS8R0+rlcazGNs7pKB+zPLTOSX2KNWhlDAf4r2Spj72JORB5OyHULX+dlD/FOky/HFy5ygYU0sey/i8moeqdunXK1qC3RuaMOYHlI/raQMl3M+EeTV5WxD3Km8a8PkM8nr648sQ9+esKbf5e/nxiKBfAOQkxbv3SU9LYmqPV9V/Pn+V20VwTyVjTqCI6edEQUOFUXs9WmfSll8DyX2dt7GlnwkswaM3l9XZ0oNK3MTXbxpOV2sGk69s6XCJw4cY8KbyRrt9TrHt7Bm0rRBQe1+fHUWNfaapU0KbqxzbORC1M/LS3dJwIl3KOrwykQG/E+61q+isgniztdOKqNOziDgZqZIzFwPvqGiyg5NCtoCqoG5NxHhPZTOsnORulKskjoKMDeLuXQ3OmnC3syxARFXdfc57LR3OrdtrvSOOs55rnqhtcdoGhpxHdjc5EfJUuHZTlftX+G15rXPlhkrnLe59F7Lz8VGHdg8c5y2OLeMZ126qduq9XC3v7nd+FchLvYPJd15gPCu8XQnh/qpm59WGVudZzvvQO97kXTcGxhnEuJvR39tWY8cwK4uhcikk4a3Gdstg9l5B2t0wfaTdWkEou5vCPOV5PH73vFL3+DfXltnh6OxjkJD6Wd5F3g88tMe6CW/7YmI99VIL4u0oqUK8ocW4d8hFrXMVoOQU8s3U97MnjvDD/XRYkyhHM1MT3GVZQR2Tdv70U8EbA5vlo+CaPAaaSWoZXm50otGodxQ6L6txGKxzw5ZYORrBsPPrykZKQIy1n8bTjwb2fO4Te3ue7x6KOKvaYns1wtIddd4nx3mwot55qyl2360cp81zurg+CGqwU8v4/Of5uAVvPgObrwvHomY8jOtZ4fXWLnefdHVXv9044+8ZklCx75DXwcV1Sb27y+vInUQEuVYSaMgRJYfAwtoj0raFxIUW1A8nz35f02qLc9Lc9lG7CBkwtUR7bf+A+5uL6ehnH9Lat+5sIEfj3Cbj3NKRvP7Rjlo7FSmqavKvpSP8MRZ7NVbQYLSkqlC9ZW4sPH18gBTcORjrhMWmQWzFmK2UsvO90qQ1oZcI8UhkCLZPtRqMy0NirobAvjIpb4/sW06qKGyPR2oGIdlazjOOTk+kLYzaaYGSp63Wz6HsXsQ51wd+LTAuZOy+8GBNq7tF+IOdDU4kENJthNID5YRafZtzZ3mDs9LbRgzixcZ2l1h83OKFbDmEd0/FiFp7DWHgp0AQGzq6nf8hPF+oa3EehOz0ziCWcm4NpBRMhX1hn571oR9wqVVSDVPtUi32sQ0vbu7scZdY9aOt2ZSEL9BEBIW+dv20AKDd9/ep09oimYqHpyImkKDuRllS4PrlHNuIqDmCJmNJQba7q1joEaUQJuR/WdXsLrJrq/L6cdJsPOyXscJ7GLKqo8cOpqhrO//yQG6oS3kZwS9xPkRB3wi7diFMtDN+PLk5m1ath+8f0Fy80dbjhvVXub+U5mEqeal27UP+dWpPlknNxW79Ak6/7Tg3UMOF52j1xA1qK7Trd6nXC+8P9ttYQcumIonLSnJtBdJNa77axw1C2x3qR4Wqnj73x9f6MbV+CCYFBZO6y51aSh3gzVrsmwzJnULEbCJC1oZ7vIZ/9Iqmfvn2u5oWO5n8fApxcuWUApum5diPgY9lrA9EtvUNOzYf8vqAcJPsU5iOh7XtXQgt2uZhjKU2amF7HQyfEYWcZk5yQ1RDKNrLcq02k/9IGmldrB93KiokPw8EB2SsoKWXO5FmxXhlckqi+3vEUvLqwok5PHVkIWAszlqzy1p54zuLpnPZ3q9bod08JlLSb5DrNxDm38Sbvsg5EBywsT7oH+3XNW3uasGirFSrxRNdCllKiPZHZzJYLZb5qEcpae3pxMCuu9oibS5/QCOiLcYUrp+MmtJeURjFdVlxzqiae6D4h40NQt54HyGv3JRo10aVfv8YhtC0pSlVKcPFuxIXahr08mzCO4VzMlLSsZuomZ+RaucU0rXsw/sfF5+osUFonWob/7TrLdaUgdpV93fl9X+VIC0Y6tek2uI8OD3J5gT2Vj9ZmP0f4IM4iY7RQ5gAAAAASUVORK5CYII=) no-repeat 50%;background-size:64px 64px;opacity:.84}.markdown-body h1:after{position:absolute;content:"";width:150%;left:-25%;height:50%;bottom:12px;border-radius:50%;background:linear-gradient(transparent 80%,rgba(77,208,225,.8));background-size:400% 200%;opacity:.6;animation:h1Animate 6s linear infinite}@keyframes h1Animate{0%{background-position:100% 100%}50%{background-position:100% 50%}to{background-position:100% 100%}}.markdown-body h2{display:block;border-bottom:4px solid #4dd0e1;position:relative;font-size:24px;padding:12px 32px;margin:30px 0}.markdown-body h2:before{width:24px;height:24px;left:0;top:0;margin:auto;background-size:24px 24px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAADGklEQVRYR81X32vTYBQ999s6mFjQgQ+DrbHiVFZYU4cDcQ/6pGhTFVYFEXGi82H+Bz448UnEF1Fx9ccEEcXpZE3d5tP2ooKiTacTHaLNpigMHDgnU9tcSbrWrkwWR0sbyEOSe885ObnfvV8IRT6oyPwoLQHBx+OVM5WJvSyEVAhnBOjt7yU/+/rr6r6l8TMO+F/EN0JQhICqQpD/xaRpcpAc9tS+M+9lBCia/oqBamK+zeDuQogQZaKJk3wcQjxSva7tGQGB2Ke1zIk3DNyMyNL+QpCnMQOaPsDAVuGAp9cjvbYc8Ec/bCYSg0zoiHilk1tHxqsqEsYlML4kjIpT/eurJxRNPweQU5VdrWaOEo1fgKAVbBgXIz73kF3R/ph+ghgdzMYWM29eAWlBJqgZaFlFYtC6nhWpaDqnSGlIlV1WjJ3DloDNgyNLncudqgX//Ucg3LxuStHGuhi8pqKCW3rqV342rwFjRznKm+/LNaN2yC237ThgF2wxcfMLeP6+ncrKzoPoKTGeLQbYbg4TNoC5iZPJY5HGVRdSNZAWYBclD3FzBQzrR8hACAKdzBzKA/4/IYioDQaOskBbpEG6PO8qKKSAEi3CnEb0Pw4oMf0OmKbTDWqh3Lw6EIiNBZi5lxh3wz4puBD5ovqAMvxhHSdFKxE1CQe3m/07TeTX4lcJdAhE+1Sv65Z5P/ByvIGTRowIZ9igbtXnmrOsbTvgj+kHBNMuBu9OdVw8EeU4nC1A0cYmAHZOTRrLhra4Z8ywnSN6vZHAFTA2WnnMfQB3qz73ddsOZM8CACFDIPSgQXqebXEgqgeZcAeEe6pXasm1f8ew3igMtAHWac0Uc/jYdyAaP0xEBwFsmgUPqbJ0NE2UKj4EGcahiOzuyhagaHpnmtgcVgTcCMuua7YdyAHbA3ArQNscVFbb4635aD6fnYaTvxxi9UNP7ddMXaRWVBdAcaLk6bDXPZCNZ9uBXEsDUX1T2Cc9yjig6Z0EHg3LK8/aqf6MwJKchkXfks1+0+JtSq3qLPa23BRR1B+T/6nkfMaW1r9hPt/MLtYfTLEpP+T9FNoAAAAASUVORK5CYII=)}.markdown-body h2:after,.markdown-body h2:before{content:"";display:block;position:absolute;bottom:0}.markdown-body h2:after{right:0;width:400px;height:10px;border-top-right-radius:24px;background:linear-gradient(90deg,#fff,#4dd0e1);max-width:50vw}.markdown-body h3{margin:30px 0;font-size:18px;position:relative;padding:4px 32px;width:max-content}.markdown-body h3:before{border-bottom:2px solid #4dd0e1;width:100%;content:"";display:block;height:28px;position:absolute;left:0;top:0;bottom:-2px;margin:auto;background-size:28px 28px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABRklEQVRYR2NkGGDAOMD2M4w6YDQERkNg+ITAppcfY/8zMv3wF+NdTUrZQpUQ2PT6cz8Dw/8CkMWMDIwNvqK8jcQ6gmIHNN19EaXPx1XPyMCghrCUKcpPlGc5MY6gyAE+Fx52MjL8j3cU5a1UYWXtZGBkEAVb+p8hxU+Mby5NHQCxnKEMaskzJ37uFmUetkmMjAzrfUX4woixHBJlZAA0y2EmPPYU4enLkhGeQIqRJDsAh+UgO7duNpD3IcVykkOA2paT5ABaWE60A2hlOdEO8D3/4CMDIyMfWvySFefoaYSoROh74eFXBgYGLiTNVLGc+BC48PAnAwMDG9QBVLOcaAd8P5ox+x/jf5AjGLgYfnwnKqv9/8/PwPO/kFF/MSj0cAKiouD/0bgYoixFU8RovWgJIX1EOYCQIZTIjzpgNARGQ2DAQwAAvHBaIdB7zxsAAAAASUVORK5CYII=);background-repeat:no-repeat;animation:h3AnimationBefore 2s infinite alternate}@keyframes h3AnimationBefore{0%{width:28px}25%{width:100%}50%{width:100%}to{width:100%}}.markdown-body h3:after{content:"";display:block;width:28px;height:28px;position:absolute;border:2px solid #4dd0e1;border-radius:50%;right:-15px;top:0;bottom:0;margin:auto;background-size:28px 28px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABRklEQVRYR2NkGGDAOMD2M4w6YDQERkNg+ITAppcfY/8zMv3wF+NdTUrZQpUQ2PT6cz8Dw/8CkMWMDIwNvqK8jcQ6gmIHNN19EaXPx1XPyMCghrCUKcpPlGc5MY6gyAE+Fx52MjL8j3cU5a1UYWXtZGBkEAVb+p8hxU+Mby5NHQCxnKEMaskzJ37uFmUetkmMjAzrfUX4woixHBJlZAA0y2EmPPYU4enLkhGeQIqRJDsAh+UgO7duNpD3IcVykkOA2paT5ABaWE60A2hlOdEO8D3/4CMDIyMfWvySFefoaYSoROh74eFXBgYGLiTNVLGc+BC48PAnAwMDG9QBVLOcaAd8P5ox+x/jf5AjGLgYfnwnKqv9/8/PwPO/kFF/MSj0cAKiouD/0bgYoixFU8RovWgJIX1EOYCQIZTIjzpgNARGQ2DAQwAAvHBaIdB7zxsAAAAASUVORK5CYII=);animation:h3AnimationAfter 2s infinite alternate}@keyframes h3AnimationAfter{0%{transform:rotate(0)}10%{transform:rotate(0)}50%{transform:rotate(-1turn)}to{transform:rotate(-1turn)}}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:15px}.markdown-body h6{margin-top:5px}.markdown-body p{line-height:inherit;margin:22px 0;letter-spacing:2px;font-size:14px;word-spacing:2px}.markdown-body img{max-width:80%;border-radius:6px;display:block;margin:20px auto!important;object-fit:contain;box-shadow:0 0 16px hsla(0,0%,43.1%,.45)}.markdown-body figcaption{display:block;font-size:13px;color:#2b2b2b}.markdown-body figcaption:before{content:"";background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgBAMAAACBVGfHAAAAGFBMVEVHcExAuPtAuPpAuPtAuPpAuPtAvPxAuPokzOX5AAAAB3RSTlMAkDLqNegkoiUM7wAAAGBJREFUKM9jYBhcgMkBTUDVBE1BeDGqEtXychNUBeXlKEqACsrLQxB8lnCQQClCiWt5OYoSiAIkJVAF5eVBqAqAShTAAs7l5ShKWMwRAmAlSArASpAVgJUkCqIAscESHwCVVjMBK9JnbQAAAABJRU5ErkJggg==);display:inline-block;width:18px;height:18px;background-size:18px;background-repeat:no-repeat;background-position:50%;margin-right:5px;margin-bottom:-5px}.markdown-body hr{border:none;border-top:1px solid #4dd0e1;margin-top:32px;margin-bottom:32px}.markdown-body del{color:#4dd0e1}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:rgba(77,208,225,.08);color:#26c6da;padding:.195em .4em}.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace;overflow:auto;position:relative;line-height:1.75;box-shadow:0 0 8px hsla(0,0%,43.1%,.45);border-radius:4px;margin:16px}.markdown-body pre:before{content:"";display:block;height:30px;width:100%;margin-bottom:-7px;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAAAdCAYAAABcz8ldAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAhgSURBVGhD7Zp7bBTHHcdn33t7vvOdzy+ITVKDU0xIKG2ABCPTRCCaUiEVKWoqRJuASAhCitRCVKSoalFUKZBiSmmFRRJKRUnUtIpo+aNqGgwoOCmuFUIRzxjwE4zte+97drYzztji8HPvtkit/PnH+n1397Tz+83vN/PbMZhmmmmm+d+BoX8n5diihcGqgFQf5vk6BMAskWUlw3GyFnIvtqWSf91w7mKC3npfOLX7wYeiIa6BBWCOLLFRF2NB0JvIOP/80YG+k2ev6S699b/OzOfKBW5l5KsgyC4DCFQDnpEAdE1goc/dlNPc/Up7P711UiYNSMuyxeUzZPnHgGHWh5XADEkSAcdiN+AnEXIBhBComgFU0/xQR+jnj51sOUMf9Z0NKyL8S9+JPBEN8zuCMrsqGOA5QWAAyzLAxe53HBeYFgJp1c5Cx33nyIfpV3e+22/Sx32nev/sMCgVnmM4bjOniAtZWQAsz315EfsGQQc4hgWcjHkCmOj1rheuNn95cXwmDMiVp5etC/D8m5FwUWVQUYYGPh6mZYFUOgsGVa1pXvOZzVT2jRuH54RM230jEuI3RcIiL4l4UkxAJmuD/riVsqD7ct2m9nep7BtVTbVfZ0uE/UIk+CQflAHDjf8+Lg6MldYATGpH3c/Ul7p3dWXppVGM6eElJSHmnQWPbSlRlN1lJcUBjqNRnwJZVQO3B5P/uq5rK1d90pakckFcaKp5UJHY92JR8YlwkUDVySEZfGfQdO7E7Z8s2HL9TSoXTPXRud9nA8IBqSwcZgWeqpPj6BYw7yTbXBN9q2v9lQEq5zBmWA8vWLCptCi4tzwW8RQMQlFQATPLSh6vCSh/plJBkMyQBHZfWYnkKRgEktEVpTJXERN2Xzo4ex2VC6K6qXYpF5b3ypVRT8EgcAERSJXRbwCBOTFzXblM5RxGBaRt+ZPYA+LO0mgxz5K1Ig+UgAzKIuGnz39z6S+olDeaibaXRsU1RUFvgx+GwTWgPCaDgMw2XXpr9gwq50XV0bkxJiYeEiNF5cwE5XsiOEkAUkXkUW51SSOVchjl8WKef604XFSRbzCGCYeCoESStv/p8QU1VPIM3knNDynctnBRfsEYhgSlNCIGgQv2UCkvGIHZgteMh1nBW9W4F16RAM6yDVV7amZTaYQcr59cuuhhWRTWBvAMLxQGeyFSHOLnh0MvUskz5RF+fbRYDEy0mZgqQYUHOLhr//b6rGoqeaLqQG0pw3PrBbyA+4EQUkRmhvgqNUfICUipKK4OKUqIJVPKB0jpEhjmWWp64jdbKmVZZNYogcJm493gsifOqhDyeh9GYR/FM7sW+DA5CKR0MSK3tvKZkpwB5gRE4tjFEr7RL0iWBGV51vHFCyupNGWWPqLgnoer9mtyEGSJAzwLllDTGzyznDjRN/CwOFkoFb4bm0eVIXICgpvdGoEvrF7fC89zfLkkeV5HbOhWiTwTpKYvCAJLGshRdXtKMKAWlyxq+MPQLk1h66g5RE5ABJYNFrqY3wvJklJRUKg5ZWLFXIA86yek2uDOPkBNb3CM5Pf7DL2QyIrUGiLH+xC5Bmmm/ARnHUhC6PnzxWDK0RH5HuIjZGy27erU9AZ0dTIWXyG+NpBBrSFySxZw220IqeUPFoS6jVAPNadM7yDsgNB1qOkLuAziMYIb1PQGA75wIaKGPyAb+9oF16g5RE5ALIQ+tSyLWoWDEAK6aXW3JlK9VJoyx1oyvVkNdvo5KXXDAVkdnaKmNwx0xjH98w3JNmTCm+Bc9hKVhsgJSI9pvp9Vdd++jmq6AXB2/HHrhcs5aTkVDv0DFzoHvKdq/mQsKX/4t7KJLDpOJW+IbAvMGoMkxfwAWZB8DT7W1diTE+WcgKz6pK1bs6z3daPwmJDsSKt6ZsCyjlLJMz0DsDGZ8SdlDROBjOb8YeWOjptU8kTXusuaazu7oJrfEnQvdkpVcUn6PTVHyAkIIW7br/Unklni0EJIZ1WgGsauZR+fvUglz6zY0dGfVp09ybRNlfwgi3k8YSbvJJ29VMoLt9v6rZVQL7hOYUubndHJGclBtzn1byqNMCogi09/2nFb01/oj+f/5TyjauBOKtPcZ1r7qZQ3f2lRfxZPWi2anp8TSDAGExZMa2jr8u03L1M5L7q3Xc+iAeuHRl/ScvPcjSLDBnZS/cjtNHd2v3171Ewbs9N5q7Pn4otVMx3btBsCsoRbk1FxG5dMVgMDqfTpXl1/tuFMa5zKefPROdX59qLQBwLnNog8Wy1OcjB1N+QEsW/QsFNZuO35Xb1v98QLX4/Sx+O3wqujrQ6013ABUWI8+AaqBjAH01+ghL22+5X2PirnMG7r+esbnae/V1neauvGSoHjigTcVU7UGFm2DeK4ttxKpQ+mLPvl+o/PjnkAkw9HTqSMmVHhyAMx9iFcSh/BHTfLceO/C8mKjApBf9zszGhoY92m9sN+BGOY9AeD7eGniv8OTaOB4dgyTsQd9wS+IQu4lciYdkI7CLrNH3Rvbb9FL41i0tbzVP2iWJkobpN5fmM4IJfJskTP1Bk8A9HQmbpmGDBrWqdVCN/Yd7PjxKGOXn+bmbto3feVVcVB9qehIL8EJy8nChwgr0O2xxBnhGU5eP2CfYbl/m4gBRsbtneMORP9oGpjpcCsiKzHHfdOPiQ/wMniyFEu2dbiTQCAeN/vavC466BGYLttXc9fmXBXMGlAhiHHur+sq6uPiUI9z7CVHMPwBnLSuuN8FuC48/Oaz1ylt94XfrW5ouyprwWfYRkwNyCyYYjwkBHows1fa+tV/fzGxlv39b9gqvfPmQ+i/HK8KlcBjhHwfl8HEHyOd1JnuzZd66S3TTPNNNP8/wDAfwDG7G0m9LKBpwAAAABJRU5ErkJggg==) 10px 10px no-repeat;background-size:40px}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{color:#4dd0e1;border-bottom:1px solid #4dd0e1;font-weight:400;text-decoration:none;margin:0 4px}.markdown-body a:active,.markdown-body a:hover{background-color:rgba(77,208,225,.1)}.markdown-body strong{color:#26c6da}.markdown-body strong:before{content:"「"}.markdown-body strong:after{content:"」"}.markdown-body em{font-style:normal;color:#4dd0e1;font-weight:700}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:rgba(77,208,225,.05)}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{margin:2em 0;padding:24px 32px;border-left:4px solid #26c6da;background:rgba(77,208,225,.15);position:relative}.markdown-body blockquote:before{content:"❝";top:8px;left:8px;color:#4dd0e1;font-size:30px;line-height:1;font-weight:700;position:absolute;opacity:.7}.markdown-body blockquote:after{content:"❞";font-size:30px;position:absolute;right:8px;bottom:0;color:#4dd0e1;opacity:.7}.markdown-body blockquote p{color:#595959;line-height:2}.markdown-body ol,.markdown-body ul{color:#595959;padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">1、前言</h2>
<p>当涉及到网站的性能优化时，CSS 的优化是一个非常重要的方面。如果你的 CSS 太复杂，那么你的网站可能会像一个<strong>慢吞吞的乌龟</strong>一样缓慢地加载和渲染，影响<strong>用户的留存</strong>、<strong>网站的转化率</strong>以及<strong>网站的体验和传播</strong>等，所以对于 CSS 优化还是非常需要的，本文将介绍一些 CSS 性能优化的技巧，帮助你在编写 CSS 代码时提高性能。</p>
<h2 data-id="heading-1">2、前置知识</h2>
<h3 data-id="heading-2">2.1 CSS 解析规则</h3>
<p>我们一般书写 CSS 选择器都是从左往右书写的，所以自然就会以为 CSS 选择器是从左往右去匹配渲染的，但其实不是这样的，<strong>CSS 选择器是从右往左去匹配的</strong>。</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.header</span> <span class="hljs-selector-tag">div</span> <span class="hljs-selector-tag">span</span> { 
  <span class="hljs-attribute">color</span>: red;
}
</code></pre>
<p>比如上面的 CSS 样式匹配查找过程是这样的：</p>
<ol>
<li>先找到所有的 <code>span</code> 元素。</li>
<li>从第一个 <code>span</code> 元素开始，沿着 <code>span</code> 元素的父级元素查到 <code>div</code>，最后沿着 <code>div</code> 的父级元素找到所有的 <code>.header</code>，找到满足条件的节点就加入到结果集中。</li>
</ol>
<h3 data-id="heading-3">2.2 CSS 的加载过程</h3>
<p><strong>简述浏览器的渲染过程</strong>：在拿到 html 文件后，浏览器会调用 html 解析器解析 html 文件，构建 DOM 树和 CSSOM 树，然后 DOM 树和 CSSOM 树合并成渲染树，最后浏览器会根据渲染树进行布局和绘制，最终将页面呈现给用户。</p>
<p><strong>CSSOM 的构建</strong>：当浏览器解析 html 文档时，如果遇到 <code>&lt;link&gt;</code> 或 <code>&lt;style&gt;</code> 标签，会开始下载和解析 CSS 文件，构建 CSSOM。在 CSSOM 构建完成之前，浏览器不会渲染任何已处理的内容，即使DOM已经解析完毕。</p>
<ul>
<li>CSS 不会阻塞 <code>DOM</code> 的解析，但会阻塞 <code>DOM</code> 的渲染。</li>
<li>CSS 不会阻塞 <code>Javascript</code> 的下载，但会阻塞 <code>JavaScript</code> 的执行，因为 <code>JavaScript</code> 可以操作样式，所以需要等 <code>CSSOM</code> 构建完成之后，才能执行 <code>JavaScript</code>。</li>
</ul>
<p>所以从这里就可以得到以下优化思路：。</p>
<ul>
<li>将一些<strong>体积小的首屏关键 CSS</strong> 内联到 <code>html</code> 文件中，加快首屏渲染速度。</li>
<li>将 CSS 放在 <code>&lt;head&gt;</code> 中，确保尽早加载。</li>
<li>使用媒体查询（如 <code>media="print"</code>）使 CSS 非阻塞渲染。</li>
<li>在生产环境中，考虑使用 preload（如 <code>&lt;link rel="preload" as="style"&gt;</code>）在不阻塞渲染的情况下加载非首屏的 CSS 资源。</li>
</ul>
<h3 data-id="heading-4">2.3 CSS 权重优先级</h3>
<p>CSS 选择器类型的优先级从低往高依次是：</p>
<ol>
<li><strong>类型选择器</strong>（比如 <code>h1</code>）和<strong>伪元素选择器</strong>（比如 <code>::before</code>）。</li>
<li><strong>类选择器</strong>（比如 <code>.header</code>）、<strong>属性选择器</strong>（比如 <code>[type="checkbox"]</code>）和<strong>伪类选择器</strong>（比如 <code>:hover</code>）。</li>
<li><strong>ID 选择器</strong>（比如 <code>#box</code>）。</li>
<li><strong>!important</strong>：优先级最高。</li>
</ol>
<h2 data-id="heading-5">2、CSS 加载性能优化</h2>
<h3 data-id="heading-6">2.1. 提取公共的 CSS 文件</h3>
<p>如果使用<code>webpack</code>进行项目打包，在打包阶段可以使用<code>mini-css-extract-plugin</code>提取公共 CSS 文件，便于缓存以及减少 CSS 请求次数。</p>
<h3 data-id="heading-7">2.2 避免使用 @import</h3>
<ul>
<li>使用 <code>@import</code> 会阻塞浏览器的并行下载，导致加载速度变慢。</li>
<li>多个 <code>@import</code> 会导致下载顺序紊乱。</li>
</ul>
<h3 data-id="heading-8">2.3 压缩 CSS 文件</h3>
<p>压缩 CSS 文件可以减小文件大小，从而加快加载速度。比如可以用<code>optimize-css-assets-webpack-plugin</code>配合<code>mini-css-extract-plugin</code>使用来优化和压缩 CSS 文件。</p>
<h3 data-id="heading-9">2.4 使用浏览器缓存</h3>
<p>可以使用浏览器缓存来缓存 CSS 文件，从而在页面加载时加快速度。可以设置适当的缓存时间来确保文件在必要时能够更新。</p>
<h3 data-id="heading-10">2.5 使用 CDN 加速</h3>
<ul>
<li>使用 <strong>CDN（内容分发网络）</strong> 可以将 CSS 文件分发到全国各个 <code>CDN</code> 节点的服务器上，用户可以就近下载，从而加快加载速度，也可以减少自己服务器的负载。</li>
<li>如果静态资源很多，可以准备多个静态服务器域名，比如域名是 <code>static.xx.com</code>，做成支持 <code>static0-5</code> 的 6 个域名, 也就是 <code>static0.xx.com、static1.xx.com、static2.xx.com...</code>，每次请求时随机选一个域名地址进行请求，这样可以绕过浏览器同域名的连接数限制（一般是限制 6 个），6 个域名就可以同时发送 36 个连接请求。当然，这个域名个数不是越多越好，太分散的话又会涉及到多域名无法缓存静态资源的问题。</li>
</ul>
<h3 data-id="heading-11">2.6 使用 CSS Sprite</h3>
<p><strong>CSS Sprite</strong> 技术就是我们常说的<strong>雪碧图</strong>，通过将多张小图标拼接成一张大图，能有效的<strong>减少HTTP请求数量</strong>以达到加速显示内容的技术。</p>
<h3 data-id="heading-12">2.7 CSS 样式抽离和去除无用 CSS</h3>
<ul>
<li>平时开发过程中可以将一些<strong>可复用</strong>的 CSS 抽离到一个单独文件中，减少 CSS 代码冗余。</li>
<li>在打包构建时可以利用一些插件去除没有用到的 CSS，相当于对 CSS 进行 <code>Tree shaking</code>，减少打包后体积。</li>
</ul>
<h3 data-id="heading-13">2.8 合理使用内嵌 CSS</h3>
<p><code>内嵌CSS</code> 也就是通过元素的 <code>style</code> 来书写行内样式，比如 <code>&lt;div style="color: red"&gt;&lt;/div&gt;</code>，它的优缺点如下：</p>
<p><strong>优点</strong>：</p>
<ul>
<li>与使用 <code>link</code> 标签相比，可以减少 CSS 的 <code>http</code> 请求量。</li>
</ul>
<p><strong>缺点</strong>：</p>
<ul>
<li>增加 <code>html</code> 文件的体积。</li>
<li>使用 <code>link</code> 标签能很好的利用浏览器的缓存，而内联样式放在 <code>html</code> 里面，能否使用缓存需要看 <code>html</code> 文件的缓存策略。</li>
</ul>
<p>综合它的优缺点，我们可以选择将一些<strong>体积小的首屏关键 CSS</strong> 内联到 <code>html</code> 文件中，加快首屏渲染速度。</p>
<h2 data-id="heading-14">3、CSS 选择器性能优化</h2>
<h3 data-id="heading-15">3.1 避免使用通配符选择器</h3>
<p>通配符选择器<code>*</code>符号可以匹配任何元素，但是这会导致浏览器需要遍历整个文档树来查找匹配的元素，从而降低性能。</p>
<h3 data-id="heading-16">3.2 使用子选择器代替后代选择器</h3>
<p>后代选择器（如 <code>.parent .child</code>）会检查所有后代元素，而子选择器（如 <code>.parent &gt; .child</code>）只检查直接子元素，匹配范围更小，性能更好。</p>
<h3 data-id="heading-17">3.3 优先使用类（Class）和 ID 选择器</h3>
<p>类选择器（如 <code>.box</code>）和 ID 选择器（如 <code>#box</code>）匹配速度更快，因为它们直接指向特定元素。避免标签选择器（如 <code>div</code>）或属性选择器（如 [type="text"]），后者匹配更加宽泛，效率较低，尤其在大型 DOM 中。</p>
<h3 data-id="heading-18">3.4 避免深层嵌套的选择器</h3>
<p>前面也说过，CSS 选择器需要从右往左去匹配的，嵌套的选择器如 <code>.header div ul li a</code>，因为浏览器需要遍历更多 DOM 节点。建议限制选择器深度在 3 层以内，使用更直接的类或 ID 选择器，如 <code>.box</code>。这能减少匹配时间。或者使用 <code>BEM</code> 命名规范，比如 <code>.block__element--modifier</code>，提高匹配效率。</p>
<p>另外在使用 ID 选择器的时候，前面就需要加上父级的选择器，比如不推荐用 <code>.box #content</code>，推荐用 <code>#content</code>。</p>
<h2 data-id="heading-19">4、CSS 属性性能优化</h2>
<h3 data-id="heading-20">4.1 避免使用过于复杂的属性</h3>
<p>过于复杂的属性会增加浏览器的渲染负担，从而降低性能。应该尽量使用简单的属性来实现需要的样式效果，比如下面这些属性：</p>
<ul>
<li><strong>box-shadow</strong>：box-shadow 属性可以实现盒子的阴影效果，但是它会增加浏览器的计算和渲染成本。如果要实现一个简单的边框效果，可以使用 <code>border</code> 属性来替代。</li>
</ul>
<pre><code class="hljs language-css" lang="css"><span class="hljs-comment">/* 不推荐使用 */</span>
<span class="hljs-selector-class">.box</span> {
  <span class="hljs-attribute">box-shadow</span>: <span class="hljs-number">2px</span> <span class="hljs-number">2px</span> <span class="hljs-number">2px</span> <span class="hljs-number">#888</span>;
}

<span class="hljs-comment">/* 推荐使用 */</span>
<span class="hljs-selector-class">.box</span> {
  <span class="hljs-attribute">border</span>: <span class="hljs-number">1px</span> solid <span class="hljs-number">#888</span>;
}
</code></pre>
<ul>
<li><strong>filter</strong>：filter 属性可以实现图像的滤镜效果，但是它会增加浏览器的计算和渲染成本。如果要实现一个简单的颜色变换效果，可以使用 <code>background-color</code> 属性来替代。</li>
</ul>
<pre><code class="hljs language-css" lang="css"><span class="hljs-comment">/* 不推荐使用 */</span>
<span class="hljs-selector-class">.box</span> {
  <span class="hljs-attribute">filter</span>: <span class="hljs-built_in">grayscale</span>(<span class="hljs-number">50%</span>);
}

<span class="hljs-comment">/* 推荐使用 */</span>
<span class="hljs-selector-class">.box</span> {
  <span class="hljs-attribute">background-color</span>: <span class="hljs-number">#ccc</span>;
}
</code></pre>
<p>不过需要注意的是，这些替代方案可能会有一些<strong>局限性</strong>，无法完全取代原来的属性。因此，在使用这些替代方案时，需要根据具体的需求和情况进行选择。</p>
<h3 data-id="heading-21">4.2 避免使用不必要的属性</h3>
<p>不必要的属性会增加 <code>CSS</code> 文件的大小，从而降低加载速度。应该尽量避免使用不必要的属性。</p>
<h3 data-id="heading-22">4.3 避免使用 !important</h3>
<p><code>!important</code> 会覆盖其他样式，从而增加渲染时间。而且它不容易被替换或覆盖，后期可维护性也比较差，更好的方式使用更具体、更准确的选择器来定义样式。</p>
<h2 data-id="heading-23">5、CSS 动画性能优化</h2>
<h3 data-id="heading-24">5.1 使用 transform 和 opacity 属性来进行动画</h3>
<p>使用 <code>transform</code> 和 <code>opacity</code> 属性可以减少浏览器的渲染负担，从而提高性能。</p>
<h3 data-id="heading-25">5.2 避免使用过于复杂的动画效果</h3>
<p>过于复杂的动画效果会增加浏览器的渲染负担，从而降低性能。应该尽量使用简单的动画效果。</p>
<h3 data-id="heading-26">5.3 在动画中使用 will-change 属性</h3>
<p><code>will-change</code> 属性可以告诉浏览器哪些属性将要被改变，从而提前进行优化，减少渲染负担。</p>
<h3 data-id="heading-27">5.4 使用 requestAnimationFrame() 函数来优化动画</h3>
<p><code>requestAnimationFrame()</code> 函数可以在浏览器下一次渲染之前执行代码，从而减少渲染负担，提高性能。</p>
<h2 data-id="heading-28">6、CSS 渲染性能优化</h2>
<h3 data-id="heading-29">6.1 使用 class 合并 DOM 的修改</h3>
<p>比如我们需要根据不同情况给一个元素添加不同的样式，可能会写出如下的代码：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> el = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">'.box'</span>);
<span class="hljs-keyword">if</span> (isHover) {
  el.<span class="hljs-property">style</span>.<span class="hljs-property">color</span> = <span class="hljs-string">'red'</span>;
  el.<span class="hljs-property">style</span>.<span class="hljs-property">background</span> = <span class="hljs-string">'blue'</span>;
} <span class="hljs-keyword">else</span> {
  el.<span class="hljs-property">style</span>.<span class="hljs-property">color</span> = <span class="hljs-string">'blue'</span>;
  el.<span class="hljs-property">style</span>.<span class="hljs-property">background</span> = <span class="hljs-string">'red'</span>;
}
</code></pre>
<p>这时候我们可以定义两个 <code>class</code> 类，然后直接切换类名即可。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> el = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">'.box'</span>);
<span class="hljs-keyword">if</span> (isHover) {
  el.<span class="hljs-property">classList</span>.<span class="hljs-title function_">remove</span>(<span class="hljs-string">'normal'</span>);
  el.<span class="hljs-property">classList</span>.<span class="hljs-title function_">add</span>(<span class="hljs-string">'hover'</span>);
} <span class="hljs-keyword">else</span> {
  el.<span class="hljs-property">classList</span>.<span class="hljs-title function_">remove</span>(<span class="hljs-string">'hover'</span>);
  el.<span class="hljs-property">classList</span>.<span class="hljs-title function_">add</span>(<span class="hljs-string">'normal'</span>);
}
</code></pre>
<h3 data-id="heading-30">6.2 让 DOM 元素脱离文档流</h3>
<p>使用 <code>absoulte</code> 或者 <code>fixed</code> 定位让 DOM 元素脱离文档流，这样在修改 DOM 元素的时候不会影响到其他 DOM 元素的布局，从而提高渲染性能。</p>
<h2 data-id="heading-31">7、总结</h2>
<p>本文主要通过<strong>CSS 加载性能优化</strong>、<strong>CSS 选择器性能优化</strong>、<strong>CSS 属性性能优化</strong>、<strong>CSS 动画性能优化</strong>和<strong>CSS 渲染性能优化</strong>这些方向介绍了 CSS 的性能优化技巧。通过优化 CSS 性能，可以提高网站的性能和用户体验。</p>
<p>在实际开发中，可根据实际业务场景和需要去进行优化。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[devstack中的systemd管理介绍]]></title>    <link>https://juejin.cn/post/7575182522411679782</link>    <guid>https://juejin.cn/post/7575182522411679782</guid>    <pubDate>2025-11-23T13:07:22.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7575182522411679782" data-draft-id="7575456858426916910" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="devstack中的systemd管理介绍"/> <meta itemprop="keywords" content="OpenStack"/> <meta itemprop="datePublished" content="2025-11-23T13:07:22.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="哈里谢顿"/> <meta itemprop="url" content="https://juejin.cn/user/3678304397695056"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            devstack中的systemd管理介绍
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3678304397695056/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    哈里谢顿
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-23T13:07:22.000Z" title="Sun Nov 23 2025 13:07:22 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>理解 <strong>systemd</strong> 以及它在 <strong>DevStack</strong> 中的作用，对于掌握现代 Linux 系统和 OpenStack 开发环境至关重要。下面我们将从基础到深入，系统性地讲解：</p>
<hr/>
<h2 data-id="heading-0">🧱 一、systemd 是什么？</h2>
<p><strong>systemd</strong> 是 Linux 操作系统中一个<strong>现代化的初始化系统（init system）和服务管理器</strong>，用于：</p>
<ul>
<li>启动操作系统（替代传统的 SysV init 或 Upstart）</li>
<li>管理系统服务（启动、停止、重启、监控）</li>
<li>处理设备挂载、日志、定时任务、网络配置等</li>
</ul>
<blockquote>
<p>💡 简单说：<strong>systemd 是 Linux 系统的“总管家”</strong>，负责从开机到关机的所有核心进程管理。</p>
</blockquote>
<h3 data-id="heading-1">✅ 主要特性</h3>

































<table><thead><tr><th>特性</th><th>说明</th></tr></thead><tbody><tr><td><strong>并行启动</strong></td><td>服务可并行加载，加快开机速度</td></tr><tr><td><strong>按需启动（socket activation）</strong></td><td>服务在被访问时才启动（如 SSH）</td></tr><tr><td><strong>依赖管理</strong></td><td>自动处理服务之间的依赖关系</td></tr><tr><td><strong>统一日志（journald）</strong></td><td>所有服务日志集中管理（<code>journalctl</code>）</td></tr><tr><td><strong>资源控制（cgroups）</strong></td><td>限制 CPU、内存、IO 使用</td></tr><tr><td><strong>服务状态监控</strong></td><td>自动重启崩溃的服务</td></tr></tbody></table>
<blockquote>
<p>📌 几乎所有主流 Linux 发行版（Ubuntu ≥16.04, CentOS ≥7, Debian ≥8）默认使用 systemd。</p>
</blockquote>
<hr/>
<h2 data-id="heading-2">🔧 二、DevStack 早期 vs 现代：为什么引入 systemd？</h2>
<h3 data-id="heading-3">🕰️ 早期 DevStack（2015–2021）：使用 <code>screen</code>/<code>tmux</code></h3>
<ul>
<li>所有 OpenStack 服务（nova-api、keystone、neutron-server 等）以<strong>独立进程</strong>方式运行</li>
<li>进程由 <code>stack.sh</code> 脚本直接 fork 启动</li>
<li>日志输出到 <code>/opt/stack/logs/*.log</code></li>
<li>使用 <code>screen -r stack</code> 查看各服务窗口</li>
</ul>
<h4 data-id="heading-4">❌ 缺点：</h4>
<ol>
<li><strong>进程管理混乱</strong>：没有统一的启停机制</li>
<li><strong>崩溃不自动恢复</strong>：服务挂了不会自动重启</li>
<li><strong>日志分散</strong>：需要手动 tail 多个文件</li>
<li><strong>权限/环境隔离差</strong>：所有服务以 <code>stack</code> 用户运行，无 cgroups 隔离</li>
<li><strong>不符合生产实践</strong>：真实生产环境都用 systemd 管理服务</li>
</ol>
<hr/>
<h3 data-id="heading-5">✅ 现代 DevStack（Yoga 版本起，默认启用 systemd）</h3>
<p>从 <strong>OpenStack Yoga（2022.1）</strong> 开始，DevStack 默认启用 <code>USE_SYSTEMD=True</code>，将每个 OpenStack 服务注册为 <strong>systemd unit</strong>。</p>
<p>例如：</p>
<ul>
<li><code>devstack@keystone.service</code></li>
<li><code>devstack@nova-api.service</code></li>
<li><code>devstack@neutron-server.service</code></li>
</ul>
<h4 data-id="heading-6">✅ 优势：</h4>

































<table><thead><tr><th>优势</th><th>说明</th></tr></thead><tbody><tr><td><strong>标准化</strong></td><td>与生产环境部署方式一致（如 Kolla、Charmed OpenStack 也用 systemd）</td></tr><tr><td><strong>健壮性</strong></td><td>systemd 可自动重启崩溃的服务（通过 <code>Restart=always</code>）</td></tr><tr><td><strong>日志集中</strong></td><td>使用 <code>journalctl</code> 统一查看、过滤、导出日志</td></tr><tr><td><strong>资源隔离</strong></td><td>可通过 systemd 配置限制内存/CPU（未来扩展）</td></tr><tr><td><strong>依赖清晰</strong></td><td>服务启动顺序由 <code>After=</code>、<code>Wants=</code> 显式定义</td></tr><tr><td><strong>启停方便</strong></td><td><code>systemctl start/stop devstack@keystone</code></td></tr></tbody></table>
<blockquote>
<p>💡 这让 DevStack 从“开发玩具”向“贴近生产”的开发环境演进。</p>
</blockquote>
<hr/>
<h2 data-id="heading-7">🏗️ 三、DevStack 如何使用 systemd？</h2>
<h3 data-id="heading-8">1. <strong>服务单元文件生成</strong></h3>
<p>当你运行 <code>./stack.sh</code> 时，DevStack 会为每个服务动态生成 systemd unit 文件，例如：</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># /etc/systemd/system/devstack@keystone.service</span>
<span class="hljs-section">[Unit]</span>
<span class="hljs-attr">Description</span>=Devstack keystone
<span class="hljs-attr">After</span>=network.target mariadb.service rabbitmq-server.service

<span class="hljs-section">[Service]</span>
<span class="hljs-attr">Type</span>=simple
<span class="hljs-attr">User</span>=stack
<span class="hljs-attr">WorkingDirectory</span>=/opt/stack/keystone
<span class="hljs-attr">ExecStart</span>=/opt/stack/keystone/bin/keystone-wsgi-public --port <span class="hljs-number">5000</span>
<span class="hljs-attr">Restart</span>=always
<span class="hljs-attr">RestartSec</span>=<span class="hljs-number">5</span>

<span class="hljs-section">[Install]</span>
<span class="hljs-attr">WantedBy</span>=multi-user.target
</code></pre>
<h3 data-id="heading-9">2. <strong>服务启停流程</strong></h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 启动 Keystone</span>
sudo systemctl start devstack@keystone

<span class="hljs-comment"># 停止</span>
sudo systemctl stop devstack@keystone

<span class="hljs-comment"># 查看状态</span>
sudo systemctl status devstack@keystone

<span class="hljs-comment"># 设置开机自启（DevStack 不需要，但机制存在）</span>
sudo systemctl <span class="hljs-built_in">enable</span> devstack@keystone
</code></pre>
<blockquote>
<p>🔍 注意：<code>@</code> 符号表示这是一个 <strong>模板化服务（instantiated service）</strong>，<code>keystone</code> 是实例名。</p>
</blockquote>
<hr/>
<h2 data-id="heading-10">📊 四、systemd vs 传统日志对比（DevStack 场景）</h2>



































<table><thead><tr><th>功能</th><th>传统模式（非 systemd）</th><th>systemd 模式</th></tr></thead><tbody><tr><td><strong>日志位置</strong></td><td><code>/opt/stack/logs/keystone.log</code></td><td><code>journalctl -u devstack@keystone</code></td></tr><tr><td><strong>实时跟踪</strong></td><td><code>tail -f keystone.log</code></td><td><code>journalctl -u devstack@keystone -f</code></td></tr><tr><td><strong>按时间查询</strong></td><td>需配合 <code>grep</code> + 时间戳</td><td><code>--since "1 hour ago"</code></td></tr><tr><td><strong>导出日志</strong></td><td>直接复制文件</td><td><code>journalctl -u ... &gt; keystone.log</code></td></tr><tr><td><strong>多服务对比</strong></td><td>需开多个终端</td><td><code>journalctl -u devstack@nova-api -u devstack@keystone</code></td></tr></tbody></table>
<hr/>
<h2 data-id="heading-11">⚙️ 五、如何控制 DevStack 的 systemd 行为？</h2>
<h3 data-id="heading-12">1. <strong>禁用 systemd（回到传统模式）</strong></h3>
<p>编辑 <code>~/devstack/local.conf</code>：</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-section">[[local|localrc]]</span>
<span class="hljs-attr">USE_SYSTEMD</span>=<span class="hljs-literal">False</span>
</code></pre>
<p>然后重新部署：</p>
<pre><code class="hljs language-bash" lang="bash">./unstack.sh
./clean.sh
./stack.sh
</code></pre>
<blockquote>
<p>⚠️ 注意：新版本 DevStack 可能逐渐弃用非 systemd 模式。</p>
</blockquote>
<hr/>
<h3 data-id="heading-13">2. <strong>调试 systemd 服务</strong></h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 查看服务详细状态（含最近日志）</span>
systemctl status devstack@keystone

<span class="hljs-comment"># 查看服务的 unit 文件内容</span>
systemctl <span class="hljs-built_in">cat</span> devstack@keystone

<span class="hljs-comment"># 重新加载 systemd 配置（修改 unit 后需要）</span>
sudo systemctl daemon-reload
</code></pre>
<hr/>
<h3 data-id="heading-14">3. <strong>临时覆盖配置（无需改 DevStack 源码）</strong></h3>
<p>创建 override 目录：</p>
<pre><code class="hljs language-bash" lang="bash">sudo systemctl edit devstack@keystone
</code></pre>
<p>输入自定义配置（例如增加环境变量）：</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-section">[Service]</span>
<span class="hljs-attr">Environment</span>=KEYSTONE_DEBUG=<span class="hljs-literal">True</span>
</code></pre>
<p>保存后自动生效（相当于创建了 <code>/etc/systemd/system/devstack@keystone.service.d/override.conf</code>）。</p>
<hr/>
<h2 data-id="heading-15">🌐 六、为什么这对 OpenStack 开发者重要？</h2>
<ol>
<li>
<p><strong>贴近真实环境</strong><br/>
生产 OpenStack 部署（如 RDO、Mirantis）几乎都用 systemd 管理服务，DevStack 保持一致可减少“在我机器上能跑”的问题。</p>
</li>
<li>
<p><strong>更好的调试体验</strong><br/>
<code>journalctl</code> 支持结构化日志、时间范围过滤、优先级筛选，比 <code>grep</code> 日志文件高效得多。</p>
</li>
<li>
<p><strong>服务生命周期管理标准化</strong><br/>
你可以用熟悉的 <code>systemctl</code> 命令控制任何 OpenStack 服务，无需记忆 DevStack 特有脚本。</p>
</li>
<li>
<p><strong>为容器化过渡打基础</strong><br/>
systemd 的 cgroups 和资源控制能力，是未来向 systemd-nspawn 或 Podman 迁移的基础。</p>
</li>
</ol>
<hr/>
<h2 data-id="heading-16">📚 七、常见命令速查表</h2>

































<table><thead><tr><th>场景</th><th>命令</th></tr></thead><tbody><tr><td>查看所有 DevStack 服务</td><td><code>systemctl list-units | grep devstack</code></td></tr><tr><td>实时跟踪 Keystone 日志</td><td><code>sudo journalctl -u devstack@keystone -f</code></td></tr><tr><td>查看最近 50 行日志</td><td><code>sudo journalctl -u devstack@keystone -n 50</code></td></tr><tr><td>按时间查日志</td><td><code>sudo journalctl -u devstack@keystone --since "2025-11-23 10:00"</code></td></tr><tr><td>重启 Nova API</td><td><code>sudo systemctl restart devstack@nova-api</code></td></tr><tr><td>检查服务是否开机自启</td><td><code>systemctl is-enabled devstack@keystone</code></td></tr></tbody></table>
<hr/>
<h2 data-id="heading-17">✅ 总结</h2>
<blockquote>
<p><strong>systemd 是现代 Linux 的基石，DevStack 采用它是为了：</strong></p>
<ul>
<li>✅ <strong>标准化</strong>：与生产环境对齐</li>
<li>✅ <strong>健壮性</strong>：自动重启、依赖管理</li>
<li>✅ <strong>可观测性</strong>：集中日志（journalctl）</li>
<li>✅ <strong>可维护性</strong>：统一的服务控制接口</li>
</ul>
</blockquote>
<p>虽然初期可能需要适应 <code>journalctl</code> 而不是 <code>.log</code> 文件，但从长远看，这大大提升了开发和调试效率。</p>
<blockquote>
<p>💡 <strong>建议</strong>：拥抱 systemd！学习 <code>journalctl</code> 的高级用法（如 <code>-o json</code>、<code>_PID=</code>、<code>PRIORITY=</code>），你会爱上它。</p>
</blockquote>
<p>如果你正在开发 OpenStack 插件或调试服务崩溃问题，systemd + journald 组合将是你最强大的助手！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[提示词工程没死，只是藏得更深了]]></title>    <link>https://juejin.cn/post/7575425466905247807</link>    <guid>https://juejin.cn/post/7575425466905247807</guid>    <pubDate>2025-11-23T13:12:26.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7575425466905247807" data-draft-id="7575458028254838827" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="提示词工程没死，只是藏得更深了"/> <meta itemprop="keywords" content="人工智能"/> <meta itemprop="datePublished" content="2025-11-23T13:12:26.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="飞哥数智谈"/> <meta itemprop="url" content="https://juejin.cn/user/3825956195409223"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            提示词工程没死，只是藏得更深了
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3825956195409223/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    飞哥数智谈
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-23T13:12:26.000Z" title="Sun Nov 23 2025 13:12:26 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>今天给大家分享一个 AI 起名从“平庸”到“惊艳”的过程，并聊聊<strong>少样本提示</strong>的使用感悟。</p>
<p>事情是这样的，下午，我在家鼓捣一个可以帮我更好地使用 AI 助手的小工具。</p>
<p>忽然发现虽然已经开发挺久了，但却一直没有设计名字，就叫做“AI助手”，没有辨识度，也体现不了独特性。</p>
<p>今天有空，就和 AI 聊聊，让它帮我起个好名字。</p>
<p>中文语言相关的问题，我还是更喜欢通义的脾性，以下内容都是使用通义官网完成的。</p>
<h2 data-id="heading-0">第一轮的对话</h2>
<p><strong>指令</strong></p>
<pre><code class="hljs">我想要实现一个应用，辅助各种AIagent的使用，请帮我设计应用名称，想要突出ai助手的助手这个点
</code></pre>
<p><strong>结果</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/82e742e05fed4442a2bd56dfa1a8ffbd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aOe5ZOl5pWw5pm66LCI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764508345&amp;x-signature=egIoyjTOXldk3Gdn3RYHZT1fVtU%3D" alt="" loading="lazy"/></p>
<p><strong>小结</strong></p>
<p>先不说给我提供了这么多的英文名称，就最后的几个中文名称，我感觉也只能算是没有语法错误。</p>
<h2 data-id="heading-1">有感悟的第二轮对话</h2>
<p>接下来就是比较重要的第二轮对话。</p>
<p><strong>指令</strong></p>
<pre><code class="hljs">上次我要做的碎片知识管理工具，给出的“集萤”，就非常惊艳，这些有些普通
</code></pre>
<p><strong>结果</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/22ac81d41df7431b97f783f0c8a74996~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aOe5ZOl5pWw5pm66LCI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764508345&amp;x-signature=gf6Xud7qh%2Bfpo00cgV1cjcHAXhM%3D" alt="" loading="lazy"/></p>
<p><strong>小结</strong></p>
<p>可以看到，给出的结果已经开始符合我的预期了，但是还需要再稍微调整下。</p>
<h2 data-id="heading-2">微调的第三轮对话</h2>
<p>这一轮对话没有特别需要注意的地方，仅仅是为了保持过程的完整性，大家可以直接跳到后面的感悟部分。</p>
<p><strong>指令</strong></p>
<pre><code class="hljs">辅辰这思路挺好，低调和高调结合，但是辰和AI相关度不是特别大， 能否再优化下
</code></pre>
<p><strong>结果</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/35c4830eeaa647d99ae9ff378fa3d510~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aOe5ZOl5pWw5pm66LCI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764508345&amp;x-signature=1A2Jpf7HMGMMjUyBGQzIEjNf%2BjE%3D" alt="" loading="lazy"/></p>
<p><strong>小结</strong></p>
<p>最后，我选择了“<strong>辅曜</strong>”。</p>
<p><strong>每个 AI 都在发光，而我帮你沐浴光辉</strong>。</p>
<p>保持“诗意隐喻 + 功能内核”的风格。</p>
<p>命名喜好，仁者见仁，但最后结果挺符合我心意的。</p>
<h2 data-id="heading-3">感悟</h2>
<p>大家可以对比下第二轮和第一轮的对话，核心就是我找了一个喜欢的<strong>示例</strong>（集萤），同时把示例的<strong>背景</strong>（碎片知识管理工具）交代清楚。</p>
<p>这样，AI 就会自动分析<strong>背景知识和取名结果之间的推导思路</strong>，进而生成符合我预期的名称。</p>
<p>这个过程很像我们小时候从一堆数里面找规律，然后推导下一个数，现在的 AI 已经可以从非常复杂、高维的角度推导出规律来了。</p>
<p>我倒是知道，<strong>现在 AI 的底层是统计、是概率，但谁又能说只有人类的思维方式才是“智能”呢</strong>？</p>
<p>另一个感悟的点是关于提示词的。去年，“提示词工程”大火，今年模型能力大幅提升后，很多人认为提示词工程不重要了，包括我之前也是这样认为的。</p>
<p>但今天与 AI 的沟通，本质上还是应用了“提示词工程”（<strong>少样本提示</strong>），只是由于模型能力的提升，可以不像去年那么注重格式上的要求了。</p>
<h2 data-id="heading-4">结语</h2>
<p>这两年使用 AI 的过程中，积累了不少这种不起眼，但却很有效果的小技巧，就像很多说不清原理的“<strong>土法子</strong>”一样，我也只是从表面现象上试图解释下。</p>
<p>网上这类资料不是很多，这几天我在想要不要把这类型分享好好整理下，形成一个体系化的合集。大家可以在下面留言告诉我哈~</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[深入Android系统（十三）Android的窗口系统]]></title>    <link>https://juejin.cn/post/7575106644499578914</link>    <guid>https://juejin.cn/post/7575106644499578914</guid>    <pubDate>2025-11-23T13:16:04.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7575106644499578914" data-draft-id="7575363120798466048" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="深入Android系统（十三）Android的窗口系统"/> <meta itemprop="keywords" content="Android,源码,设计模式"/> <meta itemprop="datePublished" content="2025-11-23T13:16:04.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="apigfly"/> <meta itemprop="url" content="https://juejin.cn/user/2488950054453613"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            深入Android系统（十三）Android的窗口系统
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2488950054453613/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    apigfly
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-23T13:16:04.000Z" title="Sun Nov 23 2025 13:16:04 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读19分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><code>Android</code>的窗口系统由<code>WindowManagerService</code>管理，包括增加和删除窗口，确定窗口的大小和位置，以及实现窗口切换、窗口动画等功能。<code>WindowManagerService</code>名字较长，后面简称<code>WMS</code></p>
<h2 data-id="heading-0">前言</h2>
<blockquote>
<p>一个小问题</p>
</blockquote>
<p>在 Android 中<code>Activity</code>可以理解成 Android 中的一个页面，前面的章节我们说 <code>SurfaceFlinger</code> 最后会把 <code>Surface</code> 对应的 <code>Layer</code> 合成到屏幕上。那么<strong>Activity 和 Surface 的关系又是怎么关联的呢？</strong></p>
<p>让我们一起排查下～～～</p>
<h2 data-id="heading-1">应用进程和<code>WMS</code>的联系</h2>
<p>在学习<code>WMS</code>之前，我们先了解下应用和<code>WMS</code>之间的联系。对于应用来说：</p>
<ul>
<li>
<p><code>Activity</code></p>
<ul>
<li><code>Activity</code>并不负责视图控制，它只是控制生命周期和处理事件</li>
<li>真正控制视图的是<code>Window</code>。一个<code>Activity</code>包含了一个<code>Window</code>，<code>Window</code>才是真正代表一个窗口</li>
<li><code>Activity</code>就像一个控制器，统筹视图的添加与显示，以及通过其他回调方法，来与<code>Window</code>、以及<code>View</code>进行交互</li>
</ul>
</li>
<li>
<p><code>Window</code></p>
<ul>
<li><code>Window</code>是视图的承载器，内部持有一个<code>DecorView</code>，而这个<code>DecorView</code>才是<code>view</code>的根布局</li>
<li><code>Window</code>是一个抽象类，实际在<code>Activity</code>中持有的是其子类<code>PhoneWindow</code></li>
<li><code>PhoneWindow</code>中有个内部类<code>DecorView</code>，通过创建<code>DecorView</code>来加载<code>Activity</code>中``传递的布局</li>
<li><code>Window</code>通过<code>WindowManager</code>将<code>DecorView</code>加载其中，并将<code>DecorView</code>交给<code>ViewRoot</code>，进行视图绘制以及其他交互</li>
</ul>
</li>
<li>
<p><code>ViewRoot</code></p>
<ul>
<li>所有<code>View</code>的绘制以及事件分发等交互都是通过它来执行或传递的</li>
<li><code>ViewRoot</code>对应的实现类是<code>ViewRootImpl</code>类，它是连接<code>WindowManagerService</code>和<code>DecorView</code>的纽带</li>
<li><code>View</code>的三大流程：测量(measure)、布局(layout)、绘制 (draw))均通过<code>ViewRoot</code>来完成</li>
</ul>
</li>
</ul>
<p>除了上面这三部分，还有一个是在<code>Android</code>应用中存在的一个唯一的<code>WindowManagerGlobal</code>对象，它们的类图关系如下：<br/>
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d3f91ffc402e497986337eba12df2b94~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgYXBpZ2ZseQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764508564&amp;x-signature=vkLls2NZ4xOy1Jgqwi5BfD6K2Os%3D" alt="image" loading="lazy"/></p>
<h3 data-id="heading-2">应用中的Window对象</h3>
<p>应用中的每个<code>Activity</code>对象都有一个类型为<code>Window</code>的成员变量<code>mWindow</code>，定义如下：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Activity</span> {
    ...
    <span class="hljs-keyword">private</span> Window mWindow;
    ...
}
</code></pre>
<p><code>Window</code>对象在应用进程代表了一个窗口，这是一块矩形的图像绘制区域。</p>
<p>从<code>WMS</code>的角度来说，它并不关系应用中的各种<code>View</code>，他管理和调度的对象是<code>Window</code>。<code>Activity</code>中的<code>View</code>树不管多复杂，最后输出的也仅仅是一张各个<code>View</code>合成的图像而已。</p>
<p><code>Window</code>是一个抽象类，在<code>Activity</code>类的<code>attach()</code>方法中会对成员变量<code>mWindow</code>进行初始化，代码如下：</p>
<pre><code class="hljs language-java" lang="java">    <span class="hljs-keyword">final</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">attach</span><span class="hljs-params">(...)</span> {
        ...
        mWindow = <span class="hljs-keyword">new</span> <span class="hljs-title class_">PhoneWindow</span>(<span class="hljs-built_in">this</span>, window, activityConfigCallback);
        ...
    }
</code></pre>
<p><code>attach()</code>方法中<code>mWindow</code>实例化成了一个<code>PhoneWindow</code>对象。</p>
<p>而对于<code>PhoneWindow</code>对象，需要我们关注的部分是如下两个成员变量：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PhoneWindow</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Window</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">MenuBuilder</span>.Callback {
    <span class="hljs-comment">// This is the top-level view of the window, containing the window decor.</span>
    <span class="hljs-keyword">private</span> DecorView mDecor;
    <span class="hljs-comment">// This is the view in which the window contents are placed. It is either</span>
    <span class="hljs-comment">// mDecor itself, or a child of mDecor where the contents go.</span>
    ViewGroup mContentParent;
    ...
}
</code></pre>
<ul>
<li>
<p><code>mDecor</code>的类型是<code>DecorView</code>，它是<code>FrameLayout</code>的子类，它可以被认为是<code>Android</code>视图树的根节点视图。</p>
<ul>
<li><code>DecorView</code>作为顶级<code>View</code>，它加载的资源文件内部会包含一个<code>android:id="@android:id/content"</code>的<code>ViewGroup</code></li>
<li>这个<code>ViewGroup</code>便是后面用来添加<code>setContentView()</code>方法传入的<code>layout</code>布局文件</li>
<li><code>DecorView</code>具体加载哪种布局文件和主题有关，这部分在<code>PhoneWindow</code>的<code>generateLayout()</code>方法中体现</li>
</ul>
</li>
<li>
<p><code>mContentParent</code>的类型是<code>ViewGroup</code>，它其实就是<code>android:id="@android:id/content"</code>对应的组件</p>
<ul>
<li>跟踪<code>generateLayout()</code>方法就会发现如下代码：</li>
</ul>
<pre><code class="hljs language-java" lang="java">    <span class="hljs-type">ViewGroup</span> <span class="hljs-variable">contentParent</span> <span class="hljs-operator">=</span> (ViewGroup)findViewById(ID_ANDROID_CONTENT);
</code></pre>
<ul>
<li><code>contentParent</code>创建完成后便会赋值给<code>mContentParent</code>，而此处的<code>ID_ANDROID_CONTENT</code>的定义是在<code>Window.java</code>中</li>
</ul>
<pre><code class="hljs language-java" lang="java">    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">ID_ANDROID_CONTENT</span> <span class="hljs-operator">=</span> com.android.internal.R.id.content;
</code></pre>
</li>
</ul>
<h3 data-id="heading-3">应用中的WindowManager对象</h3>
<p>应用中的每个<code>Activity</code>对象都有一个类型为<code>WindowManager</code>的成员变量<code>mWindowManager</code>，定义如下：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Activity</span> {
    ...
    <span class="hljs-keyword">private</span> WindowManager mWindowManager;
    ...
}
</code></pre>
<p><code>mWindowManager</code>用于和<code>WMS</code>通信，不过<code>WindowManager</code>是一个接口类，定义如下：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">WindowManager</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">ViewManager</span> {...}
</code></pre>
<p><code>mWindowManager</code>也是在<code>attach()</code>方法中进行的初始化，相关代码如下：</p>
<pre><code class="hljs language-java" lang="java">    <span class="hljs-keyword">final</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">attach</span><span class="hljs-params">(...)</span> {
        ...
        mWindow = <span class="hljs-keyword">new</span> <span class="hljs-title class_">PhoneWindow</span>(<span class="hljs-built_in">this</span>, window, activityConfigCallback);
        ...
        mWindow.setWindowManager(
                (WindowManager)context.getSystemService(Context.WINDOW_SERVICE),
                mToken, mComponent.flattenToString(),
                (info.flags &amp; ActivityInfo.FLAG_HARDWARE_ACCELERATED) != <span class="hljs-number">0</span>);
        ...
        mWindowManager = mWindow.getWindowManager();
        ...
    }
</code></pre>
<p>在<code>attach()</code>方法中，对<code>mWindowManager</code>变量的赋值是调用<code>mWindow</code>的<code>getWindowManager()</code>方法完成的。</p>
<p>但是在这之前，<code>attach()</code>方法中还调用了<code>mWindow</code>对象的<code>setWindowManager()</code>方法。前面我们已经知道<code>mWindow</code>对象的类型是<code>PhoneWindow</code>，不过这个<code>setWindowManager()</code>方法是在基类<code>Window</code>中实现的，代码如下：</p>
<pre><code class="hljs language-java" lang="java">    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setWindowManager</span><span class="hljs-params">(WindowManager wm, IBinder appToken, String appName,
            <span class="hljs-type">boolean</span> hardwareAccelerated)</span> {
        mAppToken = appToken;
        mAppName = appName;
        mHardwareAccelerated = hardwareAccelerated
                || SystemProperties.getBoolean(PROPERTY_HARDWARE_UI, <span class="hljs-literal">false</span>);
        <span class="hljs-keyword">if</span> (wm == <span class="hljs-literal">null</span>) {
            wm = (WindowManager)mContext.getSystemService(Context.WINDOW_SERVICE);
        }
        mWindowManager = ((WindowManagerImpl)wm).createLocalWindowManager(<span class="hljs-built_in">this</span>);
    }
    <span class="hljs-keyword">public</span> WindowManager <span class="hljs-title function_">getWindowManager</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> mWindowManager;
    }
</code></pre>
<p>在<code>setWindowManager()</code>方法中，调用了<code>WindowManagerImpl</code>类的<code>createLocalWindowManager()</code>方法创建了<code>mWindowManager</code>对象，这个方法也很简单：</p>
<pre><code class="hljs language-java" lang="java">    <span class="hljs-keyword">public</span> WindowManagerImpl <span class="hljs-title function_">createLocalWindowManager</span><span class="hljs-params">(Window parentWindow)</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">WindowManagerImpl</span>(mContext, parentWindow);
    }
</code></pre>
<p><code>createLocalWindowManager()</code>方法中新创建了一个<code>WindowManagerImpl</code>对象，因此，每个<code>Activity</code>中的<code>mWindowManager</code>对象实际上是一个<code>WindowManagerImpl</code>对象，我们再看下这个类的定义：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">WindowManagerImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">WindowManager</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">WindowManagerGlobal</span> <span class="hljs-variable">mGlobal</span> <span class="hljs-operator">=</span> WindowManagerGlobal.getInstance();
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Context mContext;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Window mParentWindow;
    ...
}
</code></pre>
<p>在<code>WindowManagerImpl</code>中定义了一个<code>mGlobal</code>变量，它的值是通过<code>WindowManagerGlobal.getInstance()</code>得到的，看样子是个单例模式，代码如下：</p>
<pre><code class="hljs language-java" lang="java">    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> WindowManagerGlobal <span class="hljs-title function_">getInstance</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">synchronized</span> (WindowManagerGlobal.class) {
            <span class="hljs-keyword">if</span> (sDefaultWindowManager == <span class="hljs-literal">null</span>) {
                sDefaultWindowManager = <span class="hljs-keyword">new</span> <span class="hljs-title class_">WindowManagerGlobal</span>();
            }
            <span class="hljs-keyword">return</span> sDefaultWindowManager;
        }
    }
</code></pre>
<p><code>getInstance()</code>方法中创建了一个全局唯一的<code>WindowManagerGlobal</code>对象并保存到静态变量<code>sDefaultWindowManager</code>中</p>
<p>而<code>WindowManagerImpl</code>中各种方法的实现只是在转调<code>WindowManagerGlobal</code>类中的方法，由此可见，<strong>一个应用中所有<code>Activity</code>都是通过这个进程内唯一的<code>WindowManagerGlobal</code>对象和<code>WMS</code>通信</strong></p>
<p><code>WindowManagerGlobal</code>类中还有3个重要的成员变量：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">WindowManagerGlobal</span> {
    ...
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> ArrayList&lt;View&gt; mViews = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;View&gt;();
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> ArrayList&lt;ViewRootImpl&gt; mRoots = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;ViewRootImpl&gt;();
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> ArrayList&lt;WindowManager.LayoutParams&gt; mParams =
            <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;WindowManager.LayoutParams&gt;();
    ...
}
</code></pre>
<ul>
<li><code>mViews</code>：保存了应用中所有顶层<code>View</code>对象，也就是<code>DecorView</code>(稍后细讲)</li>
<li><code>mRoots</code>：保存的是和顶层<code>View</code>对象关联的<code>ViewRootImpl</code>对象</li>
<li><code>mParams</code>：保存的是创建顶层<code>View</code>的<code>layout</code>参数</li>
</ul>
<h3 data-id="heading-4">建立应用和WMS的联系</h3>
<p>我们知道在<code>ActivityThread</code>中的<code>handleResumeActivity()</code>中会创建<code>ViewRootImpl</code>对象并进行显示，我们来看下<code>ViewRootImpl</code>中关键的几个变量：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ViewRootImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">ViewParent</span>,
        View.AttachInfo.Callbacks, ThreadedRenderer.DrawCallbacks {
    ...
    <span class="hljs-keyword">final</span> IWindowSession mWindowSession;
    ...
    <span class="hljs-keyword">final</span> W mWindow;
    ...
}
</code></pre>
<p>变量的初始化是在构造方法中，代码如下：</p>
<pre><code class="hljs language-java" lang="java">    <span class="hljs-keyword">public</span> <span class="hljs-title function_">ViewRootImpl</span><span class="hljs-params">(Context context, Display display)</span> {
        mContext = context;
        mWindowSession = WindowManagerGlobal.getWindowSession();
        ...
        mWindow = <span class="hljs-keyword">new</span> <span class="hljs-title class_">W</span>(<span class="hljs-built_in">this</span>);
        ...
    }
</code></pre>
<p>重点是进行了<code>mWindowSession</code>和<code>mWindow</code>的创建，我们逐一看下</p>
<h4 data-id="heading-5">IWindowSession对象的创建</h4>
<p><code>mWindowSession</code>变量的类型是<code>IWindowSession</code>，它是<code>WMS</code>中某个<code>Binder</code>对象的引用对象，<code>mWindowSession</code>的值是通过<code>WindowManagerGlobal</code>的<code>getWindowSession()</code>方法获得的，代码如下：</p>
<pre><code class="hljs language-java" lang="java">    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> IWindowSession <span class="hljs-title function_">getWindowSession</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">synchronized</span> (WindowManagerGlobal.class) {
            <span class="hljs-keyword">if</span> (
            `sWindowSession`== <span class="hljs-literal">null</span>) {
                <span class="hljs-keyword">try</span> {
                    <span class="hljs-type">InputMethodManager</span> <span class="hljs-variable">imm</span> <span class="hljs-operator">=</span> InputMethodManager.getInstance();
                    <span class="hljs-type">IWindowManager</span> <span class="hljs-variable">windowManager</span> <span class="hljs-operator">=</span> getWindowManagerService();
                    sWindowSession = windowManager.openSession(
                            <span class="hljs-keyword">new</span> <span class="hljs-title class_">IWindowSessionCallback</span>.Stub() {
                                <span class="hljs-meta">@Override</span>
                                <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onAnimatorScaleChanged</span><span class="hljs-params">(<span class="hljs-type">float</span> scale)</span> {
                                    ValueAnimator.setDurationScale(scale);
                                }
                            },
                            imm.getClient(), imm.getInputContext());
                } <span class="hljs-keyword">catch</span> (RemoteException e) {
                    <span class="hljs-keyword">throw</span> e.rethrowFromSystemServer();
                }
            }
            <span class="hljs-keyword">return</span> sWindowSession;
        }
    }
</code></pre>
<p>如果<code>sWindowSession</code>为空，先获取<code>InputMethodManager</code>对象，然后调用<code>WMS</code>的<code>openSession()</code>接口来进行创建，代码如下：</p>
<pre><code class="hljs language-java" lang="java">    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> IWindowSession <span class="hljs-title function_">openSession</span><span class="hljs-params">(IWindowSessionCallback callback, IInputMethodClient client,
            IInputContext inputContext)</span> {
        <span class="hljs-keyword">if</span> (client == <span class="hljs-literal">null</span>) <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalArgumentException</span>(<span class="hljs-string">"null client"</span>);
        <span class="hljs-keyword">if</span> (inputContext == <span class="hljs-literal">null</span>) <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalArgumentException</span>(<span class="hljs-string">"null inputContext"</span>);
        <span class="hljs-type">Session</span> <span class="hljs-variable">session</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Session</span>(<span class="hljs-built_in">this</span>, callback, client, inputContext);
        <span class="hljs-keyword">return</span> session;
    }
</code></pre>
<p><code>openSession()</code>直接创建了一个<code>Session</code>对象，这个<code>Session</code>类我们<a href="https://juejin.cn/post/6944960866404007944#heading-5" target="_blank" title="https://juejin.cn/post/6944960866404007944#heading-5">图像显示部分</a>简单介绍过，它是一个<code>Binder</code>服务类，简要定义如下：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Session</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">IWindowSession</span>.Stub <span class="hljs-keyword">implements</span> <span class="hljs-title class_">IBinder</span>.DeathRecipient {...}
</code></pre>
<p>对于用户进程而言，获取到的便是这个<code>Session</code>对象的<code>Binder</code>引用对象，并保存在了<code>WindowManagerGlobal</code>的静态变量<code>sWindowSession</code>中。</p>
<p>因为<code>WindowManagerGlobal</code>在进程中属于单例的存在，因此，所有调用<code>getWindowSession()</code>方法返回的都是这个<code>sWindowSession</code>对象</p>
<p>因此，<strong>一个用户进程中的所有<code>ViewRootImpl</code>对象中的<code>mWindowSession</code>都引用的是相同的对象</strong>。而这个<code>mWindowSession</code>对象的作用便是向<code>WMS</code>发起<code>Window</code>相关的<code>Binder</code>调用</p>
<blockquote>
<p>应用进程通过<code>sWindowSession</code>对象可以调用到<code>WMS</code>的功能方法了，那么<code>WMS</code>是如何通知或者控制应用进程的呢？</p>
</blockquote>
<h4 data-id="heading-6">W</h4>
<p>在<a href="https://juejin.cn/post/6944960866404007944#heading-5" target="_blank" title="https://juejin.cn/post/6944960866404007944#heading-5">图像显示部分</a>已经介绍过<code>ActivityThread</code>的<code>handleResumeActivity()</code>方法了，最后会调用到<code>WindowManagerGlobal</code>对象的<code>addView()</code>方法，方法内容如下：</p>
<pre><code class="hljs language-java" lang="java">    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">addView</span><span class="hljs-params">(View view, ViewGroup.LayoutParams params,
            Display display, Window parentWindow)</span> {
        ...
        ViewRootImpl root;
        <span class="hljs-type">View</span> <span class="hljs-variable">panelParentView</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;
        <span class="hljs-keyword">synchronized</span> (mLock) {
            ...
            root = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ViewRootImpl</span>(view.getContext(), display);
            view.setLayoutParams(wparams);

            mViews.add(view);
            mRoots.add(root);
            mParams.add(wparams);

            <span class="hljs-keyword">try</span> {
                root.setView(view, wparams, panelParentView);
            }
            ...
        }
    }
</code></pre>
<p><code>addView()</code>方法中最重要的是创建了<code>ViewRootImpl</code>对象，并通过<code>setView()</code>把它和顶层的<code>View</code>对象关联在了一起。<code>setView()</code>方法简要如下：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setView</span><span class="hljs-params">(View view, WindowManager.LayoutParams attrs, View panelParentView)</span> {
    <span class="hljs-keyword">synchronized</span> (<span class="hljs-built_in">this</span>) {
        <span class="hljs-keyword">if</span> (mView == <span class="hljs-literal">null</span>) {
            mView = view;
            ...
            requestLayout();
            ...
            <span class="hljs-keyword">try</span> {
                mOrigWindowType = mWindowAttributes.type;
                mAttachInfo.mRecomputeGlobalAttributes = <span class="hljs-literal">true</span>;
                collectViewAttributes();
                res = mWindowSession.addToDisplay(mWindow, ...);
            }
            ...
        }
    }
}
</code></pre>
<p><code>setView()</code>方法比较长，我们需要关注的是：</p>
<ul>
<li>方法中对<code>ViewRootImpl</code>对象和顶层<code>View</code>之间的关联只会执行一次，如果<code>mView</code>不为空，不会再次赋值</li>
<li>方法中调用了<code>Session</code>的<code>addToDisplay()</code>方法，更为重要的是参数<code>mWindow</code></li>
</ul>
<p><code>mWindow</code>的类型是<code>W</code>，它是一个<code>ViewRootImpl</code>的静态内部类，定义如下：</p>
<pre><code class="hljs language-java" lang="java">    <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">W</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">IWindow</span>.Stub {
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> WeakReference&lt;ViewRootImpl&gt; mViewAncestor;
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> IWindowSession mWindowSession;
        ...
    }
</code></pre>
<p>可以看出<code>W</code>是一个实现了<code>IWindow</code>接口的<code>Binder</code>服务类，并且在<code>ViewRootImpl</code>中通过<code>Session.addToDisplay()</code>方法将<code>W</code>的<code>Binder</code>引用对象传递给了<code>WMS</code></p>
<p>我们看下源码中对<code>IWindow</code>接口的描述：</p>
<blockquote>
<p>API back to a client window that the Window Manager uses to inform it of interesting things happening.</p>
</blockquote>
<p>可以看出<code>WMS</code>通过<code>IWindow</code>接口来通知应用，接下来看下<code>WMS</code>中是如何处理这个对象的</p>
<p><em><strong>秋地麻袋～，还记得我们前言中的问题吗，快看<code>setView</code>中的<code>requestLayout</code>方法</strong></em></p>
<blockquote>
<p>是不是勾起了作为应用开发者的回忆</p>
</blockquote>
<h4 data-id="heading-7">Surface 和 Activity 的联系</h4>
<p><code>ViewRootImpl.setView()</code> 会触发 <code>requestLayout()</code>，最终执行到核心方法 <code>performTraversals()</code>（这是 View 绘制三大流程 Measure/Layout/Draw 的入口）</p>
<p><code>performTraversals()</code> 800 多行。。。简要代码如下：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 伪代码逻辑 ViewRootImpl.java</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">performTraversals</span><span class="hljs-params">()</span> {
    <span class="hljs-comment">// ...</span>
    <span class="hljs-comment">// 1. 通过 IPC 请求 WindowManagerService (WMS) 对窗口进行布局</span>
    <span class="hljs-comment">// mSurface 是 ViewRootImpl 的成员变量</span>
    relayoutResult = mWindowSession.relayout(..., mSurface, ...);

    <span class="hljs-comment">// 2. WMS 在底层创建 SurfaceControl，并将 Native 层的 Surface 信息</span>
    <span class="hljs-comment">// 回写（Copy）到 ViewRootImpl 的 mSurface 中。</span>
    <span class="hljs-comment">// 后面会细讲</span>
    
    <span class="hljs-keyword">if</span> (mSurface.isValid()) {
        <span class="hljs-comment">// Surface 此时已经准备好，可以合成了</span>
    }
    <span class="hljs-comment">// ...</span>
    performMeasure(...);
    performLayout(...);
    performDraw(...);
}
</code></pre>
<p>在 <code>relayout</code> 过程中，<code>WMS</code> 会与 <code>SurfaceFlinger</code> 通信，分配 <code>Layer</code>（图层）。<code>WMS</code> 将生成的 <code>Surface</code> 信息填充到 <code>ViewRootImpl</code> 传入的 <code>mSurface</code> 参数中。</p>
<blockquote>
<p>这样，一个 Activity 就和 SurfaceFlinger 中的 Surface 产生了关联啦。</p>
</blockquote>
<p><span id="user-content-WMS2APP"/></p>
<h3 data-id="heading-8">WMS中建立和应用的关系</h3>
<p>前面提到<code>ViewRootImpl</code>对象会通过<code>addToDisplay()</code>方法将<code>IWindow</code>的<code>Binder</code>引用对象传递到<code>WMS</code>中，我们先看下<code>addToDisplay()</code>方法：</p>
<pre><code class="hljs language-java" lang="java">    <span class="hljs-comment">// 方法定义在 com.android.server.wm.Session 中</span>
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">addToDisplay</span><span class="hljs-params">(IWindow window, ...)</span> {
        <span class="hljs-comment">// mService 的类型便是 WindowManagerService</span>
        <span class="hljs-keyword">return</span> mService.addWindow(<span class="hljs-built_in">this</span>, window, ...);
    }
</code></pre>
<p>调用了<code>WMS</code>的<code>addWindow()</code>方法，代码如下：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">addWindow</span><span class="hljs-params">(Session session, IWindow client, ...)</span> {
    ...
    <span class="hljs-keyword">synchronized</span>(mWindowMap) {
        ...
        <span class="hljs-keyword">if</span> (mWindowMap.containsKey(client.asBinder())) {
            Slog.w(TAG_WM, <span class="hljs-string">"Window "</span> + client + <span class="hljs-string">" is already added"</span>);
            <span class="hljs-keyword">return</span> WindowManagerGlobal.ADD_DUPLICATE_ADD;
        }
        ...
        <span class="hljs-keyword">final</span> <span class="hljs-type">WindowState</span> <span class="hljs-variable">win</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">WindowState</span>(<span class="hljs-built_in">this</span>, session, client, token, parentWindow,
                appOp[<span class="hljs-number">0</span>], seq, attrs, viewVisibility, session.mUid,
                session.mCanAddInternalSystemWindow);
        ...
        win.attach();
        mWindowMap.put(client.asBinder(), win);
        win.initAppOpsState();
        ...
    }
    ...
    <span class="hljs-keyword">return</span> res;
}
</code></pre>
<p><code>addWindow()</code>方法代码在200多行，此处我们需要关注的部分是：</p>
<ul>
<li>创建了<code>WindowState</code>对象并添加到<code>mWindowMap</code>集合中</li>
<li>调用<code>WindowState</code>对象的<code>attach()</code>方法</li>
</ul>
<p><code>WindowState</code>后面会详细介绍，此处的关键定义如下：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">/** A window in the window manager. */</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">WindowState</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">WindowContainer</span>&lt;WindowState&gt; <span class="hljs-keyword">implements</span> <span class="hljs-title class_">WindowManagerPolicy</span>.WindowState {
    ...
    <span class="hljs-keyword">final</span> Context mContext;
    <span class="hljs-keyword">final</span> Session mSession;
    <span class="hljs-keyword">final</span> IWindow mClient;
    ...
    <span class="hljs-keyword">void</span> <span class="hljs-title function_">attach</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">if</span> (localLOGV) Slog.v(TAG, <span class="hljs-string">"Attaching "</span> + <span class="hljs-built_in">this</span> + <span class="hljs-string">" token="</span> + mToken);
        mSession.windowAddedLocked(mAttrs.packageName);
    }
}
</code></pre>
<ul>
<li><code>mClient</code>是应用进程中<code>Binder</code>服务对象<code>W</code>的引用对象</li>
<li><code>mSession</code>便是<code>WMS</code>对外封装的对象之一。以前面的<code>addToDisplay()</code>为例，实际上只是转调了<code>WMS</code>的<code>addWindow()</code>方法</li>
<li><code>attach()</code>方法也只是调用了<code>mSession</code>对象的<code>windowAddedLocked()</code>方法</li>
</ul>
<p>继续看下<code>windowAddedLocked()</code>方法:</p>
<pre><code class="hljs language-java" lang="java">    <span class="hljs-keyword">void</span> <span class="hljs-title function_">windowAddedLocked</span><span class="hljs-params">(String packageName)</span> {
        mPackageName = packageName;
        mRelayoutTag = <span class="hljs-string">"relayoutWindow: "</span> + mPackageName;
        <span class="hljs-keyword">if</span> (mSurfaceSession == <span class="hljs-literal">null</span>) {
            mSurfaceSession = <span class="hljs-keyword">new</span> <span class="hljs-title class_">SurfaceSession</span>();
            mService.mSessions.add(<span class="hljs-built_in">this</span>);
            <span class="hljs-keyword">if</span> (mLastReportedAnimatorScale != mService.getCurrentAnimatorScale()) {
                mService.dispatchNewAnimatorScaleLocked(<span class="hljs-built_in">this</span>);
            }
        }
        mNumWindow++;
    }
</code></pre>
<p><code>windowAddedLocked()</code>方法</p>
<ul>
<li>首先检查了<code>mSurfaceSession</code>的值，当为空时才会创建<code>SurfaceSession</code>对象
<ul>
<li>前面<a href="https://juejin.cn/post/6944960866404007944#heading-7" target="_blank" title="https://juejin.cn/post/6944960866404007944#heading-7">图像显示</a>部分介绍过，<code>SurfaceSession</code>对象是用来创建<code>Surface</code>的</li>
</ul>
</li>
<li>然后将<code>Session</code>对象本身添加到<code>WMS</code>的<code>mSessions</code>列表中</li>
</ul>
<p>到这里，应用进程就和<code>WMS</code>各自持有了对方的<code>Binder</code>引用对象，形成了一个双向<code>Binder</code>通道，示意图如下：<br/>
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2c770d89efe34906bf922df504d858aa~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgYXBpZ2ZseQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764508564&amp;x-signature=NaEwJ3G6o3LRkFsTlJKCfHjPwjA%3D" alt="image" loading="lazy"/></p>
<h3 data-id="heading-9">DecorView</h3>
<p>关于<code>DecorView</code>，还是要从我们最熟悉的地方说起。</p>
<p>在<code>Activity</code>的<code>onCreate()</code>中调用<code>setContentView()</code>方法时，我们看下发生了什么：</p>
<pre><code class="hljs language-java" lang="java">    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setContentView</span><span class="hljs-params">(<span class="hljs-meta">@LayoutRes</span> <span class="hljs-type">int</span> layoutResID)</span> {
        getWindow().setContentView(layoutResID);
        initWindowDecorActionBar();
    }
</code></pre>
<p><code>Activity</code>的<code>onCreate()</code>调用的是<code>Window</code>类的<code>setContentView()</code>，这是个抽象方法，具体的实现在<code>PhoneWindow.java</code>中，代码如下：</p>
<pre><code class="hljs language-java" lang="java">    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setContentView</span><span class="hljs-params">(View view, ViewGroup.LayoutParams params)</span> {
        <span class="hljs-keyword">if</span> (mContentParent == <span class="hljs-literal">null</span>) {
            installDecor();
        }
        ...
    }
</code></pre>
<p>如果<code>mContentParent</code>对象还没有创建出来，则会调用<code>installDecor()</code>方法，方法如下：</p>
<pre><code class="hljs language-java" lang="java">    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">installDecor</span><span class="hljs-params">()</span> {
        mForceDecorInstall = <span class="hljs-literal">false</span>;
        <span class="hljs-keyword">if</span> (mDecor == <span class="hljs-literal">null</span>) {
            mDecor = generateDecor(-<span class="hljs-number">1</span>); <span class="hljs-comment">// 创建 DecorView</span>
            mDecor.setDescendantFocusability(ViewGroup.FOCUS_AFTER_DESCENDANTS);
            mDecor.setIsRootNamespace(<span class="hljs-literal">true</span>);
            <span class="hljs-keyword">if</span> (!mInvalidatePanelMenuPosted &amp;&amp; mInvalidatePanelMenuFeatures != <span class="hljs-number">0</span>) {
                mDecor.postOnAnimation(mInvalidatePanelMenuRunnable);
            }
        } <span class="hljs-keyword">else</span> {
            mDecor.setWindow(<span class="hljs-built_in">this</span>);
        }
        <span class="hljs-keyword">if</span> (mContentParent == <span class="hljs-literal">null</span>) {
            mContentParent = generateLayout(mDecor); <span class="hljs-comment">// 为DecorView设置布局格式，并返回 mContentParent</span>
        }
    }
</code></pre>
<p><code>installDecor()</code>方法</p>
<ul>
<li>
<p>先根据成员变量<code>mDecor</code>是否为空来决定是否进行<code>DecorView</code>的创建</p>
<ul>
<li>对象的创建方法为<code>generateDecor()</code>，内容如下：</li>
</ul>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">protected</span> DecorView <span class="hljs-title function_">generateDecor</span><span class="hljs-params">(<span class="hljs-type">int</span> featureId)</span> {
    Context context;
    ... <span class="hljs-comment">// 省略 context 的创建过程</span>
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DecorView</span>(context, featureId, <span class="hljs-built_in">this</span>, getAttributes());
}
</code></pre>
</li>
<li>
<p>然后通过<code>generateLayout()</code>方法为创建好的<code>DecorView</code>设置布局格式，并返回<code>mContentParent</code>对象</p>
</li>
</ul>
<p>我们再看下<code>DecorView</code>的定义</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">/** <span class="hljs-doctag">@hide</span> */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DecorView</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">FrameLayout</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">RootViewSurfaceTaker</span>, WindowCallbacks {
    ...
}
</code></pre>
<p>其实就是个自定义的<code>ViewGroup</code>，只是这个<code>DecorView</code>在<code>Android</code>中作为顶级<code>View</code>去使用</p>
<h2 data-id="heading-10"><code>WindowManagerService</code>服务</h2>
<p><code>WMS</code>服务的启动，要从<code>SystemServer</code>中的<code>startOtherServices()</code>方法说起，关键代码如下：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">startOtherServices</span><span class="hljs-params">()</span> {
    ...
    wm = WindowManagerService.main(..., <span class="hljs-keyword">new</span> <span class="hljs-title class_">PhoneWindowManager</span>());
    ServiceManager.addService(Context.WINDOW_SERVICE, wm, <span class="hljs-comment">/* allowIsolated= */</span> <span class="hljs-literal">false</span>,
            DUMP_FLAG_PRIORITY_CRITICAL | DUMP_FLAG_PROTO);
    ...
}
</code></pre>
<p>看下<code>main()</code>方法的定义：</p>
<pre><code class="hljs language-java" lang="java">    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> WindowManagerService <span class="hljs-title function_">main</span><span class="hljs-params">(..., WindowManagerPolicy policy)</span> {
        DisplayThread.getHandler().runWithScissors(() -&gt;
                sInstance = <span class="hljs-keyword">new</span> <span class="hljs-title class_">WindowManagerService</span>(context, im, haveInputMethods, showBootMsgs,
                        onlyCore, policy), <span class="hljs-number">0</span>);
        <span class="hljs-keyword">return</span> sInstance;
    }
</code></pre>
<p><code>main()</code>方法主要是初始化了<code>WindowManagerService</code>对象，我们需要注意的是它的最后的参数<code>WindowManagerPolicy policy</code>，它的具体的实现类是<code>PhoneWindowManager</code></p>
<p>再看下<code>WindowManagerService</code>的关键定义：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">WindowManagerService</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">IWindowManager</span>.Stub
        <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Watchdog</span>.Monitor, WindowManagerPolicy.WindowManagerFuncs {
    ...
    <span class="hljs-keyword">final</span> ArraySet&lt;Session&gt; mSessions = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArraySet</span>&lt;&gt;();
    <span class="hljs-keyword">final</span> <span class="hljs-type">WindowHashMap</span> <span class="hljs-variable">mWindowMap</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">WindowHashMap</span>();
    <span class="hljs-keyword">final</span> WindowManagerPolicy mPolicy;
    ...
    <span class="hljs-keyword">private</span> <span class="hljs-title function_">WindowManagerService</span><span class="hljs-params">(..., WindowManagerPolicy policy)</span> {
        ...
        mPolicy = policy;
        ...
    }
}
</code></pre>
<p>其中的关键成员如下：</p>
<ul>
<li>
<p><code>mSessions</code>中储存的是<code>Session</code>服务类的对象，每个应用在<code>WMS</code>中都有一个对应的<code>Session</code>对象，它们都保存在<code>mSessions</code>中</p>
</li>
<li>
<p><code>mWindowMap</code>中类型是<code>WindowHashMap</code>，保存的是所有窗口的<code>WindowState</code>对象。<code>WindowHashMap</code>定义如下：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">class</span> <span class="hljs-title class_">WindowHashMap</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">HashMap</span>&lt;IBinder, WindowState&gt; {
}
</code></pre>
<ul>
<li>此处并未做任何删减哈，源码中就是简单地继承了<code>HashMap&lt;IBinder, WindowState&gt;</code></li>
<li><code>WindowState</code>表示一个窗口的所有属性，它便是是<code>WMS</code>中的窗口。等下细讲</li>
</ul>
</li>
<li>
<p><code>mPolicy</code>是<code>WMS</code>中执行窗口管理策略的对象，类型是<code>WindowManagerPolicy</code>，这是一个接口类</p>
<ul>
<li>从<code>SystemServer</code>的<code>startOtherServices()</code>中可以看出具体的实现类是<code>PhoneWindowManager</code></li>
<li>在<code>Android</code>中<code>WMS</code>只是负责窗口管理的框架部分，通过<code>策略模式</code>将框架和窗口实现细节进行了分离</li>
</ul>
</li>
</ul>
<p>对比<code>9.0</code>和<code>5.0</code>源码，<code>WMS</code>关于窗口部分设计变化很大，在了解<code>Android</code>如何添加一个窗口前，我们先看下<code>Android</code>中窗口类型的定义</p>
<h3 data-id="heading-11">窗口类型</h3>
<p>在<code>WMS</code>中定义了3中窗口：<code>应用窗口</code>、<code>子窗口</code>和<code>系统窗口</code>，相关的定义都是在<code>frameworks/base/core/java/android/view/WindowManager.java</code>中，确切的说应该是在<code>WindowManager.LayoutParams</code>类中定义</p>
<h4 data-id="heading-12">应用窗口(<code>application window</code>)</h4>
<p>应用窗口是<code>Activity</code>使用的全屏窗口，<code>Android</code>定义了4种不同类型的应用窗口</p>
<ul>
<li><code>TYPE_BASE_APPLICATION</code>：基础应用窗口，应用中所有窗口都位于它的上层。只能由系统创建</li>
<li><code>TYPE_APPLICATION</code>：<code>Activity</code>的顶层窗口，应用中最常见的一种</li>
<li><code>TYPE_APPLICATION_STARTING</code>：应用启动时由系统创建的窗口，显示一些信息，直到应用创建的窗口显示出来</li>
<li><code>TYPE_DRAWN_APPLICATION</code>：类似于普通的<code>TYPE_APPLICATION</code>，<code>WMS</code>针对类型额外增加了等待机制</li>
</ul>
<h4 data-id="heading-13">子窗口(<code>sub-window</code>)</h4>
<p>子窗口是指依附于应用窗口或系统窗口的窗口类型，它们一般随所依附的窗口一起出现或切换到后台。<code>Android</code>中定义了6种子窗口类型</p>
<ul>
<li><code>TYPE_APPLICATION_PANEL</code>：应用Panel窗口，显示在依附窗口的上层</li>
<li><code>TYPE_APPLICATION_MEDIA</code>：应用Media窗口，通常包含独立的Surface，显示在依附窗口的下层</li>
<li><code>TYPE_APPLICATION_SUB_PANEL</code>：应用子Panel窗口，显示在依附窗口和<code>TYPE_APPLICATION_PANEL</code>的上层</li>
<li><code>TYPE_APPLICATION_ATTACHED_DIALOG</code>：和<code>TYPE_APPLICATION_PANEL</code>类似，但是窗口的布局方式和<code>Activity</code>的顶层窗口相同</li>
<li><code>TYPE_APPLICATION_MEDIA_OVERLAY</code>：一种显示在<code>TYPE_APPLICATION_MEDIA</code>和所依附窗口之间的半透明窗口。一般用来显示<code>Video</code>的字幕或者相机的操作提示界面</li>
<li><code>TYPE_APPLICATION_ABOVE_SUB_PANEL</code>：一种显示在<code>TYPE_APPLICATION_SUB_PANEL</code>之上的窗口</li>
</ul>
<h4 data-id="heading-14">系统窗口(<code>system window</code>)</h4>
<p>系统窗口大都用于系统生成的UI中，一般比较独立，种类非常多，我们挑几个常见的看下</p>
<ul>
<li><code>TYPE_STATUS_BAR</code>：状态栏窗口，系统中只能有一个，在屏幕的最上方</li>
<li><code>TYPE_SEARCH_BAR</code>：搜索栏窗口，系统中只能有一个，在屏幕的最上方</li>
<li><code>TYPE_PHONE</code>：电话窗口，提供用户与电话的交互界面，通常位于所用应用窗口的上方，但是在状态栏的后面</li>
<li><code>TYPE_SYSTEM_ALERT</code>：系统警告窗口，位于所用应用窗口的上方</li>
<li><code>TYPE_TOAST</code>：临时通知窗口，显示一些提示信息</li>
</ul>
<p>还有很多就不一一列举了，<code>Android</code>对<code>系统窗口</code>的定义有39种之多，源码中有着详细的注释，大家可以在<code>WindowManager.java</code>中找到(<a href="https://link.juejin.cn?target=http%3A%2F%2Fandroidxref.com%2F9.0.0_r3%2Fxref%2Fframeworks%2Fbase%2Fcore%2Fjava%2Fandroid%2Fview%2FWindowManager.java%23697" target="_blank" title="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/java/android/view/WindowManager.java#697" ref="nofollow noopener noreferrer">传送门</a>)</p>
<p><strong>那么<code>WMS</code>中是怎么定义窗口的呢？</strong></p>
<h3 data-id="heading-15"><code>WMS</code>中窗口的设计</h3>
<blockquote>
<p>前面讲过（<code>WMS</code>的<code>addWindow()</code>方法），当向<code>WMS</code>添加一个窗口时，<code>WMS</code>会为其创建一个<code>WindowState</code>。对于<code>WindowState</code>来说，它包含了一个窗口的所有属性，所以它是<code>WMS</code>中真正意义上的窗口</p>
</blockquote>
<p>先看下<code>WindowState</code>的关键定义：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">/** A window in the window manager. */</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">WindowState</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">WindowContainer</span>&lt;WindowState&gt; <span class="hljs-keyword">implements</span> <span class="hljs-title class_">WindowManagerPolicy</span>.WindowState {
    ...
    WindowToken mToken;
    AppWindowToken mAppToken;
    ...
    <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> mBaseLayer;
    <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> mSubLayer;
}
</code></pre>
<p><code>WindowState</code>继承了<code>WindowContainer</code>，又是和书中不一样的地方</p>
<blockquote>
<p>对比5.0源码，很明显在<code>Window</code>这部分<code>Android</code>做了重构（设计模式看上去像是<code>组合模式</code>），优化了类结构，抽象出了<code>WindowContainer</code>用来支撑起整个窗口体系</p>
</blockquote>
<p>基于<code>Android 9.0</code>源码，窗口体系的关系梳理如下：<br/>
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f2dcd21f21c44ce48b16279606ba5d73~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgYXBpZ2ZseQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764508564&amp;x-signature=ESLkSCnWfFCwab6KKqZzZ5yiLvY%3D" alt="image" loading="lazy"/></p>
<p>类图中涉及到的类的信息下：</p>
<ul>
<li>
<p><code>WindowContainer</code></p>
<ul>
<li>成员变量<code>mChildren</code>的类型是<code>WindowList</code>，看实现其实就是<code>ArrayList&lt;WindowState&gt;</code>。又因为<code>WindowToken</code>继承了<code>WindowContainer</code>，所以该成员变量子类都会继承过来</li>
<li>所有拥有相同<code>Token</code>的窗口(<code>WindowState</code>)都会存放在<code>mChildren</code>中，</li>
</ul>
</li>
<li>
<p><code>WindowToken</code></p>
<ul>
<li>成员变量<code>token</code>是<code>IBinder</code>对象，具有系统唯一性，向<code>WMS</code>的<code>mWindowMap</code>中添加对象时都是使用这个<code>token</code>值</li>
<li>定义了<code>AppWindowToken asAppWindowToken()</code>，默认返回<code>null</code></li>
</ul>
</li>
<li>
<p><code>AppWindowToken</code></p>
<ul>
<li>继承自<code>WindowToken</code>并重写了<code>AppWindowToken asAppWindowToken()</code>方法，返回<code>this</code></li>
<li>这样便可以通过<code>asAppWindowToken()</code>的返回值判断是那种<code>Token</code></li>
</ul>
</li>
<li>
<p><code>DisplayContent</code></p>
<ul>
<li>继承自<code>WindowContainer</code>，真正意义上的屏幕，<code>WMS</code>中一个<code>DisplayContent</code>实例表示一个屏幕。多屏幕会对应多个实例</li>
<li>内部定义了4种存放<code>Window</code>的容器，都是直接或间接继承自<code>WindowContainer</code>：
<ul>
<li><code>mTaskStackContainers</code>：用来保存所有的应用窗口</li>
<li><code>mAboveAppWindowsContainers</code>：用来保存显示在应用窗口的上面的非应用窗口</li>
<li><code>mBelowAppWindowsContainers</code>：用来保存显示在应用窗口的下面的非应用窗口</li>
<li><code>mImeWindowsContainers</code>：用来保存 IME Window</li>
</ul>
</li>
</ul>
</li>
<li>
<p><code>RootWindowContainer</code></p>
<ul>
<li>代表<code>WMS</code>中窗口的根容器，所有<code>DisplayContent</code>的实例都会添加到其中</li>
<li><code>RootWindowContainer</code>在<code>WMS</code>的构造方法中初始化为<code>mRoot</code>对象</li>
</ul>
</li>
</ul>
<p>还是回到<code>WindowState</code>，类中定义了两个常量<code>mBaseLayer</code>和<code>mSubLayer</code>，通过这两个常量便可以确定一个<code>Window</code>所在的层级。这部分就不细讲了哈，涉及点有点多，后面用到再来补充吧，嘻嘻</p>
<p>我们重点看下面两个知识点：<code>WMS</code>的<code>addWindow</code>和<code>relayoutWindow</code>的设计</p>
<h4 data-id="heading-16">addWindow方法</h4>
<p><code>addWindow()</code>在<a href="#WMS2APP" title="#WMS2APP">WMS中建立和应用的关系</a>已经介绍，不再赘述</p>
<h4 data-id="heading-17">relayoutWindow方法</h4>
<p>前面介绍过，在<code>Activity</code>的<code>onResume</code>阶段，通过<code>ViewRootImpl</code>的<code>setView</code>方法开始渲染<code>View</code>的流程。</p>
<p><code>setView</code>方法中会通过<code>requestLayout()</code>开始测量渲染，这个方法中有一个核心的逻辑就是调用<code>WMS</code>的<code>relayoutWindow()</code>，重新测量<code>Window</code>，简要流程如下：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">//ViewRootImpl.java</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">requestLayout</span><span class="hljs-params">()</span> {
    <span class="hljs-keyword">if</span> (!mHandlingLayoutInLayoutRequest) {
        ...
        scheduleTraversals();
    }
}
<span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">performTraversals</span><span class="hljs-params">()</span> {
    ...
    relayoutResult = relayoutWindow(params, viewVisibility, insetsPending);
    ...
}
<span class="hljs-keyword">private</span> <span class="hljs-type">int</span> <span class="hljs-title function_">relayoutWindow</span><span class="hljs-params">(WindowManager.LayoutParams params, <span class="hljs-type">int</span> viewVisibility,
        <span class="hljs-type">boolean</span> insetsPending)</span> <span class="hljs-keyword">throws</span> RemoteException {
    ...
    <span class="hljs-type">int</span> <span class="hljs-variable">relayoutResult</span> <span class="hljs-operator">=</span> mWindowSession.relayout(mWindow, mSeq, params,
            (<span class="hljs-type">int</span>) (mView.getMeasuredWidth() * appScale + <span class="hljs-number">0.5f</span>),
            (<span class="hljs-type">int</span>) (mView.getMeasuredHeight() * appScale + <span class="hljs-number">0.5f</span>), viewVisibility,
            insetsPending ? WindowManagerGlobal.RELAYOUT_INSETS_PENDING : <span class="hljs-number">0</span>, frameNumber,
            mWinFrame, mPendingOverscanInsets, mPendingContentInsets, mPendingVisibleInsets,
            mPendingStableInsets, mPendingOutsets, mPendingBackDropFrame, mPendingDisplayCutout,
            mPendingMergedConfiguration, mSurface);
    ...
    <span class="hljs-keyword">return</span> relayoutResult;
}
</code></pre>
<p><code>relayoutWindow()</code>通过<code>Session</code>的<code>relayout()</code>方法调用到<code>WMS</code>的<code>relayoutWindow()</code>方法</p>
<pre><code class="hljs language-java" lang="java">    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">relayout</span><span class="hljs-params">(IWindow window, <span class="hljs-type">int</span> seq, ...)</span> {
        ...
        <span class="hljs-type">int</span> <span class="hljs-variable">res</span> <span class="hljs-operator">=</span> mService.relayoutWindow(<span class="hljs-built_in">this</span>, window, seq, attrs,
                requestedWidth, requestedHeight, viewFlags, flags, frameNumber,
                outFrame, outOverscanInsets, outContentInsets, outVisibleInsets,
                outStableInsets, outsets, outBackdropFrame, cutout,
                mergedConfiguration, outSurface);
        ...
        <span class="hljs-keyword">return</span> res;
    }
</code></pre>
<p><code>WMS</code>中的<code>relayoutWindow()</code>代码比较复杂，我们简单看下：</p>
<pre><code class="hljs language-java" lang="java">    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">relayoutWindow</span><span class="hljs-params">(...)</span> {
        ...
        <span class="hljs-keyword">synchronized</span>(mWindowMap) {
            <span class="hljs-comment">// 从 mWindowMap 取出对应的 WindowState 对象</span>
            <span class="hljs-type">WindowState</span> <span class="hljs-variable">win</span> <span class="hljs-operator">=</span> windowForClientLocked(session, client, <span class="hljs-literal">false</span>);
            <span class="hljs-keyword">if</span> (win == <span class="hljs-literal">null</span>) {
                <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
            }
            displayId = win.getDisplayId();
            ...
            <span class="hljs-comment">// 调用 WindowSurfacePlacer 的 performSurfacePlacement 方法</span>
            <span class="hljs-comment">// 这个方法其实就是检查清理无用的 Surface 对象，为后面创建 Surface 做准备</span>
            <span class="hljs-comment">// 详细的方法就不贴出来了，大家可以自行阅读</span>
            mWindowPlacerLocked.performSurfacePlacement(<span class="hljs-literal">true</span> <span class="hljs-comment">/* force */</span>);
            <span class="hljs-keyword">if</span> (shouldRelayout) {
                result = win.relayoutVisibleWindow(result, attrChanges, oldVisibility);
                <span class="hljs-keyword">try</span> {
                    <span class="hljs-comment">// 创建 Surface ，确切的说应该是创建 WindowSurfaceController 对象</span>
                    <span class="hljs-comment">// WindowSurfaceController 其实就是对 Surface 和 SurfaceControl 的封装</span>
                    <span class="hljs-comment">// Surface 和 SurfaceControl 的关系在十二章已经介绍啦</span>
                    result = createSurfaceControl(outSurface, result, win, winAnimator);
                } 
                ...
            } <span class="hljs-keyword">else</span> {
                ...
            }
            <span class="hljs-keyword">if</span> (focusMayChange) {
                <span class="hljs-comment">// 如果窗口发生了变化，调用 updateFocusedWindowLocked 方法重新测量窗口大小</span>
                <span class="hljs-comment">// 这个方法才是真正的核心测量窗口大小逻辑</span>
                <span class="hljs-comment">// 方法中会调用 DisplayContent.performLayout 方法开始真正的测量</span>
                <span class="hljs-keyword">if</span> (updateFocusedWindowLocked(UPDATE_FOCUS_WILL_PLACE_SURFACES,
                        <span class="hljs-literal">false</span> <span class="hljs-comment">/*updateInputWindows*/</span>)) {
                    imMayMove = <span class="hljs-literal">false</span>;
                }
            }
            ...
            win.mInRelayout = <span class="hljs-literal">false</span>;
        }
        ...
    }
</code></pre>
<p>在 <code>WMS</code> 的 <code>relayoutWindow()</code> 方法中，核心逻辑在于 <code>createSurfaceControl</code> 的调用。</p>
<pre><code class="hljs language-java" lang="java">result = createSurfaceControl(outSurface, result, win, winAnimator);
</code></pre>
<p>这里的参数 outSurface 至关重要。回看 ViewRootImpl 调用 relayout 的代码：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// ViewRootImpl.java</span>
mWindowSession.relayout(..., mSurface);
</code></pre>
<p>我们可以明确看到，<code>ViewRootImpl</code> 将自己的成员变量 mSurface 传递给了 <code>WMS</code>。 在 <code>WMS</code> 内部，<code>createSurfaceControl</code> 会请求 <code>SurfaceFlinger</code> 创建图层（<code>Layer</code>），并将生成的 <code>Native</code> 层 <code>Surface</code> 信息回写（<code>Copy</code>）到传入的 <code>outSurface</code> 参数中。</p>
<p>这意味着： 当 <code>relayoutWindow</code> 调用返回时，应用进程 <code>ViewRootImpl</code> 中的 <code>mSurface</code> 对象就已经持有了真正的图形缓冲区引用，随后应用便可以利用这个 <code>Surface</code> 进行绘图。</p>
<blockquote>
<p>怎么说～怎么说～。前言的问题是不是明了啦</p>
</blockquote>
<h2 data-id="heading-18">总结</h2>
<p>Android 的窗口系统是一个典型的 <code>C/S</code> 架构，由应用进程（Client）和 <code>WindowManagerService</code>（Server）共同构成：</p>
<p><strong>应用端 (Client)</strong></p>
<ul>
<li>
<p><code>Activity</code> 负责生命周期，持有一个 <code>PhoneWindow</code> 对象来管理视图策略。</p>
</li>
<li>
<p><code>DecorView</code> 是视图树的根节点。</p>
</li>
<li>
<p><code>ViewRootImpl</code> 是核心管理者，它连接了 DecorView 和 <code>WMS</code>，并持有 <code>Surface</code> 对象，负责发起绘制流程（Measure/Layout/Draw）。</p>
</li>
<li>
<p><code>WindowManagerGlobal</code> 是进程单例，负责管理当前进程所有的 <code>ViewRootImpl</code> 和 <code>View</code>。</p>
</li>
</ul>
<p><strong>通信层 (IPC)</strong></p>
<ul>
<li>
<p><code>IWindowSession</code>：应用向 <code>WMS</code> 发送请求的通道（如 <code>addToDisplay</code>, <code>relayout</code>）。</p>
</li>
<li>
<p><code>IWindow</code> (<code>W</code>类)：<code>WMS</code> 回调应用的通道（如窗口焦点变化、配置改变）。</p>
</li>
</ul>
<p><strong>服务端 (WMS)</strong></p>
<ul>
<li>
<p><code>WindowState</code>：<code>WMS</code> 中代表一个窗口的实体，保存窗口的所有属性。</p>
</li>
<li>
<p><code>WindowContainer</code>：构建了层级化的窗口容器结构（<code>DisplayContent</code> -&gt; <code>TaskStack</code> -&gt; <code>WindowState</code>）。</p>
</li>
<li>
<p><code>Surface</code> 管理：<code>WMS</code> 在 <code>relayoutWindow</code> 过程中计算窗口大小与位置，并与 <code>SurfaceFlinger</code> 通信创建 <code>SurfaceControl</code>，最终将可用的 <code>Surface</code> 返回给应用端。</p>
</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item>  </channel></rss>