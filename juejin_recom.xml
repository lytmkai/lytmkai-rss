<?xml version="1.0" encoding="UTF-8"?><rss version="2.0">  <channel>      <title>掘金文章推荐</title>      <link>https://juejin.cn/recommended?sort=newest</link>      <description>一个帮助开发者成长的社区</description>      <generator>python juejin_recom.py @Pi20</generator>      <item>    <title><![CDATA[Redisson分布式锁实现原理]]></title>    <link>https://juejin.cn/post/7585463195201339442</link>    <guid>https://juejin.cn/post/7585463195201339442</guid>    <pubDate>2025-12-20T08:01:18.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585463195201339442" data-draft-id="7585446706327388169" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Redisson分布式锁实现原理"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-12-20T08:01:18.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="sir761"/> <meta itemprop="url" content="https://juejin.cn/user/1285746184422272"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Redisson分布式锁实现原理
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1285746184422272/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    sir761
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-20T08:01:18.000Z" title="Sat Dec 20 2025 08:01:18 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读12分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>说到redis的分布式锁容易想到了setNx，好处是实现简单，但是会有一些问题比如误删锁问题、锁不可重入问题。所以Redisson并没有通过setNx命令来实现加锁，而是自己实现了一套完成的加锁的逻辑</p>
<h3 data-id="heading-0">加锁与解锁</h3>
<p>RLock继承了Java的lock接口，RedissonLock继承自RedissonBaseLock（抽象类），而RedissonBaseLock又实现了RLock。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">//调用getLock时候就是new了一个RedissonLock</span>
<span class="hljs-keyword">public</span> <span class="hljs-title class_">RLock</span> <span class="hljs-title function_">getLock</span>(<span class="hljs-params"><span class="hljs-built_in">String</span> name</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RedissonLock</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">commandExecutor</span>, name);
}
</code></pre>
<p>我们重点看lock方法：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">public</span> void lock() {
    <span class="hljs-keyword">try</span> {
        <span class="hljs-keyword">this</span>.lock(-<span class="hljs-number">1L</span>, (TimeUnit)<span class="hljs-literal">null</span>, <span class="hljs-literal">false</span>);
    } <span class="hljs-keyword">catch</span> (InterruptedException var2) {
        <span class="hljs-keyword">throw</span> new IllegalStateException();
    }
}
​
<span class="hljs-keyword">private</span> void lock(long leaseTime, TimeUnit unit, boolean interruptibly) throws InterruptedException {
    long threadId = Thread.currentThread().getId();
    <span class="hljs-comment">//调用了tryAcquire获取锁，这里传入了-1L代表没有指定锁的释放时间，正常情况下如果不释放是永久持有。</span>
    <span class="hljs-built_in">Long</span> ttl = <span class="hljs-keyword">this</span>.tryAcquire(-<span class="hljs-number">1L</span>, leaseTime, unit, threadId);
    <span class="hljs-comment">//以下代码先忽略</span>
    <span class="hljs-comment">//.....</span>
}
​
<span class="hljs-keyword">private</span> <span class="hljs-built_in">Long</span> tryAcquire(long waitTime, long leaseTime, TimeUnit unit, long threadId) {
    <span class="hljs-comment">//这里调用get，等待future返回。</span>
    <span class="hljs-keyword">return</span> (<span class="hljs-built_in">Long</span>)<span class="hljs-keyword">this</span>.<span class="hljs-keyword">get</span>(<span class="hljs-keyword">this</span>.tryAcquireAsync0(waitTime, leaseTime, unit, threadId));
}
​
<span class="hljs-keyword">private</span> RFuture&lt;<span class="hljs-built_in">Long</span>&gt; tryAcquireAsync0(long waitTime, long leaseTime, TimeUnit unit, long threadId) {
    <span class="hljs-comment">//使用了线程池去获取锁</span>
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.getServiceManager().execute(() -&gt; {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.tryAcquireAsync(waitTime, leaseTime, unit, threadId);
    });
}
<span class="hljs-comment">//重点方法来了</span>
<span class="hljs-keyword">private</span> RFuture&lt;<span class="hljs-built_in">Long</span>&gt; tryAcquireAsync(long waitTime, long leaseTime, TimeUnit unit, long threadId) {
    RFuture ttlRemainingFuture;
    <span class="hljs-keyword">if</span> (leaseTime &gt; <span class="hljs-number">0L</span>) {
        <span class="hljs-comment">//如果这里leaseTime不为0说明用户设置了锁的租约时间直接传入。</span>
        ttlRemainingFuture = <span class="hljs-keyword">this</span>.tryLockInnerAsync(waitTime, leaseTime, unit, threadId, RedisCommands.EVAL_LONG);
    } <span class="hljs-keyword">else</span> {
        <span class="hljs-comment">//如果这里leaseTime为0说明用户没有限制锁的租约时间，但是这里仍然会传30秒的持有时间</span>
        ttlRemainingFuture = <span class="hljs-keyword">this</span>.tryLockInnerAsync(waitTime, <span class="hljs-keyword">this</span>.internalLockLeaseTime, TimeUnit.MILLISECONDS, threadId, RedisCommands.EVAL_LONG);
    }
​
    CompletionStage&lt;<span class="hljs-built_in">Long</span>&gt; s = <span class="hljs-keyword">this</span>.handleNoSync(threadId, ttlRemainingFuture);
    RFuture&lt;<span class="hljs-built_in">Long</span>&gt; ttlRemainingFuture = new CompletableFutureWrapper(s);
    CompletionStage&lt;<span class="hljs-built_in">Long</span>&gt; f = ttlRemainingFuture.thenApply((ttlRemaining) -&gt; {
        <span class="hljs-comment">//如果为空说明lua获取锁脚本获得了锁</span>
        <span class="hljs-keyword">if</span> (ttlRemaining == <span class="hljs-literal">null</span>) {
            <span class="hljs-comment">//判断是否开启看门狗机制。</span>
            <span class="hljs-keyword">if</span> (leaseTime &gt; <span class="hljs-number">0L</span>) {
                <span class="hljs-keyword">this</span>.internalLockLeaseTime = unit.toMillis(leaseTime);
            } <span class="hljs-keyword">else</span> {
                <span class="hljs-keyword">this</span>.scheduleExpirationRenewal(threadId);
            }
        }
​
        <span class="hljs-keyword">return</span> ttlRemaining;
    });
    <span class="hljs-keyword">return</span> new CompletableFutureWrapper(f);
}
&lt;T&gt; RFuture&lt;T&gt; tryLockInnerAsync(long waitTime, long leaseTime, TimeUnit unit, long threadId, RedisStrictCommand&lt;T&gt; command) {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.evalWriteSyncedNoRetryAsync(<span class="hljs-keyword">this</span>.getRawName(), LongCodec.INSTANCE, command, 
    <span class="hljs-string">"if ((redis.call('exists', KEYS[1]) == 0) or (redis.call('hexists', KEYS[1], ARGV[2]) == 1)) then "</span> +
        <span class="hljs-string">"redis.call('hincrby', KEYS[1], ARGV[2], 1); "</span> +
        <span class="hljs-string">"redis.call('pexpire', KEYS[1], ARGV[1]); "</span>+
        <span class="hljs-string">"return nil; "</span>+ 
    <span class="hljs-string">"end;"</span>+
    <span class="hljs-comment">//返回锁的过期时间。</span>
    <span class="hljs-string">"return redis.call('pttl', KEYS[1]);"</span>, 
    Collections.singletonList(<span class="hljs-keyword">this</span>.getRawName()), new Object[]{unit.toMillis(leaseTime), <span class="hljs-keyword">this</span>.getLockName(threadId)});
}
</code></pre>
<p>获取锁的整个逻辑是：
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7303c1cfaf4549c39ec9472e6462b533~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgc2lyNzYx:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766822478&amp;x-signature=QQsH%2FZidVMS0dKLq54qchV%2F1e0E%3D" alt="分布式锁获取过程.drawio-1764576921173-4.png" loading="lazy"/>
首先，如果用户调用获取锁时候没有限制租约时间，redisson会自动给tryLockInnerAsync加上一个30秒的租约时间，并调用scheduleExpirationRenewal进行看门狗机制</p>
<p>tryLockInnerAsync是执行了一个lua脚本，首先redisson他采用的是hash来存放这个锁，key是锁的名字，field由UUID和线程id组成（UUID是区分不同客户端，防止不同客户端但是线程名恰好相同），value是锁的重入次数。这样就避免了锁的误删，重入和死锁问题了。lua的大致流程为：</p>
<ol>
<li>先判断当前锁是否被持有或者持有者是否是当前线程，如果是的话重入次数加1，并设置/重置整个锁 Key 的过期时间（防止死锁）然后返回。</li>
<li>如果上面if不成立说明锁被<strong>别人</strong>持有了，则返回当前锁剩余的存活时间（TTL）。客户端拿到这个时间后，会等待这么久再重试。</li>
</ol>
<p>回到刚刚我们忽略的代码：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">lock</span><span class="hljs-params">(<span class="hljs-type">long</span> leaseTime, TimeUnit unit, <span class="hljs-type">boolean</span> interruptibly)</span> <span class="hljs-keyword">throws</span> InterruptedException {
    <span class="hljs-type">long</span> <span class="hljs-variable">threadId</span> <span class="hljs-operator">=</span> Thread.currentThread().getId();
    <span class="hljs-type">Long</span> <span class="hljs-variable">ttl</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.tryAcquire(-<span class="hljs-number">1L</span>, leaseTime, unit, threadId);
    <span class="hljs-comment">//如果这里ttl不为空说明锁被人占有了。</span>
    <span class="hljs-keyword">if</span> (ttl != <span class="hljs-literal">null</span>) {
        <span class="hljs-comment">//此时使用pub/sub订阅这个管道</span>
        CompletableFuture&lt;RedissonLockEntry&gt; future = <span class="hljs-built_in">this</span>.subscribe(threadId);
        <span class="hljs-built_in">this</span>.pubSub.timeout(future);
        <span class="hljs-comment">//内部维护了一个Semaphore用于控制本地线程的阻塞和唤醒</span>
        RedissonLockEntry entry;
        <span class="hljs-keyword">if</span> (interruptibly) {
            entry = (RedissonLockEntry)<span class="hljs-built_in">this</span>.commandExecutor.getInterrupted(future);
        } <span class="hljs-keyword">else</span> {
            entry = (RedissonLockEntry)<span class="hljs-built_in">this</span>.commandExecutor.get(future);
        }
​
        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">//死循环直到获取锁或者被中断</span>
            <span class="hljs-keyword">while</span>(<span class="hljs-literal">true</span>) {
                <span class="hljs-comment">//先乐观查询一次</span>
                ttl = <span class="hljs-built_in">this</span>.tryAcquire(-<span class="hljs-number">1L</span>, leaseTime, unit, threadId);
                <span class="hljs-keyword">if</span> (ttl == <span class="hljs-literal">null</span>) {
                    <span class="hljs-keyword">return</span>;
                }
               <span class="hljs-comment">//仍然没有获取到锁则进入阻塞阶段</span>
                <span class="hljs-keyword">if</span> (ttl &gt;= <span class="hljs-number">0L</span>) {
                    <span class="hljs-keyword">try</span> {
                        <span class="hljs-comment">//通过ttl时间判断锁还有多久释放，从而判断阻塞多久，避免cpu空转带来性能消耗，精准在锁释放时候唤醒</span>
                        <span class="hljs-comment">//当有人释放锁了,redisson监听到了之后调用entry.getLatch().release(),或者到达ttl了都会使线程被唤醒</span>
                        entry.getLatch().tryAcquire(ttl, TimeUnit.MILLISECONDS);
                    } <span class="hljs-keyword">catch</span> (InterruptedException var14) {
                        <span class="hljs-type">InterruptedException</span> <span class="hljs-variable">e</span> <span class="hljs-operator">=</span> var14;
                        <span class="hljs-keyword">if</span> (interruptibly) {
                            <span class="hljs-keyword">throw</span> e;
                        }
                        <span class="hljs-comment">//出现异常了，重新抢锁</span>
                        entry.getLatch().tryAcquire(ttl, TimeUnit.MILLISECONDS);
                    }
                } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (interruptibly) {
                    entry.getLatch().acquire();
                } <span class="hljs-keyword">else</span> {
                    entry.getLatch().acquireUninterruptibly();
                }
            }
        } <span class="hljs-keyword">finally</span> {
            <span class="hljs-comment">//最后终止订阅。</span>
            <span class="hljs-built_in">this</span>.unsubscribe(entry, threadId);
        }
    }
}
</code></pre>
<p>解锁的逻辑：</p>
<p>跟加锁逻辑一样都是异步转换同步。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> RFuture&lt;Void&gt; <span class="hljs-title function_">unlockAsync</span><span class="hljs-params">(<span class="hljs-type">long</span> threadId)</span> {
    <span class="hljs-type">String</span> <span class="hljs-variable">requestId</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.getServiceManager().generateId();
    <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.getServiceManager().execute(() -&gt; {
        <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.unlockAsync0(threadId, requestId);
    });
}
​
<span class="hljs-keyword">private</span> RFuture&lt;Void&gt; <span class="hljs-title function_">unlockAsync0</span><span class="hljs-params">(<span class="hljs-type">long</span> threadId, String requestId)</span> {
    CompletionStage&lt;Boolean&gt; future = <span class="hljs-built_in">this</span>.unlockInnerAsync(threadId, requestId);
    <span class="hljs-comment">//处理异常</span>
    CompletionStage&lt;Void&gt; f = future.handle((res, e) -&gt; {
        <span class="hljs-built_in">this</span>.cancelExpirationRenewal(threadId, res);
        <span class="hljs-keyword">if</span> (e != <span class="hljs-literal">null</span>) {
            <span class="hljs-keyword">if</span> (e <span class="hljs-keyword">instanceof</span> CompletionException) {
                <span class="hljs-keyword">throw</span> (CompletionException)e;
            } <span class="hljs-keyword">else</span> {
                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CompletionException</span>(e);
            }
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (res == <span class="hljs-literal">null</span>) {
            <span class="hljs-type">IllegalMonitorStateException</span> <span class="hljs-variable">cause</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalMonitorStateException</span>(<span class="hljs-string">"attempt to unlock lock, not locked by current thread by node id: "</span> + <span class="hljs-built_in">this</span>.id + <span class="hljs-string">" thread-id: "</span> + threadId);
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CompletionException</span>(cause);
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
        }
    });
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CompletableFutureWrapper</span>(f);
}
​
<span class="hljs-keyword">protected</span> <span class="hljs-keyword">final</span> RFuture&lt;Boolean&gt; <span class="hljs-title function_">unlockInnerAsync</span><span class="hljs-params">(<span class="hljs-type">long</span> threadId, String requestId)</span> {
    <span class="hljs-keyword">if</span> (requestId == <span class="hljs-literal">null</span>) {
        requestId = <span class="hljs-built_in">this</span>.getServiceManager().generateId();
    }
​
    <span class="hljs-type">MasterSlaveServersConfig</span> <span class="hljs-variable">config</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.getServiceManager().getConfig();
    <span class="hljs-type">long</span> <span class="hljs-variable">timeout</span> <span class="hljs-operator">=</span> ((<span class="hljs-type">long</span>)config.getTimeout() + config.getRetryDelay().calcDelay(config.getRetryAttempts()).toMillis()) * (<span class="hljs-type">long</span>)config.getRetryAttempts();
    timeout = Math.max(timeout, <span class="hljs-number">1L</span>);
    <span class="hljs-comment">//异步释放锁</span>
    RFuture&lt;Boolean&gt; r = <span class="hljs-built_in">this</span>.unlockInnerAsync(threadId, requestId, (<span class="hljs-type">int</span>)timeout);
    CompletionStage&lt;Boolean&gt; ff = r.thenApply((v) -&gt; {
        <span class="hljs-type">CommandAsyncExecutor</span> <span class="hljs-variable">ce</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.commandExecutor;
        <span class="hljs-keyword">if</span> (ce <span class="hljs-keyword">instanceof</span> CommandBatchService) {
            ce = <span class="hljs-keyword">new</span> <span class="hljs-title class_">CommandBatchService</span>(<span class="hljs-built_in">this</span>.commandExecutor);
        }
​
        ((CommandAsyncExecutor)ce).writeAsync(<span class="hljs-built_in">this</span>.getRawName(), LongCodec.INSTANCE, RedisCommands.DEL, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]{<span class="hljs-built_in">this</span>.getUnlockLatchName(<span class="hljs-built_in">this</span>.id)});
        <span class="hljs-keyword">if</span> (ce <span class="hljs-keyword">instanceof</span> CommandBatchService) {
            ((CommandBatchService)ce).executeAsync();
        }
​
        <span class="hljs-keyword">return</span> v;
    });
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CompletableFutureWrapper</span>(ff);
}
​
<span class="hljs-keyword">protected</span> RFuture&lt;Boolean&gt; <span class="hljs-title function_">unlockInnerAsync</span><span class="hljs-params">(<span class="hljs-type">long</span> threadId, String requestId, <span class="hljs-type">int</span> timeout)</span> {
    <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.evalWriteSyncedNoRetryAsync(<span class="hljs-built_in">this</span>.getRawName(), LongCodec.INSTANCE, RedisCommands.EVAL_BOOLEAN,
<span class="hljs-comment">//防重检查（幂等性）</span>
<span class="hljs-string">"local val = redis.call('get', KEYS[3]);"</span>+
<span class="hljs-string">"if val ~= false then "</span>+
    <span class="hljs-string">"return tonumber(val);"</span>+
<span class="hljs-string">"end;"</span>+
<span class="hljs-comment">//判断是否持有锁</span>
<span class="hljs-string">"if (redis.call('hexists', KEYS[1], ARGV[3]) == 0) then "</span>+
    <span class="hljs-string">"return nil;"</span>+
<span class="hljs-string">"end; "</span>+
<span class="hljs-comment">//扣减重入次数</span>
<span class="hljs-string">"local counter = redis.call('hincrby', KEYS[1], ARGV[3], -1); "</span>+
<span class="hljs-comment">//判断是“重入释放”还是“彻底释放”</span>
<span class="hljs-string">"if (counter &gt; 0) then "</span>+
    <span class="hljs-comment">//重入次数减1</span>
    <span class="hljs-string">"redis.call('pexpire', KEYS[1], ARGV[2]); "</span>+
    <span class="hljs-string">"redis.call('set', KEYS[3], 0, 'px', ARGV[5]); "</span>+
<span class="hljs-string">"return 0; "</span>+
<span class="hljs-string">"else "</span>+
    <span class="hljs-comment">//彻底释放锁</span>
    <span class="hljs-string">"redis.call('del', KEYS[1]); "</span>+
    <span class="hljs-comment">//发送队列消息</span>
    <span class="hljs-string">"redis.call(ARGV[4], KEYS[2], ARGV[1]); "</span>+
    <span class="hljs-string">"redis.call('set', KEYS[3], 1, 'px', ARGV[5]); "</span>+
    <span class="hljs-string">"return 1; "</span>+
<span class="hljs-string">"end; "</span>,
Arrays.asList(<span class="hljs-built_in">this</span>.getRawName(), <span class="hljs-built_in">this</span>.getChannelName(), <span class="hljs-built_in">this</span>.getUnlockLatchName(requestId)), <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]{LockPubSub.UNLOCK_MESSAGE, <span class="hljs-built_in">this</span>.internalLockLeaseTime, <span class="hljs-built_in">this</span>.getLockName(threadId), <span class="hljs-built_in">this</span>.getSubscribeService().getPublishCommand(), timeout});
}
</code></pre>
<p>lua的流程为：</p>
<p>先去查一下 KEYS[3]（查看解锁请求的结果缓存）是否存在。如果存在，说明<strong>这个请求之前已经处理过了</strong>（可能是网络波动导致客户端以为超时了，重发了请求）。直接返回之前缓存的结果（0 或 1），不需要再执行后面的逻辑。这保证了<strong>幂等性</strong>。</p>
<ol start="0">
<li>检查 Hash KEYS[1] 中是否存在当前线程 ARGV[3]。如果不存在（== 0），说明当前线程根本没有持有这把锁。返回 nil（Java 客户端会抛出 IllegalMonitorStateException）。</li>
<li>将该线程的加锁计数器减 1，counter 是减完之后剩下的次数。</li>
<li>如果counter &gt; 0，说明锁重入了。pexpire：刷新锁的过期时间（看门狗时间），只要锁还没彻底释放，就得给它续命。set KEYS[3] 0：记录本次请求结果为 0（表示未完全释放）。返回 0，代表还未释放锁。</li>
<li>如果counter&lt;=0，说明锁此时可以释放了，这里会先删除这个锁对应的key，然后调用<code>redis.call(ARGV[4], KEYS[2], ARGV[1]);</code>这里ARGC[4]其实通常是publish发送消息，之所以不写死是因为集群下可以用spublish加快性能。这里发送消息是为了前文提到的，告诉监听者锁已经释放。set KEYS[3] 1：缓存本次请求结果为 1，并将1返回，代表锁成功释放了</li>
</ol>
<p>这里之所以要多出一个KEY[3]是为了<strong>做幂等</strong>。KEY[3]命名一般为{锁前缀}:{锁名}:{requestId}，每次请求时候都会带上不同的requestId，vlaue是requestId请求的解锁结果</p>
<p>存在一种可能，客户端重入了2次锁，客户端第一次调用unlock时候，redis正常执行了解锁逻辑，并扣减了1次锁记录，但是由于网络波动，响应丢失了，此时客户端会重新发起一次请求，导致重复扣减。为了解决这个问题，就利用key[3]，判断一下相同的请求id是否有记录如果是就代表确实发送了响应丢失，直接将上次的数据返回，避免重复解锁。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/eedf6a2fdad34405a4e6a6423c17e22a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgc2lyNzYx:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766822478&amp;x-signature=KTTnPGHIo7Up7jT%2F0NvTi7QGW1I%3D" alt="Redisson锁数据结构.drawio.png" loading="lazy"/></p>
<h3 data-id="heading-1">公平锁</h3>
<p>以上锁是默认非公平锁，所有线程都去争抢锁，而公平锁则是进入队列等待，防止饥饿问题。</p>
<p>当我们getFairLock时候其实是new了一个RedissonFairLock</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">public</span> <span class="hljs-title class_">RLock</span> <span class="hljs-title function_">getFairLock</span>(<span class="hljs-params"><span class="hljs-built_in">String</span> name</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RedissonFairLock</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">commandExecutor</span>, name);
}
</code></pre>
<p>RedissonFairLock继承自RedissonLock也就是说加锁的流程都是大致相同的。RedissonFairLock重写了tryLockInnerAsync方法</p>
<pre><code class="hljs language-ini" lang="ini">&lt;T&gt; RFuture&lt;T&gt; tryLockInnerAsync(long waitTime, long leaseTime, TimeUnit unit, long threadId, RedisStrictCommand&lt;T&gt; command) {
    long <span class="hljs-attr">wait</span> = this.threadWaitTime<span class="hljs-comment">;</span>
    if (waitTime &gt; 0L) {
        <span class="hljs-attr">wait</span> = unit.toMillis(waitTime)<span class="hljs-comment">;</span>
    }
​
    long <span class="hljs-attr">currentTime</span> = System.currentTimeMillis()<span class="hljs-comment">;</span>
    if (<span class="hljs-attr">command</span> == RedisCommands.EVAL_NULL_BOOLEAN) {
        return this.commandExecutor.syncedEvalNoRetry(
            this.getRawName(),
            LongCodec.INSTANCE,
            command,
            // Lua脚本 - 用于获取锁
            "while true do " +
            "    local <span class="hljs-attr">firstThreadId2</span> = redis.call(<span class="hljs-string">'lindex'</span>, KEYS[<span class="hljs-number">2</span>], <span class="hljs-number">0</span>)<span class="hljs-comment">; " +</span>
            "    if <span class="hljs-attr">firstThreadId2</span> == <span class="hljs-literal">false</span> then <span class="hljs-string">" +
            "</span>        break<span class="hljs-comment">; " +</span>
            "    end<span class="hljs-comment">; " +</span>
            "    local <span class="hljs-attr">timeout</span> = redis.call(<span class="hljs-string">'zscore'</span>, KEYS[<span class="hljs-number">3</span>], firstThreadId2)<span class="hljs-comment">; " +</span>
            "    if timeout ~= false and tonumber(timeout) &lt;= tonumber(ARGV<span class="hljs-section">[3]</span>) then " +
            "        redis.call('zrem', KEYS<span class="hljs-section">[3]</span>, firstThreadId2)<span class="hljs-comment">; " +</span>
            "        redis.call('lpop', KEYS<span class="hljs-section">[2]</span>)<span class="hljs-comment">; " +</span>
            "    else " +
            "        break<span class="hljs-comment">; " +</span>
            "    end<span class="hljs-comment">; " +</span>
            "end<span class="hljs-comment">; " +</span>
            "if (redis.call('exists', KEYS<span class="hljs-section">[1]</span>) == 0) and ((redis.call('exists', KEYS<span class="hljs-section">[2]</span>) == 0) or (redis.call('lindex', KEYS<span class="hljs-section">[2]</span>, 0) == ARGV<span class="hljs-section">[2]</span>)) then " +
            "    redis.call('lpop', KEYS<span class="hljs-section">[2]</span>)<span class="hljs-comment">; " +</span>
            "    redis.call('zrem', KEYS<span class="hljs-section">[3]</span>, ARGV<span class="hljs-section">[2]</span>)<span class="hljs-comment">; " +</span>
            "    local <span class="hljs-attr">keys</span> = redis.call(<span class="hljs-string">'zrange'</span>, KEYS[<span class="hljs-number">3</span>], <span class="hljs-number">0</span>, -<span class="hljs-number">1</span>)<span class="hljs-comment">; " +</span>
            "    for <span class="hljs-attr">i</span> = <span class="hljs-number">1</span>, <span class="hljs-comment">#keys, 1 do " +</span>
            "        redis.call('zincrby', KEYS<span class="hljs-section">[3]</span>, -tonumber(ARGV<span class="hljs-section">[4]</span>), keys<span class="hljs-section">[i]</span>)<span class="hljs-comment">; " +</span>
            "    end<span class="hljs-comment">; " +</span>
            "    redis.call('hset', KEYS<span class="hljs-section">[1]</span>, ARGV<span class="hljs-section">[2]</span>, 1)<span class="hljs-comment">; " +</span>
            "    redis.call('pexpire', KEYS<span class="hljs-section">[1]</span>, ARGV<span class="hljs-section">[1]</span>)<span class="hljs-comment">; " +</span>
            "    return nil<span class="hljs-comment">; " +</span>
            "end<span class="hljs-comment">; " +</span>
            "if (redis.call('hexists', KEYS<span class="hljs-section">[1]</span>, ARGV<span class="hljs-section">[2]</span>) == 1) then " +
            "    redis.call('hincrby', KEYS<span class="hljs-section">[1]</span>, ARGV<span class="hljs-section">[2]</span>, 1)<span class="hljs-comment">; " +</span>
            "    redis.call('pexpire', KEYS<span class="hljs-section">[1]</span>, ARGV<span class="hljs-section">[1]</span>)<span class="hljs-comment">; " +</span>
            "    return nil<span class="hljs-comment">; " +</span>
            "end<span class="hljs-comment">; " +</span>
            "return 1<span class="hljs-comment">;",</span>
            Arrays.asList(this.getRawName(), this.threadsQueueName, this.timeoutSetName),
            new Object<span class="hljs-section">[]</span>{unit.toMillis(leaseTime), this.getLockName(threadId), currentTime, wait}
        )<span class="hljs-comment">;</span>
    } else if (<span class="hljs-attr">command</span> == RedisCommands.EVAL_LONG) {
        return this.commandExecutor.syncedEvalNoRetry(
            this.getRawName(),
            LongCodec.INSTANCE,
            command,
            // Lua脚本 - 用于尝试获取锁并返回TTL
            "while true do " +
            "    local <span class="hljs-attr">firstThreadId2</span> = redis.call(<span class="hljs-string">'lindex'</span>, KEYS[<span class="hljs-number">2</span>], <span class="hljs-number">0</span>)<span class="hljs-comment">; " +</span>
            "    if <span class="hljs-attr">firstThreadId2</span> == <span class="hljs-literal">false</span> then <span class="hljs-string">" +
            "</span>        break<span class="hljs-comment">; " +</span>
            "    end<span class="hljs-comment">; " +</span>
            "    local <span class="hljs-attr">timeout</span> = redis.call(<span class="hljs-string">'zscore'</span>, KEYS[<span class="hljs-number">3</span>], firstThreadId2)<span class="hljs-comment">; " +</span>
            "    if timeout ~= false and tonumber(timeout) &lt;= tonumber(ARGV<span class="hljs-section">[4]</span>) then " +
            "        redis.call('zrem', KEYS<span class="hljs-section">[3]</span>, firstThreadId2)<span class="hljs-comment">; " +</span>
            "        redis.call('lpop', KEYS<span class="hljs-section">[2]</span>)<span class="hljs-comment">; " +</span>
            "    else " +
            "        break<span class="hljs-comment">; " +</span>
            "    end<span class="hljs-comment">; " +</span>
            "end<span class="hljs-comment">; " +</span>
            "if (redis.call('exists', KEYS<span class="hljs-section">[1]</span>) == 0) and ((redis.call('exists', KEYS<span class="hljs-section">[2]</span>) == 0) or (redis.call('lindex', KEYS<span class="hljs-section">[2]</span>, 0) == ARGV<span class="hljs-section">[2]</span>)) then " +
            "    redis.call('lpop', KEYS<span class="hljs-section">[2]</span>)<span class="hljs-comment">; " +</span>
            "    redis.call('zrem', KEYS<span class="hljs-section">[3]</span>, ARGV<span class="hljs-section">[2]</span>)<span class="hljs-comment">; " +</span>
            "    local <span class="hljs-attr">keys</span> = redis.call(<span class="hljs-string">'zrange'</span>, KEYS[<span class="hljs-number">3</span>], <span class="hljs-number">0</span>, -<span class="hljs-number">1</span>)<span class="hljs-comment">; " +</span>
            "    for <span class="hljs-attr">i</span> = <span class="hljs-number">1</span>, <span class="hljs-comment">#keys, 1 do " +</span>
            "        redis.call('zincrby', KEYS<span class="hljs-section">[3]</span>, -tonumber(ARGV<span class="hljs-section">[3]</span>), keys<span class="hljs-section">[i]</span>)<span class="hljs-comment">; " +</span>
            "    end<span class="hljs-comment">; " +</span>
            "    redis.call('hset', KEYS<span class="hljs-section">[1]</span>, ARGV<span class="hljs-section">[2]</span>, 1)<span class="hljs-comment">; " +</span>
            "    redis.call('pexpire', KEYS<span class="hljs-section">[1]</span>, ARGV<span class="hljs-section">[1]</span>)<span class="hljs-comment">; " +</span>
            "    return nil<span class="hljs-comment">; " +</span>
            "end<span class="hljs-comment">; " +</span>
            "if redis.call('hexists', KEYS<span class="hljs-section">[1]</span>, ARGV<span class="hljs-section">[2]</span>) == 1 then " +
            "    redis.call('hincrby', KEYS<span class="hljs-section">[1]</span>, ARGV<span class="hljs-section">[2]</span>, 1)<span class="hljs-comment">; " +</span>
            "    redis.call('pexpire', KEYS<span class="hljs-section">[1]</span>, ARGV<span class="hljs-section">[1]</span>)<span class="hljs-comment">; " +</span>
            "    return nil<span class="hljs-comment">; " +</span>
            "end<span class="hljs-comment">; " +</span>
            "local <span class="hljs-attr">timeout</span> = redis.call(<span class="hljs-string">'zscore'</span>, KEYS[<span class="hljs-number">3</span>], ARGV[<span class="hljs-number">2</span>])<span class="hljs-comment">; " +</span>
            "if timeout ~= false then " +
            "    local <span class="hljs-attr">ttl</span> = redis.call(<span class="hljs-string">'pttl'</span>, KEYS[<span class="hljs-number">1</span>])<span class="hljs-comment">; " +</span>
            "    return math.max(0, ttl)<span class="hljs-comment">; " +</span>
            "end<span class="hljs-comment">; " +</span>
            "local <span class="hljs-attr">lastThreadId</span> = redis.call(<span class="hljs-string">'lindex'</span>, KEYS[<span class="hljs-number">2</span>], -<span class="hljs-number">1</span>)<span class="hljs-comment">; " +</span>
            "local ttl<span class="hljs-comment">; " +</span>
            "if lastThreadId ~= false and lastThreadId ~= ARGV<span class="hljs-section">[2]</span> and redis.call('zscore', KEYS<span class="hljs-section">[3]</span>, lastThreadId) ~= false then " +
            "    <span class="hljs-attr">ttl</span> = tonumber(redis.call(<span class="hljs-string">'zscore'</span>, KEYS[<span class="hljs-number">3</span>], lastThreadId)) - tonumber(ARGV[<span class="hljs-number">4</span>])<span class="hljs-comment">; " +</span>
            "else " +
            "    <span class="hljs-attr">ttl</span> = redis.call(<span class="hljs-string">'pttl'</span>, KEYS[<span class="hljs-number">1</span>])<span class="hljs-comment">; " +</span>
            "end<span class="hljs-comment">; " +</span>
            "local <span class="hljs-attr">timeout</span> = ttl + tonumber(ARGV[<span class="hljs-number">3</span>]) + tonumber(ARGV[<span class="hljs-number">4</span>])<span class="hljs-comment">; " +</span>
            "if redis.call('zadd', KEYS<span class="hljs-section">[3]</span>, timeout, ARGV<span class="hljs-section">[2]</span>) == 1 then " +
            "    redis.call('rpush', KEYS<span class="hljs-section">[2]</span>, ARGV<span class="hljs-section">[2]</span>)<span class="hljs-comment">; " +</span>
            "end<span class="hljs-comment">; " +</span>
            "return ttl<span class="hljs-comment">;",</span>
            Arrays.asList(this.getRawName(), this.threadsQueueName, this.timeoutSetName),
            new Object<span class="hljs-section">[]</span>{unit.toMillis(leaseTime), this.getLockName(threadId), wait, currentTime}
        )<span class="hljs-comment">;</span>
    } else {
        throw new IllegalArgumentException()<span class="hljs-comment">;</span>
    }
}
</code></pre>
<p>这里有俩段lua脚本，第一段对应的是无参的tryLock（）方法，进行一次快速尝试，如果获取不到锁直接返回。第二段对应的是tryLock(waitTime)/lock这俩个阻塞等锁的方法。这里我们重点看第二段lua脚本，第一个lua脚本和第二个类似：</p>
<pre><code class="hljs language-java" lang="java">--循环的判断是否有waitTime已经超过的节点，如果有就剔除掉，防止占用着队列
<span class="hljs-keyword">while</span> <span class="hljs-literal">true</span> <span class="hljs-keyword">do</span> 
    --查询等待队列头节点是什么
    <span class="hljs-type">local</span> <span class="hljs-variable">firstThreadId2</span> <span class="hljs-operator">=</span> redis.call(<span class="hljs-string">'lindex'</span>, KEYS[<span class="hljs-number">2</span>], <span class="hljs-number">0</span>); 
    --如果等待队列为空则跳出循环
    <span class="hljs-keyword">if</span> firstThreadId2 == <span class="hljs-literal">false</span> then 
        <span class="hljs-keyword">break</span>; 
    end; 
    --不为空，判断一下是否超过了超时时间，如果是就删除掉，没有就跳出循环
    <span class="hljs-type">local</span> <span class="hljs-variable">timeout</span> <span class="hljs-operator">=</span> redis.call(<span class="hljs-string">'zscore'</span>, KEYS[<span class="hljs-number">3</span>], firstThreadId2); 
    <span class="hljs-keyword">if</span> timeout ~= <span class="hljs-literal">false</span> and <span class="hljs-title function_">tonumber</span><span class="hljs-params">(timeout)</span> &lt;= tonumber(ARGV[<span class="hljs-number">4</span>]) then 
        redis.call(<span class="hljs-string">'zrem'</span>, KEYS[<span class="hljs-number">3</span>], firstThreadId2); 
        redis.call(<span class="hljs-string">'lpop'</span>, KEYS[<span class="hljs-number">2</span>]); 
    <span class="hljs-keyword">else</span> 
        <span class="hljs-keyword">break</span>; 
    end; 
end; 
--判断一下锁是否没有被其他线程持有并且等待队列不存在（等待队列为空）或者对头是此线程，如果是则进入抢锁。
<span class="hljs-keyword">if</span> (redis.call(<span class="hljs-string">'exists'</span>, KEYS[<span class="hljs-number">1</span>]) == <span class="hljs-number">0</span>) and ((redis.call(<span class="hljs-string">'exists'</span>, KEYS[<span class="hljs-number">2</span>]) == <span class="hljs-number">0</span>) or (redis.call(<span class="hljs-string">'lindex'</span>, KEYS[<span class="hljs-number">2</span>], <span class="hljs-number">0</span>) == ARGV[<span class="hljs-number">2</span>])) then 
    --将自己从队列移除
    redis.call(<span class="hljs-string">'lpop'</span>, KEYS[<span class="hljs-number">2</span>]); 
    redis.call(<span class="hljs-string">'zrem'</span>, KEYS[<span class="hljs-number">3</span>], ARGV[<span class="hljs-number">2</span>]); 
    <span class="hljs-type">local</span> <span class="hljs-variable">keys</span> <span class="hljs-operator">=</span> redis.call(<span class="hljs-string">'zrange'</span>, KEYS[<span class="hljs-number">3</span>], <span class="hljs-number">0</span>, -<span class="hljs-number">1</span>); 
    --循环整个队列，更新所有节点的超时时间（减少等待预算）
    <span class="hljs-type">for</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span>, #keys, <span class="hljs-number">1</span> <span class="hljs-keyword">do</span> 
        redis.call(<span class="hljs-string">'zincrby'</span>, KEYS[<span class="hljs-number">3</span>], -tonumber(ARGV[<span class="hljs-number">3</span>]), keys[i]); 
    end; 
    --真正的加锁逻辑，加锁后直接返回。
    redis.call(<span class="hljs-string">'hset'</span>, KEYS[<span class="hljs-number">1</span>], ARGV[<span class="hljs-number">2</span>], <span class="hljs-number">1</span>); 
    redis.call(<span class="hljs-string">'pexpire'</span>, KEYS[<span class="hljs-number">1</span>], ARGV[<span class="hljs-number">1</span>]); 
    --返回nil说明抢锁成功
    <span class="hljs-keyword">return</span> nil; 
end; 
--前面判断为<span class="hljs-literal">false</span>，说明锁被持有了，判断一下锁是否被本线程持有，如果是重入加<span class="hljs-number">1</span>并返回
<span class="hljs-keyword">if</span> redis.call(<span class="hljs-string">'hexists'</span>, KEYS[<span class="hljs-number">1</span>], ARGV[<span class="hljs-number">2</span>]) == <span class="hljs-number">1</span> then 
    redis.call(<span class="hljs-string">'hincrby'</span>, KEYS[<span class="hljs-number">1</span>], ARGV[<span class="hljs-number">2</span>], <span class="hljs-number">1</span>); 
    redis.call(<span class="hljs-string">'pexpire'</span>, KEYS[<span class="hljs-number">1</span>], ARGV[<span class="hljs-number">1</span>]); 
    <span class="hljs-keyword">return</span> nil; 
end; 
--走到这里说明锁被其他人持有了，此时判断一下本线程是否已经在排队了
<span class="hljs-type">local</span> <span class="hljs-variable">timeout</span> <span class="hljs-operator">=</span> redis.call(<span class="hljs-string">'zscore'</span>, KEYS[<span class="hljs-number">3</span>], ARGV[<span class="hljs-number">2</span>]); 
<span class="hljs-keyword">if</span> timeout ~= <span class="hljs-literal">false</span> then 
    --如果在排队了，则返回锁的剩余持有时间
    <span class="hljs-type">local</span> <span class="hljs-variable">ttl</span> <span class="hljs-operator">=</span> redis.call(<span class="hljs-string">'pttl'</span>, KEYS[<span class="hljs-number">1</span>]); 
    <span class="hljs-keyword">return</span> math.max(<span class="hljs-number">0</span>, ttl); 
end; 
--走到这里说明没有入队，先查看一下队尾节点
<span class="hljs-type">local</span> <span class="hljs-variable">lastThreadId</span> <span class="hljs-operator">=</span> redis.call(<span class="hljs-string">'lindex'</span>, KEYS[<span class="hljs-number">2</span>], -<span class="hljs-number">1</span>); 
local ttl; 
--如果队尾节点存在（锁被持有，有线程等待抢锁）则ttl是钱一个人的超时时间-当前时间。
<span class="hljs-keyword">if</span> lastThreadId ~= <span class="hljs-literal">false</span> and lastThreadId ~= ARGV[<span class="hljs-number">2</span>] and redis.call(<span class="hljs-string">'zscore'</span>, KEYS[<span class="hljs-number">3</span>], lastThreadId) ~= <span class="hljs-literal">false</span> <span class="hljs-type">then</span> 
    <span class="hljs-variable">ttl</span> <span class="hljs-operator">=</span> tonumber(redis.call(<span class="hljs-string">'zscore'</span>, KEYS[<span class="hljs-number">3</span>], lastThreadId)) - tonumber(ARGV[<span class="hljs-number">4</span>]); 
<span class="hljs-keyword">else</span> 
    --如果队尾节点不存在（锁被持有，且没有线程等待抢锁）则ttl就是锁的过期时间
    ttl = redis.call(<span class="hljs-string">'pttl'</span>, KEYS[<span class="hljs-number">1</span>]); 
end; 
<span class="hljs-type">local</span> <span class="hljs-variable">timeout</span> <span class="hljs-operator">=</span> ttl + tonumber(ARGV[<span class="hljs-number">3</span>]) + tonumber(ARGV[<span class="hljs-number">4</span>]); 
--然后入队，将计算好的超时时间放入Zset，并将本线程放入队尾。
<span class="hljs-keyword">if</span> redis.call(<span class="hljs-string">'zadd'</span>, KEYS[<span class="hljs-number">3</span>], timeout, ARGV[<span class="hljs-number">2</span>]) == <span class="hljs-number">1</span> then 
    redis.call(<span class="hljs-string">'rpush'</span>, KEYS[<span class="hljs-number">2</span>], ARGV[<span class="hljs-number">2</span>]); 
end; 
--返回告诉客户端，还需要时间为ttl，使用Semaphore去阻塞。（唤醒过程和前文提到过的一样）
<span class="hljs-keyword">return</span> ttl;
</code></pre>
<p>此过程中用到了Zset，List，我们直到List用于存放资源争抢者，那Zset又是干嘛的？</p>
<p>List 虽然能完美实现 FIFO（先进先出），但它有2个致命弱点：</p>
<ul>
<li><strong>不好判断过期时间</strong>：List 只能告诉你谁排第一，但不能告诉你他还是不是活的（有没有超时），如果非要利用List存储过期时间就得通过value去分割，不仅需要占用cpu资源而且不好判断如何分割，万一用户命名不规范导致分割错误，此时需要Zset，它存储了每个人的“死亡时间”，用来在每次操作前清理 List 里的僵尸节点。member是uuid+线程id，score是过期时间</li>
<li><strong>不好判断是否当前线程在队列中</strong>：List需要O(n)判断，时间慢，通过Zset的dict数据结构O(1)判断。</li>
</ul>
<p>此外，由于每一个节点有可能是lock（）这种无等待时间，会阻塞到一直获取锁，在Zset中难道我们要将Zset的过期分数设置很大或者设置为-1代表没有过期时间吗？那如果客户端宕机了，该节点不就占用这个Zset和list的节点，且谁也清除不掉，导致内存泄露。且轮到它作为头节点时候，又不会抢锁，导致全部都在死等。</p>
<p>旧版本的redisson是默认给5秒过期时间，每次5秒后就刷新一下，如果客户端宕机了就不会刷新，这个节点会被清除掉。但是当竞争激烈的时候5秒获取不到锁时候大量的线程醒过来同时去更新过期时间，这个惊群效应会导致性能急剧下降，后续新版本改为了5分钟。</p>
<p>如图，比起非公平锁多了俩个数据结构</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6fcdc19af5dd40fcb4c907beb88fa65c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgc2lyNzYx:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766822478&amp;x-signature=fCOelRfQZtVqpd7k%2FW%2BCSTzULqE%3D" alt="分布式公平锁获取过程.drawio.png" loading="lazy"/></p>
<p>若有错误欢迎指出，将及时改正。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Kibana：使用 ES|QL 构建地图，对国家或地区的指标进行对比]]></title>    <link>https://juejin.cn/post/7585474459776335908</link>    <guid>https://juejin.cn/post/7585474459776335908</guid>    <pubDate>2025-12-20T08:22:04.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585474459776335908" data-draft-id="7585474459776319524" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Kibana：使用 ES|QL 构建地图，对国家或地区的指标进行对比"/> <meta itemprop="keywords" content="Elasticsearch"/> <meta itemprop="datePublished" content="2025-12-20T08:22:04.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Elasticsearch"/> <meta itemprop="url" content="https://juejin.cn/user/2612095360441448"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Kibana：使用 ES|QL 构建地图，对国家或地区的指标进行对比
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2612095360441448/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Elasticsearch
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-20T08:22:04.000Z" title="Sat Dec 20 2025 08:22:04 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>作者：来自 Elastic <a href="https://link.juejin.cn?target=https%3A%2F%2Fdiscuss.elastic.co%2Fu%2Fnathan_reese" title="https://discuss.elastic.co/u/nathan_reese" target="_blank" ref="nofollow noopener noreferrer">Nathan_Reese</a></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/856719b33e094553a77f3f6a06f3920a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRWxhc3RpY3NlYXJjaA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766823724&amp;x-signature=sIwkFyIrQn5FbGU4%2Ful7xVJkdLg%3D" alt="" loading="lazy"/></p>
<p>Kibana 地图 教程 “<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.elastic.co%2Fguide%2Fen%2Fkibana%2F8.19%2Fmaps-getting-started.html" title="https://www.elastic.co/guide/en/kibana/8.19/maps-getting-started.html" target="_blank" ref="nofollow noopener noreferrer">构建地图，用于按国家或地区对比指标</a>” 使用 Elasticsearch 的 DSL 查询 来创建地图。最近新增的 ES|QL 函数 <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.elastic.co%2Fdocs%2Freference%2Fquery-languages%2Fesql%2Fcommands%2Flookup-join" title="https://www.elastic.co/docs/reference/query-languages/esql/commands/lookup-join" target="_blank" ref="nofollow noopener noreferrer">LOOKUP JOIN</a>（ 8.18 ）和 <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.elastic.co%2Fdocs%2Freference%2Fquery-languages%2Fesql%2Ffunctions-operators%2Fspatial-functions%23esql-st_geotile" title="https://www.elastic.co/docs/reference/query-languages/esql/functions-operators/spatial-functions#esql-st_geotile" target="_blank" ref="nofollow noopener noreferrer">ST_GEOTILE</a>（ 9.2 ）使得可以使用 ES|QL 重新创建该教程中的地图。</p>
<p>下面是使用 ES|QL 重新创建该教程地图的步骤。随后，这些步骤还超出了原始教程的能力范围，并按国家人口对分级设色图层进行归一化处理。</p>
<h2 data-id="heading-0">前提条件</h2>
<ul>
<li>如果你还没有 Kibana，请使用我们的 <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.elastic.co%2Fcloud%2Felasticsearch-service%2Fsignup%3Fbaymax%3Ddocs-body%26elektra%3Ddocs" title="https://www.elastic.co/cloud/elasticsearch-service/signup?baymax=docs-body&amp;elektra=docs" target="_blank" ref="nofollow noopener noreferrer">免费试用</a> 进行设置。</li>
<li>本教程需要 <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.elastic.co%2Fguide%2Fen%2Fkibana%2F8.19%2Fget-started.html" title="https://www.elastic.co/guide/en/kibana/8.19/get-started.html" target="_blank" ref="nofollow noopener noreferrer">web logs 示例数据集</a>。</li>
<li>你必须具备创建地图和创建索引的正确权限。</li>
<li><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9ee18d03841d4a7b96cdced29f035bb0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRWxhc3RpY3NlYXJjaA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766823724&amp;x-signature=6L9%2BwGiBlMHJT3I5WumIGOqBYNM%3D" alt="" loading="lazy"/></li>
</ul>
<h2 data-id="heading-1">步骤 1：创建 地图</h2>
<ul>
<li>前往 Dashboards。</li>
<li>点击 Create dashboard。</li>
<li>将时间范围设置为 Last 7 days。</li>
<li>点击 Add 按钮并选择 New panel，最后点击 Maps。</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/75fc5d68a38a40f792bc5d21960ce2fb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRWxhc3RpY3NlYXJjaA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766823724&amp;x-signature=mJiW3kgJ8oYBKljJb4IvqZq81ls%3D" alt="" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/299c6ca01e7841c8b6e1531d07ad0624~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRWxhc3RpY3NlYXJjaA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766823724&amp;x-signature=scm067o%2BWSNTSko5PB19C0sNp5Y%3D" alt="" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fdad565309644328b1aaf0a42913a686~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRWxhc3RpY3NlYXJjaA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766823724&amp;x-signature=PtY7x5OTT9xrruWB1E2nPc8dI6I%3D" alt="" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6bf44c4e950944ca850b10893148010d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRWxhc3RpY3NlYXJjaA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766823724&amp;x-signature=lw1aRSNzzIR4M%2FTiDrYGyyi4L3I%3D" alt="" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/77d62ab1b5054e3c8e88a8af9ef37d81~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRWxhc3RpY3NlYXJjaA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766823724&amp;x-signature=nkla1tjbPRClZk0W0d0D4OzLjvI%3D" alt="" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c59530e10ed7425189a9495e511ae321~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRWxhc3RpY3NlYXJjaA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766823724&amp;x-signature=Ff2hpwV1S%2FqsEW9kp%2BWcWaYKlyA%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-2">步骤 2. 添加一个 choropleth 图层</h2>
<p>你将添加的第一个图层是一个 choropleth 图层，用于按 web 日志流量为世界各国着色。较深的颜色表示 web 日志流量较多的国家，较浅的颜色表示流量较少的国家。</p>
<h3 data-id="heading-3">索引世界国家</h3>
<ul>
<li>下载<a href="https://link.juejin.cn?target=https%3A%2F%2Fmaps.elastic.co%2F%23file%2Fworld_countries" title="https://maps.elastic.co/#file/world_countries" target="_blank" ref="nofollow noopener noreferrer">世界国家 GeoJSON</a> 文件</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cfefe39ae1fd487aa0309dddf21cd827~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRWxhc3RpY3NlYXJjaA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766823724&amp;x-signature=eACxlm%2BKon4ew2isg3ZK3iirlJw%3D" alt="" loading="lazy"/></p>
<ul>
<li>在 Kibana maps 中，点击 Add layer</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6248b5f4f086401e9d30e61074397de2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRWxhc3RpY3NlYXJjaA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766823724&amp;x-signature=1PagyFqjZttoljj5MD9LPscOGsw%3D" alt="" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/920a2f78b8384cf8b662807c1b109b30~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRWxhc3RpY3NlYXJjaA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766823724&amp;x-signature=%2BbCKB6%2FzjuUt5rIvcVSHa4%2BnWGc%3D" alt="" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2521840315d547edb220d8935431def9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRWxhc3RpY3NlYXJjaA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766823724&amp;x-signature=Zl4BlgIF%2F0OOIPL0i6Ld6kN6U5M%3D" alt="" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3077a8304ea04d90a34dcae0b504e448~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRWxhc3RpY3NlYXJjaA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766823724&amp;x-signature=mp%2BmwWXkFNUkH%2FNE%2FiBrxviIURM%3D" alt="" loading="lazy"/></p>
<ul>
<li>选择 Upload file</li>
<li>在文件选择器中选择世界国家 GeoJSON 文件</li>
<li>将 Index name 设置为 world_countries</li>
<li>打开 Advanced 部分</li>
<li>将 Index settings 设置为 { "index.mode": "lookup" }。</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/af35066cef874968a8f2ad7341c735bb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRWxhc3RpY3NlYXJjaA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766823724&amp;x-signature=HzesTFW6kVSrmxME6gU7qTWCows%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-4">添加 choropleth 图层</h3>
<ul>
<li>点击 Add layer</li>
<li>选择 ES|QL</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0edb88e6558f4c88852224e928da565f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRWxhc3RpY3NlYXJjaA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766823724&amp;x-signature=6a5vS%2Bc2eTHqlcillFK5yzGRL7A%3D" alt="" loading="lazy"/></p>
<ul>
<li>将 ES|QL statement 设置为</li>
</ul>

<pre><code class="hljs language-vbnet" lang="vbnet">`

<span class="hljs-number">1</span>.  <span class="hljs-keyword">FROM</span> kibana_sample_data_logs 
<span class="hljs-number">2</span>.  | STATS count = COUNT() <span class="hljs-keyword">BY</span> geo.dest 
<span class="hljs-number">3</span>.  | RENAME geo.dest <span class="hljs-keyword">AS</span> iso2.keyword 
<span class="hljs-number">4</span>.  | LOOKUP <span class="hljs-keyword">JOIN</span> world_countries <span class="hljs-keyword">ON</span> iso2.keyword 
<span class="hljs-number">5</span>.  | RENAME iso2.keyword <span class="hljs-keyword">AS</span> geo.dest 
<span class="hljs-number">6</span>.  | KEEP count, geometry, geo.dest

`AI写代码
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2412b1d2aa71444a9fe534fd845acb2b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRWxhc3RpY3NlYXJjaA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766823724&amp;x-signature=3ZPwYpEy%2BYvjLfGovf6N8EaRIv0%3D" alt="" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1cf38ada7d0845a5ba800dbe73770a4e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRWxhc3RpY3NlYXJjaA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766823724&amp;x-signature=OC6es0DwoXsYv4FNwA1XpZUzQqY%3D" alt="" loading="lazy"/></p>
<ul>
<li>点击 Add and continue</li>
<li>在 Layer settings 中，设置：
<ul>
<li>将 Name 设置为 Total Requests by Destination。</li>
<li>将 Opacity 设置为 50%。</li>
</ul>
</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/efe3b047e63e48edb6d1ea0fe2ad2d4e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRWxhc3RpY3NlYXJjaA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766823724&amp;x-signature=v9G2LV%2FfNUpVGK7PEYlowcM4eBY%3D" alt="" loading="lazy"/></p>
<ul>
<li>在 Layer style 中
<ul>
<li>将 Fill color 设置为 By value by count。选择 “grey to black” 颜色渐变。</li>
<li>将 Border color 设置为 “white”。4.</li>
</ul>
</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7cc5319e4c22433494754567f7f74405~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRWxhc3RpY3NlYXJjaA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766823724&amp;x-signature=YUzd07oNYRMnCTSqkJaV%2F%2FSTvv4%3D" alt="" loading="lazy"/></p>
<ul>
<li>点击 Keep changes。你的地图现在应该看起来像</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fce6da60d5fe4a64802c857e2a2d6112~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRWxhc3RpY3NlYXJjaA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766823724&amp;x-signature=12N4r%2FY7slCp05qi3N%2FK5r1b9Pg%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-5">步骤 3. 为 Elasticsearch 数据添加图层</h2>
<p>为了避免一次向用户展示过多数据，你将为 Elasticsearch 数据添加两个图层。第一个图层在用户放大地图时显示单个文档。第二个图层在用户缩小地图时显示聚合数据。</p>
<h3 data-id="heading-6">为单个文档添加图层</h3>
<p>此图层将 web 日志文档显示为点。<br/>
该图层仅在用户放大时可见。</p>
<ul>
<li>点击 Add layer</li>
<li>选择 ES|QL</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7195fa36fd744d3f9855a4cfabb3d640~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRWxhc3RpY3NlYXJjaA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766823724&amp;x-signature=gCo1jOY35J0wBj%2F0qorOOgWXYEg%3D" alt="" loading="lazy"/></p>
<ul>
<li>将 ES|QL statement 设置为</li>
</ul>

<pre><code class="hljs language-sql" lang="sql">`

<span class="hljs-number">1.</span>  <span class="hljs-keyword">FROM</span> kibana_sample_data_logs 
<span class="hljs-number">2.</span>  <span class="hljs-operator">|</span> KEEP geo.coordinates, agent, bytes, clientip, 
<span class="hljs-number">3.</span>         host, machine.os, request, response, <span class="hljs-type">timestamp</span> 
<span class="hljs-number">4.</span>  <span class="hljs-operator">|</span> LIMIT <span class="hljs-number">10000</span>

`AI写代码
</code></pre>
<ul>
<li>在 ES|QL 编辑器中点击 Run query</li>
<li>点击 Add and continue</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/730d8242b0514cb289a6009e5edb2f45~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRWxhc3RpY3NlYXJjaA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766823724&amp;x-signature=IAa4srQhlXSDFk3eyMxnM4nDgSg%3D" alt="" loading="lazy"/></p>
<ul>
<li>在 Layer settings 中，设置：
<ul>
<li>将 Name 设置为 Actual Requests。</li>
<li>将 Visibility 设置为范围 [9, 24]。</li>
</ul>
</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a28785535c8a4fe0b901ed166e835728~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRWxhc3RpY3NlYXJjaA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766823724&amp;x-signature=xnY1P%2BvT0tWOUUKOA3qxCy1F7KQ%3D" alt="" loading="lazy"/></p>
<ul>
<li>在 Layer style 中，设置：
<ul>
<li>将 Fill color 设置为 #2200FF。</li>
<li>将 Border width 设置为 0。</li>
</ul>
</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c07660b51c74440f857eebcc605b9587~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRWxhc3RpY3NlYXJjaA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766823724&amp;x-signature=h578EnyVh%2FZ%2BDvoqvQreP4Q%2BsZc%3D" alt="" loading="lazy"/></p>
<ul>
<li>点击 Keep changes。你的地图现在应该看起来像</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ff4d39c9221d44e1937a90308283b291~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRWxhc3RpY3NlYXJjaA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766823724&amp;x-signature=Dndj%2B%2F0T6IvXTXHZviJj8%2B2liSE%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-7">为聚合数据添加图层</h3>
<p>你将创建一个聚合数据图层，并仅在地图缩小时显示。较深的颜色表示 web 日志流量更多的网格，较浅的颜色表示流量较少的网格。较大的圆表示传输总字节更多的网格，较小的圆表示字节较少的网格。</p>
<ul>
<li>点击 Add layer</li>
<li>选择 ES|QL</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/26353c3fa7834282888e2f26d36aec0c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRWxhc3RpY3NlYXJjaA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766823724&amp;x-signature=hQR3rEIMLEI%2B%2Fc8HzcqE6AB1CcI%3D" alt="" loading="lazy"/></p>
<ul>
<li>将 ES|QL statement 设置为</li>
</ul>

<pre><code class="hljs language-ini" lang="ini">`

1.  FROM kibana_sample_data_logs  
2.  | EVAL <span class="hljs-attr">geotile</span> = ST_GEOTILE(geo.coordinates, <span class="hljs-number">6</span>) 
3.  | STATS <span class="hljs-attr">count</span> = COUNT(geotile), 
<span class="hljs-attr">4.          sumOfBytes</span> = SUM(bytes), 
<span class="hljs-attr">5.          centroid</span> = ST_CENTROID_AGG(geo.coordinates) BY geotile

`AI写代码
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/63cbfb4a468c4d9abb7b2c0a87b50320~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRWxhc3RpY3NlYXJjaA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766823724&amp;x-signature=tdOEyoqo1YDlLEb0j2xE4do33WE%3D" alt="" loading="lazy"/></p>
<ul>
<li>在 ES|QL 编辑器中点击 Run query</li>
<li>点击 Add 并继续</li>
<li>在 Layer settings 中，设置：
<ul>
<li>将 Name 设置为 Total Requests and Bytes。</li>
<li>将 Visibility 设置为范围 [0, 9]。</li>
</ul>
</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d8adbe05ff81480795b4230f56b6ccb6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRWxhc3RpY3NlYXJjaA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766823724&amp;x-signature=WzfyNO%2FWRy9KFKGGdTFvd1fJPrM%3D" alt="" loading="lazy"/></p>
<ul>
<li>在 Layer style 中，设置：
<ul>
<li>将 Fill color 设置为 By value by count</li>
<li>将 Border width 设置为 0。</li>
<li>将 Symbol size 设置为 By value by sumOfBytes。将最小尺寸设置为 7，最大尺寸设置为 25。</li>
<li>将 Label 设置为 By value by count</li>
</ul>
</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a1d9989a1d94426993b7a16386386185~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRWxhc3RpY3NlYXJjaA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766823724&amp;x-signature=nHcJDNQlFi7P%2F37bsJfSi7MIkSM%3D" alt="" loading="lazy"/></p>
<ul>
<li>点击 Keep changes。你的地图现在应该看起来像</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c273d329e9454d77883ac49f767a6d30~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRWxhc3RpY3NlYXJjaA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766823724&amp;x-signature=MRF3qen00nX22RKWkyljk9T4jDs%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-8">步骤 4. 按国家人口标准化 choropleth 图层</h2>
<p>第 2 步创建的 choropleth 图层按 web 日志流量为世界各国着色。由于各国人口不同，直接比较各国的计数并不公平。人口较多的国家可能有更多的 web 流量，而人口较少的国家流量较少。相反，你希望按人口调整后的 web 日志流量为世界各国着色。</p>
<p>ES|QL 可以通过考虑每个国家的总人口来对 web 日志计数进行标准化。我们将可视化每 100,000 人的 web 日志计数，而不是原始计数。现在，我们可以比较各国的标准化计数。</p>
<h3 data-id="heading-9">索引世界国家人口</h3>
<ul>
<li>下载 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnreese%2Fnotes%2Fraw%2Frefs%2Fheads%2Fmaster%2Fpopulations_2024.csv" title="https://github.com/nreese/notes/raw/refs/heads/master/populations_2024.csv" target="_blank" ref="nofollow noopener noreferrer">populations_2024.csv</a>文件。该文件来源于 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdata.worldbank.org%2Findicator%2FSP.POP.TOTL" title="https://data.worldbank.org/indicator/SP.POP.TOTL" target="_blank" ref="nofollow noopener noreferrer">World Bank Group</a>。 下载完毕后，我们必须重新命名文件后缀为 .csv 而不是 .txt。</li>
<li>在 Kibana 中，通过全局搜索字段进入 File upload。</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9427dce25b2d40b19f23333325109477~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRWxhc3RpY3NlYXJjaA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766823724&amp;x-signature=%2BP%2BpcFz4ng8SyOshN81%2FchfaYb8%3D" alt="" loading="lazy"/></p>
<ul>
<li>在文件选择器中选择 populations_2024.csv</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cbbce9d5ad5b44ac99a3384511c1f9d1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRWxhc3RpY3NlYXJjaA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766823724&amp;x-signature=6sZSjkloapPqJNPnUNct35TZXns%3D" alt="" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4d887ff51a0748e0918add6e011f0ad9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRWxhc3RpY3NlYXJjaA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766823724&amp;x-signature=9D%2BXR09h0e10Ujy40zE2pZ1lNDs%3D" alt="" loading="lazy"/></p>
<ul>
<li>将 New index name 设置为 populations</li>
<li>点击 Import</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1d0645d5615f44ae8348b930b15be4d9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRWxhc3RpY3NlYXJjaA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766823724&amp;x-signature=set59wxYd4DcSCXa8dEOARYIEw8%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-10">向 world_countries 索引添加人口字段</h3>
<p>使用 enrich processor 将人口数据添加到世界国家集合中。</p>
<ul>
<li>通过导航菜单或全局搜索字段进入 Developer tools。</li>
<li>创建一个 match enrichment policy</li>
</ul>

<pre><code class="hljs language-bash" lang="bash">`

1.  PUT /_enrich/policy/population_lookup
2.  {
3.    <span class="hljs-string">"match"</span>: {
4.      <span class="hljs-string">"indices"</span>: <span class="hljs-string">"populations"</span>,
5.      <span class="hljs-string">"match_field"</span>: <span class="hljs-string">"iso3"</span>,
6.      <span class="hljs-string">"enrich_fields"</span>: [ <span class="hljs-string">"population_2024"</span>]
7.    }
8.  }

`AI写代码
</code></pre>
<ul>
<li>要初始化该策略，运行：</li>
</ul>

<pre><code class="hljs language-bash" lang="bash">`POST /_enrich/policy/population_lookup/_execute`AI写代码
</code></pre>
<ul>
<li>要创建一个 ingest pipeline，运行：</li>
</ul>

<pre><code class="hljs language-bash" lang="bash">`

1.  PUT _ingest/pipeline/add_population_to_world_countries
2.  {
3.    <span class="hljs-string">"processors"</span>: [
4.      {
5.        <span class="hljs-string">"enrich"</span>: {
6.          <span class="hljs-string">"field"</span>: <span class="hljs-string">"iso3"</span>,
7.          <span class="hljs-string">"policy_name"</span>: <span class="hljs-string">"population_lookup"</span>,
8.          <span class="hljs-string">"target_field"</span>: <span class="hljs-string">"population"</span>,
9.          <span class="hljs-string">"ignore_missing"</span>: <span class="hljs-literal">true</span>,
10.          <span class="hljs-string">"ignore_failure"</span>: <span class="hljs-literal">true</span>
11.        }
12.      }
13.    ]
14.  }

`AI写代码![](https://csdnimg.cn/release/blogv2/dist/pc/img/runCode/icon-arrowwhite.png)
</code></pre>
<ul>
<li>要向 world_countries 添加人口数据，运行：</li>
</ul>

<pre><code class="hljs language-ini" lang="ini">`POST world_countries/_update_by_query?<span class="hljs-attr">pipeline</span>=add_population_to_world_countries`AI写代码
</code></pre>
<ul>
<li>在 Discover 中查看 world_countries 索引。每一行现在都包含 population.population_2024 列。</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b7a16b1b69204dffb9ac4dcb4a15e6d9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRWxhc3RpY3NlYXJjaA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766823724&amp;x-signature=93zdsqE99lKpjSnBXp4yIFDaQEg%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-11">在 ES|QL statement 中按人口标准化计数</h3>
<ul>
<li>点击 Total Requests by Destination 图层的 edit 按钮。</li>
<li>将 ES|QL statement 替换为</li>
</ul>

<pre><code class="hljs language-vbnet" lang="vbnet">`

<span class="hljs-number">1</span>.  <span class="hljs-keyword">FROM</span> kibana_sample_data_logs 
<span class="hljs-number">2</span>.  | STATS count = COUNT() <span class="hljs-keyword">BY</span> geo.dest 
<span class="hljs-number">3</span>.  | RENAME geo.dest <span class="hljs-keyword">AS</span> iso2.keyword 
<span class="hljs-number">4</span>.  | LOOKUP <span class="hljs-keyword">JOIN</span> world_countries <span class="hljs-keyword">ON</span> iso2.keyword 
<span class="hljs-number">5</span>.  | RENAME iso2.keyword <span class="hljs-keyword">AS</span> geo.dest 
<span class="hljs-number">6</span>.  | KEEP count, geometry, geo.dest, population.population_2024 
<span class="hljs-number">7</span>.  | EVAL normalized_count = TO_DOUBLE(count) / population.population_2024 * <span class="hljs-number">100000</span>

`AI写代码
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e63741079f2141bd9030ad4edfa290ba~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRWxhc3RpY3NlYXJjaA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766823724&amp;x-signature=DBwGweAj8s76pmqMlOXkGeEk2k0%3D" alt="" loading="lazy"/></p>
<ul>
<li>在 ES|QL 编辑器中点击 Run query</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/21e69d74f8de451280b14ae6d8c7ddce~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRWxhc3RpY3NlYXJjaA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766823724&amp;x-signature=XzvV31MVsr8bO%2FhyYtP9RaNfOd4%3D" alt="" loading="lazy"/></p>
<ul>
<li>在 Layer style 中将 Fill color 设置为 By value by normalized_count。</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/86b8e174129f42f3a2aa1ac6a42dec6c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRWxhc3RpY3NlYXJjaA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766823724&amp;x-signature=KQKsChdXQl1oDPyjGegXlVlsE60%3D" alt="" loading="lazy"/></p>
<ul>
<li>点击 Keep changes。</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2ad2ef7cbb0945448f6f5439bb833c9e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRWxhc3RpY3NlYXJjaA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766823724&amp;x-signature=vIleNIwrAzdRPRsF88yAeHBtg2A%3D" alt="" loading="lazy"/></p>
<blockquote>
<p><strong>注意</strong>：你可能已经猜到，为什么不使用 lookup 设置导入 populations CSV 来对地图查询执行第二次 LOOKUP JOIN。那是可行的！但要注意，每增加一次 join 都会有性能开销。</p>
</blockquote>
<p>原文：<a href="https://link.juejin.cn?target=https%3A%2F%2Fdiscuss.elastic.co%2Ft%2Fdec-14th-2025-en-build-a-map-to-compare-metrics-by-country-or-region-with-es-ql%2F383243" title="https://discuss.elastic.co/t/dec-14th-2025-en-build-a-map-to-compare-metrics-by-country-or-region-with-es-ql/383243" target="_blank" ref="nofollow noopener noreferrer">discuss.elastic.co/t/dec-14th-…</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[脚手架开发工具——root-check]]></title>    <link>https://juejin.cn/post/7585474459776237604</link>    <guid>https://juejin.cn/post/7585474459776237604</guid>    <pubDate>2025-12-20T08:02:32.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585474459776237604" data-draft-id="7585463195201306674" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="脚手架开发工具——root-check"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-12-20T08:02:32.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="code_YuJun"/> <meta itemprop="url" content="https://juejin.cn/user/3615612462441358"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            脚手架开发工具——root-check
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3615612462441358/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    code_YuJun
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-20T08:02:32.000Z" title="Sat Dec 20 2025 08:02:32 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    21
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">简介</h2>
<p><code>root-check</code> 是一个 <strong>Node.js 工具包</strong>，核心作用是<strong>检测当前 Node.js 进程是否以 <code>root</code>（超级管理员）权限运行</strong>，并在检测到 <code>root</code> 权限时，自动降级为指定的普通用户权限运行，以此提升应用的安全性。</p>
<h3 data-id="heading-1">检测 root 权限</h3>
<p>它会判断当前进程的 <code>uid</code>（用户 ID）是否为 <code>0</code>（Unix/Linux 系统中 <code>root</code> 用户的 <code>uid</code> 固定为 <code>0</code>），以此识别是否为 <code>root</code> 权限运行。</p>
<h3 data-id="heading-2">自动降级权限</h3>
<p>如果检测到当前是 <code>root</code> 权限，它会尝试切换到一个<strong>非 root 普通用户</strong>的权限来运行后续代码。</p>
<ul>
<li>默认会尝试切换到 <code>nobody</code> 用户（Unix/Linux 系统中内置的无特权用户）。</li>
<li>也可以手动指定要切换的用户（通过用户名或 <code>uid</code>）。</li>
</ul>
<h3 data-id="heading-3">解决的核心问题</h3>
<p>在 Unix/Linux 系统中，以 <code>root</code> 权限运行 Node.js 应用存在<strong>极高的安全风险</strong>：一旦应用存在漏洞被攻击，攻击者将直接获得系统的最高权限，可能导致服务器被完全控制。<code>root-check</code> 的存在就是为了<strong>避免这种风险</strong>，强制应用以低权限运行，即使被攻击，影响范围也会被大幅限制。</p>
<h3 data-id="heading-4">适用场景</h3>
<ul>
<li>命令行工具（CLI）开发：很多 Node.js 命令行工具（如前端的构建工具、脚手架）会用到这个包，防止用户以 <code>root</code> 权限执行命令带来风险。</li>
<li>服务端应用：Node.js 编写的后端服务，部署时需要避免 root 权限运行，可通过此包自动降级。</li>
</ul>
<h3 data-id="heading-5">基本使用示例</h3>
<pre><code class="hljs language-js" lang="js">npm install root-check --save
</code></pre>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> rootCheck = <span class="hljs-built_in">require</span>(<span class="hljs-string">'root-check'</span>).<span class="hljs-property">default</span>;
<span class="hljs-comment">// 自动降级为 nobody 用户（如果当前是 root 权限）</span>
<span class="hljs-title function_">rootCheck</span>();
<span class="hljs-comment">// 或者手动指定要切换的用户</span>
<span class="hljs-comment">// rootCheck('www-data'); // 切换到 www-data 用户</span>
</code></pre>
<h3 data-id="heading-6">注意事项</h3>
<ul>
<li><strong>仅支持 Unix/Linux 系统</strong>：Windows 系统没有 <code>root</code>/<code>uid</code> 的概念，该包在 Windows 上会直接失效（无副作用）。</li>
<li><strong>降级失败会抛出错误</strong>：如果当前是 root 权限，但无法切换到目标用户（比如目标用户不存在），<code>rootCheck</code> 会抛出异常，需要手动捕获处理。</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Vue3条件渲染中v-if系列指令如何合理使用与规避错误？]]></title>    <link>https://juejin.cn/post/7585485284152295459</link>    <guid>https://juejin.cn/post/7585485284152295459</guid>    <pubDate>2025-12-20T08:13:19.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585485284152295459" data-draft-id="7585452404113129487" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Vue3条件渲染中v-if系列指令如何合理使用与规避错误？    "/> <meta itemprop="keywords" content="前端,Trae,AI编程"/> <meta itemprop="datePublished" content="2025-12-20T08:13:19.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="kknone"/> <meta itemprop="url" content="https://juejin.cn/user/1366025597879930"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Vue3条件渲染中v-if系列指令如何合理使用与规避错误？    
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1366025597879930/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    kknone
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-20T08:13:19.000Z" title="Sat Dec 20 2025 08:13:19 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读14分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h3 data-id="heading-0">一、Vue3条件渲染的核心概念</h3>
<p>在Vue3中，<strong>条件渲染</strong>是指根据<strong>响应式数据的真假</strong>，决定是否在页面上渲染某个元素或组件。而<code>v-if</code>、<code>v-else</code>、<code>v-else-if</code>
这组指令，就是实现条件渲染的“核心工具”——它们像一套“逻辑开关”，帮你精准控制DOM的显示与隐藏。</p>
<h3 data-id="heading-1">二、v-if系列指令的语法与用法</h3>
<p>我们先逐个拆解每个指令的作用，再通过<strong>实际案例</strong>串起来用。</p>
<h4 data-id="heading-2">2.1 v-if：基础条件判断</h4>
<p><code>v-if</code>是最基础的条件指令，它的语法很简单：</p>
<pre><code class="hljs language-html" lang="html">
<span class="hljs-tag">&lt;<span class="hljs-name">元素</span> <span class="hljs-attr">v-if</span>=<span class="hljs-string">"条件表达式"</span>&gt;</span>要渲染的内容<span class="hljs-tag">&lt;/<span class="hljs-name">元素</span>&gt;</span>
</code></pre>
<ul>
<li><strong>条件表达式</strong>：可以是任何返回<code>true</code>或<code>false</code>的JavaScript表达式（比如<code>isLogin</code>、<code>score &gt;= 90</code>）。</li>
<li><strong>惰性渲染</strong>：<code>v-if</code>是“懒”的——如果初始条件不满足（比如<code>isLogin = false</code>），元素<strong>不会被渲染到DOM中</strong>（连DOM节点都不会生成）；只有当条件变为
<code>true</code>时，才会“从零开始”创建元素及其子组件。</li>
</ul>
<p>举个例子：判断用户是否登录，显示不同的内容：</p>
<pre><code class="hljs language-vue" lang="vue">
&lt;script setup&gt;
  import {ref} from 'vue'

  const isLogin = ref(false) // 初始未登录
&lt;/script&gt;

&lt;template&gt;
  &lt;div&gt;
    &lt;!-- 登录后显示 --&gt;
    &lt;p v-if="isLogin"&gt;欢迎回来，用户！&lt;/p&gt;
    &lt;!-- 未登录显示 --&gt;
    &lt;button v-if="!isLogin" @click="isLogin = true"&gt;点击登录&lt;/button&gt;
  &lt;/div&gt;
&lt;/template&gt;
</code></pre>
<p>当点击按钮时，<code>isLogin</code>变为<code>true</code>，未登录的按钮会被销毁，同时渲染“欢迎”文本——这就是<code>v-if</code>的“销毁/重建”逻辑。</p>
<details>
<summary>往期文章归档</summary>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F218c3a59282c3b757447ee08a01937bb%2F" target="_blank" title="https://blog.cmdragon.cn/posts/218c3a59282c3b757447ee08a01937bb/" ref="nofollow noopener noreferrer">Vue3动态样式控制：ref、reactive、watch与computed的应用场景与区别是什么？</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F1bab953e41f66ac53de099fa9fe76483%2F" target="_blank" title="https://blog.cmdragon.cn/posts/1bab953e41f66ac53de099fa9fe76483/" ref="nofollow noopener noreferrer">Vue3中动态样式数组的后项覆盖规则如何与计算属性结合实现复杂状态样式管理？</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fc85e1fe16a7ae45e965b4e2df4d9d2f4%2F" target="_blank" title="https://blog.cmdragon.cn/posts/c85e1fe16a7ae45e965b4e2df4d9d2f4/" ref="nofollow noopener noreferrer">Vue浅响应式如何解决深层响应式的性能问题？适用场景有哪些？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fbe04b02d2723994632de0d4ca22a3391%2F" target="_blank" title="https://blog.cmdragon.cn/posts/be04b02d2723994632de0d4ca22a3391/" ref="nofollow noopener noreferrer">Vue 3组合式API中ref与reactive的核心响应式差异及使用最佳实践是什么？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fbe04b02d2723994632de0d4ca22a3391%2F" target="_blank" title="https://blog.cmdragon.cn/posts/be04b02d2723994632de0d4ca22a3391/" ref="nofollow noopener noreferrer">Vue 3组合式API中ref与reactive的核心响应式差异及使用最佳实践是什么？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fa0af08dd60a37b9a890a9957f2cbfc9f%2F" target="_blank" title="https://blog.cmdragon.cn/posts/a0af08dd60a37b9a890a9957f2cbfc9f/" ref="nofollow noopener noreferrer">Vue3响应式系统中，对象新增属性、数组改索引、原始值代理的问题如何解决？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fbc287e1e36287afd90750fd907eca85e%2F" target="_blank" title="https://blog.cmdragon.cn/posts/bc287e1e36287afd90750fd907eca85e/" ref="nofollow noopener noreferrer">Vue 3中watch侦听器的正确使用姿势你掌握了吗？深度监听、与watchEffect的差异及常见报错解析 - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F654b9447ef1ba7ec1126a1bc26a4726d%2F" target="_blank" title="https://blog.cmdragon.cn/posts/654b9447ef1ba7ec1126a1bc26a4726d/" ref="nofollow noopener noreferrer">Vue响应式声明的API差异、底层原理与常见陷阱你都搞懂了吗 - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F654b9447ef1ba7ec1126a1bc26a4726d%2F" target="_blank" title="https://blog.cmdragon.cn/posts/654b9447ef1ba7ec1126a1bc26a4726d/" ref="nofollow noopener noreferrer">Vue响应式声明的API差异、底层原理与常见陷阱你都搞懂了吗 - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fc405a8d9950af5b7c63b56c348ac36b6%2F" target="_blank" title="https://blog.cmdragon.cn/posts/c405a8d9950af5b7c63b56c348ac36b6/" ref="nofollow noopener noreferrer">为什么Vue 3需要ref函数？它的响应式原理与正确用法是什么？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fa7e9abb9691a81e4404d9facabe0f7c3%2F" target="_blank" title="https://blog.cmdragon.cn/posts/a7e9abb9691a81e4404d9facabe0f7c3/" ref="nofollow noopener noreferrer">Vue 3中reactive函数如何通过Proxy实现响应式？使用时要避开哪些误区？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fbd995ea45161727597fb85b62566c43d%2F" target="_blank" title="https://blog.cmdragon.cn/posts/bd995ea45161727597fb85b62566c43d/" ref="nofollow noopener noreferrer">Vue3响应式系统的底层原理与实践要点你真的懂吗？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F53e3f270a80675df662c6857a3332c0f%2F" target="_blank" title="https://blog.cmdragon.cn/posts/53e3f270a80675df662c6857a3332c0f/" ref="nofollow noopener noreferrer">Vue 3模板如何通过编译三阶段实现从声明式语法到高效渲染的跨越 - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fddbce4f2a23aa72c96b1c0473900321e%2F" target="_blank" title="https://blog.cmdragon.cn/posts/ddbce4f2a23aa72c96b1c0473900321e/" ref="nofollow noopener noreferrer">快速入门Vue模板引用：从收DOM“快递”到调子组件方法，你玩明白了吗？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F23a2d5a334e15575277814c16e45df50%2F" target="_blank" title="https://blog.cmdragon.cn/posts/23a2d5a334e15575277814c16e45df50/" ref="nofollow noopener noreferrer">快速入门Vue模板里的JS表达式有啥不能碰？计算属性为啥比方法更能打？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F6be38de6382e31d282659b689c5b17f0%2F" target="_blank" title="https://blog.cmdragon.cn/posts/6be38de6382e31d282659b689c5b17f0/" ref="nofollow noopener noreferrer">快速入门Vue的v-model表单绑定：语法糖、动态值、修饰符的小技巧你都掌握了吗？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F60ce517684f4a418f453d66aa805606c%2F" target="_blank" title="https://blog.cmdragon.cn/posts/60ce517684f4a418f453d66aa805606c/" ref="nofollow noopener noreferrer">快速入门Vue3事件处理的挑战题：v-on、修饰符、自定义事件你能通关吗？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fe4ae7d5e4a9205bb11b2baccb230c637%2F" target="_blank" title="https://blog.cmdragon.cn/posts/e4ae7d5e4a9205bb11b2baccb230c637/" ref="nofollow noopener noreferrer">快速入门Vue3的v-指令：数据和DOM的“翻译官”到底有多少本事？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F999ce4fb32259ff4fbf4bf7bcb851654%2F" target="_blank" title="https://blog.cmdragon.cn/posts/999ce4fb32259ff4fbf4bf7bcb851654/" ref="nofollow noopener noreferrer">快速入门Vue3，插值、动态绑定和避坑技巧你都搞懂了吗？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fa6997d81b49cd232b87e1cf603888ad1%2F" target="_blank" title="https://blog.cmdragon.cn/posts/a6997d81b49cd232b87e1cf603888ad1/" ref="nofollow noopener noreferrer">想让PostgreSQL快到飞起？先找健康密码还是先换引擎？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F1fee7afbb9abd4540b8aa9c141d6845d%2F" target="_blank" title="https://blog.cmdragon.cn/posts/1fee7afbb9abd4540b8aa9c141d6845d/" ref="nofollow noopener noreferrer">想让PostgreSQL查询快到飞起？分区表、物化视图、并行查询这三招灵不灵？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F79c590fbd87ece535b11a71c9667884f%2F" target="_blank" title="https://blog.cmdragon.cn/posts/79c590fbd87ece535b11a71c9667884f/" ref="nofollow noopener noreferrer">子查询总拖慢查询？把它变成连接就能解决？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F748cdac2536008199abf8a8a2cd0ec85%2F" target="_blank" title="https://blog.cmdragon.cn/posts/748cdac2536008199abf8a8a2cd0ec85/" ref="nofollow noopener noreferrer">PostgreSQL全表扫描慢到崩溃？建索引+改查询+更统计信息三招能破？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F32ca943703226d317d4276a8fb53b0dd%2F" target="_blank" title="https://blog.cmdragon.cn/posts/32ca943703226d317d4276a8fb53b0dd/" ref="nofollow noopener noreferrer">复杂查询总拖后腿？PostgreSQL多列索引+覆盖索引的神仙技巧你get没？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fca93f1d53aa910e7ba5ffd8df611c12b%2F" target="_blank" title="https://blog.cmdragon.cn/posts/ca93f1d53aa910e7ba5ffd8df611c12b/" ref="nofollow noopener noreferrer">只给表子集建索引？用函数结果建索引？PostgreSQL这俩操作凭啥能省空间又加速？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Ff507856ebfddd592448813c510a53669%2F" target="_blank" title="https://blog.cmdragon.cn/posts/f507856ebfddd592448813c510a53669/" ref="nofollow noopener noreferrer">B-tree索引像字典查词一样工作？那哪些数据库查询它能加速，哪些不能？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fb2213bfcb5b88a862f2138404c03d596%2F" target="_blank" title="https://blog.cmdragon.cn/posts/b2213bfcb5b88a862f2138404c03d596/" ref="nofollow noopener noreferrer">想抓PostgreSQL里的慢SQL？pg_stat_statements基础黑匣子和pg_stat_monitor时间窗，谁能帮你更准揪出性能小偷？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F26614eb7da6c476dde41d367ad888d2f%2F" target="_blank" title="https://blog.cmdragon.cn/posts/26614eb7da6c476dde41d367ad888d2f/" ref="nofollow noopener noreferrer">PostgreSQL的“时光机”MVCC和锁机制是怎么搞定高并发的？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F69f99bc6972a860d559c74aad7280da4%2F" target="_blank" title="https://blog.cmdragon.cn/posts/69f99bc6972a860d559c74aad7280da4/" ref="nofollow noopener noreferrer">PostgreSQL性能暴涨的关键？内存IO并发参数居然要这么设置？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F7b7053f392147a8b3b1a16bebeb08d0a%2F" target="_blank" title="https://blog.cmdragon.cn/posts/7b7053f392147a8b3b1a16bebeb08d0a/" ref="nofollow noopener noreferrer">大表查询慢到翻遍整个书架？PostgreSQL分区表教你怎么“分类”才高效</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fc856e3cb073822349f3bf2d29995dcfc%2F" target="_blank" title="https://blog.cmdragon.cn/posts/c856e3cb073822349f3bf2d29995dcfc/" ref="nofollow noopener noreferrer">PostgreSQL 查询慢？是不是忘了优化 GROUP BY、ORDER BY 和窗口函数？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fc096347d18e67b7431faacd2c4757093%2F" target="_blank" title="https://blog.cmdragon.cn/posts/c096347d18e67b7431faacd2c4757093/" ref="nofollow noopener noreferrer">PostgreSQL里的子查询和CTE居然在性能上“掐架”？到底该站哪边？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F2eca89463454fd4250d7b66243b9fe5a%2F" target="_blank" title="https://blog.cmdragon.cn/posts/2eca89463454fd4250d7b66243b9fe5a/" ref="nofollow noopener noreferrer">PostgreSQL选Join策略有啥小九九？Nested Loop/Merge/Hash谁是它的菜？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F068ecb772a87d7df20a8c9fb4b233f8e%2F" target="_blank" title="https://blog.cmdragon.cn/posts/068ecb772a87d7df20a8c9fb4b233f8e/" ref="nofollow noopener noreferrer">PostgreSQL新手SQL总翻车？这7个性能陷阱你踩过没？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fd498f63cd0a2d5a77e445c688a8b88db%2F" target="_blank" title="https://blog.cmdragon.cn/posts/d498f63cd0a2d5a77e445c688a8b88db/" ref="nofollow noopener noreferrer">PostgreSQL索引选B-Tree还是GiST？“瑞士军刀”和“多面手”的差别你居然还不知道？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F9101b75bdec6faea9b35d54f14e37f36%2F" target="_blank" title="https://blog.cmdragon.cn/posts/9101b75bdec6faea9b35d54f14e37f36/" ref="nofollow noopener noreferrer">想知道数据库怎么给查询“算成本选路线”？EXPLAIN能帮你看明白？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fd527f8ebb6e3dae2c7dfe4c8d8979444%2F" target="_blank" title="https://blog.cmdragon.cn/posts/d527f8ebb6e3dae2c7dfe4c8d8979444/" ref="nofollow noopener noreferrer">PostgreSQL处理SQL居然像做蛋糕？解析到执行的4步里藏着多少查询优化的小心机？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F6bfdae84f313cf7ad0bb7045c4392347%2F" target="_blank" title="https://blog.cmdragon.cn/posts/6bfdae84f313cf7ad0bb7045c4392347/" ref="nofollow noopener noreferrer">PostgreSQL备份不是复制文件？物理vs逻辑咋选？误删还能精准恢复到1分钟前？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fde3672803de34dbad244d0a8d48b0eb5%2F" target="_blank" title="https://blog.cmdragon.cn/posts/de3672803de34dbad244d0a8d48b0eb5/" ref="nofollow noopener noreferrer">转账不翻车、并发不干扰，PostgreSQL的ACID特性到底有啥魔法？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fe463e8a2668abdf00a228c9b79324ded%2F" target="_blank" title="https://blog.cmdragon.cn/posts/e463e8a2668abdf00a228c9b79324ded/" ref="nofollow noopener noreferrer">银行转账不白扣钱、电商下单不超卖，PostgreSQL事务的诀窍是啥？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F5c967e595058c4a1fc4474a68e64031d%2F" target="_blank" title="https://blog.cmdragon.cn/posts/5c967e595058c4a1fc4474a68e64031d/" ref="nofollow noopener noreferrer">PostgreSQL里的PL/pgSQL到底是啥？能让SQL从“说目标”变“讲步骤”？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F325047855e3e23b5ef82f7d2db134fbd%2F" target="_blank" title="https://blog.cmdragon.cn/posts/325047855e3e23b5ef82f7d2db134fbd/" ref="nofollow noopener noreferrer">PostgreSQL视图不存数据？那它怎么简化查询还能递归生成序列和控制权限？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fd2dba50bb6e4df7b27e735245a06a2a2%2F" target="_blank" title="https://blog.cmdragon.cn/posts/d2dba50bb6e4df7b27e735245a06a2a2/" ref="nofollow noopener noreferrer">PostgreSQL索引这么玩，才能让你的查询真的“飞”起来？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F849ae5bab0f8c66e94c2f6ad1bb798e3%2F" target="_blank" title="https://blog.cmdragon.cn/posts/849ae5bab0f8c66e94c2f6ad1bb798e3/" ref="nofollow noopener noreferrer">PostgreSQL的表关系和约束，咋帮你搞定用户订单不混乱、学生选课不重复？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fef4800975ffa84f1ca51976a70a1585b%2F" target="_blank" title="https://blog.cmdragon.cn/posts/ef4800975ffa84f1ca51976a70a1585b/" ref="nofollow noopener noreferrer">PostgreSQL查询的筛子、排序、聚合、分组？你会用它们搞定数据吗？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fbf54711525c507c5eacfa7b0151c39d2%2F" target="_blank" title="https://blog.cmdragon.cn/posts/bf54711525c507c5eacfa7b0151c39d2/" ref="nofollow noopener noreferrer">PostgreSQL数据类型怎么选才高效不踩坑？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F887809b3e0375f5956873cd442f516d8%2F" target="_blank" title="https://blog.cmdragon.cn/posts/887809b3e0375f5956873cd442f516d8/" ref="nofollow noopener noreferrer">想解锁PostgreSQL查询从基础到进阶的核心知识点？你都get了吗？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F934be1203725e8be9d6f6e9104e5abcc%2F" target="_blank" title="https://blog.cmdragon.cn/posts/934be1203725e8be9d6f6e9104e5abcc/" ref="nofollow noopener noreferrer">PostgreSQL DELETE居然有这些操作？返回数据、连表删你试过没？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F0f0622e9b7402b599e618150d0596ffe%2F" target="_blank" title="https://blog.cmdragon.cn/posts/0f0622e9b7402b599e618150d0596ffe/" ref="nofollow noopener noreferrer">PostgreSQL UPDATE语句怎么玩？从改邮箱到批量更新的避坑技巧你都会吗？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F0e3bf7efc030b024ea67ee855a00f2de%2F" target="_blank" title="https://blog.cmdragon.cn/posts/0e3bf7efc030b024ea67ee855a00f2de/" ref="nofollow noopener noreferrer">PostgreSQL插入数据还在逐条敲？批量、冲突处理、返回自增ID的技巧你会吗？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fb6cd3c86da6aac26ed829e472d34078e%2F" target="_blank" title="https://blog.cmdragon.cn/posts/b6cd3c86da6aac26ed829e472d34078e/" ref="nofollow noopener noreferrer">PostgreSQL的“仓库-房间-货架”游戏，你能建出电商数据库和表吗？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fba1f545a3410144552fbdbfcf31b5265%2F" target="_blank" title="https://blog.cmdragon.cn/posts/ba1f545a3410144552fbdbfcf31b5265/" ref="nofollow noopener noreferrer">PostgreSQL 17安装总翻车？Windows/macOS/Linux避坑指南帮你搞定？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fb5474d1480509c5072085abc80b3dd9f%2F" target="_blank" title="https://blog.cmdragon.cn/posts/b5474d1480509c5072085abc80b3dd9f/" ref="nofollow noopener noreferrer">能当关系型数据库还能玩对象特性，能拆复杂查询还能自动管库存，PostgreSQL凭什么这么香？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fcc098d8836e787baa8a4d92e4d56d5c5%2F" target="_blank" title="https://blog.cmdragon.cn/posts/cc098d8836e787baa8a4d92e4d56d5c5/" ref="nofollow noopener noreferrer">给接口加新字段又不搞崩老客户端？FastAPI的多版本API靠哪三招实现？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F46d05151c5bd31cf37a7bcf0b8f5b0b8%2F" target="_blank" title="https://blog.cmdragon.cn/posts/46d05151c5bd31cf37a7bcf0b8f5b0b8/" ref="nofollow noopener noreferrer">流量突增要搞崩FastAPI？熔断测试是怎么防系统雪崩的？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F65ce343cc5df9faf3a8e2eeaab42ae45%2F" target="_blank" title="https://blog.cmdragon.cn/posts/65ce343cc5df9faf3a8e2eeaab42ae45/" ref="nofollow noopener noreferrer">FastAPI秒杀库存总变负数？Redis分布式锁能帮你守住底线吗 - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Feed6cd8985d9be0a4b092a7da38b3e0c%2F" target="_blank" title="https://blog.cmdragon.cn/posts/eed6cd8985d9be0a4b092a7da38b3e0c/" ref="nofollow noopener noreferrer">FastAPI的CI流水线怎么自动测端点，还能让Allure报告美到犯规？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F6157d87338ce894d18c013c3c4777abb%2F" target="_blank" title="https://blog.cmdragon.cn/posts/6157d87338ce894d18c013c3c4777abb/" ref="nofollow noopener noreferrer">如何用GitHub Actions为FastAPI项目打造自动化测试流水线？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Ffc4ef84559e04693a620d0714cb30787%2F" target="_blank" title="https://blog.cmdragon.cn/posts/fc4ef84559e04693a620d0714cb30787/" ref="nofollow noopener noreferrer">如何用Git Hook和CI流水线为FastAPI项目保驾护航？ - cmdragon's Blog</a></li>
</ul>
</details>
<details>
<summary>免费好用的热门在线工具</summary>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fraid-calculator" target="_blank" title="https://tools.cmdragon.cn/zh/apps/raid-calculator" ref="nofollow noopener noreferrer">RAID 计算器 - 应用商店 | By cmdragon</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fphotoshop-online" target="_blank" title="https://tools.cmdragon.cn/zh/apps/photoshop-online" ref="nofollow noopener noreferrer">在线PS - 应用商店 | By cmdragon</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fmermaid-live-editor" target="_blank" title="https://tools.cmdragon.cn/zh/apps/mermaid-live-editor" ref="nofollow noopener noreferrer">Mermaid 在线编辑器 - 应用商店 | By cmdragon</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fmath-solver-calculator" target="_blank" title="https://tools.cmdragon.cn/zh/apps/math-solver-calculator" ref="nofollow noopener noreferrer">数学求解计算器 - 应用商店 | By cmdragon</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fsmart-teleprompter" target="_blank" title="https://tools.cmdragon.cn/zh/apps/smart-teleprompter" ref="nofollow noopener noreferrer">智能提词器 - 应用商店 | By cmdragon</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fmagic-resume" target="_blank" title="https://tools.cmdragon.cn/zh/apps/magic-resume" ref="nofollow noopener noreferrer">魔法简历 - 应用商店 | By cmdragon</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fimage-puzzle-tool" target="_blank" title="https://tools.cmdragon.cn/zh/apps/image-puzzle-tool" ref="nofollow noopener noreferrer">Image Puzzle Tool - 图片拼图工具 | By cmdragon</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fsubtitle-downloader" target="_blank" title="https://tools.cmdragon.cn/zh/apps/subtitle-downloader" ref="nofollow noopener noreferrer">字幕下载工具 - 应用商店 | By cmdragon</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Flyrics-generator" target="_blank" title="https://tools.cmdragon.cn/zh/apps/lyrics-generator" ref="nofollow noopener noreferrer">歌词生成工具 - 应用商店 | By cmdragon</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fcloud-drive-search" target="_blank" title="https://tools.cmdragon.cn/zh/apps/cloud-drive-search" ref="nofollow noopener noreferrer">网盘资源聚合搜索 - 应用商店 | By cmdragon</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fascii-art-generator" target="_blank" title="https://tools.cmdragon.cn/zh/apps/ascii-art-generator" ref="nofollow noopener noreferrer">ASCII字符画生成器 - 应用商店 | By cmdragon</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fjwt-tool" target="_blank" title="https://tools.cmdragon.cn/zh/apps/jwt-tool" ref="nofollow noopener noreferrer">JSON Web Tokens 工具 - 应用商店 | By cmdragon</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fbcrypt-tool" target="_blank" title="https://tools.cmdragon.cn/zh/apps/bcrypt-tool" ref="nofollow noopener noreferrer">Bcrypt 密码工具 - 应用商店 | By cmdragon</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fgif-composer" target="_blank" title="https://tools.cmdragon.cn/zh/apps/gif-composer" ref="nofollow noopener noreferrer">GIF 合成器 - 应用商店 | By cmdragon</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fgif-decomposer" target="_blank" title="https://tools.cmdragon.cn/zh/apps/gif-decomposer" ref="nofollow noopener noreferrer">GIF 分解器 - 应用商店 | By cmdragon</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Ftext-steganography" target="_blank" title="https://tools.cmdragon.cn/zh/apps/text-steganography" ref="nofollow noopener noreferrer">文本隐写术 - 应用商店 | By cmdragon</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh" target="_blank" title="https://tools.cmdragon.cn/zh" ref="nofollow noopener noreferrer">CMDragon 在线工具 - 高级AI工具箱与开发者套件 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%3Fcategory%3Dtrending" target="_blank" title="https://tools.cmdragon.cn/zh/apps?category=trending" ref="nofollow noopener noreferrer">应用商店 - 发现1000+提升效率与开发的AI工具和实用程序 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fchangelog" target="_blank" title="https://tools.cmdragon.cn/zh/changelog" ref="nofollow noopener noreferrer">CMDragon 更新日志 - 最新更新、功能与改进 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fsponsor" target="_blank" title="https://tools.cmdragon.cn/zh/sponsor" ref="nofollow noopener noreferrer">支持我们 - 成为赞助者 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Ftext-to-image-ai" target="_blank" title="https://tools.cmdragon.cn/zh/apps/text-to-image-ai" ref="nofollow noopener noreferrer">AI文本生成图像 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Ftemp-email" target="_blank" title="https://tools.cmdragon.cn/zh/apps/temp-email" ref="nofollow noopener noreferrer">临时邮箱 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fqrcode-parser" target="_blank" title="https://tools.cmdragon.cn/zh/apps/qrcode-parser" ref="nofollow noopener noreferrer">二维码解析器 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Ftext-to-mindmap" target="_blank" title="https://tools.cmdragon.cn/zh/apps/text-to-mindmap" ref="nofollow noopener noreferrer">文本转思维导图 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fregex-visualizer" target="_blank" title="https://tools.cmdragon.cn/zh/apps/regex-visualizer" ref="nofollow noopener noreferrer">正则表达式可视化工具 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fsteganography-tool" target="_blank" title="https://tools.cmdragon.cn/zh/apps/steganography-tool" ref="nofollow noopener noreferrer">文件隐写工具 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fiptv-explorer" target="_blank" title="https://tools.cmdragon.cn/zh/apps/iptv-explorer" ref="nofollow noopener noreferrer">IPTV 频道探索器 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fsnapdrop" target="_blank" title="https://tools.cmdragon.cn/zh/apps/snapdrop" ref="nofollow noopener noreferrer">快传 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Flucky-draw" target="_blank" title="https://tools.cmdragon.cn/zh/apps/lucky-draw" ref="nofollow noopener noreferrer">随机抽奖工具 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fanime-scene-finder" target="_blank" title="https://tools.cmdragon.cn/zh/apps/anime-scene-finder" ref="nofollow noopener noreferrer">动漫场景查找器 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Ftime-toolkit" target="_blank" title="https://tools.cmdragon.cn/zh/apps/time-toolkit" ref="nofollow noopener noreferrer">时间工具箱 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fspeed-test" target="_blank" title="https://tools.cmdragon.cn/zh/apps/speed-test" ref="nofollow noopener noreferrer">网速测试 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fbackground-remover" target="_blank" title="https://tools.cmdragon.cn/zh/apps/background-remover" ref="nofollow noopener noreferrer">AI 智能抠图工具 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fbackground-replacer" target="_blank" title="https://tools.cmdragon.cn/zh/apps/background-replacer" ref="nofollow noopener noreferrer">背景替换工具 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fartistic-qrcode" target="_blank" title="https://tools.cmdragon.cn/zh/apps/artistic-qrcode" ref="nofollow noopener noreferrer">艺术二维码生成器 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fopen-graph-generator" target="_blank" title="https://tools.cmdragon.cn/zh/apps/open-graph-generator" ref="nofollow noopener noreferrer">Open Graph 元标签生成器 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fimage-comparison" target="_blank" title="https://tools.cmdragon.cn/zh/apps/image-comparison" ref="nofollow noopener noreferrer">图像对比工具 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fimage-compressor" target="_blank" title="https://tools.cmdragon.cn/zh/apps/image-compressor" ref="nofollow noopener noreferrer">图片压缩专业版 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fpassword-generator" target="_blank" title="https://tools.cmdragon.cn/zh/apps/password-generator" ref="nofollow noopener noreferrer">密码生成器 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fsvg-optimizer" target="_blank" title="https://tools.cmdragon.cn/zh/apps/svg-optimizer" ref="nofollow noopener noreferrer">SVG优化器 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fcolor-palette" target="_blank" title="https://tools.cmdragon.cn/zh/apps/color-palette" ref="nofollow noopener noreferrer">调色板生成器 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fonline-metronome" target="_blank" title="https://tools.cmdragon.cn/zh/apps/online-metronome" ref="nofollow noopener noreferrer">在线节拍器 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fip-geolocation" target="_blank" title="https://tools.cmdragon.cn/zh/apps/ip-geolocation" ref="nofollow noopener noreferrer">IP归属地查询 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fcss-grid-layout" target="_blank" title="https://tools.cmdragon.cn/zh/apps/css-grid-layout" ref="nofollow noopener noreferrer">CSS网格布局生成器 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Femail-validator" target="_blank" title="https://tools.cmdragon.cn/zh/apps/email-validator" ref="nofollow noopener noreferrer">邮箱验证工具 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fcalligraphy-practice" target="_blank" title="https://tools.cmdragon.cn/zh/apps/calligraphy-practice" ref="nofollow noopener noreferrer">书法练习字帖 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Ffinance-calculator-suite" target="_blank" title="https://tools.cmdragon.cn/zh/apps/finance-calculator-suite" ref="nofollow noopener noreferrer">金融计算器套件 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fchinese-kinship-calculator" target="_blank" title="https://tools.cmdragon.cn/zh/apps/chinese-kinship-calculator" ref="nofollow noopener noreferrer">中国亲戚关系计算器 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fprotobuf-toolkit" target="_blank" title="https://tools.cmdragon.cn/zh/apps/protobuf-toolkit" ref="nofollow noopener noreferrer">Protocol Buffer 工具箱 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fip-geolocation" target="_blank" title="https://tools.cmdragon.cn/zh/apps/ip-geolocation" ref="nofollow noopener noreferrer">IP归属地查询 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fimage-upscaler" target="_blank" title="https://tools.cmdragon.cn/zh/apps/image-upscaler" ref="nofollow noopener noreferrer">图片无损放大 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Ftext-compare" target="_blank" title="https://tools.cmdragon.cn/zh/apps/text-compare" ref="nofollow noopener noreferrer">文本比较工具 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fip-batch-lookup" target="_blank" title="https://tools.cmdragon.cn/zh/apps/ip-batch-lookup" ref="nofollow noopener noreferrer">IP批量查询工具 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fdomain-finder" target="_blank" title="https://tools.cmdragon.cn/zh/apps/domain-finder" ref="nofollow noopener noreferrer">域名查询工具 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fdns-toolkit" target="_blank" title="https://tools.cmdragon.cn/zh/apps/dns-toolkit" ref="nofollow noopener noreferrer">DNS工具箱 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Ffavicon-generator" target="_blank" title="https://tools.cmdragon.cn/zh/apps/favicon-generator" ref="nofollow noopener noreferrer">网站图标生成器 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fsitemap_index.xml" target="_blank" title="https://tools.cmdragon.cn/sitemap_index.xml" ref="nofollow noopener noreferrer">XML Sitemap</a></li>
</ul>
</details>
<h4 data-id="heading-3">2.2 v-else：补充默认分支</h4>
<p>如果<code>v-if</code>的条件不满足，你可以用<code>v-else</code>添加一个“默认选项”。但要注意：<br/>
<strong><code>v-else</code>必须紧跟在<code>v-if</code>或<code>v-else-if</code>的后面，中间不能有其他兄弟元素</strong>（否则Vue无法识别它属于哪个条件）。</p>
<p>修改上面的例子，用<code>v-else</code>简化未登录的情况：</p>
<pre><code class="hljs language-html" lang="html">
<span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">p</span> <span class="hljs-attr">v-if</span>=<span class="hljs-string">"isLogin"</span>&gt;</span>欢迎回来，用户！<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
        <span class="hljs-comment">&lt;!-- 直接跟在v-if后面，无需写条件 --&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">v-else</span> @<span class="hljs-attr">click</span>=<span class="hljs-string">"isLogin = true"</span>&gt;</span>点击登录<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>
</code></pre>
<h4 data-id="heading-4">2.3 v-else-if：多分支条件判断</h4>
<p>当需要判断<strong>多个条件</strong>时，用<code>v-else-if</code>连接。它的语法是：</p>
<pre><code class="hljs language-html" lang="html">
<span class="hljs-tag">&lt;<span class="hljs-name">元素</span> <span class="hljs-attr">v-if</span>=<span class="hljs-string">"条件1"</span>&gt;</span>内容1<span class="hljs-tag">&lt;/<span class="hljs-name">元素</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">元素</span> <span class="hljs-attr">v-else-if</span>=<span class="hljs-string">"条件2"</span>&gt;</span>内容2<span class="hljs-tag">&lt;/<span class="hljs-name">元素</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">元素</span> <span class="hljs-attr">v-else-if</span>=<span class="hljs-string">"条件3"</span>&gt;</span>内容3<span class="hljs-tag">&lt;/<span class="hljs-name">元素</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">元素</span> <span class="hljs-attr">v-else</span>&gt;</span>默认内容<span class="hljs-tag">&lt;/<span class="hljs-name">元素</span>&gt;</span>
</code></pre>
<p><strong>关键规则</strong>：Vue会按<strong>指令的顺序依次判断</strong>，满足第一个条件就停止（所以条件的顺序很重要！）。</p>
<p>比如根据分数显示等级（最常见的多分支场景）：</p>
<pre><code class="hljs language-vue" lang="vue">
&lt;script setup&gt;
  import {ref} from 'vue'

  const score = ref(85) // 响应式分数，初始85分
&lt;/script&gt;

&lt;template&gt;
  &lt;div class="score-level"&gt;
    &lt;h3&gt;你的分数：{{ score }}&lt;/h3&gt;
    &lt;!-- 顺序：从高到低 --&gt;
    &lt;p v-if="score &gt;= 90" class="excellent"&gt;等级：优秀（≥90）&lt;/p&gt;
    &lt;p v-else-if="score &gt;= 80" class="good"&gt;等级：良好（80-89）&lt;/p&gt;
    &lt;p v-else-if="score &gt;= 60" class="pass"&gt;等级：及格（60-79）&lt;/p&gt;
    &lt;p v-else class="fail"&gt;等级：不及格（&lt;60）&lt;/p&gt;
  &lt;/div&gt;
&lt;/template&gt;

&lt;style scoped&gt;
  .excellent {
    color: #4CAF50;
  }

  .good {
    color: #2196F3;
  }

  .pass {
    color: #FFC107;
  }

  .fail {
    color: #F44336;
  }
&lt;/style&gt;
</code></pre>
<p>运行这个组件，修改<code>score</code>的值（比如改成<code>95</code>或<code>50</code>），会看到等级自动切换——这就是多分支条件渲染的实际效果。</p>
<h3 data-id="heading-5">三、条件渲染的流程逻辑（附流程图）</h3>
<p>为了更直观理解<code>v-if</code>系列的执行顺序，我们画一个<strong>判断流程图</strong>：</p>
<pre><code class="hljs language-mermaid" lang="mermaid">flowchart TD
    A[开始] --&gt; B{检查v-if条件}
    B --&gt;|满足| C[渲染v-if内容，结束]
    B --&gt;|不满足| D{检查下一个v-else-if条件}
    D --&gt;|满足| E[渲染对应内容，结束]
    D --&gt;|不满足| F{还有v-else-if吗?}
    F --&gt;|是| D
    F --&gt;|否| G[渲染v-else内容，结束]
</code></pre>
<p>简单来说：<strong>按顺序“闯关”，满足条件就“通关”，否则继续，直到最后一个v-else</strong>。</p>
<h3 data-id="heading-6">四、课后Quiz：巩固你的理解</h3>
<h4 data-id="heading-7">Quiz 1：v-if和v-show有什么区别？</h4>
<p><strong>问题</strong>：同样是“隐藏元素”，<code>v-if</code>和<code>v-show</code>的核心差异是什么？分别适合什么场景？</p>
<p><strong>答案解析</strong>（参考Vue官网）：</p>
<ul>
<li><code>v-if</code>：<strong>销毁/重建DOM</strong>——条件不满足时，元素从DOM中消失；条件满足时，重新创建。适合<strong>条件很少变化</strong>的场景（比如权限判断），因为初始渲染更省性能。</li>
<li><code>v-show</code>：<strong>修改CSS显示</strong>——无论条件如何，元素都会渲染到DOM，只是用<code>display: none</code>隐藏。适合<strong>条件频繁切换</strong>的场景（比如
tabs 切换），因为切换时无需销毁重建，更高效。</li>
</ul>
<h4 data-id="heading-8">Quiz 2：为什么v-else必须紧跟v-if？</h4>
<p><strong>问题</strong>：如果写<code>v-if</code>之后隔了一个<code>div</code>再写<code>v-else</code>，会报错吗？为什么？</p>
<p><strong>答案解析</strong>：<br/>
会报错！错误信息是“v-else has no adjacent v-if”。<br/>
原因：Vue需要明确<code>v-else</code>对应的“上级条件”——它必须与最近的<code>v-if/v-else-if</code><strong>直接相邻</strong>（中间不能有其他兄弟元素）。如果隔开，Vue无法识别两者的关联。</p>
<h3 data-id="heading-9">五、常见报错与解决方案</h3>
<p>在使用<code>v-if</code>系列时，新手常遇到以下问题，我们逐一解决：</p>
<h4 data-id="heading-10">1. 报错：“v-else/v-else-if has no adjacent v-if”</h4>
<ul>
<li><strong>原因</strong>：<code>v-else</code>或<code>v-else-if</code>没有紧跟对应的<code>v-if</code>（中间有其他元素）。<br/>
比如：
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">v-if</span>=<span class="hljs-string">"isShow"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>无关内容<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span> <span class="hljs-comment">&lt;!-- 中间的p元素导致错误 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">v-else</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
</code></pre>
</li>
<li><strong>解决</strong>：删除中间的无关元素，让<code>v-else</code>直接紧跟<code>v-if</code>。</li>
<li><strong>预防</strong>：写<code>v-else</code>前，先检查前面的元素是否是<code>v-if</code>或<code>v-else-if</code>。</li>
</ul>
<h4 data-id="heading-11">2. 报错：“条件变化时，v-if内容不更新”</h4>
<ul>
<li><strong>原因</strong>：条件变量不是<strong>响应式</strong>的（比如用<code>let isShow = false</code>而不是<code>ref(false)</code>），Vue无法追踪其变化。</li>
<li><strong>解决</strong>：用<code>ref</code>（基本类型）或<code>reactive</code>（对象/数组）包裹条件变量：
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 错误写法</span>
<span class="hljs-keyword">let</span> isShow = <span class="hljs-literal">false</span> 
<span class="hljs-comment">// 正确写法</span>
<span class="hljs-keyword">const</span> isShow = <span class="hljs-title function_">ref</span>(<span class="hljs-literal">false</span>)
</code></pre>
</li>
<li><strong>预防</strong>：所有需要“随数据变化而更新”的变量，都用Vue的响应式API（<code>ref</code>/<code>reactive</code>）定义。</li>
</ul>
<h4 data-id="heading-12">3. 逻辑错误：v-else-if顺序导致条件失效</h4>
<ul>
<li><strong>例子</strong>：先写<code>v-else-if="score &gt;= 60"</code>，再写<code>v-else-if="score &gt;= 80"</code>——此时<code>80分</code>会被第一个条件拦截，永远到不了第二个。</li>
<li><strong>原因</strong>：Vue按指令顺序判断，满足第一个条件就停止。</li>
<li><strong>解决</strong>：将<strong>更严格的条件</strong>放在前面（比如先<code>&gt;=90</code>，再<code>&gt;=80</code>，最后<code>&gt;=60</code>）。</li>
</ul>
<h3 data-id="heading-13">参考链接</h3>
<p>Vue官网条件渲染文档：<a href="https://link.juejin.cn?target=https%3A%2F%2Fvuejs.org%2Fguide%2Fessentials%2Fconditional.html" target="_blank" title="https://vuejs.org/guide/essentials/conditional.html" ref="nofollow noopener noreferrer">vuejs.org/guide/essen…</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[2025-12-20 vue3中 eslint9+和prettier配置]]></title>    <link>https://juejin.cn/post/7585468725332197430</link>    <guid>https://juejin.cn/post/7585468725332197430</guid>    <pubDate>2025-12-20T08:19:05.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585468725332197430" data-draft-id="7585474459776090148" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="2025-12-20    vue3中 eslint9+和prettier配置"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-12-20T08:19:05.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Mr_Swilder"/> <meta itemprop="url" content="https://juejin.cn/user/3927901716878829"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            2025-12-20    vue3中 eslint9+和prettier配置
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3927901716878829/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Mr_Swilder
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-20T08:19:05.000Z" title="Sat Dec 20 2025 08:19:05 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden;color:#2b2b2b;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(159,219,252,.15) 3%,transparent 0),linear-gradient(1turn,rgba(159,219,252,.15) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin-top:35px;margin-bottom:10px;color:#4dd0e1}.markdown-body h1{font-size:30px;text-align:center;position:relative;width:max-content;margin:0 auto}.markdown-body h1:before{position:absolute;content:"";z-index:-1;top:-20px;height:100%;width:100px;left:0;right:0;margin:0 auto;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADsAAAA6CAYAAAAOeSEWAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsQAAA7EAZUrDhsAABkLSURBVGhDtZoHnJ1llcbP3Om9ZiYzmfSQhCQQIbRQVQKI9CYC68qKriJK0UXcZRcINqStIoiIqKCi1NACQihBWiCkkJ5MJlMyvd7p7d759v989/sy34yTbIj48Atz71ff855znvOc971xDrB/EtoGI7a9Z8Aq+wZML0mNj7dE95NZ1OKsj1dHo1GbnJpss9OTbWJyonvun4VP1Njuoagtb+m0it4By0iIt8LEeMvkr8XFWcfgkA1gYDLf47i2PzpsyU7UspKSLDoctagTZ7Vc08MzClMS7awJ2ZaflBB78CeET8TYla1dtrKt2w5KS7YCDGzEoz2RqKUmhGw6x2bhuXyOp2BoRXef1Q1E7Lj8TIsMD1sbxu1kcnYSAX1810RMTUmyMB7f2j1gC7NS7byinNiL/kH8Q8a+2NRh77b32El56VaPAe0YeGR2mh2bm+FdMRqP1rbZe+3dFsHT35qcb/Oz0rwzo7Gxs9feYPLS4kM2h8lawee5hPmlJXneFQeGAzJ2F564v7rFzi7Msu3d/Xgjzq5g8ArX8VCNN2vJ28daey0zZJabmGCLslP5HOf+Oygr3UzDGOf+JxrauXfQjslJt+dbuuyMgiwmk+sPAB/b2Lt2NdoMZnuY21qHIvbvUyZ4Z0ZQiXGrWjvsmPxsK4R0nmHA8ZCTQvxVQn5eRipklIBtcVbV1WtHYsjati47ZWKuTUpP9Z4yGk/xDBGe3v1mW4/dOrvYO7P/2G9jRSjf31FnXyaUXiB8r51WaJkM3kcfOSa2FR6qarIenooTLQHPLcC4mYThyw1tVpKWYlVERlZ8nC3Oz3Jzdn1nn5uvQ8OOHYvhR/CvsqffJbkCkZTvcYZ6Z0WTfTovw5Y1dtjXp+TbFPhgf7FfxpYxuMfr2uwo8rEtMmwXF+d6Z8wGmIR2PLyjo8cqOFffP2SLGexJEJCP9R29thkPXlpa4A5Y3w/jmuVNYYwO2QkY7WMtz3mVcE1hkualJdmSolzX8GnpKd4VZq80d1o7zN0RdWxGaqItgbn3B/+vsasgh/UMNBOvzYMZDxtDKp289KGaVguFQvb1yQWWwuB97GaSXqUUnVaYbSUwrDCEBz/C2CM8EhNrP13fbkeSh3OJgCAe2N1CWXKsGOc6TOr5U4q8MwYhDtkTda02MyPN+nnGBQEH7A37NHYz5KOZVv08qyjbSseEzKauPnsMj98wc6Ibcj5UUv7M8QWZTE52jEwGOVaD8U1Dw1YNWX0qM8VKyb80L/TrOPYOzH4KBJQTrK8M7+7KZjuM63sHBt17FubGoibCuf+tarWFGUmuwWeT8/vCXo1tZOYeZcazCaez8MwEzzM+HqhqtiJI5twxL1jeGLYk7jmKMF1JOCbg6Qj5nAdRqX7q3BYm8VAmQvW1lfcMc58IT95uIA3q+gftrDHPXUXJWkVEHJme5Bp5UmHsvIZ/O3l8ECE/FWcsItX2hr0ae8O2Wjs+J43QTbOZzGYQ/7Wtxq6eXjRK3r0By4YJ6Ty8EiYSJqcm2eGeV4Pox/ANENJR49RiEdfqcLflUJrEBZqgxYHrBjn2ExFURqKdVETN9YirJxKxR2rbrYeQv5ISmB6IsiDGNfZGWPeMgkzr58xnPaJ5p6XDZPKz4T77wayJ7jGhhXLwanOHTWBgq5n5q6YUwNJ7l3kKcRl7OJ7fF56l1GzvHbSD8dghTPi0wIRfv6XafjJ3ssv0PnZQ7nZx/etwzO1zJ3lHR2OETTw8x0tOx1AN3De0D7YV+63oGthjaJQ5Ur7eVVZjcdGInUyuaT73ZWg3efV8fZs7cc2E777Qi5eunVbghvPPymrt/krKGfcLd8ybYjdxrK6333Z09rjHZkNuLYzz0uIc+xWCZzz8nbHbe4dsY1e/XUOY+nimvtUaSazv4jXhaQasSbmYmpuenGwHZ8TKggSEQm08rMD7ahBOoExcMqXQegjnZ+CEvaEa1ZQUQkt39dj0zDS7krq+ARmpdws/nlNqD9WFbWN7l5u3wr9MyrcXKUsqWy3jTOaoML4DdaQ83YIoT4VYpEXvYQZLmbX5SLohBrgOj186Kc/iKTUPUhq+Rrm5ekOl3TWv1Mr6hqwbY0VOQXwEo+Moq4Z47q5qsU489G944LyJOW4LOLZOKtT/iI6+nGe/0dhuEd4ltj2NmiuCU4hnk5fHIi7+RK4uTEu0e+s7rAiRcw1CYy3OejvcYz+eXeI9MYY9nu3lYZl0KavJJ7Vjibzgjp319rUZE20j7CkJqFr5JQYgQ39f3eQaKpQk0afy8nl4uBzvjUUTRk7k3iebOm0pabDiyFn2XGu3dRME41CGVeBVqSiVnc6hIUpekp1VjHLDSOEcQlui5W/U8C7IKREjv1Gabw3wRwUTvpv7jybPtzHmIPZ49q6KRjuccqBQVCOtGvqXhrCFUUXJzOYSHt7Kw5Ix9H08dSje1o1JyL73IYXpEMmE5CRbw6wuykx2pR+Pd6/J4JpLiJKV6N9OnrcQNfQ0Zem6qQX2MmFXyWTE+DMO0kGx4e08DEjnXbsYuOq7niHB8jdY/wQ8Srm2XCZZUrOakF1CY5EKX0h93Tu/1J4kRdbDMT8MamgZK9xe3uDcvrPe++Y4f61rcZr7B53rN1c5N2ytcV5rCrvHt3T2Og19g+5nH7dvq3bqunr4NOwgK2MHA1jeEDuG7HNuLmtw7qpocl5t6nCPvdTQ7v4N4u3WTqeyu9cZHIo4f6lqdFoHh7wzMbzDeeGv3Hvzjlrnh2W1zofhHuftxpFn3VFe7zxS0+p0DlKVPbhhvBxhvwiFMgfP+mjHA08gEC4pybeLyK1iZldh8zC5VJQyUl8l59KZ0WJk2xaiYWxNrkXXJhA8r3PvZRur7ZZZRfadaRPsfiTmX9HGajC2tXd6V8dQTMhX0h8rNdJx9Ra8F8SbRNLzhPRnJmTZIUTYueTyWxyr7uv3rjC3OkzE8495oS+4xq6D5WoI0bO5WVCOSerl8rIeBrOI/Hkaw6ME5W1zSuzx2la3CRdWi3zIG+FDBvUp9LMgI/vggUmE7KkT81yGvOOgEYa/aUahhRAF5xLec3OzbF1r2O17BbVxIi7hzJIC64IYhXdJA+nh/5xVbOmE9J0QqjSxWk0pp37M2YEtgjS8GpimACu7xkqxdKJ6fEXyYl2Lre0ZtC8yELVewtWUnbfCPIhrvgDFz8WI5yhJKgcnFMZWEFrwhgzo5uWDDDA1oGSOzcu0xfx7vTlsv6posIMpJ6cGWPiw/BxL4PU7vbrpjgf8bMdu5OYwOdhm83DARUSa0ELknYIeEAaILuWxlhGa0M8+EuJCrpJT+ymENhN60pXBxa3LZ5TsucnlGaCmIEQ4Evru91yuz0xMtKaeXluI5zdh9Mm8vAlBn4aR07X64EH3vEKdXQkZJXPP/JxMvNRpLxEtHZ5RQgmNewnpouvVTpYTHdfOnmy5kFUGnpRTfEhXD9DiBdFFJB0/YWS9aj6pmc89r0BaQmgTRkgI+EsdKsYasJZOBF+QqTH474NK7LbyBvf7W+RgOxNyxfQY2/2hrp2+NkroxrzrQ55fSZkpJIa28znCgF6rb7H1hOSslATyvNflAh9pvHcX3lVE/Ya8FjTJIexa2Rq77nfU96unTnD7aME3+TAm6BFKYrPnqCNIqV5sq0ZGCiEV+Db+qWMQqpFgb5KPx48R6omeDl2EuP9DTYt9iGA/f1KBS1w/La+H4ktsSmLItvZHXLUkrCeflVtJ9DVVg1H7+sxiGvVM975rZpfabuqHVhuP5F1vewav5O8GamUe91yDanoYw47FWzC929O+DJnKA2opFY1Rjru5CE7kOcO0jJtQVUIynzuZEMeb+1CEOFXN8iFSGeRpCm1BTlJxVg49Azm819SO7Bu0axEbwn27GuxMck+TMQHDP8fn48gfDVIL4R8xKVPJ73MQBUIfA/Z54LMw5vmlE+w+VFo2A78X/SsyPA/RMD0z3e2qVLtfo7aeBslpMX0N0TEnLcUlKym1jyBFqSohmYntI5enBhYB9CY/2kNarhwJhNiMtRGyWnkQdKaCFyQwgydjyNUw4VchKxXv2/DoKdC+lkQbCX1NlKCGvJiBJkSGbCus6jfo4yGBNySgr+u7e20BCsxdVAcFlJ/tHd32+cIsNxSXUULUUx+dg/d47g7OPYFw2MxkSuyMwLHVTI6PBN6dS8Sppw45zHJSgDXV3aQzmz40Z6fDgBfiAXU0uZxby2zejee+j3eltoQMzhV6qSBogXwrEXDj7ElWxUQ8RrnSaoU0dxIsKaiMvMykXTu90NqJsGHP4z78SdLigUrLKat32nFwy/E07pfDFRdQ/7N5r57pQ1482uvWhMGhQcviGkVrKDUp0ToCxfhQal5n4Hs/g1jOgH4LWdwFOd1b1WzHET4vLZppv+Czjxo840OrDlG8jAJzv2tp5mLK1dsU/lfIOeWy5NxFxfl2BoYImlQtx9QF6mJRQKBsQYYuO2yaLYPBUXvu/VqYPxtHhNy7Y4hCkNLGPtKSklzCVKSHtMQxcqm5Kw1DhI2PTGZtcGDAvoLQ/u7MifYtWFBlxz2H9zo8RkwKzC5UYiG+p44ccqE62YAxLeT/TOpf8MXx8Qk0IJFRY1Go+viQVJpE5Ehjf49xfAZeqGIy/7us3nqxwQfCkjZypPxobVr/6YpQHIalUvuCyEwbSXC9PC8QnkFcXlrgLpoLIhIfKuaqlQkYIAwQnr/f3eyu7KttOw2lNpv8/BPHyjzVNER3o72gvEBKqRMTflndbP8BMweRDyeciEj5bFayFXqTLzheivgYJC0jwzwHa0MDDEotm48ndze5BBBElAnxxcRYHAFh3FfZaA9UNRmC354kNwUx8eHkmVj5dcTE5ZMnuEyr1QqlhtaJLuOYZv4v3KNo0TKrGPUZ1NILPKuWcvVn5Trv10SMB6h0j/ARMnlOuafCBIfnSWEx/Raif3HDzofYMM31dOyY9LBaLK3TjoX2fEqT4+2qaUVWSTQvyM6wC8nNJyEetXIyuLKrx04P7MKNnbJZlKUtNAIHo7i2dA/YU3Vtdi5l6jCepXy8hOedSSSsI8/HQg5Q+gxTKXwkMHkbESo+hjG0lbRRzQ3Fc5LOzDuFhs3Ptumpie7ilRDhlEJOq/hjsZljCxjkt7fWuPS/EekpXMggJQIk0G+eN9Xu2VmHWIkJe0nJRN4ptBBit2yutG9ML7J1DHAxebiAMrZ4VZlduqGS8I2tJc2iborUxmIN79c+kTovFxivPvrcSaP3n7RSKYTUmKt4N3rMOcw4JOneD3sP956jNaMglIeTER5Xbdlt15Tm2W10NEsYrA/N5JLCHHsR9tSqwxq08G3bqm1ZTbOtagnbo6SLvH/VzBL7W7jPzqFea0LmMLFzUuLtdwumuO3i1Vtq7OK15Xgw3l1PDmIXak+6QBEkvB9YJIzBcc/L20JIYaSZ/qAzVm5Ut4oowk3QehC+N3xo/1wTqt7zsYawfX9no9XjqdPXVLhrwyo/wucJYQkE1e4j8rLcBuHUItQQKqgMXb6LGvxFQlXw33AdZLR0V5P9Fr29lP73scNnosoyvdWPv4fPJ+uJrLVtMakqaL1M1cTvv0OLIZE6wk2a2IcIRUQh+DaejpdcXepBa7bKDRGM9PIVxTl2EwarZ72rooVuY4RQtMypdk6e1lLLehhY2lt7QEd7WxlCDvdIli6E9B4+ZIodmZEMccUGqgiZOqru9tkR3iJ8nCcXRWRZCSPMLPEjlx2LjQL1OM5qKAm+vhSuRqSfV5Ttrg8FdWcrnhMqCTex7DEM6qTsVEuM1+8hovaHQ6e6a1Fz0xLd3nUt4ToWWuzWNkhcoAIIjUx2ZpxjLzWF9+SYmngR1lok4TEoJxGfuijhI/7OICoFmadl2llcL9b1oRVJtbD+JLlv1KrhHG5811t9ELbzgk14ICUwqE+TDzftqHPz98vUSy3jSIwP8dCpkNqLDPTx+rArz4T5qLG3G2PrvJKKPoLBWE501NC3ilUX5mVjVIb9nIbgWcpPMiSXjbcL8K62UkR86m1/yfkSeMaHFuK04X0CE3J6SWzFUxw0BSNHlSzi3RmIRJwHq5udO3c16quLp6sbnffbupxbt+12vzOrzuvNHc7ycRbIxuJHgYU7YSASdQgxp7qz2ynv6HJeqW91doa7nLruXof+17sqhhu31Xif9o7HalqczV29Dnrb/f5EXZvzdH27U98/6LR5i3N0UM5zjHU71/lwjRWWltU5CAIn7F1MqLp/r9hQ5RoaxG+qmrxP4yNKcfsFLwuiprffeb2l03m2scO5h3Or2rudzjGrhk8x4Cqu2xcexilBvNEcdi5Yu4tKF3Ue4tzPy+td5/1md4tzw5iJ27NuXEYobYUdlb8z6GTWkdxaCvk2zHjd5mpKQ459mv5TkAp6mQb9Aq9HHQ8S6mrZnuc6vUG6WHusIhCJGNXl9byvnJyaiE7+Eoz8c5TYNQiUveENGpJpcIJ+biS8R0+rlcazGNs7pKB+zPLTOSX2KNWhlDAf4r2Spj72JORB5OyHULX+dlD/FOky/HFy5ygYU0sey/i8moeqdunXK1qC3RuaMOYHlI/raQMl3M+EeTV5WxD3Km8a8PkM8nr648sQ9+esKbf5e/nxiKBfAOQkxbv3SU9LYmqPV9V/Pn+V20VwTyVjTqCI6edEQUOFUXs9WmfSll8DyX2dt7GlnwkswaM3l9XZ0oNK3MTXbxpOV2sGk69s6XCJw4cY8KbyRrt9TrHt7Bm0rRBQe1+fHUWNfaapU0KbqxzbORC1M/LS3dJwIl3KOrwykQG/E+61q+isgniztdOKqNOziDgZqZIzFwPvqGiyg5NCtoCqoG5NxHhPZTOsnORulKskjoKMDeLuXQ3OmnC3syxARFXdfc57LR3OrdtrvSOOs55rnqhtcdoGhpxHdjc5EfJUuHZTlftX+G15rXPlhkrnLe59F7Lz8VGHdg8c5y2OLeMZ126qduq9XC3v7nd+FchLvYPJd15gPCu8XQnh/qpm59WGVudZzvvQO97kXTcGxhnEuJvR39tWY8cwK4uhcikk4a3Gdstg9l5B2t0wfaTdWkEou5vCPOV5PH73vFL3+DfXltnh6OxjkJD6Wd5F3g88tMe6CW/7YmI99VIL4u0oqUK8ocW4d8hFrXMVoOQU8s3U97MnjvDD/XRYkyhHM1MT3GVZQR2Tdv70U8EbA5vlo+CaPAaaSWoZXm50otGodxQ6L6txGKxzw5ZYORrBsPPrykZKQIy1n8bTjwb2fO4Te3ue7x6KOKvaYns1wtIddd4nx3mwot55qyl2360cp81zurg+CGqwU8v4/Of5uAVvPgObrwvHomY8jOtZ4fXWLnefdHVXv9044+8ZklCx75DXwcV1Sb27y+vInUQEuVYSaMgRJYfAwtoj0raFxIUW1A8nz35f02qLc9Lc9lG7CBkwtUR7bf+A+5uL6ehnH9Lat+5sIEfj3Cbj3NKRvP7Rjlo7FSmqavKvpSP8MRZ7NVbQYLSkqlC9ZW4sPH18gBTcORjrhMWmQWzFmK2UsvO90qQ1oZcI8UhkCLZPtRqMy0NirobAvjIpb4/sW06qKGyPR2oGIdlazjOOTk+kLYzaaYGSp63Wz6HsXsQ51wd+LTAuZOy+8GBNq7tF+IOdDU4kENJthNID5YRafZtzZ3mDs9LbRgzixcZ2l1h83OKFbDmEd0/FiFp7DWHgp0AQGzq6nf8hPF+oa3EehOz0ziCWcm4NpBRMhX1hn571oR9wqVVSDVPtUi32sQ0vbu7scZdY9aOt2ZSEL9BEBIW+dv20AKDd9/ep09oimYqHpyImkKDuRllS4PrlHNuIqDmCJmNJQba7q1joEaUQJuR/WdXsLrJrq/L6cdJsPOyXscJ7GLKqo8cOpqhrO//yQG6oS3kZwS9xPkRB3wi7diFMtDN+PLk5m1ath+8f0Fy80dbjhvVXub+U5mEqeal27UP+dWpPlknNxW79Ak6/7Tg3UMOF52j1xA1qK7Trd6nXC+8P9ttYQcumIonLSnJtBdJNa77axw1C2x3qR4Wqnj73x9f6MbV+CCYFBZO6y51aSh3gzVrsmwzJnULEbCJC1oZ7vIZ/9Iqmfvn2u5oWO5n8fApxcuWUApum5diPgY9lrA9EtvUNOzYf8vqAcJPsU5iOh7XtXQgt2uZhjKU2amF7HQyfEYWcZk5yQ1RDKNrLcq02k/9IGmldrB93KiokPw8EB2SsoKWXO5FmxXhlckqi+3vEUvLqwok5PHVkIWAszlqzy1p54zuLpnPZ3q9bod08JlLSb5DrNxDm38Sbvsg5EBywsT7oH+3XNW3uasGirFSrxRNdCllKiPZHZzJYLZb5qEcpae3pxMCuu9oibS5/QCOiLcYUrp+MmtJeURjFdVlxzqiae6D4h40NQt54HyGv3JRo10aVfv8YhtC0pSlVKcPFuxIXahr08mzCO4VzMlLSsZuomZ+RaucU0rXsw/sfF5+osUFonWob/7TrLdaUgdpV93fl9X+VIC0Y6tek2uI8OD3J5gT2Vj9ZmP0f4IM4iY7RQ5gAAAAASUVORK5CYII=) no-repeat 50%;background-size:64px 64px;opacity:.84}.markdown-body h1:after{position:absolute;content:"";width:150%;left:-25%;height:50%;bottom:12px;border-radius:50%;background:linear-gradient(transparent 80%,rgba(77,208,225,.8));background-size:400% 200%;opacity:.6;animation:h1Animate 6s linear infinite}@keyframes h1Animate{0%{background-position:100% 100%}50%{background-position:100% 50%}to{background-position:100% 100%}}.markdown-body h2{display:block;border-bottom:4px solid #4dd0e1;position:relative;font-size:24px;padding:12px 32px;margin:30px 0}.markdown-body h2:before{width:24px;height:24px;left:0;top:0;margin:auto;background-size:24px 24px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAADGklEQVRYR81X32vTYBQ999s6mFjQgQ+DrbHiVFZYU4cDcQ/6pGhTFVYFEXGi82H+Bz448UnEF1Fx9ccEEcXpZE3d5tP2ooKiTacTHaLNpigMHDgnU9tcSbrWrkwWR0sbyEOSe885ObnfvV8IRT6oyPwoLQHBx+OVM5WJvSyEVAhnBOjt7yU/+/rr6r6l8TMO+F/EN0JQhICqQpD/xaRpcpAc9tS+M+9lBCia/oqBamK+zeDuQogQZaKJk3wcQjxSva7tGQGB2Ke1zIk3DNyMyNL+QpCnMQOaPsDAVuGAp9cjvbYc8Ec/bCYSg0zoiHilk1tHxqsqEsYlML4kjIpT/eurJxRNPweQU5VdrWaOEo1fgKAVbBgXIz73kF3R/ph+ghgdzMYWM29eAWlBJqgZaFlFYtC6nhWpaDqnSGlIlV1WjJ3DloDNgyNLncudqgX//Ucg3LxuStHGuhi8pqKCW3rqV342rwFjRznKm+/LNaN2yC237ThgF2wxcfMLeP6+ncrKzoPoKTGeLQbYbg4TNoC5iZPJY5HGVRdSNZAWYBclD3FzBQzrR8hACAKdzBzKA/4/IYioDQaOskBbpEG6PO8qKKSAEi3CnEb0Pw4oMf0OmKbTDWqh3Lw6EIiNBZi5lxh3wz4puBD5ovqAMvxhHSdFKxE1CQe3m/07TeTX4lcJdAhE+1Sv65Z5P/ByvIGTRowIZ9igbtXnmrOsbTvgj+kHBNMuBu9OdVw8EeU4nC1A0cYmAHZOTRrLhra4Z8ywnSN6vZHAFTA2WnnMfQB3qz73ddsOZM8CACFDIPSgQXqebXEgqgeZcAeEe6pXasm1f8ew3igMtAHWac0Uc/jYdyAaP0xEBwFsmgUPqbJ0NE2UKj4EGcahiOzuyhagaHpnmtgcVgTcCMuua7YdyAHbA3ArQNscVFbb4635aD6fnYaTvxxi9UNP7ddMXaRWVBdAcaLk6bDXPZCNZ9uBXEsDUX1T2Cc9yjig6Z0EHg3LK8/aqf6MwJKchkXfks1+0+JtSq3qLPa23BRR1B+T/6nkfMaW1r9hPt/MLtYfTLEpP+T9FNoAAAAASUVORK5CYII=)}.markdown-body h2:after,.markdown-body h2:before{content:"";display:block;position:absolute;bottom:0}.markdown-body h2:after{right:0;width:400px;height:10px;border-top-right-radius:24px;background:linear-gradient(90deg,#fff,#4dd0e1);max-width:50vw}.markdown-body h3{margin:30px 0;font-size:18px;position:relative;padding:4px 32px;width:max-content}.markdown-body h3:before{border-bottom:2px solid #4dd0e1;width:100%;content:"";display:block;height:28px;position:absolute;left:0;top:0;bottom:-2px;margin:auto;background-size:28px 28px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABRklEQVRYR2NkGGDAOMD2M4w6YDQERkNg+ITAppcfY/8zMv3wF+NdTUrZQpUQ2PT6cz8Dw/8CkMWMDIwNvqK8jcQ6gmIHNN19EaXPx1XPyMCghrCUKcpPlGc5MY6gyAE+Fx52MjL8j3cU5a1UYWXtZGBkEAVb+p8hxU+Mby5NHQCxnKEMaskzJ37uFmUetkmMjAzrfUX4woixHBJlZAA0y2EmPPYU4enLkhGeQIqRJDsAh+UgO7duNpD3IcVykkOA2paT5ABaWE60A2hlOdEO8D3/4CMDIyMfWvySFefoaYSoROh74eFXBgYGLiTNVLGc+BC48PAnAwMDG9QBVLOcaAd8P5ox+x/jf5AjGLgYfnwnKqv9/8/PwPO/kFF/MSj0cAKiouD/0bgYoixFU8RovWgJIX1EOYCQIZTIjzpgNARGQ2DAQwAAvHBaIdB7zxsAAAAASUVORK5CYII=);background-repeat:no-repeat;animation:h3AnimationBefore 2s infinite alternate}@keyframes h3AnimationBefore{0%{width:28px}25%{width:100%}50%{width:100%}to{width:100%}}.markdown-body h3:after{content:"";display:block;width:28px;height:28px;position:absolute;border:2px solid #4dd0e1;border-radius:50%;right:-15px;top:0;bottom:0;margin:auto;background-size:28px 28px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABRklEQVRYR2NkGGDAOMD2M4w6YDQERkNg+ITAppcfY/8zMv3wF+NdTUrZQpUQ2PT6cz8Dw/8CkMWMDIwNvqK8jcQ6gmIHNN19EaXPx1XPyMCghrCUKcpPlGc5MY6gyAE+Fx52MjL8j3cU5a1UYWXtZGBkEAVb+p8hxU+Mby5NHQCxnKEMaskzJ37uFmUetkmMjAzrfUX4woixHBJlZAA0y2EmPPYU4enLkhGeQIqRJDsAh+UgO7duNpD3IcVykkOA2paT5ABaWE60A2hlOdEO8D3/4CMDIyMfWvySFefoaYSoROh74eFXBgYGLiTNVLGc+BC48PAnAwMDG9QBVLOcaAd8P5ox+x/jf5AjGLgYfnwnKqv9/8/PwPO/kFF/MSj0cAKiouD/0bgYoixFU8RovWgJIX1EOYCQIZTIjzpgNARGQ2DAQwAAvHBaIdB7zxsAAAAASUVORK5CYII=);animation:h3AnimationAfter 2s infinite alternate}@keyframes h3AnimationAfter{0%{transform:rotate(0)}10%{transform:rotate(0)}50%{transform:rotate(-1turn)}to{transform:rotate(-1turn)}}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:15px}.markdown-body h6{margin-top:5px}.markdown-body p{line-height:inherit;margin:22px 0;letter-spacing:2px;font-size:14px;word-spacing:2px}.markdown-body img{max-width:80%;border-radius:6px;display:block;margin:20px auto!important;object-fit:contain;box-shadow:0 0 16px hsla(0,0%,43.1%,.45)}.markdown-body figcaption{display:block;font-size:13px;color:#2b2b2b}.markdown-body figcaption:before{content:"";background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgBAMAAACBVGfHAAAAGFBMVEVHcExAuPtAuPpAuPtAuPpAuPtAvPxAuPokzOX5AAAAB3RSTlMAkDLqNegkoiUM7wAAAGBJREFUKM9jYBhcgMkBTUDVBE1BeDGqEtXychNUBeXlKEqACsrLQxB8lnCQQClCiWt5OYoSiAIkJVAF5eVBqAqAShTAAs7l5ShKWMwRAmAlSArASpAVgJUkCqIAscESHwCVVjMBK9JnbQAAAABJRU5ErkJggg==);display:inline-block;width:18px;height:18px;background-size:18px;background-repeat:no-repeat;background-position:50%;margin-right:5px;margin-bottom:-5px}.markdown-body hr{border:none;border-top:1px solid #4dd0e1;margin-top:32px;margin-bottom:32px}.markdown-body del{color:#4dd0e1}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:rgba(77,208,225,.08);color:#26c6da;padding:.195em .4em}.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace;overflow:auto;position:relative;line-height:1.75;box-shadow:0 0 8px hsla(0,0%,43.1%,.45);border-radius:4px;margin:16px}.markdown-body pre:before{content:"";display:block;height:30px;width:100%;margin-bottom:-7px;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAAAdCAYAAABcz8ldAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAhgSURBVGhD7Zp7bBTHHcdn33t7vvOdzy+ITVKDU0xIKG2ABCPTRCCaUiEVKWoqRJuASAhCitRCVKSoalFUKZBiSmmFRRJKRUnUtIpo+aNqGgwoOCmuFUIRzxjwE4zte+97drYzztji8HPvtkit/PnH+n1397Tz+83vN/PbMZhmmmmm+d+BoX8n5diihcGqgFQf5vk6BMAskWUlw3GyFnIvtqWSf91w7mKC3npfOLX7wYeiIa6BBWCOLLFRF2NB0JvIOP/80YG+k2ev6S699b/OzOfKBW5l5KsgyC4DCFQDnpEAdE1goc/dlNPc/Up7P711UiYNSMuyxeUzZPnHgGHWh5XADEkSAcdiN+AnEXIBhBComgFU0/xQR+jnj51sOUMf9Z0NKyL8S9+JPBEN8zuCMrsqGOA5QWAAyzLAxe53HBeYFgJp1c5Cx33nyIfpV3e+22/Sx32nev/sMCgVnmM4bjOniAtZWQAsz315EfsGQQc4hgWcjHkCmOj1rheuNn95cXwmDMiVp5etC/D8m5FwUWVQUYYGPh6mZYFUOgsGVa1pXvOZzVT2jRuH54RM230jEuI3RcIiL4l4UkxAJmuD/riVsqD7ct2m9nep7BtVTbVfZ0uE/UIk+CQflAHDjf8+Lg6MldYATGpH3c/Ul7p3dWXppVGM6eElJSHmnQWPbSlRlN1lJcUBjqNRnwJZVQO3B5P/uq5rK1d90pakckFcaKp5UJHY92JR8YlwkUDVySEZfGfQdO7E7Z8s2HL9TSoXTPXRud9nA8IBqSwcZgWeqpPj6BYw7yTbXBN9q2v9lQEq5zBmWA8vWLCptCi4tzwW8RQMQlFQATPLSh6vCSh/plJBkMyQBHZfWYnkKRgEktEVpTJXERN2Xzo4ex2VC6K6qXYpF5b3ypVRT8EgcAERSJXRbwCBOTFzXblM5RxGBaRt+ZPYA+LO0mgxz5K1Ig+UgAzKIuGnz39z6S+olDeaibaXRsU1RUFvgx+GwTWgPCaDgMw2XXpr9gwq50XV0bkxJiYeEiNF5cwE5XsiOEkAUkXkUW51SSOVchjl8WKef604XFSRbzCGCYeCoESStv/p8QU1VPIM3knNDynctnBRfsEYhgSlNCIGgQv2UCkvGIHZgteMh1nBW9W4F16RAM6yDVV7amZTaYQcr59cuuhhWRTWBvAMLxQGeyFSHOLnh0MvUskz5RF+fbRYDEy0mZgqQYUHOLhr//b6rGoqeaLqQG0pw3PrBbyA+4EQUkRmhvgqNUfICUipKK4OKUqIJVPKB0jpEhjmWWp64jdbKmVZZNYogcJm493gsifOqhDyeh9GYR/FM7sW+DA5CKR0MSK3tvKZkpwB5gRE4tjFEr7RL0iWBGV51vHFCyupNGWWPqLgnoer9mtyEGSJAzwLllDTGzyznDjRN/CwOFkoFb4bm0eVIXICgpvdGoEvrF7fC89zfLkkeV5HbOhWiTwTpKYvCAJLGshRdXtKMKAWlyxq+MPQLk1h66g5RE5ABJYNFrqY3wvJklJRUKg5ZWLFXIA86yek2uDOPkBNb3CM5Pf7DL2QyIrUGiLH+xC5Bmmm/ARnHUhC6PnzxWDK0RH5HuIjZGy27erU9AZ0dTIWXyG+NpBBrSFySxZw220IqeUPFoS6jVAPNadM7yDsgNB1qOkLuAziMYIb1PQGA75wIaKGPyAb+9oF16g5RE5ALIQ+tSyLWoWDEAK6aXW3JlK9VJoyx1oyvVkNdvo5KXXDAVkdnaKmNwx0xjH98w3JNmTCm+Bc9hKVhsgJSI9pvp9Vdd++jmq6AXB2/HHrhcs5aTkVDv0DFzoHvKdq/mQsKX/4t7KJLDpOJW+IbAvMGoMkxfwAWZB8DT7W1diTE+WcgKz6pK1bs6z3daPwmJDsSKt6ZsCyjlLJMz0DsDGZ8SdlDROBjOb8YeWOjptU8kTXusuaazu7oJrfEnQvdkpVcUn6PTVHyAkIIW7br/Unklni0EJIZ1WgGsauZR+fvUglz6zY0dGfVp09ybRNlfwgi3k8YSbvJJ29VMoLt9v6rZVQL7hOYUubndHJGclBtzn1byqNMCogi09/2nFb01/oj+f/5TyjauBOKtPcZ1r7qZQ3f2lRfxZPWi2anp8TSDAGExZMa2jr8u03L1M5L7q3Xc+iAeuHRl/ScvPcjSLDBnZS/cjtNHd2v3171Ewbs9N5q7Pn4otVMx3btBsCsoRbk1FxG5dMVgMDqfTpXl1/tuFMa5zKefPROdX59qLQBwLnNog8Wy1OcjB1N+QEsW/QsFNZuO35Xb1v98QLX4/Sx+O3wqujrQ6013ABUWI8+AaqBjAH01+ghL22+5X2PirnMG7r+esbnae/V1neauvGSoHjigTcVU7UGFm2DeK4ttxKpQ+mLPvl+o/PjnkAkw9HTqSMmVHhyAMx9iFcSh/BHTfLceO/C8mKjApBf9zszGhoY92m9sN+BGOY9AeD7eGniv8OTaOB4dgyTsQd9wS+IQu4lciYdkI7CLrNH3Rvbb9FL41i0tbzVP2iWJkobpN5fmM4IJfJskTP1Bk8A9HQmbpmGDBrWqdVCN/Yd7PjxKGOXn+bmbto3feVVcVB9qehIL8EJy8nChwgr0O2xxBnhGU5eP2CfYbl/m4gBRsbtneMORP9oGpjpcCsiKzHHfdOPiQ/wMniyFEu2dbiTQCAeN/vavC466BGYLttXc9fmXBXMGlAhiHHur+sq6uPiUI9z7CVHMPwBnLSuuN8FuC48/Oaz1ylt94XfrW5ouyprwWfYRkwNyCyYYjwkBHows1fa+tV/fzGxlv39b9gqvfPmQ+i/HK8KlcBjhHwfl8HEHyOd1JnuzZd66S3TTPNNNP8/wDAfwDG7G0m9LKBpwAAAABJRU5ErkJggg==) 10px 10px no-repeat;background-size:40px}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{color:#4dd0e1;border-bottom:1px solid #4dd0e1;font-weight:400;text-decoration:none;margin:0 4px}.markdown-body a:active,.markdown-body a:hover{background-color:rgba(77,208,225,.1)}.markdown-body strong{color:#26c6da}.markdown-body strong:before{content:"「"}.markdown-body strong:after{content:"」"}.markdown-body em{font-style:normal;color:#4dd0e1;font-weight:700}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:rgba(77,208,225,.05)}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{margin:2em 0;padding:24px 32px;border-left:4px solid #26c6da;background:rgba(77,208,225,.15);position:relative}.markdown-body blockquote:before{content:"❝";top:8px;left:8px;color:#4dd0e1;font-size:30px;line-height:1;font-weight:700;position:absolute;opacity:.7}.markdown-body blockquote:after{content:"❞";font-size:30px;position:absolute;right:8px;bottom:0;color:#4dd0e1;opacity:.7}.markdown-body blockquote p{color:#595959;line-height:2}.markdown-body ol,.markdown-body ul{color:#595959;padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="atom-one-dark">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#abb2bf;background:#282c34}.hljs-comment,.hljs-quote{color:#5c6370;font-style:italic}.hljs-doctag,.hljs-formula,.hljs-keyword{color:#c678dd}.hljs-deletion,.hljs-name,.hljs-section,.hljs-selector-tag,.hljs-subst{color:#e06c75}.hljs-literal{color:#56b6c2}.hljs-addition,.hljs-attribute,.hljs-meta-string,.hljs-regexp,.hljs-string{color:#98c379}.hljs-built_in,.hljs-class .hljs-title{color:#e6c07b}.hljs-attr,.hljs-number,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-pseudo,.hljs-template-variable,.hljs-type,.hljs-variable{color:#d19a66}.hljs-bullet,.hljs-link,.hljs-meta,.hljs-selector-id,.hljs-symbol,.hljs-title{color:#61aeee}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}.hljs-link{text-decoration:underline}</style><blockquote>
<p>eslint 9+相较8版本使用<code>eslint.config.js</code>和扁平化配置方式。</p>
</blockquote>
<h3 data-id="heading-0">1.在项目根目录下安装所需的开发依赖包</h3>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_"># </span><span class="bash">核心代码检查与格式化工具</span>
pnpm add -D eslint prettier
<span class="hljs-meta prompt_">
# </span><span class="bash">Vue.js 语法支持</span>
pnpm add -D eslint-plugin-vue
<span class="hljs-meta prompt_">
# </span><span class="bash">Prettier 与 ESLint 集成</span>
pnpm add -D eslint-config-prettier eslint-plugin-prettier
</code></pre>
<h3 data-id="heading-1">💅 2. <code>prettier</code>配置</h3>
<p>在<code>vscode</code>中安装插件</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a1742bb6496d4f07b32be2c2963d0580~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTXJfU3dpbGRlcg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766823740&amp;x-signature=%2B2%2BlEqI6zH04b3JliMIuAzgjdfY%3D" alt="image.png" loading="lazy"/></p>
<p>根目录下新建配置文件 <code>.prettierrc</code></p>
<pre><code class="hljs language-js" lang="js">{
  <span class="hljs-string">"semi"</span>: <span class="hljs-literal">true</span>,
  <span class="hljs-string">"singleQuote"</span>: <span class="hljs-literal">true</span>,
  <span class="hljs-string">"tabWidth"</span>: <span class="hljs-number">2</span>,
  <span class="hljs-string">"trailingComma"</span>: <span class="hljs-string">"es5"</span>,
  <span class="hljs-string">"printWidth"</span>: <span class="hljs-number">100</span>,
  <span class="hljs-string">"arrowParens"</span>: <span class="hljs-string">"avoid"</span>,
  <span class="hljs-string">"htmlWhitespaceSensitivity"</span>: <span class="hljs-string">"ignore"</span>
}
</code></pre>
<h3 data-id="heading-2">3.<code>eslint</code>配置并将<code>prettier</code>规则作为<code>eslint</code>一部分，对不符合要求的报错</h3>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// eslint.config.js</span>
<span class="hljs-keyword">import</span> eslintPluginVue <span class="hljs-keyword">from</span> <span class="hljs-string">'eslint-plugin-vue'</span>
<span class="hljs-keyword">import</span> vueEslintParser <span class="hljs-keyword">from</span> <span class="hljs-string">'vue-eslint-parser'</span>
<span class="hljs-keyword">import</span> eslintPluginPrettierRecommended <span class="hljs-keyword">from</span> <span class="hljs-string">'eslint-plugin-prettier/recommended'</span>
<span class="hljs-comment">// console.log(eslintPluginPrettierRecommended)</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> [
  <span class="hljs-comment">// 全局配置：指定环境、解析器选项</span>
  {
    <span class="hljs-attr">files</span>: [<span class="hljs-string">'**/*.js'</span>, <span class="hljs-string">'**/*.vue'</span>],
    <span class="hljs-attr">ignores</span>: [<span class="hljs-string">'vite.config.js'</span>, <span class="hljs-string">'node_modules/'</span>, <span class="hljs-string">'dist/'</span>, <span class="hljs-string">'public/'</span>],
    <span class="hljs-attr">languageOptions</span>: {
      <span class="hljs-attr">ecmaVersion</span>: <span class="hljs-string">'latest'</span>,
      <span class="hljs-attr">sourceType</span>: <span class="hljs-string">'module'</span>,
      <span class="hljs-attr">globals</span>: {
        <span class="hljs-attr">browser</span>: <span class="hljs-literal">true</span>, <span class="hljs-comment">// 浏览器环境全局变量</span>
        <span class="hljs-attr">node</span>: <span class="hljs-literal">true</span>, <span class="hljs-comment">// Node.js 环境全局变量</span>
        <span class="hljs-attr">es2021</span>: <span class="hljs-literal">true</span> <span class="hljs-comment">// ES2021 语法支持</span>
      }
    },
    <span class="hljs-attr">rules</span>: {
      <span class="hljs-string">'no-console'</span>: <span class="hljs-string">'warn'</span>,
      <span class="hljs-string">'no-debugger'</span>: <span class="hljs-string">'error'</span>,
      <span class="hljs-string">'no-unused-vars'</span>: [<span class="hljs-string">'warn'</span>, { <span class="hljs-attr">varsIgnorePattern</span>: <span class="hljs-string">'^_'</span> }]
    }
  },

  <span class="hljs-comment">// Vue 单文件组件专属配置</span>
  {
    <span class="hljs-attr">files</span>: [<span class="hljs-string">'**/*.vue'</span>],
    <span class="hljs-comment">// 使用 vue-eslint-parser 解析 .vue 文件</span>
    <span class="hljs-attr">languageOptions</span>: {
      <span class="hljs-attr">parser</span>: vueEslintParser,
      <span class="hljs-attr">parserOptions</span>: {
        <span class="hljs-attr">parser</span>: <span class="hljs-string">'espree'</span>, <span class="hljs-comment">// 解析 &lt;script&gt; 块内的 JavaScript</span>
        <span class="hljs-attr">ecmaVersion</span>: <span class="hljs-string">'latest'</span>,
        <span class="hljs-attr">sourceType</span>: <span class="hljs-string">'module'</span>
      }
    },
    <span class="hljs-attr">plugins</span>: {
      <span class="hljs-attr">vue</span>: eslintPluginVue
    },
    <span class="hljs-attr">rules</span>: {
      <span class="hljs-comment">// 启用 Vue 官方推荐规则</span>
      ...eslintPluginVue.<span class="hljs-property">configs</span>[<span class="hljs-string">'flat/recommended'</span>].<span class="hljs-property">rules</span>,
      <span class="hljs-comment">// 自定义 Vue 规则</span>
      <span class="hljs-string">'vue/multi-word-component-names'</span>: <span class="hljs-string">'off'</span> <span class="hljs-comment">// 关闭组件名必须多单词的要求</span>
    }
  },
  <span class="hljs-comment">//prettier配置</span>
  eslintPluginPrettierRecommended
]
</code></pre>
<p>此时运行</p>
<pre><code class="hljs language-shell" lang="shell">npm run lint
</code></pre>
<p>可以对不符合规则的代码检查，包含不符合<code>eslint</code>规则的</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/03c23319426b4f6d86115eea28bbe3b3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTXJfU3dpbGRlcg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766823740&amp;x-signature=5ietbj%2FFYai2fzTxhmmDQi%2Bv82I%3D" alt="image.png" loading="lazy"/></p>
<p>4.配置vscode插件<code>eslint</code>和<code>Prettier ESlint</code>，设置默认格式化工具为<code>Prettier ESlint</code>，让<code>eslint</code>直接报错<code>prettier</code>中的配置，有时修改了<code>.prettierrc</code>中的配置需要重启<code>Prettier ESlint</code>插件才能生效。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5991155e944d43e8a514563f1cf7d674~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTXJfU3dpbGRlcg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766823740&amp;x-signature=WlILNcFyOppEaY4XsUO1tfyjRZM%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ca06d152bbfe4152be64ba9accbe17ef~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTXJfU3dpbGRlcg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766823740&amp;x-signature=H4K5RzLd9rlKbrhHdippKxV6dfM%3D" alt="image.png" loading="lazy"/></p>
<blockquote>
<p>对于<code>.eslintignore</code>文件缺失时<code>eslint</code>会使用<code>.gitignore</code>文件</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[XMLHttpRequest、AJAX、Fetch 与 Axios]]></title>    <link>https://juejin.cn/post/7585463195201355826</link>    <guid>https://juejin.cn/post/7585463195201355826</guid>    <pubDate>2025-12-20T08:20:09.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585463195201355826" data-draft-id="7585686247269482505" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="XMLHttpRequest、AJAX、Fetch 与 Axios"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-12-20T08:20:09.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="用户5427784851540"/> <meta itemprop="url" content="https://juejin.cn/user/224762173330942"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            XMLHttpRequest、AJAX、Fetch 与 Axios
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/224762173330942/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    用户5427784851540
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-20T08:20:09.000Z" title="Sat Dec 20 2025 08:20:09 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在现代 Web 开发中，前端与后端的数据交互是构建动态应用的核心。围绕这一需求，诞生了多个关键技术与工具：<strong>XMLHttpRequest（XHR）</strong> 、<strong>AJAX</strong>、<strong>Axios</strong> 和 <strong>Fetch API</strong>。它们之间既有历史演进关系，也有功能重叠与互补。本文将系统梳理四者的关系，深入剖析 XHR 的工作机制与 Fetch 的底层原理，并结合 Vue 3 开发实践，提供一套完整的前端网络通信知识体系。</p>
<hr/>
<h2 data-id="heading-0">一、核心概念与层级关系</h2>
<h3 data-id="heading-1">1.1 AJAX：一种编程范式（不是技术）</h3>
<ul>
<li><strong>全称</strong>：Asynchronous JavaScript and XML</li>
<li><strong>本质</strong>：<strong>一种开发模式</strong>，指在不刷新页面的情况下，通过 JavaScript 异步与服务器交换数据并更新部分网页内容。</li>
<li><strong>核心思想</strong>：解耦 UI 更新与数据获取，提升用户体验。</li>
</ul>
<blockquote>
<p>✅ <strong>关键点</strong>：<br/>
AJAX 不是某个具体 API，而是一种<strong>使用现有技术实现异步通信的策略</strong>。<br/>
实现 AJAX 的核心技术就是 <code>XMLHttpRequest</code>。</p>
</blockquote>
<h3 data-id="heading-2">1.2 XMLHttpRequest（XHR）：浏览器原生 API</h3>
<ul>
<li>
<p><strong>角色</strong>：<strong>实现 AJAX 的底层工具</strong></p>
</li>
<li>
<p><strong>功能</strong>：提供浏览器与服务器进行 HTTP 通信的能力</p>
</li>
<li>
<p><strong>特点</strong>：</p>
<ul>
<li>基于回调（事件驱动）</li>
<li>支持进度监控、取消请求、上传/下载</li>
<li>兼容性极好（IE7+）</li>
</ul>
</li>
</ul>
<blockquote>
<p>📌 <strong>关系</strong>：<br/>
<strong>XHR 是 AJAX 的“引擎”</strong> 。没有 XHR，就没有现代意义上的 AJAX。</p>
</blockquote>
<h3 data-id="heading-3">1.3 Axios：基于 Promise 的 HTTP 客户端库</h3>
<ul>
<li>
<p><strong>定位</strong>：<strong>对 XHR 的封装与增强</strong></p>
</li>
<li>
<p><strong>核心特性</strong>：</p>
<ul>
<li>返回 Promise，支持 async/await</li>
<li>自动转换 JSON 数据</li>
<li>拦截器（请求/响应）</li>
<li>客户端支持 XSRF 防护</li>
<li>浏览器 + Node.js 双端支持</li>
</ul>
</li>
<li>
<p><strong>底层实现</strong>：在浏览器中<strong>默认使用 XHR</strong>，在 Node.js 中使用 <code>http</code> 模块</p>
</li>
</ul>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// Axios 内部简化逻辑</span>
function <span class="hljs-built_in">axios</span>(config) {
  return new <span class="hljs-built_in">Promise</span>((resolve, reject) =&gt; {
    const xhr = new <span class="hljs-built_in">XMLHttpRequest</span>();
    xhr<span class="hljs-selector-class">.open</span>(config.method, config.url);
    xhr<span class="hljs-selector-class">.send</span>(config.data);
    xhr<span class="hljs-selector-class">.onload</span> = () =&gt; <span class="hljs-built_in">resolve</span>(xhr.response);
    xhr<span class="hljs-selector-class">.onerror</span> = () =&gt; <span class="hljs-built_in">reject</span>(xhr.statusText);
  });
}
</code></pre>
<blockquote>
<p>✅ <strong>关系</strong>：<br/>
<strong>Axios 是 XHR 的现代化封装</strong>，让开发者用更简洁的语法享受 XHR 的全部能力。</p>
</blockquote>
<h3 data-id="heading-4">1.4 Fetch API：浏览器新一代原生 API</h3>
<ul>
<li>
<p><strong>定位</strong>：<strong>XHR 的官方继任者</strong></p>
</li>
<li>
<p><strong>设计目标</strong>：</p>
<ul>
<li>基于 Promise，符合现代 JS 编程习惯</li>
<li>更简洁的 API 设计</li>
<li>更好的流（Stream）支持</li>
<li>统一请求/响应模型（Request/Response 对象）</li>
</ul>
</li>
<li>
<p><strong>底层实现</strong>：<strong>并非基于 XHR</strong>，而是直接调用浏览器的网络层（如 Chromium 的 <code>blink::WebURLLoader</code>）</p>
</li>
</ul>
<blockquote>
<p>⚠️ <strong>重要区别</strong>：<br/>
Fetch <strong>不是 XHR 的封装</strong>，而是<strong>全新的底层实现</strong>。</p>
</blockquote>
<hr/>
<h2 data-id="heading-5">二、四者关系图谱</h2>
<pre><code class="hljs language-scss" lang="scss">                          ┌──────────────┐
                          │    AJAX      │ ←── 编程范式（异步通信思想）
                          └──────┬───────┘
                                 │
         ┌───────────────────────┼───────────────────────┐
         │                       │                       │
┌────────▼────────┐   ┌──────────▼──────────┐   ┌────────▼────────┐
│ XMLHttpRequest  │   │       Fetch API     │   │      Axios      │
│ (原生, 回调式)   │   │ (原生, Promise式)   │   │ (第三方库, Promise)│
└────────┬────────┘   └─────────────────────┘   └────────┬────────┘
         │                                               │
         └───────────────────────┬───────────────────────┘
                                 │
                   ┌─────────────▼─────────────┐
                   │   现代 Web 应用数据通信    │
                   └───────────────────────────┘
</code></pre>
<blockquote>
<p>🔑 <strong>总结关系</strong>：</p>
<ul>
<li><strong>AJAX</strong> 是思想，<strong>XHR/Fetch</strong> 是实现该思想的原生工具</li>
<li><strong>Axios</strong> 是对 XHR（浏览器端）的高级封装</li>
<li><strong>Fetch</strong> 是浏览器提供的、与 XHR 并列的新一代原生 API</li>
</ul>
</blockquote>
<hr/>
<h2 data-id="heading-6">三、XMLHttpRequest 详解</h2>
<h3 data-id="heading-7">3.1 基本使用流程</h3>
<pre><code class="hljs language-ini" lang="ini">const <span class="hljs-attr">xhr</span> = new XMLHttpRequest()<span class="hljs-comment">;</span>
xhr.open('GET', '/api/users', true)<span class="hljs-comment">;</span>
xhr.setRequestHeader('Content-Type', 'application/json')<span class="hljs-comment">;</span>
<span class="hljs-attr">xhr.onreadystatechange</span> = function() {
  if (<span class="hljs-attr">xhr.readyState</span> === <span class="hljs-number">4</span> &amp;&amp; xhr.status === <span class="hljs-number">200</span>) {
    console.log(xhr.responseText)<span class="hljs-comment">;</span>
  }
}<span class="hljs-comment">;</span>
xhr.send()<span class="hljs-comment">;</span>
</code></pre>
<h3 data-id="heading-8">3.2 核心属性</h3>





























<table><thead><tr><th>属性</th><th>说明</th></tr></thead><tbody><tr><td><code>readyState</code></td><td>请求状态（0–4）</td></tr><tr><td><code>status</code> / <code>statusText</code></td><td>HTTP 状态码与描述</td></tr><tr><td><code>responseText</code></td><td>字符串响应体</td></tr><tr><td><code>response</code></td><td>根据 <code>responseType</code> 解析后的数据</td></tr><tr><td><code>responseType</code></td><td>响应类型（<code>json</code>、<code>blob</code>、<code>arraybuffer</code> 等）</td></tr></tbody></table>
<h3 data-id="heading-9">3.3 事件模型</h3>
<ul>
<li>
<p><strong>传统方式</strong>：<code>onreadystatechange</code>（需手动判断 <code>readyState</code>）</p>
</li>
<li>
<p><strong>现代方式</strong>（推荐）：</p>
<ul>
<li><code>onload</code>：请求完成</li>
<li><code>onerror</code>：网络错误</li>
<li><code>ontimeout</code>：超时</li>
<li><code>onabort</code>：被中止</li>
</ul>
</li>
</ul>
<h3 data-id="heading-10">3.4 高级功能</h3>
<ul>
<li><strong>超时控制</strong>：<code>xhr.timeout = 5000</code></li>
<li><strong>跨域凭据</strong>：<code>xhr.withCredentials = true</code></li>
<li><strong>上传进度</strong>：<code>xhr.upload.onprogress</code></li>
<li><strong>中止请求</strong>：<code>xhr.abort()</code></li>
</ul>
<h3 data-id="heading-11">3.5 实际应用场景</h3>
<h4 data-id="heading-12">文件上传（带进度）</h4>
<pre><code class="hljs language-ini" lang="ini">function uploadFile(file) {
  const <span class="hljs-attr">formData</span> = new FormData()<span class="hljs-comment">;</span>
  formData.append('file', file)<span class="hljs-comment">;</span>
  
  const <span class="hljs-attr">xhr</span> = new XMLHttpRequest()<span class="hljs-comment">;</span>
  xhr.open('POST', '/upload')<span class="hljs-comment">;</span>
  
  <span class="hljs-attr">xhr.upload.onprogress</span> = (e) =&gt; {
    if (e.lengthComputable) {
      const <span class="hljs-attr">percent</span> = (e.loaded / e.total) * <span class="hljs-number">100</span><span class="hljs-comment">;</span>
      updateProgress(percent)<span class="hljs-comment">;</span>
    }
  }<span class="hljs-comment">;</span>
  
  <span class="hljs-attr">xhr.onload</span> = () =&gt; {
    if (<span class="hljs-attr">xhr.status</span> === <span class="hljs-number">200</span>) showSuccess()<span class="hljs-comment">;</span>
  }<span class="hljs-comment">;</span>
  
  xhr.send(formData)<span class="hljs-comment">;</span>
}
</code></pre>
<hr/>
<h2 data-id="heading-13">四、Fetch API 原理深度解析</h2>
<h3 data-id="heading-14">4.1 核心设计：基于 Stream 的请求/响应模型</h3>
<p>Fetch 的核心是两个构造函数：</p>
<ul>
<li><code>Request</code>：表示 HTTP 请求</li>
<li><code>Response</code>：表示 HTTP 响应</li>
</ul>
<p>两者都实现了 <strong>Body mixin</strong>，包含可读流（ReadableStream）：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-title function_">fetch</span>(<span class="hljs-string">'/api/data'</span>)
  .<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">response</span> =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(response.<span class="hljs-property">body</span> <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">ReadableStream</span>); <span class="hljs-comment">// true</span>
    <span class="hljs-keyword">return</span> response.<span class="hljs-title function_">json</span>(); <span class="hljs-comment">// 内部读取 body 流并解析</span>
  });
</code></pre>
<blockquote>
<p>💡 <strong>关键机制</strong>：<br/>
Fetch 将响应体视为<strong>流（Stream）</strong> ，支持边下载边处理，适合大文件或实时数据。</p>
</blockquote>
<h3 data-id="heading-15">4.2 执行流程（浏览器内部）</h3>
<p>以 Chromium 为例：</p>
<ol>
<li>调用 <code>fetch(url)</code> → 创建 <code>Request</code> 对象</li>
<li>浏览器主线程 → 网络服务线程（Network Service）</li>
<li>网络线程发起 HTTP 请求（复用连接池、DNS 缓存等）</li>
<li>收到响应头 → 立即 resolve Promise（返回 <code>Response</code> 对象）</li>
<li>响应体通过 <strong>ReadableStream</strong> 逐步传输到 JS 主线程</li>
<li>调用 <code>.json()</code> / <code>.text()</code> 等方法 → 消费流并解析</li>
</ol>
<h3 data-id="heading-16">4.3 与 XHR 的关键差异</h3>



































<table><thead><tr><th>特性</th><th>XHR</th><th>Fetch</th></tr></thead><tbody><tr><td><strong>错误处理</strong></td><td>网络错误 → <code>onerror</code>；HTTP 错误（404/500）→ <code>onload</code></td><td><strong>仅网络错误 reject</strong>；HTTP 错误仍 resolve（需手动检查 <code>response.ok</code>）</td></tr><tr><td><strong>Cookie 发送</strong></td><td>同域自动发送</td><td>需显式设置 <code>credentials: 'same-origin'</code></td></tr><tr><td><strong>取消请求</strong></td><td><code>xhr.abort()</code></td><td><code>AbortController</code></td></tr><tr><td><strong>上传进度</strong></td><td>原生 <code>upload.onprogress</code></td><td><strong>不支持</strong>（需自定义 <code>ReadableStream</code>，复杂）</td></tr><tr><td><strong>超时控制</strong></td><td><code>xhr.timeout</code></td><td>需配合 <code>AbortController</code> + <code>setTimeout</code></td></tr></tbody></table>
<h4 data-id="heading-17">错误处理对比示例：</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// Fetch：HTTP 404 仍 resolve</span>
<span class="hljs-title function_">fetch</span>(<span class="hljs-string">'/not-found'</span>)
  .<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">res</span> =&gt;</span> {
    <span class="hljs-keyword">if</span> (!res.<span class="hljs-property">ok</span>) { <span class="hljs-comment">// 必须手动检查</span>
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">`HTTP <span class="hljs-subst">${res.status}</span>`</span>);
    }
  })
  .<span class="hljs-title function_">catch</span>(<span class="hljs-function"><span class="hljs-params">err</span> =&gt;</span> {
    <span class="hljs-comment">// 只有网络断开才会进入这里</span>
  });
</code></pre>
<h3 data-id="heading-18">4.4 Fetch 的局限性与解决方案</h3>
<h4 data-id="heading-19">问题 1：无法监控下载进度</h4>
<p><strong>解决方案</strong>：手动读取流并计算进度：</p>
<pre><code class="hljs language-ini" lang="ini">const <span class="hljs-attr">response</span> = await fetch(<span class="hljs-string">'/large-file'</span>)<span class="hljs-comment">;</span>
const <span class="hljs-attr">contentLength</span> = +response.headers.get(<span class="hljs-string">'Content-Length'</span>)<span class="hljs-comment">;</span>
let <span class="hljs-attr">loaded</span> = <span class="hljs-number">0</span><span class="hljs-comment">;</span>

const <span class="hljs-attr">reader</span> = response.body.getReader()<span class="hljs-comment">;</span>
while (true) {
  const { done, value } = await reader.read()<span class="hljs-comment">;</span>
  if (done) break<span class="hljs-comment">;</span>
  loaded += value.length<span class="hljs-comment">;</span>
  const <span class="hljs-attr">progress</span> = (loaded / contentLength) * <span class="hljs-number">100</span><span class="hljs-comment">;</span>
  updateProgress(progress)<span class="hljs-comment">;</span>
}
</code></pre>
<h4 data-id="heading-20">问题 2：无内置超时</h4>
<p><strong>解决方案</strong>：结合 <code>AbortController</code>：</p>
<pre><code class="hljs language-scss" lang="scss">const controller = new <span class="hljs-built_in">AbortController</span>();
const timeoutId = <span class="hljs-built_in">setTimeout</span>(() =&gt; controller<span class="hljs-selector-class">.abort</span>(), <span class="hljs-number">5000</span>);

<span class="hljs-built_in">fetch</span>('/api/data', { signal: controller.signal })
  <span class="hljs-selector-class">.finally</span>(() =&gt; <span class="hljs-built_in">clearTimeout</span>(timeoutId));
</code></pre>
<hr/>
<h2 data-id="heading-21">五、Vue 3 中的网络通信实践</h2>
<p>虽然 Vue 本身不强制使用特定 HTTP 客户端，但其组合式 API 与现代请求库天然契合。</p>
<h3 data-id="heading-22">5.1 使用 Axios（推荐用于复杂项目）</h3>
<pre><code class="hljs language-ini" lang="ini">// composables/useApi.js
import axios from 'axios'<span class="hljs-comment">;</span>

const <span class="hljs-attr">api</span> = axios.create({
  baseURL: '/api',
  timeout: 10000,
  withCredentials: true
})<span class="hljs-comment">;</span>

// 请求拦截器
api.interceptors.request.use(<span class="hljs-attr">config</span> =&gt; {
  const <span class="hljs-attr">token</span> = localStorage.getItem(<span class="hljs-string">'token'</span>)<span class="hljs-comment">;</span>
  if (token) <span class="hljs-attr">config.headers.Authorization</span> = `Bearer <span class="hljs-variable">${token}</span>`<span class="hljs-comment">;</span>
  return config<span class="hljs-comment">;</span>
})<span class="hljs-comment">;</span>

// 响应拦截器
api.interceptors.response.use(
  <span class="hljs-attr">response</span> =&gt; response.data,
  <span class="hljs-attr">error</span> =&gt; {
    if (error.response?.<span class="hljs-attr">status</span> === <span class="hljs-number">401</span>) {
      // 处理未授权
      router.push('/login')<span class="hljs-comment">;</span>
    }
    return Promise.reject(error)<span class="hljs-comment">;</span>
  }
)<span class="hljs-comment">;</span>

export default api<span class="hljs-comment">;</span>
</code></pre>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- 在组件中使用 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">setup</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">import</span> { ref } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>;
<span class="hljs-keyword">import</span> api <span class="hljs-keyword">from</span> <span class="hljs-string">'@/composables/useApi'</span>;

<span class="hljs-keyword">const</span> users = <span class="hljs-title function_">ref</span>([]);
<span class="hljs-keyword">const</span> loading = <span class="hljs-title function_">ref</span>(<span class="hljs-literal">false</span>);

<span class="hljs-keyword">const</span> <span class="hljs-title function_">fetchUsers</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params"/>) =&gt; {
  loading.<span class="hljs-property">value</span> = <span class="hljs-literal">true</span>;
  <span class="hljs-keyword">try</span> {
    users.<span class="hljs-property">value</span> = <span class="hljs-keyword">await</span> api.<span class="hljs-title function_">get</span>(<span class="hljs-string">'/users'</span>);
  } <span class="hljs-keyword">finally</span> {
    loading.<span class="hljs-property">value</span> = <span class="hljs-literal">false</span>;
  }
};

<span class="hljs-title function_">fetchUsers</span>();
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
<h3 data-id="heading-23">5.2 使用 Fetch（轻量级项目）</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// utils/request.js</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">request</span>(<span class="hljs-params">url, options = {}</span>) {
  <span class="hljs-keyword">const</span> config = {
    <span class="hljs-attr">credentials</span>: <span class="hljs-string">'include'</span>,
    ...options,
    <span class="hljs-attr">headers</span>: {
      <span class="hljs-string">'Content-Type'</span>: <span class="hljs-string">'application/json'</span>,
      ...options.<span class="hljs-property">headers</span>
    }
  };

  <span class="hljs-keyword">const</span> controller = <span class="hljs-keyword">new</span> <span class="hljs-title class_">AbortController</span>();
  <span class="hljs-keyword">const</span> timeoutId = <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> controller.<span class="hljs-title function_">abort</span>(), <span class="hljs-number">10000</span>);
  
  <span class="hljs-keyword">try</span> {
    <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetch</span>(url, {
      ...config,
      <span class="hljs-attr">signal</span>: controller.<span class="hljs-property">signal</span>
    });
    
    <span class="hljs-built_in">clearTimeout</span>(timeoutId);
    
    <span class="hljs-keyword">if</span> (!response.<span class="hljs-property">ok</span>) {
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">`HTTP <span class="hljs-subst">${response.status}</span>`</span>);
    }
    
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">await</span> response.<span class="hljs-title function_">json</span>();
  } <span class="hljs-keyword">catch</span> (error) {
    <span class="hljs-built_in">clearTimeout</span>(timeoutId);
    <span class="hljs-keyword">throw</span> error;
  }
}

<span class="hljs-keyword">export</span> { request };
</code></pre>
<h3 data-id="heading-24">5.3 封装为 Composable（最佳实践）</h3>
<pre><code class="hljs language-ini" lang="ini">// composables/useFetch.js
import { ref } from 'vue'<span class="hljs-comment">;</span>

export function useFetch(url) {
  const <span class="hljs-attr">data</span> = ref(null)<span class="hljs-comment">;</span>
  const <span class="hljs-attr">loading</span> = ref(<span class="hljs-literal">false</span>)<span class="hljs-comment">;</span>
  const <span class="hljs-attr">error</span> = ref(null)<span class="hljs-comment">;</span>

  const <span class="hljs-attr">execute</span> = async () =&gt; {
    <span class="hljs-attr">loading.value</span> = <span class="hljs-literal">true</span><span class="hljs-comment">;</span>
    <span class="hljs-attr">error.value</span> = null<span class="hljs-comment">;</span>
    
    try {
      const <span class="hljs-attr">res</span> = await fetch(url)<span class="hljs-comment">;</span>
      if (!res.ok) throw new Error(res.statusText)<span class="hljs-comment">;</span>
      <span class="hljs-attr">data.value</span> = await res.json()<span class="hljs-comment">;</span>
    } catch (err) {
      <span class="hljs-attr">error.value</span> = err<span class="hljs-comment">;</span>
    } finally {
      <span class="hljs-attr">loading.value</span> = <span class="hljs-literal">false</span><span class="hljs-comment">;</span>
    }
  }<span class="hljs-comment">;</span>

  return { data, loading, error, execute }<span class="hljs-comment">;</span>
}
</code></pre>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">setup</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">import</span> { useFetch } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/composables/useFetch'</span>;

<span class="hljs-keyword">const</span> { <span class="hljs-attr">data</span>: users, loading, execute } = <span class="hljs-title function_">useFetch</span>(<span class="hljs-string">'/api/users'</span>);
<span class="hljs-title function_">execute</span>();
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
<hr/>
<h2 data-id="heading-25">六、如何选择？—— 使用场景建议</h2>








































<table><thead><tr><th>场景</th><th>推荐方案</th><th>理由</th></tr></thead><tbody><tr><td><strong>新项目（现代浏览器）</strong></td><td><code>fetch()</code> + 工具函数封装</td><td>原生支持，无依赖，符合标准</td></tr><tr><td><strong>需要上传/下载进度</strong></td><td><code>XMLHttpRequest</code> 或 Axios</td><td>原生支持 <code>onprogress</code>，简单可靠</td></tr><tr><td><strong>复杂拦截、转换、兼容 Node.js</strong></td><td><code>Axios</code></td><td>功能全面，生态成熟</td></tr><tr><td><strong>维护旧项目（IE11+）</strong></td><td><code>XMLHttpRequest</code> 或 Axios（带 polyfill）</td><td>最大兼容性</td></tr><tr><td><strong>轻量级应用，避免打包体积</strong></td><td><code>fetch()</code></td><td>无需引入第三方库</td></tr><tr><td><strong>Vue 3 项目</strong></td><td><strong>Axios（复杂）</strong> 或 <strong>Fetch + Composable（简单）</strong></td><td>与组合式 API 完美契合</td></tr></tbody></table>
<blockquote>
<p>📌 <strong>现代最佳实践</strong>：</p>
<ul>
<li>优先使用 <code>fetch()</code> 或 Axios</li>
<li>将网络逻辑封装为 Composable，实现逻辑复用</li>
<li>避免直接使用裸 XHR（除非特殊需求）</li>
</ul>
</blockquote>
<hr/>
<h2 data-id="heading-26">七、安全与性能注意事项</h2>
<h3 data-id="heading-27">7.1 安全</h3>
<ul>
<li><strong>XSS 防护</strong>：永远不要将响应直接插入 <code>innerHTML</code></li>
<li><strong>CSRF 防护</strong>：使用 anti-CSRF token，重要操作用非 GET 方法</li>
<li><strong>CORS 策略</strong>：服务器严格限制 <code>Access-Control-Allow-Origin</code></li>
<li><strong>敏感数据</strong>：使用 HTTPS，避免客户端存储密码/token</li>
</ul>
<h3 data-id="heading-28">7.2 性能</h3>
<ul>
<li><strong>缓存策略</strong>：合理设置 <code>Cache-Control</code> 头</li>
<li><strong>请求合并</strong>：避免频繁小请求</li>
<li><strong>懒加载</strong>：非关键数据延迟请求</li>
<li><strong>取消冗余请求</strong>：组件销毁时中止未完成的请求</li>
</ul>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// Vue 3 中取消请求</span>
<span class="hljs-keyword">import</span> { onUnmounted } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">useFetch</span>(<span class="hljs-params">url</span>) {
  <span class="hljs-keyword">const</span> controller = <span class="hljs-keyword">new</span> <span class="hljs-title class_">AbortController</span>();
  
  <span class="hljs-title function_">onUnmounted</span>(<span class="hljs-function">() =&gt;</span> {
    controller.<span class="hljs-title function_">abort</span>(); <span class="hljs-comment">// 组件卸载时取消请求</span>
  });
  
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">execute</span> = (<span class="hljs-params"/>) =&gt; {
    <span class="hljs-keyword">return</span> <span class="hljs-title function_">fetch</span>(url, { <span class="hljs-attr">signal</span>: controller.<span class="hljs-property">signal</span> });
  };
  
  <span class="hljs-keyword">return</span> { execute };
}
</code></pre>
<hr/>
<h2 data-id="heading-29">结语</h2>
<p>理解 XHR、AJAX、Axios 与 Fetch 的关系，本质上是理解 Web 异步通信技术的演进史：</p>
<ul>
<li><strong>AJAX</strong> 提出了“异步更新”的思想</li>
<li><strong>XHR</strong> 提供了首个标准化实现</li>
<li><strong>Axios</strong> 在 XHR 基础上构建了开发者友好的抽象</li>
<li><strong>Fetch</strong> 则代表了浏览器厂商对下一代网络 API 的重新设计</li>
</ul>
<p>作为开发者，我们不必拘泥于某一种工具，而应根据项目需求、浏览器支持和功能复杂度做出合理选择。但无论使用哪种方式，其背后的核心原理——<strong>HTTP 协议、CORS 安全模型、异步编程范式</strong>——始终不变。</p>
<p>在 Vue 3 的组合式 API 时代，将网络逻辑封装为可复用的 Composable，不仅能提升代码可维护性，更能充分发挥现代 JavaScript 的表达力。掌握这些底层逻辑，才能在技术变迁中游刃有余，构建出高性能、高安全性的现代 Web 应用。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[脚手架开发工具——判断文件是否存在 path-exists]]></title>    <link>https://juejin.cn/post/7585400495684124714</link>    <guid>https://juejin.cn/post/7585400495684124714</guid>    <pubDate>2025-12-20T08:23:02.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585400495684124714" data-draft-id="7585474459776286756" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="脚手架开发工具——判断文件是否存在  path-exists"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-12-20T08:23:02.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="code_YuJun"/> <meta itemprop="url" content="https://juejin.cn/user/3615612462441358"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            脚手架开发工具——判断文件是否存在  path-exists
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3615612462441358/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    code_YuJun
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-20T08:23:02.000Z" title="Sat Dec 20 2025 08:23:02 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">简介</h2>
<p><code>path-exists</code> 是一个轻量级的 Node.js npm 包，其<strong>核心作用是简便、高效地检查文件系统中指定的路径（文件或目录）是否存在</strong>，无需开发者手动封装原生文件操作的回调逻辑或错误处理，简化了 Node.js 中的路径存在性校验场景。</p>
<h3 data-id="heading-1">核心用法</h3>
<pre><code class="hljs language-lua" lang="lua">npm install <span class="hljs-built_in">path</span>-exists <span class="hljs-comment">--save</span>
</code></pre>
<ul>
<li>异步用法（推荐，非阻塞 I/O）</li>
</ul>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> pathExists = <span class="hljs-built_in">require</span>(<span class="hljs-string">'path-exists'</span>);

<span class="hljs-comment">// 异步检查文件路径是否存在</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">checkFilePath</span>(<span class="hljs-params"/>) {
  <span class="hljs-comment">// 传入要检查的文件/目录路径（相对路径或绝对路径均可）</span>
  <span class="hljs-keyword">const</span> isExist = <span class="hljs-keyword">await</span> <span class="hljs-title function_">pathExists</span>(<span class="hljs-string">'./test.txt'</span>);
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'文件是否存在：'</span>, isExist); <span class="hljs-comment">// 返回 true 或 false</span>
}

<span class="hljs-title function_">checkFilePath</span>();

<span class="hljs-comment">// 也可使用 Promise 链式调用（兼容旧版语法）</span>
<span class="hljs-title function_">pathExists</span>(<span class="hljs-string">'./dist/'</span>).<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">exists</span>) =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'目录是否存在：'</span>, exists);
});
</code></pre>
<ul>
<li>同步用法（适用于简单脚本，阻塞 I/O）</li>
</ul>
<pre><code class="hljs language-ini" lang="ini">const <span class="hljs-attr">pathExists</span> = require(<span class="hljs-string">'path-exists'</span>)<span class="hljs-comment">;</span>

// 同步检查目录路径是否存在
const <span class="hljs-attr">dirExists</span> = pathExists.sync(<span class="hljs-string">'./node_modules/'</span>)<span class="hljs-comment">;</span>
console.log('node_modules 目录是否存在：', dirExists)<span class="hljs-comment">; // 返回 true 或 false</span>
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[linux搭建hadoop服务]]></title>    <link>https://juejin.cn/post/7585474459776385060</link>    <guid>https://juejin.cn/post/7585474459776385060</guid>    <pubDate>2025-12-20T08:27:37.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585474459776385060" data-draft-id="7585474459776172068" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="linux搭建hadoop服务"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-12-20T08:27:37.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="苏三的开发日记"/> <meta itemprop="url" content="https://juejin.cn/user/4248949048749213"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            linux搭建hadoop服务
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4248949048749213/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    苏三的开发日记
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-20T08:27:37.000Z" title="Sat Dec 20 2025 08:27:37 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">1.创建xsync与jpsall</h2>
<p>mkdir -p /home/atguigu/bin</p>
<p>vim xsync</p>
<pre><code class="hljs language-js" lang="js">#!<span class="hljs-regexp">/bin/</span>bash

# <span class="hljs-number">1.</span> 判断参数个数
<span class="hljs-keyword">if</span> [ $# -lt <span class="hljs-number">1</span> ]; then
    echo <span class="hljs-string">"Not Enough Arguement!"</span>
    exit <span class="hljs-number">1</span>
fi

# <span class="hljs-number">2.</span> 遍历集群所有机器
<span class="hljs-keyword">for</span> host <span class="hljs-keyword">in</span> hadoop102 hadoop103 hadoop104; <span class="hljs-keyword">do</span>
    echo <span class="hljs-string">"==================== $host ===================="</span>

    # <span class="hljs-number">3.</span> 遍历所有目录，挨个发送
    <span class="hljs-keyword">for</span> file <span class="hljs-keyword">in</span> <span class="hljs-string">"$@"</span>; <span class="hljs-keyword">do</span>
        # <span class="hljs-number">4.</span> 判断文件是否存在
        <span class="hljs-keyword">if</span> [ -e <span class="hljs-string">"$file"</span> ]; then
            # <span class="hljs-number">5.</span> 获取父目录
            pdir=$(cd -P <span class="hljs-string">"$(dirname "</span>$file<span class="hljs-string">")"</span>; pwd)
            # <span class="hljs-number">6.</span> 获取当前文件的名称
            fname=$(basename <span class="hljs-string">"$file"</span>)

            ssh <span class="hljs-string">"$host"</span> <span class="hljs-string">"mkdir -p $pdir"</span>
            rsync -av <span class="hljs-string">"$pdir/$fname"</span> <span class="hljs-string">"$host:$pdir"</span>
        <span class="hljs-keyword">else</span>
            echo <span class="hljs-string">"$file does not exist!"</span>
        fi
    done
done
</code></pre>
<p>vim jpsall</p>
<pre><code class="hljs language-js" lang="js">#!<span class="hljs-regexp">/bin/</span>bash

<span class="hljs-keyword">for</span> host <span class="hljs-keyword">in</span> hadoop102 hadoop103 hadoop104

<span class="hljs-keyword">do</span>

echo =============== $host ===============

ssh $host jps

done
</code></pre>
<h2 data-id="heading-1">2.编辑/etc/profile.d/my_env.sh</h2>
<pre><code class="hljs language-js" lang="js">#<span class="hljs-variable constant_">JAVA_HOME</span>
<span class="hljs-keyword">export</span> <span class="hljs-variable constant_">JAVA_HOME</span>=<span class="hljs-regexp">/opt/m</span>odule/jdk1<span class="hljs-number">.8</span><span class="hljs-number">.0_212</span>
<span class="hljs-keyword">export</span> <span class="hljs-variable constant_">PATH</span>=<span class="hljs-attr">$PATH</span>:$JAVA_HOME/bin
#<span class="hljs-variable constant_">HADOOP_HOME</span>
<span class="hljs-keyword">export</span> <span class="hljs-variable constant_">HADOOP_HOME</span>=<span class="hljs-regexp">/opt/m</span>odule/hadoop-<span class="hljs-number">3.1</span><span class="hljs-number">.3</span>
<span class="hljs-keyword">export</span> <span class="hljs-variable constant_">PATH</span>=<span class="hljs-attr">$PATH</span>:$HADOOP_HOME/bin
<span class="hljs-keyword">export</span> <span class="hljs-variable constant_">PATH</span>=<span class="hljs-attr">$PATH</span>:$HADOOP_HOME/sbin
#<span class="hljs-variable constant_">KAFKA_HOME</span>
<span class="hljs-keyword">export</span> <span class="hljs-variable constant_">KAFKA_HOME</span>=<span class="hljs-regexp">/opt/m</span>odule/kafka
<span class="hljs-keyword">export</span> <span class="hljs-variable constant_">PATH</span>=<span class="hljs-attr">$PATH</span>:$KAFKA_HOME/bin

source /etc/profile.<span class="hljs-property">d</span>/my_env.<span class="hljs-property">sh</span>
</code></pre>
<h2 data-id="heading-2">3.修改文件组</h2>
<pre><code class="hljs language-js" lang="js">在 hadoop102、hadoop103、hadoop104 都已经创建好的/opt/<span class="hljs-variable language_">module</span> 并且已经把这个目录修改为 <span class="hljs-attr">atguigu</span>:atguigu

<span class="hljs-number">102</span>服务器: sudo chown <span class="hljs-attr">atguigu</span>:atguigu -R /opt/<span class="hljs-variable language_">module</span>

scp -r /opt/<span class="hljs-variable language_">module</span>/jdk1<span class="hljs-number">.8</span><span class="hljs-number">.0_212</span> atguigu@<span class="hljs-attr">hadoop103</span>:<span class="hljs-regexp">/opt/m</span>odule

scp -r /opt/<span class="hljs-variable language_">module</span>/jdk1<span class="hljs-number">.8</span><span class="hljs-number">.0_212</span> atguigu@<span class="hljs-attr">hadoop104</span>:<span class="hljs-regexp">/opt/m</span>odule
</code></pre>
<h2 data-id="heading-3">4.修改hadoop相关配置文件</h2>
<p>cd $HADOOP_HOME/etc/hadoop</p>
<p>编辑 core-site.xml</p>
<pre><code class="hljs language-js" lang="js">&lt;?xml version=<span class="hljs-string">"1.0"</span> encoding=<span class="hljs-string">"UTF-8"</span>?&gt;
&lt;?xml-stylesheet type=<span class="hljs-string">"text/xsl"</span> href=<span class="hljs-string">"configuration.xsl"</span>?&gt;
<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">configuration</span>&gt;</span>
 <span class="hljs-comment">&lt;!-- 指定 NameNode 的地址 --&gt;</span>
 <span class="hljs-tag">&lt;<span class="hljs-name">property</span>&gt;</span>
 <span class="hljs-tag">&lt;<span class="hljs-name">name</span>&gt;</span>fs.defaultFS<span class="hljs-tag">&lt;/<span class="hljs-name">name</span>&gt;</span>
 <span class="hljs-tag">&lt;<span class="hljs-name">value</span>&gt;</span>hdfs://hadoop102:8020<span class="hljs-tag">&lt;/<span class="hljs-name">value</span>&gt;</span>
 <span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
 <span class="hljs-comment">&lt;!-- 指定 hadoop 数据的存储目录 --&gt;</span>
 <span class="hljs-tag">&lt;<span class="hljs-name">property</span>&gt;</span>
 <span class="hljs-tag">&lt;<span class="hljs-name">name</span>&gt;</span>hadoop.tmp.dir<span class="hljs-tag">&lt;/<span class="hljs-name">name</span>&gt;</span>
 <span class="hljs-tag">&lt;<span class="hljs-name">value</span>&gt;</span>/opt/module/hadoop-3.1.3/data<span class="hljs-tag">&lt;/<span class="hljs-name">value</span>&gt;</span>
 <span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
 <span class="hljs-comment">&lt;!-- 配置 HDFS 网页登录使用的静态用户为 atguigu --&gt;</span>
 <span class="hljs-tag">&lt;<span class="hljs-name">property</span>&gt;</span>
 <span class="hljs-tag">&lt;<span class="hljs-name">name</span>&gt;</span>hadoop.http.staticuser.user<span class="hljs-tag">&lt;/<span class="hljs-name">name</span>&gt;</span>
 <span class="hljs-tag">&lt;<span class="hljs-name">value</span>&gt;</span>atguigu<span class="hljs-tag">&lt;/<span class="hljs-name">value</span>&gt;</span>
 <span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">configuration</span>&gt;</span></span>
</code></pre>
<p>编辑 hdfs-site.xml</p>
<pre><code class="hljs language-js" lang="js">&lt;?xml version=<span class="hljs-string">"1.0"</span> encoding=<span class="hljs-string">"UTF-8"</span>?&gt;
&lt;?xml-stylesheet type=<span class="hljs-string">"text/xsl"</span> href=<span class="hljs-string">"configuration.xsl"</span>?&gt;
<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">configuration</span>&gt;</span>
<span class="hljs-comment">&lt;!-- nn web 端访问地址--&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">property</span>&gt;</span>
 <span class="hljs-tag">&lt;<span class="hljs-name">name</span>&gt;</span>dfs.namenode.http-address<span class="hljs-tag">&lt;/<span class="hljs-name">name</span>&gt;</span>
 <span class="hljs-tag">&lt;<span class="hljs-name">value</span>&gt;</span>hadoop102:9870<span class="hljs-tag">&lt;/<span class="hljs-name">value</span>&gt;</span>
 <span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
<span class="hljs-comment">&lt;!-- 2nn web 端访问地址--&gt;</span>
 <span class="hljs-tag">&lt;<span class="hljs-name">property</span>&gt;</span>
 <span class="hljs-tag">&lt;<span class="hljs-name">name</span>&gt;</span>dfs.namenode.secondary.http-address<span class="hljs-tag">&lt;/<span class="hljs-name">name</span>&gt;</span>
 <span class="hljs-tag">&lt;<span class="hljs-name">value</span>&gt;</span>hadoop104:9868<span class="hljs-tag">&lt;/<span class="hljs-name">value</span>&gt;</span>
 <span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">configuration</span>&gt;</span></span>
</code></pre>
<p>编辑 yarn-site.xml</p>
<pre><code class="hljs language-js" lang="js">&lt;?xml version=<span class="hljs-string">"1.0"</span> encoding=<span class="hljs-string">"UTF-8"</span>?&gt;
&lt;?xml-stylesheet type=<span class="hljs-string">"text/xsl"</span> href=<span class="hljs-string">"configuration.xsl"</span>?&gt;
<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">configuration</span>&gt;</span>
 <span class="hljs-comment">&lt;!-- 指定 MR 走 shuffle --&gt;</span>
 <span class="hljs-tag">&lt;<span class="hljs-name">property</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">name</span>&gt;</span>yarn.nodemanager.aux-services<span class="hljs-tag">&lt;/<span class="hljs-name">name</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">value</span>&gt;</span>mapreduce_shuffle<span class="hljs-tag">&lt;/<span class="hljs-name">value</span>&gt;</span>
 <span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
 <span class="hljs-comment">&lt;!-- 指定 ResourceManager 的地址--&gt;</span>
 <span class="hljs-tag">&lt;<span class="hljs-name">property</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">name</span>&gt;</span>yarn.resourcemanager.hostname<span class="hljs-tag">&lt;/<span class="hljs-name">name</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">value</span>&gt;</span>hadoop103<span class="hljs-tag">&lt;/<span class="hljs-name">value</span>&gt;</span>
 <span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
 <span class="hljs-comment">&lt;!-- 环境变量的继承 --&gt;</span>
 <span class="hljs-tag">&lt;<span class="hljs-name">property</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">name</span>&gt;</span>yarn.nodemanager.env-whitelist<span class="hljs-tag">&lt;/<span class="hljs-name">name</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">value</span>&gt;</span>JAVA_HOME,HADOOP_COMMON_HOME,HADOOP_HDFS_HOME,HADOOP_CONF_DIR,CLASSPATH_PREPEND_DISTCACHE,HADOOP_YARN_HOME,HADOOP_MAPRED_HOME<span class="hljs-tag">&lt;/<span class="hljs-name">value</span>&gt;</span>
 <span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
 <span class="hljs-comment">&lt;!-- 开启日志聚集功能 --&gt;</span>
 <span class="hljs-tag">&lt;<span class="hljs-name">property</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">name</span>&gt;</span>yarn.log-aggregation-enable<span class="hljs-tag">&lt;/<span class="hljs-name">name</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">value</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">value</span>&gt;</span>
 <span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
 <span class="hljs-comment">&lt;!-- 设置日志聚集服务器地址 --&gt;</span>
 <span class="hljs-tag">&lt;<span class="hljs-name">property</span>&gt;</span> 
  <span class="hljs-tag">&lt;<span class="hljs-name">name</span>&gt;</span>yarn.log.server.url<span class="hljs-tag">&lt;/<span class="hljs-name">name</span>&gt;</span> 
  <span class="hljs-tag">&lt;<span class="hljs-name">value</span>&gt;</span>http://hadoop102:19888/jobhistory/logs<span class="hljs-tag">&lt;/<span class="hljs-name">value</span>&gt;</span>
 <span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
 <span class="hljs-comment">&lt;!-- 设置日志保留时间为 7 天 --&gt;</span>
 <span class="hljs-tag">&lt;<span class="hljs-name">property</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">name</span>&gt;</span>yarn.log-aggregation.retain-seconds<span class="hljs-tag">&lt;/<span class="hljs-name">name</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">value</span>&gt;</span>604800<span class="hljs-tag">&lt;/<span class="hljs-name">value</span>&gt;</span>
 <span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
 <span class="hljs-comment">&lt;!--是否启动一个线程检查每个任务正使用的物理内存量，如果任务超出分配值，则直接将其杀掉，默认是true --&gt;</span>
 <span class="hljs-tag">&lt;<span class="hljs-name">property</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">name</span>&gt;</span>yarn.nodemanager.pmem-check-enabled<span class="hljs-tag">&lt;/<span class="hljs-name">name</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">value</span>&gt;</span>false<span class="hljs-tag">&lt;/<span class="hljs-name">value</span>&gt;</span>
 <span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
 <span class="hljs-comment">&lt;!--是否启动一个线程检查每个任务正使用的虚拟内存量，如果任务超出分配值，则直接将其杀掉，默认是true --&gt;</span>
 <span class="hljs-tag">&lt;<span class="hljs-name">property</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">name</span>&gt;</span>yarn.nodemanager.vmem-check-enabled<span class="hljs-tag">&lt;/<span class="hljs-name">name</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">value</span>&gt;</span>false<span class="hljs-tag">&lt;/<span class="hljs-name">value</span>&gt;</span>
 <span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>    
 <span class="hljs-tag">&lt;<span class="hljs-name">property</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">name</span>&gt;</span>yarn.log.server.url<span class="hljs-tag">&lt;/<span class="hljs-name">name</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">value</span>&gt;</span>http://hadoop102:19888/jobhistory/logs<span class="hljs-tag">&lt;/<span class="hljs-name">value</span>&gt;</span>
 <span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">configuration</span>&gt;</span></span>
</code></pre>
<p>编辑 mapred-site.xml</p>
<pre><code class="hljs language-js" lang="js">&lt;?xml version=<span class="hljs-string">"1.0"</span> encoding=<span class="hljs-string">"UTF-8"</span>?&gt;
&lt;?xml-stylesheet type=<span class="hljs-string">"text/xsl"</span> href=<span class="hljs-string">"configuration.xsl"</span>?&gt;
<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">configuration</span>&gt;</span>
<span class="hljs-comment">&lt;!-- 指定 MapReduce 程序运行在 Yarn 上 --&gt;</span>
 <span class="hljs-tag">&lt;<span class="hljs-name">property</span>&gt;</span>
 <span class="hljs-tag">&lt;<span class="hljs-name">name</span>&gt;</span>mapreduce.framework.name<span class="hljs-tag">&lt;/<span class="hljs-name">name</span>&gt;</span>
 <span class="hljs-tag">&lt;<span class="hljs-name">value</span>&gt;</span>yarn<span class="hljs-tag">&lt;/<span class="hljs-name">value</span>&gt;</span>
 <span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
 <span class="hljs-comment">&lt;!-- 历史服务器端地址 --&gt;</span>
 <span class="hljs-tag">&lt;<span class="hljs-name">property</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">name</span>&gt;</span>mapreduce.jobhistory.address<span class="hljs-tag">&lt;/<span class="hljs-name">name</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">value</span>&gt;</span>hadoop102:10020<span class="hljs-tag">&lt;/<span class="hljs-name">value</span>&gt;</span>
 <span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
 <span class="hljs-comment">&lt;!-- 历史服务器 web 端地址 --&gt;</span>
 <span class="hljs-tag">&lt;<span class="hljs-name">property</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">name</span>&gt;</span>mapreduce.jobhistory.webapp.address<span class="hljs-tag">&lt;/<span class="hljs-name">name</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">value</span>&gt;</span>hadoop102:19888<span class="hljs-tag">&lt;/<span class="hljs-name">value</span>&gt;</span>
 <span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">configuration</span>&gt;</span></span>
</code></pre>
<p>xsync同步文件</p>
<pre><code class="hljs language-js" lang="js">xsync /opt/<span class="hljs-variable language_">module</span>/hadoop-<span class="hljs-number">3.1</span><span class="hljs-number">.3</span>/etc/hadoop/
</code></pre>
<p>编辑 workers添加内容</p>
<pre><code class="hljs language-js" lang="js">hadoop102
hadoop103
hadoop104

注意：该文件中添加的内容结尾不允许有空格，文件中不允许有空行
</code></pre>
<h2 data-id="heading-4">5.编写hadoop集群管理脚本</h2>
<pre><code class="hljs language-js" lang="js">#!<span class="hljs-regexp">/bin/</span>bash

<span class="hljs-keyword">if</span> [ $# -lt <span class="hljs-number">1</span> ]; then
    echo <span class="hljs-string">"No Args Input..."</span>
    exit
fi

<span class="hljs-keyword">case</span> $1 <span class="hljs-keyword">in</span>
    <span class="hljs-string">"start"</span>)
        echo <span class="hljs-string">" =================== 启动 hadoop 集群 ==================="</span>
        echo <span class="hljs-string">" --------------- 启动 hdfs ---------------"</span>
        ssh hadoop102 <span class="hljs-string">"/opt/module/hadoop-3.1.3/sbin/start-dfs.sh"</span>
        echo <span class="hljs-string">" --------------- 启动 yarn ---------------"</span>
        ssh hadoop103 <span class="hljs-string">"/opt/module/hadoop-3.1.3/sbin/start-yarn.sh"</span>
        echo <span class="hljs-string">" --------------- 启动 historyserver ---------------"</span>
        ssh hadoop102 <span class="hljs-string">"/opt/module/hadoop-3.1.3/bin/mapred --daemon start historyserver"</span>
        ;;
    <span class="hljs-string">"stop"</span>)
        echo <span class="hljs-string">" =================== 关闭 hadoop 集群 ==================="</span>
        echo <span class="hljs-string">" --------------- 关闭 historyserver ---------------"</span>
        ssh hadoop102 <span class="hljs-string">"/opt/module/hadoop-3.1.3/bin/mapred --daemon stop historyserver"</span>
        echo <span class="hljs-string">" --------------- 关闭 yarn ---------------"</span>
        ssh hadoop103 <span class="hljs-string">"/opt/module/hadoop-3.1.3/sbin/stop-yarn.sh"</span>
        echo <span class="hljs-string">" --------------- 关闭 hdfs ---------------"</span>
        ssh hadoop102 <span class="hljs-string">"/opt/module/hadoop-3.1.3/sbin/stop-dfs.sh"</span>
        ;;
    *)
        echo <span class="hljs-string">"Input Args Error..."</span>
        ;;
esac
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Promise ：从基础原理到高级实践]]></title>    <link>https://juejin.cn/post/7585686247269515273</link>    <guid>https://juejin.cn/post/7585686247269515273</guid>    <pubDate>2025-12-20T08:35:42.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585686247269515273" data-draft-id="7585463195201388594" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Promise ：从基础原理到高级实践"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-12-20T08:35:42.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="用户5427784851540"/> <meta itemprop="url" content="https://juejin.cn/user/224762173330942"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Promise ：从基础原理到高级实践
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/224762173330942/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    用户5427784851540
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-20T08:35:42.000Z" title="Sat Dec 20 2025 08:35:42 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><code>Promise</code> 是 JavaScript 中处理异步操作的核心机制，它解决了传统回调函数（Callback）带来的“回调地狱”（Callback Hell）问题，使异步代码更清晰、可读、可维护。自 ES6（ECMAScript 2015）正式引入以来，Promise 已成为现代前端开发的基石，并为 <code>async/await</code> 语法提供了底层支持。</p>
<hr/>
<h2 data-id="heading-0">一、为什么需要 Promise？</h2>
<h3 data-id="heading-1">1.1 回调函数的局限性</h3>
<p>在 Promise 出现之前，异步操作主要通过回调函数实现：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 嵌套回调（回调地狱）</span>
<span class="hljs-title function_">getData</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params">a</span>) {
  <span class="hljs-title function_">getMoreData</span>(a, <span class="hljs-keyword">function</span>(<span class="hljs-params">b</span>) {
    <span class="hljs-title function_">getEvenMoreData</span>(b, <span class="hljs-keyword">function</span>(<span class="hljs-params">c</span>) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(c);
    });
  });
});
</code></pre>
<p><strong>问题</strong>：</p>
<ul>
<li>代码横向扩展，难以阅读和维护</li>
<li>错误处理分散，需在每个回调中重复写 <code>try/catch</code></li>
<li>无法使用 <code>return</code> 或 <code>throw</code> 控制流程</li>
<li>多个异步操作的组合（如并行、竞态）实现复杂</li>
</ul>
<h3 data-id="heading-2">1.2 Promise 的优势</h3>
<ul>
<li><strong>链式调用</strong>：通过 <code>.then()</code> 实现线性流程</li>
<li><strong>统一错误处理</strong>：通过 <code>.catch()</code> 捕获整个链中的错误</li>
<li><strong>组合能力</strong>：支持 <code>Promise.all</code>、<code>Promise.race</code> 等高级模式</li>
<li><strong>与 async/await 无缝集成</strong></li>
</ul>
<hr/>
<h2 data-id="heading-3">二、Promise 基础概念</h2>
<h3 data-id="heading-4">2.1 什么是 Promise？</h3>
<blockquote>
<p><strong>Promise 是一个表示异步操作最终完成或失败的对象。</strong></p>
</blockquote>
<p>它有三种状态（State）：</p>
<ul>
<li><strong>pending（待定）</strong> ：初始状态，既不是成功也不是失败</li>
<li><strong>fulfilled（已成功）</strong> ：操作成功完成</li>
<li><strong>rejected（已失败）</strong> ：操作失败</li>
</ul>
<blockquote>
<p>⚠️ <strong>状态不可逆</strong>：<br/>
一旦 Promise 从 <code>pending</code> 变为 <code>fulfilled</code> 或 <code>rejected</code>，状态将<strong>永久固定</strong>，不能再改变。</p>
</blockquote>
<h3 data-id="heading-5">2.2 创建 Promise</h3>
<p>使用 <code>new Promise(executor)</code> 构造函数：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> promise = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> {
  <span class="hljs-comment">// 异步操作</span>
  <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">const</span> success = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() &gt; <span class="hljs-number">0.5</span>;
    <span class="hljs-keyword">if</span> (success) {
      <span class="hljs-title function_">resolve</span>(<span class="hljs-string">'操作成功！'</span>); <span class="hljs-comment">// 将状态变为 fulfilled</span>
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-title function_">reject</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">'操作失败！'</span>)); <span class="hljs-comment">// 将状态变为 rejected</span>
    }
  }, <span class="hljs-number">1000</span>);
});
</code></pre>
<ul>
<li><code>resolve(value)</code>：标记 Promise 成功，传递结果值</li>
<li><code>reject(reason)</code>：标记 Promise 失败，传递错误原因（通常为 Error 对象）</li>
</ul>
<hr/>
<h2 data-id="heading-6">三、Promise 的基本用法</h2>
<h3 data-id="heading-7">3.1 链式调用（Chaining）</h3>
<p>通过 <code>.then(onFulfilled, onRejected)</code> 处理结果：</p>
<pre><code class="hljs language-javascript" lang="javascript">promise
  .<span class="hljs-title function_">then</span>(
    <span class="hljs-function"><span class="hljs-params">result</span> =&gt;</span> {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'成功:'</span>, result); <span class="hljs-comment">// '操作成功！'</span>
      <span class="hljs-keyword">return</span> result.<span class="hljs-title function_">toUpperCase</span>(); <span class="hljs-comment">// 返回新值，传递给下一个 then</span>
    },
    <span class="hljs-function"><span class="hljs-params">error</span> =&gt;</span> {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'失败:'</span>, error); <span class="hljs-comment">// 不会执行（除非上一步 reject）</span>
    }
  )
  .<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">transformedResult</span> =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'转换后:'</span>, transformedResult); <span class="hljs-comment">// '操作成功！'</span>
  })
  .<span class="hljs-title function_">catch</span>(<span class="hljs-function"><span class="hljs-params">error</span> =&gt;</span> {
    <span class="hljs-comment">// 捕获链中任何未处理的 reject</span>
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'捕获错误:'</span>, error);
  });
</code></pre>
<blockquote>
<p>✅ <strong>关键规则</strong>：</p>
<ul>
<li><code>.then()</code> 总是返回一个新的 Promise</li>
<li>若 <code>onFulfilled</code> 返回普通值 → 新 Promise 状态为 <code>fulfilled</code></li>
<li>若 <code>onFulfilled</code> 抛出异常 → 新 Promise 状态为 <code>rejected</code></li>
<li>若 <code>onFulfilled</code> 返回另一个 Promise → 新 Promise 跟随该 Promise 的状态</li>
</ul>
</blockquote>
<h3 data-id="heading-8">3.2 错误处理：<code>.catch()</code></h3>
<p><code>.catch(onRejected)</code> 是 <code>.then(null, onRejected)</code> 的语法糖：</p>
<pre><code class="hljs language-ini" lang="ini">fetchUserData()
  .then(<span class="hljs-attr">user</span> =&gt; processUser(user))
  .then(<span class="hljs-attr">data</span> =&gt; saveToCache(data))
  .catch(<span class="hljs-attr">error</span> =&gt; {
    // 捕获 fetchUserData、processUser 或 saveToCache 中的任何错误
    console.error('操作失败:', error.message)<span class="hljs-comment">;</span>
    showErrorMessage()<span class="hljs-comment">;</span>
  })<span class="hljs-comment">;</span>
</code></pre>
<blockquote>
<p>📌 <strong>最佳实践</strong>：<br/>
在链的末尾使用 <code>.catch()</code> 统一处理错误，避免在每个 <code>.then()</code> 中写错误回调。</p>
</blockquote>
<hr/>
<h2 data-id="heading-9">四、Promise 的高级特性</h2>
<h3 data-id="heading-10">4.1 静态方法</h3>
<h4 data-id="heading-11"><code>Promise.resolve(value)</code></h4>
<p>将值转为已成功的 Promise：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">resolve</span>(<span class="hljs-number">42</span>).<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">v</span> =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(v)); <span class="hljs-comment">// 42</span>
<span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">resolve</span>(<span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">resolve</span>(<span class="hljs-string">'hello'</span>)).<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">v</span> =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(v)); <span class="hljs-comment">// 'hello'</span>
</code></pre>
<h4 data-id="heading-12"><code>Promise.reject(reason)</code></h4>
<p>创建一个已失败的 Promise：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">reject</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">'Oops!'</span>)).<span class="hljs-title function_">catch</span>(<span class="hljs-function"><span class="hljs-params">e</span> =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(e.<span class="hljs-property">message</span>));
</code></pre>
<h4 data-id="heading-13"><code>Promise.all(iterable)</code></h4>
<p><strong>并行执行多个 Promise，全部成功才成功</strong>：</p>
<pre><code class="hljs language-ini" lang="ini">const <span class="hljs-attr">promises</span> = [
  fetch(<span class="hljs-string">'/api/users'</span>),
  fetch(<span class="hljs-string">'/api/posts'</span>),
  fetch(<span class="hljs-string">'/api/comments'</span>)
]<span class="hljs-comment">;</span>

Promise.all(promises)
  .then(<span class="hljs-attr">results</span> =&gt; {
    const <span class="hljs-section">[users, posts, comments]</span> = results<span class="hljs-comment">;</span>
    renderPage(users, posts, comments)<span class="hljs-comment">;</span>
  })
  .catch(<span class="hljs-attr">error</span> =&gt; {
    // 任一请求失败，立即 reject
    console.error('加载失败:', error)<span class="hljs-comment">;</span>
  })<span class="hljs-comment">;</span>
</code></pre>
<blockquote>
<p>⚠️ <strong>注意</strong>：若任一 Promise reject，<code>all</code> 立即 reject，其余 Promise 仍会执行但结果被忽略。</p>
</blockquote>
<h4 data-id="heading-14"><code>Promise.allSettled(iterable)</code></h4>
<p>等待所有 Promise 完成（无论成功或失败）：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">allSettled</span>(promises)
  .<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">results</span> =&gt;</span> {
    results.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">result, i</span>) =&gt;</span> {
      <span class="hljs-keyword">if</span> (result.<span class="hljs-property">status</span> === <span class="hljs-string">'fulfilled'</span>) {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`请求 <span class="hljs-subst">${i}</span> 成功:`</span>, result.<span class="hljs-property">value</span>);
      } <span class="hljs-keyword">else</span> {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`请求 <span class="hljs-subst">${i}</span> 失败:`</span>, result.<span class="hljs-property">reason</span>);
      }
    });
  });
</code></pre>
<h4 data-id="heading-15"><code>Promise.race(iterable)</code></h4>
<p><strong>返回第一个完成的 Promise（无论成功或失败）</strong> ：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">const</span> timeout = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">_, reject</span>) =&gt;</span>
  <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">reject</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">'超时'</span>)), <span class="hljs-number">5000</span>)
);

<span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">race</span>([<span class="hljs-title function_">fetch</span>(<span class="hljs-string">'/api/data'</span>), timeout])
  .<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">data</span> =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'数据:'</span>, data))
  .<span class="hljs-keyword">catch</span>(<span class="hljs-function"><span class="hljs-params">error</span> =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'失败或超时:'</span>, error));
</code></pre>
<h4 data-id="heading-16"><code>Promise.any(iterable)</code>（ES2021）</h4>
<p>返回第一个<strong>成功</strong>的 Promise（忽略失败）：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">any</span>([
  <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">reject</span>(<span class="hljs-string">'A 失败'</span>),
  <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">resolve</span>(<span class="hljs-string">'B 成功'</span>),
  <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">reject</span>(<span class="hljs-string">'C 失败'</span>)
]).<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">value</span> =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(value)); <span class="hljs-comment">// 'B 成功'</span>
</code></pre>
<blockquote>
<p>❗ 若全部失败，则 reject 一个 <code>AggregateError</code>。</p>
</blockquote>
<hr/>
<h2 data-id="heading-17">五、Promise 与 async/await</h2>
<p><code>async/await</code> 是 Promise 的语法糖，使异步代码看起来像同步代码。</p>
<h3 data-id="heading-18">5.1 基本用法</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">fetchData</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">try</span> {
    <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetch</span>(<span class="hljs-string">'/api/data'</span>);
    <span class="hljs-keyword">if</span> (!response.<span class="hljs-property">ok</span>) <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">'请求失败'</span>);
    <span class="hljs-keyword">const</span> data = <span class="hljs-keyword">await</span> response.<span class="hljs-title function_">json</span>();
    <span class="hljs-keyword">return</span> data;
  } <span class="hljs-keyword">catch</span> (error) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'错误:'</span>, error);
    <span class="hljs-keyword">throw</span> error; <span class="hljs-comment">// 可选择重新抛出</span>
  }
}

<span class="hljs-comment">// 调用</span>
<span class="hljs-title function_">fetchData</span>().<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">data</span> =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(data));
</code></pre>
<h3 data-id="heading-19">5.2 关键规则</h3>
<ul>
<li><code>async</code> 函数<strong>总是返回 Promise</strong></li>
<li><code>await</code> 只能在 <code>async</code> 函数内使用</li>
<li><code>await</code> 后可跟 Promise 或普通值</li>
<li>错误可通过 <code>try/catch</code> 捕获</li>
</ul>
<h3 data-id="heading-20">5.3 并行 vs 串行</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// ❌ 串行（慢）</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">slow</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> a = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetch</span>(<span class="hljs-string">'/a'</span>);
  <span class="hljs-keyword">const</span> b = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetch</span>(<span class="hljs-string">'/b'</span>);
  <span class="hljs-keyword">const</span> c = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetch</span>(<span class="hljs-string">'/c'</span>);
}

<span class="hljs-comment">// ✅ 并行（快）</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">fast</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> [a, b, c] = <span class="hljs-keyword">await</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">all</span>([
    <span class="hljs-title function_">fetch</span>(<span class="hljs-string">'/a'</span>),
    <span class="hljs-title function_">fetch</span>(<span class="hljs-string">'/b'</span>),
    <span class="hljs-title function_">fetch</span>(<span class="hljs-string">'/c'</span>)
  ]);
}
</code></pre>
<hr/>
<h2 data-id="heading-21">六、常见陷阱与最佳实践</h2>
<h3 data-id="heading-22">6.1 陷阱 1：忘记返回 Promise</h3>
<pre><code class="hljs language-ini" lang="ini">// ❌ 错误：第二个 then 无法获取数据
fetch('/api')
  .then(<span class="hljs-attr">res</span> =&gt; res.json())
  .then(<span class="hljs-attr">data</span> =&gt; {
    processData(data)<span class="hljs-comment">; // 忘记 return</span>
  })
  .then(<span class="hljs-attr">result</span> =&gt; {
    console.log(result)<span class="hljs-comment">; // undefined!</span>
  })<span class="hljs-comment">;</span>

// ✅ 正确
fetch('/api')
  .then(<span class="hljs-attr">res</span> =&gt; res.json())
  .then(<span class="hljs-attr">data</span> =&gt; {
    return processData(data)<span class="hljs-comment">; // 显式 return</span>
  })<span class="hljs-comment">;</span>
</code></pre>
<h3 data-id="heading-23">6.2 陷阱 2：未处理拒绝（Uncaught Rejection）</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// ❌ 危险：可能被忽略，导致静默失败</span>
somePromise.<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">result</span> =&gt;</span> {
  <span class="hljs-comment">// ...</span>
});

<span class="hljs-comment">// ✅ 安全：始终处理错误</span>
somePromise
  .<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">result</span> =&gt;</span> { <span class="hljs-comment">/* ... */</span> })
  .<span class="hljs-keyword">catch</span>(<span class="hljs-function"><span class="hljs-params">error</span> =&gt;</span> { <span class="hljs-comment">/* 处理错误 */</span> });
</code></pre>
<blockquote>
<p>🔔 <strong>Node.js 提示</strong>：未处理的 Promise rejection 会导致进程警告（未来可能终止进程）。</p>
</blockquote>
<h3 data-id="heading-24">6.3 陷阱 3：在循环中使用 await（串行而非并行）</h3>
<pre><code class="hljs language-ini" lang="ini">// ❌ 串行执行（总耗时 = 所有请求时间之和）
for (const url of urls) {
  const <span class="hljs-attr">data</span> = await fetch(url)<span class="hljs-comment">;</span>
  results.push(data)<span class="hljs-comment">;</span>
}

// ✅ 并行执行（总耗时 ≈ 最长请求时间）
const <span class="hljs-attr">promises</span> = urls.map(url =&gt; fetch(url))<span class="hljs-comment">;</span>
const <span class="hljs-attr">results</span> = await Promise.all(promises)<span class="hljs-comment">;</span>
</code></pre>
<h3 data-id="heading-25">6.4 最佳实践</h3>
<ol>
<li><strong>始终处理错误</strong>：使用 <code>.catch()</code> 或 <code>try/catch</code></li>
<li><strong>避免嵌套 Promise</strong>：使用链式调用或 async/await</li>
<li><strong>明确返回值</strong>：在 <code>.then()</code> 中显式 <code>return</code></li>
<li><strong>合理使用组合方法</strong>：<code>all</code>、<code>race</code>、<code>allSettled</code></li>
<li><strong>不要混合回调与 Promise</strong>：统一异步风格</li>
</ol>
<hr/>
<h2 data-id="heading-26">七、Promise 的内部原理（简要）</h2>
<p>虽然开发者通常无需实现 Promise，但理解其机制有助于调试：</p>
<pre><code class="hljs language-ini" lang="ini">// 极简 Promise 实现（仅演示思路）
class SimplePromise {
  constructor(executor) {
    <span class="hljs-attr">this.state</span> = <span class="hljs-string">'pending'</span><span class="hljs-comment">;</span>
    <span class="hljs-attr">this.value</span> = undefined<span class="hljs-comment">;</span>
    <span class="hljs-attr">this.callbacks</span> = []<span class="hljs-comment">;</span>

    const <span class="hljs-attr">resolve</span> = value =&gt; {
      if (this.state !== 'pending') return<span class="hljs-comment">;</span>
      <span class="hljs-attr">this.state</span> = <span class="hljs-string">'fulfilled'</span><span class="hljs-comment">;</span>
      <span class="hljs-attr">this.value</span> = value<span class="hljs-comment">;</span>
      this.callbacks.forEach(<span class="hljs-attr">cb</span> =&gt; cb())<span class="hljs-comment">;</span>
    }<span class="hljs-comment">;</span>

    const <span class="hljs-attr">reject</span> = reason =&gt; {
      if (this.state !== 'pending') return<span class="hljs-comment">;</span>
      <span class="hljs-attr">this.state</span> = <span class="hljs-string">'rejected'</span><span class="hljs-comment">;</span>
      <span class="hljs-attr">this.value</span> = reason<span class="hljs-comment">;</span>
      this.callbacks.forEach(<span class="hljs-attr">cb</span> =&gt; cb())<span class="hljs-comment">;</span>
    }<span class="hljs-comment">;</span>

    executor(resolve, reject)<span class="hljs-comment">;</span>
  }

  then(onFulfilled) {
    return new SimplePromise((resolve) =&gt; {
      const <span class="hljs-attr">callback</span> = () =&gt; {
        if (<span class="hljs-attr">this.state</span> === <span class="hljs-string">'fulfilled'</span>) {
          const <span class="hljs-attr">result</span> = <span class="hljs-literal">on</span>Fulfilled(this.value)<span class="hljs-comment">;</span>
          resolve(result)<span class="hljs-comment">;</span>
        }
      }<span class="hljs-comment">;</span>
      if (<span class="hljs-attr">this.state</span> === <span class="hljs-string">'pending'</span>) {
        this.callbacks.push(callback)<span class="hljs-comment">;</span>
      } else {
        callback()<span class="hljs-comment">;</span>
      }
    })<span class="hljs-comment">;</span>
  }
}
</code></pre>
<blockquote>
<p>📚 <strong>真实 Promise 更复杂</strong>：需处理微任务队列（Microtask Queue）、thenable 对象、递归解析等。</p>
</blockquote>
<hr/>
<h2 data-id="heading-27">八、在 Vue 3 中的实践</h2>
<p>Vue 3 的组合式 API 与 Promise 天然契合：</p>
<pre><code class="hljs language-ini" lang="ini">// composables/useApi.js
import { ref } from 'vue'<span class="hljs-comment">;</span>

export function useApi(url) {
  const <span class="hljs-attr">data</span> = ref(null)<span class="hljs-comment">;</span>
  const <span class="hljs-attr">loading</span> = ref(<span class="hljs-literal">false</span>)<span class="hljs-comment">;</span>
  const <span class="hljs-attr">error</span> = ref(null)<span class="hljs-comment">;</span>

  const <span class="hljs-attr">execute</span> = async () =&gt; {
    <span class="hljs-attr">loading.value</span> = <span class="hljs-literal">true</span><span class="hljs-comment">;</span>
    <span class="hljs-attr">error.value</span> = null<span class="hljs-comment">;</span>
    try {
      const <span class="hljs-attr">res</span> = await fetch(url)<span class="hljs-comment">;</span>
      if (!res.ok) throw new Error(res.statusText)<span class="hljs-comment">;</span>
      <span class="hljs-attr">data.value</span> = await res.json()<span class="hljs-comment">;</span>
    } catch (err) {
      <span class="hljs-attr">error.value</span> = err<span class="hljs-comment">;</span>
    } finally {
      <span class="hljs-attr">loading.value</span> = <span class="hljs-literal">false</span><span class="hljs-comment">;</span>
    }
  }<span class="hljs-comment">;</span>

  return { data, loading, error, execute }<span class="hljs-comment">;</span>
}
</code></pre>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">setup</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">import</span> { useApi } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/composables/useApi'</span>;

<span class="hljs-keyword">const</span> { data, loading, error, execute } = <span class="hljs-title function_">useApi</span>(<span class="hljs-string">'/api/users'</span>);
<span class="hljs-title function_">execute</span>();
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">v-if</span>=<span class="hljs-string">"loading"</span>&gt;</span>加载中...<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">v-else-if</span>=<span class="hljs-string">"error"</span>&gt;</span>错误: {{ error.message }}<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">ul</span> <span class="hljs-attr">v-else</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">li</span> <span class="hljs-attr">v-for</span>=<span class="hljs-string">"user in data"</span> <span class="hljs-attr">:key</span>=<span class="hljs-string">"user.id"</span>&gt;</span>{{ user.name }}<span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">ul</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>
</code></pre>
<blockquote>
<p>✅ <strong>优势</strong>：逻辑复用、状态管理、错误处理一体化。</p>
</blockquote>
<hr/>
<h2 data-id="heading-28">结语</h2>
<p>Promise 是 JavaScript 异步编程的里程碑，它不仅解决了回调地狱问题，还为现代异步语法（async/await）奠定了基础。掌握 Promise 的核心概念、链式调用、错误处理和组合方法，是成为高效前端开发者的必经之路。</p>
<p>记住：</p>
<ul>
<li><strong>Promise 是状态机</strong>：pending → fulfilled/rejected</li>
<li><strong>链式调用是核心</strong>：每个 <code>.then()</code> 返回新 Promise</li>
<li><strong>错误必须处理</strong>：避免静默失败</li>
<li><strong>组合优于嵌套</strong>：善用 <code>Promise.all</code> 等静态方法</li>
</ul>
<p>随着 Web 应用日益复杂，异步操作无处不在。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Koa 源码深度解析：带你理解 Koa 的设计哲学和核心实现原理]]></title>    <link>https://juejin.cn/post/7585412203978833963</link>    <guid>https://juejin.cn/post/7585412203978833963</guid>    <pubDate>2025-12-20T08:42:40.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585412203978833963" data-draft-id="7585390679399301126" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Koa 源码深度解析：带你理解 Koa 的设计哲学和核心实现原理"/> <meta itemprop="keywords" content="Node.js"/> <meta itemprop="datePublished" content="2025-12-20T08:42:40.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="趴在窗边数星星"/> <meta itemprop="url" content="https://juejin.cn/user/2283029051479357"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Koa 源码深度解析：带你理解 Koa 的设计哲学和核心实现原理
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2283029051479357/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    趴在窗边数星星
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-20T08:42:40.000Z" title="Sat Dec 20 2025 08:42:40 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读10分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Koa 源码深度解析：带你理解 Koa 的设计哲学和核心实现原理</h2>
<blockquote>
<p>注：本文只讲koa源码与核心实现，无应用层相关知识</p>
</blockquote>
<h3 data-id="heading-1">一、Koa 的设计哲学</h3>
<h4 data-id="heading-2">1.1 什么是koa</h4>
<p>Koa 是由 Express 原班人马打造的下一代 Node.js Web 框架。相比于 Express，Koa 利用 ES2017 的 async/await 特性，让异步代码的编写变得更加优雅和可维护。本文将深入解析 Koa 的核心源码，帮助你理解其设计哲学和实现原理。</p>
<h4 data-id="heading-3">1.2 核心设计理念</h4>
<p>Koa 的设计理念可以概括为：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// Koa 应用本质上是一个包含中间件函数数组的对象</span>
<span class="hljs-comment">// 这些中间件以类似栈的方式组合和执行</span>
<span class="hljs-keyword">const</span> <span class="hljs-title class_">Koa</span> = <span class="hljs-built_in">require</span>(<span class="hljs-string">'koa'</span>);
<span class="hljs-keyword">const</span> app = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Koa</span>();

<span class="hljs-comment">// 中间件以"洋葱模型"方式执行</span>
app.<span class="hljs-title function_">use</span>(<span class="hljs-keyword">async</span> (ctx, next) =&gt; {
  <span class="hljs-comment">// 请求阶段（向下）</span>
  <span class="hljs-keyword">await</span> <span class="hljs-title function_">next</span>();
  <span class="hljs-comment">// 响应阶段（向上）</span>
});
</code></pre>
<p>官方文档这样描述：</p>
<blockquote>
<p>A Koa application is an object containing an array of middleware functions which are composed and executed in a stack-like manner upon request.</p>
</blockquote>
<h3 data-id="heading-4">二、源码核心流程解析</h3>
<p>在深入源码之前，我们先理解一下 Koa 应用从创建到处理请求的完整生命周期。一个典型的 Koa 应用会经历以下几个阶段：</p>
<ol>
<li><strong>创建应用实例</strong> - <code>new Koa()</code> 初始化应用对象</li>
<li><strong>注册中间件</strong> - <code>app.use()</code> 将中间件函数添加到数组</li>
<li><strong>启动监听</strong> - <code>app.listen()</code> 创建 HTTP 服务并开始监听</li>
<li><strong>处理请求</strong> - 当请求到来时，组合中间件并执行</li>
</ol>
<p>接下来我们逐步剖析每个阶段的源码实现。</p>
<h4 data-id="heading-5">2.1 创建Application</h4>
<p>当我们执行 <code>const app = new Koa()</code> 时，Koa 内部做了哪些初始化工作呢？让我们看看 <code>Application</code> 类的构造函数：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Application</span> {

  <span class="hljs-title function_">constructor</span> (options) {
    ......
    options = options || {}
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">compose</span> = options.<span class="hljs-property">compose</span> || compose <span class="hljs-comment">// 组合中间件的函数，这是实现洋葱模型的关键</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">middleware</span> = []                      <span class="hljs-comment">// 中间件数组，所有通过 use() 注册的中间件都会存储在这里</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">context</span> = <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">create</span>(context)     <span class="hljs-comment">// 上下文对象的原型，每个请求会基于它创建独立的 ctx</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">request</span> = <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">create</span>(request)     <span class="hljs-comment">// 请求对象的原型，封装了对 Node.js 原生 req 的访问</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">response</span> = <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">create</span>(response);  <span class="hljs-comment">// 响应对象的原型，封装了对 Node.js 原生 res 的访问</span>
    ......
   }
</code></pre>
<p><strong>为什么使用 <code>Object.create()</code> 而不是直接赋值？</strong></p>
<p>这是一个非常巧妙的设计。使用 <code>Object.create()</code> 创建原型链，意味着：</p>
<ul>
<li>每个应用实例都有自己独立的 <code>context</code>、<code>request</code>、<code>response</code> 对象</li>
<li>这些对象继承自共享的原型，既节省内存又保证了隔离性</li>
<li>可以在不同应用实例上挂载不同的扩展属性，互不影响</li>
</ul>
<h4 data-id="heading-6">2.2 注册中间件</h4>
<p>中间件是 Koa 的核心概念。通过 <code>app.use()</code> 方法，我们可以注册各种中间件来处理请求。让我们看一个实际例子：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 请求日志中间件：记录请求的 URL 和响应时间</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">logMiddleware</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params">ctx, next</span>) =&gt; {
  <span class="hljs-keyword">const</span> start = <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>();  <span class="hljs-comment">// 记录开始时间</span>
  <span class="hljs-keyword">await</span> <span class="hljs-title function_">next</span>();              <span class="hljs-comment">// 等待后续中间件执行完毕</span>
  <span class="hljs-keyword">const</span> end = <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>();    <span class="hljs-comment">// 记录结束时间</span>
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`<span class="hljs-subst">${ctx.method}</span> <span class="hljs-subst">${ctx.url}</span> - <span class="hljs-subst">${end - start}</span>ms`</span>);
};

app.<span class="hljs-title function_">use</span>(logMiddleware);

<span class="hljs-keyword">class</span> <span class="hljs-title class_">Application</span> {
  <span class="hljs-title function_">use</span>(<span class="hljs-params">fn</span>) {
    <span class="hljs-comment">// 注册中间件：将中间件函数添加到数组末尾</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">middleware</span>.<span class="hljs-title function_">push</span>(fn);
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>; <span class="hljs-comment">// 返回 this 支持链式调用</span>
  }
}
</code></pre>
<p><strong><code>use()</code> 方法的设计亮点：</strong></p>
<ol>
<li><strong>简单直接</strong> - 只是将中间件函数 push 到数组，没有复杂的逻辑</li>
<li><strong>链式调用</strong> - 返回 <code>this</code> 使得可以连续调用 <code>app.use().use().use()</code></li>
<li><strong>顺序敏感</strong> - 中间件的执行顺序取决于注册顺序，这对理解洋葱模型很重要</li>
</ol>
<p>注意上面的日志中间件示例：<code>await next()</code> 是一个分水岭，它将中间件分为"请求阶段"和"响应阶段"。这正是洋葱模型的精髓所在。</p>
<h4 data-id="heading-7">2.3 创建context</h4>
<p>每当有新的 HTTP 请求到来时，Koa 都会为这个请求创建一个全新的 <code>context</code> 对象。这个对象是 Koa 最重要的创新之一，它封装了 Node.js 原生的 <code>req</code> 和 <code>res</code>，提供了更加便捷的 API。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-title function_">createContext</span>(<span class="hljs-params">req, res</span>) {
  <span class="hljs-comment">// 基于应用的 context 原型创建新的 context 实例</span>
  <span class="hljs-keyword">const</span> context = <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">create</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">context</span>);
  <span class="hljs-comment">// 基于应用的 request 和 response 原型创建新的实例</span>
  <span class="hljs-keyword">const</span> request = context.<span class="hljs-property">request</span> = <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">create</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">request</span>);
  <span class="hljs-keyword">const</span> response = context.<span class="hljs-property">response</span> = <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">create</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">response</span>);

  <span class="hljs-comment">// 建立各对象之间的引用关系</span>
  context.<span class="hljs-property">app</span> = request.<span class="hljs-property">app</span> = response.<span class="hljs-property">app</span> = <span class="hljs-variable language_">this</span>;        <span class="hljs-comment">// 都持有 app 实例的引用</span>
  context.<span class="hljs-property">req</span> = request.<span class="hljs-property">req</span> = response.<span class="hljs-property">req</span> = req;         <span class="hljs-comment">// 都持有 Node.js 原生 req 的引用</span>
  context.<span class="hljs-property">res</span> = request.<span class="hljs-property">res</span> = response.<span class="hljs-property">res</span> = res;         <span class="hljs-comment">// 都持有 Node.js 原生 res 的引用</span>

  <span class="hljs-comment">// 建立 context、request、response 之间的相互引用</span>
  request.<span class="hljs-property">ctx</span> = response.<span class="hljs-property">ctx</span> = context;                   <span class="hljs-comment">// request 和 response 都能访问 context</span>
  request.<span class="hljs-property">response</span> = response;                            <span class="hljs-comment">// request 能访问 response</span>
  response.<span class="hljs-property">request</span> = request;                             <span class="hljs-comment">// response 能访问 request</span>

  <span class="hljs-keyword">return</span> context;
}

</code></pre>
<p><strong>这个方法的精妙之处：</strong></p>
<ol>
<li><strong>原型继承</strong> - 使用 <code>Object.create()</code> 确保每个请求都有独立的 context，但共享原型上的方法</li>
<li><strong>四层封装</strong> - <code>context</code> → <code>request/response</code> → <code>req/res</code>，逐层抽象，提供更优雅的 API</li>
<li><strong>相互引用</strong> - 建立了复杂但合理的引用关系，使得在任何层级都能方便地访问其他对象</li>
<li><strong>内存优化</strong> - 通过原型链共享方法，避免每个请求都创建重复的方法副本</li>
</ol>
<p>这样设计的好处是，在中间件中我们可以灵活地访问：</p>
<ul>
<li><code>ctx.req</code> / <code>ctx.res</code> - 访问 Node.js 原生对象</li>
<li><code>ctx.request</code> / <code>ctx.response</code> - 访问 Koa 封装的对象</li>
<li><code>ctx.body</code> / <code>ctx.status</code> - 使用 Koa 的便捷属性（代理到 response）</li>
</ul>
<h4 data-id="heading-8">2.4 启动监听服务</h4>
<p>当所有中间件注册完成后，我们需要启动 HTTP 服务器开始监听请求。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 用户代码：启动服务器</span>
app.<span class="hljs-title function_">listen</span>(<span class="hljs-number">3000</span>, <span class="hljs-function">() =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Server is running on port 3000'</span>);
});

<span class="hljs-comment">// Koa 内部实现</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Application</span> {
  listen (...args) {
    <span class="hljs-title function_">debug</span>(<span class="hljs-string">'listen'</span>)
    <span class="hljs-comment">// 创建 Node.js HTTP 服务器，传入 callback 作为请求处理函数</span>
    <span class="hljs-keyword">const</span> server = http.<span class="hljs-title function_">createServer</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">callback</span>())
    <span class="hljs-keyword">return</span> server.<span class="hljs-title function_">listen</span>(...args) <span class="hljs-comment">// 返回 Node.js 的 http.Server 实例</span>
  }

  <span class="hljs-comment">// callback 方法返回一个符合 Node.js http.createServer 要求的请求处理函数</span>
  <span class="hljs-title function_">callback</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// ⭐️ 核心：使用 compose 将所有中间件组合成一个函数</span>
    <span class="hljs-comment">// 这就是洋葱模型的实现入口！</span>
    <span class="hljs-keyword">const</span> fn = <span class="hljs-title function_">compose</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">middleware</span>);

    <span class="hljs-comment">// 如果没有监听 error 事件，添加默认的错误处理器</span>
    <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">listenerCount</span>(<span class="hljs-string">'error'</span>)) <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">on</span>(<span class="hljs-string">'error'</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">onerror</span>);

    <span class="hljs-comment">// 返回请求处理函数，Node.js 会在每次请求到来时调用它</span>
    <span class="hljs-keyword">return</span> <span class="hljs-function">(<span class="hljs-params">req, res</span>) =&gt;</span> {
      <span class="hljs-comment">// 为这个请求创建独立的 context</span>
      <span class="hljs-keyword">const</span> ctx = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">createContext</span>(req, res);
      <span class="hljs-comment">// 执行组合后的中间件函数，传入 context</span>
      <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">handleRequest</span>(ctx, fn);
    };
  }
}
</code></pre>
<p><strong>流程分解：</strong></p>
<ol>
<li><strong><code>app.listen()</code></strong> - 这只是对 Node.js 原生 API 的薄封装</li>
<li><strong><code>this.callback()</code></strong> - 这里是魔法发生的地方：
<ul>
<li>调用 <code>compose(this.middleware)</code> 将所有中间件组合成一个函数</li>
<li>返回一个闭包函数，每次请求时被调用</li>
</ul>
</li>
<li><strong>请求处理</strong> - 当请求到来时：
<ul>
<li>创建本次请求专属的 <code>ctx</code> 对象</li>
<li>执行组合后的中间件函数 <code>fn(ctx)</code></li>
<li>所有中间件共享同一个 <code>ctx</code></li>
</ul>
</li>
</ol>
<p><strong>关键点：<code>compose(this.middleware)</code></strong></p>
<p>这行代码是理解 Koa 的关键。它将一个中间件数组：</p>
<pre><code class="hljs language-javascript" lang="javascript">[middleware1, middleware2, middleware3]
</code></pre>
<p>转换成一个嵌套的调用链：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-title function_">middleware1</span>(ctx, <span class="hljs-function">() =&gt;</span> {
  <span class="hljs-title function_">middleware2</span>(ctx, <span class="hljs-function">() =&gt;</span> {
    <span class="hljs-title function_">middleware3</span>(ctx, <span class="hljs-function">() =&gt;</span> {
      <span class="hljs-comment">// 最内层</span>
    })
  })
})
</code></pre>
<p>这就是著名的"洋葱模型"的实现基础。接下来我们将深入剖析 <code>compose</code> 函数的源码。</p>
<h3 data-id="heading-9">三、洋葱模型：中间件的优雅编排</h3>
<h4 data-id="heading-10">3.1 什么是洋葱模型？</h4>
<p>Koa 的中间件执行机制被形象地称为"洋葱模型"。中间件的执行过程类似于剥洋葱：</p>
<ol>
<li><strong>请求阶段</strong>（外层到内层）：从第一个中间件开始，遇到 <code>await next()</code> 就进入下一个中间件</li>
<li><strong>响应阶段</strong>（内层到外层）：最内层中间件执行完毕后，依次返回到外层中间件</li>
</ol>
<h4 data-id="heading-11">3.2 compose 源码解析与实现</h4>
<p><code>compose</code> 函数是 <code>koa-compose</code> 包提供的，它是实现洋葱模型的核心。让我们先看看官方源码：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">compose</span>(<span class="hljs-params">middleware</span>) {
  <span class="hljs-comment">// compose 返回一个函数，这个函数接收 context 和一个可选的 next</span>
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">function</span> (<span class="hljs-params">context, next</span>) {
    <span class="hljs-keyword">let</span> index = -<span class="hljs-number">1</span>;  <span class="hljs-comment">// 用于记录当前执行到第几个中间件</span>

    <span class="hljs-comment">// dispatch 函数负责执行第 i 个中间件</span>
    <span class="hljs-keyword">function</span> <span class="hljs-title function_">dispatch</span>(<span class="hljs-params">i</span>) {
      <span class="hljs-comment">// 防止在同一个中间件中多次调用 next()</span>
      <span class="hljs-comment">// 如果 i &lt;= index，说明 next() 被调用了多次</span>
      <span class="hljs-keyword">if</span> (i &lt;= index) {
        <span class="hljs-keyword">return</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">reject</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">'next() 被多次调用'</span>));
      }

      index = i; <span class="hljs-comment">// 更新当前中间件索引，用于防止 next 被多次调用</span>
      <span class="hljs-keyword">let</span> fn = middleware[i];  <span class="hljs-comment">// 获取当前要执行的中间件</span>

      <span class="hljs-comment">// 如果已经是最后一个中间件，fn 设为传入的 next（通常为 undefined）</span>
      <span class="hljs-keyword">if</span> (i === middleware.<span class="hljs-property">length</span>) fn = next;
      <span class="hljs-comment">// 如果 fn 不存在，说明已经到达末尾，返回一个 resolved 的 Promise</span>
      <span class="hljs-keyword">if</span> (!fn) <span class="hljs-keyword">return</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">resolve</span>();

      <span class="hljs-keyword">try</span> {
        <span class="hljs-comment">// ⭐️ 核心逻辑：执行当前中间件，并将 dispatch(i + 1) 作为 next 参数传入</span>
        <span class="hljs-comment">// 这样当中间件调用 await next() 时，实际上是在调用 dispatch(i + 1)</span>
        <span class="hljs-comment">// 从而递归地执行下一个中间件</span>
        <span class="hljs-keyword">return</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">resolve</span>(<span class="hljs-title function_">fn</span>(context, dispatch.<span class="hljs-title function_">bind</span>(<span class="hljs-literal">null</span>, i + <span class="hljs-number">1</span>)));
      } <span class="hljs-keyword">catch</span> (err) {
        <span class="hljs-keyword">return</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">reject</span>(err);
      }
    }

    <span class="hljs-comment">// 从第一个中间件开始执行</span>
    <span class="hljs-keyword">return</span> <span class="hljs-title function_">dispatch</span>(<span class="hljs-number">0</span>);
  };
}
</code></pre>
<p><strong>这个函数的精妙之处：</strong></p>
<ol>
<li><strong>闭包保存状态</strong> - 通过闭包保存 <code>index</code>，防止 <code>next()</code> 被重复调用，这是一个重要的安全检查</li>
<li><strong>递归调用链</strong> - <code>dispatch(i)</code> 执行当前中间件，并将 <code>dispatch(i + 1)</code> 作为 <code>next</code> 传入</li>
<li><strong>Promise 包装</strong> - 所有中间件都被包装成 Promise，支持 async/await 语法</li>
<li><strong>懒执行</strong> - 只有当中间件调用 <code>await next()</code> 时，下一个中间件才会执行</li>
</ol>
<p><strong>执行流程可视化：</strong></p>
<p>假设有三个中间件 <code>[m1, m2, m3]</code>：</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-built_in">dispatch</span>(<span class="hljs-number">0</span>) 执行 <span class="hljs-built_in">m1</span>(ctx, dispatch(<span class="hljs-number">1</span>))
  ↓
  m1 执行到 await <span class="hljs-built_in">next</span>()
  ↓
  <span class="hljs-built_in">dispatch</span>(<span class="hljs-number">1</span>) 执行 <span class="hljs-built_in">m2</span>(ctx, dispatch(<span class="hljs-number">2</span>))
    ↓
    m2 执行到 await <span class="hljs-built_in">next</span>()
    ↓
    <span class="hljs-built_in">dispatch</span>(<span class="hljs-number">2</span>) 执行 <span class="hljs-built_in">m3</span>(ctx, dispatch(<span class="hljs-number">3</span>))
      ↓
      m3 执行完毕
    ↓
    m2 的 <span class="hljs-built_in">next</span>() 后的代码执行
  ↓
  m1 的 <span class="hljs-built_in">next</span>() 后的代码执行
</code></pre>
<p>源码使用递归实现，初看可能有些难懂。没关系，下面我们来实现一个简化版本，帮助理解核心思想。</p>
<h4 data-id="heading-12">3.3 手写简易版 compose</h4>
<p>核心思想：<strong>在当前中间件执行过程中，让 <code>next()</code> 函数能够自动执行下一个中间件</strong>，直到最后一个。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> <span class="hljs-title function_">compose</span> = (<span class="hljs-params">middleware</span>) =&gt; {
  <span class="hljs-keyword">const</span> ctx = {};  <span class="hljs-comment">// 创建一个上下文对象</span>

  <span class="hljs-keyword">if</span> (middleware.<span class="hljs-property">length</span> === <span class="hljs-number">0</span>) {
    <span class="hljs-keyword">return</span>;
  }

  <span class="hljs-keyword">let</span> index = <span class="hljs-number">0</span>;
  <span class="hljs-keyword">const</span> fn = middleware[index]; <span class="hljs-comment">// 获取第一个中间件</span>
  <span class="hljs-title function_">fn</span>(ctx, next);                <span class="hljs-comment">// 手动执行第一个中间件</span>

  <span class="hljs-comment">// 实现 next() 函数</span>
  <span class="hljs-comment">// 核心是在当前中间件执行过程中，获取下一个中间件函数并自动执行，直到最后一个</span>
  <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">next</span>(<span class="hljs-params"/>) {
    index++;  <span class="hljs-comment">// 移动到下一个中间件</span>

    <span class="hljs-comment">// 如果已经是最后一个中间件，直接返回</span>
    <span class="hljs-keyword">if</span> (index &gt;= middleware.<span class="hljs-property">length</span>) {
      <span class="hljs-keyword">return</span>;
    }

    <span class="hljs-keyword">const</span> fn = middleware[index];  <span class="hljs-comment">// 获取下一个中间件</span>
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">await</span> <span class="hljs-title function_">fn</span>(ctx, next);    <span class="hljs-comment">// 执行下一个中间件，并传入 next</span>
  }
};

<span class="hljs-comment">// 定义三个测试中间件</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">middleware1</span> = (<span class="hljs-params">ctx, next</span>) =&gt; {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"&gt;&gt; one"</span>);
  <span class="hljs-title function_">next</span>();                 <span class="hljs-comment">// 调用 next()，执行 middleware2</span>
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"&lt;&lt; one"</span>);
};

<span class="hljs-keyword">const</span> <span class="hljs-title function_">middleware2</span> = (<span class="hljs-params">ctx, next</span>) =&gt; {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"&gt;&gt; two"</span>);
  <span class="hljs-title function_">next</span>();                 <span class="hljs-comment">// 调用 next()，执行 middleware3</span>
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"&lt;&lt; two"</span>);
};

<span class="hljs-keyword">const</span> <span class="hljs-title function_">middleware3</span> = (<span class="hljs-params">ctx, next</span>) =&gt; {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"&gt;&gt; three"</span>);
  <span class="hljs-title function_">next</span>();                 <span class="hljs-comment">// 已经是最后一个，next() 直接返回</span>
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"&lt;&lt; three"</span>);
};

<span class="hljs-comment">// 执行组合后的中间件</span>
<span class="hljs-title function_">compose</span>([middleware1, middleware2, middleware3]);

<span class="hljs-comment">// 输出：</span>
<span class="hljs-comment">// &gt;&gt; one</span>
<span class="hljs-comment">// &gt;&gt; two</span>
<span class="hljs-comment">// &gt;&gt; three</span>
<span class="hljs-comment">// &lt;&lt; three</span>
<span class="hljs-comment">// &lt;&lt; two</span>
<span class="hljs-comment">// &lt;&lt; one</span>
</code></pre>
<p><strong>关键理解点：</strong></p>
<ol>
<li><strong>同步执行</strong> - 当 <code>middleware1</code> 调用 <code>next()</code> 时，<code>middleware2</code> 会立即开始执行</li>
<li><strong>栈式回溯</strong> - 当 <code>middleware3</code> 执行完毕后，控制权会依次返回到 <code>middleware2</code> 和 <code>middleware1</code> 的 <code>next()</code> 之后</li>
<li><strong>洋葱结构</strong> - 这就形成了"进入"和"退出"两个阶段，像剥洋葱一样</li>
</ol>
<p><strong>执行顺序详解：</strong></p>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-bullet">1.</span> middleware1 开始执行 → 打印 "&gt;&gt; one"
<span class="hljs-bullet">2.</span> middleware1 调用 next() → 暂停，进入 middleware2
<span class="hljs-bullet">3.</span> middleware2 开始执行 → 打印 "&gt;&gt; two"
<span class="hljs-bullet">4.</span> middleware2 调用 next() → 暂停，进入 middleware3
<span class="hljs-bullet">5.</span> middleware3 开始执行 → 打印 "&gt;&gt; three"
<span class="hljs-bullet">6.</span> middleware3 调用 next() → 返回（已是最后一个）
<span class="hljs-bullet">7.</span> middleware3 继续执行 → 打印 "&lt;&lt; three"
<span class="hljs-bullet">8.</span> middleware3 执行完毕 → 返回到 middleware2
<span class="hljs-bullet">9.</span> middleware2 继续执行 → 打印 "&lt;&lt; two"
<span class="hljs-bullet">10.</span> middleware2 执行完毕 → 返回到 middleware1
<span class="hljs-bullet">11.</span> middleware1 继续执行 → 打印 "&lt;&lt; one"
</code></pre>
<p><strong>建议：</strong> 使用 VSCode 的断点调试功能，在每个中间件的 <code>next()</code> 前后打断点，单步执行体会代码的具体执行过程。这样能够更直观地理解洋葱模型的运作机制。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d68926e6e1eb4925b44a05a1692dc599~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6La05Zyo56qX6L655pWw5pif5pif:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766824960&amp;x-signature=2O9KCiNJtD3y9zXPy72oxglmmTA%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-13">四、总结</h3>
<p>通过对 Koa 源码的深入分析，我们可以看到它的设计哲学：<strong>极简、优雅、灵活</strong>。</p>
<h3 data-id="heading-14">参考资源</h3>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fkoajs.com%2F" target="_blank" title="https://koajs.com/" ref="nofollow noopener noreferrer">Koa 官方文档</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fkoajs%2Fkoa" target="_blank" title="https://github.com/koajs/koa" ref="nofollow noopener noreferrer">Koa GitHub 仓库</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fkoajs%2Fcompose" target="_blank" title="https://github.com/koajs/compose" ref="nofollow noopener noreferrer">koa-compose 源码</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fkoajs%2Fkoa%2Fwiki" target="_blank" title="https://github.com/koajs/koa/wiki" ref="nofollow noopener noreferrer">Koa 中间件列表</a></li>
</ul>
<hr/>
<p>如果觉得有帮助，欢迎点赞收藏，也欢迎在评论区交流讨论！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[vscode没有js提示：配置jsconfig配置]]></title>    <link>https://juejin.cn/post/7585468725332279350</link>    <guid>https://juejin.cn/post/7585468725332279350</guid>    <pubDate>2025-12-20T08:44:44.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585468725332279350" data-draft-id="7585468725332262966" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="vscode没有js提示：配置jsconfig配置"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-12-20T08:44:44.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Mr_Swilder"/> <meta itemprop="url" content="https://juejin.cn/user/3927901716878829"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            vscode没有js提示：配置jsconfig配置
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3927901716878829/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Mr_Swilder
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-20T08:44:44.000Z" title="Sat Dec 20 2025 08:44:44 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden;color:#2b2b2b;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(159,219,252,.15) 3%,transparent 0),linear-gradient(1turn,rgba(159,219,252,.15) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin-top:35px;margin-bottom:10px;color:#4dd0e1}.markdown-body h1{font-size:30px;text-align:center;position:relative;width:max-content;margin:0 auto}.markdown-body h1:before{position:absolute;content:"";z-index:-1;top:-20px;height:100%;width:100px;left:0;right:0;margin:0 auto;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADsAAAA6CAYAAAAOeSEWAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsQAAA7EAZUrDhsAABkLSURBVGhDtZoHnJ1llcbP3Om9ZiYzmfSQhCQQIbRQVQKI9CYC68qKriJK0UXcZRcINqStIoiIqKCi1NACQihBWiCkkJ5MJlMyvd7p7d759v989/sy34yTbIj48Atz71ff855znvOc971xDrB/EtoGI7a9Z8Aq+wZML0mNj7dE95NZ1OKsj1dHo1GbnJpss9OTbWJyonvun4VP1Njuoagtb+m0it4By0iIt8LEeMvkr8XFWcfgkA1gYDLf47i2PzpsyU7UspKSLDoctagTZ7Vc08MzClMS7awJ2ZaflBB78CeET8TYla1dtrKt2w5KS7YCDGzEoz2RqKUmhGw6x2bhuXyOp2BoRXef1Q1E7Lj8TIsMD1sbxu1kcnYSAX1810RMTUmyMB7f2j1gC7NS7byinNiL/kH8Q8a+2NRh77b32El56VaPAe0YeGR2mh2bm+FdMRqP1rbZe+3dFsHT35qcb/Oz0rwzo7Gxs9feYPLS4kM2h8lawee5hPmlJXneFQeGAzJ2F564v7rFzi7Msu3d/Xgjzq5g8ArX8VCNN2vJ28daey0zZJabmGCLslP5HOf+Oygr3UzDGOf+JxrauXfQjslJt+dbuuyMgiwmk+sPAB/b2Lt2NdoMZnuY21qHIvbvUyZ4Z0ZQiXGrWjvsmPxsK4R0nmHA8ZCTQvxVQn5eRipklIBtcVbV1WtHYsjati47ZWKuTUpP9Z4yGk/xDBGe3v1mW4/dOrvYO7P/2G9jRSjf31FnXyaUXiB8r51WaJkM3kcfOSa2FR6qarIenooTLQHPLcC4mYThyw1tVpKWYlVERlZ8nC3Oz3Jzdn1nn5uvQ8OOHYvhR/CvsqffJbkCkZTvcYZ6Z0WTfTovw5Y1dtjXp+TbFPhgf7FfxpYxuMfr2uwo8rEtMmwXF+d6Z8wGmIR2PLyjo8cqOFffP2SLGexJEJCP9R29thkPXlpa4A5Y3w/jmuVNYYwO2QkY7WMtz3mVcE1hkualJdmSolzX8GnpKd4VZq80d1o7zN0RdWxGaqItgbn3B/+vsasgh/UMNBOvzYMZDxtDKp289KGaVguFQvb1yQWWwuB97GaSXqUUnVaYbSUwrDCEBz/C2CM8EhNrP13fbkeSh3OJgCAe2N1CWXKsGOc6TOr5U4q8MwYhDtkTda02MyPN+nnGBQEH7A37NHYz5KOZVv08qyjbSseEzKauPnsMj98wc6Ibcj5UUv7M8QWZTE52jEwGOVaD8U1Dw1YNWX0qM8VKyb80L/TrOPYOzH4KBJQTrK8M7+7KZjuM63sHBt17FubGoibCuf+tarWFGUmuwWeT8/vCXo1tZOYeZcazCaez8MwEzzM+HqhqtiJI5twxL1jeGLYk7jmKMF1JOCbg6Qj5nAdRqX7q3BYm8VAmQvW1lfcMc58IT95uIA3q+gftrDHPXUXJWkVEHJme5Bp5UmHsvIZ/O3l8ECE/FWcsItX2hr0ae8O2Wjs+J43QTbOZzGYQ/7Wtxq6eXjRK3r0By4YJ6Ty8EiYSJqcm2eGeV4Pox/ANENJR49RiEdfqcLflUJrEBZqgxYHrBjn2ExFURqKdVETN9YirJxKxR2rbrYeQv5ISmB6IsiDGNfZGWPeMgkzr58xnPaJ5p6XDZPKz4T77wayJ7jGhhXLwanOHTWBgq5n5q6YUwNJ7l3kKcRl7OJ7fF56l1GzvHbSD8dghTPi0wIRfv6XafjJ3ssv0PnZQ7nZx/etwzO1zJ3lHR2OETTw8x0tOx1AN3De0D7YV+63oGthjaJQ5Ur7eVVZjcdGInUyuaT73ZWg3efV8fZs7cc2E777Qi5eunVbghvPPymrt/krKGfcLd8ybYjdxrK6333Z09rjHZkNuLYzz0uIc+xWCZzz8nbHbe4dsY1e/XUOY+nimvtUaSazv4jXhaQasSbmYmpuenGwHZ8TKggSEQm08rMD7ahBOoExcMqXQegjnZ+CEvaEa1ZQUQkt39dj0zDS7krq+ARmpdws/nlNqD9WFbWN7l5u3wr9MyrcXKUsqWy3jTOaoML4DdaQ83YIoT4VYpEXvYQZLmbX5SLohBrgOj186Kc/iKTUPUhq+Rrm5ekOl3TWv1Mr6hqwbY0VOQXwEo+Moq4Z47q5qsU489G944LyJOW4LOLZOKtT/iI6+nGe/0dhuEd4ltj2NmiuCU4hnk5fHIi7+RK4uTEu0e+s7rAiRcw1CYy3OejvcYz+eXeI9MYY9nu3lYZl0KavJJ7Vjibzgjp319rUZE20j7CkJqFr5JQYgQ39f3eQaKpQk0afy8nl4uBzvjUUTRk7k3iebOm0pabDiyFn2XGu3dRME41CGVeBVqSiVnc6hIUpekp1VjHLDSOEcQlui5W/U8C7IKREjv1Gabw3wRwUTvpv7jybPtzHmIPZ49q6KRjuccqBQVCOtGvqXhrCFUUXJzOYSHt7Kw5Ix9H08dSje1o1JyL73IYXpEMmE5CRbw6wuykx2pR+Pd6/J4JpLiJKV6N9OnrcQNfQ0Zem6qQX2MmFXyWTE+DMO0kGx4e08DEjnXbsYuOq7niHB8jdY/wQ8Srm2XCZZUrOakF1CY5EKX0h93Tu/1J4kRdbDMT8MamgZK9xe3uDcvrPe++Y4f61rcZr7B53rN1c5N2ytcV5rCrvHt3T2Og19g+5nH7dvq3bqunr4NOwgK2MHA1jeEDuG7HNuLmtw7qpocl5t6nCPvdTQ7v4N4u3WTqeyu9cZHIo4f6lqdFoHh7wzMbzDeeGv3Hvzjlrnh2W1zofhHuftxpFn3VFe7zxS0+p0DlKVPbhhvBxhvwiFMgfP+mjHA08gEC4pybeLyK1iZldh8zC5VJQyUl8l59KZ0WJk2xaiYWxNrkXXJhA8r3PvZRur7ZZZRfadaRPsfiTmX9HGajC2tXd6V8dQTMhX0h8rNdJx9Ra8F8SbRNLzhPRnJmTZIUTYueTyWxyr7uv3rjC3OkzE8495oS+4xq6D5WoI0bO5WVCOSerl8rIeBrOI/Hkaw6ME5W1zSuzx2la3CRdWi3zIG+FDBvUp9LMgI/vggUmE7KkT81yGvOOgEYa/aUahhRAF5xLec3OzbF1r2O17BbVxIi7hzJIC64IYhXdJA+nh/5xVbOmE9J0QqjSxWk0pp37M2YEtgjS8GpimACu7xkqxdKJ6fEXyYl2Lre0ZtC8yELVewtWUnbfCPIhrvgDFz8WI5yhJKgcnFMZWEFrwhgzo5uWDDDA1oGSOzcu0xfx7vTlsv6posIMpJ6cGWPiw/BxL4PU7vbrpjgf8bMdu5OYwOdhm83DARUSa0ELknYIeEAaILuWxlhGa0M8+EuJCrpJT+ymENhN60pXBxa3LZ5TsucnlGaCmIEQ4Evru91yuz0xMtKaeXluI5zdh9Mm8vAlBn4aR07X64EH3vEKdXQkZJXPP/JxMvNRpLxEtHZ5RQgmNewnpouvVTpYTHdfOnmy5kFUGnpRTfEhXD9DiBdFFJB0/YWS9aj6pmc89r0BaQmgTRkgI+EsdKsYasJZOBF+QqTH474NK7LbyBvf7W+RgOxNyxfQY2/2hrp2+NkroxrzrQ55fSZkpJIa28znCgF6rb7H1hOSslATyvNflAh9pvHcX3lVE/Ya8FjTJIexa2Rq77nfU96unTnD7aME3+TAm6BFKYrPnqCNIqV5sq0ZGCiEV+Db+qWMQqpFgb5KPx48R6omeDl2EuP9DTYt9iGA/f1KBS1w/La+H4ktsSmLItvZHXLUkrCeflVtJ9DVVg1H7+sxiGvVM975rZpfabuqHVhuP5F1vewav5O8GamUe91yDanoYw47FWzC929O+DJnKA2opFY1Rjru5CE7kOcO0jJtQVUIynzuZEMeb+1CEOFXN8iFSGeRpCm1BTlJxVg49Azm819SO7Bu0axEbwn27GuxMck+TMQHDP8fn48gfDVIL4R8xKVPJ73MQBUIfA/Z54LMw5vmlE+w+VFo2A78X/SsyPA/RMD0z3e2qVLtfo7aeBslpMX0N0TEnLcUlKym1jyBFqSohmYntI5enBhYB9CY/2kNarhwJhNiMtRGyWnkQdKaCFyQwgydjyNUw4VchKxXv2/DoKdC+lkQbCX1NlKCGvJiBJkSGbCus6jfo4yGBNySgr+u7e20BCsxdVAcFlJ/tHd32+cIsNxSXUULUUx+dg/d47g7OPYFw2MxkSuyMwLHVTI6PBN6dS8Sppw45zHJSgDXV3aQzmz40Z6fDgBfiAXU0uZxby2zejee+j3eltoQMzhV6qSBogXwrEXDj7ElWxUQ8RrnSaoU0dxIsKaiMvMykXTu90NqJsGHP4z78SdLigUrLKat32nFwy/E07pfDFRdQ/7N5r57pQ1482uvWhMGhQcviGkVrKDUp0ToCxfhQal5n4Hs/g1jOgH4LWdwFOd1b1WzHET4vLZppv+Czjxo840OrDlG8jAJzv2tp5mLK1dsU/lfIOeWy5NxFxfl2BoYImlQtx9QF6mJRQKBsQYYuO2yaLYPBUXvu/VqYPxtHhNy7Y4hCkNLGPtKSklzCVKSHtMQxcqm5Kw1DhI2PTGZtcGDAvoLQ/u7MifYtWFBlxz2H9zo8RkwKzC5UYiG+p44ccqE62YAxLeT/TOpf8MXx8Qk0IJFRY1Go+viQVJpE5Ehjf49xfAZeqGIy/7us3nqxwQfCkjZypPxobVr/6YpQHIalUvuCyEwbSXC9PC8QnkFcXlrgLpoLIhIfKuaqlQkYIAwQnr/f3eyu7KttOw2lNpv8/BPHyjzVNER3o72gvEBKqRMTflndbP8BMweRDyeciEj5bFayFXqTLzheivgYJC0jwzwHa0MDDEotm48ndze5BBBElAnxxcRYHAFh3FfZaA9UNRmC354kNwUx8eHkmVj5dcTE5ZMnuEyr1QqlhtaJLuOYZv4v3KNo0TKrGPUZ1NILPKuWcvVn5Trv10SMB6h0j/ARMnlOuafCBIfnSWEx/Raif3HDzofYMM31dOyY9LBaLK3TjoX2fEqT4+2qaUVWSTQvyM6wC8nNJyEetXIyuLKrx04P7MKNnbJZlKUtNAIHo7i2dA/YU3Vtdi5l6jCepXy8hOedSSSsI8/HQg5Q+gxTKXwkMHkbESo+hjG0lbRRzQ3Fc5LOzDuFhs3Ptumpie7ilRDhlEJOq/hjsZljCxjkt7fWuPS/EekpXMggJQIk0G+eN9Xu2VmHWIkJe0nJRN4ptBBit2yutG9ML7J1DHAxebiAMrZ4VZlduqGS8I2tJc2iborUxmIN79c+kTovFxivPvrcSaP3n7RSKYTUmKt4N3rMOcw4JOneD3sP956jNaMglIeTER5Xbdlt15Tm2W10NEsYrA/N5JLCHHsR9tSqwxq08G3bqm1ZTbOtagnbo6SLvH/VzBL7W7jPzqFea0LmMLFzUuLtdwumuO3i1Vtq7OK15Xgw3l1PDmIXak+6QBEkvB9YJIzBcc/L20JIYaSZ/qAzVm5Ut4oowk3QehC+N3xo/1wTqt7zsYawfX9no9XjqdPXVLhrwyo/wucJYQkE1e4j8rLcBuHUItQQKqgMXb6LGvxFQlXw33AdZLR0V5P9Fr29lP73scNnosoyvdWPv4fPJ+uJrLVtMakqaL1M1cTvv0OLIZE6wk2a2IcIRUQh+DaejpdcXepBa7bKDRGM9PIVxTl2EwarZ72rooVuY4RQtMypdk6e1lLLehhY2lt7QEd7WxlCDvdIli6E9B4+ZIodmZEMccUGqgiZOqru9tkR3iJ8nCcXRWRZCSPMLPEjlx2LjQL1OM5qKAm+vhSuRqSfV5Ttrg8FdWcrnhMqCTex7DEM6qTsVEuM1+8hovaHQ6e6a1Fz0xLd3nUt4ToWWuzWNkhcoAIIjUx2ZpxjLzWF9+SYmngR1lok4TEoJxGfuijhI/7OICoFmadl2llcL9b1oRVJtbD+JLlv1KrhHG5811t9ELbzgk14ICUwqE+TDzftqHPz98vUSy3jSIwP8dCpkNqLDPTx+rArz4T5qLG3G2PrvJKKPoLBWE501NC3ilUX5mVjVIb9nIbgWcpPMiSXjbcL8K62UkR86m1/yfkSeMaHFuK04X0CE3J6SWzFUxw0BSNHlSzi3RmIRJwHq5udO3c16quLp6sbnffbupxbt+12vzOrzuvNHc7ycRbIxuJHgYU7YSASdQgxp7qz2ynv6HJeqW91doa7nLruXof+17sqhhu31Xif9o7HalqczV29Dnrb/f5EXZvzdH27U98/6LR5i3N0UM5zjHU71/lwjRWWltU5CAIn7F1MqLp/r9hQ5RoaxG+qmrxP4yNKcfsFLwuiprffeb2l03m2scO5h3Or2rudzjGrhk8x4Cqu2xcexilBvNEcdi5Yu4tKF3Ue4tzPy+td5/1md4tzw5iJ27NuXEYobYUdlb8z6GTWkdxaCvk2zHjd5mpKQ459mv5TkAp6mQb9Aq9HHQ8S6mrZnuc6vUG6WHusIhCJGNXl9byvnJyaiE7+Eoz8c5TYNQiUveENGpJpcIJ+biS8R0+rlcazGNs7pKB+zPLTOSX2KNWhlDAf4r2Spj72JORB5OyHULX+dlD/FOky/HFy5ygYU0sey/i8moeqdunXK1qC3RuaMOYHlI/raQMl3M+EeTV5WxD3Km8a8PkM8nr648sQ9+esKbf5e/nxiKBfAOQkxbv3SU9LYmqPV9V/Pn+V20VwTyVjTqCI6edEQUOFUXs9WmfSll8DyX2dt7GlnwkswaM3l9XZ0oNK3MTXbxpOV2sGk69s6XCJw4cY8KbyRrt9TrHt7Bm0rRBQe1+fHUWNfaapU0KbqxzbORC1M/LS3dJwIl3KOrwykQG/E+61q+isgniztdOKqNOziDgZqZIzFwPvqGiyg5NCtoCqoG5NxHhPZTOsnORulKskjoKMDeLuXQ3OmnC3syxARFXdfc57LR3OrdtrvSOOs55rnqhtcdoGhpxHdjc5EfJUuHZTlftX+G15rXPlhkrnLe59F7Lz8VGHdg8c5y2OLeMZ126qduq9XC3v7nd+FchLvYPJd15gPCu8XQnh/qpm59WGVudZzvvQO97kXTcGxhnEuJvR39tWY8cwK4uhcikk4a3Gdstg9l5B2t0wfaTdWkEou5vCPOV5PH73vFL3+DfXltnh6OxjkJD6Wd5F3g88tMe6CW/7YmI99VIL4u0oqUK8ocW4d8hFrXMVoOQU8s3U97MnjvDD/XRYkyhHM1MT3GVZQR2Tdv70U8EbA5vlo+CaPAaaSWoZXm50otGodxQ6L6txGKxzw5ZYORrBsPPrykZKQIy1n8bTjwb2fO4Te3ue7x6KOKvaYns1wtIddd4nx3mwot55qyl2360cp81zurg+CGqwU8v4/Of5uAVvPgObrwvHomY8jOtZ4fXWLnefdHVXv9044+8ZklCx75DXwcV1Sb27y+vInUQEuVYSaMgRJYfAwtoj0raFxIUW1A8nz35f02qLc9Lc9lG7CBkwtUR7bf+A+5uL6ehnH9Lat+5sIEfj3Cbj3NKRvP7Rjlo7FSmqavKvpSP8MRZ7NVbQYLSkqlC9ZW4sPH18gBTcORjrhMWmQWzFmK2UsvO90qQ1oZcI8UhkCLZPtRqMy0NirobAvjIpb4/sW06qKGyPR2oGIdlazjOOTk+kLYzaaYGSp63Wz6HsXsQ51wd+LTAuZOy+8GBNq7tF+IOdDU4kENJthNID5YRafZtzZ3mDs9LbRgzixcZ2l1h83OKFbDmEd0/FiFp7DWHgp0AQGzq6nf8hPF+oa3EehOz0ziCWcm4NpBRMhX1hn571oR9wqVVSDVPtUi32sQ0vbu7scZdY9aOt2ZSEL9BEBIW+dv20AKDd9/ep09oimYqHpyImkKDuRllS4PrlHNuIqDmCJmNJQba7q1joEaUQJuR/WdXsLrJrq/L6cdJsPOyXscJ7GLKqo8cOpqhrO//yQG6oS3kZwS9xPkRB3wi7diFMtDN+PLk5m1ath+8f0Fy80dbjhvVXub+U5mEqeal27UP+dWpPlknNxW79Ak6/7Tg3UMOF52j1xA1qK7Trd6nXC+8P9ttYQcumIonLSnJtBdJNa77axw1C2x3qR4Wqnj73x9f6MbV+CCYFBZO6y51aSh3gzVrsmwzJnULEbCJC1oZ7vIZ/9Iqmfvn2u5oWO5n8fApxcuWUApum5diPgY9lrA9EtvUNOzYf8vqAcJPsU5iOh7XtXQgt2uZhjKU2amF7HQyfEYWcZk5yQ1RDKNrLcq02k/9IGmldrB93KiokPw8EB2SsoKWXO5FmxXhlckqi+3vEUvLqwok5PHVkIWAszlqzy1p54zuLpnPZ3q9bod08JlLSb5DrNxDm38Sbvsg5EBywsT7oH+3XNW3uasGirFSrxRNdCllKiPZHZzJYLZb5qEcpae3pxMCuu9oibS5/QCOiLcYUrp+MmtJeURjFdVlxzqiae6D4h40NQt54HyGv3JRo10aVfv8YhtC0pSlVKcPFuxIXahr08mzCO4VzMlLSsZuomZ+RaucU0rXsw/sfF5+osUFonWob/7TrLdaUgdpV93fl9X+VIC0Y6tek2uI8OD3J5gT2Vj9ZmP0f4IM4iY7RQ5gAAAAASUVORK5CYII=) no-repeat 50%;background-size:64px 64px;opacity:.84}.markdown-body h1:after{position:absolute;content:"";width:150%;left:-25%;height:50%;bottom:12px;border-radius:50%;background:linear-gradient(transparent 80%,rgba(77,208,225,.8));background-size:400% 200%;opacity:.6;animation:h1Animate 6s linear infinite}@keyframes h1Animate{0%{background-position:100% 100%}50%{background-position:100% 50%}to{background-position:100% 100%}}.markdown-body h2{display:block;border-bottom:4px solid #4dd0e1;position:relative;font-size:24px;padding:12px 32px;margin:30px 0}.markdown-body h2:before{width:24px;height:24px;left:0;top:0;margin:auto;background-size:24px 24px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAADGklEQVRYR81X32vTYBQ999s6mFjQgQ+DrbHiVFZYU4cDcQ/6pGhTFVYFEXGi82H+Bz448UnEF1Fx9ccEEcXpZE3d5tP2ooKiTacTHaLNpigMHDgnU9tcSbrWrkwWR0sbyEOSe885ObnfvV8IRT6oyPwoLQHBx+OVM5WJvSyEVAhnBOjt7yU/+/rr6r6l8TMO+F/EN0JQhICqQpD/xaRpcpAc9tS+M+9lBCia/oqBamK+zeDuQogQZaKJk3wcQjxSva7tGQGB2Ke1zIk3DNyMyNL+QpCnMQOaPsDAVuGAp9cjvbYc8Ec/bCYSg0zoiHilk1tHxqsqEsYlML4kjIpT/eurJxRNPweQU5VdrWaOEo1fgKAVbBgXIz73kF3R/ph+ghgdzMYWM29eAWlBJqgZaFlFYtC6nhWpaDqnSGlIlV1WjJ3DloDNgyNLncudqgX//Ucg3LxuStHGuhi8pqKCW3rqV342rwFjRznKm+/LNaN2yC237ThgF2wxcfMLeP6+ncrKzoPoKTGeLQbYbg4TNoC5iZPJY5HGVRdSNZAWYBclD3FzBQzrR8hACAKdzBzKA/4/IYioDQaOskBbpEG6PO8qKKSAEi3CnEb0Pw4oMf0OmKbTDWqh3Lw6EIiNBZi5lxh3wz4puBD5ovqAMvxhHSdFKxE1CQe3m/07TeTX4lcJdAhE+1Sv65Z5P/ByvIGTRowIZ9igbtXnmrOsbTvgj+kHBNMuBu9OdVw8EeU4nC1A0cYmAHZOTRrLhra4Z8ywnSN6vZHAFTA2WnnMfQB3qz73ddsOZM8CACFDIPSgQXqebXEgqgeZcAeEe6pXasm1f8ew3igMtAHWac0Uc/jYdyAaP0xEBwFsmgUPqbJ0NE2UKj4EGcahiOzuyhagaHpnmtgcVgTcCMuua7YdyAHbA3ArQNscVFbb4635aD6fnYaTvxxi9UNP7ddMXaRWVBdAcaLk6bDXPZCNZ9uBXEsDUX1T2Cc9yjig6Z0EHg3LK8/aqf6MwJKchkXfks1+0+JtSq3qLPa23BRR1B+T/6nkfMaW1r9hPt/MLtYfTLEpP+T9FNoAAAAASUVORK5CYII=)}.markdown-body h2:after,.markdown-body h2:before{content:"";display:block;position:absolute;bottom:0}.markdown-body h2:after{right:0;width:400px;height:10px;border-top-right-radius:24px;background:linear-gradient(90deg,#fff,#4dd0e1);max-width:50vw}.markdown-body h3{margin:30px 0;font-size:18px;position:relative;padding:4px 32px;width:max-content}.markdown-body h3:before{border-bottom:2px solid #4dd0e1;width:100%;content:"";display:block;height:28px;position:absolute;left:0;top:0;bottom:-2px;margin:auto;background-size:28px 28px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABRklEQVRYR2NkGGDAOMD2M4w6YDQERkNg+ITAppcfY/8zMv3wF+NdTUrZQpUQ2PT6cz8Dw/8CkMWMDIwNvqK8jcQ6gmIHNN19EaXPx1XPyMCghrCUKcpPlGc5MY6gyAE+Fx52MjL8j3cU5a1UYWXtZGBkEAVb+p8hxU+Mby5NHQCxnKEMaskzJ37uFmUetkmMjAzrfUX4woixHBJlZAA0y2EmPPYU4enLkhGeQIqRJDsAh+UgO7duNpD3IcVykkOA2paT5ABaWE60A2hlOdEO8D3/4CMDIyMfWvySFefoaYSoROh74eFXBgYGLiTNVLGc+BC48PAnAwMDG9QBVLOcaAd8P5ox+x/jf5AjGLgYfnwnKqv9/8/PwPO/kFF/MSj0cAKiouD/0bgYoixFU8RovWgJIX1EOYCQIZTIjzpgNARGQ2DAQwAAvHBaIdB7zxsAAAAASUVORK5CYII=);background-repeat:no-repeat;animation:h3AnimationBefore 2s infinite alternate}@keyframes h3AnimationBefore{0%{width:28px}25%{width:100%}50%{width:100%}to{width:100%}}.markdown-body h3:after{content:"";display:block;width:28px;height:28px;position:absolute;border:2px solid #4dd0e1;border-radius:50%;right:-15px;top:0;bottom:0;margin:auto;background-size:28px 28px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABRklEQVRYR2NkGGDAOMD2M4w6YDQERkNg+ITAppcfY/8zMv3wF+NdTUrZQpUQ2PT6cz8Dw/8CkMWMDIwNvqK8jcQ6gmIHNN19EaXPx1XPyMCghrCUKcpPlGc5MY6gyAE+Fx52MjL8j3cU5a1UYWXtZGBkEAVb+p8hxU+Mby5NHQCxnKEMaskzJ37uFmUetkmMjAzrfUX4woixHBJlZAA0y2EmPPYU4enLkhGeQIqRJDsAh+UgO7duNpD3IcVykkOA2paT5ABaWE60A2hlOdEO8D3/4CMDIyMfWvySFefoaYSoROh74eFXBgYGLiTNVLGc+BC48PAnAwMDG9QBVLOcaAd8P5ox+x/jf5AjGLgYfnwnKqv9/8/PwPO/kFF/MSj0cAKiouD/0bgYoixFU8RovWgJIX1EOYCQIZTIjzpgNARGQ2DAQwAAvHBaIdB7zxsAAAAASUVORK5CYII=);animation:h3AnimationAfter 2s infinite alternate}@keyframes h3AnimationAfter{0%{transform:rotate(0)}10%{transform:rotate(0)}50%{transform:rotate(-1turn)}to{transform:rotate(-1turn)}}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:15px}.markdown-body h6{margin-top:5px}.markdown-body p{line-height:inherit;margin:22px 0;letter-spacing:2px;font-size:14px;word-spacing:2px}.markdown-body img{max-width:80%;border-radius:6px;display:block;margin:20px auto!important;object-fit:contain;box-shadow:0 0 16px hsla(0,0%,43.1%,.45)}.markdown-body figcaption{display:block;font-size:13px;color:#2b2b2b}.markdown-body figcaption:before{content:"";background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgBAMAAACBVGfHAAAAGFBMVEVHcExAuPtAuPpAuPtAuPpAuPtAvPxAuPokzOX5AAAAB3RSTlMAkDLqNegkoiUM7wAAAGBJREFUKM9jYBhcgMkBTUDVBE1BeDGqEtXychNUBeXlKEqACsrLQxB8lnCQQClCiWt5OYoSiAIkJVAF5eVBqAqAShTAAs7l5ShKWMwRAmAlSArASpAVgJUkCqIAscESHwCVVjMBK9JnbQAAAABJRU5ErkJggg==);display:inline-block;width:18px;height:18px;background-size:18px;background-repeat:no-repeat;background-position:50%;margin-right:5px;margin-bottom:-5px}.markdown-body hr{border:none;border-top:1px solid #4dd0e1;margin-top:32px;margin-bottom:32px}.markdown-body del{color:#4dd0e1}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:rgba(77,208,225,.08);color:#26c6da;padding:.195em .4em}.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace;overflow:auto;position:relative;line-height:1.75;box-shadow:0 0 8px hsla(0,0%,43.1%,.45);border-radius:4px;margin:16px}.markdown-body pre:before{content:"";display:block;height:30px;width:100%;margin-bottom:-7px;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAAAdCAYAAABcz8ldAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAhgSURBVGhD7Zp7bBTHHcdn33t7vvOdzy+ITVKDU0xIKG2ABCPTRCCaUiEVKWoqRJuASAhCitRCVKSoalFUKZBiSmmFRRJKRUnUtIpo+aNqGgwoOCmuFUIRzxjwE4zte+97drYzztji8HPvtkit/PnH+n1397Tz+83vN/PbMZhmmmmm+d+BoX8n5diihcGqgFQf5vk6BMAskWUlw3GyFnIvtqWSf91w7mKC3npfOLX7wYeiIa6BBWCOLLFRF2NB0JvIOP/80YG+k2ev6S699b/OzOfKBW5l5KsgyC4DCFQDnpEAdE1goc/dlNPc/Up7P711UiYNSMuyxeUzZPnHgGHWh5XADEkSAcdiN+AnEXIBhBComgFU0/xQR+jnj51sOUMf9Z0NKyL8S9+JPBEN8zuCMrsqGOA5QWAAyzLAxe53HBeYFgJp1c5Cx33nyIfpV3e+22/Sx32nev/sMCgVnmM4bjOniAtZWQAsz315EfsGQQc4hgWcjHkCmOj1rheuNn95cXwmDMiVp5etC/D8m5FwUWVQUYYGPh6mZYFUOgsGVa1pXvOZzVT2jRuH54RM230jEuI3RcIiL4l4UkxAJmuD/riVsqD7ct2m9nep7BtVTbVfZ0uE/UIk+CQflAHDjf8+Lg6MldYATGpH3c/Ul7p3dWXppVGM6eElJSHmnQWPbSlRlN1lJcUBjqNRnwJZVQO3B5P/uq5rK1d90pakckFcaKp5UJHY92JR8YlwkUDVySEZfGfQdO7E7Z8s2HL9TSoXTPXRud9nA8IBqSwcZgWeqpPj6BYw7yTbXBN9q2v9lQEq5zBmWA8vWLCptCi4tzwW8RQMQlFQATPLSh6vCSh/plJBkMyQBHZfWYnkKRgEktEVpTJXERN2Xzo4ex2VC6K6qXYpF5b3ypVRT8EgcAERSJXRbwCBOTFzXblM5RxGBaRt+ZPYA+LO0mgxz5K1Ig+UgAzKIuGnz39z6S+olDeaibaXRsU1RUFvgx+GwTWgPCaDgMw2XXpr9gwq50XV0bkxJiYeEiNF5cwE5XsiOEkAUkXkUW51SSOVchjl8WKef604XFSRbzCGCYeCoESStv/p8QU1VPIM3knNDynctnBRfsEYhgSlNCIGgQv2UCkvGIHZgteMh1nBW9W4F16RAM6yDVV7amZTaYQcr59cuuhhWRTWBvAMLxQGeyFSHOLnh0MvUskz5RF+fbRYDEy0mZgqQYUHOLhr//b6rGoqeaLqQG0pw3PrBbyA+4EQUkRmhvgqNUfICUipKK4OKUqIJVPKB0jpEhjmWWp64jdbKmVZZNYogcJm493gsifOqhDyeh9GYR/FM7sW+DA5CKR0MSK3tvKZkpwB5gRE4tjFEr7RL0iWBGV51vHFCyupNGWWPqLgnoer9mtyEGSJAzwLllDTGzyznDjRN/CwOFkoFb4bm0eVIXICgpvdGoEvrF7fC89zfLkkeV5HbOhWiTwTpKYvCAJLGshRdXtKMKAWlyxq+MPQLk1h66g5RE5ABJYNFrqY3wvJklJRUKg5ZWLFXIA86yek2uDOPkBNb3CM5Pf7DL2QyIrUGiLH+xC5Bmmm/ARnHUhC6PnzxWDK0RH5HuIjZGy27erU9AZ0dTIWXyG+NpBBrSFySxZw220IqeUPFoS6jVAPNadM7yDsgNB1qOkLuAziMYIb1PQGA75wIaKGPyAb+9oF16g5RE5ALIQ+tSyLWoWDEAK6aXW3JlK9VJoyx1oyvVkNdvo5KXXDAVkdnaKmNwx0xjH98w3JNmTCm+Bc9hKVhsgJSI9pvp9Vdd++jmq6AXB2/HHrhcs5aTkVDv0DFzoHvKdq/mQsKX/4t7KJLDpOJW+IbAvMGoMkxfwAWZB8DT7W1diTE+WcgKz6pK1bs6z3daPwmJDsSKt6ZsCyjlLJMz0DsDGZ8SdlDROBjOb8YeWOjptU8kTXusuaazu7oJrfEnQvdkpVcUn6PTVHyAkIIW7br/Unklni0EJIZ1WgGsauZR+fvUglz6zY0dGfVp09ybRNlfwgi3k8YSbvJJ29VMoLt9v6rZVQL7hOYUubndHJGclBtzn1byqNMCogi09/2nFb01/oj+f/5TyjauBOKtPcZ1r7qZQ3f2lRfxZPWi2anp8TSDAGExZMa2jr8u03L1M5L7q3Xc+iAeuHRl/ScvPcjSLDBnZS/cjtNHd2v3171Ewbs9N5q7Pn4otVMx3btBsCsoRbk1FxG5dMVgMDqfTpXl1/tuFMa5zKefPROdX59qLQBwLnNog8Wy1OcjB1N+QEsW/QsFNZuO35Xb1v98QLX4/Sx+O3wqujrQ6013ABUWI8+AaqBjAH01+ghL22+5X2PirnMG7r+esbnae/V1neauvGSoHjigTcVU7UGFm2DeK4ttxKpQ+mLPvl+o/PjnkAkw9HTqSMmVHhyAMx9iFcSh/BHTfLceO/C8mKjApBf9zszGhoY92m9sN+BGOY9AeD7eGniv8OTaOB4dgyTsQd9wS+IQu4lciYdkI7CLrNH3Rvbb9FL41i0tbzVP2iWJkobpN5fmM4IJfJskTP1Bk8A9HQmbpmGDBrWqdVCN/Yd7PjxKGOXn+bmbto3feVVcVB9qehIL8EJy8nChwgr0O2xxBnhGU5eP2CfYbl/m4gBRsbtneMORP9oGpjpcCsiKzHHfdOPiQ/wMniyFEu2dbiTQCAeN/vavC466BGYLttXc9fmXBXMGlAhiHHur+sq6uPiUI9z7CVHMPwBnLSuuN8FuC48/Oaz1ylt94XfrW5ouyprwWfYRkwNyCyYYjwkBHows1fa+tV/fzGxlv39b9gqvfPmQ+i/HK8KlcBjhHwfl8HEHyOd1JnuzZd66S3TTPNNNP8/wDAfwDG7G0m9LKBpwAAAABJRU5ErkJggg==) 10px 10px no-repeat;background-size:40px}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{color:#4dd0e1;border-bottom:1px solid #4dd0e1;font-weight:400;text-decoration:none;margin:0 4px}.markdown-body a:active,.markdown-body a:hover{background-color:rgba(77,208,225,.1)}.markdown-body strong{color:#26c6da}.markdown-body strong:before{content:"「"}.markdown-body strong:after{content:"」"}.markdown-body em{font-style:normal;color:#4dd0e1;font-weight:700}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:rgba(77,208,225,.05)}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{margin:2em 0;padding:24px 32px;border-left:4px solid #26c6da;background:rgba(77,208,225,.15);position:relative}.markdown-body blockquote:before{content:"❝";top:8px;left:8px;color:#4dd0e1;font-size:30px;line-height:1;font-weight:700;position:absolute;opacity:.7}.markdown-body blockquote:after{content:"❞";font-size:30px;position:absolute;right:8px;bottom:0;color:#4dd0e1;opacity:.7}.markdown-body blockquote p{color:#595959;line-height:2}.markdown-body ol,.markdown-body ul{color:#595959;padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="androidstudio">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#a9b7c6;background:#282b2e}.hljs-bullet,.hljs-literal,.hljs-number,.hljs-symbol{color:#6897bb}.hljs-deletion,.hljs-keyword,.hljs-selector-tag{color:#cc7832}.hljs-link,.hljs-template-variable,.hljs-variable{color:#629755}.hljs-comment,.hljs-quote{color:grey}.hljs-meta{color:#bbb529}.hljs-addition,.hljs-attribute,.hljs-string{color:#6a8759}.hljs-section,.hljs-title,.hljs-type{color:#ffc66d}.hljs-name,.hljs-selector-class,.hljs-selector-id{color:#e8bf6a}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><code>jsconfig.json</code>是一个配置文件，它的核心作用是告诉 Visual Studio Code（VSCode）当前目录是一个 <strong>JavaScript 项目的根目录</strong>，从而为你的代码提供更强大的智能感知（IntelliSense）和语言支持。</p>
<p>下面这个表格概括了它的主要作用：</p>






























<table><thead><tr><th>核心作用</th><th>解决的问题</th><th>简单示例</th></tr></thead><tbody><tr><td><strong>定义项目上下文</strong>​</td><td>没有它时，VSCode 将每个 JS 文件视为独立单元，文件间缺乏关联性。有了它，VSCode 能将整个项目作为一个整体理解。</td><td><code>{}</code>(一个空文件即可定义项目)</td></tr><tr><td><strong>配置路径别名映射</strong>​</td><td>当项目使用像 <code>@</code>这样的别名来代表 <code>src</code>目录时，VSCode 默认无法识别。配置后，可以实现<strong>路径的自动补全和点击跳转</strong>。</td><td><code>"paths": { "@/*": ["src/*"] }</code></td></tr><tr><td><strong>提升 IDE 性能</strong>​</td><td>通过排除不必要的文件（如 <code>node_modules</code>, <code>dist</code>），让语言服务专注于源代码，<strong>避免 IntelliSense 变慢</strong>。</td><td><code>"exclude": ["node_modules", "dist"]</code></td></tr><tr><td><strong>调整语言服务选项</strong>​</td><td>配置 JavaScript 的语言检查标准，例如启用实验性语法支持（如装饰器）或指定 ECMAScript 目标版本。</td><td><code>"experimentalDecorators": true</code></td></tr></tbody></table>
<h3 data-id="heading-0">💡 详细解读与配置</h3>
<ul>
<li>
<p><strong>定义项目上下文</strong>：在没有 <code>jsconfig.json</code>的“文件范围（File Scope）”模式下，VSCode 虽然能为单个文件提供基础语法高亮，但难以准确分析文件之间的模块引用关系。创建 <code>jsconfig.json</code>后，项目进入“显式项目（Explicit Project）”模式，VSCode 的语言服务能理解项目的整体结构，从而提供更精确的代码补全、类型推断和错误检查。</p>
</li>
<li>
<p><strong>配置路径映射（Paths Mapping）</strong> ：这是在前端项目中非常实用的功能。许多项目使用 Webpack 或 Vite 等构建工具配置了路径别名，但在代码编辑器中，这些别名默认无法被识别。通过在 <code>jsconfig.json</code>中配置 <code>paths</code>，即可让 VSCode 理解这些别名。</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"compilerOptions"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"baseUrl"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"./"</span><span class="hljs-punctuation">,</span> <span class="hljs-comment">// 设置基础目录</span>
    <span class="hljs-attr">"paths"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"@/*"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"src/*"</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>    <span class="hljs-comment">// 将 @ 映射到 src 目录</span>
      <span class="hljs-attr">"components/*"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"src/components/*"</span><span class="hljs-punctuation">]</span> <span class="hljs-comment">// 配置其他别名</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>配置后，当你输入 <code>import App from '@/App'</code>，VSCode 就能知道 <code>@</code>指向 <code>src</code>目录，并提供自动补全和跳转功能。</p>
</li>
<li>
<p><strong>优化性能（Exclude）</strong> ：JavaScript 语言服务会分析项目中的文件来提供 IntelliSense。如果它去解析庞大的 <code>node_modules</code>或构建输出的 <code>dist</code>目录，会严重拖慢速度。使用 <code>exclude</code>属性可以告诉语言服务忽略这些目录。</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"exclude"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"node_modules"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"dist"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"build"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"*.min.js"</span><span class="hljs-punctuation">]</span>
<span class="hljs-punctuation">}</span>
</code></pre>
</li>
</ul>
<h3 data-id="heading-1">🛠️ 创建与配置示例</h3>
<p>你可以在项目的根目录下创建一个名为 <code>jsconfig.json</code>的文件。一个适用于现代前端项目（如 Vue、React）的常见配置如下：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"compilerOptions"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"target"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"ESNext"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"module"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"ESNext"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"moduleResolution"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"node"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"baseUrl"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"./"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"paths"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"@/*"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"src/*"</span><span class="hljs-punctuation">]</span>
    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"allowSyntheticDefaultImports"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"experimentalDecorators"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"lib"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"esnext"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"dom"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"dom.iterable"</span><span class="hljs-punctuation">]</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"include"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"src/**/*"</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"exclude"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"node_modules"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"dist"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"build"</span><span class="hljs-punctuation">]</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p><strong>配置项说明</strong>：</p>
<ul>
<li><code>compilerOptions</code>：虽然名字叫“编译选项”，但它主要用于配置 VSCode 的 JavaScript 语言服务行为，因为 <code>jsconfig.json</code>源自 TypeScript 的 <code>tsconfig.json</code>。</li>
<li><code>include</code>：明确指定哪些文件属于项目。如果未设置，则默认包含所有子目录下的文件。</li>
<li><code>exclude</code>：指定要排除的文件和文件夹。</li>
</ul>
<h3 data-id="heading-2">💎 总结</h3>
<p>总而言之，<code>jsconfig.json</code>就像是你在 VSCode 中的<strong>项目地图和说明书</strong>。它通过定义项目根目录、映射路径别名、排除无关文件等方式，显著提升了代码编辑的智能体验、导航效率和整体性能。对于任何有一定规模的 JavaScript/TypeScript 项目，配置一个 <code>jsconfig.json</code>都是非常值得的。</p>
<p>希望这些信息能帮助你更好地理解和使用 <code>jsconfig.json</code>。如果你在配置过程中遇到具体问题，例如如何为特定框架进行优化，我很乐意提供进一步的帮助。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[告别代码屎山！UniApp + Vue3 自动化规范：ESLint 9+ 扁平化配置全指南]]></title>    <link>https://juejin.cn/post/7585463195201126450</link>    <guid>https://juejin.cn/post/7585463195201126450</guid>    <pubDate>2025-12-20T06:40:20.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585463195201126450" data-draft-id="7585446706327076873" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="告别代码屎山！UniApp + Vue3 自动化规范：ESLint 9+ 扁平化配置全指南"/> <meta itemprop="keywords" content="JavaScript,Vue.js"/> <meta itemprop="datePublished" content="2025-12-20T06:40:20.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="幼儿园老大"/> <meta itemprop="url" content="https://juejin.cn/user/1574156383555415"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            告别代码屎山！UniApp + Vue3 自动化规范：ESLint 9+ 扁平化配置全指南
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1574156383555415/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    幼儿园老大
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-20T06:40:20.000Z" title="Sat Dec 20 2025 06:40:20 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    12
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>配置初衷是为了保证，团队开发中的代码规范问题。
以下是全部配置过程，我的项目是npm创建的，并非hbuilder创建的。如果你的项目的hbuilder创建的，需要执行下 <code>npm init -y</code>。</p>
<p>配置后想要达到的效果：</p>
<ul>
<li>保证缩进统一性</li>
<li>vue组件多个属性可以自动换行。</li>
<li>在代码里用了 <code>uni.showToast</code>，ESLint 却疯狂报错 <code>uni is not defined</code>。</li>
</ul>
<p>2025 年，ESLint 迎来了史上最大变革——<strong>Flat Config（扁平化配置）</strong>  时代。今天，我们就用一套最硬核的方案，把 <strong>Vue3、TypeScript、SCSS</strong> 和 <strong>Git 自动化</strong> 全部打通！</p>
<h2 data-id="heading-0">一、 为什么 2025 年要用 ESLint 9+ ？</h2>
<p>传统的 <code>.eslintrc.js</code> 采用的是“层级继承”逻辑，配置多了就像迷宫。而 <strong>ESLint 9+ 的 Flat Config (<code>eslint.config.mjs</code>)</strong>  采用纯 JavaScript 数组对象，逻辑更扁平、加载更快速、对 ESM 原生支持更好。</p>
<h2 data-id="heading-1">二、 核心依赖安装：一步到位</h2>
<p>首先，清理掉项目里的旧配置文件，然后在根目录执行这行“全家桶”安装命令：</p>
<pre><code class="hljs language-bash" lang="bash">npm install eslint @eslint/js typescript-eslint eslint-plugin-vue globals eslint-config-prettier eslint-plugin-prettier prettier husky lint-staged --save-dev
</code></pre>
<h2 data-id="heading-2">三、 配置实战：三剑客齐聚</h2>
<ol>
<li>魔法启动：生成 ESLint 9 配置文件</li>
</ol>
<p>新版 ESLint 推荐通过交互式命令生成基础框架，但针对 UniApp，我们建议直接创建 <code>eslint.config.mjs</code> 以获得极致控制力。</p>
<p><strong>核心逻辑：</strong></p>
<ul>
<li><strong>2 空格缩进</strong>：强迫症的福音。</li>
<li><strong>属性换行</strong>：组件属性 &gt; 3 个自动起新行。</li>
<li><strong>多语言全开</strong>：JS / TS / Vue / CSS / SCSS 完美兼容。</li>
</ul>
<pre><code class="hljs language-php" lang="php"><span class="hljs-comment">/* eslint.config.mjs */</span>
import js <span class="hljs-keyword">from</span> <span class="hljs-string">'@eslint/js'</span>;
import tseslint <span class="hljs-keyword">from</span> <span class="hljs-string">'typescript-eslint'</span>;
import pluginVue <span class="hljs-keyword">from</span> <span class="hljs-string">'eslint-plugin-vue'</span>;
import pluginPrettierRecommended <span class="hljs-keyword">from</span> <span class="hljs-string">'eslint-plugin-prettier/recommended'</span>;
import globals <span class="hljs-keyword">from</span> <span class="hljs-string">'globals'</span>;

export <span class="hljs-keyword">default</span> tseslint.<span class="hljs-title function_ invoke__">config</span>(
  // 【<span class="hljs-number">1</span>】配置忽略名单：不检查编译后的代码
  { <span class="hljs-attr">ignores</span>: [<span class="hljs-string">'dist/**'</span>, <span class="hljs-string">'unpackage/**'</span>, <span class="hljs-string">'node_modules/**'</span>, <span class="hljs-string">'static/**'</span>] },

  // 【<span class="hljs-number">2</span>】JS 基础规则 &amp; UniApp 全局变量支持
  js.configs.recommended,
  {
    <span class="hljs-attr">languageOptions</span>: {
      <span class="hljs-attr">ecmaVersion</span>: <span class="hljs-string">'latest'</span>,
      <span class="hljs-attr">sourceType</span>: <span class="hljs-string">'module'</span>,
      <span class="hljs-attr">globals</span>: {
        ...globals.browser, ...globals.node,
        <span class="hljs-attr">uni</span>: <span class="hljs-string">'readonly'</span>, <span class="hljs-attr">wx</span>: <span class="hljs-string">'readonly'</span>, <span class="hljs-attr">plus</span>: <span class="hljs-string">'readonly'</span> // 解决 uni 报错
      },
    },
  },

  // 【<span class="hljs-number">3</span>】TypeScript 强类型支持
  ...tseslint.configs.recommended,

  // 【<span class="hljs-number">4</span>】Vue <span class="hljs-number">3</span> 核心规范（属性换行策略）
  ...pluginVue.configs[<span class="hljs-string">'flat/recommended'</span>],
  {
    <span class="hljs-attr">files</span>: [<span class="hljs-string">'**/*.vue'</span>],
    <span class="hljs-attr">languageOptions</span>: {
      <span class="hljs-attr">parserOptions</span>: { <span class="hljs-attr">parser</span>: tseslint.parser } // Vue 模板内支持 TS
    },
    <span class="hljs-attr">rules</span>: {
      <span class="hljs-string">'vue/multi-word-component-names'</span>: <span class="hljs-string">'off'</span>, // 适配 UniApp 页面名
      <span class="hljs-string">'vue/html-indent'</span>: [<span class="hljs-string">'error'</span>, <span class="hljs-number">2</span>],         // 模板强制 <span class="hljs-number">2</span> 空格
      <span class="hljs-string">'vue/max-attributes-per-line'</span>: [<span class="hljs-string">'error'</span>, {
        <span class="hljs-attr">singleline</span>: { <span class="hljs-attr">max</span>: <span class="hljs-number">3</span> }, // 超过 <span class="hljs-number">3</span> 个属性就换行
        <span class="hljs-attr">multiline</span>: { <span class="hljs-attr">max</span>: <span class="hljs-number">1</span> }   // 多行模式下每行只能有一个属性
      }],
      <span class="hljs-string">'vue/first-attribute-linebreak'</span>: [<span class="hljs-string">'error'</span>, {
        <span class="hljs-attr">singleline</span>: <span class="hljs-string">'beside'</span>, <span class="hljs-attr">multiline</span>: <span class="hljs-string">'below'</span>
      }]
    }
  },

  // 【<span class="hljs-number">5</span>】Prettier 冲突处理：必须放在数组最后一行！
  pluginPrettierRecommended,
);
</code></pre>
<ol start="2">
<li>视觉统领：<code>.prettierrc</code></li>
</ol>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"semi"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">false</span></span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"singleQuote"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"tabWidth"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">2</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"useTabs"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">false</span></span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"printWidth"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">100</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"trailingComma"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"all"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"endOfLine"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"auto"</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<ol start="3">
<li>编辑器底层逻辑：<code>.editorconfig</code></li>
</ol>
<p>让 IDEA 和 VS Code 在你打字的第一秒就明白：缩进只要两个空格。</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">root</span> = <span class="hljs-literal">true</span>
<span class="hljs-section">[*]</span>
<span class="hljs-attr">indent_style</span> = space
<span class="hljs-attr">indent_size</span> = <span class="hljs-number">2</span>
<span class="hljs-attr">end_of_line</span> = lf
<span class="hljs-attr">insert_final_newline</span> = <span class="hljs-literal">true</span>
</code></pre>
<p>四、 极速体验：让工具为你打工</p>
<ol>
<li>IDEA / WebStorm 深度联动</li>
</ol>
<p>别再手动敲 <code>Ctrl+Alt+L</code> 了！</p>
<ul>
<li>进入 <strong>Settings -&gt; ESLint</strong>，勾选 <strong>Run eslint --fix on save</strong>。</li>
<li>进入 <strong>Settings -&gt; Prettier</strong>，勾选 <strong>Run on save</strong>。<br/>
<em>IDEA 2024+ 会完美识别你的 <code>eslint.config.mjs</code>。</em></li>
</ul>
<ol start="2">
<li>Git 提交自动“洗地” (Husky + lint-staged)</li>
</ol>
<p>想要代码仓库永远干干净净？在 <code>package.json</code> 中加入这道闸门：</p>
<p>json</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-attr">"lint-staged"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"*.{js,ts,vue}"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"eslint --fix"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"prettier --write"</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"*.{css,scss,json,md}"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"prettier --write"</span><span class="hljs-punctuation">]</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>执行 <code>npx husky init</code> 并将 <code>.husky/pre-commit</code> 改为 <code>npx lint-staged</code>。现在，任何不符合规则的代码都别想溜进 Git 仓库！</p>
<h2 data-id="heading-3">五、 结语</h2>
<p>规范不是为了限制自由，而是为了让开发者在 2025 年繁重的业务中，能拥有一份优雅的代码底座。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[RAG实战|8种RAG架构浅析]]></title>    <link>https://juejin.cn/post/7585390679399333894</link>    <guid>https://juejin.cn/post/7585390679399333894</guid>    <pubDate>2025-12-20T07:02:08.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585390679399333894" data-draft-id="7585382553290686500" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="RAG实战|8种RAG架构浅析"/> <meta itemprop="keywords" content="AIGC,LangChain"/> <meta itemprop="datePublished" content="2025-12-20T07:02:08.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="周末程序猿"/> <meta itemprop="url" content="https://juejin.cn/user/3245414056989757"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            RAG实战|8种RAG架构浅析
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3245414056989757/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    周末程序猿
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-20T07:02:08.000Z" title="Sat Dec 20 2025 07:02:08 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读21分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>因为项目的需要，之前研究了一段时间的<code>RAG</code>，于是本文总结 8 种 <code>RAG</code> 架构，对每种架构进行简要介绍，并用 <code>langchain</code> 实现其参考代码。</p>
<h2 data-id="heading-0">1. Naive RAG</h2>
<p><strong>简介：</strong></p>
<p>Naive RAG 是最基础的检索增强生成架构，采用“索引-检索-生成”的经典流程。<strong>架构：</strong></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a791bbe7f4524e51b74053ad63de110f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZGo5pyr56iL5bqP54y_:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766818928&amp;x-signature=ku0AJbn3D7xRqqygvjDvDp5jEfs%3D" alt="图片" loading="lazy"/></p>
<p><strong>实现步骤：</strong></p>
<ul>
<li>数据加载 ：收集数据并进行清洗，比如各个文档格式的转换，OCR 文字提取等</li>
<li>分块和 embedding ：将文档拆分更小的 chunk，一方面让 embedding 更好转换语义信息，另一方面解决LLM的上下文长度限制问题</li>
<li>向量存储：将 embedding 存储到向量数据库中，方便快速搜索</li>
<li>search 和 Prompt工程：对于查找的问题先通过向量数据库检索，然后将召回的文件原文，通过 Prompt 加工提供给LLM</li>
<li>输出答案：LLM 根据 Prompt 生成答案输出</li>
</ul>
<p><strong>参考代码：</strong></p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> langchain_openai <span class="hljs-keyword">import</span> ChatOpenAI
<span class="hljs-keyword">from</span> langchain_huggingface <span class="hljs-keyword">import</span> HuggingFaceEmbeddings
<span class="hljs-keyword">from</span> langchain_community.vectorstores <span class="hljs-keyword">import</span> LanceDB
<span class="hljs-keyword">from</span> langchain.schema <span class="hljs-keyword">import</span> Document
<span class="hljs-keyword">from</span> langchain.chains <span class="hljs-keyword">import</span> RetrievalQA
<span class="hljs-keyword">from</span> langchain.prompts <span class="hljs-keyword">import</span> PromptTemplate
<span class="hljs-keyword">import</span> lancedb

<span class="hljs-keyword">class</span> <span class="hljs-title class_">NaiveRAG</span>:
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self</span>):
        self.llm = ChatOpenAI(model=<span class="hljs-string">"gpt-5"</span>, temperature=<span class="hljs-number">0</span>)
        <span class="hljs-comment"># 使用轻量级的all-MiniLM-L6-v2模型，仅80MB</span>
        self.embeddings = HuggingFaceEmbeddings(
            model_name=<span class="hljs-string">"sentence-transformers/all-MiniLM-L6-v2"</span>,
            model_kwargs={<span class="hljs-string">"device"</span>: <span class="hljs-string">"cpu"</span>},
            encode_kwargs={<span class="hljs-string">"normalize_embeddings"</span>: <span class="hljs-literal">True</span>}
        )
        self.db = lancedb.connect(<span class="hljs-string">"/tmp/lancedb_naive_rag"</span>)
        self.vectorstore = <span class="hljs-literal">None</span>
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">build_index</span>(<span class="hljs-params">self, documents: <span class="hljs-built_in">list</span></span>):
        <span class="hljs-string">"""构建向量索引"""</span>
        docs = [Document(page_content=d) <span class="hljs-keyword">for</span> d <span class="hljs-keyword">in</span> documents]
        self.vectorstore = LanceDB.from_documents(
            docs, 
            self.embeddings,
            connection=self.db,
            table_name=<span class="hljs-string">"naive_rag_docs"</span>
        )
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">query</span>(<span class="hljs-params">self, question: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">str</span>:
        <span class="hljs-string">"""执行检索并生成答案"""</span>
        <span class="hljs-comment"># 创建检索链</span>
        retriever = self.vectorstore.as_retriever(search_kwargs={<span class="hljs-string">"k"</span>: <span class="hljs-number">3</span>})
        
        prompt_template = PromptTemplate(
            input_variables=[<span class="hljs-string">"context"</span>, <span class="hljs-string">"question"</span>],
            template=<span class="hljs-string">"""基于以下上下文回答问题：
            上下文: {context}
            问题: {question}
            答案:"""</span>
        )
        
        qa_chain = RetrievalQA.from_chain_type(
            llm=self.llm,
            chain_type=<span class="hljs-string">"stuff"</span>,
            retriever=retriever,
            chain_type_kwargs={<span class="hljs-string">"prompt"</span>: prompt_template}
        )
        
        <span class="hljs-keyword">return</span> qa_chain.invoke({<span class="hljs-string">"query"</span>: question})[<span class="hljs-string">"result"</span>]

<span class="hljs-comment"># 使用示例</span>
naive_rag = NaiveRAG()
naive_rag.build_index([<span class="hljs-string">"文档1内容..."</span>, <span class="hljs-string">"文档2内容..."</span>, <span class="hljs-string">"文档3内容..."</span>])
answer = naive_rag.query(<span class="hljs-string">"What is issue date of lease?"</span>)
<span class="hljs-built_in">print</span>(answer)
</code></pre>
<h2 data-id="heading-1">2. Multi-Head RAG</h2>
<p><strong>简介：</strong></p>
<p>Multi-Head RAG 借鉴了 Transformer 的多头注意力机制，利用模型不同注意力头捕获的多样化语义特征进行并行检索。</p>
<p><strong>架构：</strong></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f2d889c3e8cf46d9a2bf9be204b3dbec~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZGo5pyr56iL5bqP54y_:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766818928&amp;x-signature=YUXFtx%2FXAO9Q0PjbKx6buyMl9UY%3D" alt="图片" loading="lazy"/></p>
<p><strong>实现步骤：</strong></p>
<ul>
<li>多头注意力Embedding：利用 Transformer 模型的多头注意力层（而非最后一层）生成多个embedding，每个头捕获不同的语义特征</li>
<li>多向量索引构建：为每个注意力头构建独立的向量索引，存储不同维度的语义信息</li>
<li>并行检索：针对查询，在多个索引上并行检索，每个头返回最相关的文档片段</li>
<li>结果融合：将多个头的检索结果进行去重和融合，综合考虑不同语义维度的相关性</li>
<li>上下文生成：将融合后的文档片段组装成上下文，输入LLM生成答案</li>
</ul>
<p><strong>相关参考如下：</strong></p>
<p>论文：<a href="https://link.juejin.cn?target=https%3A%2F%2Farxiv.org%2Fpdf%2F2406.05085" target="_blank" title="https://arxiv.org/pdf/2406.05085" ref="nofollow noopener noreferrer">arxiv.org/pdf/2406.05…</a></p>
<p>代码：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fspcl%2FMRAG" target="_blank" title="https://github.com/spcl/MRAG" ref="nofollow noopener noreferrer">github.com/spcl/MRAG</a></p>
<p><strong>参考代码：</strong></p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> langchain_openai <span class="hljs-keyword">import</span> ChatOpenAI
<span class="hljs-keyword">from</span> langchain_community.vectorstores <span class="hljs-keyword">import</span> LanceDB
<span class="hljs-keyword">from</span> langchain.schema <span class="hljs-keyword">import</span> Document
<span class="hljs-keyword">from</span> langchain.embeddings.base <span class="hljs-keyword">import</span> Embeddings
<span class="hljs-keyword">from</span> transformers <span class="hljs-keyword">import</span> AutoModel, AutoTokenizer
<span class="hljs-keyword">import</span> torch
<span class="hljs-keyword">import</span> lancedb
<span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> <span class="hljs-type">List</span>

<span class="hljs-keyword">class</span> <span class="hljs-title class_">MultiHeadEmbeddings</span>(<span class="hljs-title class_ inherited__">Embeddings</span>):
    <span class="hljs-string">"""自定义多头注意力Embedding，继承LangChain的Embeddings基类"""</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, model_name=<span class="hljs-string">"bert-base-uncased"</span>, head_index=<span class="hljs-number">0</span>, num_heads=<span class="hljs-number">12</span></span>):
        self.tokenizer = AutoTokenizer.from_pretrained(model_name)
        self.model = AutoModel.from_pretrained(model_name, output_hidden_states=<span class="hljs-literal">True</span>)
        self.head_index = head_index
        self.num_heads = num_heads
        self.head_dim = <span class="hljs-number">768</span> // num_heads  <span class="hljs-comment"># BERT hidden size / num_heads</span>
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_get_head_embedding</span>(<span class="hljs-params">self, texts: <span class="hljs-type">List</span>[<span class="hljs-built_in">str</span>]</span>) -&gt; <span class="hljs-type">List</span>[<span class="hljs-type">List</span>[<span class="hljs-built_in">float</span>]]:
        <span class="hljs-string">"""获取指定头的embedding"""</span>
        inputs = self.tokenizer(texts, return_tensors=<span class="hljs-string">"pt"</span>, padding=<span class="hljs-literal">True</span>, truncation=<span class="hljs-literal">True</span>)
        <span class="hljs-keyword">with</span> torch.no_grad():
            outputs = self.model(**inputs, output_hidden_states=<span class="hljs-literal">True</span>)
        hidden_states = outputs.hidden_states[-<span class="hljs-number">2</span>]  <span class="hljs-comment"># 倒数第二层</span>
        start = self.head_index * self.head_dim
        end = (self.head_index + <span class="hljs-number">1</span>) * self.head_dim
        head_emb = hidden_states[:, <span class="hljs-number">0</span>, start:end].numpy()
        <span class="hljs-keyword">return</span> head_emb.tolist()
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">embed_documents</span>(<span class="hljs-params">self, texts: <span class="hljs-type">List</span>[<span class="hljs-built_in">str</span>]</span>) -&gt; <span class="hljs-type">List</span>[<span class="hljs-type">List</span>[<span class="hljs-built_in">float</span>]]:
        <span class="hljs-keyword">return</span> self._get_head_embedding(texts)
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">embed_query</span>(<span class="hljs-params">self, text: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-type">List</span>[<span class="hljs-built_in">float</span>]:
        <span class="hljs-keyword">return</span> self._get_head_embedding([text])[<span class="hljs-number">0</span>]

<span class="hljs-keyword">class</span> <span class="hljs-title class_">MultiHeadRAG</span>:
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, num_heads=<span class="hljs-number">12</span></span>):
        self.llm = ChatOpenAI(model=<span class="hljs-string">"gpt-5"</span>, temperature=<span class="hljs-number">0</span>)
        self.num_heads = num_heads
        self.db = lancedb.connect(<span class="hljs-string">"/tmp/lancedb_multihead_rag"</span>)
        self.vectorstores = []  <span class="hljs-comment"># 每个头一个向量存储</span>
        self.documents = []
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">build_index</span>(<span class="hljs-params">self, documents: <span class="hljs-type">List</span>[<span class="hljs-built_in">str</span>]</span>):
        <span class="hljs-string">"""为每个头构建独立的LanceDB向量存储"""</span>
        self.documents = documents
        docs = [Document(page_content=d) <span class="hljs-keyword">for</span> d <span class="hljs-keyword">in</span> documents]
        
        <span class="hljs-keyword">for</span> head_idx <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(self.num_heads):
            embeddings = MultiHeadEmbeddings(head_index=head_idx, num_heads=self.num_heads)
            vectorstore = LanceDB.from_documents(
                docs, 
                embeddings,
                connection=self.db,
                table_name=<span class="hljs-string">f"head_<span class="hljs-subst">{head_idx}</span>_docs"</span>
            )
            self.vectorstores.append(vectorstore)
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">search</span>(<span class="hljs-params">self, query: <span class="hljs-built_in">str</span>, top_k: <span class="hljs-built_in">int</span> = <span class="hljs-number">3</span></span>) -&gt; <span class="hljs-type">List</span>[<span class="hljs-built_in">str</span>]:
        <span class="hljs-string">"""多头并行检索并融合结果"""</span>
        all_results = <span class="hljs-built_in">set</span>()
        <span class="hljs-keyword">for</span> vectorstore <span class="hljs-keyword">in</span> self.vectorstores:
            docs = vectorstore.similarity_search(query, k=top_k)
            <span class="hljs-keyword">for</span> doc <span class="hljs-keyword">in</span> docs:
                all_results.add(doc.page_content)
        <span class="hljs-keyword">return</span> <span class="hljs-built_in">list</span>(all_results)
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">query</span>(<span class="hljs-params">self, question: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">str</span>:
        <span class="hljs-string">"""检索并生成答案"""</span>
        retrieved_docs = self.search(question)
        context = <span class="hljs-string">"\n\n"</span>.join(retrieved_docs)
        
        <span class="hljs-keyword">from</span> langchain.prompts <span class="hljs-keyword">import</span> ChatPromptTemplate
        prompt = ChatPromptTemplate.from_template(
            <span class="hljs-string">"""基于以下多维度检索的上下文回答问题：
            上下文: {context}
            问题: {question}
            答案:"""</span>
        )
        chain = prompt | self.llm
        response = chain.invoke({<span class="hljs-string">"context"</span>: context, <span class="hljs-string">"question"</span>: question})
        <span class="hljs-keyword">return</span> response.content

<span class="hljs-comment"># 使用示例</span>
mrag = MultiHeadRAG(num_heads=<span class="hljs-number">12</span>)
documents = [<span class="hljs-string">"文档1的内容..."</span>, <span class="hljs-string">"文档2的内容..."</span>, <span class="hljs-string">"文档3的内容..."</span>]
mrag.build_index(documents)
answer = mrag.query(<span class="hljs-string">"查询问题"</span>)
<span class="hljs-built_in">print</span>(answer)
</code></pre>
<h2 data-id="heading-2">3. Corrective RAG</h2>
<p><strong>简介：</strong></p>
<p>Corrective RAG 在传统 RAG 基础上引入了文档质量评估和自我修正机制。对检索到的每个文档进行相关性评分（Correct/Incorrect/Ambiguous），对于质量不足的检索结果，搜索外部知识源进行补充。</p>
<p><strong>架构：</strong></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fe0109c62e3e43f68ce49846a9450b74~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZGo5pyr56iL5bqP54y_:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766818928&amp;x-signature=Wei8vQwsNIC1FczlF8K80NbNPsE%3D" alt="图片" loading="lazy"/></p>
<p><strong>实现步骤：</strong></p>
<ul>
<li>初始检索：使用向量检索获取与查询相关的候选文档</li>
<li>相关性评估：使用LLM或专门的评估模型对每个检索到的文档进行相关性评分（Correct/Incorrect/Ambiguous）</li>
<li>知识修正：对于评估为不相关或模糊的文档，触发知识修正机制</li>
<li>网络搜索增强：当本地知识库文档质量不足时，调用外部搜索引擎获取补充信息</li>
<li>文档重组：将评估为相关的文档和补充搜索结果重新组织，去除冗余信息</li>
<li>答案生成：基于修正后的高质量上下文生成最终答案</li>
</ul>
<p><strong>参考代码：</strong></p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> langchain_openai <span class="hljs-keyword">import</span> ChatOpenAI
<span class="hljs-keyword">from</span> langchain_huggingface <span class="hljs-keyword">import</span> HuggingFaceEmbeddings
<span class="hljs-keyword">from</span> langchain_community.vectorstores <span class="hljs-keyword">import</span> LanceDB
<span class="hljs-keyword">from</span> langchain_community.tools <span class="hljs-keyword">import</span> TavilySearchResults
<span class="hljs-keyword">from</span> langchain.schema <span class="hljs-keyword">import</span> Document
<span class="hljs-keyword">from</span> langchain.prompts <span class="hljs-keyword">import</span> ChatPromptTemplate
<span class="hljs-keyword">from</span> langchain_core.output_parsers <span class="hljs-keyword">import</span> StrOutputParser
<span class="hljs-keyword">import</span> lancedb
<span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> <span class="hljs-type">List</span>

<span class="hljs-keyword">class</span> <span class="hljs-title class_">CorrectiveRAG</span>:
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self</span>):
        self.llm = ChatOpenAI(model=<span class="hljs-string">"gpt-5"</span>, temperature=<span class="hljs-number">0</span>)
        self.embeddings = HuggingFaceEmbeddings(
            model_name=<span class="hljs-string">"sentence-transformers/all-MiniLM-L6-v2"</span>,
            model_kwargs={<span class="hljs-string">"device"</span>: <span class="hljs-string">"cpu"</span>},
            encode_kwargs={<span class="hljs-string">"normalize_embeddings"</span>: <span class="hljs-literal">True</span>}
        )
        self.db = lancedb.connect(<span class="hljs-string">"/tmp/lancedb_corrective_rag"</span>)
        self.vectorstore = <span class="hljs-literal">None</span>
        <span class="hljs-comment"># 使用Tavily进行网络搜索</span>
        self.web_search = TavilySearchResults(max_results=<span class="hljs-number">3</span>)
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">build_index</span>(<span class="hljs-params">self, documents: <span class="hljs-type">List</span>[<span class="hljs-built_in">str</span>]</span>):
        <span class="hljs-string">"""构建向量索引"""</span>
        docs = [Document(page_content=d) <span class="hljs-keyword">for</span> d <span class="hljs-keyword">in</span> documents]
        self.vectorstore = LanceDB.from_documents(
            docs, 
            self.embeddings,
            connection=self.db,
            table_name=<span class="hljs-string">"corrective_rag_docs"</span>
        )
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">evaluate_relevance</span>(<span class="hljs-params">self, query: <span class="hljs-built_in">str</span>, document: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">str</span>:
        <span class="hljs-string">"""评估文档与查询的相关性"""</span>
        prompt = ChatPromptTemplate.from_template(
            <span class="hljs-string">"""评估以下文档与查询的相关性。
            查询: {query}
            文档: {document}
            
            请回答: CORRECT(相关), INCORRECT(不相关), 或 AMBIGUOUS(模糊)
            只返回一个词。"""</span>
        )
        chain = prompt | self.llm | StrOutputParser()
        response = chain.invoke({<span class="hljs-string">"query"</span>: query, <span class="hljs-string">"document"</span>: document})
        <span class="hljs-keyword">return</span> response.strip().upper()
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">search_web</span>(<span class="hljs-params">self, query: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-type">List</span>[<span class="hljs-built_in">str</span>]:
        <span class="hljs-string">"""当本地文档不足时进行网络搜索"""</span>
        <span class="hljs-keyword">try</span>:
            results = self.web_search.invoke(query)
            <span class="hljs-keyword">return</span> [r[<span class="hljs-string">"content"</span>] <span class="hljs-keyword">for</span> r <span class="hljs-keyword">in</span> results <span class="hljs-keyword">if</span><span class="hljs-string">"content"</span><span class="hljs-keyword">in</span> r]
        <span class="hljs-keyword">except</span>:
            <span class="hljs-keyword">return</span> []
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">retrieve_and_correct</span>(<span class="hljs-params">self, query: <span class="hljs-built_in">str</span>, top_k: <span class="hljs-built_in">int</span> = <span class="hljs-number">5</span></span>) -&gt; <span class="hljs-type">List</span>[<span class="hljs-built_in">str</span>]:
        <span class="hljs-string">"""检索并修正文档"""</span>
        <span class="hljs-comment"># 1. 初始检索</span>
        retriever = self.vectorstore.as_retriever(search_kwargs={<span class="hljs-string">"k"</span>: top_k})
        docs = retriever.invoke(query)
        
        <span class="hljs-comment"># 2. 评估每个文档的相关性</span>
        correct_docs = []
        need_web_search = <span class="hljs-literal">True</span>
        
        <span class="hljs-keyword">for</span> doc <span class="hljs-keyword">in</span> docs:
            relevance = self.evaluate_relevance(query, doc.page_content)
            <span class="hljs-keyword">if</span> relevance == <span class="hljs-string">"CORRECT"</span>:
                correct_docs.append(doc.page_content)
                need_web_search = <span class="hljs-literal">False</span>
            <span class="hljs-keyword">elif</span> relevance == <span class="hljs-string">"AMBIGUOUS"</span>:
                <span class="hljs-comment"># 对模糊文档进行知识精炼</span>
                refined = self.refine_document(query, doc.page_content)
                correct_docs.append(refined)
        
        <span class="hljs-comment"># 3. 必要时进行网络搜索补充</span>
        <span class="hljs-keyword">if</span> need_web_search <span class="hljs-keyword">or</span> <span class="hljs-built_in">len</span>(correct_docs) &lt; <span class="hljs-number">2</span>:
            web_results = self.search_web(query)
            correct_docs.extend(web_results)
        
        <span class="hljs-keyword">return</span> correct_docs
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">refine_document</span>(<span class="hljs-params">self, query: <span class="hljs-built_in">str</span>, document: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">str</span>:
        <span class="hljs-string">"""精炼文档，提取与查询相关的部分"""</span>
        prompt = ChatPromptTemplate.from_template(
            <span class="hljs-string">"""从以下文档中提取与查询最相关的信息：
            查询: {query}
            文档: {document}
            
            请只返回相关的精炼内容："""</span>
        )
        chain = prompt | self.llm | StrOutputParser()
        <span class="hljs-keyword">return</span> chain.invoke({<span class="hljs-string">"query"</span>: query, <span class="hljs-string">"document"</span>: document})
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">query</span>(<span class="hljs-params">self, question: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">str</span>:
        <span class="hljs-string">"""生成最终答案"""</span>
        corrected_docs = self.retrieve_and_correct(question)
        context = <span class="hljs-string">"\n\n"</span>.join(corrected_docs)
        
        prompt = ChatPromptTemplate.from_template(
            <span class="hljs-string">"""基于以下经过修正的上下文回答问题：
            上下文: {context}
            问题: {question}
            答案:"""</span>
        )
        chain = prompt | self.llm | StrOutputParser()
        <span class="hljs-keyword">return</span> chain.invoke({<span class="hljs-string">"context"</span>: context, <span class="hljs-string">"question"</span>: question})

<span class="hljs-comment"># 使用示例</span>
crag = CorrectiveRAG()
crag.build_index([<span class="hljs-string">"文档1..."</span>, <span class="hljs-string">"文档2..."</span>, <span class="hljs-string">"文档3..."</span>])
answer = crag.query(<span class="hljs-string">"你的问题是什么？"</span>)
<span class="hljs-built_in">print</span>(answer)
</code></pre>
<h2 data-id="heading-3">4. Agentic RAG</h2>
<p><strong>简介：</strong></p>
<p>Agentic RAG（智能体RAG）将 AI Agent 的规划和推理能力与 RAG 相结合。<br/>
Agent 可以自主分析查询、制定检索策略、选择合适的工具（语义搜索、关键词搜索、计算器等），并根据中间结果进行迭代优化。</p>
<p><strong>架构：</strong></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e2d4ac2fafbf4f2f8a4549436c5adc3f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZGo5pyr56iL5bqP54y_:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766818928&amp;x-signature=nzUF6IDJ6xHC4IINPGVnM04N3Ig%3D" alt="图片" loading="lazy"/></p>
<p><strong>实现步骤：</strong></p>
<ul>
<li>Agent初始化：创建具有推理和规划能力的AI Agent，配备检索工具</li>
<li>任务分解：Agent分析用户查询，将复杂问题分解为多个子任务</li>
<li>工具选择：Agent根据子任务特点选择合适的工具（检索、计算、API调用等）</li>
<li>迭代检索：Agent可以根据中间结果决定是否需要进一步检索或调整查询策略</li>
<li>推理整合：Agent对多轮检索和工具调用的结果进行推理和整合</li>
<li>自我反思：Agent评估答案质量，必要时进行自我修正</li>
<li>最终输出：生成完整、准确的答案</li>
</ul>
<p><strong>参考代码：</strong></p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> langchain_openai <span class="hljs-keyword">import</span> ChatOpenAI
<span class="hljs-keyword">from</span> langchain_huggingface <span class="hljs-keyword">import</span> HuggingFaceEmbeddings
<span class="hljs-keyword">from</span> langchain_community.vectorstores <span class="hljs-keyword">import</span> LanceDB
<span class="hljs-keyword">from</span> langchain.schema <span class="hljs-keyword">import</span> Document
<span class="hljs-keyword">from</span> langchain.agents <span class="hljs-keyword">import</span> AgentExecutor, create_tool_calling_agent
<span class="hljs-keyword">from</span> langchain.tools <span class="hljs-keyword">import</span> tool
<span class="hljs-keyword">from</span> langchain_core.prompts <span class="hljs-keyword">import</span> ChatPromptTemplate, MessagesPlaceholder
<span class="hljs-keyword">import</span> lancedb
<span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> <span class="hljs-type">List</span>

<span class="hljs-keyword">class</span> <span class="hljs-title class_">AgenticRAG</span>:
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self</span>):
        self.llm = ChatOpenAI(model=<span class="hljs-string">"gpt-4"</span>, temperature=<span class="hljs-number">0</span>)
        <span class="hljs-comment"># 使用轻量级的all-MiniLM-L6-v2模型，仅80MB</span>
        self.embeddings = HuggingFaceEmbeddings(
            model_name=<span class="hljs-string">"sentence-transformers/all-MiniLM-L6-v2"</span>,
            model_kwargs={<span class="hljs-string">"device"</span>: <span class="hljs-string">"cpu"</span>},
            encode_kwargs={<span class="hljs-string">"normalize_embeddings"</span>: <span class="hljs-literal">True</span>}
        )
        self.db = lancedb.connect(<span class="hljs-string">"/tmp/lancedb_agentic_rag"</span>)
        self.vectorstore = <span class="hljs-literal">None</span>
        self.agent_executor = <span class="hljs-literal">None</span>
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">build_index</span>(<span class="hljs-params">self, documents: <span class="hljs-type">List</span>[<span class="hljs-built_in">str</span>]</span>):
        <span class="hljs-string">"""构建向量索引"""</span>
        docs = [Document(page_content=d) <span class="hljs-keyword">for</span> d <span class="hljs-keyword">in</span> documents]
        self.vectorstore = LanceDB.from_documents(
            docs, 
            self.embeddings,
            connection=self.db,
            table_name=<span class="hljs-string">"agentic_rag_docs"</span>
        )
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">setup_agent</span>(<span class="hljs-params">self</span>):
        <span class="hljs-string">"""配置Agent和工具"""</span>
        vectorstore = self.vectorstore  <span class="hljs-comment"># 闭包引用</span>
        
        @tool
        <span class="hljs-keyword">def</span> <span class="hljs-title function_">semantic_search</span>(<span class="hljs-params">query: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">str</span>:
            <span class="hljs-string">"""用于语义搜索，当需要理解问题含义并查找相关文档时使用"""</span>
            docs = vectorstore.similarity_search(query, k=<span class="hljs-number">3</span>)
            <span class="hljs-keyword">return</span><span class="hljs-string">"\n"</span>.join([d.page_content <span class="hljs-keyword">for</span> d <span class="hljs-keyword">in</span> docs])
        
        @tool
        <span class="hljs-keyword">def</span> <span class="hljs-title function_">keyword_search</span>(<span class="hljs-params">query: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">str</span>:
            <span class="hljs-string">"""用于关键词搜索，当需要精确匹配特定术语时使用"""</span>
            docs = vectorstore.similarity_search(query, k=<span class="hljs-number">2</span>)
            <span class="hljs-keyword">return</span><span class="hljs-string">"\n"</span>.join([d.page_content <span class="hljs-keyword">for</span> d <span class="hljs-keyword">in</span> docs])
        
        @tool
        <span class="hljs-keyword">def</span> <span class="hljs-title function_">calculator</span>(<span class="hljs-params">expression: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">str</span>:
            <span class="hljs-string">"""用于数学计算，输入数学表达式"""</span>
            <span class="hljs-keyword">try</span>:
                <span class="hljs-keyword">return</span> <span class="hljs-built_in">str</span>(<span class="hljs-built_in">eval</span>(expression))
            <span class="hljs-keyword">except</span>:
                <span class="hljs-keyword">return</span><span class="hljs-string">"计算错误"</span>
        
        tools = [semantic_search, keyword_search, calculator]
        
        <span class="hljs-comment"># 使用新版本的Agent提示模板</span>
        prompt = ChatPromptTemplate.from_messages([
            (<span class="hljs-string">"system"</span>, <span class="hljs-string">"""你是一个智能助手，可以使用工具来回答问题。
            
            可用工具：
            - semantic_search: 用于语义搜索，查找相关文档
            - keyword_search: 用于关键词精确匹配
            - calculator: 用于数学计算
            
            请根据问题选择合适的工具，可以多次调用工具来获取完整信息。"""</span>),
            (<span class="hljs-string">"human"</span>, <span class="hljs-string">"{input}"</span>),
            MessagesPlaceholder(variable_name=<span class="hljs-string">"agent_scratchpad"</span>)
        ])
        
        <span class="hljs-comment"># 创建Tool Calling Agent</span>
        agent = create_tool_calling_agent(self.llm, tools, prompt)
        self.agent_executor = AgentExecutor(
            agent=agent, 
            tools=tools, 
            verbose=<span class="hljs-literal">True</span>,
            max_iterations=<span class="hljs-number">5</span>,
            handle_parsing_errors=<span class="hljs-literal">True</span>
        )
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">query</span>(<span class="hljs-params">self, question: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">str</span>:
        <span class="hljs-string">"""执行查询"""</span>
        ifnot self.agent_executor:
            self.setup_agent()
        result = self.agent_executor.invoke({<span class="hljs-string">"input"</span>: question})
        <span class="hljs-keyword">return</span> result[<span class="hljs-string">"output"</span>]

<span class="hljs-comment"># 使用示例</span>
arag = AgenticRAG()
arag.build_index([<span class="hljs-string">"产品A价格100元..."</span>, <span class="hljs-string">"产品B价格200元..."</span>, <span class="hljs-string">"优惠政策..."</span>])
answer = arag.query(<span class="hljs-string">"产品A和产品B的总价是多少？有什么优惠？"</span>)
<span class="hljs-built_in">print</span>(answer)
</code></pre>
<h2 data-id="heading-4">5. Graph RAG</h2>
<p><strong>简介：</strong></p>
<p>Graph RAG 将知识图谱技术与 RAG 相结合，通过从文档中抽取实体和关系构建知识图谱，并进行社区检测和摘要生成。</p>
<p><strong>架构：</strong></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/156a00f8228c4cd6ad9d9a913b14922b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZGo5pyr56iL5bqP54y_:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766818928&amp;x-signature=1qbByKhMhrVkeQ42ZSiqfMkGUbc%3D" alt="图片" loading="lazy"/></p>
<p><strong>实现步骤：</strong></p>
<ul>
<li>实体抽取：使用NER或LLM从文档中抽取实体（人物、地点、概念等）</li>
<li>关系抽取：识别实体之间的关系，构建三元组（实体-关系-实体）</li>
<li>知识图谱构建：将实体和关系存储到图数据库中（如Neo4j）</li>
<li>社区检测：对图进行社区划分，识别主题聚类</li>
<li>社区摘要：为每个社区生成摘要描述</li>
<li>图检索：根据查询在知识图谱中检索相关子图和社区摘要</li>
<li>答案生成：结合图结构信息和社区摘要生成更全面的答案</li>
</ul>
<p><strong>参考代码：</strong></p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> langchain_openai <span class="hljs-keyword">import</span> ChatOpenAI
<span class="hljs-keyword">from</span> langchain_community.graphs <span class="hljs-keyword">import</span> Neo4jGraph
<span class="hljs-keyword">from</span> langchain.prompts <span class="hljs-keyword">import</span> ChatPromptTemplate
<span class="hljs-keyword">from</span> langchain_core.output_parsers <span class="hljs-keyword">import</span> StrOutputParser, JsonOutputParser
<span class="hljs-keyword">import</span> networkx <span class="hljs-keyword">as</span> nx
<span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> <span class="hljs-type">List</span>, <span class="hljs-type">Dict</span>
<span class="hljs-keyword">import</span> json

<span class="hljs-keyword">class</span> <span class="hljs-title class_">GraphRAG</span>:
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, neo4j_uri=<span class="hljs-string">"bolt://localhost:7687"</span>, 
                 neo4j_user=<span class="hljs-string">"neo4j"</span>, neo4j_password=<span class="hljs-string">"password"</span></span>):
        self.llm = ChatOpenAI(model=<span class="hljs-string">"gpt-5"</span>, temperature=<span class="hljs-number">0</span>)
        <span class="hljs-comment"># 使用LangChain的Neo4j集成</span>
        self.graph_db = Neo4jGraph(
            url=neo4j_uri, 
            username=neo4j_user, 
            password=neo4j_password
        )
        self.nx_graph = nx.Graph()
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">extract_entities_and_relations</span>(<span class="hljs-params">self, text: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-type">Dict</span>:
        <span class="hljs-string">"""使用LLM抽取实体和关系"""</span>
        prompt = ChatPromptTemplate.from_template(
            <span class="hljs-string">"""从以下文本中抽取实体和关系，返回JSON格式：
            文本: {text}
            
            返回格式(只返回JSON):
            {{
                "entities": ["实体1", "实体2", ...],
                "relations": [["实体1", "关系", "实体2"], ...]
            }}"""</span>
        )
        chain = prompt | self.llm | StrOutputParser()
        response = chain.invoke({<span class="hljs-string">"text"</span>: text})
        <span class="hljs-keyword">try</span>:
            <span class="hljs-keyword">return</span> json.loads(response)
        <span class="hljs-keyword">except</span>:
            <span class="hljs-keyword">return</span> {<span class="hljs-string">"entities"</span>: [], <span class="hljs-string">"relations"</span>: []}
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">build_knowledge_graph</span>(<span class="hljs-params">self, documents: <span class="hljs-type">List</span>[<span class="hljs-built_in">str</span>]</span>):
        <span class="hljs-string">"""构建知识图谱"""</span>
        <span class="hljs-keyword">for</span> doc <span class="hljs-keyword">in</span> documents:
            extracted = self.extract_entities_and_relations(doc)
            
            <span class="hljs-comment"># 添加到NetworkX图</span>
            <span class="hljs-keyword">for</span> entity <span class="hljs-keyword">in</span> extracted[<span class="hljs-string">"entities"</span>]:
                self.nx_graph.add_node(entity)
            
            <span class="hljs-keyword">for</span> rel <span class="hljs-keyword">in</span> extracted[<span class="hljs-string">"relations"</span>]:
                <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(rel) == <span class="hljs-number">3</span>:
                    self.nx_graph.add_edge(rel[<span class="hljs-number">0</span>], rel[<span class="hljs-number">2</span>], relation=rel[<span class="hljs-number">1</span>])
            
            <span class="hljs-comment"># 存储到Neo4j</span>
            <span class="hljs-keyword">for</span> entity <span class="hljs-keyword">in</span> extracted[<span class="hljs-string">"entities"</span>]:
                self.graph_db.query(
                    <span class="hljs-string">"MERGE (e:Entity {name: $name})"</span>, 
                    {<span class="hljs-string">"name"</span>: entity}
                )
            <span class="hljs-keyword">for</span> rel <span class="hljs-keyword">in</span> extracted[<span class="hljs-string">"relations"</span>]:
                <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(rel) == <span class="hljs-number">3</span>:
                    self.graph_db.query(
                        <span class="hljs-string">"""MATCH (a:Entity {name: $from})
                           MATCH (b:Entity {name: $to})
                           MERGE (a)-[r:RELATED {type: $rel}]-&gt;(b)"""</span>,
                        {<span class="hljs-string">"from"</span>: rel[<span class="hljs-number">0</span>], <span class="hljs-string">"to"</span>: rel[<span class="hljs-number">2</span>], <span class="hljs-string">"rel"</span>: rel[<span class="hljs-number">1</span>]}
                    )
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">detect_communities</span>(<span class="hljs-params">self</span>) -&gt; <span class="hljs-type">List</span>[<span class="hljs-type">List</span>[<span class="hljs-built_in">str</span>]]:
        <span class="hljs-string">"""社区检测"""</span>
        <span class="hljs-keyword">from</span> networkx.algorithms <span class="hljs-keyword">import</span> community
        <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(self.nx_graph.nodes()) == <span class="hljs-number">0</span>:
            <span class="hljs-keyword">return</span> []
        communities = community.louvain_communities(self.nx_graph)
        <span class="hljs-keyword">return</span> [<span class="hljs-built_in">list</span>(c) <span class="hljs-keyword">for</span> c <span class="hljs-keyword">in</span> communities]
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">generate_community_summaries</span>(<span class="hljs-params">self, communities: <span class="hljs-type">List</span>[<span class="hljs-type">List</span>[<span class="hljs-built_in">str</span>]]</span>) -&gt; <span class="hljs-type">List</span>[<span class="hljs-type">Dict</span>]:
        <span class="hljs-string">"""为每个社区生成摘要"""</span>
        summaries = []
        <span class="hljs-keyword">for</span> i, comm <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(communities):
            subgraph = self.nx_graph.subgraph(comm)
            edges_info = [(u, v, d.get(<span class="hljs-string">'relation'</span>, <span class="hljs-string">''</span>)) 
                         <span class="hljs-keyword">for</span> u, v, d <span class="hljs-keyword">in</span> subgraph.edges(data=<span class="hljs-literal">True</span>)]
            
            prompt = ChatPromptTemplate.from_template(
                <span class="hljs-string">"""为以下实体群组生成简短摘要：
                实体: {entities}
                关系: {relations}
                摘要:"""</span>
            )
            chain = prompt | self.llm | StrOutputParser()
            summary = chain.invoke({<span class="hljs-string">"entities"</span>: comm, <span class="hljs-string">"relations"</span>: edges_info})
            summaries.append({<span class="hljs-string">"community"</span>: i, <span class="hljs-string">"entities"</span>: comm, <span class="hljs-string">"summary"</span>: summary})
        <span class="hljs-keyword">return</span> summaries
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">query</span>(<span class="hljs-params">self, question: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">str</span>:
        <span class="hljs-string">"""基于图的检索和回答"""</span>
        <span class="hljs-comment"># 1. 从问题中提取关键实体</span>
        entities = self.extract_entities_and_relations(question)[<span class="hljs-string">"entities"</span>]
        
        <span class="hljs-comment"># 2. 在Neo4j中查找相关子图</span>
        graph_context = self.graph_db.query(
            <span class="hljs-string">"""MATCH (e:Entity)-[r]-(related)
               WHERE e.name IN $entities
               RETURN e.name AS entity, type(r) AS rel_type, 
                      r.type AS relation, related.name AS related_entity
               LIMIT 20"""</span>,
            {<span class="hljs-string">"entities"</span>: entities}
        )
        
        <span class="hljs-comment"># 3. 获取社区摘要</span>
        communities = self.detect_communities()
        summaries = self.generate_community_summaries(communities[:<span class="hljs-number">3</span>])
        
        <span class="hljs-comment"># 4. 生成答案</span>
        context = <span class="hljs-string">f"图关系: <span class="hljs-subst">{graph_context}</span>\n社区摘要: <span class="hljs-subst">{summaries}</span>"</span>
        prompt = ChatPromptTemplate.from_template(
            <span class="hljs-string">"""基于以下知识图谱信息回答问题：
            {context}
            
            问题: {question}
            答案:"""</span>
        )
        chain = prompt | self.llm | StrOutputParser()
        <span class="hljs-keyword">return</span> chain.invoke({<span class="hljs-string">"context"</span>: context, <span class="hljs-string">"question"</span>: question})

<span class="hljs-comment"># 使用示例</span>
grag = GraphRAG()
grag.build_knowledge_graph([
    <span class="hljs-string">"张三是ABC公司的CEO，该公司位于北京"</span>,
    <span class="hljs-string">"李四是ABC公司的CTO，他与张三是大学同学"</span>,
    <span class="hljs-string">"ABC公司开发了产品X，市场份额领先"</span>
])
answer = grag.query(<span class="hljs-string">"ABC公司的领导层有哪些人？"</span>)
<span class="hljs-built_in">print</span>(answer)
</code></pre>
<h2 data-id="heading-5">6. Self RAG</h2>
<p><strong>简介：</strong></p>
<p>Self RAG 提供给模型自我评估和决策能力，它通过四个反思标记（Retrieve/ISREL/ISSUP/ISUSE）来判断：是否需要检索、文档是否相关、答案是否被支持、答案是否有用，模型会生成多个候选答案并综合评分，选择最优结果输出。</p>
<p><strong>架构：</strong></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f305a7dcc64a4d119b93fc171c739451~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZGo5pyr56iL5bqP54y_:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766818928&amp;x-signature=568LwX2VOeLFWFTprYECRBOGzH0%3D" alt="图片" loading="lazy"/></p>
<p><strong>实现步骤：</strong></p>
<ul>
<li>检索决策：模型首先判断是否需要检索（生成Retrieve标记）</li>
<li>按需检索：如果需要检索，从知识库中获取相关文档</li>
<li>相关性评估：模型评估检索到的文档是否与查询相关（生成ISREL标记）</li>
<li>支持度评估：模型评估生成的内容是否被检索文档支持（生成ISSUP标记）</li>
<li>有用性评估：模型评估生成的回答是否对用户有用（生成ISUSE标记）</li>
<li>自适应生成：基于以上评估标记，模型决定是否使用检索内容、重新检索或直接生成</li>
<li>输出最优答案：选择评分最高的生成结果作为最终输出</li>
</ul>
<p><strong>参考代码：</strong></p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> langchain_openai <span class="hljs-keyword">import</span> ChatOpenAI
<span class="hljs-keyword">from</span> langchain_huggingface <span class="hljs-keyword">import</span> HuggingFaceEmbeddings
<span class="hljs-keyword">from</span> langchain_community.vectorstores <span class="hljs-keyword">import</span> LanceDB
<span class="hljs-keyword">from</span> langchain.schema <span class="hljs-keyword">import</span> Document
<span class="hljs-keyword">from</span> langchain.prompts <span class="hljs-keyword">import</span> ChatPromptTemplate
<span class="hljs-keyword">from</span> langchain_core.output_parsers <span class="hljs-keyword">import</span> StrOutputParser
<span class="hljs-keyword">import</span> lancedb
<span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> <span class="hljs-type">List</span>, <span class="hljs-type">Tuple</span>

<span class="hljs-keyword">class</span> <span class="hljs-title class_">SelfRAG</span>:
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self</span>):
        self.llm = ChatOpenAI(model=<span class="hljs-string">"gpt-4"</span>, temperature=<span class="hljs-number">0</span>)
        <span class="hljs-comment"># 使用轻量级的all-MiniLM-L6-v2模型，仅80MB</span>
        self.embeddings = HuggingFaceEmbeddings(
            model_name=<span class="hljs-string">"sentence-transformers/all-MiniLM-L6-v2"</span>,
            model_kwargs={<span class="hljs-string">"device"</span>: <span class="hljs-string">"cpu"</span>},
            encode_kwargs={<span class="hljs-string">"normalize_embeddings"</span>: <span class="hljs-literal">True</span>}
        )
        self.db = lancedb.connect(<span class="hljs-string">"/tmp/lancedb_self_rag"</span>)
        self.vectorstore = <span class="hljs-literal">None</span>
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">build_index</span>(<span class="hljs-params">self, documents: <span class="hljs-type">List</span>[<span class="hljs-built_in">str</span>]</span>):
        <span class="hljs-string">"""构建向量索引"""</span>
        docs = [Document(page_content=d) <span class="hljs-keyword">for</span> d <span class="hljs-keyword">in</span> documents]
        self.vectorstore = LanceDB.from_documents(
            docs, 
            self.embeddings,
            connection=self.db,
            table_name=<span class="hljs-string">"self_rag_docs"</span>
        )
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">should_retrieve</span>(<span class="hljs-params">self, query: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">bool</span>:
        <span class="hljs-string">"""判断是否需要检索 (Retrieve标记)"""</span>
        prompt = ChatPromptTemplate.from_template(
            <span class="hljs-string">"""判断以下问题是否需要检索外部知识来回答。
            问题: {query}
            
            如果问题需要事实性知识、最新信息或特定领域知识，回答YES。
            如果问题是通用问题或推理问题，回答NO。
            只回答YES或NO:"""</span>
        )
        chain = prompt | self.llm | StrOutputParser()
        response = chain.invoke({<span class="hljs-string">"query"</span>: query}).strip().upper()
        <span class="hljs-keyword">return</span><span class="hljs-string">"YES"</span><span class="hljs-keyword">in</span> response
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">evaluate_relevance</span>(<span class="hljs-params">self, query: <span class="hljs-built_in">str</span>, document: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-type">Tuple</span>[<span class="hljs-built_in">bool</span>, <span class="hljs-built_in">float</span>]:
        <span class="hljs-string">"""评估文档相关性 (ISREL标记)"""</span>
        prompt = ChatPromptTemplate.from_template(
            <span class="hljs-string">"""评估文档与问题的相关性，打分1-5分。
            问题: {query}
            文档: {document}
            
            返回格式: 分数|理由
            示例: 4|文档直接回答了问题的核心内容"""</span>
        )
        chain = prompt | self.llm | StrOutputParser()
        response = chain.invoke({<span class="hljs-string">"query"</span>: query, <span class="hljs-string">"document"</span>: document})
        <span class="hljs-keyword">try</span>:
            score = <span class="hljs-built_in">int</span>(response.split(<span class="hljs-string">"|"</span>)[<span class="hljs-number">0</span>].strip())
            <span class="hljs-keyword">return</span> score &gt;= <span class="hljs-number">3</span>, score / <span class="hljs-number">5.0</span>
        <span class="hljs-keyword">except</span>:
            returnTrue, <span class="hljs-number">0.6</span>
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">evaluate_support</span>(<span class="hljs-params">self, document: <span class="hljs-built_in">str</span>, answer: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-type">Tuple</span>[<span class="hljs-built_in">bool</span>, <span class="hljs-built_in">float</span>]:
        <span class="hljs-string">"""评估答案是否被文档支持 (ISSUP标记)"""</span>
        prompt = ChatPromptTemplate.from_template(
            <span class="hljs-string">"""评估答案是否被文档内容支持，打分1-5分。
            文档: {document}
            答案: {answer}
            
            返回格式: 分数|理由"""</span>
        )
        chain = prompt | self.llm | StrOutputParser()
        response = chain.invoke({<span class="hljs-string">"document"</span>: document, <span class="hljs-string">"answer"</span>: answer})
        <span class="hljs-keyword">try</span>:
            score = <span class="hljs-built_in">int</span>(response.split(<span class="hljs-string">"|"</span>)[<span class="hljs-number">0</span>].strip())
            <span class="hljs-keyword">return</span> score &gt;= <span class="hljs-number">3</span>, score / <span class="hljs-number">5.0</span>
        <span class="hljs-keyword">except</span>:
            returnTrue, <span class="hljs-number">0.6</span>
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">evaluate_usefulness</span>(<span class="hljs-params">self, query: <span class="hljs-built_in">str</span>, answer: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-type">Tuple</span>[<span class="hljs-built_in">bool</span>, <span class="hljs-built_in">float</span>]:
        <span class="hljs-string">"""评估答案有用性 (ISUSE标记)"""</span>
        prompt = ChatPromptTemplate.from_template(
            <span class="hljs-string">"""评估答案对用户问题的有用程度，打分1-5分。
            问题: {query}
            答案: {answer}
            
            返回格式: 分数|理由"""</span>
        )
        chain = prompt | self.llm | StrOutputParser()
        response = chain.invoke({<span class="hljs-string">"query"</span>: query, <span class="hljs-string">"answer"</span>: answer})
        <span class="hljs-keyword">try</span>:
            score = <span class="hljs-built_in">int</span>(response.split(<span class="hljs-string">"|"</span>)[<span class="hljs-number">0</span>].strip())
            <span class="hljs-keyword">return</span> score &gt;= <span class="hljs-number">3</span>, score / <span class="hljs-number">5.0</span>
        <span class="hljs-keyword">except</span>:
            returnTrue, <span class="hljs-number">0.6</span>
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">generate_with_context</span>(<span class="hljs-params">self, query: <span class="hljs-built_in">str</span>, context: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">str</span>:
        <span class="hljs-string">"""基于上下文生成答案"""</span>
        prompt = ChatPromptTemplate.from_template(
            <span class="hljs-string">"""基于以下上下文回答问题。如果上下文不足以回答，请说明。
            上下文: {context}
            问题: {query}
            答案:"""</span>
        )
        chain = prompt | self.llm | StrOutputParser()
        <span class="hljs-keyword">return</span> chain.invoke({<span class="hljs-string">"context"</span>: context, <span class="hljs-string">"query"</span>: query})
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">generate_without_context</span>(<span class="hljs-params">self, query: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">str</span>:
        <span class="hljs-string">"""不使用检索直接生成"""</span>
        prompt = ChatPromptTemplate.from_template(<span class="hljs-string">"请回答以下问题: {query}"</span>)
        chain = prompt | self.llm | StrOutputParser()
        <span class="hljs-keyword">return</span> chain.invoke({<span class="hljs-string">"query"</span>: query})
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">query</span>(<span class="hljs-params">self, question: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">str</span>:
        <span class="hljs-string">"""Self-RAG主流程"""</span>
        <span class="hljs-comment"># 1. 检索决策</span>
        need_retrieval = self.should_retrieve(question)
        
        ifnot need_retrieval:
            <span class="hljs-comment"># 直接生成</span>
            answer = self.generate_without_context(question)
            _, usefulness = self.evaluate_usefulness(question, answer)
            <span class="hljs-keyword">return</span> answer
        
        <span class="hljs-comment"># 2. 检索文档</span>
        retriever = self.vectorstore.as_retriever(search_kwargs={<span class="hljs-string">"k"</span>: <span class="hljs-number">3</span>})
        docs = retriever.invoke(question)
        
        <span class="hljs-comment"># 3. 对每个文档生成候选答案并评分</span>
        candidates = []
        <span class="hljs-keyword">for</span> doc <span class="hljs-keyword">in</span> docs:
            <span class="hljs-comment"># 评估相关性 (ISREL)</span>
            is_relevant, rel_score = self.evaluate_relevance(question, doc.page_content)
            ifnot is_relevant:
                <span class="hljs-keyword">continue</span>
            
            <span class="hljs-comment"># 生成答案</span>
            answer = self.generate_with_context(question, doc.page_content)
            
            <span class="hljs-comment"># 评估支持度 (ISSUP)</span>
            is_supported, sup_score = self.evaluate_support(doc.page_content, answer)
            
            <span class="hljs-comment"># 评估有用性 (ISUSE)</span>
            is_useful, use_score = self.evaluate_usefulness(question, answer)
            
            <span class="hljs-comment"># 综合评分</span>
            total_score = rel_score * <span class="hljs-number">0.3</span> + sup_score * <span class="hljs-number">0.4</span> + use_score * <span class="hljs-number">0.3</span>
            candidates.append((answer, total_score))
        
        <span class="hljs-comment"># 4. 选择最佳答案</span>
        <span class="hljs-keyword">if</span> candidates:
            candidates.sort(key=<span class="hljs-keyword">lambda</span> x: x[<span class="hljs-number">1</span>], reverse=<span class="hljs-literal">True</span>)
            <span class="hljs-keyword">return</span> candidates[<span class="hljs-number">0</span>][<span class="hljs-number">0</span>]
        <span class="hljs-keyword">else</span>:
            <span class="hljs-comment"># 如果没有合适的检索结果，直接生成</span>
            <span class="hljs-keyword">return</span> self.generate_without_context(question)

<span class="hljs-comment"># 使用示例</span>
srag = SelfRAG()
srag.build_index([<span class="hljs-string">"文档1内容..."</span>, <span class="hljs-string">"文档2内容..."</span>, <span class="hljs-string">"文档3内容..."</span>])
answer = srag.query(<span class="hljs-string">"你的问题是什么？"</span>)
<span class="hljs-built_in">print</span>(answer)
</code></pre>
<h2 data-id="heading-6">7. Adaptive RAG</h2>
<p><strong>简介：</strong></p>
<p>Adaptive RAG 根据查询的类型和复杂度动态选择最优的处理策略。</p>
<p><strong>架构：</strong></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/867cf90ae2aa496eb94c184bbfc132a6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZGo5pyr56iL5bqP54y_:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766818928&amp;x-signature=n8LHCBmrPpc99fZg4kO7JcJl4h0%3D" alt="图片" loading="lazy"/></p>
<p><strong>实现步骤：</strong></p>
<ul>
<li>查询分类：分析用户查询的类型和复杂度（简单事实/多跳推理/开放性问题）</li>
<li>策略选择：根据查询类型选择最优的RAG策略</li>
<li>
<ul>
<li>简单查询：直接LLM回答或单次检索</li>
<li>复杂查询：多轮迭代检索</li>
<li>开放性问题：结合网络搜索</li>
</ul>
</li>
<li>动态路由：将查询路由到对应的处理流程</li>
<li>自适应检索：根据中间结果动态调整检索深度和范围</li>
<li>结果整合：整合不同策略的结果生成最终答案</li>
</ul>
<p><strong>参考代码：</strong></p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> langchain_openai <span class="hljs-keyword">import</span> ChatOpenAI
<span class="hljs-keyword">from</span> langchain_huggingface <span class="hljs-keyword">import</span> HuggingFaceEmbeddings
<span class="hljs-keyword">from</span> langchain_community.vectorstores <span class="hljs-keyword">import</span> LanceDB
<span class="hljs-keyword">from</span> langchain.schema <span class="hljs-keyword">import</span> Document
<span class="hljs-keyword">from</span> langchain.prompts <span class="hljs-keyword">import</span> ChatPromptTemplate
<span class="hljs-keyword">from</span> langchain_core.output_parsers <span class="hljs-keyword">import</span> StrOutputParser
<span class="hljs-keyword">from</span> langchain_core.runnables <span class="hljs-keyword">import</span> RunnableLambda, RunnablePassthrough
<span class="hljs-keyword">import</span> lancedb
<span class="hljs-keyword">from</span> enum <span class="hljs-keyword">import</span> Enum
<span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> <span class="hljs-type">List</span>

<span class="hljs-keyword">class</span> <span class="hljs-title class_">QueryType</span>(<span class="hljs-title class_ inherited__">Enum</span>):
    SIMPLE = <span class="hljs-string">"simple"</span>           <span class="hljs-comment"># 简单事实查询</span>
    MULTI_HOP = <span class="hljs-string">"multi_hop"</span>     <span class="hljs-comment"># 多跳推理查询</span>
    OPEN_ENDED = <span class="hljs-string">"open_ended"</span>   <span class="hljs-comment"># 开放性问题</span>
    NO_RETRIEVAL = <span class="hljs-string">"no_retrieval"</span><span class="hljs-comment"># 不需要检索</span>

<span class="hljs-keyword">class</span> <span class="hljs-title class_">AdaptiveRAG</span>:
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self</span>):
        self.llm = ChatOpenAI(model=<span class="hljs-string">"gpt-4"</span>, temperature=<span class="hljs-number">0</span>)
        <span class="hljs-comment"># 使用轻量级的all-MiniLM-L6-v2模型，仅80MB</span>
        self.embeddings = HuggingFaceEmbeddings(
            model_name=<span class="hljs-string">"sentence-transformers/all-MiniLM-L6-v2"</span>,
            model_kwargs={<span class="hljs-string">"device"</span>: <span class="hljs-string">"cpu"</span>},
            encode_kwargs={<span class="hljs-string">"normalize_embeddings"</span>: <span class="hljs-literal">True</span>}
        )
        self.db = lancedb.connect(<span class="hljs-string">"/tmp/lancedb_adaptive_rag"</span>)
        self.vectorstore = <span class="hljs-literal">None</span>
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">build_index</span>(<span class="hljs-params">self, documents: <span class="hljs-type">List</span>[<span class="hljs-built_in">str</span>]</span>):
        <span class="hljs-string">"""构建向量索引"""</span>
        docs = [Document(page_content=d) <span class="hljs-keyword">for</span> d <span class="hljs-keyword">in</span> documents]
        self.vectorstore = LanceDB.from_documents(
            docs, 
            self.embeddings,
            connection=self.db,
            table_name=<span class="hljs-string">"adaptive_rag_docs"</span>
        )
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">classify_query</span>(<span class="hljs-params">self, query: <span class="hljs-built_in">str</span></span>) -&gt; QueryType:
        <span class="hljs-string">"""分类查询类型"""</span>
        prompt = ChatPromptTemplate.from_template(
            <span class="hljs-string">"""分析以下查询的类型，返回对应类别：
            查询: {query}
            
            类别说明:
            - SIMPLE: 简单的事实性问题，可以直接从单个文档找到答案
            - MULTI_HOP: 需要综合多个信息源进行推理的复杂问题
            - OPEN_ENDED: 开放性问题，需要广泛的知识和创造性思考
            - NO_RETRIEVAL: 通用知识问题，不需要检索即可回答
            
            只返回类别名称(SIMPLE/MULTI_HOP/OPEN_ENDED/NO_RETRIEVAL):"""</span>
        )
        chain = prompt | self.llm | StrOutputParser()
        response = chain.invoke({<span class="hljs-string">"query"</span>: query}).strip().upper()
        mapping = {
            <span class="hljs-string">"SIMPLE"</span>: QueryType.SIMPLE,
            <span class="hljs-string">"MULTI_HOP"</span>: QueryType.MULTI_HOP,
            <span class="hljs-string">"OPEN_ENDED"</span>: QueryType.OPEN_ENDED,
            <span class="hljs-string">"NO_RETRIEVAL"</span>: QueryType.NO_RETRIEVAL
        }
        <span class="hljs-keyword">return</span> mapping.get(response, QueryType.SIMPLE)
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">simple_rag</span>(<span class="hljs-params">self, query: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">str</span>:
        <span class="hljs-string">"""简单RAG：单次检索"""</span>
        retriever = self.vectorstore.as_retriever(search_kwargs={<span class="hljs-string">"k"</span>: <span class="hljs-number">2</span>})
        
        prompt = ChatPromptTemplate.from_template(
            <span class="hljs-string">"基于以下内容回答问题：\n{context}\n\n问题：{question}\n答案："</span>
        )
        
        <span class="hljs-keyword">def</span> <span class="hljs-title function_">format_docs</span>(<span class="hljs-params">docs</span>):
            <span class="hljs-keyword">return</span><span class="hljs-string">"\n"</span>.join([d.page_content <span class="hljs-keyword">for</span> d <span class="hljs-keyword">in</span> docs])
        
        chain = (
            {<span class="hljs-string">"context"</span>: retriever | format_docs, <span class="hljs-string">"question"</span>: RunnablePassthrough()}
            | prompt
            | self.llm
            | StrOutputParser()
        )
        <span class="hljs-keyword">return</span> chain.invoke(query)
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">multi_hop_rag</span>(<span class="hljs-params">self, query: <span class="hljs-built_in">str</span>, max_hops: <span class="hljs-built_in">int</span> = <span class="hljs-number">3</span></span>) -&gt; <span class="hljs-built_in">str</span>:
        <span class="hljs-string">"""多跳RAG：迭代检索"""</span>
        accumulated_context = []
        current_query = query
        retriever = self.vectorstore.as_retriever(search_kwargs={<span class="hljs-string">"k"</span>: <span class="hljs-number">2</span>})
        
        <span class="hljs-keyword">for</span> hop <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(max_hops):
            <span class="hljs-comment"># 检索</span>
            docs = retriever.invoke(current_query)
            accumulated_context.extend([d.page_content <span class="hljs-keyword">for</span> d <span class="hljs-keyword">in</span> docs])
            
            <span class="hljs-comment"># 检查是否已有足够信息</span>
            context = <span class="hljs-string">"\n"</span>.join(accumulated_context)
            check_prompt = ChatPromptTemplate.from_template(
                <span class="hljs-string">"""基于当前收集的信息，判断是否足够回答问题。
                收集的信息: {context}
                问题: {query}
                
                回答YES如果信息足够，回答NO如果需要更多信息。
                如果回答NO，请提供下一步应该搜索的子问题。
                格式: YES 或 NO|子问题"""</span>
            )
            check_chain = check_prompt | self.llm | StrOutputParser()
            check_response = check_chain.invoke({<span class="hljs-string">"context"</span>: context, <span class="hljs-string">"query"</span>: query})
            
            <span class="hljs-keyword">if</span> check_response.strip().upper().startswith(<span class="hljs-string">"YES"</span>):
                <span class="hljs-keyword">break</span>
            eli<span class="hljs-string">f"|"</span><span class="hljs-keyword">in</span> check_response:
                current_query = check_response.split(<span class="hljs-string">"|"</span>)[<span class="hljs-number">1</span>].strip()
        
        <span class="hljs-comment"># 生成最终答案</span>
        final_context = <span class="hljs-string">"\n"</span>.join(accumulated_context)
        final_prompt = ChatPromptTemplate.from_template(
            <span class="hljs-string">"综合以下信息回答问题：\n{context}\n\n问题：{question}\n答案："</span>
        )
        final_chain = final_prompt | self.llm | StrOutputParser()
        <span class="hljs-keyword">return</span> final_chain.invoke({<span class="hljs-string">"context"</span>: final_context, <span class="hljs-string">"question"</span>: query})
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">open_ended_rag</span>(<span class="hljs-params">self, query: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">str</span>:
        <span class="hljs-string">"""开放性RAG：广泛检索+创造性生成"""</span>
        <span class="hljs-comment"># 扩展查询</span>
        expand_prompt = ChatPromptTemplate.from_template(
            <span class="hljs-string">"为以下问题生成3个相关的搜索查询：\n{query}\n查询列表："</span>
        )
        expand_chain = expand_prompt | self.llm | StrOutputParser()
        expanded = expand_chain.invoke({<span class="hljs-string">"query"</span>: query})
        queries = [query] + [q.strip() <span class="hljs-keyword">for</span> q <span class="hljs-keyword">in</span> expanded.split(<span class="hljs-string">"\n"</span>) <span class="hljs-keyword">if</span> q.strip()][:<span class="hljs-number">3</span>]
        
        <span class="hljs-comment"># 多查询检索</span>
        retriever = self.vectorstore.as_retriever(search_kwargs={<span class="hljs-string">"k"</span>: <span class="hljs-number">2</span>})
        all_docs = []
        <span class="hljs-keyword">for</span> q <span class="hljs-keyword">in</span> queries:
            docs = retriever.invoke(q)
            all_docs.extend([d.page_content <span class="hljs-keyword">for</span> d <span class="hljs-keyword">in</span> docs])
        
        <span class="hljs-comment"># 去重</span>
        unique_docs = <span class="hljs-built_in">list</span>(<span class="hljs-built_in">set</span>(all_docs))
        context = <span class="hljs-string">"\n"</span>.join(unique_docs[:<span class="hljs-number">5</span>])
        
        final_prompt = ChatPromptTemplate.from_template(
            <span class="hljs-string">"""基于以下信息，对问题给出全面、有见地的回答：
            信息: {context}
            问题: {question}
            
            请提供详细的分析和见解："""</span>
        )
        final_chain = final_prompt | self.llm | StrOutputParser()
        <span class="hljs-keyword">return</span> final_chain.invoke({<span class="hljs-string">"context"</span>: context, <span class="hljs-string">"question"</span>: query})
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">no_retrieval_generate</span>(<span class="hljs-params">self, query: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">str</span>:
        <span class="hljs-string">"""直接生成：不使用检索"""</span>
        prompt = ChatPromptTemplate.from_template(<span class="hljs-string">"请回答：{query}"</span>)
        chain = prompt | self.llm | StrOutputParser()
        <span class="hljs-keyword">return</span> chain.invoke({<span class="hljs-string">"query"</span>: query})
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">query</span>(<span class="hljs-params">self, question: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">str</span>:
        <span class="hljs-string">"""自适应查询主流程 - 使用LangChain路由"""</span>
        <span class="hljs-comment"># 1. 分类查询</span>
        query_type = self.classify_query(question)
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"查询类型: <span class="hljs-subst">{query_type.value}</span>"</span>)
        
        <span class="hljs-comment"># 2. 路由到对应策略</span>
        routing_map = {
            QueryType.SIMPLE: self.simple_rag,
            QueryType.MULTI_HOP: self.multi_hop_rag,
            QueryType.OPEN_ENDED: self.open_ended_rag,
            QueryType.NO_RETRIEVAL: self.no_retrieval_generate
        }
        <span class="hljs-keyword">return</span> routing_map[query_type](question)

<span class="hljs-comment"># 使用示例</span>
arag = AdaptiveRAG()
arag.build_index([<span class="hljs-string">"公司财报数据..."</span>, <span class="hljs-string">"市场分析报告..."</span>, <span class="hljs-string">"行业趋势..."</span>])
answer = arag.query(<span class="hljs-string">"分析公司未来的发展前景"</span>)  <span class="hljs-comment"># 会被识别为OPEN_ENDED</span>
<span class="hljs-built_in">print</span>(answer)
</code></pre>
<h2 data-id="heading-7">8. SFR RAG</h2>
<p><strong>简介：</strong></p>
<p>SFR RAG（Salesforce Research RAG）是工业级高质量 RAG 的最佳实践。它采用经过指令微调的高性能 embedding 模型（如 BGE），结合 Cross-Encoder 重排序、上下文压缩、引用生成和质量验证等多项优化技术。</p>
<p><strong>架构：</strong></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ad02654af9d646f2854979047c43080d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZGo5pyr56iL5bqP54y_:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766818928&amp;x-signature=zLZu5nudCscefZbhgOBpnlaA%2BKA%3D" alt="图片" loading="lazy"/></p>
<p><strong>实现步骤：</strong></p>
<ul>
<li>高质量Embedding：使用SFR（Salesforce Research）的高性能embedding模型进行文档和查询编码</li>
<li>指令微调检索：使用指令微调的检索模型，支持多种检索任务（问答、摘要、事实核查等）</li>
<li>上下文压缩：对检索到的文档进行智能压缩，去除冗余信息</li>
<li>重排序：使用专门的重排序模型对候选文档进行精细排序</li>
<li>引用生成：生成答案时附带引用来源，提高可信度</li>
<li>质量控制：对生成结果进行事实性检验和质量评估</li>
</ul>
<p><strong>参考代码：</strong></p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> langchain_openai <span class="hljs-keyword">import</span> ChatOpenAI
<span class="hljs-keyword">from</span> langchain_community.embeddings <span class="hljs-keyword">import</span> HuggingFaceBgeEmbeddings
<span class="hljs-keyword">from</span> langchain_community.vectorstores <span class="hljs-keyword">import</span> LanceDB
<span class="hljs-keyword">from</span> langchain_community.cross_encoders <span class="hljs-keyword">import</span> HuggingFaceCrossEncoder
<span class="hljs-keyword">from</span> langchain.retrievers.document_compressors <span class="hljs-keyword">import</span> CrossEncoderReranker
<span class="hljs-keyword">from</span> langchain.retrievers <span class="hljs-keyword">import</span> ContextualCompressionRetriever
<span class="hljs-keyword">from</span> langchain.schema <span class="hljs-keyword">import</span> Document
<span class="hljs-keyword">from</span> langchain.prompts <span class="hljs-keyword">import</span> ChatPromptTemplate
<span class="hljs-keyword">from</span> langchain_core.output_parsers <span class="hljs-keyword">import</span> StrOutputParser
<span class="hljs-keyword">import</span> lancedb
<span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> <span class="hljs-type">List</span>, <span class="hljs-type">Dict</span>

<span class="hljs-keyword">class</span> <span class="hljs-title class_">SFRRAG</span>:
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self</span>):
        <span class="hljs-comment"># 使用BGE高质量Embedding模型</span>
        self.embeddings = HuggingFaceBgeEmbeddings(
            model_name=<span class="hljs-string">"BAAI/bge-large-en-v1.5"</span>,
            model_kwargs={<span class="hljs-string">"device"</span>: <span class="hljs-string">"cpu"</span>},
            encode_kwargs={<span class="hljs-string">"normalize_embeddings"</span>: <span class="hljs-literal">True</span>},
            query_instruction=<span class="hljs-string">"为检索任务生成查询表示: "</span>
        )
        <span class="hljs-comment"># 重排序模型</span>
        self.reranker_model = HuggingFaceCrossEncoder(
            model_name=<span class="hljs-string">"cross-encoder/ms-marco-MiniLM-L-6-v2"</span>
        )
        self.llm = ChatOpenAI(model=<span class="hljs-string">"gpt-5"</span>, temperature=<span class="hljs-number">0</span>)
        self.db = lancedb.connect(<span class="hljs-string">"./lancedb_sfr_rag"</span>)
        self.vectorstore = <span class="hljs-literal">None</span>
        self.documents = []
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">build_index</span>(<span class="hljs-params">self, documents: <span class="hljs-type">List</span>[<span class="hljs-built_in">str</span>]</span>):
        <span class="hljs-string">"""构建高质量向量索引"""</span>
        self.documents = documents
        docs = [Document(page_content=d) <span class="hljs-keyword">for</span> d <span class="hljs-keyword">in</span> documents]
        self.vectorstore = LanceDB.from_documents(
            docs, 
            self.embeddings,
            connection=self.db,
            table_name=<span class="hljs-string">"sfr_rag_docs"</span>
        )
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">get_retriever_with_reranker</span>(<span class="hljs-params">self, top_k: <span class="hljs-built_in">int</span> = <span class="hljs-number">5</span></span>):
        <span class="hljs-string">"""创建带重排序的检索器"""</span>
        <span class="hljs-comment"># 基础检索器</span>
        base_retriever = self.vectorstore.as_retriever(search_kwargs={<span class="hljs-string">"k"</span>: <span class="hljs-number">10</span>})
        
        <span class="hljs-comment"># 重排序压缩器</span>
        reranker = CrossEncoderReranker(
            model=self.reranker_model, 
            top_n=top_k
        )
        
        <span class="hljs-comment"># 组合检索器</span>
        <span class="hljs-keyword">return</span> ContextualCompressionRetriever(
            base_compressor=reranker,
            base_retriever=base_retriever
        )
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">compress_context</span>(<span class="hljs-params">self, query: <span class="hljs-built_in">str</span>, documents: <span class="hljs-type">List</span>[Document]</span>) -&gt; <span class="hljs-built_in">str</span>:
        <span class="hljs-string">"""上下文压缩"""</span>
        doc_texts = <span class="hljs-string">"\n"</span>.join([<span class="hljs-string">f"[<span class="hljs-subst">{i+<span class="hljs-number">1</span>}</span>] <span class="hljs-subst">{doc.page_content}</span>"</span>
                              <span class="hljs-keyword">for</span> i, doc <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(documents)])
        prompt = ChatPromptTemplate.from_template(
            <span class="hljs-string">"""提取以下文档中与问题相关的关键信息：
            问题: {query}
            
            文档:
            {documents}
            
            请返回压缩后的关键信息，保留文档编号以便引用："""</span>
        )
        chain = prompt | self.llm | StrOutputParser()
        <span class="hljs-keyword">return</span> chain.invoke({<span class="hljs-string">"query"</span>: query, <span class="hljs-string">"documents"</span>: doc_texts})
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">generate_with_citations</span>(<span class="hljs-params">self, query: <span class="hljs-built_in">str</span>, context: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">str</span>:
        <span class="hljs-string">"""生成带引用的答案"""</span>
        prompt = ChatPromptTemplate.from_template(
            <span class="hljs-string">"""基于以下上下文回答问题，并标注引用来源[1][2]等。
            
            上下文: {context}
            
            问题: {query}
            
            要求：
            1. 准确回答问题
            2. 在相关陈述后标注引用来源
            3. 如果上下文不足以回答，请说明
            
            答案："""</span>
        )
        chain = prompt | self.llm | StrOutputParser()
        <span class="hljs-keyword">return</span> chain.invoke({<span class="hljs-string">"context"</span>: context, <span class="hljs-string">"query"</span>: query})
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">verify_answer</span>(<span class="hljs-params">self, query: <span class="hljs-built_in">str</span>, answer: <span class="hljs-built_in">str</span>, documents: <span class="hljs-type">List</span>[Document]</span>) -&gt; <span class="hljs-type">Dict</span>:
        <span class="hljs-string">"""验证答案质量"""</span>
        doc_contents = [doc.page_content <span class="hljs-keyword">for</span> doc <span class="hljs-keyword">in</span> documents]
        prompt = ChatPromptTemplate.from_template(
            <span class="hljs-string">"""评估以下答案的质量：
            问题: {query}
            答案: {answer}
            参考文档: {documents}
            
            评估维度(1-5分)：
            1. 准确性：答案是否被文档支持
            2. 完整性：答案是否全面回答了问题
            3. 相关性：答案是否紧扣问题
            
            返回格式: 准确性分数|完整性分数|相关性分数|总评"""</span>
        )
        chain = prompt | self.llm | StrOutputParser()
        response = chain.invoke({
            <span class="hljs-string">"query"</span>: query, 
            <span class="hljs-string">"answer"</span>: answer, 
            <span class="hljs-string">"documents"</span>: doc_contents
        })
        <span class="hljs-keyword">try</span>:
            parts = response.split(<span class="hljs-string">"|"</span>)
            <span class="hljs-keyword">return</span> {
                <span class="hljs-string">"accuracy"</span>: <span class="hljs-built_in">int</span>(parts[<span class="hljs-number">0</span>].strip()),
                <span class="hljs-string">"completeness"</span>: <span class="hljs-built_in">int</span>(parts[<span class="hljs-number">1</span>].strip()),
                <span class="hljs-string">"relevance"</span>: <span class="hljs-built_in">int</span>(parts[<span class="hljs-number">2</span>].strip()),
                <span class="hljs-string">"summary"</span>: parts[<span class="hljs-number">3</span>].strip() <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(parts) &gt; <span class="hljs-number">3</span><span class="hljs-keyword">else</span><span class="hljs-string">""</span>
            }
        <span class="hljs-keyword">except</span>:
            <span class="hljs-keyword">return</span> {<span class="hljs-string">"accuracy"</span>: <span class="hljs-number">3</span>, <span class="hljs-string">"completeness"</span>: <span class="hljs-number">3</span>, <span class="hljs-string">"relevance"</span>: <span class="hljs-number">3</span>, <span class="hljs-string">"summary"</span>: <span class="hljs-string">""</span>}
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">query</span>(<span class="hljs-params">self, question: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-type">Dict</span>:
        <span class="hljs-string">"""SFR-RAG主流程"""</span>
        <span class="hljs-comment"># 1. 初始检索 + 重排序</span>
        retriever = self.get_retriever_with_reranker(top_k=<span class="hljs-number">5</span>)
        docs = retriever.invoke(question)
        
        <span class="hljs-comment"># 2. 上下文压缩</span>
        compressed_context = self.compress_context(question, docs)
        
        <span class="hljs-comment"># 3. 生成带引用的答案</span>
        answer = self.generate_with_citations(question, compressed_context)
        
        <span class="hljs-comment"># 4. 质量验证</span>
        quality = self.verify_answer(question, answer, docs)
        
        <span class="hljs-keyword">return</span> {
            <span class="hljs-string">"answer"</span>: answer,
            <span class="hljs-string">"sources"</span>: [{<span class="hljs-string">"content"</span>: doc.page_content[:<span class="hljs-number">100</span>]} <span class="hljs-keyword">for</span> doc <span class="hljs-keyword">in</span> docs],
            <span class="hljs-string">"quality"</span>: quality
        }

<span class="hljs-comment"># 使用示例</span>
sfr_rag = SFRRAG()
sfr_rag.build_index([
    <span class="hljs-string">"人工智能是计算机科学的一个分支..."</span>,
    <span class="hljs-string">"机器学习是AI的核心技术之一..."</span>,
    <span class="hljs-string">"深度学习使用神经网络进行学习..."</span>
])
result = sfr_rag.query(<span class="hljs-string">"什么是人工智能？"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"答案: <span class="hljs-subst">{result[<span class="hljs-string">'answer'</span>]}</span>"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"质量评估: <span class="hljs-subst">{result[<span class="hljs-string">'quality'</span>]}</span>"</span>)
</code></pre>
<h2 data-id="heading-8">参考</h2>
<p>（1）<a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.langchain.com%2Foss%2Fpython%2Flangchain%2Foverview" target="_blank" title="https://docs.langchain.com/oss/python/langchain/overview" ref="nofollow noopener noreferrer">docs.langchain.com/oss/python/…</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[解决Tailwind任意值滥用：规范化CSS开发体验]]></title>    <link>https://juejin.cn/post/7585382553290752036</link>    <guid>https://juejin.cn/post/7585382553290752036</guid>    <pubDate>2025-12-20T07:15:30.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585382553290752036" data-draft-id="7585031571889930283" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="解决Tailwind任意值滥用：规范化CSS开发体验"/> <meta itemprop="keywords" content="前端,CSS,ESLint"/> <meta itemprop="datePublished" content="2025-12-20T07:15:30.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="远山无期"/> <meta itemprop="url" content="https://juejin.cn/user/1310273590526728"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            解决Tailwind任意值滥用：规范化CSS开发体验
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1310273590526728/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    远山无期
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-20T07:15:30.000Z" title="Sat Dec 20 2025 07:15:30 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>背景 <code>eslint-plugin-tailwindcss</code>插件的<code>no-unnecessary-arbitrary-value</code>无法对所有的任意值进行校验，比如<code>h-[48px]</code>、<code>text-[#f5f5f5]</code>无法校验出来。但tailwindcss的预设值太多了，一个不小心可能就又写了一个没有必要的任意值。为了避免这种情况，我们需要自己实现一个检测任意值的eslint插件。</p>
</blockquote>
<h2 data-id="heading-0">插件地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.npmjs.com%2Fpackage%2Feslint-plugin-tailwind-no-preset-class" target="_blank" title="https://www.npmjs.com/package/eslint-plugin-tailwind-no-preset-class" ref="nofollow noopener noreferrer">eslint-plugin-tailwind-no-preset-class</a></h2>
<h2 data-id="heading-1">首先来看下效果</h2>
<h3 data-id="heading-2">no-unnecessary-arbitrary-value 无法检测的情况</h3>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/043c2b930ece4a7285c452a827c0d3aa~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L-c5bGx5peg5pyf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766819730&amp;x-signature=F%2B9oCeYocy4yAlLcoktqfAdeMLM%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-3">使用自定义的：eslint-plugin-tailwind-no-preset-class插件，完美完成了校验</h3>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9ead78aa0a4746c48b6f75e2552a51b9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L-c5bGx5peg5pyf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766819730&amp;x-signature=NCb9n8Gm87M%2Bb83i5qxtHcHHrFk%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-4">创建eslint插件标准目录结构</h2>
<ul>
<li>安装Yeoman</li>
</ul>
<pre><code class="hljs language-sh" lang="sh">npm install -g yo
</code></pre>
<ul>
<li>安装Yeoman generator-eslint</li>
</ul>
<pre><code class="hljs language-sh" lang="sh">npm install -g generator-eslint
</code></pre>
<ul>
<li>创建项目</li>
</ul>
<pre><code class="hljs language-sh" lang="sh"><span class="hljs-built_in">mkdir</span> eslint-plugin-my-plugin
yo eslint:plugin
</code></pre>
<p>生成目录结构如下：</p>
<pre><code class="hljs language-perl" lang="perl">eslint-plugin-<span class="hljs-keyword">my</span>-plugin/
├── lib/                    <span class="hljs-comment"># 核心源代码目录</span>
│   ├── index.js           <span class="hljs-comment"># 插件的入口文件，在这里导出所有规则</span>
│   └── rules/             <span class="hljs-comment"># 存放所有自定义规则的目录</span>
│       └── <span class="hljs-keyword">my</span>-rule.js     <span class="hljs-comment"># 生成器为你创建的一条示例规则文件</span>
├── tests/                 <span class="hljs-comment"># 测试文件目录</span>
│   └── lib/
│       └── rules/
│           └── <span class="hljs-keyword">my</span>-rule.js <span class="hljs-comment"># 示例规则对应的测试文件</span>
├── package.json           <span class="hljs-comment"># 项目的 npm 配置文件，依赖和元信息都在这里</span>
└── README.md              <span class="hljs-comment"># 项目说明文档</span>
</code></pre>
<h2 data-id="heading-5">根据实际项目的tailwindcss配置文件和tailwindcss默认配置生成全量定制化配置，用于后续eslint插件的校验依据</h2>
<h3 data-id="heading-6">实现配置文件生成并加载方法：</h3>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// lib/tailwind-config-loader.js</span>
<span class="hljs-comment">// 配置文件生成</span>
...
...
<span class="hljs-comment">// 动态加载 Tailwind 预设配置</span>
<span class="hljs-keyword">let</span> tailwindPresetConfig = <span class="hljs-literal">null</span>;
...
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">generateTailwindConfig</span>(<span class="hljs-params">projectRootPath</span>) {
  <span class="hljs-keyword">try</span> {
    <span class="hljs-comment">// 动态导入tailwindcss</span>
    <span class="hljs-keyword">const</span> resolveConfigModule = <span class="hljs-keyword">await</span> <span class="hljs-keyword">import</span>(<span class="hljs-string">'tailwindcss/lib/public/resolve-config.js'</span>);
    <span class="hljs-keyword">const</span> resolveConfig = resolveConfigModule.<span class="hljs-property">default</span>.<span class="hljs-property">default</span>
    <span class="hljs-comment">// 尝试加载项目配置</span>
    <span class="hljs-keyword">let</span> projectConfig = {};
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">const</span> projectConfigPath = <span class="hljs-title function_">join</span>(projectRootPath||process.<span class="hljs-title function_">cwd</span>(), <span class="hljs-string">'tailwind.config.js'</span>);
      <span class="hljs-keyword">const</span> projectConfigModule = <span class="hljs-keyword">await</span> <span class="hljs-keyword">import</span>(projectConfigPath);
      projectConfig = projectConfigModule.<span class="hljs-property">default</span> || projectConfigModule;
    } <span class="hljs-keyword">catch</span> (error) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'⚠️ 未找到项目 tailwind.config.js，使用默认配置'</span>);
      <span class="hljs-keyword">throw</span> error;
    }

    <span class="hljs-comment">// 使用tailwindcss的resolveConfig函数</span>
    <span class="hljs-keyword">const</span> finalConfig = <span class="hljs-title function_">resolveConfig</span>(projectConfig);

    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'✅ Tailwind preset config generated successfully!'</span>);
    
    <span class="hljs-keyword">return</span> finalConfig;
  } <span class="hljs-keyword">catch</span> (error) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'❌ 生成Tailwind配置失败:'</span>, error.<span class="hljs-property">message</span>);
    <span class="hljs-keyword">throw</span> error;
  }
}


<span class="hljs-comment">// 加载配置到内存中</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">loadTailwindPresetConfig</span>(<span class="hljs-params">projectRootPath</span>) {
  <span class="hljs-keyword">if</span> (configLoading) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'⏳ 配置正在加载中，跳过重复请求'</span>);
    <span class="hljs-keyword">return</span>;
  }

  configLoading = <span class="hljs-literal">true</span>;

  <span class="hljs-keyword">try</span> {
    <span class="hljs-comment">// 直接动态生成配置</span>
    tailwindPresetConfig = <span class="hljs-keyword">await</span> <span class="hljs-title function_">generateTailwindConfig</span>(projectRootPath);
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'✅ Tailwind 预设配置已动态生成并加载'</span>);
    <span class="hljs-title function_">onConfigLoaded</span>();
  } <span class="hljs-keyword">catch</span> (error) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'❌ 动态生成 Tailwind 预设配置失败:'</span>, error.<span class="hljs-property">message</span>);
    <span class="hljs-title function_">onConfigLoadFailed</span>(error);
    <span class="hljs-keyword">throw</span> error;
  }
}


...
<span class="hljs-comment">// 导出配置</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title class_">TailwindConfigLoader</span> = {
  <span class="hljs-attr">getConfig</span>: <span class="hljs-function">() =&gt;</span> tailwindPresetConfig,
  <span class="hljs-attr">isLoaded</span>: <span class="hljs-function">() =&gt;</span> configLoaded,
  <span class="hljs-attr">ensureLoaded</span>: ensureConfigLoaded,
  <span class="hljs-attr">reload</span>: loadTailwindPresetConfig,
  <span class="hljs-attr">generateConfig</span>: generateTailwindConfig
};
...
...

</code></pre>
<h3 data-id="heading-7">创建校验规则函数</h3>
<ul>
<li>实现校验规则函数<code>checkAndReport</code></li>
</ul>
<pre><code class="hljs language-js" lang="js">...
<span class="hljs-comment">// 使用 WeakMap 来跟踪每个文件的已报告类名，避免重复报告</span>
<span class="hljs-keyword">const</span> reportedClassesMap = <span class="hljs-keyword">new</span> <span class="hljs-title class_">WeakMap</span>();
...
<span class="hljs-comment">// 检查并报告</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">checkAndReport</span>(<span class="hljs-params">context, node, className</span>) {
  <span class="hljs-comment">// 如果配置尚未加载，尝试等待加载</span>
  <span class="hljs-keyword">if</span> (!<span class="hljs-title class_">TailwindConfigLoader</span>.<span class="hljs-title function_">isLoaded</span>()) {
    <span class="hljs-keyword">try</span> {
        <span class="hljs-keyword">const</span> projectRootPath = context.<span class="hljs-title function_">getCwd</span>();
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`正在等待加载配置文件 <span class="hljs-subst">${projectRootPath}</span>...`</span>);
      <span class="hljs-keyword">const</span> loaded = <span class="hljs-keyword">await</span> <span class="hljs-title class_">TailwindConfigLoader</span>.<span class="hljs-title function_">ensureLoaded</span>(projectRootPath);
      <span class="hljs-keyword">if</span> (!loaded) {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">warn</span>(<span class="hljs-string">'⚠️ Tailwind 预设配置尚未加载，跳过检查'</span>);
        <span class="hljs-keyword">return</span>;
      }
    } <span class="hljs-keyword">catch</span> (error) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">warn</span>(<span class="hljs-string">'⚠️ 配置加载失败，跳过检查'</span>);
      <span class="hljs-keyword">return</span>;
    }
  }

  <span class="hljs-keyword">const</span> filePath = context.<span class="hljs-title function_">getFilename</span>();
  <span class="hljs-keyword">const</span> filePathWrapper = <span class="hljs-keyword">new</span> <span class="hljs-title class_">FilePathWrapper</span>(filePath);

  <span class="hljs-keyword">if</span> (!reportedClassesMap.<span class="hljs-title function_">has</span>(filePathWrapper)) {
    reportedClassesMap.<span class="hljs-title function_">set</span>(filePathWrapper, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Set</span>());
  }
  <span class="hljs-keyword">const</span> reportedClasses = reportedClassesMap.<span class="hljs-title function_">get</span>(filePathWrapper);

  <span class="hljs-keyword">if</span> (reportedClasses.<span class="hljs-title function_">has</span>(className)) {
    <span class="hljs-keyword">return</span>;
  }

  <span class="hljs-keyword">const</span> propertyInfo = <span class="hljs-title function_">extractProperty</span>(className);
  <span class="hljs-keyword">if</span> (!propertyInfo) {
    <span class="hljs-keyword">return</span>;
  }

  <span class="hljs-keyword">const</span> { property, value, originalPrefix } = propertyInfo;

  <span class="hljs-comment">// 只检查任意值</span>
  <span class="hljs-keyword">if</span> (<span class="hljs-title function_">isArbitraryValue</span>(value)) {
    <span class="hljs-keyword">const</span> arbitraryValue = value.<span class="hljs-title function_">slice</span>(<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>);
    <span class="hljs-keyword">const</span> presetClass = <span class="hljs-title function_">findPresetClass</span>(property, arbitraryValue);

    <span class="hljs-keyword">if</span> (presetClass) {
      reportedClasses.<span class="hljs-title function_">add</span>(className);
      <span class="hljs-comment">// 使用原始前缀显示正确的类名格式（如 h-14 而不是 height-14）</span>
      <span class="hljs-keyword">const</span> suggestedClass = <span class="hljs-string">`<span class="hljs-subst">${originalPrefix}</span><span class="hljs-subst">${presetClass}</span>`</span>;
      context.<span class="hljs-title function_">report</span>({
        node,
        <span class="hljs-attr">message</span>: <span class="hljs-string">`类名 "<span class="hljs-subst">${className}</span>" 使用了任意值，但存在对应的预设类名 "<span class="hljs-subst">${suggestedClass}</span>"。请使用预设类名替代。`</span>,
      });
    }
  }
}

</code></pre>
<ul>
<li>实现属性提取，将classname解析为tailwindcss的property和value</li>
</ul>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 提取属性值</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">extractProperty</span>(<span class="hljs-params">className</span>) {
  <span class="hljs-comment">// 处理响应式前缀（如 max-md:, md:, lg: 等）</span>
  <span class="hljs-keyword">const</span> responsivePrefixes = [
    <span class="hljs-string">'max-sm:'</span>,
    <span class="hljs-string">'max-md:'</span>,
    <span class="hljs-string">'max-lg:'</span>,
    <span class="hljs-string">'max-xl:'</span>,
    <span class="hljs-string">'max-2xl:'</span>,
    <span class="hljs-string">'max-'</span>,
    <span class="hljs-string">'min-'</span>,
    <span class="hljs-string">'sm:'</span>,
    <span class="hljs-string">'md:'</span>,
    <span class="hljs-string">'lg:'</span>,
    <span class="hljs-string">'xl:'</span>,
    <span class="hljs-string">'2xl:'</span>,
  ];

  <span class="hljs-comment">// 移除响应式前缀，保留核心类名</span>
  <span class="hljs-keyword">let</span> coreClassName = className;
  <span class="hljs-keyword">let</span> responsivePrefix = <span class="hljs-string">''</span>;

  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> prefix <span class="hljs-keyword">of</span> responsivePrefixes) {
    <span class="hljs-keyword">if</span> (className.<span class="hljs-title function_">startsWith</span>(prefix)) {
      responsivePrefix = prefix;
      coreClassName = className.<span class="hljs-title function_">slice</span>(prefix.<span class="hljs-property">length</span>);
      <span class="hljs-keyword">break</span>;
    }
  }

  <span class="hljs-comment">// 按前缀长度降序排序，优先匹配更长的前缀</span>
  <span class="hljs-keyword">const</span> sortedPrefixes = <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">keys</span>(prefixToProperty).<span class="hljs-title function_">sort</span>(
    <span class="hljs-function">(<span class="hljs-params">a, b</span>) =&gt;</span> b.<span class="hljs-property">length</span> - a.<span class="hljs-property">length</span>
  );

  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> prefix <span class="hljs-keyword">of</span> sortedPrefixes) {
    <span class="hljs-keyword">if</span> (coreClassName.<span class="hljs-title function_">startsWith</span>(prefix)) {
      <span class="hljs-keyword">return</span> {
        <span class="hljs-attr">property</span>: prefixToProperty[prefix],
        <span class="hljs-attr">value</span>: coreClassName.<span class="hljs-title function_">slice</span>(prefix.<span class="hljs-property">length</span>),
        <span class="hljs-attr">originalPrefix</span>: responsivePrefix + prefix, <span class="hljs-comment">// 包含响应式前缀</span>
      };
    }
  }

  <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
}
</code></pre>
<ul>
<li>将提取的property和前面生成的全量的tailwindcss进行映射</li>
</ul>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 简化属性映射，只保留常用的属性</span>
<span class="hljs-keyword">const</span> prefixToProperty = {
  <span class="hljs-comment">// 尺寸相关</span>
  <span class="hljs-string">"w-"</span>: <span class="hljs-string">"width"</span>,
  <span class="hljs-string">"h-"</span>: <span class="hljs-string">"height"</span>,
  <span class="hljs-string">"min-w-"</span>: <span class="hljs-string">"minWidth"</span>,
  <span class="hljs-string">"min-h-"</span>: <span class="hljs-string">"minHeight"</span>,
  <span class="hljs-string">"max-w-"</span>: <span class="hljs-string">"maxWidth"</span>,
  <span class="hljs-string">"max-h-"</span>: <span class="hljs-string">"maxHeight"</span>,

  <span class="hljs-comment">// 间距相关</span>
  <span class="hljs-string">"m-"</span>: <span class="hljs-string">"margin"</span>,
  <span class="hljs-string">"mt-"</span>: <span class="hljs-string">"marginTop"</span>,
  <span class="hljs-string">"mr-"</span>: <span class="hljs-string">"marginRight"</span>,
  <span class="hljs-string">"mb-"</span>: <span class="hljs-string">"marginBottom"</span>,
  <span class="hljs-string">"ml-"</span>: <span class="hljs-string">"marginLeft"</span>,
  <span class="hljs-string">"mx-"</span>: <span class="hljs-string">"margin"</span>,
  <span class="hljs-string">"my-"</span>: <span class="hljs-string">"margin"</span>,
  <span class="hljs-string">"p-"</span>: <span class="hljs-string">"padding"</span>,
  <span class="hljs-string">"pt-"</span>: <span class="hljs-string">"paddingTop"</span>,
  <span class="hljs-string">"pr-"</span>: <span class="hljs-string">"paddingRight"</span>,
  <span class="hljs-string">"pb-"</span>: <span class="hljs-string">"paddingBottom"</span>,
  <span class="hljs-string">"pl-"</span>: <span class="hljs-string">"paddingLeft"</span>,
  <span class="hljs-string">"px-"</span>: <span class="hljs-string">"padding"</span>,
  <span class="hljs-string">"py-"</span>: <span class="hljs-string">"padding"</span>,

  <span class="hljs-comment">// 边框相关（新增）</span>
  <span class="hljs-string">"border-"</span>: <span class="hljs-string">"borderWidth;borderColor"</span>,
  <span class="hljs-string">"border-t-"</span>: <span class="hljs-string">"borderWidth;borderColor"</span>,
  <span class="hljs-string">"border-r-"</span>: <span class="hljs-string">"borderWidth;borderColor"</span>,
  <span class="hljs-string">"border-b-"</span>: <span class="hljs-string">"borderWidth;borderColor"</span>,
  <span class="hljs-string">"border-l-"</span>: <span class="hljs-string">"borderWidth;borderColor"</span>,
  <span class="hljs-string">"border-x-"</span>: <span class="hljs-string">"borderWidth;borderColor"</span>,
  <span class="hljs-string">"border-y-"</span>: <span class="hljs-string">"borderWidth;borderColor"</span>,

  <span class="hljs-comment">// 圆角相关（新增）</span>
  <span class="hljs-string">"rounded-"</span>: <span class="hljs-string">"borderRadius"</span>,
  <span class="hljs-string">"rounded-t-"</span>: <span class="hljs-string">"borderRadius"</span>,
  <span class="hljs-string">"rounded-r-"</span>: <span class="hljs-string">"borderRadius"</span>,
  <span class="hljs-string">"rounded-b-"</span>: <span class="hljs-string">"borderRadius"</span>,
  <span class="hljs-string">"rounded-l-"</span>: <span class="hljs-string">"borderRadius"</span>,
  <span class="hljs-string">"rounded-tl-"</span>: <span class="hljs-string">"borderRadius"</span>,
  <span class="hljs-string">"rounded-tr-"</span>: <span class="hljs-string">"borderRadius"</span>,
  <span class="hljs-string">"rounded-br-"</span>: <span class="hljs-string">"borderRadius"</span>,
  <span class="hljs-string">"rounded-bl-"</span>: <span class="hljs-string">"borderRadius"</span>,

  <span class="hljs-comment">// 文字相关</span>
  <span class="hljs-string">"text-"</span>: <span class="hljs-string">"fontSize;color"</span>,
  <span class="hljs-string">"leading-"</span>: <span class="hljs-string">"lineHeight"</span>,
  <span class="hljs-string">"tracking-"</span>: <span class="hljs-string">"letterSpacing"</span>,
  <span class="hljs-string">"font-"</span>: <span class="hljs-string">"fontWeight"</span>,

  <span class="hljs-comment">// 背景相关</span>
  <span class="hljs-string">"bg-"</span>: <span class="hljs-string">"backgroundColor"</span>,

  <span class="hljs-comment">// SVG相关</span>
  <span class="hljs-string">"fill-"</span>: <span class="hljs-string">"fill"</span>,
  <span class="hljs-string">"stroke-"</span>: <span class="hljs-string">"stroke"</span>,
  <span class="hljs-string">"stroke-w-"</span>: <span class="hljs-string">"strokeWidth"</span>,

  <span class="hljs-comment">// 定位相关</span>
  <span class="hljs-string">"z-"</span>: <span class="hljs-string">"zIndex"</span>,
  <span class="hljs-string">"inset-"</span>: <span class="hljs-string">"inset"</span>,
  <span class="hljs-string">"top-"</span>: <span class="hljs-string">"top"</span>,
  <span class="hljs-string">"right-"</span>: <span class="hljs-string">"right"</span>,
  <span class="hljs-string">"bottom-"</span>: <span class="hljs-string">"bottom"</span>,
  <span class="hljs-string">"left-"</span>: <span class="hljs-string">"left"</span>,

  <span class="hljs-comment">// 布局相关（新增）</span>
  <span class="hljs-string">"gap-"</span>: <span class="hljs-string">"gap"</span>,
  <span class="hljs-string">"gap-x-"</span>: <span class="hljs-string">"gap"</span>,
  <span class="hljs-string">"gap-y-"</span>: <span class="hljs-string">"gap"</span>,
  <span class="hljs-string">"space-x-"</span>: <span class="hljs-string">"gap"</span>,
  <span class="hljs-string">"space-y-"</span>: <span class="hljs-string">"gap"</span>,

  <span class="hljs-comment">// 透明度</span>
  <span class="hljs-string">"opacity-"</span>: <span class="hljs-string">"opacity"</span>,

  <span class="hljs-comment">// 变换相关（新增）</span>
  <span class="hljs-string">"scale-"</span>: <span class="hljs-string">"scale"</span>,
  <span class="hljs-string">"scale-x-"</span>: <span class="hljs-string">"scale"</span>,
  <span class="hljs-string">"scale-y-"</span>: <span class="hljs-string">"scale"</span>,
  <span class="hljs-string">"rotate-"</span>: <span class="hljs-string">"rotate"</span>,
  <span class="hljs-string">"translate-x-"</span>: <span class="hljs-string">"translate"</span>,
  <span class="hljs-string">"translate-y-"</span>: <span class="hljs-string">"translate"</span>,
  <span class="hljs-string">"skew-x-"</span>: <span class="hljs-string">"skew"</span>,
  <span class="hljs-string">"skew-y-"</span>: <span class="hljs-string">"skew"</span>,

  <span class="hljs-comment">// 阴影相关（新增）</span>
  <span class="hljs-string">"shadow-"</span>: <span class="hljs-string">"boxShadow"</span>,

  <span class="hljs-comment">// 网格相关（新增）</span>
  <span class="hljs-string">"grid-cols-"</span>: <span class="hljs-string">"gridTemplateColumns"</span>,
  <span class="hljs-string">"grid-rows-"</span>: <span class="hljs-string">"gridTemplateRows"</span>,
  <span class="hljs-string">"col-"</span>: <span class="hljs-string">"gridColumn"</span>,
  <span class="hljs-string">"row-"</span>: <span class="hljs-string">"gridRow"</span>,
  <span class="hljs-string">"col-start-"</span>: <span class="hljs-string">"gridColumnStart"</span>,
  <span class="hljs-string">"col-end-"</span>: <span class="hljs-string">"gridColumnEnd"</span>,
  <span class="hljs-string">"row-start-"</span>: <span class="hljs-string">"gridRowStart"</span>,
  <span class="hljs-string">"row-end-"</span>: <span class="hljs-string">"gridRowEnd"</span>,

  <span class="hljs-comment">// Flexbox相关（新增）</span>
  <span class="hljs-string">"flex-"</span>: <span class="hljs-string">"flex"</span>,
  <span class="hljs-string">"basis-"</span>: <span class="hljs-string">"flexBasis"</span>,
  <span class="hljs-string">"grow-"</span>: <span class="hljs-string">"flexGrow"</span>,
  <span class="hljs-string">"shrink-"</span>: <span class="hljs-string">"flexShrink"</span>,
  <span class="hljs-string">"order-"</span>: <span class="hljs-string">"order"</span>,

  <span class="hljs-comment">// 动画相关（新增）</span>
  <span class="hljs-string">"duration-"</span>: <span class="hljs-string">"transitionDuration"</span>,
  <span class="hljs-string">"delay-"</span>: <span class="hljs-string">"transitionDelay"</span>,
  <span class="hljs-string">"ease-"</span>: <span class="hljs-string">"transitionTimingFunction"</span>,

  <span class="hljs-comment">// 其他（新增）</span>
  <span class="hljs-string">"aspect-"</span>: <span class="hljs-string">"aspectRatio"</span>,
  <span class="hljs-string">"cursor-"</span>: <span class="hljs-string">"cursor"</span>,
};

<span class="hljs-comment">// 动态构建支持的 Tailwind 属性映射</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">getSupportedProperties</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> config = <span class="hljs-title class_">TailwindConfigLoader</span>.<span class="hljs-title function_">getConfig</span>();
  <span class="hljs-keyword">if</span> (!config) {
    <span class="hljs-keyword">return</span> {};
  }

  <span class="hljs-keyword">return</span> {
    <span class="hljs-attr">width</span>: config.<span class="hljs-property">theme</span>.<span class="hljs-property">width</span>,
    <span class="hljs-attr">height</span>: config.<span class="hljs-property">theme</span>.<span class="hljs-property">height</span>,
    <span class="hljs-attr">minWidth</span>: config.<span class="hljs-property">theme</span>.<span class="hljs-property">minWidth</span>,
    <span class="hljs-attr">minHeight</span>: config.<span class="hljs-property">theme</span>.<span class="hljs-property">minHeight</span>,
    <span class="hljs-attr">maxWidth</span>: config.<span class="hljs-property">theme</span>.<span class="hljs-property">maxWidth</span>,
    <span class="hljs-attr">maxHeight</span>: config.<span class="hljs-property">theme</span>.<span class="hljs-property">maxHeight</span>,
    <span class="hljs-attr">margin</span>: config.<span class="hljs-property">theme</span>.<span class="hljs-property">margin</span>,
    <span class="hljs-attr">marginTop</span>: config.<span class="hljs-property">theme</span>.<span class="hljs-property">margin</span>,
    <span class="hljs-attr">marginRight</span>: config.<span class="hljs-property">theme</span>.<span class="hljs-property">margin</span>,
    <span class="hljs-attr">marginBottom</span>: config.<span class="hljs-property">theme</span>.<span class="hljs-property">margin</span>,
    <span class="hljs-attr">marginLeft</span>: config.<span class="hljs-property">theme</span>.<span class="hljs-property">margin</span>,
    <span class="hljs-attr">padding</span>: config.<span class="hljs-property">theme</span>.<span class="hljs-property">padding</span>,
    <span class="hljs-attr">paddingTop</span>: config.<span class="hljs-property">theme</span>.<span class="hljs-property">padding</span>,
    <span class="hljs-attr">paddingRight</span>: config.<span class="hljs-property">theme</span>.<span class="hljs-property">padding</span>,
    <span class="hljs-attr">paddingBottom</span>: config.<span class="hljs-property">theme</span>.<span class="hljs-property">padding</span>,
    <span class="hljs-attr">paddingLeft</span>: config.<span class="hljs-property">theme</span>.<span class="hljs-property">padding</span>,
    <span class="hljs-attr">fontSize</span>: config.<span class="hljs-property">theme</span>.<span class="hljs-property">fontSize</span>,
    <span class="hljs-attr">lineHeight</span>: config.<span class="hljs-property">theme</span>.<span class="hljs-property">lineHeight</span>,
    <span class="hljs-attr">borderRadius</span>: config.<span class="hljs-property">theme</span>.<span class="hljs-property">borderRadius</span>,
    <span class="hljs-attr">color</span>: config.<span class="hljs-property">theme</span>.<span class="hljs-property">colors</span>,
    <span class="hljs-attr">backgroundColor</span>: config.<span class="hljs-property">theme</span>.<span class="hljs-property">backgroundColor</span>,
    <span class="hljs-attr">borderColor</span>: config.<span class="hljs-property">theme</span>.<span class="hljs-property">borderColor</span>,
    <span class="hljs-attr">fill</span>: config.<span class="hljs-property">theme</span>.<span class="hljs-property">fill</span>,
    <span class="hljs-attr">stroke</span>: config.<span class="hljs-property">theme</span>.<span class="hljs-property">stroke</span>,
    <span class="hljs-attr">borderWidth</span>: config.<span class="hljs-property">theme</span>.<span class="hljs-property">borderWidth</span>,
    <span class="hljs-attr">zIndex</span>: config.<span class="hljs-property">theme</span>.<span class="hljs-property">zIndex</span>,
    <span class="hljs-attr">gap</span>: config.<span class="hljs-property">theme</span>.<span class="hljs-property">gap</span>,
    <span class="hljs-attr">inset</span>: config.<span class="hljs-property">theme</span>.<span class="hljs-property">inset</span>,
    <span class="hljs-attr">top</span>: config.<span class="hljs-property">theme</span>.<span class="hljs-property">spacing</span>,
    <span class="hljs-attr">right</span>: config.<span class="hljs-property">theme</span>.<span class="hljs-property">spacing</span>,
    <span class="hljs-attr">bottom</span>: config.<span class="hljs-property">theme</span>.<span class="hljs-property">spacing</span>,
    <span class="hljs-attr">left</span>: config.<span class="hljs-property">theme</span>.<span class="hljs-property">spacing</span>,
    <span class="hljs-attr">opacity</span>: config.<span class="hljs-property">theme</span>.<span class="hljs-property">opacity</span>,
  };
}
</code></pre>
<h2 data-id="heading-8">整体实现流程</h2>
<pre><code class="hljs language-mermaid" lang="mermaid">graph TD
    A[ESLint 执行插件] --&gt; B[遍历代码中的类名]
    B --&gt; C{是否为 Tailwind 类名?}
    C --&gt;|否| D[跳过检查]
    C --&gt;|是| E{是否包含任意值?}
    E --&gt;|否| F[使用预设值 通过检查]
    E --&gt;|是| G[提取类名前缀和任意值]
    
    G --&gt; H[通过 prefixToProperty 映射到CSS属性]
    H --&gt; I[检查Tailwind配置是否已加载]
    I --&gt;|已加载| J[获取支持的属性预设值]
    I --&gt;|未加载| K[加载项目Tailwind配置]
    
    K --&gt; L[读取项目tailwind.config.js]
    L --&gt; M{配置是否存在?}
    M --&gt;|不存在| N[使用Tailwind默认配置]
    M --&gt;|存在| O[解析项目配置]
    
    O --&gt; P[合并默认配置和项目配置]
    N --&gt; P
    
    P --&gt; Q[生成全量Tailwind配置]
    Q --&gt; R[缓存配置到内存]
    R --&gt; J
    
    J --&gt; S{判断属性类型}
    S --&gt;|颜色相关| T[调用 findColorPreset]
    S --&gt;|数值相关| U[调用 findNumericPreset]
    
    T --&gt; V{是否匹配预设?}
    U --&gt; V
    
    V --&gt;|是| W[找到对应预设类名]
    V --&gt;|否| X[未找到预设类名]
    
    W --&gt; Y[生成建议消息]
    X --&gt; Z[通过检查 无匹配预设]
    
    Y --&gt; AA[报告建议]
    Z --&gt; BB[检查完成]
    
    AA --&gt; BB
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[windows系统搭建kafka环境]]></title>    <link>https://juejin.cn/post/7585397173023735827</link>    <guid>https://juejin.cn/post/7585397173023735827</guid>    <pubDate>2025-12-20T07:21:34.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585397173023735827" data-draft-id="7585382553290719268" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="windows系统搭建kafka环境"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-12-20T07:21:34.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="苏三的开发日记"/> <meta itemprop="url" content="https://juejin.cn/user/4248949048749213"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            windows系统搭建kafka环境
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4248949048749213/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    苏三的开发日记
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-20T07:21:34.000Z" title="Sat Dec 20 2025 07:21:34 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>kafka内置zk，因此没必要安装zk。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fkafka.apache.org%2Fcommunity%2Fdownloads%2F" target="_blank" title="https://kafka.apache.org/community/downloads/" ref="nofollow noopener noreferrer">kafka.apache.org/community/d…</a></p>
<p>1.修改zookeeper.properties文件</p>
<pre><code class="hljs language-js" lang="js">dataDir=<span class="hljs-attr">E</span>:<span class="hljs-regexp">/kafka_2.12-3.6.1/</span>data/zk
</code></pre>
<p>2.修改server.properties文件</p>
<pre><code class="hljs language-js" lang="js">log.<span class="hljs-property">dirs</span>=<span class="hljs-attr">e</span>:<span class="hljs-regexp">/kafka/</span>data/kafka
</code></pre>
<p>3.配置zk.cmd</p>
<pre><code class="hljs language-js" lang="js">call bin/windows/kafka-server-start.<span class="hljs-property">bat</span> config/server.<span class="hljs-property">properties</span>
</code></pre>
<p>4.配置kafka.cmd</p>
<pre><code class="hljs language-js" lang="js">call bin/windows/zookeeper-server-start.<span class="hljs-property">bat</span> config/zookeeper.<span class="hljs-property">properties</span>
</code></pre>
<p>5.一些常用的命令</p>
<pre><code class="hljs language-js" lang="js">kafka-topics.<span class="hljs-property">bat</span> 相关

 --bootstrap-server : 把当前的<span class="hljs-variable constant_">DOS</span>窗口当成<span class="hljs-title class_">Kafka</span>的客户端
 --create : 表示对主题的创建操作，是个操作参数，后面无需增加参数值
 --topic : 主题的名称
 --list : 表示对所有主题的查询操作，是个操作参数，后面无需增加参数值
 --describe : 查看主题的详细信息
 --alter : 表示对所有主题的查询操作，是个操作参数，后面无需增加参数值
--partitions : 修改的配置参数：分区数量
 --<span class="hljs-attr">delete</span>: 表示对主题的删除操作，是个操作参数，后面无需增加参数值。默认情况下，删除操作是逻辑删除，也就是说数据存储的文件依然存在，
但是通过指令查询不出来。如果想要直接删除，需要在server.<span class="hljs-property">properties</span>文件中设置参数<span class="hljs-keyword">delete</span>.<span class="hljs-property">topic</span>.<span class="hljs-property">enable</span>=<span class="hljs-literal">true</span>

kafka-topics.<span class="hljs-property">bat</span> --bootstrap-server <span class="hljs-attr">localhost</span>:<span class="hljs-number">9092</span> --create --topic test
kafka-topics.<span class="hljs-property">bat</span> --bootstrap-server <span class="hljs-attr">localhost</span>:<span class="hljs-number">9092</span> --list
kafka-topics.<span class="hljs-property">bat</span> --bootstrap-server <span class="hljs-attr">localhost</span>:<span class="hljs-number">9092</span> --describe --topic test
kafka-topics.<span class="hljs-property">bat</span> --bootstrap-server <span class="hljs-attr">localhost</span>:<span class="hljs-number">9092</span> --topic test --alter --partitions <span class="hljs-number">2</span>
kafka-topics.<span class="hljs-property">bat</span> --bootstrap-server <span class="hljs-attr">localhost</span>:<span class="hljs-number">9092</span> --topic test --<span class="hljs-keyword">delete</span>

<span class="hljs-attr">notice</span>:
windows系统中由于权限或进程锁定的问题，删除topic会导致kafka服务节点异常关闭。

kafka-<span class="hljs-variable language_">console</span>-producer.<span class="hljs-property">bat</span> 相关

kafka-<span class="hljs-variable language_">console</span>-producer.<span class="hljs-property">bat</span> --bootstrap-server <span class="hljs-attr">localhost</span>:<span class="hljs-number">9092</span> --topic test

typing message you want to send

kafka-<span class="hljs-variable language_">console</span>-consumer.<span class="hljs-property">bat</span> 相关

--<span class="hljs-keyword">from</span>-beginning : 从第一条数据开始消费，无参数值，是一个标记参数

kafka-<span class="hljs-variable language_">console</span>-consumer.<span class="hljs-property">bat</span> --bootstrap-server <span class="hljs-attr">localhost</span>:<span class="hljs-number">9092</span> --topic test --<span class="hljs-keyword">from</span>-beginning

</code></pre>
<p>6.windows端模拟集群服务的搭建</p>
<pre><code class="hljs language-js" lang="js">解压kafka_2<span class="hljs-number">.12</span>-<span class="hljs-number">3.6</span><span class="hljs-number">.1</span>.<span class="hljs-property">tgz</span> 分别生成<span class="hljs-number">4</span>个文件夹 node-<span class="hljs-number">1</span>,node-<span class="hljs-number">2</span>,node-<span class="hljs-number">3</span>,zookeeper


node-<span class="hljs-number">1</span> 修改server.<span class="hljs-property">properties</span>
broker.<span class="hljs-property">id</span>=<span class="hljs-number">1</span>
listeners=<span class="hljs-attr">PLAINTEXT</span>:<span class="hljs-comment">//:9091 log.dirs=E:/kafka/node-1/data zookeeper.connect=localhost:2181/kafka</span>

node-<span class="hljs-number">2</span> 修改server.<span class="hljs-property">properties</span> 
broker.<span class="hljs-property">id</span>=<span class="hljs-number">2</span> 
listeners=<span class="hljs-attr">PLAINTEXT</span>:<span class="hljs-comment">//:9092 log.dirs=E:/kafka/node-2/data zookeeper.connect=localhost:2181/kafka</span>

node-<span class="hljs-number">3</span> 修改server.<span class="hljs-property">properties</span>
broker.<span class="hljs-property">id</span>=<span class="hljs-number">3</span> 
listeners=<span class="hljs-attr">PLAINTEXT</span>:<span class="hljs-comment">//:9093 log.dirs=E:/kafka/node-3/data zookeeper.connect=localhost:2181/kafka</span>


zookeeper文件夹添加zk.<span class="hljs-property">cmd</span>
zk.<span class="hljs-property">cmd</span>内容：
call bin/windows/zookeeper-server-start.<span class="hljs-property">bat</span> config/zookeeper.<span class="hljs-property">properties</span>



node-<span class="hljs-number">1</span> node-<span class="hljs-number">2</span> node-<span class="hljs-number">3</span> 添加kafka.<span class="hljs-property">cmd</span>
kafka.<span class="hljs-property">cmd</span>内容：
call bin/windows/kafka-server-start.<span class="hljs-property">bat</span> config/server.<span class="hljs-property">properties</span>

node-<span class="hljs-number">1</span> 同级别路径添加cluster.<span class="hljs-property">cmd</span> cluster-clear.<span class="hljs-property">cmd</span>
</code></pre>
<p>7.cluster.cmd</p>
<pre><code class="hljs language-js" lang="js">cd zookeeper
start zk.<span class="hljs-property">cmd</span>
ping <span class="hljs-number">127.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span> -n <span class="hljs-number">10</span> &gt;nul
cd ../node-<span class="hljs-number">1</span>
start kafka.<span class="hljs-property">cmd</span>
cd ../node-<span class="hljs-number">2</span>
start kafka.<span class="hljs-property">cmd</span>
cd ../node-<span class="hljs-number">3</span>
start kafka.<span class="hljs-property">cmd</span>
</code></pre>
<p>8.cluster-clear.cmd</p>
<pre><code class="hljs language-js" lang="js">cd zookeeper
rd /s /q data
cd ../node-<span class="hljs-number">1</span>
rd /s /q data
cd ../node-<span class="hljs-number">2</span>
rd /s /q data
cd ../node-<span class="hljs-number">3</span>
rd /s /q data
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[PyTorch动态图编程与自定义网络层实战教程]]></title>    <link>https://juejin.cn/post/7585446706327322633</link>    <guid>https://juejin.cn/post/7585446706327322633</guid>    <pubDate>2025-12-20T07:21:14.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585446706327322633" data-draft-id="7585706951583334409" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="PyTorch动态图编程与自定义网络层实战教程"/> <meta itemprop="keywords" content="Python"/> <meta itemprop="datePublished" content="2025-12-20T07:21:14.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="test管家"/> <meta itemprop="url" content="https://juejin.cn/user/2763513988408746"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            PyTorch动态图编程与自定义网络层实战教程
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2763513988408746/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    test管家
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-20T07:21:14.000Z" title="Sat Dec 20 2025 07:21:14 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读11分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在深度学习框架的发展中，PyTorch凭借<strong>动态计算图</strong>的灵活性成为科研和工程领域的主流选择，其动态图机制打破了静态图框架的编译限制，让开发者能以更贴近Python的编程习惯构建模型。而在实际项目中，面对个性化的业务需求（如定制化激活函数、特殊卷积操作），PyTorch内置的网络层往往无法满足要求，此时掌握<strong>自定义网络层</strong>的实现方法就成为进阶的关键。</p>
<h2 data-id="heading-0">一、PyTorch动态图编程：原理与实战</h2>
<h3 data-id="heading-1">1.1 动态图与静态图的核心差异</h3>
<p>深度学习中的计算图是对模型运算流程的可视化抽象，本质是由节点（张量运算）和边（张量数据）组成的有向图。PyTorch的动态图（Dynamic Computational Graph）与TensorFlow1.x的静态图（Static Computational Graph）核心区别在于<strong>图的构建时机</strong>：</p>
<ul>
<li><strong>静态图</strong>：先定义完整的计算图结构，再将数据喂入执行，图的结构一旦确定无法实时修改，优势是编译优化后执行效率高，但调试和动态逻辑实现难度大。</li>
<li><strong>动态图</strong>：随代码执行<strong>即时构建</strong>计算图，每运行一行运算代码，就向图中添加一个节点，图的结构可根据输入数据或条件判断动态调整，支持Python原生的循环、分支等控制流，调试时能像普通Python代码一样逐行查看张量值。</li>
</ul>
<p>PyTorch的动态图机制基于<strong>Autograd</strong>（自动求导引擎）实现，Autograd会记录张量的所有运算操作，并在反向传播时自动计算梯度，这也是动态图能够支持实时求导的核心。</p>
<h3 data-id="heading-2">1.2 动态图的自动求导基础</h3>
<p>PyTorch中只有设置<code>requires_grad=True</code>的张量，才会被Autograd追踪运算并构建计算图。我们通过简单的张量运算示例，直观理解动态图的构建与求导过程：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> torch

<span class="hljs-comment"># 定义需要求导的张量</span>
x = torch.tensor([<span class="hljs-number">2.0</span>], requires_grad=<span class="hljs-literal">True</span>)
y = torch.tensor([<span class="hljs-number">3.0</span>], requires_grad=<span class="hljs-literal">True</span>)

<span class="hljs-comment"># 动态构建计算图：z = x² + 2xy + y³</span>
z = x ** <span class="hljs-number">2</span> + <span class="hljs-number">2</span> * x * y + y ** <span class="hljs-number">3</span>

<span class="hljs-comment"># 反向传播，计算z对x和y的梯度</span>
z.backward()

<span class="hljs-comment"># 打印梯度结果</span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"dz/dx: <span class="hljs-subst">{x.grad.item()}</span>"</span>)  <span class="hljs-comment"># 理论值：2x+2y = 4+6=10</span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"dz/dy: <span class="hljs-subst">{y.grad.item()}</span>"</span>)  <span class="hljs-comment"># 理论值：2x+3y² =4+27=31</span>
</code></pre>
<p>运行结果会输出<code>dz/dx: 10.0</code>和<code>dz/dy: 31.0</code>，与理论计算一致。这里需要注意：Autograd构建的计算图是<strong>动态临时</strong>的，每次<code>backward()</code>后，计算图会被释放，若需重复求导需设置<code>retain_graph=True</code>。</p>
<h3 data-id="heading-3">1.3 动态控制流的实现</h3>
<p>动态图的核心优势是支持Python原生控制流，比如根据张量的值动态选择运算分支。以下示例模拟一个“根据输入值决定循环次数”的动态运算，展示动态图的灵活性：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">dynamic_operation</span>(<span class="hljs-params">x</span>):
    <span class="hljs-comment"># 初始化输出张量</span>
    out = torch.tensor([<span class="hljs-number">0.0</span>], requires_grad=<span class="hljs-literal">True</span>)
    <span class="hljs-comment"># 根据x的数值动态确定循环次数</span>
    loop_times = <span class="hljs-built_in">int</span>(x.item()) <span class="hljs-keyword">if</span> x.item() &gt; <span class="hljs-number">0</span> <span class="hljs-keyword">else</span> <span class="hljs-number">1</span>
    
    <span class="hljs-comment"># 动态循环构建计算图</span>
    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(loop_times):
        out = out + x * (i + <span class="hljs-number">1</span>)
    <span class="hljs-keyword">return</span> out

<span class="hljs-comment"># 测试不同输入的动态运算</span>
x1 = torch.tensor([<span class="hljs-number">2.0</span>], requires_grad=<span class="hljs-literal">True</span>)
res1 = dynamic_operation(x1)
res1.backward()
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"输入x=2时，梯度为：<span class="hljs-subst">{x1.grad.item()}</span>"</span>)  <span class="hljs-comment"># 循环2次：1*2 + 2*2 =6，梯度为3</span>

x2 = torch.tensor([-<span class="hljs-number">1.0</span>], requires_grad=<span class="hljs-literal">True</span>)
res2 = dynamic_operation(x2)
res2.backward()
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"输入x=-1时，梯度为：<span class="hljs-subst">{x2.grad.item()}</span>"</span>)  <span class="hljs-comment"># 循环1次：1*(-1)，梯度为1</span>
</code></pre>
<p>上述代码中，循环次数由输入张量<code>x</code>的数值决定，静态图框架需通过特殊算子实现此类逻辑，而PyTorch的动态图可直接使用Python循环，大幅降低代码复杂度。</p>
<h3 data-id="heading-4">1.4 实战：动态图实现线性回归</h3>
<p>我们结合动态图和Autograd，实现一个简单的线性回归模型，完整展示动态图的建模、训练流程：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> torch
<span class="hljs-keyword">import</span> matplotlib.pyplot <span class="hljs-keyword">as</span> plt

<span class="hljs-comment"># 1. 生成模拟数据</span>
torch.manual_seed(<span class="hljs-number">42</span>)  <span class="hljs-comment"># 固定随机种子</span>
x = torch.randn(<span class="hljs-number">100</span>, <span class="hljs-number">1</span>)  <span class="hljs-comment"># 特征：100个样本，1个特征</span>
y = <span class="hljs-number">3</span> * x + <span class="hljs-number">2</span> + torch.randn(<span class="hljs-number">100</span>, <span class="hljs-number">1</span>) * <span class="hljs-number">0.5</span>  <span class="hljs-comment"># 标签：y=3x+2+噪声</span>

<span class="hljs-comment"># 2. 定义模型参数（需要求导）</span>
w = torch.tensor([<span class="hljs-number">1.0</span>], requires_grad=<span class="hljs-literal">True</span>)
b = torch.tensor([<span class="hljs-number">0.0</span>], requires_grad=<span class="hljs-literal">True</span>)

<span class="hljs-comment"># 3. 定义线性回归前向传播（动态构建计算图）</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">linear_model</span>(<span class="hljs-params">x</span>):
    <span class="hljs-keyword">return</span> w * x + b

<span class="hljs-comment"># 4. 定义损失函数（均方误差）</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">mse_loss</span>(<span class="hljs-params">y_pred, y_true</span>):
    <span class="hljs-keyword">return</span> torch.mean((y_pred - y_true) ** <span class="hljs-number">2</span>)

<span class="hljs-comment"># 5. 训练模型（动态图实时更新）</span>
learning_rate = <span class="hljs-number">0.1</span>
loss_list = []
<span class="hljs-keyword">for</span> epoch <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">100</span>):
    <span class="hljs-comment"># 前向传播：动态构建计算图</span>
    y_pred = linear_model(x)
    loss = mse_loss(y_pred, y)
    
    <span class="hljs-comment"># 反向传播：自动计算梯度</span>
    loss.backward()
    
    <span class="hljs-comment"># 更新参数（需禁用梯度追踪，避免加入计算图）</span>
    <span class="hljs-keyword">with</span> torch.no_grad():
        w -= learning_rate * w.grad
        b -= learning_rate * b.grad
        <span class="hljs-comment"># 清空梯度，避免累积</span>
        w.grad.zero_()
        b.grad.zero_()
    
    loss_list.append(loss.item())
    <span class="hljs-keyword">if</span> (epoch + <span class="hljs-number">1</span>) % <span class="hljs-number">10</span> == <span class="hljs-number">0</span>:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"Epoch <span class="hljs-subst">{epoch+<span class="hljs-number">1</span>}</span>, Loss: <span class="hljs-subst">{loss.item():<span class="hljs-number">.4</span>f}</span>, w: <span class="hljs-subst">{w.item():<span class="hljs-number">.4</span>f}</span>, b: <span class="hljs-subst">{b.item():<span class="hljs-number">.4</span>f}</span>"</span>)

<span class="hljs-comment"># 6. 可视化损失变化</span>
plt.plot(loss_list)
plt.xlabel(<span class="hljs-string">"Epoch"</span>)
plt.ylabel(<span class="hljs-string">"MSE Loss"</span>)
plt.title(<span class="hljs-string">"Training Loss Curve"</span>)
plt.show()
</code></pre>
<p>训练完成后，<code>w</code>会趋近于3，<code>b</code>趋近于2，完美拟合模拟数据的线性关系。整个过程中，计算图随每次前向传播动态构建，反向传播后自动释放，体现了PyTorch动态图“随用随建”的特点。</p>
<h2 data-id="heading-5">二、PyTorch自定义网络层：从简单到复杂</h2>
<p>PyTorch的<code>torch.nn</code>模块提供了丰富的内置层（如<code>nn.Linear</code>、<code>nn.Conv2d</code>），但面对定制化需求时，我们需要基于<code>nn.Module</code>或<code>nn.Function</code>实现自定义层。其中<code>nn.Module</code>是PyTorch中所有网络层和模型的基类，封装了参数管理、设备迁移、前向传播等核心功能，是自定义层的首选方式。</p>
<h3 data-id="heading-6">2.1 自定义网络层的核心：继承nn.Module</h3>
<p>所有自定义网络层都需要继承<code>nn.Module</code>，并实现**<code>forward()</code>方法**（定义前向传播逻辑）。<code>nn.Module</code>会自动处理参数的注册、梯度计算和设备迁移，核心要点：</p>
<ol>
<li>可学习参数需用<code>nn.Parameter</code>封装（会被自动注册到模型的<code>parameters()</code>中）；</li>
<li>非可学习参数可直接定义为张量（需设置<code>requires_grad=False</code>）；</li>
<li><code>forward()</code>方法中实现张量的运算逻辑。</li>
</ol>
<h3 data-id="heading-7">2.2 无参数自定义层：定制化激活函数</h3>
<p>首先实现一个无参数的自定义层——<strong>带阈值的ReLU激活层</strong>（ReLU-Threshold），当输入值大于阈值时输出原值，否则输出0：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> torch
<span class="hljs-keyword">import</span> torch.nn <span class="hljs-keyword">as</span> nn

<span class="hljs-keyword">class</span> <span class="hljs-title class_">ReLUThreshold</span>(nn.Module):
    <span class="hljs-string">"""自定义带阈值的ReLU激活层"""</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, threshold=<span class="hljs-number">0.5</span></span>):
        <span class="hljs-built_in">super</span>(ReLUThreshold, self).__init__()
        <span class="hljs-comment"># 无学习参数，直接定义为实例变量</span>
        self.threshold = threshold
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">forward</span>(<span class="hljs-params">self, x</span>):
        <span class="hljs-comment"># 前向传播逻辑：x &gt; threshold 则输出x，否则输出0</span>
        <span class="hljs-keyword">return</span> torch.where(x &gt; self.threshold, x, torch.tensor(<span class="hljs-number">0.0</span>, device=x.device))

<span class="hljs-comment"># 测试自定义激活层</span>
relu_thresh = ReLUThreshold(threshold=<span class="hljs-number">0.3</span>)
x = torch.tensor([-<span class="hljs-number">0.2</span>, <span class="hljs-number">0.1</span>, <span class="hljs-number">0.4</span>, <span class="hljs-number">1.0</span>])
output = relu_thresh(x)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"自定义激活层输出：<span class="hljs-subst">{output}</span>"</span>)  <span class="hljs-comment"># 输出：tensor([0.0000, 0.0000, 0.4000, 1.0000])</span>
</code></pre>
<p>该层无需要学习的参数，仅需在<code>__init__</code>中定义阈值，<code>forward</code>中实现核心运算即可。需要注意的是，使用<code>torch.where</code>时要保证张量的设备一致性（<code>device=x.device</code>），避免CPU/GPU张量混合运算的错误。</p>
<h3 data-id="heading-8">2.3 带参数自定义层：自定义全连接层</h3>
<p>接下来实现带可学习参数的自定义层——<strong>自定义全连接层</strong>（CustomLinear），模拟<code>nn.Linear</code>的功能，手动实现权重和偏置的参数注册与前向运算：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">CustomLinear</span>(nn.Module):
    <span class="hljs-string">"""自定义全连接层"""</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, in_features, out_features</span>):
        <span class="hljs-built_in">super</span>(CustomLinear, self).__init__()
        <span class="hljs-comment"># 注册可学习参数：权重和偏置（nn.Parameter会自动加入参数列表）</span>
        self.weight = nn.Parameter(torch.randn(out_features, in_features))
        self.bias = nn.Parameter(torch.randn(out_features))
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">forward</span>(<span class="hljs-params">self, x</span>):
        <span class="hljs-comment"># 前向传播：y = x @ W.T + b</span>
        <span class="hljs-keyword">return</span> torch.matmul(x, self.weight.t()) + self.bias

<span class="hljs-comment"># 测试自定义全连接层</span>
custom_linear = CustomLinear(in_features=<span class="hljs-number">5</span>, out_features=<span class="hljs-number">3</span>)
<span class="hljs-comment"># 查看层的可学习参数</span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">"自定义全连接层参数："</span>)
<span class="hljs-keyword">for</span> name, param <span class="hljs-keyword">in</span> custom_linear.named_parameters():
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"<span class="hljs-subst">{name}</span>: <span class="hljs-subst">{param.shape}</span>"</span>)

<span class="hljs-comment"># 输入测试：1个样本，5个特征</span>
x = torch.randn(<span class="hljs-number">1</span>, <span class="hljs-number">5</span>)
output = custom_linear(x)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"自定义全连接层输出形状：<span class="hljs-subst">{output.shape}</span>"</span>)  <span class="hljs-comment"># 输出：torch.Size([1, 3])</span>
</code></pre>
<p>这里<code>nn.Parameter</code>是关键，它继承自<code>torch.Tensor</code>，但会被<code>nn.Module</code>自动识别为可学习参数，在训练时参与梯度更新。如果直接使用<code>torch.tensor</code>定义权重，参数不会被注册，反向传播时无法计算梯度。</p>
<h3 data-id="heading-9">2.4 进阶：自定义卷积层（深度可分离卷积）</h3>
<p>在计算机视觉任务中，深度可分离卷积（Depthwise Separable Convolution）是轻量化模型的常用操作，PyTorch虽有<code>nn.Conv2d</code>，但我们可以自定义实现该层，理解其核心原理：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">DepthwiseSeparableConv</span>(nn.Module):
    <span class="hljs-string">"""自定义深度可分离卷积层"""</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, in_channels, out_channels, kernel_size=<span class="hljs-number">3</span>, stride=<span class="hljs-number">1</span>, padding=<span class="hljs-number">1</span></span>):
        <span class="hljs-built_in">super</span>(DepthwiseSeparableConv, self).__init__()
        <span class="hljs-comment"># 深度卷积：逐通道卷积，不改变通道数</span>
        self.depthwise = nn.Conv2d(
            in_channels=in_channels,
            out_channels=in_channels,
            kernel_size=kernel_size,
            stride=stride,
            padding=padding,
            groups=in_channels  <span class="hljs-comment"># groups等于通道数实现逐通道卷积</span>
        )
        <span class="hljs-comment"># 点卷积：1x1卷积，调整通道数</span>
        self.pointwise = nn.Conv2d(
            in_channels=in_channels,
            out_channels=out_channels,
            kernel_size=<span class="hljs-number">1</span>,
            stride=<span class="hljs-number">1</span>,
            padding=<span class="hljs-number">0</span>
        )
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">forward</span>(<span class="hljs-params">self, x</span>):
        <span class="hljs-comment"># 前向传播：深度卷积 -&gt; 点卷积</span>
        x = self.depthwise(x)
        x = self.pointwise(x)
        <span class="hljs-keyword">return</span> x

<span class="hljs-comment"># 测试深度可分离卷积层</span>
ds_conv = DepthwiseSeparableConv(in_channels=<span class="hljs-number">3</span>, out_channels=<span class="hljs-number">16</span>)
<span class="hljs-comment"># 输入：1个样本，3通道，224x224的图像</span>
x = torch.randn(<span class="hljs-number">1</span>, <span class="hljs-number">3</span>, <span class="hljs-number">224</span>, <span class="hljs-number">224</span>)
output = ds_conv(x)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"深度可分离卷积输出形状：<span class="hljs-subst">{output.shape}</span>"</span>)  <span class="hljs-comment"># 输出：torch.Size([1, 16, 224, 224])</span>
</code></pre>
<p>该层通过组合内置的<code>nn.Conv2d</code>实现自定义功能，体现了PyTorch模块化编程的灵活性。深度可分离卷积将标准卷积拆分为深度卷积和点卷积，大幅减少了参数量和计算量，是MobileNet等轻量模型的核心组件。</p>
<h3 data-id="heading-10">2.5 底层自定义：基于nn.Function实现运算</h3>
<p>如果需要更精细地控制梯度的计算过程（比如手动实现反向传播），可以基于<code>nn.Function</code>实现自定义运算。<code>nn.Function</code>是PyTorch中更底层的接口，需同时实现<code>forward()</code>和<code>backward()</code>方法，适合对求导逻辑有特殊定制的场景。</p>
<p>以下实现一个简单的平方运算层，手动定义前向和反向传播：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">SquareFunction</span>(torch.autograd.Function):
    <span class="hljs-string">"""基于nn.Function的自定义平方运算"""</span>
<span class="hljs-meta">    @staticmethod</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">forward</span>(<span class="hljs-params">ctx, x</span>):
        <span class="hljs-comment"># 前向传播：保存输入张量到ctx，供反向传播使用</span>
        ctx.save_for_backward(x)
        <span class="hljs-keyword">return</span> x ** <span class="hljs-number">2</span>
    
<span class="hljs-meta">    @staticmethod</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">backward</span>(<span class="hljs-params">ctx, grad_output</span>):
        <span class="hljs-comment"># 反向传播：计算梯度，grad_output是上游梯度</span>
        x, = ctx.saved_tensors
        grad_x = <span class="hljs-number">2</span> * x * grad_output  <span class="hljs-comment"># 平方的导数是2x，乘以上游梯度</span>
        <span class="hljs-keyword">return</span> grad_x

<span class="hljs-comment"># 封装为nn.Module层（方便与其他层组合）</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">SquareLayer</span>(nn.Module):
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">forward</span>(<span class="hljs-params">self, x</span>):
        <span class="hljs-keyword">return</span> SquareFunction.apply(x)

<span class="hljs-comment"># 测试自定义运算的梯度计算</span>
square_layer = SquareLayer()
x = torch.tensor([<span class="hljs-number">3.0</span>], requires_grad=<span class="hljs-literal">True</span>)
y = square_layer(x)
y.backward()
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"平方运算输出：<span class="hljs-subst">{y.item()}</span>"</span>)  <span class="hljs-comment"># 输出：9.0</span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"平方运算梯度：<span class="hljs-subst">{x.grad.item()}</span>"</span>)  <span class="hljs-comment"># 输出：6.0（2*3）</span>
</code></pre>
<p><code>nn.Function</code>的<code>forward</code>方法通过<code>ctx.save_for_backward()</code>保存张量，<code>backward</code>方法接收上游梯度并计算当前层的梯度。需要注意的是，<code>nn.Function</code>的方法必须是静态的，且通过<code>apply()</code>方法调用。</p>
<h3 data-id="heading-11">2.6 实战：组合自定义层构建完整模型</h3>
<p>最后，我们将前面实现的自定义层组合起来，构建一个简单的图像分类模型，展示自定义层在实际模型中的应用：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">CustomModel</span>(nn.Module):
    <span class="hljs-string">"""组合自定义层的图像分类模型"""</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, num_classes=<span class="hljs-number">10</span></span>):
        <span class="hljs-built_in">super</span>(CustomModel, self).__init__()
        <span class="hljs-comment"># 自定义深度可分离卷积层</span>
        self.ds_conv1 = DepthwiseSeparableConv(in_channels=<span class="hljs-number">3</span>, out_channels=<span class="hljs-number">32</span>)
        self.ds_conv2 = DepthwiseSeparableConv(in_channels=<span class="hljs-number">32</span>, out_channels=<span class="hljs-number">64</span>)
        <span class="hljs-comment"># 自定义激活层</span>
        self.relu_thresh = ReLUThreshold(threshold=<span class="hljs-number">0.1</span>)
        <span class="hljs-comment"># 池化层</span>
        self.pool = nn.MaxPool2d(kernel_size=<span class="hljs-number">2</span>, stride=<span class="hljs-number">2</span>)
        <span class="hljs-comment"># 自定义全连接层</span>
        self.fc1 = CustomLinear(in_features=<span class="hljs-number">64</span>*<span class="hljs-number">56</span>*<span class="hljs-number">56</span>, out_features=<span class="hljs-number">128</span>)
        self.fc2 = CustomLinear(in_features=<span class="hljs-number">128</span>, out_features=num_classes)
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">forward</span>(<span class="hljs-params">self, x</span>):
        <span class="hljs-comment"># 卷积层 + 激活 + 池化</span>
        x = self.pool(self.relu_thresh(self.ds_conv1(x)))
        x = self.pool(self.relu_thresh(self.ds_conv2(x)))
        <span class="hljs-comment"># 展平</span>
        x = x.view(x.size(<span class="hljs-number">0</span>), -<span class="hljs-number">1</span>)
        <span class="hljs-comment"># 全连接层</span>
        x = self.relu_thresh(self.fc1(x))
        x = self.fc2(x)
        <span class="hljs-keyword">return</span> x

<span class="hljs-comment"># 测试自定义模型</span>
model = CustomModel(num_classes=<span class="hljs-number">10</span>)
<span class="hljs-comment"># 输入：2个样本，3通道，224x224的图像</span>
x = torch.randn(<span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">224</span>, <span class="hljs-number">224</span>)
output = model(x)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"自定义模型输出形状：<span class="hljs-subst">{output.shape}</span>"</span>)  <span class="hljs-comment"># 输出：torch.Size([2, 10])</span>

<span class="hljs-comment"># 查看模型的所有参数</span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">"\n模型参数列表："</span>)
<span class="hljs-keyword">for</span> name, param <span class="hljs-keyword">in</span> model.named_parameters():
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"<span class="hljs-subst">{name}</span>: <span class="hljs-subst">{param.shape}</span>"</span>)
</code></pre>
<p>该模型组合了深度可分离卷积、自定义激活层和全连接层，完全基于PyTorch的模块化机制构建，可像内置模型一样进行训练、保存和加载。</p>
<h2 data-id="heading-12">三、自定义层的常见问题与优化技巧</h2>
<h3 data-id="heading-13">3.1 参数注册的注意事项</h3>
<ul>
<li>必须使用<code>nn.Parameter</code>封装可学习参数，否则参数不会被加入<code>model.parameters()</code>，训练时无法更新；</li>
<li>若需定义多个参数，可使用<code>nn.ParameterList</code>或<code>nn.ParameterDict</code>批量注册，例如：
<pre><code class="hljs language-python" lang="python">self.params = nn.ParameterList([nn.Parameter(torch.randn(<span class="hljs-number">3</span>, <span class="hljs-number">3</span>)) <span class="hljs-keyword">for</span> _ <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">2</span>)])
</code></pre>
</li>
</ul>
<h3 data-id="heading-14">3.2 设备迁移的正确性</h3>
<p>自定义层中的张量（如非参数的常量）需与输入张量的设备保持一致，可通过<code>x.device</code>获取输入设备，避免“CPU张量与CUDA张量混合运算”的错误。也可在模型初始化时指定设备，或使用<code>model.to(device)</code>自动迁移参数（<code>nn.Parameter</code>会被自动迁移）。</p>
<h3 data-id="heading-15">3.3 提升自定义层的执行效率</h3>
<ul>
<li>尽量使用PyTorch的内置张量运算（如<code>torch.matmul</code>、<code>torch.conv2d</code>），避免Python原生循环（效率极低）；</li>
<li>对于重复的运算逻辑，可封装为<code>nn.functional</code>中的函数（如<code>F.relu</code>、<code>F.max_pool2d</code>），减少代码冗余；</li>
<li>若自定义层需在GPU上加速，确保所有运算都使用CUDA张量，可通过<code>torch.cuda.is_available()</code>判断设备并自动切换。</li>
</ul>
<h3 data-id="heading-16">3.4 梯度验证</h3>
<p>自定义层（尤其是基于<code>nn.Function</code>的层）需验证梯度计算的正确性，可使用<code>torch.autograd.gradcheck</code>工具进行梯度检查：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 梯度检查：验证SquareFunction的梯度是否正确</span>
x = torch.tensor([<span class="hljs-number">3.0</span>], dtype=torch.double, requires_grad=<span class="hljs-literal">True</span>)
test = torch.autograd.gradcheck(SquareFunction.apply, x, eps=<span class="hljs-number">1e-6</span>, atol=<span class="hljs-number">1e-4</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"梯度检查结果：<span class="hljs-subst">{test}</span>"</span>)  <span class="hljs-comment"># 输出True表示梯度正确</span>
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Java方法（函数）完全指南：初学者的第一个"工具箱"]]></title>    <link>https://juejin.cn/post/7585412203978637355</link>    <guid>https://juejin.cn/post/7585412203978637355</guid>    <pubDate>2025-12-20T07:21:23.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585412203978637355" data-draft-id="7585382553290784804" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Java方法（函数）完全指南：初学者的第一个&quot;工具箱&quot;"/> <meta itemprop="keywords" content="Java"/> <meta itemprop="datePublished" content="2025-12-20T07:21:23.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="吃西红柿长大的番茄"/> <meta itemprop="url" content="https://juejin.cn/user/3097787706900985"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Java方法（函数）完全指南：初学者的第一个"工具箱"
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3097787706900985/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    吃西红柿长大的番茄
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-20T07:21:23.000Z" title="Sat Dec 20 2025 07:21:23 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读11分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252b3a}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px;color:#5e7ce0}.markdown-body h1{font-size:24px;margin-bottom:5px;margin-top:80px;position:relative;text-align:center}.markdown-body h2{font-size:20px;padding-bottom:12px;border-bottom:1px solid #dfe1e6}.markdown-body h3{font-size:18px;padding-bottom:0}.markdown-body h4{font-size:16px;margin-top:30px}.markdown-body h5{font-size:14px;margin-top:20px}.markdown-body h6{font-size:14px;margin-top:5px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #dfe1e6;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#ffeeed;color:#c73636;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#252b3a;background:#f8f8f8}.markdown-body a{position:relative;text-decoration:none;color:#5e7ce0;padding-right:18px;padding-bottom:4px}.markdown-body a[href^=http]:after{position:absolute;display:inline-block;width:16px;height:16px;margin-left:2px;margin-top:6px;content:"";background:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAAXNSR0IArs4c6QAAAIRlWElmTU0AKgAAAAgABQESAAMAAAABAAEAAAEaAAUAAAABAAAASgEbAAUAAAABAAAAUgEoAAMAAAABAAIAAIdpAAQAAAABAAAAWgAAAAAAAABIAAAAAQAAAEgAAAABAAOgAQADAAAAAQABAACgAgAEAAAAAQAAACCgAwAEAAAAAQAAACAAAAAAX7wP8AAAAAlwSFlzAAALEwAACxMBAJqcGAAAAVlpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IlhNUCBDb3JlIDYuMC4wIj4KICAgPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4KICAgICAgPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIKICAgICAgICAgICAgeG1sbnM6dGlmZj0iaHR0cDovL25zLmFkb2JlLmNvbS90aWZmLzEuMC8iPgogICAgICAgICA8dGlmZjpPcmllbnRhdGlvbj4xPC90aWZmOk9yaWVudGF0aW9uPgogICAgICA8L3JkZjpEZXNjcmlwdGlvbj4KICAgPC9yZGY6UkRGPgo8L3g6eG1wbWV0YT4KGV7hBwAABWVJREFUWAnlVktsVFUY/s85997pC9BOTKxRWnEKsXWlxjWJj0RWJjrFAAXjAlewYWOkgauACVu7a2IiNUEyExM3yoZE3Wmi7qgPJthJBDE6JUNpO3Mf5/j95/bOTOcBlBgXejJ37rn/Of/7O/9/iP7vQ/zTAcjnC4ry+a5ii1OkiYTpuvjvEc0Gp51uivP+ZW+QBuSW4QjW5rptAa1Ey0uOGKOxwPetVyafN6p/52/PkNBbjdAhGaGEpMRjLZTryB8+9MUSYSGNRIcBvm8kBAY9tHYlHz78nTs392xIkwv9FA3Oe33bdoX1ZZKOS0bH0CXI6RugYLW6BwIu5gskkQ4sEG0wYF25PjBzbZfSYY6kDLUmWMt7FR7Lw3xYUkaTdjxHfTPnPwav0iEGYADVa9XIRIEyxrAA0jIQxgFL22gYwF7A8/DAzNVdksJvJaTEUZ2kYnZWziN5s1ADPHneEIXByotYuMSrf9JEbbsuv7VcvbaKML8plXtQR0EdIYDqWEmtOgAomZFH8EjWSnek2ulmtljljttHbmaIHCCCHzd9MjwfsmscBeZH9Jyd10nMvz92UQrtCBKvMF06mQy0SiEdRMEGg8mN0YjAlgoDDkPrMI5qJKSkKKydpbB2CZjJkhIBvOBw2CGQgii85bpx//dMqFRKam5uvH7w+K97oe+Cl0HO68uIBH0qyEzpOMwIbZIcFq0I+9cwoElizCjk2KFI1y7Nnx614W1db58fOXIlMzs7Xn/jeDmvBV2Q0mXjGf554O/m4LZHp2N8r61WPMvLZWLdiC4GMAk5BjeeB5lhv39l6+BIbu3m760hXMDKBD08XBKzR8fr04nygnIypOOAJUx/fHrsi0Mnys+vVK+V4VUohaiyPCo2Q9DFALvF/ikw8WS4QvVZALS5ksw47/7R8ejgTPk1UFqU6/3zp8bOM7B/kdu/fkguPGU5JibW+F0sTjWOUw8DklRrg4BiLGeBqbaRLxjlT4no0InFV402RcftJz41cH/f/JnHP3kZaaF6VX/liwist9vYG5+NU9Cg3MNkt/+lU5wS8fTxq3mc7ILjDlAE4CJpe89BOWPiIjBhi9O6PI4G1jsc6RGB3lZwmS76k8H0zOKTkFboG8jS2krFKCX2fvTeaPHIBwAkMHHgncURnL3nuCSnxSopdIzN5th0BIonJ0Lf9yUA9iMkzdRWl3BixOusfDcwQVcS4UKIFwYfGPnM8wY/DyP9NFMXaTE5BU39tGkDgGZz+fJJG0oYcSaOafLcqdECY4LzfSObSzyUOgxqtyisr8SSNOOAkubWoh3TTaeA2YtFEXPnm5x81/j+6MI6JqyS25WSNU6hbCMKHG84marJbdR+vwakRhQLRuQpbzHRLjmpmijI+OmWCtq+LzWtnX5v30gHSsqmWne74DtiACi2+Wz0iXbuLt9D2cDyoPEkWOiyp5XUIwLMi/wJY1FbH5B9ONtdC1KrsD/Q0MCQAS0wccILORDW25amAeOtooAj/KQxfzF17uwTSQ1v3dJ7jnLINwdZYRDa4tPU0sHVXFo/vxFF5BqFqxRfOmgPCk4ft2NgKTCy2Y47JIEg+MIhjYsLy5I25qUYTQlCjMRHsr/UwdYwIK33UO1J5fFNB9XNO6akcywJofVmXQDP2wfrSPcI2xG5BSs3I+IosHr4EtvO1TDAu16xHQq5+ykMblfRXLbhEoFIdDTBdhldvzl+3CMg60ZktI2vNzLW6IIp0waLklot9L63yzuUp8dJd7bglPFe3hIXstBEP58/s6Ocyr4rH2+866ZNbriTzA0RSOWCwakMl1QJgculxPt8Z7O5GLdtW6bvU8R/nO1vb+hMExVAVtEAAAAASUVORK5CYII=");background-size:100%}.markdown-body a:active,.markdown-body a:hover{border-bottom:2px solid #5e7ce0}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #5e7ce0;border-spacing:0}.markdown-body thead{color:#fff;text-align:left}.markdown-body thead tr{background:#5e7ce0}.markdown-body thead th{border-bottom:1px solid #dfe1e6}.markdown-body tr{background-color:#fff}.markdown-body tr:nth-child(2n){background-color:#f2f5fc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#252b3a;padding:1px 23px;margin:22px 0;border-left:4px solid #5e7ce0;background-color:#f2f5fc}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{padding-left:10px;margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol li::marker,.markdown-body ul li::marker{color:#5e7ce0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body ul li::marker{content:"•";color:#5e7ce0}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}.markdown-body input[type=checkbox]:before{display:inline-block;width:16px;height:16px;content:"";background:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEIAAABCCAYAAADjVADoAAAK2GlDQ1BJQ0MgUHJvZmlsZQAASImVlwdUU9kWhs+96Y0WiHRC70gngJTQQxGkg6iEJJBQYkgIKmJnUMGxoCKCZcSKKFhGQMaCWLANAopdJ8igoD4HC6Ki5t3AI8zMW++99fZaJ+dbO/vss/e55671XwAoYWyRKBdWAyBPWCCODQ2gJ6ek0nHPAQRgQAI2wIHNkYiYMTGRALHJ+a/28S4Sjdhte0Wuf///v5oGlyfhAAClIZzBlXDyEG5DxkuOSFwAAOoI4jddUCBScBfCmmKkQIR/V3DWBH9ScMY4o8njMfGxgQjTAcCT2WxxFgBkO8RPL+RkIXnIih4chVyBEOFihH05fDYX4TMI2+XlzVfwIMJWSLwIAApyOoCR8aecWX/Jn6HMz2ZnKXmir3HDBwkkolz2ov/zaP635eVKJ/ewQAaZLw6LVeyHnN/9nPkRShZmzIyeZAF3oiYF86VhCZPMkQSmTjKXHRShXJs7M3KSMwUhLGWeAlb8JPMkwXGTLJ4fq9wrUxzInGS2eHxfIsIyaU6C0s/nsZT5i/jxSZNcKEicOcmSnLiIqZhApV8sjVXWzxOGBkztG6LsPU/yp34FLOXaAn58mLJ39lT9PCFzKqckWVkblxcUPBWToIwXFQQo9xLlxijjebmhSr+kME65tgC5nFNrY5RnmM0Oj5lkIABRgA04dNVJAqCAt7BA0UjgfNEisSCLX0BnIm8bj84Schzs6M6Ozs4AKN7dievwnjb+TkK061O+NYjHr10ul5+e8oUi9/i4KfJYbk35LCsAUNUD4Op+jlRcOOFDK34wyNNTBZpABxgCU2AF7IEzcAfewB8Eg3AQDeJBCpiL1MoHeUAMFoBisAKUgnKwEWwF1WA32AsOgaPgBGgGZ8AFcAXcAF2gFzwCMjAAXoFh8BGMQRCEgygQFdKBjCBzyBZyhhiQLxQMRUKxUAqUDmVBQkgKFUOroHKoAqqG9kB10HHoNHQBugZ1Qw+gPmgIegd9gVEwGdaEDWALeDrMgJlwBBwPz4Gz4Hy4CC6B18NVcC18BG6CL8A34F5YBr+CR1AARULRUMYoexQDFYiKRqWiMlFi1FJUGaoSVYtqQLWiOlC3UTLUa9RnNBZNRdPR9mhvdBg6Ac1B56OXotehq9GH0E3oS+jb6D70MPo7hoLRx9hivDAsTDImC7MAU4qpxBzAnMJcxvRiBjAfsVgsDWuJ9cCGYVOw2djF2HXYndhGbBu2G9uPHcHhcDo4W5wPLhrHxhXgSnHbcUdw53E9uAHcJzwJb4R3xofgU/FC/Ep8Jf4w/hy+B/8CP0ZQI5gTvAjRBC5hEWEDYR+hlXCLMEAYI6oTLYk+xHhiNnEFsYrYQLxMfEx8TyKRTEiepFkkAWk5qYp0jHSV1Ef6TNYg25ADyWlkKXk9+SC5jfyA/J5CoVhQ/CmplALKekod5SLlKeWTClXFQYWlwlVZplKj0qTSo/JGlaBqrspUnatapFqpelL1luprNYKahVqgGlttqVqN2mm1e2oj6lR1J/Vo9Tz1deqH1a+pD2rgNCw0gjW4GiUaezUuavRTUVRTaiCVQ11F3Ue9TB3QxGpaarI0szXLNY9qdmoOa2louWolai3UqtE6qyWjoWgWNBYtl7aBdoJ2l/ZlmsE05jTetLXTGqb1TBvV1tP21+Zpl2k3avdqf9Gh6wTr5Ohs0mnWeaKL1rXRnaW7QHeX7mXd13qaet56HL0yvRN6D/VhfRv9WP3F+nv1b+qPGBgahBqIDLYbXDR4bUgz9DfMNtxieM5wyIhq5GskMNpidN7oJV2LzqTn0qvol+jDxvrGYcZS4z3GncZjJpYmCSYrTRpNnpgSTRmmmaZbTNtNh82MzKLMis3qzR6aE8wZ5nzzbeYd5qMWlhZJFqstmi0GLbUtWZZFlvWWj60oVn5W+Va1VnessdYM6xzrndZdNrCNmw3fpsbmli1s624rsN1p222HsfO0E9rV2t2zJ9sz7Qvt6+37HGgOkQ4rHZod3kw3m546fdP0junfHd0ccx33OT5y0nAKd1rp1Or0ztnGmeNc43zHheIS4rLMpcXlrautK891l+t9N6pblNtqt3a3b+4e7mL3BvchDzOPdI8dHvcYmowYxjrGVU+MZ4DnMs8znp+93L0KvE54/eFt753jfdh7cIblDN6MfTP6fUx82D57fGS+dN903598ZX7Gfmy/Wr9n/qb+XP8D/i+Y1sxs5hHmmwDHAHHAqYDRQK/AJYFtQaig0KCyoM5gjeCE4OrgpyEmIVkh9SHDoW6hi0PbwjBhEWGbwu6xDFgcVh1rONwjfEn4pQhyRFxEdcSzSJtIcWRrFBwVHrU56vFM85nCmc3RIJoVvTn6SYxlTH7ML7Ows2Jm1cx6HusUWxzbEUeNmxd3OO5jfED8hvhHCVYJ0oT2RNXEtMS6xNGkoKSKJFny9OQlyTdSdFMEKS2puNTE1AOpI7ODZ2+dPZDmllaadneO5ZyFc67N1Z2bO/fsPNV57Hkn0zHpSemH07+yo9m17JEMVsaOjGFOIGcb5xXXn7uFO8Tz4VXwXmT6ZFZkDmb5ZG3OGuL78Sv5rwWBgmrB2+yw7N3ZoznROQdz5LlJuY15+Lz0vNNCDWGO8NJ8w/kL53eLbEWlIlm+V/7W/GFxhPiABJLMkbQUaCIi6abUSvqDtK/Qt7Cm8NOCxAUnF6ovFC68uchm0dpFL4pCivYvRi/mLG4vNi5eUdy3hLlkz1JoacbS9mWmy0qWDSwPXX5oBXFFzopfVzqurFj5YVXSqtYSg5LlJf0/hP5QX6pSKi69t9p79e416DWCNZ1rXdZuX/u9jFt2vdyxvLL86zrOuus/Ov1Y9aN8feb6zg3uG3ZtxG4Ubry7yW/ToQr1iqKK/s1Rm5u20LeUbfmwdd7Wa5Wulbu3EbdJt8mqIqtatptt37j9azW/urcmoKZxh/6OtTtGd3J39uzy39Ww22B3+e4vPwl+ur8ndE9TrUVt5V7s3sK9z/cl7uvYz9hfd0D3QPmBbweFB2WHYg9dqvOoqzusf3hDPVwvrR86knak62jQ0ZYG+4Y9jbTG8mPgmPTYy+Ppx++eiDjRfpJxsuFn8593nKKeKmuCmhY1DTfzm2UtKS3dp8NPt7d6t576xeGXg2eMz9Sc1Tq74RzxXMk5+fmi8yNtorbXF7Iu9LfPa390MfninUuzLnVejrh89UrIlYsdzI7zV32unrnmde30dcb15hvuN5puut089avbr6c63Tubbnncauny7GrtntF9rsev58LtoNtX7rDu3Oid2dt9N+Hu/Xtp92T3ufcHH+Q+ePuw8OHYo+WPMY/Lnqg9qXyq/7T2N+vfGmXusrN9QX03n8U9e9TP6X/1u+T3rwMlzynPK18YvagbdB48MxQy1PVy9suBV6JXY69L/6H+jx1vrN78/If/HzeHk4cH3orfyt+te6/z/uAH1w/tIzEjTz/mfRwbLfuk8+nQZ8bnji9JX16MLfiK+1r1zfpb6/eI74/leXK5iC1mj0sBFDLgzEwA3h1EtHEKAFRElxNnT2jrcYMmvgfGCfwnntDf4+YOQAMyKWQR0x+Akwo5i8wqyKyQRPH+AHZxUY5/mSTTxXkiFxlRlphPcvl7AwBwrQB8E8vlYzvl8m/7kGIfANCWP6HpFYZFtHyD3vJRg6LbPe3g7zah9//U499noKjAFfx9/ieoZhkWVvYkwwAAAGxlWElmTU0AKgAAAAgABAEaAAUAAAABAAAAPgEbAAUAAAABAAAARgEoAAMAAAABAAIAAIdpAAQAAAABAAAATgAAAAAAAACQAAAAAQAAAJAAAAABAAKgAgAEAAAAAQAAAEKgAwAEAAAAAQAAAEIAAAAAgodoEQAAAAlwSFlzAAAWJQAAFiUBSVIk8AAAAhRJREFUeAHtnLEuBFEUhs9cu7JCskEhIrZAgYZGoREPwBuIygOoPITKA6jEG/AAolFoaFCgICIKZBNiY8Pyz5rNOWe9wNz5T7N3Z2eT/b/7zZlpziat3xKWBDJoEyh5EDd3DTk5r8vV7Yc8vzbl6zvfwvSERIYHyzI90SeLc1WZrFV85PR9oi+N/YMnOT6t/3tiLAeXFqqytjrSFacDYmfvQS6u37tOiPHA7FS/bK6PmWhpj4AJRYGA9MiKzLpK6An+cqiNVmRleUhArrec6PNzt/5sttLgh0cvcvfY6Px+ZNY9I6Ax6gKErY1xmZ8ZyD0E5MJGIgsyIZsunT3g7qALJuTdAp0nWyMTsunS2QNukbpwOcRaPpvOHvxzQow2ZBvrs+nsfLL8o0QQBJFdMO1XGkEjaIQlQCMsD/YIGkEjLAEaYXmwR9AIGmEJ0AjLgz2CRtAIS4BGWB7sETSCRlgCNMLyYI+gETTCEqARlgd7BI2gEZYAjbA82CNoBI2wBGiE5cEeQSNohCVAIywP9ggaQSMsARphebBH0AgaYQnQCMsjYC5SF2agYi2fTWcPGA7VFfO0n8+mswdMyOrCNJwnpz/P6xqZkE2Xzh4w8qcLI4Hbu/dydvkWBRAAQBZk0uOOyKyzp5PARRiF1puNtR+NTh+oMCvtJ+D8F2N6j6x+PrwzG46gRTDDm5BtsAGBg0X924Qfj7i23p7HNgQAAAAASUVORK5CYII=");background-size:100%;position:relative;right:2px;top:-5px}.markdown-body input[type=checkbox]:checked:before{background:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEIAAABCCAYAAADjVADoAAAK2GlDQ1BJQ0MgUHJvZmlsZQAASImVlwdUU9kWhs+96Y0WiHRC70gngJTQQxGkg6iEJJBQYkgIKmJnUMGxoCKCZcSKKFhGQMaCWLANAopdJ8igoD4HC6Ki5t3AI8zMW++99fZaJ+dbO/vss/e55671XwAoYWyRKBdWAyBPWCCODQ2gJ6ek0nHPAQRgQAI2wIHNkYiYMTGRALHJ+a/28S4Sjdhte0Wuf///v5oGlyfhAAClIZzBlXDyEG5DxkuOSFwAAOoI4jddUCBScBfCmmKkQIR/V3DWBH9ScMY4o8njMfGxgQjTAcCT2WxxFgBkO8RPL+RkIXnIih4chVyBEOFihH05fDYX4TMI2+XlzVfwIMJWSLwIAApyOoCR8aecWX/Jn6HMz2ZnKXmir3HDBwkkolz2ov/zaP635eVKJ/ewQAaZLw6LVeyHnN/9nPkRShZmzIyeZAF3oiYF86VhCZPMkQSmTjKXHRShXJs7M3KSMwUhLGWeAlb8JPMkwXGTLJ4fq9wrUxzInGS2eHxfIsIyaU6C0s/nsZT5i/jxSZNcKEicOcmSnLiIqZhApV8sjVXWzxOGBkztG6LsPU/yp34FLOXaAn58mLJ39lT9PCFzKqckWVkblxcUPBWToIwXFQQo9xLlxijjebmhSr+kME65tgC5nFNrY5RnmM0Oj5lkIABRgA04dNVJAqCAt7BA0UjgfNEisSCLX0BnIm8bj84Schzs6M6Ozs4AKN7dievwnjb+TkK061O+NYjHr10ul5+e8oUi9/i4KfJYbk35LCsAUNUD4Op+jlRcOOFDK34wyNNTBZpABxgCU2AF7IEzcAfewB8Eg3AQDeJBCpiL1MoHeUAMFoBisAKUgnKwEWwF1WA32AsOgaPgBGgGZ8AFcAXcAF2gFzwCMjAAXoFh8BGMQRCEgygQFdKBjCBzyBZyhhiQLxQMRUKxUAqUDmVBQkgKFUOroHKoAqqG9kB10HHoNHQBugZ1Qw+gPmgIegd9gVEwGdaEDWALeDrMgJlwBBwPz4Gz4Hy4CC6B18NVcC18BG6CL8A34F5YBr+CR1AARULRUMYoexQDFYiKRqWiMlFi1FJUGaoSVYtqQLWiOlC3UTLUa9RnNBZNRdPR9mhvdBg6Ac1B56OXotehq9GH0E3oS+jb6D70MPo7hoLRx9hivDAsTDImC7MAU4qpxBzAnMJcxvRiBjAfsVgsDWuJ9cCGYVOw2djF2HXYndhGbBu2G9uPHcHhcDo4W5wPLhrHxhXgSnHbcUdw53E9uAHcJzwJb4R3xofgU/FC/Ep8Jf4w/hy+B/8CP0ZQI5gTvAjRBC5hEWEDYR+hlXCLMEAYI6oTLYk+xHhiNnEFsYrYQLxMfEx8TyKRTEiepFkkAWk5qYp0jHSV1Ef6TNYg25ADyWlkKXk9+SC5jfyA/J5CoVhQ/CmplALKekod5SLlKeWTClXFQYWlwlVZplKj0qTSo/JGlaBqrspUnatapFqpelL1luprNYKahVqgGlttqVqN2mm1e2oj6lR1J/Vo9Tz1deqH1a+pD2rgNCw0gjW4GiUaezUuavRTUVRTaiCVQ11F3Ue9TB3QxGpaarI0szXLNY9qdmoOa2louWolai3UqtE6qyWjoWgWNBYtl7aBdoJ2l/ZlmsE05jTetLXTGqb1TBvV1tP21+Zpl2k3avdqf9Gh6wTr5Ohs0mnWeaKL1rXRnaW7QHeX7mXd13qaet56HL0yvRN6D/VhfRv9WP3F+nv1b+qPGBgahBqIDLYbXDR4bUgz9DfMNtxieM5wyIhq5GskMNpidN7oJV2LzqTn0qvol+jDxvrGYcZS4z3GncZjJpYmCSYrTRpNnpgSTRmmmaZbTNtNh82MzKLMis3qzR6aE8wZ5nzzbeYd5qMWlhZJFqstmi0GLbUtWZZFlvWWj60oVn5W+Va1VnessdYM6xzrndZdNrCNmw3fpsbmli1s624rsN1p222HsfO0E9rV2t2zJ9sz7Qvt6+37HGgOkQ4rHZod3kw3m546fdP0junfHd0ccx33OT5y0nAKd1rp1Or0ztnGmeNc43zHheIS4rLMpcXlrautK891l+t9N6pblNtqt3a3b+4e7mL3BvchDzOPdI8dHvcYmowYxjrGVU+MZ4DnMs8znp+93L0KvE54/eFt753jfdh7cIblDN6MfTP6fUx82D57fGS+dN903598ZX7Gfmy/Wr9n/qb+XP8D/i+Y1sxs5hHmmwDHAHHAqYDRQK/AJYFtQaig0KCyoM5gjeCE4OrgpyEmIVkh9SHDoW6hi0PbwjBhEWGbwu6xDFgcVh1rONwjfEn4pQhyRFxEdcSzSJtIcWRrFBwVHrU56vFM85nCmc3RIJoVvTn6SYxlTH7ML7Ows2Jm1cx6HusUWxzbEUeNmxd3OO5jfED8hvhHCVYJ0oT2RNXEtMS6xNGkoKSKJFny9OQlyTdSdFMEKS2puNTE1AOpI7ODZ2+dPZDmllaadneO5ZyFc67N1Z2bO/fsPNV57Hkn0zHpSemH07+yo9m17JEMVsaOjGFOIGcb5xXXn7uFO8Tz4VXwXmT6ZFZkDmb5ZG3OGuL78Sv5rwWBgmrB2+yw7N3ZoznROQdz5LlJuY15+Lz0vNNCDWGO8NJ8w/kL53eLbEWlIlm+V/7W/GFxhPiABJLMkbQUaCIi6abUSvqDtK/Qt7Cm8NOCxAUnF6ovFC68uchm0dpFL4pCivYvRi/mLG4vNi5eUdy3hLlkz1JoacbS9mWmy0qWDSwPXX5oBXFFzopfVzqurFj5YVXSqtYSg5LlJf0/hP5QX6pSKi69t9p79e416DWCNZ1rXdZuX/u9jFt2vdyxvLL86zrOuus/Ov1Y9aN8feb6zg3uG3ZtxG4Ubry7yW/ToQr1iqKK/s1Rm5u20LeUbfmwdd7Wa5Wulbu3EbdJt8mqIqtatptt37j9azW/urcmoKZxh/6OtTtGd3J39uzy39Ww22B3+e4vPwl+ur8ndE9TrUVt5V7s3sK9z/cl7uvYz9hfd0D3QPmBbweFB2WHYg9dqvOoqzusf3hDPVwvrR86knak62jQ0ZYG+4Y9jbTG8mPgmPTYy+Ppx++eiDjRfpJxsuFn8593nKKeKmuCmhY1DTfzm2UtKS3dp8NPt7d6t576xeGXg2eMz9Sc1Tq74RzxXMk5+fmi8yNtorbXF7Iu9LfPa390MfninUuzLnVejrh89UrIlYsdzI7zV32unrnmde30dcb15hvuN5puut089avbr6c63Tubbnncauny7GrtntF9rsev58LtoNtX7rDu3Oid2dt9N+Hu/Xtp92T3ufcHH+Q+ePuw8OHYo+WPMY/Lnqg9qXyq/7T2N+vfGmXusrN9QX03n8U9e9TP6X/1u+T3rwMlzynPK18YvagbdB48MxQy1PVy9suBV6JXY69L/6H+jx1vrN78/If/HzeHk4cH3orfyt+te6/z/uAH1w/tIzEjTz/mfRwbLfuk8+nQZ8bnji9JX16MLfiK+1r1zfpb6/eI74/leXK5iC1mj0sBFDLgzEwA3h1EtHEKAFRElxNnT2jrcYMmvgfGCfwnntDf4+YOQAMyKWQR0x+Akwo5i8wqyKyQRPH+AHZxUY5/mSTTxXkiFxlRlphPcvl7AwBwrQB8E8vlYzvl8m/7kGIfANCWP6HpFYZFtHyD3vJRg6LbPe3g7zah9//U499noKjAFfx9/ieoZhkWVvYkwwAAAGxlWElmTU0AKgAAAAgABAEaAAUAAAABAAAAPgEbAAUAAAABAAAARgEoAAMAAAABAAIAAIdpAAQAAAABAAAATgAAAAAAAACQAAAAAQAAAJAAAAABAAKgAgAEAAAAAQAAAEKgAwAEAAAAAQAAAEIAAAAAgodoEQAAAAlwSFlzAAAWJQAAFiUBSVIk8AAABMtJREFUeAHtXM2KFDEQzrQKruIu4mEXRFlUVLz4A4K7B99AcO8io0/gwQfxDVzFuwu+gQf34EG8iOAPKAh6EFlBFMSf/qa2uqszlVR6ZtYxM5PDJNVVSer78nU6KrHzpyxuVlwx44AY2O0T8eb9D7f5fMu9fPvdff7y0/36nbdgdhUdd+jgHnf62JxbObvgjh/d60Pu2R35ajx49Mk9frqlBk7Kw8sXF9y1K4t9cCoi7tz/4F68/tYXMIkPzpzY725dP9yA1tsjoIRpIQHogRWYZSmwJ4Reh06nI2Nd7rYEA8zAzqXAxhgq/pc1d9vHKbEX+Dr4JbzypJDc/YxXYi/wifRLeOXpU5q7n/FK7EXsnBBeeRoqd7/EHj1ZhleeiMjdz8pArRKR+0pb+UsCuK0SkftKW/kzeFmrRHCAxWzufsaJOkqExWzufpOI8EpP1jnCJCK80pN1jjCJ4ICwMigidz/jRD3bI7bZUInIfaWt/KUSuK0SEd4jqFvufgYva5UIDrCYzd3POFFHifhfV/7k8lwPw7D5mUSEV3r854ju2pK7ffOIWzk/X+Go803Lr+ooGqoiwkyP9xzRXVt0q9sE3CgJYTLqfNPyE/irpkoEe2um6ck4bSiBSeD8JBl41jY/Hgd1lIiaaeoyLlsjgUGAjEH3DB4DtUpEW2Z3Mj5GAgA8efbVvXpX/200nln5IMYvKhHDrvylcwdc9+pSNdeg46WQsP7wo2s7fpWYaPT926fw9ZiVk4BpywYJkGuvlJs4EuWS0p/HTyHh3kbzH2najM85cR0lgpPiYMtukFB26m1u5Ua+vkFkWP3Zn0KCJDg1Px6f42Wtvhrhdyz8ncanrFKCmGH1wrwDMCrh/uxPIUFTAvdHbeVPsc1fVRE+c7Ud/k6fWt7XHFlYqcqQ5wTRvWpiY4wrIZwfDUL+akDRUBXB/jCzFCH9SHCzTDRUmsro7z+cEvrHwxOZn2ZTL/pVFcEBtRLoiWXfxQ5ehvoHHx4vpIwUEuJKSMvPz5/zQq0qwmIy5m+rjBQSwnsCQYnlgwjfT72av6oifOba2qnKcOXeGVIP0rT3BALTNr8mBWSpRHAgmJSTtLGhDHwj+A9GPCbX2DNiBSRoShg0H8zl5y/njxIhJ0WntralDJmIbO+UEvz85Zwt9wj7HIDB5Ttp7RkyGbRDSqC49vOjX50P9aexmr+qInzmajvtO13H02SpyrCVMNj8dT7/4BwByDXzRIC0LWXEldA/njVfip9GpV9VERxQM0lPhrVDyrCVMJr5/fwZJ+qWewR1lSuNJ21sXxnjVgIhck5VhM/cqG1WBpIAMX4Z9Xz+eP58sFUiOBArLQcZpQ0CNCXt1HzA5OfPOFGrrwYHyKTwbNJsxolaJUJbKeo0mu/4uMeXBHBbJSK88qP5jo97fAYva5UIDgivHEXk7mecqKNEhFeOhsjdbxKR+0pb+UsCuK0qIveVtvJn8LJWieAAi9nc/YwTdZQIi9nc/SYR4ZWenSO2yZvgcwTuRYZKWBnUI3e/xF7gcmio5L4HWPlL7AVuyPol95W28me8EnuBa8J+sZjM3c94JfYCd6VxTXjaCjDLe+K9cwTuSuOa8LQUYPXvh1d3w0HC7JK8kMK0/rcJfwHkVMYgi4xhOgAAAABJRU5ErkJggg==");background-size:100%}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="a11y-light">.hljs-comment,.hljs-quote{color:#696969}.hljs-deletion,.hljs-name,.hljs-regexp,.hljs-selector-class,.hljs-selector-id,.hljs-tag,.hljs-template-variable,.hljs-variable{color:#d91e18}.hljs-attribute,.hljs-built_in,.hljs-builtin-name,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-type{color:#aa5d00}.hljs-addition,.hljs-bullet,.hljs-string,.hljs-symbol{color:green}.hljs-section,.hljs-title{color:#007faa}.hljs-keyword,.hljs-selector-tag{color:#7928a1}.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#fefefe;color:#545454}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}@media screen and (-ms-high-contrast:active){.hljs-addition,.hljs-attribute,.hljs-built_in,.hljs-builtin-name,.hljs-bullet,.hljs-comment,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-quote,.hljs-string,.hljs-symbol,.hljs-type{color:highlight}.hljs-keyword,.hljs-selector-tag{font-weight:700}}</style><p>在Java编程中，方法就像是你的个人工具箱里的各种工具——锤子用来钉钉子，螺丝刀用来拧螺丝，每个工具都有专门的用途。今天，我们来学习如何创建和使用自己的"编程工具"！</p>
<h2 data-id="heading-0">引入：为什么需要方法？</h2>
<p>想象一下，你正在写一个学生成绩管理系统：
<strong>没有方法的情况：</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
    <span class="hljs-comment">// 计算第一个学生的总分</span>
    <span class="hljs-type">int</span> <span class="hljs-variable">score1</span> <span class="hljs-operator">=</span> <span class="hljs-number">85</span>;
    <span class="hljs-type">int</span> <span class="hljs-variable">score2</span> <span class="hljs-operator">=</span> <span class="hljs-number">90</span>;
    <span class="hljs-type">int</span> <span class="hljs-variable">score3</span> <span class="hljs-operator">=</span> <span class="hljs-number">78</span>;
    <span class="hljs-type">int</span> <span class="hljs-variable">total1</span> <span class="hljs-operator">=</span> score1 + score2 + score3;
    <span class="hljs-type">double</span> <span class="hljs-variable">average1</span> <span class="hljs-operator">=</span> total1 / <span class="hljs-number">3.0</span>;
    System.out.println(<span class="hljs-string">"第一个学生平均分："</span> + average1);
    
    <span class="hljs-comment">// 计算第二个学生的总分（重复写一遍！）</span>
    <span class="hljs-type">int</span> <span class="hljs-variable">score4</span> <span class="hljs-operator">=</span> <span class="hljs-number">92</span>;
    <span class="hljs-type">int</span> <span class="hljs-variable">score5</span> <span class="hljs-operator">=</span> <span class="hljs-number">88</span>;
    <span class="hljs-type">int</span> <span class="hljs-variable">score6</span> <span class="hljs-operator">=</span> <span class="hljs-number">95</span>;
    <span class="hljs-type">int</span> <span class="hljs-variable">total2</span> <span class="hljs-operator">=</span> score4 + score5 + score6;
    <span class="hljs-type">double</span> <span class="hljs-variable">average2</span> <span class="hljs-operator">=</span> total2 / <span class="hljs-number">3.0</span>;
    System.out.println(<span class="hljs-string">"第二个学生平均分："</span> + average2);
    
    <span class="hljs-comment">// 计算第三个学生的总分（又重复写一遍！）</span>
    <span class="hljs-comment">// ... 太麻烦了！</span>
}
</code></pre>
<p><strong>使用方法的情况：</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
    <span class="hljs-comment">// 只需要调用方法，代码变得超级简洁！</span>
    calculateAverage(<span class="hljs-number">85</span>, <span class="hljs-number">90</span>, <span class="hljs-number">78</span>, <span class="hljs-string">"第一个学生"</span>);
    calculateAverage(<span class="hljs-number">92</span>, <span class="hljs-number">88</span>, <span class="hljs-number">95</span>, <span class="hljs-string">"第二个学生"</span>);
    calculateAverage(<span class="hljs-number">76</span>, <span class="hljs-number">85</span>, <span class="hljs-number">90</span>, <span class="hljs-string">"第三个学生"</span>);
}

<span class="hljs-comment">// 定义一个计算平均分的方法</span>
<span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">calculateAverage</span><span class="hljs-params">(<span class="hljs-type">int</span> score1, <span class="hljs-type">int</span> score2, <span class="hljs-type">int</span> score3, String name)</span> {
    <span class="hljs-type">int</span> <span class="hljs-variable">total</span> <span class="hljs-operator">=</span> score1 + score2 + score3;
    <span class="hljs-type">double</span> <span class="hljs-variable">average</span> <span class="hljs-operator">=</span> total / <span class="hljs-number">3.0</span>;
    System.out.println(name + <span class="hljs-string">"平均分："</span> + average);
}
</code></pre>
<p>看到区别了吗？方法让代码更简洁、更易读、更易维护！</p>
<h2 data-id="heading-1">一、方法基础：什么是方法？</h2>
<h3 data-id="heading-2">1.1 方法的通俗理解</h3>
<p><strong>方法（Method）</strong>  就是一段有名字的代码块，可以重复使用。你可以把它想象成：</p>
<ul>
<li><strong>一个魔法咒语</strong>：念出咒语（调用方法），就会发生特定的魔法效果（执行代码）</li>
<li><strong>一个厨房食谱</strong>：按照食谱（方法）的步骤，就能做出美味的菜（得到结果）</li>
<li><strong>一个数学公式</strong>：比如 "圆的面积 = π × r²"，这就是一个方法</li>
</ul>
<h3 data-id="heading-3">1.2 方法的组成部分</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 访问修饰符 返回值类型 方法名(参数列表) {</span>
<span class="hljs-comment">//     方法体</span>
<span class="hljs-comment">//     返回值（如果需要）</span>
<span class="hljs-comment">// }</span>

<span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">add</span><span class="hljs-params">(<span class="hljs-type">int</span> a, <span class="hljs-type">int</span> b)</span> {
    <span class="hljs-type">int</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> a + b;
    <span class="hljs-keyword">return</span> result;
}
</code></pre>
<h2 data-id="heading-4">二、创建和使用方法</h2>
<h3 data-id="heading-5">2.1 最简单的无参方法</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SimpleMethod</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        System.out.println(<span class="hljs-string">"=== 最简单的无参方法 ===\n"</span>);
        
        <span class="hljs-comment">// 调用方法：就像喊朋友的名字</span>
        sayHello();      <span class="hljs-comment">// 第一次调用</span>
        sayHello();      <span class="hljs-comment">// 第二次调用</span>
        sayHello();      <span class="hljs-comment">// 可以无限次调用！</span>
    }
    
    <span class="hljs-comment">// 定义一个无参方法：向世界问好</span>
    <span class="hljs-comment">// static：表示这是静态方法，可以在main中直接调用</span>
    <span class="hljs-comment">// void：表示这个方法不返回任何值</span>
    <span class="hljs-comment">// sayHello：方法名（我们自己取的）</span>
    <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">sayHello</span><span class="hljs-params">()</span> {
        System.out.println(<span class="hljs-string">"你好，Java世界！"</span>);
        System.out.println(<span class="hljs-string">"我正在学习Java方法！"</span>);
        System.out.println(<span class="hljs-string">"------------------"</span>);
    }
}
</code></pre>
<h3 data-id="heading-6">2.2 带参数的方法（让方法更灵活）</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MethodWithParameters</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        System.out.println(<span class="hljs-string">"=== 带参数的方法 ===\n"</span>);
        
        <span class="hljs-comment">// 传递不同的参数，得到不同的结果</span>
        greet(<span class="hljs-string">"小明"</span>);          <span class="hljs-comment">// 向小明问好</span>
        greet(<span class="hljs-string">"小红"</span>);          <span class="hljs-comment">// 向小红问好</span>
        greet(<span class="hljs-string">"李老师"</span>);        <span class="hljs-comment">// 向李老师问好</span>
        
        <span class="hljs-comment">// 计算不同数字的和</span>
        printSum(<span class="hljs-number">5</span>, <span class="hljs-number">3</span>);        <span class="hljs-comment">// 计算5+3</span>
        printSum(<span class="hljs-number">10</span>, <span class="hljs-number">20</span>);      <span class="hljs-comment">// 计算10+20</span>
        printSum(<span class="hljs-number">100</span>, <span class="hljs-number">200</span>);    <span class="hljs-comment">// 计算100+200</span>
    }
    
    <span class="hljs-comment">// 带一个参数的方法：向指定的人问好</span>
    <span class="hljs-comment">// name：参数，调用时需要传入</span>
    <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">greet</span><span class="hljs-params">(String name)</span> {
        System.out.println(<span class="hljs-string">"你好，"</span> + name + <span class="hljs-string">"！"</span>);
        System.out.println(<span class="hljs-string">"欢迎来到Java课堂！"</span>);
        System.out.println();
    }
    
    <span class="hljs-comment">// 带两个参数的方法：计算两个数的和</span>
    <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">printSum</span><span class="hljs-params">(<span class="hljs-type">int</span> a, <span class="hljs-type">int</span> b)</span> {
        <span class="hljs-type">int</span> <span class="hljs-variable">sum</span> <span class="hljs-operator">=</span> a + b;
        System.out.println(a + <span class="hljs-string">" + "</span> + b + <span class="hljs-string">" = "</span> + sum);
    }
}
</code></pre>
<h3 data-id="heading-7">2.3 有返回值的方法（方法可以"给出答案"）</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MethodWithReturn</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        System.out.println(<span class="hljs-string">"=== 有返回值的方法 ===\n"</span>);
        
        <span class="hljs-comment">// 调用方法并接收返回值</span>
        <span class="hljs-type">int</span> <span class="hljs-variable">result1</span> <span class="hljs-operator">=</span> add(<span class="hljs-number">5</span>, <span class="hljs-number">3</span>);      <span class="hljs-comment">// 调用add方法，得到返回值8</span>
        System.out.println(<span class="hljs-string">"5 + 3 = "</span> + result1);
        
        <span class="hljs-type">int</span> <span class="hljs-variable">result2</span> <span class="hljs-operator">=</span> add(<span class="hljs-number">10</span>, <span class="hljs-number">20</span>);    <span class="hljs-comment">// 再次调用，得到30</span>
        System.out.println(<span class="hljs-string">"10 + 20 = "</span> + result2);
        
        <span class="hljs-comment">// 返回值可以直接使用</span>
        System.out.println(<span class="hljs-string">"7 + 8 = "</span> + add(<span class="hljs-number">7</span>, <span class="hljs-number">8</span>));
        
        <span class="hljs-comment">// 使用返回值进行进一步计算</span>
        <span class="hljs-type">int</span> <span class="hljs-variable">total</span> <span class="hljs-operator">=</span> add(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>) + add(<span class="hljs-number">3</span>, <span class="hljs-number">4</span>) + add(<span class="hljs-number">5</span>, <span class="hljs-number">6</span>);
        System.out.println(<span class="hljs-string">"1+2 + 3+4 + 5+6 = "</span> + total);
        
        <span class="hljs-comment">// 不同类型的方法</span>
        <span class="hljs-type">boolean</span> <span class="hljs-variable">isAdult</span> <span class="hljs-operator">=</span> checkAge(<span class="hljs-number">20</span>);
        System.out.println(<span class="hljs-string">"20岁是成年人吗？"</span> + isAdult);
        
        <span class="hljs-type">double</span> <span class="hljs-variable">area</span> <span class="hljs-operator">=</span> calculateCircleArea(<span class="hljs-number">5.0</span>);
        System.out.println(<span class="hljs-string">"半径为5的圆面积："</span> + area);
    }
    
    <span class="hljs-comment">// 有返回值的方法：返回两个数的和</span>
    <span class="hljs-comment">// int：表示这个方法返回一个整数</span>
    <span class="hljs-comment">// return：返回计算结果</span>
    <span class="hljs-keyword">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">add</span><span class="hljs-params">(<span class="hljs-type">int</span> a, <span class="hljs-type">int</span> b)</span> {
        <span class="hljs-type">int</span> <span class="hljs-variable">sum</span> <span class="hljs-operator">=</span> a + b;   <span class="hljs-comment">// 计算和</span>
        <span class="hljs-keyword">return</span> sum;        <span class="hljs-comment">// 返回结果</span>
    }
    
    <span class="hljs-comment">// 检查年龄是否成年</span>
    <span class="hljs-keyword">static</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">checkAge</span><span class="hljs-params">(<span class="hljs-type">int</span> age)</span> {
        <span class="hljs-keyword">if</span> (age &gt;= <span class="hljs-number">18</span>) {
            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;   <span class="hljs-comment">// 返回true</span>
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;  <span class="hljs-comment">// 返回false</span>
        }
        <span class="hljs-comment">// 注意：一个方法必须保证在所有情况下都有返回值</span>
    }
    
    <span class="hljs-comment">// 计算圆面积</span>
    <span class="hljs-keyword">static</span> <span class="hljs-type">double</span> <span class="hljs-title function_">calculateCircleArea</span><span class="hljs-params">(<span class="hljs-type">double</span> radius)</span> {
        <span class="hljs-type">double</span> <span class="hljs-variable">area</span> <span class="hljs-operator">=</span> <span class="hljs-number">3.14159</span> * radius * radius;
        <span class="hljs-keyword">return</span> area;  <span class="hljs-comment">// 返回double类型</span>
    }
}
</code></pre>
<h3 data-id="heading-8">2.4 方法参数传递的细节</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ParameterDetails</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        System.out.println(<span class="hljs-string">"=== 方法参数细节 ===\n"</span>);
        
        <span class="hljs-comment">// 基本类型参数传递（传值）</span>
        <span class="hljs-type">int</span> <span class="hljs-variable">x</span> <span class="hljs-operator">=</span> <span class="hljs-number">10</span>;
        System.out.println(<span class="hljs-string">"修改前 x = "</span> + x);
        changeNumber(x);  <span class="hljs-comment">// 把x的值10传给方法</span>
        System.out.println(<span class="hljs-string">"修改后 x = "</span> + x);
        System.out.println(<span class="hljs-string">"结论：基本类型参数不会改变原变量\n"</span>);
        
        <span class="hljs-comment">// 数组参数传递（传引用）</span>
        <span class="hljs-type">int</span>[] scores = {<span class="hljs-number">85</span>, <span class="hljs-number">90</span>, <span class="hljs-number">78</span>};
        System.out.println(<span class="hljs-string">"修改前 scores[0] = "</span> + scores[<span class="hljs-number">0</span>]);
        changeArrayElement(scores);  <span class="hljs-comment">// 把数组的"地址"传给方法</span>
        System.out.println(<span class="hljs-string">"修改后 scores[0] = "</span> + scores[<span class="hljs-number">0</span>]);
        System.out.println(<span class="hljs-string">"结论：数组参数会改变原数组内容\n"</span>);
        
        <span class="hljs-comment">// 多个参数示例</span>
        printStudentInfo(<span class="hljs-string">"张三"</span>, <span class="hljs-number">18</span>, <span class="hljs-number">95.5</span>);
        printStudentInfo(<span class="hljs-string">"李四"</span>, <span class="hljs-number">20</span>, <span class="hljs-number">88.0</span>);
        
        <span class="hljs-comment">// 可变参数（参数数量可变）</span>
        System.out.println(<span class="hljs-string">"\n=== 可变参数 ==="</span>);
        System.out.println(<span class="hljs-string">"平均分1："</span> + calculateAverage(<span class="hljs-number">85</span>, <span class="hljs-number">90</span>, <span class="hljs-number">78</span>));
        System.out.println(<span class="hljs-string">"平均分2："</span> + calculateAverage(<span class="hljs-number">92</span>, <span class="hljs-number">88</span>, <span class="hljs-number">95</span>, <span class="hljs-number">76</span>, <span class="hljs-number">85</span>));
        System.out.println(<span class="hljs-string">"平均分3："</span> + calculateAverage(<span class="hljs-number">100</span>, <span class="hljs-number">95</span>));  <span class="hljs-comment">// 两个参数也可以</span>
    }
    
    <span class="hljs-comment">// 尝试修改基本类型参数</span>
    <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">changeNumber</span><span class="hljs-params">(<span class="hljs-type">int</span> num)</span> {
        num = <span class="hljs-number">100</span>;  <span class="hljs-comment">// 只修改了方法内的副本</span>
        System.out.println(<span class="hljs-string">"方法内 num = "</span> + num);
    }
    
    <span class="hljs-comment">// 修改数组元素</span>
    <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">changeArrayElement</span><span class="hljs-params">(<span class="hljs-type">int</span>[] arr)</span> {
        <span class="hljs-keyword">if</span> (arr.length &gt; <span class="hljs-number">0</span>) {
            arr[<span class="hljs-number">0</span>] = <span class="hljs-number">100</span>;  <span class="hljs-comment">// 修改了原数组的内容</span>
        }
    }
    
    <span class="hljs-comment">// 多个参数的方法</span>
    <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">printStudentInfo</span><span class="hljs-params">(String name, <span class="hljs-type">int</span> age, <span class="hljs-type">double</span> score)</span> {
        System.out.println(<span class="hljs-string">"姓名："</span> + name + <span class="hljs-string">"，年龄："</span> + age + <span class="hljs-string">"，成绩："</span> + score);
    }
    
    <span class="hljs-comment">// 可变参数：可以接受任意数量的参数</span>
    <span class="hljs-comment">// 语法：类型... 参数名</span>
    <span class="hljs-keyword">static</span> <span class="hljs-type">double</span> <span class="hljs-title function_">calculateAverage</span><span class="hljs-params">(<span class="hljs-type">int</span>... scores)</span> {
        <span class="hljs-keyword">if</span> (scores.length == <span class="hljs-number">0</span>) {
            <span class="hljs-keyword">return</span> <span class="hljs-number">0.0</span>;
        }
        
        <span class="hljs-type">int</span> <span class="hljs-variable">sum</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> score : scores) {
            sum += score;
        }
        <span class="hljs-keyword">return</span> (<span class="hljs-type">double</span>) sum / scores.length;
    }
}
</code></pre>
<h2 data-id="heading-9">三、方法重载：同名不同"参"</h2>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MethodOverloading</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        System.out.println(<span class="hljs-string">"=== 方法重载 ===\n"</span>);
        
        <span class="hljs-comment">// 方法重载：方法名相同，但参数列表不同</span>
        <span class="hljs-comment">// Java会根据你传入的参数自动选择合适的版本</span>
        
        System.out.println(<span class="hljs-string">"整数相加: "</span> + add(<span class="hljs-number">5</span>, <span class="hljs-number">3</span>));
        System.out.println(<span class="hljs-string">"小数相加: "</span> + add(<span class="hljs-number">5.5</span>, <span class="hljs-number">3.3</span>));
        System.out.println(<span class="hljs-string">"三个数相加: "</span> + add(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>));
        System.out.println(<span class="hljs-string">"字符串连接: "</span> + add(<span class="hljs-string">"Hello, "</span>, <span class="hljs-string">"Java!"</span>));
        
        <span class="hljs-comment">// 实际应用：计算不同图形的面积</span>
        System.out.println(<span class="hljs-string">"\n=== 计算图形面积 ==="</span>);
        System.out.println(<span class="hljs-string">"正方形面积（边长5）: "</span> + calculateArea(<span class="hljs-number">5</span>));
        System.out.println(<span class="hljs-string">"长方形面积（长5宽3）: "</span> + calculateArea(<span class="hljs-number">5</span>, <span class="hljs-number">3</span>));
        System.out.println(<span class="hljs-string">"圆面积（半径4）: "</span> + calculateArea(<span class="hljs-number">4.0</span>));
        
        <span class="hljs-comment">// 注意：返回值类型不同不能构成重载！</span>
        <span class="hljs-comment">// 重载只看参数类型、数量、顺序，不看返回值</span>
    }
    
    <span class="hljs-comment">// 版本1：两个整数相加</span>
    <span class="hljs-keyword">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">add</span><span class="hljs-params">(<span class="hljs-type">int</span> a, <span class="hljs-type">int</span> b)</span> {
        System.out.print(<span class="hljs-string">"调用int版本："</span>);
        <span class="hljs-keyword">return</span> a + b;
    }
    
    <span class="hljs-comment">// 版本2：三个整数相加（参数数量不同）</span>
    <span class="hljs-keyword">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">add</span><span class="hljs-params">(<span class="hljs-type">int</span> a, <span class="hljs-type">int</span> b, <span class="hljs-type">int</span> c)</span> {
        System.out.print(<span class="hljs-string">"调用三个参数版本："</span>);
        <span class="hljs-keyword">return</span> a + b + c;
    }
    
    <span class="hljs-comment">// 版本3：两个小数相加（参数类型不同）</span>
    <span class="hljs-keyword">static</span> <span class="hljs-type">double</span> <span class="hljs-title function_">add</span><span class="hljs-params">(<span class="hljs-type">double</span> a, <span class="hljs-type">double</span> b)</span> {
        System.out.print(<span class="hljs-string">"调用double版本："</span>);
        <span class="hljs-keyword">return</span> a + b;
    }
    
    <span class="hljs-comment">// 版本4：字符串连接（完全不同类型）</span>
    <span class="hljs-keyword">static</span> String <span class="hljs-title function_">add</span><span class="hljs-params">(String a, String b)</span> {
        System.out.print(<span class="hljs-string">"调用String版本："</span>);
        <span class="hljs-keyword">return</span> a + b;
    }
    
    <span class="hljs-comment">// 版本5：整数和小数相加（参数顺序不同）</span>
    <span class="hljs-keyword">static</span> <span class="hljs-type">double</span> <span class="hljs-title function_">add</span><span class="hljs-params">(<span class="hljs-type">int</span> a, <span class="hljs-type">double</span> b)</span> {
        System.out.print(<span class="hljs-string">"调用int-double版本："</span>);
        <span class="hljs-keyword">return</span> a + b;
    }
    
    <span class="hljs-comment">// 版本6：小数和整数相加（参数顺序不同）</span>
    <span class="hljs-keyword">static</span> <span class="hljs-type">double</span> <span class="hljs-title function_">add</span><span class="hljs-params">(<span class="hljs-type">double</span> a, <span class="hljs-type">int</span> b)</span> {
        System.out.print(<span class="hljs-string">"调用double-int版本："</span>);
        <span class="hljs-keyword">return</span> a + b;
    }
    
    <span class="hljs-comment">// 图形面积计算方法（重载示例）</span>
    <span class="hljs-keyword">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">calculateArea</span><span class="hljs-params">(<span class="hljs-type">int</span> side)</span> {
        <span class="hljs-keyword">return</span> side * side;  <span class="hljs-comment">// 正方形</span>
    }
    
    <span class="hljs-keyword">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">calculateArea</span><span class="hljs-params">(<span class="hljs-type">int</span> length, <span class="hljs-type">int</span> width)</span> {
        <span class="hljs-keyword">return</span> length * width;  <span class="hljs-comment">// 长方形</span>
    }
    
    <span class="hljs-keyword">static</span> <span class="hljs-type">double</span> <span class="hljs-title function_">calculateArea</span><span class="hljs-params">(<span class="hljs-type">double</span> radius)</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-number">3.14159</span> * radius * radius;  <span class="hljs-comment">// 圆形</span>
    }
}
</code></pre>
<h2 data-id="heading-10">四、方法的最佳实践和常见错误</h2>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MethodBestPractices</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        System.out.println(<span class="hljs-string">"=== 方法的最佳实践 ===\n"</span>);
        
        <span class="hljs-comment">// ✅ 好方法：单一职责，只做一件事</span>
        printWelcomeMessage();
        <span class="hljs-type">int</span> <span class="hljs-variable">sum</span> <span class="hljs-operator">=</span> calculateSum(<span class="hljs-number">10</span>, <span class="hljs-number">20</span>);
        System.out.println(<span class="hljs-string">"计算结果："</span> + sum);
        
        <span class="hljs-comment">// ✅ 好方法：有意义的命名</span>
        <span class="hljs-type">boolean</span> <span class="hljs-variable">isValid</span> <span class="hljs-operator">=</span> isValidEmail(<span class="hljs-string">"test@example.com"</span>);
        System.out.println(<span class="hljs-string">"邮箱是否有效："</span> + isValid);
        
        <span class="hljs-comment">// ❌ 常见错误演示</span>
        System.out.println(<span class="hljs-string">"\n=== 常见错误 ==="</span>);
        
        <span class="hljs-comment">// 错误1：方法太长（应该拆分成小方法）</span>
        <span class="hljs-comment">// 错误2：方法名无意义（如 doSomething、process）</span>
        <span class="hljs-comment">// 错误3：参数太多（超过3个要考虑封装成对象）</span>
        <span class="hljs-comment">// 错误4：副作用太多（一个方法做了太多事情）</span>
        
        <span class="hljs-comment">// 实用示例：学生管理系统</span>
        System.out.println(<span class="hljs-string">"\n=== 学生管理系统示例 ==="</span>);
        
        <span class="hljs-type">String</span> <span class="hljs-variable">name</span> <span class="hljs-operator">=</span> <span class="hljs-string">"张三"</span>;
        <span class="hljs-type">int</span>[] scores = {<span class="hljs-number">85</span>, <span class="hljs-number">90</span>, <span class="hljs-number">78</span>};
        
        <span class="hljs-comment">// 使用多个小方法，代码清晰易读</span>
        printStudentHeader(name);
        <span class="hljs-type">double</span> <span class="hljs-variable">average</span> <span class="hljs-operator">=</span> calculateAverage(scores);
        <span class="hljs-type">String</span> <span class="hljs-variable">grade</span> <span class="hljs-operator">=</span> calculateGrade(average);
        printStudentResult(average, grade);
    }
    
    <span class="hljs-comment">// ✅ 好例子：方法名清晰，功能单一</span>
    <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">printWelcomeMessage</span><span class="hljs-params">()</span> {
        System.out.println(<span class="hljs-string">"=== 欢迎使用学生管理系统 ==="</span>);
        System.out.println();
    }
    
    <span class="hljs-keyword">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">calculateSum</span><span class="hljs-params">(<span class="hljs-type">int</span> a, <span class="hljs-type">int</span> b)</span> {
        <span class="hljs-keyword">return</span> a + b;
    }
    
    <span class="hljs-keyword">static</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isValidEmail</span><span class="hljs-params">(String email)</span> {
        <span class="hljs-comment">// 简单的邮箱验证（实际应该用正则表达式）</span>
        <span class="hljs-keyword">return</span> email != <span class="hljs-literal">null</span> &amp;&amp; 
               email.contains(<span class="hljs-string">"@"</span>) &amp;&amp; 
               email.contains(<span class="hljs-string">"."</span>);
    }
    
    <span class="hljs-comment">// 学生管理相关方法</span>
    <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">printStudentHeader</span><span class="hljs-params">(String name)</span> {
        System.out.println(<span class="hljs-string">"学生姓名："</span> + name);
        System.out.println(<span class="hljs-string">"------------"</span>);
    }
    
    <span class="hljs-keyword">static</span> <span class="hljs-type">double</span> <span class="hljs-title function_">calculateAverage</span><span class="hljs-params">(<span class="hljs-type">int</span>[] scores)</span> {
        <span class="hljs-type">int</span> <span class="hljs-variable">sum</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> score : scores) {
            sum += score;
        }
        <span class="hljs-keyword">return</span> (<span class="hljs-type">double</span>) sum / scores.length;
    }
    
    <span class="hljs-keyword">static</span> String <span class="hljs-title function_">calculateGrade</span><span class="hljs-params">(<span class="hljs-type">double</span> average)</span> {
        <span class="hljs-keyword">if</span> (average &gt;= <span class="hljs-number">90</span>) <span class="hljs-keyword">return</span> <span class="hljs-string">"A"</span>;
        <span class="hljs-keyword">if</span> (average &gt;= <span class="hljs-number">80</span>) <span class="hljs-keyword">return</span> <span class="hljs-string">"B"</span>;
        <span class="hljs-keyword">if</span> (average &gt;= <span class="hljs-number">70</span>) <span class="hljs-keyword">return</span> <span class="hljs-string">"C"</span>;
        <span class="hljs-keyword">if</span> (average &gt;= <span class="hljs-number">60</span>) <span class="hljs-keyword">return</span> <span class="hljs-string">"D"</span>;
        <span class="hljs-keyword">return</span> <span class="hljs-string">"F"</span>;
    }
    
    <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">printStudentResult</span><span class="hljs-params">(<span class="hljs-type">double</span> average, String grade)</span> {
        System.out.printf(<span class="hljs-string">"平均分：%.2f\n"</span>, average);
        System.out.println(<span class="hljs-string">"等级："</span> + grade);
        System.out.println();
    }
    
    <span class="hljs-comment">// 📝 方法命名规范：</span>
    <span class="hljs-comment">// 1. 动词开头：get、set、calculate、print、check等</span>
    <span class="hljs-comment">// 2. 驼峰命名法：calculateAverageScore</span>
    <span class="hljs-comment">// 3. 见名知义：不要用a、b、c这种无意义的名字</span>
    
    <span class="hljs-comment">// 📝 方法设计原则：</span>
    <span class="hljs-comment">// 1. 一个方法只做一件事</span>
    <span class="hljs-comment">// 2. 方法不要太长（一般不超过50行）</span>
    <span class="hljs-comment">// 3. 参数不要太多（最好不超过3个）</span>
    <span class="hljs-comment">// 4. 避免副作用（不要修改不应该修改的东西）</span>
}
</code></pre>
<h2 data-id="heading-11">五、递归方法：自己调用自己</h2>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RecursionDemo</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        System.out.println(<span class="hljs-string">"=== 递归方法 ===\n"</span>);
        
        <span class="hljs-comment">// 递归：方法自己调用自己</span>
        <span class="hljs-comment">// 注意：必须有结束条件，否则会无限循环！</span>
        
        System.out.println(<span class="hljs-string">"计算5的阶乘："</span>);
        <span class="hljs-type">int</span> <span class="hljs-variable">factorial</span> <span class="hljs-operator">=</span> calculateFactorial(<span class="hljs-number">5</span>);
        System.out.println(<span class="hljs-string">"5! = "</span> + factorial);
        
        System.out.println(<span class="hljs-string">"\n计算斐波那契数列："</span>);
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt;= <span class="hljs-number">10</span>; i++) {
            System.out.println(<span class="hljs-string">"fib("</span> + i + <span class="hljs-string">") = "</span> + fibonacci(i));
        }
        
        System.out.println(<span class="hljs-string">"\n递归实现数字倒序："</span>);
        printReverse(<span class="hljs-number">12345</span>);
    }
    
    <span class="hljs-comment">// 计算阶乘：n! = n × (n-1) × ... × 1</span>
    <span class="hljs-comment">// 例如：5! = 5 × 4 × 3 × 2 × 1 = 120</span>
    <span class="hljs-keyword">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">calculateFactorial</span><span class="hljs-params">(<span class="hljs-type">int</span> n)</span> {
        <span class="hljs-comment">// 结束条件：0的阶乘是1</span>
        <span class="hljs-keyword">if</span> (n == <span class="hljs-number">0</span> || n == <span class="hljs-number">1</span>) {
            System.out.println(<span class="hljs-string">"到达结束条件：factorial("</span> + n + <span class="hljs-string">") = 1"</span>);
            <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;
        } <span class="hljs-keyword">else</span> {
            System.out.println(<span class="hljs-string">"计算 factorial("</span> + n + <span class="hljs-string">") = "</span> + n + <span class="hljs-string">" × factorial("</span> + (n-<span class="hljs-number">1</span>) + <span class="hljs-string">")"</span>);
            <span class="hljs-keyword">return</span> n * calculateFactorial(n - <span class="hljs-number">1</span>);
        }
    }
    
    <span class="hljs-comment">// 斐波那契数列：每个数是前两个数之和</span>
    <span class="hljs-comment">// fib(0)=0, fib(1)=1, fib(2)=1, fib(3)=2, fib(4)=3, ...</span>
    <span class="hljs-keyword">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">fibonacci</span><span class="hljs-params">(<span class="hljs-type">int</span> n)</span> {
        <span class="hljs-keyword">if</span> (n == <span class="hljs-number">0</span>) {
            <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (n == <span class="hljs-number">1</span>) {
            <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-keyword">return</span> fibonacci(n - <span class="hljs-number">1</span>) + fibonacci(n - <span class="hljs-number">2</span>);
        }
    }
    
    <span class="hljs-comment">// 递归打印数字倒序</span>
    <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">printReverse</span><span class="hljs-params">(<span class="hljs-type">int</span> number)</span> {
        <span class="hljs-keyword">if</span> (number &lt; <span class="hljs-number">10</span>) {
            <span class="hljs-comment">// 只有一位数，直接打印</span>
            System.out.print(number);
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-comment">// 打印最后一位数</span>
            System.out.print(number % <span class="hljs-number">10</span>);
            <span class="hljs-comment">// 递归处理剩下的数字</span>
            printReverse(number / <span class="hljs-number">10</span>);
        }
    }
}
</code></pre>
<h2 data-id="heading-12">六、实用案例：学生成绩管理系统</h2>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">StudentGradeSystem</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        System.out.println(<span class="hljs-string">"=== 学生成绩管理系统 ===\n"</span>);
        
        <span class="hljs-comment">// 学生数据</span>
        String[] names = {<span class="hljs-string">"张三"</span>, <span class="hljs-string">"李四"</span>, <span class="hljs-string">"王五"</span>, <span class="hljs-string">"赵六"</span>};
        <span class="hljs-type">int</span>[][] scores = {
            {<span class="hljs-number">85</span>, <span class="hljs-number">90</span>, <span class="hljs-number">78</span>},  <span class="hljs-comment">// 张三的成绩</span>
            {<span class="hljs-number">92</span>, <span class="hljs-number">88</span>, <span class="hljs-number">95</span>},  <span class="hljs-comment">// 李四的成绩</span>
            {<span class="hljs-number">76</span>, <span class="hljs-number">85</span>, <span class="hljs-number">90</span>},  <span class="hljs-comment">// 王五的成绩</span>
            {<span class="hljs-number">88</span>, <span class="hljs-number">92</span>, <span class="hljs-number">86</span>}   <span class="hljs-comment">// 赵六的成绩</span>
        };
        
        <span class="hljs-comment">// 处理每个学生</span>
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; names.length; i++) {
            processStudent(names[i], scores[i]);
        }
        
        <span class="hljs-comment">// 找出最高分的学生</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">topStudent</span> <span class="hljs-operator">=</span> findTopStudent(names, scores);
        System.out.println(<span class="hljs-string">"\n⭐ 最高分学生："</span> + topStudent);
        
        <span class="hljs-comment">// 统计各分数段人数</span>
        printGradeDistribution(scores);
    }
    
    <span class="hljs-comment">// 处理单个学生信息</span>
    <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">processStudent</span><span class="hljs-params">(String name, <span class="hljs-type">int</span>[] studentScores)</span> {
        printDivider();
        System.out.println(<span class="hljs-string">"学生："</span> + name);
        
        <span class="hljs-type">double</span> <span class="hljs-variable">average</span> <span class="hljs-operator">=</span> calculateAverage(studentScores);
        <span class="hljs-type">String</span> <span class="hljs-variable">grade</span> <span class="hljs-operator">=</span> getGradeLetter(average);
        <span class="hljs-type">String</span> <span class="hljs-variable">status</span> <span class="hljs-operator">=</span> getStatus(average);
        
        System.out.printf(<span class="hljs-string">"平均分：%.2f\n"</span>, average);
        System.out.println(<span class="hljs-string">"等级："</span> + grade);
        System.out.println(<span class="hljs-string">"状态："</span> + status);
        
        printScores(studentScores);
    }
    
    <span class="hljs-comment">// 计算平均分</span>
    <span class="hljs-keyword">static</span> <span class="hljs-type">double</span> <span class="hljs-title function_">calculateAverage</span><span class="hljs-params">(<span class="hljs-type">int</span>[] scores)</span> {
        <span class="hljs-type">int</span> <span class="hljs-variable">sum</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> score : scores) {
            sum += score;
        }
        <span class="hljs-keyword">return</span> (<span class="hljs-type">double</span>) sum / scores.length;
    }
    
    <span class="hljs-comment">// 获取等级（A-F）</span>
    <span class="hljs-keyword">static</span> String <span class="hljs-title function_">getGradeLetter</span><span class="hljs-params">(<span class="hljs-type">double</span> average)</span> {
        <span class="hljs-keyword">if</span> (average &gt;= <span class="hljs-number">90</span>) <span class="hljs-keyword">return</span> <span class="hljs-string">"A"</span>;
        <span class="hljs-keyword">if</span> (average &gt;= <span class="hljs-number">80</span>) <span class="hljs-keyword">return</span> <span class="hljs-string">"B"</span>;
        <span class="hljs-keyword">if</span> (average &gt;= <span class="hljs-number">70</span>) <span class="hljs-keyword">return</span> <span class="hljs-string">"C"</span>;
        <span class="hljs-keyword">if</span> (average &gt;= <span class="hljs-number">60</span>) <span class="hljs-keyword">return</span> <span class="hljs-string">"D"</span>;
        <span class="hljs-keyword">return</span> <span class="hljs-string">"F"</span>;
    }
    
    <span class="hljs-comment">// 获取状态（优秀/良好等）</span>
    <span class="hljs-keyword">static</span> String <span class="hljs-title function_">getStatus</span><span class="hljs-params">(<span class="hljs-type">double</span> average)</span> {
        <span class="hljs-keyword">if</span> (average &gt;= <span class="hljs-number">90</span>) <span class="hljs-keyword">return</span> <span class="hljs-string">"优秀"</span>;
        <span class="hljs-keyword">if</span> (average &gt;= <span class="hljs-number">80</span>) <span class="hljs-keyword">return</span> <span class="hljs-string">"良好"</span>;
        <span class="hljs-keyword">if</span> (average &gt;= <span class="hljs-number">70</span>) <span class="hljs-keyword">return</span> <span class="hljs-string">"中等"</span>;
        <span class="hljs-keyword">if</span> (average &gt;= <span class="hljs-number">60</span>) <span class="hljs-keyword">return</span> <span class="hljs-string">"及格"</span>;
        <span class="hljs-keyword">return</span> <span class="hljs-string">"不及格"</span>;
    }
    
    <span class="hljs-comment">// 打印分数详情</span>
    <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">printScores</span><span class="hljs-params">(<span class="hljs-type">int</span>[] scores)</span> {
        System.out.print(<span class="hljs-string">"各科分数："</span>);
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; scores.length; i++) {
            System.out.print(<span class="hljs-string">"科目"</span> + (i+<span class="hljs-number">1</span>) + <span class="hljs-string">":"</span> + scores[i]);
            <span class="hljs-keyword">if</span> (i &lt; scores.length - <span class="hljs-number">1</span>) {
                System.out.print(<span class="hljs-string">", "</span>);
            }
        }
        System.out.println();
    }
    
    <span class="hljs-comment">// 找出最高分学生</span>
    <span class="hljs-keyword">static</span> String <span class="hljs-title function_">findTopStudent</span><span class="hljs-params">(String[] names, <span class="hljs-type">int</span>[][] allScores)</span> {
        <span class="hljs-type">double</span> <span class="hljs-variable">highestAverage</span> <span class="hljs-operator">=</span> -<span class="hljs-number">1</span>;
        <span class="hljs-type">String</span> <span class="hljs-variable">topStudent</span> <span class="hljs-operator">=</span> <span class="hljs-string">""</span>;
        
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; names.length; i++) {
            <span class="hljs-type">double</span> <span class="hljs-variable">average</span> <span class="hljs-operator">=</span> calculateAverage(allScores[i]);
            <span class="hljs-keyword">if</span> (average &gt; highestAverage) {
                highestAverage = average;
                topStudent = names[i];
            }
        }
        
        <span class="hljs-keyword">return</span> topStudent + String.format(<span class="hljs-string">" (%.2f分)"</span>, highestAverage);
    }
    
    <span class="hljs-comment">// 统计分数分布</span>
    <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">printGradeDistribution</span><span class="hljs-params">(<span class="hljs-type">int</span>[][] allScores)</span> {
        <span class="hljs-type">int</span> <span class="hljs-variable">excellent</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>, good = <span class="hljs-number">0</span>, medium = <span class="hljs-number">0</span>, pass = <span class="hljs-number">0</span>, fail = <span class="hljs-number">0</span>;
        
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span>[] scores : allScores) {
            <span class="hljs-type">double</span> <span class="hljs-variable">average</span> <span class="hljs-operator">=</span> calculateAverage(scores);
            <span class="hljs-keyword">if</span> (average &gt;= <span class="hljs-number">90</span>) excellent++;
            <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (average &gt;= <span class="hljs-number">80</span>) good++;
            <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (average &gt;= <span class="hljs-number">70</span>) medium++;
            <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (average &gt;= <span class="hljs-number">60</span>) pass++;
            <span class="hljs-keyword">else</span> fail++;
        }
        
        printDivider();
        System.out.println(<span class="hljs-string">"📊 分数分布统计："</span>);
        System.out.println(<span class="hljs-string">"优秀（90+）: "</span> + excellent + <span class="hljs-string">"人"</span>);
        System.out.println(<span class="hljs-string">"良好（80-89）: "</span> + good + <span class="hljs-string">"人"</span>);
        System.out.println(<span class="hljs-string">"中等（70-79）: "</span> + medium + <span class="hljs-string">"人"</span>);
        System.out.println(<span class="hljs-string">"及格（60-69）: "</span> + pass + <span class="hljs-string">"人"</span>);
        System.out.println(<span class="hljs-string">"不及格（&lt;60）: "</span> + fail + <span class="hljs-string">"人"</span>);
    }
    
    <span class="hljs-comment">// 打印分隔线</span>
    <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">printDivider</span><span class="hljs-params">()</span> {
        System.out.println(<span class="hljs-string">"----------------------------"</span>);
    }
}
</code></pre>
<h2 data-id="heading-13">七、总结：最重要的知识点</h2>
<h3 data-id="heading-14">🎯 核心要点总结：</h3>
<ol>
<li>
<p><strong>方法是代码的积木块</strong>：把常用的代码封装成方法，让程序更清晰、更易维护</p>
</li>
<li>
<p><strong>方法三要素</strong>：</p>
<ul>
<li><strong>方法名</strong>：要见名知义，用动词开头（如calculate、print、get）</li>
<li><strong>参数列表</strong>：方法需要的输入信息</li>
<li><strong>返回值</strong>：方法执行后给出的结果（没有返回值用void）</li>
</ul>
</li>
<li>
<p><strong>方法调用</strong>：使用方法名加括号，传入需要的参数</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 定义方法</span>
<span class="hljs-keyword">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">add</span><span class="hljs-params">(<span class="hljs-type">int</span> a, <span class="hljs-type">int</span> b)</span> {
    <span class="hljs-keyword">return</span> a + b;
}

<span class="hljs-comment">// 调用方法</span>
<span class="hljs-type">int</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> add(<span class="hljs-number">5</span>, <span class="hljs-number">3</span>);
</code></pre>
</li>
<li>
<p><strong>方法重载</strong>：同一个方法名，不同的参数列表</p>
<pre><code class="hljs language-java" lang="java">add(<span class="hljs-number">5</span>, <span class="hljs-number">3</span>);      <span class="hljs-comment">// 调用int版本</span>
add(<span class="hljs-number">5.5</span>, <span class="hljs-number">3.3</span>);  <span class="hljs-comment">// 调用double版本</span>
</code></pre>
</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[linux端进行kafka集群服务的搭建]]></title>    <link>https://juejin.cn/post/7585397173023768595</link>    <guid>https://juejin.cn/post/7585397173023768595</guid>    <pubDate>2025-12-20T07:39:09.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585397173023768595" data-draft-id="7585382553290801188" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="linux端进行kafka集群服务的搭建"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-12-20T07:39:09.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="苏三的开发日记"/> <meta itemprop="url" content="https://juejin.cn/user/4248949048749213"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            linux端进行kafka集群服务的搭建
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4248949048749213/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    苏三的开发日记
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-20T07:39:09.000Z" title="Sat Dec 20 2025 07:39:09 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">1.环境变量的配置</h2>
<h5 data-id="heading-1">1.1 修改/etc/hosts</h5>
<pre><code class="hljs language-js" lang="js"><span class="hljs-number">192.168</span><span class="hljs-number">.220</span><span class="hljs-number">.102</span> hadoop102
<span class="hljs-number">192.168</span><span class="hljs-number">.220</span><span class="hljs-number">.103</span> hadoop103
<span class="hljs-number">192.168</span><span class="hljs-number">.220</span><span class="hljs-number">.104</span> hadoop104
</code></pre>
<h5 data-id="heading-2">1.2 修改/etc/hostname</h5>
<pre><code class="hljs language-js" lang="js">hadoop102
</code></pre>
<h5 data-id="heading-3">1.3 添加文件/etc/profile.d/my_env.sh</h5>
<pre><code class="hljs language-js" lang="js">#<span class="hljs-variable constant_">JAVA_HOME</span>
<span class="hljs-keyword">export</span> <span class="hljs-variable constant_">JAVA_HOME</span>=<span class="hljs-regexp">/opt/m</span>odule/jdk1<span class="hljs-number">.8</span><span class="hljs-number">.0_212</span>
<span class="hljs-keyword">export</span> <span class="hljs-variable constant_">PATH</span>=<span class="hljs-attr">$PATH</span>:$JAVA_HOME/bin
#<span class="hljs-variable constant_">HADOOP_HOME</span>
<span class="hljs-keyword">export</span> <span class="hljs-variable constant_">HADOOP_HOME</span>=<span class="hljs-regexp">/opt/m</span>odule/hadoop-<span class="hljs-number">3.1</span><span class="hljs-number">.3</span>
<span class="hljs-keyword">export</span> <span class="hljs-variable constant_">PATH</span>=<span class="hljs-attr">$PATH</span>:$HADOOP_HOME/bin
<span class="hljs-keyword">export</span> <span class="hljs-variable constant_">PATH</span>=<span class="hljs-attr">$PATH</span>:$HADOOP_HOME/sbin
#<span class="hljs-variable constant_">KAFKA_HOME</span>
<span class="hljs-keyword">export</span> <span class="hljs-variable constant_">KAFKA_HOME</span>=<span class="hljs-regexp">/opt/m</span>odule/kafka
<span class="hljs-keyword">export</span> <span class="hljs-variable constant_">PATH</span>=<span class="hljs-attr">$PATH</span>:$KAFKA_HOME/bin

保存之后 source /etc/profile.<span class="hljs-property">d</span>/my_env.<span class="hljs-property">sh</span>
</code></pre>
<h2 data-id="heading-4">2.SSH之间进行无密登录访问</h2>
<pre><code class="hljs language-js" lang="js"><span class="hljs-number">1.</span>使用hadoop102 进行演示

登录虚拟机hadoop102
ssh-keygen -t rsa 
然后敲（三个回车），就会生成两个文件id_rsa（私钥）、id_rsa.<span class="hljs-property">pub</span>（公钥）

ssh-copy-id hadoop102
ssh-copy-id hadoop103
ssh-copy-id hadoop104
</code></pre>
<h2 data-id="heading-5">3.zookeeper安装</h2>
<pre><code class="hljs language-js" lang="js">在/opt/<span class="hljs-variable language_">module</span>/zookeeper/目录下创建zkData
# 创建myid文件内容如下
<span class="hljs-number">1</span>

# 进入cd /opt/<span class="hljs-variable language_">module</span>/zookeeper/conf文件目录
cd /opt/<span class="hljs-variable language_">module</span>/zookeeper/conf

# 修改文件名称
mv zoo_sample.<span class="hljs-property">cfg</span> zoo.<span class="hljs-property">cfg</span>

# 修改文件内容
vim zoo.<span class="hljs-property">cfg</span>

# 以下内容为修改内容
dataDir=<span class="hljs-regexp">/opt/m</span>odule/zookeeper/zkData
server<span class="hljs-number">.1</span>=<span class="hljs-attr">hadoop102</span>:<span class="hljs-number">2888</span>:<span class="hljs-number">3888</span>
server<span class="hljs-number">.2</span>=<span class="hljs-attr">hadoop103</span>:<span class="hljs-number">2888</span>:<span class="hljs-number">3888</span>
server<span class="hljs-number">.3</span>=<span class="hljs-attr">hadoop104</span>:<span class="hljs-number">2888</span>:<span class="hljs-number">3888</span>

# 进入/opt/<span class="hljs-variable language_">module</span>路径
cd /opt/<span class="hljs-variable language_">module</span>

# 调用分发脚本将本机得<span class="hljs-title class_">ZooKeeper</span>安装包分发到其他两台机器
xsync zookeeper
</code></pre>
<h2 data-id="heading-6">4.zookeeper启动脚本</h2>
<pre><code class="hljs language-js" lang="js">#!<span class="hljs-regexp">/bin/</span>bash

<span class="hljs-keyword">case</span> $1 <span class="hljs-keyword">in</span>
<span class="hljs-string">"start"</span>){
	<span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> hadoop102 hadoop103 hadoop104
	<span class="hljs-keyword">do</span>
        echo ---------- zookeeper $i 启动 ------------
		ssh $i <span class="hljs-string">"/opt/module/zookeeper/bin/zkServer.sh start"</span>
	done
};;
<span class="hljs-string">"stop"</span>){
	<span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> hadoop102 hadoop103 hadoop104
	<span class="hljs-keyword">do</span>
        echo ---------- zookeeper $i 停止 ------------    
		ssh $i <span class="hljs-string">"/opt/module/zookeeper/bin/zkServer.sh stop"</span>
	done
};;
<span class="hljs-string">"status"</span>){
	<span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> hadoop102 hadoop103 hadoop104
	<span class="hljs-keyword">do</span>
        echo ---------- zookeeper $i 状态 ------------    
		ssh $i <span class="hljs-string">"/opt/module/zookeeper/bin/zkServer.sh status"</span>
	done
};;
esac
</code></pre>
<h2 data-id="heading-7">5.kafka安装</h2>
<pre><code class="hljs language-js" lang="js">vim server.<span class="hljs-property">properties</span>

#broker的全局唯一编号，每个服务节点不能重复，只能是数字。
broker.<span class="hljs-property">id</span>=<span class="hljs-number">1</span> #(hadoop102-&gt;<span class="hljs-number">1</span> hadoop103-&gt;<span class="hljs-number">2</span> hadoop104-&gt;<span class="hljs-number">3</span>)

#broker对外暴露的<span class="hljs-variable constant_">IP</span>和端口 （每个节点单独配置）
advertised.<span class="hljs-property">listeners</span>=<span class="hljs-attr">PLAINTEXT</span>:<span class="hljs-comment">//hadoop102:9092 #(hadoop102-&gt;hadoop102:9092 hadoop103-&gt;hadoop103:9092 hadoop104-&gt;hadoop104:9092)</span>

路径，路径与路径之间可以用<span class="hljs-string">"，"</span>分隔
log.<span class="hljs-property">dirs</span>=<span class="hljs-regexp">/opt/m</span>odule/kafka/datas

#配置连接<span class="hljs-title class_">Zookeeper</span>集群地址（在zk根目录下创建/kafka，方便管理）
zookeeper.<span class="hljs-property">connect</span>=<span class="hljs-attr">hadoop102</span>:<span class="hljs-number">2181</span>,<span class="hljs-attr">hadoop103</span>:<span class="hljs-number">2181</span>,<span class="hljs-attr">hadoop104</span>:<span class="hljs-number">2181</span>/kafka

</code></pre>
<h2 data-id="heading-8">6.kafka启动脚本</h2>
<pre><code class="hljs language-js" lang="js">#! <span class="hljs-regexp">/bin/</span>bash

<span class="hljs-keyword">case</span> $1 <span class="hljs-keyword">in</span>
<span class="hljs-string">"start"</span>){
    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> hadoop102 hadoop103 hadoop104
    <span class="hljs-keyword">do</span>
        echo <span class="hljs-string">" --------启动 $i Kafka-------"</span>
        ssh $i <span class="hljs-string">"/opt/module/kafka/bin/kafka-server-start.sh -daemon /opt/module/kafka/config/server.properties"</span>
    done
};;
<span class="hljs-string">"stop"</span>){
    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> hadoop102 hadoop103 hadoop104
    <span class="hljs-keyword">do</span>
        echo <span class="hljs-string">" --------停止 $i Kafka-------"</span>
        ssh $i <span class="hljs-string">"/opt/module/kafka/bin/kafka-server-stop.sh "</span>
    done
};;
esac
</code></pre>
<h2 data-id="heading-9">7.cluster管理脚本</h2>
<pre><code class="hljs language-js" lang="js">#!<span class="hljs-regexp">/bin/</span>bash

<span class="hljs-keyword">case</span> $1 <span class="hljs-keyword">in</span>
<span class="hljs-string">"start"</span>){
        echo ================== 启动 <span class="hljs-title class_">Kafka</span>集群 ==================
        #启动 <span class="hljs-title class_">Zookeeper</span>集群
        zk.<span class="hljs-property">sh</span> start

        #启动 <span class="hljs-title class_">Kafka</span>采集集群
        kafka.<span class="hljs-property">sh</span> start

        };;
<span class="hljs-string">"stop"</span>){
        echo ================== 停止 <span class="hljs-title class_">Kafka</span>集群 ==================

        #停止 <span class="hljs-title class_">Kafka</span>采集集群
        kafka.<span class="hljs-property">sh</span> stop

		#循环直至 <span class="hljs-title class_">Kafka</span> 集群进程全部停止
		kafka_count=$(xcall jps | grep <span class="hljs-title class_">Kafka</span> | wc -l)
		<span class="hljs-keyword">while</span> [ $kafka_count -gt <span class="hljs-number">0</span> ]
		<span class="hljs-keyword">do</span>
			sleep <span class="hljs-number">1</span>
			kafka_count=$(xcall | grep <span class="hljs-title class_">Kafka</span> | wc -l)
            echo <span class="hljs-string">"当前未停止的 Kafka 进程数为 $kafka_count"</span>
		done

        #停止 <span class="hljs-title class_">Zookeeper</span>集群
        zk.<span class="hljs-property">sh</span> stop
};;
esac
</code></pre>
<h2 data-id="heading-10">8.xcall与xsync脚本</h2>
<h5 data-id="heading-11">8.1 xcall</h5>
<pre><code class="hljs language-js" lang="js">#!<span class="hljs-regexp">/bin/</span>bash

# ====== 节点列表（按你集群实际修改）======
<span class="hljs-variable constant_">HOSTS</span>=(<span class="hljs-string">"hadoop102"</span> <span class="hljs-string">"hadoop103"</span> <span class="hljs-string">"hadoop104"</span>)

# ====== 参数校验 ======
<span class="hljs-keyword">if</span> [ $# -lt <span class="hljs-number">1</span> ]; then
  echo <span class="hljs-string">"Usage: xcall &lt;command&gt;"</span>
  exit <span class="hljs-number">1</span>
fi

# ====== 执行 ======
<span class="hljs-keyword">for</span> host <span class="hljs-keyword">in</span> <span class="hljs-string">"${HOSTS[@]}"</span>; <span class="hljs-keyword">do</span>
  echo <span class="hljs-string">"==================== $host ===================="</span>
  ssh $host <span class="hljs-string">"$@"</span>
done
</code></pre>
<h5 data-id="heading-12">8.2 xsync</h5>
<pre><code class="hljs language-js" lang="js">#!<span class="hljs-regexp">/bin/</span>bash

# <span class="hljs-number">1.</span> 判断参数个数
<span class="hljs-keyword">if</span> [ $# -lt <span class="hljs-number">1</span> ]; then
    echo <span class="hljs-string">"Not Enough Arguement!"</span>
    exit <span class="hljs-number">1</span>
fi

# <span class="hljs-number">2.</span> 遍历集群所有机器
<span class="hljs-keyword">for</span> host <span class="hljs-keyword">in</span> hadoop102 hadoop103 hadoop104; <span class="hljs-keyword">do</span>
    echo <span class="hljs-string">"==================== $host ===================="</span>

    # <span class="hljs-number">3.</span> 遍历所有目录，挨个发送
    <span class="hljs-keyword">for</span> file <span class="hljs-keyword">in</span> <span class="hljs-string">"$@"</span>; <span class="hljs-keyword">do</span>
        # <span class="hljs-number">4.</span> 判断文件是否存在
        <span class="hljs-keyword">if</span> [ -e <span class="hljs-string">"$file"</span> ]; then
            # <span class="hljs-number">5.</span> 获取父目录
            pdir=$(cd -P <span class="hljs-string">"$(dirname "</span>$file<span class="hljs-string">")"</span>; pwd)
            # <span class="hljs-number">6.</span> 获取当前文件的名称
            fname=$(basename <span class="hljs-string">"$file"</span>)

            ssh <span class="hljs-string">"$host"</span> <span class="hljs-string">"mkdir -p $pdir"</span>
            rsync -av <span class="hljs-string">"$pdir/$fname"</span> <span class="hljs-string">"$host:$pdir"</span>
        <span class="hljs-keyword">else</span>
            echo <span class="hljs-string">"$file does not exist!"</span>
        fi
    done
done
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[从Activity.setContentView()开始]]></title>    <link>https://juejin.cn/post/7585397173023850515</link>    <guid>https://juejin.cn/post/7585397173023850515</guid>    <pubDate>2025-12-20T07:49:48.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585397173023850515" data-draft-id="7585468725332049974" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="从Activity.setContentView()开始"/> <meta itemprop="keywords" content="Android"/> <meta itemprop="datePublished" content="2025-12-20T07:49:48.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="StarShip"/> <meta itemprop="url" content="https://juejin.cn/user/3790771820172391"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            从Activity.setContentView()开始
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3790771820172391/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    StarShip
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-20T07:49:48.000Z" title="Sat Dec 20 2025 07:49:48 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一、从 Activity.setContentView() 开始的调用链</h2>
<pre><code class="hljs language-scss" lang="scss">Activity<span class="hljs-selector-class">.setContentView</span>(layoutId)
    ↓
PhoneWindow<span class="hljs-selector-class">.setContentView</span>(view)
    ↓
创建 / 装配 DecorView
    ↓
WindowManager<span class="hljs-selector-class">.addView</span>(DecorView, params)
    ↓
WindowManagerGlobal<span class="hljs-selector-class">.addView</span>(...)
    ↓
new <span class="hljs-built_in">ViewRootImpl</span>(...)
    ↓
ViewRootImpl<span class="hljs-selector-class">.setView</span>(DecorView, params)
    ↓
<span class="hljs-built_in">requestLayout</span>() → <span class="hljs-built_in">scheduleTraversals</span>()
    ↓
<span class="hljs-built_in">doTraversal</span>() → <span class="hljs-built_in">performMeasure</span>() / <span class="hljs-built_in">performLayout</span>() / <span class="hljs-built_in">performDraw</span>()
    ↓
View 树 <span class="hljs-built_in">onDraw</span>(Canvas)
    ↓
<span class="hljs-selector-tag">Canvas</span> → Skia → (OpenGL ES / 软件渲染)
    ↓
绘制到 Surface 的 Buffer
</code></pre>
<hr/>
<h2 data-id="heading-1">二、Activity, Window, DecorView：界面“外壳结构”</h2>
<ol>
<li>
<h3 data-id="heading-2">Activity：逻辑入口 + 拥有一个 Window</h3>
</li>
</ol>
<ul>
<li>每个 Activity 内部都持有一个 Window（通常是 <code>PhoneWindow</code>）。</li>
<li>当你调用：setContentView(R.layout.activity_main);</li>
</ul>
<p>其实是</p>
<pre><code class="hljs language-less" lang="less"><span class="hljs-selector-tag">public</span> <span class="hljs-selector-tag">void</span> <span class="hljs-selector-tag">setContentView</span>(<span class="hljs-variable">@LayoutRes</span> int layoutResID) {
    <span class="hljs-selector-tag">getWindow</span>()<span class="hljs-selector-class">.setContentView</span>(layoutResID); <span class="hljs-comment">// 交给 PhoneWindow</span>
}
</code></pre>
<ol start="2">
<li>
<h3 data-id="heading-3">Window / PhoneWindow：管理 DecorView 的“窗口对象”</h3>
</li>
</ol>
<ul>
<li>
<p>Window 是一个抽象类，PhoneWindow 是常见实现。</p>
</li>
<li>
<p>它负责：</p>
<ul>
<li>创建并管理 DecorView（整个窗口的根视图）；</li>
<li>处理标题栏、状态栏适配等“窗口装饰”。</li>
</ul>
</li>
</ul>
<p>简化的调用链：</p>
<pre><code class="hljs language-scss" lang="scss">Activity<span class="hljs-selector-class">.setContentView</span>()
    └─ PhoneWindow<span class="hljs-selector-class">.setContentView</span>()
            ├─ <span class="hljs-built_in">ensureDecor</span>()  <span class="hljs-comment">// 确保 DecorView 已创建</span>
            │     └─ <span class="hljs-built_in">installDecor</span>()
            │          └─ mDecor = new <span class="hljs-built_in">DecorView</span>(...)
            └─ 将 layoutId inflate 成 View，并添加到 mDecor 的 <span class="hljs-attribute">content</span> 区域
</code></pre>
<ol start="3">
<li>
<h3 data-id="heading-4">DecorView &amp; View / ViewGroup：UI 树结构</h3>
</li>
</ol>
<ul>
<li>
<p>DecorView：</p>
<ul>
<li>继承自 ViewGroup；</li>
<li>是当前 Window 的 根 View；</li>
<li>内含状态栏/标题栏区域 + 内容区域。</li>
</ul>
</li>
<li>
<p>XML 布局最终会成为：</p>
</li>
</ul>
<pre><code class="hljs language-scss" lang="scss">DecorView (FrameLayout)
    └─ contentParent (id=android.R.id.content)
          └─ 你的根 ViewGroup (例如 ConstraintLayout)
                └─ 若干子 View / ViewGroup
</code></pre>
<p>这些 View/ViewGroup 负责在三大阶段中工作：</p>
<ul>
<li><code>onMeasure()</code>：计算大小；</li>
<li><code>onLayout()</code>：确定位置；</li>
<li><code>onDraw(Canvas)</code>：在 Canvas 上画出自己。</li>
</ul>
<p>这一切目前 还只是在<strong>内存结构</strong>上建立，还没有真正“出现在屏幕上”。</p>
<h2 data-id="heading-5">三、WindowManager / WMS / ViewRootImpl：把 DecorView 挂到窗口 &amp; Surface 上</h2>
<ol>
<li>
<h3 data-id="heading-6">WindowManager：应用侧窗口管理接口</h3>
</li>
</ol>
<ul>
<li>Activity 内可以调用 <code>getWindowManager()</code> 或使用 <code>WindowManager</code> 添加/更新 View（如 Dialog、Toast）。</li>
<li>当 <code>PhoneWindow.setContentView()</code> 完成 DecorView 构造后，Activity/系统会调用：</li>
</ul>
<pre><code class="hljs language-ini" lang="ini">WindowManager <span class="hljs-attr">wm</span> = getWindowManager()<span class="hljs-comment">;</span>
wm.addView(decorView, layoutParams)<span class="hljs-comment">;</span>
</code></pre>
<ol start="2">
<li>
<h3 data-id="heading-7">WindowManagerGlobal / ViewRootImpl：建立与 WMS 的连接</h3>
</li>
</ol>
<p><code>WindowManager.addView()</code> 内部最终走到：</p>
<pre><code class="hljs language-scss" lang="scss">WindowManagerGlobal<span class="hljs-selector-class">.addView</span>(view, params)
    ├─ 创建 ViewRootImpl root = new <span class="hljs-built_in">ViewRootImpl</span>(context, display)
    ├─ root<span class="hljs-selector-class">.setView</span>(view, params)
    └─ 记录 (view ↔ root) 映射关系
</code></pre>
<p>此时几个关键点：</p>
<ul>
<li>ViewRootImpl 被创建；</li>
<li>DecorView 被交给 ViewRootImpl 管理；</li>
<li>ViewRootImpl 通过 Binder 与 WMS（WindowManagerService） 通信，申请窗口、布局、Surface 等。</li>
</ul>
<ol start="3">
<li>
<h3 data-id="heading-8">WMS（WindowManagerService）：系统级窗口管理</h3>
</li>
</ol>
<p>在 系统进程 中运行，统一管理所有 app 的窗口：</p>
<ul>
<li>决定窗口的位置、尺寸、Z 轴顺序；</li>
<li>为窗口分配/更新对应的 Surface；</li>
<li>将窗口信息提供给 SurfaceFlinger 刷新显示。</li>
</ul>
<p>关系图（结构视角）：</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-selector-attr">[ Activity ]</span>
    └─ <span class="hljs-selector-attr">[ Window (PhoneWindow) ]</span>
            └─ <span class="hljs-selector-attr">[ DecorView (ViewGroup 根) ]</span>
                    ↑
                    │ <span class="hljs-built_in">setContentView</span>()
                    │
<span class="hljs-selector-attr">[ WindowManagerImpl ]</span> (App进程)
    └─ <span class="hljs-selector-attr">[ WindowManagerGlobal ]</span>
            └─ new <span class="hljs-built_in">ViewRootImpl</span>(...)
                    └─ <span class="hljs-built_in">setView</span>(DecorView, params)
                           ↕ Binder
                     <span class="hljs-selector-attr">[ WMS (系统进程) ]</span>
                           └─ 管理 Window、分配 Surface
</code></pre>
<h2 data-id="heading-9">四、Surface：ViewRootImpl 与图形系统的“接缝处”</h2>
<ol>
<li>
<h3 data-id="heading-10">Surface：底层缓冲队列的 Java 封装</h3>
</li>
</ol>
<ul>
<li>
<p>每个 Window 在 WMS/SurfaceFlinger 侧都会有一个 Surface 对应；</p>
</li>
<li>
<p>对 ViewRootImpl 来说，它持有一个 <code>Surface mSurface</code>：</p>
<ul>
<li>这是它绘制输出的目标；</li>
<li>内部与 BufferQueue 关联，生产者是当前窗口（App 侧），消费者是 SurfaceFlinger。</li>
</ul>
</li>
</ul>
<ol start="2">
<li>
<h3 data-id="heading-11">ViewRootImpl.setView() &amp; requestLayout()</h3>
</li>
</ol>
<p><code>ViewRootImpl.setView()</code> 完成：</p>
<ul>
<li>保存根 View = DecorView；</li>
<li>向 WMS 注册窗口；</li>
<li>初始化 <code>Surface</code>；</li>
<li>调用 <code>requestLayout()</code>，触发第一次测量/布局/绘制。</li>
</ul>
<p><code>requestLayout()</code> 内部最终会走到：</p>
<pre><code class="hljs language-scss" lang="scss">ViewRootImpl<span class="hljs-selector-class">.requestLayout</span>()
    └─ <span class="hljs-built_in">scheduleTraversals</span>()
           └─ mChoreographer<span class="hljs-selector-class">.postCallback</span>(TRAVERSAL, mTraversalRunnable, ...)
</code></pre>
<p>这里就引出了 Choreographer。</p>
<h2 data-id="heading-12">五、Choreographer + Handler：VSync 驱动的 UI 刷新</h2>
<ol>
<li>
<h3 data-id="heading-13">Handler / Looper：消息循环基础</h3>
</li>
</ol>
<ul>
<li>
<p>UI 线程拥有 Looper + MessageQueue；</p>
</li>
<li>
<p>Handler 用来：</p>
<ul>
<li>发送消息、投递 Runnable；</li>
<li>在 UI 线程执行各种回调（包括 ViewRootImpl 的刷新逻辑）。</li>
</ul>
</li>
</ul>
<ol start="2">
<li>
<h3 data-id="heading-14">Choreographer：基于 VSync 的帧调度器</h3>
</li>
</ol>
<ul>
<li>
<p>Choreographer 挂在 UI 线程上；</p>
</li>
<li>
<p><code>scheduleTraversals()</code> 会通过 Choreographer 在 下一个 VSync 时 执行 <code>doTraversal()</code>，而不是立刻执行：</p>
<ul>
<li>这样能保证所有 <code>requestLayout()/invalidate()</code> 合并到下一帧统一处理；</li>
<li>避免“抖动”和无意义重复绘制。</li>
</ul>
</li>
</ul>
<p>简化版时序：</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-built_in">requestLayout</span>() / <span class="hljs-built_in">invalidate</span>()
    ↓
ViewRootImpl<span class="hljs-selector-class">.scheduleTraversals</span>()
    ↓
Choreographer<span class="hljs-selector-class">.postCallback</span>(TRAVERSAL, doTraversal)
    ↓   (等到下一次 VSync)
Choreographer<span class="hljs-selector-id">#doFrame</span>()
    └─ <span class="hljs-built_in">doTraversal</span>()  <span class="hljs-comment">// 核心渲染流程</span>
</code></pre>
<h2 data-id="heading-15">六、ViewRootImpl.doTraversal()：三大流程 + Canvas / Skia / OpenGL ES</h2>
<p><code>doTraversal()</code> 里会顺序执行：</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-built_in">performMeasure</span>() → <span class="hljs-built_in">performLayout</span>() → <span class="hljs-built_in">performDraw</span>()
</code></pre>
<ol>
<li>
<h3 data-id="heading-16">performMeasure()</h3>
</li>
</ol>
<ul>
<li>
<p>从 DecorView 开始向下：</p>
<ul>
<li>调用每个 View / ViewGroup 的 <code>onMeasure()</code>；</li>
<li>计算 width/height。</li>
</ul>
</li>
</ul>
<ol start="2">
<li>
<h3 data-id="heading-17">performLayout()</h3>
</li>
</ol>
<ul>
<li>
<p>对根 View 调用 <code>layout(l, t, r, b)</code>：</p>
<ul>
<li>ViewGroup 会在 <code>onLayout()</code> 中安排子 View 的位置；</li>
<li>整个树的几何结构确定。</li>
</ul>
</li>
</ul>
<ol start="3">
<li>
<h3 data-id="heading-18">performDraw()：真正的绘制</h3>
</li>
</ol>
<p>核心逻辑类似：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">performDraw</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// 省略前置逻辑</span>
    <span class="hljs-title function_">draw</span>(fullRedrawNeeded);
}

<span class="hljs-keyword">private</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">draw</span>(<span class="hljs-params"><span class="hljs-built_in">boolean</span> fullRedrawNeeded</span>) {
    <span class="hljs-comment">// 获取/准备 Canvas</span>
    <span class="hljs-comment">// 调用 DecorView.draw(canvas)</span>
}
</code></pre>
<p>调用链：</p>
<pre><code class="hljs language-scss" lang="scss">ViewRootImpl<span class="hljs-selector-class">.performDraw</span>()
    └─ DecorView<span class="hljs-selector-class">.draw</span>(Canvas)
          └─ <span class="hljs-built_in">drawBackground</span>()
          └─ <span class="hljs-built_in">onDraw</span>(Canvas)
          └─ <span class="hljs-built_in">dispatchDraw</span>(Canvas)  <span class="hljs-comment">// 调子 View 的 draw()</span>
                 └─ 每个子 View 的 <span class="hljs-built_in">onDraw</span>(Canvas)
</code></pre>
<ol start="4">
<li>
<h3 data-id="heading-19">Canvas / Skia / OpenGL ES</h3>
</li>
</ol>
<p>在 <code>onDraw(Canvas)</code> 中，开发者用 <code>Canvas</code> 提供的 API 绘制：</p>
<pre><code class="hljs language-css" lang="css">protected void onDraw(<span class="hljs-selector-tag">Canvas</span> <span class="hljs-selector-tag">canvas</span>) {
    <span class="hljs-selector-tag">canvas</span><span class="hljs-selector-class">.drawRect</span>(...);
    <span class="hljs-selector-tag">canvas</span><span class="hljs-selector-class">.drawText</span>(...);
    <span class="hljs-selector-tag">canvas</span><span class="hljs-selector-class">.drawBitmap</span>(...);
}
</code></pre>
<p>底层发生了：</p>
<pre><code class="hljs language-arduino" lang="arduino">Canvas API
    ↓
<span class="hljs-built_in">Skia</span> (<span class="hljs-number">2</span>D 引擎)
    ↓
※ 若软件渲染：在 CPU 内存 buffer 中画像素
※ 若硬件加速(HWUI + OpenGL ES/Vulkan)：
       Skia 将绘制指令转换为 GPU 命令
           ↓
       通过 OpenGL ES / Vulkan 调 GPU 渲染
           ↓
       GPU 把结果写入当前 Surface 的 buffer
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Coze编程首测：我用大白话搭了个“AI漫剧流水线”，太离谱了！]]></title>    <link>https://juejin.cn/post/7585463258690600969</link>    <guid>https://juejin.cn/post/7585463258690600969</guid>    <pubDate>2025-12-20T06:04:49.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585463258690600969" data-draft-id="7585686247269154825" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content=" Coze编程首测：我用大白话搭了个“AI漫剧流水线”，太离谱了！"/> <meta itemprop="keywords" content="Coze,人工智能,AIGC"/> <meta itemprop="datePublished" content="2025-12-20T06:04:49.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="后端小肥肠"/> <meta itemprop="url" content="https://juejin.cn/user/2966945320667536"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
             Coze编程首测：我用大白话搭了个“AI漫剧流水线”，太离谱了！
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2966945320667536/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    后端小肥肠
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-20T06:04:49.000Z" title="Sat Dec 20 2025 06:04:49 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#383838;font-size:15px;line-height:30px;letter-spacing:2px;word-break:break-word;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen,Ubuntu,Cantarell,Open Sans,Helvetica Neue,sans-serif;scroll-behavior:smooth;background-image:linear-gradient(0deg,transparent 24%,rgba(201,195,195,.329) 25%,hsla(0,8%,80.4%,.05) 26%,transparent 27%,transparent 74%,hsla(0,5.2%,81%,.185) 75%,rgba(180,176,176,.05) 76%,transparent 77%,transparent),linear-gradient(90deg,transparent 24%,rgba(204,196,196,.226) 25%,hsla(0,4%,66.1%,.05) 26%,transparent 27%,transparent 74%,hsla(0,5.2%,81%,.185) 75%,rgba(180,176,176,.05) 76%,transparent 77%,transparent);background-color:#fff;background-size:50px 50px;padding-bottom:60px}.markdown-body ::selection{color:#fff;background-color:#a862ea}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{margin:24px 0 12px;color:#a862ea}.markdown-body h1{line-height:2;font-size:1.4em}.markdown-body h1~p:first-of-type:first-letter{color:#a862ea;float:left;font-size:2em;margin-right:.4em;font-weight:bolder}.markdown-body h2{font-size:1.2em}.markdown-body h3{font-size:1.1em}.markdown-body ol,.markdown-body ul{padding-left:2em}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;padding-left:.2em}.markdown-body ol li::marker,.markdown-body ul li::marker{color:#a862ea}.markdown-body ol li.task-list-item,.markdown-body ul li.task-list-item{list-style:none}.markdown-body ol li.task-list-item ol,.markdown-body ol li.task-list-item ul,.markdown-body ul li.task-list-item ol,.markdown-body ul li.task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:10px}.markdown-body a,.markdown-body code,.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6,.markdown-body li,.markdown-body p{opacity:.85;vertical-align:baseline;transition:all .1s ease}.markdown-body a:hover,.markdown-body code:hover,.markdown-body h1:hover,.markdown-body h2:hover,.markdown-body h3:hover,.markdown-body h4:hover,.markdown-body h5:hover,.markdown-body h6:hover,.markdown-body li:hover,.markdown-body p:hover{opacity:1}.markdown-body a{display:inline-block;color:#a862ea;cursor:pointer;text-decoration:none;position:relative}.markdown-body a:after{content:"";position:absolute;width:98%;height:1px;bottom:0;left:0;transform:scaleX(0);background-color:#a862ea;transform-origin:bottom right;transition:transform .3s ease-in-out}.markdown-body a:hover:after{transform:scaleX(1);transform-origin:bottom left}.markdown-body a:active,.markdown-body a:link{color:#a862ea}.markdown-body img{max-width:100%;user-select:none;margin:1em 0;transition:transform .2s ease 0s;background-color:#f8f5ff;box-shadow:0 0 10px #e7daff}.markdown-body img:hover{opacity:1;box-shadow:0 0 20px #e7daff;transform:translateY(-1px)}.markdown-body blockquote{padding:.5em 1em;margin:12px 0;border-top-left-radius:2px;border-bottom-left-radius:2px;border-left:3px solid #a862ea;background-color:#f8f5ff}.markdown-body blockquote&gt;p{margin:0}.markdown-body .math{font-style:italic;margin:12px 0;padding:.5em 1em;background-color:#f8f5ff}.markdown-body .math&gt;p{margin:0}.markdown-body code{padding:2px .4em;overflow-x:auto;color:#a862ea;font-weight:700;word-break:break-word;font-family:Operator Mono,Consolas,Monaco,Menlo,monospace;background-color:#f8f5ff}.markdown-body pre{margin:2em 0}.markdown-body pre&gt;code{display:block;padding:1.5em;word-break:normal;font-size:.9em;font-style:normal;font-weight:400;font-family:Operator Mono,Consolas,Monaco,Menlo,monospace;line-height:18px;color:#383838;border-radius:2px;scroll-behavior:smooth;box-shadow:0 0 10px #e7daff}.markdown-body pre&gt;code:hover{box-shadow:0 0 20px #e7daff}.markdown-body pre&gt;code::-webkit-scrollbar{height:6px;background-color:#f8f5ff}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:#e7daff;border-bottom-left-radius:3px;border-bottom-right-radius:3px}.markdown-body hr{margin:2em 0;border-top:1px solid #a862ea}.markdown-body table{width:100%;font-size:12px;max-width:100%;overflow:auto;border-collapse:collapse}.markdown-body thead{color:#a862ea;background:#f8f5ff}.markdown-body td,.markdown-body th{padding:.5em;border:1px solid #e7daff}.markdown-body tr{background-color:#f8f5ff}@media (max-width:720px){.markdown-body{font-size:12px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>大家好，我是小肥肠！今天我们将硬核实战 <strong>Coze 编程</strong>，打造一套全自动的 <strong>AI 漫剧分镜图片生成</strong> <strong>工作流</strong>。从一段小说原文到精美分镜图一键直出，全程保姆级教程，快来码住跟练，搭建属于你的自动化视觉流水线吧~</p>
<h2 data-id="heading-0">1. 前言</h2>
<p>最近AI漫剧爆火，我也在带着社群的朋友做这块的内容，之前的文章已经解决了AI漫剧版权的问题：<a href="https://juejin.cn/post/7582561515816484927" target="_blank" title="https://juejin.cn/post/7582561515816484927">突破 LLM 极限！n8n + MemMachine 打造“无限流”小说生成器</a>，<a href="https://juejin.cn/post/7580378958072610826" target="_blank" title="https://juejin.cn/post/7580378958072610826">通吃网文投稿+AI漫剧版权！我用 n8n+飞书搭了个“万字爆款小说流水线”</a>。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/01e81656088d44cf89b833244974ac95~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZCO56uv5bCP6IKl6IKg:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766815489&amp;x-signature=%2BMocmb7BaaqP31Q06U8EyFWMALg%3D" alt="" loading="lazy"/></p>
<p><strong>今天将给大家带来进一步的内容，将小说原文转换为动画分镜图，只需要略加一点动态提示词到AI视频软件就可以产出AI漫剧了。</strong></p>
<p><strong>就在昨天，Coze 编程功能重磅发布，它最大的黑科技在于支持基于自然语言搭建</strong> <strong>工作流</strong> <strong>。</strong> 我抱着试一试的心态，直接把我的需求<strong>丢</strong>给它，结果出乎意料——它竟然秒懂，并直接帮我生成了完整的工作流！整个过程丝滑无比，只需要输入小说内容，点击【试运行】，几分钟后，契合度极高的人物分镜图就诞生了。接下来，我就带大家实操这套<strong>有手就行</strong>的 AI 漫剧分镜流。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/dc91b20159e14457975b792c0d0b766b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZCO56uv5bCP6IKl6IKg:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766815489&amp;x-signature=%2Fj8e5mlULfTwGUKjhCycZa%2F3b6s%3D" alt="" loading="lazy"/></p>
<p>下面正式开始教程，文末还送工作流生成提示词，感兴趣就码住跟练~</p>
<h2 data-id="heading-1">2. Coze编程工作流实现</h2>
<p>基于Coze编程创建ai动漫分镜稿的步骤非常简单，首先打开网页<a href="https://link.juejin.cn?target=https%3A%2F%2Fcode.coze.cn%2Fhome%25EF%25BC%258C%25E8%25BE%2593%25E5%2585%25A5%25E6%258F%2590%25E7%25A4%25BA%25E8%25AF%258D%25E5%2590%258E%25E7%2582%25B9%25E5%2587%25BB%25E5%258F%2591%25E9%2580%2581%25E3%2580%2582" target="_blank" title="https://code.coze.cn/home%EF%BC%8C%E8%BE%93%E5%85%A5%E6%8F%90%E7%A4%BA%E8%AF%8D%E5%90%8E%E7%82%B9%E5%87%BB%E5%8F%91%E9%80%81%E3%80%82" ref="nofollow noopener noreferrer">code.coze.cn/home，输入提示词后…</a></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5b874cff035b4696bee5566273902c78~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZCO56uv5bCP6IKl6IKg:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766815489&amp;x-signature=J0TRgzsgmdX3WsvVbsWbNBXSi14%3D" alt="" loading="lazy"/></p>
<p><strong>提示词编写思路：</strong></p>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-bullet">1.</span> 提取小说内容生成短剧剧本
<span class="hljs-bullet">2.</span> 基于短剧剧本构建角色描述
<span class="hljs-bullet">3.</span> 生成分镜文生图提示词
<span class="hljs-bullet">4.</span> 调用生图模型生成分镜图
</code></pre>
<p>只需要把这四点逻辑告诉 Coze，就可以开始工作流的构建了。构建完成后，右侧界面会自动生成完整的工作流：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/791b103d180d45cbaf70b0394b7f4b72~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZCO56uv5bCP6IKl6IKg:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766815489&amp;x-signature=7FSFVMQHHtlnMtY3S44L4mZHrFI%3D" alt="" loading="lazy"/></p>
<p>点击右上角【试运行】按钮，输入小说文本内容后再点击底部【试运行】按钮，等待几分钟后就可以看到成品分镜图。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/375ecebc39764d21a3f89ad5ade3ead3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZCO56uv5bCP6IKl6IKg:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766815489&amp;x-signature=LEL4dvzfvgPfdYDM7oGSqjEDAzI%3D" alt="" loading="lazy"/></p>
<p>打开图片看一下，<strong>人物一致性</strong>保持得很不错！主要是我完全没进行复杂的精调，全是 Coze 自动理解生成的，这个契合度已经非常惊人了。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3db1029308e147fc99e03401bb00c8f9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZCO56uv5bCP6IKl6IKg:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766815489&amp;x-signature=ONcaipd%2BCH%2BEAAbGn1%2FhqGz%2B6i4%3D" alt="" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d0fc134d51ec483b9e0278e79502d8a6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZCO56uv5bCP6IKl6IKg:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766815489&amp;x-signature=8lPFFqpZtE09Ax4abcfRXBXtUuI%3D" alt="" loading="lazy"/></p>
<p>以上就是本期教程的完整内容。本文中生成工作流的提示词限时派送，限量30份，评论区留言ai漫剧即可获取。</p>
<h2 data-id="heading-2">3. 结语</h2>
<p>这次 Coze 编程的更新，最大的意义不在于工具本身，而在于它再次降低了 AI 内容创作的门槛。<strong>以前我们需要学习如何搭建</strong> <strong>工作流</strong> <strong>，现在我们只需要学会如何清晰地表达需求。</strong> 本文搭建的工作流对于想做 AI 漫剧却苦于没有美术基础、或者觉得分镜耗时太长的朋友来说，这绝对是一个提效利器。</p>
<p><strong>如本次分享对你有帮助，麻烦一键三连支持一下小肥肠，我们下期再见~</strong></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/eb8c39c5529840c38aea5bfdfadae0b6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZCO56uv5bCP6IKl6IKg:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766815489&amp;x-signature=7AKXNIR2fD4oNgW%2BEqtmftvo7P8%3D" alt="" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[【轻松掌握通信协议】C#的通信过程与协议实操 | 2024全新]]></title>    <link>https://juejin.cn/post/7585382553290473508</link>    <guid>https://juejin.cn/post/7585382553290473508</guid>    <pubDate>2025-12-20T05:58:33.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585382553290473508" data-draft-id="7585412203978309675" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="【轻松掌握通信协议】C#的通信过程与协议实操 | 2024全新"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-12-20T05:58:33.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="子元youkeit_xyz"/> <meta itemprop="url" content="https://juejin.cn/user/4469936823730986"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            【轻松掌握通信协议】C#的通信过程与协议实操 | 2024全新
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4469936823730986/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    子元youkeit_xyz
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-20T05:58:33.000Z" title="Sat Dec 20 2025 05:58:33 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    6
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>C<strong>QF 量化金融中文版（23 版）硬核资料｜6 万价值，量化投资通关秘籍</strong></p>
<p>在量化金融的世界里，理论与代码从来不分家。CQF（Certificate in Quantitative Finance）作为全球顶尖的量化金融认证课程，其核心不仅在于随机微积分、衍生品定价和风险管理等高深理论，更在于如何将这些模型转化为可运行、可验证、可交易的代码系统。2023 年新版 CQF 课程进一步强化了机器学习、高频数据处理与 Python 工程实践的比重，对学员的编程能力提出了更高要求。</p>
<p>本文结合《CQF 量化金融中文版（23 版）》硬核资料包中的核心内容，通过<strong>真实代码示例</strong>，带你一窥量化建模的关键环节——从 Black-Scholes 定价到蒙特卡洛模拟，再到使用 LSTM 预测波动率，真正实现“理论落地、代码驱动”。</p>
<hr/>
<h3 data-id="heading-0">一、Black-Scholes 期权定价：理论的第一行代码</h3>
<p>Black-Scholes 模型是 CQF 第一模块的基石。其解析解虽简洁，但理解其实现逻辑至关重要。</p>
<pre><code class="hljs language-python" lang="python">python
编辑
<span class="hljs-keyword">import</span> numpy <span class="hljs-keyword">as</span> np
<span class="hljs-keyword">from</span> scipy.stats <span class="hljs-keyword">import</span> norm

<span class="hljs-keyword">def</span> <span class="hljs-title function_">black_scholes_call</span>(<span class="hljs-params">S, K, T, r, sigma</span>):
    <span class="hljs-string">"""
    计算欧式看涨期权的 Black-Scholes 价格
    :param S: 标的资产当前价格
    :param K: 行权价
    :param T: 到期时间（年）
    :param r: 无风险利率
    :param sigma: 波动率
    :return: 期权价格
    """</span>
    d1 = (np.log(S / K) + (r + <span class="hljs-number">0.5</span> * sigma**<span class="hljs-number">2</span>) * T) / (sigma * np.sqrt(T))
    d2 = d1 - sigma * np.sqrt(T)
    call_price = S * norm.cdf(d1) - K * np.exp(-r * T) * norm.cdf(d2)
    <span class="hljs-keyword">return</span> call_price

<span class="hljs-comment"># 示例：S=100, K=100, T=1年, r=5%, sigma=20%</span>
price = black_scholes_call(<span class="hljs-number">100</span>, <span class="hljs-number">100</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0.05</span>, <span class="hljs-number">0.2</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"Call Option Price: <span class="hljs-subst">{price:<span class="hljs-number">.4</span>f}</span>"</span>)
</code></pre>
<p>这段代码不仅是公式翻译，更是后续 Greeks（Delta、Gamma 等）计算和对冲策略的基础。CQF 资料包中提供了完整的敏感性分析模板，助你理解“为什么波动率是期权的命脉”。</p>
<hr/>
<h3 data-id="heading-1">二、蒙特卡洛模拟：为路径依赖型衍生品定价</h3>
<p>对于亚式期权、回望期权等无解析解的产品，蒙特卡洛方法是 CQF 强调的核心数值技术。</p>
<pre><code class="hljs language-ini" lang="ini">python
编辑
def monte_carlo_asian_call(S0, K, T, r, sigma, <span class="hljs-attr">N</span>=<span class="hljs-number">1000</span>, M=<span class="hljs-number">10000</span>):
    """
    蒙特卡洛模拟亚式看涨期权（算术平均）
    :param N: 时间步数
    :param M: 模拟路径数
    """
    <span class="hljs-attr">dt</span> = T / N
    <span class="hljs-attr">drift</span> = (r - <span class="hljs-number">0.5</span> * sigma**<span class="hljs-number">2</span>) * dt
    <span class="hljs-attr">diffusion</span> = sigma * np.sqrt(dt)
    
    <span class="hljs-attr">payoffs</span> = []
    for _ in range(M):
        <span class="hljs-attr">path</span> = [S0]
        for _ in range(N):
            <span class="hljs-attr">Z</span> = np.random.normal()
            <span class="hljs-attr">St</span> = path[-<span class="hljs-number">1</span>] * np.exp(drift + diffusion * Z)
            path.append(St)
        <span class="hljs-attr">avg_price</span> = np.mean(path[<span class="hljs-number">1</span>:])  <span class="hljs-comment"># 算术平均</span>
        <span class="hljs-attr">payoff</span> = max(avg_price - K, <span class="hljs-number">0</span>)
        payoffs.append(payoff)
    
    <span class="hljs-attr">option_price</span> = np.exp(-r * T) * np.mean(pay<span class="hljs-literal">off</span>s)
    return option_price

<span class="hljs-attr">price_mc</span> = monte_carlo_asian_call(<span class="hljs-number">100</span>, <span class="hljs-number">100</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0.05</span>, <span class="hljs-number">0.2</span>, N=<span class="hljs-number">252</span>, M=<span class="hljs-number">50000</span>)
print(f"Asian Call (MC): {price_mc:.4f}")
</code></pre>
<p>CQF 资料包进一步引入<strong>方差缩减技术</strong>（如控制变量法、对偶变量法），将模拟效率提升数倍——这正是实战与玩具代码的区别。</p>
<hr/>
<h3 data-id="heading-2">三、用 GARCH 模型动态预测波动率</h3>
<p>CQF 第四模块深入讲解波动率建模。GARCH(1,1) 是业界标准，用于捕捉波动率聚集效应。</p>
<pre><code class="hljs language-ini" lang="ini">python
编辑
import arch

<span class="hljs-comment"># 假设已有股票日收益率序列 returns（pandas Series）</span>
def fit_garch(returns):
    <span class="hljs-attr">model</span> = arch.arch_model(returns, vol=<span class="hljs-string">'Garch'</span>, p=<span class="hljs-number">1</span>, q=<span class="hljs-number">1</span>, dist=<span class="hljs-string">'Normal'</span>)
    <span class="hljs-attr">fitted</span> = model.fit(disp=<span class="hljs-string">'off'</span>)
    <span class="hljs-attr">forecast</span> = fitted.forecast(horizon=<span class="hljs-number">1</span>)
    <span class="hljs-comment"># 预测未来1天的条件方差</span>
    <span class="hljs-attr">cond_vol</span> = np.sqrt(forecast.variance.values[-<span class="hljs-number">1</span>, <span class="hljs-number">0</span>])
    return cond_vol

<span class="hljs-comment"># 示例（需真实数据）</span>
<span class="hljs-comment"># daily_returns = get_stock_returns('AAPL')</span>
<span class="hljs-comment"># vol_forecast = fit_garch(daily_returns)</span>
<span class="hljs-comment"># print(f"Predicted Volatility: {vol_forecast:.4f}")</span>
</code></pre>
<p>资料包提供完整 A 股/美股数据获取脚本，并对比 GARCH 与隐含波动率（IV）的预测能力，助你构建更稳健的期权交易策略。</p>
<hr/>
<h3 data-id="heading-3">四、LSTM 预测股价方向（CQF 23 版新增 AI 模块）</h3>
<p>2023 版 CQF 新增“AI in Finance”专题，强调深度学习在 alpha 挖掘中的应用。</p>
<pre><code class="hljs language-ini" lang="ini">python
编辑
from tensorflow.keras.models import Sequential
from tensorflow.keras.layers import LSTM, Dense
from sklearn.preprocessing import MinMaxScaler

def build_lstm_model(X_train):
    <span class="hljs-attr">model</span> = Sequential([
        LSTM(<span class="hljs-number">50</span>, return_sequences=<span class="hljs-literal">True</span>, input_shape=(X_train.shape[<span class="hljs-number">1</span>], <span class="hljs-number">1</span>)),
        LSTM(<span class="hljs-number">50</span>),
        Dense(<span class="hljs-number">1</span>, activation=<span class="hljs-string">'tanh'</span>)  <span class="hljs-comment"># 输出 -1 到 1，代表涨跌方向</span>
    ])
    model.compile(<span class="hljs-attr">optimizer</span>=<span class="hljs-string">'adam'</span>, loss=<span class="hljs-string">'mse'</span>)
    return model

<span class="hljs-comment"># 数据预处理（简化）</span>
<span class="hljs-attr">scaler</span> = MinMaxScaler()
<span class="hljs-attr">scaled_prices</span> = scaler.fit_transform(price_series.reshape(-<span class="hljs-number">1</span>, <span class="hljs-number">1</span>))

<span class="hljs-comment"># 构造 X, y：用过去60天预测第61天的收益率符号</span>
X, <span class="hljs-attr">y</span> = [], []
for i in range(60, len(scaled_prices)):
    X.append(scaled_prices<span class="hljs-section">[i-60:i, 0]</span>)
    <span class="hljs-attr">ret</span> = (price_series[i] - price_series[i-<span class="hljs-number">1</span>]) / price_series[i-<span class="hljs-number">1</span>]
    y.append(np.sign(ret))  <span class="hljs-comment"># +1 或 -1</span>

X, <span class="hljs-attr">y</span> = np.array(X), np.array(y)
<span class="hljs-attr">X</span> = np.reshape(X, (X.shape[<span class="hljs-number">0</span>], X.shape[<span class="hljs-number">1</span>], <span class="hljs-number">1</span>))

<span class="hljs-comment"># 训练</span>
<span class="hljs-attr">model</span> = build_lstm_model(X)
model.fit(X, y, <span class="hljs-attr">epochs</span>=<span class="hljs-number">10</span>, batch_size=<span class="hljs-number">32</span>, verbose=<span class="hljs-number">1</span>)
</code></pre>
<p>CQF 资料包强调：<strong>AI 不是魔法，而是特征工程 + 经济逻辑 + 严谨回测的结合体</strong>。课程提供完整的回测框架，避免“过拟合陷阱”。</p>
<hr/>
<h3 data-id="heading-4">五、为什么这套资料值 6 万元？</h3>
<p>《CQF 量化金融中文版（23 版）硬核资料包》并非简单翻译，而是由多位 CQF 持证人、对冲基金量化研究员联合打造，包含：</p>
<ul>
<li><strong>全六模块精讲笔记 + 中文推导手稿</strong>；</li>
<li><strong>200+ Jupyter Notebook 实战项目</strong>（含上述所有代码）；</li>
<li><strong>QuantLib、Pyfolio、Backtrader 高级用法指南</strong>；</li>
<li><strong>Final Project 选题库与评审标准</strong>（如加密货币波动率曲面建模、ESG 因子多空策略）；</li>
<li><strong>面试真题与简历优化建议</strong>（覆盖 Citadel、Two Sigma、国内顶级私募）。</li>
</ul>
<p>对于立志进入量化交易、风险管理或金融科技领域的你，这不仅是通关 CQF 的利器，更是踏入高薪行业的敲门砖。</p>
<hr/>
<h3 data-id="heading-5">结语</h3>
<p>量化金融的本质，是用数学描述市场，用代码验证逻辑，用纪律执行策略。CQF 教给你的不是“必胜公式”，而是一套<strong>严谨、可证伪、可迭代的科学方法论</strong>。而《23 版中文硬核资料包》，就是将这套方法论从英文文献、复杂公式转化为你指尖可运行、可调试、可盈利的生产力工具。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[ESM 模块（ECMAScript Module）详解]]></title>    <link>https://juejin.cn/post/7585463195200995378</link>    <guid>https://juejin.cn/post/7585463195200995378</guid>    <pubDate>2025-12-20T05:53:52.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585463195200995378" data-draft-id="7585463258690568201" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="ESM 模块（ECMAScript Module）详解"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-12-20T05:53:52.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="用户5427784851540"/> <meta itemprop="url" content="https://juejin.cn/user/224762173330942"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            ESM 模块（ECMAScript Module）详解
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/224762173330942/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    用户5427784851540
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-20T05:53:52.000Z" title="Sat Dec 20 2025 05:53:52 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>ECMAScript 模块（ECMAScript Modules，简称 ESM）是 JavaScript 语言官方标准化的模块系统，自 ECMAScript 2015（ES6）起正式引入，并在后续版本中不断完善。作为现代 Web 开发的基石，ESM 不仅解决了长期以来 JavaScript 缺乏原生模块化支持的问题，还为构建高性能、可维护的前端和后端应用提供了统一标准。</p>
<hr/>
<p> </p>
<h2 data-id="heading-0">一、JavaScript 模块化的历史演进</h2>
<p>在 ESM 出现之前，JavaScript 社区长期缺乏官方模块系统，开发者依赖各种“约定”或工具实现模块化：</p>
<ul>
<li><strong>全局变量模式</strong>：将功能挂载到全局对象（如 <code>window.MyLib</code>），极易造成命名冲突。</li>
<li><strong>IIFE（立即调用函数表达式）</strong> ：通过闭包实现私有作用域，但无法跨文件共享。</li>
<li><strong>CommonJS</strong>：Node.js 采用的同步 <code>require/module.exports</code> 模式，适合服务端，但无法直接用于浏览器。</li>
<li><strong>AMD（Asynchronous Module Definition）</strong> ：如 RequireJS，支持异步加载，但语法复杂。</li>
<li><strong>UMD（Universal Module Definition）</strong> ：兼容 CommonJS、AMD 和全局变量的混合方案。</li>
</ul>
<p>这些方案互不兼容，导致生态碎片化。开发者不得不依赖打包工具（如 Webpack、Browserify）将模块转换为目标环境可执行的代码。这种“编译时模块系统”虽解决了问题，但也带来了构建复杂度高、启动慢等弊端。</p>
<p>ESM 的出现，标志着 JavaScript 终于拥有了<strong>语言层面、运行时支持、跨平台统一</strong>的模块标准。</p>
<hr/>
<p> </p>
<h2 data-id="heading-1">二、ESM 的核心语法与特性</h2>
<p>ESM 采用声明式语法，强调<strong>静态结构</strong>和<strong>显式依赖</strong>。</p>
<h3 data-id="heading-2">1. 导出（Export）</h3>
<h4 data-id="heading-3">命名导出（Named Exports）</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// math.js</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">PI</span> = <span class="hljs-number">3.14159</span>;
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">a, b</span>) { <span class="hljs-keyword">return</span> a + b; }
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Calculator</span> { <span class="hljs-comment">/* ... */</span> }


<span class="hljs-comment">// 或批量导出</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">subtract</span> = (<span class="hljs-params">a, b</span>) =&gt; a - b;
<span class="hljs-keyword">const</span> <span class="hljs-title function_">multiply</span> = (<span class="hljs-params">a, b</span>) =&gt; a * b;
<span class="hljs-keyword">export</span> { subtract, multiply };
</code></pre>
<h4 data-id="heading-4">默认导出（Default Export）</h4>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-comment">// App.js</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">App</span> {
  <span class="hljs-comment">// 一个模块只能有一个 default export</span>
}
</code></pre>
<blockquote>
<p>✅ <strong>关键区别</strong>：命名导出可有多个，导入时需用相同名称（或重命名），默认导出无名称，导入时可任意命名</p>
</blockquote>
<h3 data-id="heading-5">2. 导入（Import）</h3>
<h4 data-id="heading-6">导入命名导出</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { <span class="hljs-variable constant_">PI</span>, add } <span class="hljs-keyword">from</span> <span class="hljs-string">'./math.js'</span>;
<span class="hljs-keyword">import</span> { subtract <span class="hljs-keyword">as</span> minus } <span class="hljs-keyword">from</span> <span class="hljs-string">'./math.js'</span>; <span class="hljs-comment">// 重命名</span>
<span class="hljs-keyword">import</span> * <span class="hljs-keyword">as</span> <span class="hljs-title class_">MathUtils</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'./math.js'</span>; <span class="hljs-comment">// 导入所有为命名空间对象</span>
</code></pre>
<h4 data-id="heading-7">导入默认导出</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> <span class="hljs-title class_">App</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'./App.js'</span>; <span class="hljs-comment">// 无需花括号</span>
</code></pre>
<h4 data-id="heading-8">混合导入</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> <span class="hljs-title class_">React</span>, { useState, useEffect } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;
</code></pre>
<h4 data-id="heading-9">副作用导入（仅执行模块，不导入绑定）</h4>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-keyword">import</span> <span class="hljs-string">'./polyfills.js'</span>; <span class="hljs-comment">// 初始化全局补丁</span>
</code></pre>
<h3 data-id="heading-10">3. 动态导入（Dynamic Import）</h3>
<p>ES2020 引入 <code>import()</code> 表达式，支持运行时按需加载：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 条件加载</span>
<span class="hljs-keyword">if</span> (user.<span class="hljs-property">isAdmin</span>) {
  <span class="hljs-keyword">const</span> adminModule = <span class="hljs-keyword">await</span> <span class="hljs-keyword">import</span>(<span class="hljs-string">'./admin.js'</span>);
  adminModule.<span class="hljs-title function_">init</span>();
}


<span class="hljs-comment">// 路由懒加载（React/Vue 中常见）</span>
<span class="hljs-keyword">const</span> <span class="hljs-title class_">HomePage</span> = <span class="hljs-title function_">lazy</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-keyword">import</span>(<span class="hljs-string">'./HomePage'</span>));
</code></pre>
<blockquote>
<p>⚠️ 注意：<code>import()</code> 返回 Promise，而静态 <code>import</code> 必须位于顶层作用域。</p>
</blockquote>
<hr/>
<p> </p>
<h2 data-id="heading-11">三、ESM 的核心特性与设计哲学</h2>
<h3 data-id="heading-12">1. 静态分析（Static Analyzability）</h3>
<p>ESM 的 <code>import</code>/<code>export</code> 语句<strong>必须是顶层的、字面量的</strong>，不能出现在条件语句或函数中：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// ❌ 非法</span>
<span class="hljs-keyword">if</span> (condition) {
  <span class="hljs-keyword">import</span> utils <span class="hljs-keyword">from</span> <span class="hljs-string">'./utils.js'</span>; <span class="hljs-comment">// SyntaxError</span>
}
</code></pre>
<p>这一限制使得引擎能在<strong>代码执行前</strong>解析整个依赖图，带来三大优势：</p>
<ul>
<li><strong>Tree Shaking</strong>：打包工具可精准移除未使用的导出（如 Rollup、Webpack）</li>
<li><strong>循环依赖检测</strong>：在编译阶段发现潜在问题</li>
<li><strong>性能优化</strong>：浏览器可并行预加载依赖</li>
</ul>
<h3 data-id="heading-13">2. 实时绑定（Live Bindings）</h3>
<p>ESM 导出的是<strong>绑定（binding）</strong> ，而非值的拷贝：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// counter.js</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">let</span> count = <span class="hljs-number">0</span>;
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">increment</span>(<span class="hljs-params"/>) { count++; }


<span class="hljs-comment">// main.js</span>
<span class="hljs-keyword">import</span> { count, increment } <span class="hljs-keyword">from</span> <span class="hljs-string">'./counter.js'</span>;
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(count); <span class="hljs-comment">// 0</span>
<span class="hljs-title function_">increment</span>();
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(count); <span class="hljs-comment">// 1 —— 自动同步！</span>
</code></pre>
<p>这与 CommonJS 的“值拷贝”形成鲜明对比，避免了状态不一致问题。</p>
<h3 data-id="heading-14">3. 单例语义（Singleton Semantics）</h3>
<p>每个模块在单个运行时环境中<strong>只执行一次</strong>，后续导入返回同一实例：</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-comment">// config.js</span>
console.<span class="hljs-built_in">log</span>(<span class="hljs-string">'Config loaded!'</span>);
<span class="hljs-keyword">export</span> <span class="hljs-type">const</span> settings = { theme: <span class="hljs-string">'dark'</span> };


<span class="hljs-comment">// a.js 和 b.js 都 import config.js</span>
<span class="hljs-comment">// "Config loaded!" 仅打印一次</span>
</code></pre>
<p>这保证了模块状态的全局唯一性，适用于配置、缓存等场景。</p>
<hr/>
<p> </p>
<h2 data-id="heading-15">四、ESM 在浏览器中的运行机制</h2>
<h3 data-id="heading-16">1. 启用方式</h3>
<p>在 HTML 中通过 <code>&lt;script type="module"&gt;</code> 启用：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"module"</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"./main.js"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
<span class="hljs-comment">&lt;!-- 或内联 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"module"</span>&gt;</span><span class="javascript">
  <span class="hljs-keyword">import</span> { greet } <span class="hljs-keyword">from</span> <span class="hljs-string">'./utils.js'</span>;
  <span class="hljs-title function_">greet</span>();
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
<blockquote>
</blockquote>
<blockquote>
<p>🔒 <strong>安全限制</strong>：</p>
</blockquote>
<blockquote>
</blockquote>
<blockquote>
<p>模块脚本默认启用 <strong>CORS</strong>，跨域需服务器设置 <code>Access-Control-Allow-Origin</code></p>
</blockquote>
<blockquote>
<p>无法在 <code>file://</code> 协议下运行（需本地服务器）</p>
</blockquote>
<blockquote>
</blockquote>
<h3 data-id="heading-17">2. 加载与执行流程</h3>
<p>当浏览器遇到模块脚本时：</p>
<ol>
<li><strong>解析依赖</strong>：递归解析所有 <code>import</code> 语句，构建依赖图</li>
<li><strong>并行下载</strong>：通过 HTTP/2 多路复用并行请求所有模块</li>
<li><strong>拓扑排序</strong>：按依赖顺序确定执行顺序（无依赖的先执行）</li>
<li><strong>执行模块</strong>：每个模块仅执行一次，导出绑定供其他模块使用</li>
</ol>
<blockquote>
</blockquote>
<blockquote>
<p>💡 <strong>性能优势</strong>： 无需打包即可按需加载，浏览器缓存粒度更细（单个模块级别）</p>
</blockquote>
<h3 data-id="heading-18">3. MIME 类型要求</h3>
<p>服务器必须为 <code>.js</code> 文件返回正确的 MIME 类型：</p>
<pre><code class="hljs language-bash" lang="bash">Content-Type: application/javascript
</code></pre>
<p>否则浏览器会拒绝执行。</p>
<hr/>
<p> </p>
<h2 data-id="heading-19">五、ESM 在 Node.js 中的支持</h2>
<p>Node.js 自 v12 起原生支持 ESM，但需注意与 CommonJS 的互操作性。</p>
<h3 data-id="heading-20">1. 启用方式</h3>
<ul>
<li>文件扩展名 <code>.mjs</code></li>
<li>或在 <code>package.json</code> 中设置 <code>"type": "module"</code></li>
<li>或使用 <code>--input-type=module</code> 标志运行字符串代码</li>
</ul>
<h3 data-id="heading-21">2. 与 CommonJS 互操作</h3>
<h4 data-id="heading-22">ESM 导入 CommonJS</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// CommonJS 模块导出的是 module.exports 对象</span>
<span class="hljs-keyword">import</span> pkg <span class="hljs-keyword">from</span> <span class="hljs-string">'lodash'</span>; <span class="hljs-comment">// 默认导入整个对象</span>
<span class="hljs-keyword">import</span> { debounce } <span class="hljs-keyword">from</span> <span class="hljs-string">'lodash'</span>; <span class="hljs-comment">// 命名导入（需支持）</span>
</code></pre>
<blockquote>
<p>⚠️ 限制：CommonJS 模块的动态属性无法被静态分析，命名导入可能失败。</p>
</blockquote>
<h4 data-id="heading-23">CommonJS 导入 ESM（Node.js v14.13+）</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 使用 async/await</span>
<span class="hljs-keyword">const</span> myModule = <span class="hljs-keyword">await</span> <span class="hljs-keyword">import</span>(<span class="hljs-string">'./my-esm-module.js'</span>);
</code></pre>
<h3 data-id="heading-24">3. 路径解析差异</h3>
<p>ESM <strong>必须使用完整路径</strong>（包括扩展名）：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// ✅ 正确</span>
<span class="hljs-keyword">import</span> { foo } <span class="hljs-keyword">from</span> <span class="hljs-string">'./foo.js'</span>;
<span class="hljs-keyword">import</span> { bar } <span class="hljs-keyword">from</span> <span class="hljs-string">'./bar/index.js'</span>;


<span class="hljs-comment">// ❌ 错误（Node.js 不自动补全 .js）</span>
<span class="hljs-keyword">import</span> { foo } <span class="hljs-keyword">from</span> <span class="hljs-string">'./foo'</span>;
</code></pre>
<blockquote>
<p>🛠 解决方案：使用 <code>--experimental-specifier-resolution=node</code> 或构建工具处理。</p>
</blockquote>
<hr/>
<p> </p>
<h2 data-id="heading-25">六、ESM vs CommonJS：关键差异对比</h2>








































<table><thead><tr><th>特性</th><th>ESM</th><th>CommonJS</th></tr></thead><tbody><tr><td><strong>加载时机</strong></td><td>异步（浏览器并行加载）</td><td>同步（Node.js 逐行执行）</td></tr><tr><td><strong>导出本质</strong></td><td>实时绑定（Live Binding）</td><td>值拷贝（Copy of Value）</td></tr><tr><td><strong>this 指向</strong></td><td>undefined</td><td>module.exports</td></tr><tr><td><strong>循环依赖</strong></td><td>支持（绑定未初始化时为 undefined）</td><td>支持（返回部分初始化对象）</td></tr><tr><td><strong>Tree Shaking</strong></td><td>原生支持</td><td>需工具模拟</td></tr><tr><td><strong>顶层 await</strong></td><td>支持（ES2022）</td><td>不支持（需 IIFE 包裹）</td></tr></tbody></table>
<hr/>
<p> </p>
<h2 data-id="heading-26">七、ESM 的实际应用场景</h2>
<h3 data-id="heading-27">1. 前端开发：Vite、Snowpack 等现代构建工具</h3>
<p>Vite 利用浏览器原生 ESM，实现<strong>无打包开发</strong>：</p>
<ul>
<li>开发阶段直接 serve 源码</li>
<li>依赖预构建为 ESM</li>
<li>HMR 基于模块图精准更新</li>
</ul>
<h3 data-id="heading-28">2. 微前端架构</h3>
<p>通过动态 <code>import()</code> 实现子应用按需加载：</p>
<pre><code class="hljs language-ini" lang="ini">const <span class="hljs-attr">loadMicroApp</span> = async (name) =&gt; {
  const <span class="hljs-attr">app</span> = await import(`https://cdn.com/<span class="hljs-variable">${name}</span>/entry.js`)<span class="hljs-comment">;</span>
  app.bootstrap()<span class="hljs-comment">;</span>
}<span class="hljs-comment">;</span>
</code></pre>
<h3 data-id="heading-29">3. CDN 直接分发</h3>
<p>现代 CDN（如 Skypack、esm.sh）将 npm 包自动转换为 ESM：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> <span class="hljs-title class_">React</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'https://esm.sh/react'</span>;
<span class="hljs-keyword">import</span> { createRoot } <span class="hljs-keyword">from</span> <span class="hljs-string">'https://esm.sh/react-dom/client'</span>;
</code></pre>
<h3 data-id="heading-30">4. Web Workers 与 Service Workers</h3>
<p>Workers 支持 ESM 模块：</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-comment">// 主线程</span>
<span class="hljs-keyword">const</span> worker = <span class="hljs-built_in">new</span> Worker(<span class="hljs-string">'./worker.js'</span>, { <span class="hljs-keyword">type</span>: <span class="hljs-string">'module'</span> });


<span class="hljs-comment">// worker.js</span>
<span class="hljs-keyword">import</span> { heavyTask } from <span class="hljs-string">'./utils.js'</span>;
</code></pre>
<hr/>
<p> </p>
<h2 data-id="heading-31">八、未来展望</h2>
<p>ESM 生态仍在快速发展：</p>
<p><strong>Import Maps</strong>：允许在 HTML 中定义模块标识符映射，解决裸模块（bare specifiers）问题</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"importmap"</span>&gt;</span><span class="javascript">
{
  <span class="hljs-string">"imports"</span>: {
    <span class="hljs-string">"lodash"</span>: <span class="hljs-string">"/node_modules/lodash-es/lodash.js"</span>
  }
}
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
<ul>
<li/>
<li><strong>Top-Level Await</strong>：已在 ES2022 标准化，简化异步模块初始化</li>
<li><strong>JSON Modules</strong>：提案阶段，允许直接 <code>import data from './config.json'</code></li>
</ul>
<hr/>
<p> </p>
<h2 data-id="heading-32">结语</h2>
<p>ECMAScript 模块不仅是 JavaScript 语言的一次重要进化，更是现代 Web 开发生态的基础设施。它通过静态分析、实时绑定、单例语义等设计，为构建高性能、可维护的应用提供了坚实基础。随着浏览器和 Node.js 的全面支持，以及 Vite 等工具的普及，ESM 正逐步取代历史遗留的模块方案，成为事实上的标准。</p>
<p>对于开发者而言，深入理解 ESM 的工作机制，不仅能写出更高效的代码，更能充分利用现代工具链的优势，在工程化实践中游刃有余。正如 TC39 委员会所倡导的：“ESM is the future of JavaScript modularity.” —— 拥抱 ESM，就是拥抱 JavaScript 的未来。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Nginx 为什么能进行静态资源托管]]></title>    <link>https://juejin.cn/post/7585706951583186953</link>    <guid>https://juejin.cn/post/7585706951583186953</guid>    <pubDate>2025-12-20T05:59:37.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585706951583186953" data-draft-id="7585706951583170569" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Nginx 为什么能进行静态资源托管"/> <meta itemprop="keywords" content="Nginx"/> <meta itemprop="datePublished" content="2025-12-20T05:59:37.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="用户5427784851540"/> <meta itemprop="url" content="https://juejin.cn/user/224762173330942"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Nginx 为什么能进行静态资源托管
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/224762173330942/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    用户5427784851540
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-20T05:59:37.000Z" title="Sat Dec 20 2025 05:59:37 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    7
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>Nginx 本质是一个<strong>高性能的 HTTP 服务器</strong>，其核心能力之一就是直接读取服务器本地文件并通过 HTTP 协议返回给客户端。具体来说，它通过以下机制实现静态资源托管：</p>
<h4 data-id="heading-0">1. <strong>事件驱动架构（非阻塞 I/O）</strong></h4>
<p>Nginx 采用 <strong>epoll/kqueue</strong> 等 I/O 多路复用技术，能在单个进程内高效处理<strong>数万并发连接</strong>，而不会为每个连接创建新进程/线程（避免资源开销）。</p>
<ul>
<li><strong>对比 Apache</strong>：传统 Apache 采用多进程/多线程模型，并发量高时会因进程切换导致性能下降。</li>
<li><strong>优势</strong>：处理静态资源时，Nginx 能以极小的内存占用和 CPU 消耗支持高并发请求。</li>
</ul>
<h4 data-id="heading-1">2. <strong>文件系统直接读取</strong></h4>
<p>Nginx 可直接操作服务器文件系统，通过配置 <code>root</code> 或 <code>alias</code> 指令指定静态资源目录，例如：</p>
<pre><code class="hljs language-bash" lang="bash">server {
  root /usr/local/frontend/dist; <span class="hljs-comment"># 静态资源根目录</span>
  location /images/ {
    <span class="hljs-built_in">alias</span> /data/pictures/; <span class="hljs-comment"># 别名目录（与 root 区别：会替换 URL 中的 /images/）</span>
  }
}
</code></pre>
<p>当客户端请求 <code>http://example.com/index.html</code> 时，Nginx 会直接读取 <code>/usr/local/frontend/dist/index.html</code> 并返回。</p>
<h4 data-id="heading-2">3. <strong>HTTP 协议实现</strong></h4>
<p>Nginx 内置完整的 HTTP 协议解析器，能正确处理：</p>
<ul>
<li>请求方法（GET/HEAD 等，静态资源常用 GET）</li>
<li>请求头（如 <code>Range</code> 断点续传）</li>
<li>响应头（如 <code>Content-Type</code>、<code>Cache-Control</code>）</li>
<li>状态码（200/404/304 等）</li>
</ul>
<p>例如，请求图片时自动返回 <code>Content-Type: image/png</code>，浏览器据此正确渲染资源。</p>
<p> </p>
<h3 data-id="heading-3">⚡ 静态资源托管的核心配置指令</h3>
<p>Nginx 通过以下关键指令控制静态资源的读取和响应行为：</p>
<h4 data-id="heading-4">1. <code>root</code> <strong>：指定资源根目录</strong></h4>
<pre><code class="hljs language-arduino" lang="arduino">location /<span class="hljs-type">static</span>/ {
  root /usr/share/nginx/; 
  # 请求 /<span class="hljs-type">static</span>/logo.png → 实际读取 /usr/share/nginx/<span class="hljs-type">static</span>/logo.png
}
</code></pre>
<h4 data-id="heading-5">2. <code>alias</code> <strong>：替换 URL 路径（与</strong> <code>root</code> <strong>区别）</strong></h4>
<pre><code class="hljs language-bash" lang="bash">location /static/ {
  <span class="hljs-built_in">alias</span> /usr/share/nginx/files/; 
  <span class="hljs-comment"># 请求 /static/logo.png → 实际读取 /usr/share/nginx/files/logo.png（注意 alias 路径末尾的 /）</span>
}
</code></pre>
<h4 data-id="heading-6">3. <code>index</code> <strong>：默认主页文件</strong></h4>
<pre><code class="hljs language-ini" lang="ini">server {
  index index.html index.htm<span class="hljs-comment">; </span>
  <span class="hljs-comment"># 请求 / → 自动返回 /index.html（按顺序查找）</span>
}
</code></pre>
<h4 data-id="heading-7">4. <code>try_files</code> <strong>：按顺序尝试读取文件</strong></h4>
<p>解决 SPA（单页应用）路由刷新 404 问题：</p>
<pre><code class="hljs language-bash" lang="bash">location / {
  try_files <span class="hljs-variable">$uri</span> <span class="hljs-variable">$uri</span>/ /index.html; 
  <span class="hljs-comment"># 尝试读取请求的文件 → 目录 → 最后返回 index.html</span>
}
</code></pre>
<h5 data-id="heading-8">🧩 <code>try_files $uri $uri/ /index.html;</code> 的核心作用</h5>
<p><strong>一句话概括</strong>：当用户访问一个路径时，Nginx 会按顺序尝试查找文件或目录，找不到就兜底返回 <code>index.html</code>（前端 SPA 的入口文件）。</p>
<h6 data-id="heading-9">适用场景：</h6>
<p>单页应用（如 Vue/React/Angular），这类应用的路由由前端 JavaScript 控制（如 <code>vue-router</code> 的 <code>history</code> 模式），而非传统的后端路由。</p>
<h5 data-id="heading-10">🔍 逐段解析：三个参数的含义</h5>
<h6 data-id="heading-11">a. <code>$uri</code> <strong>：尝试访问请求的文件</strong></h6>
<ul>
<li><code>$uri</code> 是 Nginx 的内置变量，表示当前请求的 <strong>文件路径</strong>（不包含查询参数）。</li>
<li>例如：<br/>
用户请求 <code>http://example.com/about</code> → <code>$uri</code> 是 <code>/about</code><br/>
Nginx 会先检查服务器上是否存在 <code>/usr/local/frontend/dist/about</code> <strong>文件</strong>（假设 <code>root</code> 指向 <code>dist</code> 目录）。</li>
</ul>
<h6 data-id="heading-12">b. <code>$uri/</code> <strong>：尝试访问请求的目录</strong></h6>
<ul>
<li>如果 <code>$uri</code> 对应的文件不存在，Nginx 会尝试将其作为 <strong>目录</strong> 访问（添加 <code>/</code>）。</li>
<li>例如：<br/>
请求 <code>http://example.com/about</code> → 检查 <code>/usr/local/frontend/dist/about/</code> 目录是否存在，以及该目录下是否有 <code>index.html</code>（由 <code>index</code> 指令配置，如 <code>index index.html</code>）。</li>
</ul>
<h6 data-id="heading-13">c. <code>/index.html</code> <strong>：兜底返回前端入口文件</strong></h6>
<ul>
<li>如果前两个尝试都失败（文件和目录都不存在），Nginx 会直接返回 <code>root</code> 目录下的 <code>index.html</code>（即前端 SPA 的入口文件）。</li>
<li>此时，前端路由（如 <code>vue-router</code>）会根据 URL 中的路径（如 <code>/about</code>）渲染对应的页面组件，从而避免 404 错误。</li>
</ul>
<h6 data-id="heading-14">d. <code>history</code> <strong>模式 vs</strong> <code>hash</code> <strong>模式</strong></h6>
<ul>
<li><code>hash</code> <strong>模式</strong>（如 <code>http://example.com/#/about</code> ）：哈希部分（<code>#/about</code>）不会发送到服务器，因此无需 <code>try_files</code> 也能正常刷新。</li>
<li><code>history</code> <strong>模式</strong>（如 <code>http://example.com/about</code> ）：URL 路径会发送到服务器，必须配置 <code>try_files</code> 才能避免 404。</li>
<li><strong>推荐</strong>：<code>history</code> 模式（URL 更美观）+ <code>try_files</code> 配置。</li>
</ul>
<h5 data-id="heading-15">📝 为什么需要这行配置？</h5>
<p>单页应用的路由是“前端接管”的，所有页面实际上都通过 <code>index.html</code> 加载，再由 JavaScript 根据 URL 动态渲染内容。</p>
<h5 data-id="heading-16"><code>try_files $uri $uri/ /index.html;</code> 的作用就是告诉 Nginx：“如果用户访问的路径不是真实存在的文件/目录，就把处理权交还给前端路由（通过返回 <code>index.html</code>）”。</h5>
<h4 data-id="heading-17">5. <code>expires</code> <strong>与</strong> <code>Cache-Control</code> <strong>：缓存控制</strong></h4>
<pre><code class="hljs language-ruby" lang="ruby">nginx
复制
location ~* .(js|<span class="hljs-params">css</span>|png)<span class="hljs-variable">$ </span>{
  expires 30d; <span class="hljs-comment"># 浏览器缓存 30 天</span>
  add_header <span class="hljs-title class_">Cache</span>-<span class="hljs-title class_">Control</span> <span class="hljs-string">"public, max-age=2592000, immutable"</span>;
}
</code></pre>
<p> </p>
<h3 data-id="heading-18">🚀 Nginx 静态资源托管的性能优化手段</h3>
<p>除了基础能力，Nginx 还提供多种优化策略，让静态资源加载更快：</p>
<h4 data-id="heading-19">1. <strong>启用</strong> <code>gzip</code> <strong>压缩</strong></h4>
<p>压缩 JS/CSS/HTML 等文本资源，减少传输体积：</p>
<pre><code class="hljs language-bash" lang="bash">nginx
复制
gzip on;
gzip_types text/css application/javascript text/html;
gzip_comp_level 5; <span class="hljs-comment"># 压缩等级（1-9，越高压缩率越好但耗 CPU）</span>
</code></pre>
<h4 data-id="heading-20">2. <code>sendfile</code> <strong>零拷贝技术</strong></h4>
<p>跳过用户态与内核态的数据拷贝，直接从磁盘读取文件发送到网络：</p>
<pre><code class="hljs language-csharp" lang="csharp">nginx
复制
sendfile <span class="hljs-keyword">on</span>; <span class="hljs-meta"># 启用零拷贝</span>
tcp_nopush <span class="hljs-keyword">on</span>; <span class="hljs-meta"># 配合 sendfile 使用，减少网络包数量</span>
</code></pre>
<h4 data-id="heading-21">3. <code>open_file_cache</code> <strong>缓存文件元信息</strong></h4>
<p>缓存文件的 inode、大小、修改时间等信息，避免重复 stat 系统调用：</p>
<pre><code class="hljs language-ini" lang="ini">nginx
复制
open_file_cache <span class="hljs-attr">max</span>=<span class="hljs-number">1000</span> inactive=<span class="hljs-number">20</span>s<span class="hljs-comment">;</span>
open_file_cache_valid 30s<span class="hljs-comment">;</span>
open_file_cache_min_uses 2<span class="hljs-comment">;</span>
</code></pre>
<h4 data-id="heading-22">4. <strong>限制请求速率（防滥用）</strong></h4>
<pre><code class="hljs language-ini" lang="ini">nginx
复制
limit_rate 100k<span class="hljs-comment">; # 单连接限速 100KB/s</span>
limit_conn_zone $binary_remote_addr <span class="hljs-attr">zone</span>=addr:<span class="hljs-number">10</span>m<span class="hljs-comment">;</span>
limit_conn addr 10<span class="hljs-comment">; # 单 IP 最多 10 个并发连接</span>
</code></pre>
<p> </p>
<h3 data-id="heading-23">📚 为什么不直接用浏览器打开 <code>dist</code> 目录的 HTML 文件？</h3>
<p>虽然 <code>dist</code> 目录包含静态文件，但直接通过 <code>file:///path/to/dist/index.html</code> 打开会有问题：</p>
<ol>
<li><strong>跨域限制</strong>：浏览器禁止 <code>file://</code> 协议下的 AJAX 请求（安全策略）。</li>
<li><strong>路径错误</strong>：相对路径（如 <code>./js/app.js</code>）会被解析为 <code>file://</code> 协议，而非服务器 URL。</li>
<li><strong>路由失效</strong>：SPA 路由（如 <code>/about</code>）会被浏览器视为本地文件路径，导致 404。</li>
</ol>
<p>而 Nginx 提供了标准的 <code>http://</code> 协议环境，完美解决以上问题。</p>
<hr/>
<p> </p>
<h3 data-id="heading-24">📝 总结：Nginx 静态资源托管的核心优势</h3>

























<table><thead><tr><th>优势</th><th>具体说明</th></tr></thead><tbody><tr><td><strong>高性能</strong></td><td>事件驱动架构 + 零拷贝技术，支持高并发低延迟</td></tr><tr><td><strong>配置灵活</strong></td><td>root/alias/try_files 等指令适配各种场景</td></tr><tr><td><strong>功能丰富</strong></td><td>内置缓存、压缩、限速、SSL 等能力</td></tr><tr><td><strong>轻量稳定</strong></td><td>内存占用低，故障率极低，7x24 小时运行无压力</td></tr></tbody></table>
<p>简单说，Nginx 就像一个<strong>高效的"文件快递员"</strong> ：既能快速找到服务器上的静态文件，又能通过各种优化手段把文件"快递"到用户浏览器，还能顺便处理缓存、压缩等"增值服务"。这也是它成为静态资源托管首选工具的根本原因！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[在Android开发中阅读源码的指导思路]]></title>    <link>https://juejin.cn/post/7585382553290506276</link>    <guid>https://juejin.cn/post/7585382553290506276</guid>    <pubDate>2025-12-20T06:12:17.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585382553290506276" data-draft-id="7585412203978276907" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="在Android开发中阅读源码的指导思路"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-12-20T06:12:17.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Poorguy9527"/> <meta itemprop="url" content="https://juejin.cn/user/1746465251931063"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            在Android开发中阅读源码的指导思路
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1746465251931063/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Poorguy9527
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-20T06:12:17.000Z" title="Sat Dec 20 2025 06:12:17 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>阅读源码是研究技术底层实现逻辑的必由之路
，也是开发者成长路上必备的一课</p>
</blockquote>
<p>阅读Android源码（尤其是像Kotlin协程这样的复杂框架）需要有系统的方法和清晰的思路。以下是高效阅读源码的指导思路，并以Kotlin协程为例说明具体实施步骤：</p>
<h2 data-id="heading-0">📚 <strong>一、通用源码阅读方法论</strong></h2>
<h3 data-id="heading-1">1. <strong>明确阅读目标</strong></h3>
<pre><code class="hljs language-text" lang="text">初级：理解基本用法和工作原理
中级：掌握内部机制和设计思想
高级：能修改扩展或解决深层次问题
</code></pre>
<h3 data-id="heading-2">2. <strong>分层渐进策略</strong></h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 推荐阅读顺序</span>
<span class="hljs-number">1.</span> 官方文档和示例
<span class="hljs-number">2.</span> 关键API使用
<span class="hljs-number">3.</span> 架构概览
<span class="hljs-number">4.</span> 核心流程跟踪
<span class="hljs-number">5.</span> 深入细节实现
</code></pre>
<h2 data-id="heading-3">🔍 <strong>二、具体到Kotlin协程源码</strong></h2>
<h3 data-id="heading-4"><strong>第一步：准备工作</strong></h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 1. 搭建调试环境</span>
dependencies {
    implementation(<span class="hljs-string">"org.jetbrains.kotlinx:kotlinx-coroutines-core:1.7.3"</span>)
    implementation(<span class="hljs-string">"org.jetbrains.kotlinx:kotlinx-coroutines-debug:1.7.3"</span>)
}

<span class="hljs-comment">// 2. 使用协程调试工具</span>
CoroutineScope(Dispatchers.Default + CoroutineName(<span class="hljs-string">"test"</span>)).launch {
    debugCoroutine()  <span class="hljs-comment">// 自定义调试函数</span>
}
</code></pre>
<h3 data-id="heading-5"><strong>第二步：由浅入深四层阅读法</strong></h3>
<h4 data-id="heading-6"><strong>第1层：入口和核心接口</strong></h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 先看这几个核心接口/类</span>
<span class="hljs-number">1.</span> CoroutineScope - 协程作用域
<span class="hljs-number">2.</span> CoroutineContext - 协程上下文
<span class="hljs-number">3.</span> Continuation - 续体（核心抽象）
<span class="hljs-number">4.</span> CoroutineDispatcher - 调度器
<span class="hljs-number">5.</span> Job/Deferred - 协程任务

<span class="hljs-comment">// 阅读路径建议：</span>
kotlinx.coroutines/
├── CoroutineScope.kt
├── CoroutineContext.kt
├── Continuation.kt
└── AbstractCoroutine.kt
</code></pre>
<h4 data-id="heading-7"><strong>第2层：启动流程分析</strong></h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 跟踪 launch/async 执行流程</span>
launch { 
    <span class="hljs-comment">// 代码块</span>
}

<span class="hljs-comment">// 阅读顺序：</span>
<span class="hljs-number">1.</span> CoroutineScope.launch() 扩展函数
<span class="hljs-number">2.</span> StandaloneCoroutine / LazyStandaloneCoroutine
<span class="hljs-number">3.</span> start() -&gt; resumeWith()
<span class="hljs-number">4.</span> 调度器分配逻辑
</code></pre>
<h4 data-id="heading-8"><strong>第3层：调度器实现</strong></h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 重点阅读：</span>
<span class="hljs-number">1.</span> Dispatchers.Main/Default/IO/Unconfined
<span class="hljs-number">2.</span> CoroutineScheduler.kt (线程池核心)
<span class="hljs-number">3.</span> 任务窃取算法

<span class="hljs-comment">// 调试技巧：切换调度器观察线程变化</span>
withContext(Dispatchers.IO) {
    println(<span class="hljs-string">"Thread: <span class="hljs-subst">${Thread.currentThread().name}</span>"</span>)
}
</code></pre>
<h4 data-id="heading-9"><strong>第4层：挂起机制</strong></h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 深入理解 suspend 原理</span>
<span class="hljs-number">1.</span> suspendCoroutine{} / suspendCancellableCoroutine{}
<span class="hljs-number">2.</span> ContinuationImpl
<span class="hljs-number">3.</span> BaseContinuationImpl.resumeWith()
<span class="hljs-number">4.</span> SafeContinuator

<span class="hljs-comment">// 关键文件：</span>
kotlinx.coroutines.intrinsics/
├── Cancellable.kt
└── ContinuationImpl.kt
</code></pre>
<h3 data-id="heading-10"><strong>第三步：实用调试技巧</strong></h3>
<h4 data-id="heading-11"><strong>1. 使用协程调试模式</strong></h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 启动时添加VM参数</span>
-Dkotlinx.coroutines.debug=on

<span class="hljs-comment">// 输出包含协程名的堆栈</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> = runBlocking {
    launch(CoroutineName(<span class="hljs-string">"my-coroutine"</span>)) {
        println(<span class="hljs-string">"Running in <span class="hljs-subst">${coroutineContext[CoroutineName]}</span>"</span>)
    }
}
</code></pre>
<h4 data-id="heading-12"><strong>2. 关键断点设置</strong></h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 建议断点位置：</span>
1. AbstractCoroutine.resumeWith()  <span class="hljs-comment"># 协程恢复点</span>
2. CoroutineScheduler.dispatch()   <span class="hljs-comment"># 任务调度点</span>
3. ContinuationImpl.invokeSuspend() <span class="hljs-comment"># 挂起函数执行点</span>
4. JobSupport.cancel()            <span class="hljs-comment"># 取消逻辑</span>
</code></pre>
<h4 data-id="heading-13"><strong>3. 时序图绘制工具</strong></h4>
<pre><code class="hljs language-mermaid" lang="mermaid">sequenceDiagram
launch -&gt; CoroutineScope: 创建协程
CoroutineScope -&gt; CoroutineScheduler: 提交任务
CoroutineScheduler -&gt; Worker: 分配线程
Worker -&gt; Continuation: 执行续体
Continuation -&gt; suspend: 遇到挂起点
suspend -&gt; dispatch: 释放线程

</code></pre>
<h2 data-id="heading-14">🛠️ <strong>三、高效工具链</strong></h2>
<h3 data-id="heading-15"><strong>1. IDE配置</strong></h3>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">Android Studio / IntelliJ IDEA:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-string">安装</span> <span class="hljs-string">"Kotlin"</span> <span class="hljs-string">插件</span>
  <span class="hljs-bullet">-</span> <span class="hljs-string">启用</span> <span class="hljs-string">"Kotlin协程调试器"</span>
  <span class="hljs-bullet">-</span> <span class="hljs-string">配置源码跳转:</span> <span class="hljs-string">Ctrl+Click</span> <span class="hljs-string">-&gt;</span> <span class="hljs-string">Download</span> <span class="hljs-string">Sources</span>
  <span class="hljs-bullet">-</span> <span class="hljs-string">使用</span> <span class="hljs-string">"Structure"</span> <span class="hljs-string">视图查看类层次</span>
</code></pre>
<h3 data-id="heading-16"><strong>2. 命令行工具</strong></h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 生成依赖图</span>
./gradlew :app:dependencies

<span class="hljs-comment"># 反编译查看字节码</span>
javap -c MyCoroutine.class

<span class="hljs-comment"># 使用Kotlin编译器插件</span>
kotlinc -Xcoroutines=<span class="hljs-built_in">enable</span>
</code></pre>
<h3 data-id="heading-17"><strong>3. 可视化工具</strong></h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 协程堆栈分析</span>
<span class="hljs-keyword">val</span> stackTrace = Thread.currentThread().stackTrace
stackTrace.forEach { 
    <span class="hljs-keyword">if</span> (it.className.contains(<span class="hljs-string">"coroutine"</span>)) {
        println(<span class="hljs-string">"Coroutine related: <span class="hljs-variable">$it</span>"</span>)
    }
}
</code></pre>
<h2 data-id="heading-18">📝 <strong>四、具体实践：分析一个挂起函数</strong></h2>
<h3 data-id="heading-19"><strong>案例：delay() 实现</strong></h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 阅读路径：</span>
<span class="hljs-number">1.</span> kotlinx.coroutines.Delay.kt
<span class="hljs-number">2.</span> kotlinx.coroutines.Delay.delay()
<span class="hljs-number">3.</span> kotlinx.coroutines.EventLoopImplBase.delayNanos()
<span class="hljs-number">4.</span> kotlinx.coroutines.DelayQueue

<span class="hljs-comment">// 关键理解点：</span>
- 如何实现非阻塞延迟
- 与Handler/Looper的集成
- 取消机制的实现
</code></pre>
<h2 data-id="heading-20">🔧 <strong>五、问题导向阅读法</strong></h2>
<p>当遇到问题时，按这个流程：</p>
<pre><code class="hljs language-mermaid" lang="mermaid">graph LR
A[实际问题] --&gt; B[定位相关类]
B --&gt; C{是否需要深入?}
C --&gt;|是| D[阅读核心方法]
C --&gt;|否| E[查看API文档]
D --&gt; F[绘制调用关系]
F --&gt; G[验证猜想]
</code></pre>
<h2 data-id="heading-21">💡 <strong>六、学习建议</strong></h2>
<ol>
<li><strong>先会用再读源码</strong> - 熟练掌握API后再深入</li>
<li><strong>带着问题读</strong> - 每次解决一个具体疑问</li>
<li><strong>做笔记画图</strong> - 用图表记录核心流程</li>
<li><strong>写测试验证</strong> - 通过单元测试理解行为</li>
<li><strong>参与社区</strong> - 关注Kotlin协程的GitHub Issues</li>
</ol>
<h2 data-id="heading-22">📚 <strong>七、推荐阅读材料</strong></h2>
<pre><code class="hljs language-text" lang="text">官方文档:
- Kotlin协程指南: https://kotlinlang.org/docs/coroutines-guide.html
- 设计文档: https://github.com/Kotlin/kotlinx.coroutines/blob/master/docs/topics/coroutines-design.md

源码位置:
- GitHub: kotlinx.coroutines
- 包结构: kotlinx.coroutines.*
</code></pre>
<p>记住：<strong>不要试图一次性理解所有代码</strong>。协程源码有2万+行，应该分模块、分层次逐步深入。建议先从 <code>kotlinx.coroutines.core</code> 开始，理解基本模型后再看 <code>kotlinx.coroutines.android</code> 等平台特定实现。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[支付成功订单却没了？MyBatis连接池的坑我踩了]]></title>    <link>https://juejin.cn/post/7585446706327126025</link>    <guid>https://juejin.cn/post/7585446706327126025</guid>    <pubDate>2025-12-20T06:25:35.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585446706327126025" data-draft-id="7585463258690650121" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="支付成功订单却没了？MyBatis连接池的坑我踩了"/> <meta itemprop="keywords" content="后端,面试,Java"/> <meta itemprop="datePublished" content="2025-12-20T06:25:35.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="9号达人"/> <meta itemprop="url" content="https://juejin.cn/user/2450136052270077"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            支付成功订单却没了？MyBatis连接池的坑我踩了
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2450136052270077/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    9号达人
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-20T06:25:35.000Z" title="Sat Dec 20 2025 06:25:35 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#595959;font-size:15px;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(60,10,30,.04) 3%,transparent 0),linear-gradient(1turn,rgba(60,10,30,.04) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body p{color:#595959;font-size:15px;line-height:2;font-weight:400}.markdown-body p+p{margin-top:16px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin:0;color:#135ce0}.markdown-body h1{position:relative;text-align:center;font-size:22px;margin:50px 0}.markdown-body h1:before{position:absolute;content:"";top:-10px;left:50%;width:32px;height:32px;transform:translateX(-50%);background-size:100% 100%;opacity:.36;background-repeat:no-repeat;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC)}.markdown-body h2{position:relative;font-size:20px;border-left:4px solid;padding:0 0 0 10px;margin:30px 0}.markdown-body h3{font-size:16px}.markdown-body ul{list-style:disc outside;margin-left:2em;margin-top:1em}.markdown-body li{line-height:2;color:#595959}.markdown-body img.loaded{margin:0 auto;display:block}.markdown-body blockquote{background:#fff9f9;margin:2em 0;padding:2px 20px;border-left:4px solid #b2aec5}.markdown-body blockquote p{color:#666;line-height:2}.markdown-body a{color:#036aca;border-bottom:1px solid rgba(3,106,202,.8);font-weight:400;text-decoration:none}.markdown-body em strong,.markdown-body strong{color:#036aca}.markdown-body hr{border-top:1px solid #135ce0}.markdown-body pre{overflow:auto}.markdown-body code,.markdown-body pre{overflow:auto;position:relative;line-height:1.75;font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body table{border-collapse:collapse;margin:1rem 0;overflow-x:auto}.markdown-body table td,.markdown-body table th{border:1px solid #dfe2e5;padding:.6em 1em}.markdown-body table tr{border-top:1px solid #dfe2e5}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">事故现场</h2>
<p>上周线上炸了。</p>
<p>支付业务出了问题，用户支付成功，但订单表没数据。更诡异的是，修改订单时有时也会提示获取锁超时。</p>
<p>DBA看了一眼数据库连接，发现几个事务一直没提交，锁着订单表的几行数据。</p>
<p>排查半天，最后发现是某个业务接口忘了提交事务。</p>
<p>按理说,事务没提交应该很容易发现。但这个bug就比较隐蔽。</p>
<p><strong>4个反常识的现象：</strong></p>
<ol>
<li><strong>业务代码正常执行完毕</strong> 没有任何报错，日志也正常打印。</li>
<li><strong>日志显示事务已提交</strong> commit方法被调用了，但数据库里没数据。</li>
<li><strong>偶尔会成功</strong> 大部分时候失败，但偶尔能正常插入订单。</li>
</ol>
<p>这种情况让人摸不着头脑。代码没报错，日志也正常，为啥数据就是不入库?</p>
<h2 data-id="heading-1">应急处理</h2>
<p>线上出问题，那肯定先恢复业务再说。</p>
<p>最快的办法就是重启应用，强制释放这些连接。</p>
<p>重启完，支付功能恢复正常。但问题还是要找到</p>
<p>重启只能暂时缓解，得找到到底哪个业务出了问题。</p>
<p>对比了最近的上线记录，发现有个新业务刚上线。检查代码，果然发现了问题：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SomeService</span> {

    <span class="hljs-keyword">public</span> void handleSpecialCase() {
        <span class="hljs-comment">// 开启事务</span>
        sqlSession.connection.setAutoCommit(<span class="hljs-literal">false</span>);

        <span class="hljs-comment">// 执行SQL</span>
        mapper.insert(<span class="hljs-keyword">data</span>);

        <span class="hljs-comment">// 特殊情况下，忘记commit了！</span>
        <span class="hljs-keyword">if</span> (specialCondition) {
            <span class="hljs-comment">// 某些情况下会return，但没commit</span>
            <span class="hljs-keyword">return</span>;
        }

        sqlSession.commit();
    }
}
</code></pre>
<p>特殊分支直接return了，commit没执行。</p>
<h3 data-id="heading-2">快速修复</h3>
<p>立即补上commit，重新上线：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SomeService</span> {

    <span class="hljs-keyword">public</span> void handleSpecialCase() {
        <span class="hljs-keyword">try</span> {
            sqlSession.connection.setAutoCommit(<span class="hljs-literal">false</span>);
            mapper.insert(<span class="hljs-keyword">data</span>);

            <span class="hljs-keyword">if</span> (specialCondition) {
                sqlSession.commit(); <span class="hljs-comment">// 补上！</span>
                <span class="hljs-keyword">return</span>;
            }

            sqlSession.commit();
        } <span class="hljs-keyword">catch</span> (Exception e) {
            sqlSession.rollback();
            <span class="hljs-keyword">throw</span> e;
        }
    }
}
</code></pre>
<p>上线后验证，问题解决。</p>
<h2 data-id="heading-3">事后复盘</h2>
<p>问题虽然解决了，但还是很奇怪：为啥一个业务的事务没提交，会影响到其他完全不相关的支付业务？</p>
<p>周末花了半天debug源码，终于搞清楚了。</p>
<h3 data-id="heading-4">断点打在getTransaction</h3>
<p>首先在Spring的<code>getTransaction</code>方法打断点，发现出问题的请求都会走到这里：</p>
<pre><code class="hljs language-less" lang="less"><span class="hljs-selector-tag">public</span> <span class="hljs-selector-tag">final</span> <span class="hljs-selector-tag">TransactionStatus</span> <span class="hljs-selector-tag">getTransaction</span>(<span class="hljs-variable">@Nullable</span> TransactionDefinition definition)
        <span class="hljs-selector-tag">throws</span> <span class="hljs-selector-tag">TransactionException</span> {

    <span class="hljs-comment">// 使用默认的事务定义</span>
    <span class="hljs-selector-tag">TransactionDefinition</span> <span class="hljs-selector-tag">def</span> = (definition != null ? <span class="hljs-attribute">definition </span>: TransactionDefinition.<span class="hljs-built_in">withDefaults</span>());

    <span class="hljs-comment">// 关键：获取当前事务对象</span>
    <span class="hljs-selector-tag">Object</span> <span class="hljs-selector-tag">transaction</span> = <span class="hljs-selector-tag">doGetTransaction</span>();
    <span class="hljs-selector-tag">boolean</span> <span class="hljs-selector-tag">debugEnabled</span> = <span class="hljs-selector-tag">logger</span><span class="hljs-selector-class">.isDebugEnabled</span>();

    <span class="hljs-comment">// 判断是否是已存在的事务</span>
    <span class="hljs-selector-tag">if</span> (<span class="hljs-built_in">isExistingTransaction</span>(transaction)) {
        <span class="hljs-comment">// 发现已存在的事务，直接返回</span>
        <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">handleExistingTransaction</span>(def, transaction, debugEnabled);
    }

    <span class="hljs-comment">// 创建新事务的逻辑...</span>
}
</code></pre>
<p>问题就出在<code>doGetTransaction</code>这个方法。</p>
<h3 data-id="heading-5">doGetTransaction会复用连接</h3>
<p>点开<code>doGetTransaction</code>，会发现：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">protected</span> Object <span class="hljs-title function_">doGetTransaction</span><span class="hljs-params">()</span> {
    <span class="hljs-type">DataSourceTransactionObject</span> <span class="hljs-variable">txObject</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DataSourceTransactionObject</span>();
    txObject.setSavepointAllowed(<span class="hljs-built_in">this</span>.isNestedTransactionAllowed());

    <span class="hljs-comment">// 关键：从TransactionSynchronizationManager获取连接</span>
    <span class="hljs-type">ConnectionHolder</span> <span class="hljs-variable">conHolder</span> <span class="hljs-operator">=</span> (ConnectionHolder) TransactionSynchronizationManager.getResource(<span class="hljs-built_in">this</span>.obtainDataSource());

    txObject.setConnectionHolder(conHolder, <span class="hljs-literal">false</span>);
    <span class="hljs-keyword">return</span> txObject;
}
</code></pre>
<p><code>TransactionSynchronizationManager.getResource</code>会从连接池拿连接。如果拿到一个被污染的连接（上一个事务没提交），<code>ConnectionHolder</code>里就带着上一个事务的状态。</p>
<h3 data-id="heading-6">isExistingTransaction的判断</h3>
<p>然后<code>isExistingTransaction</code>会检查这个连接：</p>
<pre><code class="hljs language-scss" lang="scss">protected boolean <span class="hljs-built_in">isExistingTransaction</span>(Object transaction) {
    DataSourceTransactionObject txObject = (DataSourceTransactionObject)transaction;
    return txObject<span class="hljs-selector-class">.hasConnectionHolder</span>() &amp;&amp; txObject<span class="hljs-selector-class">.getConnectionHolder</span>()<span class="hljs-selector-class">.isTransactionActive</span>();
}
</code></pre>
<p>如果连接上有事务标记(<code>isTransactionActive()</code>)，就认为是已存在的事务，不会创建新事务。</p>
<p>问题来了：如果上一个业务用完连接后，事务没提交也没回滚，<code>ConnectionHolder</code>的事务标记还在。下一个业务通过<code>doGetTransaction</code>从<code>TransactionSynchronizationManager</code>拿到这个<code>ConnectionHolder</code>，就被当成已存在的事务了。</p>
<h3 data-id="heading-7">被污染的连接是怎么来的</h3>
<p>回顾前面应急处理时找到的那段demo代码：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SomeService</span> {

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">handleSpecialCase</span><span class="hljs-params">()</span> {
        <span class="hljs-comment">// 开启事务</span>
        <span class="hljs-type">TransactionStatus</span> <span class="hljs-variable">status</span> <span class="hljs-operator">=</span> transactionManager.getTransaction(<span class="hljs-keyword">new</span> <span class="hljs-title class_">DefaultTransactionDefinition</span>());

        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// 执行SQL</span>
            mapper.insert(data);

            <span class="hljs-comment">// 特殊分支：直接return，没commit！</span>
            <span class="hljs-keyword">if</span> (specialCondition) {
                <span class="hljs-keyword">return</span>;
            }

            transactionManager.commit(status);
        } <span class="hljs-keyword">catch</span> (Exception e) {
            transactionManager.rollback(status);
            <span class="hljs-keyword">throw</span> e;
        }
    }
}
</code></pre>
<p>当走到特殊分支return时：</p>
<ul>
<li><code>ConnectionHolder</code>已经被标记为有事务（<code>isTransactionActive() = true</code>）</li>
<li>但事务既没commit，也没rollback</li>
<li>方法结束后，连接归还到<code>TransactionSynchronizationManager</code></li>
<li><code>ConnectionHolder</code>的事务标记还在</li>
</ul>
<p>这个连接就被污染了。</p>
<h3 data-id="heading-8">复用导致的问题</h3>
<p>其他业务刚好复用到了这个被污染的连接：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PaymentService</span> {

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">createOrder</span><span class="hljs-params">(Order order)</span> {
        <span class="hljs-comment">// 手动开启事务</span>
        <span class="hljs-type">TransactionStatus</span> <span class="hljs-variable">status</span> <span class="hljs-operator">=</span> transactionManager.getTransaction(<span class="hljs-keyword">new</span> <span class="hljs-title class_">DefaultTransactionDefinition</span>());

        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// 插入订单</span>
            orderMapper.insert(order);

            <span class="hljs-comment">// 提交事务</span>
            transactionManager.commit(status);
        } <span class="hljs-keyword">catch</span> (Exception e) {
            transactionManager.rollback(status);
            <span class="hljs-keyword">throw</span> e;
        }
    }
}
</code></pre>
<p>看起来没问题，对吧？但当这个方法获取到被污染的连接时：</p>
<ol>
<li><code>getTransaction</code>判断<code>isExistingTransaction</code>为true</li>
<li>走进<code>handleExistingTransaction</code>方法</li>
<li>根据事务传播行为，可能会加入现有事务，而不是创建新事务</li>
<li>最后commit时，因为不是事务发起者，不会真正提交</li>
</ol>
<h3 data-id="heading-9">processCommit的判断</h3>
<p>继续debug到commit方法，发现会执行processCommit去完成提交：</p>
<pre><code class="hljs language-scss" lang="scss">private void <span class="hljs-built_in">processCommit</span>(DefaultTransactionStatus status) throws TransactionException {
    try {
        boolean beforeCompletionInvoked = false;

        try {
            <span class="hljs-built_in">prepareForCommit</span>(status);
            <span class="hljs-built_in">triggerBeforeCommit</span>(status);
            <span class="hljs-built_in">triggerBeforeCompletion</span>(status);
            beforeCompletionInvoked = true;

            if (status.hasSavepoint()) {
                status<span class="hljs-selector-class">.releaseHeldSavepoint</span>();
            }
            <span class="hljs-comment">// 关键判断：只有新事务才真正提交</span>
            else if (status.isNewTransaction()) {
                if (status.isDebug()) {
                    logger<span class="hljs-selector-class">.debug</span>("Initiating transaction commit");
                }
                <span class="hljs-comment">// 真正执行数据库commit</span>
                <span class="hljs-built_in">doCommit</span>(status);
            }
            <span class="hljs-comment">// 如果不是新事务，什么都不做！</span>

        } catch (UnexpectedRollbackException ex) {
            <span class="hljs-comment">// ...</span>
        }

    } finally {
        <span class="hljs-built_in">cleanupAfterCompletion</span>(status);
    }
}
</code></pre>
<p>因为<code>status.isNewTransaction()</code>返回false（这是个加入的事务，不是新事务），所以<code>doCommit(status)</code>根本不会执行。</p>
<p>真正的<code>connection.commit()</code>根本没执行。</p>
<h3 data-id="heading-10">完整的问题链路</h3>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/949f8bc5fad646ce99fe08ea931a121b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgOeWPt-i-vuS6ug==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766816735&amp;x-signature=eaui1jMxdtT2JMmKe2B7tW5yA9M%3D" alt="" loading="lazy"/></p>
<ol>
<li><code>SomeService.handleSpecialCase()</code>特殊分支没提交事务</li>
<li>方法结束，<code>ConnectionHolder</code>归还到<code>TransactionSynchronizationManager</code>，但事务标记<code>isTransactionActive()</code>还是true</li>
<li><code>PaymentService.createOrder()</code>调用<code>doGetTransaction()</code></li>
<li><code>doGetTransaction</code>从<code>TransactionSynchronizationManager</code>拿到被污染的<code>ConnectionHolder</code></li>
<li><code>isExistingTransaction</code>判断为true，认为已有事务</li>
<li>走<code>handleExistingTransaction</code>流程，加入现有事务（<code>isNewTransaction = false</code>）</li>
<li>业务代码执行完，调用<code>commit</code></li>
<li><code>processCommit</code>中判断<code>isNewTransaction()</code>为false，跳过<code>doCommit</code></li>
<li>数据没入库，<code>ConnectionHolder</code>继续待在<code>TransactionSynchronizationManager</code>，继续污染下一个业务</li>
</ol>
<h2 data-id="heading-11">为什么偶尔会成功？</h2>
<p>因为<code>TransactionSynchronizationManager</code>是ThreadLocal实现的，每个线程有独立的资源。</p>
<p>如果支付请求分配到一个干净的线程（没有被污染的<code>ConnectionHolder</code>），就能正常工作。但只要分配到被污染的线程，就会出问题。</p>
<p>这就是为什么这个bug这么难发现：</p>
<ul>
<li>不是100%复现（取决于线程池调度）</li>
<li>没有报错信息</li>
<li>日志看起来正常</li>
</ul>
<h2 data-id="heading-12">预防措施</h2>
<p>经过这次事故，我们加了几个预防措施。</p>
<h3 data-id="heading-13">1. 连接池健康检查</h3>
<p>配置连接池的连接校验：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">spring:</span>
  <span class="hljs-attr">datasource:</span>
    <span class="hljs-attr">hikari:</span>
      <span class="hljs-string">connection-test-query:</span> <span class="hljs-string">SELECT</span> <span class="hljs-number">1</span>
      <span class="hljs-string">validation-timeout:</span> <span class="hljs-number">3000</span>
      <span class="hljs-comment"># 从池子取连接前先测试</span>
      <span class="hljs-string">connection-init-sql:</span> <span class="hljs-string">SET</span> <span class="hljs-string">autocommit=1</span>
</code></pre>
<p><code>connection-init-sql</code>会在每次从池子取连接时重置状态，避免被污染的连接影响业务。</p>
<h3 data-id="heading-14">2. 监控告警</h3>
<p>增加数据库长事务监控：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 查找执行超过30秒的事务</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span>
<span class="hljs-keyword">FROM</span> information_schema.innodb_trx
<span class="hljs-keyword">WHERE</span> TIME_TO_SEC(TIMEDIFF(NOW(), trx_started)) <span class="hljs-operator">&gt;</span> <span class="hljs-number">30</span>;
</code></pre>
<p>配置告警规则，超过30秒的事务立即报警。</p>
<h2 data-id="heading-15">踩坑总结</h2>
<p>这次事故让我明白了几点。</p>
<h3 data-id="heading-16">1. 连接池不只是性能优化</h3>
<p>之前我一直觉得连接池就是提升性能的。这次才懂，连接池还会带来状态复用的坑。</p>
<p>一个连接的问题，会影响后面所有复用这个连接的业务。</p>
<h3 data-id="heading-17">2. 事务管理要写清楚</h3>
<p>手动管理事务，一定要写清楚commit和rollback：</p>
<ul>
<li>commit写在try块末尾</li>
<li>rollback写在catch块</li>
<li>finally块关闭资源</li>
</ul>
<p>别偷懒省这几行代码。一个遗漏的commit，就可能导致线上事故。</p>
<h3 data-id="heading-18">3. 监控要覆盖到数据库层</h3>
<p>应用层日志正常，不代表数据库层没问题。</p>
<p>必须要有数据库层面的监控：</p>
<ul>
<li>慢查询</li>
<li>长事务</li>
<li>锁等待</li>
<li>连接数</li>
</ul>
<h3 data-id="heading-19">4. 源码不能只看，要调试</h3>
<p>看源码很多时候看不出问题。这次是真的打断点一步步走，才发现<code>getTransaction</code>方法里有个<code>isExistingTransaction</code>的判断。</p>
<p>遇到诡异问题，直接上断点调试。看调用栈，看变量值，比看文档快多了。</p>
<h2 data-id="heading-20">写在最后</h2>
<p>这个bug修复后，我跟同事也分享了一下。记录了问题现象、排查过程、根本原因、解决方案和预防措施。</p>
<p>不是为了甩锅，是为了让团队其他人避免踩同样的坑。</p>
<p>技术债不可怕，可怕的是踩坑了还不总结。</p>
<p>生产环境的每一次事故，都是学习的机会。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[AQS抽象队列同步器原理与应用]]></title>    <link>https://juejin.cn/post/7585382553290604580</link>    <guid>https://juejin.cn/post/7585382553290604580</guid>    <pubDate>2025-12-20T06:40:38.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585382553290604580" data-draft-id="7585171571129876516" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="AQS抽象队列同步器原理与应用"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-12-20T06:40:38.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="無量"/> <meta itemprop="url" content="https://juejin.cn/user/1116759546145086"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            AQS抽象队列同步器原理与应用
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1116759546145086/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    無量
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-20T06:40:38.000Z" title="Sat Dec 20 2025 06:40:38 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读33分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一、理论知识与核心概念</h2>
<h3 data-id="heading-1">1.1 什么是AQS?</h3>
<p>AQS(AbstractQueuedSynchronizer,抽象队列同步器)是Java并发包(JUC)中最核心的基础框架之一,由Doug Lea大师设计并实现。它为构建锁和同步器提供了一套通用的框架,通过<strong>内置的FIFO双向队列</strong>来管理线程的竞争和等待。</p>
<p>简单来说,AQS解决了实现同步器时的大量通用性工作,包括:</p>
<ul>
<li><strong>同步状态的原子性管理</strong></li>
<li><strong>线程的阻塞与唤醒</strong></li>
<li><strong>等待队列的维护</strong></li>
</ul>
<p>开发者只需要继承AQS并实现特定的几个方法,就能构建出各种功能强大的同步工具。</p>
<h3 data-id="heading-2">1.2 AQS在Java并发包中的地位</h3>
<p>AQS是整个JUC包的基石,以下同步工具都基于AQS实现:</p>
<p><strong>独占锁:</strong></p>
<ul>
<li><code>ReentrantLock</code> - 可重入独占锁</li>
<li><code>ReentrantReadWriteLock.WriteLock</code> - 写锁</li>
</ul>
<p><strong>共享锁:</strong></p>
<ul>
<li><code>Semaphore</code> - 信号量</li>
<li><code>CountDownLatch</code> - 倒计数门闩</li>
<li><code>ReentrantReadWriteLock.ReadLock</code> - 读锁</li>
</ul>
<p><strong>其他同步工具:</strong></p>
<ul>
<li><code>CyclicBarrier</code> - 循环屏障(基于ReentrantLock+Condition)</li>
<li><code>ThreadPoolExecutor.Worker</code> - 线程池工作线程(内部使用AQS)</li>
</ul>
<p>可以说,掌握AQS原理是深入理解Java并发编程的必经之路。</p>
<h3 data-id="heading-3">1.3 AQS的设计思想:模板方法模式</h3>
<p>AQS采用了<strong>模板方法设计模式</strong>:</p>
<p><strong>AQS定义了同步器的骨架流程:</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 模板方法 - 获取锁的标准流程</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">acquire</span><span class="hljs-params">(<span class="hljs-type">int</span> arg)</span> {
    <span class="hljs-keyword">if</span> (!tryAcquire(arg) &amp;&amp;           <span class="hljs-comment">// 尝试获取(子类实现)</span>
        acquireQueued(                <span class="hljs-comment">// 进入队列等待(AQS实现)</span>
            addWaiter(Node.EXCLUSIVE), arg)) <span class="hljs-comment">// 加入队列(AQS实现)</span>
        selfInterrupt();
}
</code></pre>
<p><strong>子类只需实现具体的获取/释放逻辑:</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">protected</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">tryAcquire</span><span class="hljs-params">(<span class="hljs-type">int</span> arg)</span> {
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UnsupportedOperationException</span>();
}
</code></pre>
<p>这种设计让AQS复用了线程调度、队列管理等复杂逻辑,子类只关注业务语义。</p>
<h3 data-id="heading-4">1.4 同步器与锁的关系</h3>
<p><strong>锁是面向使用者的API</strong>, 而<strong>同步器是面向锁实现者的框架</strong>:</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 锁 - 对外API</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ReentrantLock</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Lock</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Sync sync;  <span class="hljs-comment">// 内部同步器</span>

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">lock</span><span class="hljs-params">()</span> {
        sync.acquire(<span class="hljs-number">1</span>);  <span class="hljs-comment">// 委托给同步器</span>
    }
}

<span class="hljs-comment">// 同步器 - 实现细节</span>
<span class="hljs-keyword">abstract</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Sync</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AbstractQueuedSynchronizer</span> {
    <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">lock</span><span class="hljs-params">()</span>;

    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">final</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">tryAcquire</span><span class="hljs-params">(<span class="hljs-type">int</span> acquires)</span> {
        <span class="hljs-comment">// 具体的锁获取逻辑</span>
    }
}
</code></pre>
<p><strong>关键区别:</strong></p>
<ul>
<li>锁定义了<code>lock()/unlock()</code>等用户友好的API</li>
<li>同步器负责实际的线程竞争、排队、唤醒等底层机制</li>
<li>一个锁可以有多种同步器实现(如公平锁/非公平锁)</li>
</ul>
<hr/>
<h2 data-id="heading-5">二、原理深度剖析</h2>
<h3 data-id="heading-6">2.1 AQS核心设计思想</h3>
<h4 data-id="heading-7">2.1.1 同步状态(state)</h4>
<p>AQS使用一个<code>volatile int</code>类型的成员变量<code>state</code>来表示同步状态:</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">volatile</span> <span class="hljs-type">int</span> state;

<span class="hljs-keyword">protected</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getState</span><span class="hljs-params">()</span> {
    <span class="hljs-keyword">return</span> state;
}

<span class="hljs-keyword">protected</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setState</span><span class="hljs-params">(<span class="hljs-type">int</span> newState)</span> {
    state = newState;
}

<span class="hljs-keyword">protected</span> <span class="hljs-keyword">final</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">compareAndSetState</span><span class="hljs-params">(<span class="hljs-type">int</span> expect, <span class="hljs-type">int</span> update)</span> {
    <span class="hljs-keyword">return</span> unsafe.compareAndSwapInt(<span class="hljs-built_in">this</span>, stateOffset, expect, update);
}
</code></pre>
<p><strong>state的语义由子类定义:</strong></p>






























<table><thead><tr><th>同步器</th><th>state含义</th><th>获取条件</th></tr></thead><tbody><tr><td>ReentrantLock</td><td>重入次数</td><td>state=0表示未锁定</td></tr><tr><td>Semaphore</td><td>剩余许可数</td><td>state&gt;0表示有许可</td></tr><tr><td>CountDownLatch</td><td>倒计数值</td><td>state=0表示门闩打开</td></tr><tr><td>ReentrantReadWriteLock</td><td>高16位:读锁数<br/>低16位:写锁数</td><td>复合判断</td></tr></tbody></table>
<p><strong>CAS操作保证原子性:</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 非公平锁的快速获取</span>
<span class="hljs-keyword">final</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">nonfairTryAcquire</span><span class="hljs-params">(<span class="hljs-type">int</span> acquires)</span> {
    <span class="hljs-keyword">final</span> <span class="hljs-type">Thread</span> <span class="hljs-variable">current</span> <span class="hljs-operator">=</span> Thread.currentThread();
    <span class="hljs-type">int</span> <span class="hljs-variable">c</span> <span class="hljs-operator">=</span> getState();
    <span class="hljs-keyword">if</span> (c == <span class="hljs-number">0</span>) {
        <span class="hljs-comment">// CAS原子操作抢占锁</span>
        <span class="hljs-keyword">if</span> (compareAndSetState(<span class="hljs-number">0</span>, acquires)) {
            setExclusiveOwnerThread(current);
            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
        }
    }
    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
}
</code></pre>
<h4 data-id="heading-8">2.1.2 CLH队列锁</h4>
<p>AQS内部维护了一个基于<strong>CLH(Craig, Landin, and Hagersten)队列锁</strong>的变体:</p>
<p><strong>原始CLH队列特点:</strong></p>
<ul>
<li>自旋锁,基于链表</li>
<li>每个节点自旋检查前驱节点的状态</li>
<li>前驱释放锁时,后继自动获得锁</li>
</ul>
<p><strong>AQS的改进:</strong></p>
<ul>
<li>使用双向链表(便于取消操作)</li>
<li>节点不再自旋,而是阻塞等待(park/unpark)</li>
<li>前驱节点负责唤醒后继节点</li>
</ul>
<p><strong>Node节点结构:</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Node</span> {
    <span class="hljs-comment">// 模式</span>
    <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Node</span> <span class="hljs-variable">SHARED</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Node</span>();    <span class="hljs-comment">// 共享模式</span>
    <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Node</span> <span class="hljs-variable">EXCLUSIVE</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;       <span class="hljs-comment">// 独占模式</span>

    <span class="hljs-comment">// 等待状态</span>
    <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">CANCELLED</span> <span class="hljs-operator">=</span>  <span class="hljs-number">1</span>;  <span class="hljs-comment">// 线程已取消</span>
    <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">SIGNAL</span>    <span class="hljs-operator">=</span> -<span class="hljs-number">1</span>;  <span class="hljs-comment">// 后继需要唤醒</span>
    <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">CONDITION</span> <span class="hljs-operator">=</span> -<span class="hljs-number">2</span>;  <span class="hljs-comment">// 在条件队列中等待</span>
    <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">PROPAGATE</span> <span class="hljs-operator">=</span> -<span class="hljs-number">3</span>;  <span class="hljs-comment">// 共享模式下传播唤醒</span>

    <span class="hljs-keyword">volatile</span> <span class="hljs-type">int</span> waitStatus;        <span class="hljs-comment">// 当前节点状态</span>
    <span class="hljs-keyword">volatile</span> Node prev;             <span class="hljs-comment">// 前驱节点</span>
    <span class="hljs-keyword">volatile</span> Node next;             <span class="hljs-comment">// 后继节点</span>
    <span class="hljs-keyword">volatile</span> Thread thread;         <span class="hljs-comment">// 等待的线程</span>
    Node nextWaiter;               <span class="hljs-comment">// 条件队列下一个节点/模式标记</span>
}
</code></pre>
<p><strong>队列结构示意(见下图):</strong></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f298f64fc56845e5b5e3301549ee0481~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54Sh6YeP:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766817638&amp;x-signature=7svwD2YJSrjKJGMFGzM25Q%2FlZF4%3D" alt="aqs-queue-structure.svg" loading="lazy"/>
<strong>双向链表的维护:</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 入队 - 通过CAS将节点加到队尾</span>
<span class="hljs-keyword">private</span> Node <span class="hljs-title function_">enq</span><span class="hljs-params">(<span class="hljs-keyword">final</span> Node node)</span> {
    <span class="hljs-keyword">for</span> (;;) {
        <span class="hljs-type">Node</span> <span class="hljs-variable">t</span> <span class="hljs-operator">=</span> tail;
        <span class="hljs-keyword">if</span> (t == <span class="hljs-literal">null</span>) {  <span class="hljs-comment">// 队列为空,初始化</span>
            <span class="hljs-keyword">if</span> (compareAndSetHead(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Node</span>()))
                tail = head;
        } <span class="hljs-keyword">else</span> {
            node.prev = t;
            <span class="hljs-keyword">if</span> (compareAndSetTail(t, node)) {  <span class="hljs-comment">// CAS设置tail</span>
                t.next = node;
                <span class="hljs-keyword">return</span> t;
            }
        }
    }
}
</code></pre>
<h4 data-id="heading-9">2.1.3 独占模式与共享模式</h4>
<p><strong>独占模式(Exclusive):</strong></p>
<ul>
<li>同一时刻只有一个线程能持有锁</li>
<li>典型应用:ReentrantLock、WriteLock</li>
</ul>
<p><strong>共享模式(Shared):</strong></p>
<ul>
<li>同一时刻允许多个线程同时持有</li>
<li>典型应用:Semaphore、ReadLock、CountDownLatch</li>
</ul>
<p><strong>实现差异:</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 独占模式 - 获取成功后只唤醒一个后继</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setHead</span><span class="hljs-params">(Node node)</span> {
    head = node;
    node.thread = <span class="hljs-literal">null</span>;
    node.prev = <span class="hljs-literal">null</span>;
}

<span class="hljs-comment">// 共享模式 - 获取成功后传播唤醒</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setHeadAndPropagate</span><span class="hljs-params">(Node node, <span class="hljs-type">int</span> propagate)</span> {
    <span class="hljs-type">Node</span> <span class="hljs-variable">h</span> <span class="hljs-operator">=</span> head;
    setHead(node);

    <span class="hljs-comment">// 如果还有剩余资源,继续唤醒后继</span>
    <span class="hljs-keyword">if</span> (propagate &gt; <span class="hljs-number">0</span> || h == <span class="hljs-literal">null</span> || h.waitStatus &lt; <span class="hljs-number">0</span> ||
        (h = head) == <span class="hljs-literal">null</span> || h.waitStatus &lt; <span class="hljs-number">0</span>) {
        <span class="hljs-type">Node</span> <span class="hljs-variable">s</span> <span class="hljs-operator">=</span> node.next;
        <span class="hljs-keyword">if</span> (s == <span class="hljs-literal">null</span> || s.isShared())
            doReleaseShared();  <span class="hljs-comment">// 传播唤醒</span>
    }
}
</code></pre>
<h3 data-id="heading-10">2.2 AQS核心方法源码剖析</h3>
<h4 data-id="heading-11">2.2.1 acquire(int arg) - 独占式获取</h4>
<p><strong>完整流程:</strong></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/62192b2f43e44181a3dd38ece2359787~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54Sh6YeP:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766817638&amp;x-signature=fkHI5VbjDn8QxCaSrChzzf6cvRI%3D" alt="aqs-acquire-flow.svg" loading="lazy"/></p>
<p><strong>源码分析:</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">/**
 * 独占模式获取,忽略中断
 * 1. 尝试获取(tryAcquire)
 * 2. 失败则加入队列并阻塞(acquireQueued)
 * 3. 被唤醒后重新尝试获取
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">acquire</span><span class="hljs-params">(<span class="hljs-type">int</span> arg)</span> {
    <span class="hljs-keyword">if</span> (!tryAcquire(arg) &amp;&amp;                    <span class="hljs-comment">// ①尝试获取</span>
        acquireQueued(addWaiter(Node.EXCLUSIVE), arg))  <span class="hljs-comment">// ②入队+自旋</span>
        selfInterrupt();                        <span class="hljs-comment">// ③补偿中断</span>
}

<span class="hljs-comment">// ① tryAcquire - 子类实现,定义获取语义</span>
<span class="hljs-keyword">protected</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">tryAcquire</span><span class="hljs-params">(<span class="hljs-type">int</span> arg)</span> {
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UnsupportedOperationException</span>();
}

<span class="hljs-comment">// ② addWaiter - 创建节点并加入队尾</span>
<span class="hljs-keyword">private</span> Node <span class="hljs-title function_">addWaiter</span><span class="hljs-params">(Node mode)</span> {
    <span class="hljs-type">Node</span> <span class="hljs-variable">node</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Node</span>(Thread.currentThread(), mode);
    <span class="hljs-type">Node</span> <span class="hljs-variable">pred</span> <span class="hljs-operator">=</span> tail;

    <span class="hljs-comment">// 快速入队尝试</span>
    <span class="hljs-keyword">if</span> (pred != <span class="hljs-literal">null</span>) {
        node.prev = pred;
        <span class="hljs-keyword">if</span> (compareAndSetTail(pred, node)) {
            pred.next = node;
            <span class="hljs-keyword">return</span> node;
        }
    }

    <span class="hljs-comment">// 快速失败,调用完整入队逻辑</span>
    enq(node);
    <span class="hljs-keyword">return</span> node;
}

<span class="hljs-comment">// ③ acquireQueued - 在队列中自旋获取</span>
<span class="hljs-keyword">final</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">acquireQueued</span><span class="hljs-params">(<span class="hljs-keyword">final</span> Node node, <span class="hljs-type">int</span> arg)</span> {
    <span class="hljs-type">boolean</span> <span class="hljs-variable">failed</span> <span class="hljs-operator">=</span> <span class="hljs-literal">true</span>;
    <span class="hljs-keyword">try</span> {
        <span class="hljs-type">boolean</span> <span class="hljs-variable">interrupted</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>;
        <span class="hljs-keyword">for</span> (;;) {  <span class="hljs-comment">// 自旋</span>
            <span class="hljs-keyword">final</span> <span class="hljs-type">Node</span> <span class="hljs-variable">p</span> <span class="hljs-operator">=</span> node.predecessor();

            <span class="hljs-comment">// 前驱是head才有资格尝试获取</span>
            <span class="hljs-keyword">if</span> (p == head &amp;&amp; tryAcquire(arg)) {
                setHead(node);      <span class="hljs-comment">// 获取成功,设为新head</span>
                p.next = <span class="hljs-literal">null</span>;      <span class="hljs-comment">// 帮助GC</span>
                failed = <span class="hljs-literal">false</span>;
                <span class="hljs-keyword">return</span> interrupted;
            }

            <span class="hljs-comment">// 检查是否需要阻塞</span>
            <span class="hljs-keyword">if</span> (shouldParkAfterFailedAcquire(p, node) &amp;&amp;
                parkAndCheckInterrupt())  <span class="hljs-comment">// 阻塞等待</span>
                interrupted = <span class="hljs-literal">true</span>;
        }
    } <span class="hljs-keyword">finally</span> {
        <span class="hljs-keyword">if</span> (failed)
            cancelAcquire(node);  <span class="hljs-comment">// 异常情况取消获取</span>
    }
}

<span class="hljs-comment">// 判断是否应该阻塞</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">shouldParkAfterFailedAcquire</span><span class="hljs-params">(Node pred, Node node)</span> {
    <span class="hljs-type">int</span> <span class="hljs-variable">ws</span> <span class="hljs-operator">=</span> pred.waitStatus;

    <span class="hljs-keyword">if</span> (ws == Node.SIGNAL)
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;  <span class="hljs-comment">// 前驱状态为SIGNAL,可以安心阻塞</span>

    <span class="hljs-keyword">if</span> (ws &gt; <span class="hljs-number">0</span>) {
        <span class="hljs-comment">// 前驱已取消,跳过所有已取消的节点</span>
        <span class="hljs-keyword">do</span> {
            node.prev = pred = pred.prev;
        } <span class="hljs-keyword">while</span> (pred.waitStatus &gt; <span class="hljs-number">0</span>);
        pred.next = node;
    } <span class="hljs-keyword">else</span> {
        <span class="hljs-comment">// 设置前驱状态为SIGNAL</span>
        compareAndSetWaitStatus(pred, ws, Node.SIGNAL);
    }
    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
}

<span class="hljs-comment">// 阻塞当前线程</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">parkAndCheckInterrupt</span><span class="hljs-params">()</span> {
    LockSupport.park(<span class="hljs-built_in">this</span>);  <span class="hljs-comment">// 阻塞</span>
    <span class="hljs-keyword">return</span> Thread.interrupted();  <span class="hljs-comment">// 返回中断状态并清除中断标志</span>
}
</code></pre>
<p><strong>关键点:</strong></p>
<ol>
<li><strong>自旋与阻塞结合</strong>: 先自旋几次,失败后才阻塞,减少线程切换</li>
<li><strong>只有head的后继能尝试获取</strong>: 保证FIFO公平性</li>
<li><strong>前驱负责唤醒后继</strong>: 通过waitStatus=SIGNAL标识</li>
<li><strong>中断处理</strong>: 获取过程中不响应中断,只记录标志,最后补偿</li>
</ol>
<h4 data-id="heading-12">2.2.2 release(int arg) - 独占式释放</h4>
<p><strong>完整流程:</strong></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3bbb8fd5b8d848fda72108834ec7d602~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54Sh6YeP:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766817638&amp;x-signature=%2BpC%2FhgrD3axW4acoeizR3Td8zDY%3D" alt="aqs-release-flow.svg" loading="lazy"/></p>
<p><strong>源码分析:</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">/**
 * 独占模式释放
 * 1. 尝试释放(tryRelease)
 * 2. 成功则唤醒后继节点
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">release</span><span class="hljs-params">(<span class="hljs-type">int</span> arg)</span> {
    <span class="hljs-keyword">if</span> (tryRelease(arg)) {           <span class="hljs-comment">// ①尝试释放</span>
        <span class="hljs-type">Node</span> <span class="hljs-variable">h</span> <span class="hljs-operator">=</span> head;
        <span class="hljs-keyword">if</span> (h != <span class="hljs-literal">null</span> &amp;&amp; h.waitStatus != <span class="hljs-number">0</span>)
            unparkSuccessor(h);      <span class="hljs-comment">// ②唤醒后继</span>
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    }
    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
}

<span class="hljs-comment">// ① tryRelease - 子类实现</span>
<span class="hljs-keyword">protected</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">tryRelease</span><span class="hljs-params">(<span class="hljs-type">int</span> arg)</span> {
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UnsupportedOperationException</span>();
}

<span class="hljs-comment">// ② unparkSuccessor - 唤醒后继节点</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">unparkSuccessor</span><span class="hljs-params">(Node node)</span> {
    <span class="hljs-type">int</span> <span class="hljs-variable">ws</span> <span class="hljs-operator">=</span> node.waitStatus;
    <span class="hljs-keyword">if</span> (ws &lt; <span class="hljs-number">0</span>)
        compareAndSetWaitStatus(node, ws, <span class="hljs-number">0</span>);  <span class="hljs-comment">// 清除信号</span>

    <span class="hljs-type">Node</span> <span class="hljs-variable">s</span> <span class="hljs-operator">=</span> node.next;

    <span class="hljs-comment">// 如果后继为空或已取消,从tail向前找最近的有效节点</span>
    <span class="hljs-keyword">if</span> (s == <span class="hljs-literal">null</span> || s.waitStatus &gt; <span class="hljs-number">0</span>) {
        s = <span class="hljs-literal">null</span>;
        <span class="hljs-keyword">for</span> (<span class="hljs-type">Node</span> <span class="hljs-variable">t</span> <span class="hljs-operator">=</span> tail; t != <span class="hljs-literal">null</span> &amp;&amp; t != node; t = t.prev)
            <span class="hljs-keyword">if</span> (t.waitStatus &lt;= <span class="hljs-number">0</span>)
                s = t;
    }

    <span class="hljs-keyword">if</span> (s != <span class="hljs-literal">null</span>)
        LockSupport.unpark(s.thread);  <span class="hljs-comment">// 唤醒线程</span>
}
</code></pre>
<p><strong>为什么从tail向前遍历?</strong></p>
<p>考虑并发入队场景:</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// addWaiter中的入队操作</span>
node.prev = pred;                    <span class="hljs-comment">// ①设置prev</span>
<span class="hljs-keyword">if</span> (compareAndSetTail(pred, node)) { <span class="hljs-comment">// ②CAS设置tail</span>
    pred.next = node;                <span class="hljs-comment">// ③设置next</span>
    <span class="hljs-keyword">return</span> node;
}
</code></pre>
<p>在②③之间,<code>next</code>指针尚未设置,但<code>prev</code>已经设置。从后向前遍历能保证找到所有已入队的节点。</p>
<h4 data-id="heading-13">2.2.3 acquireShared(int arg) - 共享式获取</h4>
<p><strong>源码分析:</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">acquireShared</span><span class="hljs-params">(<span class="hljs-type">int</span> arg)</span> {
    <span class="hljs-keyword">if</span> (tryAcquireShared(arg) &lt; <span class="hljs-number">0</span>)  <span class="hljs-comment">// 返回值:负数-失败,0-成功但无剩余,正数-成功且有剩余</span>
        doAcquireShared(arg);
}

<span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">doAcquireShared</span><span class="hljs-params">(<span class="hljs-type">int</span> arg)</span> {
    <span class="hljs-keyword">final</span> <span class="hljs-type">Node</span> <span class="hljs-variable">node</span> <span class="hljs-operator">=</span> addWaiter(Node.SHARED);  <span class="hljs-comment">// 共享模式节点</span>
    <span class="hljs-type">boolean</span> <span class="hljs-variable">failed</span> <span class="hljs-operator">=</span> <span class="hljs-literal">true</span>;
    <span class="hljs-keyword">try</span> {
        <span class="hljs-type">boolean</span> <span class="hljs-variable">interrupted</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>;
        <span class="hljs-keyword">for</span> (;;) {
            <span class="hljs-keyword">final</span> <span class="hljs-type">Node</span> <span class="hljs-variable">p</span> <span class="hljs-operator">=</span> node.predecessor();
            <span class="hljs-keyword">if</span> (p == head) {
                <span class="hljs-type">int</span> <span class="hljs-variable">r</span> <span class="hljs-operator">=</span> tryAcquireShared(arg);
                <span class="hljs-keyword">if</span> (r &gt;= <span class="hljs-number">0</span>) {
                    setHeadAndPropagate(node, r);  <span class="hljs-comment">// 关键:传播唤醒</span>
                    p.next = <span class="hljs-literal">null</span>;
                    <span class="hljs-keyword">if</span> (interrupted)
                        selfInterrupt();
                    failed = <span class="hljs-literal">false</span>;
                    <span class="hljs-keyword">return</span>;
                }
            }
            <span class="hljs-keyword">if</span> (shouldParkAfterFailedAcquire(p, node) &amp;&amp;
                parkAndCheckInterrupt())
                interrupted = <span class="hljs-literal">true</span>;
        }
    } <span class="hljs-keyword">finally</span> {
        <span class="hljs-keyword">if</span> (failed)
            cancelAcquire(node);
    }
}

<span class="hljs-comment">// 共享模式的核心:传播唤醒</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setHeadAndPropagate</span><span class="hljs-params">(Node node, <span class="hljs-type">int</span> propagate)</span> {
    <span class="hljs-type">Node</span> <span class="hljs-variable">h</span> <span class="hljs-operator">=</span> head;
    setHead(node);

    <span class="hljs-comment">// propagate &gt; 0表示还有剩余资源,继续唤醒后继</span>
    <span class="hljs-keyword">if</span> (propagate &gt; <span class="hljs-number">0</span> || h == <span class="hljs-literal">null</span> || h.waitStatus &lt; <span class="hljs-number">0</span> ||
        (h = head) == <span class="hljs-literal">null</span> || h.waitStatus &lt; <span class="hljs-number">0</span>) {
        <span class="hljs-type">Node</span> <span class="hljs-variable">s</span> <span class="hljs-operator">=</span> node.next;
        <span class="hljs-keyword">if</span> (s == <span class="hljs-literal">null</span> || s.isShared())
            doReleaseShared();  <span class="hljs-comment">// 释放共享锁,唤醒后继</span>
    }
}
</code></pre>
<p><strong>共享模式与独占模式的关键区别:</strong></p>
<ul>
<li>独占: 只唤醒一个后继,后继成为新head</li>
<li>共享: 唤醒后继,后继继续唤醒下一个,形成<strong>传播链</strong></li>
</ul>
<h4 data-id="heading-14">2.2.4 条件队列(Condition)</h4>
<p><strong>ConditionObject实现原理:</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ConditionObject</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Condition</span> {
    <span class="hljs-comment">// 条件队列头尾指针(单向链表)</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">transient</span> Node firstWaiter;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">transient</span> Node lastWaiter;

    <span class="hljs-comment">// await - 释放锁,加入条件队列,等待signal</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">await</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> InterruptedException {
        <span class="hljs-keyword">if</span> (Thread.interrupted())
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InterruptedException</span>();

        <span class="hljs-type">Node</span> <span class="hljs-variable">node</span> <span class="hljs-operator">=</span> addConditionWaiter();    <span class="hljs-comment">// ①加入条件队列</span>
        <span class="hljs-type">int</span> <span class="hljs-variable">savedState</span> <span class="hljs-operator">=</span> fullyRelease(node); <span class="hljs-comment">// ②完全释放锁</span>
        <span class="hljs-type">int</span> <span class="hljs-variable">interruptMode</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;

        <span class="hljs-comment">// ③不在同步队列中则阻塞</span>
        <span class="hljs-keyword">while</span> (!isOnSyncQueue(node)) {
            LockSupport.park(<span class="hljs-built_in">this</span>);
            <span class="hljs-keyword">if</span> ((interruptMode = checkInterruptWhileWaiting(node)) != <span class="hljs-number">0</span>)
                <span class="hljs-keyword">break</span>;
        }

        <span class="hljs-comment">// ④被signal后,重新竞争锁</span>
        <span class="hljs-keyword">if</span> (acquireQueued(node, savedState) &amp;&amp; interruptMode != THROW_IE)
            interruptMode = REINTERRUPT;

        <span class="hljs-keyword">if</span> (node.nextWaiter != <span class="hljs-literal">null</span>)
            unlinkCancelledWaiters();  <span class="hljs-comment">// 清理取消节点</span>

        <span class="hljs-keyword">if</span> (interruptMode != <span class="hljs-number">0</span>)
            reportInterruptAfterWait(interruptMode);
    }

    <span class="hljs-comment">// signal - 将条件队列头节点转移到同步队列</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">signal</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">if</span> (!isHeldExclusively())
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalMonitorStateException</span>();

        <span class="hljs-type">Node</span> <span class="hljs-variable">first</span> <span class="hljs-operator">=</span> firstWaiter;
        <span class="hljs-keyword">if</span> (first != <span class="hljs-literal">null</span>)
            doSignal(first);  <span class="hljs-comment">// 转移到同步队列</span>
    }

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">doSignal</span><span class="hljs-params">(Node first)</span> {
        <span class="hljs-keyword">do</span> {
            <span class="hljs-keyword">if</span> ((firstWaiter = first.nextWaiter) == <span class="hljs-literal">null</span>)
                lastWaiter = <span class="hljs-literal">null</span>;
            first.nextWaiter = <span class="hljs-literal">null</span>;
        } <span class="hljs-keyword">while</span> (!transferForSignal(first) &amp;&amp;  <span class="hljs-comment">// 转移节点</span>
                 (first = firstWaiter) != <span class="hljs-literal">null</span>);
    }
}

<span class="hljs-comment">// 将节点从条件队列转移到同步队列</span>
<span class="hljs-keyword">final</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">transferForSignal</span><span class="hljs-params">(Node node)</span> {
    <span class="hljs-comment">// CAS修改状态从CONDITION到0</span>
    <span class="hljs-keyword">if</span> (!compareAndSetWaitStatus(node, Node.CONDITION, <span class="hljs-number">0</span>))
        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;

    <span class="hljs-comment">// 加入同步队列</span>
    <span class="hljs-type">Node</span> <span class="hljs-variable">p</span> <span class="hljs-operator">=</span> enq(node);
    <span class="hljs-type">int</span> <span class="hljs-variable">ws</span> <span class="hljs-operator">=</span> p.waitStatus;

    <span class="hljs-comment">// 如果前驱已取消或设置SIGNAL失败,直接唤醒</span>
    <span class="hljs-keyword">if</span> (ws &gt; <span class="hljs-number">0</span> || !compareAndSetWaitStatus(p, ws, Node.SIGNAL))
        LockSupport.unpark(node.thread);
    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
}
</code></pre>
<p><strong>条件队列 vs 同步队列:</strong></p>



































<table><thead><tr><th>维度</th><th>条件队列</th><th>同步队列</th></tr></thead><tbody><tr><td>数据结构</td><td>单向链表</td><td>双向链表</td></tr><tr><td>节点状态</td><td>CONDITION(-2)</td><td>SIGNAL(-1)等</td></tr><tr><td>触发条件</td><td>await()主动进入</td><td>锁竞争失败进入</td></tr><tr><td>退出条件</td><td>signal()唤醒</td><td>前驱释放锁</td></tr><tr><td>多条件支持</td><td>一个Lock多个Condition</td><td>一个同步队列</td></tr></tbody></table>
<p><strong>Condition使用场景:</strong></p>
<p>生产者-消费者模式:</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">class</span> <span class="hljs-title class_">BoundedBuffer</span> {
    <span class="hljs-keyword">final</span> <span class="hljs-type">Lock</span> <span class="hljs-variable">lock</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ReentrantLock</span>();
    <span class="hljs-keyword">final</span> <span class="hljs-type">Condition</span> <span class="hljs-variable">notFull</span>  <span class="hljs-operator">=</span> lock.newCondition();  <span class="hljs-comment">// 非满条件</span>
    <span class="hljs-keyword">final</span> <span class="hljs-type">Condition</span> <span class="hljs-variable">notEmpty</span> <span class="hljs-operator">=</span> lock.newCondition();  <span class="hljs-comment">// 非空条件</span>

    <span class="hljs-keyword">final</span> Object[] items = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[<span class="hljs-number">100</span>];
    <span class="hljs-type">int</span> putptr, takeptr, count;

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">put</span><span class="hljs-params">(Object x)</span> <span class="hljs-keyword">throws</span> InterruptedException {
        lock.lock();
        <span class="hljs-keyword">try</span> {
            <span class="hljs-keyword">while</span> (count == items.length)
                notFull.await();  <span class="hljs-comment">// 队列满,等待notFull信号</span>

            items[putptr] = x;
            <span class="hljs-keyword">if</span> (++putptr == items.length) putptr = <span class="hljs-number">0</span>;
            ++count;
            notEmpty.signal();  <span class="hljs-comment">// 通知消费者</span>
        } <span class="hljs-keyword">finally</span> {
            lock.unlock();
        }
    }

    <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">take</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> InterruptedException {
        lock.lock();
        <span class="hljs-keyword">try</span> {
            <span class="hljs-keyword">while</span> (count == <span class="hljs-number">0</span>)
                notEmpty.await();  <span class="hljs-comment">// 队列空,等待notEmpty信号</span>

            <span class="hljs-type">Object</span> <span class="hljs-variable">x</span> <span class="hljs-operator">=</span> items[takeptr];
            <span class="hljs-keyword">if</span> (++takeptr == items.length) takeptr = <span class="hljs-number">0</span>;
            --count;
            notFull.signal();  <span class="hljs-comment">// 通知生产者</span>
            <span class="hljs-keyword">return</span> x;
        } <span class="hljs-keyword">finally</span> {
            lock.unlock();
        }
    }
}
</code></pre>
<h3 data-id="heading-15">2.3 ReentrantLock vs synchronized深度对比</h3>
<h4 data-id="heading-16">2.3.1 功能对比</h4>























































<table><thead><tr><th>功能</th><th>synchronized</th><th>ReentrantLock</th></tr></thead><tbody><tr><td>可重入性</td><td>✅支持</td><td>✅支持</td></tr><tr><td>公平性选择</td><td>❌不支持(非公平)</td><td>✅支持公平/非公平</td></tr><tr><td>可中断获取</td><td>❌不支持</td><td>✅lockInterruptibly()</td></tr><tr><td>超时获取</td><td>❌不支持</td><td>✅tryLock(timeout)</td></tr><tr><td>非阻塞获取</td><td>❌不支持</td><td>✅tryLock()</td></tr><tr><td>条件变量</td><td>❌只有一个(wait/notify)</td><td>✅多个Condition</td></tr><tr><td>锁绑定</td><td>❌绑定对象</td><td>✅可绑定任意对象</td></tr><tr><td>自动释放</td><td>✅JVM自动</td><td>❌需手动unlock</td></tr><tr><td>死锁检测</td><td>✅JVM支持</td><td>❌需自行实现</td></tr></tbody></table>
<p><strong>代码示例对比:</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// synchronized - 简洁但功能受限</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">synchronized</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">method</span><span class="hljs-params">()</span> {
    <span class="hljs-comment">// 业务逻辑</span>
}

<span class="hljs-comment">// ReentrantLock - 灵活但需手动管理</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">ReentrantLock</span> <span class="hljs-variable">lock</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ReentrantLock</span>(<span class="hljs-literal">true</span>);  <span class="hljs-comment">// 公平锁</span>

<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">method</span><span class="hljs-params">()</span> {
    lock.lock();
    <span class="hljs-keyword">try</span> {
        <span class="hljs-comment">// 业务逻辑</span>
    } <span class="hljs-keyword">finally</span> {
        lock.unlock();  <span class="hljs-comment">// 必须在finally中释放</span>
    }
}

<span class="hljs-comment">// 可中断获取</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">methodWithInterrupt</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> InterruptedException {
    lock.lockInterruptibly();
    <span class="hljs-keyword">try</span> {
        <span class="hljs-comment">// 长时间操作</span>
    } <span class="hljs-keyword">finally</span> {
        lock.unlock();
    }
}

<span class="hljs-comment">// 超时获取</span>
<span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">methodWithTimeout</span><span class="hljs-params">()</span> {
    <span class="hljs-keyword">if</span> (lock.tryLock(<span class="hljs-number">3</span>, TimeUnit.SECONDS)) {
        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// 业务逻辑</span>
            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
        } <span class="hljs-keyword">finally</span> {
            lock.unlock();
        }
    }
    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;  <span class="hljs-comment">// 获取锁超时</span>
}
</code></pre>
<h4 data-id="heading-17">2.3.2 性能对比</h4>
<p><strong>JDK 1.6之前:</strong></p>
<ul>
<li>synchronized是重量级锁,完全依赖操作系统互斥量</li>
<li>ReentrantLock完全在用户态实现,性能明显优于synchronized</li>
</ul>
<p><strong>JDK 1.6之后(锁优化):</strong></p>
<ul>
<li>synchronized引入偏向锁、轻量级锁、自旋锁等优化</li>
<li>低竞争场景下,synchronized性能与ReentrantLock相当甚至更好</li>
</ul>
<p><strong>性能测试(JDK 17):</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@BenchmarkMode(Mode.Throughput)</span>
<span class="hljs-meta">@Warmup(iterations = 3)</span>
<span class="hljs-meta">@Measurement(iterations = 5)</span>
<span class="hljs-meta">@State(Scope.Benchmark)</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">LockBenchmark</span> {

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Object</span> <span class="hljs-variable">syncLock</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>();
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">ReentrantLock</span> <span class="hljs-variable">reentrantLock</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ReentrantLock</span>();
    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> <span class="hljs-variable">count</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;

    <span class="hljs-comment">// 低竞争场景(1线程)</span>
    <span class="hljs-meta">@Benchmark</span>
    <span class="hljs-meta">@Threads(1)</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">synchronizedLowContention</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">synchronized</span> (syncLock) {
            count++;
        }
    }

    <span class="hljs-meta">@Benchmark</span>
    <span class="hljs-meta">@Threads(1)</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">reentrantLockLowContention</span><span class="hljs-params">()</span> {
        reentrantLock.lock();
        <span class="hljs-keyword">try</span> {
            count++;
        } <span class="hljs-keyword">finally</span> {
            reentrantLock.unlock();
        }
    }

    <span class="hljs-comment">// 高竞争场景(16线程)</span>
    <span class="hljs-meta">@Benchmark</span>
    <span class="hljs-meta">@Threads(16)</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">synchronizedHighContention</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">synchronized</span> (syncLock) {
            count++;
        }
    }

    <span class="hljs-meta">@Benchmark</span>
    <span class="hljs-meta">@Threads(16)</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">reentrantLockHighContention</span><span class="hljs-params">()</span> {
        reentrantLock.lock();
        <span class="hljs-keyword">try</span> {
            count++;
        } <span class="hljs-keyword">finally</span> {
            reentrantLock.unlock();
        }
    }
}
</code></pre>
<p><strong>测试结果(ops/s,越高越好):</strong></p>























<table><thead><tr><th>场景</th><th>synchronized</th><th>ReentrantLock(非公平)</th><th>ReentrantLock(公平)</th></tr></thead><tbody><tr><td>低竞争(1线程)</td><td>120M</td><td>115M</td><td>110M</td></tr><tr><td>高竞争(16线程)</td><td>8M</td><td>12M</td><td>6M</td></tr></tbody></table>
<p><strong>结论:</strong></p>
<ul>
<li><strong>低竞争</strong>: synchronized略优(JVM优化好)</li>
<li><strong>高竞争</strong>: ReentrantLock非公平模式最优</li>
<li><strong>公平锁</strong>: 性能明显下降(需维护FIFO顺序)</li>
</ul>
<h4 data-id="heading-18">2.3.3 使用场景选择</h4>
<p><strong>选择synchronized的场景:</strong></p>
<ul>
<li>✅ 简单的互斥访问</li>
<li>✅ 不需要高级特性(中断、超时、公平性)</li>
<li>✅ 代码简洁性优先</li>
<li>✅ 兼容旧代码</li>
</ul>
<p><strong>选择ReentrantLock的场景:</strong></p>
<ul>
<li>✅ 需要公平锁(避免线程饥饿)</li>
<li>✅ 需要可中断获取(如超时取消)</li>
<li>✅ 需要尝试获取(tryLock)</li>
<li>✅ 需要多个条件变量(复杂等待通知)</li>
<li>✅ 需要锁投票、定时、可中断的锁获取</li>
</ul>
<p><strong>决策树:</strong></p>
<pre><code class="hljs language-arduino" lang="arduino">需要高级特性?
├─ 是 → ReentrantLock
│   ├─ 需要公平性? → <span class="hljs-keyword">new</span> <span class="hljs-built_in">ReentrantLock</span>(<span class="hljs-literal">true</span>)
│   └─ 性能优先? → <span class="hljs-keyword">new</span> <span class="hljs-built_in">ReentrantLock</span>(<span class="hljs-literal">false</span>)
└─ 否 → <span class="hljs-keyword">synchronized</span>
</code></pre>
<h3 data-id="heading-19">2.4 其他AQS同步工具实现原理</h3>
<h4 data-id="heading-20">2.4.1 CountDownLatch - 倒计数门闩</h4>
<p><strong>实现原理:</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CountDownLatch</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Sync</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AbstractQueuedSynchronizer</span> {
        Sync(<span class="hljs-type">int</span> count) {
            setState(count);  <span class="hljs-comment">// state=倒计数初始值</span>
        }

        <span class="hljs-comment">// 共享式获取:state=0时成功</span>
        <span class="hljs-keyword">protected</span> <span class="hljs-type">int</span> <span class="hljs-title function_">tryAcquireShared</span><span class="hljs-params">(<span class="hljs-type">int</span> acquires)</span> {
            <span class="hljs-keyword">return</span> (getState() == <span class="hljs-number">0</span>) ? <span class="hljs-number">1</span> : -<span class="hljs-number">1</span>;
        }

        <span class="hljs-comment">// 共享式释放:递减state</span>
        <span class="hljs-keyword">protected</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">tryReleaseShared</span><span class="hljs-params">(<span class="hljs-type">int</span> releases)</span> {
            <span class="hljs-keyword">for</span> (;;) {
                <span class="hljs-type">int</span> <span class="hljs-variable">c</span> <span class="hljs-operator">=</span> getState();
                <span class="hljs-keyword">if</span> (c == <span class="hljs-number">0</span>)
                    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;  <span class="hljs-comment">// 已经为0,无需释放</span>

                <span class="hljs-type">int</span> <span class="hljs-variable">nextc</span> <span class="hljs-operator">=</span> c - <span class="hljs-number">1</span>;
                <span class="hljs-keyword">if</span> (compareAndSetState(c, nextc))
                    <span class="hljs-keyword">return</span> nextc == <span class="hljs-number">0</span>;  <span class="hljs-comment">// 减到0时返回true,触发唤醒</span>
            }
        }
    }

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Sync sync;

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">CountDownLatch</span><span class="hljs-params">(<span class="hljs-type">int</span> count)</span> {
        <span class="hljs-keyword">if</span> (count &lt; <span class="hljs-number">0</span>) <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalArgumentException</span>(<span class="hljs-string">"count &lt; 0"</span>);
        <span class="hljs-built_in">this</span>.sync = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Sync</span>(count);
    }

    <span class="hljs-comment">// 等待state减到0</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">await</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> InterruptedException {
        sync.acquireSharedInterruptibly(<span class="hljs-number">1</span>);
    }

    <span class="hljs-comment">// 递减state</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">countDown</span><span class="hljs-params">()</span> {
        sync.releaseShared(<span class="hljs-number">1</span>);
    }

    <span class="hljs-keyword">public</span> <span class="hljs-type">long</span> <span class="hljs-title function_">getCount</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> sync.getState();
    }
}
</code></pre>
<p><strong>关键点:</strong></p>
<ul>
<li>state表示倒计数值</li>
<li><code>await()</code>在state&gt;0时阻塞,state=0时所有线程一起被唤醒</li>
<li><code>countDown()</code>每次递减state,减到0时唤醒所有等待线程</li>
<li><strong>一次性使用</strong>: state减到0后无法重置</li>
</ul>
<h4 data-id="heading-21">2.4.2 CyclicBarrier - 循环屏障</h4>
<p><strong>实现原理(基于ReentrantLock + Condition):</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CyclicBarrier</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">ReentrantLock</span> <span class="hljs-variable">lock</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ReentrantLock</span>();
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Condition</span> <span class="hljs-variable">trip</span> <span class="hljs-operator">=</span> lock.newCondition();
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> parties;        <span class="hljs-comment">// 参与线程数</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Runnable barrierCommand;  <span class="hljs-comment">// 屏障动作</span>
    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> count;                <span class="hljs-comment">// 剩余等待数</span>

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Generation</span> {
        <span class="hljs-type">boolean</span> <span class="hljs-variable">broken</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>;       <span class="hljs-comment">// 屏障是否被破坏</span>
    }
    <span class="hljs-keyword">private</span> <span class="hljs-type">Generation</span> <span class="hljs-variable">generation</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Generation</span>();

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">CyclicBarrier</span><span class="hljs-params">(<span class="hljs-type">int</span> parties, Runnable barrierAction)</span> {
        <span class="hljs-keyword">if</span> (parties &lt;= <span class="hljs-number">0</span>) <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalArgumentException</span>();
        <span class="hljs-built_in">this</span>.parties = parties;
        <span class="hljs-built_in">this</span>.count = parties;
        <span class="hljs-built_in">this</span>.barrierCommand = barrierAction;
    }

    <span class="hljs-comment">// 到达屏障点并等待</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">await</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> InterruptedException, BrokenBarrierException {
        <span class="hljs-keyword">final</span> <span class="hljs-type">ReentrantLock</span> <span class="hljs-variable">lock</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.lock;
        lock.lock();
        <span class="hljs-keyword">try</span> {
            <span class="hljs-keyword">final</span> <span class="hljs-type">Generation</span> <span class="hljs-variable">g</span> <span class="hljs-operator">=</span> generation;

            <span class="hljs-keyword">if</span> (g.broken)
                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BrokenBarrierException</span>();

            <span class="hljs-keyword">if</span> (Thread.interrupted()) {
                breakBarrier();
                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InterruptedException</span>();
            }

            <span class="hljs-type">int</span> <span class="hljs-variable">index</span> <span class="hljs-operator">=</span> --count;
            <span class="hljs-keyword">if</span> (index == <span class="hljs-number">0</span>) {  <span class="hljs-comment">// 最后一个到达</span>
                <span class="hljs-type">boolean</span> <span class="hljs-variable">ranAction</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>;
                <span class="hljs-keyword">try</span> {
                    <span class="hljs-keyword">final</span> <span class="hljs-type">Runnable</span> <span class="hljs-variable">command</span> <span class="hljs-operator">=</span> barrierCommand;
                    <span class="hljs-keyword">if</span> (command != <span class="hljs-literal">null</span>)
                        command.run();  <span class="hljs-comment">// 执行屏障动作</span>
                    ranAction = <span class="hljs-literal">true</span>;
                    nextGeneration();   <span class="hljs-comment">// 开启下一代</span>
                    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
                } <span class="hljs-keyword">finally</span> {
                    <span class="hljs-keyword">if</span> (!ranAction)
                        breakBarrier();
                }
            }

            <span class="hljs-comment">// 不是最后一个,循环等待</span>
            <span class="hljs-keyword">for</span> (;;) {
                <span class="hljs-keyword">try</span> {
                    trip.await();  <span class="hljs-comment">// 等待signal</span>
                    <span class="hljs-keyword">break</span>;
                } <span class="hljs-keyword">catch</span> (InterruptedException ie) {
                    <span class="hljs-keyword">if</span> (g == generation &amp;&amp; !g.broken) {
                        breakBarrier();
                        <span class="hljs-keyword">throw</span> ie;
                    } <span class="hljs-keyword">else</span> {
                        Thread.currentThread().interrupt();
                    }
                }

                <span class="hljs-keyword">if</span> (g.broken)
                    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BrokenBarrierException</span>();

                <span class="hljs-keyword">if</span> (g != generation)
                    <span class="hljs-keyword">return</span> index;
            }
        } <span class="hljs-keyword">finally</span> {
            lock.unlock();
        }
    }

    <span class="hljs-comment">// 开启下一代(重置count,唤醒所有等待线程)</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">nextGeneration</span><span class="hljs-params">()</span> {
        trip.signalAll();
        count = parties;
        generation = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Generation</span>();
    }
}
</code></pre>
<p><strong>CountDownLatch vs CyclicBarrier:</strong></p>








































<table><thead><tr><th>维度</th><th>CountDownLatch</th><th>CyclicBarrier</th></tr></thead><tbody><tr><td>底层实现</td><td>AQS共享模式</td><td>ReentrantLock + Condition</td></tr><tr><td>可重用性</td><td>❌一次性</td><td>✅可重置</td></tr><tr><td>等待角色</td><td>一组等一组</td><td>互相等待</td></tr><tr><td>计数方向</td><td>递减到0</td><td>递增到N</td></tr><tr><td>屏障动作</td><td>❌不支持</td><td>✅支持barrierAction</td></tr><tr><td>典型场景</td><td>主线程等所有子线程完成</td><td>多线程互相等待同步点</td></tr></tbody></table>
<h4 data-id="heading-22">2.4.3 Semaphore - 信号量</h4>
<p><strong>实现原理:</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Semaphore</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">java</span>.io.Serializable {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Sync sync;

    <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Sync</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AbstractQueuedSynchronizer</span> {
        Sync(<span class="hljs-type">int</span> <span class="hljs-keyword">permits</span>) {
            setState(<span class="hljs-keyword">permits</span>);  <span class="hljs-comment">// state=许可数</span>
        }

        <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getPermits</span><span class="hljs-params">()</span> {
            <span class="hljs-keyword">return</span> getState();
        }

        <span class="hljs-comment">// 非公平获取</span>
        <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-title function_">nonfairTryAcquireShared</span><span class="hljs-params">(<span class="hljs-type">int</span> acquires)</span> {
            <span class="hljs-keyword">for</span> (;;) {
                <span class="hljs-type">int</span> <span class="hljs-variable">available</span> <span class="hljs-operator">=</span> getState();
                <span class="hljs-type">int</span> <span class="hljs-variable">remaining</span> <span class="hljs-operator">=</span> available - acquires;
                <span class="hljs-keyword">if</span> (remaining &lt; <span class="hljs-number">0</span> ||
                    compareAndSetState(available, remaining))
                    <span class="hljs-keyword">return</span> remaining;
            }
        }

        <span class="hljs-comment">// 释放许可</span>
        <span class="hljs-keyword">protected</span> <span class="hljs-keyword">final</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">tryReleaseShared</span><span class="hljs-params">(<span class="hljs-type">int</span> releases)</span> {
            <span class="hljs-keyword">for</span> (;;) {
                <span class="hljs-type">int</span> <span class="hljs-variable">current</span> <span class="hljs-operator">=</span> getState();
                <span class="hljs-type">int</span> <span class="hljs-variable">next</span> <span class="hljs-operator">=</span> current + releases;
                <span class="hljs-keyword">if</span> (next &lt; current)  <span class="hljs-comment">// 溢出检查</span>
                    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">"Maximum permit count exceeded"</span>);
                <span class="hljs-keyword">if</span> (compareAndSetState(current, next))
                    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
            }
        }
    }

    <span class="hljs-comment">// 非公平版本</span>
    <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">NonfairSync</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Sync</span> {
        NonfairSync(<span class="hljs-type">int</span> <span class="hljs-keyword">permits</span>) {
            <span class="hljs-built_in">super</span>(<span class="hljs-keyword">permits</span>);
        }

        <span class="hljs-keyword">protected</span> <span class="hljs-type">int</span> <span class="hljs-title function_">tryAcquireShared</span><span class="hljs-params">(<span class="hljs-type">int</span> acquires)</span> {
            <span class="hljs-keyword">return</span> nonfairTryAcquireShared(acquires);
        }
    }

    <span class="hljs-comment">// 公平版本</span>
    <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">FairSync</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Sync</span> {
        FairSync(<span class="hljs-type">int</span> <span class="hljs-keyword">permits</span>) {
            <span class="hljs-built_in">super</span>(<span class="hljs-keyword">permits</span>);
        }

        <span class="hljs-keyword">protected</span> <span class="hljs-type">int</span> <span class="hljs-title function_">tryAcquireShared</span><span class="hljs-params">(<span class="hljs-type">int</span> acquires)</span> {
            <span class="hljs-keyword">for</span> (;;) {
                <span class="hljs-comment">// 公平性:检查队列中是否有等待线程</span>
                <span class="hljs-keyword">if</span> (hasQueuedPredecessors())
                    <span class="hljs-keyword">return</span> -<span class="hljs-number">1</span>;

                <span class="hljs-type">int</span> <span class="hljs-variable">available</span> <span class="hljs-operator">=</span> getState();
                <span class="hljs-type">int</span> <span class="hljs-variable">remaining</span> <span class="hljs-operator">=</span> available - acquires;
                <span class="hljs-keyword">if</span> (remaining &lt; <span class="hljs-number">0</span> ||
                    compareAndSetState(available, remaining))
                    <span class="hljs-keyword">return</span> remaining;
            }
        }
    }

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">Semaphore</span><span class="hljs-params">(<span class="hljs-type">int</span> <span class="hljs-keyword">permits</span>, <span class="hljs-type">boolean</span> fair)</span> {
        sync = fair ? <span class="hljs-keyword">new</span> <span class="hljs-title class_">FairSync</span>(<span class="hljs-keyword">permits</span>) : <span class="hljs-keyword">new</span> <span class="hljs-title class_">NonfairSync</span>(<span class="hljs-keyword">permits</span>);
    }

    <span class="hljs-comment">// 获取许可</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">acquire</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> InterruptedException {
        sync.acquireSharedInterruptibly(<span class="hljs-number">1</span>);
    }

    <span class="hljs-comment">// 释放许可</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">release</span><span class="hljs-params">()</span> {
        sync.releaseShared(<span class="hljs-number">1</span>);
    }
}
</code></pre>
<p><strong>应用场景:</strong></p>
<ul>
<li>限流(控制并发访问数)</li>
<li>资源池(数据库连接池、线程池)</li>
</ul>
<h4 data-id="heading-23">2.4.4 ReadWriteLock - 读写锁</h4>
<p><strong>实现原理(state的位运算):</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">abstract</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Sync</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AbstractQueuedSynchronizer</span> {
    <span class="hljs-comment">// state的位划分</span>
    <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">SHARED_SHIFT</span>   <span class="hljs-operator">=</span> <span class="hljs-number">16</span>;
    <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">SHARED_UNIT</span>    <span class="hljs-operator">=</span> (<span class="hljs-number">1</span> &lt;&lt; SHARED_SHIFT);  <span class="hljs-comment">// 65536</span>
    <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">MAX_COUNT</span>      <span class="hljs-operator">=</span> (<span class="hljs-number">1</span> &lt;&lt; SHARED_SHIFT) - <span class="hljs-number">1</span>;  <span class="hljs-comment">// 65535</span>
    <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">EXCLUSIVE_MASK</span> <span class="hljs-operator">=</span> (<span class="hljs-number">1</span> &lt;&lt; SHARED_SHIFT) - <span class="hljs-number">1</span>;  <span class="hljs-comment">// 低16位掩码</span>

    <span class="hljs-comment">// 读锁计数(高16位)</span>
    <span class="hljs-keyword">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">sharedCount</span><span class="hljs-params">(<span class="hljs-type">int</span> c)</span>    { <span class="hljs-keyword">return</span> c &gt;&gt;&gt; SHARED_SHIFT; }

    <span class="hljs-comment">// 写锁计数(低16位)</span>
    <span class="hljs-keyword">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">exclusiveCount</span><span class="hljs-params">(<span class="hljs-type">int</span> c)</span> { <span class="hljs-keyword">return</span> c &amp; EXCLUSIVE_MASK; }

    <span class="hljs-comment">// 获取写锁</span>
    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">final</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">tryAcquire</span><span class="hljs-params">(<span class="hljs-type">int</span> acquires)</span> {
        <span class="hljs-type">Thread</span> <span class="hljs-variable">current</span> <span class="hljs-operator">=</span> Thread.currentThread();
        <span class="hljs-type">int</span> <span class="hljs-variable">c</span> <span class="hljs-operator">=</span> getState();
        <span class="hljs-type">int</span> <span class="hljs-variable">w</span> <span class="hljs-operator">=</span> exclusiveCount(c);  <span class="hljs-comment">// 写锁数</span>

        <span class="hljs-keyword">if</span> (c != <span class="hljs-number">0</span>) {
            <span class="hljs-comment">// state!=0,存在读锁或写锁</span>
            <span class="hljs-keyword">if</span> (w == <span class="hljs-number">0</span> || current != getExclusiveOwnerThread())
                <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;  <span class="hljs-comment">// 存在读锁或其他线程持有写锁</span>

            <span class="hljs-keyword">if</span> (w + exclusiveCount(acquires) &gt; MAX_COUNT)
                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">"Maximum lock count exceeded"</span>);

            setState(c + acquires);  <span class="hljs-comment">// 重入</span>
            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
        }

        <span class="hljs-keyword">if</span> (writerShouldBlock() ||
            !compareAndSetState(c, c + acquires))
            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;

        setExclusiveOwnerThread(current);
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    }

    <span class="hljs-comment">// 获取读锁</span>
    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-title function_">tryAcquireShared</span><span class="hljs-params">(<span class="hljs-type">int</span> acquires)</span> {
        <span class="hljs-type">Thread</span> <span class="hljs-variable">current</span> <span class="hljs-operator">=</span> Thread.currentThread();
        <span class="hljs-type">int</span> <span class="hljs-variable">c</span> <span class="hljs-operator">=</span> getState();

        <span class="hljs-comment">// 存在写锁且不是当前线程持有</span>
        <span class="hljs-keyword">if</span> (exclusiveCount(c) != <span class="hljs-number">0</span> &amp;&amp;
            getExclusiveOwnerThread() != current)
            <span class="hljs-keyword">return</span> -<span class="hljs-number">1</span>;

        <span class="hljs-type">int</span> <span class="hljs-variable">r</span> <span class="hljs-operator">=</span> sharedCount(c);
        <span class="hljs-keyword">if</span> (!readerShouldBlock() &amp;&amp;
            r &lt; MAX_COUNT &amp;&amp;
            compareAndSetState(c, c + SHARED_UNIT)) {  <span class="hljs-comment">// 高16位+1</span>

            <span class="hljs-keyword">if</span> (r == <span class="hljs-number">0</span>) {
                firstReader = current;
                firstReaderHoldCount = <span class="hljs-number">1</span>;
            } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (firstReader == current) {
                firstReaderHoldCount++;
            } <span class="hljs-keyword">else</span> {
                <span class="hljs-comment">// 使用ThreadLocal记录每个线程的读锁重入次数</span>
                <span class="hljs-type">HoldCounter</span> <span class="hljs-variable">rh</span> <span class="hljs-operator">=</span> cachedHoldCounter;
                <span class="hljs-keyword">if</span> (rh == <span class="hljs-literal">null</span> || rh.tid != getThreadId(current))
                    cachedHoldCounter = rh = readHolds.get();
                <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (rh.count == <span class="hljs-number">0</span>)
                    readHolds.set(rh);
                rh.count++;
            }
            <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;
        }

        <span class="hljs-keyword">return</span> fullTryAcquireShared(current);
    }
}
</code></pre>
<p><strong>锁降级机制:</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 正确的锁降级示例</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">CachedData</span> {
    Object data;
    <span class="hljs-keyword">volatile</span> <span class="hljs-type">boolean</span> cacheValid;
    <span class="hljs-keyword">final</span> <span class="hljs-type">ReentrantReadWriteLock</span> <span class="hljs-variable">rwl</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ReentrantReadWriteLock</span>();

    <span class="hljs-keyword">void</span> <span class="hljs-title function_">processCachedData</span><span class="hljs-params">()</span> {
        rwl.readLock().lock();
        <span class="hljs-keyword">if</span> (!cacheValid) {
            <span class="hljs-comment">// 需要更新缓存</span>
            rwl.readLock().unlock();  <span class="hljs-comment">// ①释放读锁</span>
            rwl.writeLock().lock();   <span class="hljs-comment">// ②获取写锁</span>
            <span class="hljs-keyword">try</span> {
                <span class="hljs-comment">// 再次检查(其他线程可能已更新)</span>
                <span class="hljs-keyword">if</span> (!cacheValid) {
                    data = loadData();
                    cacheValid = <span class="hljs-literal">true</span>;
                }

                <span class="hljs-comment">// ③锁降级:在持有写锁的情况下获取读锁</span>
                rwl.readLock().lock();
            } <span class="hljs-keyword">finally</span> {
                rwl.writeLock().unlock();  <span class="hljs-comment">// ④释放写锁</span>
            }
        }

        <span class="hljs-keyword">try</span> {
            use(data);
        } <span class="hljs-keyword">finally</span> {
            rwl.readLock().unlock();  <span class="hljs-comment">// ⑤释放读锁</span>
        }
    }
}
</code></pre>
<p><strong>为什么没有锁升级?</strong></p>
<p>锁升级(读锁→写锁)会导致死锁:</p>
<pre><code class="hljs language-makefile" lang="makefile"><span class="hljs-section">线程A: 持有读锁 → 想升级为写锁 → 等待其他读锁释放</span>
<span class="hljs-section">线程B: 持有读锁 → 想升级为写锁 → 等待其他读锁释放</span>
→ 死锁!
</code></pre>
<p>锁降级(写锁→读锁)是安全的:</p>
<pre><code class="hljs language-css" lang="css">线程<span class="hljs-selector-tag">A</span>: 持有写锁 → 获取读锁 → 释放写锁
此时无其他线程持有任何锁,不会死锁
</code></pre>
<hr/>
<h2 data-id="heading-24">三、实战场景应用</h2>
<h3 data-id="heading-25">3.1 场景1: 分布式任务协调中的CountDownLatch应用</h3>
<h4 data-id="heading-26">业务背景</h4>
<p>电商平台需要批量导入订单数据,每批次1000个订单。为提高效率,采用多线程并行导入:</p>
<ul>
<li>将1000个订单分成10组,每组100个</li>
<li>10个线程并行导入</li>
<li>主线程需要等待所有子线程完成后,汇总导入结果并发送通知</li>
</ul>
<h4 data-id="heading-27">方案设计</h4>
<p>使用<code>CountDownLatch</code>实现主线程等待:</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4f84c1a6010c43e2a08482a69cb32605~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54Sh6YeP:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766817638&amp;x-signature=nGYvSUPm%2FybNvRl3WTHIMhuUlF0%3D" alt="countdownlatch-scenario.svg" loading="lazy"/></p>
<h4 data-id="heading-28">完整代码实现</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">/**
 * 订单批量导入服务
 */</span>
<span class="hljs-meta">@Service</span>
<span class="hljs-meta">@Slf4j</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderBatchImportService</span> {

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> OrderRepository orderRepository;

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> NotificationService notificationService;

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">ExecutorService</span> <span class="hljs-variable">executor</span> <span class="hljs-operator">=</span> Executors.newFixedThreadPool(<span class="hljs-number">10</span>);

    <span class="hljs-comment">/**
     * 批量导入订单
     * <span class="hljs-doctag">@param</span> orders 待导入订单列表
     * <span class="hljs-doctag">@return</span> 导入结果统计
     */</span>
    <span class="hljs-keyword">public</span> ImportResult <span class="hljs-title function_">batchImport</span><span class="hljs-params">(List&lt;OrderDTO&gt; orders)</span> {
        <span class="hljs-type">int</span> <span class="hljs-variable">batchSize</span> <span class="hljs-operator">=</span> <span class="hljs-number">100</span>;
        <span class="hljs-type">int</span> <span class="hljs-variable">totalBatches</span> <span class="hljs-operator">=</span> (orders.size() + batchSize - <span class="hljs-number">1</span>) / batchSize;

        <span class="hljs-comment">// ①创建CountDownLatch</span>
        <span class="hljs-type">CountDownLatch</span> <span class="hljs-variable">latch</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CountDownLatch</span>(totalBatches);

        <span class="hljs-comment">// 结果收集器(线程安全)</span>
        ConcurrentHashMap&lt;String, AtomicInteger&gt; resultMap = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConcurrentHashMap</span>&lt;&gt;();
        resultMap.put(<span class="hljs-string">"success"</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">AtomicInteger</span>(<span class="hljs-number">0</span>));
        resultMap.put(<span class="hljs-string">"failed"</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">AtomicInteger</span>(<span class="hljs-number">0</span>));

        log.info(<span class="hljs-string">"开始批量导入订单,总数:{},分{}批"</span>, orders.size(), totalBatches);

        <span class="hljs-comment">// ②提交子任务</span>
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; totalBatches; i++) {
            <span class="hljs-type">int</span> <span class="hljs-variable">fromIndex</span> <span class="hljs-operator">=</span> i * batchSize;
            <span class="hljs-type">int</span> <span class="hljs-variable">toIndex</span> <span class="hljs-operator">=</span> Math.min(fromIndex + batchSize, orders.size());
            List&lt;OrderDTO&gt; batch = orders.subList(fromIndex, toIndex);

            executor.submit(() -&gt; {
                <span class="hljs-keyword">try</span> {
                    importBatch(batch, resultMap);
                } <span class="hljs-keyword">catch</span> (Exception e) {
                    log.error(<span class="hljs-string">"批次导入失败"</span>, e);
                    resultMap.get(<span class="hljs-string">"failed"</span>).addAndGet(batch.size());
                } <span class="hljs-keyword">finally</span> {
                    latch.countDown();  <span class="hljs-comment">// ③完成后countDown</span>
                    log.info(<span class="hljs-string">"批次完成,剩余批次:{}"</span>, latch.getCount());
                }
            });
        }

        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// ④主线程等待所有子线程完成(超时30秒)</span>
            <span class="hljs-type">boolean</span> <span class="hljs-variable">finished</span> <span class="hljs-operator">=</span> latch.await(<span class="hljs-number">30</span>, TimeUnit.SECONDS);

            <span class="hljs-keyword">if</span> (!finished) {
                log.error(<span class="hljs-string">"批量导入超时,已完成批次:{}"</span>, totalBatches - latch.getCount());
                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BusinessException</span>(<span class="hljs-string">"批量导入超时"</span>);
            }

            <span class="hljs-comment">// ⑤汇总结果</span>
            <span class="hljs-type">ImportResult</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ImportResult</span>();
            result.setTotalCount(orders.size());
            result.setSuccessCount(resultMap.get(<span class="hljs-string">"success"</span>).get());
            result.setFailedCount(resultMap.get(<span class="hljs-string">"failed"</span>).get());

            log.info(<span class="hljs-string">"批量导入完成:{}"</span>, result);

            <span class="hljs-comment">// ⑥发送通知</span>
            notificationService.sendImportResult(result);

            <span class="hljs-keyword">return</span> result;

        } <span class="hljs-keyword">catch</span> (InterruptedException e) {
            Thread.currentThread().interrupt();
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BusinessException</span>(<span class="hljs-string">"批量导入被中断"</span>, e);
        }
    }

    <span class="hljs-comment">/**
     * 导入单个批次
     */</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">importBatch</span><span class="hljs-params">(List&lt;OrderDTO&gt; batch,
                           ConcurrentHashMap&lt;String, AtomicInteger&gt; resultMap)</span> {
        <span class="hljs-keyword">for</span> (OrderDTO orderDTO : batch) {
            <span class="hljs-keyword">try</span> {
                <span class="hljs-type">Order</span> <span class="hljs-variable">order</span> <span class="hljs-operator">=</span> convertToEntity(orderDTO);
                orderRepository.save(order);
                resultMap.get(<span class="hljs-string">"success"</span>).incrementAndGet();
            } <span class="hljs-keyword">catch</span> (Exception e) {
                log.error(<span class="hljs-string">"订单导入失败,orderId:{}"</span>, orderDTO.getOrderId(), e);
                resultMap.get(<span class="hljs-string">"failed"</span>).incrementAndGet();
            }
        }
    }

    <span class="hljs-meta">@Data</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ImportResult</span> {
        <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> totalCount;
        <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> successCount;
        <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> failedCount;

        <span class="hljs-keyword">public</span> <span class="hljs-type">double</span> <span class="hljs-title function_">getSuccessRate</span><span class="hljs-params">()</span> {
            <span class="hljs-keyword">return</span> totalCount == <span class="hljs-number">0</span> ? <span class="hljs-number">0</span> : (<span class="hljs-type">double</span>) successCount / totalCount * <span class="hljs-number">100</span>;
        }
    }
}
</code></pre>
<h4 data-id="heading-29">错误处理:子任务异常的兜底方案</h4>
<p><strong>问题:</strong> 如果子任务抛出异常未捕获,可能导致<code>countDown()</code>未执行,主线程永久阻塞。</p>
<p><strong>解决方案:</strong></p>
<pre><code class="hljs language-java" lang="java">executor.submit(() -&gt; {
    <span class="hljs-keyword">try</span> {
        importBatch(batch, resultMap);
    } <span class="hljs-keyword">catch</span> (Exception e) {
        log.error(<span class="hljs-string">"批次导入失败"</span>, e);
        resultMap.get(<span class="hljs-string">"failed"</span>).addAndGet(batch.size());
    } <span class="hljs-keyword">finally</span> {
        latch.countDown();  <span class="hljs-comment">// finally确保一定执行</span>
    }
});
</code></pre>
<h4 data-id="heading-30">超时控制</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 带超时的await</span>
<span class="hljs-type">boolean</span> <span class="hljs-variable">finished</span> <span class="hljs-operator">=</span> latch.await(<span class="hljs-number">30</span>, TimeUnit.SECONDS);

<span class="hljs-keyword">if</span> (!finished) {
    <span class="hljs-comment">// 超时处理</span>
    log.error(<span class="hljs-string">"部分任务未完成,已完成:{}/{}"</span>,
             totalBatches - latch.getCount(), totalBatches);

    <span class="hljs-comment">// 取消未完成的任务</span>
    executor.shutdownNow();

    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BusinessException</span>(<span class="hljs-string">"批量导入超时"</span>);
}
</code></pre>
<h3 data-id="heading-31">3.2 场景2: 使用Semaphore限流</h3>
<h4 data-id="heading-32">业务背景</h4>
<p>电商平台需要限制数据库连接池的并发访问数量:</p>
<ul>
<li>数据库最大连接数20</li>
<li>应用服务器有100个工作线程</li>
<li>需要控制同时访问数据库的线程数≤20</li>
</ul>
<h4 data-id="heading-33">方案设计</h4>
<p>使用<code>Semaphore(20)</code>限制并发:</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">/**
 * 基于Semaphore的数据库连接池
 */</span>
<span class="hljs-meta">@Slf4j</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DatabaseConnectionPool</span> {

    <span class="hljs-comment">// 实际连接池</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> BlockingQueue&lt;Connection&gt; connections;

    <span class="hljs-comment">// 信号量控制并发数</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Semaphore semaphore;

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> String jdbcUrl;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> String username;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> String password;

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">DatabaseConnectionPool</span><span class="hljs-params">(String jdbcUrl, String username, String password,
                                 <span class="hljs-type">int</span> maxConnections, <span class="hljs-type">boolean</span> fair)</span> {
        <span class="hljs-built_in">this</span>.jdbcUrl = jdbcUrl;
        <span class="hljs-built_in">this</span>.username = username;
        <span class="hljs-built_in">this</span>.password = password;
        <span class="hljs-built_in">this</span>.connections = <span class="hljs-keyword">new</span> <span class="hljs-title class_">LinkedBlockingQueue</span>&lt;&gt;(maxConnections);
        <span class="hljs-built_in">this</span>.semaphore = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Semaphore</span>(maxConnections, fair);  <span class="hljs-comment">// 公平/非公平可选</span>

        <span class="hljs-comment">// 初始化连接</span>
        initConnections(maxConnections);
    }

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">initConnections</span><span class="hljs-params">(<span class="hljs-type">int</span> count)</span> {
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; count; i++) {
            <span class="hljs-keyword">try</span> {
                <span class="hljs-type">Connection</span> <span class="hljs-variable">conn</span> <span class="hljs-operator">=</span> DriverManager.getConnection(jdbcUrl, username, password);
                connections.offer(conn);
            } <span class="hljs-keyword">catch</span> (SQLException e) {
                log.error(<span class="hljs-string">"初始化连接失败"</span>, e);
            }
        }
        log.info(<span class="hljs-string">"数据库连接池初始化完成,连接数:{}"</span>, connections.size());
    }

    <span class="hljs-comment">/**
     * 获取连接(阻塞等待)
     */</span>
    <span class="hljs-keyword">public</span> Connection <span class="hljs-title function_">getConnection</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> InterruptedException {
        <span class="hljs-comment">// ①获取许可</span>
        semaphore.acquire();

        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// ②从池中取连接</span>
            <span class="hljs-type">Connection</span> <span class="hljs-variable">conn</span> <span class="hljs-operator">=</span> connections.poll(<span class="hljs-number">10</span>, TimeUnit.SECONDS);
            <span class="hljs-keyword">if</span> (conn == <span class="hljs-literal">null</span>) {
                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">"获取连接超时"</span>);
            }

            log.debug(<span class="hljs-string">"获取连接成功,剩余许可:{}"</span>, semaphore.availablePermits());
            <span class="hljs-keyword">return</span> conn;

        } <span class="hljs-keyword">catch</span> (Exception e) {
            <span class="hljs-comment">// 异常时需要释放许可</span>
            semaphore.release();
            <span class="hljs-keyword">throw</span> e;
        }
    }

    <span class="hljs-comment">/**
     * 获取连接(超时等待)
     */</span>
    <span class="hljs-keyword">public</span> Connection <span class="hljs-title function_">getConnection</span><span class="hljs-params">(<span class="hljs-type">long</span> timeout, TimeUnit unit)</span>
            <span class="hljs-keyword">throws</span> InterruptedException, TimeoutException {

        <span class="hljs-comment">// ①尝试获取许可(超时)</span>
        <span class="hljs-keyword">if</span> (!semaphore.tryAcquire(timeout, unit)) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TimeoutException</span>(<span class="hljs-string">"获取连接超时,等待时间:"</span> + timeout + unit);
        }

        <span class="hljs-keyword">try</span> {
            <span class="hljs-type">Connection</span> <span class="hljs-variable">conn</span> <span class="hljs-operator">=</span> connections.poll(timeout, unit);
            <span class="hljs-keyword">if</span> (conn == <span class="hljs-literal">null</span>) {
                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TimeoutException</span>(<span class="hljs-string">"连接池为空"</span>);
            }
            <span class="hljs-keyword">return</span> conn;
        } <span class="hljs-keyword">catch</span> (Exception e) {
            semaphore.release();
            <span class="hljs-keyword">throw</span> e;
        }
    }

    <span class="hljs-comment">/**
     * 释放连接
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">releaseConnection</span><span class="hljs-params">(Connection conn)</span> {
        <span class="hljs-keyword">if</span> (conn != <span class="hljs-literal">null</span>) {
            <span class="hljs-keyword">try</span> {
                <span class="hljs-comment">// ①归还连接到池</span>
                <span class="hljs-keyword">if</span> (!connections.offer(conn, <span class="hljs-number">5</span>, TimeUnit.SECONDS)) {
                    log.error(<span class="hljs-string">"归还连接失败,连接池已满"</span>);
                    conn.close();  <span class="hljs-comment">// 关闭连接</span>
                }
            } <span class="hljs-keyword">catch</span> (Exception e) {
                log.error(<span class="hljs-string">"归还连接异常"</span>, e);
            } <span class="hljs-keyword">finally</span> {
                <span class="hljs-comment">// ②释放许可(必须执行)</span>
                semaphore.release();
                log.debug(<span class="hljs-string">"释放连接,剩余许可:{}"</span>, semaphore.availablePermits());
            }
        }
    }

    <span class="hljs-comment">/**
     * 获取连接池状态
     */</span>
    <span class="hljs-keyword">public</span> PoolStats <span class="hljs-title function_">getStats</span><span class="hljs-params">()</span> {
        <span class="hljs-type">PoolStats</span> <span class="hljs-variable">stats</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">PoolStats</span>();
        stats.setMaxConnections(semaphore.availablePermits() + semaphore.getQueueLength());
        stats.setAvailableConnections(semaphore.availablePermits());
        stats.setWaitingThreads(semaphore.getQueueLength());
        stats.setActiveConnections(stats.getMaxConnections() - stats.getAvailableConnections());
        <span class="hljs-keyword">return</span> stats;
    }

    <span class="hljs-meta">@Data</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PoolStats</span> {
        <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> maxConnections;
        <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> availableConnections;
        <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> activeConnections;
        <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> waitingThreads;
    }
}
</code></pre>
<h4 data-id="heading-34">使用示例</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderService</span> {

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> DatabaseConnectionPool connectionPool;

    <span class="hljs-keyword">public</span> Order <span class="hljs-title function_">queryOrder</span><span class="hljs-params">(Long orderId)</span> {
        <span class="hljs-type">Connection</span> <span class="hljs-variable">conn</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;
        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// 获取连接(最多等待3秒)</span>
            conn = connectionPool.getConnection(<span class="hljs-number">3</span>, TimeUnit.SECONDS);

            <span class="hljs-type">PreparedStatement</span> <span class="hljs-variable">ps</span> <span class="hljs-operator">=</span> conn.prepareStatement(
                <span class="hljs-string">"SELECT * FROM t_order WHERE id = ?"</span>);
            ps.setLong(<span class="hljs-number">1</span>, orderId);

            <span class="hljs-type">ResultSet</span> <span class="hljs-variable">rs</span> <span class="hljs-operator">=</span> ps.executeQuery();
            <span class="hljs-keyword">if</span> (rs.next()) {
                <span class="hljs-keyword">return</span> mapToOrder(rs);
            }
            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;

        } <span class="hljs-keyword">catch</span> (TimeoutException e) {
            log.error(<span class="hljs-string">"获取数据库连接超时,orderId:{}"</span>, orderId);
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BusinessException</span>(<span class="hljs-string">"系统繁忙,请稍后重试"</span>);
        } <span class="hljs-keyword">catch</span> (Exception e) {
            log.error(<span class="hljs-string">"查询订单失败,orderId:{}"</span>, orderId, e);
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BusinessException</span>(<span class="hljs-string">"查询失败"</span>, e);
        } <span class="hljs-keyword">finally</span> {
            <span class="hljs-comment">// 必须释放连接</span>
            connectionPool.releaseConnection(conn);
        }
    }
}
</code></pre>
<h4 data-id="heading-35">公平与非公平的选择</h4>
<p><strong>非公平模式(默认):</strong></p>
<ul>
<li>新到达的线程可能直接获取许可,无需排队</li>
<li>吞吐量高,但可能导致饥饿</li>
</ul>
<p><strong>公平模式:</strong></p>
<ul>
<li>严格按照FIFO顺序分配许可</li>
<li>避免饥饿,但性能稍差</li>
</ul>
<p><strong>性能测试对比:</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@BenchmarkMode(Mode.Throughput)</span>
<span class="hljs-meta">@State(Scope.Benchmark)</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SemaphoreBenchmark</span> {

    <span class="hljs-keyword">private</span> <span class="hljs-type">Semaphore</span> <span class="hljs-variable">fairSemaphore</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Semaphore</span>(<span class="hljs-number">20</span>, <span class="hljs-literal">true</span>);
    <span class="hljs-keyword">private</span> <span class="hljs-type">Semaphore</span> <span class="hljs-variable">unfairSemaphore</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Semaphore</span>(<span class="hljs-number">20</span>, <span class="hljs-literal">false</span>);

    <span class="hljs-meta">@Benchmark</span>
    <span class="hljs-meta">@Threads(100)</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testFair</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> InterruptedException {
        fairSemaphore.acquire();
        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// 模拟业务操作</span>
            Thread.sleep(<span class="hljs-number">1</span>);
        } <span class="hljs-keyword">finally</span> {
            fairSemaphore.release();
        }
    }

    <span class="hljs-meta">@Benchmark</span>
    <span class="hljs-meta">@Threads(100)</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testUnfair</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> InterruptedException {
        unfairSemaphore.acquire();
        <span class="hljs-keyword">try</span> {
            Thread.sleep(<span class="hljs-number">1</span>);
        } <span class="hljs-keyword">finally</span> {
            unfairSemaphore.release();
        }
    }
}

<span class="hljs-comment">// 结果(ops/s):</span>
<span class="hljs-comment">// testFair:    12000</span>
<span class="hljs-comment">// testUnfair:  18000  (提升50%)</span>
</code></pre>
<p><strong>选择建议:</strong></p>
<ul>
<li>高吞吐场景 → 非公平模式</li>
<li>需要避免饥饿 → 公平模式</li>
</ul>
<h3 data-id="heading-36">3.3 场景3: 使用ReadWriteLock优化缓存</h3>
<h4 data-id="heading-37">业务背景</h4>
<p>电商平台的商品服务需要缓存热门商品信息:</p>
<ul>
<li>缓存读操作占99%,写操作占1%</li>
<li>使用<code>synchronized</code>导致读操作也串行化,性能瓶颈明显</li>
</ul>
<h4 data-id="heading-38">使用synchronized的性能问题</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">/**
 * 基于synchronized的缓存(性能差)
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ProductCacheSynchronized</span> {

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Map&lt;Long, ProductDTO&gt; cache = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();

    <span class="hljs-comment">// 读操作也需要加锁,导致串行化</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">synchronized</span> ProductDTO <span class="hljs-title function_">get</span><span class="hljs-params">(Long productId)</span> {
        <span class="hljs-keyword">return</span> cache.get(productId);
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">synchronized</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">put</span><span class="hljs-params">(Long productId, ProductDTO product)</span> {
        cache.put(productId, product);
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">synchronized</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">remove</span><span class="hljs-params">(Long productId)</span> {
        cache.remove(productId);
    }
}
</code></pre>
<p><strong>性能问题:</strong></p>
<ul>
<li>读操作占99%,但也需要获取独占锁</li>
<li>100个线程同时读取,也会串行执行</li>
<li>吞吐量严重受限</li>
</ul>
<h4 data-id="heading-39">ReadWriteLock改造</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">/**
 * 基于ReadWriteLock的缓存(性能优)
 */</span>
<span class="hljs-meta">@Slf4j</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ProductCacheReadWriteLock</span> {

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Map&lt;Long, ProductDTO&gt; cache = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">ReadWriteLock</span> <span class="hljs-variable">rwLock</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ReentrantReadWriteLock</span>();
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Lock</span> <span class="hljs-variable">readLock</span> <span class="hljs-operator">=</span> rwLock.readLock();
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Lock</span> <span class="hljs-variable">writeLock</span> <span class="hljs-operator">=</span> rwLock.writeLock();

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> ProductRepository productRepository;

    <span class="hljs-comment">/**
     * 读取缓存(多线程并发读)
     */</span>
    <span class="hljs-keyword">public</span> ProductDTO <span class="hljs-title function_">get</span><span class="hljs-params">(Long productId)</span> {
        readLock.lock();  <span class="hljs-comment">// 读锁</span>
        <span class="hljs-keyword">try</span> {
            <span class="hljs-type">ProductDTO</span> <span class="hljs-variable">product</span> <span class="hljs-operator">=</span> cache.get(productId);
            <span class="hljs-keyword">if</span> (product != <span class="hljs-literal">null</span>) {
                log.debug(<span class="hljs-string">"缓存命中,productId:{}"</span>, productId);
                <span class="hljs-keyword">return</span> product;
            }
        } <span class="hljs-keyword">finally</span> {
            readLock.unlock();
        }

        <span class="hljs-comment">// 缓存未命中,需要从数据库加载</span>
        <span class="hljs-keyword">return</span> loadFromDB(productId);
    }

    <span class="hljs-comment">/**
     * 从数据库加载并更新缓存(锁降级)
     */</span>
    <span class="hljs-keyword">private</span> ProductDTO <span class="hljs-title function_">loadFromDB</span><span class="hljs-params">(Long productId)</span> {
        writeLock.lock();  <span class="hljs-comment">// ①获取写锁</span>
        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// ②双重检查(其他线程可能已加载)</span>
            <span class="hljs-type">ProductDTO</span> <span class="hljs-variable">product</span> <span class="hljs-operator">=</span> cache.get(productId);
            <span class="hljs-keyword">if</span> (product != <span class="hljs-literal">null</span>) {
                <span class="hljs-keyword">return</span> product;
            }

            <span class="hljs-comment">// ③从数据库加载</span>
            log.info(<span class="hljs-string">"从数据库加载商品,productId:{}"</span>, productId);
            product = productRepository.findById(productId);

            <span class="hljs-keyword">if</span> (product != <span class="hljs-literal">null</span>) {
                cache.put(productId, product);
            }

            <span class="hljs-keyword">return</span> product;

        } <span class="hljs-keyword">finally</span> {
            writeLock.unlock();
        }
    }

    <span class="hljs-comment">/**
     * 更新缓存(独占写)
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">put</span><span class="hljs-params">(Long productId, ProductDTO product)</span> {
        writeLock.lock();
        <span class="hljs-keyword">try</span> {
            cache.put(productId, product);
            log.info(<span class="hljs-string">"更新缓存,productId:{}"</span>, productId);
        } <span class="hljs-keyword">finally</span> {
            writeLock.unlock();
        }
    }

    <span class="hljs-comment">/**
     * 删除缓存
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">remove</span><span class="hljs-params">(Long productId)</span> {
        writeLock.lock();
        <span class="hljs-keyword">try</span> {
            cache.remove(productId);
            log.info(<span class="hljs-string">"删除缓存,productId:{}"</span>, productId);
        } <span class="hljs-keyword">finally</span> {
            writeLock.unlock();
        }
    }

    <span class="hljs-comment">/**
     * 批量预热缓存(锁降级示例)
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">warmUp</span><span class="hljs-params">(List&lt;Long&gt; productIds)</span> {
        writeLock.lock();  <span class="hljs-comment">// ①获取写锁</span>
        <span class="hljs-keyword">try</span> {
            log.info(<span class="hljs-string">"开始预热缓存,商品数:{}"</span>, productIds.size());

            List&lt;ProductDTO&gt; products = productRepository.findByIds(productIds);
            <span class="hljs-keyword">for</span> (ProductDTO product : products) {
                cache.put(product.getProductId(), product);
            }

            <span class="hljs-comment">// ②锁降级:获取读锁</span>
            readLock.lock();

        } <span class="hljs-keyword">finally</span> {
            writeLock.unlock();  <span class="hljs-comment">// ③释放写锁</span>
        }

        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// ④持有读锁,允许其他线程并发读取</span>
            log.info(<span class="hljs-string">"缓存预热完成,当前缓存数:{}"</span>, cache.size());
        } <span class="hljs-keyword">finally</span> {
            readLock.unlock();  <span class="hljs-comment">// ⑤释放读锁</span>
        }
    }

    <span class="hljs-comment">/**
     * 获取缓存统计
     */</span>
    <span class="hljs-keyword">public</span> CacheStats <span class="hljs-title function_">getStats</span><span class="hljs-params">()</span> {
        readLock.lock();
        <span class="hljs-keyword">try</span> {
            <span class="hljs-type">CacheStats</span> <span class="hljs-variable">stats</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CacheStats</span>();
            stats.setCacheSize(cache.size());
            <span class="hljs-keyword">return</span> stats;
        } <span class="hljs-keyword">finally</span> {
            readLock.unlock();
        }
    }

    <span class="hljs-meta">@Data</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CacheStats</span> {
        <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> cacheSize;
    }
}
</code></pre>
<h4 data-id="heading-40">性能提升数据对比</h4>
<p><strong>测试代码:</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@BenchmarkMode(Mode.Throughput)</span>
<span class="hljs-meta">@Warmup(iterations = 3)</span>
<span class="hljs-meta">@Measurement(iterations = 5)</span>
<span class="hljs-meta">@State(Scope.Benchmark)</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CacheBenchmark</span> {

    <span class="hljs-keyword">private</span> ProductCacheSynchronized syncCache;
    <span class="hljs-keyword">private</span> ProductCacheReadWriteLock rwCache;

    <span class="hljs-meta">@Setup</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setup</span><span class="hljs-params">()</span> {
        syncCache = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ProductCacheSynchronized</span>();
        rwCache = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ProductCacheReadWriteLock</span>();

        <span class="hljs-comment">// 预热缓存</span>
        <span class="hljs-keyword">for</span> (<span class="hljs-type">long</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span>; i &lt;= <span class="hljs-number">1000</span>; i++) {
            <span class="hljs-type">ProductDTO</span> <span class="hljs-variable">product</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ProductDTO</span>();
            product.setProductId(i);
            product.setProductName(<span class="hljs-string">"商品"</span> + i);

            syncCache.put(i, product);
            rwCache.put(i, product);
        }
    }

    <span class="hljs-comment">// 读多写少场景(99%读,1%写)</span>
    <span class="hljs-meta">@Benchmark</span>
    <span class="hljs-meta">@Threads(100)</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testSynchronizedRead</span><span class="hljs-params">()</span> {
        <span class="hljs-type">long</span> <span class="hljs-variable">productId</span> <span class="hljs-operator">=</span> ThreadLocalRandom.current().nextLong(<span class="hljs-number">1</span>, <span class="hljs-number">1001</span>);

        <span class="hljs-keyword">if</span> (ThreadLocalRandom.current().nextInt(<span class="hljs-number">100</span>) &lt; <span class="hljs-number">99</span>) {
            <span class="hljs-comment">// 99%读操作</span>
            syncCache.get(productId);
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-comment">// 1%写操作</span>
            <span class="hljs-type">ProductDTO</span> <span class="hljs-variable">product</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ProductDTO</span>();
            product.setProductId(productId);
            syncCache.put(productId, product);
        }
    }

    <span class="hljs-meta">@Benchmark</span>
    <span class="hljs-meta">@Threads(100)</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testReadWriteLockRead</span><span class="hljs-params">()</span> {
        <span class="hljs-type">long</span> <span class="hljs-variable">productId</span> <span class="hljs-operator">=</span> ThreadLocalRandom.current().nextLong(<span class="hljs-number">1</span>, <span class="hljs-number">1001</span>);

        <span class="hljs-keyword">if</span> (ThreadLocalRandom.current().nextInt(<span class="hljs-number">100</span>) &lt; <span class="hljs-number">99</span>) {
            rwCache.get(productId);
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-type">ProductDTO</span> <span class="hljs-variable">product</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ProductDTO</span>();
            product.setProductId(productId);
            rwCache.put(productId, product);
        }
    }
}
</code></pre>
<p><strong>测试结果(JDK 17, ops/s):</strong></p>



































<table><thead><tr><th>并发线程数</th><th>synchronized</th><th>ReadWriteLock</th><th>提升倍数</th></tr></thead><tbody><tr><td>10</td><td>850K</td><td>2.1M</td><td>2.5x</td></tr><tr><td>50</td><td>420K</td><td>3.8M</td><td>9.0x</td></tr><tr><td>100</td><td>280K</td><td>4.2M</td><td>15.0x</td></tr><tr><td>200</td><td>190K</td><td>4.5M</td><td>23.7x</td></tr></tbody></table>
<p><strong>结论:</strong></p>
<ul>
<li>读多写少场景下,ReadWriteLock性能提升显著</li>
<li>并发度越高,性能优势越明显</li>
<li>100线程时性能提升<strong>15倍</strong></li>
</ul>
<hr/>
<h2 data-id="heading-41">四、生产案例与故障排查</h2>
<h3 data-id="heading-42">4.1 案例1: AQS在高并发场景的应用</h3>
<h4 data-id="heading-43">业务场景:秒杀系统库存扣减</h4>
<p>电商平台秒杀活动,需要保证:</p>
<ul>
<li>库存扣减的原子性(不能超卖)</li>
<li>高并发(QPS 10000+)</li>
<li>低延迟(P99 &lt; 50ms)</li>
</ul>
<h4 data-id="heading-44">为什么不用synchronized?</h4>
<p><strong>synchronized的问题:</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 使用synchronized的库存扣减</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">synchronized</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">deductStock</span><span class="hljs-params">(Long skuId, <span class="hljs-type">int</span> quantity)</span> {
    <span class="hljs-type">Integer</span> <span class="hljs-variable">stock</span> <span class="hljs-operator">=</span> stockMap.get(skuId);
    <span class="hljs-keyword">if</span> (stock == <span class="hljs-literal">null</span> || stock &lt; quantity) {
        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;  <span class="hljs-comment">// 库存不足</span>
    }

    stockMap.put(skuId, stock - quantity);
    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
}
</code></pre>
<p><strong>性能瓶颈:</strong></p>
<ul>
<li>锁粒度太粗: 所有SKU共用一把锁</li>
<li>SKU A的扣减会阻塞SKU B的扣减</li>
<li>高并发下吞吐量受限</li>
</ul>
<h4 data-id="heading-45">技术方案:分段锁 + ReentrantLock</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">/**
 * 高性能库存扣减服务
 */</span>
<span class="hljs-meta">@Service</span>
<span class="hljs-meta">@Slf4j</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">StockDeductionService</span> {

    <span class="hljs-comment">// SKU维度的分段锁(降低锁竞争)</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> ConcurrentHashMap&lt;Long, ReentrantLock&gt; skuLocks = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConcurrentHashMap</span>&lt;&gt;();

    <span class="hljs-comment">// 库存缓存(Caffeine本地缓存 + Redis分布式缓存)</span>
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> Cache&lt;Long, Integer&gt; localCache;

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> RedisTemplate&lt;String, Integer&gt; redisTemplate;

    <span class="hljs-comment">/**
     * 扣减库存
     * <span class="hljs-doctag">@param</span> skuId 商品SKU ID
     * <span class="hljs-doctag">@param</span> quantity 扣减数量
     * <span class="hljs-doctag">@return</span> 是否扣减成功
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">deductStock</span><span class="hljs-params">(Long skuId, <span class="hljs-type">int</span> quantity)</span> {
        <span class="hljs-comment">// ①获取SKU维度的锁(分段锁,降低竞争)</span>
        <span class="hljs-type">ReentrantLock</span> <span class="hljs-variable">lock</span> <span class="hljs-operator">=</span> skuLocks.computeIfAbsent(skuId,
            k -&gt; <span class="hljs-keyword">new</span> <span class="hljs-title class_">ReentrantLock</span>(<span class="hljs-literal">false</span>));  <span class="hljs-comment">// 非公平锁,性能优先</span>

        <span class="hljs-comment">// ②尝试获取锁(超时100ms)</span>
        <span class="hljs-keyword">try</span> {
            <span class="hljs-keyword">if</span> (!lock.tryLock(<span class="hljs-number">100</span>, TimeUnit.MILLISECONDS)) {
                log.warn(<span class="hljs-string">"获取库存锁超时,skuId:{}"</span>, skuId);
                <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
            }
        } <span class="hljs-keyword">catch</span> (InterruptedException e) {
            Thread.currentThread().interrupt();
            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
        }

        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// ③先查本地缓存</span>
            <span class="hljs-type">Integer</span> <span class="hljs-variable">stock</span> <span class="hljs-operator">=</span> localCache.getIfPresent(skuId);

            <span class="hljs-keyword">if</span> (stock == <span class="hljs-literal">null</span>) {
                <span class="hljs-comment">// ④本地缓存未命中,查Redis</span>
                <span class="hljs-type">String</span> <span class="hljs-variable">redisKey</span> <span class="hljs-operator">=</span> <span class="hljs-string">"stock:"</span> + skuId;
                stock = redisTemplate.opsForValue().get(redisKey);

                <span class="hljs-keyword">if</span> (stock == <span class="hljs-literal">null</span>) {
                    <span class="hljs-comment">// ⑤Redis也未命中,查数据库</span>
                    stock = loadStockFromDB(skuId);
                    <span class="hljs-keyword">if</span> (stock == <span class="hljs-literal">null</span>) {
                        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;  <span class="hljs-comment">// 商品不存在</span>
                    }

                    <span class="hljs-comment">// 回写缓存</span>
                    redisTemplate.opsForValue().set(redisKey, stock, <span class="hljs-number">60</span>, TimeUnit.SECONDS);
                }

                <span class="hljs-comment">// 回写本地缓存</span>
                localCache.put(skuId, stock);
            }

            <span class="hljs-comment">// ⑥检查库存</span>
            <span class="hljs-keyword">if</span> (stock &lt; quantity) {
                log.warn(<span class="hljs-string">"库存不足,skuId:{},当前库存:{},扣减数量:{}"</span>,
                        skuId, stock, quantity);
                <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
            }

            <span class="hljs-comment">// ⑦扣减库存(本地缓存 + Redis)</span>
            <span class="hljs-type">int</span> <span class="hljs-variable">newStock</span> <span class="hljs-operator">=</span> stock - quantity;
            localCache.put(skuId, newStock);

            <span class="hljs-type">String</span> <span class="hljs-variable">redisKey</span> <span class="hljs-operator">=</span> <span class="hljs-string">"stock:"</span> + skuId;
            redisTemplate.opsForValue().set(redisKey, newStock, <span class="hljs-number">60</span>, TimeUnit.SECONDS);

            <span class="hljs-comment">// ⑧异步更新数据库(MQ)</span>
            sendStockUpdateMessage(skuId, newStock);

            log.info(<span class="hljs-string">"库存扣减成功,skuId:{},扣减:{},剩余:{}"</span>, skuId, quantity, newStock);
            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;

        } <span class="hljs-keyword">finally</span> {
            <span class="hljs-comment">// ⑨释放锁(必须在finally中)</span>
            lock.unlock();
        }
    }

    <span class="hljs-comment">/**
     * 从数据库加载库存
     */</span>
    <span class="hljs-keyword">private</span> Integer <span class="hljs-title function_">loadStockFromDB</span><span class="hljs-params">(Long skuId)</span> {
        <span class="hljs-comment">// 实际实现省略</span>
        <span class="hljs-keyword">return</span> <span class="hljs-number">1000</span>;
    }

    <span class="hljs-comment">/**
     * 异步更新数据库库存(通过MQ)
     */</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">sendStockUpdateMessage</span><span class="hljs-params">(Long skuId, <span class="hljs-type">int</span> newStock)</span> {
        <span class="hljs-comment">// 发送MQ消息,异步更新数据库</span>
        <span class="hljs-comment">// 实际实现省略</span>
    }

    <span class="hljs-comment">/**
     * 定时清理空闲锁对象(防止内存泄漏)
     */</span>
    <span class="hljs-meta">@Scheduled(fixedRate = 60000)</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">cleanIdleLocks</span><span class="hljs-params">()</span> {
        skuLocks.entrySet().removeIf(entry -&gt; {
            <span class="hljs-type">ReentrantLock</span> <span class="hljs-variable">lock</span> <span class="hljs-operator">=</span> entry.getValue();
            <span class="hljs-comment">// 尝试获取锁,获取成功说明无人使用</span>
            <span class="hljs-keyword">if</span> (lock.tryLock()) {
                <span class="hljs-keyword">try</span> {
                    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;  <span class="hljs-comment">// 移除</span>
                } <span class="hljs-keyword">finally</span> {
                    lock.unlock();
                }
            }
            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;  <span class="hljs-comment">// 保留</span>
        });

        log.info(<span class="hljs-string">"清理空闲锁完成,当前锁数量:{}"</span>, skuLocks.size());
    }
}
</code></pre>
<h4 data-id="heading-46">压测数据与优化过程</h4>
<p><strong>优化前(synchronized):</strong></p>
<pre><code class="hljs language-makefile" lang="makefile"><span class="hljs-section">并发:1000</span>
<span class="hljs-section">QPS: 2800</span>
<span class="hljs-section">P99延迟: 350ms</span>
<span class="hljs-section">错误率: 15% (超时)</span>
</code></pre>
<p><strong>优化后(ReentrantLock分段锁):</strong></p>
<pre><code class="hljs language-makefile" lang="makefile"><span class="hljs-section">并发:1000</span>
<span class="hljs-section">QPS: 12000  (提升4.3倍)</span>
<span class="hljs-section">P99延迟: 45ms  (降低87%)</span>
<span class="hljs-section">错误率: 0.1%</span>
</code></pre>
<p><strong>优化关键点:</strong></p>
<ol>
<li><strong>分段锁</strong>: 每个SKU独立锁,降低竞争</li>
<li><strong>非公平锁</strong>: 性能优先,避免线程切换</li>
<li><strong>超时机制</strong>: <code>tryLock(100ms)</code>,避免无限等待</li>
<li><strong>多级缓存</strong>: 本地缓存(Caffeine) + Redis,降低DB压力</li>
<li><strong>异步更新DB</strong>: 通过MQ异步,不阻塞主流程</li>
</ol>
<h3 data-id="heading-47">4.2 案例2: CountDownLatch超时未释放导致的线程泄漏</h3>
<h4 data-id="heading-48">故障现象</h4>
<p>生产环境发现线程池线程数持续增长,最终耗尽:</p>
<pre><code class="hljs language-arduino" lang="arduino">[ERROR] ThreadPoolExecutor: Worker creation failed
[WARN] ThreadPoolExecutor: Pool size: <span class="hljs-number">200</span>/<span class="hljs-number">200</span> (max)
</code></pre>
<h4 data-id="heading-49">问题分析</h4>
<p><strong>排查过程:</strong></p>
<ol>
<li><strong>线程dump分析</strong></li>
</ol>
<pre><code class="hljs language-bash" lang="bash">jstack &lt;pid&gt; &gt; thread_dump.txt
</code></pre>
<p>发现大量线程阻塞在<code>CountDownLatch.await()</code>:</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-string">"batch-import-1"</span> <span class="hljs-comment">#123 prio=5 os_prio=0 waiting on condition</span>
   java.lang.Thread.State: <span class="hljs-title function_ invoke__">WAITING</span> (parking)
        at sun.misc.Unsafe.<span class="hljs-title function_ invoke__">park</span>(Native Method)
        at java.util.concurrent.locks.LockSupport.<span class="hljs-title function_ invoke__">park</span>(LockSupport.<span class="hljs-attr">java</span>:<span class="hljs-number">175</span>)
        at java.util.concurrent.locks.AbstractQueuedSynchronizer.parkAndCheckInterrupt
        at java.util.concurrent.locks.AbstractQueuedSynchronizer.doAcquireSharedInterruptibly
        at java.util.concurrent.CountDownLatch.<span class="hljs-title function_ invoke__">await</span>(CountDownLatch.<span class="hljs-attr">java</span>:<span class="hljs-number">231</span>)
        at com.example.service.BatchService.<span class="hljs-title function_ invoke__">importData</span>(BatchService.<span class="hljs-attr">java</span>:<span class="hljs-number">45</span>)
</code></pre>
<p>2.  <strong>代码审查</strong></p>
<p>发现问题代码:</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// ❌错误代码</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">batchImport</span><span class="hljs-params">(List&lt;Data&gt; dataList)</span> {
    <span class="hljs-type">CountDownLatch</span> <span class="hljs-variable">latch</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CountDownLatch</span>(<span class="hljs-number">10</span>);

    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10</span>; i++) {
        executor.submit(() -&gt; {
            processData(dataList.get(i));  <span class="hljs-comment">// 可能抛异常</span>
            latch.countDown();  <span class="hljs-comment">// 异常时未执行!</span>
        });
    }

    latch.await();  <span class="hljs-comment">// 永久阻塞!</span>
}
</code></pre>
<p><strong>根因:</strong></p>
<ul>
<li>子任务抛出异常时,<code>countDown()</code>未执行</li>
<li>主线程<code>await()</code>永久阻塞</li>
<li>线程池线程被占用,最终耗尽</li>
</ul>
<h4 data-id="heading-50">解决方案</h4>
<p><strong>方案1: finally块保证countDown</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// ✅正确代码</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">batchImport</span><span class="hljs-params">(List&lt;Data&gt; dataList)</span> {
    <span class="hljs-type">CountDownLatch</span> <span class="hljs-variable">latch</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CountDownLatch</span>(<span class="hljs-number">10</span>);

    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10</span>; i++) {
        <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">index</span> <span class="hljs-operator">=</span> i;
        executor.submit(() -&gt; {
            <span class="hljs-keyword">try</span> {
                processData(dataList.get(index));
            } <span class="hljs-keyword">catch</span> (Exception e) {
                log.error(<span class="hljs-string">"处理失败,index:{}"</span>, index, e);
            } <span class="hljs-keyword">finally</span> {
                latch.countDown();  <span class="hljs-comment">// 必定执行</span>
            }
        });
    }

    <span class="hljs-comment">// 增加超时保护</span>
    <span class="hljs-type">boolean</span> <span class="hljs-variable">finished</span> <span class="hljs-operator">=</span> latch.await(<span class="hljs-number">30</span>, TimeUnit.SECONDS);
    <span class="hljs-keyword">if</span> (!finished) {
        log.error(<span class="hljs-string">"批量处理超时"</span>);
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BusinessException</span>(<span class="hljs-string">"批量处理超时"</span>);
    }
}
</code></pre>
<p><strong>方案2: 使用CompletableFuture(推荐)</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// ✅更优方案:使用CompletableFuture</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">batchImport</span><span class="hljs-params">(List&lt;Data&gt; dataList)</span> {
    <span class="hljs-comment">// 创建异步任务</span>
    List&lt;CompletableFuture&lt;Void&gt;&gt; futures = dataList.stream()
        .map(data -&gt; CompletableFuture.runAsync(() -&gt; {
            processData(data);
        }, executor))
        .collect(Collectors.toList());

    <span class="hljs-comment">// 等待所有任务完成(带超时)</span>
    <span class="hljs-keyword">try</span> {
        CompletableFuture.allOf(futures.toArray(<span class="hljs-keyword">new</span> <span class="hljs-title class_">CompletableFuture</span>[<span class="hljs-number">0</span>]))
            .get(<span class="hljs-number">30</span>, TimeUnit.SECONDS);
        log.info(<span class="hljs-string">"批量处理完成"</span>);
    } <span class="hljs-keyword">catch</span> (TimeoutException e) {
        log.error(<span class="hljs-string">"批量处理超时"</span>);
        <span class="hljs-comment">// 取消未完成的任务</span>
        futures.forEach(f -&gt; f.cancel(<span class="hljs-literal">true</span>));
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BusinessException</span>(<span class="hljs-string">"批量处理超时"</span>, e);
    } <span class="hljs-keyword">catch</span> (Exception e) {
        log.error(<span class="hljs-string">"批量处理失败"</span>, e);
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BusinessException</span>(<span class="hljs-string">"批量处理失败"</span>, e);
    }
}
</code></pre>
<p><strong>CompletableFuture的优势:</strong></p>
<ul>
<li>✅ 异常自动传播,不会丢失</li>
<li>✅ 支持链式调用,代码更优雅</li>
<li>✅ 支持超时取消</li>
<li>✅ 支持组合多个异步任务</li>
</ul>
<h4 data-id="heading-51">改进方案对比</h4>

























<table><thead><tr><th>方案</th><th>优点</th><th>缺点</th></tr></thead><tbody><tr><td>CountDownLatch + finally</td><td>简单直接</td><td>异常处理复杂,需手动管理</td></tr><tr><td>CompletableFuture</td><td>异常自动处理,API丰富</td><td>学习成本稍高</td></tr><tr><td>CompletableFuture + 超时</td><td>完善的异常和超时处理</td><td>-</td></tr></tbody></table>
<hr/>
<h2 data-id="heading-52">五、常见问题与避坑指南</h2>
<h3 data-id="heading-53">5.1 AQS的state字段为什么用volatile?</h3>
<p><strong>原因1: 保证可见性</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 线程A</span>
state = <span class="hljs-number">1</span>;  <span class="hljs-comment">// 释放锁</span>

<span class="hljs-comment">// 线程B</span>
<span class="hljs-keyword">if</span> (state == <span class="hljs-number">0</span>) {  <span class="hljs-comment">// 获取锁</span>
    <span class="hljs-comment">// ...</span>
}
</code></pre>
<p>如果<code>state</code>不是<code>volatile</code>,线程B可能读取到旧值(缓存),导致:</p>
<ul>
<li>看到state=0(实际已被修改为1)</li>
<li>重复获取锁,破坏互斥性</li>
</ul>
<p><strong>原因2: 配合CAS保证原子性</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">final</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">compareAndSetState</span><span class="hljs-params">(<span class="hljs-type">int</span> expect, <span class="hljs-type">int</span> update)</span> {
    <span class="hljs-keyword">return</span> unsafe.compareAndSwapInt(<span class="hljs-built_in">this</span>, stateOffset, expect, update);
}
</code></pre>
<p>CAS操作本身是原子的,但需要<code>volatile</code>保证:</p>
<ul>
<li>读取最新值进行比较</li>
<li>修改后立即对其他线程可见</li>
</ul>
<p><strong>原因3: 禁止重排序</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 获取锁的典型流程</span>
<span class="hljs-keyword">if</span> (compareAndSetState(<span class="hljs-number">0</span>, <span class="hljs-number">1</span>)) {  <span class="hljs-comment">// ①CAS获取锁</span>
    setExclusiveOwnerThread(current);  <span class="hljs-comment">// ②设置持有线程</span>
    <span class="hljs-comment">// ③执行临界区代码</span>
}
</code></pre>
<p><code>volatile</code>的内存屏障保证:</p>
<ul>
<li>①②不会重排序到③之后</li>
<li>其他线程看到state=1时,必定也能看到owner线程的设置</li>
</ul>
<h3 data-id="heading-54">5.2 为什么需要CLH队列?直接自旋不行吗?</h3>
<p><strong>纯自旋的问题:</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 纯自旋锁</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SpinLock</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-type">AtomicBoolean</span> <span class="hljs-variable">locked</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AtomicBoolean</span>(<span class="hljs-literal">false</span>);

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">lock</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">while</span> (!locked.compareAndSet(<span class="hljs-literal">false</span>, <span class="hljs-literal">true</span>)) {
            <span class="hljs-comment">// 不断自旋,浪费CPU</span>
        }
    }
}
</code></pre>
<p><strong>问题:</strong></p>
<ol>
<li><strong>CPU空转</strong>: 高竞争下,大量线程自旋,CPU利用率100%但无效</li>
<li><strong>不公平</strong>: 无法保证FIFO顺序,可能饥饿</li>
<li><strong>无法支持中断/超时</strong>: 自旋过程无法响应中断</li>
</ol>
<p><strong>CLH队列的优势:</strong></p>
<ol>
<li><strong>自旋+阻塞结合</strong>: 先自旋几次,失败后阻塞(park),避免CPU空转</li>
<li><strong>FIFO公平性</strong>: 队列天然保证先进先出</li>
<li><strong>支持中断/超时</strong>: <code>parkNanos</code>/<code>parkUntil</code>支持超时,<code>park</code>可被中断</li>
<li><strong>节点状态管理</strong>: <code>waitStatus</code>记录节点状态,优化唤醒流程</li>
</ol>
<h3 data-id="heading-55">5.3 CountDownLatch vs CyclicBarrier如何选择?</h3>
<p><strong>CountDownLatch场景:</strong></p>
<ul>
<li>✅ 一组线程等待另一组线程完成</li>
<li>✅ 一次性使用(无需重置)</li>
<li>✅ 等待者与执行者角色明确</li>
</ul>
<p><strong>示例:</strong> 主线程等待所有子线程完成</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-type">CountDownLatch</span> <span class="hljs-variable">latch</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CountDownLatch</span>(<span class="hljs-number">10</span>);

<span class="hljs-comment">// 主线程</span>
latch.await();

<span class="hljs-comment">// 子线程</span>
latch.countDown();
</code></pre>
<p><strong>CyclicBarrier场景:</strong></p>
<ul>
<li>✅ 多个线程相互等待</li>
<li>✅ 需要重复使用</li>
<li>✅ 到达屏障点后执行共同动作</li>
</ul>
<p><strong>示例:</strong> 多线程计算,每轮同步</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-type">CyclicBarrier</span> <span class="hljs-variable">barrier</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CyclicBarrier</span>(<span class="hljs-number">3</span>, () -&gt; {
    System.out.println(<span class="hljs-string">"一轮计算完成"</span>);
});

<span class="hljs-comment">// 每个线程</span>
<span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">round</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; round &lt; <span class="hljs-number">10</span>; round++) {
    compute(round);
    barrier.await();  <span class="hljs-comment">// 等待其他线程</span>
}
</code></pre>
<p><strong>决策表:</strong></p>






























<table><thead><tr><th>需求</th><th>CountDownLatch</th><th>CyclicBarrier</th></tr></thead><tbody><tr><td>重复使用</td><td>❌</td><td>✅</td></tr><tr><td>角色分离(等待者vs执行者)</td><td>✅</td><td>❌</td></tr><tr><td>屏障动作</td><td>❌</td><td>✅</td></tr><tr><td>底层实现</td><td>AQS</td><td>ReentrantLock</td></tr></tbody></table>
<h3 data-id="heading-56">5.4 ReentrantLock为什么推荐在finally中unlock?</h3>
<p><strong>错误示例:</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// ❌错误:unlock不在finally中</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">transfer</span><span class="hljs-params">(Account from, Account to, <span class="hljs-type">int</span> amount)</span> {
    lock.lock();

    <span class="hljs-keyword">if</span> (from.getBalance() &lt; amount) {
        lock.unlock();  <span class="hljs-comment">// ①提前返回时释放</span>
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InsufficientBalanceException</span>();
    }

    from.deduct(amount);
    to.add(amount);  <span class="hljs-comment">// ②如果这里抛异常,锁永不释放!</span>

    lock.unlock();  <span class="hljs-comment">// ③正常流程释放</span>
}
</code></pre>
<p><strong>问题:</strong></p>
<ul>
<li>如果②抛出异常,③不会执行,锁永不释放</li>
<li>其他线程永久阻塞,导致死锁</li>
</ul>
<p><strong>正确示例:</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// ✅正确:unlock在finally中</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">transfer</span><span class="hljs-params">(Account from, Account to, <span class="hljs-type">int</span> amount)</span> {
    lock.lock();
    <span class="hljs-keyword">try</span> {
        <span class="hljs-keyword">if</span> (from.getBalance() &lt; amount) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InsufficientBalanceException</span>();
        }

        from.deduct(amount);
        to.add(amount);
    } <span class="hljs-keyword">finally</span> {
        lock.unlock();  <span class="hljs-comment">// 无论如何都会释放</span>
    }
}
</code></pre>
<p><strong>原则:</strong></p>
<ul>
<li><code>lock()</code>和<code>unlock()</code>必须配对</li>
<li><code>unlock()</code>必须在<code>finally</code>块中</li>
<li>避免在<code>try</code>块外<code>lock()</code>(可能异常导致未lock就unlock)</li>
</ul>
<h3 data-id="heading-57">5.5 Semaphore的公平与非公平模式性能差异多大?</h3>
<p>前面的测试结果显示:</p>
<ul>
<li><strong>非公平模式吞吐量提升约50%</strong></li>
<li><strong>公平模式延迟更稳定,避免饥饿</strong></li>
</ul>
<p><strong>适用场景:</strong></p>
<ul>
<li><strong>高吞吐业务</strong>: 非公平模式(如接口限流)</li>
<li><strong>关键业务</strong>: 公平模式(如任务调度,避免饥饿)</li>
</ul>
<h3 data-id="heading-58">5.6 ReadWriteLock的锁降级是什么?如何实现?</h3>
<p><strong>锁降级:</strong> 持有写锁时获取读锁,然后释放写锁</p>
<p><strong>正确示例:</strong></p>
<pre><code class="hljs language-java" lang="java">rwLock.writeLock().lock();  <span class="hljs-comment">// ①获取写锁</span>
<span class="hljs-keyword">try</span> {
    <span class="hljs-comment">// 更新数据</span>
    data = newData;

    rwLock.readLock().lock();  <span class="hljs-comment">// ②获取读锁(锁降级)</span>
} <span class="hljs-keyword">finally</span> {
    rwLock.writeLock().unlock();  <span class="hljs-comment">// ③释放写锁</span>
}

<span class="hljs-keyword">try</span> {
    <span class="hljs-comment">// ④使用数据(持有读锁)</span>
    use(data);
} <span class="hljs-keyword">finally</span> {
    rwLock.readLock().unlock();  <span class="hljs-comment">// ⑤释放读锁</span>
}
</code></pre>
<p><strong>为什么需要锁降级?</strong></p>
<ul>
<li>保证数据一致性: ②③之间,其他线程无法修改数据</li>
<li>提高并发性: 释放写锁后,其他线程可以并发读</li>
</ul>
<h3 data-id="heading-59">5.7 为什么没有锁升级?</h3>
<p><strong>锁升级(读锁→写锁)会导致死锁:</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// ❌死锁示例</span>
<span class="hljs-comment">// 线程A</span>
readLock.lock();
<span class="hljs-comment">// ... 想升级为写锁</span>
writeLock.lock();  <span class="hljs-comment">// 阻塞,等待读锁释放</span>

<span class="hljs-comment">// 线程B</span>
readLock.lock();
<span class="hljs-comment">// ... 想升级为写锁</span>
writeLock.lock();  <span class="hljs-comment">// 阻塞,等待读锁释放</span>

<span class="hljs-comment">// 死锁! 两个线程都持有读锁,都等待对方释放</span>
</code></pre>
<p><strong>正确做法: 先释放读锁,再获取写锁</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// ✅正确</span>
readLock.lock();
<span class="hljs-keyword">try</span> {
    <span class="hljs-comment">// 读取数据</span>
    <span class="hljs-keyword">if</span> (needUpdate) {
        readLock.unlock();  <span class="hljs-comment">// ①释放读锁</span>

        writeLock.lock();  <span class="hljs-comment">// ②获取写锁</span>
        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// ③双重检查</span>
            <span class="hljs-keyword">if</span> (needUpdate) {
                <span class="hljs-comment">// 更新数据</span>
            }
        } <span class="hljs-keyword">finally</span> {
            writeLock.unlock();
        }
    }
} <span class="hljs-keyword">finally</span> {
    <span class="hljs-keyword">if</span> (readLock.isHeldByCurrentThread()) {
        readLock.unlock();
    }
}
</code></pre>
<h3 data-id="heading-60">5.8 Condition vs wait/notify的区别?</h3>













































<table><thead><tr><th>特性</th><th>wait/notify</th><th>Condition</th></tr></thead><tbody><tr><td>绑定对象</td><td>任意Object</td><td>Lock</td></tr><tr><td>条件数量</td><td>1个(对象监视器)</td><td>多个(一个Lock多个Condition)</td></tr><tr><td>唤醒精确性</td><td>❌notify随机唤醒</td><td>✅signal精确唤醒</td></tr><tr><td>支持中断</td><td>✅</td><td>✅</td></tr><tr><td>支持超时</td><td>✅</td><td>✅</td></tr><tr><td>必须在同步块</td><td>✅必须在synchronized</td><td>✅必须持有Lock</td></tr><tr><td>虚假唤醒</td><td>⚠️存在</td><td>⚠️存在</td></tr></tbody></table>
<p><strong>Condition的优势:</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 多条件示例:生产者-消费者</span>
<span class="hljs-type">Lock</span> <span class="hljs-variable">lock</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ReentrantLock</span>();
<span class="hljs-type">Condition</span> <span class="hljs-variable">notFull</span> <span class="hljs-operator">=</span> lock.newCondition();   <span class="hljs-comment">// 条件1</span>
<span class="hljs-type">Condition</span> <span class="hljs-variable">notEmpty</span> <span class="hljs-operator">=</span> lock.newCondition();  <span class="hljs-comment">// 条件2</span>

<span class="hljs-comment">// 生产者</span>
lock.lock();
<span class="hljs-keyword">try</span> {
    <span class="hljs-keyword">while</span> (count == capacity) {
        notFull.await();  <span class="hljs-comment">// 等待notFull条件</span>
    }
    <span class="hljs-comment">// 生产</span>
    notEmpty.signal();  <span class="hljs-comment">// 精确唤醒消费者</span>
} <span class="hljs-keyword">finally</span> {
    lock.unlock();
}

<span class="hljs-comment">// 消费者</span>
lock.lock();
<span class="hljs-keyword">try</span> {
    <span class="hljs-keyword">while</span> (count == <span class="hljs-number">0</span>) {
        notEmpty.await();  <span class="hljs-comment">// 等待notEmpty条件</span>
    }
    <span class="hljs-comment">// 消费</span>
    notFull.signal();  <span class="hljs-comment">// 精确唤醒生产者</span>
} <span class="hljs-keyword">finally</span> {
    lock.unlock();
}
</code></pre>
<hr/>
<h2 data-id="heading-61">六、最佳实践与总结</h2>
<h3 data-id="heading-62">6.1 如何选择合适的同步工具?</h3>
<p><strong>决策树:</strong></p>
<pre><code class="hljs language-arduino" lang="arduino">需要互斥访问?
├─ 是 → 需要高级特性(中断/超时/公平/多条件)?
│   ├─ 是 → ReentrantLock
│   └─ 否 → <span class="hljs-keyword">synchronized</span>
└─ 否 → 需要什么样的协调?
    ├─ 限制并发数 → Semaphore
    ├─ 等待多个线程完成 → CountDownLatch
    ├─ 多线程互相等待同步点 → CyclicBarrier
    ├─ 读多写少 → ReadWriteLock
    └─ 生产者-消费者 → BlockingQueue
</code></pre>
<h3 data-id="heading-63">6.2 AQS自定义同步器的实现步骤</h3>
<p><strong>步骤1: 继承AQS</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MyLock</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Sync</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AbstractQueuedSynchronizer</span> {
        <span class="hljs-comment">// 实现同步逻辑</span>
    }

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Sync</span> <span class="hljs-variable">sync</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Sync</span>();
}
</code></pre>
<p><strong>步骤2: 定义state语义</strong></p>
<ul>
<li>独占锁: state=0未锁,state=1已锁</li>
<li>共享锁: state=剩余许可数</li>
<li>信号量: state=可用资源数</li>
</ul>
<p><strong>步骤3: 实现tryAcquire/tryRelease(独占模式)</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">protected</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">tryAcquire</span><span class="hljs-params">(<span class="hljs-type">int</span> arg)</span> {
    <span class="hljs-keyword">if</span> (compareAndSetState(<span class="hljs-number">0</span>, <span class="hljs-number">1</span>)) {
        setExclusiveOwnerThread(Thread.currentThread());
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    }
    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
}

<span class="hljs-keyword">protected</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">tryRelease</span><span class="hljs-params">(<span class="hljs-type">int</span> arg)</span> {
    setExclusiveOwnerThread(<span class="hljs-literal">null</span>);
    setState(<span class="hljs-number">0</span>);
    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
}
</code></pre>
<p><strong>步骤4: 实现tryAcquireShared/tryReleaseShared(共享模式)</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">protected</span> <span class="hljs-type">int</span> <span class="hljs-title function_">tryAcquireShared</span><span class="hljs-params">(<span class="hljs-type">int</span> arg)</span> {
    <span class="hljs-keyword">for</span> (;;) {
        <span class="hljs-type">int</span> <span class="hljs-variable">available</span> <span class="hljs-operator">=</span> getState();
        <span class="hljs-type">int</span> <span class="hljs-variable">remaining</span> <span class="hljs-operator">=</span> available - arg;
        <span class="hljs-keyword">if</span> (remaining &lt; <span class="hljs-number">0</span> || compareAndSetState(available, remaining))
            <span class="hljs-keyword">return</span> remaining;
    }
}

<span class="hljs-keyword">protected</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">tryReleaseShared</span><span class="hljs-params">(<span class="hljs-type">int</span> arg)</span> {
    <span class="hljs-keyword">for</span> (;;) {
        <span class="hljs-type">int</span> <span class="hljs-variable">current</span> <span class="hljs-operator">=</span> getState();
        <span class="hljs-type">int</span> <span class="hljs-variable">next</span> <span class="hljs-operator">=</span> current + arg;
        <span class="hljs-keyword">if</span> (compareAndSetState(current, next))
            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    }
}
</code></pre>
<p><strong>步骤5: 提供Lock API</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">lock</span><span class="hljs-params">()</span> {
    sync.acquire(<span class="hljs-number">1</span>);
}

<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">unlock</span><span class="hljs-params">()</span> {
    sync.release(<span class="hljs-number">1</span>);
}

<span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">tryLock</span><span class="hljs-params">()</span> {
    <span class="hljs-keyword">return</span> sync.tryAcquire(<span class="hljs-number">1</span>);
}
</code></pre>
<h3 data-id="heading-64">6.3 同步工具使用原则</h3>
<ol>
<li>
<p><strong>优先使用高级工具</strong></p>
<ul>
<li>使用<code>java.util.concurrent</code>包提供的工具</li>
<li>避免直接使用<code>wait/notify</code></li>
</ul>
</li>
<li>
<p><strong>锁的粒度要合适</strong></p>
<ul>
<li>锁粒度太粗 → 并发度低</li>
<li>锁粒度太细 → 复杂度高,容易死锁</li>
</ul>
</li>
<li>
<p><strong>避免锁嵌套</strong></p>
<ul>
<li>容易死锁</li>
<li>难以维护</li>
</ul>
</li>
<li>
<p><strong>及时释放锁</strong></p>
<ul>
<li>锁保护的临界区尽量小</li>
<li><code>unlock()</code>必须在<code>finally</code>块</li>
</ul>
</li>
<li>
<p><strong>优先使用非阻塞算法</strong></p>
<ul>
<li>CAS、原子类、无锁数据结构</li>
<li>性能更好,无死锁风险</li>
</ul>
</li>
</ol>
<h3 data-id="heading-65">6.4 性能优化建议</h3>
<ol>
<li>
<p><strong>减少锁竞争</strong></p>
<ul>
<li>缩小临界区</li>
<li>锁分段(ConcurrentHashMap)</li>
<li>读写分离(ReadWriteLock)</li>
</ul>
</li>
<li>
<p><strong>选择合适的锁类型</strong></p>
<ul>
<li>低竞争 → synchronized</li>
<li>高竞争 → ReentrantLock(非公平)</li>
<li>读多写少 → ReadWriteLock</li>
</ul>
</li>
<li>
<p><strong>避免锁的不必要获取</strong></p>
<ul>
<li>双重检查锁定(DCL)</li>
<li><code>tryLock()</code>尝试获取</li>
</ul>
</li>
<li>
<p><strong>使用并发容器</strong></p>
<ul>
<li><code>ConcurrentHashMap</code> 代替 <code>Hashtable</code></li>
<li><code>CopyOnWriteArrayList</code> 代替 <code>Vector</code></li>
</ul>
</li>
</ol>
<h3 data-id="heading-66">6.5 常见陷阱总结</h3>













































<table><thead><tr><th>陷阱</th><th>后果</th><th>避免方法</th></tr></thead><tbody><tr><td>unlock()不在finally</td><td>锁泄漏,死锁</td><td>必须在finally中unlock</td></tr><tr><td>CountDownLatch未countDown</td><td>线程永久阻塞</td><td>finally保证countDown</td></tr><tr><td>Semaphore获取后未释放</td><td>资源泄漏</td><td>finally保证release</td></tr><tr><td>锁重入未正确计数</td><td>锁提前释放</td><td>使用ReentrantLock</td></tr><tr><td>读锁升级为写锁</td><td>死锁</td><td>先释放读锁再获取写锁</td></tr><tr><td>synchronized(this)</td><td>锁粗粒度</td><td>使用私有锁对象</td></tr><tr><td>wait()不在while循环</td><td>虚假唤醒</td><td>用while检查条件</td></tr></tbody></table>
<h3 data-id="heading-67">6.6 总结</h3>
<p>AQS是Java并发编程的基石,深入理解AQS能够:</p>
<ol>
<li><strong>掌握JUC核心工具原理</strong>: ReentrantLock、Semaphore、CountDownLatch等</li>
<li><strong>提升并发编程能力</strong>: 选择合适的同步工具,避免常见陷阱</li>
<li><strong>优化系统性能</strong>: 根据场景选择最优方案,如读写锁、分段锁等</li>
<li><strong>自定义同步器</strong>: 在特殊场景下实现定制化同步逻辑</li>
</ol>
<p><strong>核心要点回顾:</strong></p>
<ul>
<li><strong>AQS核心</strong>: state(同步状态) + CLH队列(等待线程) + CAS(原子操作)</li>
<li><strong>独占vs共享</strong>: 独占一次唤醒一个,共享传播唤醒</li>
<li><strong>Condition</strong>: 一个Lock多个条件,精确唤醒</li>
<li><strong>ReentrantLock vs synchronized</strong>: 功能丰富 vs 简洁易用</li>
<li><strong>读写锁</strong>: 读多写少场景性能提升显著</li>
<li><strong>最佳实践</strong>: 锁粒度适中、及时释放、避免嵌套、优先非阻塞</li>
</ul>
<p>掌握AQS,你已经迈入Java并发编程高级阶段!</p>
<pre><code class="hljs"/></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Vue 3 中开发高阶组件（HOC）与 Renderless 组件]]></title>    <link>https://juejin.cn/post/7585446706327093257</link>    <guid>https://juejin.cn/post/7585446706327093257</guid>    <pubDate>2025-12-20T06:23:44.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585446706327093257" data-draft-id="7585706951583219721" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Vue 3 中开发高阶组件（HOC）与 Renderless 组件"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-12-20T06:23:44.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="用户5427784851540"/> <meta itemprop="url" content="https://juejin.cn/user/224762173330942"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Vue 3 中开发高阶组件（HOC）与 Renderless 组件
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/224762173330942/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    用户5427784851540
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-20T06:23:44.000Z" title="Sat Dec 20 2025 06:23:44 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在 Vue 3 的组合式 API（Composition API）时代，虽然官方更推荐使用 Composables（组合函数） 来复用逻辑，但理解 高阶组件（Higher-Order Component, HOC） 和 Renderless 组件（无渲染组件） 仍然具有重要价值。它们不仅是 React 生态中的经典模式，在 Vue 中也有其适用场景，尤其在需要封装复杂状态逻辑并以组件形式暴露时。</p>
<p>本文将深入讲解如何在 Vue 3 中实现这两种模式，并通过实际案例展示其用法、优势与注意事项。</p>
<hr/>
<p> </p>
<h2 data-id="heading-0">一、概念澄清</h2>
<h3 data-id="heading-1">1. 高阶组件（HOC）</h3>
<blockquote>
<p>接收一个组件作为参数，返回一个新组件的函数。</p>
</blockquote>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> <span class="hljs-title function_">withLoading</span> = (<span class="hljs-params">WrappedComponent</span>) =&gt; {
  <span class="hljs-keyword">return</span> {
    <span class="hljs-title function_">setup</span>(<span class="hljs-params">props, { slots }</span>) {
      <span class="hljs-comment">// 添加 loading 逻辑</span>
      <span class="hljs-keyword">const</span> loading = <span class="hljs-title function_">ref</span>(<span class="hljs-literal">true</span>);
      
      <span class="hljs-title function_">onMounted</span>(<span class="hljs-function">() =&gt;</span> {
        <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> loading.<span class="hljs-property">value</span> = <span class="hljs-literal">false</span>, <span class="hljs-number">1000</span>);
      });
      
      <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">h</span>(<span class="hljs-title class_">WrappedComponent</span>, {
        ...props,
        <span class="hljs-attr">loading</span>: loading.<span class="hljs-property">value</span>
      });
    }
  };
};
</code></pre>
<h3 data-id="heading-2">2. Renderless 组件（无渲染组件）</h3>
<blockquote>
<p>不包含任何 DOM 结构，只提供逻辑和数据，通过作用域插槽（scoped slot）将状态传递给子组件。</p>
</blockquote>
<pre><code class="hljs language-ini" lang="ini">&lt;template&gt;
  &lt;slot 
    :<span class="hljs-attr">loading</span>=<span class="hljs-string">"loading"</span> 
    :<span class="hljs-attr">startLoading</span>=<span class="hljs-string">"startLoading"</span>
  /&gt;
&lt;/template&gt;


&lt;script setup&gt;
import { ref } from 'vue'<span class="hljs-comment">;</span>


const <span class="hljs-attr">loading</span> = ref(<span class="hljs-literal">false</span>)<span class="hljs-comment">;</span>


const <span class="hljs-attr">startLoading</span> = () =&gt; {
  <span class="hljs-attr">loading.value</span> = <span class="hljs-literal">true</span><span class="hljs-comment">;</span>
  setTimeout(() =&gt; <span class="hljs-attr">loading.value</span> = <span class="hljs-literal">false</span>, <span class="hljs-number">1000</span>)<span class="hljs-comment">;</span>
}<span class="hljs-comment">;</span>
&lt;/script&gt;
</code></pre>
<blockquote>
<p>✅ 关键区别：HOC：包装现有组件，注入 props，Renderless：自身不渲染 UI，通过 <code>&lt;slot&gt;</code> 暴露逻辑</p>
</blockquote>
<hr/>
<p> </p>
<h2 data-id="heading-3">二、实战：开发一个通用数据加载 HOC</h2>
<h3 data-id="heading-4">场景</h3>
<p>为任意组件添加自动数据加载能力，无需重复编写 <code>loading</code>、<code>error</code>、<code>data</code> 状态管理。</p>
<h3 data-id="heading-5">步骤 1：定义 HOC 函数</h3>
<pre><code class="hljs language-ini" lang="ini">// hoc/withAsyncData.js
import { defineComponent, ref, onMounted, h } from 'vue'<span class="hljs-comment">;</span>


/**
 * 高阶组件：为组件注入异步数据加载能力
 * @param {Function} fetchFn - 数据获取函数 (返回 Promise)
 * @param {Object} options - 配置项
 * @returns {Component} 新组件
 */
export function withAsyncData(fetchFn, <span class="hljs-attr">options</span> = {}) {
  const {
    <span class="hljs-attr">loadingProp</span> = <span class="hljs-string">'loading'</span>,
    <span class="hljs-attr">dataProp</span> = <span class="hljs-string">'data'</span>,
    <span class="hljs-attr">errorProp</span> = <span class="hljs-string">'error'</span>,
    <span class="hljs-attr">autoLoad</span> = <span class="hljs-literal">true</span>
  } = options<span class="hljs-comment">;</span>


  return (WrappedComponent) =&gt; {
    return defineComponent({
      name: `WithAsyncData(${WrappedComponent.name || 'Anonymous'})`,
      
      props: WrappedComponent.props ? { ...WrappedComponent.props } : {},
      
      setup(props, { attrs, slots }) {
        const <span class="hljs-attr">loading</span> = ref(<span class="hljs-literal">false</span>)<span class="hljs-comment">;</span>
        const <span class="hljs-attr">data</span> = ref(null)<span class="hljs-comment">;</span>
        const <span class="hljs-attr">error</span> = ref(null)<span class="hljs-comment">;</span>


        const <span class="hljs-attr">loadData</span> = async () =&gt; {
          <span class="hljs-attr">loading.value</span> = <span class="hljs-literal">true</span><span class="hljs-comment">;</span>
          <span class="hljs-attr">error.value</span> = null<span class="hljs-comment">;</span>
          
          try {
            const <span class="hljs-attr">result</span> = await fetchFn()<span class="hljs-comment">;</span>
            <span class="hljs-attr">data.value</span> = result<span class="hljs-comment">;</span>
          } catch (err) {
            <span class="hljs-attr">error.value</span> = err<span class="hljs-comment">;</span>
          } finally {
            <span class="hljs-attr">loading.value</span> = <span class="hljs-literal">false</span><span class="hljs-comment">;</span>
          }
        }<span class="hljs-comment">;</span>


        if (autoLoad) {
          onMounted(loadData)<span class="hljs-comment">;</span>
        }


        // 将状态作为 props 注入 WrappedComponent
        const <span class="hljs-attr">injectedProps</span> = {
          <span class="hljs-section">[loadingProp]</span>: loading.value,
          <span class="hljs-section">[dataProp]</span>: data.value,
          <span class="hljs-section">[errorProp]</span>: error.value,
          // 提供重新加载方法
          reload: loadData
        }<span class="hljs-comment">;</span>


        return () =&gt; h(
          WrappedComponent,
          {
            ...props,
            ...attrs,
            ...injectedProps
          },
          slots
        )<span class="hljs-comment">;</span>
      }
    })<span class="hljs-comment">;</span>
  }<span class="hljs-comment">;</span>
}
</code></pre>
<h3 data-id="heading-6">步骤 2：使用 HOC</h3>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- UserList.vue --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">v-if</span>=<span class="hljs-string">"loading"</span>&gt;</span>加载中...<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">v-else-if</span>=<span class="hljs-string">"error"</span>&gt;</span>错误: {{ error.message }}<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">ul</span> <span class="hljs-attr">v-else</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">li</span> <span class="hljs-attr">v-for</span>=<span class="hljs-string">"user in data"</span> <span class="hljs-attr">:key</span>=<span class="hljs-string">"user.id"</span>&gt;</span>{{ user.name }}<span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">ul</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">button</span> @<span class="hljs-attr">click</span>=<span class="hljs-string">"reload"</span>&gt;</span>刷新<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>


<span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">import</span> { defineComponent } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>;


<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title function_">defineComponent</span>({
  <span class="hljs-attr">name</span>: <span class="hljs-string">'UserList'</span>,
  <span class="hljs-attr">props</span>: [<span class="hljs-string">'loading'</span>, <span class="hljs-string">'data'</span>, <span class="hljs-string">'error'</span>, <span class="hljs-string">'reload'</span>] <span class="hljs-comment">// 接收 HOC 注入的 props</span>
});
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
<p> </p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- App.vue --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">UserListWithAsyncData</span> /&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>


<span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">import</span> <span class="hljs-title class_">UserList</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'./UserList.vue'</span>;
<span class="hljs-keyword">import</span> { withAsyncData } <span class="hljs-keyword">from</span> <span class="hljs-string">'./hoc/withAsyncData'</span>;


<span class="hljs-comment">// 创建增强后的组件</span>
<span class="hljs-keyword">const</span> <span class="hljs-title class_">UserListWithAsyncData</span> = <span class="hljs-title function_">withAsyncData</span>(
  <span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">fetch</span>(<span class="hljs-string">'/api/users'</span>).<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">res</span> =&gt;</span> res.<span class="hljs-title function_">json</span>()),
  { <span class="hljs-attr">autoLoad</span>: <span class="hljs-literal">true</span> }
)(<span class="hljs-title class_">UserList</span>);


<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-attr">components</span>: {
    <span class="hljs-title class_">UserListWithAsyncData</span>
  }
};
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
<blockquote>
<p>✅ 优势：
逻辑复用：任何列表组件都可快速获得加载能力；
类型安全：通过 props 明确接口；
可配置：支持自定义 prop 名称</p>
</blockquote>
<hr/>
<p> </p>
<h2 data-id="heading-7">三、实战：开发 Renderless 组件</h2>
<h3 data-id="heading-8">场景</h3>
<p>创建一个通用的计数器逻辑组件，不关心 UI 如何展示。</p>
<h3 data-id="heading-9">步骤 1：创建 Renderless 组件</h3>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- renderless/CounterProvider.vue --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-comment">&lt;!-- 无任何 DOM，只暴露逻辑 --&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">slot</span> 
    <span class="hljs-attr">:count</span>=<span class="hljs-string">"count"</span>
    <span class="hljs-attr">:increment</span>=<span class="hljs-string">"increment"</span>
    <span class="hljs-attr">:decrement</span>=<span class="hljs-string">"decrement"</span>
    <span class="hljs-attr">:reset</span>=<span class="hljs-string">"reset"</span>
    <span class="hljs-attr">:isEven</span>=<span class="hljs-string">"isEven"</span>
  /&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>


<span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">setup</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">import</span> { ref, computed } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>;


<span class="hljs-keyword">const</span> props = <span class="hljs-title function_">defineProps</span>({
  <span class="hljs-attr">initialCount</span>: {
    <span class="hljs-attr">type</span>: <span class="hljs-title class_">Number</span>,
    <span class="hljs-attr">default</span>: <span class="hljs-number">0</span>
  },
  <span class="hljs-attr">min</span>: <span class="hljs-title class_">Number</span>,
  <span class="hljs-attr">max</span>: <span class="hljs-title class_">Number</span>
});


<span class="hljs-keyword">const</span> count = <span class="hljs-title function_">ref</span>(props.<span class="hljs-property">initialCount</span>);


<span class="hljs-keyword">const</span> <span class="hljs-title function_">increment</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-keyword">if</span> (props.<span class="hljs-property">max</span> === <span class="hljs-literal">undefined</span> || count.<span class="hljs-property">value</span> &lt; props.<span class="hljs-property">max</span>) {
    count.<span class="hljs-property">value</span>++;
  }
};


<span class="hljs-keyword">const</span> <span class="hljs-title function_">decrement</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-keyword">if</span> (props.<span class="hljs-property">min</span> === <span class="hljs-literal">undefined</span> || count.<span class="hljs-property">value</span> &gt; props.<span class="hljs-property">min</span>) {
    count.<span class="hljs-property">value</span>--;
  }
};


<span class="hljs-keyword">const</span> <span class="hljs-title function_">reset</span> = (<span class="hljs-params"/>) =&gt; {
  count.<span class="hljs-property">value</span> = props.<span class="hljs-property">initialCount</span>;
};


<span class="hljs-keyword">const</span> isEven = <span class="hljs-title function_">computed</span>(<span class="hljs-function">() =&gt;</span> count.<span class="hljs-property">value</span> % <span class="hljs-number">2</span> === <span class="hljs-number">0</span>);
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
<h3 data-id="heading-10">步骤 2：使用 Renderless 组件</h3>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- App.vue --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- 方式1：基础用法 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">CounterProvider</span> <span class="hljs-attr">v-slot</span>=<span class="hljs-string">"{ count, increment, decrement }"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>当前计数: {{ count }}<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> @<span class="hljs-attr">click</span>=<span class="hljs-string">"increment"</span>&gt;</span>+1<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> @<span class="hljs-attr">click</span>=<span class="hljs-string">"decrement"</span>&gt;</span>-1<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">CounterProvider</span>&gt;</span>


    <span class="hljs-comment">&lt;!-- 方式2：高级用法（带限制） --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">CounterProvider</span> 
      <span class="hljs-attr">:initial-count</span>=<span class="hljs-string">"10"</span> 
      <span class="hljs-attr">:min</span>=<span class="hljs-string">"0"</span> 
      <span class="hljs-attr">:max</span>=<span class="hljs-string">"20"</span>
      <span class="hljs-attr">v-slot</span>=<span class="hljs-string">"{ count, increment, decrement, isEven }"</span>
    &gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">:class</span>=<span class="hljs-string">"{ even: isEven }"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">h3</span>&gt;</span>受限计数器 (0~20)<span class="hljs-tag">&lt;/<span class="hljs-name">h3</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>{{ count }} {{ isEven ? '(偶数)' : '(奇数)' }}<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">button</span> @<span class="hljs-attr">click</span>=<span class="hljs-string">"increment"</span> <span class="hljs-attr">:disabled</span>=<span class="hljs-string">"count &gt;= 20"</span>&gt;</span>+1<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">button</span> @<span class="hljs-attr">click</span>=<span class="hljs-string">"decrement"</span> <span class="hljs-attr">:disabled</span>=<span class="hljs-string">"count &lt;= 0"</span>&gt;</span>-1<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">CounterProvider</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>


<span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">setup</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">import</span> <span class="hljs-title class_">CounterProvider</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'./renderless/CounterProvider.vue'</span>;
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>


<span class="hljs-tag">&lt;<span class="hljs-name">style</span> <span class="hljs-attr">scoped</span>&gt;</span><span class="css">
<span class="hljs-selector-class">.even</span> { <span class="hljs-attribute">color</span>: green; }
</span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span>
</code></pre>
<blockquote>
<p>✅ 优势：
完全解耦逻辑与 UI；
灵活组合：同一个逻辑可适配多种 UI；
类型推导：IDE 可自动提示 slot 属性；</p>
</blockquote>
<hr/>
<p> </p>
<h2 data-id="heading-11">四、HOC vs Renderless vs Composables 对比</h2>









































<table><thead><tr><th>特性</th><th>HOC</th><th>Renderless 组件</th><th>Composables</th></tr></thead><tbody><tr><td>复用方式</td><td>包装组件</td><td>作用域插槽</td><td>函数调用</td></tr><tr><td>模板侵入性</td><td>低（使用者无感知）</td><td>中（需写 ）</td><td>无</td></tr><tr><td>逻辑复杂度</td><td>适合简单 props 注入</td><td>适合状态+方法暴露</td><td>最灵活</td></tr><tr><td>TypeScript 支持</td><td>需手动处理类型</td><td>自动推导 slot 类型</td><td>最佳</td></tr><tr><td>Vue 3 推荐度</td><td>⭐⭐</td><td>⭐⭐⭐</td><td>⭐⭐⭐⭐⭐</td></tr></tbody></table>
<p>📌 建议：</p>
<blockquote>
<p>Vue 3 中优先使用 Composables，仅在以下情况考虑 HOC/Renderless：
需要以组件形式分发（如 UI 库）；
与第三方组件集成（无法修改其内部逻辑）；
团队习惯类 React 的开发模式；</p>
</blockquote>
<hr/>
<p> </p>
<h2 data-id="heading-12">五、Composables 替代方案（推荐）</h2>
<p>上述功能用 Composables 实现更简洁：</p>
<pre><code class="hljs language-ini" lang="ini">// composables/useCounter.js
import { ref, computed, watch } from 'vue'<span class="hljs-comment">;</span>


export function useCounter(<span class="hljs-attr">initialValue</span> = <span class="hljs-number">0</span>, { min, max } = {}) {
  const <span class="hljs-attr">count</span> = ref(initialValue)<span class="hljs-comment">;</span>
  
  const <span class="hljs-attr">increment</span> = () =&gt; {
    if (<span class="hljs-attr">max</span> === undefined || count.value &lt; max) count.value++<span class="hljs-comment">;</span>
  }<span class="hljs-comment">;</span>
  
  const <span class="hljs-attr">decrement</span> = () =&gt; {
    if (<span class="hljs-attr">min</span> === undefined || count.value &gt; min) count.value--<span class="hljs-comment">;</span>
  }<span class="hljs-comment">;</span>
  
  const <span class="hljs-attr">reset</span> = () =&gt; count.value = initialValue<span class="hljs-comment">;</span>
  
  const <span class="hljs-attr">isEven</span> = computed(() =&gt; count.value % <span class="hljs-number">2</span> === <span class="hljs-number">0</span>)<span class="hljs-comment">;</span>
  
  // 监听 initialValue 变化
  watch(() =&gt; initialValue, (newVal) =&gt; {
    <span class="hljs-attr">count.value</span> = newVal<span class="hljs-comment">;</span>
  })<span class="hljs-comment">;</span>
  
  return {
    count,
    increment,
    decrement,
    reset,
    isEven
  }<span class="hljs-comment">;</span>
}
</code></pre>
<p> </p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- 使用 Composables --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">setup</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">import</span> { useCounter } <span class="hljs-keyword">from</span> <span class="hljs-string">'./composables/useCounter'</span>;


<span class="hljs-keyword">const</span> { count, increment, decrement } = <span class="hljs-title function_">useCounter</span>(<span class="hljs-number">0</span>, { <span class="hljs-attr">min</span>: <span class="hljs-number">0</span>, <span class="hljs-attr">max</span>: <span class="hljs-number">10</span> });
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>


<span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>{{ count }}<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">button</span> @<span class="hljs-attr">click</span>=<span class="hljs-string">"increment"</span>&gt;</span>+1<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">button</span> @<span class="hljs-attr">click</span>=<span class="hljs-string">"decrement"</span>&gt;</span>-1<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>
</code></pre>
<p> </p>
<hr/>
<h2 data-id="heading-13">六、最佳实践与注意事项</h2>
<h3 data-id="heading-14">1. HOC 注意事项</h3>
<ul>
<li>透传 Props/Attrs/Slots：确保包装组件的行为与原组件一致</li>
<li>命名规范：使用 <code>WithXxx</code> 前缀（如 <code>WithLoading</code>）</li>
<li>避免嵌套过深：HOC 嵌套会导致调试困难</li>
</ul>
<h3 data-id="heading-15">2. Renderless 组件注意事项</h3>
<ul>
<li>明确 Slot 接口：使用 TypeScript 定义 slot props 类型</li>
<li>避免过度设计：简单逻辑直接用 Composables</li>
<li>文档说明：清晰标注暴露的 slot 属性</li>
</ul>
<h3 data-id="heading-16">3. 性能优化</h3>
<ul>
<li>缓存计算属性：使用 <code>computed</code> 而非方法</li>
<li>按需响应：只暴露必要的状态</li>
<li>清理副作用：在 <code>onUnmounted</code> 中清理定时器等</li>
</ul>
<hr/>
<p> </p>
<h2 data-id="heading-17">结语</h2>
<p>虽然 Vue 3 的 Composition API 使得 Composables 成为逻辑复用的首选，但理解 HOC 和 Renderless 组件仍有其价值：</p>
<ul>
<li>HOC 适合对现有组件进行“装饰”，尤其在无法修改组件源码时</li>
<li>Renderless 组件 在构建 UI 库时非常有用，允许用户完全控制渲染</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[解析Android内存分析的指标]]></title>    <link>https://juejin.cn/post/7585446706326781961</link>    <guid>https://juejin.cn/post/7585446706326781961</guid>    <pubDate>2025-12-20T05:10:11.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585446706326781961" data-draft-id="7585463258690273289" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="解析Android内存分析的指标"/> <meta itemprop="keywords" content="Android,APP"/> <meta itemprop="datePublished" content="2025-12-20T05:10:11.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="愤怒的代码"/> <meta itemprop="url" content="https://juejin.cn/user/4125023358426190"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            解析Android内存分析的指标
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4125023358426190/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    愤怒的代码
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-20T05:10:11.000Z" title="Sat Dec 20 2025 05:10:11 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    2
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在 Android 系统开发中，为了精准衡量进程的内存消耗，通常会使用 <strong>VSS、RSS、PSS、USS</strong> 这四个指标。由于内存共享机制的存在，单一的“内存占用”数字往往无法真实反映进程对系统的影响，因此这四个指标提供了不同维度的观察视角。</p>
<h2 data-id="heading-0">0x00 核心含义详解</h2>
<p>我们可以通过一个简单的模型来理解：假设进程 A 使用了 <strong>50MB 私有内存</strong>，并与进程 B 共享一个 <strong>20MB 的动态库</strong>。</p>
<h3 data-id="heading-1"><strong>VSS (Virtual Set Size) - 虚拟耗用内存</strong></h3>
<ul>
<li><strong>含义</strong>：进程能访问到的全部虚拟地址空间大小。</li>
<li><strong>包含</strong>：已分配但未实际使用的内存、映射到磁盘的文件、共享库占用的全部空间等。</li>
<li><strong>特点</strong>：数值最大。它不代表真实的物理内存消耗，对于<strong>性能分析意义较小</strong>。</li>
</ul>
<h3 data-id="heading-2"><strong>RSS (Resident Set Size) - 实际使用物理内存</strong></h3>
<ul>
<li><strong>含义</strong>：进程当前实际占用的物理内存（RAM）。</li>
<li><strong>包含</strong>：进程的私有内存 + <strong>共享库的全部大小</strong>。</li>
<li><strong>缺点</strong>：存在“重复计算”。如果有 10 个进程都用了那个 20MB 的共享库，每个进程的 RSS 都会计入这 20MB。将所有进程的 RSS 相加，会远大于系统总内存。</li>
</ul>
<h3 data-id="heading-3"><strong>PSS (Proportional Set Size) - 比例分配内存</strong></h3>
<ul>
<li><strong>含义</strong>：将共享库的大小按共享进程的数量<strong>均摊</strong>。</li>
<li><strong>计算</strong>：私有内存 + (共享库大小 / 共享该库的进程数)。</li>
<li><strong>优点</strong>：<strong>最客观的指标</strong>。如果将系统中所有进程的 PSS 相加，结果几乎等于系统实际消耗的总内存。它是衡量进程系统级负担的最佳标准。</li>
</ul>
<h3 data-id="heading-4"><strong>USS (Unique Set Size) - 进程独占内存（最常用）</strong></h3>
<ul>
<li><strong>含义</strong>：进程完全独占的物理内存。</li>
<li><strong>包含</strong>：只有该进程能访问到的 RAM 区域。</li>
<li><strong>优点</strong>：<strong>分析内存泄露的核心指标</strong>。它表示如果杀死该进程，系统能立刻回收的内存量。</li>
</ul>
<h2 data-id="heading-5">0x01 核心判断标准：为什么 USS 是“金标准”？</h2>
<p>在分析泄漏时，我们通常遵循这个优先级：<strong>USS &gt; PSS &gt; RSS &gt; VSS</strong>。</p>
<ul>
<li><strong>VSS 和 RSS 的局限性</strong>：由于 RSS 包含了共享库内存，当系统其他进程加载或卸载共享库时，你的进程 RSS 可能会波动，这会产生“伪泄漏”的干扰。</li>
<li><strong>PSS 的参考意义</strong>：PSS 能够反映你的进程对系统总内存的真实贡献。如果 PSS 持续上涨，说明你的应用正在拖慢系统。</li>
<li><strong>USS 的决定性作用</strong>：<strong>USS 只包含进程完全独占的内存。</strong> 内存泄漏本质上是进程内部的对象无法被回收，因此<strong>内存泄漏一定会直接反映在 USS 的上涨上</strong>。</li>
</ul>
<h2 data-id="heading-6">0x02 分析内存泄漏分析的流程</h2>
<h3 data-id="heading-7">第一步：建立基准线 (Baseline)</h3>
<p>在应用启动并进入主界面稳定后，记录当前的内存状态。</p>
<pre><code class="hljs language-shell" lang="shell">adb shell dumpsys meminfo &lt;your_package_name&gt;
</code></pre>
<p>重点记录：<code>TOTAL Pss</code> 和 <code>Private Dirty</code>（后者非常接近 USS）。</p>
<h3 data-id="heading-8">第二步：执行重复性操作 (Stress Test)</h3>
<p>内存泄漏通常发生在 Activity 销毁或长生命周期对象（如 Singleton、Thread）中。执行以下操作：</p>
<ol>
<li>进入一个怀疑有泄漏的页面，再退出。</li>
<li>重复上述过程 <strong>10 次以上</strong>。</li>
<li>手动触发几次 GC（在 Android Studio Profiler 中点击小垃圾桶图标，或通过 <code>adb shell cmd activity gc</code>）。</li>
</ol>
<h3 data-id="heading-9">第三步：对比观测</h3>
<p>再次运行 <code>adb shell dumpsys meminfo &lt;your_package_name&gt;</code>，观察数据变化：</p>
<ul>
<li><strong>如果 USS (Private Dirty) 阶梯式上升</strong>：说明存在<strong>私有内存泄漏</strong>（通常是 Java 对象、Bitmap 或 Native 堆内存）。</li>
<li><strong>如果 PSS 上升但 USS 稳定</strong>：这种情况极少见，可能意味着你调用的系统共享资源（如某些系统服务的缓存）在增加，而不是你进程内部的泄漏。</li>
<li><strong>如果 PSS/USS 均不增加，但 VSS 疯狂增长</strong>：说明你在不断地申请虚拟地址空间（例如创建了大量线程，每个线程占用 1MB 虚拟栈空间，但实际还没开始使用物理内存）。</li>
</ul>
<pre><code class="hljs language-shell" lang="shell">Applications Memory Usage (in Kilobytes):
Uptime: 102275 Realtime: 102275

** MEMINFO in pid 3069 [com.android.launcher3] **
                   Pss  Private  Private     Swap      Rss     Heap     Heap     Heap
                 Total    Dirty    Clean    Dirty    Total     Size    Alloc     Free
                ------   ------   ------   ------   ------   ------   ------   ------
  Native Heap    11128    11060        0        0    13796    19812    13511     2600
  Dalvik Heap     2316     2188        0        0     6620    27729     3153    24576
 Dalvik Other     2587     2264        0        0     3528                           
        Stack      736      736        0        0      740                           
       Ashmem        2        0        0        0        8                           
      Gfx dev     1244     1244        0        0     1244                           
    Other dev       36        0       36        0      284                           
     .so mmap     6076      212      128        0    54512                           
    .jar mmap     1922        0        0        0    26648                           
    .apk mmap    14824        0    13900        0    38756                           
    .ttf mmap       54        0        0        0      228                           
    .dex mmap      213        4        0        0      504                           
    .oat mmap       55        0        0        0     2044                           
    .art mmap     7794     7404        4        0    20040                           
   Other mmap     1179        4       32        0     4984                           
   EGL mtrack    40288    40288        0        0    40288                           
    GL mtrack     6104     6104        0        0     6104                           
      Unknown      466      448        0        0     1100                           
        TOTAL    97024    71956    14100        0    97024    47541    16664    27176
 
 App Summary
                       Pss(KB)                        Rss(KB)
                        ------                         ------
           Java Heap:     9596                          26660
         Native Heap:    11060                          13796
                Code:    14256                         123424
               Stack:      736                            740
            Graphics:    47636                          47636
       Private Other:     2772
              System:    10968
             Unknown:                                    9172
 
           TOTAL PSS:    97024            TOTAL RSS:   221428      TOTAL SWAP (KB):        0
 
...

</code></pre>
<h2 data-id="heading-10">0x03 针对不同类型的泄漏分析</h2>
<h3 data-id="heading-11">A. Java 层泄漏 (Activity/Fragment)</h3>
<ul>
<li>
<p><strong>现象</strong>：<code>TOTAL Pss</code> 和 <code>Java Heap</code> 持续增长。</p>
</li>
<li>
<p><strong>分析</strong>：查看 <code>dumpsys meminfo</code> 最后的 <code>Objects</code> 部分。</p>
<ul>
<li><code>Views</code> 和 <code>Activities</code> 的数量。如果你退出了页面，<code>Activities</code> 数量没有减少，那就是典型的 Activity 泄漏。</li>
</ul>
</li>
</ul>
<h3 data-id="heading-12">B. Native 层泄漏 (C++/JNI)</h3>
<ul>
<li><strong>现象</strong>：<code>Native Heap</code> 指标持续增长，且 <code>USS</code> 同步上涨。</li>
<li><strong>分析</strong>：如果你在 JNI 中使用了 <code>malloc</code> 或 <code>new</code> 但没有 <code>free</code>，这部分内存会体现在 <code>Native Heap</code> 中。</li>
</ul>
<h3 data-id="heading-13">C. 共享内存/文件描述符泄漏 (SharedMemory/FD)</h3>
<p>如果 SharedMemory 没有被正确关闭：</p>
<ul>
<li>
<p><strong>现象</strong>：<code>USS</code> 可能不会显著增长（如果你已经 <code>munmap</code> 了），但<strong>文件描述符 (FD)</strong> 会耗尽。</p>
</li>
<li>
<p><strong>检查方式</strong>：</p>
<pre><code class="hljs language-bash" lang="bash">adb shell <span class="hljs-built_in">ls</span> -l /proc/&lt;pid&gt;/fd | <span class="hljs-built_in">wc</span> -l
</code></pre>
<p>例如检查<code>3069</code>号进程(<code>com.android.launcher3</code>)</p>
<pre><code class="hljs language-shell" lang="shell">adb root
adb shell ls -l /proc/3069/fd | wc -l
<span class="hljs-meta prompt_">
# </span><span class="bash">输出</span>
<span class="hljs-meta prompt_"># </span><span class="bash">82</span>
</code></pre>
<p>重复操作后，如果 FD 数量不断增加，说明你的 <code>SharedMemory</code> 或 <code>ParcelFileDescriptor</code> 没有执行 <code>close()</code>。</p>
</li>
</ul>
<h2 data-id="heading-14">0x04 自动化检测工具推荐</h2>
<p>虽然手动分析 <code>dumpsys</code> 很有帮助，但在实际开发中，建议配合以下工具：</p>





















<table><thead><tr><th><strong>工具</strong></th><th><strong>优势</strong></th></tr></thead><tbody><tr><td><strong>LeakCanary</strong></td><td>自动化程度最高，直接在手机端弹窗告知 Java 泄漏引用链。</td></tr><tr><td><strong>Android Studio Profiler</strong></td><td>可视化实时查看 PSS 分布，支持 Capture Heap Dump 分析堆快照。</td></tr><tr><td><strong>Perfetto / Systrace</strong></td><td>适合分析 Native 层和系统级的内存分配行为。</td></tr></tbody></table></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[使用 Node.js Elasticsearch 客户端索引大型 CSV 文件]]></title>    <link>https://juejin.cn/post/7585390679398957062</link>    <guid>https://juejin.cn/post/7585390679398957062</guid>    <pubDate>2025-12-20T04:10:45.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585390679398957062" data-draft-id="7585412203978162219" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="使用 Node.js Elasticsearch 客户端索引大型 CSV 文件"/> <meta itemprop="keywords" content="Elasticsearch"/> <meta itemprop="datePublished" content="2025-12-20T04:10:45.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Elasticsearch"/> <meta itemprop="url" content="https://juejin.cn/user/2612095360441448"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            使用 Node.js Elasticsearch 客户端索引大型 CSV 文件
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2612095360441448/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Elasticsearch
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-20T04:10:45.000Z" title="Sat Dec 20 2025 04:10:45 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>作者：来自 Elastic <a href="https://link.juejin.cn?target=https%3A%2F%2Fdiscuss.elastic.co%2Fu%2Fjoshmock" title="https://discuss.elastic.co/u/joshmock" target="_blank" ref="nofollow noopener noreferrer">joshmock</a></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a63db05724934ee494f54a3ab790d1a9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRWxhc3RpY3NlYXJjaA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766808645&amp;x-signature=3Ak4aLkmgmzCh6BMEheIyUvXemY%3D" alt="" loading="lazy"/></p>
<p>使用 <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.elastic.co%2Fdocs%2Fapi%2Fdoc%2Felasticsearch%2Foperation%2Foperation-bulk" title="https://www.elastic.co/docs/api/doc/elasticsearch/operation/operation-bulk" target="_blank" ref="nofollow noopener noreferrer">bulk API</a> 可以轻松地将大量文档索引到 Elasticsearch：将你的数据记录转换为 JSON 文档，并插入指示它们应该添加到哪个索引的指令，然后将这个大的换行分隔 JSON blob 作为请求体，通过单个 HTTP 请求发送到 Elasticsearch 集群。或者，使用 Node.js 客户端的 bulk 函数。</p>
<p>更多阅读：E<a href="https://link.juejin.cn?target=https%3A%2F%2Felasticstack.blog.csdn.net%2Farticle%2Fdetails%2F124318170" title="https://elasticstack.blog.csdn.net/article/details/124318170" target="_blank" ref="nofollow noopener noreferrer">lasticsearch：使用最新的 Nodejs client 8.x 来创建索引并搜索</a></p>
<p>下面演示如何读取 CSV 文件，将其行转换为 JSON 对象，并进行索引：</p>
<pre><code class="hljs language-php" lang="php">`

<span class="hljs-number">1</span>.  import { Client } <span class="hljs-keyword">from</span> <span class="hljs-string">'@elastic/elasticsearch'</span>
<span class="hljs-number">2</span>.  import { parse } <span class="hljs-keyword">from</span> <span class="hljs-string">"csv-parse/sync"</span>
<span class="hljs-number">3</span>.  import { readFileSync } <span class="hljs-keyword">from</span> <span class="hljs-string">'node:fs'</span>

<span class="hljs-number">5</span>.  <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">csv</span> = <span class="hljs-title function_ invoke__">parse</span>(<span class="hljs-title function_ invoke__">readFileSync</span>(<span class="hljs-string">'data.csv'</span>, <span class="hljs-string">'utf8'</span>), { <span class="hljs-attr">columns</span>: <span class="hljs-literal">true</span> })
<span class="hljs-number">6</span>.  <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">operations</span> = csv.<span class="hljs-title function_ invoke__">flatMap</span>(row =&gt; [
<span class="hljs-number">7</span>.    { <span class="hljs-attr">index</span>: { <span class="hljs-attr">_index</span>: <span class="hljs-string">"my_index"</span> } },
<span class="hljs-number">8</span>.    row
<span class="hljs-number">9</span>.  ])

<span class="hljs-number">11</span>.  <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">client</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Client</span>({ node: <span class="hljs-string">'http://localhost:9200'</span> })
<span class="hljs-number">12</span>.  await client.<span class="hljs-title function_ invoke__">bulk</span>({ operations })

`AI写代码![](https:<span class="hljs-comment">//csdnimg.cn/release/blogv2/dist/pc/img/runCode/icon-arrowwhite.png)</span>
</code></pre>
<p>但是，如果你需要发送的数据量超过 Elasticsearch 单次请求能接收的大小，或者你的 CSV 文件太大，无法一次性全部加载到内存中，该怎么办？这时可以使用 <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.elastic.co%2Fdocs%2Freference%2Felasticsearch%2Fclients%2Fjavascript%2Fclient-helpers%23bulk-helper" title="https://www.elastic.co/docs/reference/elasticsearch/clients/javascript/client-helpers#bulk-helper" target="_blank" ref="nofollow noopener noreferrer">bulk helper</a>！</p>
<p>虽然 bulk API 本身已经很简单，但对于更复杂的场景，helper 提供了对流式输入的支持，可以将大型数据集拆分为多个请求等。</p>
<p>例如，如果你的 Elasticsearch 服务器只能接收小于 10MB 的 HTTP 请求，你可以通过设置 flushBytes 值来指示 bulk helper 拆分数据。每当请求即将超过设置值时，就会发送一次 bulk 请求：</p>
<pre><code class="hljs language-php" lang="php">`

<span class="hljs-number">1</span>.  <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">csv</span> = <span class="hljs-title function_ invoke__">parse</span>(<span class="hljs-title function_ invoke__">readFileSync</span>(<span class="hljs-string">'data.csv'</span>, <span class="hljs-string">'utf8'</span>), { <span class="hljs-attr">columns</span>: <span class="hljs-literal">true</span> })
<span class="hljs-number">2</span>.  await client.helpers.<span class="hljs-title function_ invoke__">bulk</span>({
<span class="hljs-number">3</span>.    <span class="hljs-attr">datasource</span>: csv,
<span class="hljs-number">4</span>.    <span class="hljs-title function_ invoke__">onDocument</span>(doc) {
<span class="hljs-number">5</span>.      <span class="hljs-keyword">return</span> { <span class="hljs-attr">index</span>: { <span class="hljs-attr">_index</span>: <span class="hljs-string">"my_index"</span> } }
<span class="hljs-number">6</span>.    },
<span class="hljs-number">7</span>.    // send a bulk request <span class="hljs-keyword">for</span> every <span class="hljs-number">9.5</span>MB
<span class="hljs-number">8</span>.    <span class="hljs-attr">flushBytes</span>: <span class="hljs-number">9500000</span>
<span class="hljs-number">9</span>.  })

`AI写代码
</code></pre>
<p>或者，如果你的 CSV 文件太大无法一次性加载到内存中，helper 可以将<a href="https://link.juejin.cn?target=https%3A%2F%2Fnodejs.org%2Fapi%2Fstream.html" title="https://nodejs.org/api/stream.html" target="_blank" ref="nofollow noopener noreferrer">流</a>作为数据源，而不是使用数组：</p>
<pre><code class="hljs language-php" lang="php">`

<span class="hljs-number">1</span>.  import { createReadStream } <span class="hljs-keyword">from</span> <span class="hljs-string">'node:fs'</span>
<span class="hljs-number">2</span>.  import { parse } <span class="hljs-keyword">from</span> <span class="hljs-string">'csv-parse'</span>

<span class="hljs-number">4</span>.  <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">parser</span> = <span class="hljs-title function_ invoke__">parse</span>({ <span class="hljs-attr">columns</span>: <span class="hljs-literal">true</span> })
<span class="hljs-number">5</span>.  await client.helpers.<span class="hljs-title function_ invoke__">bulk</span>({
<span class="hljs-number">6</span>.    <span class="hljs-attr">datasource</span>: <span class="hljs-title function_ invoke__">createReadStream</span>(<span class="hljs-string">'data.csv'</span>).<span class="hljs-title function_ invoke__">pipe</span>(parser),
<span class="hljs-number">7</span>.    <span class="hljs-title function_ invoke__">onDocument</span>(doc) {
<span class="hljs-number">8</span>.      <span class="hljs-keyword">return</span> { <span class="hljs-attr">index</span>: { <span class="hljs-attr">_index</span>: <span class="hljs-string">"my_index"</span> } }
<span class="hljs-number">9</span>.    }
<span class="hljs-number">10</span>.  })

`AI写代码![](https:<span class="hljs-comment">//csdnimg.cn/release/blogv2/dist/pc/img/runCode/icon-arrowwhite.png)</span>
</code></pre>
<p>这会将 CSV 文件中的行缓冲到内存中，解析为 JSON 对象，并让 helper 将结果刷新为一个或多个 HTTP 请求发送出去。这个解决方案不仅节省内存，而且阅读起来也和将整个文件加载到内存中的方法一样简单！</p>
<p>原文：<a href="https://link.juejin.cn?target=https%3A%2F%2Fdiscuss.elastic.co%2Ft%2Fdec-9th-2025-en-use-the-node-js-elasticsearch-client-to-index-large-csv-files%2F382901" title="https://discuss.elastic.co/t/dec-9th-2025-en-use-the-node-js-elasticsearch-client-to-index-large-csv-files/382901" target="_blank" ref="nofollow noopener noreferrer">discuss.elastic.co/t/dec-9th-2…</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[面试官问Redis主从延迟导致脏数据读怎么解决？]]></title>    <link>https://juejin.cn/post/7585686247269187593</link>    <guid>https://juejin.cn/post/7585686247269187593</guid>    <pubDate>2025-12-20T05:02:26.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585686247269187593" data-draft-id="7585382553290342436" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="面试官问Redis主从延迟导致脏数据读怎么解决？"/> <meta itemprop="keywords" content="后端,Redis,面试"/> <meta itemprop="datePublished" content="2025-12-20T05:02:26.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="想用offer打牌"/> <meta itemprop="url" content="https://juejin.cn/user/578781641968972"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            面试官问Redis主从延迟导致脏数据读怎么解决？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/578781641968972/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    想用offer打牌
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-20T05:02:26.000Z" title="Sat Dec 20 2025 05:02:26 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.8;font-weight:400;font-size:16px;word-spacing:2px;letter-spacing:2px;overflow-x:hidden;color:#3e3e3e;background-image:linear-gradient(90deg,rgba(50,0,0,.05) 3%,transparent 0),linear-gradient(1turn,rgba(50,0,0,.05) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:30px;margin-bottom:5px}.markdown-body h2{padding-bottom:12px;font-size:24px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:18px;padding-bottom:0}.markdown-body h4{font-size:1.2em;border-bottom:2px solid #ef7060;word-spacing:0!important;letter-spacing:0!important;font-size:inherit;line-height:inherit;display:block;font-weight:400;background:#ef7060;color:#fff;padding:10px;border-top-right-radius:3px;border-top-left-radius:3px;margin-right:3px}.markdown-body h5{font-size:15px}.markdown-body h6{margin-top:5px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="monokai">.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#272822;color:#ddd}.hljs-keyword,.hljs-literal,.hljs-name,.hljs-selector-tag,.hljs-strong,.hljs-tag{color:#f92672}.hljs-code{color:#66d9ef}.hljs-class .hljs-title{color:#fff}.hljs-attribute,.hljs-link,.hljs-regexp,.hljs-symbol{color:#bf79db}.hljs-addition,.hljs-built_in,.hljs-builtin-name,.hljs-bullet,.hljs-emphasis,.hljs-section,.hljs-selector-attr,.hljs-selector-pseudo,.hljs-string,.hljs-subst,.hljs-template-tag,.hljs-template-variable,.hljs-title,.hljs-type,.hljs-variable{color:#a6e22e}.hljs-comment,.hljs-deletion,.hljs-meta,.hljs-quote{color:#75715e}.hljs-doctag,.hljs-keyword,.hljs-literal,.hljs-section,.hljs-selector-id,.hljs-selector-tag,.hljs-title,.hljs-type{font-weight:700}</style><h2 data-id="heading-0">引言</h2>
<blockquote>
<p>大家好啊，今天给大家带来一个面试常问题：redis主从数据同步延迟，担心从节点读到脏数据，怎么办？Redis 主从复制默认是<strong>异步</strong>的，这意味着在 CAP 理论中，Redis 默认保证的是 <strong>AP（可用性 + 分区容错性）</strong> ，而不是 CP（强一致性）。因此，主从延迟导致的“读脏数据”（Stale Data）在理论上无法完全避免，只能通过业务策略或技术手段来缓解</p>
</blockquote>
<h2 data-id="heading-1">Redis主从架构</h2>
<p>要先弄明白为什么redis主从架构会出现脏数据读，我们才能想出对应的缓解之策。</p>
<p>举一个栗子：redis一主二从架构，主节点负责变更数据，然后同步给从节点。从节点负责读数据。因此从这样的架构来说，出现脏数据读从理论上说是不可避免的，因为主从节点数据同步无法做到零延迟。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/beb441caceb446e68c34d30d982c22cd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oOz55Sob2ZmZXLmiZPniYw=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766811746&amp;x-signature=8RnX77VUEIrXkT2iFv%2B%2FZcIR00Q%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-2">Redis主从数据同步延迟很大的常见原因</h2>
<h3 data-id="heading-3">复制积压堆积</h3>
<p>主节点每秒处理大量写操作（如高频 SET、INCR、LPUSH 等），产生大量复制流，从节点消费速度跟不上主节点生产速度，导致复制积压堆积。</p>
<p><code>lave0</code>/<code>slave1</code> 的 <code>offset</code> 与主节点 <code>master_repl_offset</code> 的差值就是是否复制积压堆积的标准。若差值持续增大，说明复制追不上。</p>
<h3 data-id="heading-4">BigKey</h3>
<p>Redis的BigKey传输是导致主从延迟最常见的原因。
Master 传输一个几十 MB 的 List 或 Hash 给 Slave，网络被占用，解析被阻塞，导致后续命令瞬间堆积延迟。</p>
<h3 data-id="heading-5">网络与硬件</h3>
<ul>
<li>
<p><strong>同局域网:</strong> 确保主从在同一机房/局域网，跨公域网同步延迟极大。</p>
</li>
<li>
<p><strong>机器负载:</strong> 检查 Slave 节点的 AOF 重写（Rewrite）或 RDB 生成是否导致 CPU 飙升，阻塞了主线程的同步回放</p>
</li>
</ul>
<h2 data-id="heading-6">解决方法</h2>
<p>我从<strong>业务容忍度</strong>、<strong>代码逻辑</strong>和<strong>运维配置</strong>三个层面来解决这个问题。</p>
<p>关键是不要试图全局解决“0延迟”，而是根据数据敏感度拆分策略。</p>
<h3 data-id="heading-7">关键业务强制读主 (Read from Master)</h3>
<p>这是最简单且最有效的方案。对于必须准确的数据，不要走读写分离的逻辑，直接路由到 Master 节点。
比如余额，库存扣减，订单状态等等。</p>
<p>在Java中，可以类似这样写：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">if</span> (isCriticalData) {
    redisTemplate.opsForValue().get(key); <span class="hljs-comment">// 配置为主库连接</span>
} <span class="hljs-keyword">else</span> {
    redisReadReplicaTemplate.opsForValue().get(key); <span class="hljs-comment">// 配置为从库连接</span>
}
</code></pre>
<h3 data-id="heading-8">使用 <code>WAIT</code> 命令 (强一致性折衷,不推荐)</h3>
<p>Redis 支持 <code>WAIT</code> 命令，它可以阻塞当前写操作的客户端，直到写操作被同步到指定数量的从节点。</p>
<ul>
<li><strong>命令:</strong> <code>WAIT numreplicas timeout</code></li>
<li><strong>逻辑:</strong> 只有当至少 <code>numreplicas</code> 个从节点确认接收到写操作后，Master 才会返回成功。</li>
<li><strong>代价:</strong> <strong>严重牺牲写性能</strong>。如果从节点故障或网络抖动，写操作会阻塞直到超时。</li>
<li><strong>适用:</strong> 极其重要且写频率较低的数据</li>
</ul>
<h3 data-id="heading-9">业务层校验 "版本号" 或 "时间戳"</h3>
<p>如果你必须读从库，但又想知道数据是否过期：</p>
<ol>
<li><strong>写入时:</strong> 在 Value 中写入一个时间戳或版本号 <code>v1</code>。</li>
<li><strong>另外存储:</strong> 将该 Key 的最新版本号 <code>v1</code> 存入一个高可用的缓存（如 Zookeeper、Etcd 或 Redis Master 的一个专用 Key）。</li>
<li><strong>读取时:</strong> 读取从库数据，对比其中的版本号与 Master/中心存储的版本号。如果不一致，说明延迟了，触发<strong>回源读主库</strong></li>
</ol>
<h3 data-id="heading-10">杜绝BigKey等</h3>
<p>还有很多策略，比如代码层我们要拆分bigkey，监控主从复制偏移量等等</p>
<h2 data-id="heading-11">总结</h2>
<p>我们要根据业务敏感度来解决这个问题，根据数据敏感度来拆分策略：</p>

























<table><thead><tr><th><strong>场景</strong></th><th><strong>示例</strong></th><th><strong>推荐策略</strong></th></tr></thead><tbody><tr><td><strong>强一致性</strong></td><td>余额、库存扣减、订单状态</td><td><strong>强制读主库 (Master)</strong></td></tr><tr><td><strong>最终一致性</strong></td><td>用户昵称、非实时排行榜、历史记录</td><td><strong>读从库 + 监控/重试</strong></td></tr><tr><td><strong>高敏感度</strong></td><td>秒杀资格、配置开关</td><td><strong>使用 <code>WAIT</code> 命令或分布式锁</strong></td></tr></tbody></table>
<ul>
<li>
<p><strong>最高优先级:</strong> 梳理业务。将<strong>必须强一致</strong>的读请求（如金额），在代码层面指定<strong>直接读 Master</strong>。这是最稳妥的。</p>
</li>
<li>
<p><strong>次优先级:</strong> 检查是否有 <strong>BigKey</strong> 阻塞了同步链路。</p>
</li>
<li>
<p><strong>可选策略:</strong> 如果必须读从库且要求较高一致性，实现一个简单的<strong>监控熔断机制</strong>（通过 Java/Go 定时检查 Offset），自动隔离高延迟的从节点</p>
</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[从零搭一个 Vue 小家：用 Vite + 路由轻松入门现代前端开发]]></title>    <link>https://juejin.cn/post/7585400495683665962</link>    <guid>https://juejin.cn/post/7585400495683665962</guid>    <pubDate>2025-12-20T04:08:42.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585400495683665962" data-draft-id="7585400495683026986" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="从零搭一个 Vue 小家：用 Vite + 路由轻松入门现代前端开发"/> <meta itemprop="keywords" content="Vue.js,前端框架,面试"/> <meta itemprop="datePublished" content="2025-12-20T04:08:42.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="鱼鱼块"/> <meta itemprop="url" content="https://juejin.cn/user/4302802432307224"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            从零搭一个 Vue 小家：用 Vite + 路由轻松入门现代前端开发
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4302802432307224/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    鱼鱼块
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-20T04:08:42.000Z" title="Sat Dec 20 2025 04:08:42 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">从零开始，轻松走进 Vue 的世界：一个“全家桶”小项目的搭建之旅</h2>
<p>如果你刚刚接触前端开发，听到“Vue”、“Vite”、“路由”这些词时是不是有点懵？别担心！我们可以把写代码想象成<strong>搭积木、装修房子、甚至安排一场家庭旅行</strong>。今天，我们就通过一个名为 <code>all-vue</code> 的小项目，带你一步步理解现代 Vue 应用是怎么“搭起来”的。</p>
<hr/>
<h3 data-id="heading-1">🏠 第一步：选好地基——用 Vite 快速建项目</h3>
<h4 data-id="heading-2"><strong>什么是vite？</strong></h4>
<blockquote>
<p><strong>Vite</strong>（法语，意为“快”）是一个由 Vue.js 作者 <strong>尤雨溪（Evan You）</strong> 主导开发的现代化前端构建工具。它旨在解决传统打包工具（如 Webpack）在开发阶段启动慢、热更新（HMR）延迟高等问题，提供极速的开发体验。</p>
</blockquote>
<p>想象你要盖一栋房子。传统方式可能要先打地基、砌砖、铺电线……繁琐又耗时。而 <strong>Vite</strong> 就像一位超级高效的建筑承包商，你只要说一句：“我要一个 Vue 房子”，它立刻给你搭好框架，连水电都通好了！</p>
<p>在终端里运行：</p>
<pre><code class="hljs language-sql" lang="sql">npm init vite<span class="hljs-variable">@latest</span> <span class="hljs-keyword">all</span><span class="hljs-operator">-</span>vue <span class="hljs-comment">-- --template vue</span>
</code></pre>
<p>几秒钟后，你就得到了一个结构清晰的项目目录。其中最关键的是：</p>
<ul>
<li><code>index.html</code>：这是你房子的“大门”，浏览器一打开就看到它。</li>
<li><code>src/main.js</code>：这是整栋房子的“总开关”，负责启动整个应用。</li>
<li><code>src/App.vue</code>：这是“客厅”，所有房间（页面）都要从这里进出。</li>
</ul>
<p>Vite 的优势在于<strong>快</strong>——修改代码后，浏览器几乎瞬间刷新，就像你换了个沙发，家人马上就能坐上去试舒服不舒服。</p>
<hr/>
<h3 data-id="heading-3">🏗️ 第二步：认识整栋楼——项目结构概览</h3>
<p>运行 <code>npm init vite@latest all-vue -- --template vue</code> 后，你会得到这样一栋“数字公寓”：</p>
<p>项目结构简略预览：</p>
<pre><code class="hljs language-bash" lang="bash">/all-vue
├── public/            <span class="hljs-comment"># 公共资源（如 logo.png）</span>
├── src/
│   ├── assets/        <span class="hljs-comment"># 图片、字体等静态资源</span>
│   ├── components/    <span class="hljs-comment"># 可复用的小部件（按钮、卡片等）</span>
│   ├── views/         <span class="hljs-comment"># 独立页面（首页、关于页等）</span>
|   |     |—— About.vue <span class="hljs-comment"># 关于页面的Vue组件</span>
|   |     |—— Home.vue <span class="hljs-comment"># 主页的vue组件</span>
│   ├── router/        <span class="hljs-comment"># 室内导航系统</span>
|   |     |—— index.js <span class="hljs-comment"># 路由总控</span>
│   ├── App.vue        <span class="hljs-comment"># 中央控制台（客厅）</span>
│   └── main.js        <span class="hljs-comment"># 智能钥匙</span>
├── index.html         <span class="hljs-comment"># 入户大门</span>
├── package.json       <span class="hljs-comment"># 公寓的“住户手册 + 装修清单”</span>
└── vite.config.js     <span class="hljs-comment"># 建筑规范说明书</span>
</code></pre>
<p>其中，<code>package.json</code> 就像这栋楼的<strong>住户手册 + 装修材料清单</strong>。打开它，你会看到：</p>
<pre><code class="hljs language-perl" lang="perl">{
  <span class="hljs-string">"name"</span>: <span class="hljs-string">"all-vue"</span>,
  <span class="hljs-string">"version"</span>: <span class="hljs-string">"0.0.0"</span>,
  <span class="hljs-string">"scripts"</span>: {
    <span class="hljs-string">"dev"</span>: <span class="hljs-string">"vite"</span>,
    <span class="hljs-string">"build"</span>: <span class="hljs-string">"vite build"</span>,
    <span class="hljs-string">"preview"</span>: <span class="hljs-string">"vite preview"</span>
  },
  <span class="hljs-string">"dependencies"</span>: {
    <span class="hljs-string">"vue"</span>: <span class="hljs-string">"^3.4.0"</span>,
    <span class="hljs-string">"vue-router"</span>: <span class="hljs-string">"^4.3.0"</span>
  },
  <span class="hljs-string">"devDependencies"</span>: {
    <span class="hljs-string">"@vitejs/plugin-vue"</span>: <span class="hljs-string">"^5.0.0"</span>,
    <span class="hljs-string">"vite"</span>: <span class="hljs-string">"^5.0.0"</span>
  }
}
</code></pre>
<ul>
<li><strong><code>dependencies</code></strong>：这是“入住必需品”，比如 Vue 框架本身、路由系统——没有它们，房子没法正常运转；</li>
<li><strong><code>devDependencies</code></strong>：这是“装修工具包”，只在开发时用（比如 Vite 构建工具），住户入住后就不需要了；</li>
<li><strong><code>scripts</code></strong>：这是“快捷指令”，比如 <code>npm run dev</code> 就是“启动预览模式”，<code>npm run build</code> 是“打包交付”。</li>
</ul>
<p>有了这份清单，任何开发者都能一键还原你的整套环境——就像照着宜家说明书组装家具一样可靠。</p>
<hr/>
<h3 data-id="heading-4">🚪 第三步：认识“大门”——index.html 的两个秘密</h3>
<p>虽然现代 Vue 应用的逻辑几乎全在 JavaScript 和 <code>.vue</code> 文件里，但一切的起点，其实是这个看似简单的 <code>index.html</code>：</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"en"</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">"UTF-8"</span> /&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">link</span> <span class="hljs-attr">rel</span>=<span class="hljs-string">"icon"</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"image/svg+xml"</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"/vite.svg"</span> /&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"viewport"</span> <span class="hljs-attr">content</span>=<span class="hljs-string">"width=device-width, initial-scale=1.0"</span> /&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>all-vue<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"app"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"module"</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"/src/main.js"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span>
</code></pre>
<p>别小看这十几行代码，它藏着两个关键设计：</p>
<h4 data-id="heading-5">🔌 1. <code>&lt;div id="app"&gt;&lt;/div&gt;</code>：Vue 的“插座”</h4>
<p>你可以把它想象成墙上预留的一个<strong>智能插座面板</strong>。它本身空无一物，但一旦通电（Vue 应用启动），就会自动“投影”出整个用户界面。</p>
<p>在 <code>main.js</code> 中，我们这样写：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-title function_">createApp</span>(<span class="hljs-title class_">App</span>).<span class="hljs-title function_">mount</span>(<span class="hljs-string">'#app'</span>)
</code></pre>
<p>这句话的意思就是：“请把 <code>App.vue</code> 这个‘客厅’的内容，投射到 id 为 <code>app</code> 的那个插座上。”<br/>
没有这个插座，Vue 再厉害也无处施展；有了它，动态内容才能在静态 HTML 中生根发芽。</p>
<h4 data-id="heading-6">⚡ 2. <code>&lt;script type="module" src="/src/main.js"&gt;&lt;/script&gt;</code>：原生 ES 模块的魔法</h4>
<p>注意这里的 <code>type="module"</code>。这是现代浏览器支持的一种<strong>原生模块加载方式</strong>。传统脚本是“一股脑全塞进来”，而模块化脚本则像快递包裹——每个文件独立打包，按需引用，互不干扰。</p>
<p>Vite 正是利用了这一特性，<strong>无需打包即可直接在浏览器中运行模块化的代码</strong>。这意味着：</p>
<ul>
<li>开发时启动飞快（冷启动快）；</li>
<li>修改文件后热更新极快（HMR 精准替换）；</li>
<li>代码结构清晰，符合现代工程规范。</li>
</ul>
<p>所以，<code>index.html</code> 不仅是入口，更是连接<strong>静态 HTML 世界</strong>与<strong>动态 Vue 世界</strong>的桥梁。</p>
<hr/>
<h3 data-id="heading-7">🔑 第四步：打造“钥匙”——main.js 如何启动应用</h3>
<p>有了大门，就得有钥匙。<code>main.js</code> 就是这把精密的电子钥匙，负责激活整套智能家居系统：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> { createApp } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">App</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'./App.vue'</span>
<span class="hljs-keyword">import</span> router <span class="hljs-keyword">from</span> <span class="hljs-string">'./router'</span>
<span class="hljs-keyword">import</span> <span class="hljs-string">'./style.css'</span>

<span class="hljs-title function_">createApp</span>(<span class="hljs-title class_">App</span>).<span class="hljs-title function_">use</span>(router).<span class="hljs-title function_">mount</span>(<span class="hljs-string">'#app'</span>)
</code></pre>
<p>这段代码做了三件事，环环相扣：</p>
<ol>
<li><strong>引入核心模块</strong>：从 Vue 拿到“造房子”的工具（<code>createApp</code>），从本地拿到“客厅设计图”（<code>App.vue</code>）和“导航系统”（<code>router</code>）；</li>
<li><strong>组装系统</strong>：用 <code>.use(router)</code> 把导航插件装进主程序；</li>
<li><strong>插入插座</strong>：<code>.mount('#app')</code> 表示：“请把这套系统通电安装在 <code>index.html</code> 中 id 为 <code>app</code> 的插座上。”</li>
</ol>
<p>没有这把钥匙，再漂亮的客厅也只是一堆图纸；有了它，整个房子才真正“活”起来。</p>
<hr/>
<h3 data-id="heading-8">💡 第五步：点亮客厅——根组件 App.vue</h3>
<p>钥匙转动，门开了，我们走进 <code>App.vue</code> —— 这是所有功能的总控中心：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"app"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">nav</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">router-link</span> <span class="hljs-attr">to</span>=<span class="hljs-string">"/"</span>&gt;</span>Home<span class="hljs-tag">&lt;/<span class="hljs-name">router-link</span>&gt;</span> |
      <span class="hljs-tag">&lt;<span class="hljs-name">router-link</span> <span class="hljs-attr">to</span>=<span class="hljs-string">"/about"</span>&gt;</span>About<span class="hljs-tag">&lt;/<span class="hljs-name">router-link</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">nav</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">router-view</span> /&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>
</code></pre>
<blockquote>
<p>多人一开始会直接写 <code>&lt;div&gt;Home | About&lt;/div&gt;</code>，但这只是静态文字。要让它们变成可点击的导航，就得用 Vue Router 提供的 <code>&lt;router-link&gt;</code> 组件。</p>
</blockquote>
<p>这里有两个核心元素：</p>
<ul>
<li><strong><code>&lt;router-link&gt;</code></strong> ：智能门把手，点击不刷新页面，只切换内容；</li>
<li><strong><code>&lt;router-view /&gt;</code></strong> ：魔法地板，当前该展示哪个房间，它就实时投影出来。</li>
</ul>
<p>虽然原始文件只写了 <code>HomeAbout</code>，但正确的写法应如上所示——让文字变成可交互的导航。</p>
<hr/>
<h3 data-id="heading-9">🗺️ 第六步：装上导航系统——配置 Vue Router</h3>
<p>路由，就像是你家里的<strong>智能导航系统</strong>。没有它，你只能待在客厅；有了它，你才能自由穿梭于各个房间。</p>
<p>我们在 <code>src/router/index.js</code> 中这样配置：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> { createRouter, createWebHashHistory } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue-router'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-title class_">Home</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'../views/Home.vue'</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">About</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'../views/About.vue'</span>

<span class="hljs-keyword">const</span> routes = [
  { <span class="hljs-attr">path</span>: <span class="hljs-string">'/'</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">'Home'</span>, <span class="hljs-attr">component</span>: <span class="hljs-title class_">Home</span> },
  { <span class="hljs-attr">path</span>: <span class="hljs-string">'/about'</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">'About'</span>, <span class="hljs-attr">component</span>: <span class="hljs-title class_">About</span> }
]

<span class="hljs-keyword">const</span> router = <span class="hljs-title function_">createRouter</span>({
  <span class="hljs-attr">history</span>: <span class="hljs-title function_">createWebHashHistory</span>(),
  routes
})

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> router
</code></pre>
<p>这段代码的意思是：</p>
<ul>
<li>当用户访问 <code>/</code>（也就是主页），就显示 <code>Home.vue</code> 这个房间；</li>
<li>当用户访问 <code>/about</code>，就带他去 <code>About.vue</code> 那个房间。</li>
</ul>
<p>注意这里用了 <code>createWebHashHistory()</code>，这意味着网址会变成 <code>http://localhost:5173/#/about</code>。那个 <code>#</code> 就像门牌号里的“分隔符”，告诉系统：“后面的部分是内部房间号，不是新地址”。</p>
<hr/>
<h3 data-id="heading-10">🛋️ 第七步：布置房间——编写页面组件</h3>
<p>现在，我们来装修两个房间。</p>
<h4 data-id="heading-11">首页（Home.vue）</h4>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>Home<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>
</code></pre>
<h4 data-id="heading-12">关于页（About.vue）</h4>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>About<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>
</code></pre>
<p>每个 <code>.vue</code> 文件都是一个自包含的“功能单元”：有自己的结构（template）、逻辑（script）和样式（style）。它们彼此隔离，却能通过路由无缝切换。</p>
<hr/>
<h3 data-id="heading-13">🎨 第八步：美化家园——全局样式 style.css</h3>
<p>虽然功能齐备，但房子还是灰扑扑的。这时候，<code>style.css</code> 就派上用场了。你可以在这里写：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-tag">body</span> {
  <span class="hljs-attribute">font-family</span>: <span class="hljs-string">'Arial'</span>, sans-serif;
  <span class="hljs-attribute">background-color</span>: <span class="hljs-number">#f5f5f5</span>;
}

<span class="hljs-selector-tag">nav</span> {
  <span class="hljs-attribute">padding</span>: <span class="hljs-number">1rem</span>;
  <span class="hljs-attribute">background</span>: white;
  <span class="hljs-attribute">box-shadow</span>: <span class="hljs-number">0</span> <span class="hljs-number">2px</span> <span class="hljs-number">4px</span> <span class="hljs-built_in">rgba</span>(<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0.1</span>);
}
</code></pre>
<p>就像给墙壁刷漆、给地板打蜡，让整个家更温馨舒适。</p>
<hr/>
<h3 data-id="heading-14">▶️ 最后一步：启动你的 Vue 家园！</h3>
<p>现在，所有“装修材料”都已就位——地基打好了（Vite 项目）、大门装上了（<code>index.html</code>）、钥匙配好了（<code>main.js</code>）、客厅布置妥当（<code>App.vue</code>），连房间（<code>Home.vue</code>、<code>About.vue</code>）和导航系统（Vue Router）也都调试完毕。是时候打开电闸，点亮整栋房子了！</p>
<p>请在终端（命令行）中依次执行以下两条命令（确保你已在 <code>all-vue</code> 项目目录下）：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 第一步：安装“住户手册”里列出的所有依赖（比如 Vue 和路由）</span>
npm install

<span class="hljs-comment"># 第二步：启动开发服务器——相当于按下“智能家居总开关”</span>
npm run dev
</code></pre>
<p>运行成功后，你会看到类似这样的提示：</p>
<pre><code class="hljs language-arduino" lang="arduino">  VITE v5<span class="hljs-number">.0</span><span class="hljs-number">.0</span>  ready in <span class="hljs-number">320</span> ms

  ➜  Local:   http:<span class="hljs-comment">//localhost:5173/</span>
  ➜  Network: use --host to expose
</code></pre>
<p>这时，只需打开浏览器，访问 <strong><a href="https://link.juejin.cn?target=http%3A%2F%2Flocalhost%3A5173%2F" target="_blank" title="http://localhost:5173/" ref="nofollow noopener noreferrer">http://localhost:5173/</a></strong> （端口号可能略有不同），就能看到你的 Vue 小家啦！</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/440dcba58617403380171870481fdee4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6bG86bG85Z2X:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766808522&amp;x-signature=PS6EH4QoNScSUb1Hfyz%2Ff%2FzfYA0%3D" alt="image.png" loading="lazy"/></p>
<ul>
<li>点击 <strong>Home</strong>，客厅中央显示 “Home”；</li>
<li>点击 <strong>About</strong>，瞬间切换到 “About” 页面——<strong>全程无需刷新</strong>，就像在家自由走动一样丝滑。</li>
</ul>
<p>🎉 <strong>恭喜你！你不仅看懂了代码，还亲手让它跑起来了！</strong></p>
<p>这不再是一堆抽象的文件，而是一个真正能交互的 Web 应用。你已经完成了从“零”到“一”的飞跃——而这，正是所有伟大项目的起点。</p>
<hr/>
<h3 data-id="heading-15">🧩 总结：Vue 项目的“生活化”逻辑链</h3>
<p>让我们用一次智能家居入住体验来串起全过程：</p>
<ol>
<li><strong>Vite 是开发商</strong>：提供标准化精装修样板间；</li>
<li><strong>index.html 是入户门</strong>：设有智能插座（<code>#app</code>）和模块化接线口（<code>type="module"</code>）；</li>
<li><strong>main.js 是电子钥匙</strong>：插入后激活整套系统；</li>
<li><strong>App.vue 是中央控制台</strong>：集成导航与内容展示区；</li>
<li><strong>Vue Router 是室内导航图</strong>：定义各房间路径；</li>
<li><strong>Home.vue / About.vue 是功能房间</strong>：各自独立，按需进入；</li>
<li><strong>style.css 是全屋软装方案</strong>：统一视觉风格。</li>
</ol>
<h3 data-id="heading-16">✨ 写在最后：你已经站在 Vue 的门口</h3>
<p>这个 <code>all-vue</code> 项目虽小，却包含了现代 Vue 应用的核心骨架：<strong>组件化 + 路由 + 响应式 + 工程化构建</strong>。你不需要一开始就懂所有细节，就像学骑自行车，先扶稳车把，再慢慢蹬脚踏。</p>
<p>当你运行 <code>npm run dev</code>，看到浏览器里出现“Home”和“About”两个链接，并能自由切换时——恭喜你，你已经成功迈出了 Vue 开发的第一步！</p>
<p>接下来，你可以：</p>
<ul>
<li>在 Home 里加一张图片；</li>
<li>在 About 里写一段自我介绍；</li>
<li>用 CSS 让导航栏变彩色；</li>
<li>甚至添加第三个页面……</li>
</ul>
<p>编程不是魔法，而是一步步搭建的过程。而你，已经搭好了第一块积木。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Android View框架概览]]></title>    <link>https://juejin.cn/post/7585382553290375204</link>    <guid>https://juejin.cn/post/7585382553290375204</guid>    <pubDate>2025-12-20T04:08:17.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585382553290375204" data-draft-id="7585400495683616810" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Android View框架概览"/> <meta itemprop="keywords" content="Android,计算机图形学"/> <meta itemprop="datePublished" content="2025-12-20T04:08:17.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="StarShip"/> <meta itemprop="url" content="https://juejin.cn/user/3790771820172391"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Android View框架概览
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3790771820172391/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    StarShip
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-20T04:08:17.000Z" title="Sat Dec 20 2025 04:08:17 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    3
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一、整体分层总览</h2>
<p>先看一个“从 App 到 系统服务 到 显示系统”的文字架构图：</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-selector-attr">[ 应用进程 App Process ]</span>
    ├─ Activity
    │    └─ Window (PhoneWindow)
    │         └─ DecorView (根 ViewGroup)
    │               └─ ViewGroup ... View 树
    ├─ ViewRootImpl   (桥梁：View世界 ↔ Window/Surface世界)
    ├─ WindowManager  (Framework 接口，实现在 app 进程)
    ├─ Handler / Looper (UI线程消息循环)
    ├─ Choreographer  (基于 VSync 调度绘制/动画)
    ├─ <span class="hljs-selector-tag">Canvas</span>         (绘图 API 抽象，底层由 Skia 实现)
    ├─ Skia / HWUI    (<span class="hljs-number">2</span>D 图形引擎，生成 GPU/CPU 绘制命令)
    ├─ OpenGL ES (或 Vulkan) (与 GPU 交互接口)
    └─ Surface / SurfaceView / TextureView (图形缓冲队列的“端口”)

<span class="hljs-selector-attr">[ System Server 进程 ]</span>
    ├─ WindowManagerService (WMS)
    │    └─ 管理 Window 的层级、位置、可见、焦点等
    └─ SurfaceFlinger (图形合成服务，不在此问题核心，略提)

<span class="hljs-selector-attr">[ 显示子系统 / HAL / 驱动 ]</span>
    ├─ Hardware Composer (HWC)
    ├─ Gralloc / GPU 驱动
    └─ 显示驱动 / 屏幕
</code></pre>
<p>记住一件事：Activity 只管“想显示什么 View 树”，真正的窗口、Surface 和显示，都是 Window / WMS / Surface / ViewRootImpl 在干活。</p>
<h2 data-id="heading-1">二、UI 树相关核心概念：Activity → Window → DecorView → ViewGroup / View</h2>
<ol>
<li>
<h3 data-id="heading-2">Activity</h3>
</li>
</ol>
<ul>
<li>
<p>职责：</p>
<ul>
<li>管理一个屏幕界面的生命周期：<code>onCreate</code> / <code>onStart</code> / <code>onResume</code> 等；</li>
<li>通过 <code>setContentView()</code> 指定要显示的布局（View 树）。</li>
</ul>
</li>
<li>
<p>关键点：Activity 本身 不直接持有视图树，而是通过 Window 来间接管理 UI。</p>
</li>
</ul>
<ol start="2">
<li>
<h3 data-id="heading-3">Window &amp; WindowManager</h3>
</li>
</ol>
<ul>
<li>
<p>Window（通常是 PhoneWindow）</p>
<ul>
<li>
<p>Activity 调用 <code>getWindow()</code> 得到的就是它；</p>
</li>
<li>
<p>代表的是当前 Activity 的“窗口抽象”，负责管理：</p>
<ul>
<li>标题栏、状态栏占位、导航栏区域（需要时）；</li>
<li>内容视图（<code>setContentView()</code> 塞进去的 View 树）。</li>
</ul>
</li>
</ul>
</li>
<li>
<p>WindowManager</p>
<ul>
<li>是一个 接口，应用通过它 添加/更新/删除 Window；</li>
<li>在应用进程中，<code>WindowManager</code> 的实现是 <code>WindowManagerImpl</code>；</li>
<li>内部最终会通过 Binder 跟系统进程的 WindowManagerService (WMS) 通信。</li>
</ul>
</li>
</ul>
<ol start="3">
<li>
<h3 data-id="heading-4">DecorView</h3>
</li>
</ol>
<ul>
<li>
<p>DecorView 是 整个窗口的根 View，是一个 特殊的 ViewGroup：</p>
<ul>
<li>顶层是窗口装饰（状态栏占位、标题栏、ActionBar 等）；</li>
<li>中间是内容区域：<code>android.R.id.content</code> 对应的区域；</li>
<li>Activity 的 <code>setContentView(layout)</code> 实际上是把你的布局添加到 DecorView 的内容区域。</li>
</ul>
</li>
<li>
<p>结构示意：</p>
</li>
</ul>
<pre><code class="hljs language-scss" lang="scss">DecorView (extends FrameLayout)
    ├─ StatusBar 占位（可选）
    ├─ TitleBar / Toolbar（可选）
    └─ contentParent (id=android.R.id.content)
          └─ 你的布局根 ViewGroup (LinearLayout / ConstraintLayout / ...)
                └─ 子 View / ViewGroup ...
</code></pre>
<ol start="4">
<li>
<h3 data-id="heading-5">View &amp; ViewGroup</h3>
</li>
</ol>
<ul>
<li>
<p>View</p>
<ul>
<li>
<p>UI 的最小单元：TextView、Button、ImageView 等都继承自它；</p>
</li>
<li>
<p>负责：</p>
<ul>
<li>测量：<code>onMeasure()</code>；</li>
<li>布局位置（由父布局决定）：<code>onLayout()</code>；</li>
<li>绘制：<code>onDraw(Canvas canvas)</code>。</li>
</ul>
</li>
</ul>
</li>
</ul>
<ol start="5">
<li>
<h3 data-id="heading-6">ViewGroup</h3>
</li>
</ol>
<ul>
<li>
<p>继承自 View，是各种布局容器的基类（LinearLayout、RelativeLayout、ConstraintLayout 等）；</p>
</li>
<li>
<p>负责：</p>
<ul>
<li>管理子 View 的添加/删除；</li>
<li>在 <code>onLayout()</code> 中排列子 View</li>
</ul>
</li>
</ul>
<h2 data-id="heading-7">三、ViewRootImpl：Java View 世界 ↔ Window/Surface 世界的桥梁</h2>
<p>核心：ViewRootImpl 把 View 树绑定到一个 Window/Surface 上，并驱动 measure/layout/draw。</p>
<ol>
<li>
<h3 data-id="heading-8">ViewRootImpl 是谁创建的？</h3>
</li>
</ol>
<ul>
<li>
<p>当 Activity 第一次 <code>setContentView()</code>，并通过 <code>WindowManager.addView(DecorView, params)</code> 时：</p>
<ul>
<li><code>WindowManagerGlobal</code> 会为这个 DecorView 创建一个 ViewRootImpl 实例；</li>
<li>并把 DecorView 作为 ViewRootImpl 的“根 View”。</li>
</ul>
</li>
</ul>
<ol start="2">
<li>
<h3 data-id="heading-9">ViewRootImpl 的职责</h3>
</li>
</ol>
<ul>
<li>
<p>接收来自 WMS 的回调（比如窗口尺寸改变、可见性改变等）；</p>
</li>
<li>
<p>在 UI 线程上驱动 View 树的三大流程：</p>
<ul>
<li>
<p><code>performTraversals()</code>：</p>
<ul>
<li><code>performMeasure()</code> → 根 View 的 <code>onMeasure()</code> 链；</li>
<li><code>performLayout()</code> → 根 View 的 <code>onLayout()</code> 链；</li>
<li><code>performDraw()</code> → 根 View 的 <code>draw()</code> 链。</li>
</ul>
</li>
</ul>
</li>
<li>
<p>管理与 Surface 的绑定（通过 <code>SurfaceHolder</code>/<code>Surface</code>，与底层 BufferQueue 对接）；</p>
</li>
<li>
<p>把 <code>invalidate()</code> / <code>requestLayout()</code> 产生的重绘/重布局请求归一，在合适的 VSync 时机刷新。</p>
</li>
</ul>
<ol start="3">
<li>
<h3 data-id="heading-10">ViewRootImpl、Window、WMS 的关系图</h3>
</li>
</ol>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-selector-attr">[ Activity ]</span>
    └─ <span class="hljs-selector-attr">[ Window (PhoneWindow) ]</span>
            └─ <span class="hljs-selector-attr">[ DecorView (根 ViewGroup) ]</span>

<span class="hljs-selector-attr">[ WindowManagerImpl ]</span>  (app 进程)
    └─ <span class="hljs-built_in">addView</span>(DecorView, params)
         └─ <span class="hljs-selector-attr">[ ViewRootImpl ]</span> ←→ <span class="hljs-selector-attr">[ WMS (系统进程) ]</span>
              └─ 持有 DecorView 作为 mView
              └─ 持有 Surface (mSurface)
              └─ 负责 measure/layout/draw
</code></pre>
<h2 data-id="heading-11">四、WindowManagerService（WMS）：系统级的窗口管理者</h2>
<ul>
<li>
<p>运行在 System Server 进程；</p>
</li>
<li>
<p>管理整个系统所有窗口（应用 Window、系统栏、Dialog 等）的：</p>
<ul>
<li>Z 轴顺序（谁在上谁在下）；</li>
<li>尺寸/位置/可见性；</li>
<li>焦点、输入事件目标窗口等。</li>
</ul>
</li>
<li>
<p><code>WindowManager</code>（应用侧）所有操作最终都会通过 Binder 调用 WMS，例如：</p>
<ul>
<li><code>addView(...)</code> → <code>WMS.addWindow(...)</code>；</li>
<li><code>updateViewLayout(...)</code> → <code>WMS.relayoutWindow(...)</code>；</li>
<li><code>removeView(...)</code> → <code>WMS.removeWindow(...)</code>。</li>
</ul>
</li>
<li>
<p>WMS 决定每个 Window 拥有一个什么样的 Surface（大小、格式等），然后通知对应的 ViewRootImpl 进行渲染。</p>
</li>
</ul>
<h2 data-id="heading-12">五、Surface / Canvas / SurfaceView：图像输出的“终端”</h2>
<ol>
<li>
<h3 data-id="heading-13">Surface：显示的“画布缓冲管道”--数据驱动，以画布数据为中心，承上启下了</h3>
</li>
</ol>
<ul>
<li>
<p>Surface 本质上是一个与底层 BufferQueue 绑定的对象：</p>
<ul>
<li>上层（应用 / RenderThread / SurfaceView 的绘制线程）作为 Producer 往里写图像；</li>
<li>下层（SurfaceFlinger）作为 Consumer 从中取图像做合成。</li>
</ul>
</li>
<li>
<p>每个窗口通常对应一个 Surface：</p>
<ul>
<li>ViewRootImpl 通过 <code>mSurface</code> 把 View 的绘制结果输出到这个 Surface。</li>
</ul>
</li>
</ul>
<ol start="2">
<li>
<h3 data-id="heading-14">Canvas：提供给 View 使用的二维绘图接口</h3>
</li>
</ol>
<ul>
<li>
<p>在 <code>View#onDraw(Canvas canvas)</code> 里使用；</p>
</li>
<li>
<p>Canvas 底层其实是 调用 Skia：</p>
<ul>
<li>软件渲染：Skia 在 CPU 内存里画；</li>
<li>硬件加速：Skia 生成 GPU 绘图指令（最终通过 OpenGL ES/Vulkan 执行）。</li>
</ul>
</li>
</ul>
<ol start="3">
<li>
<h3 data-id="heading-15">SurfaceView：一个“特殊的 View”，自己有独立 Surface</h3>
</li>
</ol>
<ul>
<li>
<p>普通 View：</p>
<ul>
<li>最终都绘制到所在窗口的 同一个 Surface；</li>
<li>先由 UI 渲染生成一个层，之后由 SurfaceFlinger 合成。</li>
</ul>
</li>
<li>
<p>SurfaceView：</p>
<ul>
<li>
<p>内部会创建一个 独立的 Surface（通常是直接由系统合成到屏幕，支持视频、游戏等高性能场景）；</p>
</li>
<li>
<p>其子 View 显示区域只是一个“洞”：</p>
<ul>
<li>Window 的主 Surface 挖一个透明区域；</li>
<li>SurfaceView 专用的 Surface 显示在这个洞里。</li>
</ul>
</li>
</ul>
</li>
<li>
<p>特点：</p>
<ul>
<li>支持 单独的绘制线程（后台线程），不占用 UI 线程；</li>
<li>常用于：视频播放、相机预览、需要自定义渲染的游戏。</li>
</ul>
</li>
</ul>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-selector-attr">[ Window 的主 Surface ]</span>      <span class="hljs-selector-attr">[ SurfaceView 专用 Surface ]</span>
    ┌──────────────────┐       ┌──────────────────┐
    │ 其他普通 View 绘制 │       │   视频/游戏内容    │
    │   (UI 线程绘制)   │       │ (渲染线程绘制)     │
    │  <span class="hljs-selector-attr">[挖一个洞区域]</span>   │◀─────▶│ 对应屏幕某块区域   │
    └──────────────────┘       └──────────────────┘
</code></pre>
<h2 data-id="heading-16">六、消息、节奏与动画：Handler / Choreographer / VSync</h2>
<ol>
<li>
<h3 data-id="heading-17">Handler：UI 线程的消息驱动机制</h3>
</li>
</ol>
<ul>
<li>
<p>UI 线程有一个 Looper + MessageQueue：</p>
<ul>
<li>Handler 是发送/处理消息的工具；</li>
</ul>
</li>
<li>
<p>ViewRootImpl 的很多操作都是通过 Handler 投递到 UI 线程执行：</p>
<ul>
<li>比如 <code>requestLayout()</code> / <code>invalidate()</code> 最终会排队一个“重新测量/布局/绘制”的消息。</li>
</ul>
</li>
</ul>
<ol start="2">
<li>
<h3 data-id="heading-18">Choreographer：基于 VSync 的统一调度器</h3>
</li>
</ol>
<ul>
<li>
<p>Choreographer 挂在 UI 线程上，使用 Handler 驱动；</p>
</li>
<li>
<p>每次屏幕发出一帧 VSync 信号 时：</p>
<ul>
<li>
<p>Choreographer 收到回调，在 同一个 frame 内按顺序触发：</p>
<ul>
<li>输入处理（Input）；</li>
<li>动画（Animation）；</li>
<li>View 树绘制（Traversal → ViewRootImpl#doTraversal）。</li>
</ul>
</li>
</ul>
</li>
<li>
<p>作用：保证 UI 绘制和动画跟屏幕刷新同步，减少撕裂与抖动。</p>
</li>
</ul>
<ol start="3">
<li>
<h3 data-id="heading-19">三者关系图（UI 线程上）：</h3>
</li>
</ol>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-selector-attr">[VSync 信号]</span> ──► <span class="hljs-selector-attr">[Choreographer#doFrame()]</span>
                      │
                      ├─ 处理输入事件
                      ├─ 计算动画 (ValueAnimator, ViewPropertyAnimator...)
                      └─ 调用 ViewRootImpl<span class="hljs-selector-class">.scheduleTraversals</span>()
                               │
                               └─ Handler<span class="hljs-selector-class">.post</span>(...) -&gt; <span class="hljs-built_in">doTraversal</span>()
                                       ├─ <span class="hljs-built_in">measure</span>()
                                       ├─ <span class="hljs-built_in">layout</span>()
                                       └─ <span class="hljs-built_in">draw</span>()  (生成绘制命令 / DisplayList)
</code></pre>
<h2 data-id="heading-20">七、Skia / OpenGL ES：View 的绘制到底是怎么画出来的？</h2>
<ol>
<li>
<h3 data-id="heading-21">Skia：2D 图形引擎</h3>
</li>
</ol>
<ul>
<li>
<p>Android 中 <code>Canvas</code> 的真正执行者；</p>
</li>
<li>
<p>提供：</p>
<ul>
<li>画线、画矩形、画圆、画文本；</li>
<li>画 Bitmap、裁剪、变换等；</li>
</ul>
</li>
<li>
<p>在 Android 的 硬件加速 UI 管线（HWUI） 中：</p>
<ul>
<li>Skia 不会直接在 CPU 内存画像素；</li>
<li>而是把绘制操作转换为 GPU 命令，交给 OpenGL ES/Vulkan 执行。</li>
</ul>
</li>
</ul>
<ol start="2">
<li>
<h3 data-id="heading-22">OpenGL ES：与 GPU 对话的 API</h3>
</li>
</ol>
<ul>
<li>
<p>图形硬件标准接口；</p>
</li>
<li>
<p>在 Android 中：</p>
<ul>
<li>
<p>Skia 会调用 OpenGL ES，实现：</p>
<ul>
<li>几何变换（平移/缩放/旋转）；</li>
<li>纹理绘制（View 内容作为纹理贴在矩形上）；</li>
<li>alpha 混合、阴影、圆角等效果。</li>
</ul>
</li>
</ul>
</li>
<li>
<p>GLSurfaceView / 游戏引擎 等也会直接使用 OpenGL ES 绘制自己的内容到 Surface。</p>
</li>
</ul>
<ol start="3">
<li>
<h3 data-id="heading-23">View 绘制调用链（硬件加速时，简化版）</h3>
</li>
</ol>
<pre><code class="hljs language-scss" lang="scss">ViewRootImpl<span class="hljs-selector-class">.performDraw</span>()
    └─ DecorView<span class="hljs-selector-class">.draw</span>(canvas)
         └─ 各 View 的 <span class="hljs-built_in">onDraw</span>(canvas)
               └─ 调用 <span class="hljs-selector-tag">Canvas</span> API (drawRect/drawText/drawBitmap...)
                     └─ <span class="hljs-selector-tag">Canvas</span> → Skia
                           └─ Skia 生成 GPU 命令
                               └─ 通过 OpenGL ES / Vulkan 调用 GPU
                                   └─ GPU 在 Surface 对应的 buffer 中生成最终像素
</code></pre>
<h2 data-id="heading-24">八、综合关系大图（简化版）</h2>
<pre><code class="hljs language-less" lang="less"><span class="hljs-selector-attr">[ Activity ]</span>
    └─ 持有 <span class="hljs-selector-attr">[Window (PhoneWindow)]</span>
            └─ <span class="hljs-selector-attr">[DecorView: 根 ViewGroup]</span>
                    └─ <span class="hljs-selector-tag">ViewGroup</span> / <span class="hljs-selector-tag">View</span> 树
                          └─ <span class="hljs-selector-tag">onDraw</span>(Canvas) → <span class="hljs-selector-tag">Canvas</span> → <span class="hljs-selector-tag">Skia</span> → <span class="hljs-selector-tag">OpenGL</span> <span class="hljs-selector-tag">ES</span>

<span class="hljs-selector-attr">[ WindowManager ]</span>
    └─ <span class="hljs-selector-tag">addView</span>(DecorView, params)
          └─ 创建 <span class="hljs-selector-attr">[ViewRootImpl]</span>
                ├─ 持有 <span class="hljs-selector-tag">DecorView</span>
                ├─ 持有 <span class="hljs-selector-tag">Surface</span>
                ├─ 通过 <span class="hljs-selector-tag">Handler</span> 在 <span class="hljs-selector-tag">UI</span> 线程 <span class="hljs-selector-tag">scheduleTraversals</span>()
                └─ 和 <span class="hljs-selector-attr">[WMS]</span> 通信（窗口大小/位置/<span class="hljs-selector-tag">Surface</span> 等）

<span class="hljs-selector-attr">[ Handler / Looper / Choreographer ]</span>
    ├─ <span class="hljs-selector-tag">Looper</span> 负责 <span class="hljs-selector-tag">UI</span> 线程消息循环
    ├─ <span class="hljs-selector-tag">Handler</span> 投递 <span class="hljs-selector-tag">measure</span>/<span class="hljs-selector-tag">layout</span>/<span class="hljs-selector-tag">draw</span> 等消息
    └─ <span class="hljs-selector-tag">Choreographer</span> 使用 <span class="hljs-selector-tag">VSync</span> 回调统一驱动:
           <span class="hljs-selector-tag">Input</span> → <span class="hljs-selector-tag">Animation</span> → <span class="hljs-selector-tag">Traversal</span> (ViewRootImpl.doTraversal)

<span class="hljs-selector-attr">[ WMS (WindowManagerService) ]</span>
    └─ 管理所有 <span class="hljs-selector-tag">Window</span>
    └─ 为 <span class="hljs-selector-tag">Window</span> 分配 <span class="hljs-selector-tag">Surface</span>
    └─ 告诉 <span class="hljs-selector-tag">app</span> 端 <span class="hljs-selector-tag">ViewRootImpl</span> 窗口变化等信息

<span class="hljs-selector-attr">[ Surface / SurfaceView ]</span>
    ├─ <span class="hljs-selector-tag">Surface</span>: 与 <span class="hljs-selector-tag">BufferQueue</span> 相连，<span class="hljs-selector-tag">ViewRootImpl</span>/<span class="hljs-selector-tag">RenderThread</span> 渲染目标
    └─ <span class="hljs-selector-tag">SurfaceView</span>: 特殊 <span class="hljs-selector-tag">View</span>，自有 <span class="hljs-selector-tag">Surface</span>，可由单独线程/<span class="hljs-selector-tag">GL</span> 渲染

<span class="hljs-selector-attr">[ Skia / OpenGL ES ]</span>
    ├─ <span class="hljs-selector-tag">Skia</span>: <span class="hljs-selector-tag">Canvas</span> 的实现，生成绘制命令
    └─ <span class="hljs-selector-tag">OpenGL</span> <span class="hljs-selector-tag">ES</span>: 交给 <span class="hljs-selector-tag">GPU</span> 执行绘图，硬件加速路径
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Android 四大组件与 AMS 交互的完整对比]]></title>    <link>https://juejin.cn/post/7585463258690224137</link>    <guid>https://juejin.cn/post/7585463258690224137</guid>    <pubDate>2025-12-20T04:15:20.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585463258690224137" data-draft-id="7585227038992269350" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Android 四大组件与 AMS 交互的完整对比"/> <meta itemprop="keywords" content="面试"/> <meta itemprop="datePublished" content="2025-12-20T04:15:20.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="懒猫爱上鱼"/> <meta itemprop="url" content="https://juejin.cn/user/325111174151821"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Android 四大组件与 AMS 交互的完整对比
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/325111174151821/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    懒猫爱上鱼
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-20T04:15:20.000Z" title="Sat Dec 20 2025 04:15:20 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">引言</h2>
<p>Android 系统通过 ActivityManagerService（AMS）统一管理四大组件的生命周期和交互。虽然都是通过 Binder 与 AMS 通信，但四大组件在交互方式、生命周期管理、进程优先级等方面存在显著差异。本文将分析这些差异，帮助开发者更好地理解 Android 系统架构。</p>
<h2 data-id="heading-1">四大组件与 AMS 交互对比表</h2>


















































<table><thead><tr><th>组件</th><th>启动/注册模式</th><th>AMS数据结构</th><th>生命周期管理</th><th>进程交互</th><th>优先级管理</th><th>主要特点</th></tr></thead><tbody><tr><td>Activity</td><td>显式/隐式 Intent</td><td>ActivityStack/Task/ActivityRecord</td><td>栈式管理，AMS 严格控制状态转换</td><td>强绑定，每个状态变化都通知 AMS</td><td>前台/可见进程，由任务栈位置决定</td><td>用户交互界面，AMS 管理窗口、输入焦点</td></tr><tr><td>Service</td><td>startService()/bindService()</td><td>ServiceRecord/ConnectionRecord</td><td>启动/绑定两套生命周期，AMS 协调进程优先级</td><td>启动/停止/绑定/解绑时交互</td><td>动态变化（前台/可见/服务进程）</td><td>后台执行，AMS 管理进程保活和绑定关系</td></tr><tr><td>BroadcastReceiver</td><td>静态注册/动态注册</td><td>BroadcastQueue/ReceiverList/BroadcastRecord</td><td>瞬时执行，无持久状态，AMS 管理分发队列</td><td>发送/接收时交互，执行完即结束</td><td>无独立优先级，依赖宿主进程</td><td>事件驱动，AMS 处理权限和有序分发</td></tr><tr><td>ContentProvider</td><td>自动发布</td><td>ProviderMap/ContentProviderRecord</td><td>持久存在，与应用进程同生命周期</td><td>查询/插入/更新/删除时交互</td><td>依赖宿主进程，但 AMS 管理访问权限</td><td>数据共享，AMS 路由 URI 和权限控制</td></tr></tbody></table>
<h2 data-id="heading-2">详细交互机制分析</h2>
<h3 data-id="heading-3">1. Activity 与 AMS 交互</h3>
<p><strong>核心交互流程</strong></p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 启动流程</span>
应用进程 → <span class="hljs-attr">AMS</span>: <span class="hljs-title function_">startActivity</span>(intent)  <span class="hljs-comment">// 启动请求</span>
<span class="hljs-variable constant_">AMS</span> → 应用进程: <span class="hljs-title function_">scheduleLaunchActivity</span>()  <span class="hljs-comment">// 调度启动</span>
应用进程 → <span class="hljs-attr">AMS</span>: <span class="hljs-title function_">activityPaused</span>()  <span class="hljs-comment">// 状态同步</span>
<span class="hljs-variable constant_">AMS</span> → 其他应用进程: <span class="hljs-title function_">schedulePauseActivity</span>()  <span class="hljs-comment">// 暂停其他Activity</span>
<span class="hljs-variable constant_">AMS</span> → 应用进程: <span class="hljs-title function_">scheduleResumeActivity</span>()  <span class="hljs-comment">// 恢复当前Activity</span>
</code></pre>
<p><strong>AMS 管理要点：</strong></p>
<ul>
<li>维护 ActivityStack 和 Task 的任务栈结构</li>
<li>控制 Back Stack 回退逻辑</li>
<li>管理 Activity 的启动模式（standard、singleTop 等）</li>
<li>处理多窗口模式下的可见性</li>
<li>协调 Activity 转场动画</li>
</ul>
<p><strong>进程优先级：</strong> Activity 所在进程优先级由其在任务栈中的位置决定：</p>
<ul>
<li>前台 Activity → 前台进程（adj=0）</li>
<li>可见但不在前台 → 可见进程（adj=100）</li>
<li>完全不可见 → 缓存进程（adj=900+）</li>
</ul>
<h3 data-id="heading-4">2. Service 与 AMS 交互</h3>
<p><strong>启动服务流程：</strong></p>
<pre><code class="hljs language-js" lang="js">应用进程 → <span class="hljs-attr">AMS</span>: <span class="hljs-title function_">startService</span>(intent)
<span class="hljs-variable constant_">AMS</span> → 应用进程: <span class="hljs-title function_">scheduleCreateService</span>() → <span class="hljs-title function_">scheduleServiceArgs</span>()
<span class="hljs-comment">// 绑定服务流程</span>
应用进程 → <span class="hljs-attr">AMS</span>: <span class="hljs-title function_">bindService</span>(intent, conn, flags)
<span class="hljs-variable constant_">AMS</span> → 服务端进程: <span class="hljs-title function_">scheduleBindService</span>()
<span class="hljs-variable constant_">AMS</span> → 客户端进程: 返回 <span class="hljs-title class_">IBinder</span>
</code></pre>
<p><strong>AMS 管理要点：</strong></p>
<ul>
<li>维护 ServiceRecord 记录服务状态</li>
<li>管理 ConnectionRecord 绑定关系</li>
<li>控制服务进程的优先级</li>
<li>处理前台服务通知</li>
<li>协调跨进程服务绑定</li>
</ul>
<p><strong>进程优先级动态变化：</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// AMS 动态调整服务进程优先级</span>
<span class="hljs-keyword">if</span> (service.isForeground) {
    <span class="hljs-comment">// 前台服务，优先级最高</span>
    process.setAdj(ProcessList.FOREGROUND_APP_ADJ);  <span class="hljs-comment">// 0</span>
} <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (process.hasVisibleActivities()) {
    <span class="hljs-comment">// 绑定到可见Activity，优先级较高</span>
    process.setAdj(ProcessList.VISIBLE_APP_ADJ);  <span class="hljs-comment">// 100</span>
} <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (process.hasServices()) {
    <span class="hljs-comment">// 只有服务，无可见组件</span>
    process.setAdj(ProcessList.SERVICE_ADJ);  <span class="hljs-comment">// 500</span>
} <span class="hljs-keyword">else</span> {
    <span class="hljs-comment">// 无活跃组件，优先级最低</span>
    process.setAdj(ProcessList.CACHED_APP_MIN_ADJ);  <span class="hljs-comment">// 900+</span>
}
</code></pre>
<h3 data-id="heading-5">3. BroadcastReceiver 与 AMS 交互</h3>
<p><strong>注册和发送流程：</strong></p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 注册流程</span>
应用进程 → <span class="hljs-attr">AMS</span>: <span class="hljs-title function_">registerReceiver</span>(receiver, filter)
<span class="hljs-comment">// 发送流程</span>
应用进程 → <span class="hljs-attr">AMS</span>: <span class="hljs-title function_">sendBroadcast</span>(intent)
<span class="hljs-variable constant_">AMS</span> → 接收进程: <span class="hljs-title function_">scheduleReceiver</span>()  <span class="hljs-comment">// 异步分发</span>
<span class="hljs-comment">// 执行完成后</span>
接收进程 → <span class="hljs-attr">AMS</span>: 无回调，执行完即结束
</code></pre>
<p><strong>AMS 管理要点：</strong></p>
<ul>
<li>维护广播队列（有序/无序）</li>
<li>处理粘性广播缓存</li>
<li>检查发送和接收权限</li>
<li>控制广播超时</li>
<li>管理进程优先级临时提升</li>
</ul>
<p><strong>广播执行特点：</strong></p>
<ul>
<li>瞬时执行，无生命周期状态维护</li>
<li>AMS 不跟踪接收器执行状态</li>
<li>异步分发，可能延迟或丢弃</li>
<li>可并行执行多个无序广播</li>
</ul>
<h3 data-id="heading-6">4. ContentProvider 与 AMS 交互</h3>
<p><strong>发布和查询流程：</strong></p>
<pre><code class="hljs language-js" lang="js">/ 发布流程
应用进程 → <span class="hljs-attr">AMS</span>: <span class="hljs-title function_">publishContentProviders</span>(providers)
<span class="hljs-comment">// 查询流程</span>
客户端进程 → <span class="hljs-attr">AMS</span>: <span class="hljs-title function_">getContentProvider</span>(name)
<span class="hljs-variable constant_">AMS</span> → 服务端进程: 无直接调用，返回已发布的<span class="hljs-title class_">Provider</span>接口
客户端进程 → 服务端进程: 直接调用<span class="hljs-title class_">IContentProvider</span>.<span class="hljs-title function_">query</span>()
</code></pre>
<p><strong>AMS 管理要点：</strong></p>
<ul>
<li>维护 ProviderMap 路由表</li>
<li>检查跨进程访问权限</li>
<li>管理 Provider 引用计数</li>
<li>处理 Provider 进程死亡</li>
<li>协调 URI 权限授权</li>
</ul>
<p><strong>数据共享模型：</strong></p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// AMS 中的Provider路由</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">ProviderMap</span> {
    <span class="hljs-comment">// authority → ContentProviderRecord</span>
    <span class="hljs-title class_">ArrayMap</span>&lt;<span class="hljs-title class_">String</span>, <span class="hljs-title class_">ContentProviderRecord</span>&gt; mProvidersByName;
    <span class="hljs-comment">// component → ContentProviderRecord  </span>
    <span class="hljs-title class_">ArrayMap</span>&lt;<span class="hljs-title class_">ComponentName</span>, <span class="hljs-title class_">ContentProviderRecord</span>&gt; mProvidersByClass;
}

<span class="hljs-comment">// ContentProviderRecord</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">ContentProviderRecord</span> {
    <span class="hljs-title class_">IContentProvider</span> provider;  <span class="hljs-comment">// 真正的Provider接口</span>
    <span class="hljs-title class_">ProcessRecord</span> app;          <span class="hljs-comment">// 所在进程</span>
    int externalProcessNo;      <span class="hljs-comment">// 外部进程引用计数</span>
    <span class="hljs-comment">// 当引用计数为0时，AMS可通知进程清理Provider</span>
}
</code></pre>
<h2 data-id="heading-7">跨进程通信差异</h2>
<h3 data-id="heading-8">1. Binder 通信频率</h3>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// Activity: 高频通信</span>
<span class="hljs-comment">// 每个生命周期变化都要通信</span>
<span class="hljs-title function_">onCreate</span>() ↔ <span class="hljs-title function_">onCreate</span>() 通知
<span class="hljs-title function_">onStart</span>()  ↔ <span class="hljs-title function_">onStart</span>() 通知  
<span class="hljs-title function_">onResume</span>() ↔ <span class="hljs-title function_">onResume</span>() 通知
<span class="hljs-title function_">onPause</span>()  ↔ <span class="hljs-title function_">onPause</span>() 通知
<span class="hljs-title function_">onStop</span>()   ↔ <span class="hljs-title function_">onStop</span>() 通知
<span class="hljs-title function_">onDestroy</span>()↔ <span class="hljs-title function_">onDestroy</span>() 通知

<span class="hljs-comment">// Service: 中频通信</span>
<span class="hljs-comment">// 启动/停止/绑定/解绑时通信</span>
<span class="hljs-title function_">onCreate</span>() ↔ 启动时通信
<span class="hljs-title function_">onStartCommand</span>() ↔ 每次启动通信
<span class="hljs-title function_">onBind</span>() ↔ 绑定时通信
<span class="hljs-title function_">onUnbind</span>() ↔ 解绑时通信

<span class="hljs-comment">// Broadcast: 低频通信</span>
<span class="hljs-comment">// 注册/发送时通信</span>
<span class="hljs-title function_">registerReceiver</span>() ↔ 注册时通信
<span class="hljs-title function_">sendBroadcast</span>() ↔ 发送时通信
<span class="hljs-comment">// onReceive() 执行无需回调AMS</span>

<span class="hljs-comment">// ContentProvider: 按需通信</span>
<span class="hljs-comment">// 获取Provider时通信一次</span>
<span class="hljs-title function_">getContentProvider</span>() ↔ 获取时通信
<span class="hljs-comment">// 后续操作直接与Provider进程通信</span>

</code></pre>
<h3 data-id="heading-9">2. 数据传输量</h3>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// Activity: 大量数据</span>
<span class="hljs-comment">// 传递整个ActivityRecord，包含Intent、Options等</span>
data.<span class="hljs-title function_">writeParcelable</span>(activityRecord);

<span class="hljs-comment">// Service: 中等数据  </span>
<span class="hljs-comment">// 传递Intent和启动参数</span>
data.<span class="hljs-title function_">writeParcelable</span>(service);
data.<span class="hljs-title function_">writeInt</span>(flags);
data.<span class="hljs-title function_">writeInt</span>(startId);

<span class="hljs-comment">// Broadcast: 小量数据</span>
<span class="hljs-comment">// 主要传递Intent</span>
data.<span class="hljs-title function_">writeParcelable</span>(intent);

<span class="hljs-comment">// ContentProvider: 变长数据</span>
<span class="hljs-comment">// 传递URI和查询参数</span>
data.<span class="hljs-title function_">writeParcelable</span>(uri);
data.<span class="hljs-title function_">writeStringArray</span>(projection);
data.<span class="hljs-title function_">writeString</span>(selection);
data.<span class="hljs-title function_">writeStringArray</span>(selectionArgs);

</code></pre>
<h2 data-id="heading-10">生命周期管理深度</h2>
<h3 data-id="heading-11">1. Activity 生命周期（AMS 完全控制）</h3>
<p>这个生命周期是没有设置configChanges参数。主要简单介绍一下AMS是如何参与到Activity的生命周期中的。设置了configChanges参数的有兴趣的可以单独搜索一下相关文档。
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e23535642b09449584b9c9ac713780f2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oeS54yr54ix5LiK6bG8:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766808919&amp;x-signature=LVjOadSv9XLB97Ih4n8A4rU%2Fqpc%3D" alt="Activity 生命周期.png" loading="lazy"/></p>
<h3 data-id="heading-12">2. Service 生命周期（AMS 部分控制）</h3>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 启动式服务</span>
<span class="hljs-attr">AMS</span>: 启动服务 → 应用: <span class="hljs-title function_">onCreate</span>() → <span class="hljs-title function_">onStartCommand</span>() → 运行
      ↓
<span class="hljs-attr">AMS</span>: 停止服务 → 应用: <span class="hljs-title function_">onDestroy</span>()

<span class="hljs-comment">// 绑定式服务  </span>
<span class="hljs-attr">AMS</span>: 绑定服务 → 应用: <span class="hljs-title function_">onCreate</span>() → <span class="hljs-title function_">onBind</span>() → 服务绑定
      ↓
<span class="hljs-attr">AMS</span>: 所有客户端解绑 → 应用: <span class="hljs-title function_">onUnbind</span>() → <span class="hljs-title function_">onDestroy</span>()
</code></pre>
<h3 data-id="heading-13">3. BroadcastReceiver 生命周期（AMS 不管理）</h3>
<pre><code class="hljs language-js" lang="js">/ <span class="hljs-variable constant_">AMS</span>只管理分发，不管理执行状态
<span class="hljs-attr">AMS</span>: 收到广播 → 查找接收器 → 分发到进程
应用进程: 创建<span class="hljs-title class_">Receiver</span>实例 → <span class="hljs-title function_">onReceive</span>() → 销毁实例
<span class="hljs-comment">// 执行完毕即结束，无状态跟踪</span>
</code></pre>
<h3 data-id="heading-14">4. ContentProvider 生命周期（与应用进程绑定）</h3>
<pre><code class="hljs language-js" lang="js">/ <span class="hljs-title class_">Provider</span>生命周期跟随应用进程
应用进程启动 → <span class="hljs-title function_">onCreate</span>() → 运行
      ↓
应用进程死亡 → <span class="hljs-title function_">onDestroy</span>()

<span class="hljs-comment">// AMS只管理Provider的发布和引用</span>
<span class="hljs-attr">AMS</span>: 发布<span class="hljs-title class_">Provider</span> → 增加引用 → 减少引用 → 通知清理

</code></pre>
<h2 data-id="heading-15">AMS 中的调度策略</h2>
<h3 data-id="heading-16">1. 优先级调度差异</h3>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// Activity调度：基于任务栈</span>
<span class="hljs-title class_">ActivityStack</span>.<span class="hljs-title function_">getNextActivityToResume</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// 总是恢复栈顶Activity</span>
    <span class="hljs-keyword">return</span> mActivities.<span class="hljs-title function_">get</span>(mActivities.<span class="hljs-title function_">size</span>() - <span class="hljs-number">1</span>);
}

<span class="hljs-comment">// Service调度：基于进程状态</span>
<span class="hljs-title function_">updateServiceProcessLocked</span>(<span class="hljs-params">ServiceRecord sr</span>) {
    <span class="hljs-keyword">if</span> (sr.<span class="hljs-property">isForeground</span>) {
        <span class="hljs-comment">// 前台服务，保持进程存活</span>
        <span class="hljs-title function_">keepProcessAlive</span>(sr.<span class="hljs-property">app</span>);
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (sr.<span class="hljs-property">bindings</span>.<span class="hljs-title function_">size</span>() &gt; <span class="hljs-number">0</span>) {
        <span class="hljs-comment">// 有绑定，适当保活</span>
        <span class="hljs-title function_">adjustProcessAdj</span>(sr.<span class="hljs-property">app</span>, <span class="hljs-title class_">ProcessList</span>.<span class="hljs-property">SERVICE_ADJ</span>);
    }
}

<span class="hljs-comment">// Broadcast调度：基于队列</span>
<span class="hljs-title class_">BroadcastQueue</span>.<span class="hljs-title function_">scheduleBroadcastsLocked</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// 顺序处理队列中的广播</span>
    <span class="hljs-title function_">processNextBroadcast</span>(<span class="hljs-literal">true</span>);
}

<span class="hljs-comment">// ContentProvider调度：基于需求</span>
<span class="hljs-title function_">getContentProviderImpl</span>(<span class="hljs-params">name</span>) {
    <span class="hljs-comment">// 按需启动Provider进程</span>
    <span class="hljs-keyword">if</span> (provider == <span class="hljs-literal">null</span>) {
        <span class="hljs-title function_">startProcessLocked</span>(cpr.<span class="hljs-property">processName</span>, ...);
    }
}

</code></pre>
<h3 data-id="heading-17">2. 内存管理策略</h3>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 四大组件的内存回收优先级</span>
boolean <span class="hljs-title function_">shouldKillProcess</span>(<span class="hljs-params">ProcessRecord app</span>) {
    <span class="hljs-comment">// 计算进程重要性</span>
    int importance = <span class="hljs-title function_">calculateImportance</span>(app);
    
    <span class="hljs-comment">// 判断标准（简化）：</span>
    <span class="hljs-comment">// 1. 有前台Activity的进程最后杀</span>
    <span class="hljs-comment">// 2. 有可见Activity的进程次之</span>
    <span class="hljs-comment">// 3. 有前台Service的进程再次</span>
    <span class="hljs-comment">// 4. 有普通Service的进程</span>
    <span class="hljs-comment">// 5. 有缓存Provider的进程</span>
    <span class="hljs-comment">// 6. 只有BroadcastReceiver的进程最先杀</span>
    
    <span class="hljs-keyword">return</span> importance &lt; threshold;
}

</code></pre>
<h2 data-id="heading-18">总结</h2>
<p>四大组件与 AMS 的交互体现了 Android 系统的分层设计：</p>
<ol>
<li><strong>Activity​ - 用户界面层：</strong> AMS 严格管理，确保用户体验</li>
<li><strong>Service​ - 后台任务层：</strong> AMS 协调进程优先级，平衡性能</li>
<li><strong>BroadcastReceiver​ - 事件通信层：</strong> AMS 负责路由，解耦组件</li>
<li><strong>ContentProvider​ - 数据共享层：</strong> AMS 控制访问，保证安全</li>
</ol>
<p>关键区别在于：</p>
<ul>
<li><strong>控制粒度：</strong> Activity 最细，Broadcast 最粗</li>
<li><strong>状态管理：</strong> Activity 和 Service 有状态，Broadcast 无状态</li>
<li><strong>进程影响：</strong> Activity 和前台 Service 可提升进程优先级</li>
<li><strong>通信模式：</strong> Activity/Service 双向，Broadcast 单向，Provider 按需</li>
</ul>
<p>AMS 作为系统协调者，针对不同组件的特性采用不同的管理策略，确保系统高效、稳定运行。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[[macos系统]我用的是苹果电脑, 终端的shell是zsh,而不是bash, 那我在执行.sh文件的时候, 是bash xxx.sh还是zsh xxx.sh]]></title>    <link>https://juejin.cn/post/7585382553290391588</link>    <guid>https://juejin.cn/post/7585382553290391588</guid>    <pubDate>2025-12-20T04:18:07.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585382553290391588" data-draft-id="7585400495683698730" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="[macos系统]我用的是苹果电脑, 终端的shell是zsh,而不是bash, 那我在执行.sh文件的时候, 是bash xxx.sh还是zsh xxx.sh"/> <meta itemprop="keywords" content="Shell"/> <meta itemprop="datePublished" content="2025-12-20T04:18:07.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="import_random"/> <meta itemprop="url" content="https://juejin.cn/user/2013961033882312"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            [macos系统]我用的是苹果电脑, 终端的shell是zsh,而不是bash, 那我在执行.sh文件的时候, 是bash xxx.sh还是zsh xxx.sh
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2013961033882312/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    import_random
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-20T04:18:07.000Z" title="Sat Dec 20 2025 04:18:07 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    5
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在 macOS 的 zsh 终端中执行 .sh 文件时，<strong>取决于你的需求和脚本的 shebang（第一行声明）</strong>。以下是几种情况和建议：</p>
<h2 data-id="heading-0">1. <strong>如果脚本有 shebang（推荐）</strong></h2>
<p>脚本第一行指定了解释器，例如：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-meta">#!/bin/bash</span>
</code></pre>
<p>或</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-meta">#!/bin/zsh</span>
</code></pre>
<p>可以直接执行：</p>
<pre><code class="hljs language-bash" lang="bash">./xxx.sh
</code></pre>
<p>系统会自动使用 shebang 指定的解释器。</p>
<h2 data-id="heading-1">2. <strong>如果想显式指定解释器</strong></h2>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 用 bash 执行</span>
bash xxx.sh

<span class="hljs-comment"># 用 zsh 执行</span>
zsh xxx.sh
</code></pre>
<h2 data-id="heading-2">3. <strong>重要区别</strong></h2>
<ul>
<li><strong>bash xxx.sh</strong>：强制使用 bash 解释器</li>
<li><strong>zsh xxx.sh</strong>：强制使用 zsh 解释器</li>
<li><strong>./xxx.sh</strong>：使用 shebang 指定的解释器（需要文件有执行权限）</li>
</ul>
<h2 data-id="heading-3">4. <strong>给脚本添加执行权限</strong></h2>
<p>如果经常执行，建议：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">chmod</span> +x xxx.sh
./xxx.sh
</code></pre>
<h2 data-id="heading-4">5. <strong>最佳实践</strong></h2>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 先检查脚本 shebang</span>
<span class="hljs-built_in">head</span> -1 xxx.sh

<span class="hljs-comment"># 如果有 shebang，确保有执行权限</span>
<span class="hljs-built_in">chmod</span> +x xxx.sh
./xxx.sh

<span class="hljs-comment"># 如果没有 shebang或想强制使用特定shell</span>
bash xxx.sh   <span class="hljs-comment"># 用 bash 执行</span>
zsh xxx.sh    <span class="hljs-comment"># 用 zsh 执行</span>
</code></pre>
<h2 data-id="heading-5">6. <strong>判断当前默认shell</strong></h2>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">echo</span> <span class="hljs-variable">$SHELL</span>  <span class="hljs-comment"># 显示默认登录shell</span>
<span class="hljs-built_in">echo</span> <span class="hljs-variable">$0</span>      <span class="hljs-comment"># 显示当前使用的shell</span>
</code></pre>
<p><strong>简单建议</strong>：如果脚本是 bash 写的（多数情况），用 <code>bash xxx.sh</code>；如果是 zsh 写的，用 <code>zsh xxx.sh</code>。最好给脚本加上正确的 shebang。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[工程化工具类：模块化系统全解析与实践]]></title>    <link>https://juejin.cn/post/7585412203978227755</link>    <guid>https://juejin.cn/post/7585412203978227755</guid>    <pubDate>2025-12-20T05:11:39.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585412203978227755" data-draft-id="7585390679399071750" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="工程化工具类：模块化系统全解析与实践"/> <meta itemprop="keywords" content="前端,JavaScript,面试"/> <meta itemprop="datePublished" content="2025-12-20T05:11:39.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="1024肥宅"/> <meta itemprop="url" content="https://juejin.cn/user/588993964030574"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            工程化工具类：模块化系统全解析与实践
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/588993964030574/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    1024肥宅
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-20T05:11:39.000Z" title="Sat Dec 20 2025 05:11:39 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h4 data-id="heading-0">引言</h4>
<p>在前端开发的演进历程中，模块化一直是工程化实践的核心。从早期的脚本标签堆砌到现代的ES Modules，模块化技术极大地提升了代码的可维护性、复用性和协作效率。本文将深入探讨模块化的各个方面，包括模块加载器实现、规范演化、Polyfill技术，并补充构建工具、性能优化等工程化实践，全面解析模块化在现代前端开发中的应用。</p>
<h4 data-id="heading-1">一、实现简单的模块加载器</h4>
<p>在理解复杂模块系统之前，我们先实现一个简单的模块加载器，了解其核心原理。</p>
<h5 data-id="heading-2">1.1 基础模块加载器实现</h5>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 简单的模块注册表</span>
<span class="hljs-keyword">const</span> moduleRegistry = {};
<span class="hljs-keyword">const</span> moduleCache = {};

<span class="hljs-comment">// 模块定义函数</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">define</span>(<span class="hljs-params">name, dependencies, factory</span>) {
  <span class="hljs-keyword">if</span> (!moduleRegistry[name]) {
    moduleRegistry[name] = {
      dependencies,
      factory,
      <span class="hljs-attr">resolved</span>: <span class="hljs-literal">false</span>,
      <span class="hljs-attr">exports</span>: <span class="hljs-literal">null</span>
    };
  }
}

<span class="hljs-comment">// 模块加载函数</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">require</span>(<span class="hljs-params">name</span>) {
  <span class="hljs-comment">// 检查缓存</span>
  <span class="hljs-keyword">if</span> (moduleCache[name]) {
    <span class="hljs-keyword">return</span> moduleCache[name];
  }
  
  <span class="hljs-keyword">const</span> <span class="hljs-variable language_">module</span> = moduleRegistry[name];
  <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">module</span>) {
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">`Module <span class="hljs-subst">${name}</span> not found`</span>);
  }
  
  <span class="hljs-comment">// 解析依赖</span>
  <span class="hljs-keyword">const</span> resolvedDeps = <span class="hljs-variable language_">module</span>.<span class="hljs-property">dependencies</span>.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">dep</span> =&gt;</span> {
    <span class="hljs-keyword">if</span> (dep === <span class="hljs-string">'exports'</span> || dep === <span class="hljs-string">'module'</span>) {
      <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>; <span class="hljs-comment">// 特殊处理</span>
    }
    <span class="hljs-keyword">return</span> <span class="hljs-built_in">require</span>(dep);
  });
  
  <span class="hljs-comment">// 执行工厂函数获取模块导出</span>
  <span class="hljs-keyword">const</span> factoryResult = <span class="hljs-variable language_">module</span>.<span class="hljs-property">factory</span>.<span class="hljs-title function_">apply</span>(<span class="hljs-literal">null</span>, resolvedDeps);
  
  <span class="hljs-comment">// 缓存模块导出</span>
  moduleCache[name] = factoryResult || {};
  <span class="hljs-variable language_">module</span>.<span class="hljs-property">resolved</span> = <span class="hljs-literal">true</span>;
  
  <span class="hljs-keyword">return</span> moduleCache[name];
}

<span class="hljs-comment">// 使用示例</span>
<span class="hljs-title function_">define</span>(<span class="hljs-string">'math'</span>, [], <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">return</span> {
    <span class="hljs-attr">add</span>: <span class="hljs-function">(<span class="hljs-params">a, b</span>) =&gt;</span> a + b,
    <span class="hljs-attr">multiply</span>: <span class="hljs-function">(<span class="hljs-params">a, b</span>) =&gt;</span> a * b
  };
});

<span class="hljs-title function_">define</span>(<span class="hljs-string">'calculator'</span>, [<span class="hljs-string">'math'</span>], <span class="hljs-keyword">function</span>(<span class="hljs-params">math</span>) {
  <span class="hljs-keyword">return</span> {
    <span class="hljs-attr">calculate</span>: <span class="hljs-function">(<span class="hljs-params">x, y</span>) =&gt;</span> math.<span class="hljs-title function_">multiply</span>(math.<span class="hljs-title function_">add</span>(x, y), <span class="hljs-number">2</span>)
  };
});

<span class="hljs-comment">// 使用模块</span>
<span class="hljs-keyword">const</span> calculator = <span class="hljs-built_in">require</span>(<span class="hljs-string">'calculator'</span>);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(calculator.<span class="hljs-title function_">calculate</span>(<span class="hljs-number">2</span>, <span class="hljs-number">3</span>)); <span class="hljs-comment">// 10</span>
</code></pre>
<h5 data-id="heading-3">1.2 异步模块加载器</h5>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">AsyncModuleLoader</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">modules</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>();
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">loading</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>();
  }
  
  <span class="hljs-comment">// 定义模块</span>
  <span class="hljs-title function_">define</span>(<span class="hljs-params">name, deps, factory</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">modules</span>.<span class="hljs-title function_">set</span>(name, {
      deps,
      factory,
      <span class="hljs-attr">exports</span>: <span class="hljs-literal">null</span>,
      <span class="hljs-attr">resolved</span>: <span class="hljs-literal">false</span>
    });
  }
  
  <span class="hljs-comment">// 异步加载模块</span>
  <span class="hljs-keyword">async</span> <span class="hljs-title function_">require</span>(<span class="hljs-params">name</span>) {
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">modules</span>.<span class="hljs-title function_">get</span>(name)?.<span class="hljs-property">resolved</span>) {
      <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">modules</span>.<span class="hljs-title function_">get</span>(name).<span class="hljs-property">exports</span>;
    }
    
    <span class="hljs-comment">// 防止重复加载</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">loading</span>.<span class="hljs-title function_">has</span>(name)) {
      <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">loading</span>.<span class="hljs-title function_">get</span>(name);
    }
    
    <span class="hljs-comment">// 创建加载Promise</span>
    <span class="hljs-keyword">const</span> loadPromise = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">_loadModule</span>(name);
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">loading</span>.<span class="hljs-title function_">set</span>(name, loadPromise);
    
    <span class="hljs-keyword">return</span> loadPromise;
  }
  
  <span class="hljs-keyword">async</span> <span class="hljs-title function_">_loadModule</span>(<span class="hljs-params">name</span>) {
    <span class="hljs-keyword">const</span> <span class="hljs-variable language_">module</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">modules</span>.<span class="hljs-title function_">get</span>(name);
    <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">module</span>) {
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">`Module <span class="hljs-subst">${name}</span> not found`</span>);
    }
    
    <span class="hljs-comment">// 加载所有依赖</span>
    <span class="hljs-keyword">const</span> depPromises = <span class="hljs-variable language_">module</span>.<span class="hljs-property">deps</span>.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">dep</span> =&gt;</span> <span class="hljs-variable language_">this</span>.<span class="hljs-built_in">require</span>(dep));
    <span class="hljs-keyword">const</span> deps = <span class="hljs-keyword">await</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">all</span>(depPromises);
    
    <span class="hljs-comment">// 执行工厂函数</span>
    <span class="hljs-keyword">const</span> <span class="hljs-built_in">exports</span> = <span class="hljs-variable language_">module</span>.<span class="hljs-property">factory</span>.<span class="hljs-title function_">apply</span>(<span class="hljs-literal">null</span>, deps);
    
    <span class="hljs-comment">// 更新模块状态</span>
    <span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = <span class="hljs-built_in">exports</span> || {};
    <span class="hljs-variable language_">module</span>.<span class="hljs-property">resolved</span> = <span class="hljs-literal">true</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">loading</span>.<span class="hljs-title function_">delete</span>(name);
    
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span>;
  }
}

<span class="hljs-comment">// 使用示例</span>
<span class="hljs-keyword">const</span> loader = <span class="hljs-keyword">new</span> <span class="hljs-title class_">AsyncModuleLoader</span>();

loader.<span class="hljs-title function_">define</span>(<span class="hljs-string">'utils'</span>, [], <span class="hljs-function">() =&gt;</span> ({
  <span class="hljs-attr">format</span>: <span class="hljs-function"><span class="hljs-params">str</span> =&gt;</span> str.<span class="hljs-title function_">toUpperCase</span>()
}));

loader.<span class="hljs-title function_">define</span>(<span class="hljs-string">'app'</span>, [<span class="hljs-string">'utils'</span>], <span class="hljs-function">(<span class="hljs-params">utils</span>) =&gt;</span> {
  <span class="hljs-keyword">return</span> {
    <span class="hljs-attr">run</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(utils.<span class="hljs-title function_">format</span>(<span class="hljs-string">'hello'</span>))
  };
});

loader.<span class="hljs-built_in">require</span>(<span class="hljs-string">'app'</span>).<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">app</span> =&gt;</span> app.<span class="hljs-title function_">run</span>()); <span class="hljs-comment">// 输出: HELLO</span>
</code></pre>
<h4 data-id="heading-4">二、AMD规范实现</h4>
<p>AMD（Asynchronous Module Definition）规范是RequireJS推广的异步模块定义标准。</p>
<h5 data-id="heading-5">2.1 简化的AMD实现</h5>
<pre><code class="hljs language-javascript" lang="javascript">(<span class="hljs-keyword">function</span>(<span class="hljs-params"><span class="hljs-variable language_">global</span></span>) {
  <span class="hljs-comment">// 模块缓存</span>
  <span class="hljs-keyword">const</span> modules = {};
  <span class="hljs-keyword">const</span> inProgress = {};
  
  <span class="hljs-comment">// 定义函数</span>
  <span class="hljs-keyword">function</span> <span class="hljs-title function_">define</span>(<span class="hljs-params">id, dependencies, factory</span>) {
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">arguments</span>.<span class="hljs-property">length</span> === <span class="hljs-number">2</span>) {
      factory = dependencies;
      dependencies = [];
    }
    
    modules[id] = {
      <span class="hljs-attr">id</span>: id,
      <span class="hljs-attr">dependencies</span>: dependencies,
      <span class="hljs-attr">factory</span>: factory,
      <span class="hljs-attr">exports</span>: <span class="hljs-literal">null</span>,
      <span class="hljs-attr">resolved</span>: <span class="hljs-literal">false</span>
    };
    
    <span class="hljs-comment">// 尝试解析模块</span>
    <span class="hljs-title function_">resolveModule</span>(id);
  }
  
  <span class="hljs-comment">// 依赖解析</span>
  <span class="hljs-keyword">function</span> <span class="hljs-title function_">resolveModule</span>(<span class="hljs-params">id</span>) {
    <span class="hljs-keyword">const</span> <span class="hljs-variable language_">module</span> = modules[id];
    <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">module</span> || <span class="hljs-variable language_">module</span>.<span class="hljs-property">resolved</span>) <span class="hljs-keyword">return</span>;
    
    <span class="hljs-comment">// 检查依赖是否都可用</span>
    <span class="hljs-keyword">const</span> deps = <span class="hljs-variable language_">module</span>.<span class="hljs-property">dependencies</span>;
    <span class="hljs-keyword">const</span> missingDeps = deps.<span class="hljs-title function_">filter</span>(<span class="hljs-function"><span class="hljs-params">dep</span> =&gt;</span> 
      !modules[dep] || !modules[dep].<span class="hljs-property">resolved</span>
    );
    
    <span class="hljs-keyword">if</span> (missingDeps.<span class="hljs-property">length</span> === <span class="hljs-number">0</span>) {
      <span class="hljs-comment">// 所有依赖已就绪，执行工厂函数</span>
      <span class="hljs-title function_">executeModule</span>(id);
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-comment">// 等待依赖</span>
      missingDeps.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">dep</span> =&gt;</span> {
        <span class="hljs-keyword">if</span> (!inProgress[dep]) {
          inProgress[dep] = [];
        }
        inProgress[dep].<span class="hljs-title function_">push</span>(id);
      });
    }
  }
  
  <span class="hljs-comment">// 执行模块</span>
  <span class="hljs-keyword">function</span> <span class="hljs-title function_">executeModule</span>(<span class="hljs-params">id</span>) {
    <span class="hljs-keyword">const</span> <span class="hljs-variable language_">module</span> = modules[id];
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">module</span>.<span class="hljs-property">resolved</span>) <span class="hljs-keyword">return</span>;
    
    <span class="hljs-comment">// 获取依赖的exports</span>
    <span class="hljs-keyword">const</span> depExports = <span class="hljs-variable language_">module</span>.<span class="hljs-property">dependencies</span>.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">dep</span> =&gt;</span> {
      <span class="hljs-keyword">if</span> (dep === <span class="hljs-string">'exports'</span>) <span class="hljs-keyword">return</span> {};
      <span class="hljs-keyword">if</span> (dep === <span class="hljs-string">'require'</span>) <span class="hljs-keyword">return</span> <span class="hljs-title function_">createRequire</span>();
      <span class="hljs-keyword">if</span> (dep === <span class="hljs-string">'module'</span>) <span class="hljs-keyword">return</span> { <span class="hljs-attr">id</span>: <span class="hljs-variable language_">module</span>.<span class="hljs-property">id</span>, <span class="hljs-attr">exports</span>: {} };
      <span class="hljs-keyword">return</span> modules[dep].<span class="hljs-property">exports</span>;
    });
    
    <span class="hljs-comment">// 执行工厂函数</span>
    <span class="hljs-keyword">const</span> <span class="hljs-built_in">exports</span> = <span class="hljs-variable language_">module</span>.<span class="hljs-property">factory</span>.<span class="hljs-title function_">apply</span>(<span class="hljs-literal">null</span>, depExports);
    
    <span class="hljs-comment">// 设置exports</span>
    <span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = <span class="hljs-built_in">exports</span> || 
      (depExports[<span class="hljs-variable language_">module</span>.<span class="hljs-property">dependencies</span>.<span class="hljs-title function_">indexOf</span>(<span class="hljs-string">'exports'</span>)] || {});
    <span class="hljs-variable language_">module</span>.<span class="hljs-property">resolved</span> = <span class="hljs-literal">true</span>;
    
    <span class="hljs-comment">// 通知等待此模块的其他模块</span>
    <span class="hljs-keyword">if</span> (inProgress[id]) {
      inProgress[id].<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">dependentId</span> =&gt;</span> <span class="hljs-title function_">resolveModule</span>(dependentId));
      <span class="hljs-keyword">delete</span> inProgress[id];
    }
  }
  
  <span class="hljs-comment">// 创建require函数</span>
  <span class="hljs-keyword">function</span> <span class="hljs-title function_">createRequire</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">function</span>(<span class="hljs-params">ids, callback</span>) {
      <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> ids === <span class="hljs-string">'string'</span>) ids = [ids];
      
      <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">all</span>(ids.<span class="hljs-title function_">map</span>(loadModule))
        .<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">modules</span> =&gt;</span> {
          <span class="hljs-keyword">if</span> (callback) callback.<span class="hljs-title function_">apply</span>(<span class="hljs-literal">null</span>, modules);
        });
    };
  }
  
  <span class="hljs-comment">// 异步加载模块</span>
  <span class="hljs-keyword">function</span> <span class="hljs-title function_">loadModule</span>(<span class="hljs-params">id</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> {
      <span class="hljs-keyword">if</span> (modules[id] &amp;&amp; modules[id].<span class="hljs-property">resolved</span>) {
        <span class="hljs-title function_">resolve</span>(modules[id].<span class="hljs-property">exports</span>);
        <span class="hljs-keyword">return</span>;
      }
      
      <span class="hljs-comment">// 动态加载脚本</span>
      <span class="hljs-keyword">const</span> script = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">'script'</span>);
      script.<span class="hljs-property">src</span> = id + <span class="hljs-string">'.js'</span>;
      script.<span class="hljs-property">onload</span> = <span class="hljs-function">() =&gt;</span> {
        <span class="hljs-comment">// 等待模块解析</span>
        <span class="hljs-keyword">const</span> checkInterval = <span class="hljs-built_in">setInterval</span>(<span class="hljs-function">() =&gt;</span> {
          <span class="hljs-keyword">if</span> (modules[id] &amp;&amp; modules[id].<span class="hljs-property">resolved</span>) {
            <span class="hljs-built_in">clearInterval</span>(checkInterval);
            <span class="hljs-title function_">resolve</span>(modules[id].<span class="hljs-property">exports</span>);
          }
        }, <span class="hljs-number">10</span>);
      };
      script.<span class="hljs-property">onerror</span> = reject;
      <span class="hljs-variable language_">document</span>.<span class="hljs-property">head</span>.<span class="hljs-title function_">appendChild</span>(script);
    });
  }
  
  <span class="hljs-comment">// 暴露到全局</span>
  <span class="hljs-variable language_">global</span>.<span class="hljs-property">define</span> = define;
  <span class="hljs-variable language_">global</span>.<span class="hljs-property">require</span> = <span class="hljs-title function_">createRequire</span>();
  
})(<span class="hljs-keyword">typeof</span> <span class="hljs-variable language_">window</span> !== <span class="hljs-string">'undefined'</span> ? <span class="hljs-variable language_">window</span> : <span class="hljs-variable language_">global</span>);

<span class="hljs-comment">// 使用示例</span>
<span class="hljs-title function_">define</span>(<span class="hljs-string">'math'</span>, [], <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">return</span> {
    <span class="hljs-attr">add</span>: <span class="hljs-keyword">function</span>(<span class="hljs-params">a, b</span>) { <span class="hljs-keyword">return</span> a + b; }
  };
});

<span class="hljs-title function_">define</span>(<span class="hljs-string">'app'</span>, [<span class="hljs-string">'math'</span>, <span class="hljs-string">'require'</span>], <span class="hljs-keyword">function</span>(<span class="hljs-params">math, <span class="hljs-built_in">require</span></span>) {
  <span class="hljs-keyword">return</span> {
    <span class="hljs-attr">calculate</span>: <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
      <span class="hljs-keyword">return</span> math.<span class="hljs-title function_">add</span>(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>);
    },
    <span class="hljs-attr">loadExtra</span>: <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
      <span class="hljs-built_in">require</span>([<span class="hljs-string">'utils'</span>], <span class="hljs-keyword">function</span>(<span class="hljs-params">utils</span>) {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Utils loaded'</span>);
      });
    }
  };
});

<span class="hljs-built_in">require</span>([<span class="hljs-string">'app'</span>], <span class="hljs-keyword">function</span>(<span class="hljs-params">app</span>) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(app.<span class="hljs-title function_">calculate</span>()); <span class="hljs-comment">// 3</span>
});
</code></pre>
<h4 data-id="heading-6">三、CMD规范实现</h4>
<p>CMD（Common Module Definition）规范由Sea.js推广，强调就近依赖。</p>
<h5 data-id="heading-7">3.1 简化的CMD实现</h5>
<pre><code class="hljs language-javascript" lang="javascript">(<span class="hljs-keyword">function</span>(<span class="hljs-params"><span class="hljs-variable language_">global</span></span>) {
  <span class="hljs-keyword">const</span> modules = {};
  <span class="hljs-keyword">const</span> factories = {};
  <span class="hljs-keyword">const</span> cache = {};
  
  <span class="hljs-comment">// 模块状态</span>
  <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">STATUS</span> = {
    <span class="hljs-attr">PENDING</span>: <span class="hljs-number">0</span>,
    <span class="hljs-attr">LOADING</span>: <span class="hljs-number">1</span>,
    <span class="hljs-attr">LOADED</span>: <span class="hljs-number">2</span>,
    <span class="hljs-attr">EXECUTING</span>: <span class="hljs-number">3</span>,
    <span class="hljs-attr">EXECUTED</span>: <span class="hljs-number">4</span>
  };
  
  <span class="hljs-comment">// 定义函数</span>
  <span class="hljs-keyword">function</span> <span class="hljs-title function_">define</span>(<span class="hljs-params">factory</span>) {
    <span class="hljs-comment">// 获取当前脚本</span>
    <span class="hljs-keyword">const</span> scripts = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementsByTagName</span>(<span class="hljs-string">'script'</span>);
    <span class="hljs-keyword">const</span> currentScript = scripts[scripts.<span class="hljs-property">length</span> - <span class="hljs-number">1</span>];
    <span class="hljs-keyword">const</span> id = currentScript.<span class="hljs-property">src</span>.<span class="hljs-title function_">replace</span>(<span class="hljs-regexp">/\.js$/</span>, <span class="hljs-string">''</span>);
    
    factories[id] = factory;
    modules[id] = {
      <span class="hljs-attr">id</span>: id,
      <span class="hljs-attr">factory</span>: factory,
      <span class="hljs-attr">deps</span>: [],
      <span class="hljs-attr">exports</span>: <span class="hljs-literal">null</span>,
      <span class="hljs-attr">status</span>: <span class="hljs-variable constant_">STATUS</span>.<span class="hljs-property">PENDING</span>,
      <span class="hljs-attr">callbacks</span>: []
    };
    
    <span class="hljs-comment">// 解析依赖</span>
    <span class="hljs-title function_">parseDependencies</span>(id);
  }
  
  <span class="hljs-comment">// 解析依赖</span>
  <span class="hljs-keyword">function</span> <span class="hljs-title function_">parseDependencies</span>(<span class="hljs-params">id</span>) {
    <span class="hljs-keyword">const</span> factory = factories[id];
    <span class="hljs-keyword">if</span> (!factory) <span class="hljs-keyword">return</span>;
    
    <span class="hljs-keyword">const</span> source = factory.<span class="hljs-title function_">toString</span>();
    <span class="hljs-keyword">const</span> requireRegex = <span class="hljs-regexp">/require\s*\(\s*['"]([^'"]+)['"]\s*\)/g</span>;
    <span class="hljs-keyword">const</span> deps = [];
    <span class="hljs-keyword">let</span> match;
    
    <span class="hljs-keyword">while</span> ((match = requireRegex.<span class="hljs-title function_">exec</span>(source)) !== <span class="hljs-literal">null</span>) {
      deps.<span class="hljs-title function_">push</span>(match[<span class="hljs-number">1</span>]);
    }
    
    modules[id].<span class="hljs-property">deps</span> = deps;
  }
  
  <span class="hljs-comment">// 异步加载模块</span>
  <span class="hljs-keyword">function</span> <span class="hljs-title function_">require</span>(<span class="hljs-params">id, callback</span>) {
    <span class="hljs-keyword">const</span> <span class="hljs-variable language_">module</span> = modules[id];
    
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">module</span> &amp;&amp; <span class="hljs-variable language_">module</span>.<span class="hljs-property">status</span> === <span class="hljs-variable constant_">STATUS</span>.<span class="hljs-property">EXECUTED</span>) {
      <span class="hljs-comment">// 模块已执行，直接返回</span>
      <span class="hljs-keyword">if</span> (callback) {
        <span class="hljs-title function_">callback</span>(<span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span>);
      }
      <span class="hljs-keyword">return</span> <span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span>;
    }
    
    <span class="hljs-comment">// 模块未加载，开始加载</span>
    <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">module</span> || <span class="hljs-variable language_">module</span>.<span class="hljs-property">status</span> === <span class="hljs-variable constant_">STATUS</span>.<span class="hljs-property">PENDING</span>) {
      <span class="hljs-keyword">return</span> <span class="hljs-title function_">loadModule</span>(id, callback);
    }
    
    <span class="hljs-comment">// 模块加载中，添加回调</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">module</span>.<span class="hljs-property">status</span> &lt; <span class="hljs-variable constant_">STATUS</span>.<span class="hljs-property">EXECUTED</span>) {
      <span class="hljs-variable language_">module</span>.<span class="hljs-property">callbacks</span>.<span class="hljs-title function_">push</span>(callback);
    }
  }
  
  <span class="hljs-comment">// 加载模块</span>
  <span class="hljs-keyword">function</span> <span class="hljs-title function_">loadModule</span>(<span class="hljs-params">id, callback</span>) {
    <span class="hljs-keyword">const</span> <span class="hljs-variable language_">module</span> = modules[id] || (modules[id] = {
      <span class="hljs-attr">id</span>: id,
      <span class="hljs-attr">deps</span>: [],
      <span class="hljs-attr">exports</span>: <span class="hljs-literal">null</span>,
      <span class="hljs-attr">status</span>: <span class="hljs-variable constant_">STATUS</span>.<span class="hljs-property">LOADING</span>,
      <span class="hljs-attr">callbacks</span>: callback ? [callback] : []
    });
    
    <span class="hljs-comment">// 创建script标签加载</span>
    <span class="hljs-keyword">const</span> script = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">'script'</span>);
    script.<span class="hljs-property">src</span> = id + <span class="hljs-string">'.js'</span>;
    script.<span class="hljs-property">async</span> = <span class="hljs-literal">true</span>;
    
    script.<span class="hljs-property">onload</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
      <span class="hljs-variable language_">module</span>.<span class="hljs-property">status</span> = <span class="hljs-variable constant_">STATUS</span>.<span class="hljs-property">LOADED</span>;
      <span class="hljs-title function_">executeModule</span>(id);
    };
    
    script.<span class="hljs-property">onerror</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`Failed to load module: <span class="hljs-subst">${id}</span>`</span>);
    };
    
    <span class="hljs-variable language_">document</span>.<span class="hljs-property">head</span>.<span class="hljs-title function_">appendChild</span>(script);
    
    <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
  }
  
  <span class="hljs-comment">// 执行模块</span>
  <span class="hljs-keyword">function</span> <span class="hljs-title function_">executeModule</span>(<span class="hljs-params">id</span>) {
    <span class="hljs-keyword">const</span> <span class="hljs-variable language_">module</span> = modules[id];
    <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">module</span> || <span class="hljs-variable language_">module</span>.<span class="hljs-property">status</span> &gt;= <span class="hljs-variable constant_">STATUS</span>.<span class="hljs-property">EXECUTING</span>) <span class="hljs-keyword">return</span>;
    
    <span class="hljs-variable language_">module</span>.<span class="hljs-property">status</span> = <span class="hljs-variable constant_">STATUS</span>.<span class="hljs-property">EXECUTING</span>;
    
    <span class="hljs-comment">// 收集依赖</span>
    <span class="hljs-keyword">const</span> deps = <span class="hljs-variable language_">module</span>.<span class="hljs-property">deps</span>;
    <span class="hljs-keyword">const</span> depValues = deps.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">depId</span> =&gt;</span> {
      <span class="hljs-keyword">const</span> depModule = modules[depId];
      <span class="hljs-keyword">if</span> (depModule &amp;&amp; depModule.<span class="hljs-property">status</span> === <span class="hljs-variable constant_">STATUS</span>.<span class="hljs-property">EXECUTED</span>) {
        <span class="hljs-keyword">return</span> depModule.<span class="hljs-property">exports</span>;
      }
      <span class="hljs-comment">// 同步加载依赖（简化实现）</span>
      <span class="hljs-keyword">return</span> <span class="hljs-built_in">require</span>(depId);
    });
    
    <span class="hljs-comment">// 执行工厂函数</span>
    <span class="hljs-keyword">const</span> factory = factories[id];
    <span class="hljs-keyword">if</span> (!factory) {
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">`Factory not found for module: <span class="hljs-subst">${id}</span>`</span>);
    }
    
    <span class="hljs-comment">// 提供require、exports、module参数</span>
    <span class="hljs-keyword">const</span> localRequire = <span class="hljs-keyword">function</span>(<span class="hljs-params">depId</span>) {
      <span class="hljs-keyword">return</span> <span class="hljs-built_in">require</span>(depId);
    };
    
    <span class="hljs-keyword">const</span> localExports = {};
    <span class="hljs-keyword">const</span> localModule = { <span class="hljs-attr">exports</span>: localExports };
    
    <span class="hljs-comment">// 执行</span>
    <span class="hljs-keyword">const</span> result = factory.<span class="hljs-title function_">call</span>(<span class="hljs-literal">null</span>, localRequire, localExports, localModule);
    
    <span class="hljs-comment">// 设置exports</span>
    <span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = localModule.<span class="hljs-property">exports</span> || result || localExports;
    <span class="hljs-variable language_">module</span>.<span class="hljs-property">status</span> = <span class="hljs-variable constant_">STATUS</span>.<span class="hljs-property">EXECUTED</span>;
    
    <span class="hljs-comment">// 执行回调</span>
    <span class="hljs-variable language_">module</span>.<span class="hljs-property">callbacks</span>.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">cb</span> =&gt;</span> <span class="hljs-title function_">cb</span>(<span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span>));
    <span class="hljs-variable language_">module</span>.<span class="hljs-property">callbacks</span> = [];
  }
  
  <span class="hljs-comment">// 暴露全局</span>
  <span class="hljs-variable language_">global</span>.<span class="hljs-property">define</span> = define;
  <span class="hljs-variable language_">global</span>.<span class="hljs-property">require</span> = <span class="hljs-built_in">require</span>;
  
})(<span class="hljs-keyword">typeof</span> <span class="hljs-variable language_">window</span> !== <span class="hljs-string">'undefined'</span> ? <span class="hljs-variable language_">window</span> : <span class="hljs-variable language_">global</span>);

<span class="hljs-comment">// 使用示例</span>
<span class="hljs-comment">// 文件: math.js</span>
<span class="hljs-title function_">define</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params"><span class="hljs-built_in">require</span>, <span class="hljs-built_in">exports</span>, <span class="hljs-variable language_">module</span></span>) {
  <span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = {
    <span class="hljs-attr">add</span>: <span class="hljs-keyword">function</span>(<span class="hljs-params">a, b</span>) {
      <span class="hljs-keyword">return</span> a + b;
    }
  };
});

<span class="hljs-comment">// 文件: app.js</span>
<span class="hljs-title function_">define</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params"><span class="hljs-built_in">require</span>, <span class="hljs-built_in">exports</span>, <span class="hljs-variable language_">module</span></span>) {
  <span class="hljs-keyword">var</span> math = <span class="hljs-built_in">require</span>(<span class="hljs-string">'math'</span>);
  
  <span class="hljs-built_in">exports</span>.<span class="hljs-property">calculate</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> math.<span class="hljs-title function_">add</span>(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>);
  };
});

<span class="hljs-comment">// 主文件</span>
<span class="hljs-built_in">require</span>(<span class="hljs-string">'app'</span>, <span class="hljs-keyword">function</span>(<span class="hljs-params">app</span>) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(app.<span class="hljs-title function_">calculate</span>()); <span class="hljs-comment">// 3</span>
});
</code></pre>
<h4 data-id="heading-8">四、ES Module的简单Polyfill</h4>
<p>虽然现代浏览器支持ES Modules，但在某些场景下，我们仍需要Polyfill支持。</p>
<h5 data-id="heading-9">4.1 基础ESM Polyfill实现</h5>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// ES Module Polyfill</span>
(<span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> moduleMap = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>();
  <span class="hljs-keyword">const</span> moduleCache = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>();
  
  <span class="hljs-comment">// 拦截import语句（通过动态import实现）</span>
  <span class="hljs-variable language_">window</span>.<span class="hljs-property">importModule</span> = <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span>(<span class="hljs-params">modulePath</span>) {
    <span class="hljs-comment">// 检查缓存</span>
    <span class="hljs-keyword">if</span> (moduleCache.<span class="hljs-title function_">has</span>(modulePath)) {
      <span class="hljs-keyword">return</span> moduleCache.<span class="hljs-title function_">get</span>(modulePath);
    }
    
    <span class="hljs-comment">// 加载模块代码</span>
    <span class="hljs-keyword">const</span> code = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetchModule</span>(modulePath);
    
    <span class="hljs-comment">// 解析依赖</span>
    <span class="hljs-keyword">const</span> deps = <span class="hljs-title function_">extractDependencies</span>(code);
    
    <span class="hljs-comment">// 加载依赖</span>
    <span class="hljs-keyword">const</span> depPromises = deps.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">dep</span> =&gt;</span> 
      importModule(<span class="hljs-title function_">resolvePath</span>(modulePath, dep))
    );
    <span class="hljs-keyword">const</span> dependencies = <span class="hljs-keyword">await</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">all</span>(depPromises);
    
    <span class="hljs-comment">// 执行模块</span>
    <span class="hljs-keyword">const</span> moduleExports = {};
    <span class="hljs-keyword">const</span> <span class="hljs-variable language_">module</span> = {
      <span class="hljs-attr">exports</span>: moduleExports
    };
    
    <span class="hljs-comment">// 创建包装函数</span>
    <span class="hljs-keyword">const</span> wrapper = <span class="hljs-title function_">createWrapper</span>(code, dependencies);
    <span class="hljs-title function_">wrapper</span>(
      moduleExports, <span class="hljs-comment">// exports</span>
      <span class="hljs-variable language_">module</span>,        <span class="hljs-comment">// module</span>
      modulePath     <span class="hljs-comment">// __filename（模拟）</span>
    );
    
    <span class="hljs-comment">// 缓存结果</span>
    <span class="hljs-keyword">const</span> <span class="hljs-built_in">exports</span> = <span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> === moduleExports ? 
      moduleExports : <span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span>;
    moduleCache.<span class="hljs-title function_">set</span>(modulePath, <span class="hljs-built_in">exports</span>);
    
    <span class="hljs-keyword">return</span> <span class="hljs-built_in">exports</span>;
  };
  
  <span class="hljs-comment">// 提取依赖</span>
  <span class="hljs-keyword">function</span> <span class="hljs-title function_">extractDependencies</span>(<span class="hljs-params">code</span>) {
    <span class="hljs-keyword">const</span> importRegex = <span class="hljs-regexp">/import\s+.*?\s+from\s+['"](.*?)['"]/g</span>;
    <span class="hljs-keyword">const</span> dynamicImportRegex = <span class="hljs-regexp">/import\s*\(['"](.*?)['"]\)/g</span>;
    <span class="hljs-keyword">const</span> deps = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Set</span>();
    
    <span class="hljs-keyword">let</span> match;
    <span class="hljs-keyword">while</span> ((match = importRegex.<span class="hljs-title function_">exec</span>(code)) !== <span class="hljs-literal">null</span>) {
      deps.<span class="hljs-title function_">add</span>(match[<span class="hljs-number">1</span>]);
    }
    
    <span class="hljs-comment">// 重置正则</span>
    importRegex.<span class="hljs-property">lastIndex</span> = <span class="hljs-number">0</span>;
    
    <span class="hljs-keyword">while</span> ((match = dynamicImportRegex.<span class="hljs-title function_">exec</span>(code)) !== <span class="hljs-literal">null</span>) {
      deps.<span class="hljs-title function_">add</span>(match[<span class="hljs-number">1</span>]);
    }
    
    <span class="hljs-keyword">return</span> <span class="hljs-title class_">Array</span>.<span class="hljs-title function_">from</span>(deps);
  }
  
  <span class="hljs-comment">// 创建包装函数</span>
  <span class="hljs-keyword">function</span> <span class="hljs-title function_">createWrapper</span>(<span class="hljs-params">code, dependencies</span>) {
    <span class="hljs-keyword">const</span> wrapperCode = <span class="hljs-string">`
      (function(exports, module, __filename, __dirname) {
        // 注入依赖
        const [
          <span class="hljs-subst">${dependencies.map((_, i) =&gt; <span class="hljs-string">`__dep<span class="hljs-subst">${i}</span>`</span>).join(<span class="hljs-string">', '</span>)}</span>
        ] = arguments[4];
        
        <span class="hljs-subst">${code}</span>
        
        // 返回默认导出
        return module.exports &amp;&amp; module.exports.default ?
          module.exports.default : module.exports;
      })
    `</span>;
    
    <span class="hljs-keyword">return</span> <span class="hljs-built_in">eval</span>(wrapperCode);
  }
  
  <span class="hljs-comment">// 解析路径</span>
  <span class="hljs-keyword">function</span> <span class="hljs-title function_">resolvePath</span>(<span class="hljs-params">basePath, targetPath</span>) {
    <span class="hljs-keyword">if</span> (targetPath.<span class="hljs-title function_">startsWith</span>(<span class="hljs-string">'./'</span>) || targetPath.<span class="hljs-title function_">startsWith</span>(<span class="hljs-string">'../'</span>)) {
      <span class="hljs-keyword">const</span> baseDir = basePath.<span class="hljs-title function_">substring</span>(<span class="hljs-number">0</span>, basePath.<span class="hljs-title function_">lastIndexOf</span>(<span class="hljs-string">'/'</span>));
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title function_">URL</span>(targetPath, baseDir + <span class="hljs-string">'/'</span>).<span class="hljs-property">pathname</span>;
    }
    <span class="hljs-keyword">return</span> targetPath;
  }
  
  <span class="hljs-comment">// 获取模块代码</span>
  <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">fetchModule</span>(<span class="hljs-params">path</span>) {
    <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetch</span>(path);
    <span class="hljs-keyword">if</span> (!response.<span class="hljs-property">ok</span>) {
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">`Failed to load module: <span class="hljs-subst">${path}</span>`</span>);
    }
    <span class="hljs-keyword">return</span> response.<span class="hljs-title function_">text</span>();
  }
  
  <span class="hljs-comment">// 拦截script type="module"</span>
  <span class="hljs-title function_">interceptModuleScripts</span>();
  
  <span class="hljs-keyword">function</span> <span class="hljs-title function_">interceptModuleScripts</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> originalCreateElement = <span class="hljs-variable language_">document</span>.<span class="hljs-property">createElement</span>;
    
    <span class="hljs-variable language_">document</span>.<span class="hljs-property">createElement</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params">tagName</span>) {
      <span class="hljs-keyword">const</span> element = originalCreateElement.<span class="hljs-title function_">call</span>(<span class="hljs-variable language_">document</span>, tagName);
      
      <span class="hljs-keyword">if</span> (tagName === <span class="hljs-string">'script'</span>) {
        <span class="hljs-keyword">const</span> originalSetAttribute = element.<span class="hljs-property">setAttribute</span>.<span class="hljs-title function_">bind</span>(element);
        
        element.<span class="hljs-property">setAttribute</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params">name, value</span>) {
          <span class="hljs-title function_">originalSetAttribute</span>(name, value);
          
          <span class="hljs-keyword">if</span> (name === <span class="hljs-string">'type'</span> &amp;&amp; value === <span class="hljs-string">'module'</span>) {
            <span class="hljs-comment">// 拦截模块脚本</span>
            <span class="hljs-keyword">const</span> src = element.<span class="hljs-title function_">getAttribute</span>(<span class="hljs-string">'src'</span>);
            <span class="hljs-keyword">if</span> (src) {
              element.<span class="hljs-property">type</span> = <span class="hljs-string">'text/javascript'</span>;
              importModule(src).<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> {
                <span class="hljs-keyword">if</span> (element.<span class="hljs-property">onload</span>) element.<span class="hljs-title function_">onload</span>();
              }).<span class="hljs-title function_">catch</span>(<span class="hljs-function"><span class="hljs-params">err</span> =&gt;</span> {
                <span class="hljs-keyword">if</span> (element.<span class="hljs-property">onerror</span>) element.<span class="hljs-title function_">onerror</span>(err);
              });
            }
          }
        };
      }
      
      <span class="hljs-keyword">return</span> element;
    };
  }
})();

<span class="hljs-comment">// 使用示例</span>
<span class="hljs-comment">// 模块文件: utils.js</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">capitalize</span>(<span class="hljs-params">str</span>) {
  <span class="hljs-keyword">return</span> str.<span class="hljs-title function_">charAt</span>(<span class="hljs-number">0</span>).<span class="hljs-title function_">toUpperCase</span>() + str.<span class="hljs-title function_">slice</span>(<span class="hljs-number">1</span>);
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">greet</span>(<span class="hljs-params">name</span>) {
  <span class="hljs-keyword">return</span> <span class="hljs-string">`Hello, <span class="hljs-subst">${capitalize(name)}</span>!`</span>;
}

<span class="hljs-comment">// 主文件</span>
importModule(<span class="hljs-string">'./utils.js'</span>).<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">utils</span> =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(utils.<span class="hljs-title function_">default</span>(<span class="hljs-string">'world'</span>)); <span class="hljs-comment">// Hello, World!</span>
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(utils.<span class="hljs-title function_">capitalize</span>(<span class="hljs-string">'test'</span>)); <span class="hljs-comment">// Test</span>
});
</code></pre>
<h5 data-id="heading-10">4.2 支持Tree Shaking的ESM Polyfill</h5>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">ESMCompat</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">modules</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>();
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">usedExports</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Set</span>();
  }
  
  <span class="hljs-comment">// 注册模块</span>
  <span class="hljs-title function_">register</span>(<span class="hljs-params">name, code</span>) {
    <span class="hljs-keyword">const</span> ast = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">parse</span>(code);
    <span class="hljs-keyword">const</span> <span class="hljs-built_in">exports</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">extractExports</span>(ast);
    
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">modules</span>.<span class="hljs-title function_">set</span>(name, {
      code,
      ast,
      <span class="hljs-built_in">exports</span>,
      <span class="hljs-attr">used</span>: <span class="hljs-keyword">new</span> <span class="hljs-title class_">Set</span>()
    });
  }
  
  <span class="hljs-comment">// 解析代码为AST（简化版）</span>
  <span class="hljs-title function_">parse</span>(<span class="hljs-params">code</span>) {
    <span class="hljs-comment">// 简化实现：实际应使用Babel等解析器</span>
    <span class="hljs-keyword">const</span> exportMatches = code.<span class="hljs-title function_">match</span>(<span class="hljs-regexp">/export\s+(const|let|var|function|class|default)\s+(\w+)/g</span>) || [];
    <span class="hljs-keyword">const</span> imports = code.<span class="hljs-title function_">match</span>(<span class="hljs-regexp">/import\s+\{([^}]+)\}\s+from\s+['"]([^'"]+)['"]/g</span>) || [];
    
    <span class="hljs-keyword">return</span> {
      <span class="hljs-attr">exports</span>: exportMatches.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">match</span> =&gt;</span> ({
        <span class="hljs-attr">type</span>: match.<span class="hljs-title function_">split</span>(<span class="hljs-string">' '</span>)[<span class="hljs-number">1</span>],
        <span class="hljs-attr">name</span>: match.<span class="hljs-title function_">split</span>(<span class="hljs-string">' '</span>)[<span class="hljs-number">2</span>]
      })),
      <span class="hljs-attr">imports</span>: imports.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">match</span> =&gt;</span> {
        <span class="hljs-keyword">const</span> parts = match.<span class="hljs-title function_">match</span>(<span class="hljs-regexp">/import\s+\{([^}]+)\}\s+from\s+['"]([^'"]+)['"]/</span>);
        <span class="hljs-keyword">return</span> {
          <span class="hljs-attr">specifiers</span>: parts[<span class="hljs-number">1</span>].<span class="hljs-title function_">split</span>(<span class="hljs-string">','</span>).<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">s</span> =&gt;</span> s.<span class="hljs-title function_">trim</span>()),
          <span class="hljs-attr">source</span>: parts[<span class="hljs-number">2</span>]
        };
      })
    };
  }
  
  <span class="hljs-comment">// 提取导出</span>
  <span class="hljs-title function_">extractExports</span>(<span class="hljs-params">ast</span>) {
    <span class="hljs-keyword">return</span> ast.<span class="hljs-property">exports</span>.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">exp</span> =&gt;</span> exp.<span class="hljs-property">name</span>);
  }
  
  <span class="hljs-comment">// 使用模块（标记使用的导出）</span>
  <span class="hljs-title function_">use</span>(<span class="hljs-params">name, ...<span class="hljs-built_in">exports</span></span>) {
    <span class="hljs-keyword">const</span> <span class="hljs-variable language_">module</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">modules</span>.<span class="hljs-title function_">get</span>(name);
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">module</span>) {
      <span class="hljs-built_in">exports</span>.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">exp</span> =&gt;</span> {
        <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span>.<span class="hljs-title function_">includes</span>(exp)) {
          <span class="hljs-variable language_">module</span>.<span class="hljs-property">used</span>.<span class="hljs-title function_">add</span>(exp);
        }
      });
    }
  }
  
  <span class="hljs-comment">// 生成优化后的代码</span>
  <span class="hljs-title function_">generateOptimized</span>(<span class="hljs-params">name</span>) {
    <span class="hljs-keyword">const</span> <span class="hljs-variable language_">module</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">modules</span>.<span class="hljs-title function_">get</span>(name);
    <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">module</span>) <span class="hljs-keyword">return</span> <span class="hljs-string">''</span>;
    
    <span class="hljs-keyword">let</span> code = <span class="hljs-variable language_">module</span>.<span class="hljs-property">code</span>;
    
    <span class="hljs-comment">// 移除未使用的导出（简化实现）</span>
    <span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span>.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">exp</span> =&gt;</span> {
      <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">module</span>.<span class="hljs-property">used</span>.<span class="hljs-title function_">has</span>(exp)) {
        <span class="hljs-keyword">const</span> regex = <span class="hljs-keyword">new</span> <span class="hljs-title class_">RegExp</span>(<span class="hljs-string">`export\\s+.*?\\b<span class="hljs-subst">${exp}</span>\\b[^;]*;`</span>, <span class="hljs-string">'g'</span>);
        code = code.<span class="hljs-title function_">replace</span>(regex, <span class="hljs-string">''</span>);
      }
    });
    
    <span class="hljs-keyword">return</span> code;
  }
}

<span class="hljs-comment">// 使用示例</span>
<span class="hljs-keyword">const</span> compat = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ESMCompat</span>();

compat.<span class="hljs-title function_">register</span>(<span class="hljs-string">'math'</span>, <span class="hljs-string">`
export const PI = 3.14159;
export function add(a, b) { return a + b; }
export function multiply(a, b) { return a * b; }
export function unusedFunction() { return 'unused'; }
`</span>);

<span class="hljs-comment">// 标记使用的导出</span>
compat.<span class="hljs-title function_">use</span>(<span class="hljs-string">'math'</span>, <span class="hljs-string">'PI'</span>, <span class="hljs-string">'add'</span>);

<span class="hljs-comment">// 生成优化代码</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(compat.<span class="hljs-title function_">generateOptimized</span>(<span class="hljs-string">'math'</span>));
<span class="hljs-comment">// 输出将只包含PI和add的导出</span>
</code></pre>
<h4 data-id="heading-11">五、模块化构建工具集成</h4>
<p>现代开发中，我们使用构建工具处理模块化。以下展示如何集成Webpack-like的简单打包器。</p>
<h5 data-id="heading-12">5.1 简易模块打包器</h5>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> fs = <span class="hljs-built_in">require</span>(<span class="hljs-string">'fs'</span>);
<span class="hljs-keyword">const</span> path = <span class="hljs-built_in">require</span>(<span class="hljs-string">'path'</span>);
<span class="hljs-keyword">const</span> { parse } = <span class="hljs-built_in">require</span>(<span class="hljs-string">'@babel/parser'</span>);
<span class="hljs-keyword">const</span> traverse = <span class="hljs-built_in">require</span>(<span class="hljs-string">'@babel/traverse'</span>).<span class="hljs-property">default</span>;
<span class="hljs-keyword">const</span> generate = <span class="hljs-built_in">require</span>(<span class="hljs-string">'@babel/generator'</span>).<span class="hljs-property">default</span>;
<span class="hljs-keyword">const</span> t = <span class="hljs-built_in">require</span>(<span class="hljs-string">'@babel/types'</span>);

<span class="hljs-keyword">class</span> <span class="hljs-title class_">SimpleBundler</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">entry</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">entry</span> = entry;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">modules</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>();
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">moduleId</span> = <span class="hljs-number">0</span>;
  }
  
  <span class="hljs-comment">// 构建</span>
  <span class="hljs-title function_">build</span>(<span class="hljs-params">outputPath</span>) {
    <span class="hljs-keyword">const</span> entryModule = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">collectDependencies</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">entry</span>);
    <span class="hljs-keyword">const</span> bundleCode = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">generateBundle</span>(entryModule);
    
    fs.<span class="hljs-title function_">writeFileSync</span>(outputPath, bundleCode);
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`Bundle generated: <span class="hljs-subst">${outputPath}</span>`</span>);
  }
  
  <span class="hljs-comment">// 收集依赖</span>
  <span class="hljs-title function_">collectDependencies</span>(<span class="hljs-params">filePath</span>) {
    <span class="hljs-keyword">const</span> fileContent = fs.<span class="hljs-title function_">readFileSync</span>(filePath, <span class="hljs-string">'utf-8'</span>);
    <span class="hljs-keyword">const</span> ast = <span class="hljs-title function_">parse</span>(fileContent, {
      <span class="hljs-attr">sourceType</span>: <span class="hljs-string">'module'</span>,
      <span class="hljs-attr">plugins</span>: [<span class="hljs-string">'jsx'</span>]
    });
    
    <span class="hljs-keyword">const</span> dependencies = [];
    <span class="hljs-keyword">const</span> dirname = path.<span class="hljs-title function_">dirname</span>(filePath);
    
    <span class="hljs-comment">// 遍历AST收集import语句</span>
    <span class="hljs-title function_">traverse</span>(ast, {
      <span class="hljs-title class_">ImportDeclaration</span>: <span class="hljs-function">(<span class="hljs-params">{ node }</span>) =&gt;</span> {
        <span class="hljs-keyword">const</span> importPath = node.<span class="hljs-property">source</span>.<span class="hljs-property">value</span>;
        <span class="hljs-keyword">const</span> absolutePath = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">resolvePath</span>(importPath, dirname);
        dependencies.<span class="hljs-title function_">push</span>(absolutePath);
      },
      <span class="hljs-title class_">CallExpression</span>: <span class="hljs-function">(<span class="hljs-params">{ node }</span>) =&gt;</span> {
        <span class="hljs-keyword">if</span> (node.<span class="hljs-property">callee</span>.<span class="hljs-property">type</span> === <span class="hljs-string">'Import'</span>) {
          <span class="hljs-keyword">const</span> importPath = node.<span class="hljs-property">arguments</span>[<span class="hljs-number">0</span>].<span class="hljs-property">value</span>;
          <span class="hljs-keyword">const</span> absolutePath = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">resolvePath</span>(importPath, dirname);
          dependencies.<span class="hljs-title function_">push</span>(absolutePath);
        }
      }
    });
    
    <span class="hljs-keyword">const</span> moduleId = <span class="hljs-variable language_">this</span>.<span class="hljs-property">moduleId</span>++;
    <span class="hljs-keyword">const</span> <span class="hljs-variable language_">module</span> = {
      <span class="hljs-attr">id</span>: moduleId,
      filePath,
      <span class="hljs-attr">code</span>: fileContent,
      dependencies,
      <span class="hljs-attr">mapping</span>: {}
    };
    
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">modules</span>.<span class="hljs-title function_">set</span>(filePath, <span class="hljs-variable language_">module</span>);
    
    <span class="hljs-comment">// 递归收集依赖</span>
    dependencies.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">dep</span> =&gt;</span> {
      <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-property">modules</span>.<span class="hljs-title function_">has</span>(dep)) {
        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">collectDependencies</span>(dep);
      }
    });
    
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">module</span>;
  }
  
  <span class="hljs-comment">// 解析路径</span>
  <span class="hljs-title function_">resolvePath</span>(<span class="hljs-params">importPath, baseDir</span>) {
    <span class="hljs-keyword">if</span> (importPath.<span class="hljs-title function_">startsWith</span>(<span class="hljs-string">'.'</span>)) {
      <span class="hljs-keyword">return</span> path.<span class="hljs-title function_">resolve</span>(baseDir, importPath);
    }
    <span class="hljs-comment">// 处理node_modules（简化）</span>
    <span class="hljs-keyword">const</span> nodeModulePath = path.<span class="hljs-title function_">resolve</span>(process.<span class="hljs-title function_">cwd</span>(), <span class="hljs-string">'node_modules'</span>, importPath);
    <span class="hljs-keyword">if</span> (fs.<span class="hljs-title function_">existsSync</span>(nodeModulePath)) {
      <span class="hljs-keyword">return</span> nodeModulePath;
    }
    <span class="hljs-keyword">return</span> importPath;
  }
  
  <span class="hljs-comment">// 生成打包代码</span>
  <span class="hljs-title function_">generateBundle</span>(<span class="hljs-params">entryModule</span>) {
    <span class="hljs-keyword">const</span> modules = [];
    
    <span class="hljs-comment">// 创建模块映射</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">modules</span>.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">module</span> =&gt;</span> {
      <span class="hljs-keyword">const</span> transformedCode = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">transformModule</span>(<span class="hljs-variable language_">module</span>);
      modules.<span class="hljs-title function_">push</span>(<span class="hljs-string">`
        <span class="hljs-subst">${<span class="hljs-variable language_">module</span>.id}</span>: {
          factory: function(require, module, exports) {
            <span class="hljs-subst">${transformedCode}</span>
          },
          mapping: <span class="hljs-subst">${<span class="hljs-built_in">JSON</span>.stringify(<span class="hljs-variable language_">module</span>.mapping)}</span>
        }
      `</span>);
    });
    
    <span class="hljs-comment">// 生成运行时</span>
    <span class="hljs-keyword">return</span> <span class="hljs-string">`
      (function(modules) {
        const moduleCache = {};
        
        function require(id) {
          if (moduleCache[id]) {
            return moduleCache[id].exports;
          }
          
          const mod = modules[id];
          const localRequire = function(modulePath) {
            return require(mod.mapping[modulePath]);
          };
          
          const module = { exports: {} };
          mod.factory(localRequire, module, module.exports);
          
          moduleCache[id] = module;
          return module.exports;
        }
        
        // 启动入口模块
        require(0);
      })({
        <span class="hljs-subst">${modules.join(<span class="hljs-string">',\n'</span>)}</span>
      });
    `</span>;
  }
  
  <span class="hljs-comment">// 转换模块代码</span>
  <span class="hljs-title function_">transformModule</span>(<span class="hljs-params"><span class="hljs-variable language_">module</span></span>) {
    <span class="hljs-keyword">const</span> ast = <span class="hljs-title function_">parse</span>(<span class="hljs-variable language_">module</span>.<span class="hljs-property">code</span>, {
      <span class="hljs-attr">sourceType</span>: <span class="hljs-string">'module'</span>
    });
    
    <span class="hljs-comment">// 构建路径映射</span>
    <span class="hljs-keyword">let</span> importIndex = <span class="hljs-number">0</span>;
    
    <span class="hljs-title function_">traverse</span>(ast, {
      <span class="hljs-title class_">ImportDeclaration</span>: <span class="hljs-function">(<span class="hljs-params">{ node }</span>) =&gt;</span> {
        <span class="hljs-keyword">const</span> importPath = node.<span class="hljs-property">source</span>.<span class="hljs-property">value</span>;
        <span class="hljs-keyword">const</span> depModule = <span class="hljs-variable language_">this</span>.<span class="hljs-property">modules</span>.<span class="hljs-title function_">get</span>(
          <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">resolvePath</span>(importPath, path.<span class="hljs-title function_">dirname</span>(<span class="hljs-variable language_">module</span>.<span class="hljs-property">filePath</span>))
        );
        
        <span class="hljs-keyword">if</span> (depModule) {
          <span class="hljs-keyword">const</span> importName = <span class="hljs-string">`__import_<span class="hljs-subst">${importIndex++}</span>`</span>;
          <span class="hljs-variable language_">module</span>.<span class="hljs-property">mapping</span>[importPath] = depModule.<span class="hljs-property">id</span>;
          
          <span class="hljs-comment">// 替换import语句</span>
          <span class="hljs-keyword">const</span> specifiers = node.<span class="hljs-property">specifiers</span>.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">spec</span> =&gt;</span> {
            <span class="hljs-keyword">if</span> (t.<span class="hljs-title function_">isImportDefaultSpecifier</span>(spec)) {
              <span class="hljs-keyword">return</span> t.<span class="hljs-title function_">variableDeclarator</span>(
                spec.<span class="hljs-property">local</span>,
                t.<span class="hljs-title function_">memberExpression</span>(
                  t.<span class="hljs-title function_">identifier</span>(importName),
                  t.<span class="hljs-title function_">identifier</span>(<span class="hljs-string">'default'</span>)
                )
              );
            } <span class="hljs-keyword">else</span> {
              <span class="hljs-keyword">return</span> t.<span class="hljs-title function_">variableDeclarator</span>(
                spec.<span class="hljs-property">local</span>,
                t.<span class="hljs-title function_">memberExpression</span>(
                  t.<span class="hljs-title function_">identifier</span>(importName),
                  spec.<span class="hljs-property">imported</span> || spec.<span class="hljs-property">local</span>
                )
              );
            }
          });
          
          <span class="hljs-keyword">return</span> t.<span class="hljs-title function_">variableDeclaration</span>(<span class="hljs-string">'const'</span>, specifiers);
        }
      }
    });
    
    <span class="hljs-comment">// 移除export语句</span>
    <span class="hljs-title function_">traverse</span>(ast, {
      <span class="hljs-title class_">ExportNamedDeclaration</span>: <span class="hljs-function">(<span class="hljs-params">{ node, remove }</span>) =&gt;</span> {
        <span class="hljs-keyword">if</span> (node.<span class="hljs-property">declaration</span>) {
          <span class="hljs-keyword">return</span> node.<span class="hljs-property">declaration</span>;
        }
        <span class="hljs-title function_">remove</span>();
      },
      <span class="hljs-title class_">ExportDefaultDeclaration</span>: <span class="hljs-function">(<span class="hljs-params">{ node }</span>) =&gt;</span> {
        <span class="hljs-keyword">return</span> t.<span class="hljs-title function_">expressionStatement</span>(
          t.<span class="hljs-title function_">assignmentExpression</span>(
            <span class="hljs-string">'='</span>,
            t.<span class="hljs-title function_">memberExpression</span>(
              t.<span class="hljs-title function_">identifier</span>(<span class="hljs-string">'module'</span>),
              t.<span class="hljs-title function_">identifier</span>(<span class="hljs-string">'exports'</span>)
            ),
            t.<span class="hljs-title function_">objectExpression</span>([
              t.<span class="hljs-title function_">objectProperty</span>(
                t.<span class="hljs-title function_">identifier</span>(<span class="hljs-string">'default'</span>),
                node.<span class="hljs-property">declaration</span>
              )
            ])
          )
        );
      }
    });
    
    <span class="hljs-keyword">const</span> { code } = <span class="hljs-title function_">generate</span>(ast);
    <span class="hljs-keyword">return</span> code;
  }
}

<span class="hljs-comment">// 使用示例</span>
<span class="hljs-keyword">const</span> bundler = <span class="hljs-keyword">new</span> <span class="hljs-title class_">SimpleBundler</span>(<span class="hljs-string">'./src/index.js'</span>);
bundler.<span class="hljs-title function_">build</span>(<span class="hljs-string">'./dist/bundle.js'</span>);
</code></pre>
<h4 data-id="heading-13">六、模块联邦与微前端架构</h4>
<p>模块联邦（Module Federation）是Webpack 5引入的重要特性，支持跨应用共享模块。</p>
<h5 data-id="heading-14">6.1 简易模块联邦实现</h5>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 模块联邦管理器</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">ModuleFederation</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">config</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">config</span> = config;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">remotes</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>();
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">exposes</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>();
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">shared</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>();
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">init</span>();
  }
  
  <span class="hljs-title function_">init</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// 初始化共享模块</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">config</span>.<span class="hljs-property">shared</span>) {
      <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">entries</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">config</span>.<span class="hljs-property">shared</span>).<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">[name, config]</span>) =&gt;</span> {
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">shared</span>.<span class="hljs-title function_">set</span>(name, {
          <span class="hljs-attr">module</span>: <span class="hljs-built_in">require</span>(name),
          <span class="hljs-attr">version</span>: config.<span class="hljs-property">version</span>,
          <span class="hljs-attr">singleton</span>: config.<span class="hljs-property">singleton</span> || <span class="hljs-literal">false</span>
        });
      });
    }
    
    <span class="hljs-comment">// 初始化暴露模块</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">config</span>.<span class="hljs-property">exposes</span>) {
      <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">entries</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">config</span>.<span class="hljs-property">exposes</span>).<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">[name, modulePath]</span>) =&gt;</span> {
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">exposes</span>.<span class="hljs-title function_">set</span>(name, <span class="hljs-built_in">require</span>(modulePath));
      });
    }
  }
  
  <span class="hljs-comment">// 注册远程应用</span>
  <span class="hljs-keyword">async</span> <span class="hljs-title function_">registerRemote</span>(<span class="hljs-params">name, url</span>) {
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">const</span> remoteManifest = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">fetchRemoteManifest</span>(url);
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">remotes</span>.<span class="hljs-title function_">set</span>(name, {
        url,
        <span class="hljs-attr">manifest</span>: remoteManifest
      });
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`Remote <span class="hljs-subst">${name}</span> registered`</span>);
    } <span class="hljs-keyword">catch</span> (error) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`Failed to register remote <span class="hljs-subst">${name}</span>:`</span>, error);
    }
  }
  
  <span class="hljs-comment">// 获取远程清单</span>
  <span class="hljs-keyword">async</span> <span class="hljs-title function_">fetchRemoteManifest</span>(<span class="hljs-params">url</span>) {
    <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetch</span>(<span class="hljs-string">`<span class="hljs-subst">${url}</span>/federation-manifest.json`</span>);
    <span class="hljs-keyword">return</span> response.<span class="hljs-title function_">json</span>();
  }
  
  <span class="hljs-comment">// 获取模块</span>
  <span class="hljs-keyword">async</span> <span class="hljs-title function_">getModule</span>(<span class="hljs-params">remoteName, moduleName</span>) {
    <span class="hljs-comment">// 检查共享模块</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">shared</span>.<span class="hljs-title function_">has</span>(moduleName)) {
      <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">shared</span>.<span class="hljs-title function_">get</span>(moduleName).<span class="hljs-property">module</span>;
    }
    
    <span class="hljs-comment">// 检查本地暴露</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">exposes</span>.<span class="hljs-title function_">has</span>(moduleName)) {
      <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">exposes</span>.<span class="hljs-title function_">get</span>(moduleName);
    }
    
    <span class="hljs-comment">// 检查远程模块</span>
    <span class="hljs-keyword">const</span> remote = <span class="hljs-variable language_">this</span>.<span class="hljs-property">remotes</span>.<span class="hljs-title function_">get</span>(remoteName);
    <span class="hljs-keyword">if</span> (remote) {
      <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">loadRemoteModule</span>(remote, moduleName);
    }
    
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">`Module <span class="hljs-subst">${moduleName}</span> not found`</span>);
  }
  
  <span class="hljs-comment">// 加载远程模块</span>
  <span class="hljs-keyword">async</span> <span class="hljs-title function_">loadRemoteModule</span>(<span class="hljs-params">remote, moduleName</span>) {
    <span class="hljs-keyword">const</span> moduleUrl = <span class="hljs-string">`<span class="hljs-subst">${remote.url}</span>/<span class="hljs-subst">${moduleName}</span>.js`</span>;
    
    <span class="hljs-comment">// 动态加载脚本</span>
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> {
      <span class="hljs-keyword">const</span> script = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">'script'</span>);
      script.<span class="hljs-property">src</span> = moduleUrl;
      
      script.<span class="hljs-property">onload</span> = <span class="hljs-function">() =&gt;</span> {
        <span class="hljs-comment">// 假设远程模块会暴露到全局</span>
        <span class="hljs-keyword">const</span> <span class="hljs-variable language_">module</span> = <span class="hljs-variable language_">window</span>[<span class="hljs-string">`<span class="hljs-subst">${remote.name}</span>_<span class="hljs-subst">${moduleName}</span>`</span>];
        <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">module</span>) {
          <span class="hljs-title function_">resolve</span>(<span class="hljs-variable language_">module</span>);
        } <span class="hljs-keyword">else</span> {
          <span class="hljs-title function_">reject</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">`Module <span class="hljs-subst">${moduleName}</span> not found in remote`</span>));
        }
      };
      
      script.<span class="hljs-property">onerror</span> = reject;
      <span class="hljs-variable language_">document</span>.<span class="hljs-property">head</span>.<span class="hljs-title function_">appendChild</span>(script);
    });
  }
  
  <span class="hljs-comment">// 暴露模块</span>
  <span class="hljs-title function_">expose</span>(<span class="hljs-params">name, <span class="hljs-variable language_">module</span></span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">exposes</span>.<span class="hljs-title function_">set</span>(name, <span class="hljs-variable language_">module</span>);
    <span class="hljs-comment">// 暴露到全局（供远程访问）</span>
    <span class="hljs-variable language_">window</span>[<span class="hljs-string">`<span class="hljs-subst">${<span class="hljs-variable language_">this</span>.config.name}</span>_<span class="hljs-subst">${name}</span>`</span>] = <span class="hljs-variable language_">module</span>;
  }
}

<span class="hljs-comment">// 使用示例</span>
<span class="hljs-comment">// App 1 配置</span>
<span class="hljs-keyword">const</span> federation1 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ModuleFederation</span>({
  <span class="hljs-attr">name</span>: <span class="hljs-string">'app1'</span>,
  <span class="hljs-attr">exposes</span>: {
    <span class="hljs-string">'./Button'</span>: <span class="hljs-string">'./src/components/Button.js'</span>
  },
  <span class="hljs-attr">shared</span>: {
    <span class="hljs-attr">react</span>: { <span class="hljs-attr">singleton</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">version</span>: <span class="hljs-string">'17.0.0'</span> },
    <span class="hljs-string">'react-dom'</span>: { <span class="hljs-attr">singleton</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">version</span>: <span class="hljs-string">'17.0.0'</span> }
  }
});

<span class="hljs-comment">// App 2 配置</span>
<span class="hljs-keyword">const</span> federation2 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ModuleFederation</span>({
  <span class="hljs-attr">name</span>: <span class="hljs-string">'app2'</span>,
  <span class="hljs-attr">remotes</span>: {
    <span class="hljs-attr">app1</span>: <span class="hljs-string">'http://localhost:3001'</span>
  },
  <span class="hljs-attr">shared</span>: {
    <span class="hljs-attr">react</span>: { <span class="hljs-attr">singleton</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">version</span>: <span class="hljs-string">'17.0.0'</span> }
  }
});

<span class="hljs-comment">// App2中使用App1的模块</span>
federation2.<span class="hljs-title function_">getModule</span>(<span class="hljs-string">'app1'</span>, <span class="hljs-string">'Button'</span>).<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">Button</span> =&gt;</span> {
  <span class="hljs-comment">// 使用远程Button组件</span>
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Remote Button loaded:'</span>, <span class="hljs-title class_">Button</span>);
});
</code></pre>
<h5 data-id="heading-15">七、模块化性能优化</h5>
<h5 data-id="heading-16">7.1 代码分割与懒加载</h5>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">CodeSplitter</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">chunks</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>();
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">loadedChunks</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Set</span>();
  }
  
  <span class="hljs-comment">// 定义代码分割点</span>
  <span class="hljs-title function_">defineChunk</span>(<span class="hljs-params">name, getChunk</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">chunks</span>.<span class="hljs-title function_">set</span>(name, getChunk);
  }
  
  <span class="hljs-comment">// 懒加载代码块</span>
  <span class="hljs-keyword">async</span> <span class="hljs-title function_">loadChunk</span>(<span class="hljs-params">name</span>) {
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">loadedChunks</span>.<span class="hljs-title function_">has</span>(name)) {
      <span class="hljs-keyword">return</span>;
    }
    
    <span class="hljs-keyword">const</span> getChunk = <span class="hljs-variable language_">this</span>.<span class="hljs-property">chunks</span>.<span class="hljs-title function_">get</span>(name);
    <span class="hljs-keyword">if</span> (!getChunk) {
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">`Chunk <span class="hljs-subst">${name}</span> not found`</span>);
    }
    
    <span class="hljs-comment">// 标记为加载中</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">loadedChunks</span>.<span class="hljs-title function_">add</span>(name);
    
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">await</span> <span class="hljs-title function_">getChunk</span>();
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`Chunk <span class="hljs-subst">${name}</span> loaded`</span>);
    } <span class="hljs-keyword">catch</span> (error) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">loadedChunks</span>.<span class="hljs-title function_">delete</span>(name);
      <span class="hljs-keyword">throw</span> error;
    }
  }
  
  <span class="hljs-comment">// 预加载代码块</span>
  <span class="hljs-title function_">preloadChunk</span>(<span class="hljs-params">name</span>) {
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">loadedChunks</span>.<span class="hljs-title function_">has</span>(name)) <span class="hljs-keyword">return</span>;
    
    <span class="hljs-keyword">const</span> link = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">'link'</span>);
    link.<span class="hljs-property">rel</span> = <span class="hljs-string">'preload'</span>;
    link.<span class="hljs-property">as</span> = <span class="hljs-string">'script'</span>;
    
    <span class="hljs-keyword">const</span> getChunk = <span class="hljs-variable language_">this</span>.<span class="hljs-property">chunks</span>.<span class="hljs-title function_">get</span>(name);
    <span class="hljs-keyword">if</span> (getChunk &amp;&amp; getChunk.<span class="hljs-property">chunkPath</span>) {
      link.<span class="hljs-property">href</span> = getChunk.<span class="hljs-property">chunkPath</span>;
      <span class="hljs-variable language_">document</span>.<span class="hljs-property">head</span>.<span class="hljs-title function_">appendChild</span>(link);
    }
  }
}

<span class="hljs-comment">// Webpack动态导入兼容</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">dynamicImport</span>(<span class="hljs-params">modulePath</span>) {
  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> __webpack_require__ !== <span class="hljs-string">'undefined'</span>) {
    <span class="hljs-comment">// Webpack环境</span>
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">import</span>(<span class="hljs-comment">/* webpackChunkName: "[request]" */</span> modulePath);
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-comment">// 原生环境</span>
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">import</span>(modulePath);
  }
}

<span class="hljs-comment">// 使用示例</span>
<span class="hljs-keyword">const</span> splitter = <span class="hljs-keyword">new</span> <span class="hljs-title class_">CodeSplitter</span>();

<span class="hljs-comment">// 定义代码块</span>
splitter.<span class="hljs-title function_">defineChunk</span>(<span class="hljs-string">'dashboard'</span>, <span class="hljs-function">() =&gt;</span> 
  <span class="hljs-title function_">dynamicImport</span>(<span class="hljs-string">'./Dashboard.js'</span>)
);

splitter.<span class="hljs-title function_">defineChunk</span>(<span class="hljs-string">'analytics'</span>, <span class="hljs-function">() =&gt;</span> 
  <span class="hljs-title function_">dynamicImport</span>(<span class="hljs-string">'./Analytics.js'</span>)
);

<span class="hljs-comment">// 路由懒加载</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">loadRoute</span>(<span class="hljs-params">routeName</span>) {
  <span class="hljs-keyword">switch</span> (routeName) {
    <span class="hljs-keyword">case</span> <span class="hljs-string">'dashboard'</span>:
      <span class="hljs-keyword">await</span> splitter.<span class="hljs-title function_">loadChunk</span>(<span class="hljs-string">'dashboard'</span>);
      <span class="hljs-keyword">break</span>;
    <span class="hljs-keyword">case</span> <span class="hljs-string">'analytics'</span>:
      <span class="hljs-keyword">await</span> splitter.<span class="hljs-title function_">loadChunk</span>(<span class="hljs-string">'analytics'</span>);
      <span class="hljs-keyword">break</span>;
  }
}

<span class="hljs-comment">// 预加载</span>
<span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'mouseover'</span>, <span class="hljs-function">(<span class="hljs-params">e</span>) =&gt;</span> {
  <span class="hljs-keyword">if</span> (e.<span class="hljs-property">target</span>.<span class="hljs-property">href</span> &amp;&amp; e.<span class="hljs-property">target</span>.<span class="hljs-property">href</span>.<span class="hljs-title function_">includes</span>(<span class="hljs-string">'dashboard'</span>)) {
    splitter.<span class="hljs-title function_">preloadChunk</span>(<span class="hljs-string">'dashboard'</span>);
  }
});
</code></pre>
<h5 data-id="heading-17">7.2 模块缓存策略</h5>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">ModuleCache</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">cache</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>();
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">ttl</span> = <span class="hljs-number">5</span> * <span class="hljs-number">60</span> * <span class="hljs-number">1000</span>; <span class="hljs-comment">// 5分钟</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">maxSize</span> = <span class="hljs-number">100</span>; <span class="hljs-comment">// 最大缓存模块数</span>
  }
  
  <span class="hljs-comment">// 获取模块</span>
  <span class="hljs-keyword">async</span> <span class="hljs-title function_">get</span>(<span class="hljs-params">key, fetchModule</span>) {
    <span class="hljs-keyword">const</span> cached = <span class="hljs-variable language_">this</span>.<span class="hljs-property">cache</span>.<span class="hljs-title function_">get</span>(key);
    
    <span class="hljs-comment">// 检查缓存是否有效</span>
    <span class="hljs-keyword">if</span> (cached &amp;&amp; <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>() - cached.<span class="hljs-property">timestamp</span> &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">ttl</span>) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`Cache hit: <span class="hljs-subst">${key}</span>`</span>);
      <span class="hljs-keyword">return</span> cached.<span class="hljs-property">module</span>;
    }
    
    <span class="hljs-comment">// 缓存失效或不存在，重新获取</span>
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`Cache miss: <span class="hljs-subst">${key}</span>`</span>);
    <span class="hljs-keyword">const</span> <span class="hljs-variable language_">module</span> = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetchModule</span>();
    
    <span class="hljs-comment">// 更新缓存</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">set</span>(key, <span class="hljs-variable language_">module</span>);
    
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">module</span>;
  }
  
  <span class="hljs-comment">// 设置缓存</span>
  <span class="hljs-title function_">set</span>(<span class="hljs-params">key, <span class="hljs-variable language_">module</span></span>) {
    <span class="hljs-comment">// 清理过期缓存</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">cleanup</span>();
    
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">cache</span>.<span class="hljs-title function_">set</span>(key, {
      <span class="hljs-variable language_">module</span>,
      <span class="hljs-attr">timestamp</span>: <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>()
    });
  }
  
  <span class="hljs-comment">// 清理缓存</span>
  <span class="hljs-title function_">cleanup</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> now = <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>();
    
    <span class="hljs-comment">// 清理过期</span>
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> [key, value] <span class="hljs-keyword">of</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">cache</span>) {
      <span class="hljs-keyword">if</span> (now - value.<span class="hljs-property">timestamp</span> &gt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">ttl</span>) {
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">cache</span>.<span class="hljs-title function_">delete</span>(key);
      }
    }
    
    <span class="hljs-comment">// 清理超出大小限制的（LRU策略）</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">cache</span>.<span class="hljs-property">size</span> &gt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">maxSize</span>) {
      <span class="hljs-keyword">const</span> entries = <span class="hljs-title class_">Array</span>.<span class="hljs-title function_">from</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">cache</span>.<span class="hljs-title function_">entries</span>());
      entries.<span class="hljs-title function_">sort</span>(<span class="hljs-function">(<span class="hljs-params">a, b</span>) =&gt;</span> a[<span class="hljs-number">1</span>].<span class="hljs-property">timestamp</span> - b[<span class="hljs-number">1</span>].<span class="hljs-property">timestamp</span>);
      
      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; entries.<span class="hljs-property">length</span> - <span class="hljs-variable language_">this</span>.<span class="hljs-property">maxSize</span>; i++) {
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">cache</span>.<span class="hljs-title function_">delete</span>(entries[i][<span class="hljs-number">0</span>]);
      }
    }
  }
  
  <span class="hljs-comment">// 清空缓存</span>
  <span class="hljs-title function_">clear</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">cache</span>.<span class="hljs-title function_">clear</span>();
  }
}

<span class="hljs-comment">// 使用示例</span>
<span class="hljs-keyword">const</span> moduleCache = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ModuleCache</span>();

<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">loadModuleWithCache</span>(<span class="hljs-params">modulePath</span>) {
  <span class="hljs-keyword">return</span> moduleCache.<span class="hljs-title function_">get</span>(modulePath, <span class="hljs-keyword">async</span> () =&gt; {
    <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetch</span>(modulePath);
    <span class="hljs-keyword">return</span> response.<span class="hljs-title function_">text</span>();
  });
}
</code></pre>
<h4 data-id="heading-18">八、模块化最佳实践与工程化</h4>
<h5 data-id="heading-19">8.1 模块设计原则</h5>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 1. 单一职责原则</span>
<span class="hljs-comment">// 不好的例子</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">UserManager</span> {
  <span class="hljs-comment">// 混合了用户管理、验证、通知等多个职责</span>
}

<span class="hljs-comment">// 好的例子</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">UserRepository</span> {
  <span class="hljs-comment">// 只负责数据访问</span>
}

<span class="hljs-keyword">class</span> <span class="hljs-title class_">UserValidator</span> {
  <span class="hljs-comment">// 只负责验证</span>
}

<span class="hljs-keyword">class</span> <span class="hljs-title class_">UserNotifier</span> {
  <span class="hljs-comment">// 只负责通知</span>
}

<span class="hljs-comment">// 2. 依赖注入</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">UserService</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">userRepository, validator, notifier</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">userRepository</span> = userRepository;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">validator</span> = validator;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">notifier</span> = notifier;
  }
  
  <span class="hljs-keyword">async</span> <span class="hljs-title function_">register</span>(<span class="hljs-params">user</span>) {
    <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-property">validator</span>.<span class="hljs-title function_">validate</span>(user)) {
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">'Invalid user'</span>);
    }
    
    <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">userRepository</span>.<span class="hljs-title function_">save</span>(user);
    <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">notifier</span>.<span class="hljs-title function_">sendWelcome</span>(user.<span class="hljs-property">email</span>);
  }
}

<span class="hljs-comment">// 3. 接口抽象</span>
<span class="hljs-comment">// 定义接口</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">IStorage</span> {
  <span class="hljs-keyword">async</span> <span class="hljs-title function_">save</span>(<span class="hljs-params">key, value</span>) {}
  <span class="hljs-keyword">async</span> <span class="hljs-title function_">get</span>(<span class="hljs-params">key</span>) {}
  <span class="hljs-keyword">async</span> <span class="hljs-title function_">delete</span>(<span class="hljs-params">key</span>) {}
}

<span class="hljs-comment">// 具体实现</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">LocalStorage</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">IStorage</span> {
  <span class="hljs-keyword">async</span> <span class="hljs-title function_">save</span>(<span class="hljs-params">key, value</span>) {
    <span class="hljs-variable language_">localStorage</span>.<span class="hljs-title function_">setItem</span>(key, <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(value));
  }
  
  <span class="hljs-keyword">async</span> <span class="hljs-title function_">get</span>(<span class="hljs-params">key</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(<span class="hljs-variable language_">localStorage</span>.<span class="hljs-title function_">getItem</span>(key));
  }
  
  <span class="hljs-keyword">async</span> <span class="hljs-title function_">delete</span>(<span class="hljs-params">key</span>) {
    <span class="hljs-variable language_">localStorage</span>.<span class="hljs-title function_">removeItem</span>(key);
  }
}

<span class="hljs-keyword">class</span> <span class="hljs-title class_">APIService</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">storage</span>) {
    <span class="hljs-keyword">if</span> (!(storage <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">IStorage</span>)) {
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">'Invalid storage implementation'</span>);
    }
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">storage</span> = storage;
  }
}
</code></pre>
<h5 data-id="heading-20">8.2 模块版本管理与升级</h5>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">ModuleVersionManager</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">versions</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>();
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">deprecations</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>();
  }
  
  <span class="hljs-comment">// 注册模块版本</span>
  <span class="hljs-title function_">register</span>(<span class="hljs-params">moduleName, version, <span class="hljs-variable language_">module</span></span>) {
    <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-property">versions</span>.<span class="hljs-title function_">has</span>(moduleName)) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">versions</span>.<span class="hljs-title function_">set</span>(moduleName, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>());
    }
    
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">versions</span>.<span class="hljs-title function_">get</span>(moduleName).<span class="hljs-title function_">set</span>(version, <span class="hljs-variable language_">module</span>);
  }
  
  <span class="hljs-comment">// 获取模块（支持语义化版本）</span>
  <span class="hljs-title function_">get</span>(<span class="hljs-params">moduleName, versionRange = <span class="hljs-string">'latest'</span></span>) {
    <span class="hljs-keyword">const</span> moduleVersions = <span class="hljs-variable language_">this</span>.<span class="hljs-property">versions</span>.<span class="hljs-title function_">get</span>(moduleName);
    <span class="hljs-keyword">if</span> (!moduleVersions) {
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">`Module <span class="hljs-subst">${moduleName}</span> not found`</span>);
    }
    
    <span class="hljs-keyword">if</span> (versionRange === <span class="hljs-string">'latest'</span>) {
      <span class="hljs-keyword">const</span> latestVersion = <span class="hljs-title class_">Array</span>.<span class="hljs-title function_">from</span>(moduleVersions.<span class="hljs-title function_">keys</span>())
        .<span class="hljs-title function_">sort</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">compareVersions</span>)
        .<span class="hljs-title function_">pop</span>();
      <span class="hljs-keyword">return</span> moduleVersions.<span class="hljs-title function_">get</span>(latestVersion);
    }
    
    <span class="hljs-comment">// 简化的版本范围解析</span>
    <span class="hljs-keyword">const</span> availableVersions = <span class="hljs-title class_">Array</span>.<span class="hljs-title function_">from</span>(moduleVersions.<span class="hljs-title function_">keys</span>())
      .<span class="hljs-title function_">filter</span>(<span class="hljs-function"><span class="hljs-params">v</span> =&gt;</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">satisfiesVersion</span>(v, versionRange))
      .<span class="hljs-title function_">sort</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">compareVersions</span>);
    
    <span class="hljs-keyword">if</span> (availableVersions.<span class="hljs-property">length</span> === <span class="hljs-number">0</span>) {
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">`No version of <span class="hljs-subst">${moduleName}</span> satisfies <span class="hljs-subst">${versionRange}</span>`</span>);
    }
    
    <span class="hljs-keyword">return</span> moduleVersions.<span class="hljs-title function_">get</span>(availableVersions.<span class="hljs-title function_">pop</span>());
  }
  
  <span class="hljs-comment">// 比较版本</span>
  <span class="hljs-title function_">compareVersions</span>(<span class="hljs-params">v1, v2</span>) {
    <span class="hljs-keyword">const</span> parts1 = v1.<span class="hljs-title function_">split</span>(<span class="hljs-string">'.'</span>).<span class="hljs-title function_">map</span>(<span class="hljs-title class_">Number</span>);
    <span class="hljs-keyword">const</span> parts2 = v2.<span class="hljs-title function_">split</span>(<span class="hljs-string">'.'</span>).<span class="hljs-title function_">map</span>(<span class="hljs-title class_">Number</span>);
    
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">3</span>; i++) {
      <span class="hljs-keyword">if</span> (parts1[i] !== parts2[i]) {
        <span class="hljs-keyword">return</span> parts1[i] - parts2[i];
      }
    }
    
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
  }
  
  <span class="hljs-comment">// 检查版本是否满足范围</span>
  <span class="hljs-title function_">satisfiesVersion</span>(<span class="hljs-params">version, range</span>) {
    <span class="hljs-comment">// 简化实现，实际应使用semver库</span>
    <span class="hljs-keyword">if</span> (range === <span class="hljs-string">'*'</span>) <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    
    <span class="hljs-keyword">const</span> [op, versionRange] = range.<span class="hljs-title function_">match</span>(<span class="hljs-regexp">/^([&gt;=&lt;~^]*)(\d+\.\d+\.\d+)$/</span>).<span class="hljs-title function_">slice</span>(<span class="hljs-number">1</span>);
    <span class="hljs-keyword">const</span> vParts = version.<span class="hljs-title function_">split</span>(<span class="hljs-string">'.'</span>).<span class="hljs-title function_">map</span>(<span class="hljs-title class_">Number</span>);
    <span class="hljs-keyword">const</span> rParts = versionRange.<span class="hljs-title function_">split</span>(<span class="hljs-string">'.'</span>).<span class="hljs-title function_">map</span>(<span class="hljs-title class_">Number</span>);
    
    <span class="hljs-keyword">switch</span> (op) {
      <span class="hljs-keyword">case</span> <span class="hljs-string">'^'</span>: <span class="hljs-comment">// 兼容版本</span>
        <span class="hljs-keyword">return</span> vParts[<span class="hljs-number">0</span>] === rParts[<span class="hljs-number">0</span>] &amp;&amp; vParts[<span class="hljs-number">1</span>] &gt;= rParts[<span class="hljs-number">1</span>];
      <span class="hljs-keyword">case</span> <span class="hljs-string">'~'</span>: <span class="hljs-comment">// 近似版本</span>
        <span class="hljs-keyword">return</span> vParts[<span class="hljs-number">0</span>] === rParts[<span class="hljs-number">0</span>] &amp;&amp; 
               vParts[<span class="hljs-number">1</span>] === rParts[<span class="hljs-number">1</span>] &amp;&amp; 
               vParts[<span class="hljs-number">2</span>] &gt;= rParts[<span class="hljs-number">2</span>];
      <span class="hljs-keyword">case</span> <span class="hljs-string">'&gt;='</span>:
        <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">compareVersions</span>(version, versionRange) &gt;= <span class="hljs-number">0</span>;
      <span class="hljs-keyword">case</span> <span class="hljs-string">'&gt;'</span>:
        <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">compareVersions</span>(version, versionRange) &gt; <span class="hljs-number">0</span>;
      <span class="hljs-keyword">case</span> <span class="hljs-string">'&lt;='</span>:
        <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">compareVersions</span>(version, versionRange) &lt;= <span class="hljs-number">0</span>;
      <span class="hljs-keyword">case</span> <span class="hljs-string">'&lt;'</span>:
        <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">compareVersions</span>(version, versionRange) &lt; <span class="hljs-number">0</span>;
      <span class="hljs-attr">default</span>:
        <span class="hljs-keyword">return</span> version === versionRange;
    }
  }
  
  <span class="hljs-comment">// 弃用通知</span>
  <span class="hljs-title function_">deprecate</span>(<span class="hljs-params">moduleName, version, message</span>) {
    <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-property">deprecations</span>.<span class="hljs-title function_">has</span>(moduleName)) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">deprecations</span>.<span class="hljs-title function_">set</span>(moduleName, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>());
    }
    
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">deprecations</span>.<span class="hljs-title function_">get</span>(moduleName).<span class="hljs-title function_">set</span>(version, {
      message,
      <span class="hljs-attr">deprecatedAt</span>: <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>()
    });
    
    <span class="hljs-comment">// 添加控制台警告</span>
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">warn</span>(<span class="hljs-string">`Module <span class="hljs-subst">${moduleName}</span>@<span class="hljs-subst">${version}</span> is deprecated: <span class="hljs-subst">${message}</span>`</span>);
  }
}

<span class="hljs-comment">// 使用示例</span>
<span class="hljs-keyword">const</span> versionManager = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ModuleVersionManager</span>();

<span class="hljs-comment">// 注册不同版本</span>
versionManager.<span class="hljs-title function_">register</span>(<span class="hljs-string">'utils'</span>, <span class="hljs-string">'1.0.0'</span>, {
  <span class="hljs-attr">oldMethod</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-string">'old'</span>
});

versionManager.<span class="hljs-title function_">register</span>(<span class="hljs-string">'utils'</span>, <span class="hljs-string">'1.1.0'</span>, {
  <span class="hljs-attr">oldMethod</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-string">'old'</span>,
  <span class="hljs-attr">newMethod</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-string">'new'</span>
});

versionManager.<span class="hljs-title function_">register</span>(<span class="hljs-string">'utils'</span>, <span class="hljs-string">'2.0.0'</span>, {
  <span class="hljs-attr">newMethod</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-string">'new'</span>,
  <span class="hljs-attr">betterMethod</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-string">'better'</span>
});

<span class="hljs-comment">// 标记弃用</span>
versionManager.<span class="hljs-title function_">deprecate</span>(<span class="hljs-string">'utils'</span>, <span class="hljs-string">'1.0.0'</span>, <span class="hljs-string">'请升级到1.1.0+版本'</span>);

<span class="hljs-comment">// 获取模块</span>
<span class="hljs-keyword">const</span> utilsV1 = versionManager.<span class="hljs-title function_">get</span>(<span class="hljs-string">'utils'</span>, <span class="hljs-string">'^1.0.0'</span>);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(utilsV1); <span class="hljs-comment">// 1.1.0版本</span>

<span class="hljs-keyword">const</span> utilsLatest = versionManager.<span class="hljs-title function_">get</span>(<span class="hljs-string">'utils'</span>);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(utilsLatest); <span class="hljs-comment">// 2.0.0版本</span>
</code></pre>
<h4 data-id="heading-21">总结</h4>
<p>模块化是现代前端工程化的基石，从前端的脚本标签到ES Modules，再到模块联邦等高级模式，模块化技术不断演进。本文从简单模块加载器实现开始，逐步深入AMD、CMD规范，探讨ES Module的Polyfill技术，并补充了构建工具集成、模块联邦、性能优化等工程化实践。</p>
<p><strong>关键要点总结:</strong></p>
<ol>
<li><strong>模块加载器核心原理:</strong> 依赖管理、缓存、异步加载</li>
<li><strong>规范演进:</strong> 从AMD/CMD到ES Modules的统一</li>
<li><strong>工程化实践:</strong> 代码分割、懒加载、版本管理、依赖注入</li>
<li><strong>未来趋势:</strong> 模块联邦、微前端架构、Web Assembly模块化</li>
</ol>
<p>模块化不仅仅是技术选择，更是一种设计哲学。良好的模块化设计能够提升代码的可维护性、可测试性和团队协作效率。在实际项目中，应根据团队规模、项目复杂度和技术栈选择合适的模块化方案，并不断优化模块边界和依赖关系。</p>
<p>随着前端技术的不断发展，模块化将继续演进，但核心原则——关注点分离、接口抽象、依赖管理——将始终保持不变。掌握模块化的核心原理和实践，能够帮助开发者构建更健壮、可维护的前端应用。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Vue2中能否实现输入中文自动转化为拼音, 且不带音调]]></title>    <link>https://juejin.cn/post/7585463258690420745</link>    <guid>https://juejin.cn/post/7585463258690420745</guid>    <pubDate>2025-12-20T04:55:37.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585463258690420745" data-draft-id="7585382317444972554" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Vue2中能否实现输入中文自动转化为拼音, 且不带音调"/> <meta itemprop="keywords" content="Vue.js"/> <meta itemprop="datePublished" content="2025-12-20T04:55:37.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="用户722786812344"/> <meta itemprop="url" content="https://juejin.cn/user/4100515739233513"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Vue2中能否实现输入中文自动转化为拼音, 且不带音调
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4100515739233513/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    用户722786812344
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-20T04:55:37.000Z" title="Sat Dec 20 2025 04:55:37 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    3
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>vue2中能否实现输入中文自动转化为拼音, 且不带音调。有以下几种方案</p>
<p>方案一：使用pinyin库（推荐）</p>
<p>1.安装依赖</p>
<pre><code class="hljs">npm install pinyin
</code></pre>
<p>2.在Vue组件中使用</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">input</span> 
      <span class="hljs-attr">v-model</span>=<span class="hljs-string">"chineseInput"</span> 
      <span class="hljs-attr">placeholder</span>=<span class="hljs-string">"输入中文"</span>
      @<span class="hljs-attr">input</span>=<span class="hljs-string">"convertToPinyin"</span>
    /&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>中文: {{ chineseInput }}<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>拼音: {{ pinyinOutput }}<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">import</span> pinyin <span class="hljs-keyword">from</span> <span class="hljs-string">'pinyin'</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-title function_">data</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> {
      <span class="hljs-attr">chineseInput</span>: <span class="hljs-string">''</span>,
      <span class="hljs-attr">pinyinOutput</span>: <span class="hljs-string">''</span>
    }
  },
  <span class="hljs-attr">methods</span>: {
    <span class="hljs-title function_">convertToPinyin</span>(<span class="hljs-params"/>) {
      <span class="hljs-comment">// 使用pinyin库转换，设置style为NORMAL去除音调</span>
      <span class="hljs-keyword">const</span> result = <span class="hljs-title function_">pinyin</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">chineseInput</span>, {
        <span class="hljs-attr">style</span>: pinyin.<span class="hljs-property">STYLE_NORMAL</span>, <span class="hljs-comment">// 不带音调</span>
        <span class="hljs-attr">heteronym</span>: <span class="hljs-literal">false</span> <span class="hljs-comment">// 不启用多音字模式</span>
      })
      
      <span class="hljs-comment">// 将二维数组转换为一维字符串</span>
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">pinyinOutput</span> = result.<span class="hljs-title function_">flat</span>().<span class="hljs-title function_">join</span>(<span class="hljs-string">''</span>)
    }
  }
}
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
<p>方案二：自定义指令实现</p>
<p>1.创建自定义指令</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// directives/pinyin.js</span>
<span class="hljs-keyword">import</span> pinyin <span class="hljs-keyword">from</span> <span class="hljs-string">'pinyin'</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> pinyinDirective = {
  <span class="hljs-title function_">bind</span>(<span class="hljs-params">el, binding, vnode</span>) {
    <span class="hljs-keyword">const</span> vm = vnode.<span class="hljs-property">context</span>
    <span class="hljs-keyword">const</span> expression = binding.<span class="hljs-property">expression</span>
    
    el.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'input'</span>, <span class="hljs-function">(<span class="hljs-params">event</span>) =&gt;</span> {
      <span class="hljs-keyword">const</span> result = <span class="hljs-title function_">pinyin</span>(event.<span class="hljs-property">target</span>.<span class="hljs-property">value</span>, {
        <span class="hljs-attr">style</span>: pinyin.<span class="hljs-property">STYLE_NORMAL</span>
      })
      
      <span class="hljs-keyword">const</span> pinyinText = result.<span class="hljs-title function_">flat</span>().<span class="hljs-title function_">join</span>(<span class="hljs-string">''</span>)
      
      <span class="hljs-comment">// 更新绑定的数据</span>
      vm[expression] = pinyinText
    })
  }
}

<span class="hljs-comment">// 在main.js中注册全局指令</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">Vue</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>
<span class="hljs-keyword">import</span> { pinyinDirective } <span class="hljs-keyword">from</span> <span class="hljs-string">'./directives/pinyin'</span>

<span class="hljs-title class_">Vue</span>.<span class="hljs-title function_">directive</span>(<span class="hljs-string">'pinyin'</span>, pinyinDirective)
</code></pre>
<p>2.在组件中使用指令</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">v-model</span>=<span class="hljs-string">"chineseText"</span> <span class="hljs-attr">placeholder</span>=<span class="hljs-string">"输入中文"</span> /&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">v-pinyin</span>=<span class="hljs-string">"pinyinText"</span> <span class="hljs-attr">placeholder</span>=<span class="hljs-string">"这里显示拼音"</span> /&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>拼音结果: {{ pinyinText }}<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span>
export default {
### data(https://www.falvce.com/) {
    return {
      chineseText: '',
      pinyinText: ''
    }
  }
}
<span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
<p>方案三：使用计算属性</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">v-model</span>=<span class="hljs-string">"chineseInput"</span> <span class="hljs-attr">placeholder</span>=<span class="hljs-string">"输入中文"</span> /&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>拼音: {{ pinyinResult }}<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">import</span> pinyin <span class="hljs-keyword">from</span> <span class="hljs-string">'pinyin'</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-title function_">data</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> {
      <span class="hljs-attr">chineseInput</span>: <span class="hljs-string">''</span>
    }
  },
  <span class="hljs-attr">computed</span>: {
    <span class="hljs-title function_">pinyinResult</span>(<span class="hljs-params"/>) {
      <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-property">chineseInput</span>) <span class="hljs-keyword">return</span> <span class="hljs-string">''</span>
      
      <span class="hljs-keyword">const</span> result = <span class="hljs-title function_">pinyin</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">chineseInput</span>, {
        <span class="hljs-attr">style</span>: pinyin.<span class="hljs-property">STYLE_NORMAL</span>
      })
      
      <span class="hljs-keyword">return</span> result.<span class="hljs-title function_">flat</span>().<span class="hljs-title function_">join</span>(<span class="hljs-string">''</span>)
    }
  }
}
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
<p>方案四：带防抖的优化版本</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">input</span> 
      <span class="hljs-attr">v-model</span>=<span class="hljs-string">"chineseInput"</span> 
      <span class="hljs-attr">placeholder</span>=<span class="hljs-string">"输入中文"</span>
      @<span class="hljs-attr">input</span>=<span class="hljs-string">"debouncedConvertPinyin"</span>
    /&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>拼音: {{ pinyinOutput }}<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">import</span> pinyin <span class="hljs-keyword">from</span> <span class="hljs-string">'pinyin'</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-title function_">data</span>(<span class="hljs-params">https:<span class="hljs-comment">//www.falvce.com/) {</span>
    <span class="hljs-keyword">return</span> {
      chineseInput: <span class="hljs-string">''</span>,
      pinyinOutput: <span class="hljs-string">''</span>,
      timeout: <span class="hljs-literal">null</span>
    }
  },
  methods: {
    convertToPinyin() {
      <span class="hljs-keyword">const</span> result = pinyin(<span class="hljs-variable language_">this</span>.chineseInput, {
        style: pinyin.STYLE_NORMAL
      })
      <span class="hljs-variable language_">this</span>.pinyinOutput = result.flat().join(<span class="hljs-string">''</span>)
    },
    
    debouncedConvertPinyin() {
      // 防抖处理，避免频繁转换
      <span class="hljs-built_in">clearTimeout</span>(<span class="hljs-variable language_">this</span>.timeout)
      <span class="hljs-variable language_">this</span>.timeout = <span class="hljs-built_in">setTimeout</span>(() =&gt; {
        <span class="hljs-variable language_">this</span>.convertToPinyin()
      }, <span class="hljs-number">300</span>)
    }
  },
  
  beforeDestroy() {
    <span class="hljs-built_in">clearTimeout</span>(<span class="hljs-variable language_">this</span>.timeout)
  }
}
</span></span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
<p>方案五：使用其他拼音库</p>
<p>如果不使用pinyin库，也可以使用考虑其他替代方案</p>
<p>使用tiny-pinyin</p>
<pre><code class="hljs">npm install tiny-pinyin
</code></pre>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">import</span> { pinyin } <span class="hljs-keyword">from</span> <span class="hljs-string">'tiny-pinyin'</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-attr">methods</span>: {
    <span class="hljs-title function_">convertToPinyin</span>(<span class="hljs-params">text</span>) {
      <span class="hljs-keyword">return</span> <span class="hljs-title function_">pinyin</span>(text, { <span class="hljs-attr">toneType</span>: <span class="hljs-string">'none'</span> }) <span class="hljs-comment">// 不带音调</span>
    }
  }
}
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
<p>注意事项</p>
<ul>
<li>性能考虑：对于大量文本转换，建议使用防抖或节流</li>
<li>多音字处理：上述示例关闭了多音字模式，如需处理多音字需要额外逻辑</li>
<li>非中文字符：拼音库通常会保留非中文字符不变</li>
<li>空格处理：可根据需求决定是否保留空格</li>
<li>推荐使用方案一或方案三，它们实现简单且易于维护。</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[从零手写一个 printf 函数：变参宏与默认参数提升]]></title>    <link>https://juejin.cn/post/7585446706326765577</link>    <guid>https://juejin.cn/post/7585446706326765577</guid>    <pubDate>2025-12-20T04:58:51.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585446706326765577" data-draft-id="7585382317444988938" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="从零手写一个 printf 函数：变参宏与默认参数提升"/> <meta itemprop="keywords" content="Linux"/> <meta itemprop="datePublished" content="2025-12-20T04:58:51.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="xlp666hub"/> <meta itemprop="url" content="https://juejin.cn/user/2965810860569131"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            从零手写一个 printf 函数：变参宏与默认参数提升
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2965810860569131/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    xlp666hub
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-20T04:58:51.000Z" title="Sat Dec 20 2025 04:58:51 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读18分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在学习 C 语言的过程中，<code>printf</code> 应该是我们打交道最多的函数了。但你是否思考过下面的问题：普通的函数参数个数都是<strong>固定</strong>的，为什么 <code>printf</code> 可以接受无限个参数？编译器又是怎么知道我们传了几个参数的？为什么 <code>%c</code> 明明是打印字符，底层却要按 <code>int</code> 类型来处理？</p>
<p>在这篇文章，我们就从零手写一个 <code>my_printf</code>，彻底弄懂 C 语言 <strong>变参函数</strong> 和 <strong>函数调用栈</strong> 的底层原理。</p>
<h2 data-id="heading-0">1. 核心原理</h2>
<h3 data-id="heading-1">1.1 编译器</h3>
<p>对于我们比较常见的普通函数，他们的<strong>参数类型和数量一般是固定</strong>的，像这样：</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-type">void</span> <span class="hljs-title function_">func</span><span class="hljs-params">(<span class="hljs-type">int</span> a, <span class="hljs-type">int</span> b)</span>;
</code></pre>
<p>这种情况下，编译器在编译时非常清楚，调用这个函数需要传递 2 个 <code>int</code>。</p>
<p>我们再来看看<code>printf</code>函数的声明：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e2c8cdbea42742f287599d6207bb0bd7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgeGxwNjY2aHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766811531&amp;x-signature=dZN5CQgMwCKeSzLt9Ea2ylcqDh4%3D" alt="1. printf声明.png" loading="lazy"/></p>
<h4 data-id="heading-2">1.1.1 restrict 的作用</h4>
<p>在进入咱们的正题之前，我们先需要了解一下图中的<code>restrict</code> 到底是起了什么作用。<code>restrict</code> 是 C99 标准引入的关键字，通俗一点来说，它的作用是告诉编译器：这个 <code>const char *</code> 指针是访问它所指向内存的<strong>唯一</strong>入口，除此之外，别无其他指针，从而使得编译器可以放心大胆地去优化代码。</p>
<p>仅仅这样语言描述一下，可能还是有点不够形象，为了帮助大家理解，我下面举个例子：</p>
<p>编译器在优化代码时，其实是非常保守的，因为它非常害怕<strong>两个不同的指针实际上指向同一块内存（指针别名）</strong> 。请看下面的代码：</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-type">void</span> <span class="hljs-title function_">add</span><span class="hljs-params">(<span class="hljs-type">int</span> *a, <span class="hljs-type">int</span> *b, <span class="hljs-type">int</span> *val)</span> 
{
    *a += *val;
    *b += *val;
}
</code></pre>
<p>这个<code>add</code>函数接收三个<code>int *</code>类型的参数，分别是<code>a</code>，<code>b</code>，<code>val</code>，然后将<code>val</code>所指向内存的值分别加到<code>a</code>和<code>b</code>所指向内存中的值。</p>
<p>上面其实也提到了，编译器优化代码时是很<strong>保守</strong>的。我们来梳理一下这个过程，编译器在第一步会读取 <code>* val</code> 的值，然后加到 <code>* a</code>中去，第二步，再次读取 <code>* val</code> 的值，然后将读取到的 <code>* val</code>的值加到 <code>* b</code>中去。</p>
<p>可能有人这样想：第一步不是已经读取了 <code>* val</code> 的值了吗？为什么第二步还要再读取一遍呢？直接使用第一步读取到的值不行吗？</p>
<p>而编译器是这样想的：如果在传参数是 <code>a</code> 和 <code>val</code> 指向的是<strong>同一个地址</strong>怎么办？第一步的操作改变了 <code>* a</code> 的值，同时也改变了 <code>* val</code> 的值，如果还使用改变之前的 <code>* val</code> 的值，那计算不是出错了吗？因此，在编译器不能确保两个指针指向的不是同一块内存时，它在使用这块内存中的值之前都会去内存里面重新读取一下，以防计算发生错误。</p>
<p>而如果我们加上<code>restrict</code>，像下面这样：</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-type">void</span> <span class="hljs-title function_">add_2</span><span class="hljs-params">(<span class="hljs-type">int</span> *a, <span class="hljs-type">int</span> *b, <span class="hljs-type">int</span> *<span class="hljs-keyword">restrict</span> val)</span> {
    *a += *val;
    *b += *val;
}
</code></pre>
<p>这就相当于告诉编译器，<code>* val</code> 的值绝对不会被 <code>a</code> 或 <code>b</code> 修改，这样编译器在第一次读取了 <code>* val</code> 的值后，第二步时直接就能使用，省得再回内存里面去查。这样也会带来相应的<strong>性能提升</strong>。</p>
<h4 data-id="heading-3">1.1.2 restrict 案例分析</h4>
<p>为了让大家能够更清晰地看到这个现象，我进行了下面的实验：</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-type">void</span> <span class="hljs-title function_">add</span><span class="hljs-params">(<span class="hljs-type">int</span> *a, <span class="hljs-type">int</span> *b, <span class="hljs-type">int</span> *val)</span> 
{
    *a += *val;
    *b += *val;
}
​
<span class="hljs-type">void</span> <span class="hljs-title function_">add_2</span><span class="hljs-params">(<span class="hljs-type">int</span> *a, <span class="hljs-type">int</span> *b, <span class="hljs-type">int</span> *<span class="hljs-keyword">restrict</span> val)</span> 
{
    *a += *val;
    *b += *val;
}
​
</code></pre>
<p>这段代码<code>add</code>函数的 <code>val</code> 我没加<code>restrict</code>，而<code>add_2</code>函数我加了。然后可以使用下面的命令，将这段代码编译成汇编代码：</p>
<pre><code class="hljs language-bash" lang="bash">gcc -O2 -S demo.c -o demo.s
</code></pre>
<p><strong>-O2</strong>选项是开启编译器优化，<strong>-S</strong>是生成汇编代码。</p>
<p>下面是我截取的部分汇编代码：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8afde7b2d5c84d1ea2c8f1c6e900a3a2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgeGxwNjY2aHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766811531&amp;x-signature=uPoMSWWbo1QF9NopqA1jZAHPAmM%3D" alt="2. 汇编代码.png" loading="lazy"/></p>
<p>生成的汇编代码中，我们只需要看关键部分，对于<code>add</code>函数，我们需要看第 10-13 行，对于<code>add_2</code>函数，我们需要看 25-27 行。</p>
<p>在我使用的 64 位 Linux 系统中，<strong>函数参数是通过寄存器传递</strong>的，有<strong>固定的顺序</strong>。第一个参数 <code>a</code> 放在寄存器 <code>%rdi</code> 中，第二个参数 <code>b</code> 放在寄存器 <code>%rsi</code> 中，第三个参数 <code>val</code> 存放在寄存器 <code>%rdx</code> 中。而 <code>%eax</code> 是一个通用寄存器，用于临时存放数据。</p>
<p>在了解了一些必备的知识后，我们先来看函数<code>add</code>的关键部分。第10行，<code>movl (%rdx), %eax</code> ，去<code>val</code>指向的内存地址 <code>%rdx</code> ，把里面的数字取出来放到 <code>%eax</code> 中。第11行，<code>addl %eax, (%rdi)</code>，将 <code>%eax</code> 中的数加到<code>a</code>指向的内存地址 <code>%rdi</code> 中去。在看第12行，又去<code>val</code>指向的 <code>%rdx</code> ，把里面的值取出来放到 <code>%eax</code> 中，第13行，<code>addl %eax, (%rsi)</code>，把 <code>%eax</code> 中的数加到 <code>%rsi</code> 中去。在我们看来，第二次再去读 <code>* val</code> 的值是多此一举的，但是编译器害怕旧值被修改，就只能再去读一次，拿到最新的值。</p>
<p>再来看函数 <code>add_2</code> ，这里的<code>val</code>加了<code>restrict</code>关键字，我们看看情况是否有所不同。第25行依然是去<code>val</code>指向的内存，将值取出来放到 <code>%eax</code> 中，第26行将 <code>%eax</code> 中的值加到<code>a</code>所指向的内存地址 <code>%rdi</code> 中去。而到了第27行，它没有再去读一遍 <code>* val</code> 的值，而是直接使用旧的 <code>* val</code> 的值直接加到<code>b</code>指向的内存 <code>%rsi</code> 中去。</p>
<p>到这里相信大家已经很清晰了。<strong>内存是慢速设备，而寄存器速度是极快</strong>的，加上<code>restrict</code>关键词，我们节省了一次去内存读取的开销。</p>
<h4 data-id="heading-4">1.1.3 小结</h4>
<p>在了解了<code>restrict</code>之后，新的问题有浮出水面了。回过头去看<code>printf</code>函数的声明，编译器<strong>只能知道有一个固定参数</strong><code>format</code>，他不知道后面还有没有参数，更不知道后面参数是什么类型的。既然编译器不知道，那么<code>printf</code>是怎样正确的打印出内容的呢？答案藏在下一章的内容里面。</p>
<h3 data-id="heading-5">1.2 函数调用栈</h3>
<p>假如我们在32位系统下调用下面的代码：</p>
<pre><code class="hljs language-c" lang="c">my_printf(<span class="hljs-string">"Num:%d"</span>, <span class="hljs-number">100</span>);
</code></pre>
<p>此时，我们来看一下<strong>函数调用栈</strong>的布局：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bc36a4b670a148bab85ab6f565721104~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgeGxwNjY2aHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766811531&amp;x-signature=%2FA1s7OoajLA6UlPAknx4wUTBmBc%3D" alt="3. 栈帧.png" loading="lazy"/></p>
<p>注：现代 x64 或 ARM 架构通常优先使用寄存器传参（上面汇编的解释中提到过），但 <code>stdarg.h</code> 的封装让我们在逻辑上还是可以像操作栈一样去处理它们，核心思想是不变的。</p>
<p>首先，我们要知道，<strong>栈是从高地址向低地址生长的</strong>。可以仔细观察一下图中左边函数调用栈的布局，最上面的是之前的栈帧。</p>
<p>其次，我们还要知道，<strong>函数参数的入栈顺序是从右向左</strong>的。在我举的这个例子里面，<strong>最右边的参数100</strong> 先入栈，它紧贴着之前的栈帧，然后它左边的参数（也就是 “<code>Num:%d</code>” 的所在的地址）入栈，紧贴着参数100存放。最后函数的返回地址入栈。</p>
<p>理解了这张图，那一切就都明了了。虽然编译器<strong>只知道第一个固定参数</strong>，而不知道它后面有什么，但根据 C 语言的调用约定，<strong>变参一定紧紧挨着固定参数存放</strong>，并且位于更高的地址。</p>
<p>下面我们来顺一下整个流程，参数<code>format</code>的类型是<code>const char *</code>，也就是说它<strong>本身是一个指针</strong>，真正的字符串内容 “<code>Num:%d</code>” 存放在<strong>只读数据区(.rodata)</strong> ，在32为系统下它的大小是 <strong>4 个字节</strong>，而本身存放 <code>format</code> 的地址我们也是知道的。我们要做的，是拿到<code>format</code>变量本身在栈上的地址，然后加上<code>format</code>的大小，也就是4个字节，这样指针就跳过了<code>format</code>占据的地址，从而能够得到变参（100）的地址。同理，就算后面还有其他变参，我们也能通过<strong>地址偏移</strong>的方法找到他。</p>
<p>如果使用的是<strong>64位系统</strong>，那么<code>format</code>的大小就会改变为 8 个字节，但是原理还是这样的。</p>
<p>这也就是为什么编译器并不知道<code>format</code>后面的参数是什么，而<code>printf</code>却能正确打印出来的原因。</p>
<h3 data-id="heading-6">1.3 变参宏的本质</h3>
<p>理论上，我们确实可以手动通过 <code>(char*)&amp;format + 4</code> 来找到下一个参数。</p>
<p>这里先简要提一下为什么取<code>format</code>的地址后要转为<code>char *</code>类型，这就涉及到C语言中一个基础知识点——<strong>指针运算</strong>。在C语言中，<strong>指针加减的单位不是字节，而是它指向的数据类型的大小</strong>。我把指针转为<code>char *</code>类型，是为了能够让它以字节为单位移动。在转换类型之后，<code>(char*)&amp;format</code>的数据类型为<code>char *</code>，它指向的是<code>char</code>类型，长度为 1 个字节，所以<code>(char*)&amp;format + 4</code>，指针就会精确的移动4个字节，刚好跳过<code>format</code>变量。如果不转的话，<code>&amp;format</code> 的类型是 <code>char**</code>，它指向的是 <code>char*</code> (指针，在32位系统里面大小为 4 )，再给他加上 4 ，那么这个指针就会移动16个字节，已经错过了我们要找的变参。</p>
<p>但直接写<strong>硬编码</strong>的数字（+4）是<strong>非常危险</strong>的。因为在 64 位系统上它应该是 +8，在某些特殊架构上对齐方式可能更复杂。因此，为了解决跨平台问题，C 语言在 <code>&lt;stdarg.h&gt;</code> 中封装了一套<strong>标准宏</strong>。</p>
<p>为了弄懂这些宏执行的操作和我上面描述的是否一致，我查看了现代Linux环境下<code>&lt;stdarg.h&gt;</code>的源码。结果发现GCC的<code>&lt;stdarg.h&gt;</code>的实现如下：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2673290464e742919f497b9ec02e41e3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgeGxwNjY2aHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766811531&amp;x-signature=bDG0BsQcUVQI99ZeVbHGPCCTx2c%3D" alt="4. stdarg源码.png" loading="lazy"/></p>
<p>这里要简单补充一下，普通的头文件（如 <code>stdio.h</code>）通常由 C 标准库提供，放在 <code>/usr/include</code>。但 <code>stdarg.h</code> 非常特殊，它涉及参数传递的底层细节（如寄存器使用、栈帧布局），这些是<strong>依赖编译器实现</strong>的。因此，GCC 不会使用系统默认的 stdarg.h，而是会优先使用自己<strong>私有目录</strong>下的版本。</p>
<p>因此我们要使用下面的命令去查看：</p>
<pre><code class="hljs language-bash" lang="bash">vim $(gcc -print-file-name=include/stdarg.h)
</code></pre>
<p>为什么要使用这条命令呢？因为<code>gcc</code>安装目录版本众多，路径随版本变化，而这条命令能获得<code>gcc</code>实际使用的文件并使用<code>vim</code>编辑器打开它。</p>
<p>现在我们来看一下<code>&lt;stdarg.h&gt;</code>的源码，全是 <code>__builtin_</code> 开头的函数。这是因为现代 CPU 架构（如 x86-64）的参数传递非常复杂（<strong>优先使用寄存器，寄存器用完了才压栈</strong>），单纯的指针加减法已经无法搞定了。编译器为了极致的性能优化，选择把这些操作直接<strong>内置</strong>在编译器内部。</p>
<p>为了能够让大家看到实际的C语言实现，我翻出了 <strong>Linux 0.11 内核源码</strong> ，我把源码的内容直接放在下面的代码块中（注：原汁原味，我一点没改）：</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> _STDARG_H</span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> _STDARG_H</span>
​
<span class="hljs-keyword">typedef</span> <span class="hljs-type">char</span> *va_list;
​
<span class="hljs-comment">/* Amount of space required in an argument list for an arg of type TYPE.
   TYPE may alternatively be an expression whose type is used.  */</span>
​
<span class="hljs-meta">#<span class="hljs-keyword">define</span> __va_rounded_size(TYPE)  \
  (((sizeof (TYPE) + sizeof (int) - 1) / sizeof (int)) * sizeof (int))</span>
​
<span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> __sparc__</span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> va_start(AP, LASTARG)                       \
 (AP = ((char *) &amp;(LASTARG) + __va_rounded_size (LASTARG)))</span>
<span class="hljs-meta">#<span class="hljs-keyword">else</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> va_start(AP, LASTARG)                       \
 (__builtin_saveregs (),                        \
  AP = ((char *) &amp;(LASTARG) + __va_rounded_size (LASTARG)))</span>
<span class="hljs-meta">#<span class="hljs-keyword">endif</span></span>
​
<span class="hljs-type">void</span> <span class="hljs-title function_">va_end</span> <span class="hljs-params">(va_list)</span>;      <span class="hljs-comment">/* Defined in gnulib */</span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> va_end(AP)</span>
​
<span class="hljs-meta">#<span class="hljs-keyword">define</span> va_arg(AP, TYPE)                        \
 (AP += __va_rounded_size (TYPE),                   \
  *((TYPE *) (AP - __va_rounded_size (TYPE))))</span>
​
<span class="hljs-meta">#<span class="hljs-keyword">endif</span> <span class="hljs-comment">/* _STDARG_H */</span></span>
</code></pre>
<p>源码第 9，10 行定义了一个宏 <code>__va_rounded_size</code>，这行代码看着复杂，其实只做一件事，就是<strong>向上取整到 int 的倍数</strong>。也就是说如果你传<code>char</code>，算出来是 4，如果你传<code>int</code>，算出来还是 4，如果你传<code>double</code>，算出来就是 8 。这也解释了为什么我们在手动推导时，默认步长是 4 的原因，本质上是<strong>为了保证栈上的内存对齐</strong>。</p>
<p>然后请看源码第 13 行，相信大家已经看到了<code>char *</code>强转，<code>&amp;LASTARG</code> 取出的是固定参数的地址，如果不转成 <code>char *</code>，指针加法会按照该类型的步长移动，转成 <code>char *</code> 后，加法就变成了<strong>字节级</strong>的移动。这也证实了<strong>必须要将指针转为单字节步长</strong>，才能精确跨过固定参数，指向<strong>变参</strong>的第一个元素。</p>
<p>再看源码第 24 行，这里的操作非常有意思，它利用了 C 语言的 <strong>逗号表达式</strong>：(A, B)。规则是：<strong>先执行 A，再执行 B，并且整个表达式的值等于 B 的值。</strong> 在逗号前，游标 AP 直接<strong>向前移动</strong>，跨过了当前这个参数，指向了<strong>下一个参数</strong>的起点。逗号后，用新的参数起始地址减去当前参数的大小，就是当前参数的起始地址，把这个地址强转为<code>TYPE *</code>，再解引用，最后拿到数据。最后<strong>这个宏的值就是拿到的数据</strong>。至于逗号后面为什么要强转为<code>TYPE *</code>然后再解引用，这是因为<strong>解引用后取出数据的长度是根据被解引用的这个东西的数据类型决定</strong>的，如果这个数据类型不是<code>TYPE *</code>，那么解引用取出的数据长度自然就不符合我们的预期。</p>
<h2 data-id="heading-7">2. 默认参数提升</h2>
<p>搞懂了底层的宏定义，我们终于可以开始写代码了。但在动手之前，必须先讲一个大家可能会<strong>踩的坑</strong>。</p>
<p>我们在实现 <code>my_printf</code> 处理 <code>%c</code>字符时，如果没有了解过这个细节，直觉上会这样写：</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-type">char</span> c = va_arg(ap, <span class="hljs-type">char</span>);  <span class="hljs-comment">//错误写法</span>
</code></pre>
<p>这样写会导致指针偏移量出现错误，甚至读到乱码。</p>
<h3 data-id="heading-8">2.1 为什么不能直接取char</h3>
<p>不知道大家对我们 1.3 节中提到的<code>__va_rounded_size</code>这个宏还有印象吗。无论你传入的数据类型多小，栈上的槽位最小也是 <code>sizeof(int)</code>。在 C 语言的<strong>变参函数调用约定</strong>中，有一条<strong>默认参数提升</strong>规则：</p>
<p><strong>char、short</strong> 在入栈前会自动升级为 <strong>int</strong>。</p>
<p><strong>float</strong> 在入栈前会自动升级为 <strong>double</strong>。</p>
<h3 data-id="heading-9">2.2 原理分析</h3>
<p><strong>如果你写 <code>va_arg(ap, char)</code>：</strong> 宏计算出的步长是 <code>sizeof(char)</code> = 1 字节。游标 AP 只往后移了 1 个字节。但实际上，栈里那个字符占了 4 个字节。</p>
<p>结果就是<strong>指针错位</strong>，后面的<strong>所有参数读取全乱套</strong>。</p>
<p>那么怎样写才是正确的呢？既然编译器把 <code>char</code> 变成了 <code>int</code> 塞进栈里，那我们取的时候，也必须按 <code>int</code> 去取，然后再强转回来。想下面这样：</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-type">int</span> val = va_arg(ap, <span class="hljs-type">int</span>);   <span class="hljs-comment">// 按照 int 的步长去栈里捞数据</span>
my_putchar((<span class="hljs-type">char</span>)val);   <span class="hljs-comment">// 强转回 char 使用</span>
</code></pre>
<h2 data-id="heading-10">3. 核心代码实现</h2>
<p>理论现在已经了解的差不多了，我们现在来直接使用系统调用<code>write</code>实现一个<code>my_printf</code>。</p>
<h3 data-id="heading-11">3.1 基础函数编写</h3>
<p><code>printf</code> 的核心难点在于<strong>把整数转换成字符串</strong>，例如把整数 123 变成字符数组 <code>{'1', '2', '3', '\0'}</code>。标准库有 <code>itoa</code>，但我们要自己写一个。请看下面代码：</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdarg.h&gt;</span></span>
​
<span class="hljs-comment">//往屏幕写一个字符</span>
<span class="hljs-type">void</span> <span class="hljs-title function_">my_putchar</span><span class="hljs-params">(<span class="hljs-type">char</span> c)</span> 
{
    write(<span class="hljs-number">1</span>, &amp;c, <span class="hljs-number">1</span>);
}
​
<span class="hljs-comment">//往屏幕写字符串</span>
<span class="hljs-type">void</span> <span class="hljs-title function_">my_putstr</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span> *str)</span> 
{
    <span class="hljs-type">int</span> i = <span class="hljs-number">0</span>;
    <span class="hljs-keyword">while</span>(str[i]) my_putchar(str[i++]);
}
​
<span class="hljs-comment">//将整数 value 转换为字符串并打印</span>
<span class="hljs-comment">//base表示 10 进制或 16 进制</span>
<span class="hljs-type">void</span> <span class="hljs-title function_">my_itoa</span><span class="hljs-params">(<span class="hljs-type">int</span> value, <span class="hljs-type">int</span> base)</span> 
{
    <span class="hljs-type">char</span> buffer[<span class="hljs-number">32</span>];
    <span class="hljs-type">int</span> i = <span class="hljs-number">0</span>, is_neg = <span class="hljs-number">0</span>;
​
    <span class="hljs-comment">// 0 是特殊情况，单独处理</span>
    <span class="hljs-keyword">if</span> (value == <span class="hljs-number">0</span>) 
    {
        my_putchar(<span class="hljs-string">'0'</span>);
        <span class="hljs-keyword">return</span>;
    }
    
    <span class="hljs-comment">//处理负数 (这里只处理十进制)</span>
    <span class="hljs-keyword">if</span> (value &lt; <span class="hljs-number">0</span> &amp;&amp; base == <span class="hljs-number">10</span>) 
    {
        is_neg = <span class="hljs-number">1</span>;
        value = -value;
    }
​
    <span class="hljs-comment">//循环取模，把 value 的各位数从后往前依次存在 buffer 中</span>
    <span class="hljs-keyword">while</span> (value != <span class="hljs-number">0</span>) 
    {
        <span class="hljs-type">int</span> rem = value % base;
        buffer[i++] = (rem &gt; <span class="hljs-number">9</span>) ? (rem - <span class="hljs-number">10</span>) + <span class="hljs-string">'a'</span> : rem + <span class="hljs-string">'0'</span>;<span class="hljs-comment">//如果是十六进制，要处理 a-f</span>
        value /= base;
    }
​
    <span class="hljs-comment">//如果是负数，给 buffer 最后再补个负号</span>
    <span class="hljs-keyword">if</span> (is_neg) buffer[i++] = <span class="hljs-string">'-'</span>;
​
    <span class="hljs-comment">//逆序打印，把 buffer 的内容从后往前依次打印</span>
    <span class="hljs-keyword">while</span> (i &gt; <span class="hljs-number">0</span>) my_putchar(buffer[--i]);
}
</code></pre>
<p>虽然上面的注释已经很完善了，但我还是想简单解释一下上面代码的实现。我们假设传进去的数字是 123 。</p>
<p>计算机不认识 123 这个整体，它只认识二进制。为了把它变成字符 '1', '2', '3'，我们需要从<strong>个位</strong>开始剥离，请结合<code>while</code>循环中的代码理解下面过程：</p>
<p><strong><code>value % base</code></strong>：拿到最后一位数字，例如 <code>123 % 10 = 3</code> 。</p>
<p>然后将它放在<code>buffer[0]</code>，然后 <code>i</code> 变成 1 。</p>
<p><strong><code>value / base</code></strong>：去掉最后一位，例如 <code>123 / 10 = 12</code> 。</p>
<p>就这样循环 3 次，<code>buffer[] = {3, 2, 1}</code>，这时 <code>i</code> 为 3 。</p>
<p>因为它不是负数，下一步就可以循环打印了。打印的时候，<code>i</code> 先减 1，变成 2 ，这时打印出<code>buffer[2]</code>也就是 1，依次类推，最终打印出 1，2，3 三个字符。</p>
<h3 data-id="heading-12">3.2 主要逻辑</h3>
<p>有了 <code>my_itoa</code> 和标准宏，我们就可以编写主函数逻辑了。</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-type">int</span> <span class="hljs-title function_">my_printf</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span> *format, ...)</span> 
{
    va_list ap;
    va_start(ap, format); <span class="hljs-comment">//初始化，让 ap 指向第一个变参</span>
​
    <span class="hljs-type">const</span> <span class="hljs-type">char</span> *p = format;
    <span class="hljs-keyword">while</span> (*p != <span class="hljs-string">'\0'</span>) 
    {
        <span class="hljs-keyword">if</span> (*p == <span class="hljs-string">'%'</span>) 
        {
            p++; <span class="hljs-comment">// 跳过 '%'</span>
            
            <span class="hljs-keyword">switch</span> (*p) 
            {
                <span class="hljs-keyword">case</span> <span class="hljs-string">'d'</span>: <span class="hljs-comment">// 十进制整数</span>
                { 
                    <span class="hljs-type">int</span> val = va_arg(ap, <span class="hljs-type">int</span>); <span class="hljs-comment">// 从栈里取出一个 int</span>
                    my_itoa(val, <span class="hljs-number">10</span>);          
                    <span class="hljs-keyword">break</span>;
                }
                <span class="hljs-keyword">case</span> <span class="hljs-string">'x'</span>: <span class="hljs-comment">// 十六进制整数</span>
                { 
                    <span class="hljs-type">int</span> val = va_arg(ap, <span class="hljs-type">int</span>);
                    my_putstr(<span class="hljs-string">"0x"</span>);           <span class="hljs-comment">// 加个前缀</span>
                    my_itoa(val, <span class="hljs-number">16</span>);
                    <span class="hljs-keyword">break</span>;
                }
                <span class="hljs-keyword">case</span> <span class="hljs-string">'c'</span>: <span class="hljs-comment">// 字符</span>
                { 
                    <span class="hljs-type">int</span> val = va_arg(ap, <span class="hljs-type">int</span>); 
                    my_putchar((<span class="hljs-type">char</span>)val);
                    <span class="hljs-keyword">break</span>;
                }
                <span class="hljs-keyword">case</span> <span class="hljs-string">'s'</span>: <span class="hljs-comment">// 字符串</span>
                { 
                    <span class="hljs-comment">// 字符串本质是 char* 指针，指针不需要提升</span>
                    <span class="hljs-type">char</span> *str = va_arg(ap, <span class="hljs-type">char</span>*);
                    my_putstr(str);
                    <span class="hljs-keyword">break</span>;
                }
                <span class="hljs-keyword">default</span>: <span class="hljs-comment">// 如果不是上面的几种，原样打印</span>
                    my_putchar(<span class="hljs-string">'%'</span>);<span class="hljs-comment">//记得先把跳过的那个 % 打印了</span>
                    my_putchar(*p);
                    <span class="hljs-keyword">break</span>;
            }
        } <span class="hljs-keyword">else</span> 
        {
            <span class="hljs-comment">// 普通字符</span>
            my_putchar(*p);
        }
        p++; <span class="hljs-comment">// 继续扫描下一个字符</span>
    }
​
    va_end(ap); <span class="hljs-comment">//将 ap 置空，防止野指针</span>
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;   <span class="hljs-comment">//这里简化版返回 0，标准库通常返回打印的字符数</span>
}
</code></pre>
<p>这段代码的主要逻辑是：如果遇到普通字符，那就直接输出。如果遇到 <code>%</code>，暂停输出，查看下一个字符是什么再决定去栈里取什么数据。</p>
<p>理解了主要逻辑，我们再看一下几个关键细节：</p>
<pre><code class="hljs language-c" lang="c">va_start(ap, format);
</code></pre>
<p>执行完这句，指针 <code>ap</code> 就已经跳过了 <code>format</code> 字符串本身，停在了<strong>第一个变参</strong>的内存起始位置，准备随时被调用。</p>
<p>然后是<code>switch-case</code>逻辑，根据 <code>%</code> 后面的字母，决定<strong>用什么类型去取栈里的数据</strong>。如果是<code>%d</code>，调用 <code>va_arg(ap, int)</code>。编译器会生成指令，从当前栈位置复制 4 个字节，解释为 <code>int</code>，然后调用我们写好的 <code>my_itoa</code> 转成字符打印。如果是<code>%x</code>，逻辑和上面相同，但我手动打印了 <code>"0x"</code> 前缀，这样能与十进制有所区别。如果是 <code>%s</code> ，调用<code>va_arg(ap, char*)</code>。注意这里取出的只是一个<strong>指针</strong>，真正的字符串内容存储在常量区或堆区，我们把这个地址交给 <code>my_putstr</code> 去遍历打印。然后就是那个反直觉的 <code>%c</code> ，虽然我们要打印的是 <code>char</code>，但在 <code>va_arg</code> 里必须写 <code>int</code>，正如第二章所述，C 语言的<strong>默认参数提升</strong>规则，<code>char</code> 在入栈时已经被强转为 <code>int</code> 了，因此我们取的时候也要按照<code>int</code>来取。</p>
<p>最后<code>va_end(ap)</code>，调用它来将指针置空。</p>
<h2 data-id="heading-13">4. 测试与验证</h2>
<p>为了验证我们的 <code>my_printf</code> 是否经得起考验，我编写了一个 <code>main</code> 函数，覆盖了整数、十六进制、字符串，和最关键的<strong>字符提升</strong>。</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span> 
{
    my_putstr(<span class="hljs-string">"=== My Printf Test ===\n"</span>);
​
    my_printf(<span class="hljs-string">"Integer: %d\n"</span>, <span class="hljs-number">12345</span>);
    my_printf(<span class="hljs-string">"Negative: %d\n"</span>, <span class="hljs-number">-6789</span>);
    
    my_printf(<span class="hljs-string">"Hex: %x\n"</span>, <span class="hljs-number">255</span>); 
​
    my_printf(<span class="hljs-string">"String: %s\n"</span>, <span class="hljs-string">"Hello World"</span>);
​
    my_printf(<span class="hljs-string">"Char: %c\n"</span>, <span class="hljs-string">'A'</span>); 
​
    my_printf(<span class="hljs-string">"Mix: %d + %c = %s\n"</span>, <span class="hljs-number">1</span>, <span class="hljs-string">'2'</span>, <span class="hljs-string">"Three"</span>);
​
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}
</code></pre>
<p>运行结果如下，大家可以看到，各种类型都能正常打印。包括涉及到参数提升的<code>char</code>型，也能正常打印。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3713c1563d184b3d889fc1a3da08156a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgeGxwNjY2aHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766811531&amp;x-signature=8y2WwYyxXCY6skeTKZ7J9rH41Qs%3D" alt="5. 运行结果.png" loading="lazy"/></p>
<h2 data-id="heading-14">5. 总结</h2>
<p>写到这里，我们的 <code>my_printf</code> 已经跑通了。但说实话，这不到 100 行的代码本身并不重要，毕竟在实际应用中，我们永远会去用标准库那个经过千锤百炼的 <code>printf</code>。</p>
<p>而<strong>这个手写 <code>printf</code> 真正的价值，在于它是我们探索底层原理的一个引导。</strong></p>
<p>通过这几章的分析，我们收获的不是一个粗糙的打印函数，而是对 C 语言运行机制的深刻理解。</p>
<p>我们亲手证明了 <code>&lt;stdarg.h&gt;</code> 里那些看似高深的宏，剥去它光鲜亮丽的外壳后，不过是<strong>朴实无华的指针加减法</strong>。</p>
<p>我们深刻体会到了<strong>默认参数提升</strong>的存在。这不是书本上的死记硬背，而是为了让 CPU 跑得更快、内存对齐更方便而设计的硬件妥协。</p>
<p>我们还知道参数在内存里是挨着放的，拿到一个参数就能顺藤摸瓜拿到其他的参数。</p>
<p>好了，这篇文章到这里就结束了。最后我还想说两句私房话，我真心希望这篇文章能帮助到大家，如果大家觉得看完这篇文章有所收获的话，并且你自己也愿意的话，希望你能留下一个关注，我在这里先说一声感谢，后面我还会再发这种能帮助大家深入理解底层原理的文章。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Tanstack Router 文件命名速查表]]></title>    <link>https://juejin.cn/post/7585382553290457124</link>    <guid>https://juejin.cn/post/7585382553290457124</guid>    <pubDate>2025-12-20T05:24:22.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585382553290457124" data-draft-id="7585400495683797034" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Tanstack Router 文件命名速查表"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-12-20T05:24:22.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="皮蛋小精灵"/> <meta itemprop="url" content="https://juejin.cn/user/219558056559278"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Tanstack Router 文件命名速查表
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/219558056559278/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    皮蛋小精灵
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-20T05:24:22.000Z" title="Sat Dec 20 2025 05:24:22 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h4 data-id="heading-0">1. 基础与嵌套 (Basic Structure)</h4>








































<table><thead><tr><th><strong>符号 / 规则</strong></th><th><strong>作用</strong></th><th><strong>文件名示例</strong></th><th><strong>对应 URL / 效果</strong></th><th><strong>核心逻辑</strong></th></tr></thead><tbody><tr><td><strong><code>__root.tsx</code></strong></td><td><strong>根组件</strong></td><td><code>src/routes/__root.tsx</code></td><td><strong>全局</strong></td><td>整个应用的入口外壳 (HTML/Body)。</td></tr><tr><td><strong><code>.</code> (点)</strong></td><td><strong>嵌套层级</strong></td><td><code>blog.post.tsx</code></td><td><code>/blog/post</code></td><td>用点代替文件夹，扁平化写法。</td></tr><tr><td><strong><code>index</code></strong></td><td><strong>默认页</strong></td><td><code>posts.index.tsx</code></td><td><code>/posts</code></td><td>父级路径的“首页” (精确匹配时显示)。</td></tr><tr><td><strong><code>route.tsx</code></strong></td><td><strong>目录布局</strong></td><td><code>settings/route.tsx</code></td><td><code>/settings</code></td><td>等同于 <code>settings.tsx</code>，文件夹模式下的父级布局。</td></tr></tbody></table>
<h4 data-id="heading-1">2. 动态参数 (Dynamic Params)</h4>


























<table><thead><tr><th><strong>符号 / 规则</strong></th><th><strong>作用</strong></th><th><strong>文件名示例</strong></th><th><strong>对应 URL / 效果</strong></th><th><strong>核心逻辑</strong></th></tr></thead><tbody><tr><td><strong><code>$</code></strong></td><td><strong>变量/参数</strong></td><td><code>posts.$id.tsx</code></td><td><code>/posts/123</code><br/><br/>  <br/><br/><code>/posts/abc</code></td><td><code>$</code> 后的单词变为参数名 (如 <code>params.id</code>)。</td></tr><tr><td><strong><code>$</code> (单独)</strong></td><td><strong>通配符 (Splat)</strong></td><td><code>files.$.tsx</code></td><td><code>/files/a/b/c</code></td><td>贪婪匹配后面所有的路径片段。</td></tr></tbody></table>
<h4 data-id="heading-2">3. 布局与组织 (Layouts &amp; Organization)</h4>

































<table><thead><tr><th><strong>符号 / 规则</strong></th><th><strong>作用</strong></th><th><strong>文件名示例</strong></th><th><strong>对应 URL / 效果</strong></th><th><strong>核心逻辑</strong></th></tr></thead><tbody><tr><td><strong><code>_</code> (前缀)</strong></td><td><strong>无路径布局</strong></td><td><code>_auth.login.tsx</code></td><td><code>/login</code></td><td><strong>不</strong>影响 URL，只套用 <code>_auth.tsx</code> 的布局组件。</td></tr><tr><td><strong><code>(xxx)</code></strong></td><td><strong>路由组</strong></td><td><code>(app)/dashboard.tsx</code></td><td><code>/dashboard</code></td><td><strong>完全透明</strong>，仅用于文件夹分类 (如把管理端页面归类)。</td></tr><tr><td><strong><code>-</code> (前缀)</strong></td><td><strong>忽略文件</strong></td><td><code>-components/Nav.tsx</code></td><td>(无)</td><td><strong>不</strong>生成路由，可放组件、工具函数等。</td></tr></tbody></table>
<h4 data-id="heading-3">4. 特殊处理 (Advanced)</h4>


























<table><thead><tr><th><strong>符号 / 规则</strong></th><th><strong>作用</strong></th><th><strong>文件名示例</strong></th><th><strong>对应 URL / 效果</strong></th><th><strong>核心逻辑</strong></th></tr></thead><tbody><tr><td><strong><code>_</code> (后缀)</strong></td><td><strong>非嵌套路由</strong></td><td><code>posts_.$id.edit.tsx</code></td><td><code>/posts/123/edit</code></td><td><strong>逃离</strong>父级 <code>posts.tsx</code> 的布局，独立全屏渲染。</td></tr><tr><td><strong><code>[ ]</code></strong></td><td><strong>转义字符</strong></td><td><code>abc[.]def.tsx</code></td><td><code>/abc.def</code></td><td>强制保留文件名中的点，不被解析为嵌套。</td></tr></tbody></table>
<hr/>
<h3 data-id="heading-4">⚡️ 一眼看懂对比</h3>
<p>为了加深印象，这几个<strong>容易混淆</strong>的用法我单独列出来对比：</p>
<ul>
<li>
<p><strong><code>posts.tsx</code></strong> 🆚 <strong><code>posts/route.tsx</code></strong></p>
<ul>
<li>
<p><strong>效果一样</strong>：都定义 <code>/posts</code> 这个层级的布局（父级）。</p>
</li>
<li>
<p><strong>区别</strong>：前者是扁平文件，后者是目录文件。</p>
</li>
</ul>
</li>
<li>
<p><strong><code>posts/index.tsx</code></strong> 🆚 <strong><code>posts.tsx</code></strong></p>
<ul>
<li>
<p><strong><code>posts.tsx</code></strong>：是<strong>框</strong>（Layout），不管去 <code>/posts</code> 还是 <code>/posts/123</code> 都在。</p>
</li>
<li>
<p><strong><code>posts/index.tsx</code></strong>：是<strong>内容</strong>，只有访问 <code>/posts</code> 时才在框里显示。</p>
</li>
</ul>
</li>
<li>
<p><strong><code>_layout.a.tsx</code></strong> 🆚 <strong><code>layout.a.tsx</code></strong></p>
<ul>
<li>
<p><strong><code>_layout.a.tsx</code></strong> (前缀 <code>_</code>)：URL 是 <code>/a</code> (布局名隐身)。</p>
</li>
<li>
<p><strong><code>layout.a.tsx</code></strong> (无前缀)：URL 是 <code>/layout/a</code> (布局名是路径一部分)。</p>
</li>
</ul>
</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[鸿蒙开发：个人开发者如何使用华为账号登录]]></title>    <link>https://juejin.cn/post/7585382553290440740</link>    <guid>https://juejin.cn/post/7585382553290440740</guid>    <pubDate>2025-12-20T05:23:49.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585382553290440740" data-draft-id="7585382553290424356" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="鸿蒙开发：个人开发者如何使用华为账号登录"/> <meta itemprop="keywords" content="HarmonyOS,Android,iOS"/> <meta itemprop="datePublished" content="2025-12-20T05:23:49.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="程序员一鸣"/> <meta itemprop="url" content="https://juejin.cn/user/1398234520239095"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            鸿蒙开发：个人开发者如何使用华为账号登录
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1398234520239095/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    程序员一鸣
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-20T05:23:49.000Z" title="Sat Dec 20 2025 05:23:49 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden;color:#2b2b2b;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(159,219,252,.15) 3%,transparent 0),linear-gradient(1turn,rgba(159,219,252,.15) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin-top:35px;margin-bottom:10px;color:#4dd0e1}.markdown-body h1{font-size:30px;text-align:center;position:relative;width:max-content;margin:0 auto}.markdown-body h1:before{position:absolute;content:"";z-index:-1;top:-20px;height:100%;width:100px;left:0;right:0;margin:0 auto;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADsAAAA6CAYAAAAOeSEWAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsQAAA7EAZUrDhsAABkLSURBVGhDtZoHnJ1llcbP3Om9ZiYzmfSQhCQQIbRQVQKI9CYC68qKriJK0UXcZRcINqStIoiIqKCi1NACQihBWiCkkJ5MJlMyvd7p7d759v989/sy34yTbIj48Atz71ff855znvOc971xDrB/EtoGI7a9Z8Aq+wZML0mNj7dE95NZ1OKsj1dHo1GbnJpss9OTbWJyonvun4VP1Njuoagtb+m0it4By0iIt8LEeMvkr8XFWcfgkA1gYDLf47i2PzpsyU7UspKSLDoctagTZ7Vc08MzClMS7awJ2ZaflBB78CeET8TYla1dtrKt2w5KS7YCDGzEoz2RqKUmhGw6x2bhuXyOp2BoRXef1Q1E7Lj8TIsMD1sbxu1kcnYSAX1810RMTUmyMB7f2j1gC7NS7byinNiL/kH8Q8a+2NRh77b32El56VaPAe0YeGR2mh2bm+FdMRqP1rbZe+3dFsHT35qcb/Oz0rwzo7Gxs9feYPLS4kM2h8lawee5hPmlJXneFQeGAzJ2F564v7rFzi7Msu3d/Xgjzq5g8ArX8VCNN2vJ28daey0zZJabmGCLslP5HOf+Oygr3UzDGOf+JxrauXfQjslJt+dbuuyMgiwmk+sPAB/b2Lt2NdoMZnuY21qHIvbvUyZ4Z0ZQiXGrWjvsmPxsK4R0nmHA8ZCTQvxVQn5eRipklIBtcVbV1WtHYsjati47ZWKuTUpP9Z4yGk/xDBGe3v1mW4/dOrvYO7P/2G9jRSjf31FnXyaUXiB8r51WaJkM3kcfOSa2FR6qarIenooTLQHPLcC4mYThyw1tVpKWYlVERlZ8nC3Oz3Jzdn1nn5uvQ8OOHYvhR/CvsqffJbkCkZTvcYZ6Z0WTfTovw5Y1dtjXp+TbFPhgf7FfxpYxuMfr2uwo8rEtMmwXF+d6Z8wGmIR2PLyjo8cqOFffP2SLGexJEJCP9R29thkPXlpa4A5Y3w/jmuVNYYwO2QkY7WMtz3mVcE1hkualJdmSolzX8GnpKd4VZq80d1o7zN0RdWxGaqItgbn3B/+vsasgh/UMNBOvzYMZDxtDKp289KGaVguFQvb1yQWWwuB97GaSXqUUnVaYbSUwrDCEBz/C2CM8EhNrP13fbkeSh3OJgCAe2N1CWXKsGOc6TOr5U4q8MwYhDtkTda02MyPN+nnGBQEH7A37NHYz5KOZVv08qyjbSseEzKauPnsMj98wc6Ibcj5UUv7M8QWZTE52jEwGOVaD8U1Dw1YNWX0qM8VKyb80L/TrOPYOzH4KBJQTrK8M7+7KZjuM63sHBt17FubGoibCuf+tarWFGUmuwWeT8/vCXo1tZOYeZcazCaez8MwEzzM+HqhqtiJI5twxL1jeGLYk7jmKMF1JOCbg6Qj5nAdRqX7q3BYm8VAmQvW1lfcMc58IT95uIA3q+gftrDHPXUXJWkVEHJme5Bp5UmHsvIZ/O3l8ECE/FWcsItX2hr0ae8O2Wjs+J43QTbOZzGYQ/7Wtxq6eXjRK3r0By4YJ6Ty8EiYSJqcm2eGeV4Pox/ANENJR49RiEdfqcLflUJrEBZqgxYHrBjn2ExFURqKdVETN9YirJxKxR2rbrYeQv5ISmB6IsiDGNfZGWPeMgkzr58xnPaJ5p6XDZPKz4T77wayJ7jGhhXLwanOHTWBgq5n5q6YUwNJ7l3kKcRl7OJ7fF56l1GzvHbSD8dghTPi0wIRfv6XafjJ3ssv0PnZQ7nZx/etwzO1zJ3lHR2OETTw8x0tOx1AN3De0D7YV+63oGthjaJQ5Ur7eVVZjcdGInUyuaT73ZWg3efV8fZs7cc2E777Qi5eunVbghvPPymrt/krKGfcLd8ybYjdxrK6333Z09rjHZkNuLYzz0uIc+xWCZzz8nbHbe4dsY1e/XUOY+nimvtUaSazv4jXhaQasSbmYmpuenGwHZ8TKggSEQm08rMD7ahBOoExcMqXQegjnZ+CEvaEa1ZQUQkt39dj0zDS7krq+ARmpdws/nlNqD9WFbWN7l5u3wr9MyrcXKUsqWy3jTOaoML4DdaQ83YIoT4VYpEXvYQZLmbX5SLohBrgOj186Kc/iKTUPUhq+Rrm5ekOl3TWv1Mr6hqwbY0VOQXwEo+Moq4Z47q5qsU489G944LyJOW4LOLZOKtT/iI6+nGe/0dhuEd4ltj2NmiuCU4hnk5fHIi7+RK4uTEu0e+s7rAiRcw1CYy3OejvcYz+eXeI9MYY9nu3lYZl0KavJJ7Vjibzgjp319rUZE20j7CkJqFr5JQYgQ39f3eQaKpQk0afy8nl4uBzvjUUTRk7k3iebOm0pabDiyFn2XGu3dRME41CGVeBVqSiVnc6hIUpekp1VjHLDSOEcQlui5W/U8C7IKREjv1Gabw3wRwUTvpv7jybPtzHmIPZ49q6KRjuccqBQVCOtGvqXhrCFUUXJzOYSHt7Kw5Ix9H08dSje1o1JyL73IYXpEMmE5CRbw6wuykx2pR+Pd6/J4JpLiJKV6N9OnrcQNfQ0Zem6qQX2MmFXyWTE+DMO0kGx4e08DEjnXbsYuOq7niHB8jdY/wQ8Srm2XCZZUrOakF1CY5EKX0h93Tu/1J4kRdbDMT8MamgZK9xe3uDcvrPe++Y4f61rcZr7B53rN1c5N2ytcV5rCrvHt3T2Og19g+5nH7dvq3bqunr4NOwgK2MHA1jeEDuG7HNuLmtw7qpocl5t6nCPvdTQ7v4N4u3WTqeyu9cZHIo4f6lqdFoHh7wzMbzDeeGv3Hvzjlrnh2W1zofhHuftxpFn3VFe7zxS0+p0DlKVPbhhvBxhvwiFMgfP+mjHA08gEC4pybeLyK1iZldh8zC5VJQyUl8l59KZ0WJk2xaiYWxNrkXXJhA8r3PvZRur7ZZZRfadaRPsfiTmX9HGajC2tXd6V8dQTMhX0h8rNdJx9Ra8F8SbRNLzhPRnJmTZIUTYueTyWxyr7uv3rjC3OkzE8495oS+4xq6D5WoI0bO5WVCOSerl8rIeBrOI/Hkaw6ME5W1zSuzx2la3CRdWi3zIG+FDBvUp9LMgI/vggUmE7KkT81yGvOOgEYa/aUahhRAF5xLec3OzbF1r2O17BbVxIi7hzJIC64IYhXdJA+nh/5xVbOmE9J0QqjSxWk0pp37M2YEtgjS8GpimACu7xkqxdKJ6fEXyYl2Lre0ZtC8yELVewtWUnbfCPIhrvgDFz8WI5yhJKgcnFMZWEFrwhgzo5uWDDDA1oGSOzcu0xfx7vTlsv6posIMpJ6cGWPiw/BxL4PU7vbrpjgf8bMdu5OYwOdhm83DARUSa0ELknYIeEAaILuWxlhGa0M8+EuJCrpJT+ymENhN60pXBxa3LZ5TsucnlGaCmIEQ4Evru91yuz0xMtKaeXluI5zdh9Mm8vAlBn4aR07X64EH3vEKdXQkZJXPP/JxMvNRpLxEtHZ5RQgmNewnpouvVTpYTHdfOnmy5kFUGnpRTfEhXD9DiBdFFJB0/YWS9aj6pmc89r0BaQmgTRkgI+EsdKsYasJZOBF+QqTH474NK7LbyBvf7W+RgOxNyxfQY2/2hrp2+NkroxrzrQ55fSZkpJIa28znCgF6rb7H1hOSslATyvNflAh9pvHcX3lVE/Ya8FjTJIexa2Rq77nfU96unTnD7aME3+TAm6BFKYrPnqCNIqV5sq0ZGCiEV+Db+qWMQqpFgb5KPx48R6omeDl2EuP9DTYt9iGA/f1KBS1w/La+H4ktsSmLItvZHXLUkrCeflVtJ9DVVg1H7+sxiGvVM975rZpfabuqHVhuP5F1vewav5O8GamUe91yDanoYw47FWzC929O+DJnKA2opFY1Rjru5CE7kOcO0jJtQVUIynzuZEMeb+1CEOFXN8iFSGeRpCm1BTlJxVg49Azm819SO7Bu0axEbwn27GuxMck+TMQHDP8fn48gfDVIL4R8xKVPJ73MQBUIfA/Z54LMw5vmlE+w+VFo2A78X/SsyPA/RMD0z3e2qVLtfo7aeBslpMX0N0TEnLcUlKym1jyBFqSohmYntI5enBhYB9CY/2kNarhwJhNiMtRGyWnkQdKaCFyQwgydjyNUw4VchKxXv2/DoKdC+lkQbCX1NlKCGvJiBJkSGbCus6jfo4yGBNySgr+u7e20BCsxdVAcFlJ/tHd32+cIsNxSXUULUUx+dg/d47g7OPYFw2MxkSuyMwLHVTI6PBN6dS8Sppw45zHJSgDXV3aQzmz40Z6fDgBfiAXU0uZxby2zejee+j3eltoQMzhV6qSBogXwrEXDj7ElWxUQ8RrnSaoU0dxIsKaiMvMykXTu90NqJsGHP4z78SdLigUrLKat32nFwy/E07pfDFRdQ/7N5r57pQ1482uvWhMGhQcviGkVrKDUp0ToCxfhQal5n4Hs/g1jOgH4LWdwFOd1b1WzHET4vLZppv+Czjxo840OrDlG8jAJzv2tp5mLK1dsU/lfIOeWy5NxFxfl2BoYImlQtx9QF6mJRQKBsQYYuO2yaLYPBUXvu/VqYPxtHhNy7Y4hCkNLGPtKSklzCVKSHtMQxcqm5Kw1DhI2PTGZtcGDAvoLQ/u7MifYtWFBlxz2H9zo8RkwKzC5UYiG+p44ccqE62YAxLeT/TOpf8MXx8Qk0IJFRY1Go+viQVJpE5Ehjf49xfAZeqGIy/7us3nqxwQfCkjZypPxobVr/6YpQHIalUvuCyEwbSXC9PC8QnkFcXlrgLpoLIhIfKuaqlQkYIAwQnr/f3eyu7KttOw2lNpv8/BPHyjzVNER3o72gvEBKqRMTflndbP8BMweRDyeciEj5bFayFXqTLzheivgYJC0jwzwHa0MDDEotm48ndze5BBBElAnxxcRYHAFh3FfZaA9UNRmC354kNwUx8eHkmVj5dcTE5ZMnuEyr1QqlhtaJLuOYZv4v3KNo0TKrGPUZ1NILPKuWcvVn5Trv10SMB6h0j/ARMnlOuafCBIfnSWEx/Raif3HDzofYMM31dOyY9LBaLK3TjoX2fEqT4+2qaUVWSTQvyM6wC8nNJyEetXIyuLKrx04P7MKNnbJZlKUtNAIHo7i2dA/YU3Vtdi5l6jCepXy8hOedSSSsI8/HQg5Q+gxTKXwkMHkbESo+hjG0lbRRzQ3Fc5LOzDuFhs3Ptumpie7ilRDhlEJOq/hjsZljCxjkt7fWuPS/EekpXMggJQIk0G+eN9Xu2VmHWIkJe0nJRN4ptBBit2yutG9ML7J1DHAxebiAMrZ4VZlduqGS8I2tJc2iborUxmIN79c+kTovFxivPvrcSaP3n7RSKYTUmKt4N3rMOcw4JOneD3sP956jNaMglIeTER5Xbdlt15Tm2W10NEsYrA/N5JLCHHsR9tSqwxq08G3bqm1ZTbOtagnbo6SLvH/VzBL7W7jPzqFea0LmMLFzUuLtdwumuO3i1Vtq7OK15Xgw3l1PDmIXak+6QBEkvB9YJIzBcc/L20JIYaSZ/qAzVm5Ut4oowk3QehC+N3xo/1wTqt7zsYawfX9no9XjqdPXVLhrwyo/wucJYQkE1e4j8rLcBuHUItQQKqgMXb6LGvxFQlXw33AdZLR0V5P9Fr29lP73scNnosoyvdWPv4fPJ+uJrLVtMakqaL1M1cTvv0OLIZE6wk2a2IcIRUQh+DaejpdcXepBa7bKDRGM9PIVxTl2EwarZ72rooVuY4RQtMypdk6e1lLLehhY2lt7QEd7WxlCDvdIli6E9B4+ZIodmZEMccUGqgiZOqru9tkR3iJ8nCcXRWRZCSPMLPEjlx2LjQL1OM5qKAm+vhSuRqSfV5Ttrg8FdWcrnhMqCTex7DEM6qTsVEuM1+8hovaHQ6e6a1Fz0xLd3nUt4ToWWuzWNkhcoAIIjUx2ZpxjLzWF9+SYmngR1lok4TEoJxGfuijhI/7OICoFmadl2llcL9b1oRVJtbD+JLlv1KrhHG5811t9ELbzgk14ICUwqE+TDzftqHPz98vUSy3jSIwP8dCpkNqLDPTx+rArz4T5qLG3G2PrvJKKPoLBWE501NC3ilUX5mVjVIb9nIbgWcpPMiSXjbcL8K62UkR86m1/yfkSeMaHFuK04X0CE3J6SWzFUxw0BSNHlSzi3RmIRJwHq5udO3c16quLp6sbnffbupxbt+12vzOrzuvNHc7ycRbIxuJHgYU7YSASdQgxp7qz2ynv6HJeqW91doa7nLruXof+17sqhhu31Xif9o7HalqczV29Dnrb/f5EXZvzdH27U98/6LR5i3N0UM5zjHU71/lwjRWWltU5CAIn7F1MqLp/r9hQ5RoaxG+qmrxP4yNKcfsFLwuiprffeb2l03m2scO5h3Or2rudzjGrhk8x4Cqu2xcexilBvNEcdi5Yu4tKF3Ue4tzPy+td5/1md4tzw5iJ27NuXEYobYUdlb8z6GTWkdxaCvk2zHjd5mpKQ459mv5TkAp6mQb9Aq9HHQ8S6mrZnuc6vUG6WHusIhCJGNXl9byvnJyaiE7+Eoz8c5TYNQiUveENGpJpcIJ+biS8R0+rlcazGNs7pKB+zPLTOSX2KNWhlDAf4r2Spj72JORB5OyHULX+dlD/FOky/HFy5ygYU0sey/i8moeqdunXK1qC3RuaMOYHlI/raQMl3M+EeTV5WxD3Km8a8PkM8nr648sQ9+esKbf5e/nxiKBfAOQkxbv3SU9LYmqPV9V/Pn+V20VwTyVjTqCI6edEQUOFUXs9WmfSll8DyX2dt7GlnwkswaM3l9XZ0oNK3MTXbxpOV2sGk69s6XCJw4cY8KbyRrt9TrHt7Bm0rRBQe1+fHUWNfaapU0KbqxzbORC1M/LS3dJwIl3KOrwykQG/E+61q+isgniztdOKqNOziDgZqZIzFwPvqGiyg5NCtoCqoG5NxHhPZTOsnORulKskjoKMDeLuXQ3OmnC3syxARFXdfc57LR3OrdtrvSOOs55rnqhtcdoGhpxHdjc5EfJUuHZTlftX+G15rXPlhkrnLe59F7Lz8VGHdg8c5y2OLeMZ126qduq9XC3v7nd+FchLvYPJd15gPCu8XQnh/qpm59WGVudZzvvQO97kXTcGxhnEuJvR39tWY8cwK4uhcikk4a3Gdstg9l5B2t0wfaTdWkEou5vCPOV5PH73vFL3+DfXltnh6OxjkJD6Wd5F3g88tMe6CW/7YmI99VIL4u0oqUK8ocW4d8hFrXMVoOQU8s3U97MnjvDD/XRYkyhHM1MT3GVZQR2Tdv70U8EbA5vlo+CaPAaaSWoZXm50otGodxQ6L6txGKxzw5ZYORrBsPPrykZKQIy1n8bTjwb2fO4Te3ue7x6KOKvaYns1wtIddd4nx3mwot55qyl2360cp81zurg+CGqwU8v4/Of5uAVvPgObrwvHomY8jOtZ4fXWLnefdHVXv9044+8ZklCx75DXwcV1Sb27y+vInUQEuVYSaMgRJYfAwtoj0raFxIUW1A8nz35f02qLc9Lc9lG7CBkwtUR7bf+A+5uL6ehnH9Lat+5sIEfj3Cbj3NKRvP7Rjlo7FSmqavKvpSP8MRZ7NVbQYLSkqlC9ZW4sPH18gBTcORjrhMWmQWzFmK2UsvO90qQ1oZcI8UhkCLZPtRqMy0NirobAvjIpb4/sW06qKGyPR2oGIdlazjOOTk+kLYzaaYGSp63Wz6HsXsQ51wd+LTAuZOy+8GBNq7tF+IOdDU4kENJthNID5YRafZtzZ3mDs9LbRgzixcZ2l1h83OKFbDmEd0/FiFp7DWHgp0AQGzq6nf8hPF+oa3EehOz0ziCWcm4NpBRMhX1hn571oR9wqVVSDVPtUi32sQ0vbu7scZdY9aOt2ZSEL9BEBIW+dv20AKDd9/ep09oimYqHpyImkKDuRllS4PrlHNuIqDmCJmNJQba7q1joEaUQJuR/WdXsLrJrq/L6cdJsPOyXscJ7GLKqo8cOpqhrO//yQG6oS3kZwS9xPkRB3wi7diFMtDN+PLk5m1ath+8f0Fy80dbjhvVXub+U5mEqeal27UP+dWpPlknNxW79Ak6/7Tg3UMOF52j1xA1qK7Trd6nXC+8P9ttYQcumIonLSnJtBdJNa77axw1C2x3qR4Wqnj73x9f6MbV+CCYFBZO6y51aSh3gzVrsmwzJnULEbCJC1oZ7vIZ/9Iqmfvn2u5oWO5n8fApxcuWUApum5diPgY9lrA9EtvUNOzYf8vqAcJPsU5iOh7XtXQgt2uZhjKU2amF7HQyfEYWcZk5yQ1RDKNrLcq02k/9IGmldrB93KiokPw8EB2SsoKWXO5FmxXhlckqi+3vEUvLqwok5PHVkIWAszlqzy1p54zuLpnPZ3q9bod08JlLSb5DrNxDm38Sbvsg5EBywsT7oH+3XNW3uasGirFSrxRNdCllKiPZHZzJYLZb5qEcpae3pxMCuu9oibS5/QCOiLcYUrp+MmtJeURjFdVlxzqiae6D4h40NQt54HyGv3JRo10aVfv8YhtC0pSlVKcPFuxIXahr08mzCO4VzMlLSsZuomZ+RaucU0rXsw/sfF5+osUFonWob/7TrLdaUgdpV93fl9X+VIC0Y6tek2uI8OD3J5gT2Vj9ZmP0f4IM4iY7RQ5gAAAAASUVORK5CYII=) no-repeat 50%;background-size:64px 64px;opacity:.84}.markdown-body h1:after{position:absolute;content:"";width:150%;left:-25%;height:50%;bottom:12px;border-radius:50%;background:linear-gradient(transparent 80%,rgba(77,208,225,.8));background-size:400% 200%;opacity:.6;animation:h1Animate 6s linear infinite}@keyframes h1Animate{0%{background-position:100% 100%}50%{background-position:100% 50%}to{background-position:100% 100%}}.markdown-body h2{display:block;border-bottom:4px solid #4dd0e1;position:relative;font-size:24px;padding:12px 32px;margin:30px 0}.markdown-body h2:before{width:24px;height:24px;left:0;top:0;margin:auto;background-size:24px 24px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAADGklEQVRYR81X32vTYBQ999s6mFjQgQ+DrbHiVFZYU4cDcQ/6pGhTFVYFEXGi82H+Bz448UnEF1Fx9ccEEcXpZE3d5tP2ooKiTacTHaLNpigMHDgnU9tcSbrWrkwWR0sbyEOSe885ObnfvV8IRT6oyPwoLQHBx+OVM5WJvSyEVAhnBOjt7yU/+/rr6r6l8TMO+F/EN0JQhICqQpD/xaRpcpAc9tS+M+9lBCia/oqBamK+zeDuQogQZaKJk3wcQjxSva7tGQGB2Ke1zIk3DNyMyNL+QpCnMQOaPsDAVuGAp9cjvbYc8Ec/bCYSg0zoiHilk1tHxqsqEsYlML4kjIpT/eurJxRNPweQU5VdrWaOEo1fgKAVbBgXIz73kF3R/ph+ghgdzMYWM29eAWlBJqgZaFlFYtC6nhWpaDqnSGlIlV1WjJ3DloDNgyNLncudqgX//Ucg3LxuStHGuhi8pqKCW3rqV342rwFjRznKm+/LNaN2yC237ThgF2wxcfMLeP6+ncrKzoPoKTGeLQbYbg4TNoC5iZPJY5HGVRdSNZAWYBclD3FzBQzrR8hACAKdzBzKA/4/IYioDQaOskBbpEG6PO8qKKSAEi3CnEb0Pw4oMf0OmKbTDWqh3Lw6EIiNBZi5lxh3wz4puBD5ovqAMvxhHSdFKxE1CQe3m/07TeTX4lcJdAhE+1Sv65Z5P/ByvIGTRowIZ9igbtXnmrOsbTvgj+kHBNMuBu9OdVw8EeU4nC1A0cYmAHZOTRrLhra4Z8ywnSN6vZHAFTA2WnnMfQB3qz73ddsOZM8CACFDIPSgQXqebXEgqgeZcAeEe6pXasm1f8ew3igMtAHWac0Uc/jYdyAaP0xEBwFsmgUPqbJ0NE2UKj4EGcahiOzuyhagaHpnmtgcVgTcCMuua7YdyAHbA3ArQNscVFbb4635aD6fnYaTvxxi9UNP7ddMXaRWVBdAcaLk6bDXPZCNZ9uBXEsDUX1T2Cc9yjig6Z0EHg3LK8/aqf6MwJKchkXfks1+0+JtSq3qLPa23BRR1B+T/6nkfMaW1r9hPt/MLtYfTLEpP+T9FNoAAAAASUVORK5CYII=)}.markdown-body h2:after,.markdown-body h2:before{content:"";display:block;position:absolute;bottom:0}.markdown-body h2:after{right:0;width:400px;height:10px;border-top-right-radius:24px;background:linear-gradient(90deg,#fff,#4dd0e1);max-width:50vw}.markdown-body h3{margin:30px 0;font-size:18px;position:relative;padding:4px 32px;width:max-content}.markdown-body h3:before{border-bottom:2px solid #4dd0e1;width:100%;content:"";display:block;height:28px;position:absolute;left:0;top:0;bottom:-2px;margin:auto;background-size:28px 28px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABRklEQVRYR2NkGGDAOMD2M4w6YDQERkNg+ITAppcfY/8zMv3wF+NdTUrZQpUQ2PT6cz8Dw/8CkMWMDIwNvqK8jcQ6gmIHNN19EaXPx1XPyMCghrCUKcpPlGc5MY6gyAE+Fx52MjL8j3cU5a1UYWXtZGBkEAVb+p8hxU+Mby5NHQCxnKEMaskzJ37uFmUetkmMjAzrfUX4woixHBJlZAA0y2EmPPYU4enLkhGeQIqRJDsAh+UgO7duNpD3IcVykkOA2paT5ABaWE60A2hlOdEO8D3/4CMDIyMfWvySFefoaYSoROh74eFXBgYGLiTNVLGc+BC48PAnAwMDG9QBVLOcaAd8P5ox+x/jf5AjGLgYfnwnKqv9/8/PwPO/kFF/MSj0cAKiouD/0bgYoixFU8RovWgJIX1EOYCQIZTIjzpgNARGQ2DAQwAAvHBaIdB7zxsAAAAASUVORK5CYII=);background-repeat:no-repeat;animation:h3AnimationBefore 2s infinite alternate}@keyframes h3AnimationBefore{0%{width:28px}25%{width:100%}50%{width:100%}to{width:100%}}.markdown-body h3:after{content:"";display:block;width:28px;height:28px;position:absolute;border:2px solid #4dd0e1;border-radius:50%;right:-15px;top:0;bottom:0;margin:auto;background-size:28px 28px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABRklEQVRYR2NkGGDAOMD2M4w6YDQERkNg+ITAppcfY/8zMv3wF+NdTUrZQpUQ2PT6cz8Dw/8CkMWMDIwNvqK8jcQ6gmIHNN19EaXPx1XPyMCghrCUKcpPlGc5MY6gyAE+Fx52MjL8j3cU5a1UYWXtZGBkEAVb+p8hxU+Mby5NHQCxnKEMaskzJ37uFmUetkmMjAzrfUX4woixHBJlZAA0y2EmPPYU4enLkhGeQIqRJDsAh+UgO7duNpD3IcVykkOA2paT5ABaWE60A2hlOdEO8D3/4CMDIyMfWvySFefoaYSoROh74eFXBgYGLiTNVLGc+BC48PAnAwMDG9QBVLOcaAd8P5ox+x/jf5AjGLgYfnwnKqv9/8/PwPO/kFF/MSj0cAKiouD/0bgYoixFU8RovWgJIX1EOYCQIZTIjzpgNARGQ2DAQwAAvHBaIdB7zxsAAAAASUVORK5CYII=);animation:h3AnimationAfter 2s infinite alternate}@keyframes h3AnimationAfter{0%{transform:rotate(0)}10%{transform:rotate(0)}50%{transform:rotate(-1turn)}to{transform:rotate(-1turn)}}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:15px}.markdown-body h6{margin-top:5px}.markdown-body p{line-height:inherit;margin:22px 0;letter-spacing:2px;font-size:14px;word-spacing:2px}.markdown-body img{max-width:80%;border-radius:6px;display:block;margin:20px auto!important;object-fit:contain;box-shadow:0 0 16px hsla(0,0%,43.1%,.45)}.markdown-body figcaption{display:block;font-size:13px;color:#2b2b2b}.markdown-body figcaption:before{content:"";background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgBAMAAACBVGfHAAAAGFBMVEVHcExAuPtAuPpAuPtAuPpAuPtAvPxAuPokzOX5AAAAB3RSTlMAkDLqNegkoiUM7wAAAGBJREFUKM9jYBhcgMkBTUDVBE1BeDGqEtXychNUBeXlKEqACsrLQxB8lnCQQClCiWt5OYoSiAIkJVAF5eVBqAqAShTAAs7l5ShKWMwRAmAlSArASpAVgJUkCqIAscESHwCVVjMBK9JnbQAAAABJRU5ErkJggg==);display:inline-block;width:18px;height:18px;background-size:18px;background-repeat:no-repeat;background-position:50%;margin-right:5px;margin-bottom:-5px}.markdown-body hr{border:none;border-top:1px solid #4dd0e1;margin-top:32px;margin-bottom:32px}.markdown-body del{color:#4dd0e1}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:rgba(77,208,225,.08);color:#26c6da;padding:.195em .4em}.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace;overflow:auto;position:relative;line-height:1.75;box-shadow:0 0 8px hsla(0,0%,43.1%,.45);border-radius:4px;margin:16px}.markdown-body pre:before{content:"";display:block;height:30px;width:100%;margin-bottom:-7px;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAAAdCAYAAABcz8ldAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAhgSURBVGhD7Zp7bBTHHcdn33t7vvOdzy+ITVKDU0xIKG2ABCPTRCCaUiEVKWoqRJuASAhCitRCVKSoalFUKZBiSmmFRRJKRUnUtIpo+aNqGgwoOCmuFUIRzxjwE4zte+97drYzztji8HPvtkit/PnH+n1397Tz+83vN/PbMZhmmmmm+d+BoX8n5diihcGqgFQf5vk6BMAskWUlw3GyFnIvtqWSf91w7mKC3npfOLX7wYeiIa6BBWCOLLFRF2NB0JvIOP/80YG+k2ev6S699b/OzOfKBW5l5KsgyC4DCFQDnpEAdE1goc/dlNPc/Up7P711UiYNSMuyxeUzZPnHgGHWh5XADEkSAcdiN+AnEXIBhBComgFU0/xQR+jnj51sOUMf9Z0NKyL8S9+JPBEN8zuCMrsqGOA5QWAAyzLAxe53HBeYFgJp1c5Cx33nyIfpV3e+22/Sx32nev/sMCgVnmM4bjOniAtZWQAsz315EfsGQQc4hgWcjHkCmOj1rheuNn95cXwmDMiVp5etC/D8m5FwUWVQUYYGPh6mZYFUOgsGVa1pXvOZzVT2jRuH54RM230jEuI3RcIiL4l4UkxAJmuD/riVsqD7ct2m9nep7BtVTbVfZ0uE/UIk+CQflAHDjf8+Lg6MldYATGpH3c/Ul7p3dWXppVGM6eElJSHmnQWPbSlRlN1lJcUBjqNRnwJZVQO3B5P/uq5rK1d90pakckFcaKp5UJHY92JR8YlwkUDVySEZfGfQdO7E7Z8s2HL9TSoXTPXRud9nA8IBqSwcZgWeqpPj6BYw7yTbXBN9q2v9lQEq5zBmWA8vWLCptCi4tzwW8RQMQlFQATPLSh6vCSh/plJBkMyQBHZfWYnkKRgEktEVpTJXERN2Xzo4ex2VC6K6qXYpF5b3ypVRT8EgcAERSJXRbwCBOTFzXblM5RxGBaRt+ZPYA+LO0mgxz5K1Ig+UgAzKIuGnz39z6S+olDeaibaXRsU1RUFvgx+GwTWgPCaDgMw2XXpr9gwq50XV0bkxJiYeEiNF5cwE5XsiOEkAUkXkUW51SSOVchjl8WKef604XFSRbzCGCYeCoESStv/p8QU1VPIM3knNDynctnBRfsEYhgSlNCIGgQv2UCkvGIHZgteMh1nBW9W4F16RAM6yDVV7amZTaYQcr59cuuhhWRTWBvAMLxQGeyFSHOLnh0MvUskz5RF+fbRYDEy0mZgqQYUHOLhr//b6rGoqeaLqQG0pw3PrBbyA+4EQUkRmhvgqNUfICUipKK4OKUqIJVPKB0jpEhjmWWp64jdbKmVZZNYogcJm493gsifOqhDyeh9GYR/FM7sW+DA5CKR0MSK3tvKZkpwB5gRE4tjFEr7RL0iWBGV51vHFCyupNGWWPqLgnoer9mtyEGSJAzwLllDTGzyznDjRN/CwOFkoFb4bm0eVIXICgpvdGoEvrF7fC89zfLkkeV5HbOhWiTwTpKYvCAJLGshRdXtKMKAWlyxq+MPQLk1h66g5RE5ABJYNFrqY3wvJklJRUKg5ZWLFXIA86yek2uDOPkBNb3CM5Pf7DL2QyIrUGiLH+xC5Bmmm/ARnHUhC6PnzxWDK0RH5HuIjZGy27erU9AZ0dTIWXyG+NpBBrSFySxZw220IqeUPFoS6jVAPNadM7yDsgNB1qOkLuAziMYIb1PQGA75wIaKGPyAb+9oF16g5RE5ALIQ+tSyLWoWDEAK6aXW3JlK9VJoyx1oyvVkNdvo5KXXDAVkdnaKmNwx0xjH98w3JNmTCm+Bc9hKVhsgJSI9pvp9Vdd++jmq6AXB2/HHrhcs5aTkVDv0DFzoHvKdq/mQsKX/4t7KJLDpOJW+IbAvMGoMkxfwAWZB8DT7W1diTE+WcgKz6pK1bs6z3daPwmJDsSKt6ZsCyjlLJMz0DsDGZ8SdlDROBjOb8YeWOjptU8kTXusuaazu7oJrfEnQvdkpVcUn6PTVHyAkIIW7br/Unklni0EJIZ1WgGsauZR+fvUglz6zY0dGfVp09ybRNlfwgi3k8YSbvJJ29VMoLt9v6rZVQL7hOYUubndHJGclBtzn1byqNMCogi09/2nFb01/oj+f/5TyjauBOKtPcZ1r7qZQ3f2lRfxZPWi2anp8TSDAGExZMa2jr8u03L1M5L7q3Xc+iAeuHRl/ScvPcjSLDBnZS/cjtNHd2v3171Ewbs9N5q7Pn4otVMx3btBsCsoRbk1FxG5dMVgMDqfTpXl1/tuFMa5zKefPROdX59qLQBwLnNog8Wy1OcjB1N+QEsW/QsFNZuO35Xb1v98QLX4/Sx+O3wqujrQ6013ABUWI8+AaqBjAH01+ghL22+5X2PirnMG7r+esbnae/V1neauvGSoHjigTcVU7UGFm2DeK4ttxKpQ+mLPvl+o/PjnkAkw9HTqSMmVHhyAMx9iFcSh/BHTfLceO/C8mKjApBf9zszGhoY92m9sN+BGOY9AeD7eGniv8OTaOB4dgyTsQd9wS+IQu4lciYdkI7CLrNH3Rvbb9FL41i0tbzVP2iWJkobpN5fmM4IJfJskTP1Bk8A9HQmbpmGDBrWqdVCN/Yd7PjxKGOXn+bmbto3feVVcVB9qehIL8EJy8nChwgr0O2xxBnhGU5eP2CfYbl/m4gBRsbtneMORP9oGpjpcCsiKzHHfdOPiQ/wMniyFEu2dbiTQCAeN/vavC466BGYLttXc9fmXBXMGlAhiHHur+sq6uPiUI9z7CVHMPwBnLSuuN8FuC48/Oaz1ylt94XfrW5ouyprwWfYRkwNyCyYYjwkBHows1fa+tV/fzGxlv39b9gqvfPmQ+i/HK8KlcBjhHwfl8HEHyOd1JnuzZd66S3TTPNNNP8/wDAfwDG7G0m9LKBpwAAAABJRU5ErkJggg==) 10px 10px no-repeat;background-size:40px}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{color:#4dd0e1;border-bottom:1px solid #4dd0e1;font-weight:400;text-decoration:none;margin:0 4px}.markdown-body a:active,.markdown-body a:hover{background-color:rgba(77,208,225,.1)}.markdown-body strong{color:#26c6da}.markdown-body strong:before{content:"「"}.markdown-body strong:after{content:"」"}.markdown-body em{font-style:normal;color:#4dd0e1;font-weight:700}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:rgba(77,208,225,.05)}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{margin:2em 0;padding:24px 32px;border-left:4px solid #26c6da;background:rgba(77,208,225,.15);position:relative}.markdown-body blockquote:before{content:"❝";top:8px;left:8px;color:#4dd0e1;font-size:30px;line-height:1;font-weight:700;position:absolute;opacity:.7}.markdown-body blockquote:after{content:"❞";font-size:30px;position:absolute;right:8px;bottom:0;color:#4dd0e1;opacity:.7}.markdown-body blockquote p{color:#595959;line-height:2}.markdown-body ol,.markdown-body ul{color:#595959;padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="a11y-dark">.hljs-comment,.hljs-quote{color:#d4d0ab}.hljs-deletion,.hljs-name,.hljs-regexp,.hljs-selector-class,.hljs-selector-id,.hljs-tag,.hljs-template-variable,.hljs-variable{color:#ffa07a}.hljs-built_in,.hljs-builtin-name,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-type{color:#f5ab35}.hljs-attribute{color:gold}.hljs-addition,.hljs-bullet,.hljs-string,.hljs-symbol{color:#abe338}.hljs-section,.hljs-title{color:#00e0e0}.hljs-keyword,.hljs-selector-tag{color:#dcc6e0}.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#2b2b2b;color:#f8f8f2}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}@media screen and (-ms-high-contrast:active){.hljs-addition,.hljs-attribute,.hljs-built_in,.hljs-builtin-name,.hljs-bullet,.hljs-comment,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-quote,.hljs-string,.hljs-symbol,.hljs-type{color:highlight}.hljs-keyword,.hljs-selector-tag{font-weight:700}}</style><h2 data-id="heading-0">前言</h2>
<p>最近上架的两款应用都增加了华为账号登录，可以说，极大方便了用户登录操作，也降低了自身的业务复杂度，因为不在考虑注册，找回密码等业务，只依赖华为账号即可，所以，开发起来，效率上就提高了很多。</p>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d1b7f573948f4e95a875c8d7cbc09737~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY5LiA6bij:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766813029&amp;x-signature=xH6TU9LB91NCEmV7J8q8aAkosmo%3D" alt="" width="50%" loading="lazy"/></p>
<p>可能有的同学会有疑问，为什么是华为账号登录，而不是华为账号一键登录，这里需要解释的是，目前华为账号一键登录不支持个人开发者，所以，没办法，只能用官方推荐的华为账号或者静默登录。</p>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1ab3ec29674048eba04c5f77826919b1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY5LiA6bij:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766813029&amp;x-signature=JzBwA92VkTQhNqcgEumYAgUE2QI%3D" alt="" width="50%" loading="lazy"/></p>
<p>需要说明的是，如果你的业务中，存在和用户交互的功能，建议使用，如果只是简单的单机应用，并没有和用户直接操作相关的，建议不使用，因为，没必要。</p>
<h2 data-id="heading-1">开发前提</h2>
<p>华为账号有一个开发前提，无论你是正式还是测试，一定要在 AppGallery Connect后台配置自己的公钥指纹，否则点击是报错的，公钥指纹，就是你所创建的发布证书或者测试证书。</p>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2892dee7867f4a2685af870fba0b6bd9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY5LiA6bij:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766813029&amp;x-signature=hRYaLw4A2EC7%2Faa72ggnEwdKRmo%3D" alt="" width="50%" loading="lazy"/></p>
<h3 data-id="heading-2">确认是否需要配置Client ID</h3>
<p>如果在项目配置中，看到Client ID和APP ID相同，则无需配置Client ID，否则需要按下一步配置Client ID。</p>
<p>在工程中<strong>entry</strong>模块的module.json5文件中，新增metadata，配置name为client_id，value为上一步获取的Client ID的值，如下所示：</p>
<pre><code class="hljs language-TypeScript" lang="TypeScript"><span class="hljs-string">"module"</span>: {
  <span class="hljs-string">"name"</span>: <span class="hljs-string">"&lt;name&gt;"</span>,
  <span class="hljs-string">"type"</span>: <span class="hljs-string">"entry"</span>,
  <span class="hljs-string">"description"</span>: <span class="hljs-string">"&lt;description&gt;"</span>,
  <span class="hljs-string">"mainElement"</span>: <span class="hljs-string">"&lt;mainElement&gt;"</span>,
  <span class="hljs-string">"deviceTypes"</span>: [],
  <span class="hljs-string">"pages"</span>: <span class="hljs-string">"&lt;pages&gt;"</span>,
  <span class="hljs-string">"abilities"</span>: [],
  <span class="hljs-string">"metadata"</span>: [ <span class="hljs-comment">// 配置信息如下</span>
    {
      <span class="hljs-string">"name"</span>: <span class="hljs-string">"client_id"</span>,
      <span class="hljs-string">"value"</span>: <span class="hljs-string">"xxxxx"</span> <span class="hljs-comment">// 将上一步获取到的Client ID赋值给value，请注意不要使用其他方式设置value值</span>
    }
  ]
 }
</code></pre>
<h2 data-id="heading-3">华为账号登录</h2>
<p>华为账号登录，有两种方式，一种是使用官方提供的登录按钮，一种是自己定义的按钮，无论哪种方式，都必须要遵循官方的设计规范；华为账号登录按钮包含文本、标志和文本、标志三种样式，以满足应用对界面风格一致性和灵活性的要求。</p>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c05f95ed742641eba6ae25a5476d7f4d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY5LiA6bij:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766813029&amp;x-signature=%2FKWihRaEt2%2FfHucReC%2F77pgMwTE%3D" alt="" width="50%" loading="lazy"/></p>
<h3 data-id="heading-4">使用官方按钮</h3>
<p>使用官方的组件比较简单，直接使用即可。</p>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9d3b0b1e962a41fd8af4b50b87291404~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY5LiA6bij:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766813029&amp;x-signature=UhgoTAdOPwKDiyHUyyc%2ByT%2Fqaz4%3D" alt="" width="50%" loading="lazy"/></p>
<h3 data-id="heading-5">完整案例</h3>
<p>完全是官方的案例，没什么好说的，具体的组件摆放，自己设置即可。</p>
<pre><code class="hljs language-TypeScript" lang="TypeScript"><span class="hljs-keyword">import</span> { loginComponentManager, <span class="hljs-title class_">LoginWithHuaweiIDButton</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.AccountKit'</span>;
<span class="hljs-keyword">import</span> hilog <span class="hljs-keyword">from</span> <span class="hljs-string">'@ohos.hilog'</span>;

<span class="hljs-meta">@Entry</span>
<span class="hljs-meta">@Component</span>
struct <span class="hljs-title class_">Index</span> {
  <span class="hljs-comment">// 构造LoginWithHuaweiIDButton组件的控制器</span>
  <span class="hljs-attr">controller</span>: loginComponentManager.<span class="hljs-property">LoginWithHuaweiIDButtonController</span> =
    <span class="hljs-keyword">new</span> loginComponentManager.<span class="hljs-title class_">LoginWithHuaweiIDButtonController</span>()
      .<span class="hljs-title function_">onClickLoginWithHuaweiIDButton</span>(<span class="hljs-function">(<span class="hljs-params">error: BusinessError&lt;<span class="hljs-built_in">void</span>&gt;,
        response: loginComponentManager.HuaweiIDCredential</span>) =&gt;</span> {
        <span class="hljs-keyword">if</span> (error) {
          <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">dealAllError</span>(error);
          <span class="hljs-keyword">return</span>;
        }

        <span class="hljs-keyword">if</span> (response) {
          hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">'Succeeded in getting response.'</span>);
          <span class="hljs-keyword">const</span> authCode = response.<span class="hljs-property">authorizationCode</span>;
          <span class="hljs-comment">// 开发者处理authCode</span>
        }
      });

  <span class="hljs-comment">// 错误处理</span>
  <span class="hljs-title function_">dealAllError</span>(<span class="hljs-attr">error</span>: <span class="hljs-title class_">BusinessError</span>&lt;<span class="hljs-built_in">void</span>&gt;): <span class="hljs-built_in">void</span> {
    hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>,
      <span class="hljs-string">`Failed to login, errorCode is <span class="hljs-subst">${error.code}</span>, errorMessage is <span class="hljs-subst">${error.message}</span>`</span>);
    <span class="hljs-comment">// 在应用登录涉及UI交互场景下，建议按照如下错误码指导提示用户</span>
    <span class="hljs-keyword">if</span> (error.<span class="hljs-property">code</span> === <span class="hljs-title class_">ErrorCode</span>.<span class="hljs-property">ERROR_CODE_LOGIN_OUT</span>) {
      <span class="hljs-comment">// 用户未登录华为账号，请登录华为账号并重试或者尝试使用其他方式登录</span>
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (error.<span class="hljs-property">code</span> === <span class="hljs-title class_">ErrorCode</span>.<span class="hljs-property">ERROR_CODE_NETWORK_ERROR</span>) {
      <span class="hljs-comment">// 网络异常，请检查当前网络状态并重试或者尝试使用其他方式登录</span>
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (error.<span class="hljs-property">code</span> === <span class="hljs-title class_">ErrorCode</span>.<span class="hljs-property">ERROR_CODE_INTERNAL_ERROR</span>) {
      <span class="hljs-comment">// 登录失败，请尝试使用其他方式登录</span>
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (error.<span class="hljs-property">code</span> === <span class="hljs-title class_">ErrorCode</span>.<span class="hljs-property">ERROR_CODE_USER_CANCEL</span>) {
      <span class="hljs-comment">// 用户取消授权</span>
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (error.<span class="hljs-property">code</span> === <span class="hljs-title class_">ErrorCode</span>.<span class="hljs-property">ERROR_CODE_SYSTEM_SERVICE</span>) {
      <span class="hljs-comment">// 系统服务异常，请稍后重试或者尝试使用其他方式登录</span>
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (error.<span class="hljs-property">code</span> === <span class="hljs-title class_">ErrorCode</span>.<span class="hljs-property">ERROR_CODE_REQUEST_REFUSE</span>) {
      <span class="hljs-comment">// 重复请求，应用无需处理</span>
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (error.<span class="hljs-property">code</span> === <span class="hljs-title class_">ErrorCode</span>.<span class="hljs-property">ERROR_CODE_AGREEMENT_STATUS_NOT_ACCEPTED</span>) {
      <span class="hljs-comment">// 用户未同意协议</span>
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-comment">// 应用登录失败，请尝试使用其他方式登录</span>
    }
  }

  <span class="hljs-title function_">build</span>(<span class="hljs-params"/>) {
    <span class="hljs-title class_">RelativeContainer</span>() {
      <span class="hljs-title class_">LoginWithHuaweiIDButton</span>({
        <span class="hljs-attr">params</span>: {
          <span class="hljs-comment">// LoginWithHuaweiIDButton支持的样式</span>
          <span class="hljs-attr">style</span>: loginComponentManager.<span class="hljs-property">Style</span>.<span class="hljs-property">BUTTON_RED</span>,
          <span class="hljs-comment">// 账号登录按钮在登录过程中展示加载态</span>
          <span class="hljs-attr">extraStyle</span>: {
            <span class="hljs-attr">buttonStyle</span>: <span class="hljs-keyword">new</span> loginComponentManager.<span class="hljs-title class_">ButtonStyle</span>().<span class="hljs-title function_">loadingStyle</span>({
              <span class="hljs-attr">show</span>: <span class="hljs-literal">true</span>
            })
          },
          <span class="hljs-comment">// LoginWithHuaweiIDButton的边框圆角半径</span>
          <span class="hljs-attr">borderRadius</span>: <span class="hljs-number">24</span>,
          <span class="hljs-comment">// LoginWithHuaweiIDButton支持的登录类型</span>
          <span class="hljs-attr">loginType</span>: loginComponentManager.<span class="hljs-property">LoginType</span>.<span class="hljs-property">ID</span>,
          <span class="hljs-comment">// LoginWithHuaweiIDButton支持按钮的样式跟随系统深浅色模式切换</span>
          <span class="hljs-attr">supportDarkMode</span>: <span class="hljs-literal">true</span>
        },
        <span class="hljs-attr">controller</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">controller</span>
      })
        .<span class="hljs-title function_">width</span>(<span class="hljs-string">"100%"</span>)
        .<span class="hljs-title function_">height</span>(<span class="hljs-number">40</span>)
        .<span class="hljs-title function_">alignRules</span>({
          <span class="hljs-attr">center</span>: { <span class="hljs-attr">anchor</span>: <span class="hljs-string">'__container__'</span>, <span class="hljs-attr">align</span>: <span class="hljs-title class_">VerticalAlign</span>.<span class="hljs-property">Center</span> },
          <span class="hljs-attr">middle</span>: { <span class="hljs-attr">anchor</span>: <span class="hljs-string">'__container__'</span>, <span class="hljs-attr">align</span>: <span class="hljs-title class_">HorizontalAlign</span>.<span class="hljs-property">Center</span> }
        })
    }
    .<span class="hljs-title function_">height</span>(<span class="hljs-string">'100%'</span>)
    .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)
  }
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">enum</span> <span class="hljs-title class_">ErrorCode</span> {
  <span class="hljs-comment">// 账号未登录</span>
  <span class="hljs-variable constant_">ERROR_CODE_LOGIN_OUT</span> = <span class="hljs-number">1001502001</span>,
  <span class="hljs-comment">// 网络错误</span>
  <span class="hljs-variable constant_">ERROR_CODE_NETWORK_ERROR</span> = <span class="hljs-number">1001502005</span>,
  <span class="hljs-comment">// 内部错误</span>
  <span class="hljs-variable constant_">ERROR_CODE_INTERNAL_ERROR</span> = <span class="hljs-number">1001502009</span>,
  <span class="hljs-comment">// 用户取消授权</span>
  <span class="hljs-variable constant_">ERROR_CODE_USER_CANCEL</span> = <span class="hljs-number">1001502012</span>,
  <span class="hljs-comment">// 系统服务异常</span>
  <span class="hljs-variable constant_">ERROR_CODE_SYSTEM_SERVICE</span> = <span class="hljs-number">12300001</span>,
  <span class="hljs-comment">// 重复请求</span>
  <span class="hljs-variable constant_">ERROR_CODE_REQUEST_REFUSE</span> = <span class="hljs-number">1001500002</span>,
  <span class="hljs-comment">// 用户未同意用户协议</span>
  <span class="hljs-variable constant_">ERROR_CODE_AGREEMENT_STATUS_NOT_ACCEPTED</span> = <span class="hljs-number">1005300001</span>
}
</code></pre>
<h3 data-id="heading-6">使用自定义按钮</h3>
<p>自定义按钮，和以上的代码没什么大的区别，唯独是需要自己触发登录请求逻辑，登录成功之后，就可以拿到华为账号的相关信息，接着就可以上传到服务端或者存储到本地，做一些其他的操作，有一点需要注意，有可能avatarUri头像返回为undefined，你可以做判断后，等于一个默认的头像。</p>
<pre><code class="hljs language-TypeScript" lang="TypeScript"> <span class="hljs-comment">/**
   *AUTHOR:AbnerMing
   *INTRODUCE:登录
   */</span>
  <span class="hljs-keyword">private</span> <span class="hljs-title function_">doLogin</span>(<span class="hljs-params"/>) {
  
    <span class="hljs-comment">// 创建授权请求，并设置参数</span>
    <span class="hljs-keyword">const</span> authRequest = <span class="hljs-keyword">new</span> authentication.<span class="hljs-title class_">HuaweiIDProvider</span>().<span class="hljs-title function_">createAuthorizationWithHuaweiIDRequest</span>();
    <span class="hljs-comment">// 获取头像昵称需要传如下scope</span>
    authRequest.<span class="hljs-property">scopes</span> = [<span class="hljs-string">'profile'</span>];
    <span class="hljs-comment">// 若开发者需要进行服务端开发以获取头像昵称，则需传如下permission获取authorizationCode</span>
    authRequest.<span class="hljs-property">permissions</span> = [<span class="hljs-string">'serviceauthcode'</span>];
    <span class="hljs-comment">// 用户是否需要登录授权，该值为true且用户未登录或未授权时，会拉起用户登录或授权页面</span>
    authRequest.<span class="hljs-property">forceAuthorization</span> = <span class="hljs-literal">true</span>;
    <span class="hljs-comment">// 用于防跨站点请求伪造</span>
    authRequest.<span class="hljs-property">state</span> = util.<span class="hljs-title function_">generateRandomUUID</span>();
    <span class="hljs-comment">// 执行授权请求</span>
    <span class="hljs-keyword">try</span> {
      <span class="hljs-comment">// 此示例为代码片段，实际需在自定义组件实例中使用，以获取UIContext对象作为函数入参</span>
      <span class="hljs-keyword">const</span> controller = <span class="hljs-keyword">new</span> authentication.<span class="hljs-title class_">AuthenticationController</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getUIContext</span>().<span class="hljs-title function_">getHostContext</span>());
      controller.<span class="hljs-title function_">executeRequest</span>(authRequest).<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">data</span>) =&gt;</span> {
        <span class="hljs-keyword">const</span> authorizationWithHuaweiIDResponse = data <span class="hljs-keyword">as</span> authentication.<span class="hljs-property">AuthorizationWithHuaweiIDResponse</span>;
        <span class="hljs-keyword">const</span> state = authorizationWithHuaweiIDResponse.<span class="hljs-property">state</span>;
        <span class="hljs-keyword">if</span> (state &amp;&amp; authRequest.<span class="hljs-property">state</span> !== state) {
          hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">`Failed to authorize. The state is different, response state: <span class="hljs-subst">${state}</span>`</span>);
          <span class="hljs-keyword">return</span>;
        }
        <span class="hljs-keyword">const</span> authorizationWithHuaweiIDCredential = authorizationWithHuaweiIDResponse?.<span class="hljs-property">data</span>;
        <span class="hljs-keyword">let</span> avatarUri = authorizationWithHuaweiIDCredential?.<span class="hljs-property">avatarUri</span>;
        <span class="hljs-keyword">const</span> nickName = authorizationWithHuaweiIDCredential?.<span class="hljs-property">nickName</span>;
        <span class="hljs-comment">// 开发者处理avatarUri, nickName</span>
        <span class="hljs-keyword">const</span> unionID = authorizationWithHuaweiIDCredential?.<span class="hljs-property">unionID</span>;
        <span class="hljs-comment">// 涉及服务端开发以获取头像昵称场景，开发者处理authorizationCode</span>
        <span class="hljs-comment">//这里进行接口请求，上传到自己服务器，如果需要的情况下</span>

        
        
      }).<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">err: BusinessError</span>) =&gt;</span> {
        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">dealAllError</span>(err);
      });
    } <span class="hljs-keyword">catch</span> (error) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">dealAllError</span>(error);
    }
  }

  <span class="hljs-comment">// 错误处理</span>
  <span class="hljs-title function_">dealAllError</span>(<span class="hljs-attr">error</span>: <span class="hljs-title class_">BusinessError</span>): <span class="hljs-built_in">void</span> {
    <span class="hljs-comment">// 在应用登录涉及UI交互场景下，建议按照如下错误码指导提示用户</span>
    <span class="hljs-keyword">if</span> (error.<span class="hljs-property">code</span> === <span class="hljs-title class_">ErrorCode</span>.<span class="hljs-property">ERROR_CODE_LOGIN_OUT</span>) {
      <span class="hljs-comment">// 用户未登录华为账号，请登录华为账号并重试或者尝试使用其他方式登录</span>
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (error.<span class="hljs-property">code</span> === <span class="hljs-title class_">ErrorCode</span>.<span class="hljs-property">ERROR_CODE_NETWORK_ERROR</span>) {
      <span class="hljs-comment">// 网络异常，请检查当前网络状态并重试或者尝试使用其他方式登录</span>
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (error.<span class="hljs-property">code</span> === <span class="hljs-title class_">ErrorCode</span>.<span class="hljs-property">ERROR_CODE_INTERNAL_ERROR</span>) {
      <span class="hljs-comment">// 登录失败，请尝试使用其他方式登录</span>
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (error.<span class="hljs-property">code</span> === <span class="hljs-title class_">ErrorCode</span>.<span class="hljs-property">ERROR_CODE_USER_CANCEL</span>) {
      <span class="hljs-comment">// 用户取消授权</span>
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (error.<span class="hljs-property">code</span> === <span class="hljs-title class_">ErrorCode</span>.<span class="hljs-property">ERROR_CODE_SYSTEM_SERVICE</span>) {
      <span class="hljs-comment">// 系统服务异常，请稍后重试或者尝试使用其他方式登录</span>
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (error.<span class="hljs-property">code</span> === <span class="hljs-title class_">ErrorCode</span>.<span class="hljs-property">ERROR_CODE_REQUEST_REFUSE</span>) {
      <span class="hljs-comment">// 重复请求，应用无需处理</span>
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-comment">// 应用登录失败，请尝试使用其他方式登录</span>
    }
  }
</code></pre>
<h2 data-id="heading-7">静默登录</h2>
<p>静默登录一般常用于在应用卸载重装、用户换机等场景，如登录的华为账号与应用重装、换机前一致，应用可通过Account Kit提供的静默登录方式即不需要用户点击登录/注册按钮，即可获取用户的身份标识UnionID/OpenID，完成用户的静默登录。</p>
<pre><code class="hljs language-TypeScript" lang="TypeScript"><span class="hljs-title function_">login</span>(<span class="hljs-params"/>){
    <span class="hljs-comment">// 创建登录请求，并设置参数</span>
    <span class="hljs-keyword">const</span> loginRequest = <span class="hljs-keyword">new</span> authentication.<span class="hljs-title class_">HuaweiIDProvider</span>().<span class="hljs-title function_">createLoginWithHuaweiIDRequest</span>();
    <span class="hljs-comment">// false表示静默登录</span>
    loginRequest.<span class="hljs-property">forceLogin</span> = <span class="hljs-literal">false</span>;
    <span class="hljs-comment">// 用于防跨站点请求伪造</span>
    loginRequest.<span class="hljs-property">state</span> = util.<span class="hljs-title function_">generateRandomUUID</span>();
    <span class="hljs-comment">// 执行登录请求</span>
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">const</span> controller = <span class="hljs-keyword">new</span> authentication.<span class="hljs-title class_">AuthenticationController</span>();
      controller.<span class="hljs-title function_">executeRequest</span>(loginRequest).<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">response: authentication.LoginWithHuaweiIDResponse</span>) =&gt;</span> {
        <span class="hljs-keyword">const</span> loginWithHuaweiIDResponse = response <span class="hljs-keyword">as</span> authentication.<span class="hljs-property">LoginWithHuaweiIDResponse</span>;
        <span class="hljs-keyword">const</span> state = loginWithHuaweiIDResponse.<span class="hljs-property">state</span>;
        <span class="hljs-keyword">if</span> (state &amp;&amp; loginRequest.<span class="hljs-property">state</span> !== state) {
          hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">`Failed to login. The state is different, response state: <span class="hljs-subst">${state}</span>`</span>);
          <span class="hljs-keyword">return</span>;
        }
        hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">'Succeeded in logging in.'</span>);
        <span class="hljs-keyword">const</span> loginWithHuaweiIDCredential = loginWithHuaweiIDResponse?.<span class="hljs-property">data</span>;
        <span class="hljs-keyword">const</span> code = loginWithHuaweiIDCredential?.<span class="hljs-property">authorizationCode</span>;
        <span class="hljs-comment">//  处理code  都自己的接口，或其他操作</span>
      }).<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">error: BusinessError</span>) =&gt;</span> {
        <span class="hljs-title function_">dealAllError</span>(error);
      })
    } <span class="hljs-keyword">catch</span> (error) {
      <span class="hljs-title function_">dealAllError</span>(error);
    }
  }
</code></pre>
<h2 data-id="heading-8">相关总结</h2>
<p>华为账号登录，满足了个人开发者的用户登录需求，可以说，极大的提高了开发效率和应用的便捷性，不在为账号体系而发愁，但是，有一点需要注意，应用端的账号登录需要和服务端的账号体系打通，否则只是单纯的登录，无法实现用户之间的交互。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Redis与MySQL双剑合璧：缓存更新策略与数据一致性保障]]></title>    <link>https://juejin.cn/post/7585463195200946226</link>    <guid>https://juejin.cn/post/7585463195200946226</guid>    <pubDate>2025-12-20T05:47:47.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585463195200946226" data-draft-id="7490783352842207259" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Redis与MySQL双剑合璧：缓存更新策略与数据一致性保障"/> <meta itemprop="keywords" content="Redis,数据库,性能优化"/> <meta itemprop="datePublished" content="2025-12-20T05:47:47.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Go高并发架构_王工"/> <meta itemprop="url" content="https://juejin.cn/user/446863555701561"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Redis与MySQL双剑合璧：缓存更新策略与数据一致性保障
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/446863555701561/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Go高并发架构_王工
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-20T05:47:47.000Z" title="Sat Dec 20 2025 05:47:47 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读20分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h4 data-id="heading-0">一、前言</h4>
<p>在现代高并发系统中，性能和数据一致性常常是一对“欢喜冤家”：追求极致性能可能牺牲一致性，而过于强调一致性又容易拖慢系统响应。Redis和MySQL作为两种截然不同的数据库技术，就像武侠小说中的双剑，一个快如闪电，一个稳如磐石。如何让它们携手作战，既提升性能又保障数据一致性，是许多开发者面临的现实挑战。</p>
<p>想象一下，你正在开发一个电商系统，商品详情页每秒被访问上万次，数据库不堪重负；或者在秒杀活动中，库存数据稍有延迟就可能引发超卖。单靠MySQL，查询慢、压力大；单靠Redis，又难以保证持久化和复杂查询。这时，Redis与MySQL的结合就成了“救命稻草”。Redis负责缓存热点数据，MySQL保障数据持久化和事务支持，两者分工明确，优势互补。</p>
<p>这篇文章面向有1-2年Redis使用经验的开发者。你可能已经熟悉基本的<code>SET</code>、<code>GET</code>操作，也尝试过用Redis优化系统性能，但面对缓存更新策略和一致性问题时，难免有些迷雾重重。我的目标是通过实战经验，带你梳理Redis与MySQL协同工作的核心策略，剖析常见问题，并分享解决方案和注意事项。无论你是想提升系统性能，还是解决“缓存和数据库不同步”的头疼问题，这里都有你需要的答案。</p>
<h5 data-id="heading-1">我的故事与经验</h5>
<p>我从事后端开发已有10年，其中Redis几乎是我每个项目的“老搭档”。从早期的高并发电商平台，到后来的实时数据分析系统，再到最近的分布式日志服务，Redis与MySQL的组合贯穿始终。比如在某电商项目中，我们用Redis缓存商品详情页，QPS从几百提升到上万，数据库负载降低了80%；在实时监控项目中，Redis的低延迟让我们能秒级更新数据，而MySQL则默默守护着数据的完整性。这些经验告诉我，缓存与数据库的协作不仅仅是技术选型，更是业务需求与架构设计的平衡。</p>
<p>然而，这一路并非坦途。缓存失效导致的脏数据、高并发下的热点Key问题、甚至Redis宕机引发的连锁反应，都让我踩过不少坑。正是这些“摔打”，让我深刻认识到缓存更新策略和数据一致性保障的重要性。接下来，我将结合这些实战经验，带你一步步解锁Redis与MySQL双剑合璧的奥秘。</p>
<hr/>
<h4 data-id="heading-2">二、Redis与MySQL双剑合璧的核心优势</h4>
<p>Redis和MySQL的组合，就像一场精心编排的“双人舞”：Redis以迅雷不及掩耳之势处理高频请求，MySQL则稳扎稳打守护数据的完整性。单独使用它们都有局限，但结合起来却能迸发出惊人的能量。这一节，我们将剖析两者的互补性，探讨典型应用场景，并聊聊性能与一致性之间的微妙权衡。</p>
<h5 data-id="heading-3">1. Redis与MySQL的互补性</h5>
<p>MySQL是关系型数据库的“老大哥”，擅长持久化存储和复杂查询。它的强一致性（ACID特性）和丰富的事务支持，让它成为数据可靠性的基石。然而，面对高并发场景，磁盘I/O和锁机制往往让它“喘不过气来”。相比之下，Redis就像一位“轻功高手”，基于内存操作，读写延迟低至亚毫秒级，单机QPS轻松突破十万，非常适合缓存热点数据或临时状态。但Redis也有短板：数据持久化能力有限，复杂查询更是它的“软肋”。</p>
<p>两者的结合，恰好弥补了彼此的不足。在我参与的一个电商项目中，商品详情页的访问量激增时，我们用Redis缓存热点数据，QPS从500提升到2万，MySQL的查询压力骤降80%。而库存更新等关键操作依然交给MySQL，确保数据不会因Redis宕机而丢失。这种“快慢搭配”的模式，既提升了性能，又保障了可靠性。</p>
<p><strong>核心优势一览表：</strong></p>



































<table><thead><tr><th>特性</th><th>MySQL</th><th>Redis</th><th>结合后效果</th></tr></thead><tbody><tr><td>数据存储</td><td>磁盘，持久化</td><td>内存，临时</td><td>热点数据加速，核心数据安全</td></tr><tr><td>访问速度</td><td>毫秒级</td><td>亚毫秒级</td><td>性能提升10倍以上</td></tr><tr><td>查询能力</td><td>复杂SQL支持</td><td>简单Key-Value</td><td>满足多样化需求</td></tr><tr><td>一致性</td><td>强一致性</td><td>弱一致性</td><td>可根据业务灵活调整</td></tr></tbody></table>
<h5 data-id="heading-4">2. 典型应用场景</h5>
<p>在实际项目中，Redis与MySQL的组合无处不在。以下是两个常见的例子：</p>
<ul>
<li>
<p><strong>电商商品详情页</strong><br/>
商品信息（如名称、价格）变化频率低，但访问量极高。我们用Redis缓存这些数据，设置TTL为1小时，极大减少MySQL的查询压力。而库存数据因实时性要求高，更新时直接写MySQL，再同步失效Redis缓存。这种分工让系统既快又稳。</p>
</li>
<li>
<p><strong>用户会话管理</strong><br/>
在一个社交应用中，用户登录状态用Redis存储，TTL设为30分钟，快速响应会话查询。用户的长期数据（如注册信息）则保存在MySQL中，确保即使Redis重启，会话过期后也能从MySQL恢复。这种搭配让会话管理高效又可靠。</p>
</li>
</ul>
<h5 data-id="heading-5">3. 一致性与性能的权衡</h5>
<p>Redis与MySQL协作时，性能和一致性就像天平的两端，很难两全其美。我们常听到“最终一致性”和“强一致性”这两个词，它们该如何选择呢？答案藏在业务需求里。</p>
<p>以秒杀场景为例，库存扣减必须实时准确，任何延迟或不一致都可能导致超卖。这时需要强一致性，通常通过分布式锁或事务确保Redis和MySQL同步更新。而在推荐系统中，用户看到的商品列表可能基于几分钟前的数据，短暂的不一致无伤大雅，最终一致性就够用了——先更新MySQL，再异步刷新Redis即可。</p>
<p><strong>权衡选择示意图：</strong></p>
<pre><code class="hljs language-lua" lang="lua">高一致性需求       中间地带       高性能需求
|<span class="hljs-comment">-------|-------|-------|-------|</span>
强一致性         最终一致性
&lt;<span class="hljs-comment">-- 秒杀、支付 --&gt; &lt;-- 推荐、日志 --&gt;</span>
</code></pre>
<p>在我的经验中，一个实时数据分析项目让我深刻体会到这种权衡。初期我们追求强一致性，所有数据都同步写Redis和MySQL，结果性能瓶颈明显。后来调整为异步写回策略，吞吐量提升了3倍，用户也能接受秒级的延迟。这提醒我们：技术方案没有绝对的好坏，只有适不适合。</p>
<hr/>
<h4 data-id="heading-6">三、缓存更新策略详解</h4>
<p>Redis与MySQL的协作好比一场精密的“接力赛”，缓存更新策略就是接力棒交接的规则。交接顺畅，系统跑得又快又稳；稍有失误，就可能摔个跟头。这一节，我们将深入探讨三种主流缓存更新策略：Cache-Aside、Write-Through和Write-Behind，剖析它们的原理、优缺点，并结合实战经验分享代码和踩坑教训，最后给出选择建议。</p>
<h5 data-id="heading-7">1. 常见的缓存更新策略</h5>
<h6 data-id="heading-8">Cache-Aside（旁路缓存）</h6>
<p><strong>原理</strong>：这是最经典的缓存策略。读取时，先查Redis，若未命中则查MySQL并回写缓存；写入时，先更新MySQL，再主动失效（删除）Redis缓存。这种“懒加载”的方式让缓存按需填充，非常灵活。</p>
<p><strong>优点</strong>：</p>
<ul>
<li>实现简单，开发成本低。</li>
<li>适合读多写少的场景，缓存命中率高时性能提升显著。</li>
</ul>
<p><strong>代码示例（Java伪代码）：</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 获取用户信息</span>
String <span class="hljs-title function_">getUser</span><span class="hljs-params">(<span class="hljs-type">int</span> userId)</span> {
    <span class="hljs-type">String</span> <span class="hljs-variable">cacheKey</span> <span class="hljs-operator">=</span> <span class="hljs-string">"user:"</span> + userId;
    <span class="hljs-type">String</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> redis.get(cacheKey); <span class="hljs-comment">// 先查Redis</span>
    <span class="hljs-keyword">if</span> (user == <span class="hljs-literal">null</span>) { <span class="hljs-comment">// 未命中</span>
        user = mysql.query(<span class="hljs-string">"SELECT * FROM users WHERE id = ?"</span>, userId); <span class="hljs-comment">// 查MySQL</span>
        <span class="hljs-keyword">if</span> (user != <span class="hljs-literal">null</span>) {
            redis.setex(cacheKey, <span class="hljs-number">3600</span>, user); <span class="hljs-comment">// 回写Redis，TTL为1小时</span>
        }
    }
    <span class="hljs-keyword">return</span> user;
}

<span class="hljs-comment">// 更新用户信息</span>
<span class="hljs-keyword">void</span> <span class="hljs-title function_">updateUser</span><span class="hljs-params">(<span class="hljs-type">int</span> userId, String data)</span> {
    mysql.update(<span class="hljs-string">"UPDATE users SET data = ? WHERE id = ?"</span>, data, userId); <span class="hljs-comment">// 先更新MySQL</span>
    redis.del(<span class="hljs-string">"user:"</span> + userId); <span class="hljs-comment">// 再删除Redis缓存</span>
}
</code></pre>
<p><strong>踩坑经验</strong>：<br/>
在一个电商项目中，我们发现部分用户数据更新后，缓存未及时失效，导致前端显示脏数据。后来分析发现，某些场景下<code>redis.del</code>因网络抖动失败。为此，我们引入TTL自动清理机制，即使删除失败，缓存也会在到期后失效，避免长期不一致。</p>
<h6 data-id="heading-9">Write-Through（直写）</h6>
<p><strong>原理</strong>：写入时同时更新MySQL和Redis，确保两者数据时刻一致。就像“双管齐下”，每次写操作都两边同步。</p>
<p><strong>优点</strong>：</p>
<ul>
<li>一致性强，读操作无需担心脏数据。</li>
<li>适合写频繁且一致性要求高的场景。</li>
</ul>
<p><strong>缺点</strong>：</p>
<ul>
<li>性能开销大，双写增加了延迟。</li>
<li>Redis和MySQL的同步可能因异常中断。</li>
</ul>
<p><strong>实际场景</strong>：<br/>
在金融系统的账户余额更新中，我们采用Write-Through。每次转账操作先写MySQL，再同步更新Redis，确保余额实时准确。虽然性能略有下降，但一致性得到了保障。</p>
<h6 data-id="heading-10">Write-Behind（异步写回）</h6>
<p><strong>原理</strong>：先快速写入Redis，再通过异步任务（如消息队列或定时任务）批量更新MySQL。就像“先记账，后对账”，优先保证写性能。</p>
<p><strong>优点</strong>：</p>
<ul>
<li>高吞吐量，适合高并发写场景。</li>
<li>异步批量操作减少数据库压力。</li>
</ul>
<p><strong>代码示例（Java伪代码）：</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">void</span> <span class="hljs-title function_">updateProductStock</span><span class="hljs-params">(<span class="hljs-type">int</span> productId, <span class="hljs-type">int</span> stock)</span> {
    <span class="hljs-type">String</span> <span class="hljs-variable">cacheKey</span> <span class="hljs-operator">=</span> <span class="hljs-string">"stock:"</span> + productId;
    redis.set(cacheKey, stock); <span class="hljs-comment">// 先写Redis</span>
    messageQueue.send(<span class="hljs-string">"update_stock"</span>, productId, stock); <span class="hljs-comment">// 异步发MQ更新MySQL</span>
}

<span class="hljs-comment">// MQ消费者</span>
<span class="hljs-keyword">void</span> <span class="hljs-title function_">onMessage</span><span class="hljs-params">(String productId, <span class="hljs-type">int</span> stock)</span> {
    mysql.update(<span class="hljs-string">"UPDATE products SET stock = ? WHERE id = ?"</span>, stock, productId);
}
</code></pre>
<p><strong>踩坑经验</strong>：<br/>
在实时监控系统中，我们用Write-Behind处理指标数据。某次MQ消费失败，导致MySQL未更新，数据丢失了近1小时。吸取教训后，我们引入重试机制和日志补偿：失败的任务重试3次仍不成功则记录日志，运维人员手动修复。</p>
<h5 data-id="heading-11">2. 如何选择合适的策略</h5>
<p>选择缓存策略就像挑选武功招式，没有最强，只有最合适。以下是我的经验总结：</p>
<p><strong>选择依据对比表：</strong></p>

































<table><thead><tr><th>策略</th><th>适用场景</th><th>一致性</th><th>性能</th><th>复杂度</th></tr></thead><tbody><tr><td>Cache-Aside</td><td>读多写少（如商品详情）</td><td>最终一致性</td><td>高</td><td>低</td></tr><tr><td>Write-Through</td><td>写频繁一致性高（如金融）</td><td>强一致性</td><td>中</td><td>中</td></tr><tr><td>Write-Behind</td><td>高并发写（如日志）</td><td>最终一致性</td><td>极高</td><td>高</td></tr></tbody></table>
<p><strong>项目经验</strong>：</p>
<ul>
<li><strong>电商库存管理</strong>：我们用Cache-Aside结合延迟双删（后文详述），应对读多写少的场景，确保库存更新后缓存及时刷新。</li>
<li><strong>实时监控</strong>：Write-Through保证指标数据实时同步，满足强一致性需求。</li>
<li><strong>日志系统</strong>：Write-Behind配合消息队列，轻松应对每秒百万级的写请求。</li>
</ul>
<p>选择时，建议从业务特点出发：</p>
<ol>
<li><strong>读写比例</strong>：读多写少选Cache-Aside，写多读少选Write-Through。</li>
<li><strong>一致性要求</strong>：强一致性选Write-Through，最终一致性可考虑其他两者。</li>
<li><strong>系统复杂度</strong>：资源有限时，优先简单易用的Cache-Aside。</li>
</ol>
<p><strong>策略选择流程图：</strong></p>
<pre><code class="hljs language-rust" lang="rust">开始
  |
读多写少? -<span class="hljs-punctuation">-&gt;</span> 是 -<span class="hljs-punctuation">-&gt;</span> Cache-Aside
  |             否
强一致性? -<span class="hljs-punctuation">-&gt;</span> 是 -<span class="hljs-punctuation">-&gt;</span> Write-Through
  |             否
高并发写? -<span class="hljs-punctuation">-&gt;</span> 是 -<span class="hljs-punctuation">-&gt;</span> Write-Behind
  |
其他场景 -<span class="hljs-punctuation">-&gt;</span> 根据复杂度调整
</code></pre>
<hr/>
<h4 data-id="heading-12">四、数据一致性保障的实战技巧</h4>
<p>缓存更新策略为Redis与MySQL的协作搭好了舞台，但一致性问题就像舞台下的“暗流”，稍不留神就会让表演翻车。无论是缓存未及时刷新，还是并发更新导致的脏数据，这些问题都可能让用户体验大打折扣。这一节，我们将直面一致性问题的根源，分享我在项目中总结的实战技巧，帮助你打造一个既快又准的系统。</p>
<h5 data-id="heading-13">1. 一致性问题的根源</h5>
<p>一致性问题通常源于两点：</p>
<ul>
<li><strong>更新顺序异常</strong>：比如先写MySQL后删Redis，但Redis宕机或网络延迟导致删除失败，缓存保留了旧数据。</li>
<li><strong>并发冲突</strong>：多个线程同时更新同一数据，比如秒杀场景下多人抢购库存，可能出现Redis和MySQL的数据“打架”。</li>
</ul>
<p>在一次电商活动中，我们就遇到过类似问题：库存更新后，Redis缓存未及时删除，导致前端显示的库存比实际多，最终引发超卖。分析后发现，根源在于高并发下操作顺序不可控和异常处理不足。</p>
<h5 data-id="heading-14">2. 解决方案与最佳实践</h5>
<p>针对这些问题，我总结了三种实用方案，下面逐一展开。</p>
<h6 data-id="heading-15">延迟双删策略</h6>
<p><strong>原理</strong>：写MySQL后立即删除Redis缓存，等几秒后再删一次，确保即使有并发读回写了旧数据，也能被清理掉。这就像“双重保险”，牺牲一点延迟换取一致性。</p>
<p><strong>代码示例（Java+Spring）：</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Transactional</span>
<span class="hljs-keyword">void</span> <span class="hljs-title function_">updateProduct</span><span class="hljs-params">(<span class="hljs-type">int</span> productId, String data)</span> {
    <span class="hljs-comment">// 更新MySQL</span>
    mysql.update(<span class="hljs-string">"UPDATE products SET data = ? WHERE id = ?"</span>, data, productId);
    <span class="hljs-type">String</span> <span class="hljs-variable">cacheKey</span> <span class="hljs-operator">=</span> <span class="hljs-string">"product:"</span> + productId;
    redis.del(cacheKey); <span class="hljs-comment">// 第一次删除</span>
    <span class="hljs-comment">// 延迟2秒再次删除</span>
    taskScheduler.schedule(() -&gt; redis.del(cacheKey), <span class="hljs-number">2000</span>);
}
</code></pre>
<p><strong>踩坑经验</strong>：<br/>
在某项目中，我们固定延迟2秒，结果发现高峰期QPS过高时，2秒不够覆盖所有并发读，导致部分脏数据残留。后来改为动态调整延迟时间（根据业务QPS，范围1-5秒），问题显著减少。</p>
<p><strong>适用场景</strong>：读多写少，且能容忍短暂不一致。</p>
<h6 data-id="heading-16">分布式锁</h6>
<p><strong>原理</strong>：在高并发更新时，用Redis分布式锁确保同一时刻只有一个线程能操作数据，避免冲突。就像给资源加了把“安全锁”，谁拿到钥匙谁操作。</p>
<p><strong>代码示例（Redis分布式锁）：</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-type">String</span> <span class="hljs-variable">lockKey</span> <span class="hljs-operator">=</span> <span class="hljs-string">"lock:product:"</span> + productId;
<span class="hljs-type">String</span> <span class="hljs-variable">cacheKey</span> <span class="hljs-operator">=</span> <span class="hljs-string">"product:"</span> + productId;
<span class="hljs-keyword">if</span> (redis.setnx(lockKey, <span class="hljs-string">"1"</span>)) { <span class="hljs-comment">// 尝试加锁</span>
    redis.expire(lockKey, <span class="hljs-number">10</span>); <span class="hljs-comment">// 设置10秒超时</span>
    <span class="hljs-keyword">try</span> {
        <span class="hljs-comment">// 更新MySQL</span>
        mysql.update(<span class="hljs-string">"UPDATE products SET stock = stock - 1 WHERE id = ?"</span>, productId);
        redis.del(cacheKey); <span class="hljs-comment">// 同步删除缓存</span>
    } <span class="hljs-keyword">finally</span> {
        redis.del(lockKey); <span class="hljs-comment">// 释放锁</span>
    }
} <span class="hljs-keyword">else</span> {
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">"获取锁失败，重试"</span>);
}
</code></pre>
<p><strong>最佳实践</strong>：</p>
<ul>
<li><strong>超时设置</strong>：锁超时太短可能提前释放，太长可能阻塞其他线程，建议根据业务调整（5-30秒）。</li>
<li><strong>续期机制</strong>：若操作耗时长，可用watchdog线程自动续期，避免死锁。</li>
<li><strong>踩坑经验</strong>：一次秒杀活动中，忘记释放锁，导致后续请求全被阻塞。后来用<code>finally</code>块确保释放，才解决问题。</li>
</ul>
<p><strong>适用场景</strong>：秒杀、库存扣减等高并发强一致性场景。</p>
<h6 data-id="heading-17">消息队列解耦</h6>
<p><strong>原理</strong>：写操作通过消息队列（MQ）解耦，先快速写Redis，再由消费者异步更新MySQL。这就像“快递代发”，前端快速响应，后端慢慢处理。</p>
<p><strong>代码示例（Java伪代码）：</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">void</span> <span class="hljs-title function_">updateLog</span><span class="hljs-params">(String logData)</span> {
    <span class="hljs-type">String</span> <span class="hljs-variable">cacheKey</span> <span class="hljs-operator">=</span> <span class="hljs-string">"log:"</span> + UUID.randomUUID();
    redis.set(cacheKey, logData); <span class="hljs-comment">// 先写Redis</span>
    messageQueue.send(<span class="hljs-string">"update_log"</span>, logData); <span class="hljs-comment">// 发MQ异步更新</span>
}

<span class="hljs-comment">// MQ消费者</span>
<span class="hljs-keyword">void</span> <span class="hljs-title function_">onMessage</span><span class="hljs-params">(String logData)</span> {
    mysql.insert(<span class="hljs-string">"INSERT INTO logs (data) VALUES (?)"</span>, logData);
}
</code></pre>
<p><strong>踩坑经验</strong>：<br/>
在日志系统中，MQ消费者宕机导致积压，MySQL未及时更新。后来引入死信队列，所有消费失败的消息转入备用队列，由定时任务重试，确保不丢数据。</p>
<p><strong>适用场景</strong>：高并发写，且一致性要求不高（如日志、统计数据）。</p>
<h5 data-id="heading-18">3. 一致性验证</h5>
<p>无论用哪种策略，异常总可能发生。为防万一，我们需要“查漏补缺”：</p>
<ul>
<li><strong>定期比对</strong>：用定时任务对比Redis与MySQL数据，发现不一致时自动修复。</li>
<li><strong>项目经验</strong>：在电商库存管理中，我们每天凌晨跑脚本比对，修复了99%的脏数据问题。修复过程记录日志，便于追溯。</li>
</ul>
<p><strong>验证流程示意图：</strong></p>
<pre><code class="hljs language-rust" lang="rust">定时任务启动
    |
获取Redis数据 -<span class="hljs-punctuation">-&gt;</span> 与MySQL比对 -<span class="hljs-punctuation">-&gt;</span> 不一致?
    |                              是 -<span class="hljs-punctuation">-&gt;</span> 更新Redis或MySQL -<span class="hljs-punctuation">-&gt;</span> 记录日志
    |                              否
结束
</code></pre>
<p><strong>一致性保障方案对比表：</strong></p>

































<table><thead><tr><th>方案</th><th>一致性</th><th>性能影响</th><th>复杂度</th><th>适用场景</th></tr></thead><tbody><tr><td>延迟双删</td><td>较高</td><td>小</td><td>中</td><td>读多写少</td></tr><tr><td>分布式锁</td><td>极高</td><td>中</td><td>高</td><td>高并发强一致性</td></tr><tr><td>消息队列</td><td>最终一致性</td><td>低</td><td>高</td><td>高并发写</td></tr></tbody></table>
<hr/>
<h4 data-id="heading-19">五、性能优化与踩坑经验</h4>
<p>Redis与MySQL的协作就像一辆跑车，缓存策略和一致性保障是引擎，而性能优化则是让它跑得更快更稳的“调校”。但这条赛道上也埋了不少“陷阱”，稍不留神就可能翻车。这一节，我将分享性能优化的核心技巧，以及我在实战中踩过的坑和应对之道，希望帮你少走弯路。</p>
<h5 data-id="heading-20">1. 性能优化的关键点</h5>
<p>要想让系统跑得快，细节决定成败。以下是三个关键点：</p>
<ul>
<li>
<p><strong>Redis键设计</strong><br/>
键名要短小精悍，避免“大Key”拖慢性能。比如存储复杂数据时，别用一个String存JSON，而是用Hash结构分字段存储。在一个用户管理系统中，我们将用户信息从<code>user:123:info</code>的单一String改为<code>HSET user:123 name "Tom" age "25"</code>，内存占用减少30%，查询效率也更高。</p>
</li>
<li>
<p><strong>批量操作</strong><br/>
Redis的单次操作很快，但网络RTT（往返时间）可能是瓶颈。使用Pipeline批量提交命令，能大幅降低延迟。在实时监控项目中，我们将每秒100次<code>SET</code>改为Pipeline批量操作，RTT从50ms降到5ms，性能提升10倍。</p>
</li>
<li>
<p><strong>缓存预热</strong><br/>
系统启动时，别让Redis“裸奔”。提前加载热点数据，能避免冷启动时的数据库压力。在电商活动中，我们在活动前将Top 100商品数据预热到Redis，首波流量直接命中缓存，MySQL毫发无损。</p>
</li>
</ul>
<p><strong>性能优化效果示意图：</strong></p>
<pre><code class="hljs language-lua" lang="lua">优化前：高RTT + 大Key + 冷启动
  |<span class="hljs-comment">----&gt; 数据库压力激增</span>
优化后：Pipeline + Hash + 预热
  |<span class="hljs-comment">----&gt; QPS提升，稳定运行</span>
</code></pre>
<h5 data-id="heading-21">2. 踩坑经验分享</h5>
<p>实战中，性能问题往往伴随着“坑”。以下是我遇到的三大典型问题及解决方案：</p>
<h6 data-id="heading-22">缓存穿透</h6>
<p><strong>问题</strong>：查询不存在的数据（如用户ID为-1），Redis未命中，请求直达MySQL，导致数据库压力暴增。<br/>
<strong>案例</strong>：某次接口被恶意请求刷爆，QPS从1万飙到10万，MySQL差点挂掉。<br/>
<strong>解决</strong>：</p>
<ol>
<li><strong>布隆过滤器</strong>：预先用布隆过滤器判断Key是否存在，不存在直接返回。</li>
<li><strong>缓存空值</strong>：查不到数据时，缓存空对象（如<code>null</code>），TTL设短些（如5分钟）。
<pre><code class="hljs language-java" lang="java">String <span class="hljs-title function_">getUser</span><span class="hljs-params">(<span class="hljs-type">int</span> userId)</span> {
    <span class="hljs-type">String</span> <span class="hljs-variable">cacheKey</span> <span class="hljs-operator">=</span> <span class="hljs-string">"user:"</span> + userId;
    <span class="hljs-type">String</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> redis.get(cacheKey);
    <span class="hljs-keyword">if</span> (user != <span class="hljs-literal">null</span>) <span class="hljs-keyword">return</span> user;
    <span class="hljs-keyword">if</span> (bloomFilter.mightContain(cacheKey)) {
        user = mysql.query(<span class="hljs-string">"SELECT * FROM users WHERE id = ?"</span>, userId);
        redis.setex(cacheKey, user == <span class="hljs-literal">null</span> ? <span class="hljs-number">300</span> : <span class="hljs-number">3600</span>, user); <span class="hljs-comment">// 空值TTL 5分钟</span>
    }
    <span class="hljs-keyword">return</span> user;
}
</code></pre>
</li>
</ol>
<p><strong>经验</strong>：布隆过滤器适合大数据量场景，空值缓存更简单但需控制内存。</p>
<h6 data-id="heading-23">缓存雪崩</h6>
<p><strong>问题</strong>：大量缓存Key同时失效，请求全打到MySQL，导致宕机。<br/>
<strong>案例</strong>：一次活动结束后，所有商品缓存TTL统一到期，MySQL瞬间瘫痪。<br/>
<strong>解决</strong>：</p>
<ol>
<li><strong>TTL随机化</strong>：给每个Key的TTL加随机偏移（如1小时±10分钟）。
<pre><code class="hljs language-java" lang="java">redis.setex(cacheKey, <span class="hljs-number">3600</span> + random.nextInt(<span class="hljs-number">600</span>), data);
</code></pre>
</li>
<li><strong>热点缓存隔离</strong>：将高频Key单独延长TTL或永不过期，手动刷新。<br/>
<strong>经验</strong>：随机化简单有效，热点隔离更适合核心数据。</li>
</ol>
<h6 data-id="heading-24">热点Key问题</h6>
<p><strong>问题</strong>：单个Key（如活动页数据）QPS过高，Redis单节点压力爆棚。<br/>
<strong>案例</strong>：某电商活动页Key每秒10万次请求，Redis集群响应变慢。<br/>
<strong>解决</strong>：</p>
<ol>
<li><strong>分片存储</strong>：将数据拆成多个Key（如<code>activity:1:part1</code>、<code>part2</code>），分散压力。</li>
<li><strong>本地缓存</strong>：前端或应用层用Guava Cache分担流量。我们在Nginx层加了本地缓存，Redis压力降到20%。
<pre><code class="hljs language-java" lang="java">Cache&lt;String, String&gt; localCache = CacheBuilder.newBuilder()
    .expireAfterWrite(<span class="hljs-number">10</span>, TimeUnit.SECONDS).build();
String <span class="hljs-title function_">getActivityData</span><span class="hljs-params">(String key)</span> {
    <span class="hljs-type">String</span> <span class="hljs-variable">data</span> <span class="hljs-operator">=</span> localCache.getIfPresent(key);
    <span class="hljs-keyword">if</span> (data == <span class="hljs-literal">null</span>) {
        data = redis.get(key);
        localCache.put(key, data);
    }
    <span class="hljs-keyword">return</span> data;
}
</code></pre>
</li>
</ol>
<p><strong>经验</strong>：分片适合Redis层优化，本地缓存更灵活但需注意内存。</p>
<p><strong>踩坑问题对比表：</strong></p>





























<table><thead><tr><th>问题</th><th>表现</th><th>解决方法</th><th>实施难度</th></tr></thead><tbody><tr><td>缓存穿透</td><td>数据库压力大</td><td>布隆过滤器/空值缓存</td><td>中</td></tr><tr><td>缓存雪崩</td><td>数据库瞬时过载</td><td>TTL随机化/热点隔离</td><td>低</td></tr><tr><td>热点Key</td><td>Redis响应慢</td><td>分片/本地缓存</td><td>高</td></tr></tbody></table>
<hr/>
<h4 data-id="heading-25">六、总结与展望</h4>
<p>Redis与MySQL的协作就像一场精彩的“双人舞”，从缓存策略到一致性保障，再到性能优化，每一步都考验着开发者的智慧和经验。走完这段旅程，我们不仅看到了两者的默契配合，也收获了实战中的宝贵教训。这一节，我将总结核心要点，分享实践建议，并展望未来的技术趋势，希望为你点亮前行的路。</p>
<h5 data-id="heading-26">1. 总结</h5>
<p>Redis与MySQL双剑合璧的核心在于两点：</p>
<ul>
<li><strong>合理选择缓存策略</strong>：Cache-Aside适合读多写少，Write-Through保障强一致性，Write-Behind应对高并发写。策略没有优劣之分，关键是匹配业务需求。</li>
<li><strong>保障数据一致性</strong>：延迟双删、分布式锁和消息队列各有千秋，配合定期验证，能让系统既快又稳。</li>
</ul>
<p>我的核心经验是：一切从业务出发。高并发电商需要性能优先，金融系统强调一致性，日志服务追求吞吐量。技术是为业务服务的，脱离需求的优化都是“空中楼阁”。比如在电商项目中，我们用Cache-Aside加延迟双删，QPS提升10倍的同时保证了库存准确；在实时监控中，Write-Through让数据零延迟，满足了客户需求。这些成功都源于对业务的深刻理解。</p>
<p><strong>实践建议</strong>：</p>
<ol>
<li><strong>从小处着手</strong>：先用Cache-Aside试水，简单易上手，再根据需求调整。</li>
<li><strong>关注异常</strong>：为每种策略设计兜底方案（如重试、日志补偿）。</li>
<li><strong>监控先行</strong>：部署Redis和MySQL的监控，实时掌握命中率、延迟和一致性问题。</li>
<li><strong>迭代优化</strong>：性能和一致性是个动态平衡，定期复盘调整。</li>
</ol>
<h5 data-id="heading-27">2. 展望</h5>
<p>Redis与MySQL的协作仍在进化。Redis 7.0增强了集群功能，支持多线程I/O和更灵活的数据结构，未来可能在一致性场景中扮演更重要角色。MySQL 8.0则优化了JSON支持和高可用性，与Redis的配合将更紧密。比如，Redis的Stream数据结构可以与MySQL的binlog集成，实现更高效的异步同步。</p>
<p>未来趋势可能包括：</p>
<ul>
<li><strong>智能化缓存</strong>：AI驱动的缓存预热和淘汰策略，让Redis更“聪明”。</li>
<li><strong>云原生融合</strong>：Serverless架构下，Redis和MySQL可能以托管服务形式无缝集成。</li>
<li><strong>一致性新解法</strong>：分布式事务（如TiDB+Redis的结合）或将简化强一致性实现。</li>
</ul>
<p>作为开发者，我鼓励你多实践、多分享。Redis与MySQL的组合看似简单，实则蕴藏无限可能。每次踩坑和优化，都是成长的契机。我的10年经验告诉我，技术没有终点，只有不断探索的乐趣。</p>
<p><strong>个人心得</strong>：<br/>
我最喜欢Redis的轻快和MySQL的稳重，它们就像我的左右手，缺一不可。每次解决一个一致性难题或优化一次性能瓶颈，都让我对这对“黄金搭档”更有信心。希望你也能在实践中找到属于自己的节奏。</p>
<hr/>
<p><strong>文章尾声：</strong><br/>
至此，我们从Redis与MySQL的优势讲到缓存策略，再到一致性和性能优化，走了一条完整的实战之路。带着这些经验和建议，去试试吧！有什么心得或问题，欢迎随时交流，毕竟技术的魅力就在于分享与成长。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[精选 8 个 .NET 开发实用的类库，效率提升利器！]]></title>    <link>https://juejin.cn/post/7585390679399104518</link>    <guid>https://juejin.cn/post/7585390679399104518</guid>    <pubDate>2025-12-20T05:47:11.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585390679399104518" data-draft-id="7585397173023424531" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="精选 8 个 .NET 开发实用的类库，效率提升利器！"/> <meta itemprop="keywords" content="后端,.NET"/> <meta itemprop="datePublished" content="2025-12-20T05:47:11.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="追逐时光者"/> <meta itemprop="url" content="https://juejin.cn/user/2770425031690333"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            精选 8 个 .NET 开发实用的类库，效率提升利器！
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2770425031690333/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    追逐时光者
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-20T05:47:11.000Z" title="Sat Dec 20 2025 05:47:11 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6847a14abcd44fcf8c16b78ede2d4929~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L-96YCQ5pe25YWJ6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766814431&amp;x-signature=F3PFPN7HN7vMeliN6HZdl3wpIbw%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-0">Mapster</h2>
<p>Mapster 是一个开源免费（MIT license）、快速、高性能、灵活且易于使用的 .NET 对象映射库，用于在 .NET 用程序中进行对象之间的转换和映射操作，大幅减少手动赋值带来的重复代码、人为错误和维护成本。</p>
<ul>
<li><strong>开源地址：</strong> <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FMapsterMapper%2FMapster" target="_blank" title="https://github.com/MapsterMapper/Mapster" ref="nofollow noopener noreferrer">github.com/MapsterMapp…</a></li>
<li><strong>详细介绍：</strong> <a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FQFEbHE2EWzzZN9VvnUwD4A" target="_blank" title="https://mp.weixin.qq.com/s/QFEbHE2EWzzZN9VvnUwD4A" ref="nofollow noopener noreferrer">mp.weixin.qq.com/s/QFEbHE2EW…</a></li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2f691a8a91f24f8d98f57b66b65bece2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L-96YCQ5pe25YWJ6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766814431&amp;x-signature=YGT%2FYfsP2XG1DPXl0kZZMWa0Clg%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-1">FlaUI</h2>
<p>FlaUI 是一个 .NET 开源免费（MIT license）、功能强大 的 UI 自动化库，专为 Windows 桌面应用程序（如 Win32、WinForms、WPF、Store Apps 等应用）的自动化测试而设计。该项目基于 Microsoft 的原生 UI Automation 库构建，并作为这些库的封装器，提供了丰富的功能和灵活的 API，以便开发者能够高效地编写自动化测试脚本。</p>
<ul>
<li><strong>开源地址：</strong> <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FFlaUI%2FFlaUI" target="_blank" title="https://github.com/FlaUI/FlaUI" ref="nofollow noopener noreferrer">github.com/FlaUI/FlaUI</a></li>
<li><strong>详细介绍：</strong> <a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FPE4S-fUyeG7U8Z78NYu6Rw" target="_blank" title="https://mp.weixin.qq.com/s/PE4S-fUyeG7U8Z78NYu6Rw" ref="nofollow noopener noreferrer">mp.weixin.qq.com/s/PE4S-fUye…</a></li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9bc69f3e40374ecba76d64c1ca3e8624~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L-96YCQ5pe25YWJ6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766814431&amp;x-signature=eKXkeP7XDh%2BSTHKmFm009eWFBms%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-2">QuestPDF</h2>
<p>QuestPDF 是一个用于生成 PDF 文档的现代开源 .NET 库。QuestPDF 由简洁易用的 C# Fluent API 提供全面的布局引擎。轻松生成 PDF 报告、发票、导出等。QuestPDF它提供了一个布局引擎，在设计时考虑了完整的分页支持。与其他库不同，它不依赖于 HTML 到 PDF 的转换，这在许多情况下是不可靠的。相反，它实现了自己的布局引擎，该引擎经过优化，可以满足所有与分页相关的要求。</p>
<ul>
<li><strong>开源地址：</strong> <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FQuestPDF%2FQuestPDF" target="_blank" title="https://github.com/QuestPDF/QuestPDF" ref="nofollow noopener noreferrer">github.com/QuestPDF/Qu…</a></li>
<li><strong>详细介绍：</strong> <a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FZLxDsDE-UQnYdLnVw4h3Kg" target="_blank" title="https://mp.weixin.qq.com/s/ZLxDsDE-UQnYdLnVw4h3Kg" ref="nofollow noopener noreferrer">mp.weixin.qq.com/s/ZLxDsDE-U…</a></li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9206c005cf5c428abf3a9a4614c9059b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L-96YCQ5pe25YWJ6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766814431&amp;x-signature=vc1sF08o8fSKZruG7unQMdGefvA%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-3">BouncyCastle</h2>
<p>BouncyCastle是一款C#版开源、免费的Bouncy Castle密码库，开发人员可以通过该项目在他们的 C# 应用程序中使用 Bouncy Castle 提供的各种密码学功能，从而加强数据的安全性和保护隐私信息。</p>
<ul>
<li><strong>开源地址：</strong> <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fbcgit%2Fbc-csharp" target="_blank" title="https://github.com/bcgit/bc-csharp" ref="nofollow noopener noreferrer">github.com/bcgit/bc-cs…</a></li>
<li><strong>详细介绍：</strong> <a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2F_VLzuDkyELusgsjFO6Wkog" target="_blank" title="https://mp.weixin.qq.com/s/_VLzuDkyELusgsjFO6Wkog" ref="nofollow noopener noreferrer">mp.weixin.qq.com/s/_VLzuDkyE…</a></li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f613a1a83cee41498cc77e412b155096~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L-96YCQ5pe25YWJ6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766814431&amp;x-signature=k4GGcb5lnRMNzCPX%2BcAcf3e3fW8%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-4">IdGenerator</h2>
<p>IdGenerator是一个全面的分布式主键ID生成器，使用的是优化的雪花算法（SnowFlake）雪花漂移算法，在缩短ID长度的同时，具备极高瞬时并发处理能力（50W/0.1s）。</p>
<ul>
<li><strong>开源地址：</strong> <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fyitter%2FIdGenerator" target="_blank" title="https://github.com/yitter/IdGenerator" ref="nofollow noopener noreferrer">github.com/yitter/IdGe…</a></li>
<li><strong>详细介绍：</strong> <a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FU1qKb4nYkQNtbXmQJkxyPA" target="_blank" title="https://mp.weixin.qq.com/s/U1qKb4nYkQNtbXmQJkxyPA" ref="nofollow noopener noreferrer">mp.weixin.qq.com/s/U1qKb4nYk…</a></li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9b3f777cd5e94a9782608e4eaf2e9a3e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L-96YCQ5pe25YWJ6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766814431&amp;x-signature=%2FssqbCgt%2FMFbU1gjtCGeb7HXQhw%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-5">CsvHelper</h2>
<p>CsvHelper是一个.NET开源、快速、灵活、高度可配置、易于使用的用于读取和写入CSV文件的类库。</p>
<ul>
<li><strong>开源地址：</strong> <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FJoshClose%2FCsvHelper" target="_blank" title="https://github.com/JoshClose/CsvHelper" ref="nofollow noopener noreferrer">github.com/JoshClose/C…</a></li>
<li><strong>详细介绍：</strong> <a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FoE-nnlYuP5SqkJmdxCTdUQ" target="_blank" title="https://mp.weixin.qq.com/s/oE-nnlYuP5SqkJmdxCTdUQ" ref="nofollow noopener noreferrer">mp.weixin.qq.com/s/oE-nnlYuP…</a></li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d3c798374c6c4b62893012c656ea4bfc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L-96YCQ5pe25YWJ6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766814431&amp;x-signature=R8eHH2dzhu3qhBFCDxzx%2FdxTvo8%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-6">Moq</h2>
<p>Moq是一个.NET开源、流行、使用简单的 .NET 模拟库，充分利用了.NET 的 Linq 表达式树和 lambda 表达式。这使得 Moq 成为最具生产力、类型安全且支持重构的模拟库。它不仅支持模拟接口，还支持模拟类。其 API 非常简单直观，不需要任何关于模拟概念的事先知识或经验。从而简化单元测试中的依赖管理和验证过程，提高代码的可测试性和可维护性。</p>
<ul>
<li><strong>开源地址：</strong> <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fdevlooped%2Fmoq" target="_blank" title="https://github.com/devlooped/moq" ref="nofollow noopener noreferrer">github.com/devlooped/m…</a></li>
<li><strong>详细介绍：</strong> <a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FlJMf3UP1TQHAdE1gi9DWQw" target="_blank" title="https://mp.weixin.qq.com/s/lJMf3UP1TQHAdE1gi9DWQw" ref="nofollow noopener noreferrer">mp.weixin.qq.com/s/lJMf3UP1T…</a></li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/16a22ab1fc184b4d80efb16923993e25~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L-96YCQ5pe25YWJ6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766814431&amp;x-signature=MiI019A329vbNF4Fhb2c1hXIdmw%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-7">xUnit</h2>
<p>xUnit 是一个开源、免费、以社区为中心的 .NET 单元测试框架，是用于 C# 和 F#（其他 .NET 语言可能也能运行，但未提供官方支持）进行单元测试的最新技术。xUnit 能够与 Visual Studio、Visual Studio Code、ReSharper、CodeRush 和 TestDriven.NET 兼容。它是.NET 基金会的一部分，并遵循其行为准则。</p>
<ul>
<li><strong>开源地址：</strong> <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fxunit%2Fxunit" target="_blank" title="https://github.com/xunit/xunit" ref="nofollow noopener noreferrer">github.com/xunit/xunit</a></li>
<li><strong>详细介绍：</strong> <a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2F_jZNx2V1mRJCVL4m0nFzxw" target="_blank" title="https://mp.weixin.qq.com/s/_jZNx2V1mRJCVL4m0nFzxw" ref="nofollow noopener noreferrer">mp.weixin.qq.com/s/_jZNx2V1m…</a></li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/07dcbd723d034a47b2cdf6361c192a5e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L-96YCQ5pe25YWJ6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766814431&amp;x-signature=xGVPE1MOZIH00OzTzx1Rnqt5Abs%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-8">更多 .NET 实用类库实操</h2>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2Fe43W9dqTWnmwI2STQREolw" target="_blank" title="https://mp.weixin.qq.com/s/e43W9dqTWnmwI2STQREolw" ref="nofollow noopener noreferrer">DotNetGuide专栏C#/.NET/.NET Core编程技巧练习集：</a>C#/.NET/.NET Core编程常用语法、算法、技巧、中间件、类库、工作业务实操练习集，配套详细的文章教程和代码示例，助力快速掌握C#/.NET/.NET Core中各种编程常用语法、算法、技巧、中间件、类库、工作业务实操等等。</p>
<ul>
<li>开源地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FYSGStudyHards%2FDotNetExercises" target="_blank" title="https://github.com/YSGStudyHards/DotNetExercises" ref="nofollow noopener noreferrer">github.com/YSGStudyHar…</a></li>
<li>想要学习C#/.NET/.NET Core什么技术欢迎Issues中留言：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FYSGStudyHards%2FDotNetGuide%2Fissues%2F42" target="_blank" title="https://github.com/YSGStudyHards/DotNetGuide/issues/42" ref="nofollow noopener noreferrer">github.com/YSGStudyHar…</a></li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/215e18e2d1a34103ae9045716b2fb27a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L-96YCQ5pe25YWJ6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766814431&amp;x-signature=NnZQ06SAI3Jp%2BN2eLtVo2dJ3FeE%3D" alt="" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[闭包在 Vue 项目中的应用]]></title>    <link>https://juejin.cn/post/7585463195200929842</link>    <guid>https://juejin.cn/post/7585463195200929842</guid>    <pubDate>2025-12-20T05:46:21.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585463195200929842" data-draft-id="7585410547338068018" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="闭包在 Vue 项目中的应用"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-12-20T05:46:21.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="用户5427784851540"/> <meta itemprop="url" content="https://juejin.cn/user/224762173330942"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            闭包在 Vue 项目中的应用
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/224762173330942/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    用户5427784851540
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-20T05:46:21.000Z" title="Sat Dec 20 2025 05:46:21 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>闭包（Closure）作为 JavaScript 的核心特性，在 Vue 项目中有着广泛而精妙的应用。它不仅是 Vue 框架内部实现的重要机制，也是开发者编写高效、可维护代码的关键工具。</p>
<hr/>
<h2 data-id="heading-0">一、Vue 框架内部的闭包应用</h2>
<h3 data-id="heading-1">1. 响应式系统（Reactivity System）</h3>
<p>Vue 3 的响应式系统基于 <code>Proxy</code> 和 <code>effect</code> 实现，而 <strong>依赖收集（Dependency Collection）</strong> 的核心就是闭包。</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// 简化版 Vue 3 响应式原理</span>
let activeEffect = null;


function <span class="hljs-built_in">effect</span>(fn) {
  activeEffect = fn; <span class="hljs-comment">// 当前正在执行的副作用函数</span>
  <span class="hljs-built_in">fn</span>();              <span class="hljs-comment">// 执行时会触发 getter</span>
  activeEffect = null;
}


function <span class="hljs-built_in">reactive</span>(obj) {
  return new <span class="hljs-built_in">Proxy</span>(obj, {
    get(target, key) {
      if (activeEffect) {
        <span class="hljs-comment">// 闭包：track 函数捕获了 key 和 activeEffect</span>
        <span class="hljs-built_in">track</span>(target, key, activeEffect);
      }
      return target<span class="hljs-selector-attr">[key]</span>;
    },
    <span class="hljs-built_in">set</span>(target, key, value) {
      target<span class="hljs-selector-attr">[key]</span> = value;
      <span class="hljs-built_in">trigger</span>(target, key); <span class="hljs-comment">// 触发所有依赖该 key 的 effect</span>
    }
  });
}


<span class="hljs-comment">// track 函数内部使用闭包保存依赖关系</span>
const depsMap = new <span class="hljs-built_in">WeakMap</span>();
function <span class="hljs-built_in">track</span>(target, key, effectFn) {
  let deps = depsMap<span class="hljs-selector-class">.get</span>(target);
  if (!deps) {
    deps = new <span class="hljs-built_in">Map</span>();
    depsMap<span class="hljs-selector-class">.set</span>(target, deps);
  }
  let effects = deps<span class="hljs-selector-class">.get</span>(key);
  if (!effects) {
    effects = new <span class="hljs-built_in">Set</span>();
    deps<span class="hljs-selector-class">.set</span>(key, effects);
  }
  effects<span class="hljs-selector-class">.add</span>(effectFn); <span class="hljs-comment">// effectFn 是通过闭包传递进来的</span>
}
</code></pre>
<blockquote>
<p>✅ <strong>关键点</strong>：</p>
</blockquote>
<blockquote>
<p><code>effectFn</code>（如组件 render 函数）通过闭包被保存在依赖集合中，当数据变化时，这些闭包函数被重新执行，实现视图更新</p>
</blockquote>
<h3 data-id="heading-2">2. Computed 计算属性</h3>
<p>计算属性的缓存机制依赖闭包保存状态：</p>
<pre><code class="hljs language-ini" lang="ini">function computed(getter) {
  let value<span class="hljs-comment">;</span>
  let <span class="hljs-attr">dirty</span> = <span class="hljs-literal">true</span><span class="hljs-comment">; // 是否需要重新计算</span>
  
  const <span class="hljs-attr">runner</span> = effect(getter, {
    lazy: true,
    scheduler: () =&gt; {
      if (!dirty) {
        <span class="hljs-attr">dirty</span> = <span class="hljs-literal">true</span><span class="hljs-comment">;</span>
        // 触发视图更新（通过闭包引用的 watcher）
      }
    }
  })<span class="hljs-comment">;</span>
  
  return {
    // 闭包：get 捕获了 value、dirty、runner
    get value() {
      if (dirty) {
        <span class="hljs-attr">value</span> = runner()<span class="hljs-comment">;</span>
        <span class="hljs-attr">dirty</span> = <span class="hljs-literal">false</span><span class="hljs-comment">;</span>
      }
      return value<span class="hljs-comment">;</span>
    }
  }<span class="hljs-comment">;</span>
}
</code></pre>
<p>每个 <code>computed</code> 实例通过闭包维护自己的 <code>value</code> 和 <code>dirty</code> 状态，实现精准缓存。</p>
<h3 data-id="heading-3">3. Watch 监听器</h3>
<p><code>watch</code> 的回调函数本质上是一个闭包，捕获了监听的数据和上下文：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-title function_">watch</span>(
  <span class="hljs-function">() =&gt;</span> user.<span class="hljs-property">name</span>, <span class="hljs-comment">// 依赖源（闭包捕获 user）</span>
  <span class="hljs-function">(<span class="hljs-params">newName, oldName</span>) =&gt;</span> {
    <span class="hljs-comment">// 回调函数是闭包，可以访问组件实例、其他变量等</span>
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`<span class="hljs-subst">${oldName}</span> → <span class="hljs-subst">${newName}</span>`</span>);
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">sendAnalytics</span>(newName); <span class="hljs-comment">// 访问组件方法</span>
  }
);
</code></pre>
<hr/>
<p> </p>
<h2 data-id="heading-4">二、业务开发中的闭包应用</h2>
<h3 data-id="heading-5">1. 封装私有状态（模块模式）</h3>
<p>在 Vue 组件或工具函数中，利用闭包创建私有变量：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// utils/request.js</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">createRequest</span> = (<span class="hljs-params">baseURL</span>) =&gt; {
  <span class="hljs-keyword">let</span> token = <span class="hljs-literal">null</span>; <span class="hljs-comment">// 私有变量，外部无法直接访问</span>
  
  <span class="hljs-keyword">return</span> {
    <span class="hljs-title function_">setToken</span>(<span class="hljs-params">newToken</span>) {
      token = newToken;
    },
    <span class="hljs-keyword">async</span> <span class="hljs-title function_">get</span>(<span class="hljs-params">url</span>) {
      <span class="hljs-comment">// 闭包捕获 token 和 baseURL</span>
      <span class="hljs-keyword">const</span> res = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetch</span>(<span class="hljs-string">`<span class="hljs-subst">${baseURL}</span><span class="hljs-subst">${url}</span>`</span>, {
        <span class="hljs-attr">headers</span>: { <span class="hljs-title class_">Authorization</span>: <span class="hljs-string">`Bearer <span class="hljs-subst">${token}</span>`</span> }
      });
      <span class="hljs-keyword">return</span> res.<span class="hljs-title function_">json</span>();
    }
  };
};


<span class="hljs-comment">// 在 Vue 组件中使用</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-title function_">data</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> {
      <span class="hljs-attr">api</span>: <span class="hljs-title function_">createRequest</span>(<span class="hljs-string">'/api'</span>)
    };
  },
  <span class="hljs-title function_">mounted</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">api</span>.<span class="hljs-title function_">setToken</span>(<span class="hljs-variable language_">localStorage</span>.<span class="hljs-title function_">getItem</span>(<span class="hljs-string">'token'</span>));
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">api</span>.<span class="hljs-title function_">get</span>(<span class="hljs-string">'/user'</span>).<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">user</span> =&gt;</span> {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">user</span> = user;
    });
  }
};
</code></pre>
<blockquote>
<p>✅ <strong>优势</strong>：避免全局变量污染，实现数据封装</p>
</blockquote>
<h3 data-id="heading-6">2. 防抖（Debounce）与节流（Throttle）</h3>
<p>表单验证、搜索建议等场景常用防抖，其核心是闭包：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">v-model</span>=<span class="hljs-string">"searchText"</span> @<span class="hljs-attr">input</span>=<span class="hljs-string">"debouncedSearch"</span> /&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>


<span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-title function_">data</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> {
      <span class="hljs-attr">searchText</span>: <span class="hljs-string">''</span>
    };
  },
  <span class="hljs-title function_">created</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// 创建防抖函数（闭包保存 timerId）</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">debouncedSearch</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">debounce</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">search</span>, <span class="hljs-number">300</span>);
  },
  <span class="hljs-attr">methods</span>: {
    <span class="hljs-title function_">debounce</span>(<span class="hljs-params">func, delay</span>) {
      <span class="hljs-keyword">let</span> timeoutId;
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">function</span>(<span class="hljs-params">...args</span>) {
        <span class="hljs-built_in">clearTimeout</span>(timeoutId);
        timeoutId = <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
          func.<span class="hljs-title function_">apply</span>(<span class="hljs-variable language_">this</span>, args);
        }, delay);
      };
    },
    <span class="hljs-keyword">async</span> <span class="hljs-title function_">search</span>(<span class="hljs-params"/>) {
      <span class="hljs-keyword">const</span> results = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">$http</span>.<span class="hljs-title function_">get</span>(<span class="hljs-string">`/search?q=<span class="hljs-subst">${<span class="hljs-variable language_">this</span>.searchText}</span>`</span>);
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">results</span> = results;
    }
  }
};
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
<p>每个组件实例的 <code>debouncedSearch</code> 都有自己的 <code>timeoutId</code>，互不干扰。</p>
<p> </p>
<hr/>
<h3 data-id="heading-7">详细解释：</h3>
<p>在 JavaScript 中，箭头函数 <code>(...args) =&gt; {}</code> 使用了 <strong>剩余参数语法（Rest Parameters）</strong> ，它会把所有传给函数的实际参数收集到一个数组中。</p>
<pre><code class="hljs language-javascript" lang="javascript">javascript
复制
<span class="hljs-keyword">function</span> <span class="hljs-title function_">example</span>(<span class="hljs-params">...args</span>) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(args); <span class="hljs-comment">// args 是一个数组，包含所有传入的参数</span>
}

<span class="hljs-title function_">example</span>(<span class="hljs-number">1</span>, <span class="hljs-string">'hello'</span>, <span class="hljs-literal">true</span>); 
<span class="hljs-comment">// 输出: [1, 'hello', true]</span>
</code></pre>
<p> </p>
<h4 data-id="heading-8">🎯 举个实际例子：带参数的防抖函数</h4>
<p>假设我们有一个搜索函数，每次用户输入时都要调用 API 查询结果：</p>
<pre><code class="hljs language-javascript" lang="javascript">javascript
复制
<span class="hljs-keyword">function</span> <span class="hljs-title function_">searchAPI</span>(<span class="hljs-params">query, category</span>) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`Searching for "<span class="hljs-subst">${query}</span>" in <span class="hljs-subst">${category}</span>`</span>);
  <span class="hljs-comment">// 模拟发起网络请求</span>
}


<span class="hljs-comment">// 创建防抖版本</span>
<span class="hljs-keyword">const</span> debouncedSearch = <span class="hljs-title function_">debounce</span>(searchAPI, <span class="hljs-number">500</span>);


<span class="hljs-comment">// 模拟用户多次输入</span>
<span class="hljs-title function_">debouncedSearch</span>(<span class="hljs-string">'laptop'</span>, <span class="hljs-string">'electronics'</span>); <span class="hljs-comment">// 参数会被收集到 args 中</span>
<span class="hljs-title function_">debouncedSearch</span>(<span class="hljs-string">'laptop pro'</span>, <span class="hljs-string">'electronics'</span>);
<span class="hljs-title function_">debouncedSearch</span>(<span class="hljs-string">'laptop pro max'</span>, <span class="hljs-string">'electronics'</span>);


<span class="hljs-comment">// 最终只会执行最后一次调用:</span>
<span class="hljs-comment">// Searching for "laptop pro max" in electronics</span>
</code></pre>
<h3 data-id="heading-9">执行过程详解：</h3>
<ol>
<li>第一次调用 <code>debouncedSearch('laptop', 'electronics')</code></li>
<li>
<ol>
<li><code>args = ['laptop', 'electronics']</code></li>
<li>设置定时器 A</li>
</ol>
</li>
<li>第二次调用（500ms 内）</li>
<li>
<ol>
<li>清除定时器 A</li>
<li>设置定时器 B，此时 <code>args = ['laptop pro', 'electronics']</code></li>
</ol>
</li>
<li>第三次调用（仍在 500ms 内）</li>
<li>
<ol>
<li>清除定时器 B</li>
<li>设置定时器 C，此时 <code>args = ['laptop pro max', 'electronics']</code></li>
</ol>
</li>
<li>500ms 后无新调用</li>
<li>
<ol>
<li>执行 <code>func.apply(this, args)</code></li>
<li>等价于 <code>searchAPI.call(this, 'laptop pro max', 'electronics')</code></li>
</ol>
</li>
</ol>
<p> </p>
<h2 data-id="heading-10">🔍 <code>func.apply(this, args)</code> 的作用</h2>
<p>这部分是防抖函数的关键设计，目的是<strong>保持原函数的调用上下文和参数传递</strong>：</p>





















<table><thead><tr><th>方法</th><th>作用</th></tr></thead><tbody><tr><td>this</td><td>保持函数调用时的上下文（谁调用了这个函数）</td></tr><tr><td>args</td><td>保证原始参数完整传递给目标函数</td></tr><tr><td>apply()</td><td>以数组形式展开参数并绑定 this</td></tr></tbody></table>
<hr/>
<p> </p>
<h3 data-id="heading-11">3. 事件处理器中的参数传递</h3>
<p>在循环渲染列表时，闭包解决事件参数问题：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">v-for</span>=<span class="hljs-string">"item in items"</span> <span class="hljs-attr">:key</span>=<span class="hljs-string">"item.id"</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- 方式1：箭头函数（隐式闭包） --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">button</span> @<span class="hljs-attr">click</span>=<span class="hljs-string">"() =&gt; handleDelete(item.id)"</span>&gt;</span>删除<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
    
    <span class="hljs-comment">&lt;!-- 方式2：方法返回函数（显式闭包） --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">button</span> @<span class="hljs-attr">click</span>=<span class="hljs-string">"getDeleteHandler(item.id)"</span>&gt;</span>删除<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>


<span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-attr">methods</span>: {
    <span class="hljs-title function_">handleDelete</span>(<span class="hljs-params">id</span>) {
      <span class="hljs-comment">// 处理删除逻辑</span>
    },
    <span class="hljs-comment">// 返回一个闭包函数，捕获 id</span>
    <span class="hljs-title function_">getDeleteHandler</span>(<span class="hljs-params">id</span>) {
      <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> {
        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">handleDelete</span>(id);
      };
    }
  }
};
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
<blockquote>
<p>⚠️ <strong>注意</strong>：避免在模板中直接写 <code>@click="handleDelete(item.id)"</code>，这会在每次渲染时创建新函数，影响性能。</p>
</blockquote>
<h3 data-id="heading-12">4. Composition API 中的闭包</h3>
<p>Vue 3 的组合式 API 天然适合闭包：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// composables/useCounter.js</span>
<span class="hljs-keyword">import</span> { ref, computed } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>;


<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">useCounter</span>(<span class="hljs-params">initialValue = <span class="hljs-number">0</span></span>) {
  <span class="hljs-keyword">const</span> count = <span class="hljs-title function_">ref</span>(initialValue);
  
  <span class="hljs-comment">// 闭包：以下函数共享 count</span>
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">increment</span> = (<span class="hljs-params"/>) =&gt; count.<span class="hljs-property">value</span>++;
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">decrement</span> = (<span class="hljs-params"/>) =&gt; count.<span class="hljs-property">value</span>--;
  <span class="hljs-keyword">const</span> doubled = <span class="hljs-title function_">computed</span>(<span class="hljs-function">() =&gt;</span> count.<span class="hljs-property">value</span> * <span class="hljs-number">2</span>);
  
  <span class="hljs-keyword">return</span> {
    count,
    increment,
    decrement,
    doubled
  };
}


<span class="hljs-comment">// 在组件中使用</span>
<span class="hljs-keyword">import</span> { useCounter } <span class="hljs-keyword">from</span> <span class="hljs-string">'./composables/useCounter'</span>;


<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-title function_">setup</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> { count, increment, doubled } = <span class="hljs-title function_">useCounter</span>(<span class="hljs-number">10</span>);
    <span class="hljs-keyword">return</span> { count, increment, doubled };
  }
};
</code></pre>
<p>每个 <code>useCounter</code> 调用都创建独立的作用域，状态完全隔离。</p>
<h3 data-id="heading-13">5. 高阶组件（HOC）与 Renderless 组件</h3>
<p>通过闭包封装通用逻辑：</p>
<pre><code class="hljs language-ini" lang="ini">// composables/useFetch.js
export function useFetch(url) {
  const <span class="hljs-attr">data</span> = ref(null)<span class="hljs-comment">;</span>
  const <span class="hljs-attr">loading</span> = ref(<span class="hljs-literal">true</span>)<span class="hljs-comment">;</span>
  const <span class="hljs-attr">error</span> = ref(null)<span class="hljs-comment">;</span>
  
  const <span class="hljs-attr">fetchData</span> = async () =&gt; {
    try {
      <span class="hljs-attr">loading.value</span> = <span class="hljs-literal">true</span><span class="hljs-comment">;</span>
      const <span class="hljs-attr">res</span> = await fetch(url)<span class="hljs-comment">; // 闭包捕获 url</span>
      <span class="hljs-attr">data.value</span> = await res.json()<span class="hljs-comment">;</span>
    } catch (err) {
      <span class="hljs-attr">error.value</span> = err<span class="hljs-comment">;</span>
    } finally {
      <span class="hljs-attr">loading.value</span> = <span class="hljs-literal">false</span><span class="hljs-comment">;</span>
    }
  }<span class="hljs-comment">;</span>
  
  onMounted(fetchData)<span class="hljs-comment">;</span>
  
  return { data, loading, error, refetch: fetchData }<span class="hljs-comment">;</span>
}


// 在任意组件中复用
export default {
  setup() {
    const { data, loading } = useFetch('/api/users')<span class="hljs-comment">;</span>
    return { data, loading }<span class="hljs-comment">;</span>
  }
}<span class="hljs-comment">;</span>
</code></pre>
<h3 data-id="heading-14">6. 缓存计算结果（Memoization）</h3>
<p>对复杂计算进行缓存：</p>
<pre><code class="hljs language-ini" lang="ini">// composables/useExpensiveCalc.js
export function useExpensiveCalc(items) {
  const <span class="hljs-attr">cache</span> = new Map()<span class="hljs-comment">;</span>
  
  const <span class="hljs-attr">getResult</span> = (filter) =&gt; {
    const <span class="hljs-attr">key</span> = JSON.stringify(filter)<span class="hljs-comment">;</span>
    if (cache.has(key)) {
      return cache.get(key)<span class="hljs-comment">;</span>
    }
    
    // 模拟复杂计算
    const <span class="hljs-attr">result</span> = items.value
      .filter(<span class="hljs-attr">item</span> =&gt; item.type === filter.type)
      .map(<span class="hljs-attr">item</span> =&gt; ({ ...item, processed: <span class="hljs-literal">true</span> }))<span class="hljs-comment">;</span>
    
    cache.set(key, result)<span class="hljs-comment">;</span>
    return result<span class="hljs-comment">;</span>
  }<span class="hljs-comment">;</span>
  
  // 提供清除缓存的方法
  const <span class="hljs-attr">clearCache</span> = () =&gt; cache.clear()<span class="hljs-comment">;</span>
  
  return { getResult, clearCache }<span class="hljs-comment">;</span>
}
</code></pre>
<p>闭包保护 <code>cache</code> 对象，避免全局污染。</p>
<hr/>
<p> </p>
<h2 data-id="heading-15">三、闭包相关的常见问题与解决方案</h2>
<h3 data-id="heading-16">1. 循环中的闭包陷阱（Vue 2 + var）</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// ❌ 错误示例（Vue 2 中使用 var）</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-title function_">data</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> { <span class="hljs-attr">list</span>: [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>] };
  },
  <span class="hljs-title function_">mounted</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">list</span>.<span class="hljs-property">length</span>; i++) {
      <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(i); <span class="hljs-comment">// 全部输出 3</span>
      }, <span class="hljs-number">100</span>);
    }
  }
};
</code></pre>
<p><strong>解决方案</strong>：</p>
<ul>
<li>使用 <code>let</code> 替代 <code>var</code></li>
<li>使用 <code>forEach</code> 或 <code>map</code></li>
<li>使用箭头函数</li>
</ul>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// ✅ 正确做法</span>
<span class="hljs-title function_">mounted</span>(<span class="hljs-params"/>) {
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">list</span>.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">item, index</span>) =&gt;</span> {
    <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(index); <span class="hljs-comment">// 0, 1, 2</span>
    }, <span class="hljs-number">100</span>);
  });
}
</code></pre>
<h3 data-id="heading-17">2. 内存泄漏风险</h3>
<p>在组件销毁时，及时清理闭包持有的资源：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-title function_">data</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> { <span class="hljs-attr">timer</span>: <span class="hljs-literal">null</span> };
  },
  <span class="hljs-title function_">mounted</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// 闭包持有 timer 引用</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">timer</span> = <span class="hljs-built_in">setInterval</span>(<span class="hljs-function">() =&gt;</span> {
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">updateData</span>();
    }, <span class="hljs-number">1000</span>);
  },
  <span class="hljs-title function_">beforeUnmount</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// 必须清理，否则闭包导致内存泄漏</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">timer</span>) {
      <span class="hljs-built_in">clearInterval</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">timer</span>);
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">timer</span> = <span class="hljs-literal">null</span>;
    }
  }
};
</code></pre>
<h3 data-id="heading-18">3. 闭包与 this 指向</h3>
<p>在 Vue 2 选项式 API 中，注意 <code>this</code> 绑定：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-attr">methods</span>: {
    <span class="hljs-title function_">handleClick</span>(<span class="hljs-params"/>) {
      <span class="hljs-keyword">const</span> self = <span class="hljs-variable language_">this</span>; <span class="hljs-comment">// 保存 this 引用（闭包）</span>
      
      <span class="hljs-built_in">setTimeout</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
        <span class="hljs-comment">// 普通函数中 this 指向 window</span>
        self.<span class="hljs-title function_">showMessage</span>(); <span class="hljs-comment">// 通过闭包访问组件实例</span>
      }, <span class="hljs-number">100</span>);
      
      <span class="hljs-comment">// 或使用箭头函数（自动继承 this）</span>
      <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">showMessage</span>(); <span class="hljs-comment">// 正确</span>
      }, <span class="hljs-number">100</span>);
    }
  }
};
</code></pre>
<h2 data-id="heading-19">四、最佳实践总结</h2>








































<table><thead><tr><th>场景</th><th>推荐做法</th><th>避免事项</th></tr></thead><tbody><tr><td><strong>状态封装</strong></td><td>使用闭包创建私有变量</td><td>滥用全局变量</td></tr><tr><td><strong>事件处理</strong></td><td>在 methods 中定义，模板中引用</td><td>在模板中直接写内联函数</td></tr><tr><td><strong>防抖节流</strong></td><td>在 created/setup 中创建一次</td><td>每次渲染都创建新函数</td></tr><tr><td><strong>循环索引</strong></td><td>使用 let 或 forEach</td><td>在 for(var) 中使用闭包</td></tr><tr><td><strong>资源清理</strong></td><td>在 beforeUnmount 中清理定时器、监听器</td><td>忽略清理导致内存泄漏</td></tr><tr><td><strong>Composition API</strong></td><td>利用闭包实现逻辑复用</td><td>过度嵌套导致调试困难</td></tr></tbody></table>
<h2 data-id="heading-20">结语</h2>
<p>闭包在 Vue 项目中既是<strong>框架运行的基石</strong>，也是<strong>开发者手中的利器</strong>。理解其原理，能帮助我们：</p>
<ul>
<li>更好地使用 Vue 的响应式系统和 Composition API</li>
<li>编写出高性能、低内存占用的组件</li>
<li>避免常见的作用域陷阱和内存泄漏问题</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[JavaScript 闭包详解：由浅入深掌握作用域与内存管理的艺术]]></title>    <link>https://juejin.cn/post/7585463195200962610</link>    <guid>https://juejin.cn/post/7585463195200962610</guid>    <pubDate>2025-12-20T05:50:41.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585463195200962610" data-draft-id="7585410547338100786" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="JavaScript 闭包详解：由浅入深掌握作用域与内存管理的艺术"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-12-20T05:50:41.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="用户5427784851540"/> <meta itemprop="url" content="https://juejin.cn/user/224762173330942"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            JavaScript 闭包详解：由浅入深掌握作用域与内存管理的艺术
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/224762173330942/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    用户5427784851540
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-20T05:50:41.000Z" title="Sat Dec 20 2025 05:50:41 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一、什么是闭包？——从直观现象入手</h2>
<h3 data-id="heading-1">1.1 一个经典例子</h3>
<p>先看一段代码：</p>
<pre><code class="hljs language-scss" lang="scss">function <span class="hljs-built_in">outer</span>() {
  let count = <span class="hljs-number">0</span>;
  
  function <span class="hljs-built_in">inner</span>() {
    count++;
    console<span class="hljs-selector-class">.log</span>(count);
  }
  
  return inner;
}


const counter = <span class="hljs-built_in">outer</span>();
<span class="hljs-built_in">counter</span>(); <span class="hljs-comment">// 输出: 1</span>
<span class="hljs-built_in">counter</span>(); <span class="hljs-comment">// 输出: 2</span>
<span class="hljs-built_in">counter</span>(); <span class="hljs-comment">// 输出: 3</span>
</code></pre>
<p>这里发生了什么？</p>
<ul>
<li><code>outer</code> 函数执行完毕后，按理说其内部变量 <code>count</code> 应该被销毁。</li>
<li>但通过 <code>counter()</code> 调用 <code>inner</code> 函数时，<code>count</code> 不仅存在，还能被修改并保留状态。</li>
</ul>
<p>这种 <strong>“函数即使在其词法作用域外被调用，仍能访问并操作其创建时所在作用域中的变量”</strong> 的现象，就是闭包。</p>
<h3 data-id="heading-2">1.2 官方定义</h3>
<p>MDN 对闭包的定义是：</p>
<blockquote>
<p>“闭包是指那些能够访问自由变量的函数。自由变量是指在函数中使用，但既不是函数参数也不是函数局部变量的变量。”</p>
</blockquote>
<p>更通俗地说：<strong>闭包 = 函数 + 其创建时所处的词法环境（Lexical Environment）的引用</strong>。</p>
<p> </p>
<h2 data-id="heading-3">二、理解基础：作用域与词法环境</h2>
<p>要真正理解闭包，必须先掌握 JavaScript 的作用域机制。</p>
<h3 data-id="heading-4">2.1 作用域（Scope）</h3>
<p>作用域决定了变量的可访问范围。JavaScript 采用 <strong>词法作用域（Lexical Scoping）</strong> ，即变量的作用域在<strong>代码编写时就已确定</strong>，而非运行时。</p>
<pre><code class="hljs language-scss" lang="scss">let <span class="hljs-selector-tag">a</span> = <span class="hljs-number">1</span>;


function <span class="hljs-built_in">foo</span>() {
  console<span class="hljs-selector-class">.log</span>(a); <span class="hljs-comment">// 会输出 1，因为 foo 定义在全局作用域内</span>
}


function <span class="hljs-built_in">bar</span>() {
  let <span class="hljs-selector-tag">a</span> = <span class="hljs-number">2</span>;
  <span class="hljs-built_in">foo</span>(); <span class="hljs-comment">// 仍然输出 1！不是 2</span>
}


<span class="hljs-built_in">bar</span>();
</code></pre>
<p>尽管 <code>foo</code> 是在 <code>bar</code> 内部调用的，但它访问的是<strong>定义时</strong>所在的作用域（全局），而非<strong>调用时</strong>的作用域。这就是词法作用域的核心。</p>
<h3 data-id="heading-5">2.2 词法环境（Lexical Environment）</h3>
<p>ES6 规范引入了 <strong>词法环境（Lexical Environment）</strong> 来精确描述作用域。</p>
<p>每个词法环境包含两个部分：</p>
<ul>
<li><strong>环境记录（Environment Record）</strong> ：存储变量和函数的映射（如 <code>{ count: 0 }</code>）</li>
<li><strong>对外部词法环境的引用（Outer Environment Reference）</strong> ：指向父级作用域</li>
</ul>
<p>当函数被创建时，它会<strong>捕获（capture）</strong> 当前的词法环境，并将其保存在内部属性 <code>[[Environment]]</code> 中。</p>
<blockquote>
<p>✅ <strong>关键点</strong>：闭包的本质，就是函数通过 <code>[[Environment]]</code> 引用“记住”了它出生时的环境。</p>
</blockquote>
<p> </p>
<h2 data-id="heading-6">三、闭包的形成机制：内存模型解析</h2>
<p>让我们通过内存模型，可视化闭包的形成过程。</p>
<h3 data-id="heading-7">3.1 执行上下文与作用域链</h3>
<p>当 JavaScript 引擎执行代码时，会为每个函数调用创建一个 <strong>执行上下文（Execution Context）</strong> ，其中包含：</p>
<ul>
<li>变量对象（Variable Object）</li>
<li>作用域链（Scope Chain）</li>
<li>this 绑定</li>
</ul>
<p>作用域链是一个<strong>从当前作用域逐级向上查找</strong>的链表，直到全局作用域。</p>
<h3 data-id="heading-8">3.2 闭包的内存结构</h3>
<p>以之前的 <code>counter</code> 为例：</p>
<pre><code class="hljs language-lua" lang="lua"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">outer</span><span class="hljs-params">()</span></span> {
  let count = <span class="hljs-number">0</span>; // 存储在 outer 的词法环境中
  
  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">inner</span><span class="hljs-params">()</span></span> { // inner 的 <span class="hljs-string">[[Environment]]</span> 指向 outer 的词法环境
    count++;
    console.<span class="hljs-built_in">log</span>(count);
  }
  
  <span class="hljs-keyword">return</span> inner;
}
</code></pre>
<p>当 <code>outer()</code> 执行时：</p>
<ol>
<li>创建 <code>outer</code> 的执行上下文，初始化 <code>count = 0</code></li>
<li>定义 <code>inner</code> 函数，其内部属性 <code>[[Environment]]</code> 指向 <code>outer</code> 的词法环境</li>
<li>返回 <code>inner</code> 函数引用</li>
</ol>
<p>当 <code>outer()</code> 执行完毕：</p>
<ul>
<li><code>outer</code> 的执行上下文被弹出调用栈</li>
<li><strong>但</strong> <code>inner</code> <strong>仍持有对</strong> <code>outer</code> <strong>词法环境的引用</strong></li>
<li>因此，<code>count</code> 不会被垃圾回收，继续存在于内存中</li>
</ul>
<blockquote>
<p>📌 <strong>重要结论</strong>：</p>
</blockquote>
<blockquote>
<p>闭包导致外部函数的变量<strong>不会被释放</strong>，直到闭包本身不再被引用。</p>
</blockquote>
<h3 data-id="heading-9">3.3 多个闭包共享同一环境</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">createCounter</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">let</span> count = <span class="hljs-number">0</span>;
  
  <span class="hljs-keyword">return</span> {
    <span class="hljs-attr">increment</span>: <span class="hljs-function">() =&gt;</span> ++count,
    <span class="hljs-attr">decrement</span>: <span class="hljs-function">() =&gt;</span> --count,
    <span class="hljs-attr">value</span>: <span class="hljs-function">() =&gt;</span> count
  };
}


<span class="hljs-keyword">const</span> counter = <span class="hljs-title function_">createCounter</span>();
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(counter.<span class="hljs-title function_">value</span>()); <span class="hljs-comment">// 0</span>
counter.<span class="hljs-title function_">increment</span>();
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(counter.<span class="hljs-title function_">value</span>()); <span class="hljs-comment">// 1</span>
counter.<span class="hljs-title function_">decrement</span>();
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(counter.<span class="hljs-title function_">value</span>()); <span class="hljs-comment">// 0</span>
</code></pre>
<p>这里 <code>increment</code>、<code>decrement</code>、<code>value</code> 三个函数都形成了闭包，<strong>共享同一个</strong> <code>count</code> <strong>变量</strong>。它们的 <code>[[Environment]]</code> 都指向 <code>createCounter</code> 的词法环境。</p>
<h2 data-id="heading-10">四、常见误区与陷阱</h2>
<h3 data-id="heading-11">4.1 误区一：“只有返回函数才算闭包”</h3>
<p><strong>错误！</strong> 任何函数只要访问了其外部作用域的变量，就形成了闭包，无论是否被返回。</p>
<pre><code class="hljs language-ini" lang="ini">let <span class="hljs-attr">globalVar</span> = <span class="hljs-string">'global'</span><span class="hljs-comment">;</span>


function outer() {
  let <span class="hljs-attr">outerVar</span> = <span class="hljs-string">'outer'</span><span class="hljs-comment">;</span>
  
  function inner() {
    console.log(globalVar, outerVar)<span class="hljs-comment">; // 访问了外部变量 → 闭包</span>
  }
  
  inner()<span class="hljs-comment">; // 即使没有返回，inner 也是闭包</span>
}


outer()<span class="hljs-comment">;</span>
</code></pre>
<h3 data-id="heading-12">4.2 误区二：“闭包会导致内存泄漏”</h3>
<p><strong>不完全正确。</strong> 闭包确实会延长变量的生命周期，但这<strong>不是内存泄漏</strong>，而是预期行为。</p>
<p>真正的内存泄漏是指：<strong>无用的数据因错误引用而无法被垃圾回收</strong>。</p>
<p>例如：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">setup</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> largeData = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Array</span>(<span class="hljs-number">1000000</span>).<span class="hljs-title function_">fill</span>(<span class="hljs-string">'*'</span>);
  
  <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'button'</span>).<span class="hljs-property">onclick</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Clicked'</span>);
    <span class="hljs-comment">// 即使没用到 largeData，闭包仍会持有它！</span>
  };
}
</code></pre>
<p>这里点击事件处理函数形成了闭包，无意中持有了 <code>largeData</code> 的引用，导致本可释放的大数组一直驻留内存。</p>
<p><strong>解决方案</strong>：显式断开引用</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">setup</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> largeData = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Array</span>(<span class="hljs-number">1000000</span>).<span class="hljs-title function_">fill</span>(<span class="hljs-string">'*'</span>);
  
  <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'button'</span>).<span class="hljs-property">onclick</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Clicked'</span>);
  };
  
  <span class="hljs-comment">// 不再需要 largeData</span>
  largeData = <span class="hljs-literal">null</span>;
}
</code></pre>
<h3 data-id="heading-13">4.3 经典陷阱：循环中的闭包</h3>
<pre><code class="hljs language-css" lang="css">for (<span class="hljs-selector-tag">var</span> <span class="hljs-selector-tag">i</span> = <span class="hljs-number">0</span>; <span class="hljs-selector-tag">i</span> &lt; <span class="hljs-number">3</span>; <span class="hljs-selector-tag">i</span>++) {
  setTimeout(() =&gt; {
    console<span class="hljs-selector-class">.log</span>(<span class="hljs-selector-tag">i</span>); // 输出: <span class="hljs-number">3</span>, <span class="hljs-number">3</span>, <span class="hljs-number">3</span>
  }, <span class="hljs-number">100</span>);
}
</code></pre>
<p><strong>原因</strong>：<code>var</code> 声明的 <code>i</code> 是函数作用域，所有闭包共享同一个 <code>i</code>。当 <code>setTimeout</code> 执行时，循环早已结束，<code>i = 3</code>。</p>
<p><strong>解决方案</strong>：</p>
<h4 data-id="heading-14">方案一：使用 <code>let</code>（块级作用域）</h4>
<pre><code class="hljs language-css" lang="css">for (let <span class="hljs-selector-tag">i</span> = <span class="hljs-number">0</span>; <span class="hljs-selector-tag">i</span> &lt; <span class="hljs-number">3</span>; <span class="hljs-selector-tag">i</span>++) {
  setTimeout(() =&gt; {
    console<span class="hljs-selector-class">.log</span>(<span class="hljs-selector-tag">i</span>); // 输出: <span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2</span>
  }, <span class="hljs-number">100</span>);
}
</code></pre>
<p><code>let</code> 为每次迭代创建新的绑定，每个闭包捕获的是不同的 <code>i</code>。</p>
<h4 data-id="heading-15">方案二：IIFE（立即调用函数表达式）</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">3</span>; i++) {
  (<span class="hljs-keyword">function</span>(<span class="hljs-params">j</span>) {
    <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(j); <span class="hljs-comment">// 输出: 0, 1, 2</span>
    }, <span class="hljs-number">100</span>);
  })(i);
}
</code></pre>
<h4 data-id="heading-16">方案三：<code>bind</code> 传参</h4>
<pre><code class="hljs language-css" lang="css">for (<span class="hljs-selector-tag">var</span> <span class="hljs-selector-tag">i</span> = <span class="hljs-number">0</span>; <span class="hljs-selector-tag">i</span> &lt; <span class="hljs-number">3</span>; <span class="hljs-selector-tag">i</span>++) {
  setTimeout(console<span class="hljs-selector-class">.log</span><span class="hljs-selector-class">.bind</span>(null, <span class="hljs-selector-tag">i</span>), <span class="hljs-number">100</span>);
}
</code></pre>
<p> </p>
<h2 data-id="heading-17">五、闭包的实际应用场景</h2>
<h3 data-id="heading-18">5.1 模块模式（Module Pattern）</h3>
<p>利用闭包实现<strong>私有变量和公共接口</strong>：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> <span class="hljs-title class_">CounterModule</span> = (<span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">let</span> count = <span class="hljs-number">0</span>; <span class="hljs-comment">// 私有变量</span>
  
  <span class="hljs-keyword">return</span> {
    <span class="hljs-attr">increment</span>: <span class="hljs-function">() =&gt;</span> ++count,
    <span class="hljs-attr">decrement</span>: <span class="hljs-function">() =&gt;</span> --count,
    <span class="hljs-attr">getCount</span>: <span class="hljs-function">() =&gt;</span> count
  };
})();


<span class="hljs-comment">// 外部无法直接访问 count</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title class_">CounterModule</span>.<span class="hljs-title function_">getCount</span>()); <span class="hljs-comment">// 0</span>
<span class="hljs-title class_">CounterModule</span>.<span class="hljs-title function_">increment</span>();
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title class_">CounterModule</span>.<span class="hljs-title function_">getCount</span>()); <span class="hljs-comment">// 1</span>
</code></pre>
<p>这是 ES6 模块出现前最流行的封装方式。</p>
<h3 data-id="heading-19">5.2 函数柯里化（Currying）</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">multiply</span>(<span class="hljs-params">a</span>) {
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">function</span>(<span class="hljs-params">b</span>) {
    <span class="hljs-keyword">return</span> a * b;
  };
}


<span class="hljs-keyword">const</span> double = <span class="hljs-title function_">multiply</span>(<span class="hljs-number">2</span>);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title function_">double</span>(<span class="hljs-number">5</span>)); <span class="hljs-comment">// 10</span>


<span class="hljs-comment">// 或使用箭头函数</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">multiply</span> = a =&gt; <span class="hljs-function"><span class="hljs-params">b</span> =&gt;</span> a * b;
</code></pre>
<p>每个返回的函数都闭包了 <code>a</code> 的值。</p>
<h3 data-id="heading-20">5.3 防抖（Debounce）与节流（Throttle）</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">debounce</span>(<span class="hljs-params">func, delay</span>) {
  <span class="hljs-keyword">let</span> timeoutId;
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">function</span>(<span class="hljs-params">...args</span>) {
    <span class="hljs-built_in">clearTimeout</span>(timeoutId);
    timeoutId = <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> func.<span class="hljs-title function_">apply</span>(<span class="hljs-variable language_">this</span>, args), delay);
  };
}


<span class="hljs-keyword">const</span> debouncedSearch = <span class="hljs-title function_">debounce</span>(searchAPI, <span class="hljs-number">300</span>);
input.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'input'</span>, debouncedSearch);
</code></pre>
<p><code>debounce</code> 返回的函数闭包了 <code>timeoutId</code> 和 <code>func</code>，实现了状态保持。</p>
<h3 data-id="heading-21">5.4 事件处理器中的参数传递</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">attachListeners</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> buttons = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelectorAll</span>(<span class="hljs-string">'.btn'</span>);
  
  buttons.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">button, index</span>) =&gt;</span> {
    button.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'click'</span>, <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`Button <span class="hljs-subst">${index}</span> clicked`</span>); <span class="hljs-comment">// 闭包捕获 index</span>
    });
  });
}
</code></pre>
<p>若不用闭包，很难在事件回调中获取循环索引。</p>
<h3 data-id="heading-22">5.5 缓存（Memoization）</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">memoize</span>(<span class="hljs-params">fn</span>) {
  <span class="hljs-keyword">const</span> cache = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>();
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">function</span>(<span class="hljs-params">...args</span>) {
    <span class="hljs-keyword">const</span> key = <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(args);
    <span class="hljs-keyword">if</span> (cache.<span class="hljs-title function_">has</span>(key)) {
      <span class="hljs-keyword">return</span> cache.<span class="hljs-title function_">get</span>(key);
    }
    <span class="hljs-keyword">const</span> result = fn.<span class="hljs-title function_">apply</span>(<span class="hljs-variable language_">this</span>, args);
    cache.<span class="hljs-title function_">set</span>(key, result);
    <span class="hljs-keyword">return</span> result;
  };
}


<span class="hljs-keyword">const</span> fib = <span class="hljs-title function_">memoize</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params">n</span>) {
  <span class="hljs-keyword">if</span> (n &lt;= <span class="hljs-number">1</span>) <span class="hljs-keyword">return</span> n;
  <span class="hljs-keyword">return</span> <span class="hljs-title function_">fib</span>(n - <span class="hljs-number">1</span>) + <span class="hljs-title function_">fib</span>(n - <span class="hljs-number">2</span>);
});
</code></pre>
<p>缓存对象 <code>cache</code> 被闭包保护，避免全局污染。</p>
<p> </p>
<h2 data-id="heading-23">六、闭包与 <code>this</code> 的交互</h2>
<p>闭包会捕获变量，但<strong>不会捕获</strong> <code>this</code>。<code>this</code> 的绑定取决于调用方式。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> obj = {
  <span class="hljs-attr">name</span>: <span class="hljs-string">'Alice'</span>,
  <span class="hljs-attr">greet</span>: <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> sayHello = <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span>); <span class="hljs-comment">// undefined! this 指向全局</span>
    };
    <span class="hljs-title function_">sayHello</span>();
  }
};


obj.<span class="hljs-title function_">greet</span>();
</code></pre>
<p><strong>解决方案</strong>：</p>
<h4 data-id="heading-24">使用箭头函数（继承外层 this）</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> obj = {
  <span class="hljs-attr">name</span>: <span class="hljs-string">'Alice'</span>,
  <span class="hljs-attr">greet</span>: <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> <span class="hljs-title function_">sayHello</span> = (<span class="hljs-params"/>) =&gt; {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span>); <span class="hljs-comment">// 'Alice'</span>
    };
    <span class="hljs-title function_">sayHello</span>();
  }
};
</code></pre>
<h4 data-id="heading-25">显式绑定</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> obj = {
  <span class="hljs-attr">name</span>: <span class="hljs-string">'Alice'</span>,
  <span class="hljs-attr">greet</span>: <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> self = <span class="hljs-variable language_">this</span>; <span class="hljs-comment">// 闭包捕获 self</span>
    <span class="hljs-keyword">const</span> sayHello = <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(self.<span class="hljs-property">name</span>); <span class="hljs-comment">// 'Alice'</span>
    };
    <span class="hljs-title function_">sayHello</span>();
  }
};
</code></pre>
<p> </p>
<h2 data-id="heading-26">七、性能考量与最佳实践</h2>
<h3 data-id="heading-27">7.1 内存占用</h3>
<p>闭包会阻止变量被垃圾回收，因此：</p>
<ul>
<li><strong>避免不必要的闭包</strong>：如果函数不需要访问外部变量，不要嵌套定义</li>
<li><strong>及时释放大对象引用</strong>：如前述 <code>largeData = null</code> 的例子</li>
</ul>
<h3 data-id="heading-28">7.2 调试困难</h3>
<p>闭包中的变量在调试器中可能显示为 <code>[[Scopes]]</code>，不易查看。建议：</p>
<ul>
<li>使用有意义的变量名</li>
<li>避免过深的嵌套</li>
</ul>
<h3 data-id="heading-29">7.3 最佳实践总结</h3>
<ol>
<li><strong>理解作用域链</strong>：清楚知道变量从哪里来</li>
<li><strong>谨慎使用闭包</strong>：只在需要保持状态或封装私有数据时使用</li>
<li><strong>注意循环陷阱</strong>：优先使用 <code>let</code> 而非 <code>var</code></li>
<li><strong>管理内存</strong>：及时解除对大型数据的引用</li>
<li><strong>利用现代语法</strong>：箭头函数简化 <code>this</code> 问题</li>
</ol>
<p> </p>
<h2 data-id="heading-30">八、闭包在现代 JavaScript 中的演进</h2>
<h3 data-id="heading-31">8.1 与块级作用域的协同</h3>
<p>ES6 的 <code>let</code>/<code>const</code> 与闭包结合，解决了经典循环问题，使代码更安全。</p>
<h3 data-id="heading-32">8.2 与模块系统的融合</h3>
<p>ES6 模块（ESM）本质上是<strong>顶级闭包</strong>：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// math.js</span>
<span class="hljs-keyword">let</span> privateVar = <span class="hljs-number">0</span>; <span class="hljs-comment">// 模块作用域，外部不可见</span>


<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">increment</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">return</span> ++privateVar; <span class="hljs-comment">// 闭包访问 privateVar</span>
}
</code></pre>
<p>每个模块文件形成独立作用域，天然支持私有状态。</p>
<h3 data-id="heading-33">8.3 在 React Hooks 中的应用</h3>
<p>React 的 <code>useState</code>、<code>useEffect</code> 等 Hook 依赖闭包实现状态管理：</p>
<pre><code class="hljs language-scss" lang="scss">function <span class="hljs-built_in">Counter</span>() {
  const <span class="hljs-selector-attr">[count, setCount]</span> = <span class="hljs-built_in">useState</span>(<span class="hljs-number">0</span>);
  
  <span class="hljs-built_in">useEffect</span>(() =&gt; {
    const timer = <span class="hljs-built_in">setInterval</span>(() =&gt; {
      <span class="hljs-built_in">setCount</span>(c =&gt; c + <span class="hljs-number">1</span>); <span class="hljs-comment">// 闭包捕获 setCount</span>
    }, <span class="hljs-number">1000</span>);
    return () =&gt; <span class="hljs-built_in">clearInterval</span>(timer);
  }, <span class="hljs-selector-attr">[]</span>); <span class="hljs-comment">// 依赖项为空，只在挂载时执行</span>
  
  return &lt;<span class="hljs-selector-tag">div</span>&gt;{count}&lt;/<span class="hljs-selector-tag">div</span>&gt;;
}
</code></pre>
<p>若在 <code>setInterval</code> 回调中直接使用 <code>count</code>，会因闭包捕获旧值导致 bug，因此需使用函数式更新。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Vite 5大优化技巧：让你的构建速度飙升50%，开发者都在偷偷用！]]></title>    <link>https://juejin.cn/post/7585452404112801807</link>    <guid>https://juejin.cn/post/7585452404112801807</guid>    <pubDate>2025-12-20T04:16:30.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585452404112801807" data-draft-id="7585458459165818914" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Vite 5大优化技巧：让你的构建速度飙升50%，开发者都在偷偷用！"/> <meta itemprop="keywords" content="后端,前端,人工智能"/> <meta itemprop="datePublished" content="2025-12-20T04:16:30.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="阿橙的百宝箱"/> <meta itemprop="url" content="https://juejin.cn/user/1638743356481367"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Vite 5大优化技巧：让你的构建速度飙升50%，开发者都在偷偷用！
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1638743356481367/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    阿橙的百宝箱
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-20T04:16:30.000Z" title="Sat Dec 20 2025 04:16:30 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0"><strong>Vite 5大优化技巧：让你的构建速度飙升50%，开发者都在偷偷用！</strong></h2>
<h2 data-id="heading-1">引言</h2>
<p>在前端开发领域，构建工具的性能直接影响开发体验和生产力。Vite 作为新一代前端构建工具，凭借其原生 ESM 支持和极速的热更新能力，已经成为许多开发者的首选。然而，即使是性能优异的 Vite，在实际项目中也可能因为配置不当或使用方式欠佳而未能发挥全部潜力。本文将深入剖析 5 个经过实战检验的 Vite 优化技巧，帮助你将构建速度提升高达 50%，这些方法正在被众多高效能团队秘密使用。</p>
<h2 data-id="heading-2">主体</h2>
<h3 data-id="heading-3">1. 精准配置依赖预构建（OptimizeDeps）</h3>
<h4 data-id="heading-4">问题背景</h4>
<p>Vite 的核心优势之一是其依赖预构建机制，它将 CommonJS/UMD 模块转换为 ESM 格式并缓存以提高后续加载速度。然而，默认配置可能无法完美适应所有项目。</p>
<h4 data-id="heading-5">优化方案</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// vite.config.js</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title function_">defineConfig</span>({
  <span class="hljs-attr">optimizeDeps</span>: {
    <span class="hljs-attr">include</span>: [
      <span class="hljs-string">'vue'</span>,
      <span class="hljs-string">'pinia'</span>,
      <span class="hljs-string">'vue-router'</span>,
      <span class="hljs-comment">// 明确列出高频使用的大型库</span>
      <span class="hljs-string">'lodash-es'</span>,
      <span class="hljs-string">'axios'</span>
    ],
    <span class="hljs-attr">exclude</span>: [<span class="hljs-string">'某些不需要预构建的库'</span>],
    <span class="hljs-attr">force</span>: process.<span class="hljs-property">env</span>.<span class="hljs-property">NODE_ENV</span> === <span class="hljs-string">'development'</span> ? <span class="hljs-literal">false</span> : <span class="hljs-literal">true</span>
  }
})
</code></pre>
<h4 data-id="heading-6">技术细节</h4>
<ul>
<li><strong>include</strong>：主动声明需要预构建的依赖项可以避免自动探测的开销</li>
<li><strong>force</strong>：生产环境强制重新构建确保一致性</li>
<li><strong>esbuildOptions</strong>：可通过此参数调整 ESBuild 的配置（如 target）</li>
</ul>
<p>实测数据：在包含50+依赖项的中型项目中，此项优化可减少15%-20%的冷启动时间。</p>
<h3 data-id="heading-7">2. Smart CSS Code Splitting</h3>
<h4 data-id="heading-8">CSS处理的瓶颈</h4>
<p>传统打包器会将所有CSS合并成单个文件，导致首屏加载不必要的样式代码。</p>
<h4 data-id="heading-9">Vite高级解决方案</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// vite.config.js</span>
<span class="hljs-keyword">import</span> { splitVendorChunkPlugin } <span class="hljs-keyword">from</span> <span class="hljs-string">'vite'</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title function_">defineConfig</span>({
  <span class="hljs-attr">css</span>: {
    <span class="hljs-attr">devSourcemap</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-attr">postcss</span>: {
      <span class="hljs-comment">// PostCSS配置...</span>
    },
    <span class="hljs-attr">modules</span>: {
      <span class="hljs-attr">localsConvention</span>: <span class="hljs-string">'camelCaseOnly'</span>
    }
  },
  
})
</code></pre>
<p>结合以下实践：</p>
<ul>
<li><code>@import</code>替换为ESM导入（支持Tree Shaking）</li>
<li>CSS Modules自动作用域处理减少冗余代码</li>
<li>build.cssCodeSplit保持启用（默认true）</li>
</ul>
<p>效果验证：某电商项目应用后CSS体积减少38%，关键路径CSS缩减62%。</p>
<h3 data-id="heading-10">3. Advanced Cache Strategy</h3>
<h4 data-id="heading-11">Vite缓存机制深度利用</h4>
<p>Vite默认缓存位置在node_modules/.vite：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># Linux/MacOS用户可将缓存移至内存文件系统</span>
<span class="hljs-built_in">export</span> VITE_CACHE_DIR=/dev/shm/vite_cache

<span class="hljs-comment"># Windows用户可用RAMDisk工具实现类似效果</span>
</code></pre>
<h4 data-id="heading-12">Programmatic Cache Control示例：</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> { createServer } <span class="hljs-keyword">from</span> <span class="hljs-string">'vite'</span>

<span class="hljs-keyword">const</span> server = <span class="hljs-keyword">await</span> <span class="hljs-title function_">createServer</span>({
  
})

server.<span class="hljs-property">watcher</span>.<span class="hljs-title function_">on</span>(<span class="hljs-string">'change'</span>, <span class="hljs-keyword">async</span> (file) =&gt; {
  
})
</code></pre>
<p>实际案例：某金融系统通过定制化缓存策略使HMR更新时间从1200ms降至400ms。</p>
<h3 data-id="heading-13">### ###4. Fine-Tuned Build Parallelism</h3>
<h4 data-id="heading-14">ESBuild多核优化秘诀：</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// vite.config.js</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title function_">defineConfig</span>({
  
}) 
</code></pre>
<p>需要配合以下环境变量：</p>
<pre><code class="hljs language-bash" lang="bash">

</code></pre>
<p>基准测试对比：</p>














<table><thead><tr><th>Worker数量</th><th>Build时间(s)</th><th>Memory占用</th></tr></thead><tbody><tr><td>Default(4)</td><td/></tr></tbody></table>
<h2 data-id="heading-15">##总结</h2></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[鸿蒙 SDK 发布实战：JWorker 上架 ohpm 全流程]]></title>    <link>https://juejin.cn/post/7585390679398989830</link>    <guid>https://juejin.cn/post/7585390679398989830</guid>    <pubDate>2025-12-20T04:42:58.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585390679398989830" data-draft-id="7585400495682994218" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="鸿蒙 SDK 发布实战：JWorker 上架 ohpm 全流程"/> <meta itemprop="keywords" content="HarmonyOS,ArkTS,TypeScript"/> <meta itemprop="datePublished" content="2025-12-20T04:42:58.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="江澎涌"/> <meta itemprop="url" content="https://juejin.cn/user/1820446986338504"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            鸿蒙 SDK 发布实战：JWorker 上架 ohpm 全流程
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1820446986338504/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    江澎涌
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-20T04:42:58.000Z" title="Sat Dec 20 2025 04:42:58 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    15
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">零、前言</h2>
<p>分享一次完整的鸿蒙 HAR SDK 发布过程，以前几天发布的 <code>JWorker</code> SDK 为例。</p>
<blockquote>
<p><code>JWorker</code> 是一套简单易用的基于鸿蒙 Worker 的双向 RPC 通讯机制。</p>
<p>库地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fohpm.openharmony.cn%2F%23%2Fcn%2Fdetail%2Fjworker" target="_blank" title="https://ohpm.openharmony.cn/#/cn/detail/jworker" ref="nofollow noopener noreferrer">ohpm.openharmony.cn/#/cn/detail…</a></p>
<p>仓库地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FzincPower%2FJWorker" target="_blank" title="https://github.com/zincPower/JWorker" ref="nofollow noopener noreferrer">github.com/zincPower/J…</a></p>
</blockquote>
<p>话不多说，接下来分享每一步的操作细节。</p>
<h2 data-id="heading-1">一、添加 README.md、CHANGELOG.md、LICENSE 文件</h2>
<p><strong>在发布的模块中添加这三个文件，需要与模块的 <code>src</code> 文件夹同层级。</strong> 具体结构如下图所示：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8c33f55082134940919c79053252c504~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rGf5r6O5raM:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766811587&amp;x-signature=jnPAwj%2FnnxuABZllC2ukPg9PZaw%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-2">1、README.md 文件</h3>
<p>内容描述 SDK 怎么被安装和使用，还有个人或团队的介绍等。<strong>描述内容一定要包含 <code>ohpm install &lt;你发布的 SDK 名称&gt;</code></strong> ，否则上架审核时会被拒绝，并收到以下错误。</p>
<pre><code class="hljs language-css" lang="css">README<span class="hljs-selector-class">.md</span>中未包含安装命令：ohpm install xxx或ohpm <span class="hljs-selector-tag">i</span> xxx；
</code></pre>
<h3 data-id="heading-3">2、CHANGELOG.md 文件</h3>
<p>用于记录 SDK 每个版本的发布时间和修改内容。</p>
<h3 data-id="heading-4">3、LICENSE 开源许可证</h3>
<p>选择合适的开源许可证类型，例如：MIT、Apache-2.0 等。</p>
<blockquote>
<p>MIT：<a href="https://link.juejin.cn?target=https%3A%2F%2Fchoosealicense.com%2Flicenses%2Fmit%2F" target="_blank" title="https://choosealicense.com/licenses/mit/" ref="nofollow noopener noreferrer">choosealicense.com/licenses/mi…</a>
Apache-2.0：<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.apache.org%2Flicenses%2FLICENSE-2.0.txt" target="_blank" title="https://www.apache.org/licenses/LICENSE-2.0.txt" ref="nofollow noopener noreferrer">www.apache.org/licenses/LI…</a></p>
</blockquote>
<p>具体内容可以从上面的链接中拷贝然后修改。以 MIT 为例，需要修改 <code>[year]</code> 和 <code>[fullname]</code> 两个值。</p>
<p><strong>值得注意：</strong></p>
<ul>
<li><code>[fullname]</code> 必须和 SDK 的 <code>oh-package.json5</code> 中 <code>name</code> 的值完全一致，否则上架审核时会被拒绝，并收到以下错误。</li>
</ul>

<pre><code class="hljs language-go" lang="go">LICENSE文件中许可证条款内容和oh-<span class="hljs-keyword">package</span>.json5文件中许可证名称不一致；
</code></pre>
<ul>
<li>修改 <code>oh-package.json5</code> 的 <code>license</code> 的类型，默认是 <code>Apache-2.0</code> ，<code>JWorker</code> 使用的是 <code>MIT</code> 所以需要进行修改。否则还是会报上面的错误。</li>
</ul>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-comment">// 省略其他</span>
  <span class="hljs-attr">"license"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"MIT"</span><span class="hljs-punctuation">,</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h3 data-id="heading-5">4、让你的项目评分更高</h3>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2ca6986e68454a49a0ef0a09b6ba5be4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rGf5r6O5raM:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766811587&amp;x-signature=CXz73NcDzjnk834sX9XHWj%2BuE70%3D" alt="" loading="lazy"/></p>
<p>如果想让 SDK 评分得满 50 分，则必须满足以下两点：</p>
<p>1、在 <code>oh-package.json5</code> 配置 <code>author</code>、<code>keywords</code>、<code>homepage</code> 和 <code>repository</code>，具体作用请看下面 json 配置。</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-comment">// 项目名称</span>
  <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"jworker"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-comment">// 版本</span>
  <span class="hljs-attr">"version"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"1.0.1"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"description"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"一套简单易用的基于鸿蒙 Worker 的双向 RPC 通讯机制"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"main"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Index.ets"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-comment">// 作者</span>
  <span class="hljs-attr">"author"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"江澎涌"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-comment">// 开源协议类型</span>
  <span class="hljs-attr">"license"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"MIT"</span><span class="hljs-punctuation">,</span>                                             
  <span class="hljs-attr">"dependencies"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span><span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-comment">// 关键字，能够让你的仓库被搜索到</span>
  <span class="hljs-attr">"keywords"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>                                             
    <span class="hljs-string">"harmonyos"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-string">"worker"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-string">"rpc"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-string">"communication"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-string">"thread"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-string">"多线程"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-string">"emitter"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-string">"线程通讯"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
  <span class="hljs-comment">// 主页</span>
  <span class="hljs-attr">"homepage"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"https://github.com/zincPower"</span><span class="hljs-punctuation">,</span>               
  <span class="hljs-comment">// 代码仓库</span>
  <span class="hljs-attr">"repository"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"https://github.com/zincPower/JWorker"</span><span class="hljs-punctuation">,</span>     
<span class="hljs-punctuation">}</span>
</code></pre>
<p>2、创建 example 目录，可以根据情况增加 README.md 和示例代码。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/dca69f4bc0674b20914649496d1e23ca~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rGf5r6O5raM:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766811587&amp;x-signature=j54LFJY6rrGmogZt8MfhZzfTRLw%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-6">二、生成密钥</h2>
<p>通过以下命令生成密钥</p>
<pre><code class="hljs language-css" lang="css">ssh-keygen -m PEM -t RSA -<span class="hljs-selector-tag">b</span> <span class="hljs-number">4096</span> -f /<span class="hljs-selector-attr">[存放路径]</span>/<span class="hljs-selector-attr">[密钥名称]</span>
</code></pre>
<p>例如生成一个名称为 <code>ohos_publish_key</code> 的密钥，可以使用 <code>ssh-keygen -m PEM -t RSA -b 4096 -f ohos_publish_key</code> 进行生成，<strong>期间必须设置密钥密码，否则 OHPM 包管理器会拒绝。</strong> 过程如下图：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/303817fba07c4dc7890675fdedd1677e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rGf5r6O5raM:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766811587&amp;x-signature=nItvGZ4NcyBzG89PE0zwG5UKcy8%3D" alt="" loading="lazy"/></p>
<p>运行后会生成两个文件，私钥 <code>ohos_publish_key</code> 和 公钥 <code>ohos_publish_key.pub</code> 。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b438752956d84f479d91b287aceb985d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rGf5r6O5raM:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766811587&amp;x-signature=nhsCG4Rwbt%2B%2BghhzLvG9JWyZUXE%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-7">三、提交公钥</h2>
<p>进入到 <a href="https://link.juejin.cn?target=https%3A%2F%2Fohpm.openharmony.cn%2F%23%2Fcn%2FpersonalCenter%2FsshKeys" target="_blank" title="https://ohpm.openharmony.cn/#/cn/personalCenter/sshKeys" ref="nofollow noopener noreferrer">OpenHarmony 三方库中心仓的 “个人中心-认证管理”</a>，根据下图所示，在 “认证管理-新增” 的弹框中填入刚才生成的公钥 <code>ohos_publish_key.pub</code> 的内容然后保存。</p>
<blockquote>
<p>如果没有 OpenHarmony 三方库中心仓的帐号先进行注册，这里就不再赘述。</p>
</blockquote>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/37141d9286d04623812ff989365ac284~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rGf5r6O5raM:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766811587&amp;x-signature=0OzZ95feus2k4emNgYR6RnDK7Xc%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-8">四、本地配置私钥</h2>
<p>将刚生成的私钥 <code>ohos_publish_key</code> 进行配置，配置命令如下</p>
<pre><code class="hljs language-arduino" lang="arduino">ohpm config set key_path [ohos_publish_key 的路径]
</code></pre>
<p><strong>输入后如果遇到 <code>zsh: command not found: ohpm</code> 说明需要配置 ohpm</strong>，通过 <code>open ~/.zshrc</code> 打开配置，添加以下配置即可</p>
<pre><code class="hljs language-ini" lang="ini">export <span class="hljs-attr">OHPM_PATH</span>=/Users/[你的 mac 用户名]/Library/Huawei/ohpm/bin
export <span class="hljs-attr">PATH</span>=<span class="hljs-variable">${PATH}</span>:<span class="hljs-variable">${OHPM_PATH}</span>
</code></pre>
<p>配置后运行 <code>source ~/.zshrc</code> 或是重新打开 terminal 再次运行配置私钥命令即可。</p>
<h2 data-id="heading-9">五、配置发布码</h2>
<p>进入到 <a href="https://link.juejin.cn?target=https%3A%2F%2Fohpm.openharmony.cn%2F%23%2Fcn%2FpersonalCenter%2Fnotifications" target="_blank" title="https://ohpm.openharmony.cn/#/cn/personalCenter/notifications" ref="nofollow noopener noreferrer">OpenHarmony 三方库中心仓的 “个人中心”</a> 在下图位置复制发布码</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b452e0bfbfdb4cfc905fa2e8d04cd11a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rGf5r6O5raM:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766811587&amp;x-signature=GG5cw23plJ0owXdGSf8%2BASj5nVw%3D" alt="" loading="lazy"/></p>
<p>然后在 terminal 输入以下命令进行配置</p>
<pre><code class="hljs language-arduino" lang="arduino">ohpm config set publish_id [刚刚获取的发布码]
</code></pre>
<h2 data-id="heading-10">六、编译发布的 har 包</h2>
<p>在鸿蒙的开发 ide 中，先进行 <code>Build - Clean Project</code> 打扫项目，然后 <code>Build - Make Module '你的模块名'</code> 进行 HAR 包编译，如下图所示</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7c1fe89a7fab4913b199fe2586c81834~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rGf5r6O5raM:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766811587&amp;x-signature=jV38xm7077CxMIovk0nKVTCKjgI%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-11">七、发布 har 包</h2>
<p>进入到上图所示的 <code>default</code> 目录下，然后运行 <code>ohpm publish jworker.har</code> 进行发布，过程需要输入密钥的密码，输入后就完成了。过程如下图所示：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ea662e905f284c15bc95de0bfb105248~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rGf5r6O5raM:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766811587&amp;x-signature=Y7f4KwO3wtbHn5aQgdNOL3mVnzI%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-12">八、查看发布情况</h2>
<p>回到 <a href="https://link.juejin.cn?target=https%3A%2F%2Fohpm.openharmony.cn%2F%23%2Fcn%2FpersonalCenter%2Fnotifications" target="_blank" title="https://ohpm.openharmony.cn/#/cn/personalCenter/notifications" ref="nofollow noopener noreferrer">OpenHarmony 三方库中心仓的 “个人中心”</a> 就可以看到对应的消息提示了，后续多留意 SDK 的审核情况。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4f66a5a842af43cd84ab25bff6275343~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rGf5r6O5raM:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766811587&amp;x-signature=hzpOhPh9xmB9dwOW3m4ub4pG7vc%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-13">九、官方文档</h2>
<p>发布共享包：<a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.huawei.com%2Fconsumer%2Fcn%2Fdoc%2Fharmonyos-guides%2Fide-har-publish" target="_blank" title="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/ide-har-publish" ref="nofollow noopener noreferrer">developer.huawei.com/consumer/cn…</a></p>
<p>编译HAR模块：<a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.huawei.com%2Fconsumer%2Fcn%2Fdoc%2Fharmonyos-guides%2Fide-har%23section7892044183814" target="_blank" title="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/ide-har#section7892044183814" ref="nofollow noopener noreferrer">developer.huawei.com/consumer/cn…</a></p>
<h2 data-id="heading-14">十、作者博客</h2>
<p>掘金：<a href="https://juejin.cn/user/1820446986338504" target="_blank" title="https://juejin.cn/user/1820446986338504">juejin.cn/user/182044…</a></p>
<p>csdn：<a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.csdn.net%2Fweixin_37625173" target="_blank" title="https://blog.csdn.net/weixin_37625173" ref="nofollow noopener noreferrer">blog.csdn.net/weixin_3762…</a></p>
<p>公众号：微信搜索 "江澎涌"</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/95f0c6d5e0964c9795f3e8f5897f8311~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rGf5r6O5raM:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766811587&amp;x-signature=%2Fe3VOoCeHwS8JOFzL7u72ZRPmxQ%3D" alt="" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Android AI解放生产力（五）实战：解放写API接口的繁琐工作]]></title>    <link>https://juejin.cn/post/7585289701793677338</link>    <guid>https://juejin.cn/post/7585289701793677338</guid>    <pubDate>2025-12-19T05:58:46.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585289701793677338" data-draft-id="7585005164726386726" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Android AI解放生产力（五）实战：解放写API接口的繁琐工作"/> <meta itemprop="keywords" content="Android"/> <meta itemprop="datePublished" content="2025-12-19T05:58:46.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="TimeFine"/> <meta itemprop="url" content="https://juejin.cn/user/3913917123802615"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Android AI解放生产力（五）实战：解放写API接口的繁琐工作
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3913917123802615/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    TimeFine
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-19T05:58:46.000Z" title="Fri Dec 19 2025 05:58:46 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-19
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    35
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读10分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="androidstudio">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#a9b7c6;background:#282b2e}.hljs-bullet,.hljs-literal,.hljs-number,.hljs-symbol{color:#6897bb}.hljs-deletion,.hljs-keyword,.hljs-selector-tag{color:#cc7832}.hljs-link,.hljs-template-variable,.hljs-variable{color:#629755}.hljs-comment,.hljs-quote{color:grey}.hljs-meta{color:#bbb529}.hljs-addition,.hljs-attribute,.hljs-string{color:#6a8759}.hljs-section,.hljs-title,.hljs-type{color:#ffc66d}.hljs-name,.hljs-selector-class,.hljs-selector-id{color:#e8bf6a}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>公司当前项目使用的是Apifox作为API调试/文档工具，所以以这个为例。市面上的工具应该都逐步开放了AI能力，需要关注一下，只要能提供原始数据就行，不能的话那也没办法喂给AI。</p>
<p>上一篇已经让AI写UI了，这一篇让AI写接口请求。首先思考一下可能碰到的问题。</p>
<h2 data-id="heading-0">一、可能遇到的问题</h2>
<p>默认网络请求用的retrofit，其它也是一通百通。</p>
<h3 data-id="heading-1">1、问题一：适配请求头</h3>
<p>项目中网络请求的拦截器已经定义了请求头，读取的原始数据如何关联？答案就是在skill中告诉AI，并让它模仿你的代码写。</p>
<h3 data-id="heading-2">2、问题二：适配请求参数中有一些公共部分</h3>
<p>项目中网络请求的拦截器已经定义了一些公共请求参数，读取的原始数据如何关联？例如：</p>
<pre><code class="hljs language-kotlin" lang="kotlin">{
    <span class="hljs-string">"app"</span>: {
        <span class="hljs-string">"locale"</span>: <span class="hljs-string">"{{locale}}"</span>,
        <span class="hljs-string">"tid"</span>: <span class="hljs-string">"{{terminal_id}}"</span>,
        <span class="hljs-string">"platform"</span>: <span class="hljs-string">"{{platform}}"</span>
    },
    <span class="hljs-string">"data"</span>: {
        <span class="hljs-comment">//每个接口只有这里有差异</span>
    }
}
</code></pre>
<p>只有data块中有差异。答案其实同上，skill中告诉AI，并让它模仿你的代码。</p>
<h3 data-id="heading-3">3、问题三：返回数据脱壳</h3>
<p>例如项目中的壳是这样：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">data</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ApiResponse</span>&lt;<span class="hljs-type">T</span>&gt;(
    <span class="hljs-keyword">val</span> code: <span class="hljs-built_in">Int</span>,
    <span class="hljs-keyword">val</span> msg: String,
    <span class="hljs-keyword">val</span> <span class="hljs-keyword">data</span>: T
) : BaseResponse&lt;T&gt;() {...}
</code></pre>
<p>那我们需要的解析的Data Class可能只需要脱壳的部分，如何让AI知道？答案也同上，skill中告诉AI，并让它模仿你的代码。</p>
<h3 data-id="heading-4">4、问题四：viewmodel中网络请求如何写</h3>
<p>道理同上。</p>
<h3 data-id="heading-5">5、问题五：代码放在哪个文件</h3>
<p>这个问题的解答要看情况了，我们先看下面只给代码的示例，最后再探讨一下这个问题。</p>
<h2 data-id="heading-6">二、获取接口原始数据</h2>
<p>这一步依赖MCP的开放能力，后端兄弟接口怎么定义的，字段怎么写的，Android如何封装Data Class都依赖这些原始数据。接下来看通过Apifox如何办到的。</p>
<p>Apifox的MCP现阶段还不能集成到Codex中使用，启动的时候会报错：</p>
<pre><code class="hljs language-kotlin" lang="kotlin">⚠ MCP client <span class="hljs-keyword">for</span> `apifox_api_docs` failed to start: MCP startup failed: handshaking with MCP server failed: connection closed: initialize response
⚠ MCP startup incomplete (failed: apifox_api_docs)
</code></pre>
<p>原因是Apifox的MCP返回不符合Codex定义的规范。</p>
<p>那换其他方式，打开Apifox终端（当前V版本2.7.58 (2.7.58)），选择需要生成代码的接口：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2912582992aa4b93981239341d8f3546~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVGltZUZpbmU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766742632&amp;x-signature=59jJlOCs9ni4MWdY7lke9mdIFbg%3D" alt="image.png" loading="lazy"/></p>
<p>如上操作，可以得到复制的一段信息如下：</p>
<pre><code class="hljs language-kotlin" lang="kotlin">请访问以下链接获取接口“天气信息V3”的接口定义信息：https:<span class="hljs-comment">//api.apifox.cn/temp-links/api/%E5%A4%A9%E6%B0%6%81%AFv3-253061517?t=e0be3ab5-e8bf-4ec2-be81-f1489</span>
</code></pre>
<p>这样我们就拿到了接口的原始数据链接。</p>
<h2 data-id="heading-7">三、如何编辑skills</h2>
<p>这一步跟项目强关联，因为每个项目写法都不一样，文件不一样，所以skill的写法因项目而异。</p>
<p>先自己手动写一份粗糙的，然后给AI帮你改一改。</p>
<p>下面贴一份自己写的粗糙的，剔除敏感信息后的skill：</p>
<pre><code class="hljs language-kotlin" lang="kotlin">---
name: api_to_request
description: 请访问链接获取接口定义信息。
---
## 请访问链接获取接口定义信息，给出如下要求的代码：

### <span class="hljs-number">1</span>、代码一：生成retrofit接口定义
`java/api` 文件夹内是定义的retrofit api 请求的接口，例如其中的一例：

<span class="hljs-comment">/**
 * 获取Camera Event事件
 */</span>
<span class="hljs-meta">@POST(<span class="hljs-string">"/v1/iot/camera/discoverXXX"</span>)</span>
<span class="hljs-keyword">suspend</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">discoverXxx</span><span class="hljs-params">(<span class="hljs-meta">@Body</span> request: <span class="hljs-type">Request</span>)</span></span>: ApiResponse&lt;Response?&gt;

请按照链接中的请求类型给出类似上面的接口定义。

### <span class="hljs-number">2</span>、代码二：给出请求的<span class="hljs-meta">@Body</span>
一般的请求数据示例是下面这样的：

{
    <span class="hljs-string">"data"</span>: {
        <span class="hljs-string">"dev_id"</span>: <span class="hljs-string">"xxx"</span>
    },
    <span class="hljs-string">"app"</span>: {
        <span class="hljs-string">"locale"</span>: <span class="hljs-string">"en_AU"</span>,
        <span class="hljs-string">"tid"</span>: <span class="hljs-string">"8AE4EC1E36904B869D03FC9BABE4C087"</span>,
        <span class="hljs-string">"alias"</span>: <span class="hljs-string">"Kevin 的 A52"</span>,
        <span class="hljs-string">"platform"</span>: <span class="hljs-string">"foxx"</span>
    }
}

为了避免每次都给出重复的参数，我在retrofit添加了一个拦截器，请参考`AddPublicParamsInterceptor.kt`文件，这里是添加公共请求参数的地方。所以<span class="hljs-meta">@Body</span>中只需要给出<span class="hljs-keyword">data</span>节点的内容即可，如果<span class="hljs-keyword">data</span>节点内的内容为空，那就不需要给出任何参数，因为`AddPublicParamsInterceptor.kt`中会默认添加`{}`.

### <span class="hljs-number">3</span>、代码三：给出返回的response
返回的数据使用`ApiResponse.kt`剥壳，所以给出的response数据应该是剥壳后的数据，一般是一个<span class="hljs-keyword">data</span> <span class="hljs-keyword">class</span>类。请参考`java/<span class="hljs-keyword">data</span>`文件夹内其他response的写法给出。

### <span class="hljs-number">4</span>、代码四：viewmodel中实际请求的代码
viewmodel中实际请求的代码请参考下面的代码给出：

    <span class="hljs-comment">/**
     * 获取设备同步授权码
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">syncAppDevice</span><span class="hljs-params">(
        buffer: <span class="hljs-type">MeshBanBindBuffer</span>,
        success: (<span class="hljs-type">Any</span>?) -&gt; <span class="hljs-type">Unit</span>,
        fail: (<span class="hljs-type">ApiHttpExceptionResponse</span>&lt;<span class="hljs-type">Any</span>?&gt;) -&gt; <span class="hljs-type">Unit</span>,
        error: (<span class="hljs-type">AppException</span>) -&gt; <span class="hljs-type">Unit</span>
    )</span></span> {
        <span class="hljs-keyword">val</span> request = SyncAppDeviceRequest(...)
        requestWithHttpException({ apiService.syncAppDevice(request) }, success = {
            success(it)
        }, fail = {
            fail(it)
        }, error = {
            error(it)
        })
    }
</code></pre>
<p>根据项目情况可以写的更丰富，更详细。</p>
<p>这一份是让AI改过后的，如下：</p>
<pre><code class="hljs language-kotlin" lang="kotlin">---
name: api_to_request
description: 请访问链接获取接口定义信息。访问用户提供的接口文档链接，解析请求/响应结构，并按项目约定生成：Retrofit 接口、<span class="hljs-meta">@Body(data 节点)</span>、剥壳后的 Response <span class="hljs-keyword">data</span> <span class="hljs-keyword">class</span>、以及优化后的 ViewModel 调用代码（全部用 Markdown 代码块输出）。
---

# 访问链接生成 Retrofit / Request / Response / ViewModel 代码

## 何时使用
当用户提供一个**接口定义链接**（Swagger/Apifox/Postman 文档/自研文档页面等），并要求按项目既定规范生成 Android(Kotlin) 网络层代码时使用。

## 输入
- 必须：接口文档链接（包含请求方式、path、请求体、返回体说明）
- 可选：项目约束/示例（已有 api service、已有 response/request 命名、字段命名风格、是否可空等）

## 输出（必须全部提供，且全部以 Markdown 代码块输出）
<span class="hljs-number">1.</span> **代码一：Retrofit 接口定义**（放入 `java/api` 对应 service）
<span class="hljs-number">2.</span> **代码二：请求 <span class="hljs-meta">@Body</span>（仅 <span class="hljs-keyword">data</span> 节点）**（Request <span class="hljs-keyword">data</span> <span class="hljs-keyword">class</span> 或 Map 形态）
<span class="hljs-number">3.</span> **代码三：剥壳后的 Response <span class="hljs-keyword">data</span> <span class="hljs-keyword">class</span>**（放入 `java/<span class="hljs-keyword">data</span>`）
<span class="hljs-number">4.</span> **代码四：ViewModel 中实际请求代码**（基于现有 `requestWithHttpException` 机制优化写法）

---

## 核心约定（严格遵守）
### A. Retrofit 接口风格
- 按接口文档的请求类型使用：`<span class="hljs-meta">@GET</span>/<span class="hljs-meta">@POST</span>/<span class="hljs-meta">@PUT</span>/<span class="hljs-meta">@DELETE</span>/...`
- 路径按文档给出，例如：`<span class="hljs-meta">@POST(<span class="hljs-string">"/v1/iot/camera/discoverEvents"</span>)</span>`
- 返回统一：`ApiResponse&lt;T?&gt;`
- KDoc 注释写清楚「做什么」
- 形参规则：
  - 若接口使用 body：使用 `<span class="hljs-meta">@Body</span> request: XxxRequest` 或 `<span class="hljs-meta">@Body</span> params: Map&lt;String, Any?&gt;`
  - 若 <span class="hljs-keyword">data</span> 节点为空：**不要要求调用方传参**
    - Retrofit 接口直接写成：`<span class="hljs-keyword">suspend</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">xxx</span><span class="hljs-params">()</span></span>: ApiResponse&lt;Resp?&gt;`
    - 或（仅在必须显式 body 的场景）使用默认空对象：`<span class="hljs-meta">@Body</span> request: Map&lt;String, Any?&gt; = emptyMap()`

### B. 请求体只给 <span class="hljs-keyword">data</span> 节点
项目通过拦截器 `AddPublicParamsInterceptor.kt` 统一注入公共字段（例如 `app.locale/tid/alias/platform` 等），因此：
- `<span class="hljs-meta">@Body</span>` 只包含 `<span class="hljs-keyword">data</span>` 的内容
- 若 `<span class="hljs-keyword">data</span>` 为空，则调用方不传任何参数（或传 `{}` 由拦截器兜底）

### C. Response 必须“剥壳后”
网络返回会被 `ApiResponse.kt` 统一剥壳，因此你输出的 Response 类只描述真正业务数据结构：
- 输出为 `<span class="hljs-keyword">data</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">XxxResponse</span>(...)`
- 字段名遵循服务端返回字段（通常是 snake_case），按项目既有写法决定是否用 `<span class="hljs-meta">@SerializedName</span>`

### D. ViewModel 请求代码要更“干净”
在不破坏现有 `requestWithHttpException` 用法前提下，优化目标：
- 减少重复样板代码
- 参数构造更明确（优先 `buildMap {}` 或 request <span class="hljs-keyword">data</span> <span class="hljs-keyword">class</span>）
- success/fail/error 的传递更简洁
- 方法命名、注释清晰一致

---

## 严格流程（每次都按此执行）
<span class="hljs-number">1.</span> **打开链接并提取接口定义**
   - 请求方式、path、query/path/header/body 结构
   - `<span class="hljs-keyword">data</span>` 节点字段清单、类型、必填/可选、枚举/限制
   - 返回体结构（剥掉外层 wrapper，仅保留业务 <span class="hljs-keyword">data</span>）
<span class="hljs-number">2.</span> **生成代码一：Retrofit 接口定义**
   - 按项目示例风格输出（参考 `java/api` 里的写法）
<span class="hljs-number">3.</span> **生成代码二：<span class="hljs-meta">@Body</span>（仅 <span class="hljs-keyword">data</span>）**
   - 若字段少且动态：用 `buildMap { put(...) }`
   - 若字段多/有嵌套：建 `XxxRequest` <span class="hljs-keyword">data</span> <span class="hljs-keyword">class</span>（只含 <span class="hljs-keyword">data</span> 字段本体，不含 app）
<span class="hljs-number">4.</span> **生成代码三：Response <span class="hljs-keyword">data</span> <span class="hljs-keyword">class</span>**
   - 仅业务字段，按返回体结构拆分嵌套类
   - 可空性：以文档标注为准；没标注时宁可保守为可空
<span class="hljs-number">5.</span> **生成代码四：ViewModel 调用（优化版）**
   - 统一用一个小型私有封装减少重复（示例见下方“推荐写法模板”）
<span class="hljs-number">6.</span> **最终输出格式固定**
   - 依次输出：代码一/二/三/四
   - 如需说明：放在代码块外的简短要点（不发散）

---

## 推荐写法模板（用于生成 ViewModel 优化版）
&gt; 你需要在生成 ViewModel 代码时尽量贴近此风格（不改变现有基础设施前提下）。

- 用一个私有方法把重复的 `requestWithHttpException(...)` 统一收敛：
  - `<span class="hljs-keyword">private</span> <span class="hljs-keyword">inline</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-type">&lt;T&gt;</span> <span class="hljs-title">call</span><span class="hljs-params">(...)</span></span>`
- 请求参数：
  - Map：`<span class="hljs-keyword">val</span> params = buildMap { put(<span class="hljs-string">"dev_id"</span>, devId) }`
  - Request：`<span class="hljs-keyword">val</span> request = XxxRequest(...)`
- success/fail/error：
  - 直接透传 lambda，不要重复 `success(it)` 这种包一层的写法

---

## 你输出时的固定结构（必须遵守）
### 代码一：Retrofit 接口定义
<span class="hljs-comment">// 放在对应 ApiService 中</span>

### 代码二：<span class="hljs-meta">@Body</span>（仅 <span class="hljs-keyword">data</span>）
<span class="hljs-comment">// XxxRequest data class 或 buildMap 示例（二选一或都给，看接口复杂度）</span>

### 代码三：Response <span class="hljs-keyword">data</span> <span class="hljs-keyword">class</span>（剥壳后）
<span class="hljs-comment">// 放在 java/data 下，参考项目现有 response 写法</span>

### 代码四：ViewModel 请求代码（优化版）
<span class="hljs-comment">// 给出可直接粘贴的 ViewModel 方法（包含必要的私有封装）</span>

---

## 质量检查清单（输出前自检）
	•	Retrofit 注解的 HTTP 方法与 path 与文档一致
	•	<span class="hljs-meta">@Body</span> 只包含 <span class="hljs-keyword">data</span> 节点，且 <span class="hljs-keyword">data</span> 为空时不强迫传参
	•	Response 已剥壳：不再包含 ApiResponse 外层结构
	•	ViewModel 代码已减少重复样板，参数构造清晰，回调透传简洁
	•	所有代码均在 Markdown 代码块中输出

如果你接下来把“接口文档链接”贴出来，我就会按这个 skill 的流程输出 **四段代码**（并直接给出优化后的 ViewModel 写法）。


</code></pre>
<p>Apifox复制链接的内容因为匹配skill的<code>description</code>，所以给出链接就可以触发上面的skill。Codex生成的代码如下(剔除了敏感信息)：</p>
<pre><code class="hljs language-kotlin" lang="kotlin">• 使用 api_to_request 技能，因为需要从接口文档生成 Retrofit 请求、请求体、响应体与 ViewModel 调用代码。(api.apifox.cn (https:<span class="hljs-comment">//api.apifox.cn/temp-links/api/</span>
  %E5%A4%A9%E6%F%A1%E6%<span class="hljs-number">81</span>%AFv3-<span class="hljs-number">253061517</span>?t=e0be3ab5-e8bf-4ec2-be81-f148d9))

  代码一：Retrofit 接口定义(api.apifox.cn (https:<span class="hljs-comment">//api.apifox.cn/temp-links/api/%E5%A4%A9%E6%A1%E6%81%AFv3-253061517?t=e0be3ab5-e8bf-4ec2-be81-</span>
  f14569))

  <span class="hljs-comment">/**
   * 天气信息V3
   */</span>
  <span class="hljs-meta">@POST(<span class="hljs-string">"/v1/iot/weather/getCurrentInfo"</span>)</span>
  <span class="hljs-keyword">suspend</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">getCurrentInfoV3</span><span class="hljs-params">(<span class="hljs-meta">@Body</span> request: <span class="hljs-type">WeatherInfoV3Request</span>)</span></span>: ApiResponse&lt;WeatherInfoV3Response?&gt;

  代码二：<span class="hljs-meta">@Body</span>（仅 <span class="hljs-keyword">data</span> 节点）(api.apifox.cn (https:<span class="hljs-comment">//api.apifox.cn/temp-links/api/%E5%A4%A9%E6%%E6%81%AFv3-253061517?t=e0be3ab5-e8bf-4ec2-be81-</span>
  f8569))

  <span class="hljs-keyword">data</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">WeatherInfoV3Request</span>(
      <span class="hljs-keyword">var</span> lon: <span class="hljs-built_in">Double</span>,
      <span class="hljs-keyword">var</span> lat: <span class="hljs-built_in">Double</span>,
      <span class="hljs-keyword">var</span> unit: String = <span class="hljs-string">"IMPERIAL"</span> <span class="hljs-comment">// METRIC / IMPERIAL</span>
  )

  代码三：Response（剥壳后的 <span class="hljs-keyword">data</span>）(api.apifox.cn (https:<span class="hljs-comment">//api.apifox.cn/temp-links/api/%E5%A4%A9%E6%F%A1%E6%81%AFv3-253061517?t=e0be3ab5-e8bf-4ec2-</span>
  be81-f18569))

  <span class="hljs-keyword">data</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">WeatherInfoV3Response</span>(
      <span class="hljs-keyword">var</span> day: <span class="hljs-built_in">Boolean</span>?,
      <span class="hljs-keyword">var</span> weather: WeatherV3?,
      <span class="hljs-keyword">var</span> temperature: <span class="hljs-built_in">Double</span>?,
      <span class="hljs-keyword">var</span> wind: <span class="hljs-built_in">Double</span>?,
      <span class="hljs-keyword">var</span> pressure: <span class="hljs-built_in">Double</span>?,
      <span class="hljs-keyword">var</span> humidity: <span class="hljs-built_in">Double</span>?,
      <span class="hljs-keyword">var</span> aqi: String?
  )

  <span class="hljs-keyword">data</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">WeatherV3</span>(
      <span class="hljs-keyword">var</span> condition: String?,
      <span class="hljs-keyword">var</span> icon: String?
  )

  代码四：ViewModel 中实际请求代码(api.apifox.cn (https:<span class="hljs-comment">//api.apifox.cn/temp-links/api/%E5%A4%A9%%A1%E6%81%AFv3-253061517?t=e0be3ab5-e8bf-4ec2-</span>
  be81-f1469))

  <span class="hljs-comment">/**
   * 获取天气信息V3
   */</span>
  <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">getCurrentInfoV3</span><span class="hljs-params">(
      lon: <span class="hljs-type">Double</span>,
      lat: <span class="hljs-type">Double</span>,
      unit: <span class="hljs-type">String</span> = <span class="hljs-string">"IMPERIAL"</span>,
      success: (<span class="hljs-type">WeatherInfoV3Response</span>?) -&gt; <span class="hljs-type">Unit</span>,
      fail: (<span class="hljs-type">ApiHttpExceptionResponse</span>&lt;<span class="hljs-type">Any</span>?&gt;) -&gt; <span class="hljs-type">Unit</span>,
      error: (<span class="hljs-type">AppException</span>) -&gt; <span class="hljs-type">Unit</span>
  )</span></span> {
      <span class="hljs-keyword">val</span> request = WeatherInfoV3Request(
          lon = lon,
          lat = lat,
          unit = unit
      )
      requestWithHttpException({ homeManagementApiService.getCurrentInfoV3(request) }, success = {
          success(it)
      }, fail = {
          fail(it)
      }, error = {
          error(it)
      })
  }

</code></pre>
<p>生成的代码可用度极高，很大程度上解放了生产力。</p>
<h2 data-id="heading-8">四、AI的放权</h2>
<p>AI生成的代码可用度这么高，那是不是应该放权直接让AI写文件呢？</p>
<p>1、如果是一个新项目，定义好项目架构后就大胆的让AI生成文件自己写代码吧，能”摸鱼"就别动手，人生苦短我用AI。</p>
<p>2、如果是一个成熟度高的项目，建议以小颗粒度的形式让AI生成或修改文件代码，这样影响的范围可控，git提交的时候请仔细审查AI生成的代码。</p>
<p>3、如果是一个成熟度高的项目，修改的需求复杂，牵扯面广，或者公司规定不让AI写代码只让辅助参考，那还是开只读模式自己写吧。</p>
<p>回到最上面的问题五：代码放哪个文件？</p>
<p>答案就简单了。</p>
<ul>
<li>项目架构清晰，让AI干活，可以完全让AI自主决策，后续自己调整。</li>
<li>可以在skill中添加提示加以引导，让AI放哪个文件/目录。</li>
<li>只读模式，自己处理AI生成的代码，前期可以开只读熟悉AI的使用，等熟练后就可以让AI自己写文件了。</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[LangChain 技术栈全解析：从模型编排到 RAG 实战]]></title>    <link>https://juejin.cn/post/7585138968167088164</link>    <guid>https://juejin.cn/post/7585138968167088164</guid>    <pubDate>2025-12-19T07:16:41.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585138968167088164" data-draft-id="7585214391827890219" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="LangChain 技术栈全解析：从模型编排到 RAG 实战"/> <meta itemprop="keywords" content="前端,LangChain,Python"/> <meta itemprop="datePublished" content="2025-12-19T07:16:41.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="编程干货铺"/> <meta itemprop="url" content="https://juejin.cn/user/52383084474680"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            LangChain 技术栈全解析：从模型编排到 RAG 实战
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/52383084474680/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    编程干货铺
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-19T07:16:41.000Z" title="Fri Dec 19 2025 07:16:41 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-19
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/34d91378c1684fe1862186d879886cd2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg57yW56iL5bmy6LSn6ZO6:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766733401&amp;x-signature=%2BUR%2BIetRoN43mSOr0nfx8CNobII%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<h2 data-id="heading-0">引言</h2>
<p>随着大语言模型能力的快速演进，真正的技术挑战已经不再是“如何调用模型”，而是：</p>
<ul>
<li>如何组织 Prompt</li>
<li>如何管理上下文</li>
<li>如何接入外部数据</li>
<li>如何构建多步骤推理流程</li>
<li>如何让模型在复杂任务中稳定工作</li>
</ul>
<p>LangChain 正是为解决这些问题而诞生的框架。</p>
<p>它不是一个模型，也不是一个简单的 SDK，而是一个<strong>用于构建 LLM 应用的应用层编排框架</strong>。</p>
<h2 data-id="heading-1">1. LangChain 是什么</h2>
<p>LangChain 是一个用于构建大模型应用（LLM Applications）的开源框架，其核心目标是：</p>
<blockquote>
<p><strong>将模型、提示词、数据源、工具和控制逻辑组织成可复用、可组合、可维护的应用流程。</strong></p>
</blockquote>
<p>在架构层面，LangChain 处于：</p>
<ul>
<li>大模型 API 之上</li>
<li>具体业务逻辑之下</li>
</ul>
<p>它承担的是 <strong>“AI 应用的中间层 / 编排层”</strong> 角色。</p>
<h2 data-id="heading-2">2. LangChain 解决了哪些问题</h2>
<p>在没有 LangChain 的情况下，LLM 应用通常存在以下问题：</p>
<ol>
<li>Prompt 分散在代码中，难以维护</li>
<li>多轮对话上下文不可控</li>
<li>检索、生成、工具调用逻辑耦合严重</li>
<li>难以构建多步骤推理流程</li>
<li>应用无法演进为复杂系统</li>
</ol>
<p>LangChain 的设计目标正是系统性地解决上述问题。</p>
<h2 data-id="heading-3">3. LangChain 的核心抽象模型</h2>
<p>LangChain 的能力建立在一组高度内聚的抽象之上：</p>









































<table><thead><tr><th>抽象</th><th>作用</th></tr></thead><tbody><tr><td>LLM / ChatModel</td><td>大模型统一接口</td></tr><tr><td>PromptTemplate</td><td>结构化提示词</td></tr><tr><td>Chain</td><td>可组合的执行流程</td></tr><tr><td>Memory</td><td>上下文与状态管理</td></tr><tr><td>Retriever</td><td>检索接口</td></tr><tr><td>VectorStore</td><td>向量存储</td></tr><tr><td>Tool</td><td>外部能力封装</td></tr><tr><td>Agent</td><td>推理 + 决策控制器</td></tr></tbody></table>
<p>这些抽象共同构成了 LangChain 的技术骨架。</p>
<h2 data-id="heading-4">4. 安装与基础调用</h2>
<h3 data-id="heading-5">JavaScript</h3>
<pre><code class="hljs language-bash" lang="bash">npm install langchain @langchain/openai
</code></pre>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">ChatOpenAI</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"@langchain/openai"</span>;

<span class="hljs-keyword">const</span> model = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ChatOpenAI</span>({
  <span class="hljs-attr">model</span>: <span class="hljs-string">"gpt-4o-mini"</span>
});

<span class="hljs-keyword">const</span> res = <span class="hljs-keyword">await</span> model.<span class="hljs-title function_">invoke</span>(<span class="hljs-string">"用一句话说明 LangChain 的作用"</span>);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(res.<span class="hljs-property">content</span>);
</code></pre>
<h3 data-id="heading-6">Python</h3>
<pre><code class="hljs language-bash" lang="bash">pip install langchain langchain-openai
</code></pre>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> langchain_openai <span class="hljs-keyword">import</span> ChatOpenAI

model = ChatOpenAI(model=<span class="hljs-string">"gpt-4o-mini"</span>)
resp = model.invoke(<span class="hljs-string">"用一句话说明 LangChain 的作用"</span>)
<span class="hljs-built_in">print</span>(resp.content)
</code></pre>
<h2 data-id="heading-7">5. PromptTemplate：结构化提示词</h2>
<p>PromptTemplate 用于将 Prompt 从字符串提升为可配置对象。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">PromptTemplate</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"langchain/prompts"</span>;

<span class="hljs-keyword">const</span> prompt = <span class="hljs-keyword">new</span> <span class="hljs-title class_">PromptTemplate</span>({
  <span class="hljs-attr">template</span>: <span class="hljs-string">"请解释 {concept} 的核心作用"</span>,
  <span class="hljs-attr">inputVariables</span>: [<span class="hljs-string">"concept"</span>]
});

<span class="hljs-keyword">const</span> text = <span class="hljs-keyword">await</span> prompt.<span class="hljs-title function_">format</span>({ <span class="hljs-attr">concept</span>: <span class="hljs-string">"LangChain"</span> });
</code></pre>
<p>优势在于：</p>
<ul>
<li>参数明确</li>
<li>可复用</li>
<li>易组合</li>
</ul>
<h2 data-id="heading-8">6. Chain：构建可组合的执行流程</h2>
<p>Chain 是 LangChain 的核心执行单元。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">LLMChain</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"langchain/chains"</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">ChatOpenAI</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"@langchain/openai"</span>;

<span class="hljs-keyword">const</span> chain = <span class="hljs-keyword">new</span> <span class="hljs-title class_">LLMChain</span>({
  <span class="hljs-attr">llm</span>: <span class="hljs-keyword">new</span> <span class="hljs-title class_">ChatOpenAI</span>({ <span class="hljs-attr">model</span>: <span class="hljs-string">"gpt-4o-mini"</span> }),
  prompt
});

<span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> chain.<span class="hljs-title function_">invoke</span>({ <span class="hljs-attr">concept</span>: <span class="hljs-string">"Chain 机制"</span> });
</code></pre>
<p>Chain 使得 <strong>Prompt → 模型 → 输出</strong> 成为一个标准化流程单元。</p>
<h2 data-id="heading-9">7. Memory：上下文与状态管理</h2>
<p>Memory 用于控制模型可感知的历史上下文。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">ConversationChain</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"langchain/chains"</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">BufferMemory</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"langchain/memory"</span>;

<span class="hljs-keyword">const</span> chain = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConversationChain</span>({
  <span class="hljs-attr">llm</span>: <span class="hljs-keyword">new</span> <span class="hljs-title class_">ChatOpenAI</span>(),
  <span class="hljs-attr">memory</span>: <span class="hljs-keyword">new</span> <span class="hljs-title class_">BufferMemory</span>()
});
</code></pre>
<p>Memory 的存在，使多轮对话和状态管理成为一等能力。</p>
<h2 data-id="heading-10">8. 向量化与检索：RAG 的技术基础</h2>
<p>RAG（Retrieval-Augmented Generation）并不是一个模型，而是一种架构模式。</p>
<p>LangChain 将 RAG 拆解为三个核心组件：</p>
<ol>
<li><strong>Text Splitter</strong>：文本分割</li>
<li><strong>Embedding</strong>：向量化</li>
<li><strong>VectorStore / Retriever</strong>：检索接口</li>
</ol>
<h2 data-id="heading-11">9. LangChain RAG 实战案例</h2>
<p>下面是一个结构完整、可运行的 LangChain RAG 示例（简化版）。</p>
<h3 data-id="heading-12">9.1 文档准备与切分</h3>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">RecursiveCharacterTextSplitter</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"langchain/text_splitter"</span>;

<span class="hljs-keyword">const</span> text = <span class="hljs-string">`
LangChain 是一个用于构建大语言模型应用的框架，
核心目标是将模型、数据、工具组织成可维护的流程。
`</span>;

<span class="hljs-keyword">const</span> splitter = <span class="hljs-keyword">new</span> <span class="hljs-title class_">RecursiveCharacterTextSplitter</span>({
  <span class="hljs-attr">chunkSize</span>: <span class="hljs-number">100</span>,
  <span class="hljs-attr">chunkOverlap</span>: <span class="hljs-number">20</span>
});

<span class="hljs-keyword">const</span> docs = <span class="hljs-keyword">await</span> splitter.<span class="hljs-title function_">splitText</span>(text);
</code></pre>
<h3 data-id="heading-13">9.2 向量化并存入向量库</h3>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">OpenAIEmbeddings</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"@langchain/openai"</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">MemoryVectorStore</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"langchain/vectorstores/memory"</span>;

<span class="hljs-keyword">const</span> vectorStore = <span class="hljs-keyword">await</span> <span class="hljs-title class_">MemoryVectorStore</span>.<span class="hljs-title function_">fromTexts</span>(
  docs,
  docs.<span class="hljs-title function_">map</span>(<span class="hljs-function">() =&gt;</span> ({})),
  <span class="hljs-keyword">new</span> <span class="hljs-title class_">OpenAIEmbeddings</span>()
);
</code></pre>
<h3 data-id="heading-14">9.3 基于检索的问答</h3>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> results = <span class="hljs-keyword">await</span> vectorStore.<span class="hljs-title function_">similaritySearch</span>(
  <span class="hljs-string">"LangChain 的核心作用是什么？"</span>,
  <span class="hljs-number">2</span>
);

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(results.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">r</span> =&gt;</span> r.<span class="hljs-property">pageContent</span>));
</code></pre>
<h3 data-id="heading-15">9.4 结合模型生成最终回答</h3>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">ChatOpenAI</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"@langchain/openai"</span>;

<span class="hljs-keyword">const</span> context = results.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">r</span> =&gt;</span> r.<span class="hljs-property">pageContent</span>).<span class="hljs-title function_">join</span>(<span class="hljs-string">"\n"</span>);

<span class="hljs-keyword">const</span> answer = <span class="hljs-keyword">await</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ChatOpenAI</span>().<span class="hljs-title function_">invoke</span>(
  <span class="hljs-string">`基于以下资料回答问题：\n<span class="hljs-subst">${context}</span>\n\n问题：LangChain 的作用是什么？`</span>
);

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(answer.<span class="hljs-property">content</span>);
</code></pre>
<h2 data-id="heading-16">10. Agent 与工具调用（进阶能力）</h2>
<p>LangChain 的 Agent 允许模型在运行时：</p>
<ul>
<li>判断是否需要工具</li>
<li>选择合适的工具</li>
<li>执行并整合结果</li>
</ul>
<p>这是构建复杂 AI 系统的重要基础。</p>
<h2 data-id="heading-17">11. LangChain 的典型应用方向</h2>
<ul>
<li>企业知识库问答（RAG）</li>
<li>智能客服系统</li>
<li>AI 助手与自动化 Agent</li>
<li>多步骤任务执行系统</li>
<li>AI 中台与能力编排层</li>
</ul>
<h2 data-id="heading-18">结语</h2>
<p>LangChain 的价值不在于“帮你写 Prompt”，
而在于 <strong>让大模型应用具备工程结构和系统能力</strong>。</p>
<p>当 LLM 应用从 Demo 走向生产环境，
LangChain 几乎是绕不开的技术栈之一。</p>
<p>如果你正在构建真实的 AI 应用系统，
理解并掌握 LangChain，是非常值得投入的一步。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/821171844b6a4abd9daca23c087ca843~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg57yW56iL5bmy6LSn6ZO6:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766733401&amp;x-signature=t%2BlH9D0aw1%2FGLxs%2F7KMsGinvAV8%3D" alt="在这里插入图片描述" loading="lazy"/>
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0d7fe2ec0c944a17a9c76e01962d29b6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg57yW56iL5bmy6LSn6ZO6:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766733401&amp;x-signature=dGohuWQhcg7B7gfcZo5N0A6%2FWoA%3D" alt="在这里插入图片描述" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[JavaScript 性能优化：5个被低估的V8引擎技巧让你的代码提速50%]]></title>    <link>https://juejin.cn/post/7585097023747915791</link>    <guid>https://juejin.cn/post/7585097023747915791</guid>    <pubDate>2025-12-19T04:16:53.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585097023747915791" data-draft-id="7585130590291656719" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="JavaScript 性能优化：5个被低估的V8引擎技巧让你的代码提速50%"/> <meta itemprop="keywords" content="后端,前端,人工智能"/> <meta itemprop="datePublished" content="2025-12-19T04:16:53.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="阿橙的百宝箱"/> <meta itemprop="url" content="https://juejin.cn/user/1638743356481367"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            JavaScript 性能优化：5个被低估的V8引擎技巧让你的代码提速50%
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1638743356481367/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    阿橙的百宝箱
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-19T04:16:53.000Z" title="Fri Dec 19 2025 04:16:53 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-19
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    29
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0"><strong>JavaScript 性能优化：5个被低估的V8引擎技巧让你的代码提速50%</strong></h2>
<h2 data-id="heading-1">引言</h2>
<p>在现代Web开发中，JavaScript的性能优化是一个永恒的话题。随着V8引擎的不断进化，许多开发者可能并未充分挖掘其潜力。V8作为Chrome和Node.js的核心引擎，通过即时编译（JIT）、隐藏类（Hidden Classes）、内联缓存（Inline Caching）等技术大幅提升了JavaScript的执行效率。然而，许多优化技巧仍被低估或忽视。本文将深入探讨5个鲜为人知的V8引擎技巧，帮助你将代码性能提升高达50%。</p>
<h2 data-id="heading-2">主体</h2>
<h3 data-id="heading-3">1. <strong>利用隐藏类（Hidden Classes）避免动态属性分配</strong></h3>
<p>V8通过隐藏类来优化对象属性访问。当对象的结构（即属性的顺序和类型）频繁变化时，V8会创建多个隐藏类，导致性能下降。例如：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 反例：动态添加属性</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">createUser</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> user = {};
  user.<span class="hljs-property">name</span> = <span class="hljs-string">"John"</span>;
  user.<span class="hljs-property">age</span> = <span class="hljs-number">30</span>; <span class="hljs-comment">// V8会为每次属性添加创建新的隐藏类</span>
  <span class="hljs-keyword">return</span> user;
}

<span class="hljs-comment">// 正例：一次性初始化所有属性</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">createUserOptimized</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> user = { <span class="hljs-attr">name</span>: <span class="hljs-string">"John"</span>, <span class="hljs-attr">age</span>: <span class="hljs-number">30</span> }; <span class="hljs-comment">// V8只需创建一个隐藏类</span>
  <span class="hljs-keyword">return</span> user;
}
</code></pre>
<p><strong>优化建议</strong>：</p>
<ul>
<li>尽量在对象构造时一次性定义所有属性。</li>
<li>避免在运行时动态删除或重新排序属性。</li>
</ul>
<h3 data-id="heading-4">2. <strong>避免数字类型的频繁切换（Smi vs. Heap Number）</strong></h3>
<p>V8对数字有两种内部表示形式：</p>
<ul>
<li><strong>Smi</strong>（Small Integer）：31位有符号整数，直接存储在对象中，访问速度快。</li>
<li><strong>Heap Number</strong>：双精度浮点数，存储在堆中，访问较慢。</li>
</ul>
<p>频繁切换这两种类型会导致性能损失：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">let</span> count = <span class="hljs-number">0</span>; <span class="hljs-comment">// Smi</span>
<span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">1e6</span>; i++) {
  count += i; <span class="hljs-comment">// 保持Smi类型</span>
}

<span class="hljs-keyword">let</span> floatCount = <span class="hljs-number">0.1</span>; <span class="hljs-comment">// Heap Number</span>
<span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">1e6</span>; i++) {
  floatCount += i; <span class="hljs-comment">// V8需要反复切换类型</span>
}
</code></pre>
<p><strong>优化建议</strong>：</p>
<ul>
<li>在密集计算中尽量使用整数（Smi）。</li>
<li>避免混合整数和浮点运算。</li>
</ul>
<h3 data-id="heading-5">3. <strong>利用内联缓存（Inline Caching）优化函数调用</strong></h3>
<p>V8通过内联缓存记录函数调用点的类型信息，加速后续调用。如果函数参数类型不稳定，会导致缓存失效（Megamorphic状态）：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 反例：多态参数导致内联缓存失效</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">a, b</span>) {
  <span class="hljs-keyword">return</span> a + b;
}
<span class="hljs-title function_">add</span>(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>);       <span class="hljs-comment">// IC记录Number类型</span>
<span class="hljs-title function_">add</span>(<span class="hljs-string">"1"</span>, <span class="hljs-string">"2"</span>);   <span class="hljs-comment">// IC失效，重新学习String类型</span>

<span class="hljs-comment">// 正例：保持参数类型一致</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">addNumbers</span>(<span class="hljs-params">a, b</span>) {
  <span class="hljs-keyword">return</span> a + b;
}
<span class="hljs-title function_">addNumbers</span>(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>); <span class="hljs-comment">// IC始终有效</span>
</code></pre>
<p><strong>优化建议</strong>：</p>
<ul>
<li>确保高频调用的函数参数类型稳定。</li>
<li>避免在热代码路径中使用<code>arguments</code>或动态参数。</li>
</ul>
<p>###4. <strong>谨慎使用<code>try-catch</code>和<code>with</code>语句</strong></p>
<p>V8会对包含<code>try-catch</code>或<code>with</code>的函数禁用某些优化（如函数内联）：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// try-catch影响性能</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">riskyOperation</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">try</span> {
        <span class="hljs-comment">// ...可能抛出异常的操作...</span>
    } <span class="hljs-keyword">catch</span> (e) {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(e);
    }
}

<span class="hljs-comment">// Node.js中更高效的错误处理方式：</span>
<span class="hljs-keyword">if</span> (errorProneCondition) {
    process.<span class="hljs-title function_">nextTick</span>(<span class="hljs-function">() =&gt;</span> { <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">"..."</span>); });
}
</code></pre>
<p><strong>优化建议</strong>：</p>
<ul>
<li>将<code>try-catch</code>移至外层或非关键路径。</li>
<li>完全避免使用<code>with</code>语句（已废弃）。</li>
</ul>
<p>###5. <strong>预编译正则表达式并利用持久化匹配状态</strong></p>
<p>正则表达式在V8中会被编译为原生代码，但重复编译会拖慢性能：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">//  反例：每次循环重新编译正则 </span>
<span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i =  <span class="hljs-number">0</span> ; i &lt;  <span class="hljs-number">1000</span> ; i++) { 
    <span class="hljs-regexp">/test(\d+)/</span>.<span class="hljs-title function_">exec</span>(<span class="hljs-string">"test123"</span>); 
} 

<span class="hljs-comment">//  正例：预编译正则 </span>
<span class="hljs-keyword">const</span> regex = <span class="hljs-regexp">/test(\d+)/</span>; 
<span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i =  <span class="hljs-number">0</span> ; i &lt;  <span class="hljs-number">1000</span> ; i++) { 
    regex.<span class="hljs-title function_">exec</span>(<span class="hljs-string">"test123"</span>); 
} 

<span class="hljs-comment">//  进阶技巧：复用RegExp实例的lastIndex </span>
<span class="hljs-keyword">const</span> globalRegex = <span class="hljs-regexp">/test(\d+)/g</span>; 
globalRegex.<span class="hljs-property">lastIndex</span> =  <span class="hljs-number">0</span> ; <span class="hljs-comment">//  显式重置位置 </span>
<span class="hljs-keyword">while</span> ((match = globalRegex.<span class="hljs-title function_">exec</span>(input)) !== <span class="hljs-literal">null</span>) { ... }
</code></pre>
<h2 data-id="heading-6">总结</h2>
<p>通过深入理解V8的工作原理并调整编码习惯 ——从对象构造、数字处理到函数设计——开发者可以显著提升JavaScript的执行效率</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Android AI解放生产力（六）实战：解放页面开发前的繁琐工作]]></title>    <link>https://juejin.cn/post/7585121055037358130</link>    <guid>https://juejin.cn/post/7585121055037358130</guid>    <pubDate>2025-12-19T06:59:54.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585121055037358130" data-draft-id="7585121055036964914" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Android AI解放生产力（六）实战：解放页面开发前的繁琐工作"/> <meta itemprop="keywords" content="架构,Android"/> <meta itemprop="datePublished" content="2025-12-19T06:59:54.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="TimeFine"/> <meta itemprop="url" content="https://juejin.cn/user/3913917123802615"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Android AI解放生产力（六）实战：解放页面开发前的繁琐工作
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3913917123802615/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    TimeFine
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-19T06:59:54.000Z" title="Fri Dec 19 2025 06:59:54 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-19
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    34
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="androidstudio">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#a9b7c6;background:#282b2e}.hljs-bullet,.hljs-literal,.hljs-number,.hljs-symbol{color:#6897bb}.hljs-deletion,.hljs-keyword,.hljs-selector-tag{color:#cc7832}.hljs-link,.hljs-template-variable,.hljs-variable{color:#629755}.hljs-comment,.hljs-quote{color:grey}.hljs-meta{color:#bbb529}.hljs-addition,.hljs-attribute,.hljs-string{color:#6a8759}.hljs-section,.hljs-title,.hljs-type{color:#ffc66d}.hljs-name,.hljs-selector-class,.hljs-selector-id{color:#e8bf6a}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>一般开发一个新页面的工作是这样的:</p>
<ul>
<li>新建Activity/Fragment，里面会各种继承和默认实现的函数。</li>
<li>新建ViewModel，也是继承和基础实现。</li>
<li>如果有RecyclerView还要创建Adapter。</li>
</ul>
<p>大部分开发者估计都是拷贝之前的文件然后改改就用了，但是拷贝这些文件是不是很繁琐？以后这些活交给AI来干。首先思考一下可能碰到的问题。</p>
<h2 data-id="heading-0">一、可能碰到的问题</h2>
<h3 data-id="heading-1">1、文件名的定义</h3>
<p>如果要生成Activity，Fragment，ViewModel，Adapter，ViewBinding等，文件名要怎么取？
答案是按项目的命名规范告诉AI即可，例如要创建AboutActivity，告诉AI对应的Fragment应该是AboutFragment，ViewModel应该是AboutViewModel，Adapter应该是AboutAdapter，ViewBding应该是ActivityAboutBinding，如果是XML布局文件来写UI，布局文件应该是activity_about。在skill中描述清楚。</p>
<h3 data-id="heading-2">2、文件放哪儿</h3>
<p>上一篇有讨论这个问题，可以见上篇。</p>
<h2 data-id="heading-3">二、编辑skill</h2>
<p>还是让AI只给出代码。</p>
<p>需要在skill中描述生成哪些文件以及每个文件应该如何参考项目的模版代码生成。下面是一份手动写的简单示例：</p>
<pre><code class="hljs language-kotlin" lang="kotlin">---
name: new_page_dev
description: 新页面开发生成Activity。
---
## 创建Activity等并给出如下要求的代码：

### <span class="hljs-number">1</span>、代码一：创建对应的Activity
可以参考`MyOrdersActivity`这个Activity。

布局文件的Binding按规则:例如AActivity, 那么viewbinding就是ActivityABinding，我会在后续补充这个布局文件。

<span class="hljs-keyword">class</span> <span class="hljs-title class_">MyOrdersActivity</span> : <span class="hljs-type">BaseVBActivity</span>&lt;<span class="hljs-type">ActivityMyOrdersListBinding</span>&gt;() {

    <span class="hljs-comment">//涉及具体项目代码，略，根据自己的项目模版代码编辑</span>

}
请参照上面的模版代码给出。

给出AndroidManifest清单文件注册的代码。

### <span class="hljs-number">2</span>、代码二：给出ViewModel的代码
ViewModel的命名规则如果是AActivity,那么ViewModel就是AViewModel。

AViewModel的创建可参考的代码为：
<span class="hljs-keyword">class</span> <span class="hljs-title class_">AlertDetailsViewModel</span>(savedStateHandle: SavedStateHandle) : BaseViewModel() {

    <span class="hljs-comment">//涉及具体项目代码，略，根据自己的项目模版代码编辑</span>
    
    <span class="hljs-keyword">companion</span> <span class="hljs-keyword">object</span> {

    }
}

### <span class="hljs-number">3</span>、代码三：给出Adapter的代码

Adapter的命名规则同上。

可参考的Adapter的代码：

<span class="hljs-keyword">class</span> <span class="hljs-title class_">MyOrdersListAdapter</span> : <span class="hljs-type">BaseQuickAdapter</span>&lt;<span class="hljs-type">PlanDetails, QuickViewHolder</span>&gt;() {

    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onBindViewHolder</span><span class="hljs-params">(holder: <span class="hljs-type">QuickViewHolder</span>, position: <span class="hljs-type">Int</span>, item: <span class="hljs-type">PlanDetails</span>?)</span></span> {
        <span class="hljs-keyword">val</span> binding = ItemMyOrdersInfoBinding.bind(holder.itemView)
        item?.apply {
        	<span class="hljs-comment">//TODO</span>
            }
    }

    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onCreateViewHolder</span><span class="hljs-params">(context: <span class="hljs-type">Context</span>, parent: <span class="hljs-type">ViewGroup</span>, viewType: <span class="hljs-type">Int</span>)</span></span>: QuickViewHolder {
        <span class="hljs-keyword">return</span> QuickViewHolder(R.layout.item_my_orders_info, parent)
    }
}

</code></pre>
<p>根据项目的实际情况编辑上面的skill。<strong>给AI让它帮你修改成标准格式的skill</strong>，因为跟项目代码关联，这里没办法贴出我的。</p>
<p>在Codex Cli中输入：</p>
<pre><code class="hljs language-kotlin" lang="kotlin">新页面开发生成AboutActivity
</code></pre>
<p>下面是AI生成的结果：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"> Using skill new_page_dev to generate the Activity/ViewModel/Adapter skeletons.

  <span class="hljs-comment">//...略...</span>

  <span class="hljs-keyword">class</span> <span class="hljs-title class_">AboutActivity</span> : <span class="hljs-type">BaseVBActivity</span>&lt;<span class="hljs-type">ActivityAboutBinding</span>&gt;() {

      <span class="hljs-keyword">override</span> <span class="hljs-keyword">val</span> viewModel <span class="hljs-keyword">by</span> viewModels&lt;AboutViewModel&gt;()
      <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> mAdapter = AboutAdapter()
      <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> mDataList = mutableListOf&lt;Any&gt;()

      <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">createViewBinding</span><span class="hljs-params">(inflater: <span class="hljs-type">LayoutInflater</span>)</span></span>: ActivityAboutBinding {
          <span class="hljs-keyword">return</span> ActivityAboutBinding.inflate(inflater)
      }

      <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">init</span><span class="hljs-params">(savedInstanceState: <span class="hljs-type">Bundle</span>?)</span></span> {
          multiStateContainer = MultiStatePage.bindMultiState(binding.rlContainer)
          initAdapter()
          requestData(<span class="hljs-literal">true</span>)
      }

      <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">initAdapter</span><span class="hljs-params">()</span></span> {
          binding.rcy.layoutManager = LinearLayoutManager(<span class="hljs-keyword">this</span>)
          binding.rcy.adapter = mAdapter
          binding.refreshLayout.setEnableFooterFollowWhenNoMoreData(<span class="hljs-literal">true</span>)
      }

      <span class="hljs-meta">@SuppressLint(<span class="hljs-string">"NotifyDataSetChanged"</span>)</span>
      <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">requestData</span><span class="hljs-params">(isShowLoading: <span class="hljs-type">Boolean</span> = <span class="hljs-literal">false</span>)</span></span> {
          <span class="hljs-keyword">if</span> (isShowLoading) {
              multiStateContainer.showLoading()
          }
          <span class="hljs-comment">// <span class="hljs-doctag">TODO:</span> request data and update mDataList / adapter</span>
      }

      <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">showError</span><span class="hljs-params">()</span></span> {
          multiStateContainer.showErrorCustom {
              requestData(<span class="hljs-literal">true</span>)
          }
      }

      <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">showEmpty</span><span class="hljs-params">()</span></span> {
          multiStateContainer.showEmptyCustom()
      }

      <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">createObserver</span><span class="hljs-params">()</span></span> {

      }
  }

  <span class="hljs-comment">//...略...</span>

  <span class="hljs-keyword">class</span> <span class="hljs-title class_">AboutViewModel</span>(savedStateHandle: SavedStateHandle) : BaseViewModel() {

      <span class="hljs-keyword">companion</span> <span class="hljs-keyword">object</span> {

      }
  }

  <span class="hljs-comment">//...略...</span>

  <span class="hljs-keyword">class</span> <span class="hljs-title class_">AboutAdapter</span> : <span class="hljs-type">BaseQuickAdapter</span>&lt;<span class="hljs-type">Any, QuickViewHolder</span>&gt;() {

      <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onBindViewHolder</span><span class="hljs-params">(holder: <span class="hljs-type">QuickViewHolder</span>, position: <span class="hljs-type">Int</span>, item: <span class="hljs-type">Any</span>?)</span></span> {
          <span class="hljs-keyword">val</span> binding = ItemAboutBinding.bind(holder.itemView)
          item?.apply {
              <span class="hljs-comment">// <span class="hljs-doctag">TODO:</span> bind item</span>
          }
      }

      <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onCreateViewHolder</span><span class="hljs-params">(context: <span class="hljs-type">Context</span>, parent: <span class="hljs-type">ViewGroup</span>, viewType: <span class="hljs-type">Int</span>)</span></span>: QuickViewHolder {
          <span class="hljs-keyword">return</span> QuickViewHolder(R.layout.item_about, parent)
      }
  }

  Confirm the target <span class="hljs-keyword">package</span> and whether <span class="hljs-keyword">this</span> page <span class="hljs-keyword">is</span> list-based (RecyclerView). If not, I can simplify the Activity and remove the adapter scaffold.
</code></pre>
<p>代码完全可用，开启写的权限，复制粘贴都省了。</p>
<h2 data-id="heading-4">三、总结</h2>
<p>实战的三篇分别解决了：</p>
<ul>
<li>根据需求创建模板文件；</li>
<li>通过Figma MCP加skill生成UI；</li>
<li>通过Apifox加skill生成接口数据；</li>
</ul>
<p>作为开发者：</p>
<ul>
<li>基本不用写UI了；</li>
<li>不用写接口接入那一套流程了；</li>
<li>不用操作创建一堆文件那一套流程了；</li>
</ul>
<p>重心只需要放在需求和数据对接的代码即可，极大的解放了生成力。</p>
<p>如果终端开多个窗口跑，同时完成上面的工作，效率会进一步提高。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item>  </channel></rss>