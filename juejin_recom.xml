<?xml version="1.0" encoding="UTF-8"?><rss version="2.0">  <channel>      <title>掘金文章推荐</title>      <link>https://juejin.cn/recommended?sort=newest</link>      <description>一个帮助开发者成长的社区</description>      <generator>python juejin_recom.py @Pi20</generator>      <item>    <title><![CDATA[场景化落地指南——金仓时序数据库在关键行业的应用实践]]></title>    <link>https://juejin.cn/post/7595974133096759330</link>    <guid>https://juejin.cn/post/7595974133096759330</guid>    <pubDate>2026-01-17T11:21:31.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7595974133096759330" data-draft-id="7595893785907003426" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="场景化落地指南——金仓时序数据库在关键行业的应用实践"/> <meta itemprop="keywords" content="数据库"/> <meta itemprop="datePublished" content="2026-01-17T11:21:31.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="倔强的石头_"/> <meta itemprop="url" content="https://juejin.cn/user/3168119757484368"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            场景化落地指南——金仓时序数据库在关键行业的应用实践
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3168119757484368/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    倔强的石头_
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-17T11:21:31.000Z" title="Sat Jan 17 2026 11:21:31 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-17
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读17分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>时序数据怎么“落到系统里”，往往比“概念讲清楚”更难。本文就以金仓时序数据库的工程落地为主线，把采集、存储、分析、看板到运维闭环串起来：能力怎么拆、模型怎么建、SQL怎么写、行业怎么用，尽量讲得清楚、也讲得能直接照着做。</p>
</blockquote>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f5b55ca384944f96a4cf3c0a36adf160~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YCU5by655qE55-z5aS0Xw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769253691&amp;x-signature=fdsDHhQyoy37cjLTvKj9B2Su7kQ%3D" alt="a6bb70bf487627cb7b4e42054570950f.jpg" loading="lazy"/></p>
<p>@[toc]</p>
<hr/>
<h2 data-id="heading-0">1. 为什么 2025 年时序数据库“必须场景化”</h2>
<p>时序数据库早就不只是“写得快、存得下”这么简单了。到了 2025 年，大家更看重的是<strong>能不能围绕场景把链路交付出来</strong>——接入稳不稳、存储贵不贵、查询快不快、系统抗不抗压、治理合不合规、国产化环境能不能长期跑住。</p>
<h3 data-id="heading-1">1.1 2025 年时序数据的四个典型变化</h3>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1df8dde84d2744feb7bc1cc119e5cf88~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YCU5by655qE55-z5aS0Xw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769253691&amp;x-signature=7p2Mi36fZofdnccGaUfht%2BFXZjs%3D" alt="image.png" loading="lazy"/></p>
<ol>
<li>
<p><strong>数据源更碎更近</strong><br/>
边缘侧设备、网关、工业控制与车联网等产生大量“短周期、高噪声、易丢包”的数据，接入链路需要更强的吞吐与容错。</p>
</li>
<li>
<p><strong>“写入高峰 + 查询突发”成为常态</strong><br/>
白天业务写入、夜间批处理、故障排查突发查询叠加，要求数据库同时兼顾写入、压缩、聚合与并发读。</p>
</li>
<li>
<p><strong>从“保存原始数据”走向“可运营的数据资产”</strong><br/>
不只是存：还要分层（热/温/冷）、保留策略、降采样、数据质量与审计，让数据能被长期复用。</p>
</li>
<li>
<p><strong>“可控可用”比“参数最优”更重要</strong><br/>
关键行业更看重可交付性：可运维、可审计、可扩展、可兼容生态、可在国产化环境稳定运行。</p>
</li>
</ol>
<h3 data-id="heading-2">1.2 趋势、格局与金仓的机会点：把“能力”写进“交付件”</h3>
<p>如果把行业格局拆开看，时序产品大体会落在三条路线上：偏工业/能源的生产系统路线、偏 IT 可观测性的运维路线、以及偏物联网与平台化的数据平台路线。走到 2025 年，真正能拉开差距的往往不是某一项“极限指标”，而是能不能把能力沉淀成一套可复用、可验收的交付件：
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b622a9049f0743fb8efd44c7b228bc4c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YCU5by655qE55-z5aS0Xw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769253691&amp;x-signature=wWSt4kYJwWDsqgK%2F5IfiFmHyqtM%3D" alt="image.png" loading="lazy"/></p>
<ul>
<li><strong>数据接入标准化</strong>：批量写入、重试幂等、乱序补写、质量标记这些能力，最后要落成接入规范与模板，谁接谁用。</li>
<li><strong>分区生命周期工程化</strong>：分区自动创建与清理、冷热分层、归档策略要固化成运维脚本与验收口径，跑起来心里有底。</li>
<li><strong>看板查询产品化</strong>：分钟/小时聚合层配上回补窗口，把看板从“偶尔很快”变成“长期稳定快”。</li>
<li><strong>治理与审计体系化</strong>：权限隔离、审计留痕、保留策略可审计，减少上线审批与合规沟通成本。</li>
<li><strong>国产化落地可持续</strong>：压测基线、容量模型、演练流程与监控指标补齐，尽量把问题挡在上线前。</li>
</ul>
<hr/>
<h2 data-id="heading-3">2. 金仓时序数据库的能力拆解：用工程语言对齐“能解决什么问题”</h2>
<p>把能力按“落地会用到的层次”拆开看，规划、验收、扩容评估都会清晰不少。</p>
<pre><code class="hljs language-mermaid" lang="mermaid">flowchart TB
  A[数据接入&lt;br/&gt;采集/网关/消息队列] --&gt; B[写入与缓冲&lt;br/&gt;批量/乱序/幂等]
  B --&gt; C[存储组织&lt;br/&gt;分区/索引/压缩]
  C --&gt; D[查询分析&lt;br/&gt;窗口聚合/关联/预聚合]
  D --&gt; E[数据治理&lt;br/&gt;生命周期/权限/审计]
  E --&gt; F[高可用与运维&lt;br/&gt;备份恢复/监控/扩缩容]
</code></pre>
<h3 data-id="heading-4">2.0 把“金仓”放进架构图：不是单点能力，而是一套交付体系</h3>
<p>关键行业里，金仓的时序能力更多是作为金仓数据库的企业级数据底座能力来用：它能承载“海量时序数据采集检索类应用”等场景，并且支持和关系、文档、GIS 等模型统一存储、混合访问。换句话说，很多时候你不必为了时序单独再拼一套系统，运维与治理的压力也会小一截。</p>
<p>做国产化替代，难点往往不在“能不能迁”，而在“迁完能不能长期稳”。所以工程交付必须把“评估—迁移—开发—运维”这一串打通。金仓官网公开信息里也明确提到其配套的工具组件体系覆盖迁移评估、数据迁移、开发管理与集中运维等环节，目的就是把“能跑起来”进一步变成“能持续跑下去”。
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b48a386d0f054ef18ff92cd3acb2dd60~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YCU5by655qE55-z5aS0Xw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769253691&amp;x-signature=JA2Fl3CS3OEOuywHwQuR0G3cWV8%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-5">2.1 写入：吞吐、乱序与“业务可恢复”</h3>
<p>很多项目里，写入的真实痛点并不是“单条写得慢”，而是下面这些更折磨人的问题：</p>
<ul>
<li>峰值写入时如何保持稳定、不卡死查询；</li>
<li>乱序/迟到数据如何补写并保持一致；</li>
<li>断网/重试时如何做到幂等与可追溯。</li>
</ul>
<p>落到工程上，可以按这个思路做：</p>
<ul>
<li>入口层先把<strong>批量写入</strong>和<strong>重试去重</strong>做扎实（设备侧或网关侧带唯一序号/时间戳+设备ID），写入高峰时更稳。</li>
<li>数据库侧用<strong>按时间范围分区</strong>来兜底，避免一张表无限变大后维护成本飙升。</li>
<li>如果业务维度很稳定、过滤也很高频，就把“时间 + 业务维度”当成联合切分的抓手，既降低热点，也减少扫描范围。[^kb-logs][^kb-safety]</li>
</ul>
<h3 data-id="heading-6">2.2 存储：分区、压缩与冷热分层（降低总成本）</h3>
<p>时序数据按时间范围切分（天/小时/周等）几乎是“默认正确”的选择，收益也很直接：</p>
<ul>
<li>查询裁剪：只扫描命中的时间分区；</li>
<li>运维简化：过期数据直接按分区清理；</li>
<li>性能稳定：避免“越存越慢”的长尾问题。</li>
</ul>
<p>从产品形态上看，金仓把时序能力放进融合数据库体系里，强调多种模型统一存储、混合访问。这样一来，“时序明细 + 业务维表 +（可选的）空间信息”就能在同一底座内闭环完成，跨系统同步与一致性治理的麻烦事会少很多。[^kb-kes]</p>
<h3 data-id="heading-7">2.3 查询：窗口聚合、预聚合与“秒级看板”</h3>
<p>看板/告警最常见的坑就是：原始点位太多，一上来就扫明细，延迟上去了，资源也被吃光。更稳妥的做法通常是：</p>
<ul>
<li>明细层保留原始数据；</li>
<li>聚合层按分钟/小时做预聚合（可物化/可增量）；</li>
<li>业务侧读聚合层满足大多数实时看板。</li>
</ul>
<p>在金仓公开的时序分析实践里，“区间筛选 + 时间窗口聚合”的函数化思路经常被用来把复杂查询收敛成稳定、可复用的时间窗操作，这样压测、缓存和看板复用都会更顺手。[^kb-safety]</p>
<h3 data-id="heading-8">2.4 治理与安全：权限、审计与合规</h3>
<p>关键行业往往要求：</p>
<ul>
<li>
<p>租户/部门隔离（多业务域并行）；</p>
</li>
<li>
<p>行级/库级/表级权限；</p>
</li>
<li>
<p>操作审计、追溯与留痕；</p>
</li>
<li>
<p>数据保留策略可控、可审计。</p>
</li>
</ul>
<h2 data-id="heading-9">时序项目能不能顺利上线、上线后敢不敢放量，很多时候就卡在治理这一关。</h2>
<h2 data-id="heading-10">3. 一个可复用的数据模型：设备测点表（含分区与索引）</h2>
<p>先用通用 SQL 来阐述建模思路，把“设备测点”当作事实表，并按照时间范围实施分区，然后针对最常见的过滤条件创建合成索引，这样大概就可以涵盖多数生产场景。</p>
<p>不同系统对于分区语法的细节可能存在差别，不过建模思路以及字段设计可以照搬，等到实际执行的时候，再依照金仓时序数据库的功能以及运维规范去调整分区粒度和索引策略即可。</p>
<h3 data-id="heading-11">3.1 表结构建议</h3>
<ul>
<li><code>ts</code>：采集时间（统一使用同一时区/统一入库口径）</li>
<li><code>device_id</code>：设备/点位唯一标识</li>
<li><code>metric</code>：指标名（温度、压力、电流等）</li>
<li><code>value</code>：数值</li>
<li><code>quality</code>：质量位（可选，标记是否有效/是否补传）</li>
<li><code>tags</code>：扩展维度（可选，JSON 或规范化维表）</li>
</ul>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> telemetry_points (
  ts         <span class="hljs-type">TIMESTAMP</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,
  device_id  <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">64</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,
  metric     <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">64</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,
  <span class="hljs-keyword">value</span>      <span class="hljs-type">DOUBLE PRECISION</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,
  quality    <span class="hljs-type">INTEGER</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-number">0</span>,
  <span class="hljs-keyword">PRIMARY</span> KEY (ts, device_id, metric)
);
</code></pre>
<h3 data-id="heading-12">3.2 按时间范围分区（示例：按天）</h3>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> telemetry_points_2025_01_01 <span class="hljs-keyword">PARTITION</span> <span class="hljs-keyword">OF</span> telemetry_points
<span class="hljs-keyword">FOR</span> <span class="hljs-keyword">VALUES</span> <span class="hljs-keyword">FROM</span> (<span class="hljs-string">'2025-01-01'</span>) <span class="hljs-keyword">TO</span> (<span class="hljs-string">'2025-01-02'</span>);
</code></pre>
<h3 data-id="heading-13">3.3 常用索引</h3>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">CREATE</span> INDEX idx_tp_device_metric_ts <span class="hljs-keyword">ON</span> telemetry_points (device_id, metric, ts);
<span class="hljs-keyword">CREATE</span> INDEX idx_tp_ts <span class="hljs-keyword">ON</span> telemetry_points (ts);
</code></pre>
<h3 data-id="heading-14">3.4 多业务域/多租户的两种常见隔离方式</h3>
<p>时序平台一旦做成“平台”，就会遇到多业务域/多租户的问题。工程上最常见的隔离方式基本就这两类：</p>
<ul>
<li><strong>库/模式隔离</strong>：不同租户/业务域使用不同库或不同模式，隔离清晰、权限简单，适合强隔离场景。</li>
<li><strong>表内隔离</strong>：同一张事实表增加 <code>tenant_id</code> 字段，适合租户多且小、共享资源的场景，但需要更严格的权限与审计策略。</li>
</ul>
<hr/>
<h2 data-id="heading-15">4. 典型查询与聚合：从“明细点”到“可用指标”</h2>
<p>许多团队执行时序分析的时候，最常犯的错误就是“每个人都有一套自己的时间窗逻辑”，这样就造成口径不统一，性能也无法控制，金仓在开展时序分析的时候，更侧重于把“时间范围过滤，区间筛选，时间窗口聚合”这些功能做成函数化，模板化的模式，从而减轻重复劳动的负担，也便于创建性能基线并实施回归检测，这里有一组通用的 SQL 思路；到了实际操作金仓时，可以优先采用金仓自身具备的等效内置函数及其相关能力，把逻辑编写得更为精炼，稳定。</p>
<h3 data-id="heading-16">4.1 区间查询：设备在某时间段的曲线</h3>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">SELECT</span> ts, <span class="hljs-keyword">value</span>
<span class="hljs-keyword">FROM</span> telemetry_points
<span class="hljs-keyword">WHERE</span> device_id <span class="hljs-operator">=</span> <span class="hljs-string">'D-10086'</span>
  <span class="hljs-keyword">AND</span> metric <span class="hljs-operator">=</span> <span class="hljs-string">'temperature'</span>
  <span class="hljs-keyword">AND</span> ts <span class="hljs-operator">&gt;=</span> <span class="hljs-string">'2025-01-01 00:00:00'</span>
  <span class="hljs-keyword">AND</span> ts <span class="hljs-operator">&lt;</span>  <span class="hljs-string">'2025-01-02 00:00:00'</span>
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> ts;
</code></pre>
<h3 data-id="heading-17">4.2 窗口聚合：按 5 分钟做均值、最大、最小</h3>
<p>没有内置时间桶函数时，也可以用“时间截断/取整”的方式表达时间桶。</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">SELECT</span>
  (DATE_TRUNC(<span class="hljs-string">'minute'</span>, ts) <span class="hljs-operator">-</span> (<span class="hljs-built_in">EXTRACT</span>(<span class="hljs-keyword">minute</span> <span class="hljs-keyword">FROM</span> ts)::<span class="hljs-type">int</span> <span class="hljs-operator">%</span> <span class="hljs-number">5</span>) <span class="hljs-operator">*</span> <span class="hljs-type">INTERVAL</span> <span class="hljs-string">'1 minute'</span>) <span class="hljs-keyword">AS</span> bucket_start,
  <span class="hljs-built_in">AVG</span>(<span class="hljs-keyword">value</span>) <span class="hljs-keyword">AS</span> avg_value,
  <span class="hljs-built_in">MIN</span>(<span class="hljs-keyword">value</span>) <span class="hljs-keyword">AS</span> min_value,
  <span class="hljs-built_in">MAX</span>(<span class="hljs-keyword">value</span>) <span class="hljs-keyword">AS</span> max_value
<span class="hljs-keyword">FROM</span> telemetry_points
<span class="hljs-keyword">WHERE</span> device_id <span class="hljs-operator">=</span> <span class="hljs-string">'D-10086'</span>
  <span class="hljs-keyword">AND</span> metric <span class="hljs-operator">=</span> <span class="hljs-string">'temperature'</span>
  <span class="hljs-keyword">AND</span> ts <span class="hljs-operator">&gt;=</span> <span class="hljs-string">'2025-01-01 00:00:00'</span>
  <span class="hljs-keyword">AND</span> ts <span class="hljs-operator">&lt;</span>  <span class="hljs-string">'2025-01-01 06:00:00'</span>
<span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> bucket_start
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> bucket_start;
</code></pre>
<h3 data-id="heading-18">4.3 预聚合：面向看板的“分钟级物化视图”（示例思路）</h3>
<p>当看板查询频繁、且大部分只需要分钟级指标时，建议做“明细层 + 聚合层”两层结构。</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> telemetry_1m (
  bucket_start <span class="hljs-type">TIMESTAMP</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,
  device_id    <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">64</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,
  metric       <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">64</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,
  avg_value    <span class="hljs-type">DOUBLE PRECISION</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,
  min_value    <span class="hljs-type">DOUBLE PRECISION</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,
  max_value    <span class="hljs-type">DOUBLE PRECISION</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,
  cnt          <span class="hljs-type">BIGINT</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,
  <span class="hljs-keyword">PRIMARY</span> KEY (bucket_start, device_id, metric)
);
</code></pre>
<p>聚合刷新策略建议：</p>
<ul>
<li>实时性要求高：按分钟增量刷新；</li>
<li>允许延迟：按 5 分钟/15 分钟批量刷新；</li>
<li>支持迟到数据：设置“回补窗口”（例如回补最近 2 小时）。</li>
</ul>
<h3 data-id="heading-19">4.4 乱序、重复与补传：用“质量位 + 业务幂等键”降低风险</h3>
<p>现场采集常常会遇到这样一些麻烦事，第一种是设备补传引发的重复情况，第二种是因为网络抖动而出现的乱序现象，第三种则是由于设备离线造成的缺段问题，想要减小返工量，最好是就在模型层预先留出控制面。</p>
<ul>
<li><code>quality</code> 标记来源（正常/补传/估算/无效等），便于告警与统计口径一致</li>
<li>入口层生成 <code>event_id</code>（设备序号或哈希），用于幂等写入与去重</li>
</ul>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> telemetry_points2 (
  ts         <span class="hljs-type">TIMESTAMP</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,
  device_id  <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">64</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,
  metric     <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">64</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,
  <span class="hljs-keyword">value</span>      <span class="hljs-type">DOUBLE PRECISION</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,
  quality    <span class="hljs-type">INTEGER</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-number">0</span>,
  event_id   <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">128</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,
  <span class="hljs-keyword">PRIMARY</span> KEY (event_id)
);
</code></pre>
<h3 data-id="heading-20">4.5 缺失补齐：把“时间对齐”做成可复用查询模板</h3>
<p>看板经常要一根“等间隔时间轴”（比如每分钟一个点）。遇到缺失时，先用 <code>NULL</code> 占位更干净，后面在展示层再做插值或前向填充就好。</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">WITH</span> time_grid <span class="hljs-keyword">AS</span> (
  <span class="hljs-keyword">SELECT</span> generate_series(
    <span class="hljs-type">TIMESTAMP</span> <span class="hljs-string">'2025-01-01 00:00:00'</span>,
    <span class="hljs-type">TIMESTAMP</span> <span class="hljs-string">'2025-01-01 01:00:00'</span>,
    <span class="hljs-type">INTERVAL</span> <span class="hljs-string">'1 minute'</span>
  ) <span class="hljs-keyword">AS</span> ts
),
raw <span class="hljs-keyword">AS</span> (
  <span class="hljs-keyword">SELECT</span> DATE_TRUNC(<span class="hljs-string">'minute'</span>, ts) <span class="hljs-keyword">AS</span> ts, <span class="hljs-built_in">AVG</span>(<span class="hljs-keyword">value</span>) <span class="hljs-keyword">AS</span> v
  <span class="hljs-keyword">FROM</span> telemetry_points
  <span class="hljs-keyword">WHERE</span> device_id <span class="hljs-operator">=</span> <span class="hljs-string">'D-10086'</span>
    <span class="hljs-keyword">AND</span> metric <span class="hljs-operator">=</span> <span class="hljs-string">'temperature'</span>
    <span class="hljs-keyword">AND</span> ts <span class="hljs-operator">&gt;=</span> <span class="hljs-string">'2025-01-01 00:00:00'</span>
    <span class="hljs-keyword">AND</span> ts <span class="hljs-operator">&lt;</span>  <span class="hljs-string">'2025-01-01 01:00:00'</span>
  <span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> DATE_TRUNC(<span class="hljs-string">'minute'</span>, ts)
)
<span class="hljs-keyword">SELECT</span> g.ts, r.v
<span class="hljs-keyword">FROM</span> time_grid g
<span class="hljs-keyword">LEFT</span> <span class="hljs-keyword">JOIN</span> raw r <span class="hljs-keyword">ON</span> r.ts <span class="hljs-operator">=</span> g.ts
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> g.ts;
</code></pre>
<h3 data-id="heading-21">4.6 告警计算：阈值 + 持续时间（避免“抖动误报”）</h3>
<p>不少告警规则并不是“超过阈值就立刻报”，而是“连续超过阈值 N 分钟才算”。这类需求更适合先在分钟聚合层算，再去识别连续段。</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">WITH</span> m1 <span class="hljs-keyword">AS</span> (
  <span class="hljs-keyword">SELECT</span>
    DATE_TRUNC(<span class="hljs-string">'minute'</span>, ts) <span class="hljs-keyword">AS</span> minute_ts,
    <span class="hljs-built_in">AVG</span>(<span class="hljs-keyword">value</span>) <span class="hljs-keyword">AS</span> avg_value
  <span class="hljs-keyword">FROM</span> telemetry_points
  <span class="hljs-keyword">WHERE</span> device_id <span class="hljs-operator">=</span> <span class="hljs-string">'D-10086'</span>
    <span class="hljs-keyword">AND</span> metric <span class="hljs-operator">=</span> <span class="hljs-string">'temperature'</span>
    <span class="hljs-keyword">AND</span> ts <span class="hljs-operator">&gt;=</span> <span class="hljs-string">'2025-01-01 00:00:00'</span>
    <span class="hljs-keyword">AND</span> ts <span class="hljs-operator">&lt;</span>  <span class="hljs-string">'2025-01-01 06:00:00'</span>
  <span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> DATE_TRUNC(<span class="hljs-string">'minute'</span>, ts)
),
flag <span class="hljs-keyword">AS</span> (
  <span class="hljs-keyword">SELECT</span>
    minute_ts,
    avg_value,
    <span class="hljs-keyword">CASE</span> <span class="hljs-keyword">WHEN</span> avg_value <span class="hljs-operator">&gt;=</span> <span class="hljs-number">80</span> <span class="hljs-keyword">THEN</span> <span class="hljs-number">1</span> <span class="hljs-keyword">ELSE</span> <span class="hljs-number">0</span> <span class="hljs-keyword">END</span> <span class="hljs-keyword">AS</span> over_th
  <span class="hljs-keyword">FROM</span> m1
),
grp <span class="hljs-keyword">AS</span> (
  <span class="hljs-keyword">SELECT</span>
    <span class="hljs-operator">*</span>,
    <span class="hljs-built_in">SUM</span>(<span class="hljs-keyword">CASE</span> <span class="hljs-keyword">WHEN</span> over_th <span class="hljs-operator">=</span> <span class="hljs-number">0</span> <span class="hljs-keyword">THEN</span> <span class="hljs-number">1</span> <span class="hljs-keyword">ELSE</span> <span class="hljs-number">0</span> <span class="hljs-keyword">END</span>) <span class="hljs-keyword">OVER</span> (<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> minute_ts) <span class="hljs-keyword">AS</span> grp_id
  <span class="hljs-keyword">FROM</span> flag
)
<span class="hljs-keyword">SELECT</span>
  <span class="hljs-built_in">MIN</span>(minute_ts) <span class="hljs-keyword">AS</span> start_ts,
  <span class="hljs-built_in">MAX</span>(minute_ts) <span class="hljs-keyword">AS</span> end_ts,
  <span class="hljs-built_in">COUNT</span>(<span class="hljs-operator">*</span>) <span class="hljs-keyword">AS</span> minutes
<span class="hljs-keyword">FROM</span> grp
<span class="hljs-keyword">WHERE</span> over_th <span class="hljs-operator">=</span> <span class="hljs-number">1</span>
<span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> grp_id
<span class="hljs-keyword">HAVING</span> <span class="hljs-built_in">COUNT</span>(<span class="hljs-operator">*</span>) <span class="hljs-operator">&gt;=</span> <span class="hljs-number">5</span>
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> start_ts;
</code></pre>
<hr/>
<h2 data-id="heading-22">5. 生命周期管理：热/温/冷分层与保留策略（落地可验收）</h2>
<p>时序项目最容易越跑越贵，原因往往很朴素：原始数据一直涨、聚合层没规划、过期数据清不掉（或者不敢清）。</p>
<p>一个实用的做法，是按业务价值把数据分三层：
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4847f42a74084e079a20e59150cf2a7e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YCU5by655qE55-z5aS0Xw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769253691&amp;x-signature=ewj21miKVR%2BFpb8MZhqW5Cls6LA%3D" alt="image.png" loading="lazy"/></p>
<p>这块怎么验收也不难，口径可以很清楚：</p>
<ul>
<li>分区切换与清理是否自动化；</li>
<li>聚合层是否按周期生成并可回补；</li>
<li>单次看板查询能否稳定在目标延迟（例如 1–3 秒级）。</li>
</ul>
<h3 data-id="heading-23">5.1 分区清理的最小可行策略：按“分区删除”而非“全表删除”</h3>
<p>过期数据的处理上，优先选“按分区删除/归档”，别用“全表扫一遍再删”的方式去赌运气，这样能绕开长事务和大量碎片带来的抖动风险。验收时就看两件事：清理窗口里系统稳不稳、清理耗时能不能预测。</p>
<h3 data-id="heading-24">5.2 用一张图理解“明细到指标”的数据金字塔</h3>
<pre><code class="hljs language-mermaid" lang="mermaid">flowchart TB
  A[原始明细点位&lt;br/&gt;秒级/更细] --&gt; B[分钟聚合&lt;br/&gt;看板主力]
  B --&gt; C[小时/天聚合&lt;br/&gt;报表与趋势]
  A --&gt; D[事件/告警表&lt;br/&gt;定位入口]
  D --&gt; A
</code></pre>
<hr/>
<h2 data-id="heading-25">6. 关键行业应用实践：三类场景、三种交付方式</h2>
<p>下面我就按“业务诉求—数据特征—落地打法”来写，你写征文或方案时也方便直接拿去用。</p>
<h3 data-id="heading-26">6.0 一张表把“场景诉求”映射到“金仓落地动作”</h3>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/edd77ec9032b4340bd1db610a7dc17aa~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YCU5by655qE55-z5aS0Xw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769253691&amp;x-signature=gzJi5WMn%2FRWaSWCfyBGSUYYJoPw%3D" alt="image.png" loading="lazy"/></p>
<p>顺带一提，“时间 + 业务维度”的联合分区/分片，以及把查询收敛到区间筛选与时间窗口这套写法，在金仓官网的时序分析文章里被反复强调，用它来当方案的设计抓手会更落地。[^kb-logs][^kb-safety]</p>
<h3 data-id="heading-27">6.1 电力与能源：设备状态监测 + 故障追溯</h3>
<p><strong>业务诉求</strong><br/>
设备状态量（电压、电流、温度、振动等）连续采集；异常发生后要能快速定位时间窗、关联工况与告警记录。</p>
<p><strong>数据特征</strong><br/>
点位多、采样周期短；峰值写入高；查询以“设备+时间段”为主，伴随聚合与对比。</p>
<p><strong>落地打法</strong></p>
<ul>
<li>用金仓时序数据库承载海量采集与检索，先把写入与查询基线压测跑出来，心里有数；[^kb-kes]</li>
<li>明细表按天分区；常用设备/指标建组合索引；</li>
<li>建分钟级聚合层供看板读；</li>
<li>故障追溯走“事件表 + 明细回放”链路。</li>
</ul>
<pre><code class="hljs language-mermaid" lang="mermaid">sequenceDiagram
  participant Dev as 设备/采集端
  participant Gw as 网关/消息队列
  participant TS as 金仓时序数据库
  participant BI as 看板/告警
  Dev-&gt;&gt;Gw: 批量上报(含序号/时间戳)
  Gw-&gt;&gt;TS: 批量写入/重试
  TS--&gt;&gt;BI: 分钟聚合指标
  BI--&gt;&gt;TS: 异常回放查询(设备+时间窗)
</code></pre>
<h3 data-id="heading-28">6.2 制造与工业互联网：OEE/能耗与质量波动分析</h3>
<p><strong>业务诉求</strong><br/>
把机台数据变成可运营指标（稼动率、能耗、节拍波动、良率关联），并能按产线/班组/工单维度分析。</p>
<p><strong>数据特征</strong><br/>
除时序明细外，必须强依赖维度（产线、工单、物料批次、工艺段）。</p>
<p><strong>落地打法</strong></p>
<ul>
<li>把时序事实表和业务维表放在金仓统一底座内，尽量少做跨库同步，把一致性治理的复杂度压下去；[^kb-kes]</li>
<li>“时序事实表 + 维表”建模：维表相对稳定，事实表高频写；</li>
<li>查询侧做“窗口聚合 + 维表关联”，把指标沉淀到报表层；</li>
<li>对关键指标做预聚合，减少峰值压力。</li>
</ul>
<h3 data-id="heading-29">6.3 交通与城市运行：多源融合监测与态势感知</h3>
<p><strong>业务诉求</strong><br/>
融合多源数据（设备、环境、视频结构化指标、路网状态），要求稳定接入、实时聚合与趋势判断。</p>
<p><strong>数据特征</strong><br/>
来源多、格式不一、质量参差；需要统一时间对齐与数据质量管理。</p>
<p><strong>落地打法</strong></p>
<ul>
<li>接入层规范化：统一时间口径、统一设备ID映射；</li>
<li>入库前做基础质量校验（缺测、重复、异常值标记）；</li>
<li>用聚合层支撑全市/全网态势看板，用明细层支撑局部排障回放。</li>
<li>需要空间维度（区域、路段、围栏）时，可结合时序与空间数据做联合筛选，把“时间窗 + 空间范围”的查询收敛成可复用模板。[^kb-kes][^kb-safety]</li>
</ul>
<hr/>
<h2 data-id="heading-30">7. 国产化替代背景下：怎么把“可用”做成“好用、稳用、可持续用”</h2>
<p>国产化替代项目真正的关键，通常不是“能不能替”，而是把风险尽量从“上线后暴露”前移到“上线前可控”。比较稳的推进方式，可以沿着“三条主线”走：</p>
<h3 data-id="heading-31">7.1 主线一：选型与验证（可量化、可复测）</h3>
<p>验证集建议至少覆盖这些维度：</p>
<ul>
<li>
<p>写入：峰值吞吐、乱序补写、重试幂等；</p>
</li>
<li>
<p>查询：典型看板/报表/回放 SQL 的稳定延迟；</p>
</li>
<li>
<p>运维：备份恢复、扩容、分区维护、生命周期清理；</p>
</li>
<li>
<p>安全：权限隔离、审计留痕、账号策略与合规要求。</p>
</li>
</ul>
<p>更为关键的是要将验证动作和工具链关联起来，迁移评定，数据迁移，开发守护以及集中运维这些环节都应该凝结成可回溯的交付物，不可让替代项目仅依靠记忆或者经验存在。</p>
<h3 data-id="heading-32">7.2 主线二：数据分层与指标体系（让成本与性能可控）</h3>
<p>比较实用的做法，是先把指标分成三类：</p>
<ul>
<li>需要秒级：走分钟聚合层或更细粒度的预聚合；</li>
<li>需要分钟级：直接查聚合层；</li>
<li>需要追溯：从事件定位，再回放明细层。</li>
</ul>
<p>这样资源消耗就能从“每次都扫明细”变成“多数读聚合，少数回放明细”，性能和成本都会稳很多。</p>
<h3 data-id="heading-33">7.3 主线三：运维闭环（让系统在生产中持续稳定）</h3>
<p>建议把下面这些事做成日常动作，别等出问题才想起来：</p>
<ul>
<li>
<p>分区自动创建与过期清理；</p>
</li>
<li>
<p>聚合层按计划刷新并具备回补窗口；</p>
</li>
<li>
<p>指标监控：写入延迟、查询 P95、磁盘增长、分区数量、慢查询；</p>
</li>
<li>
<p>灾备演练：按季度做恢复演练与容量回归。</p>
</li>
</ul>
<hr/>
<h2 data-id="heading-34">结语：用“可交付的时序工程”把机会点落到现实</h2>
<p>2025年的时序数据库竞争渐渐变成了一场工程交付能力的较量，谁能将写入，存储，查询，治理，运维形成起一套可复用的体系，谁就更有可能在关键行业中做到规模扩张。</p>
<p>如果你正在推动关键行业时序数据平台的创建或者进行国产化替代，建议先把“数据分层，分区生命周期，预聚合”这三件事做好，然后逐步深入地完善指标体系和运维闭环。想了解更多产品与方案，可以到金仓数据库官网看看：<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.kingbase.com.cn%2F" target="_blank" title="https://www.kingbase.com.cn/" ref="nofollow noopener noreferrer">www.kingbase.com.cn/</a></p>
<p>👉 <strong>金仓数据库官方博客站</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Fkingbase.com.cn%2Fexplore" target="_blank" title="https://kingbase.com.cn/explore" ref="nofollow noopener noreferrer">kingbase.com.cn/explore</a><br/>
想继续深挖的话，这里有不少专家文章、原理解析和最佳实践，可以按场景直接挑着看。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4489bfd0539c468cbea4c95c197e29aa~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YCU5by655qE55-z5aS0Xw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769253691&amp;x-signature=uTf9%2BxessAbK49jLIj8bLrmJd5Q%3D" alt="image.png" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[🌰在 OpenLayers 中实现图层裁切]]></title>    <link>https://juejin.cn/post/7595890117865701422</link>    <guid>https://juejin.cn/post/7595890117865701422</guid>    <pubDate>2026-01-17T11:31:43.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7595890117865701422" data-draft-id="7595894884956864563" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="🌰在 OpenLayers 中实现图层裁切"/> <meta itemprop="keywords" content="前端,GIS"/> <meta itemprop="datePublished" content="2026-01-17T11:31:43.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="黑心皮蛋"/> <meta itemprop="url" content="https://juejin.cn/user/3738785874458039"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            🌰在 OpenLayers 中实现图层裁切
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3738785874458039/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    黑心皮蛋
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-17T11:31:43.000Z" title="Sat Jan 17 2026 11:31:43 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-17
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{font-family:-apple-system,system-ui,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial;color:#00325e}.markdown-body ::selection{background-color:#00325e;color:#fff}.markdown-body blockquote{padding:10px 20px;background-color:#fffaf0;box-shadow:0 3px 10px 0 rgba(255,172,194,.24);border:1px solid #f3ca8e;transition:all .2s;margin:1em 0;border-radius:5px}.markdown-body blockquote p{font-size:14px;line-height:25px;color:#795548}.markdown-body blockquote p:last-child{margin:0}.markdown-body blockquote:hover{border-color:#ff9800;background-color:#fff8e0;box-shadow:0 6px 10px -5px rgba(225,173,98,.3803921569)}.markdown-body blockquote code{color:#ff502c}.markdown-body pre{border:1px solid #8cc0f3;box-shadow:0 3px 10px 0 rgba(255,198,198,.28);border-radius:5px;transition:all .2s;overflow-x:auto;white-space:pre-wrap}.markdown-body pre:hover{border-color:#6d9dce}.markdown-body pre&gt;code{padding:10px 20px;color:#00325e;background:#f0f8ff;font-size:12px;line-height:1.6;display:block}.markdown-body code{background:#f6fbff;color:#0b5393;padding:2px 4px;border-radius:4px;font-size:12px}.markdown-body p{font-size:14px;line-height:28px;text-align:justify;margin-bottom:17px;color:#595959}.markdown-body a{color:#00325e;text-decoration:none}.markdown-body a:after{content:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAoAAAAKCAYAAACNMs+9AAAAAXNSR0IArs4c6QAAAQdJREFUKFNt0DtLA0EUBeBzZle0Eks7rcUfEfBRCha7NorYa6NmVJzgyi4smUgKtdZGCJktLMVH4Y8QeztLWyE7VyLEuNFbXj4Oh0P8c8mZm+uJrEN4BJFTeP/MUVe3bnocfALwkOlo1zS7iZAzf6Cx7oXgbaqjxiDEWCcVaGyxQ8pSWo9XhqhoQ/xUFbaKjhe5V+CmR7mnSplEEF6GSmJ+F/d0KHvbCIIJCLc85U6BC5mONgbJNM3uFag++sX7z8O8MzsWBucifMx0dDGE1kmm458KDVukAlnNdDz/exEeW3dNkbfsYC0xtmgDWP6ELLZ0/F6BJu/UoFQN5AkoeUjeJPvx6+i+X5Sjah4tA6gYAAAAAElFTkSuQmCC);margin-left:2px}.markdown-body a:hover{box-shadow:0 1px}.markdown-body table{max-width:100%;border-collapse:collapse;border-spacing:0;box-shadow:0 3px 10px 0 rgba(255,238,172,.24);transition:all .2s}.markdown-body table:hover{box-shadow:0 3px 10px 0 rgba(185,169,103,.24)}.markdown-body table tr th{border:1px solid #8cc0f3;background-color:#f0f8ff;padding:12px 15px}.markdown-body table tr td{border:1px solid rgba(243,202,142,.4);padding:12px 15px}.markdown-body table tbody tr{transition:all .2s}.markdown-body table tbody tr:hover td{border-color:#f3ca8e;background-color:#fff8e0;z-index:1}.markdown-body img{max-width:100%}.markdown-body h1{font-size:20px;margin-top:30px;margin-bottom:10px;padding-left:30px;position:relative}.markdown-body h1&gt;code{font-size:20px}.markdown-body h1:before{content:"🍺";display:block;font-size:18px;width:18px;height:18px;left:0;position:absolute}.markdown-body h2{font-size:18px;margin-top:30px;margin-bottom:10px;padding-left:28px;position:relative}.markdown-body h2&gt;code{font-size:18px}.markdown-body h2:before{content:"🍻";display:block;font-size:16px;width:16px;height:16px;left:0;position:absolute}.markdown-body h3{font-size:16px;margin-top:30px;margin-bottom:10px;padding-left:26px;position:relative}.markdown-body h3&gt;code{font-size:16px}.markdown-body h3:before{content:"🥂";display:block;font-size:14px;width:14px;height:14px;left:0;position:absolute}.markdown-body h4{font-size:14px;margin-top:30px;margin-bottom:10px;padding-left:24px;position:relative}.markdown-body h4&gt;code{font-size:14px}.markdown-body h4:before{content:"🥃";display:block;font-size:12px;width:12px;height:12px;left:0;position:absolute}.markdown-body h5{font-size:12px;margin-top:30px;margin-bottom:10px}.markdown-body h5&gt;code{font-size:12px}.markdown-body h6{font-size:10px;margin-top:30px;margin-bottom:10px}.markdown-body h6&gt;code{font-size:10px}.markdown-body h1,.markdown-body h2{color:#ff502c}.markdown-body hr{height:4px;border:none;margin-top:32px;margin-bottom:32px;background-size:4px 1px;background-image:linear-gradient(270deg,#6d9dce,#8cc0f3 25%,transparent 50%)}.markdown-body hr:nth-child(2n){background-image:linear-gradient(270deg,#ff9800,#fff8e0 25%,transparent 50%)}.markdown-body ul{padding-inline-start:20px}.markdown-body ul li{list-style-type:"🔸"}.markdown-body ul li li{list-style-type:"◻️"}.markdown-body ul li li li{list-style-type:"▫️"}.markdown-body ol{padding-inline-start:20px}.markdown-body ol ::marker{color:#ff9800}.markdown-body ol,.markdown-body ul{line-height:2em}.markdown-body li{padding-inline-start:1ch}.markdown-body li.task-list-item{list-style:none;padding-inline-start:0}.markdown-body li input{padding-right:2px}.markdown-body li input[type=checkbox i]{appearance:none}.markdown-body li input:before{content:"🟩";display:block;width:13px;height:13px}.markdown-body li input:checked:before{content:"✅"}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="atelier-sulphurpool-light">.hljs-comment,.hljs-quote{color:#6b7394}.hljs-attribute,.hljs-link,.hljs-name,.hljs-regexp,.hljs-selector-class,.hljs-selector-id,.hljs-tag,.hljs-template-variable,.hljs-variable{color:#c94922}.hljs-built_in,.hljs-builtin-name,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-type{color:#c76b29}.hljs-bullet,.hljs-string,.hljs-symbol{color:#ac9739}.hljs-section,.hljs-title{color:#3d8fd1}.hljs-keyword,.hljs-selector-tag{color:#6679cc}.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#f5f7ff;color:#5e6687}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9bb77a589b2f40f2a4eec2a5f9415aab~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6buR5b-D55qu6JuL:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769254303&amp;x-signature=zhS0YkFsCOPczuk7iFb0uBq%2FV%2FU%3D" alt="img" loading="lazy"/>💬 前言</h2>
<p>​	做地图的时候，常会给地图套个“遮罩”——把不关心的地方调暗，把想看的地方突出出来。但有时我们并不想动整张地图的视觉效果，只想把某一张图层按不规则形状展示出来，比如只在某块多边形里显示指定图层。</p>
<h2 data-id="heading-1">🎯 最终效果如下</h2>
<blockquote>
<p>给定一个多边形（polygonCoords），对单一 WMTS/瓦片图层进行裁切：图层仅在该多边形内部可见，其他图层不受影响。</p>
</blockquote>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fb736c5ae789455e90444e1b40ce72b6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6buR5b-D55qu6JuL:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769254303&amp;x-signature=euEHOYoOheo8D9TBYBPI3PK9Pbo%3D" alt="图层裁切最终效果" loading="lazy"/></p>
<h2 data-id="heading-2">🧭 实现思路</h2>
<blockquote>
<p>通过监听图层的 prerender 事件 和 postrender事件 实现裁切</p>
</blockquote>
<ol>
<li>在图层开始绘制之前（prerender）准备裁切：
<ul>
<li>回调里会拿到两个东西：OpenLayers 的矢量渲染上下文和原生的 Canvas 上下文（ctx）。</li>
<li>先用 ctx.save() 保存当前 canvas 状态。</li>
<li>用 <code>drawFeature(feature, style)</code> 把多边形画到当前画布上（这会在 canvas 上生成路径）。</li>
<li>然后调用 <code>ctx.clip()</code>，把这条路径设为裁切区,将当前图层进行裁切。</li>
</ul>
</li>
<li>在图层绘制结束后（postrender）恢复状态：
<ul>
<li>在 postrender 回调里调用 <code>ctx.restore()</code>，把之前保存的 canvas 状态还原，移除裁切，确保别的图层不受影响。</li>
</ul>
</li>
</ol>
<h2 data-id="heading-3">⚙️ 初始化项目</h2>
<p>​	这里我设置地图的坐标系是3857,你可以根据自己的需要设置对应的坐标系</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"zh-cn"</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">"UTF-8"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"viewport"</span> <span class="hljs-attr">content</span>=<span class="hljs-string">"width=device-width, initial-scale=1.0"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>openlayer图层裁切<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">style</span>&gt;</span><span class="css">
        <span class="hljs-selector-tag">html</span>,
        <span class="hljs-selector-tag">body</span>,
        <span class="hljs-selector-id">#map</span> {
            <span class="hljs-attribute">width</span>: <span class="hljs-number">100%</span>;
            <span class="hljs-attribute">height</span>: <span class="hljs-number">100%</span>;
            <span class="hljs-attribute">margin</span>: <span class="hljs-number">0</span>;
            <span class="hljs-attribute">padding</span>: <span class="hljs-number">0</span>;
        }
    </span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"map"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"./ol.js"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
        <span class="hljs-keyword">const</span> projection = ol.<span class="hljs-property">proj</span>.<span class="hljs-title function_">get</span>(<span class="hljs-string">'EPSG:3857'</span>);
        <span class="hljs-keyword">const</span> map = <span class="hljs-keyword">new</span> ol.<span class="hljs-title class_">Map</span>({
            <span class="hljs-attr">layers</span>: [
                <span class="hljs-comment">// 矢量底图</span>
                <span class="hljs-keyword">new</span> ol.<span class="hljs-property">layer</span>.<span class="hljs-title class_">Tile</span>({
                    <span class="hljs-attr">source</span>: <span class="hljs-keyword">new</span> ol.<span class="hljs-property">source</span>.<span class="hljs-title function_">XYZ</span>({
                        <span class="hljs-attr">url</span>: <span class="hljs-string">`https://t{0-7}.tianditu.gov.cn/DataServer?T=vec_w&amp;x={x}&amp;y={y}&amp;l={z}&amp;tk=2aedde694311cf1e8ac3feca2da4fd3e`</span>,
                    }),
                }),
                <span class="hljs-comment">// 矢量注记</span>
                <span class="hljs-keyword">new</span> ol.<span class="hljs-property">layer</span>.<span class="hljs-title class_">Tile</span>({
                    <span class="hljs-attr">source</span>: <span class="hljs-keyword">new</span> ol.<span class="hljs-property">source</span>.<span class="hljs-title function_">XYZ</span>({
                        <span class="hljs-attr">url</span>: <span class="hljs-string">`https://t{0-7}.tianditu.gov.cn/DataServer?T=cva_w&amp;x={x}&amp;y={y}&amp;l={z}&amp;tk=2aedde694311cf1e8ac3feca2da4fd3e`</span>,
                    }),
                }),
            ],
            <span class="hljs-attr">target</span>: <span class="hljs-string">'map'</span>,
            <span class="hljs-attr">view</span>: <span class="hljs-keyword">new</span> ol.<span class="hljs-title class_">View</span>({
                <span class="hljs-attr">zoom</span>: <span class="hljs-number">5</span>,
                <span class="hljs-attr">maxZoom</span>: <span class="hljs-number">17</span>,
                <span class="hljs-attr">minZoom</span>: <span class="hljs-number">1</span>,
                <span class="hljs-attr">projection</span>: projection,
                <span class="hljs-attr">center</span>: [<span class="hljs-number">116.406393</span>, <span class="hljs-number">39.909006</span>],
            }),
        })
    </span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>

<span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span>
</code></pre>
<p>效果如下</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8a43574a3cdc4763a027c2523cffc589~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6buR5b-D55qu6JuL:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769254303&amp;x-signature=RN3t1%2Fm7CT5YmRvO0DDmnUOqnHQ%3D" alt="image-20260117182119131" loading="lazy"/></p>
<h2 data-id="heading-4">📐 多边形预览</h2>
<p>​	前面实现思路说了,我们需要一个多边形裁切图层,我这里准备了一个</p>
<pre><code class="hljs language-js" lang="js">   <span class="hljs-keyword">const</span> polygonCoords =
                [
                    [
                        [
                            <span class="hljs-number">911245.7835522988</span>,
                            <span class="hljs-number">1672839.829528198</span>
                        ],
                        [
                            <span class="hljs-number">1517290.255658307</span>,
                            <span class="hljs-number">2962709.5078420187</span>
                        ],
                        [
                            <span class="hljs-number">2862581.9534774087</span>,
                            <span class="hljs-number">3011639.670051078</span>
                        ],
                        [
                            <span class="hljs-number">3492423.0665472616</span>,
                            <span class="hljs-number">2736407.507625122</span>
                        ],
                        [
                            <span class="hljs-number">3675871.934431684</span>,
                            <span class="hljs-number">2161478.101668681</span>
                        ],
                        [
                            <span class="hljs-number">3131640.2930412292</span>,
                            <span class="hljs-number">1647711.398473564</span>
                        ],
                        [
                            <span class="hljs-number">2141016.406465345</span>,
                            <span class="hljs-number">999386.7492035348</span>
                        ],
                        [
                            <span class="hljs-number">2581293.6893879604</span>,
                            <span class="hljs-number">63597.39695528569</span>
                        ],
                        [
                            <span class="hljs-number">2165476.2555166017</span>,
                            -<span class="hljs-number">523564.5495534199</span>
                        ],
                        [
                            <span class="hljs-number">3107180.4439899744</span>,
                            -<span class="hljs-number">982284.8202633462</span>
                        ],
                        [
                            <span class="hljs-number">2232740.8404075587</span>,
                            -<span class="hljs-number">1379842.3882119493</span>
                        ],
                        [
                            <span class="hljs-number">1609014.6896005198</span>,
                            -<span class="hljs-number">1300330.874622228</span>
                        ],
                        [
                            <span class="hljs-number">1040323.1991588091</span>,
                            -<span class="hljs-number">1104610.2257859926</span>
                        ],
                        [
                            <span class="hljs-number">471631.7087170966</span>,
                            -<span class="hljs-number">450169.3062398317</span>
                        ],
                        [
                            <span class="hljs-number">465516.74645428266</span>,
                            <span class="hljs-number">240969.23496312322</span>
                        ],
                        [
                            <span class="hljs-number">324872.6144095585</span>,
                            <span class="hljs-number">913758.9653376816</span>
                        ],
                        [
                            <span class="hljs-number">593930.953973379</span>,
                            <span class="hljs-number">1757804.2634439464</span>
                        ],
                        [
                            <span class="hljs-number">911245.7835522988</span>,
                            <span class="hljs-number">1672839.829528198</span>
                        ]
                    ]
                ]

</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4f7410564aeb478e9827fd817cf71849~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6buR5b-D55qu6JuL:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769254303&amp;x-signature=%2Bkjd2JTkSK9KdsclpRGCcUj429U%3D" alt="image-20260117190344593" loading="lazy"/></p>
<p>后面就会用这个多边形来对图层进行裁切</p>
<h2 data-id="heading-5">🗺️ 添加一张影像图</h2>
<pre><code class="hljs language-html" lang="html"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"zh-cn"</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">"UTF-8"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"viewport"</span> <span class="hljs-attr">content</span>=<span class="hljs-string">"width=device-width, initial-scale=1.0"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>openlayer图层裁切<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">style</span>&gt;</span><span class="css">
        <span class="hljs-selector-tag">html</span>,
        <span class="hljs-selector-tag">body</span>,
        <span class="hljs-selector-id">#map</span> {
            <span class="hljs-attribute">width</span>: <span class="hljs-number">100%</span>;
            <span class="hljs-attribute">height</span>: <span class="hljs-number">100%</span>;
            <span class="hljs-attribute">margin</span>: <span class="hljs-number">0</span>;
            <span class="hljs-attribute">padding</span>: <span class="hljs-number">0</span>;
        }
    </span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"map"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"./ol.js"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
        <span class="hljs-keyword">const</span> projection = ol.<span class="hljs-property">proj</span>.<span class="hljs-title function_">get</span>(<span class="hljs-string">'EPSG:3857'</span>);
        <span class="hljs-keyword">const</span> projectionExtent = projection.<span class="hljs-title function_">getExtent</span>();
        <span class="hljs-keyword">const</span> size = ol.<span class="hljs-property">extent</span>.<span class="hljs-title function_">getWidth</span>(projectionExtent) / <span class="hljs-number">256</span>;
        <span class="hljs-keyword">const</span> resolutions = [];
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> z = <span class="hljs-number">2</span>; z &lt; <span class="hljs-number">19</span>; ++z) {
            resolutions[z] = size / <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">pow</span>(<span class="hljs-number">2</span>, z);
        }
        <span class="hljs-keyword">const</span> matrixIds = [<span class="hljs-string">'0'</span>,
            <span class="hljs-string">'1'</span>,
            <span class="hljs-string">'2'</span>,
            <span class="hljs-string">'3'</span>,
            <span class="hljs-string">'4'</span>,
            <span class="hljs-string">'5'</span>,
            <span class="hljs-string">'6'</span>,
            <span class="hljs-string">'7'</span>,
            <span class="hljs-string">'8'</span>,
            <span class="hljs-string">'9'</span>,
            <span class="hljs-string">'10'</span>,
            <span class="hljs-string">'11'</span>,
            <span class="hljs-string">'12'</span>,
            <span class="hljs-string">'13'</span>,
            <span class="hljs-string">'14'</span>,
            <span class="hljs-string">'15'</span>,
            <span class="hljs-string">'16'</span>,
            <span class="hljs-string">'17'</span>,
            <span class="hljs-string">'18'</span>]
        <span class="hljs-keyword">const</span> map = <span class="hljs-keyword">new</span> ol.<span class="hljs-title class_">Map</span>({
            <span class="hljs-attr">layers</span>: [
                <span class="hljs-comment">// 矢量底图</span>
                <span class="hljs-keyword">new</span> ol.<span class="hljs-property">layer</span>.<span class="hljs-title class_">Tile</span>({
                    <span class="hljs-attr">source</span>: <span class="hljs-keyword">new</span> ol.<span class="hljs-property">source</span>.<span class="hljs-title function_">XYZ</span>({
                        <span class="hljs-attr">url</span>: <span class="hljs-string">`https://t{0-7}.tianditu.gov.cn/DataServer?T=vec_w&amp;x={x}&amp;y={y}&amp;l={z}&amp;tk=2aedde694311cf1e8ac3feca2da4fd3e`</span>,
                    }),
                }),
                <span class="hljs-comment">// 矢量注记</span>
                <span class="hljs-keyword">new</span> ol.<span class="hljs-property">layer</span>.<span class="hljs-title class_">Tile</span>({
                    <span class="hljs-attr">source</span>: <span class="hljs-keyword">new</span> ol.<span class="hljs-property">source</span>.<span class="hljs-title function_">XYZ</span>({
                        <span class="hljs-attr">url</span>: <span class="hljs-string">`https://t{0-7}.tianditu.gov.cn/DataServer?T=cva_w&amp;x={x}&amp;y={y}&amp;l={z}&amp;tk=2aedde694311cf1e8ac3feca2da4fd3e`</span>,
                    }),
                }),
            ],
            <span class="hljs-attr">target</span>: <span class="hljs-string">'map'</span>,
            <span class="hljs-attr">view</span>: <span class="hljs-keyword">new</span> ol.<span class="hljs-title class_">View</span>({
                <span class="hljs-attr">zoom</span>: <span class="hljs-number">5</span>,
                <span class="hljs-attr">maxZoom</span>: <span class="hljs-number">17</span>,
                <span class="hljs-attr">minZoom</span>: <span class="hljs-number">1</span>,
                <span class="hljs-attr">projection</span>: projection,
                <span class="hljs-attr">center</span>: [<span class="hljs-number">116.406393</span>, <span class="hljs-number">39.909006</span>],
            }),
        })
        <span class="hljs-keyword">const</span> wmtsLayer = <span class="hljs-keyword">new</span> ol.<span class="hljs-property">layer</span>.<span class="hljs-title class_">Tile</span>({
            <span class="hljs-attr">source</span>: <span class="hljs-keyword">new</span> ol.<span class="hljs-property">source</span>.<span class="hljs-title function_">WMTS</span>({
                <span class="hljs-attr">url</span>: <span class="hljs-string">`http://t{0-6}.tianditu.gov.cn/img_c/wmts?tk=2aedde694311cf1e8ac3feca2da4fd3e`</span>,
                <span class="hljs-attr">layer</span>: <span class="hljs-string">'img'</span>,
                <span class="hljs-attr">matrixSet</span>: <span class="hljs-string">'c'</span>,
                <span class="hljs-attr">style</span>: <span class="hljs-string">'default'</span>,
                <span class="hljs-attr">crossOrigin</span>: <span class="hljs-string">'anonymous'</span>,
                <span class="hljs-attr">format</span>: <span class="hljs-string">'tiles'</span>,
                <span class="hljs-attr">wrapX</span>: <span class="hljs-literal">true</span>,
                <span class="hljs-attr">crossOrigin</span>: <span class="hljs-string">'anonymous'</span>,
                <span class="hljs-attr">tileGrid</span>: <span class="hljs-keyword">new</span> ol.<span class="hljs-property">tilegrid</span>.<span class="hljs-title function_">WMTS</span>({
                    <span class="hljs-attr">origin</span>: ol.<span class="hljs-property">extent</span>.<span class="hljs-title function_">getTopLeft</span>(projectionExtent),
                    <span class="hljs-attr">resolutions</span>: resolutions,
                    <span class="hljs-attr">matrixIds</span>: matrixIds
                })
            })
        })
        map.<span class="hljs-title function_">addLayer</span>(wmtsLayer);
    </span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>

<span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span>
</code></pre>
<p>效果如下</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bd3566be6a6c415e81caa2a99d625fd9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6buR5b-D55qu6JuL:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769254303&amp;x-signature=f5pvYkkuGT3v4ZZpmDSqjln99w8%3D" alt="image-20260117191715249" loading="lazy"/></p>
<h2 data-id="heading-6">🔔 监听图层事件</h2>
<p>前面已经将这个影像图添加到地图上面去了, 接下来就可以监听这个图层事件,然后用多边形去裁切这张图层</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// wmtsLayer 就是前面添加的影像图</span>
wmtsLayer.<span class="hljs-title function_">on</span>(<span class="hljs-string">'prerender'</span>, <span class="hljs-keyword">function</span> (<span class="hljs-params">evt</span>) {
    <span class="hljs-keyword">const</span> layerContent = ol.<span class="hljs-property">render</span>.<span class="hljs-title function_">getVectorContext</span>(evt)
    <span class="hljs-keyword">const</span> ctx = evt.<span class="hljs-property">context</span>;
    ctx.<span class="hljs-title function_">save</span>();
    layerContent.<span class="hljs-title function_">drawFeature</span>(polygon, polygonStyle)
    ctx.<span class="hljs-title function_">clip</span>();
});

<span class="hljs-comment">// 渲染后恢复 canvas 状态，移除裁切</span>
wmtsLayer.<span class="hljs-title function_">on</span>(<span class="hljs-string">'postrender'</span>, <span class="hljs-keyword">function</span> (<span class="hljs-params">evt</span>) {
    <span class="hljs-keyword">const</span> ctx = evt.<span class="hljs-property">context</span>;
    <span class="hljs-keyword">if</span> (ctx) ctx.<span class="hljs-title function_">restore</span>();
});
<span class="hljs-keyword">const</span> layer = map.<span class="hljs-title function_">addLayer</span>(wmtsLayer);
</code></pre>
<h2 data-id="heading-7">📄 完整代码</h2>
<pre><code class="hljs language-html" lang="html"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"zh-cn"</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">"UTF-8"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"viewport"</span> <span class="hljs-attr">content</span>=<span class="hljs-string">"width=device-width, initial-scale=1.0"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>openlayer图层裁切<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">style</span>&gt;</span><span class="css">
        <span class="hljs-selector-tag">html</span>,
        <span class="hljs-selector-tag">body</span>,
        <span class="hljs-selector-id">#map</span> {
            <span class="hljs-attribute">width</span>: <span class="hljs-number">100%</span>;
            <span class="hljs-attribute">height</span>: <span class="hljs-number">100%</span>;
            <span class="hljs-attribute">margin</span>: <span class="hljs-number">0</span>;
            <span class="hljs-attribute">padding</span>: <span class="hljs-number">0</span>;
        }

        <span class="hljs-comment">/* 右上角形状按钮组 */</span>
        <span class="hljs-selector-id">#shape-controls</span> {
            <span class="hljs-attribute">position</span>: fixed;
            <span class="hljs-attribute">top</span>: <span class="hljs-number">12px</span>;
            <span class="hljs-attribute">right</span>: <span class="hljs-number">12px</span>;
            <span class="hljs-attribute">display</span>: flex;
            <span class="hljs-attribute">flex-direction</span>: column;
            <span class="hljs-attribute">gap</span>: <span class="hljs-number">8px</span>;
            <span class="hljs-attribute">z-index</span>: <span class="hljs-number">1000</span>;
        }

        <span class="hljs-selector-id">#shape-controls</span> <span class="hljs-selector-tag">button</span> {
            <span class="hljs-attribute">padding</span>: <span class="hljs-number">6px</span> <span class="hljs-number">10px</span>;
            <span class="hljs-attribute">font-size</span>: <span class="hljs-number">14px</span>;
            <span class="hljs-attribute">cursor</span>: pointer;
        }

        <span class="hljs-selector-id">#shape-controls</span> <span class="hljs-selector-tag">button</span><span class="hljs-selector-class">.active</span> {
            <span class="hljs-attribute">background</span>: <span class="hljs-number">#0b5ed7</span>;
            <span class="hljs-attribute">color</span>: <span class="hljs-number">#fff</span>;
        }
    </span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"map"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"shape-controls"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"btn-polygon"</span>&gt;</span>添加多边形影像图<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"./ol.js"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
        <span class="hljs-keyword">const</span> projection = ol.<span class="hljs-property">proj</span>.<span class="hljs-title function_">get</span>(<span class="hljs-string">'EPSG:3857'</span>);
        <span class="hljs-keyword">const</span> projectionExtent = projection.<span class="hljs-title function_">getExtent</span>();
        <span class="hljs-keyword">const</span> size = ol.<span class="hljs-property">extent</span>.<span class="hljs-title function_">getWidth</span>(projectionExtent) / <span class="hljs-number">256</span>;
        <span class="hljs-keyword">const</span> resolutions = [];
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> z = <span class="hljs-number">2</span>; z &lt; <span class="hljs-number">19</span>; ++z) {
            resolutions[z] = size / <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">pow</span>(<span class="hljs-number">2</span>, z);
        }
        <span class="hljs-keyword">const</span> matrixIds = [<span class="hljs-string">'0'</span>,
            <span class="hljs-string">'1'</span>,
            <span class="hljs-string">'2'</span>,
            <span class="hljs-string">'3'</span>,
            <span class="hljs-string">'4'</span>,
            <span class="hljs-string">'5'</span>,
            <span class="hljs-string">'6'</span>,
            <span class="hljs-string">'7'</span>,
            <span class="hljs-string">'8'</span>,
            <span class="hljs-string">'9'</span>,
            <span class="hljs-string">'10'</span>,
            <span class="hljs-string">'11'</span>,
            <span class="hljs-string">'12'</span>,
            <span class="hljs-string">'13'</span>,
            <span class="hljs-string">'14'</span>,
            <span class="hljs-string">'15'</span>,
            <span class="hljs-string">'16'</span>,
            <span class="hljs-string">'17'</span>,
            <span class="hljs-string">'18'</span>]
        <span class="hljs-keyword">const</span> map = <span class="hljs-keyword">new</span> ol.<span class="hljs-title class_">Map</span>({
            <span class="hljs-attr">layers</span>: [
                <span class="hljs-comment">// 矢量底图</span>
                <span class="hljs-keyword">new</span> ol.<span class="hljs-property">layer</span>.<span class="hljs-title class_">Tile</span>({
                    <span class="hljs-attr">source</span>: <span class="hljs-keyword">new</span> ol.<span class="hljs-property">source</span>.<span class="hljs-title function_">XYZ</span>({
                        <span class="hljs-attr">url</span>: <span class="hljs-string">`https://t{0-7}.tianditu.gov.cn/DataServer?T=vec_w&amp;x={x}&amp;y={y}&amp;l={z}&amp;tk=2aedde694311cf1e8ac3feca2da4fd3e`</span>,
                    }),
                }),
                <span class="hljs-comment">// 矢量注记</span>
                <span class="hljs-keyword">new</span> ol.<span class="hljs-property">layer</span>.<span class="hljs-title class_">Tile</span>({
                    <span class="hljs-attr">source</span>: <span class="hljs-keyword">new</span> ol.<span class="hljs-property">source</span>.<span class="hljs-title function_">XYZ</span>({
                        <span class="hljs-attr">url</span>: <span class="hljs-string">`https://t{0-7}.tianditu.gov.cn/DataServer?T=cva_w&amp;x={x}&amp;y={y}&amp;l={z}&amp;tk=2aedde694311cf1e8ac3feca2da4fd3e`</span>,
                    }),
                }),
            ],
            <span class="hljs-attr">target</span>: <span class="hljs-string">'map'</span>,
            <span class="hljs-attr">view</span>: <span class="hljs-keyword">new</span> ol.<span class="hljs-title class_">View</span>({
                <span class="hljs-attr">zoom</span>: <span class="hljs-number">5</span>,
                <span class="hljs-attr">maxZoom</span>: <span class="hljs-number">17</span>,
                <span class="hljs-attr">minZoom</span>: <span class="hljs-number">1</span>,
                <span class="hljs-attr">projection</span>: projection,
                <span class="hljs-attr">center</span>: [<span class="hljs-number">116.406393</span>, <span class="hljs-number">39.909006</span>],
            }),
        })

        <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'btn-polygon'</span>).<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'click'</span>, <span class="hljs-keyword">function</span> (<span class="hljs-params"/>) {
            <span class="hljs-keyword">const</span> polygonCoords =
                [
                    [
                        [
                            <span class="hljs-number">911245.7835522988</span>,
                            <span class="hljs-number">1672839.829528198</span>
                        ],
                        [
                            <span class="hljs-number">1517290.255658307</span>,
                            <span class="hljs-number">2962709.5078420187</span>
                        ],
                        [
                            <span class="hljs-number">2862581.9534774087</span>,
                            <span class="hljs-number">3011639.670051078</span>
                        ],
                        [
                            <span class="hljs-number">3492423.0665472616</span>,
                            <span class="hljs-number">2736407.507625122</span>
                        ],
                        [
                            <span class="hljs-number">3675871.934431684</span>,
                            <span class="hljs-number">2161478.101668681</span>
                        ],
                        [
                            <span class="hljs-number">3131640.2930412292</span>,
                            <span class="hljs-number">1647711.398473564</span>
                        ],
                        [
                            <span class="hljs-number">2141016.406465345</span>,
                            <span class="hljs-number">999386.7492035348</span>
                        ],
                        [
                            <span class="hljs-number">2581293.6893879604</span>,
                            <span class="hljs-number">63597.39695528569</span>
                        ],
                        [
                            <span class="hljs-number">2165476.2555166017</span>,
                            -<span class="hljs-number">523564.5495534199</span>
                        ],
                        [
                            <span class="hljs-number">3107180.4439899744</span>,
                            -<span class="hljs-number">982284.8202633462</span>
                        ],
                        [
                            <span class="hljs-number">2232740.8404075587</span>,
                            -<span class="hljs-number">1379842.3882119493</span>
                        ],
                        [
                            <span class="hljs-number">1609014.6896005198</span>,
                            -<span class="hljs-number">1300330.874622228</span>
                        ],
                        [
                            <span class="hljs-number">1040323.1991588091</span>,
                            -<span class="hljs-number">1104610.2257859926</span>
                        ],
                        [
                            <span class="hljs-number">471631.7087170966</span>,
                            -<span class="hljs-number">450169.3062398317</span>
                        ],
                        [
                            <span class="hljs-number">465516.74645428266</span>,
                            <span class="hljs-number">240969.23496312322</span>
                        ],
                        [
                            <span class="hljs-number">324872.6144095585</span>,
                            <span class="hljs-number">913758.9653376816</span>
                        ],
                        [
                            <span class="hljs-number">593930.953973379</span>,
                            <span class="hljs-number">1757804.2634439464</span>
                        ],
                        [
                            <span class="hljs-number">911245.7835522988</span>,
                            <span class="hljs-number">1672839.829528198</span>
                        ]
                    ]
                ]

            <span class="hljs-keyword">const</span> wmtsLayer = <span class="hljs-keyword">new</span> ol.<span class="hljs-property">layer</span>.<span class="hljs-title class_">Tile</span>({
                <span class="hljs-attr">source</span>: <span class="hljs-keyword">new</span> ol.<span class="hljs-property">source</span>.<span class="hljs-title function_">WMTS</span>({
                    <span class="hljs-attr">url</span>: <span class="hljs-string">`http://t{0-6}.tianditu.gov.cn/img_c/wmts?tk=2aedde694311cf1e8ac3feca2da4fd3e`</span>,
                    <span class="hljs-attr">layer</span>: <span class="hljs-string">'img'</span>,
                    <span class="hljs-attr">matrixSet</span>: <span class="hljs-string">'c'</span>,
                    <span class="hljs-attr">style</span>: <span class="hljs-string">'default'</span>,
                    <span class="hljs-attr">crossOrigin</span>: <span class="hljs-string">'anonymous'</span>,
                    <span class="hljs-attr">format</span>: <span class="hljs-string">'tiles'</span>,
                    <span class="hljs-attr">wrapX</span>: <span class="hljs-literal">true</span>,
                    <span class="hljs-attr">crossOrigin</span>: <span class="hljs-string">'anonymous'</span>,
                    <span class="hljs-attr">tileGrid</span>: <span class="hljs-keyword">new</span> ol.<span class="hljs-property">tilegrid</span>.<span class="hljs-title function_">WMTS</span>({
                        <span class="hljs-attr">origin</span>: ol.<span class="hljs-property">extent</span>.<span class="hljs-title function_">getTopLeft</span>(projectionExtent),
                        <span class="hljs-attr">resolutions</span>: resolutions,
                        <span class="hljs-attr">matrixIds</span>: matrixIds
                    })
                })
            })
            <span class="hljs-keyword">const</span> polygon = <span class="hljs-keyword">new</span> ol.<span class="hljs-title class_">Feature</span>({
                <span class="hljs-attr">geometry</span>: <span class="hljs-keyword">new</span> ol.<span class="hljs-property">geom</span>.<span class="hljs-title class_">Polygon</span>(polygonCoords)
            })
            <span class="hljs-keyword">const</span> polygonStyle = <span class="hljs-keyword">new</span> ol.<span class="hljs-property">style</span>.<span class="hljs-title class_">Style</span>({
                <span class="hljs-attr">stroke</span>: <span class="hljs-keyword">new</span> ol.<span class="hljs-property">style</span>.<span class="hljs-title class_">Stroke</span>({
                    <span class="hljs-attr">color</span>: <span class="hljs-string">'rgba(255, 0, 0, 1)'</span>,
                    <span class="hljs-attr">width</span>: <span class="hljs-number">2</span>
                })
            });

            <span class="hljs-comment">// 在渲染前使用多边形对图层进行裁切（clip）</span>
            wmtsLayer.<span class="hljs-title function_">on</span>(<span class="hljs-string">'prerender'</span>, <span class="hljs-keyword">function</span> (<span class="hljs-params">evt</span>) {
                <span class="hljs-keyword">const</span> layerContent = ol.<span class="hljs-property">render</span>.<span class="hljs-title function_">getVectorContext</span>(evt)
                <span class="hljs-keyword">const</span> ctx = evt.<span class="hljs-property">context</span>;
                ctx.<span class="hljs-title function_">save</span>();
                layerContent.<span class="hljs-title function_">drawFeature</span>(polygon, polygonStyle)
                ctx.<span class="hljs-title function_">clip</span>();
            });

            <span class="hljs-comment">// 渲染后恢复 canvas 状态，移除裁切</span>
            wmtsLayer.<span class="hljs-title function_">on</span>(<span class="hljs-string">'postrender'</span>, <span class="hljs-keyword">function</span> (<span class="hljs-params">evt</span>) {
                <span class="hljs-keyword">const</span> ctx = evt.<span class="hljs-property">context</span>;
                <span class="hljs-keyword">if</span> (ctx) ctx.<span class="hljs-title function_">restore</span>();
            });
            <span class="hljs-keyword">const</span> layer = map.<span class="hljs-title function_">addLayer</span>(wmtsLayer);
        });
    </span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>

<span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span>
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[🚀 AI全栈项目实战 Day 3：React 玩家的后端新大陆 —— NestJS 深度硬核指南]]></title>    <link>https://juejin.cn/post/7595808703074500634</link>    <guid>https://juejin.cn/post/7595808703074500634</guid>    <pubDate>2026-01-17T08:22:24.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7595808703074500634" data-draft-id="7595847940621467698" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="🚀 AI全栈项目实战 Day 3：React 玩家的后端新大陆 —— NestJS 深度硬核指南"/> <meta itemprop="keywords" content="NestJS,全栈"/> <meta itemprop="datePublished" content="2026-01-17T08:22:24.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="神秘的猪头"/> <meta itemprop="url" content="https://juejin.cn/user/793223472877051"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            🚀 AI全栈项目实战 Day 3：React 玩家的后端新大陆 —— NestJS 深度硬核指南
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/793223472877051/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    神秘的猪头
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-17T08:22:24.000Z" title="Sat Jan 17 2026 08:22:24 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-17
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读12分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>哈喽，掘金的各位全栈练习生们！我是你们的神秘猪头导师。欢迎来到 AI 全栈项目实战的第三天！👋</p>
<p>在<a href="https://juejin.cn/column/7595043440520413190" target="_blank" title="https://juejin.cn/column/7595043440520413190">上一篇文章</a>中，我们可能还在纠结前端页面的像素眼，或者用原生的 Node.js 手搓简单的服务。但今天，我们要进入一个更加深邃、更加迷人，也绝对会让 React 开发者感到无比亲切的领域——<strong>NestJS</strong>。</p>
<p>如果你觉得 Express 像是一个“只有毛坯房”的装修现场，什么都要自己造；那么 NestJS 就是精装修的“豪宅”，水电煤气（路由、依赖注入、模块化）一应俱全，你只需要拎包入住，专注于你的业务逻辑家具摆放。</p>
<p>准备好了吗？我们要开始一场从“前端切图仔”到“企业级后端架构师”的华丽转身了！🏎️</p>
<hr/>
<h2 data-id="heading-0">🧐 为什么是 NestJS？</h2>
<p>很多 React 开发者第一次看 NestJS 的代码时，都会惊呼：“这味道……太熟悉了！”</p>
<h3 data-id="heading-1">1. 模块化架构 (Modular) 🧩</h3>
<p>React 用 Component（组件）来拼凑 UI，NestJS 用 <strong>Module（模块）</strong> 来拼凑后端服务。你的代码不再是散落在文件夹里的意大利面条，而是井井有条的积木。</p>
<h3 data-id="heading-2">2. 依赖注入 (Dependency Injection) 💉</h3>
<p>听起来很吓人？其实就是“饭来张口”。你需要数据库连接？不需要你自己去 <code>new Database()</code>，只需要在构造函数里喊一声，NestJS 的底层容器就会把数据库实例“注入”给你。这大大降低了代码的耦合度。</p>
<h3 data-id="heading-3">3. TypeScript 的亲儿子 📘</h3>
<p>NestJS 原生就是用 TypeScript 写的。对于我们这些习惯了类型约束、受够了 <code>undefined is not a function</code> 的现代前端人来说，这简直就是福音。</p>
<h3 data-id="heading-4">4. MVC 模式的完美落地 🏗️</h3>
<ul>
<li><strong>M (Model)</strong>: 数据层（Service/Database）</li>
<li><strong>V (View)</strong>: 视图层（API 接口返回的 JSON）</li>
<li><strong>C (Controller)</strong>: 控制层（路由分发）</li>
</ul>
<hr/>
<h2 data-id="heading-5">🛠️ 第一步：起高楼 —— 项目创建</h2>
<p>话不多说，先跑起来。打开你的终端（Terminal），我们先装上 NestJS 的脚手架。这就像是买了一把万能钥匙。</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 安装 NestJS CLI 全局工具</span>
npm i -g @nestjs/cli

<span class="hljs-comment"># 新建项目，我们要创建一个叫 nest-test-demo 的项目</span>
nest new nest-test-demo
</code></pre>
<p>在这个过程中，CLI 会问你用 npm 还是 yarn，选你喜欢的就好。等进度条跑完，一个企业级架构的后端项目就已经躺在你的硬盘里了。</p>
<hr/>
<h2 data-id="heading-6">🚪 第二步：叩开真理之门 —— main.ts 入口分析</h2>
<p>我们先不看别的，直接冲进 <code>main.ts</code>。这里是整个程序的<strong>入口</strong>，梦开始的地方。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">NestFactory</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/core'</span>;
<span class="hljs-comment">// 模块化</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">AppModule</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./app.module'</span>;
<span class="hljs-keyword">import</span> { config } <span class="hljs-keyword">from</span> <span class="hljs-string">'dotenv'</span>;
<span class="hljs-title function_">config</span>();

<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">bootstrap</span>(<span class="hljs-params"/>) {
  <span class="hljs-comment">// server app</span>
  <span class="hljs-comment">// 工厂模式 三星 手机，汽车，方便面</span>
  <span class="hljs-comment">// NestFactory nest 工厂</span>
  <span class="hljs-comment">// 根模型</span>
  <span class="hljs-keyword">const</span> app = <span class="hljs-keyword">await</span> <span class="hljs-title class_">NestFactory</span>.<span class="hljs-title function_">create</span>(<span class="hljs-title class_">AppModule</span>); <span class="hljs-comment">// L12</span>
  <span class="hljs-comment">// 3000 node 进程对象process</span>
  <span class="hljs-comment">// 空值合并运算符 ES2020 2015是ES6所以2020是ES11</span>
  <span class="hljs-keyword">await</span> app.<span class="hljs-title function_">listen</span>(process.<span class="hljs-property">env</span>.<span class="hljs-property">PORT</span> ?? <span class="hljs-number">3000</span>); <span class="hljs-comment">// L15</span>
}
<span class="hljs-title function_">bootstrap</span>();
</code></pre>
<h3 data-id="heading-7">🏭 知识点 1：工厂模式 (Factory Pattern)</h3>
<p>请看第 12 行：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">const</span> app = <span class="hljs-keyword">await</span> <span class="hljs-title class_">NestFactory</span>.<span class="hljs-title function_">create</span>(<span class="hljs-title class_">AppModule</span>);
</code></pre>
<p>这里用到了经典的设计模式——<strong>工厂模式</strong>。
想象一下，你想要一台三星手机。你不需要自己去采购屏幕、芯片、电池然后自己组装（那是 <code>new App()</code> 做的事）。你只需要找到“三星工厂” (<code>NestFactory</code>)，告诉它：“给我造一台手机！” (<code>create</code>)，并且把设计图纸 (<code>AppModule</code>) 给它。
<code>NestFactory</code> 就会帮你把底层的 Express 实例、路由系统、异常过滤器等等全部组装好，直接返给你一个可以直接使用的 <code>app</code> 对象。这就是封装的艺术。</p>
<h3 data-id="heading-8">❓ 知识点 2：空值合并运算符 (Nullish Coalescing)</h3>
<p>再看第 15 行：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">await</span> app.<span class="hljs-title function_">listen</span>(process.<span class="hljs-property">env</span>.<span class="hljs-property">PORT</span> ?? <span class="hljs-number">3000</span>);
</code></pre>
<p>这里有个可爱的小符号 <code>??</code>。这是 ES2020 (ES11) 引入的新特性，叫<strong>空值合并运算符</strong>。</p>
<ul>
<li><strong>以前我们怎么写？</strong> <code>process.env.PORT || 3000</code>。但这有个 bug，如果端口真的是 <code>0</code>（虽然很少见），<code>||</code> 会把它当成 false，强行变成 3000。</li>
<li><strong>现在 <code>??</code> 怎么做？</strong> 只有当左侧是 <code>null</code> 或 <code>undefined</code> 时，才会使用右侧的值。如果左侧是 <code>0</code> 或 <code>false</code>，它会照单全收。这就是严谨！</li>
</ul>
<hr/>
<h2 data-id="heading-9">🧠 第三步：大脑中枢 —— App.Module</h2>
<p>如果说 <code>main.ts</code> 是大门，那 <code>app.module.ts</code> 就是<strong>总指挥部</strong>。NestJS 是模块化的，而 <code>AppModule</code> 是所有模块的根（Root Module）。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">Module</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/common'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">AppController</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./app.controller'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">AppService</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./app.service'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">TodosModule</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./todos/todos.module'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">DatabaseModule</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./database/database.module'</span>;
<span class="hljs-comment">// mvc 设计模式 模型-视图-控制器</span>
<span class="hljs-comment">// 一个文件一个类</span>
<span class="hljs-comment">// 装饰器模式 让AppModule类成为一个模块</span>
<span class="hljs-meta">@Module</span>({
  <span class="hljs-attr">imports</span>: [
    <span class="hljs-title class_">TodosModule</span>,
    <span class="hljs-title class_">DatabaseModule</span>
  ],
  <span class="hljs-comment">// 后端路由 控制逻辑 参数校验 逻辑处理</span>
  <span class="hljs-attr">controllers</span>: [<span class="hljs-title class_">AppController</span>],
  <span class="hljs-comment">// 后端服务 业务逻辑 数据库操作</span>
  <span class="hljs-comment">// 数据</span>
  <span class="hljs-attr">providers</span>: [<span class="hljs-title class_">AppService</span>],
})
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AppModule</span> {}
</code></pre>
<h3 data-id="heading-10">🎀 知识点 3：装饰器 (Decorators)</h3>
<p>看到那个 <code>@Module</code> 了吗？这就是<strong>装饰器</strong>。
在 ES6 的类（Class）上面加个 <code>@</code>，就像给这个类贴了个魔法标签。
<code>AppModule</code> 本身只是个空类（Class），啥也不会。但是贴上 <code>@Module</code> 后，NestJS 就知道：“哦！这是一个模块！”</p>
<p><code>@Module</code> 接收一个对象，里面有三个核心属性：</p>
<ol>
<li><strong>imports</strong>: <strong>“我需要谁帮忙？”</strong> 这里引入了 <code>TodosModule</code> 和 <code>DatabaseModule</code>。说明 <code>AppModule</code> 这个老板可以调用这两个部门的能力。</li>
<li><strong>controllers</strong>: <strong>“谁负责接待客人？”</strong> <code>AppController</code> 是门面，负责处理 HTTP 请求。</li>
<li><strong>providers</strong>: <strong>“谁负责干活？”</strong> <code>AppService</code> 是苦力，负责具体的业务逻辑。</li>
</ol>
<p>这三者共同构成了 NestJS 的 MVC 架构基石。</p>
<hr/>
<h2 data-id="heading-11">🗣️ 第四步：门面担当 —— Controller (控制器)</h2>
<p>接下来我们看看负责接待的 <code>AppController</code>。它的职责非常明确：<strong>监听路由，接收参数，校验数据，然后把活儿派给 Service</strong>。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">Controller</span>,<span class="hljs-title class_">Get</span>,<span class="hljs-title class_">Post</span>,<span class="hljs-title class_">Body</span>,<span class="hljs-title class_">Inject</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/common'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">AppService</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./app.service'</span>;

<span class="hljs-meta">@Controller</span>()
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AppController</span> {
  <span class="hljs-comment">// service 实例</span>
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">
    <span class="hljs-meta">@Inject</span>(<span class="hljs-string">'PG_CONNECTION'</span>) <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> db: <span class="hljs-built_in">any</span>, <span class="hljs-comment">// L8</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> appService: AppService <span class="hljs-comment">// L9</span>
  </span>){}

  <span class="hljs-meta">@Get</span>()
  <span class="hljs-title function_">getHello</span>(): <span class="hljs-built_in">string</span> {
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">appService</span>.<span class="hljs-title function_">getHello</span>();
  }

  <span class="hljs-comment">// ... 省略部分代码</span>

  <span class="hljs-meta">@Post</span>(<span class="hljs-string">'login'</span>)
  <span class="hljs-title function_">login</span>(<span class="hljs-params"><span class="hljs-meta">@Body</span>() body: {username: <span class="hljs-built_in">string</span>, password: <span class="hljs-built_in">string</span>}</span>){
    <span class="hljs-keyword">const</span> {username,password} = body;
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(username,password);
    <span class="hljs-comment">// ... 参数校验逻辑</span>
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">appService</span>.<span class="hljs-title function_">handleLogin</span>(username,password);
  }
}
</code></pre>
<h3 data-id="heading-12">💉 知识点 4：构造函数注入 (Constructor Injection) —— 核心难点！</h3>
<p>请大家把目光聚焦在第 7-10 行的 <code>constructor</code>：</p>
<pre><code class="hljs language-typescript" lang="typescript">  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">
    <span class="hljs-meta">@Inject</span>(<span class="hljs-string">'PG_CONNECTION'</span>) <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> db: <span class="hljs-built_in">any</span>,
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> appService: AppService
  </span>){}
</code></pre>
<p>这里有两个非常硬核的知识点：</p>
<ol>
<li>
<p><strong>TypeScript 的参数属性 (Parameter Properties)</strong>：
你看到 <code>private readonly appService: AppService</code> 了吗？
在普通的 JS 类里，你需要先定义 <code>this.appService</code>，然后在构造函数里 <code>this.appService = appService</code>。
但在 TS 里，只要你在构造函数参数前加上 <code>private</code>、<code>public</code> 或 <code>readonly</code>，TS 就会自动帮你把这个参数变成类的属性，并自动赋值！<strong>一行代码顶三行，简洁就是正义。</strong></p>
</li>
<li>
<p><strong>依赖注入 (DI) 的真谛</strong>：
我们没有写 <code>new AppService()</code>。我们只是声明了类型 <code>: AppService</code>。NestJS 的扫描机制发现你需要 <code>AppService</code>，它就会去容器里找，找到之前在 <code>AppModule</code> 里注册过的那个 <code>AppService</code> 实例，直接塞给你。
这就叫“雇佣兵”模式：谁需要谁招募，但招募的动作由系统自动完成。</p>
<p>至于那个 <code>@Inject('PG_CONNECTION')</code>，我们稍后讲数据库模块时会揭晓它的神秘面纱！🎭</p>
</li>
</ol>
<h3 data-id="heading-13">🚦 知识点 5：HTTP 动词与参数装饰器</h3>
<ul>
<li>
<p><strong>@Controller()</strong>: 可以传参，比如 <code>@Controller('users')</code>，那下面的路由前缀就是 <code>/users</code>。这里没传，就是根路径。</p>
</li>
<li>
<p><strong>@Get()</strong>: 处理 GET 请求。</p>
</li>
<li>
<p><strong>@Post('login')</strong>: 处理 POST 请求，路径是 <code>/login</code>。</p>
</li>
<li>
<p><strong>@Body()</strong>: 这是一个<strong>参数装饰器</strong>。它专门用来提取 HTTP 请求体（Body）里的数据。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-title function_">login</span>(<span class="hljs-meta">@Body</span>() <span class="hljs-attr">body</span>: {<span class="hljs-attr">username</span>: <span class="hljs-built_in">string</span>, <span class="hljs-attr">password</span>: <span class="hljs-built_in">string</span>})
</code></pre>
<p>这里我们还顺手给 <code>body</code> 加了个 TS 类型定义。在函数内部，我们可以直接解构 <code>username</code> 和 <code>password</code> 进行校验。虽然这里我们是手动写 <code>if (!username)</code> 来校验的，但在更高级的用法里，我们可以配合 DTO (Data Transfer Object) 和 <code>class-validator</code> 来自动校验。</p>
</li>
</ul>
<p>Controller 做完校验后，最后一行 <code>return this.appService.handleLogin(...)</code>，就把具体的登录逻辑甩锅给 Service 了。这就叫<strong>职责分离</strong>！</p>
<hr/>
<h2 data-id="heading-14">👨‍🍳 第五步：幕后大厨 —— Service (服务)</h2>
<p>Controller 只是服务员，拿着菜单（参数）进厨房。<code>AppService</code> 才是真正炒菜的大厨。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 依赖注入</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Injectable</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/common'</span>
<span class="hljs-comment">// controller 服务于路由， 树根</span>
<span class="hljs-comment">// service 店里的厨师 Injectable 被注入 </span>
<span class="hljs-meta">@Injectable</span>() 
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AppService</span> {
  <span class="hljs-title function_">getHello</span>(): <span class="hljs-built_in">string</span> {
    <span class="hljs-keyword">return</span> <span class="hljs-string">'你好yeah'</span>;
  }
  <span class="hljs-comment">// ...</span>
  <span class="hljs-title function_">handleLogin</span>(<span class="hljs-params">username: <span class="hljs-built_in">string</span>,password: <span class="hljs-built_in">string</span></span>) {
    <span class="hljs-keyword">if</span>(username === <span class="hljs-string">"admin"</span> &amp;&amp; password === <span class="hljs-string">"123456"</span>){
      <span class="hljs-keyword">return</span> { <span class="hljs-attr">code</span>: <span class="hljs-number">200</span>, <span class="hljs-attr">msg</span>: <span class="hljs-string">'登录成功'</span> };
    }
    <span class="hljs-keyword">else</span> <span class="hljs-keyword">return</span> { <span class="hljs-attr">code</span>: <span class="hljs-number">400</span>, <span class="hljs-attr">msg</span>: <span class="hljs-string">'用户名或密码错误'</span> };
  }
}
</code></pre>
<h3 data-id="heading-15">🏷️ 知识点 6：@Injectable()</h3>
<p><code>@Injectable()</code> 顾名思义：<strong>可被注入的</strong>。
这个装饰器告诉 NestJS：“嘿，我是个有用的类，我可以被注入到别的 Controller 或者其他 Service 里去。”
所有的业务逻辑（Business Logic），比如计算、判断密码、复杂的算法，都应该写在这里。Controller 应该保持清爽，只负责收发。</p>
<hr/>
<h2 data-id="heading-16">🧱 第六步：举一反三 —— Feature Module (Todos 业务模块)</h2>
<p>看完了 <code>AppModule</code>，我们来看看如何扩展业务。比如我们要写一个待办事项（Todo）的功能。NestJS 推荐我们将功能按模块拆分。</p>
<h3 data-id="heading-17">1. Todos Module</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-meta">@Module</span>({
    <span class="hljs-attr">controllers</span>: [<span class="hljs-title class_">TodosController</span>],
    <span class="hljs-attr">providers</span>: [<span class="hljs-title class_">TodosService</span>],
})
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TodosModule</span> {}
</code></pre>
<p>结构和 <code>AppModule</code> 一模一样！这就是模块化的美妙之处——<strong>一致性</strong>。无论你的项目多大，每个模块的结构都是可预测的。</p>
<h3 data-id="heading-18">2. Todos Controller (解锁新技能)</h3>
<p>在 <code>todos.controller.ts</code> 里，我们解锁了几个新装饰器：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">Controller</span>, <span class="hljs-title class_">Get</span>, <span class="hljs-title class_">Post</span>, <span class="hljs-title class_">Body</span>, <span class="hljs-title class_">Delete</span>, <span class="hljs-title class_">Param</span>, <span class="hljs-title class_">ParseIntPipe</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/common'</span>;
<span class="hljs-comment">// ...</span>

<span class="hljs-meta">@Controller</span>(<span class="hljs-string">'todos'</span>) <span class="hljs-comment">// 路由前缀，访问路径变成了 /todos</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TodosController</span> {
    <span class="hljs-title function_">constructor</span>(<span class="hljs-params"><span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> todosService: TodosService</span>) {}
    
    <span class="hljs-meta">@Get</span>()
    <span class="hljs-title function_">getTodos</span>(<span class="hljs-params"/>) { <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">todosService</span>.<span class="hljs-title function_">findAll</span>(); }

    <span class="hljs-meta">@Post</span>()
    <span class="hljs-title function_">addTodo</span>(<span class="hljs-params"><span class="hljs-meta">@Body</span>(<span class="hljs-string">'title'</span>) title: <span class="hljs-built_in">string</span></span>){ <span class="hljs-comment">// 只取 body 里的 title 字段</span>
        <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">todosService</span>.<span class="hljs-title function_">addTodo</span>(title);
    }

    <span class="hljs-meta">@Delete</span>(<span class="hljs-string">':id'</span>) <span class="hljs-comment">// 动态路由</span>
    <span class="hljs-title function_">deleteTodo</span>(<span class="hljs-params"><span class="hljs-meta">@Param</span>(<span class="hljs-string">'id'</span>, ParseIntPipe) id: <span class="hljs-built_in">number</span></span>){ <span class="hljs-comment">// 管道转换</span>
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-keyword">typeof</span> id,<span class="hljs-string">'/////'</span>); <span class="hljs-comment">// 这里的 id 已经是 number 类型了！</span>
        <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">todosService</span>.<span class="hljs-title function_">deleteTodo</span>(id);
    }
}
</code></pre>
<ul>
<li><strong>@Controller('todos')</strong>: 这里加了前缀。所以 <code>getTodos</code> 的 URL 是 <code>GET /todos</code>。</li>
<li><strong>@Body('title')</strong>: 之前我们在 <code>login</code> 里是获取整个 body。这里我们可以传个字符串 <code>'title'</code>，告诉 NestJS：“我只要 body 里的 title 属性”。精准打击！🎯</li>
<li><strong>@Delete(':id')</strong>: 定义了一个动态路由参数。URL 类似于 <code>DELETE /todos/123</code>。</li>
<li><strong>Pipe (管道) —— <code>ParseIntPipe</code></strong>:
这是 NestJS 的一大杀器！HTTP 传过来的参数默认都是 String 类型的。
但是我们的 Service 需要一个 Number 类型的 ID。
<code>@Param('id', ParseIntPipe) id: number</code> 这行代码做了一件很酷的事：
<ol>
<li>从路由提取 <code>id</code>。</li>
<li><strong>中间件拦截</strong>：<code>ParseIntPipe</code> 尝试把它转成整数。</li>
<li><strong>如果转换失败</strong>（比如传了 <code>abc</code>），NestJS 直接抛出 400 错误，甚至不会进入函数体。</li>
<li><strong>如果成功</strong>，传入函数的 <code>id</code> 就是纯正的 <code>number</code> 类型。</li>
</ol>
</li>
</ul>
<h3 data-id="heading-19">3. Todos Service (接口与数据)</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">Todo</span> {
    <span class="hljs-attr">id</span>: <span class="hljs-built_in">number</span>;
    <span class="hljs-attr">title</span>: <span class="hljs-built_in">string</span>;
    <span class="hljs-attr">completed</span>: <span class="hljs-built_in">boolean</span>;
}

<span class="hljs-meta">@Injectable</span>()
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TodosService</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-attr">todos</span>: <span class="hljs-title class_">Todo</span>[] = [ ... ]; <span class="hljs-comment">// 内存数据库</span>
    <span class="hljs-comment">// ... CRUD 方法</span>
}
</code></pre>
<p>这里我们定义了 <code>Todo</code> 接口（Interface）。在 TS 里，接口是构建健壮应用的基础，它规定了数据的形状。</p>
<hr/>
<h2 data-id="heading-20">💎 第七步：进阶硬核 —— Database Module (自定义 Provider)</h2>
<p>最后，我们来讲讲最硬核的部分——如何封装一个数据库模块。
我们在 <code>AppController</code> 里看到的 <code>@Inject('PG_CONNECTION')</code> 到底是从哪来的？</p>
<p>请看 <code>src/database/database.module.ts</code>：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">Module</span>,<span class="hljs-title class_">Global</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/common'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Pool</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'pg'</span>; <span class="hljs-comment">// PostgreSQL 客户端</span>
<span class="hljs-keyword">import</span> * <span class="hljs-keyword">as</span> dotenv <span class="hljs-keyword">from</span> <span class="hljs-string">'dotenv'</span>;
dotenv.<span class="hljs-title function_">config</span>();

<span class="hljs-comment">// 数据库基础服务</span>
<span class="hljs-meta">@Global</span>() <span class="hljs-comment">// 全局服务</span>
<span class="hljs-meta">@Module</span>({
    <span class="hljs-attr">providers</span>: [
        {
            <span class="hljs-attr">provide</span>: <span class="hljs-string">'PG_CONNECTION'</span>, <span class="hljs-comment">// 自定义令牌 (Token)</span>
            <span class="hljs-comment">// 连接池</span>
            <span class="hljs-attr">useValue</span>: <span class="hljs-keyword">new</span> <span class="hljs-title class_">Pool</span>({
                <span class="hljs-attr">user</span>: process.<span class="hljs-property">env</span>.<span class="hljs-property">DB_USER</span>,
                <span class="hljs-comment">// ... 环境变量配置</span>
                <span class="hljs-attr">port</span>: <span class="hljs-built_in">parseInt</span>(process.<span class="hljs-property">env</span>.<span class="hljs-property">DB_PORT</span> || <span class="hljs-string">'5432'</span>,<span class="hljs-number">10</span>),
            })
        }
    ],
    <span class="hljs-attr">exports</span>: [<span class="hljs-string">'PG_CONNECTION'</span>] <span class="hljs-comment">// 导出令牌，让别人也能用</span>
})
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DatabaseModule</span> {}
</code></pre>
<p>这里包含了 NestJS 高级依赖注入的精髓：</p>
<h3 data-id="heading-21">1. 自定义 Provider (Custom Provider)</h3>
<p>通常我们的 provider 是一个类（比如 <code>AppService</code>）。但有时候，我们需要注入一个第三方库的实例（比如 <code>pg</code> 的连接池 <code>Pool</code>），或者一个常量。
这时我们就不能直接写类名了，而是要用对象字面量：</p>
<ul>
<li><strong>provide</strong>: <code>'PG_CONNECTION'</code>。这是一个<strong>令牌 (Token)</strong>。你可以把它想象成一个暗号。</li>
<li><strong>useValue</strong>: 这是一个具体的值（在这里是一个配置好的数据库连接池实例）。</li>
</ul>
<h3 data-id="heading-22">2. @Global() 全局模块</h3>
<p>通常模块是隔离的。如果 <code>TodosModule</code> 想用数据库，它得在 <code>imports</code> 里导入 <code>DatabaseModule</code>。
但数据库是基础设施，每个模块都要用。每次都 import 太麻烦了。
加上 <code>@Global()</code> 装饰器，<code>DatabaseModule</code> 就变成了“VIP 中 P”。只要在 <code>AppModule</code> 里注册一次，全项目的任何地方都可以直接使用它导出的 Provider！</p>
<h3 data-id="heading-23">3. 回到 AppController 使用它</h3>
<p>现在回到 <code>src/app.controller.ts</code> 的构造函数：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-meta">@Inject</span>(<span class="hljs-string">'PG_CONNECTION'</span>) <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> <span class="hljs-attr">db</span>: <span class="hljs-built_in">any</span>
</code></pre>
<p>这里必须用 <code>@Inject('PG_CONNECTION')</code>，因为 <code>'PG_CONNECTION'</code> 是一个字符串令牌，TS 无法通过类型自动推断出来（不像 <code>AppService</code> 是个类）。
通过这个暗号，NestJS 从容器里拿到了那个 <code>Pool</code> 实例，赋值给 <code>this.db</code>。</p>
<p>然后我们就可以愉快地写 SQL 了：</p>
<pre><code class="hljs language-typescript" lang="typescript">  <span class="hljs-meta">@Get</span>(<span class="hljs-string">'db-test'</span>)
  <span class="hljs-keyword">async</span> <span class="hljs-title function_">testConnection</span>(<span class="hljs-params"/>) {
      <span class="hljs-keyword">const</span> res = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">db</span>.<span class="hljs-title function_">query</span>(<span class="hljs-string">'SELECT * FROM users'</span>); <span class="hljs-comment">// L44</span>
      <span class="hljs-keyword">return</span> { <span class="hljs-attr">data</span>: res.<span class="hljs-property">rows</span> }
  }
</code></pre>
<p>注意这里用了 <code>async/await</code>，因为数据库查询是异步操作。</p>
<hr/>
<h2 data-id="heading-24">📝 总结</h2>
<p>恭喜你！🎉 读到这里，你已经掌握了 NestJS 的核心命脉：</p>
<ol>
<li><strong>CLI 就像魔法棒</strong>：<code>nest new</code> 一键生成。</li>
<li><strong>Main 入口</strong>：工厂模式创建应用，<code>??</code> 运算符保驾护航。</li>
<li><strong>Module 乐高积木</strong>：<code>@Module</code> 组装 Controller 和 Service。</li>
<li><strong>Controller 接待员</strong>：路由分发，参数校验，Pipe 管道清洗数据。</li>
<li><strong>Service 大厨</strong>：<code>@Injectable</code> 承载业务逻辑。</li>
<li><strong>Dependency Injection (DI)</strong>：通过构造函数自动注入依赖，解放双手。</li>
<li><strong>Custom Provider</strong>：利用 Token 注入数据库连接池等第三方实例。</li>
</ol>
<p>NestJS 就像是给 Node.js 穿上了一套钢铁侠的战衣。它可能一开始看起来有点重，但当你飞起来的时候，你会感谢这套战衣给你提供的强大动力和安全感。</p>
<p>对于 React 开发者来说，学习 NestJS 是一次思维的升维。你不再只是画页面的画家，你是构建世界的建筑师。</p>
<p>Stay Hungry, Stay Foolish, See you next time! 👋</p>
<hr/>
<h3 data-id="heading-25">💡 附录：核心代码地图</h3>
<ul>
<li><strong>入口文件</strong>: <a title="" ref="nofollow noopener noreferrer" href="https://link.juejin.cn?target="><code>main.ts</code></a></li>
<li><strong>根模块</strong>: <a title="" ref="nofollow noopener noreferrer" href="https://link.juejin.cn?target="><code>app.module.ts</code></a></li>
<li><strong>主控制器</strong>: <a title="" ref="nofollow noopener noreferrer" href="https://link.juejin.cn?target="><code>app.controller.ts</code></a></li>
<li><strong>业务模块</strong>: <a title="" ref="nofollow noopener noreferrer" href="https://link.juejin.cn?target="><code>todos.module.ts</code></a></li>
<li><strong>数据库模块</strong>: <a title="" ref="nofollow noopener noreferrer" href="https://link.juejin.cn?target="><code>database.module.ts</code></a></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Flask - Tracking ID的设计]]></title>    <link>https://juejin.cn/post/7595842144906870834</link>    <guid>https://juejin.cn/post/7595842144906870834</guid>    <pubDate>2026-01-17T09:31:58.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7595842144906870834" data-draft-id="7595890117865439278" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Flask - Tracking ID的设计"/> <meta itemprop="keywords" content="后端,Python,Flask"/> <meta itemprop="datePublished" content="2026-01-17T09:31:58.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="花酒锄作田"/> <meta itemprop="url" content="https://juejin.cn/user/3289345922186590"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Flask - Tracking ID的设计
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3289345922186590/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    花酒锄作田
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-17T09:31:58.000Z" title="Sat Jan 17 2026 09:31:58 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-17
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    8
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言</h2>
<p>在实际业务中，根据 <code>tracking_id</code> 追溯一条请求的完整处理路径是比较常见的需求。借助 Flask 自带的全局对象 <code>g</code> 以及钩子函数，可以很容易地为每条请求添加 <code>tracking_id</code>，并在日志中自动记录。</p>
<p>主要内容：</p>
<ul>
<li>如何为每条请求添加 <code>tracking_id</code></li>
<li>如何为日志自动添加 <code>tracking_id</code> 记录</li>
<li>如何自定义响应类，实现统一的响应格式，并在响应头中添加 <code>tracking_id</code></li>
<li>视图函数单元测试示例</li>
<li>Gunicorn 配置</li>
</ul>
<h2 data-id="heading-1">项目结构</h2>
<p>虽然内容看起来很多，但 tracking_id 的实现其实很简单。本文按照生产项目的规范组织了代码，添加了 Gunicorn 配置和单元测试代码，以及规范了日志格式和 JSON 响应格式。</p>
<pre><code class="hljs language-markdown" lang="markdown">├── apis
│   ├── common
│   │   ├── common.py
│   │   └── <span class="hljs-strong">__init__</span>.py
│   └── <span class="hljs-strong">__init__</span>.py
├── gunicorn.conf.py
├── handles
│   └── user.py
├── logs
│   ├── access.log
│   └── error.log
├── main.py
├── middlewares
│   ├── <span class="hljs-strong">__init__</span>.py
│   └── tracking<span class="hljs-emphasis">_id.py
├── pkgs
│   └── log
│       ├── app_</span>log.py
│       └── <span class="hljs-strong">__init__</span>.py
├── pyproject.toml
├── pytest.ini
├── README.md
├── responses
│   ├── <span class="hljs-strong">__init__</span>.py
│   └── json<span class="hljs-emphasis">_response.py
├── tests
│   └── apis
│       └── test_</span>common.py
├── tmp
│   └── gunicorn.pid
└── uv.lock
</code></pre>
<p>安装依赖</p>
<pre><code class="hljs language-shell" lang="shell">uv add flask
uv add gunicorn gevent  # 生产环境部署一般依赖这两个
uv add --dev pytest           # 测试库
</code></pre>
<h2 data-id="heading-2">实现添加 tracking_id 的中间件</h2>
<p>代码文件：<code>middlewares/tracking_id.py</code></p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> uuid <span class="hljs-keyword">import</span> uuid4

<span class="hljs-keyword">from</span> flask <span class="hljs-keyword">import</span> Flask, Response, g, request


<span class="hljs-keyword">def</span> <span class="hljs-title function_">tracking_id_middleware</span>(<span class="hljs-params">app: Flask</span>):
    <span class="hljs-string">"""
    跟踪 ID 中间件
    为每个请求生成或获取跟踪 ID，用于追踪请求链路
    """</span>
    
<span class="hljs-meta">    @app.before_request</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">tracking_id_before_request</span>():
        <span class="hljs-string">"""
        请求前处理函数
        检查请求头中是否包含 X-Tracking-ID，如果没有则生成一个新的 UUID 作为跟踪 ID
        并将其存储到 Flask 的全局对象 g 中，供后续处理使用
        """</span>
        <span class="hljs-comment"># 从请求头中获取 X-Tracking-ID</span>
        tracking_id = request.headers.get(<span class="hljs-string">"X-Tracking-ID"</span>)
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> tracking_id:
            <span class="hljs-comment"># 如果请求头中没有 X-Tracking-ID，则生成一个新的 UUID</span>
            tracking_id = <span class="hljs-built_in">str</span>(uuid4())
        <span class="hljs-comment"># 将跟踪 ID 存储到 Flask 的全局对象 g 中，供后续处理使用</span>
        g.tracking_id = tracking_id

<span class="hljs-meta">    @app.after_request</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">tracking_id_after_request</span>(<span class="hljs-params">response: Response</span>):
        <span class="hljs-string">"""
        请求后处理函数
        将跟踪 ID 添加到响应头中，以便客户端知道本次请求的跟踪 ID
        """</span>
        <span class="hljs-comment"># 检查响应头中是否已经有 X-Tracking-ID</span>
        tracking_id = response.headers.get(<span class="hljs-string">"X-Tracking-ID"</span>, <span class="hljs-string">""</span>)
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> tracking_id:
            <span class="hljs-comment"># 如果响应头中没有 X-Tracking-ID，则从全局对象 g 中获取</span>
            tracking_id = g.get(<span class="hljs-string">"tracking_id"</span>, <span class="hljs-string">""</span>)
            <span class="hljs-comment"># 将跟踪 ID 添加到响应头中</span>
            response.headers[<span class="hljs-string">"X-Tracking-ID"</span>] = tracking_id
        <span class="hljs-keyword">return</span> response

    <span class="hljs-comment"># 返回应用实例</span>
    <span class="hljs-keyword">return</span> app
</code></pre>
<p>代码文件 <code>middlewares/__init__.py</code>，方便其他模块导入</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> .tracking_id <span class="hljs-keyword">import</span> tracking_id_middleware

__all__ = [
    <span class="hljs-string">"tracking_id_middleware"</span>,
]
</code></pre>
<h2 data-id="heading-3">日志模块 - 自动记录 tracking_id</h2>
<p>实现一个简单的输出到控制台的日志模块，日志格式为 JSON，自动添加 tracking_id 到日志中，避免手动在 <code>logger.info()</code> 这类方法中传入 <code>tracking_id</code>。</p>
<p>代码文件 <code>pkgs/log/app_log.py</code></p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> json
<span class="hljs-keyword">import</span> logging
<span class="hljs-keyword">import</span> sys

<span class="hljs-keyword">from</span> flask <span class="hljs-keyword">import</span> g


<span class="hljs-keyword">class</span> <span class="hljs-title class_">JSONFormatter</span>(logging.Formatter):
    <span class="hljs-string">"""日志格式化器，输出 JSON 格式的日志。"""</span>

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">format</span>(<span class="hljs-params">self, record: logging.LogRecord</span>) -&gt; <span class="hljs-built_in">str</span>:
        log_record = {
            <span class="hljs-string">"@timestamp"</span>: self.formatTime(record, <span class="hljs-string">"%Y-%m-%dT%H:%M:%S%z"</span>),
            <span class="hljs-string">"level"</span>: record.levelname,
            <span class="hljs-string">"name"</span>: record.name,
            <span class="hljs-comment"># "processName": record.processName,  # 如需记录进程名可取消注释</span>
            <span class="hljs-string">"tracking_id"</span>: <span class="hljs-built_in">getattr</span>(record, <span class="hljs-string">"tracking_id"</span>, <span class="hljs-literal">None</span>),
            <span class="hljs-string">"loc"</span>: <span class="hljs-string">"%s:%d"</span> % (record.filename, record.lineno),
            <span class="hljs-string">"func"</span>: record.funcName,
            <span class="hljs-string">"message"</span>: record.getMessage(),
        }

        <span class="hljs-keyword">return</span> json.dumps(log_record, ensure_ascii=<span class="hljs-literal">False</span>, default=<span class="hljs-built_in">str</span>)


<span class="hljs-keyword">class</span> <span class="hljs-title class_">TrackingIDFilter</span>(logging.Filter):
    <span class="hljs-string">"""日志过滤器，为日志记录添加 tracking_id。"""</span>

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">filter</span>(<span class="hljs-params">self, record</span>):
        record.tracking_id = g.get(<span class="hljs-string">"tracking_id"</span>, <span class="hljs-literal">None</span>)
        <span class="hljs-keyword">return</span> <span class="hljs-literal">True</span>


<span class="hljs-keyword">def</span> <span class="hljs-title function_">_setup_console_handler</span>(<span class="hljs-params">level: <span class="hljs-built_in">int</span></span>) -&gt; logging.StreamHandler:
    <span class="hljs-string">"""设置控制台日志处理器。

    Args:
        level (int): 日志级别。
    """</span>
    handler = logging.StreamHandler(sys.stdout)
    handler.setLevel(level)
    handler.setFormatter(JSONFormatter())
    <span class="hljs-keyword">return</span> handler


<span class="hljs-keyword">def</span> <span class="hljs-title function_">setup_app_logger</span>(<span class="hljs-params">level: <span class="hljs-built_in">int</span> = logging.INFO, name: <span class="hljs-built_in">str</span> = <span class="hljs-string">"app"</span></span>) -&gt; logging.Logger:
    logger = logging.getLogger(name)

    <span class="hljs-keyword">if</span> logger.hasHandlers():
        <span class="hljs-keyword">return</span> logger

    logger.setLevel(level)
    logger.propagate = <span class="hljs-literal">False</span>

    logger.addHandler(_setup_console_handler(level))
    logger.addFilter(TrackingIDFilter())

    <span class="hljs-keyword">return</span> logger
</code></pre>
<p>在 <code>pkgs/log/__init__.py</code> 中初始化 <code>logger</code>，实现单例调用。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> .app_log <span class="hljs-keyword">import</span> setup_app_logger

logger = setup_app_logger()

__all__ = [<span class="hljs-string">"logger"</span>]
</code></pre>
<h2 data-id="heading-4">自定义响应类</h2>
<p>规范 JSON 类型的响应格式，并在响应头中添加 <code>X-Tracking-ID</code> 和 <code>X-DateTime</code>。</p>
<p>代码文件 <code>responses/json_response.py</code></p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> json
<span class="hljs-keyword">from</span> datetime <span class="hljs-keyword">import</span> datetime
<span class="hljs-keyword">from</span> http <span class="hljs-keyword">import</span> HTTPStatus
<span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> <span class="hljs-type">Any</span>

<span class="hljs-keyword">from</span> flask <span class="hljs-keyword">import</span> Response, g, request


<span class="hljs-keyword">class</span> <span class="hljs-title class_">JsonResponse</span>(<span class="hljs-title class_ inherited__">Response</span>):
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">
        self,
        data: <span class="hljs-type">Any</span> = <span class="hljs-literal">None</span>,
        code: HTTPStatus = HTTPStatus.OK,
        msg: <span class="hljs-built_in">str</span> = <span class="hljs-string">"this is a json response"</span>,
    </span>):
        x_tracking_id = g.get(<span class="hljs-string">"tracking_id"</span>, <span class="hljs-string">""</span>)
        x_datetime = datetime.now().astimezone().isoformat(timespec=<span class="hljs-string">"seconds"</span>)
        resp_headers = {
            <span class="hljs-string">"Content-Type"</span>: <span class="hljs-string">"application/json"</span>,
            <span class="hljs-string">"X-Tracking-ID"</span>: x_tracking_id,
            <span class="hljs-string">"X-DateTime"</span>: x_datetime,
        }
        <span class="hljs-keyword">try</span>:
            resp = json.dumps(
                {
                    <span class="hljs-string">"code"</span>: code.value,
                    <span class="hljs-string">"msg"</span>: msg,
                    <span class="hljs-string">"data"</span>: data,
                },
                ensure_ascii=<span class="hljs-literal">False</span>,
                default=<span class="hljs-built_in">str</span>,
            )
        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
            resp = json.dumps(
                {
                    <span class="hljs-string">"code"</span>: HTTPStatus.INTERNAL_SERVER_ERROR.value,
                    <span class="hljs-string">"msg"</span>: <span class="hljs-string">f"Response serialization error: <span class="hljs-subst">{<span class="hljs-built_in">str</span>(e)}</span>"</span>,
                    <span class="hljs-string">"data"</span>: <span class="hljs-literal">None</span>,
                }
            )
        <span class="hljs-built_in">super</span>().__init__(response=resp, status=code.value, headers=resp_headers)


<span class="hljs-keyword">class</span> <span class="hljs-title class_">Success</span>(<span class="hljs-title class_ inherited__">JsonResponse</span>):
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, data: <span class="hljs-type">Any</span> = <span class="hljs-literal">None</span>, msg: <span class="hljs-built_in">str</span> = <span class="hljs-string">""</span></span>):
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> msg:
            msg = <span class="hljs-string">f"<span class="hljs-subst">{request.method}</span> <span class="hljs-subst">{request.path}</span> success"</span>
        <span class="hljs-built_in">super</span>().__init__(data=data, code=HTTPStatus.OK, msg=msg)


<span class="hljs-keyword">class</span> <span class="hljs-title class_">Fail</span>(<span class="hljs-title class_ inherited__">JsonResponse</span>):
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, msg: <span class="hljs-built_in">str</span> = <span class="hljs-string">""</span>, data: <span class="hljs-type">Any</span> = <span class="hljs-literal">None</span></span>):
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> msg:
            msg = <span class="hljs-string">f"<span class="hljs-subst">{request.method}</span> <span class="hljs-subst">{request.path}</span> failed"</span>
        <span class="hljs-built_in">super</span>().__init__(data=data, code=HTTPStatus.INTERNAL_SERVER_ERROR, msg=msg)


<span class="hljs-keyword">class</span> <span class="hljs-title class_">ArgumentNotFound</span>(<span class="hljs-title class_ inherited__">JsonResponse</span>):
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, msg: <span class="hljs-built_in">str</span> = <span class="hljs-string">""</span>, data: <span class="hljs-type">Any</span> = <span class="hljs-literal">None</span></span>):
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> msg:
            msg = <span class="hljs-string">f"<span class="hljs-subst">{request.method}</span> <span class="hljs-subst">{request.path}</span> argument not found"</span>
        <span class="hljs-built_in">super</span>().__init__(data=data, code=HTTPStatus.BAD_REQUEST, msg=msg)


<span class="hljs-keyword">class</span> <span class="hljs-title class_">ArgumentInvalid</span>(<span class="hljs-title class_ inherited__">JsonResponse</span>):
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, msg: <span class="hljs-built_in">str</span> = <span class="hljs-string">""</span>, data: <span class="hljs-type">Any</span> = <span class="hljs-literal">None</span></span>):
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> msg:
            msg = <span class="hljs-string">f"<span class="hljs-subst">{request.method}</span> <span class="hljs-subst">{request.path}</span> argument invalid"</span>
        <span class="hljs-built_in">super</span>().__init__(data=data, code=HTTPStatus.BAD_REQUEST, msg=msg)


<span class="hljs-keyword">class</span> <span class="hljs-title class_">AuthFailed</span>(<span class="hljs-title class_ inherited__">JsonResponse</span>):
    <span class="hljs-string">"""HTTP 状态码: 401"""</span>

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, msg: <span class="hljs-built_in">str</span> = <span class="hljs-string">""</span>, data: <span class="hljs-type">Any</span> = <span class="hljs-literal">None</span></span>):
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> msg:
            msg = <span class="hljs-string">f"<span class="hljs-subst">{request.method}</span> <span class="hljs-subst">{request.path}</span> auth failed"</span>
        <span class="hljs-built_in">super</span>().__init__(data=data, code=HTTPStatus.UNAUTHORIZED, msg=msg)


<span class="hljs-keyword">class</span> <span class="hljs-title class_">ResourceConflict</span>(<span class="hljs-title class_ inherited__">JsonResponse</span>):
    <span class="hljs-string">"""HTTP 状态码: 409"""</span>

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, msg: <span class="hljs-built_in">str</span> = <span class="hljs-string">""</span>, data: <span class="hljs-type">Any</span> = <span class="hljs-literal">None</span></span>):
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> msg:
            msg = <span class="hljs-string">f"<span class="hljs-subst">{request.method}</span> <span class="hljs-subst">{request.path}</span> resource conflict"</span>
        <span class="hljs-built_in">super</span>().__init__(data=data, code=HTTPStatus.CONFLICT, msg=msg)


<span class="hljs-keyword">class</span> <span class="hljs-title class_">ResourceNotFound</span>(<span class="hljs-title class_ inherited__">JsonResponse</span>):
    <span class="hljs-string">"""HTTP 状态码: 404"""</span>

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, msg: <span class="hljs-built_in">str</span> = <span class="hljs-string">""</span>, data: <span class="hljs-type">Any</span> = <span class="hljs-literal">None</span></span>):
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> msg:
            msg = <span class="hljs-string">f"<span class="hljs-subst">{request.method}</span> <span class="hljs-subst">{request.path}</span> resource not found"</span>
        <span class="hljs-built_in">super</span>().__init__(data=data, code=HTTPStatus.NOT_FOUND, msg=msg)


<span class="hljs-keyword">class</span> <span class="hljs-title class_">ResourceForbidden</span>(<span class="hljs-title class_ inherited__">JsonResponse</span>):
    <span class="hljs-string">"""HTTP 状态码: 403"""</span>

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, msg: <span class="hljs-built_in">str</span> = <span class="hljs-string">""</span>, data: <span class="hljs-type">Any</span> = <span class="hljs-literal">None</span></span>):
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> msg:
            msg = <span class="hljs-string">f"<span class="hljs-subst">{request.method}</span> <span class="hljs-subst">{request.path}</span> resource forbidden"</span>
        <span class="hljs-built_in">super</span>().__init__(data=data, code=HTTPStatus.FORBIDDEN, msg=msg)

</code></pre>
<p>代码文件 <code>responses/__init__.py</code>，方便其他模块调用。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> .json_response <span class="hljs-keyword">import</span> (
    ArgumentInvalid,
    ArgumentNotFound,
    AuthFailed,
    Fail,
    JsonResponse,
    ResourceConflict,
    ResourceForbidden,
    ResourceNotFound,
    Success,
)

__all__ = [
    <span class="hljs-string">"JsonResponse"</span>,
    <span class="hljs-string">"Success"</span>,
    <span class="hljs-string">"Fail"</span>,
    <span class="hljs-string">"ArgumentNotFound"</span>,
    <span class="hljs-string">"ArgumentInvalid"</span>,
    <span class="hljs-string">"AuthFailed"</span>,
    <span class="hljs-string">"ResourceConflict"</span>,
    <span class="hljs-string">"ResourceNotFound"</span>,
    <span class="hljs-string">"ResourceForbidden"</span>,
]
</code></pre>
<h2 data-id="heading-5">编写视图函数</h2>
<p>代码文件 <code>apis/common/common.py</code>。以下定义了 5 个路由，主要用于测试响应类是否正常返回 JSON 格式。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> datetime <span class="hljs-keyword">import</span> datetime

<span class="hljs-keyword">from</span> flask <span class="hljs-keyword">import</span> Blueprint

<span class="hljs-keyword">from</span> handles <span class="hljs-keyword">import</span> user <span class="hljs-keyword">as</span> user_handle
<span class="hljs-keyword">from</span> pkgs.log <span class="hljs-keyword">import</span> logger
<span class="hljs-keyword">from</span> responses <span class="hljs-keyword">import</span> Success

route = Blueprint(<span class="hljs-string">"common_apis"</span>, __name__, url_prefix=<span class="hljs-string">"/api"</span>)


<span class="hljs-meta">@route.get(<span class="hljs-params"><span class="hljs-string">"/health"</span></span>)</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">health_check</span>():
    <span class="hljs-comment"># print(g.get("tracking_id", "no-tracking-id"))</span>
    logger.info(<span class="hljs-string">"Health check"</span>)
    <span class="hljs-keyword">return</span> Success(data=<span class="hljs-string">"OK"</span>)


<span class="hljs-meta">@route.get(<span class="hljs-params"><span class="hljs-string">"/users"</span></span>)</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">get_users</span>():
    users = user_handle.get_users()
    <span class="hljs-keyword">return</span> Success(data=users)


<span class="hljs-meta">@route.get(<span class="hljs-params"><span class="hljs-string">"/names"</span></span>)</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">get_names</span>():
    names = [<span class="hljs-string">"Alice"</span>, <span class="hljs-string">"Bob"</span>, <span class="hljs-string">"Charlie"</span>]
    <span class="hljs-keyword">return</span> Success(data=names)


<span class="hljs-meta">@route.get(<span class="hljs-params"><span class="hljs-string">"/item"</span></span>)</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">get_item</span>():
    item = {<span class="hljs-string">"id"</span>: <span class="hljs-number">101</span>, <span class="hljs-string">"name"</span>: <span class="hljs-string">"Sample Item"</span>, <span class="hljs-string">"price"</span>: <span class="hljs-number">29.99</span>, <span class="hljs-string">"now"</span>: datetime.now()}
    <span class="hljs-keyword">return</span> Success(data=item)


<span class="hljs-meta">@route.get(<span class="hljs-params"><span class="hljs-string">"/error"</span></span>)</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">get_error</span>():
    <span class="hljs-keyword">raise</span> Exception(<span class="hljs-string">"This is a test exception"</span>)

</code></pre>
<p><code>GET /api/users</code> 调用了 <code>handles/</code> 中的代码，模拟查询数据库。<code>handles/user.py</code> 中的代码如下：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> time
<span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> <span class="hljs-type">Any</span>, <span class="hljs-type">Dict</span>, <span class="hljs-type">List</span>


<span class="hljs-keyword">def</span> <span class="hljs-title function_">get_users</span>() -&gt; <span class="hljs-type">List</span>[<span class="hljs-type">Dict</span>[<span class="hljs-built_in">str</span>, <span class="hljs-type">Any</span>]]:
    <span class="hljs-comment"># 模拟查询用户数据</span>
    time.sleep(<span class="hljs-number">0.1</span>)  <span class="hljs-comment"># 模拟延迟</span>
    users = [{<span class="hljs-string">"id"</span>: <span class="hljs-number">1</span>, <span class="hljs-string">"name"</span>: <span class="hljs-string">"Alice"</span>}, {<span class="hljs-string">"id"</span>: <span class="hljs-number">2</span>, <span class="hljs-string">"name"</span>: <span class="hljs-string">"Bob"</span>}]
    <span class="hljs-keyword">return</span> users
</code></pre>
<p>代码文件 <code>apis/common/__init__.py</code> 中导入各个蓝图并统一暴露。由于示例代码只定义了一个蓝图，所以这里写得很简单。如果有多个蓝图，可以把蓝图都添加到一个列表中，在 Flask 应用中一次性遍历注册。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> .common <span class="hljs-keyword">import</span> route
<span class="hljs-comment"># from .common import route as common_route</span>

<span class="hljs-comment"># routes = [</span>
<span class="hljs-comment">#     common_route,</span>
<span class="hljs-comment"># ]</span>

__all__ = [<span class="hljs-string">"route"</span>]
</code></pre>
<p>代码文件 <code>apis/__init__.py</code> 中提供 Flask 应用的工厂函数。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> traceback

<span class="hljs-keyword">from</span> flask <span class="hljs-keyword">import</span> Flask

<span class="hljs-keyword">from</span> apis.common <span class="hljs-keyword">import</span> route <span class="hljs-keyword">as</span> common_route
<span class="hljs-keyword">from</span> middlewares <span class="hljs-keyword">import</span> tracking_id_middleware
<span class="hljs-keyword">from</span> responses <span class="hljs-keyword">import</span> Fail, ResourceNotFound
<span class="hljs-keyword">from</span> pkgs.log <span class="hljs-keyword">import</span> logger



<span class="hljs-comment"># 错误处理器</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">error_handler_notfound</span>(<span class="hljs-params">error</span>):
    <span class="hljs-keyword">return</span> ResourceNotFound()


<span class="hljs-keyword">def</span> <span class="hljs-title function_">error_handler_generic</span>(<span class="hljs-params">error</span>):
    logger.error(traceback.format_exc())
    <span class="hljs-keyword">return</span> Fail(data=<span class="hljs-built_in">str</span>(error))



<span class="hljs-keyword">def</span> <span class="hljs-title function_">create_app</span>() -&gt; Flask:
    app = Flask(__name__)

    <span class="hljs-comment"># 注册中间件</span>
    app = tracking_id_middleware(app)

    <span class="hljs-comment"># 注册错误处理器</span>
    app.errorhandler(Exception)(error_handler_generic)
    app.errorhandler(<span class="hljs-number">404</span>)(error_handler_notfound)

    <span class="hljs-comment"># 注册蓝图</span>
    app.register_blueprint(common_route)

    <span class="hljs-keyword">return</span> app

__all__ = [
    <span class="hljs-string">"create_app"</span>,
]
</code></pre>
<p>入口代码文件 <code>main.py</code></p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> apis <span class="hljs-keyword">import</span> create_app

app = create_app()

<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">"__main__"</span>:
    app.run(host=<span class="hljs-string">"127.0.0.1"</span>, port=<span class="hljs-number">8000</span>, debug=<span class="hljs-literal">False</span>)
</code></pre>
<h2 data-id="heading-6">简单运行测试</h2>
<ol>
<li>启动应用</li>
</ol>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 方式1, 直接启动, 用于简单测试</span>
python main.py

<span class="hljs-comment"># 方式2, 使用 gunicorn, 这是生产环境启动方式. 配置文件默认路径即 ./gunicorn.conf.py</span>
gunicorn main:app
</code></pre>
<ol start="2">
<li>curl 请求 <code>/api/health</code>。可以看到响应头中已经有了 <code>X-Tracking-ID</code> 和 <code>X-DateTime</code></li>
</ol>
<pre><code class="hljs language-bash" lang="bash">$ curl -v http://127.0.0.1:8000/api/health
*   Trying 127.0.0.1:8000...
* Connected to 127.0.0.1 (127.0.0.1) port 8000
* using HTTP/1.x
&gt; GET /api/health HTTP/1.1
&gt; Host: 127.0.0.1:8000
&gt; User-Agent: curl/8.14.1
&gt; Accept: */*
&gt;
* Request completely sent off
&lt; HTTP/1.1 200 OK
&lt; Server: gunicorn
&lt; Date: Sat, 17 Jan 2026 08:41:07 GMT
&lt; Connection: keep-alive
&lt; Content-Type: application/json
&lt; X-Tracking-ID: 1f0adb8d-9bee-49d4-873f-31aa1437da60
&lt; X-DateTime: 2026-01-17T16:41:07+08:00
&lt; Content-Length: 61
&lt;
* Connection <span class="hljs-comment">#0 to host 127.0.0.1 left intact</span>
{<span class="hljs-string">"code"</span>: 200, <span class="hljs-string">"msg"</span>: <span class="hljs-string">"GET /api/health success"</span>, <span class="hljs-string">"data"</span>: <span class="hljs-string">"OK"</span>}
</code></pre>
<ol start="3">
<li>curl 请求 <code>/api/users</code>。手动指定请求头中的 <code>X-Tracking-ID</code>，响应时也会保持相同的 ID。</li>
</ol>
<pre><code class="hljs language-bash" lang="bash">$ curl -v http://127.0.0.1:8000/api/users -H <span class="hljs-string">'X-Tracking-ID:123456'</span>
*   Trying 127.0.0.1:8000...
* Connected to 127.0.0.1 (127.0.0.1) port 8000
* using HTTP/1.x
&gt; GET /api/users HTTP/1.1
&gt; Host: 127.0.0.1:8000
&gt; User-Agent: curl/8.14.1
&gt; Accept: */*
&gt; X-Tracking-ID:123456
&gt;
* Request completely sent off
&lt; HTTP/1.1 200 OK
&lt; Server: gunicorn
&lt; Date: Sat, 17 Jan 2026 08:44:37 GMT
&lt; Connection: keep-alive
&lt; Content-Type: application/json
&lt; X-Tracking-ID: 123456
&lt; X-DateTime: 2026-01-17T16:44:37+08:00
&lt; Content-Length: 110
&lt;
* Connection <span class="hljs-comment">#0 to host 127.0.0.1 left intact</span>
{<span class="hljs-string">"code"</span>: 200, <span class="hljs-string">"msg"</span>: <span class="hljs-string">"GET /api/users success"</span>, <span class="hljs-string">"data"</span>: [{<span class="hljs-string">"id"</span>: 1, <span class="hljs-string">"name"</span>: <span class="hljs-string">"Alice"</span>}, {<span class="hljs-string">"id"</span>: 2, <span class="hljs-string">"name"</span>: <span class="hljs-string">"Bob"</span>}]}
</code></pre>
<h2 data-id="heading-7">编写单元测试</h2>
<p>使用 pytest 进行单元测试，这里只是一个简单的示例</p>
<h3 data-id="heading-8">配置 pytest</h3>
<p>配置文件 <code>pytest.ini</code></p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-section">[pytest]</span>
<span class="hljs-attr">testpaths</span> = <span class="hljs-string">"tests"</span>
<span class="hljs-attr">pythonpath</span> = <span class="hljs-string">"."</span>
</code></pre>
<h3 data-id="heading-9">测试代码</h3>
<p>代码文件 <code>tests/apis/test_common.py</code></p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> Generator
<span class="hljs-keyword">from</span> unittest.mock <span class="hljs-keyword">import</span> MagicMock, patch

<span class="hljs-keyword">import</span> pytest
<span class="hljs-keyword">from</span> flask <span class="hljs-keyword">import</span> Flask
<span class="hljs-keyword">from</span> flask.testing <span class="hljs-keyword">import</span> FlaskClient

<span class="hljs-keyword">from</span> apis.common <span class="hljs-keyword">import</span> route <span class="hljs-keyword">as</span> common_route


<span class="hljs-meta">@pytest.fixture</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">app</span>() -&gt; Generator[Flask, <span class="hljs-literal">None</span>, <span class="hljs-literal">None</span>]:
    app = Flask(__name__)
    app.config.update(
        {
            <span class="hljs-string">"TESTING"</span>: <span class="hljs-literal">True</span>,
            <span class="hljs-string">"DEBUG"</span>: <span class="hljs-literal">False</span>,
        }
    )
    app.register_blueprint(common_route)
    <span class="hljs-keyword">yield</span> app


<span class="hljs-meta">@pytest.fixture</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">client</span>(<span class="hljs-params">app: Flask</span>) -&gt; FlaskClient:
    <span class="hljs-keyword">return</span> app.test_client()


<span class="hljs-keyword">class</span> <span class="hljs-title class_">TestGetHealth</span>:
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">test_get_health_success</span>(<span class="hljs-params">self, client: FlaskClient</span>) -&gt; <span class="hljs-literal">None</span>:
        resp = client.get(<span class="hljs-string">"/api/health"</span>)
        <span class="hljs-keyword">assert</span> resp.status_code == <span class="hljs-number">200</span>

        resp_headers = resp.headers
        <span class="hljs-keyword">assert</span> resp_headers.get(<span class="hljs-string">"Content-Type"</span>) == <span class="hljs-string">"application/json"</span>
        <span class="hljs-keyword">assert</span> <span class="hljs-string">"X-Tracking-ID"</span> <span class="hljs-keyword">in</span> resp_headers
        <span class="hljs-keyword">assert</span> <span class="hljs-string">"X-DateTime"</span> <span class="hljs-keyword">in</span> resp_headers

        resp_body = resp.json
        <span class="hljs-keyword">assert</span> resp_body == {
            <span class="hljs-string">"code"</span>: <span class="hljs-number">200</span>,
            <span class="hljs-string">"msg"</span>: <span class="hljs-string">"GET /api/health success"</span>,
            <span class="hljs-string">"data"</span>: <span class="hljs-string">"OK"</span>,
        }


<span class="hljs-keyword">class</span> <span class="hljs-title class_">TestGetUsers</span>:
<span class="hljs-meta">    @patch(<span class="hljs-params"><span class="hljs-string">"apis.common.common.user_handle.get_users"</span></span>)</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">test_get_users</span>(<span class="hljs-params">self, mock_get_users: MagicMock, client: FlaskClient</span>) -&gt; <span class="hljs-literal">None</span>:
        <span class="hljs-comment"># mock user.get_users() 的返回值</span>
        mock_get_users.return_value = [
            {<span class="hljs-string">"id"</span>: <span class="hljs-number">1</span>, <span class="hljs-string">"name"</span>: <span class="hljs-string">"Alice123"</span>},
            {<span class="hljs-string">"id"</span>: <span class="hljs-number">2</span>, <span class="hljs-string">"name"</span>: <span class="hljs-string">"Bob456"</span>},
        ]

        <span class="hljs-comment"># 发送请求</span>
        resp = client.get(<span class="hljs-string">"/api/users"</span>)
        <span class="hljs-keyword">assert</span> resp.status_code == <span class="hljs-number">200</span>

        resp_headers = resp.headers
        <span class="hljs-keyword">assert</span> resp_headers.get(<span class="hljs-string">"Content-Type"</span>) == <span class="hljs-string">"application/json"</span>
        <span class="hljs-keyword">assert</span> <span class="hljs-string">"X-Tracking-ID"</span> <span class="hljs-keyword">in</span> resp_headers
        <span class="hljs-keyword">assert</span> <span class="hljs-string">"X-DateTime"</span> <span class="hljs-keyword">in</span> resp_headers

        <span class="hljs-comment"># resp_body = resp.json</span>

        mock_get_users.assert_called_once()

</code></pre>
<h3 data-id="heading-10">执行测试</h3>
<pre><code class="hljs language-shell" lang="shell">pytest -vv
</code></pre>
<h2 data-id="heading-11">配置 Gunicorn</h2>
<p>代码文件 <code>gunicorn.conf.py</code>。简单配置了一些启动参数，以及请求日志的格式。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># Gunicorn 配置文件</span>
<span class="hljs-keyword">from</span> pathlib <span class="hljs-keyword">import</span> Path
<span class="hljs-keyword">from</span> multiprocessing <span class="hljs-keyword">import</span> cpu_count
<span class="hljs-keyword">import</span> gunicorn.glogging
<span class="hljs-keyword">from</span> datetime <span class="hljs-keyword">import</span> datetime

<span class="hljs-keyword">class</span> <span class="hljs-title class_">CustomLogger</span>(gunicorn.glogging.Logger):
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">atoms</span>(<span class="hljs-params">self, resp, req, environ, request_time</span>):
        <span class="hljs-string">"""
        重写 atoms 方法来自定义日志占位符
        """</span>
        <span class="hljs-comment"># 获取默认的所有占位符数据</span>
        atoms = <span class="hljs-built_in">super</span>().atoms(resp, req, environ, request_time)
        
        <span class="hljs-comment"># 自定义 't' (时间戳) 的格式</span>
        now = datetime.now().astimezone()
        atoms[<span class="hljs-string">'t'</span>] = now.isoformat(timespec=<span class="hljs-string">"seconds"</span>)
        
        <span class="hljs-keyword">return</span> atoms
    

<span class="hljs-comment"># 预加载应用代码</span>
preload_app = <span class="hljs-literal">True</span>

<span class="hljs-comment"># 工作进程数量：通常是 CPU 核心数的 2 倍加 1</span>
<span class="hljs-comment"># workers = int(cpu_count() * 2 + 1)</span>
workers = <span class="hljs-number">2</span>

<span class="hljs-comment"># 使用 gevent 异步 worker 类型，适合 I/O 密集型应用</span>
<span class="hljs-comment"># 注意：gevent worker 不使用 threads 参数，而是使用协程进行并发处理</span>
worker_class = <span class="hljs-string">"gevent"</span>

<span class="hljs-comment"># 每个 gevent worker 可处理的最大并发连接数</span>
worker_connections = <span class="hljs-number">2000</span>

<span class="hljs-comment"># 绑定地址和端口</span>
bind = <span class="hljs-string">"127.0.0.1:8000"</span>

<span class="hljs-comment"># 进程名称</span>
proc_name = <span class="hljs-string">"flask-dev"</span>

<span class="hljs-comment"># PID 文件路径</span>
pidfile = <span class="hljs-built_in">str</span>(Path(__file__).parent / <span class="hljs-string">"tmp"</span> / <span class="hljs-string">"gunicorn.pid"</span>)

logger_class = CustomLogger
access_log_format = (
    <span class="hljs-string">'{"@timestamp": "%(t)s", '</span>
    <span class="hljs-string">'"remote_addr": "%(h)s", '</span>
    <span class="hljs-string">'"protocol": "%(H)s", '</span>
    <span class="hljs-string">'"host": "%({host}i)s", '</span>
    <span class="hljs-string">'"request_method": "%(m)s", '</span>
    <span class="hljs-string">'"request_path": "%(U)s", '</span>
    <span class="hljs-string">'"status_code": %(s)s, '</span>
    <span class="hljs-string">'"response_length": %(b)s, '</span>
    <span class="hljs-string">'"referer": "%(f)s", '</span>
    <span class="hljs-string">'"user_agent": "%(a)s", '</span>
    <span class="hljs-string">'"x_tracking_id": "%({x-tracking-id}i)s", '</span>
    <span class="hljs-string">'"request_time": %(L)s}'</span>
)

<span class="hljs-comment"># 访问日志路径</span>
accesslog = <span class="hljs-built_in">str</span>(Path(__file__).parent / <span class="hljs-string">"logs"</span> / <span class="hljs-string">"access.log"</span>)

<span class="hljs-comment"># 错误日志路径</span>
errorlog = <span class="hljs-built_in">str</span>(Path(__file__).parent / <span class="hljs-string">"logs"</span> / <span class="hljs-string">"error.log"</span>)

<span class="hljs-comment"># 日志级别</span>
loglevel = <span class="hljs-string">"debug"</span>
</code></pre>
<p>输出的日志格式。可以看到日志格式符合 JSON 规范，便于 Filebeat 收集后在 Kibana 上检索。</p>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_">$ </span><span class="bash"><span class="hljs-built_in">tail</span> -n 1 logs/access.log | python3 -m json.tool</span>
{
    "@timestamp": "2026-01-17T16:44:37+08:00",
    "remote_addr": "127.0.0.1",
    "protocol": "HTTP/1.1",
    "host": "127.0.0.1:8000",
    "request_method": "GET",
    "request_path": "/api/users",
    "status_code": 200,
    "response_length": 110,
    "referer": "-",
    "user_agent": "curl/8.14.1",
    "x_tracking_id": "123456",
    "request_time": 0.102042
}
</code></pre>
<h2 data-id="heading-12">补充</h2>
<h3 data-id="heading-13">全局对象 g 的注意事项</h3>
<ol>
<li><code>g</code> 不是进程或线程共享的全局变量，请只在请求处理流程中使用 <code>g</code>。</li>
<li>如果视图函数中启动了后台线程或异步任务，在子线程中直接访问 <code>g</code> 通常会报错或获取不到数据。这时建议显式传递数据。</li>
<li>不要在 <code>g</code> 中存储大文件或数据对象，否则会占用过高内存。</li>
<li><code>g</code> 不是 <code>session</code>。</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[一周之内，五家公司用行动画出了AI的未来地图]]></title>    <link>https://juejin.cn/post/7595890117865537582</link>    <guid>https://juejin.cn/post/7595890117865537582</guid>    <pubDate>2026-01-17T10:16:24.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7595890117865537582" data-draft-id="7595808703074648090" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="一周之内，五家公司用行动画出了AI的未来地图"/> <meta itemprop="keywords" content="前端,后端,JavaScript"/> <meta itemprop="datePublished" content="2026-01-17T10:16:24.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="摸鱼的春哥"/> <meta itemprop="url" content="https://juejin.cn/user/1714893870865303"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            一周之内，五家公司用行动画出了AI的未来地图
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1714893870865303/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    摸鱼的春哥
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-17T10:16:24.000Z" title="Sat Jan 17 2026 10:16:24 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-17
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>过去这一周，科技圈的几个大动作，单独看都是新闻，连起来看，就是一张正在快速成型的未来地图。</p>
<p>地图的一角，微软发出警告，说中国AI正在新兴市场成为默认选择。另一角，苹果正式宣布，下一代Siri的核心将交给谷歌的Gemini来驱动。与此同时，Anthropic让Claude变成了能直接操作你电脑文件的“数字员工”。</p>
<p>这些事发生在不同公司、不同领域，但指向同一个方向：AI竞赛已经结束了实验室炫技阶段，进入了拼生态、抢入口、定标准的实战环节。</p>
<h2 data-id="heading-0">微软的警告，关于另一种游戏规则</h2>
<p>微软这份报告，分量很重。它不是什么分析师的观点，而是这家深度绑定OpenAI、运营着全球顶级云服务、天天看着全球数据流的巨头，在陈述一个它观察到的事实。</p>
<p>微软说，在高端企业市场、云基础设施这块，西方公司依然领先。但出了西方世界，游戏规则变了。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fb0d49d07083458dada20089402ed53d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pG46bG855qE5pil5ZOl:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769249784&amp;x-signature=MlYYpFJcIcUhsazrRktWd0ijDtA%3D" alt="" loading="lazy"/></p>
<p>中国AI生态推的模型，更便宜，更容易获取，很多还是开源或接近开源的。在非洲、东欧、拉丁美洲这些地方，企业问的第一个问题往往不是“哪个模型最强大”，而是“哪个我们用得起、部署得了、维护得了”。</p>
<p>微软点名了深度求索这类公司，说它们的模型在这些区域用量很大，有时甚至超过了西方产品。</p>
<p>这件事的关键在于，一旦用上了，就容易形成生态锁定。开发者、初创公司、大学习惯了用某一套工具链，未来几年都会沿着这条路走下去。早期的互联网协议、移动操作系统、云服务商，都是这么过来的。</p>
<p>所以微软的警告其实是，在西方市场之外，中国AI可能正在因为“便宜好用”而成为默认选项。这背后是一整套国家支持、基建投入和快速规模化能力的协同。西方面对的，不是一个对手，而是一个高度协调、能快速铺开的生态系统。</p>
<p>对微软、谷歌、亚马逊这些公司来说，新兴市场不是锦上添花，而是未来的增长引擎。如果在那里失去影响，失去的不仅是客户，还有数据飞轮、开发者生态，最终是市场份额。</p>
<h2 data-id="heading-1">苹果的选择，与生态的合纵连横</h2>
<p>就在微软描绘全球竞争图景时，苹果用行动展示了竞争的另一面：合纵连横。</p>
<p>苹果官方宣布，和谷歌达成一项多年期合作。谷歌的Gemini模型和云技术，将成为苹果下一代基础模型和未来“苹果智能”功能的基石。预计2026年，我们会看到一个由Gemini驱动的全新Siri。</p>
<p>苹果的说法很值得玩味。他们说，经过仔细评估，认为谷歌的AI提供了“能力最强的基础”。以苹果的挑剔，这算是很高的评价了。</p>
<p>更关键的是，苹果并没有因此踢掉OpenAI。他们告诉媒体，之前将ChatGPT集成到Siri和苹果智能中的协议不变。Gemini是来驱动基础模型和下一代Siri核心能力的，而OpenAI则处理某些特定类型的复杂查询。
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/41bf68db613643c7af6571fa9bb62401~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pG46bG855qE5pil5ZOl:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769249784&amp;x-signature=Woj4d77HWrwxYapNn0fGF4ktNCs%3D" alt="" loading="lazy"/>
苹果本质上是在Siri内部构建一个AI路由系统。它想保持自己隐私、本地处理、严格控制的一贯身份，但在底层模型上，它选择依靠谷歌的堆栈，同时也不排斥接入其他强者。</p>
<p>这个决定的背景很有意思。谷歌母公司Alphabet的市值刚超过苹果，这是2019年以来的第一次。同时，谷歌和苹果之间那个著名的搜索默认协议，正因垄断问题被美国法院审视。</p>
<p>但即便在这种压力下，谷歌依然通过AI，把自己的触角更深地伸进了苹果生态。Siri每天在超过20亿台活跃设备上处理10亿次请求，这个分发渠道是谷歌靠自己永远无法复制的。</p>
<p>苹果评估过Anthropic，最终选了谷歌。有消息说，财务条款是重要考量。这不再是功能合作，而是基础设施层面的绑定。AI竞赛，已经进入了巨头结盟的新阶段。</p>
<h2 data-id="heading-2">从桌面到现实，AI代理开始动手</h2>
<p>当巨头们在云端结盟时，AI也在变得更具体、更“动手”。</p>
<p>Anthropic给Claude推出了一个叫“CoWork”的功能，目前是研究预览版，只给Mac版Claude的订阅用户。这个功能很简单，你授权Claude访问你Mac上的某个文件夹，之后它就能直接在里面读取、编辑、创建文件。</p>
<p>这听起来简单，但区别巨大。聊天助手是给你建议，而代理是直接触碰你的资产并产出结果。CoWork设计用来处理多步骤项目，比如整理文件、从图片里提取数据、把零散的笔记生成报告。你可以实时反馈，它还能通过连接器调用外部数据或控制浏览器工作流。</p>
<p>风险是显然的，所以Anthropic强调了安全控制。用户决定Claude能访问哪些文件夹，在删除文件这类重大操作前，助手会请求许可。他们甚至提到了“提示词注入”风险——恶意文档或网页可能嵌入指令，试图劫持代理。目前这功能还限于美国区的macOS。</p>
<p>另一家公司Manus，则瞄准了比电脑桌面更普遍的场景：现实中的对话。他们推出了“会议纪要”功能，专门针对线下面对面会议、访谈，而不是线上会议。
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d63c64dd401b492d92a39e58033294f9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pG46bG855qE5pil5ZOl:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769249784&amp;x-signature=WK9tfqhxXppQ26GTdwdunZvG6HY%3D" alt="" loading="lazy"/>
它实时录音，然后产出结构化内容：摘要、发言人识别、参会者列表、可执行任务。两个细节很关键，一是支持离线录音，网络断了也不影响，二是能尝试识别谁说了什么，以便把任务项准确分配给人。</p>
<p>Manus还想把“说到做到”的闭环打通，它能直接从会议笔记在同一个工作流里生成交付物，比如演示文稿、网站或社交媒体素材。商业模式是积分制，录音免费，但分析和结构化输出要花积分。价值显然在“思考”部分，而不只是记录。</p>
<h2 data-id="heading-3">机器人学会“预演”，谷歌想定义AI购物</h2>
<p>从虚拟代理到实体机器人，逻辑是相通的。机器人公司1X将其新的视频预训练世界模型集成到了Neo机器人平台。</p>
<p>传统机器人训练往往依赖海量的机器人演示数据，让机器人反复做动作，慢且贵。1X的新方法，结合了互联网视频和“自我中心”的人类与机器人数据。自我中心数据，就是第一人称视角。</p>
<p>这个模型通过生成文本条件下的视频推演来预测机器人动作，然后再通过逆向动力学把视频转换成运动指令。简单说，AI不仅在看，还在预测“做什么动作会导致什么视觉结果”，然后据此控制身体。</p>
<p>目前每次推演推理大约需要11秒，这说明技术还没到瞬间自主反应的级别。但好处是泛化能力更强，对于训练数据里没有的新物体和新动作，处理得更好。内部测试显示，它在双手协调、复杂物体操控等任务上，成功率匹配或超过了以前的模型。</p>
<p>最后，是谷歌可能埋下的一个最深的基础设施。它正式宣布进入“AI商务”阶段，核心是推出“通用商务协议”。</p>
<p>这是一个新的开放标准，旨在为AI代理、商家和支付系统之间的交互提供通用语言。谷歌与Shopify、沃尔玛、Target、eBay等大公司合作开发。它兼容现有的其他协议，这意味着它能接入现有生态，而不是推倒重来。</p>
<p>一个最直接的应用，就是用户在美国可以通过谷歌的AI搜索模式和Gemini应用，直接购买合作零售商的商品，使用谷歌钱包或PayPal支付。零售商依然是销售主体，保留定制集成的能力。</p>
<p>谷歌还在推出“商务代理”，让品牌能在搜索结果中直接以虚拟购物助手的形态与顾客互动，用品牌自己的风格回答问题。第一阶段包括劳氏、锐步等品牌。</p>
<p>谷歌做的，是在协议层尝试标准化AI购物，把它嵌入Gemini和AI搜索，并给商家在搜索结果里提供代理界面。这是基础设施级别的布局。</p>
<h2 data-id="heading-4">所以，未来是什么样</h2>
<p>把这些碎片拼起来，画面就清晰了。</p>
<p><strong>竞争是全球化的，但打法分成了两种。</strong> 一种是以微软报告为代表的观察：在高端市场之外，性价比和可获取性正在成为决定性因素，催生新的生态主导者。</p>
<p><strong>联盟是必然的，没有全能选手。</strong> 强如苹果，也需要在底层模型上依靠谷歌，并接入OpenAI。未来的AI服务，很可能是一个由多家供应商模型驱动的混合体，关键在于谁能做好路由和整合。</p>
<p><strong>AI正在从“说”走向“做”。</strong> 无论是操作你的电脑文件，处理线下会议，控制机器人手臂，还是帮你完成购物，AI代理开始拥有执行权。这带来了巨大的便利，也带来了全新的安全和伦理挑战。</p>
<p><strong>标准协议是隐藏的战场。</strong> 谷歌推通用商务协议，是想在AI代理如何与商业世界交互这个根本问题上，定义规则。谁定义了协议，谁就掌握了生态的枢纽位置。</p>
<p>我们正在经历的，不是单个产品的升级，而是一整个数字世界运行规则的迁移。AI正在从一项技术，变成我们与所有机器、所有信息、所有商业活动交互的新界面。</p>
<p>这个界面如何工作，由谁定义，又将被谁主导，就是未来十年科技竞争的核心故事。故事才刚刚翻开第一章。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[回顾浮动布局]]></title>    <link>https://juejin.cn/post/7595859552347963444</link>    <guid>https://juejin.cn/post/7595859552347963444</guid>    <pubDate>2026-01-17T07:50:18.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7595859552347963444" data-draft-id="7595871887000813568" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="回顾浮动布局"/> <meta itemprop="keywords" content="CSS,面试,前端"/> <meta itemprop="datePublished" content="2026-01-17T07:50:18.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="进击的明明"/> <meta itemprop="url" content="https://juejin.cn/user/1159300977801081"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            回顾浮动布局
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1159300977801081/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    进击的明明
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-17T07:50:18.000Z" title="Sat Jan 17 2026 07:50:18 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-17
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">引言</h2>
<p>在现代 Web 开发中，虽然 Flexbox 和 Grid 已成为主流布局方案，但 <strong>CSS 浮动（float）</strong>  作为早期实现网页多列布局的核心技术，仍然具有重要的历史地位和实用价值。尤其在处理图文混排、旧项目维护或兼容性要求较高的场景中，掌握浮动布局依然是前端开发者的必备技能。</p>
<p>本文将从原理、行为、常见问题及解决方案等方面，系统讲解 CSS 浮动布局。</p>
<hr/>
<h2 data-id="heading-1">一、什么是浮动（Float）？</h2>
<p><code>float</code> 是 CSS 中的一个属性，最初设计用于实现<strong>文本环绕图片</strong>的效果。其基本语法如下：</p>
<pre><code class="hljs language-sql" lang="sql">element {
  <span class="hljs-type">float</span>: <span class="hljs-keyword">left</span> <span class="hljs-operator">|</span> <span class="hljs-keyword">right</span> <span class="hljs-operator">|</span> <span class="hljs-keyword">none</span> <span class="hljs-operator">|</span> inherit;
}
</code></pre>
<ul>
<li><code>left</code>：元素向左浮动；</li>
<li><code>right</code>：元素向右浮动；</li>
<li><code>none</code>（默认值）：元素不浮动；</li>
<li><code>inherit</code>：继承父元素的浮动设置。</li>
</ul>
<h3 data-id="heading-2">示例：基础浮动</h3>
<pre><code class="hljs language-css" lang="css">&lt;<span class="hljs-selector-tag">img</span> <span class="hljs-attribute">src</span>="example<span class="hljs-selector-class">.jpg</span>" style="<span class="hljs-attribute">float</span>: left; <span class="hljs-attribute">margin</span>: <span class="hljs-number">10px</span>;"&gt;
&lt;<span class="hljs-selector-tag">p</span>&gt;这是一段文字，会环绕在图片右侧……&lt;/<span class="hljs-selector-tag">p</span>&gt;
</code></pre>
<p>在这个例子中，图片脱离了正常文档流并向左浮动，文字则围绕在其右侧流动。</p>
<hr/>
<h2 data-id="heading-3">二、浮动的核心行为</h2>
<p>要真正掌握浮动，必须理解它的三个关键特性：</p>
<h3 data-id="heading-4">1. 脱离正常文档流（但仍在页面中）</h3>
<p>浮动元素会<strong>脱离块级格式化上下文（BFC）中的正常流</strong>，不再占据原来的空间（对后续块级元素而言），但<strong>仍会影响行内内容的排布</strong>（如文字环绕）。</p>
<blockquote>
<p>注意：浮动元素并未完全“消失”，它依然存在于渲染树中，并参与布局计算。</p>
</blockquote>
<h3 data-id="heading-5">2. 向左/右尽可能靠边</h3>
<p>浮动元素会向指定方向移动，直到碰到<strong>包含块的边界</strong>或<strong>另一个浮动元素</strong>为止。</p>
<h3 data-id="heading-6">3. 块级元素“坍塌”问题</h3>
<p>当一个容器内的所有子元素都浮动时，该容器<strong>高度会变为 0</strong>（即“高度坍塌”）。这是因为浮动元素脱离了正常流，父容器无法感知其高度。</p>
<pre><code class="hljs language-css" lang="css">&lt;<span class="hljs-selector-tag">div</span> class="container"&gt;
  &lt;<span class="hljs-selector-tag">div</span> style="<span class="hljs-attribute">float</span>: left; <span class="hljs-attribute">width</span>: <span class="hljs-number">100px</span>; <span class="hljs-attribute">height</span>: <span class="hljs-number">100px</span>; <span class="hljs-attribute">background</span>: red;"&gt;&lt;/<span class="hljs-selector-tag">div</span>&gt;
  &lt;<span class="hljs-selector-tag">div</span> style="<span class="hljs-attribute">float</span>: left; <span class="hljs-attribute">width</span>: <span class="hljs-number">100px</span>; <span class="hljs-attribute">height</span>: <span class="hljs-number">100px</span>; <span class="hljs-attribute">background</span>: blue;"&gt;&lt;/<span class="hljs-selector-tag">div</span>&gt;
&lt;/<span class="hljs-selector-tag">div</span>&gt;
&lt;!-- <span class="hljs-selector-class">.container</span> 高度为 <span class="hljs-number">0</span> --&gt;
</code></pre>
<p>这个问题需要通过<strong>清除浮动（Clearfix）</strong>  来解决。</p>
<hr/>
<h2 data-id="heading-7">三、清除浮动（Clearing Floats）</h2>
<p>为了解决父容器高度坍塌的问题，我们需要“清除浮动”。常用方法有：</p>
<h3 data-id="heading-8">方法 1：使用 <code>clear</code> 属性</h3>
<p><code>clear: both</code> 是 CSS 中用于<strong>控制元素与浮动元素之间关系</strong>的一个属性值，它的作用是：<strong>强制该元素不与任何左侧或右侧的浮动元素处于同一行</strong>，即“清除浮动”的影响。</p>
<p>在浮动元素后添加一个空元素并设置 <code>clear: both</code>：</p>
<pre><code class="hljs language-css" lang="css">&lt;<span class="hljs-selector-tag">div</span> class="container"&gt;
  &lt;<span class="hljs-selector-tag">div</span> style="<span class="hljs-attribute">float</span>: left;"&gt;<span class="hljs-selector-tag">A</span>&lt;/<span class="hljs-selector-tag">div</span>&gt;
  &lt;<span class="hljs-selector-tag">div</span> style="<span class="hljs-attribute">float</span>: left;"&gt;<span class="hljs-selector-tag">B</span>&lt;/<span class="hljs-selector-tag">div</span>&gt;
  &lt;<span class="hljs-selector-tag">div</span> style="<span class="hljs-attribute">clear</span>: both;"&gt;&lt;/<span class="hljs-selector-tag">div</span>&gt;
&lt;/<span class="hljs-selector-tag">div</span>&gt;
</code></pre>
<blockquote>
<p>缺点：引入无语义的 HTML 元素。</p>
</blockquote>
<h3 data-id="heading-9">方法 2：使用伪元素（推荐 —— Clearfix 技巧）</h3>
<pre><code class="hljs language-css" lang="css">clearfix<span class="hljs-selector-pseudo">::after</span> {
  <span class="hljs-attribute">content</span>: <span class="hljs-string">""</span>;
  <span class="hljs-attribute">display</span>: table;
  <span class="hljs-attribute">clear</span>: both;
}
</code></pre>
<pre><code class="hljs language-css" lang="css">&lt;<span class="hljs-selector-tag">div</span> class="container clearfix"&gt;
  &lt;<span class="hljs-selector-tag">div</span> style="<span class="hljs-attribute">float</span>: left;"&gt;<span class="hljs-selector-tag">A</span>&lt;/<span class="hljs-selector-tag">div</span>&gt;
  &lt;<span class="hljs-selector-tag">div</span> style="<span class="hljs-attribute">float</span>: left;"&gt;<span class="hljs-selector-tag">B</span>&lt;/<span class="hljs-selector-tag">div</span>&gt;
&lt;/<span class="hljs-selector-tag">div</span>&gt;
</code></pre>
<p>这是最经典的 <strong>clearfix</strong> 解决方案，兼容性好且语义清晰。</p>
<h3 data-id="heading-10">方法 3：触发 BFC（Block Formatting Context）</h3>
<p>让父容器形成一个新的 BFC，使其能包含浮动子元素。常见方式包括：</p>
<ul>
<li><code>overflow: hidden</code> / <code>auto</code></li>
<li><code>display: flow-root</code>（现代浏览器）</li>
<li><code>float: left/right</code></li>
<li><code>position: absolute/fixed</code></li>
</ul>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.container</span> {
  <span class="hljs-attribute">overflow</span>: hidden; <span class="hljs-comment">/* 触发 BFC */</span>
}
</code></pre>
<blockquote>
<p>推荐在现代项目中使用 <code>display: flow-root</code>，它专为解决此问题而生，且不会带来副作用（如裁剪内容）。</p>
</blockquote>
<hr/>
<h2 data-id="heading-11">四、浮动布局的典型应用场景</h2>
<p>尽管 Flex/Grid 更强大，但浮动仍有其用武之地：</p>
<h3 data-id="heading-12">1. 图文混排</h3>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-tag">img</span> {
  <span class="hljs-attribute">float</span>: left;
  <span class="hljs-attribute">margin-right</span>: <span class="hljs-number">15px</span>;
}
</code></pre>
<p>这是浮动最初的设计目的，至今仍非常高效。</p>
<h3 data-id="heading-13">2. 简单的多列布局（旧项目）</h3>
<p>在 Flexbox 出现前，开发者常通过浮动实现两栏或三栏布局：</p>
<pre><code class="hljs language-css" lang="css">sidebar { <span class="hljs-attribute">float</span>: left; <span class="hljs-attribute">width</span>: <span class="hljs-number">200px</span>; }
<span class="hljs-selector-tag">main</span> { <span class="hljs-attribute">float</span>: right; <span class="hljs-attribute">width</span>: <span class="hljs-built_in">calc</span>(<span class="hljs-number">100%</span> - <span class="hljs-number">200px</span>); }
</code></pre>
<blockquote>
<p>注意：需处理清除浮动和响应式适配。</p>
</blockquote>
<h3 data-id="heading-14">3. 列表项横向排列（如导航菜单）</h3>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-tag">nav</span> <span class="hljs-selector-tag">li</span> {
  <span class="hljs-attribute">float</span>: left;
  <span class="hljs-attribute">list-style</span>: none;
}
<span class="hljs-selector-tag">nav</span><span class="hljs-selector-pseudo">::after</span> {
  <span class="hljs-attribute">content</span>: <span class="hljs-string">""</span>;
  <span class="hljs-attribute">display</span>: table;
  <span class="hljs-attribute">clear</span>: both;
}
</code></pre>
<hr/>
<h2 data-id="heading-15">五、浮动的局限性与替代方案</h2>
<h3 data-id="heading-16">局限性：</h3>
<ul>
<li>容易引发高度坍塌；</li>
<li>布局逻辑复杂，调试困难；</li>
<li>不支持垂直居中、等高列等常见需求；</li>
<li>响应式适配能力弱。</li>
</ul>
<h3 data-id="heading-17">现代替代方案：</h3>

























<table><thead><tr><th>需求</th><th>推荐方案</th></tr></thead><tbody><tr><td>多列布局</td><td>CSS Grid</td></tr><tr><td>单行/单列弹性布局</td><td>Flexbox</td></tr><tr><td>图文环绕</td><td>仍可用 <code>float</code>，或结合 <code>shape-outside</code></td></tr><tr><td>容器包含浮动子元素</td><td><code>display: flow-root</code></td></tr></tbody></table></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[前端路由不再难：React Router 从入门到工程化]]></title>    <link>https://juejin.cn/post/7595911076014112804</link>    <guid>https://juejin.cn/post/7595911076014112804</guid>    <pubDate>2026-01-17T08:05:49.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7595911076014112804" data-draft-id="7595911076014096420" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="前端路由不再难：React Router 从入门到工程化"/> <meta itemprop="keywords" content="React.js,前端框架,前端"/> <meta itemprop="datePublished" content="2026-01-17T08:05:49.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="xhxxx"/> <meta itemprop="url" content="https://juejin.cn/user/3235201610941578"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            前端路由不再难：React Router 从入门到工程化
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3235201610941578/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    xhxxx
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-17T08:05:49.000Z" title="Sat Jan 17 2026 08:05:49 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-17
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    9
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">掌握 React Router：从基础到工程化实践</h2>
<h3 data-id="heading-1">前端路由：从页面跳转到体验升级</h3>
<p>在 Web 开发的早期，前端只是“静态页面的搬运工”——所有跳转逻辑由后端掌控，每次点击链接都会触发一次完整的页面刷新。用户看到的是白屏、等待、再加载；开发者面对的是耦合、重复和低效。</p>
<p>随着前后端分离架构的普及，前端不再只是展示层，而是逐渐承担起完整的应用逻辑。<strong>路由，也由此从前端的“盲区”变成了核心能力之一</strong>。</p>
<p>今天，借助像 React Router 这样的工具，我们可以在不刷新页面的前提下，实现 URL 与 UI 的精准同步，构建真正意义上的单页应用（SPA）——既保持了 URL 的可分享性与书签能力，又带来了接近原生应用的流畅体验。</p>
<p>而这一切，都始于一个简单的映射关系：<br/>
<strong>路径（URL） → 组件（View）</strong> 。</p>
<p>接下来，我们将深入 React Router DOM，从安装配置到高级用法，一步步揭开前端路由的面纱。</p>
<h3 data-id="heading-2">React Router DOM</h3>
<p>不同框架的路由实现虽然不同，但基本原理是相似的。这里我们以 React 路由为例，带你了解路由的魅力。</p>
<p>传统的 Web 开发是多页应用，基于 HTTP 请求实现。每当请求新的 URL 时，页面都会完全刷新，导致瞬间白屏，体验较差。</p>
<h4 data-id="heading-3">单页应用 (SPA)</h4>
<p>得益于路由的出现，我们能够实现单页应用（SPA）。当用户点击链接跳转时，只触发对应的事件并更新局部视图，而不是重新渲染整个页面，从而提供流畅的用户体验。</p>
<h4 data-id="heading-4">安装路由</h4>
<pre><code class="hljs language-bash" lang="bash">npm install react-router-dom
</code></pre>
<p><strong>路由表示的就是路径和组件的映射关系</strong></p>
<h4 data-id="heading-5">路由的使用</h4>
<h5 data-id="heading-6">1. 引入路由</h5>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">BrowserRouter</span> <span class="hljs-keyword">as</span> <span class="hljs-title class_">Router</span>, <span class="hljs-title class_">Route</span>, <span class="hljs-title class_">Routes</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'react-router-dom'</span>;
</code></pre>
<h5 data-id="heading-7">2. 路由的模式</h5>
<ul>
<li><strong>HashRouter</strong> (<code>#/</code>)
<ul>
<li>URL 带有 <code>#</code> 号。</li>
<li>兼容性极好，通常在路径之后会自动加上 <code>#/</code>。</li>
</ul>
</li>
<li><strong>BrowserRouter</strong> (<code>/</code>)
<ul>
<li>URL 和后端路由一致，基于 HTML5 History API。</li>
<li>兼容性较好（IE11 之前不支持），现代浏览器几乎都支持。</li>
<li><strong>推荐</strong>：现代开发中更推荐使用 <code>BrowserRouter</code>。</li>
<li><strong>注意</strong>：<code>BrowserRouter as Router</code> 是为了提高可读性，后续统一使用 <code>Router</code> 命名。</li>
</ul>
</li>
</ul>
<h5 data-id="heading-8">3. 核心组件</h5>
<ul>
<li><strong>Routes</strong>：路由容器，负责管理一组路由，通常包裹在 <code>Router</code> 组件中。</li>
<li><strong>Route</strong>：定义单个路由规则，当路径匹配时渲染对应的组件。</li>
</ul>
<h4 data-id="heading-9">路由的配置</h4>
<p>在现代的开发目录中，我们通常将路由的配置都放在 <code>router</code> 目录下。</p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">BrowserRouter</span> <span class="hljs-keyword">as</span> <span class="hljs-title class_">Router</span>, <span class="hljs-title class_">Route</span>, <span class="hljs-title class_">Routes</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'react-router-dom'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-title class_">Home</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'./Home'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-title class_">About</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'./About'</span>;

<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Router</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">Routes</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">Route</span> <span class="hljs-attr">path</span>=<span class="hljs-string">"/"</span> <span class="hljs-attr">element</span>=<span class="hljs-string">{</span>&lt;<span class="hljs-attr">Home</span> /&gt;</span>} /&gt;
      <span class="hljs-tag">&lt;<span class="hljs-name">Route</span> <span class="hljs-attr">path</span>=<span class="hljs-string">"/about"</span> <span class="hljs-attr">element</span>=<span class="hljs-string">{</span>&lt;<span class="hljs-attr">About</span> /&gt;</span>} /&gt;
    <span class="hljs-tag">&lt;/<span class="hljs-name">Routes</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">Router</span>&gt;</span></span>
</code></pre>
<p><strong>配置说明</strong>：</p>
<ul>
<li><code>/</code> 对应 <code>Home</code> 组件</li>
<li><code>/about</code> 对应 <code>About</code> 组件</li>
</ul>
<p>当用户访问 <code>/</code> 时，会渲染 <code>Home</code> 组件；当访问 <code>/about</code> 时，会渲染 <code>About</code> 组件。</p>
<h4 data-id="heading-10">路由导航</h4>
<p>在 SPA 中，我们不能使用 <code>&lt;a&gt;</code> 标签进行导航，因为它会导致页面的刷新。我们需要使用 React Router 提供的 <code>Link</code> 组件。</p>
<p>当用户点击 <code>Link</code> 组件时，会触发路由的导航，而不会导致页面刷新。我们需要在 <code>Link</code> 组件中指定 <code>to</code> 属性，来指定跳转的路径。</p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">Link</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'react-router-dom'</span>;

<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Link</span> <span class="hljs-attr">to</span>=<span class="hljs-string">"/"</span>&gt;</span>Home<span class="hljs-tag">&lt;/<span class="hljs-name">Link</span>&gt;</span></span>
<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Link</span> <span class="hljs-attr">to</span>=<span class="hljs-string">"/about"</span>&gt;</span>About<span class="hljs-tag">&lt;/<span class="hljs-name">Link</span>&gt;</span></span>
</code></pre>
<p>点击对应的链接就会跳转到对应的页面。</p>
<hr/>
<h4 data-id="heading-11">路由的种类</h4>
<h5 data-id="heading-12">1. 普通路由</h5>
<p>最基本的路由，当路径匹配时，会渲染对应的组件。
例如：<code>about</code> 对应 <code>About</code> 组件。</p>
<pre><code class="hljs language-jsx" lang="jsx"> &lt;<span class="hljs-title class_">Route</span> path=<span class="hljs-string">"/about"</span> element={<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">About</span> /&gt;</span></span>} /&gt;
</code></pre>
<h5 data-id="heading-13">2. 动态路由</h5>
<p>路径中包含动态参数。</p>
<pre><code class="hljs language-jsx" lang="jsx">&lt;<span class="hljs-title class_">Route</span> path=<span class="hljs-string">"/user/:id"</span> element={<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">UserProfile</span> /&gt;</span></span>} /&gt;
</code></pre>
<p>动态路由当路径匹配时，会渲染对应的组件，并且会将路径中的参数传递给组件。
例如：<code>/user/123</code> 对应 <code>UserProfile</code> 组件，并且会将 <code>123</code> 传递给 <code>UserProfile</code> 组件。</p>
<p>在 <code>UserProfile</code> 组件中，我们可以通过 <code>useParams</code> hook 来获取路由参数：</p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">import</span> { useParams } <span class="hljs-keyword">from</span> <span class="hljs-string">'react-router-dom'</span>;
<span class="hljs-keyword">const</span> { id } = <span class="hljs-title function_">useParams</span>();
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(id); <span class="hljs-comment">// 123</span>
</code></pre>
<h5 data-id="heading-14">3. 嵌套路由</h5>
<pre><code class="hljs language-jsx" lang="jsx">&lt;<span class="hljs-title class_">Route</span> path=<span class="hljs-string">"/products"</span> element={<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Product</span>/&gt;</span></span>}&gt;
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Route</span> <span class="hljs-attr">path</span>=<span class="hljs-string">":productId"</span> <span class="hljs-attr">element</span>=<span class="hljs-string">{</span>&lt;<span class="hljs-attr">ProductDetail</span> /&gt;</span>}/&gt;</span>
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Route</span> <span class="hljs-attr">path</span>=<span class="hljs-string">"new"</span> <span class="hljs-attr">element</span>=<span class="hljs-string">{</span>&lt;<span class="hljs-attr">NewProduct</span> /&gt;</span>}/&gt;</span>
&lt;/<span class="hljs-title class_">Route</span>&gt;
</code></pre>
<p>嵌套路由是局部更新的一种典型。当用户访问到产品页面时，点击产品列表中的不同按钮（例如产品详情和新产品），会渲染对应的子组件，而不会导致整个页面的刷新。
这样的路径配置是基于 <code>/products</code> 继续匹配的。</p>
<p>在 <code>Product</code> 组件中，我们可以通过 <code>Outlet</code> 组件来渲染嵌套路由的内容。
例如：<code>/products/123</code> 对应 <code>ProductDetail</code> 组件，并且会将 <code>123</code> 传递给 <code>ProductDetail</code> 组件。</p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">import</span>{
    <span class="hljs-title class_">Outlet</span>
} <span class="hljs-keyword">from</span> <span class="hljs-string">'react-router-dom'</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">Product</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>产品列表<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">Outlet</span> /&gt;</span>
    <span class="hljs-tag">&lt;/&gt;</span></span>
  )
}
</code></pre>
<h5 data-id="heading-15">4. 重定向路由</h5>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">import</span> {
  <span class="hljs-title class_">Routes</span>, 
  <span class="hljs-title class_">Route</span>,
  <span class="hljs-title class_">Navigate</span>
} <span class="hljs-keyword">from</span> <span class="hljs-string">'react-router-dom'</span>

&lt;<span class="hljs-title class_">Route</span> path=<span class="hljs-string">"/old-path"</span> element={<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Navigate</span> <span class="hljs-attr">to</span>=<span class="hljs-string">"/new-path"</span> /&gt;</span></span>} /&gt;
</code></pre>
<p>当一个网站可能已经废弃或者不再更新资源，但用户依然访问旧路径时，我们通常就需要使用重定向路由帮助用户进行导航。
引入 <code>Navigate</code>，当用户访问 <code>/old-path</code> 时，会自动跳转到 <code>/new-path</code>。默认是使用 <code>replace</code> 模式，不会保留旧的历史记录。</p>
<p>如果我们想要保留旧的历史记录，可以设置 <code>replace</code> 属性为 <code>false</code>：</p>
<pre><code class="hljs language-jsx" lang="jsx">&lt;<span class="hljs-title class_">Route</span> path=<span class="hljs-string">"/old-path"</span> element={<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Navigate</span> <span class="hljs-attr">to</span>=<span class="hljs-string">"/new-path"</span> <span class="hljs-attr">replace</span>=<span class="hljs-string">{false}</span> /&gt;</span></span>} /&gt;
</code></pre>
<h5 data-id="heading-16">5. 鉴权路由 (路由守卫)</h5>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">import</span> <span class="hljs-title class_">ProtectRoute</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'./ProtectRoute'</span>;
<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Route</span> <span class="hljs-attr">path</span>=<span class="hljs-string">'/pay'</span> <span class="hljs-attr">element</span>=<span class="hljs-string">{</span>
   &lt;<span class="hljs-attr">ProtectRoute</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">Pay</span> /&gt;</span>
   <span class="hljs-tag">&lt;/<span class="hljs-name">ProtectRoute</span>&gt;</span>
}/&gt;</span>
</code></pre>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-comment">//protectRoute.jsx</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Navigate</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'react-router-dom'</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">ProductRoute</span>(<span class="hljs-params">{children}</span>) {
    <span class="hljs-keyword">const</span> isLoggedIn = <span class="hljs-variable language_">localStorage</span>.<span class="hljs-title function_">getItem</span>(<span class="hljs-string">'isLogin'</span>)===<span class="hljs-string">'true'</span>
    <span class="hljs-keyword">if</span>(!isLoggedIn){
        <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Navigate</span> <span class="hljs-attr">to</span>=<span class="hljs-string">"/login"</span> /&gt;</span></span>
    }
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;&gt;</span>
      {children}
    <span class="hljs-tag">&lt;/&gt;</span></span>
  )
}
</code></pre>
<p>鉴权路由也叫路由守卫，只有当满足条件时才能够放行。就像很多软件，你不登录就无法使用很多功能；当你想要付款时，如果没有登录，它就会自动弹出登录页。
使用一个组件来包裹需要鉴权的路由，当用户访问到这个路由时，会先判断是否登录。如果没有登录，就会跳转到登录页，否则就会渲染对应的组件。</p>
<h5 data-id="heading-17">6. 404 路由</h5>
<pre><code class="hljs language-jsx" lang="jsx">&lt;<span class="hljs-title class_">Route</span> path=<span class="hljs-string">"*"</span> element={<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">NotFound</span> /&gt;</span></span>} /&gt;
</code></pre>
<p><code>*</code> 代表除配置外的所有路由。
当用户访问到一个不存在的路由时，会渲染 <code>NotFound</code> 组件。</p>
<hr/>
<h4 data-id="heading-18">性能优化</h4>
<h5 data-id="heading-19">路由的懒加载</h5>
<p>在现代前端框架（如 React、Vue 等）中，<strong>路由的懒加载 (Lazy Loading)</strong> 是一种优化应用性能的重要手段。它允许你按需加载组件，而不是在应用初始加载时一次性加载所有路由组件，从而减小首屏 bundle 体积、加快页面加载速度。</p>
<p>例如当你打开应用首页时，你会看见很多功能按钮，但是如果要在首次进入时把这些按钮对应的所有组件一次性全部加载，这无疑是很糟糕的。这样不仅仅卡顿，还会增加首屏加载时间，甚至有些组件你都不使用，它却被加载了，这是非常浪费资源的。</p>
<p>而懒加载就很好地处理了这个问题。</p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-comment">// 传统的引入</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">Home</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'./Home'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-title class_">About</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'./About'</span>;

<span class="hljs-comment">// 懒加载引入</span>
<span class="hljs-keyword">import</span> { lazy } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;
<span class="hljs-keyword">const</span> <span class="hljs-title class_">Home</span> = <span class="hljs-title function_">lazy</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-keyword">import</span>(<span class="hljs-string">'./Home'</span>));
<span class="hljs-keyword">const</span> <span class="hljs-title class_">About</span> = <span class="hljs-title function_">lazy</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-keyword">import</span>(<span class="hljs-string">'./About'</span>));
</code></pre>
<p>当然了，所有懒加载的组件都需要在 <code>Suspense</code> 组件中包裹起来，否则会报错。</p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">Suspense</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;
<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Suspense</span> <span class="hljs-attr">fallback</span>=<span class="hljs-string">{</span>&lt;<span class="hljs-attr">div</span>&gt;</span>Loading...<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>}&gt;
   <span class="hljs-tag">&lt;<span class="hljs-name">Route</span> <span class="hljs-attr">path</span>=<span class="hljs-string">"/"</span> <span class="hljs-attr">element</span>=<span class="hljs-string">{</span>&lt;<span class="hljs-attr">Home</span> /&gt;</span>} /&gt;
   <span class="hljs-tag">&lt;<span class="hljs-name">Route</span> <span class="hljs-attr">path</span>=<span class="hljs-string">"/about"</span> <span class="hljs-attr">element</span>=<span class="hljs-string">{</span>&lt;<span class="hljs-attr">About</span> /&gt;</span>} /&gt;
<span class="hljs-tag">&lt;/<span class="hljs-name">Suspense</span>&gt;</span></span>
</code></pre>
<p>当 <code>Home</code> 和 <code>About</code> 组件被加载时，会显示 <code>Loading...</code>，当加载完成后，会显示对应的组件。
当我们访问 <code>/</code> 时，会显示 <code>Home</code> 组件，而 <code>About</code> 则会延迟加载；只有当用户访问到 <code>/about</code> 时，才会加载 <code>About</code> 组件。</p>
<hr/>
<h4 data-id="heading-20">路由职责分离</h4>
<p>为了保持代码的整洁和可维护性，我们通常会将路由的<strong>配置</strong>和<strong>导航</strong>逻辑从主应用组件中剥离出来。
这种分离让 <code>App.jsx</code> 更加简洁，专注于布局和全局组件的组合。</p>
<h5 data-id="heading-21">1. 独立的路由配置 (<code>src/router/index.jsx</code>)</h5>
<p>所有的路由规则、懒加载 (<code>lazy</code>)、路由守卫 (<code>ProtectRoute</code>) 等逻辑都集中管理。</p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-comment">// src/router/index.jsx</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Routes</span>, <span class="hljs-title class_">Route</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'react-router-dom'</span>;
<span class="hljs-keyword">import</span> { lazy, <span class="hljs-title class_">Suspense</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;

<span class="hljs-comment">// ... 懒加载组件定义 ...</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">RouterConfig</span>(<span class="hljs-params"/>){
    <span class="hljs-keyword">return</span>(
        <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Suspense</span> <span class="hljs-attr">fallback</span>=<span class="hljs-string">{</span>&lt;<span class="hljs-attr">LoadingFallback</span> /&gt;</span>}&gt;
          <span class="hljs-tag">&lt;<span class="hljs-name">Routes</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">Route</span> <span class="hljs-attr">path</span>=<span class="hljs-string">"/"</span> <span class="hljs-attr">element</span>=<span class="hljs-string">{</span>&lt;<span class="hljs-attr">Home</span> /&gt;</span>} /&gt;
            {/* ...其他路由配置 */}
          <span class="hljs-tag">&lt;/<span class="hljs-name">Routes</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">Suspense</span>&gt;</span></span>
    )
}
</code></pre>
<h5 data-id="heading-22">2. 独立的导航组件 (<code>src/components/Navigation.jsx</code>)</h5>
<p>导航菜单、链接高亮等 UI 逻辑封装在独立的组件中。</p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-comment">// src/components/Navigation.jsx</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Link</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'react-router-dom'</span>;
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">Navigation</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">nav</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">Link</span> <span class="hljs-attr">to</span>=<span class="hljs-string">"/"</span>&gt;</span>Home<span class="hljs-tag">&lt;/<span class="hljs-name">Link</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">Link</span> <span class="hljs-attr">to</span>=<span class="hljs-string">"/about"</span>&gt;</span>About<span class="hljs-tag">&lt;/<span class="hljs-name">Link</span>&gt;</span>
      {/* ... */}
    <span class="hljs-tag">&lt;/<span class="hljs-name">nav</span>&gt;</span></span>
  )
}
</code></pre>
<h5 data-id="heading-23">3. 简洁的主入口 (<code>src/App.jsx</code>)</h5>
<p>主组件只负责引入和组装，不再包含复杂的路由逻辑。</p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-comment">// src/App.jsx</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">Navigation</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'./components/Navigation'</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">RouterConfig</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'./router'</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">App</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Router</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">Navigation</span> /&gt;</span>   {/* 导航区域 */}
      <span class="hljs-tag">&lt;<span class="hljs-name">RouterConfig</span> /&gt;</span> {/* 路由视图区域 */}
    <span class="hljs-tag">&lt;/<span class="hljs-name">Router</span>&gt;</span></span>
  )
}
</code></pre>
<hr/>
<h4 data-id="heading-24">样式优化</h4>
<h5 data-id="heading-25">导航区高亮 (像掘金一样)</h5>
<p>当我们点击导航区的不同链接时，我们通常会希望对应的导航项高亮显示，以告知用户当前所在的位置。
React Router 提供的 <code>useResolvedPath</code> 和 <code>useMatch</code> 可以帮助我们实现这个功能。</p>
<ul>
<li><code>useResolvedPath</code>: 将目标路径（<code>to</code> 属性）解析为绝对路径对象。</li>
<li><code>useMatch</code>: 接收一个路径模式，判断当前 URL 是否与该模式匹配。</li>
</ul>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">import</span> { useResolvedPath, useMatch, <span class="hljs-title class_">Link</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'react-router-dom'</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">Navigation</span>(<span class="hljs-params"/>){
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">isActive</span> = (<span class="hljs-params">to</span>) =&gt; {
     <span class="hljs-comment">// 1. 将 to 解析为 location 对象，处理相对路径等情况</span>
     <span class="hljs-keyword">const</span> resolvedPath = <span class="hljs-title function_">useResolvedPath</span>(to);
     
     <span class="hljs-comment">// 2. 检查当前路径是否匹配 resolvedPath.pathname</span>
     <span class="hljs-keyword">const</span> match = <span class="hljs-title function_">useMatch</span>({
      <span class="hljs-attr">path</span>: resolvedPath.<span class="hljs-property">pathname</span>,
      <span class="hljs-attr">end</span>: <span class="hljs-literal">true</span> <span class="hljs-comment">// 精准匹配，避免 / 匹配所有路径</span>
     })

     <span class="hljs-keyword">return</span> match ? <span class="hljs-string">'active'</span> : <span class="hljs-string">''</span>
  }
  
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">nav</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">ul</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">li</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">Link</span> <span class="hljs-attr">to</span>=<span class="hljs-string">"/"</span> <span class="hljs-attr">className</span>=<span class="hljs-string">{isActive(</span>'/')}&gt;</span>Home<span class="hljs-tag">&lt;/<span class="hljs-name">Link</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">li</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">Link</span> <span class="hljs-attr">to</span>=<span class="hljs-string">"/about"</span> <span class="hljs-attr">className</span>=<span class="hljs-string">{isActive(</span>'/<span class="hljs-attr">about</span>')}&gt;</span>About<span class="hljs-tag">&lt;/<span class="hljs-name">Link</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span>
        {/* ... */}
      <span class="hljs-tag">&lt;/<span class="hljs-name">ul</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">nav</span>&gt;</span></span>
  )
}
</code></pre>
<h4 data-id="heading-26">结语</h4>
<p>前端路由的本质，是<strong>路径与组件的映射</strong>；而 React Router，则让这种映射变得清晰、灵活又强大。</p>
<p>从基础跳转到动态参数，从嵌套路由到权限控制，再到懒加载与工程化拆分——我们不仅是在配置 URL，更是在构建一个可维护、高性能、用户体验流畅的现代 Web 应用。</p>
<p>掌握 React Router，不只是学会几个 API，而是理解 SPA 背后的导航逻辑与架构思维。希望这篇指南能成为你开发路上的可靠参考，助你写出更优雅的路由代码。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Vue转React学习笔记(1): 关于useEffect的困惑和思考]]></title>    <link>https://juejin.cn/post/7595842144906706994</link>    <guid>https://juejin.cn/post/7595842144906706994</guid>    <pubDate>2026-01-17T08:12:55.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7595842144906706994" data-draft-id="7595808703074467866" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Vue转React学习笔记(1): 关于useEffect的困惑和思考"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2026-01-17T08:12:55.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="mo_Mo"/> <meta itemprop="url" content="https://juejin.cn/user/3727788080114596"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Vue转React学习笔记(1): 关于useEffect的困惑和思考
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3727788080114596/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    mo_Mo
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-17T08:12:55.000Z" title="Sat Jan 17 2026 08:12:55 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-17
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    3
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读13分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h3 data-id="heading-0">零、写在前面</h3>
<ol>
<li>之前实习和项目中都是学的Vue，由于之后工作大概率会进入React的技术生态，最近才开始学React并且缺少企业级的项目开发经验，也没有对源码做系统研究，以下的内容只是个人学习过程中的记录和思考，因此大概率会显得稚嫩而且主观，需要大佬们的指点和修正。</li>
<li>软件开发毕竟属于工程实践领域，对于相同的目标可以有不同的实现方案，而一样的技术在不同的场景下也需要做取舍权衡，它并不像数学物理这样的学科有一套不容置疑的公理。而且对于团队开发者而言，一套技术的开发体验、学习成本、认知对齐等因素也同样重要，它们应该是带有主观色彩的，至少是可讨论的；</li>
<li>为了描述简便，以下会根据官方文档的写法和称呼，对于<code>useEffect(setup，dependencies)</code>，将渲染中产生的副作用称为<code>Effect</code>，将第一个函数参数称为<code>setup</code>，将依赖数组简称为<code>deps</code>，将<code>setup</code>返回的清理函数称为<code>cleanup</code>。</li>
<li>文中提到的观点有些是React官方的提倡，有些是笔者自己的思考，请注意辨别，官方怎么说不代表我们真的要那么做/想。关于这个API，其实在各种React社区已经做出了大量讨论了，本文可以说是一个读后感。</li>
<li>以下提到的Vue指的是3.0+版本，而React指的是React18+的函数式组件+hook模式。</li>
</ol>
<h3 data-id="heading-1">一、Vue视角的对比：一些粗浅的理解</h3>
<p>由于之前有Vue框架的学习经验，因此在学习新的框架的时候，主播总会习惯上联想到Vue中相对应的Api，并且官方文档和大多数技术教程都会提到三种不同deps对应的情景和用法。</p>
<h4 data-id="heading-2">(一) 三种依赖情景</h4>
<h5 data-id="heading-3">1. 不传任何dep——类比<code>onMounted</code>和<code>onUpdated</code></h5>
<p>不传递任何依赖的时候，函数式组件首次渲染及之后更新，都会setup函数都会执行。对Vue来讲也是类似的，组件首次挂载执行onMounted和onUpdated钩子，区别在于Vue的onUpdated钩子的使用频率是很低的。</p>
<h5 data-id="heading-4">2. 传递空数组——类比<code>onMounted</code></h5>
<p>传递空数组意味着dep永远不变，setup函数只会在组件挂载的时候运行一次</p>
<h5 data-id="heading-5">3. 传递依赖值——类比<code>watch</code>和<code>watchEffect</code></h5>
<p>依赖值发生变化的时候，注册的回调函数会重新执行</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-built_in">useEffect</span>(() =&gt; {
  <span class="hljs-comment">// 会在每次渲染后运行</span>
});

<span class="hljs-built_in">useEffect</span>(() =&gt; {
  <span class="hljs-comment">// 只会在组件挂载（首次出现）时运行</span>
}, <span class="hljs-selector-attr">[]</span>);

<span class="hljs-built_in">useEffect</span>(() =&gt; {
  <span class="hljs-comment">// 会在组件挂载时运行，而且当 a 或 b 的值自上次渲染后发生变化后也会运行</span>
}, <span class="hljs-selector-attr">[a, b]</span>);
</code></pre>
<h4 data-id="heading-6">(二) 清理函数</h4>
<p>cleanup函数会在调用和组件卸载的时候执行，Vue中也提供了相关的功能，比如在onUnmounted的时候执行卸载逻辑，watch和watchEffect都能返回函数以用于清理副作用。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-title function_">watchEffect</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-comment">// 副作用逻辑：创建定时器</span>
  <span class="hljs-keyword">const</span> timer = <span class="hljs-built_in">setInterval</span>(<span class="hljs-function">() =&gt;</span> {
    count.<span class="hljs-property">value</span>++
  }, <span class="hljs-number">1000</span>)

  <span class="hljs-comment">// 清理函数：清除上一轮的定时器</span>
  <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> {
    <span class="hljs-built_in">clearInterval</span>(timer)
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'定时器已清除'</span>)
  }
})
</code></pre>
<h4 data-id="heading-7">(三) 思维差异</h4>
<p>对于Vue开发者或者React类组件的开发者来说，很容易用生命周期的组件思维来理解hook，然而官方觉得这对Effect来讲是不适宜的。如果用Vue角度来类比，大概率会觉得<code>useEffect</code>起到了一个“监听器”的作用，这引发了后面关于是否使用effect和如何写deps数组的差异。</p>
<h3 data-id="heading-8">二、如何理解副作用：区分<code>Event</code>和<code>Effect</code></h3>
<h4 data-id="heading-9">(一) 副作用的定义</h4>
<p>React hook倡导的是<code>UI=f(state)</code>的函数式编程理念，理论上组件函数应该是纯函数，也就是相同的输入返回相同的输出，并且不依赖也不影响外部系统，也就是不和外部产生任何交互。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 非纯函数</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">fn</span>=(<span class="hljs-params">arr</span>)=&gt;{
  arr.<span class="hljs-title function_">push</span>(<span class="hljs-number">1</span>) <span class="hljs-comment">// 修改了外部的参数</span>
}
</code></pre>
<p>在日常开发中产生副作用的频率是很高的，常见的比如：</p>
<ul>
<li>发送http请求：和服务器交互</li>
<li>操作dom元素：和浏览器API交互</li>
<li>定时器：和浏览器API交互</li>
<li>甚至console.log也是</li>
</ul>
<p>很多文章提到，<code>useEffect</code>是用来管理副作用的，但如果抱有一遇到“网络请求”“定时器”之类的操作，就全部放进useEffect处理，这肯定是不对的，至少不符合官方推荐的理念。</p>
<p>事实上，官方文档多次强调要区分由用户交互引起的副作用event和由渲染过程引起的Effect</p>
<h4 data-id="heading-10">(二) 区分<code>event</code>和<code>Effect</code></h4>
<p><strong>Effect 允许你指定由渲染自身，而不是特定事件引起的副作用</strong>。</p>
<p>当你决定将某些逻辑放入事件处理函数还是 Effect 中时，你需要回答的主要问题是：从用户的角度来看它是 <strong>怎样的逻辑</strong>。如果这个逻辑是由某个特定的交互引起的，请将它保留在相应的事件处理函数(<code>event handler</code>)中。如果是由用户在屏幕上 <strong>看到</strong> 组件时引起的，请将它保留在 Effect 中。</p>
<h5 data-id="heading-11">1. <strong>官方文档的例子</strong></h5>
<p>假设你正在实现一个聊天室组件，需求如下：</p>
<ol>
<li>组件应该自动连接选中的聊天室。</li>
<li>每当你点击“Send”按钮，组件应该在当前聊天界面发送一条消息。</li>
</ol>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">ChatRoom</span>(<span class="hljs-params">{ roomId }</span>) {
  <span class="hljs-keyword">const</span> [message, setMessage] = <span class="hljs-title function_">useState</span>(<span class="hljs-string">''</span>);
  <span class="hljs-comment">// ...</span>
  <span class="hljs-keyword">function</span> <span class="hljs-title function_">handleSendClick</span>(<span class="hljs-params"/>) {
    <span class="hljs-title function_">sendMessage</span>(message);
  }
  <span class="hljs-comment">// ...</span>
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">value</span>=<span class="hljs-string">{message}</span> <span class="hljs-attr">onChange</span>=<span class="hljs-string">{e</span> =&gt;</span> setMessage(e.target.value)} /&gt;
      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{handleSendClick}</span>&gt;</span>Send<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
    <span class="hljs-tag">&lt;/&gt;</span></span>
  );
}
</code></pre>
<h5 data-id="heading-12">2. <strong>日常项目中常见的例子</strong></h5>
<p>比如我们点击按钮切换不同的数据类型，需要发送网络请求拉取最新数据，用effect需要这样写</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-built_in">useEffect</span>(()=&gt;{
  <span class="hljs-built_in">fetchData</span>(type)
},<span class="hljs-selector-attr">[type]</span>)
</code></pre>
<p>这样就会带来一个问题，比如页面中有一些情况会改变type，但是那个场景下不需要发送请求，却仍旧触发了Effect，因此我们需要在setup函数里添加判断：</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-built_in">useEffect</span>(()=&gt;{
  if (type==='<span class="hljs-number">1</span>'){
    <span class="hljs-built_in">fetchData</span>(type)
  }
},<span class="hljs-selector-attr">[type]</span>)
</code></pre>
<p>未来，假设业务需求变更，你的请求又依赖了另一个参数userId，你需要在dep中添加另一个数据，甚至新数据也会再页面其他地方被修改，你需要对新数据进行条件判断。这样的话，代码的维护成本将会增高不少。</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-built_in">useEffect</span>(()=&gt;{
  if (type==='<span class="hljs-number">1</span>' &amp;&amp; userId){
    <span class="hljs-built_in">fetchData</span>(type,userId)
  }
},<span class="hljs-selector-attr">[type，userId]</span>)
</code></pre>
<p>但实际上，假如请求这是点击事件触发的，官方更推荐把它直接写在事件处理函数里。这样写的好处是：只有当用户点击按钮这个事件触发的时候才会发送请求，而不是type变化的时候发送请求，从而做到切断type和useEffect的逻辑关系，让发送请求专属于点击事件。</p>
<pre><code class="hljs language-lua" lang="lua"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">handleClick</span><span class="hljs-params">(e)</span></span>{
  const <span class="hljs-built_in">type</span>=e.target.<span class="hljs-built_in">type</span>
  fetchData(<span class="hljs-built_in">type</span>)
}
</code></pre>
<p>在常见的管理页中，搜索框输入，搜索框点击，分页页码，下拉菜单选项都有可能触发重新请求，那么应该怎么办呢？</p>
<p>我们可能会这么写：</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-built_in">useEffect</span>(()=&gt;{
	<span class="hljs-built_in">fetchData</span>({
		pageNum,
		pageSize,
		searchKey,
		selectType
	})
},
	<span class="hljs-selector-attr">[pageNum,pageSize,searchKey,selectType]</span>
)
</code></pre>
<p>大多数人我感觉也会这么写，把useEffect当成“监听”来使用，当数据变化时，拿着最新的数据发送请求，好像也没什么问题。</p>
<p>但是按照React官方的说法，每个事件函数里都要发送一次请求吗？我的答案是：也许是的。。。但其实也没那么复杂，多写几次而已，前提是把fetchData提前封装好。</p>
<pre><code class="hljs language-scss" lang="scss">const handleSearch = () =&gt; {
	<span class="hljs-built_in">setPageNum</span>(<span class="hljs-number">1</span>); 
	<span class="hljs-built_in">fetchData</span>(); <span class="hljs-comment">// 调用统一请求函数</span>
};

const handlePageChange = (newPageNum, newPageSize) =&gt; {
	<span class="hljs-built_in">setPageNum</span>(newPageNum);
	<span class="hljs-built_in">setPageSize</span>(newPageSize);
	<span class="hljs-built_in">fetchData</span>(); <span class="hljs-comment">// 调用统一请求函数</span>
};

const handleSelectChange = (value) =&gt; {
	<span class="hljs-built_in">setSelectType</span>(value);
	<span class="hljs-built_in">setPageNum</span>(<span class="hljs-number">1</span>); 
	<span class="hljs-built_in">fetchData</span>(); <span class="hljs-comment">// 调用统一请求函数</span>
};
</code></pre>
<h5 data-id="heading-13"/>
<h4 data-id="heading-14">(三) 响应式 VS 命令式——我们真的需要“监听”吗？</h4>
<p>扯远一点，或许再考虑一个问题，我们真的在React中需要实现“监听”吗？</p>
<p>在<code>JavaScript</code>层面，我们永远做不到对一个变量是否被改变进行监听，Vue和React作为JS框架当然都无法改变这一点。那为什么Vue可以做到监听呢？笔者觉得这涉及到两个框架对于<code>响应式设计</code>在理念上的巨大差异，也就是响应式编程和命令式编程。</p>
<p>简单讲，Vue主打一个“自动化”，基于发布订阅模式，当你声明一个数据需要为“响应式”的时候，框架内部会利用getter和setter帮你自动地进行依赖的收集和触发更新。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">reactive</span>(<span class="hljs-params">target</span>) {
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Proxy</span>(target, {
    <span class="hljs-title function_">get</span>(<span class="hljs-params">obj, key</span>) {
      <span class="hljs-title function_">track</span>(obj, key); <span class="hljs-comment">// 启动依赖跟踪</span>
      <span class="hljs-keyword">return</span> <span class="hljs-title class_">Reflect</span>.<span class="hljs-title function_">get</span>(obj, key);
    },
    <span class="hljs-title function_">set</span>(<span class="hljs-params">obj, key, value</span>) {
      <span class="hljs-title class_">Reflect</span>.<span class="hljs-title function_">set</span>(obj, key, value);
      <span class="hljs-title function_">trigger</span>(obj, key); <span class="hljs-comment">// 触发副作用</span>
      <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    }
  });
}
</code></pre>
<p>而React则把控制权交给开发者，类似于“手动挡”，根据<code>UI=f(state)</code>的理念，React中只有状态这个概念，因此开发者必须<strong>手动</strong>管理好每一个状态，通过调用<code>setState</code>进行状态修改，由React来帮你自动重渲染并更新。这样一来，每一处变动都是开发者手动触发的，React自然没有进行自动监听的义务。</p>
<p>所以笔者觉得，或许当我们真的需要用React来进行自动监听的时候，应该持有的实现思路可能是像Vue一样基于JS的发布订阅这条路去实现<code>getter</code>和<code>setter</code>，而不是<code>useEffect</code>。</p>
<p>幸运的是，我们已经拥有了第三方库<code>Mobx</code>，它便是基于Vue响应式中的getter和setter模式，实现了自动监听。假如你使用<code>React + Mobx</code>则完全不需要手动<code>setState</code>了，可以看到两个框架的设计思想正在发生一定程度的交融。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">import</span> {observable, computed} from <span class="hljs-string">"mobx"</span>;

<span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderLine</span> {
    <span class="hljs-meta">@observable</span> price = <span class="hljs-number">0</span>;
    <span class="hljs-meta">@observable</span> amount = <span class="hljs-number">1</span>;
    <span class="hljs-keyword">constructor</span>(price) {
        <span class="hljs-keyword">this</span>.price = price;
    }
  <span class="hljs-comment">// 很像Vue的computed</span>
    <span class="hljs-meta">@computed</span> <span class="hljs-keyword">get</span> total() {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.price * <span class="hljs-keyword">this</span>.amount;
    }
}
</code></pre>
<pre><code class="hljs language-ini" lang="ini">const <span class="hljs-attr">todos</span> = observable([
    {
        title: <span class="hljs-string">"Make coffee"</span>,
        done: <span class="hljs-literal">true</span>,
    },
])<span class="hljs-comment">;</span>

// reaction 很像watch
const <span class="hljs-attr">reaction</span> = reaction(
    () =&gt; todos.map(<span class="hljs-attr">todo</span> =&gt; todo.title),
    <span class="hljs-attr">titles</span> =&gt; console.log(<span class="hljs-string">"reaction 2:"</span>, titles.join(<span class="hljs-string">", "</span>))
)<span class="hljs-comment">;</span>

// autorun 很像watchEffect
const <span class="hljs-attr">autorun1</span> = autorun(
    () =&gt; console.log("autorun 1:", todos.map(<span class="hljs-attr">todo</span> =&gt; todo.title).join(<span class="hljs-string">", "</span>))
)<span class="hljs-comment">;</span>
</code></pre>
<h3 data-id="heading-15">三、巨大的心智负担：deps到底怎么写</h3>
<p>从以上例子可以看出，Effect的创作者担心开发人员理解不了这个hook，因此用了大量的案例来提示使用者在某些场景下别用Effect，但用不用Effect可能还不是最大的争议，useEffect钩子最大的争议点应该是在于依赖数组，也就是deps该怎么写，是否应该写完整。</p>
<h4 data-id="heading-16">(一) 官方的推荐：写全deps数组</h4>
<p>文档中提到：任何响应式值都可以在重新渲染时发生变化，所以需要将响应式值包括在 Effect 的依赖项中。这里的响应式值可能含有：</p>
<ul>
<li>
<ol>
<li>state</li>
</ol>
</li>
<li>
<ol start="2">
<li>props</li>
</ol>
</li>
<li>
<ol start="3">
<li>所有在组件函数中用到的普通函数和普通变量</li>
</ol>
</li>
</ul>
<p>也就是所有在setup中用到，并且函数组件作用域内的可能变化的值，都需要添加到dep中。</p>
<p>正是这一点，给开发者带来巨大的心智负担，即使官方推荐安装eslint的插件辅助我们补全deps，但实践中还是将它设置为warning而并非error，这仅仅相当于起到了一个心理安慰的作用。</p>
<p>特别是当dep用到了函数的时候，可能会导致useCallback嵌套的问题</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">//组件函数体内部</span>
function <span class="hljs-built_in">init</span>(){
	<span class="hljs-comment">// 每次重渲染都会产生新引用</span>
}

<span class="hljs-built_in">useEffect</span>(()=&gt;{
	<span class="hljs-built_in">init</span>(data) <span class="hljs-comment">// 会频繁触发</span>
},<span class="hljs-selector-attr">[data,init]</span>) 
</code></pre>
<p>添加useCallback</p>
<pre><code class="hljs language-scss" lang="scss">const initFn=<span class="hljs-built_in">useCallback</span>(init,[dep])
<span class="hljs-comment">// 如果dep里面还有函数，可能需要再次包裹useCallback，代码可读性会降低很多</span>

<span class="hljs-built_in">useEffect</span>(()=&gt;{
	<span class="hljs-built_in">initFn</span>(data) <span class="hljs-comment">// 会频繁触发</span>
},<span class="hljs-selector-attr">[data,initFn]</span>) 
</code></pre>
<h4 data-id="heading-17">(二) 先实现setup，再确定deps，而不是反过来</h4>
<p>官方文档提到，dep数组是完全由setup函数确定的，而不是由开发者选择的</p>
<p>个人是这么理解的：</p>
<ol>
<li>
<ol>
<li>你应该先确定这里的副作用是什么</li>
<li>dep是副作用的过滤器，通过指定dep来跳过副作用的执行，保证性能</li>
<li>同样地，如果要修改dep，应该先修改setup，而不是反过来</li>
<li>如果抱着“监听”的思维去理解，会先确定dep（你要监听的东西）再实现setup，那样的话，你可能会漏写dep</li>
</ol>
</li>
</ol>
<h3 data-id="heading-18">四、如何建立自己的最佳实践</h3>
<p>既然<code>useEffect</code>的心智负担那么重，我们应该这么做，以下是一点个人的思考</p>
<h4 data-id="heading-19">1.尽量多使用成熟的第三方库，减少自己裸写<code>useEffect</code>的情景</h4>
<ul>
<li>状态管理上，已经有很多第三方库帮你解决数据的收集和更新的问题了，比如Mobx和Zustand，本质上都是发布订阅的模式</li>
<li>发送请求上，优先使用Tanstack-Query、SWR、ahooks中的useRequest等第三方库，来发送请求，帮你管理请求中的各种问题（包括网络竞态、数据缓存、loading error管理等），比自己写useEffect要稳得多。</li>
</ul>
<h4 data-id="heading-20">2.可以使用<code>useEffect</code>的情况</h4>
<ul>
<li>需要操作原生dom元素的情况：比如手动设置元素的<code>scrollTop</code>的值</li>
<li>确保副作用仅一次性执行，可以使用空数组的场景：比如初始化第三方SDK</li>
<li>监听浏览器原生事件的情况：比如窗口大小变化<code>window.resize</code></li>
<li>需要和外部环境进行同步的情况：比如websocket链接，SSE链接等</li>
<li>你觉得自己完全搞懂了useEffect的话可以用。。。（反正我是没搞懂。。）</li>
</ul>
<h4 data-id="heading-21">3.协作开发的过程需要和团队对齐观念</h4>
<p>如果是团队开发的话，要能看懂并理解别人的代码，而不是强迫别人理解自己的观点。团队的领导者最好能制定一份团队的开发规范，拉齐所有人的技术认知。当然这不是我这种新手该考虑的东西，只能说领导让怎么做就怎么做QvQ。</p>
<h3 data-id="heading-22">五、写在最后</h3>
<p>作为一点Vue转React的新手，有几点个人的主观感受想提一下</p>
<ol>
<li>React只是一个JS库，它没有义务覆盖前端所有的业务场景，也没义务提供所谓的最佳实践，而是让开发者自己选择，这种理念应该是可以理解的。</li>
<li>但不管怎么说，<code>useEffect</code>都是一个认知曲线极其陡峭、给开发者造成巨大心智负担的API，从开发文档的篇幅以及React提出的<code>useEffectEvent</code>就可以看出来，但其实都是在缝缝补补。</li>
<li>官方对这个API的设计理念，和开发者的日常用法存在不少的割裂，这也是官方文档用大部分篇幅来讲这个hook的原因，就是为了让开发者少用，少滥用。</li>
<li>从体验上看，Vue即使对底层原理不那么熟悉也能进行开发，但React的开发过程中，还是需要不断按照React的机制去模拟整个流程，所以理解原理还是比较重要。至于这是不是框架在甩锅给开发者，就见仁见智了。</li>
</ol>
<h3 data-id="heading-23">六、参考</h3>
<ol>
<li>《为什么我们要删掉100%的useEffect》：<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.yuque.com%2Fjiango%2Fcode%2Fgood-bye-use-effect%23a6Ch9" target="_blank" title="https://www.yuque.com/jiango/code/good-bye-use-effect#a6Ch9" ref="nofollow noopener noreferrer">www.yuque.com/jiango/code…</a></li>
<li>《React hook使用误区，驳官方文档》：<a href="https://link.juejin.cn?target=https%3A%2F%2Fzhuanlan.zhihu.com%2Fp%2F450513902" target="_blank" title="https://zhuanlan.zhihu.com/p/450513902" ref="nofollow noopener noreferrer">zhuanlan.zhihu.com/p/450513902</a></li>
<li>《A Complete Guide to useEffect》：<a href="https://link.juejin.cn?target=https%3A%2F%2Foverreacted.io%2Fa-complete-guide-to-useeffect%2F" target="_blank" title="https://overreacted.io/a-complete-guide-to-useeffect/" ref="nofollow noopener noreferrer">overreacted.io/a-complete-…</a></li>
<li>《精读useEffect完全指南》：<a href="https://link.juejin.cn?target=https%3A%2F%2Fzhuanlan.zhihu.com%2Fp%2F60277120" target="_blank" title="https://zhuanlan.zhihu.com/p/60277120" ref="nofollow noopener noreferrer">zhuanlan.zhihu.com/p/60277120</a></li>
<li>React官方文档《脱围机制》：<a href="https://link.juejin.cn?target=https%3A%2F%2Fzh-hans.react.dev%2Flearn%2Fescape-hatches" target="_blank" title="https://zh-hans.react.dev/learn/escape-hatches" ref="nofollow noopener noreferrer">zh-hans.react.dev/learn/escap…</a></li>
<li>React官方文档 useEffect： <a href="https://link.juejin.cn?target=https%3A%2F%2Fzh-hans.react.dev%2Freference%2Freact%2FuseEffect" target="_blank" title="https://zh-hans.react.dev/reference/react/useEffect" ref="nofollow noopener noreferrer">zh-hans.react.dev/reference/r…</a></li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Message组件和Vue3 进阶：手动挂载组件与 Diff 算法深度解析]]></title>    <link>https://juejin.cn/post/7595871887001157632</link>    <guid>https://juejin.cn/post/7595871887001157632</guid>    <pubDate>2026-01-17T08:24:01.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7595871887001157632" data-draft-id="7595871887001141248" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Message组件和Vue3 进阶：手动挂载组件与 Diff 算法深度解析"/> <meta itemprop="keywords" content="Vue.js,前端框架"/> <meta itemprop="datePublished" content="2026-01-17T08:24:01.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="干死前端"/> <meta itemprop="url" content="https://juejin.cn/user/1486957885265400"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Message组件和Vue3 进阶：手动挂载组件与 Diff 算法深度解析
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1486957885265400/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    干死前端
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-17T08:24:01.000Z" title="Sat Jan 17 2026 08:24:01 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-17
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读11分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/10862e9655534fde81d62ac8a0a6ae11~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bmy5q275YmN56uv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769243041&amp;x-signature=N7zA2RCqEgobX5S3upfbxKuSuIM%3D" alt="ai_image_1768638049154_1.jpg" loading="lazy"/></p>
<h2 data-id="heading-0">Vue3 进阶：手动挂载组件与 Diff 算法深度解析</h2>
<blockquote>
<p>很多 Vue 开发者习惯了在 <code>&lt;template&gt;</code> 里写组件，但在开发 <code>Message</code>（全局提示）、<code>Modal</code>（模态框）或 <code>Notification</code>（通知）这类组件时，我们往往希望通过 JS 函数直接调用，而不是在每个页面都写一个 <code>&lt;MyMessage /&gt;</code> 标签。本文将带你深入 Vue3 底层，看看如何<strong>手动渲染组件</strong>。</p>
</blockquote>
<h3 data-id="heading-1">1. 为什么需要手动挂载？</h3>
<p>想象一下，如果你想弹出一个成功提示，哪种方式更优雅？</p>
<p><strong>方式 A (声明式)</strong>：
需要在每个页面的 template 里都写一遍组件，还要定义一个变量来控制显示隐藏。</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">MyMessage</span> <span class="hljs-attr">:visible</span>=<span class="hljs-string">"showMsg"</span> <span class="hljs-attr">message</span>=<span class="hljs-string">"操作成功"</span> /&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">button</span> @<span class="hljs-attr">click</span>=<span class="hljs-string">"showMsg = true"</span>&gt;</span>点击<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>
</code></pre>
<p><strong>方式 B (命令式)</strong>：
直接在 JS 里调用，随用随调，完全解耦。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { message } <span class="hljs-keyword">from</span> <span class="hljs-string">'my-ui'</span>

<span class="hljs-keyword">function</span> <span class="hljs-title function_">handleClick</span>(<span class="hljs-params"/>) {
  message.<span class="hljs-title function_">success</span>(<span class="hljs-string">'操作成功'</span>)
}
</code></pre>
<p>显然，方式 B 是组件库的标准做法。但 Vue 的组件通常是渲染在父组件的模板里的，如何把它“凭空”变出来并挂载到 <code>document.body</code> 上呢？</p>
<p>这就需要用到 Vue3 暴露的两个底层 API：<code>createVNode</code> 和 <code>render</code>。</p>
<h3 data-id="heading-2">2. 核心 API 解密</h3>
<h4 data-id="heading-3">createVNode：画图纸</h4>
<p>在 Vue 中，一切皆 VNode（虚拟节点）。普通的 <code>.vue</code> 文件只是一个组件定义，它不是 DOM，也不是 VNode。我们需要用 <code>createVNode</code> 把它实例化。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { createVNode } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">MyComponent</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'./MyComponent.vue'</span>

<span class="hljs-comment">// 这就像是拿着图纸 (MyComponent)</span>
<span class="hljs-comment">// 创建了一个具体的实例化对象 (vm)</span>
<span class="hljs-comment">// 第二个参数是 props</span>
<span class="hljs-keyword">const</span> vnode = <span class="hljs-title function_">createVNode</span>(<span class="hljs-title class_">MyComponent</span>, { <span class="hljs-attr">title</span>: <span class="hljs-string">'Hello'</span> })
</code></pre>
<h4 data-id="heading-4">render：施工队</h4>
<p>有了 VNode，它还只是内存里的对象。我们需要 <code>render</code> 函数把它变成真实的 DOM 节点，并挂载到某个容器上。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { render } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>

<span class="hljs-keyword">const</span> container = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">'div'</span>)
<span class="hljs-comment">// 把 vnode 渲染到 container 盒子里</span>
<span class="hljs-title function_">render</span>(vnode, container)

<span class="hljs-comment">// 最后把盒子放到 body 上</span>
<span class="hljs-variable language_">document</span>.<span class="hljs-property">body</span>.<span class="hljs-title function_">appendChild</span>(container)
</code></pre>
<h3 data-id="heading-5">3. 实战：手写一个简单的 Message 函数</h3>
<p>让我们来看看 <code>packages/components/message/src/method.ts</code> 是如何实现的。</p>
<h4 data-id="heading-6">第一步：创建容器与 VNode</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> { createVNode, render } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">MessageConstructor</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'./message.vue'</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">message</span>(<span class="hljs-params">options</span>) {
  <span class="hljs-comment">// 1. 创建一个临时的 div 容器</span>
  <span class="hljs-keyword">const</span> container = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">'div'</span>)

  <span class="hljs-comment">// 2. 创建 VNode，并将 options 作为 props 传入</span>
  <span class="hljs-comment">// 例如：createVNode(MessageConstructor, { message: '你好', type: 'success' })</span>
  <span class="hljs-keyword">const</span> vnode = <span class="hljs-title function_">createVNode</span>(<span class="hljs-title class_">MessageConstructor</span>, options)

  <span class="hljs-comment">// 3. 将 VNode 渲染到 container 中</span>
  <span class="hljs-comment">// 此时 container.firstElementChild 就是组件生成的真实 DOM</span>
  <span class="hljs-title function_">render</span>(vnode, container)

  <span class="hljs-comment">// 4. 将真实 DOM 追加到 body</span>
  <span class="hljs-variable language_">document</span>.<span class="hljs-property">body</span>.<span class="hljs-title function_">appendChild</span>(container.<span class="hljs-property">firstElementChild</span>!)
}
</code></pre>
<h4 data-id="heading-7">第二步：处理组件卸载</h4>
<p>这就完事了吗？并没有。如果我们不处理销毁逻辑，这些 DOM 节点会一直堆积在 body 里，造成内存泄漏。</p>
<p>我们需要在组件内部发射一个 <code>destroy</code> 事件（比如在动画结束时），然后在外部监听它。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">const</span> vnode = <span class="hljs-title function_">createVNode</span>(<span class="hljs-title class_">MessageConstructor</span>, {
  ...options,
  <span class="hljs-comment">// 监听组件内部 emit('destroy')</span>
  <span class="hljs-attr">onDestroy</span>: <span class="hljs-function">() =&gt;</span> {
    <span class="hljs-comment">// 移除 DOM</span>
    <span class="hljs-title function_">render</span>(<span class="hljs-literal">null</span>, container) <span class="hljs-comment">// 这一步会触发组件的 unmounted 钩子</span>
  }
})
</code></pre>
<h3 data-id="heading-8">4. 源码深潜：createVNode 和 render 到底干了啥？</h3>
<p>对于好奇心强的同学，可能想知道：Vue 内部到底是怎么把这几行代码变成页面的？让我们用最通俗的伪代码来拆解一下。</p>
<h4 data-id="heading-9">4.1 createVNode：给节点“打标签”</h4>
<p><code>createVNode</code> 的核心任务不仅仅是创建一个对象，更是为了<strong>性能优化</strong>。它会根据你传入的类型，给 VNode 打上一个二进制标记（ShapeFlag）。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 伪代码简化版</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">createVNode</span>(<span class="hljs-params"><span class="hljs-keyword">type</span>, props, children</span>) {
  <span class="hljs-comment">// 1. 定义 VNode 结构</span>
  <span class="hljs-keyword">const</span> vnode = {
    <span class="hljs-keyword">type</span>, <span class="hljs-comment">// 组件对象 或 'div' 标签名</span>
    props,
    children,
    <span class="hljs-attr">component</span>: <span class="hljs-literal">null</span>, <span class="hljs-comment">// 稍后挂载组件实例</span>
    <span class="hljs-attr">el</span>: <span class="hljs-literal">null</span>, <span class="hljs-comment">// 稍后挂载真实 DOM</span>
    <span class="hljs-attr">shapeFlag</span>: <span class="hljs-number">0</span> <span class="hljs-comment">// 核心：类型标记</span>
  }

  <span class="hljs-comment">// 2. 通过位运算打标记</span>
  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> <span class="hljs-keyword">type</span> === <span class="hljs-string">'string'</span>) {
    vnode.<span class="hljs-property">shapeFlag</span> = <span class="hljs-title class_">ShapeFlags</span>.<span class="hljs-property">ELEMENT</span> <span class="hljs-comment">// 这是一个 HTML 标签 (div, span)</span>
  }
  <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> <span class="hljs-keyword">type</span> === <span class="hljs-string">'object'</span>) {
    vnode.<span class="hljs-property">shapeFlag</span> = <span class="hljs-title class_">ShapeFlags</span>.<span class="hljs-property">STATEFUL_COMPONENT</span> <span class="hljs-comment">// 这是一个 Vue 组件</span>
  }

  <span class="hljs-keyword">return</span> vnode
}
</code></pre>
<p><strong>为什么要这么做？</strong>
Vue 的更新过程非常频繁。有了 <code>shapeFlag</code>，在后续的 Diff 过程中，Vue 就不需要每次都去猜“这是个啥”，直接看二进制位就知道怎么处理，速度极快。</p>
<h4 data-id="heading-10">4.2 render：万能的包工头</h4>
<p><code>render</code> 函数其实非常简单，它背后真正的干活主力是 <code>patch</code> 函数。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 伪代码简化版</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">render</span>(<span class="hljs-params">vnode, container</span>) {
  <span class="hljs-keyword">if</span> (vnode == <span class="hljs-literal">null</span>) {
    <span class="hljs-comment">// 如果传 null，说明要销毁</span>
    <span class="hljs-keyword">if</span> (container.<span class="hljs-property">_vnode</span>) {
      <span class="hljs-title function_">unmount</span>(container.<span class="hljs-property">_vnode</span>) <span class="hljs-comment">// 卸载旧节点</span>
    }
  }
  <span class="hljs-keyword">else</span> {
    <span class="hljs-comment">// 如果有新 VNode，就开始“打补丁”</span>
    <span class="hljs-comment">// 参数：(旧节点, 新节点, 容器)</span>
    <span class="hljs-title function_">patch</span>(container.<span class="hljs-property">_vnode</span> || <span class="hljs-literal">null</span>, vnode, container)
  }

  <span class="hljs-comment">// 记住这次渲染的 VNode，下次更新时它就是“旧节点”了</span>
  container.<span class="hljs-property">_vnode</span> = vnode
}
</code></pre>
<h4 data-id="heading-11">4.3 patch：分发任务</h4>
<p><code>patch</code> 是 Vue 渲染器的核心。它根据我们前面打的 <code>shapeFlag</code>，把任务分发给不同的处理函数。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">patch</span>(<span class="hljs-params">n1, n2, container</span>) {
  <span class="hljs-keyword">if</span> (n1 &amp;&amp; !<span class="hljs-title function_">isSameVNodeType</span>(n1, n2)) {
    <span class="hljs-comment">// 如果类型都不一样（比如从 div 变成了 span），直接卸载旧的</span>
    <span class="hljs-title function_">unmount</span>(n1)
    n1 = <span class="hljs-literal">null</span>
  }

  <span class="hljs-keyword">const</span> { shapeFlag } = n2
  <span class="hljs-keyword">if</span> (shapeFlag &amp; <span class="hljs-title class_">ShapeFlags</span>.<span class="hljs-property">ELEMENT</span>) {
    <span class="hljs-comment">// 这是一个 HTML 标签</span>
    <span class="hljs-title function_">processElement</span>(n1, n2, container)
  }
  <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (shapeFlag &amp; <span class="hljs-title class_">ShapeFlags</span>.<span class="hljs-property">COMPONENT</span>) {
    <span class="hljs-comment">// 这是一个 Vue 组件</span>
    <span class="hljs-title function_">processComponent</span>(n1, n2, container)
  }
}
</code></pre>
<h4 data-id="heading-12">4.4 深入 processComponent：组件是怎么跑起来的？</h4>
<p>当 <code>patch</code> 发现这是个组件时，它会区分是“初次挂载”还是“更新”。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">processComponent</span>(<span class="hljs-params">n1, n2, container</span>) {
  <span class="hljs-keyword">if</span> (n1 == <span class="hljs-literal">null</span>) {
    <span class="hljs-comment">// 1. 挂载组件 (Mount)</span>
    <span class="hljs-title function_">mountComponent</span>(n2, container)
  }
  <span class="hljs-keyword">else</span> {
    <span class="hljs-comment">// 2. 更新组件 (Update)</span>
    <span class="hljs-title function_">updateComponent</span>(n1, n2)
  }
}
</code></pre>
<p><strong>mountComponent 做的事情：</strong></p>
<ol>
<li><strong>创建实例</strong>：<code>const instance = createComponentInstance(vnode)</code>。</li>
<li><strong>设置状态</strong>：初始化 <code>props</code>、<code>slots</code>，执行 <code>setup()</code> 函数。</li>
<li><strong>建立副作用</strong>：创建一个 <code>effect</code>（响应式副作用），运行组件的 <code>render</code> 函数生成子树（subTree），并监听响应式数据变化。</li>
</ol>
<h4 data-id="heading-13">4.5 深入 processElement：挂载与更新</h4>
<p>当 <code>patch</code> 遇到 HTML 标签时，会根据 <code>n1</code>（旧节点）是否存在来决定是初始化还是更新。</p>
<h5 data-id="heading-14">1. 挂载 (Mount)</h5>
<p>如果 <code>n1</code> 为 <code>null</code>，说明是初次渲染。Vue 会调用宿主环境的 API（如 <code>document.createElement</code>）创建真实 DOM，并将其插入到容器中。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">mountElement</span>(<span class="hljs-params">vnode, container</span>) {
  <span class="hljs-comment">// 1. 创建真实 DOM</span>
  <span class="hljs-keyword">const</span> el = (vnode.<span class="hljs-property">el</span> = <span class="hljs-title function_">hostCreateElement</span>(vnode.<span class="hljs-property">type</span>))

  <span class="hljs-comment">// 2. 处理 Props (Style, Class, Event)</span>
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> key <span class="hljs-keyword">in</span> vnode.<span class="hljs-property">props</span>) {
    <span class="hljs-title function_">hostPatchProp</span>(el, key, <span class="hljs-literal">null</span>, vnode.<span class="hljs-property">props</span>[key])
  }

  <span class="hljs-comment">// 3. 处理子节点 (递归 mount)</span>
  <span class="hljs-title function_">mountChildren</span>(vnode.<span class="hljs-property">children</span>, el)

  <span class="hljs-comment">// 4. 插入页面</span>
  <span class="hljs-title function_">hostInsert</span>(el, container)
}
</code></pre>
<h5 data-id="heading-15">2. 更新 (Patch)</h5>
<p>如果 <code>n1</code> 存在，Vue 就需要对比新旧节点，做最小量的 DOM 操作。</p>
<ol>
<li><strong>更新 Props</strong>：对比新旧 Props，修改变动的 Class、Style 或事件监听器。</li>
<li><strong>更新 Children (核心 Diff)</strong>：这是最复杂的部分。</li>
</ol>
<h4 data-id="heading-16">4.6 核心 Diff 算法：Vue3 是如何“增删改移”的？</h4>
<p>Vue3 采用的是<strong>快速 Diff 算法 (Quick Diff)</strong>。它的核心思想是：<strong>先处理两端容易对比的节点，最后再处理中间复杂的乱序部分</strong>。</p>
<p>我们通过一个具体的代码示例来模拟这个过程。</p>
<p><strong>假设场景：</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 旧列表 (n1)</span>
<span class="hljs-keyword">const</span> oldChildren = [
  { <span class="hljs-attr">key</span>: <span class="hljs-string">'A'</span> }, { <span class="hljs-attr">key</span>: <span class="hljs-string">'B'</span> }, <span class="hljs-comment">// 头</span>
  { <span class="hljs-attr">key</span>: <span class="hljs-string">'C'</span> }, { <span class="hljs-attr">key</span>: <span class="hljs-string">'D'</span> }, { <span class="hljs-attr">key</span>: <span class="hljs-string">'E'</span> }, <span class="hljs-comment">// 中间</span>
  { <span class="hljs-attr">key</span>: <span class="hljs-string">'F'</span> }, { <span class="hljs-attr">key</span>: <span class="hljs-string">'G'</span> }  <span class="hljs-comment">// 尾</span>
]

<span class="hljs-comment">// 新列表 (n2)</span>
<span class="hljs-keyword">const</span> newChildren = [
  { <span class="hljs-attr">key</span>: <span class="hljs-string">'A'</span> }, { <span class="hljs-attr">key</span>: <span class="hljs-string">'B'</span> }, <span class="hljs-comment">// 头 (不变)</span>
  { <span class="hljs-attr">key</span>: <span class="hljs-string">'E'</span> }, { <span class="hljs-attr">key</span>: <span class="hljs-string">'C'</span> }, { <span class="hljs-attr">key</span>: <span class="hljs-string">'D'</span> }, { <span class="hljs-attr">key</span>: <span class="hljs-string">'H'</span> }, <span class="hljs-comment">// 中间 (乱序 + 新增)</span>
  { <span class="hljs-attr">key</span>: <span class="hljs-string">'F'</span> }, { <span class="hljs-attr">key</span>: <span class="hljs-string">'G'</span> }  <span class="hljs-comment">// 尾 (不变)</span>
]
</code></pre>
<h5 data-id="heading-17">第一步：掐头（Sync from start）</h5>
<p>Vue 会维护一个索引 <code>i = 0</code>，从头部开始向后遍历，如果 <code>key</code> 相同，直接 patch（更新属性），然后 <code>i++</code>。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>
<span class="hljs-keyword">const</span> e1 = oldChildren.<span class="hljs-property">length</span> - <span class="hljs-number">1</span> <span class="hljs-comment">// 旧列表尾部索引</span>
<span class="hljs-keyword">const</span> e2 = newChildren.<span class="hljs-property">length</span> - <span class="hljs-number">1</span> <span class="hljs-comment">// 新列表尾部索引</span>

<span class="hljs-comment">// 1. 从头往后比</span>
<span class="hljs-keyword">while</span> (i &lt;= e1 &amp;&amp; i &lt;= e2) {
  <span class="hljs-keyword">const</span> n1 = oldChildren[i]
  <span class="hljs-keyword">const</span> n2 = newChildren[i]
  
  <span class="hljs-keyword">if</span> (<span class="hljs-title function_">isSameVNodeType</span>(n1, n2)) {
    <span class="hljs-title function_">patch</span>(n1, n2, container) <span class="hljs-comment">// 复用节点，更新 Props</span>
    i++
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-keyword">break</span> <span class="hljs-comment">// 遇到不同的 (C vs E)，停下来</span>
  }
}
<span class="hljs-comment">// 此时 i = 2，指向 C 和 E</span>
</code></pre>
<h5 data-id="heading-18">第二步：去尾（Sync from end）</h5>
<p>同样的逻辑，从尾部开始向前遍历。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 2. 从尾往前比</span>
<span class="hljs-keyword">while</span> (i &lt;= e1 &amp;&amp; i &lt;= e2) {
  <span class="hljs-keyword">const</span> n1 = oldChildren[e1]
  <span class="hljs-keyword">const</span> n2 = newChildren[e2]
  
  <span class="hljs-keyword">if</span> (<span class="hljs-title function_">isSameVNodeType</span>(n1, n2)) {
    <span class="hljs-title function_">patch</span>(n1, n2, container)
    e1--
    e2--
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-keyword">break</span> <span class="hljs-comment">// 遇到不同的 (E vs H)，停下来</span>
  }
}
<span class="hljs-comment">// 此时 e1 = 4 (指向 E), e2 = 5 (指向 H)</span>
</code></pre>
<p><strong>此时的状态：</strong></p>
<ul>
<li>头部 A, B 已处理。</li>
<li>尾部 F, G 已处理。</li>
<li><strong>剩下的烂摊子</strong>：
<ul>
<li>旧：<code>[C, D, E]</code> (索引 2 到 4)</li>
<li>新：<code>[E, C, D, H]</code> (索引 2 到 5)</li>
</ul>
</li>
</ul>
<h5 data-id="heading-19">第三步：处理新增与删除（简单情况）</h5>
<p>如果预处理后，旧列表没了（<code>i &gt; e1</code>），新列表还剩，说明全是<strong>新增</strong>。
如果新列表没了（<code>i &gt; e2</code>），旧列表还剩，说明全是<strong>删除</strong>。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">if</span> (i &gt; e1) {
  <span class="hljs-keyword">if</span> (i &lt;= e2) {
    <span class="hljs-comment">// 旧的没了，新的还有 -&gt; 挂载剩余的新节点</span>
    <span class="hljs-keyword">while</span> (i &lt;= e2) <span class="hljs-title function_">patch</span>(<span class="hljs-literal">null</span>, newChildren[i++], container)
  }
} 
<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (i &gt; e2) {
  <span class="hljs-comment">// 新的没了，旧的还有 -&gt; 卸载剩余的旧节点</span>
  <span class="hljs-keyword">while</span> (i &lt;= e1) <span class="hljs-title function_">unmount</span>(oldChildren[i++])
}
</code></pre>
<h5 data-id="heading-20">第四步：处理乱序（Unknown Sequence）</h5>
<p>这是最复杂的情况（如我们的例子）。Vue 需要判断哪些节点移动了，哪些需要新建。</p>
<p><strong>1. 构建新节点映射表与初始化</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 1. 构建新节点的 key 映射表</span>
<span class="hljs-keyword">const</span> keyToNewIndexMap = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>()
<span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> k = i; k &lt;= e2; k++) {
  keyToNewIndexMap.<span class="hljs-title function_">set</span>(newChildren[k].<span class="hljs-property">key</span>, k)
}

<span class="hljs-comment">// 2. 待处理新节点数量</span>
<span class="hljs-keyword">const</span> count = e2 - i + <span class="hljs-number">1</span>
<span class="hljs-comment">// 3. 记录新节点在旧列表中的位置（用于计算最长递增子序列）</span>
<span class="hljs-keyword">const</span> newIndexToOldIndexMap = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Array</span>(count).<span class="hljs-title function_">fill</span>(<span class="hljs-number">0</span>)
</code></pre>
<p><strong>2. 遍历旧节点：复用与删除</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 4. 遍历旧节点，寻找可复用的节点</span>
<span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> k = i; k &lt;= e1; k++) {
  <span class="hljs-keyword">const</span> oldChild = oldChildren[k]
  <span class="hljs-keyword">const</span> newIndex = keyToNewIndexMap.<span class="hljs-title function_">get</span>(oldChild.<span class="hljs-property">key</span>)

  <span class="hljs-keyword">if</span> (newIndex === <span class="hljs-literal">undefined</span>) {
    <span class="hljs-comment">// 旧节点在新列表中找不到了 -&gt; 删除</span>
    <span class="hljs-title function_">unmount</span>(oldChild)
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-comment">// 找到了！记录旧索引 + 1（防止 0 索引冲突）</span>
    <span class="hljs-comment">// newIndex - i 是为了映射到从 0 开始的 count 数组中</span>
    newIndexToOldIndexMap[newIndex - i] = k + <span class="hljs-number">1</span>
    <span class="hljs-comment">// 进行递归比对</span>
    <span class="hljs-title function_">patch</span>(oldChild, newChildren[newIndex], container)
  }
}
<span class="hljs-comment">/**
 * 此时产生的映射关系图例：
 * 
 * 索引 (i):      0    1    2    3   (对应新列表中的位置)
 * 新节点 key:   [E]  [C]  [D]  [H]
 * 旧索引 + 1:   [5]  [3]  [4]  [0]  (对应 newIndexToOldIndexMap)
 * 
 * 其中：
 * - 0 代表 H 是新来的，需要挂载 (Mount)
 * - 3, 4 是递增的序列 -&gt; 这就是 LIS (最长递增子序列)
 * - 5 打破了递增性 -&gt; 说明 E 发生了移动
 */</span>
</code></pre>
<blockquote>
<p><strong>💡 小白专属解释：</strong></p>
<p>你可以把 <code>newIndexToOldIndexMap</code> 想象成一张 <strong>“寻人启事表”</strong>。
表格的长度就是新列表里乱序的人数（这里是 4 个：E, C, D, H）。</p>
<ul>
<li><strong>第 0 格 (E)</strong>：表里写着 <code>5</code>。意思是：“我是旧列表里的第 4 号（5-1）人”。</li>
<li><strong>第 1 格 (C)</strong>：表里写着 <code>3</code>。意思是：“我是旧列表里的第 2 号（3-1）人”。</li>
<li><strong>第 2 格 (D)</strong>：表里写着 <code>4</code>。意思是：“我是旧列表里的第 3 号（4-1）人”。</li>
<li><strong>第 3 格 (H)</strong>：表里写着 <code>0</code>。意思是：“查无此人，我是新来的”。</li>
</ul>
<p>Vue 看到这张表，就知道谁是从哪儿来的，谁是新来的。然后只要算出哪个序列是<strong>递增</strong>的（3 -&gt; 4），就说明这几个人（C 和 D）的相对站位没变，可以不用动，省力气！</p>
</blockquote>
<p><strong>3. 计算最长递增子序列 (LIS)</strong></p>
<p>Vue 使用一个算法算出 <code>newIndexToOldIndexMap</code> 中的<strong>最长递增子序列</strong>。这个序列里的节点，在旧列表和新列表里的相对顺序是一样的，所以<strong>不需要移动</strong>。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 获取最长递增子序列的相对索引</span>
<span class="hljs-comment">// 传入: [5, 3, 4, 0] (忽略 0)</span>
<span class="hljs-comment">// 返回: [1, 2] (对应值 3, 4，即 C 和 D，它们在 newIndexToOldIndexMap 中的下标)</span>
<span class="hljs-keyword">const</span> increasingNewIndexSequence = <span class="hljs-title function_">getSequence</span>(newIndexToOldIndexMap)

<span class="hljs-comment">// j 指向 LIS 数组的末尾 (即最大索引)</span>
<span class="hljs-keyword">let</span> j = increasingNewIndexSequence.<span class="hljs-property">length</span> - <span class="hljs-number">1</span>
</code></pre>
<p><strong>4. 倒序遍历与移动 (Moving)</strong></p>
<p>最后，我们<strong>从后往前</strong>遍历需要处理的新节点。
为什么倒序？因为 <code>insert</code> 操作需要一个<strong>参照节点 (Anchor)</strong>。从后往前遍历时，当前节点的<strong>后一个节点</strong>一定已经处理好了（要么是刚移动完的，要么是末尾固定的），可以放心地作为 Anchor。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 遍历待处理的新节点 (倒序)</span>
<span class="hljs-comment">// k: 当前处理节点在乱序区间内的相对索引 (0 ~ count-1)</span>
<span class="hljs-comment">// i: 乱序区间的起始索引 (全局索引)</span>
<span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> k = count - <span class="hljs-number">1</span>; k &gt;= <span class="hljs-number">0</span>; k--) {
  <span class="hljs-comment">// 1. 计算该节点在新列表中的真实全局索引</span>
  <span class="hljs-keyword">const</span> nextIndex = i + k
  <span class="hljs-keyword">const</span> nextChild = newChildren[nextIndex]
  
  <span class="hljs-comment">// 2. 找锚点 (Anchor)：就是它后面那个节点</span>
  <span class="hljs-comment">// 如果 nextIndex + 1 超过了长度，说明它是最后一个，锚点是 null (插到容器末尾)</span>
  <span class="hljs-keyword">const</span> anchor = nextIndex + <span class="hljs-number">1</span> &lt; newChildren.<span class="hljs-property">length</span> ? newChildren[nextIndex + <span class="hljs-number">1</span>].<span class="hljs-property">el</span> : <span class="hljs-literal">null</span>

  <span class="hljs-keyword">if</span> (newIndexToOldIndexMap[k] === <span class="hljs-number">0</span>) {
    <span class="hljs-comment">// ------------------------------------</span>
    <span class="hljs-comment">// 情况 1: 标记是 0 -&gt; 新增节点</span>
    <span class="hljs-comment">// ------------------------------------</span>
    <span class="hljs-title function_">patch</span>(<span class="hljs-literal">null</span>, nextChild, container, anchor)
  
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (j &lt; <span class="hljs-number">0</span> || k !== increasingNewIndexSequence[j]) {
    <span class="hljs-comment">// ------------------------------------</span>
    <span class="hljs-comment">// 情况 2: 需要移动</span>
    <span class="hljs-comment">// ------------------------------------</span>
    <span class="hljs-comment">// 这里的 k 不在 LIS 里，说明位置不对，需要搬家</span>
    <span class="hljs-title function_">move</span>(nextChild, container, anchor) 
  
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-comment">// ------------------------------------</span>
    <span class="hljs-comment">// 情况 3: 命中 LIS -&gt; 原地不动</span>
    <span class="hljs-comment">// ------------------------------------</span>
    <span class="hljs-comment">// k === seq[j]: 恭喜，这个节点在最长递增序列里</span>
    <span class="hljs-comment">// 它的相对位置没变，不需要动 DOM，只需要让 LIS 指针前移</span>
    j--
  }
}
</code></pre>
<blockquote>
<p><strong>💡 核心逻辑图解：</strong></p>
<ol>
<li><strong>H (i=3)</strong>: Map 值为 0 -&gt; <strong>新建</strong>，插到末尾。</li>
<li><strong>D (i=2)</strong>: 命中 LIS (seq[j]=2) -&gt; <strong>不动</strong>，<code>j--</code>。</li>
<li><strong>C (i=1)</strong>: 命中 LIS (seq[j]=1) -&gt; <strong>不动</strong>，<code>j--</code>。</li>
<li><strong>E (i=0)</strong>: 不在 LIS 里 -&gt; <strong>移动</strong>，插到 C 前面。</li>
</ol>
</blockquote>
<h3 data-id="heading-21">5. 源码级细节：为什么需要 Context？</h3>
<p>你可能会发现我们的源码里有这么一行：</p>
<pre><code class="hljs language-typescript" lang="typescript">vnode.<span class="hljs-property">appContext</span> = context || <span class="hljs-literal">null</span>
</code></pre>
<p>这是为了让动态挂载的组件能继承当前 App 的上下文。比如，你在主 App 里注册了 <code>vue-router</code> 或 <code>i18n</code>，如果不把 <code>appContext</code> 赋值给新的 VNode，那么在这个 Message 组件里就无法使用 <code>useRouter()</code> 或 <code>$t()</code>。</p>
<h3 data-id="heading-22">6. 总结</h3>
<p>通过手动使用 <code>createVNode</code> 和 <code>render</code>，我们突破了 Vue 模板的限制，实现了能够动态创建、挂载、销毁的命令式组件。</p>
<p>这也是开发高级组件（如弹窗、抽屉、通知）的必经之路。</p>
<p><strong>关键点复习</strong>：</p>
<ol>
<li><code>createVNode(Component, props)</code> 创建虚拟节点。</li>
<li><code>render(vnode, container)</code> 将虚拟节点转化为真实 DOM。</li>
<li><code>render(null, container)</code> 销毁组件，释放内存。</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[async/await : 一场生成器和 Promise的里应外合]]></title>    <link>https://juejin.cn/post/7595864836360241204</link>    <guid>https://juejin.cn/post/7595864836360241204</guid>    <pubDate>2026-01-17T08:43:33.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7595864836360241204" data-draft-id="7595858353660723234" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="async/await : 一场生成器和 Promise的里应外合"/> <meta itemprop="keywords" content="前端,JavaScript,性能优化"/> <meta itemprop="datePublished" content="2026-01-17T08:43:33.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="sophie旭"/> <meta itemprop="url" content="https://juejin.cn/user/2559318799692952"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            async/await : 一场生成器和 Promise的里应外合
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2559318799692952/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    sophie旭
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-17T08:43:33.000Z" title="Sat Jan 17 2026 08:43:33 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-17
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读19分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">背景</h2>
<p>说实话，async/await 我在日常工作中好像并没有很主动的去用，可能对于异步编程，我宁愿去用 Promise这种显式链式方式告诉自己，这是异步流程。同步式的代码让我有点心有余悸，为啥会这样放着更过“高级”的API不用呢？我想可能有一方面的原因是，我对它的了解不深吧，或者只停留在了解吧，这两天看了下 async/await 的原理，发现它并没有那么神秘，并且是站在两位巨人的肩膀上的。</p>
<h2 data-id="heading-1">巨人一号：生成器 Generator</h2>
<h3 data-id="heading-2">Generator基本使用</h3>
<p>Generator相信大家都不陌生啦，我们直接上代码看运行结果吧</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 定义一个生成器函数（普通函数 + *）</span>
<span class="hljs-keyword">function</span>* <span class="hljs-title function_">numberGenerator</span>(<span class="hljs-params"/>) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"生成器函数开始执行"</span>);
  
  <span class="hljs-comment">// 第一次yield，向外返回值</span>
  <span class="hljs-keyword">const</span> firstValue = <span class="hljs-keyword">yield</span> <span class="hljs-number">1</span>; <span class="hljs-comment">// yield左边可以接收next传入的参数</span>
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"第一个yield接收到的参数:"</span>, firstValue);
  
  <span class="hljs-comment">// 第二次yield</span>
  <span class="hljs-keyword">const</span> secondValue = <span class="hljs-keyword">yield</span> <span class="hljs-number">2</span>;
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"第二个yield接收到的参数:"</span>, secondValue);
  
  <span class="hljs-comment">// 第三次yield</span>
  <span class="hljs-keyword">yield</span> <span class="hljs-number">3</span>;
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"生成器函数即将执行完毕"</span>);
  
  <span class="hljs-comment">// 函数结束，done会变为true</span>
  <span class="hljs-keyword">return</span> <span class="hljs-string">"执行结束"</span>;
}

<span class="hljs-comment">// 1. 调用生成器函数，不会执行函数体，只会得到生成器对象</span>
<span class="hljs-keyword">const</span> generator = <span class="hljs-title function_">numberGenerator</span>();
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"调用生成器函数后得到的对象:"</span>, generator); <span class="hljs-comment">// 输出 Generator 对象，无函数体执行日志</span>

<span class="hljs-comment">// 2. 第一次调用next()，函数体开始执行，直到第一个yield暂停</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"第一次next返回:"</span>, generator.<span class="hljs-title function_">next</span>()); 
<span class="hljs-comment">// 输出：</span>
<span class="hljs-comment">// 生成器函数开始执行</span>
<span class="hljs-comment">// 第一次next返回: { value: 1, done: false }</span>

<span class="hljs-comment">// 3. 第二次调用next()并传入参数，参数会作为上一个yield的返回值</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"第二次next返回:"</span>, generator.<span class="hljs-title function_">next</span>(<span class="hljs-string">"我是第一个yield的返回值"</span>));
<span class="hljs-comment">// 输出：</span>
<span class="hljs-comment">// 第一个yield接收到的参数: 我是第一个yield的返回值</span>
<span class="hljs-comment">// 第二次next返回: { value: 2, done: false }</span>

<span class="hljs-comment">// 4. 第三次调用next()并传入参数</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"第三次next返回:"</span>, generator.<span class="hljs-title function_">next</span>(<span class="hljs-string">"我是第二个yield的返回值"</span>));
<span class="hljs-comment">// 输出：</span>
<span class="hljs-comment">// 第二个yield接收到的参数: 我是第二个yield的返回值</span>
<span class="hljs-comment">// 生成器函数即将执行完毕</span>
<span class="hljs-comment">// 第三次next返回: { value: 3, done: false }</span>

<span class="hljs-comment">// 5. 第四次调用next()，函数执行到return，done变为true</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"第四次next返回:"</span>, generator.<span class="hljs-title function_">next</span>());
<span class="hljs-comment">// 输出：</span>
<span class="hljs-comment">// 第四次next返回: { value: '执行结束', done: true }</span>

<span class="hljs-comment">// 6. 后续调用next()，value为undefined，done保持true</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"第五次next返回:"</span>, generator.<span class="hljs-title function_">next</span>());
<span class="hljs-comment">// 输出：</span>
<span class="hljs-comment">// 第五次next返回: { value: undefined, done: true }</span>
</code></pre>
<h4 data-id="heading-3">关键特性解释</h4>
<ol>
<li><strong>生成器函数定义</strong>：<code>function* 函数名()</code> 是生成器函数的语法（<code>*</code> 的位置可以在 <code>function</code> 后、函数名前，空格不影响），这是和普通函数最核心的区别。</li>
<li><strong>调用不执行</strong>：调用 <code>numberGenerator()</code> 不会执行函数体，只会返回一个 <code>Generator</code> 对象，这和普通函数调用立即执行完全不同。</li>
<li><strong>yield 暂停与返回</strong>：
<ul>
<li><code>yield</code> 是生成器的核心关键词，执行到 <code>yield</code> 时，函数会<strong>暂停执行</strong>（而非结束），并将 <code>yield</code> 后的值作为 <code>next()</code> 返回对象的 <code>value</code>。</li>
<li><code>yield</code> 不像 <code>return</code> 那样终止函数，下次调用 <code>next()</code> 会从暂停的位置继续执行。</li>
</ul>
</li>
<li><strong>next 传参</strong>：<code>generator.next(参数)</code> 传入的参数，会作为<strong>上一个 <code>yield</code> 语句的返回值</strong>（注意：第一个 <code>next()</code> 传参无效，因为此时还没有执行过任何 <code>yield</code>）。</li>
<li><strong>done 属性</strong>：<code>next()</code> 返回对象的 <code>done</code> 属性表示生成器是否执行完毕：
<ul>
<li><code>false</code>：生成器未执行完，还能继续调用 <code>next()</code> 获取值；</li>
<li><code>true</code>：生成器执行完毕（执行到 <code>return</code> 或函数末尾），<strong>后续 <code>next()</code> 的 <code>value</code> 为 <code>undefined</code>(这一点我经常忽略)。</strong></li>
</ul>
</li>
</ol>
<h4 data-id="heading-4">总结</h4>
<ol>
<li>生成器函数通过 <code>function*</code> 定义，调用后返回生成器对象，而非立即执行函数体。</li>
<li><code>yield</code> 负责暂停函数并向外返回值，<code>next()</code> 负责恢复执行，且 <code>next()</code> 可传参作为上一个 <code>yield</code> 的返回值。</li>
<li><code>next()</code> 返回的对象包含 <code>value</code>（返回值）和 <code>done</code>（执行状态），<code>done: true</code> 表示生成器执行完毕。</li>
</ol>
<h3 data-id="heading-5">Generator throw</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 定义一个包含异常处理的生成器函数</span>
<span class="hljs-keyword">function</span>* <span class="hljs-title function_">fooGenerator</span>(<span class="hljs-params"/>) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"fooGenerator 开始执行（第一次next触发）"</span>);
  
  <span class="hljs-keyword">try</span> {
    <span class="hljs-comment">// 第一个yield：暂停并返回值，后续可能接收next传参</span>
    <span class="hljs-keyword">const</span> receivedValue = <span class="hljs-keyword">yield</span> <span class="hljs-string">"第一个yield返回值"</span>;
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"第一个yield接收到next的参数:"</span>, receivedValue);

    <span class="hljs-comment">// 执行到这里时，如果外部调用throw()，异常会抛到当前执行位置</span>
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"准备执行第二个yield..."</span>);
    <span class="hljs-keyword">yield</span> <span class="hljs-string">"第二个yield返回值"</span>;

    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"生成器未被中断，继续执行"</span>);
  } <span class="hljs-keyword">catch</span> (error) {
    <span class="hljs-comment">// 捕获外部throw()抛出的异常</span>
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"生成器内部捕获到异常:"</span>, error.<span class="hljs-property">message</span>);
    <span class="hljs-comment">// 捕获异常后，生成器可继续yield返回值</span>
    <span class="hljs-keyword">yield</span> <span class="hljs-string">"异常捕获后返回的兜底值"</span>;
  }

  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"生成器函数执行到末尾"</span>);
  <span class="hljs-keyword">return</span> <span class="hljs-string">"执行结束"</span>;
}

<span class="hljs-comment">// 1. 调用生成器函数，仅得到生成器对象，函数体不执行</span>
<span class="hljs-keyword">const</span> generator = <span class="hljs-title function_">fooGenerator</span>();
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"调用fooGenerator后得到的对象:"</span>, generator); <span class="hljs-comment">// Generator 对象</span>

<span class="hljs-comment">// 2. 第一次调用next()：函数体开始执行，直到第一个yield暂停</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"===== 第一次调用 next() ====="</span>);
<span class="hljs-keyword">const</span> firstNext = generator.<span class="hljs-title function_">next</span>();
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"第一次next返回:"</span>, firstNext);
<span class="hljs-comment">// 输出：</span>
<span class="hljs-comment">// fooGenerator 开始执行（第一次next触发）</span>
<span class="hljs-comment">// 第一次next返回: { value: '第一个yield返回值', done: false }</span>

<span class="hljs-comment">// 3. 第二次调用next(参数)：从第一个yield暂停处继续执行，参数作为yield返回值</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"\n===== 第二次调用 next('bar') ====="</span>);
<span class="hljs-keyword">const</span> secondNext = generator.<span class="hljs-title function_">next</span>(<span class="hljs-string">"bar"</span>);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"第二次next返回:"</span>, secondNext);
<span class="hljs-comment">// 输出：</span>
<span class="hljs-comment">// 第一个yield接收到next的参数: bar</span>
<span class="hljs-comment">// 准备执行第二个yield...</span>
<span class="hljs-comment">// 第二次next返回: { value: '第二个yield返回值', done: false }</span>

<span class="hljs-comment">// 4. 调用throw()：从第二个yield暂停处继续执行，但抛出异常</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"\n===== 调用 throw() 方法 ====="</span>);
<span class="hljs-keyword">const</span> throwResult = generator.<span class="hljs-keyword">throw</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">"外部手动抛出的异常"</span>));
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"throw()返回:"</span>, throwResult);
<span class="hljs-comment">// 输出：</span>
<span class="hljs-comment">// 生成器内部捕获到异常: 外部手动抛出的异常</span>
<span class="hljs-comment">// throw()返回: { value: '异常捕获后返回的兜底值', done: false }</span>

<span class="hljs-comment">// 5. 异常捕获后，生成器仍可继续执行next()</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"\n===== 异常后调用 next() ====="</span>);
<span class="hljs-keyword">const</span> thirdNext = generator.<span class="hljs-title function_">next</span>();
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"第三次next返回:"</span>, thirdNext);
<span class="hljs-comment">// 输出：</span>
<span class="hljs-comment">// 生成器函数执行到末尾</span>
<span class="hljs-comment">// 第三次next返回: { value: '执行结束', done: true }</span>
</code></pre>
<h4 data-id="heading-6">throw() 方法核心逻辑解释</h4>
<ol>
<li><strong>throw() 的执行触发</strong>：
<ul>
<li>和 <code>next()</code> 一样，调用 <code>generator.throw()</code> 会让生成器从<strong>上一次暂停的位置</strong>继续执行；</li>
<li>但不同于 <code>next()</code> 传入普通参数，<code>throw()</code> 会在生成器当前执行位置<strong>主动抛出一个异常</strong> -- <strong>意思就是 从当前位置直接去走catch逻辑，try逻辑不会再走了</strong>。</li>
</ul>
</li>
<li><strong>异常的捕获与处理</strong>：
<ul>
<li>如果生成器内部有 <code>try/catch</code> 块包裹了暂停位置后的执行逻辑，异常会被内部捕获，生成器不会立即终止；</li>
<li>如果内部没有捕获，异常会抛出到外部，生成器状态变为 <code>done: true</code>，后续调用 <code>next()</code> 只会返回 <code>{ value: undefined, done: true }</code>。</li>
</ul>
</li>
<li><strong>throw() 的返回值</strong>：
<ul>
<li>即使抛出了异常，只要内部捕获了，<code>throw()</code> 也会返回和 <code>next()</code> 一样的对象（<code>{ value, done }</code>）；</li>
<li>这个 <code>value</code> 是异常捕获后，生成器继续执行到下一个 <code>yield</code> 时返回的值（示例中就是 <code>异常捕获后返回的兜底值</code>）。</li>
</ul>
</li>
</ol>
<h4 data-id="heading-7">总结</h4>
<ol>
<li><code>throw()</code> 方法和 <code>next()</code> 一样能触发生成器继续执行，但核心作用是<strong>向生成器内部抛出异常</strong>；</li>
<li>生成器内部可通过 <code>try/catch</code> 捕获 <code>throw()</code> 抛出的异常，捕获后生成器不会终止，仍可继续执行并返回新的 <code>yield</code> 值；</li>
<li>生成器的执行始终是“暂停-恢复”模式：<code>next()</code> 恢复执行并传参，<code>throw()</code> 恢复执行并抛异常，本质都是改变生成器的执行状态。</li>
</ol>
<p><code>这个特性在异步编程中很实用，比如可以用 </code>throw()<code> 主动终止异步任务、处理异步流程中的错误等。</code></p>
<h2 data-id="heading-8">巨人二号：Promise</h2>
<p>Promise大家应该再熟悉不过了，由于篇幅原因，这篇先不做深入了解</p>
<p>下面让我们看看他们结合在一起会发生什么吧</p>
<h2 data-id="heading-9">“回调式” 写法 =》 “同步式” 写法</h2>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 传统 Promise 回调写法：有明显的回调嵌套感，代码“右移”</span>
<span class="hljs-title function_">fetch</span>(<span class="hljs-string">'https://jsonplaceholder.typicode.com/todos/1'</span>)
  .<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">response</span> =&gt;</span> response.<span class="hljs-title function_">json</span>())
  .<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">data</span> =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'请求结果:'</span>, data);
    <span class="hljs-comment">// 如果还要发第二个请求，就要在这继续嵌套 then，越套越深</span>
    <span class="hljs-title function_">fetch</span>(<span class="hljs-string">`https://jsonplaceholder.typicode.com/todos/<span class="hljs-subst">${data.id + <span class="hljs-number">1</span>}</span>`</span>)
      .<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">res</span> =&gt;</span> res.<span class="hljs-title function_">json</span>())
      .<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">data2</span> =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'第二个请求结果:'</span>, data2));
  })
  .<span class="hljs-title function_">catch</span>(<span class="hljs-function"><span class="hljs-params">error</span> =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'错误:'</span>, error));
</code></pre>
<p>以上代码，我们看到 虽然用到了Promise，但是也难免会出现嵌套，下面我们看看下面这段代码，</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 模拟 Ajax 请求：返回 Promise（真实项目里是 fetch/axios 等）</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">requestData</span>(<span class="hljs-params">url</span>) {
  <span class="hljs-keyword">return</span> <span class="hljs-title function_">fetch</span>(url)
    .<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">response</span> =&gt;</span> response.<span class="hljs-title function_">json</span>()) <span class="hljs-comment">// 解析 JSON 数据</span>
    .<span class="hljs-title function_">catch</span>(<span class="hljs-function"><span class="hljs-params">error</span> =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'请求失败:'</span>, error));
}

<span class="hljs-comment">// 定义生成器函数 main：内部用 yield 暂停，写“同步风格”的异步逻辑</span>
<span class="hljs-keyword">function</span>* <span class="hljs-title function_">main</span>(<span class="hljs-params"/>) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'开始执行生成器，准备发请求'</span>);
  
  <span class="hljs-comment">// 1. yield 抛出 Promise（Ajax 请求），生成器暂停执行</span>
  <span class="hljs-comment">// 这里的 result 会接收后续 next(data) 传进来的请求结果</span>
  <span class="hljs-keyword">const</span> result = <span class="hljs-keyword">yield</span> <span class="hljs-title function_">requestData</span>(<span class="hljs-string">'https://jsonplaceholder.typicode.com/todos/1'</span>);
  
  <span class="hljs-comment">// 3. 当外部调用 next(data) 后，生成器从暂停处恢复，执行这行</span>
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'生成器内部拿到的请求结果:'</span>, result);
  
  <span class="hljs-comment">// 可以继续发第二个请求，依然是“同步写法”</span>
  <span class="hljs-keyword">const</span> result2 = <span class="hljs-keyword">yield</span> <span class="hljs-title function_">requestData</span>(<span class="hljs-string">`https://jsonplaceholder.typicode.com/todos/<span class="hljs-subst">${result.id + <span class="hljs-number">1</span>}</span>`</span>);
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'第二个请求结果:'</span>, result2);
}

<span class="hljs-comment">// 外界执行生成器的逻辑</span>
<span class="hljs-keyword">const</span> generator = <span class="hljs-title function_">main</span>(); <span class="hljs-comment">// 1. 调用生成器，得到生成器对象（函数体不执行）</span>

<span class="hljs-comment">// 2. 第一次调用 next()：生成器开始执行，直到第一个 yield 暂停</span>
<span class="hljs-keyword">const</span> firstNextResult = generator.<span class="hljs-title function_">next</span>(); 
<span class="hljs-comment">// firstNextResult.value 就是 yield 抛出的 Promise（requestData 的返回值）</span>
<span class="hljs-keyword">const</span> promise = firstNextResult.<span class="hljs-property">value</span>;

<span class="hljs-comment">// 3. 等 Promise 执行完成（请求返回），把结果传给生成器</span>
promise.<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">data</span> =&gt;</span> {
  <span class="hljs-comment">// 调用 next(data)：把请求结果传进去，生成器从 yield 处恢复执行</span>
  generator.<span class="hljs-title function_">next</span>(data);
  
  <span class="hljs-comment">// 第二个请求的处理（如果有）：这里可以封装成自动执行逻辑，不用手动写</span>
  <span class="hljs-keyword">const</span> secondNextResult = generator.<span class="hljs-title function_">next</span>();
  secondNextResult.<span class="hljs-property">value</span>.<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">data2</span> =&gt;</span> {
    generator.<span class="hljs-title function_">next</span>(data2);
  });
});
</code></pre>
<h4 data-id="heading-10">逐行解释（对应你的描述）</h4>
<ol>
<li>
<p><strong>定义生成器函数 <code>main</code></strong>：</p>
<ul>
<li>内部 <code>yield requestData(...)</code>：<code>requestData</code> 返回 Promise（Ajax 请求），<code>yield</code> 会把这个 Promise 抛出去，同时<strong>暂停生成器的执行</strong>（不会立刻执行后面的 <code>console.log</code>）。</li>
<li><code>const result = yield ...</code>：这里的 <code>result</code> 暂时没有值，要等后续把请求结果传进来才会赋值。</li>
</ul>
</li>
<li>
<p><strong>外界调用生成器</strong>：</p>
<ul>
<li><code>const generator = main()</code>：调用生成器函数，只得到生成器对象，<code>main</code> 的函数体<strong>完全不执行</strong>。</li>
<li><code>generator.next()</code>：第一次调用 <code>next</code>，<code>main</code> 开始执行，直到遇到 <code>yield</code> 暂停；<code>next()</code> 返回的对象 <code>{ value: Promise, done: false }</code> 中，<code>value</code> 就是 <code>yield</code> 抛出来的 Promise（Ajax 请求）。</li>
</ul>
</li>
<li>
<p><strong>处理 Promise 结果，恢复生成器</strong>：</p>
<ul>
<li>给 Promise 加 <code>then</code> 回调，等请求返回拿到 <code>data</code> 后，调用 <code>generator.next(data)</code>：
<ul>
<li><code>data</code> 会作为<strong>上一个 <code>yield</code> 语句的返回值</strong>，赋值给 <code>main</code> 里的 <code>result</code>；</li>
<li>生成器从暂停的 <code>yield</code> 位置<strong>继续执行</strong>，执行后面的 <code>console.log(result)</code> —— 这一步就像“同步代码”一样，直接拿到了异步请求的结果。</li>
</ul>
</li>
</ul>
</li>
</ol>
<h4 data-id="heading-11">为什么说“消灭了回调，近乎同步体验”</h4>
<p>对比两种写法：</p>
<ul>
<li>传统 Promise：请求结果的处理逻辑必须写在 <code>then</code> 回调里（异步风格）；</li>
<li>生成器写法：<code>main</code> 内部没有任何 <code>then</code> 回调，<code>const result = yield ...</code> 看起来就像“同步赋值”，拿到结果后直接 <code>console.log</code> —— 代码结构和同步代码完全一致，只是多了 <code>yield</code> 关键字。</li>
</ul>
<h4 data-id="heading-12">总结</h4>
<ol>
<li>核心目的：用生成器的 <code>yield</code> 暂停特性，把异步 Promise 的“回调式”写法，改成生成器内部的“同步式”写法，消灭回调嵌套；</li>
<li>核心流程：生成器 <code>yield</code> 抛出 Promise → 等 Promise 执行完成 → 调用 <code>next(结果)</code> 把值传回生成器 → 生成器恢复执行，拿到结果；</li>
</ol>
<h2 data-id="heading-13">等一下，怎么看着更复杂了？？</h2>
<p>不知道你发现没有发出疑问，经过转换，怎么比我写个嵌套更复杂了？别着急，我们一步步简化！</p>
<h4 data-id="heading-14">先看问题：手动处理多个 yield 的弊端</h4>
<p>如果 <code>main</code> 里有 3 个 <code>yield</code>（3 次 Ajax 请求），手动处理会写成这样，重复代码特别多：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 手动处理多个 yield 的糟糕写法（仅举例，不要这么写）</span>
<span class="hljs-keyword">const</span> gen = <span class="hljs-title function_">main</span>();
<span class="hljs-comment">// 处理第一个请求</span>
<span class="hljs-keyword">let</span> res1 = gen.<span class="hljs-title function_">next</span>();
res1.<span class="hljs-property">value</span>.<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">data1</span> =&gt;</span> {
  <span class="hljs-comment">// 处理第二个请求</span>
  <span class="hljs-keyword">let</span> res2 = gen.<span class="hljs-title function_">next</span>(data1);
  res2.<span class="hljs-property">value</span>.<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">data2</span> =&gt;</span> {
    <span class="hljs-comment">// 处理第三个请求</span>
    <span class="hljs-keyword">let</span> res3 = gen.<span class="hljs-title function_">next</span>(data2);
    res3.<span class="hljs-property">value</span>.<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">data3</span> =&gt;</span> {
      gen.<span class="hljs-title function_">next</span>(data3); <span class="hljs-comment">// 最后一次 next</span>
    });
  });
});
</code></pre>
<p>这种写法和回调嵌套没区别，完全违背了用生成器简化异步的初衷 —— 而<strong>递归自动执行器</strong>就是解决这个问题的关键。</p>
<h4 data-id="heading-15">核心思路：递归自动执行器</h4>
<p>我们写一个通用的递归函数（比如叫 <code>runGenerator</code>），它会：</p>
<ol>
<li>调用生成器的 <code>next()</code>，拿到返回结果（包含 <code>value</code>（Promise）和 <code>done</code>）；</li>
<li>判断 <code>done</code>：如果是 <code>true</code>，递归终止；</li>
<li>如果是 <code>false</code>，给 <code>value</code>（Promise）加 <code>then</code> 回调；</li>
<li>在 <code>then</code> 里拿到异步结果，再<strong>递归调用自身</strong>，把结果传给 <code>next()</code>，继续处理下一个 <code>yield</code>。</li>
</ol>
<h4 data-id="heading-16">完整代码示例（含递归执行器）</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 1. 模拟 Ajax 请求：返回 Promise</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">requestData</span>(<span class="hljs-params">url</span>) {
  <span class="hljs-keyword">return</span> <span class="hljs-title function_">fetch</span>(url)
    .<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">res</span> =&gt;</span> res.<span class="hljs-title function_">json</span>())
    .<span class="hljs-title function_">catch</span>(<span class="hljs-function"><span class="hljs-params">err</span> =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'请求失败:'</span>, err));
}

<span class="hljs-comment">// 2. 定义有多个 yield 的生成器函数</span>
<span class="hljs-keyword">function</span>* <span class="hljs-title function_">main</span>(<span class="hljs-params"/>) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'开始第一个请求'</span>);
  <span class="hljs-comment">// 第一个 yield：请求 todo/1</span>
  <span class="hljs-keyword">const</span> result1 = <span class="hljs-keyword">yield</span> <span class="hljs-title function_">requestData</span>(<span class="hljs-string">'https://jsonplaceholder.typicode.com/todos/1'</span>);
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'第一个请求结果:'</span>, result1);

  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'开始第二个请求'</span>);
  <span class="hljs-comment">// 第二个 yield：基于第一个结果请求 todo/2</span>
  <span class="hljs-keyword">const</span> result2 = <span class="hljs-keyword">yield</span> <span class="hljs-title function_">requestData</span>(<span class="hljs-string">`https://jsonplaceholder.typicode.com/todos/<span class="hljs-subst">${result1.id + <span class="hljs-number">1</span>}</span>`</span>);
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'第二个请求结果:'</span>, result2);

  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'开始第三个请求'</span>);
  <span class="hljs-comment">// 第三个 yield：基于第二个结果请求 todo/3</span>
  <span class="hljs-keyword">const</span> result3 = <span class="hljs-keyword">yield</span> <span class="hljs-title function_">requestData</span>(<span class="hljs-string">`https://jsonplaceholder.typicode.com/todos/<span class="hljs-subst">${result2.id + <span class="hljs-number">1</span>}</span>`</span>);
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'第三个请求结果:'</span>, result3);

  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'所有请求执行完毕'</span>);
  <span class="hljs-keyword">return</span> <span class="hljs-string">'最终结果'</span>;
}

<span class="hljs-comment">// 3. 核心：递归自动执行器（通用函数，任何生成器都能用）</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">runGenerator</span>(<span class="hljs-params">generator</span>) {
  <span class="hljs-comment">// 定义递归函数</span>
  <span class="hljs-keyword">function</span> <span class="hljs-title function_">next</span>(<span class="hljs-params">data</span>) {
    <span class="hljs-comment">// 调用 next()，拿到当前执行结果（{ value: Promise, done: boolean }）</span>
    <span class="hljs-keyword">const</span> result = generator.<span class="hljs-title function_">next</span>(data);

    <span class="hljs-comment">// 终止条件：如果 done 为 true，递归结束</span>
    <span class="hljs-keyword">if</span> (result.<span class="hljs-property">done</span>) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'生成器执行完毕，最终返回值:'</span>, result.<span class="hljs-property">value</span>);
      <span class="hljs-keyword">return</span>; <span class="hljs-comment">// 终止递归</span>
    }

    <span class="hljs-comment">// 如果 done 为 false，处理当前的 Promise</span>
    result.<span class="hljs-property">value</span>
      .<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">data</span> =&gt;</span> {
        <span class="hljs-comment">// 递归调用 next，把当前 Promise 的结果传给下一个 yield</span>
        <span class="hljs-title function_">next</span>(data);
      })
      .<span class="hljs-title function_">catch</span>(<span class="hljs-function"><span class="hljs-params">err</span> =&gt;</span> {
        <span class="hljs-comment">// 处理异常：也可以调用 generator.throw(err) 抛到生成器内部</span>
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'异步执行出错:'</span>, err);
      });
  }

  <span class="hljs-comment">// 启动第一次递归（第一次 next 不传参，因为第一个 yield 左边没值可接）</span>
  <span class="hljs-title function_">next</span>();
}

<span class="hljs-comment">// 4. 启动执行器，自动处理所有 yield</span>
<span class="hljs-title function_">runGenerator</span>(<span class="hljs-title function_">main</span>());
</code></pre>
<h4 data-id="heading-17">逐行解释递归执行器的逻辑</h4>
<ol>
<li><strong>执行器初始化</strong>：调用 <code>runGenerator(main())</code>，先创建生成器对象，再执行 <code>next()</code>（无参），启动第一次递归。</li>
<li><strong>第一次递归</strong>：
<ul>
<li><code>generator.next()</code> → 执行 <code>main</code> 到第一个 <code>yield</code>，返回 <code>{ value: 第一个请求的 Promise, done: false }</code>；</li>
<li>因为 <code>done: false</code>，给 Promise 加 <code>then</code>；</li>
<li>等第一个请求返回 <code>data1</code>，递归调用 <code>next(data1)</code>。</li>
</ul>
</li>
<li><strong>第二次递归</strong>：
<ul>
<li><code>generator.next(data1)</code> → <code>data1</code> 赋值给 <code>result1</code>，<code>main</code> 执行到第二个 <code>yield</code>，返回 <code>{ value: 第二个请求的 Promise, done: false }</code>；</li>
<li>给第二个 Promise 加 <code>then</code>，拿到 <code>data2</code> 后递归调用 <code>next(data2)</code>。</li>
</ul>
</li>
<li><strong>第三次递归</strong>：
<ul>
<li><code>generator.next(data2)</code> → <code>data2</code> 赋值给 <code>result2</code>，<code>main</code> 执行到第三个 <code>yield</code>，返回 <code>{ value: 第三个请求的 Promise, done: false }</code>；</li>
<li>拿到 <code>data3</code> 后递归调用 <code>next(data3)</code>。</li>
</ul>
</li>
<li><strong>第四次递归</strong>：
<ul>
<li><code>generator.next(data3)</code> → <code>data3</code> 赋值给 <code>result3</code>，<code>main</code> 执行到末尾，返回 <code>{ value: '最终结果', done: true }</code>；</li>
<li>检测到 <code>done: true</code>，递归终止。</li>
</ul>
</li>
</ol>
<h4 data-id="heading-18">为什么递归能解决问题？</h4>
<ul>
<li><strong>自动迭代</strong>：不管 <code>main</code> 里有多少个 <code>yield</code>，递归都会自动处理，不用手动写每一次的 <code>next()</code> 和 <code>then()</code>；</li>
<li><strong>终止条件清晰</strong>：靠 <code>done: true</code> 判断生成器是否执行完，避免无限递归；</li>
<li><strong>代码复用</strong>：<code>runGenerator</code> 是通用函数，任何“yield 出 Promise”的生成器都能直接用，不用改逻辑。</li>
</ul>
<h2 data-id="heading-19"><strong>生成器 + Promise 实现异步同步化</strong> 完整方案</h2>
<h4 data-id="heading-20">再梳理这个“完整执行器”的核心逻辑</h4>
<p>把我们之前的“简化版递归执行器”升级成<strong>工业级的 co 函数</strong>，完整逻辑如下（伪代码梳理）：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 1. 定义通用执行器 co</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">co</span>(<span class="hljs-params">generatorFunc</span>) {
  <span class="hljs-comment">// 创建生成器对象</span>
  <span class="hljs-keyword">const</span> generator = <span class="hljs-title function_">generatorFunc</span>();

  <span class="hljs-comment">// 2. 定义递归处理函数 handlerResult</span>
  <span class="hljs-keyword">function</span> <span class="hljs-title function_">handlerResult</span>(<span class="hljs-params">result</span>) {
    <span class="hljs-comment">// 终止条件：生成器执行完毕</span>
    <span class="hljs-keyword">if</span> (result.<span class="hljs-property">done</span>) {
      <span class="hljs-keyword">return</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">resolve</span>(result.<span class="hljs-property">value</span>); <span class="hljs-comment">// 最终返回 Promise，对齐 async 函数</span>
    }

    <span class="hljs-comment">// 处理 Promise（成功/失败）</span>
    <span class="hljs-keyword">return</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">resolve</span>(result.<span class="hljs-property">value</span>) <span class="hljs-comment">// 确保 value 是 Promise（兼容非 Promise 情况）</span>
      .<span class="hljs-title function_">then</span>(
        <span class="hljs-comment">// 成功回调：把结果传给 next，递归处理下一个 result</span>
        <span class="hljs-function">(<span class="hljs-params">data</span>) =&gt;</span> <span class="hljs-title function_">handlerResult</span>(generator.<span class="hljs-title function_">next</span>(data)),
        <span class="hljs-comment">// 失败回调：调用 throw() 抛异常给生成器内部</span>
        <span class="hljs-function">(<span class="hljs-params">error</span>) =&gt;</span> <span class="hljs-title function_">handlerResult</span>(generator.<span class="hljs-keyword">throw</span>(error))
      );
  }

  <span class="hljs-comment">// 3. 启动递归：传入第一次 next() 的结果</span>
  <span class="hljs-keyword">return</span> <span class="hljs-title function_">handlerResult</span>(generator.<span class="hljs-title function_">next</span>());
}

<span class="hljs-comment">// 4. 生成器内部用 try/catch 捕获异常</span>
<span class="hljs-keyword">function</span>* <span class="hljs-title function_">main</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">try</span> {
    <span class="hljs-keyword">const</span> res1 = <span class="hljs-keyword">yield</span> <span class="hljs-title function_">requestData</span>(<span class="hljs-string">'url1'</span>);
    <span class="hljs-keyword">const</span> res2 = <span class="hljs-keyword">yield</span> <span class="hljs-title function_">requestData</span>(<span class="hljs-string">'url2'</span>);
  } <span class="hljs-keyword">catch</span> (err) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'捕获异常:'</span>, err); <span class="hljs-comment">// 捕获 generator.throw() 抛的异常</span>
  }
}

<span class="hljs-comment">// 5. 调用 co 执行生成器（通用复用）</span>
<span class="hljs-title function_">co</span>(main).<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">finalRes</span> =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'最终结果:'</span>, finalRes));
</code></pre>
<h4 data-id="heading-21">总结</h4>
<p>这些内容，是我们之前讨论的<strong>生成器+Promise 实现异步同步化</strong>的“完整版落地”：</p>
<ol>
<li>核心逻辑完全一致：递归执行器 + 暂停-恢复 + Promise 处理；</li>
<li>补充了关键细节：异常处理（<code>throw()</code> + <code>try/catch</code>）；</li>
</ol>
<h2 data-id="heading-22">好的，该 async/await登场了</h2>
<p>讲了这么多啊都没提到我们的主角，好的他们来了～</p>
<h4 data-id="heading-23">用 async/await 改写你这段手动代码</h4>
<p>你手动处理 2 个请求的代码，换成 <code>async/await</code> 后长这样，<strong>没有任何手动的 next/then</strong>，但底层逻辑完全一致：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 原生成器逻辑 → 等价的 async/await 代码</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">mainAsync</span>(<span class="hljs-params"/>) {
  <span class="hljs-comment">// 对应：第一次 next() + promise.then + generator.next(data)</span>
  <span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> <span class="hljs-title function_">requestData</span>(<span class="hljs-string">'https://jsonplaceholder.typicode.com/todos/1'</span>);
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'生成器内部拿到的请求结果:'</span>, result);

  <span class="hljs-comment">// 对应：secondNextResult = generator.next() + secondNextResult.value.then + generator.next(data2)</span>
  <span class="hljs-keyword">const</span> result2 = <span class="hljs-keyword">await</span> <span class="hljs-title function_">requestData</span>(<span class="hljs-string">`https://jsonplaceholder.typicode.com/todos/<span class="hljs-subst">${result.id + <span class="hljs-number">1</span>}</span>`</span>);
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'第二个请求结果:'</span>, result2);
}

<span class="hljs-comment">// 调用 async 函数（引擎自动执行所有 next/then 逻辑）</span>
<span class="hljs-title function_">mainAsync</span>();
</code></pre>
<h4 data-id="heading-24">关键补充：async/await 不是“新东西”，是语法糖</h4>
<p><code>async/await</code> 并不是 JavaScript 新增的底层特性，它就是<strong>生成器 + 自动执行器</strong>的“语法糖”—— 本质上：</p>
<ol>
<li><code>async</code> 函数 = 生成器函数 + 内置自动执行器；</li>
<li><code>await</code> 关键字 = <code>yield</code> 关键字的“语义化包装”（更易读，不用写 <code>yield</code>）；</li>
<li>你手动写的递归执行器 → JS 引擎内置的、更高效的自动执行逻辑。</li>
</ol>
<h4 data-id="heading-25">举个更直观的例子：引擎如何处理 await</h4>
<p>当你写：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">fn</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> a = <span class="hljs-keyword">await</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">resolve</span>(<span class="hljs-number">1</span>);
  <span class="hljs-keyword">const</span> b = <span class="hljs-keyword">await</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">resolve</span>(a + <span class="hljs-number">1</span>);
  <span class="hljs-keyword">return</span> b;
}
<span class="hljs-title function_">fn</span>().<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">res</span> =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(res)); <span class="hljs-comment">// 输出 2</span>
</code></pre>
<p>JS 引擎在底层会做这些事（对应你的手动代码）：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 引擎模拟的底层逻辑（伪代码）</span>
<span class="hljs-keyword">function</span>* <span class="hljs-title function_">fnGenerator</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> a = <span class="hljs-keyword">yield</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">resolve</span>(<span class="hljs-number">1</span>);
  <span class="hljs-keyword">const</span> b = <span class="hljs-keyword">yield</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">resolve</span>(a + <span class="hljs-number">1</span>);
  <span class="hljs-keyword">return</span> b;
}

<span class="hljs-comment">// 引擎内置的自动执行器（类似你写的递归函数）</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">autoRun</span>(<span class="hljs-params">generator</span>) {
  <span class="hljs-keyword">const</span> gen = <span class="hljs-title function_">generator</span>();
  <span class="hljs-keyword">function</span> <span class="hljs-title function_">next</span>(<span class="hljs-params">data</span>) {
    <span class="hljs-keyword">const</span> { value, done } = gen.<span class="hljs-title function_">next</span>(data);
    <span class="hljs-keyword">if</span> (done) <span class="hljs-keyword">return</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">resolve</span>(value);
    <span class="hljs-keyword">return</span> value.<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">res</span> =&gt;</span> <span class="hljs-title function_">next</span>(res));
  }
  <span class="hljs-keyword">return</span> <span class="hljs-title function_">next</span>();
}

<span class="hljs-comment">// 引擎自动调用</span>
<span class="hljs-title function_">autoRun</span>(fnGenerator).<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">res</span> =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(res)); <span class="hljs-comment">// 输出 2</span>
</code></pre>
<h4 data-id="heading-26">总结</h4>
<ol>
<li>你手动写的 <code>next()</code>、<code>then()</code>、传参、处理下一个 <code>yield</code> 这些操作，<strong>全部由 <code>async/await</code> 自动完成</strong>，不用你写一行；</li>
<li><code>async/await</code> 是生成器+自动执行器的语法糖，核心逻辑和你手动封装的递归执行器完全一致；</li>
<li>区别仅在于：引擎的内置执行器更高效、更健壮（处理了异常、中断等边界情况），而你手动写的是简化版。</li>
</ol>
<p>简单说：<code>async/await</code> 就是把你手动做的“脏活累活”（调 next、等 Promise、传结果）全部自动化了，让你只需要写“看起来像同步”的代码就行。</p>
<h2 data-id="heading-27"><code>async/await</code>用了哪些设计模式呢？</h2>
<p><code>async/await</code> 并不是单一的设计模式，而是<strong>组合了多个经典模式</strong>的“语法糖封装”，核心是这3个：</p>





















<table><thead><tr><th>设计模式</th><th>对应 async/await 的角色</th></tr></thead><tbody><tr><td><strong>迭代器模式（Iterator）</strong></td><td>生成器（Generator）本身就是迭代器的一种实现，<code>next()</code> 方法就是迭代器的核心（一步步“迭代”执行异步任务）；</td></tr><tr><td><strong>观察者模式（Observer）</strong></td><td>Promise 是典型的观察者模式（<code>then/catch</code> 监听 Promise 状态变化），<code>await</code> 本质是“监听 Promise 完成后通知生成器继续执行”；</td></tr><tr><td><strong>模板方法模式（Template Method）</strong></td><td>JS 引擎内置的“自动执行器”就是模板方法：把“调用 next → 等 Promise → 传参 → 递归”的固定逻辑封装成模板，<code>async/await</code> 使用者只需要写业务逻辑（await 后面的异步任务），不用关心执行流程；</td></tr></tbody></table>
<p>关于设计模式，我应该会拉出一个主题好好研究</p>
<h2 data-id="heading-28">现在你有没有理解我说的“里应外合“</h2>
<h4 data-id="heading-29">先明确“里”和“外”的角色</h4>




















<table><thead><tr><th>角色</th><th>对应代码/逻辑</th><th>核心动作</th></tr></thead><tbody><tr><td><strong>里（生成器内部）</strong></td><td><code>async</code> 函数里的 <code>await 异步任务</code></td><td>1. 抛出 Promise 给“外”；2. 暂停等待；3. 接收“外”传回来的值继续执行</td></tr><tr><td><strong>外（JS引擎/执行器）</strong></td><td>引擎内置的自动执行器</td><td>1. 接住“里”抛出来的 Promise；2. 等待 Promise 执行完成；3. 把结果传回“里”，触发继续执行</td></tr></tbody></table>
<h4 data-id="heading-30">用“里应外合”拆解完整执行流程（一步一步对应）</h4>
<p>我们用 <code>await requestData()</code> 为例，还原这个互动过程：</p>
<h5 data-id="heading-31">第一步：“里”先出招 —— 抛出 Promise，原地待命</h5>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">fn</span>(<span class="hljs-params"/>) {
  <span class="hljs-comment">// 「里」的动作：</span>
  <span class="hljs-comment">// 1. 执行 await requestData()，先调用 requestData 得到 Promise；</span>
  <span class="hljs-comment">// 2. 把这个 Promise “扔”给外面的引擎；</span>
  <span class="hljs-comment">// 3. 自己暂停执行（就像士兵原地待命，等外面的消息）；</span>
  <span class="hljs-keyword">const</span> res = <span class="hljs-keyword">await</span> <span class="hljs-title function_">requestData</span>(<span class="hljs-string">'url'</span>); 
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(res); <span class="hljs-comment">// 暂停后，这行暂时不执行</span>
}
</code></pre>
<p>👉 对应“里应外合”：<strong>里先“应”—— 抛出异步任务（Promise），告诉外面“我要等这个做完”</strong>。</p>
<h5 data-id="heading-32">第二步：“外”接招 —— 处理 Promise，等结果</h5>
<p>JS 引擎（外面的执行器）接住这个 Promise 后，不会闲着：</p>
<ol>
<li>监听 Promise 的状态变化（成功/失败）；</li>
<li>等待异步任务完成（比如接口请求返回数据）；</li>
<li>拿到结果（比如接口返回的 data）。</li>
</ol>
<p>👉 对应“里应外合”：<strong>外“合”—— 响应里面的请求，处理异步任务，拿到结果</strong>。</p>
<h5 data-id="heading-33">第三步：“外”回传结果 —— 给“里”赋值，触发继续执行</h5>
<p>引擎拿到 data 后，会做两件关键事：</p>
<ol>
<li>把 data 赋值给 <code>await</code> 左边的变量 <code>res</code>（相当于 <code>res = data</code>）；</li>
<li>告诉“里”：“结果拿到了，你继续往下走！” —— 生成器从暂停的位置恢复执行。</li>
</ol>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">fn</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> res = <span class="hljs-keyword">await</span> <span class="hljs-title function_">requestData</span>(<span class="hljs-string">'url'</span>); 
  <span class="hljs-comment">// 「里」的动作：</span>
  <span class="hljs-comment">// 接收到外面传的 data，赋值给 res，然后执行这行</span>
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(res); 
}
</code></pre>
<p>👉 对应“里应外合”：<strong>外把结果“合”进里面，里收到后继续执行，完成一次互动</strong>。</p>
<h5 data-id="heading-34">第四步：多轮“里应外合”（多个 await）</h5>
<p>如果有多个 <code>await</code>，就是重复上面的过程：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">fn</span>(<span class="hljs-params"/>) {
  <span class="hljs-comment">// 第一轮里应外合：</span>
  <span class="hljs-keyword">const</span> res1 = <span class="hljs-keyword">await</span> <span class="hljs-title function_">requestData</span>(<span class="hljs-string">'url1'</span>); 
  <span class="hljs-comment">// 第二轮里应外合：</span>
  <span class="hljs-keyword">const</span> res2 = <span class="hljs-keyword">await</span> <span class="hljs-title function_">requestData</span>(<span class="hljs-string">`url2?<span class="hljs-subst">${res1.id}</span>`</span>); 
}
</code></pre>
<p>👉 里抛第一个 Promise → 外处理 → 回传 res1 → 里再抛第二个 Promise → 外处理 → 回传 res2 → 直到执行完。</p>
<h4 data-id="heading-35">补充：异常场景的“里应外合”（更完整）</h4>
<p>如果 Promise 失败（比如接口报错），互动逻辑变成：</p>
<ol>
<li>里：抛出失败的 Promise；</li>
<li>外：接住失败的 Promise，拿到错误信息；</li>
<li>外：把错误“扔回”里（对应 <code>generator.throw()</code>）；</li>
<li>里：如果有 <code>try/catch</code>，就捕获这个错误，完成“合”。</li>
</ol>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">fn</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">try</span> {
    <span class="hljs-keyword">const</span> res = <span class="hljs-keyword">await</span> <span class="hljs-title function_">requestData</span>(<span class="hljs-string">'error-url'</span>); <span class="hljs-comment">// 里抛出失败的 Promise</span>
  } <span class="hljs-keyword">catch</span> (err) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(err); <span class="hljs-comment">// 外把错误传回来，里捕获处理</span>
  }
}
</code></pre>
<h4 data-id="heading-36">记忆强化：用“里应外合”总结核心</h4>
<ol>
<li><strong>里的核心</strong>：抛 Promise 等结果，接结果继续走（“应”—— 响应异步需求，等外部反馈）；</li>
<li><strong>外的核心</strong>：接 Promise 处理完，传结果促执行（“合”—— 配合内部需求，反馈处理结果）；</li>
<li><code>async/await</code> 就是把这个“里应外合”的过程，从“手动写执行器”变成“引擎自动做”，<code>你只需要写“里”的逻辑就行。</code></li>
</ol>
<p>这个比喻完全抓住了本质 —— 生成器（里）和执行器（外）的互动，就是靠“抛 Promise-处理 Promise-传结果”完成的“里应外合”，记住这个比喻，就能记住 <code>async/await</code> 的底层执行逻辑了。</p>
<h2 data-id="heading-37">这下明白了 async/await 很多用法的底层逻辑</h2>
<h4 data-id="heading-38">一、为什么必须有 <code>async</code>？—— 标记“异步执行器容器”</h4>
<h5 data-id="heading-39">核心原因：</h5>
<p><code>async</code> 是给函数打一个“标记”，告诉 JS 引擎：<strong>这个函数内部有 <code>await</code>，需要按“生成器+自动执行器”的逻辑来处理</strong>，而不是普通函数的“一次性执行完”。</p>
<h5 data-id="heading-40">对应底层逻辑（里应外合）：</h5>
<ul>
<li>没有 <code>async</code> 的普通函数：调用后会“一口气执行完所有代码”，无法暂停；</li>
<li>加了 <code>async</code> 的函数：JS 引擎会把它当成「生成器+自动执行器」的封装体——调用 <code>async</code> 函数时，引擎先创建“生成器式”的执行上下文，为后续 <code>await</code> 的“暂停-恢复”铺路。</li>
</ul>
<h5 data-id="heading-41">记忆例子：</h5>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 错误：没有 async，用 await 会直接报错</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">fn</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> res = <span class="hljs-keyword">await</span> <span class="hljs-title function_">requestData</span>(); <span class="hljs-comment">// Uncaught SyntaxError: await is only valid in async functions</span>
}

<span class="hljs-comment">// 正确：async 标记函数是“异步执行容器”</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">fn</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> res = <span class="hljs-keyword">await</span> <span class="hljs-title function_">requestData</span>(); 
}
</code></pre>
<h4 data-id="heading-42">二、为什么要用 <code>try/catch</code>？—— 统一捕获“里应外合”的异常</h4>
<h5 data-id="heading-43">核心原因：</h5>
<p><code>await</code> 后面的 Promise 一旦失败（rejected），底层会触发 <code>generator.throw()</code> 向函数内部抛异常——如果不捕获，这个异常会变成“未捕获异常”导致程序崩溃；而 <code>try/catch</code> 是同步代码的错误处理方式，<code>async/await</code> 把异步错误“伪装”成同步错误，自然用 <code>try/catch</code> 捕获最贴合直觉。</p>
<h5 data-id="heading-44">对应底层逻辑（里应外合）：</h5>
<ul>
<li>外（引擎）：发现 Promise 失败 → 调用 <code>generator.throw(错误)</code> 把异常抛回“里”；</li>
<li>里（async 函数）：如果没有 <code>try/catch</code>，异常会从“里”逃出，变成全局未捕获异常；有 <code>try/catch</code> 则能在内部接住，和同步代码的错误处理完全一致。</li>
</ul>
<h5 data-id="heading-45">记忆例子：</h5>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">fn</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">try</span> {
    <span class="hljs-comment">// await 后面的 Promise 失败 → 引擎抛异常到这里</span>
    <span class="hljs-keyword">const</span> res = <span class="hljs-keyword">await</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">reject</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">'请求失败'</span>));
  } <span class="hljs-keyword">catch</span> (err) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'捕获错误:'</span>, err.<span class="hljs-property">message</span>); <span class="hljs-comment">// 输出：请求失败</span>
  }
}
</code></pre>
<h4 data-id="heading-46">三、为什么说“await 后面的代码相当于 promise.then()”？—— 都是“等待完成后执行”</h4>
<h5 data-id="heading-47">核心原因：</h5>
<p><code>await</code> 会暂停函数执行，等后面的 Promise 完成后，才执行 <code>await</code> 下面的代码——这和 <code>promise.then(回调)</code> 里“回调函数等 Promise 完成后执行”的逻辑完全一致，只是 <code>await</code> 把回调里的代码“扁平化”了。</p>
<h5 data-id="heading-48">对应底层逻辑（里应外合）：</h5>
<ul>
<li>Promise.then 写法：回调函数是“外”通知“里”执行的逻辑（观察者模式）；</li>
<li>await 写法：<code>await</code> 下面的代码，就是引擎自动帮你放到 <code>then</code> 回调里的逻辑，只是不用写回调嵌套。</li>
</ul>
<h5 data-id="heading-49">记忆对比：</h5>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// Promise.then 写法（回调嵌套）</span>
<span class="hljs-title function_">requestData</span>().<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">res</span> =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(res); <span class="hljs-comment">// 这行在 then 回调里，等 Promise 完成后执行</span>
});

<span class="hljs-comment">// async/await 写法（扁平化）</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">fn</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> res = <span class="hljs-keyword">await</span> <span class="hljs-title function_">requestData</span>();
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(res); <span class="hljs-comment">// 这行等价于上面 then 里的代码，等 Promise 完成后执行</span>
}
</code></pre>
<h4 data-id="heading-50">四、为什么说“async 函数返回的是 Promise”？—— 对齐异步生态，兼容执行器逻辑</h4>
<h5 data-id="heading-51">核心原因：</h5>
<ol>
<li>底层逻辑：<code>async</code> 函数的自动执行器最终要返回一个“结果容器”，而 Promise 是 JS 里唯一的“异步结果容器”——不管函数内部有没有 <code>await</code>，引擎都会把返回值包装成 Promise；</li>
<li>生态兼容：Promise 是 JS 异步的“通用语言”，返回 Promise 能让 <code>async</code> 函数和现有异步逻辑（<code>.then</code>/<code>.catch</code>、Promise.all 等）无缝衔接。</li>
</ol>
<h5 data-id="heading-52">记忆例子：</h5>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 1. 显式返回普通值 → 自动包装成 Promise</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">fn1</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">return</span> <span class="hljs-number">123</span>; <span class="hljs-comment">// 等价于 return Promise.resolve(123)</span>
}
<span class="hljs-title function_">fn1</span>().<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">res</span> =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(res)); <span class="hljs-comment">// 输出 123</span>

<span class="hljs-comment">// 2. 没有 return → 返回 Promise.resolve(undefined)</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">fn2</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">await</span> <span class="hljs-title function_">requestData</span>();
}
<span class="hljs-title function_">fn2</span>().<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">res</span> =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(res)); <span class="hljs-comment">// 输出 undefined</span>

<span class="hljs-comment">// 3. 抛出异常 → 返回 Promise.reject(错误)</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">fn3</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">'出错了'</span>);
}
<span class="hljs-title function_">fn3</span>().<span class="hljs-title function_">catch</span>(<span class="hljs-function"><span class="hljs-params">err</span> =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(err.<span class="hljs-property">message</span>)); <span class="hljs-comment">// 输出 出错了</span>
</code></pre>
<h4 data-id="heading-53">五、补充：我经常混淆的点——“await 不是返回 Promise，是等待 Promise 并取其结果”</h4>
<ul>
<li>❌ 错误：await 返回 Promise；</li>
<li>✅ 正确：<code>await</code> <strong>等待</strong> 后面的 Promise 完成，然后<strong>取出 Promise 的最终结果</strong>（成功值/失败抛异常）。</li>
</ul>
<h5 data-id="heading-54">例子验证：</h5>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">fn</span>(<span class="hljs-params"/>) {
  <span class="hljs-comment">// requestData() 返回 Promise，await 等待它完成，取出结果赋值给 res</span>
  <span class="hljs-keyword">const</span> res = <span class="hljs-keyword">await</span> <span class="hljs-title function_">requestData</span>(); 
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(res); <span class="hljs-comment">// res 是 Promise 的成功值（比如接口返回的 data），不是 Promise</span>
}
</code></pre>
<p>对应到底层执行器的逻辑：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 对应的生成器函数</span>
<span class="hljs-keyword">function</span>* <span class="hljs-title function_">genFn</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> res = <span class="hljs-keyword">yield</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">resolve</span>(<span class="hljs-number">1</span>); <span class="hljs-comment">// await 的底层：yield 抛 Promise，等结果</span>
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(res); <span class="hljs-comment">// res = 1（next 传进来的）</span>
  <span class="hljs-keyword">return</span> <span class="hljs-number">3</span>; <span class="hljs-comment">// 生成器最终的 value = 3</span>
}

<span class="hljs-comment">// 执行器处理</span>
<span class="hljs-title function_">autoRun</span>(genFn).<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">val</span> =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(val)); <span class="hljs-comment">// 输出 3</span>
<span class="hljs-comment">// autoRun 里的逻辑：</span>
<span class="hljs-comment">// - 第一次 next()：yield 出 Promise.resolve(1)，等待完成后 next(1)</span>
<span class="hljs-comment">// - 第二次 next(1)：res = 1，执行到 return 3，done = true</span>
<span class="hljs-comment">// - 触发 if (done)，返回 Promise.resolve(3) → 这就是 async 函数的返回值</span>
</code></pre>
<p><code>记忆口诀：</code>await<code> 取 Promise 的“值”，</code>async<code> 包返回值成“Promise”——前者是“拆包”，后者是“打包”。</code></p>
<h4 data-id="heading-55">总结（核心记忆点）</h4>
<p>把这些“为什么”浓缩成4句话，记下来就彻底懂了：</p>
<ol>
<li><code>async</code> 是“容器标记”：告诉引擎这个函数要按“生成器+自动执行器”逻辑跑；</li>
<li><code>try/catch</code> 是“异常兜底”：接住引擎从外部抛回的 Promise 失败异常；</li>
<li><code>await</code> 下面的代码 = <code>then</code> 回调：都是等 Promise 完成后执行，只是写法更平；</li>
<li><code>async</code> 函数返回 Promise：对齐异步生态，让结果能被 <code>.then</code>/<code>.catch</code> 处理。</li>
</ol>
<p>本质上，<code>async/await</code> 所有的“规则”（必须加 async、用 try/catch 等），都是为了让“生成器+自动执行器”的底层逻辑，能以“同步代码”的形式呈现——这也是它最巧妙的地方。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[从零构建本地AI应用：React与Ollama全栈开发实战]]></title>    <link>https://juejin.cn/post/7595890117865504814</link>    <guid>https://juejin.cn/post/7595890117865504814</guid>    <pubDate>2026-01-17T09:39:34.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7595890117865504814" data-draft-id="7595886887522975784" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="从零构建本地AI应用：React与Ollama全栈开发实战"/> <meta itemprop="keywords" content="Ollama,全栈,VibeCoding"/> <meta itemprop="datePublished" content="2026-01-17T09:39:34.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="秃头敲码小姐姐"/> <meta itemprop="url" content="https://juejin.cn/user/24668014656249"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            从零构建本地AI应用：React与Ollama全栈开发实战
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/24668014656249/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    秃头敲码小姐姐
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-17T09:39:34.000Z" title="Sat Jan 17 2026 09:39:34 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-17
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    10
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h3 data-id="heading-0">博客开篇：为什么选择本地大模型开发？</h3>
<p>在当前的AI浪潮中，OpenAI等云端API虽然强大，但存在数据隐私、Token成本和网络延迟的问题。<strong>Ollama</strong> 的出现，让开发者可以在本地轻松部署开源大模型（如Qwen、Llama 3等）。结合前端框架（如React），我们可以构建完全私有、低成本的AI应用。</p>
<p>本博客将带你从环境搭建到代码实现，一步步构建一个基于 React 和 Ollama 的聊天应用，并深入剖析其中的技术细节。</p>
<hr/>
<h3 data-id="heading-1">第一部分：环境与基础架构</h3>
<h4 data-id="heading-2">1.1 Ollama 核心原理</h4>
<p>Ollama 是一个在本地运行大型语言模型的工具。它通过一个简单的命令行接口，让开发者可以拉取（Pull）、运行（Run）和管理模型。</p>
<ul>
<li>
<p><strong>核心命令：</strong></p>
<ul>
<li><code>ollama pull qwen2.5:0.5b</code>：拉取特定版本的千问模型。</li>
<li><code>ollama run qwen2.5:0.5b</code>：启动模型。</li>
<li><strong>端口服务：</strong> Ollama 默认在 <code>11434</code> 端口提供服务，且提供了兼容 OpenAI 格式的 <code>/v1/chat/completions</code> 接口。</li>
</ul>
</li>
</ul>
<h4 data-id="heading-3">1.2 项目初始化</h4>
<p>我们需要一个 React 项目来作为前端界面。使用 Vite 或 Create React App 初始化项目，并安装必要的依赖（如 <code>axios</code> 用于 HTTP 请求）。</p>
<hr/>
<h3 data-id="heading-4">第二部分：后端通信层（API 模块）</h3>
<p>这是应用的“神经系统”，负责前端与本地大模型的对话。</p>
<h4 data-id="heading-5">2.1 代码逻辑解析</h4>
<p>在提供的代码中，<code>ollamaApi.js</code> 文件负责创建与 Ollama 服务的连接。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> axios <span class="hljs-keyword">from</span> <span class="hljs-string">'axios'</span>;

<span class="hljs-comment">// 创建 axios 实例</span>
<span class="hljs-keyword">const</span> ollamaApi = axios.<span class="hljs-title function_">create</span>({
  <span class="hljs-attr">baseURL</span>: <span class="hljs-string">'http://localhost:11434/v1'</span>, <span class="hljs-comment">// 指向本地 Ollama 服务</span>
  <span class="hljs-attr">headers</span>: {
    <span class="hljs-string">'Authorization'</span>: <span class="hljs-string">'Bearer ollama'</span>, <span class="hljs-comment">// 注意：Ollama 的固定 Token</span>
    <span class="hljs-string">'Content-Type'</span>: <span class="hljs-string">'application/json'</span>,
  }
});

<span class="hljs-comment">// 封装聊天请求函数</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">chatCompletions</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params">messages</span>) =&gt; {
  <span class="hljs-keyword">try</span> {
    <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> ollamaApi.<span class="hljs-title function_">post</span>(<span class="hljs-string">'/chat/completions'</span>, {
      <span class="hljs-attr">model</span>: <span class="hljs-string">'qwen2.5:0.5b'</span>, <span class="hljs-comment">// 指定模型名称</span>
      messages, <span class="hljs-comment">// 对话历史</span>
      <span class="hljs-attr">stream</span>: <span class="hljs-literal">false</span>, <span class="hljs-comment">// 关闭流式输出（简化处理）</span>
      <span class="hljs-attr">temperature</span>: <span class="hljs-number">0.7</span>, <span class="hljs-comment">// 控制生成文本的随机性</span>
    });
    <span class="hljs-keyword">return</span> response.<span class="hljs-property">data</span>.<span class="hljs-property">choices</span>.<span class="hljs-property">message</span>.<span class="hljs-property">content</span>;
  } <span class="hljs-keyword">catch</span>(err) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'ollama 请求失败'</span>);
  }
}
</code></pre>
<h4 data-id="heading-6">2.2 技术点详解</h4>
<ol>
<li>
<p><strong>Axios 封装：</strong> 使用 <code>axios.create</code> 创建实例，统一管理 <code>baseURL</code> 和 <code>headers</code>，避免在每个请求中重复配置。</p>
</li>
<li>
<p><strong>兼容性接口：</strong> Ollama 采用了 OpenAI 的 API 规范，这意味着如果你的后端换成 OpenAI，前端代码几乎不需要修改。</p>
</li>
<li>
<p><strong>请求参数：</strong></p>
<ul>
<li><code>messages</code>: 这是一个数组，包含 <code>role</code> (system/user/assistant) 和 <code>content</code>。<strong>注意：</strong> 必须传入完整的对话历史，模型才能理解上下文。</li>
<li><code>temperature</code>: 值越低越确定，越高越有创造性。</li>
</ul>
</li>
</ol>
<h4 data-id="heading-7">🧠 答疑解惑：易错点与排查</h4>
<ul>
<li>
<p><strong>问题：跨域错误 (CORS) 或 网络连接失败</strong></p>
<ul>
<li>
<p><strong>原因：</strong> 前端运行在 <code>localhost:3000</code>，而 Ollama 服务运行在 <code>localhost:11434</code>。虽然同源策略通常允许不同端口，但如果 Ollama 服务未启动，会报 <code>ECONNREFUSED</code>。</p>
</li>
<li>
<p><strong>解决方案：</strong></p>
<ol>
<li>确保 Ollama 服务已启动（终端运行 <code>ollama serve</code> 或直接运行模型）。</li>
<li>检查防火墙设置。</li>
<li>在开发环境中，如果遇到严格的 CORS 限制，可以考虑使用 Vite 的代理配置（Proxy）。</li>
</ol>
</li>
</ul>
</li>
<li>
<p><strong>问题：401 Unauthorized 错误</strong></p>
<ul>
<li><strong>原因：</strong> 虽然 Ollama 本地部署通常不需要复杂的鉴权，但根据代码规范，它要求 Header 中必须包含 <code>Authorization: Bearer ollama</code>。</li>
<li><strong>解决方案：</strong> 确保在请求头中正确设置了该字段。</li>
</ul>
</li>
<li>
<p><strong>问题：模型未找到 (Model not found)</strong></p>
<ul>
<li><strong>原因：</strong> 代码中写死了 <code>qwen2.5:0.5b</code>，但本地未下载该模型。</li>
<li><strong>解决方案：</strong> 运行 <code>ollama pull qwen2.5:0.5b</code>，或者修改代码中的 <code>model</code> 字段为你本地已有的模型（如 <code>llama3</code>）。</li>
</ul>
</li>
</ul>
<h4 data-id="heading-8">💼 面试模拟：API 层设计</h4>
<p><strong>面试官：</strong> “在封装 API 时，为什么要使用 Axios 实例而不是直接使用 <code>axios.post</code>？”<br/>
<strong>候选人：</strong></p>
<ol>
<li><strong>统一管理：</strong> 如果 baseURL 变更（例如从开发环境切换到生产环境），只需修改实例配置，无需修改每个请求。</li>
<li><strong>拦截器：</strong> 实例可以添加请求拦截器（自动加 Token）和响应拦截器（统一错误处理）。</li>
<li><strong>复用性：</strong> 可以创建多个实例对应不同的后端服务。</li>
</ol>
<hr/>
<h3 data-id="heading-9">第三部分：前端状态管理（Hooks 模块）</h3>
<h4 data-id="heading-10">3.1 代码逻辑解析</h4>
<p><code>useLLM.js</code> 文件是一个自定义 Hook，用于管理聊天应用的状态。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { useState } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;
<span class="hljs-keyword">import</span> { chatCompletions } <span class="hljs-keyword">from</span> <span class="hljs-string">'../api/ollamaApi.js'</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">useLLM</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-keyword">const</span> [messages, setMessages] = <span class="hljs-title function_">useState</span>([
    { <span class="hljs-attr">role</span>: <span class="hljs-string">'user'</span>, <span class="hljs-attr">content</span>: <span class="hljs-string">'你好'</span> },
    { <span class="hljs-attr">role</span>: <span class="hljs-string">'assistant'</span>, <span class="hljs-attr">content</span>: <span class="hljs-string">'你好，我是qwen2.5 0.5b 模型'</span> }
  ]);
  <span class="hljs-keyword">const</span> [loading, setLoading] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">false</span>);
  <span class="hljs-keyword">const</span> [error, setError] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">null</span>);

  <span class="hljs-comment">// 发送消息逻辑</span>
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">sendMessage</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params">userMessage</span>) =&gt; {
    <span class="hljs-comment">// 1. 更新UI：添加用户消息</span>
    <span class="hljs-keyword">const</span> newMessages = [...messages, { <span class="hljs-attr">role</span>: <span class="hljs-string">'user'</span>, <span class="hljs-attr">content</span>: userMessage }];
    <span class="hljs-title function_">setMessages</span>(newMessages);
    <span class="hljs-title function_">setLoading</span>(<span class="hljs-literal">true</span>);
    <span class="hljs-title function_">setError</span>(<span class="hljs-literal">null</span>);

    <span class="hljs-keyword">try</span> {
      <span class="hljs-comment">// 2. 调用API</span>
      <span class="hljs-keyword">const</span> botResponse = <span class="hljs-keyword">await</span> <span class="hljs-title function_">chatCompletions</span>(newMessages);
      <span class="hljs-comment">// 3. 更新UI：添加机器人回复</span>
      <span class="hljs-title function_">setMessages</span>(<span class="hljs-function"><span class="hljs-params">prev</span> =&gt;</span> [...prev, { <span class="hljs-attr">role</span>: <span class="hljs-string">'assistant'</span>, <span class="hljs-attr">content</span>: botResponse }]);
    } <span class="hljs-keyword">catch</span> (err) {
      <span class="hljs-title function_">setError</span>(<span class="hljs-string">'请求失败，请重试'</span>);
    } <span class="hljs-keyword">finally</span> {
      <span class="hljs-title function_">setLoading</span>(<span class="hljs-literal">false</span>);
    }
  };

  <span class="hljs-keyword">const</span> <span class="hljs-title function_">resetChat</span> = (<span class="hljs-params"/>) =&gt; {
    <span class="hljs-title function_">setMessages</span>([]);
  };

  <span class="hljs-keyword">return</span> { messages, loading, error, sendMessage, resetChat };
};
</code></pre>
<h4 data-id="heading-11">3.2 技术点详解</h4>
<ol>
<li><strong>状态设计：</strong> 使用 <code>messages</code> 数组存储对话历史，<code>loading</code> 控制按钮状态，<code>error</code> 处理异常。</li>
<li><strong>闭包与异步：</strong> 在 <code>sendMessage</code> 中，我们使用了函数式更新 <code>setMessages(prev =&gt; [...prev, ...])</code> 来确保获取到最新的状态，避免闭包陷阱。</li>
<li><strong>错误边界：</strong> 使用 <code>try-catch</code> 捕获 API 异常，并通过 <code>setError</code> 反馈给 UI。</li>
</ol>
<h4 data-id="heading-12">🧠 答疑解惑：易错点与排查</h4>
<ul>
<li>
<p><strong>问题：机器人回复总是“上一轮”的内容</strong></p>
<ul>
<li>
<p><strong>原因：</strong> 这是一个经典的 <strong>State 闭包问题</strong>。如果你在调用 API 前没有正确更新 <code>messages</code>，或者在调用 API 时传入的是旧的 <code>messages</code> 快照。</p>
</li>
<li>
<p><strong>解决方案：</strong></p>
<ul>
<li><strong>方案 A：</strong> 如上面的代码所示，先构造新的消息数组 <code>newMessages</code>，传给 API，成功后再更新 State。</li>
<li><strong>方案 B：</strong> 使用 <code>useRef</code> 保存最新的消息列表，或者在 <code>setMessages</code> 的回调中处理后续逻辑（虽然 React 18 严格模式下可能执行两次渲染，但逻辑上应保证幂等性）。</li>
</ul>
</li>
</ul>
</li>
<li>
<p><strong>问题：输入框无法输入或按钮一直禁用</strong></p>
<ul>
<li><strong>原因：</strong> 逻辑错误导致 <code>loading</code> 状态未重置。</li>
<li><strong>解决方案：</strong> 确保 <code>try-catch-finally</code> 结构完整。无论成功或失败，<code>finally</code> 块中必须将 <code>loading</code> 设为 <code>false</code>。</li>
</ul>
</li>
</ul>
<h4 data-id="heading-13">💼 面试模拟：React Hooks</h4>
<p><strong>面试官：</strong> “在 <code>sendMessage</code> 函数中，为什么在 <code>setMessages</code> 之后立即调用 API，传入的 <code>messages</code> 可能不是最新的？如何解决？”<br/>
<strong>候选人：</strong><br/>
React 的 <code>setState</code> 是异步的。在 <code>setMessages</code> 调用后，<code>messages</code> 变量的值在当前函数作用域内并没有立即改变。如果直接传 <code>messages</code> 给 API，会丢失刚刚添加的用户消息。<br/>
<strong>解决方法：</strong></p>
<ol>
<li><strong>预计算：</strong> 像代码中那样，先用 <code>const newMessages = [...messages, userMsg]</code> 计算出新数组，传给 API，然后 <code>setMessages(newMessages)</code>。</li>
<li><strong>函数式更新：</strong> 如果逻辑复杂，可以使用 <code>useRef</code> 来维护一个可变的引用。</li>
</ol>
<hr/>
<h3 data-id="heading-14">第四部分：视图层（UI 组件）</h3>
<h4 data-id="heading-15">4.1 代码逻辑解析</h4>
<p><code>App.jsx</code> 是应用的主组件，负责展示和用户交互。</p>
<pre><code class="hljs language-ini" lang="ini">import { useEffect, useState } from 'react'<span class="hljs-comment">;</span>
import { useLLM } from './hooks/useLLM.js'<span class="hljs-comment">;</span>

export default function App() {
  const <span class="hljs-section">[inputValue, setInputValue]</span> = useState('')<span class="hljs-comment">;</span>
  const { messages, loading, sendMessage } = useLLM()<span class="hljs-comment">; // 使用自定义 Hook</span>

  const <span class="hljs-attr">handleSend</span> = (e) =&gt; {
    e.preventDefault()<span class="hljs-comment">;</span>
    if (!inputValue.trim()) return<span class="hljs-comment">;</span>
    sendMessage(inputValue)<span class="hljs-comment">; // 调用 Hook 中的逻辑</span>
    setInputValue('')<span class="hljs-comment">; // 清空输入框</span>
  }<span class="hljs-comment">;</span>

  // 页面挂载时的初始化逻辑（可选）
  useEffect(() =&gt; {
    // 例如：加载历史记录
  }, <span class="hljs-section">[]</span>)<span class="hljs-comment">;</span>

  return (
    &lt;div <span class="hljs-attr">className</span>=<span class="hljs-string">"min-h-screen bg-gray-50 flex flex-col items-center py-6 px-4"</span>&gt;
      &lt;div <span class="hljs-attr">className</span>=<span class="hljs-string">"w-full max-w-[800px] bg-white rounded-lg shadow-md flex flex-col h-[90vh] max-h-[800px]"</span>&gt;
        {/* 聊天内容区域 */}
        &lt;div <span class="hljs-attr">className</span>=<span class="hljs-string">"flex-1 p-4 overflow-y-auto"</span>&gt;
          {messages.map((msg, idx) =&gt; (
            &lt;div <span class="hljs-attr">key</span>={idx} className={`mb-<span class="hljs-number">4</span> p-<span class="hljs-number">3</span> rounded-lg max-w-xs <span class="hljs-variable">${msg.role === 'user' ? 'bg-blue-100 ml-auto' : 'bg-gray-100'}</span>`}&gt;
              {msg.content}
            &lt;/div&gt;
          ))}
        &lt;/div&gt;
      &lt;/div&gt;
      
      &lt;form <span class="hljs-attr">className</span>=<span class="hljs-string">"p-4 border-t"</span> <span class="hljs-literal">on</span>Submit={handleSend}&gt;
        &lt;div <span class="hljs-attr">className</span>=<span class="hljs-string">"flex gap-2"</span>&gt;
          &lt;input
            <span class="hljs-attr">type</span>=<span class="hljs-string">"text"</span>
            <span class="hljs-attr">value</span>={inputValue}
            <span class="hljs-attr">onChange</span>={e =&gt; setInputValue(e.target.value)} 
            <span class="hljs-attr">placeholder</span>=<span class="hljs-string">"输入消息....按回车发送"</span>
            <span class="hljs-attr">disabled</span>={loading} 
            <span class="hljs-attr">className</span>=<span class="hljs-string">"flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"</span>
          /&gt;
          &lt;button 
            <span class="hljs-attr">type</span>=<span class="hljs-string">"submit"</span>
            <span class="hljs-attr">disabled</span>={loading || !inputValue.trim()}
            <span class="hljs-attr">className</span>=<span class="hljs-string">"bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition"</span>
          &gt;
            {loading ? '思考中...' : '发送'}
          &lt;/button&gt;
        &lt;/div&gt;
      &lt;/form&gt;
    &lt;/div&gt;
  )<span class="hljs-comment">;</span>
}
</code></pre>
<h4 data-id="heading-16">4.2 技术点详解</h4>
<ol>
<li><strong>受控组件：</strong> <code>input</code> 的 <code>value</code> 绑定到 <code>inputValue</code>，通过 <code>onChange</code> 更新状态，保证 UI 与 State 一致。</li>
<li><strong>表单处理：</strong> 使用 <code>onSubmit</code> 处理表单提交，并调用 <code>e.preventDefault()</code> 阻止页面刷新。</li>
<li><strong>条件渲染：</strong> 根据 <code>loading</code> 状态禁用按钮和改变按钮文本，防止重复提交。</li>
</ol>
<h4 data-id="heading-17">🧠 答疑解惑：易错点与排查</h4>
<ul>
<li>
<p><strong>问题：按下回车键页面刷新了</strong></p>
<ul>
<li><strong>原因：</strong> <code>&lt;form&gt;</code> 标签的默认行为是 <code>onSubmit</code> 触发页面跳转。</li>
<li><strong>解决方案：</strong> 在 <code>handleSend</code> 函数的第一行加上 <code>e.preventDefault();</code>。</li>
</ul>
</li>
<li>
<p><strong>问题：聊天记录滚动条没有自动到底部</strong></p>
<ul>
<li><strong>原因：</strong> DOM 更新后，容器的 <code>scrollTop</code> 没有自动调整。</li>
<li><strong>解决方案：</strong> 使用 <code>useRef</code> 获取聊天容器的 DOM 引用，在 <code>useEffect</code> 中监听 <code>messages</code> 变化，并设置 <code>container.scrollTop = container.scrollHeight</code>。</li>
</ul>
</li>
</ul>
<h4 data-id="heading-18">💼 面试模拟：UI 与用户体验</h4>
<p><strong>面试官：</strong> “如何优化这个聊天界面的用户体验（UX）？”<br/>
<strong>候选人：</strong></p>
<ol>
<li><strong>流式响应：</strong> 当前代码设置 <code>stream: false</code>，用户需要等待模型生成完所有文本才能看到结果。开启 <code>stream: true</code> 可以实现逐字输出的效果，体验更像真人打字。</li>
<li><strong>加载状态：</strong> 除了按钮禁用，聊天区域可以增加一个“机器人正在思考...”的 Typing 动画。</li>
<li><strong>错误重试：</strong> 当 API 调用失败时，UI 应该提供一个“重试”按钮，而不是仅仅显示错误文本。</li>
</ol>
<hr/>
<h3 data-id="heading-19">第五部分：进阶与优化</h3>
<h4 data-id="heading-20">5.1 流式传输 (Streaming)</h4>
<p>目前的代码是等待模型生成完所有内容后一次性返回。为了实现类似 ChatGPT 的打字机效果，我们需要开启流式传输。</p>
<ul>
<li><strong>原理：</strong> 设置 <code>stream: true</code>，后端会以 <code>text/event-stream</code> 格式分块传输数据。</li>
<li><strong>实现：</strong> 在 <code>chatCompletions</code> 函数中，需要使用 <code>fetch</code> API 替代 Axios（因为 Axios 对流式处理支持较弱），并读取 <code>ReadableStream</code>。</li>
</ul>
<h4 data-id="heading-21">5.2 上下文管理</h4>
<p><code>qwen2.5:0.5b</code> 这种 0.5B 参数的模型内存有限。如果对话过长，模型会“忘记”开头的内容，或者出现显存溢出。</p>
<ul>
<li><strong>解决方案：</strong> 实现一个简单的上下文截断逻辑，只保留最近的 N 轮对话传给模型。</li>
</ul>
<h4 data-id="heading-22">5.3 模型切换</h4>
<p>可以扩展 UI，让用户在界面上选择不同的本地模型（如从 <code>qwen</code> 切换到 <code>llama3</code>）。</p>
<hr/>
<h3 data-id="heading-23">博客结语</h3>
<p>通过这篇博客，我们完成了一个从本地大模型部署到前端全栈应用的开发流程。这不仅是一个技术Demo，更是理解现代AI应用架构的基石。</p>
<p><strong>核心收获：</strong></p>
<ol>
<li><strong>Ollama 是本地AI的基石</strong>，它让大模型触手可及。</li>
<li><strong>React Hooks</strong> 极大地简化了状态管理的复杂度。</li>
<li><strong>前后端分离</strong> 的思想依然适用，即使是与本地服务通信。</li>
</ol>
<p>希望这篇教程能帮助你在本地AI开发的道路上更进一步！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[小程序 Markdown 渲染血泪史：mp-html 组件从入门到放弃再到重生]]></title>    <link>https://juejin.cn/post/7595886887523401768</link>    <guid>https://juejin.cn/post/7595886887523401768</guid>    <pubDate>2026-01-17T10:14:35.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7595886887523401768" data-draft-id="7595974133096579106" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="小程序 Markdown 渲染血泪史：mp-html 组件从入门到放弃再到重生"/> <meta itemprop="keywords" content="前端,微信小程序"/> <meta itemprop="datePublished" content="2026-01-17T10:14:35.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="小时前端"/> <meta itemprop="url" content="https://juejin.cn/user/1197805741808339"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            小程序 Markdown 渲染血泪史：mp-html 组件从入门到放弃再到重生
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1197805741808339/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    小时前端
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-17T10:14:35.000Z" title="Sat Jan 17 2026 10:14:35 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-17
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{position:relative;word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden;color:#333}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:30px;margin-bottom:5px}.markdown-body h2{font-size:24px;display:inline-block;font-weight:700;background:#ef7060;color:#fff;padding:6px 8px 0 0;border-top-right-radius:6px;margin-right:2px;box-shadow:6px 3px 0 0 rgba(239,112,96,.2)}.markdown-body h2:before{content:" ";display:inline-block;width:8px}.markdown-body h2:after{content:" ";position:absolute;display:block;width:calc(100% - 50px);border-bottom:3px solid #ef7060}.markdown-body h3{font-size:18px;padding-bottom:0}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:15px}.markdown-body h6{margin-top:5px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #3e3e3e;margin-top:32px;margin-bottom:32px;height:1px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:rgba(27,31,35,.05);color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:JetBranins Mono,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75;box-shadow:0 0 8px hsla(0,0%,43.1%,.45);border-radius:4px;margin:16px}.markdown-body pre:before{content:"";display:block;height:30px;width:100%;margin-bottom:-7px;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAAAdCAYAAABcz8ldAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAhgSURBVGhD7Zp7bBTHHcdn33t7vvOdzy+ITVKDU0xIKG2ABCPTRCCaUiEVKWoqRJuASAhCitRCVKSoalFUKZBiSmmFRRJKRUnUtIpo+aNqGgwoOCmuFUIRzxjwE4zte+97drYzztji8HPvtkit/PnH+n1397Tz+83vN/PbMZhmmmmm+d+BoX8n5diihcGqgFQf5vk6BMAskWUlw3GyFnIvtqWSf91w7mKC3npfOLX7wYeiIa6BBWCOLLFRF2NB0JvIOP/80YG+k2ev6S699b/OzOfKBW5l5KsgyC4DCFQDnpEAdE1goc/dlNPc/Up7P711UiYNSMuyxeUzZPnHgGHWh5XADEkSAcdiN+AnEXIBhBComgFU0/xQR+jnj51sOUMf9Z0NKyL8S9+JPBEN8zuCMrsqGOA5QWAAyzLAxe53HBeYFgJp1c5Cx33nyIfpV3e+22/Sx32nev/sMCgVnmM4bjOniAtZWQAsz315EfsGQQc4hgWcjHkCmOj1rheuNn95cXwmDMiVp5etC/D8m5FwUWVQUYYGPh6mZYFUOgsGVa1pXvOZzVT2jRuH54RM230jEuI3RcIiL4l4UkxAJmuD/riVsqD7ct2m9nep7BtVTbVfZ0uE/UIk+CQflAHDjf8+Lg6MldYATGpH3c/Ul7p3dWXppVGM6eElJSHmnQWPbSlRlN1lJcUBjqNRnwJZVQO3B5P/uq5rK1d90pakckFcaKp5UJHY92JR8YlwkUDVySEZfGfQdO7E7Z8s2HL9TSoXTPXRud9nA8IBqSwcZgWeqpPj6BYw7yTbXBN9q2v9lQEq5zBmWA8vWLCptCi4tzwW8RQMQlFQATPLSh6vCSh/plJBkMyQBHZfWYnkKRgEktEVpTJXERN2Xzo4ex2VC6K6qXYpF5b3ypVRT8EgcAERSJXRbwCBOTFzXblM5RxGBaRt+ZPYA+LO0mgxz5K1Ig+UgAzKIuGnz39z6S+olDeaibaXRsU1RUFvgx+GwTWgPCaDgMw2XXpr9gwq50XV0bkxJiYeEiNF5cwE5XsiOEkAUkXkUW51SSOVchjl8WKef604XFSRbzCGCYeCoESStv/p8QU1VPIM3knNDynctnBRfsEYhgSlNCIGgQv2UCkvGIHZgteMh1nBW9W4F16RAM6yDVV7amZTaYQcr59cuuhhWRTWBvAMLxQGeyFSHOLnh0MvUskz5RF+fbRYDEy0mZgqQYUHOLhr//b6rGoqeaLqQG0pw3PrBbyA+4EQUkRmhvgqNUfICUipKK4OKUqIJVPKB0jpEhjmWWp64jdbKmVZZNYogcJm493gsifOqhDyeh9GYR/FM7sW+DA5CKR0MSK3tvKZkpwB5gRE4tjFEr7RL0iWBGV51vHFCyupNGWWPqLgnoer9mtyEGSJAzwLllDTGzyznDjRN/CwOFkoFb4bm0eVIXICgpvdGoEvrF7fC89zfLkkeV5HbOhWiTwTpKYvCAJLGshRdXtKMKAWlyxq+MPQLk1h66g5RE5ABJYNFrqY3wvJklJRUKg5ZWLFXIA86yek2uDOPkBNb3CM5Pf7DL2QyIrUGiLH+xC5Bmmm/ARnHUhC6PnzxWDK0RH5HuIjZGy27erU9AZ0dTIWXyG+NpBBrSFySxZw220IqeUPFoS6jVAPNadM7yDsgNB1qOkLuAziMYIb1PQGA75wIaKGPyAb+9oF16g5RE5ALIQ+tSyLWoWDEAK6aXW3JlK9VJoyx1oyvVkNdvo5KXXDAVkdnaKmNwx0xjH98w3JNmTCm+Bc9hKVhsgJSI9pvp9Vdd++jmq6AXB2/HHrhcs5aTkVDv0DFzoHvKdq/mQsKX/4t7KJLDpOJW+IbAvMGoMkxfwAWZB8DT7W1diTE+WcgKz6pK1bs6z3daPwmJDsSKt6ZsCyjlLJMz0DsDGZ8SdlDROBjOb8YeWOjptU8kTXusuaazu7oJrfEnQvdkpVcUn6PTVHyAkIIW7br/Unklni0EJIZ1WgGsauZR+fvUglz6zY0dGfVp09ybRNlfwgi3k8YSbvJJ29VMoLt9v6rZVQL7hOYUubndHJGclBtzn1byqNMCogi09/2nFb01/oj+f/5TyjauBOKtPcZ1r7qZQ3f2lRfxZPWi2anp8TSDAGExZMa2jr8u03L1M5L7q3Xc+iAeuHRl/ScvPcjSLDBnZS/cjtNHd2v3171Ewbs9N5q7Pn4otVMx3btBsCsoRbk1FxG5dMVgMDqfTpXl1/tuFMa5zKefPROdX59qLQBwLnNog8Wy1OcjB1N+QEsW/QsFNZuO35Xb1v98QLX4/Sx+O3wqujrQ6013ABUWI8+AaqBjAH01+ghL22+5X2PirnMG7r+esbnae/V1neauvGSoHjigTcVU7UGFm2DeK4ttxKpQ+mLPvl+o/PjnkAkw9HTqSMmVHhyAMx9iFcSh/BHTfLceO/C8mKjApBf9zszGhoY92m9sN+BGOY9AeD7eGniv8OTaOB4dgyTsQd9wS+IQu4lciYdkI7CLrNH3Rvbb9FL41i0tbzVP2iWJkobpN5fmM4IJfJskTP1Bk8A9HQmbpmGDBrWqdVCN/Yd7PjxKGOXn+bmbto3feVVcVB9qehIL8EJy8nChwgr0O2xxBnhGU5eP2CfYbl/m4gBRsbtneMORP9oGpjpcCsiKzHHfdOPiQ/wMniyFEu2dbiTQCAeN/vavC466BGYLttXc9fmXBXMGlAhiHHur+sq6uPiUI9z7CVHMPwBnLSuuN8FuC48/Oaz1ylt94XfrW5ouyprwWfYRkwNyCyYYjwkBHows1fa+tV/fzGxlv39b9gqvfPmQ+i/HK8KlcBjhHwfl8HEHyOd1JnuzZd66S3TTPNNNP8/wDAfwDG7G0m9LKBpwAAAABJRU5ErkJggg==) 10px 10px no-repeat;background-size:40px;background-color:#fdfdfd}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#fdfdfd}.markdown-body a{text-decoration:none;font-weight:700;color:#ef7060;border-bottom:1px solid #ef7060}.markdown-body a:active,.markdown-body a:hover{color:#ef2d26}.markdown-body table tr td,.markdown-body table tr th{border:1px solid #ccc;padding:5px 10px}.markdown-body table{display:block!important;width:auto;max-width:100%;overflow:auto;border-collapse:collapse}.markdown-body thead{background:#f0f0f0;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#f8f8f8}.markdown-body blockquote{margin-inline-start:0;margin-inline-end:0;border-left:3px solid #ef7060;background:#fff9f9;padding:1px 20px;margin-top:20px}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="atom-one-light">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#383a42;background:#fafafa}.hljs-comment,.hljs-quote{color:#a0a1a7;font-style:italic}.hljs-doctag,.hljs-formula,.hljs-keyword{color:#a626a4}.hljs-deletion,.hljs-name,.hljs-section,.hljs-selector-tag,.hljs-subst{color:#e45649}.hljs-literal{color:#0184bb}.hljs-addition,.hljs-attribute,.hljs-meta-string,.hljs-regexp,.hljs-string{color:#50a14f}.hljs-built_in,.hljs-class .hljs-title{color:#c18401}.hljs-attr,.hljs-number,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-pseudo,.hljs-template-variable,.hljs-type,.hljs-variable{color:#986801}.hljs-bullet,.hljs-link,.hljs-meta,.hljs-selector-id,.hljs-symbol,.hljs-title{color:#4078f2}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}.hljs-link{text-decoration:underline}</style><h2 data-id="heading-0">前言：小程序 MD 渲染的难点</h2>
<p>在小程序开发中，Markdown 内容的渲染一直是一个让人头疼的问题。与 Web 端丰富的生态不同，小程序平台有着诸多限制：</p>
<ul>
<li><strong>平台差异性</strong>：微信小程序、支付宝小程序、百度小程序等平台对 HTML 和 CSS 的支持程度不同</li>
<li><strong>安全限制</strong>：小程序不允许直接使用 <code>dangerouslySetInnerHTML</code> 或动态执行脚本</li>
<li><strong>样式兼容性</strong>：部分 CSS 属性在小程序中不被支持</li>
<li><strong>性能瓶颈</strong>：复杂的富文本渲染容易影响页面性能</li>
<li><strong>交互限制</strong>：图片预览、链接跳转等交互行为需要特殊处理</li>
</ul>
<p>这些限制使得在小程序中实现完整的 Markdown 渲染变得异常困难。开发者往往需要在功能完整性和性能体验之间寻找平衡。</p>
<h2 data-id="heading-1">最近的踩坑经历</h2>
<p>最近在开发一个小程序时，需要在小程序中渲染包含代码块、表格、图片等多种元素的 Markdown 内容。一开始天真地以为可以用简单的 HTML 解析器搞定，结果踩了一堆坑。</p>
<h3 data-id="heading-2">坑一：代码高亮完全不工作</h3>
<p>最先遇到的就是代码高亮问题。我按照文档启用 Markdown 插件后，代码块倒是能显示，但是语法高亮完全没有效果。</p>
<pre><code class="hljs language-markdown" lang="markdown">// 这是我一开始的配置
<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">mp-html</span>
  <span class="hljs-attr">:content</span>=<span class="hljs-string">"markdownContent"</span>
  <span class="hljs-attr">:markdown</span>=<span class="hljs-string">"true"</span>
/&gt;</span></span>
</code></pre>
<p>代码块显示成了普通文本，完全没有颜色区分。后来才发现需要单独启用 <code>highlight</code> 插件，而且还需要重新构建组件。</p>
<h3 data-id="heading-3">坑二：多语言代码块识别失败</h3>
<p>启用代码高亮后，发现只有 JavaScript 代码能正常高亮，其他语言如 Java、Python、Go 等都显示为纯文本。原来 mp-html 默认只支持基础的几种语言，需要手动下载完整的 Prism.js 文件来支持更多编程语言。</p>
<h3 data-id="heading-4">坑三：图片路径和预览问题</h3>
<p>Markdown 中的图片链接在小程序中无法直接显示。一开始我尝试使用相对路径，结果全部加载失败。后来发现需要配置 <code>domain</code> 属性来处理图片路径，而且图片预览功能还需要手动开启。</p>
<h3 data-id="heading-5">坑四：表格滚动和样式问题</h3>
<p>复杂的表格在小程序中显示不全，内容会被截断。特别是手机端，表格列数多时根本看不清内容。而且表格的样式也需要特殊处理，默认样式很难看。</p>
<h3 data-id="heading-6">坑五：文本选择和复制功能</h3>
<p>用户希望能复制代码块的内容，但是默认情况下小程序不支持文本选择。后来发现可以通过配置 <code>selectable</code> 属性来开启这个功能。</p>
<h3 data-id="heading-7">坑六：Mermaid 图表渲染失败</h3>
<p>最棘手的问题是 Mermaid 图表渲染。在 Markdown 中，Mermaid 图表通常以代码块形式存在：</p>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-code">```mermaid
graph TD;
    A--&gt;B;
    A--&gt;C;
    B--&gt;D;
    C--&gt;D;
</span></code></pre>
<pre><code class="hljs language-ini" lang="ini">
mp-html 组件本身不支持 Mermaid 语法渲染，因为 Mermaid 需要 JavaScript 引擎来解析和绘制图表，而小程序环境对这有限制。

一开始我尝试直接在 Markdown 中嵌入 Mermaid 代码，但结果只能显示为普通的代码块，完全没有图表效果。

<span class="hljs-comment">## 解决方案大揭秘</span>

经过一番折腾，终于找到了完整的解决方案。以下是我的实战配置：

<span class="hljs-comment">### 1. 完整的组件配置</span>

```vue
&lt;template&gt;
  &lt;view <span class="hljs-attr">class</span>=<span class="hljs-string">"article-container"</span>&gt;
    &lt;mp-html
      :<span class="hljs-attr">content</span>=<span class="hljs-string">"articleContent"</span>
      :<span class="hljs-attr">markdown</span>=<span class="hljs-string">"true"</span>
      :<span class="hljs-attr">preview-img</span>=<span class="hljs-string">"true"</span>
      :<span class="hljs-attr">scroll-table</span>=<span class="hljs-string">"true"</span>
      :<span class="hljs-attr">selectable</span>=<span class="hljs-string">"true"</span>
      :<span class="hljs-attr">use-anchor</span>=<span class="hljs-string">"true"</span>
      :<span class="hljs-attr">lazy-load</span>=<span class="hljs-string">"true"</span>
      <span class="hljs-attr">container-style</span>=<span class="hljs-string">"padding: 20rpx; background: #fff; border-radius: 12rpx;"</span>
      @<span class="hljs-attr">load</span>=<span class="hljs-string">"onContentLoad"</span>
      @<span class="hljs-attr">ready</span>=<span class="hljs-string">"onContentReady"</span>
      @<span class="hljs-attr">imgtap</span>=<span class="hljs-string">"onImageTap"</span>
      @<span class="hljs-attr">linktap</span>=<span class="hljs-string">"onLinkTap"</span>
      @<span class="hljs-attr">error</span>=<span class="hljs-string">"onError"</span>
    /&gt;
  &lt;/view&gt;
&lt;/template&gt;
</code></pre>
<h3 data-id="heading-8">2. 插件配置（重点）</h3>
<p>需要在 <code>node_modules/mp-html/tools/config.js</code> 中启用所有必要的插件：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = {
  <span class="hljs-attr">plugins</span>: [
    <span class="hljs-string">'markdown'</span>,    <span class="hljs-comment">// Markdown 解析</span>
    <span class="hljs-string">'highlight'</span>,   <span class="hljs-comment">// 代码高亮</span>
    <span class="hljs-string">'emoji'</span>,       <span class="hljs-comment">// Emoji 支持</span>
  ],

  <span class="hljs-comment">// 全局样式配置</span>
  <span class="hljs-attr">externStyle</span>: <span class="hljs-string">`
    .markdown-body {
      color: #333;
      line-height: 1.6;
      font-size: 28rpx;
    }
    .markdown-body h1,
    .markdown-body h2,
    .markdown-body h3 {
      color: #2c3e50;
      margin: 40rpx 0 20rpx 0;
      font-weight: 600;
    }
    .markdown-body p {
      margin: 20rpx 0;
      text-align: justify;
    }
    .markdown-body pre {
      background: #f6f8fa;
      border-radius: 8rpx;
      padding: 20rpx;
      overflow-x: auto;
    }
    .markdown-body code {
      background: #f1f3f4;
      padding: 4rpx 8rpx;
      border-radius: 4rpx;
      font-family: 'Consolas', 'Monaco', monospace;
    }
    .markdown-body blockquote {
      border-left: 4rpx solid #ddd;
      padding-left: 20rpx;
      margin: 20rpx 0;
      color: #666;
      background: #fafafa;
    }
    .markdown-body table {
      border-collapse: collapse;
      width: 100%;
      margin: 20rpx 0;
    }
    .markdown-body th,
    .markdown-body td {
      border: 1rpx solid #ddd;
      padding: 12rpx;
      text-align: left;
    }
    .markdown-body th {
      background: #f5f5f5;
      font-weight: 600;
    }
  `</span>
}
</code></pre>
<h3 data-id="heading-9">3. 代码高亮扩展（关键步骤）</h3>
<p>要支持多种编程语言的代码高亮，需要：</p>
<ol>
<li>访问 <a href="https://link.juejin.cn?target=https%3A%2F%2Fprismjs.com%2Fdownload.html" target="_blank" title="https://prismjs.com/download.html" ref="nofollow noopener noreferrer">prismjs.com/download.ht…</a></li>
<li>选择 Tomorrow Night 主题</li>
<li>勾选需要的语言：JavaScript, Java, Python, Go, C++, C, HTML, CSS 等</li>
<li>下载 <code>prism.min.js</code> 和 <code>prism.css</code></li>
<li>替换 <code>node_modules/mp-html/plugins/highlight/</code> 目录下的对应文件</li>
<li>重新构建组件：<code>npm run build:uni-app</code></li>
</ol>
<h3 data-id="heading-10">4. 代码高亮配置优化</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// plugins/highlight/config.js</span>
<span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = {
  <span class="hljs-attr">copyByLongPress</span>: <span class="hljs-literal">true</span>,    <span class="hljs-comment">// 长按复制代码</span>
  <span class="hljs-attr">showLanguageName</span>: <span class="hljs-literal">true</span>,   <span class="hljs-comment">// 显示语言名称</span>
  <span class="hljs-attr">showLineNumber</span>: <span class="hljs-literal">true</span>       <span class="hljs-comment">// 显示行号</span>
}
</code></pre>
<h3 data-id="heading-11">5. Mermaid 图表处理</h3>
<p>对于 Mermaid 图表渲染问题，需要在前端预处理，将 Mermaid 代码块转换为图片：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// utils/mermaidProcessor.js</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">processMermaidInMarkdown</span>(<span class="hljs-params">content</span>) {
  <span class="hljs-keyword">if</span> (!content) <span class="hljs-keyword">return</span> content

  <span class="hljs-comment">// 匹配 mermaid 代码块</span>
  <span class="hljs-keyword">const</span> mermaidRegex = <span class="hljs-regexp">/```mermaid\s*\n([\s\S]*?)\n```/g</span>

  <span class="hljs-keyword">return</span> content.<span class="hljs-title function_">replace</span>(mermaidRegex, <span class="hljs-function">(<span class="hljs-params">match, mermaidCode</span>) =&gt;</span> {
    <span class="hljs-keyword">try</span> {
      <span class="hljs-comment">// 将 mermaid 代码发送到服务器生成图片</span>
      <span class="hljs-comment">// 这里需要实现一个服务，将 mermaid 代码转换为图片 URL</span>
      <span class="hljs-keyword">const</span> imageUrl = <span class="hljs-title function_">generateMermaidImageUrl</span>(mermaidCode)
      <span class="hljs-keyword">return</span> <span class="hljs-string">`![Mermaid 图表](<span class="hljs-subst">${imageUrl}</span>)`</span>
    } <span class="hljs-keyword">catch</span> (error) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'Mermaid 处理失败:'</span>, error)
      <span class="hljs-comment">// 处理失败时返回原始代码块</span>
      <span class="hljs-keyword">return</span> match
    }
  })
}

<span class="hljs-comment">// 在 Vue 组件中使用</span>
<span class="hljs-keyword">const</span> processedContent = <span class="hljs-title function_">computed</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-keyword">const</span> content = question.<span class="hljs-property">value</span>?.<span class="hljs-property">content</span>
  <span class="hljs-keyword">if</span> (!content) <span class="hljs-keyword">return</span> <span class="hljs-string">''</span>

  <span class="hljs-comment">// 先处理 mermaid（将 mermaid 代码块转换为图片）</span>
  <span class="hljs-keyword">const</span> mermaidProcessed = <span class="hljs-title function_">processMermaidInMarkdown</span>(content)
  <span class="hljs-comment">// 再转换为 HTML</span>
  <span class="hljs-keyword">return</span> mermaidProcessed
})
</code></pre>
<p><strong>关键点</strong>：</p>
<ul>
<li>Mermaid 图表无法在小程序中直接渲染，需要预先转换为图片</li>
<li>需要后端服务或第三方 API 将 Mermaid 代码转换为图片</li>
<li>处理顺序：先转换 Mermaid → 再解析 Markdown → 最后渲染 HTML</li>
</ul>
<h3 data-id="heading-12">6. 图片处理策略</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 处理图片路径</span>
<span class="hljs-title function_">getImageUrl</span>(<span class="hljs-params">originalUrl</span>) {
  <span class="hljs-comment">// 如果是相对路径，拼接完整域名</span>
  <span class="hljs-keyword">if</span> (originalUrl.<span class="hljs-title function_">startsWith</span>(<span class="hljs-string">'/'</span>)) {
    <span class="hljs-keyword">return</span> <span class="hljs-string">`https://your-domain.com<span class="hljs-subst">${originalUrl}</span>`</span>
  }
  <span class="hljs-comment">// 如果是外部链接，可以添加代理或直接返回</span>
  <span class="hljs-keyword">return</span> originalUrl
}
</code></pre>
<h3 data-id="heading-13">6. 事件处理</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-attr">methods</span>: {
    <span class="hljs-title function_">onContentLoad</span>(<span class="hljs-params"/>) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Markdown 内容加载完成'</span>)
      <span class="hljs-comment">// 可以在这里添加加载完成后的逻辑</span>
    },

    <span class="hljs-title function_">onContentReady</span>(<span class="hljs-params"/>) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'所有资源加载完成'</span>)
      <span class="hljs-comment">// 图片等资源加载完成后的处理</span>
    },

    <span class="hljs-title function_">onImageTap</span>(<span class="hljs-params">e</span>) {
      <span class="hljs-keyword">const</span> { src, i } = e.<span class="hljs-property">detail</span>
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`点击第 <span class="hljs-subst">${i + <span class="hljs-number">1</span>}</span> 张图片:`</span>, src)
      <span class="hljs-comment">// 可以在这里添加图片统计或其他逻辑</span>
    },

    <span class="hljs-title function_">onLinkTap</span>(<span class="hljs-params">e</span>) {
      <span class="hljs-keyword">const</span> { href } = e.<span class="hljs-property">detail</span>
      <span class="hljs-comment">// 处理内部链接跳转</span>
      <span class="hljs-keyword">if</span> (href.<span class="hljs-title function_">startsWith</span>(<span class="hljs-string">'#'</span>)) {
        <span class="hljs-comment">// 锚点跳转</span>
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">$refs</span>.<span class="hljs-property">mpHtml</span>.<span class="hljs-title function_">navigateTo</span>(href.<span class="hljs-title function_">substring</span>(<span class="hljs-number">1</span>))
      } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (href.<span class="hljs-title function_">startsWith</span>(<span class="hljs-string">'/'</span>)) {
        <span class="hljs-comment">// 内部页面跳转</span>
        uni.<span class="hljs-title function_">navigateTo</span>({ <span class="hljs-attr">url</span>: href })
      } <span class="hljs-keyword">else</span> {
        <span class="hljs-comment">// 外部链接，可以复制或用 webview 打开</span>
        uni.<span class="hljs-title function_">setClipboardData</span>({
          <span class="hljs-attr">data</span>: href,
          <span class="hljs-attr">success</span>: <span class="hljs-function">() =&gt;</span> {
            uni.<span class="hljs-title function_">showToast</span>({
              <span class="hljs-attr">title</span>: <span class="hljs-string">'链接已复制'</span>,
              <span class="hljs-attr">icon</span>: <span class="hljs-string">'success'</span>
            })
          }
        })
      }
    },

    <span class="hljs-title function_">onError</span>(<span class="hljs-params">err</span>) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'渲染错误:'</span>, err)
      <span class="hljs-comment">// 错误处理逻辑</span>
    }
  }
}
</code></pre>
<h2 data-id="heading-14">性能优化建议</h2>
<h3 data-id="heading-15">1. 图片懒加载</h3>
<pre><code class="hljs language-vue" lang="vue">&lt;mp-html :lazy-load="true" /&gt;
</code></pre>
<h3 data-id="heading-16">2. 按需加载</h3>
<p>只在需要 Markdown 渲染的页面引入组件，避免全局注册增加包体积。</p>
<h3 data-id="heading-17">3. 缓存策略</h3>
<p>对于频繁使用的 Markdown 内容，可以考虑缓存解析结果。</p>
<h3 data-id="heading-18">4. 样式优化</h3>
<p>使用 <code>externStyle</code> 统一配置样式，避免内联样式过多影响性能。</p>
<h2 data-id="heading-19">总结</h2>
<p>mp-html 确实是一个功能强大的小程序 Markdown 渲染组件，但在使用的过程中需要注意：</p>
<ol>
<li><strong>插件配置</strong>：必须正确启用和配置相关插件</li>
<li><strong>代码高亮</strong>：需要手动扩展 Prism.js 来支持更多语言</li>
<li><strong>样式处理</strong>：充分利用 <code>externStyle</code> 和 <code>tag-style</code> 进行样式定制</li>
<li><strong>事件处理</strong>：合理处理图片、链接等交互事件</li>
<li><strong>性能优化</strong>：开启懒加载，合理使用缓存策略</li>
<li><strong>Mermaid 图表</strong>：需要预处理将 Mermaid 代码转换为图片</li>
</ol>
<p>虽然踩了不少坑，但最终的效果还是很满意的。现在我们的小程序可以完美地渲染包含代码高亮、表格、图片、Mermaid 图表等多种元素的 Markdown 内容，为用户提供了良好的阅读体验。</p>
<p>特别值得一提的是 Mermaid 图表的处理，这在技术面试题中非常常见。通过预处理将图表转换为图片，我们成功解决了小程序环境中无法直接渲染 Mermaid 的问题。</p>
<p>如果你也在小程序开发中遇到 Markdown 渲染的问题，不妨试试 mp-html 这个组件，希望这篇踩坑记能为你节省一些时间！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[使用pymobiledevice3进行iphone应用性能采集]]></title>    <link>https://juejin.cn/post/7595864836360142900</link>    <guid>https://juejin.cn/post/7595864836360142900</guid>    <pubDate>2026-01-17T08:05:23.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7595864836360142900" data-draft-id="7595871887000977408" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="使用pymobiledevice3进行iphone应用性能采集"/> <meta itemprop="keywords" content="Python,iOS"/> <meta itemprop="datePublished" content="2026-01-17T08:05:23.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="茫茫碌碌"/> <meta itemprop="url" content="https://juejin.cn/user/430664290939080"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            使用pymobiledevice3进行iphone应用性能采集
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/430664290939080/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    茫茫碌碌
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-17T08:05:23.000Z" title="Sat Jan 17 2026 08:05:23 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-17
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    7
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">执行步骤</h2>
<h4 data-id="heading-1">安装依赖（未安装则执行）</h4>
<pre><code class="hljs language-bash" lang="bash">pip install pymobiledevice3
</code></pre>
<h4 data-id="heading-2">启动Tunnel（系统版本&gt;=17需要）</h4>
<pre><code class="hljs language-bash" lang="bash">sudo pymobiledevice3 remote tunneld
</code></pre>
<h4 data-id="heading-3">获取性能数据（打开一个新的终端）</h4>
<p>根据PID获取性能数据</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 获取PID</span>
pymobiledevice3 developer dvt process-id-for-bundle-id com.xxx.xxx

<span class="hljs-comment"># 获取指定PID的性能数据</span>
pymobiledevice3 developer dvt sysmon process single -a pid=xxxx
</code></pre>
<p>获取全部进程的性能数据</p>
<pre><code class="hljs language-bash" lang="bash">pymobiledevice3 developer dvt sysmon process monitor --rsd xxxx:xxxx:xxxx::x 58524 0.01
</code></pre>
<h2 data-id="heading-4">简单方案</h2>
<p>上面的多个步骤都是通过<code>pymobiledevice3</code>一个工具来实现的，因此是否可以一步就完成性能的采集？当然可以，通过深扒（并复制+改造）pymobiledevice3的源码，将所有操作封装到了一个脚本中~~~</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-string">"""
—————— 使用说明 ——————
usage: python3 ios-monitor.py [-h] [-g GAP] [-b BUNDLE_ID] [-r REPORT_HOST] [--detail] [--csv] [--debug]

ios设备性能收集

options:
  -h, --help            show this help message and exit
  -g, --gap GAP         性能数据获取时间间隔，默认1s
  -b, --bundle_id BUNDLE_ID
                        包名, 默认: com.mi.car.mobile
  -r, --report_host REPORT_HOST
                        性能采集数据上报地址
  --detail              输出详细信息
  --csv                 结果写入到CSV文件
  --debug               打印debug日志

—————— 示例 ——————
# 进行性能采集，ctrl+c 终止后写入csv文件
sudo python3 ios-monitor.py --csv

# 进行性能采集，数据上报到指定服务
sudo python3 ios-monitor.py -r 127.0.0.1:9311

"""</span>
<span class="hljs-keyword">import</span> argparse
<span class="hljs-keyword">import</span> asyncio
<span class="hljs-keyword">import</span> csv
<span class="hljs-keyword">import</span> json
<span class="hljs-keyword">import</span> logging
<span class="hljs-keyword">import</span> os
<span class="hljs-keyword">import</span> signal
<span class="hljs-keyword">import</span> sys
<span class="hljs-keyword">import</span> time
<span class="hljs-keyword">from</span> functools <span class="hljs-keyword">import</span> partial
<span class="hljs-keyword">import</span> multiprocessing
<span class="hljs-keyword">from</span> multiprocessing <span class="hljs-keyword">import</span> Process

<span class="hljs-keyword">from</span> pymobiledevice3.remote.common <span class="hljs-keyword">import</span> TunnelProtocol
<span class="hljs-keyword">from</span> pymobiledevice3.remote.module_imports <span class="hljs-keyword">import</span> verify_tunnel_imports
<span class="hljs-keyword">from</span> pymobiledevice3.remote.remote_service_discovery <span class="hljs-keyword">import</span> RemoteServiceDiscoveryService
<span class="hljs-keyword">from</span> pymobiledevice3.services.dvt.dvt_secure_socket_proxy <span class="hljs-keyword">import</span> DvtSecureSocketProxyService
<span class="hljs-keyword">from</span> pymobiledevice3.services.dvt.instruments.device_info <span class="hljs-keyword">import</span> DeviceInfo
<span class="hljs-keyword">from</span> pymobiledevice3.services.dvt.instruments.process_control <span class="hljs-keyword">import</span> ProcessControl
<span class="hljs-keyword">from</span> pymobiledevice3.services.dvt.instruments.sysmontap <span class="hljs-keyword">import</span> Sysmontap
<span class="hljs-keyword">from</span> pymobiledevice3.tunneld.server <span class="hljs-keyword">import</span> TunneldRunner

<span class="hljs-keyword">import</span> requests

TUNNELD_DEFAULT_ADDRESS = (<span class="hljs-string">'127.0.0.1'</span>, <span class="hljs-number">49151</span>)

logging.basicConfig(level=logging.INFO, <span class="hljs-built_in">format</span>=<span class="hljs-string">'%(asctime)s - %(levelname)s - %(message)s'</span>)
logger = logging.getLogger(__name__)

report_error_num = <span class="hljs-number">0</span>

csv_data_list = []
csv_fieldnames=[<span class="hljs-string">'cpu'</span>, <span class="hljs-string">'mem'</span>]

<span class="hljs-keyword">def</span> <span class="hljs-title function_">run_tunneld</span>():
    <span class="hljs-string">""" Start Tunneld service for remote tunneling
    sudo pymobiledevice3 remote tunneld
    """</span>
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> verify_tunnel_imports():
        logger.warning(<span class="hljs-string">"verify_tunnel_imports false"</span>)
        <span class="hljs-keyword">return</span>
    host = TUNNELD_DEFAULT_ADDRESS[<span class="hljs-number">0</span>]
    port = TUNNELD_DEFAULT_ADDRESS[<span class="hljs-number">1</span>]
    protocol = TunnelProtocol(TunnelProtocol.DEFAULT.value)

    tunneld_runner = partial(TunneldRunner.create, host, port, protocol=protocol, usb_monitor=<span class="hljs-literal">True</span>,
                             wifi_monitor=<span class="hljs-literal">True</span>, usbmux_monitor=<span class="hljs-literal">True</span>, mobdev2_monitor=<span class="hljs-literal">True</span>)

    tunneld_runner()
    <span class="hljs-keyword">return</span>

<span class="hljs-keyword">def</span> <span class="hljs-title function_">process_id_for_bundle_id</span>(<span class="hljs-params">lockdown, app_bundle_identifier: <span class="hljs-built_in">str</span> = <span class="hljs-string">"com.mi.car.mobile"</span></span>):
    <span class="hljs-string">""" Get PID of a bundle identifier (only returns a valid value if its running). """</span>
    <span class="hljs-keyword">with</span> DvtSecureSocketProxyService(lockdown=lockdown) <span class="hljs-keyword">as</span> dvt:
        <span class="hljs-keyword">return</span> ProcessControl(dvt).process_identifier_for_bundle_identifier(app_bundle_identifier)

<span class="hljs-keyword">def</span> <span class="hljs-title function_">sysmon_process_single</span>(<span class="hljs-params">lockdown, pid, detail, report_host=<span class="hljs-string">''</span>, write_csv=<span class="hljs-literal">False</span>, tunnel_process=<span class="hljs-literal">None</span></span>):
    <span class="hljs-string">""" show a single snapshot of currently running processes. """</span>
    count = <span class="hljs-number">0</span>
    result = []

    <span class="hljs-keyword">with</span> DvtSecureSocketProxyService(lockdown=lockdown) <span class="hljs-keyword">as</span> dvt:
        device_info = DeviceInfo(dvt)
        <span class="hljs-keyword">with</span> Sysmontap(dvt) <span class="hljs-keyword">as</span> sysmon:
            <span class="hljs-keyword">for</span> process_snapshot <span class="hljs-keyword">in</span> sysmon.iter_processes():
                count += <span class="hljs-number">1</span>
                <span class="hljs-keyword">if</span> count &lt; <span class="hljs-number">2</span>:
                    <span class="hljs-comment"># first sample doesn't contain an initialized value for cpuUsage</span>
                    <span class="hljs-keyword">continue</span>
                <span class="hljs-keyword">for</span> process <span class="hljs-keyword">in</span> process_snapshot:
                    <span class="hljs-comment"># print(process)</span>
                    <span class="hljs-keyword">if</span> <span class="hljs-built_in">str</span>(process[<span class="hljs-string">"pid"</span>]) != <span class="hljs-built_in">str</span>(pid):
                        <span class="hljs-keyword">continue</span>
                    <span class="hljs-comment"># adding "artificially" the execName field</span>
                    process[<span class="hljs-string">'execName'</span>] = device_info.execname_for_pid(process[<span class="hljs-string">'pid'</span>])
                    result.append(process)
                <span class="hljs-comment"># exit after single snapshot</span>
                <span class="hljs-keyword">break</span>
    <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(result) == <span class="hljs-number">0</span>:
        logger.info(<span class="hljs-string">"[]"</span>)
        <span class="hljs-keyword">return</span>
    
    cpu_usage = <span class="hljs-string">"%.2f"</span> % result[<span class="hljs-number">0</span>][<span class="hljs-string">'cpuUsage'</span>]
    mem = <span class="hljs-string">"%.2f"</span> % (result[<span class="hljs-number">0</span>][<span class="hljs-string">'memResidentSize'</span>] / <span class="hljs-number">1024</span> / <span class="hljs-number">1024</span>)
    
    <span class="hljs-keyword">if</span> write_csv:
        csv_data = {<span class="hljs-string">'cpu'</span>: cpu_usage, <span class="hljs-string">'mem'</span>: mem}
        csv_data_list.append(csv_data)

    <span class="hljs-keyword">if</span> report_host:
        report(host=report_host, info=result[<span class="hljs-number">0</span>], pid=<span class="hljs-built_in">str</span>(pid), tunnel_process=tunnel_process)
        <span class="hljs-keyword">return</span>

    <span class="hljs-keyword">if</span> detail:
        logger.info(json.dumps(result, indent=<span class="hljs-number">4</span>, ensure_ascii=<span class="hljs-literal">False</span>))
    <span class="hljs-keyword">else</span>:
        logger.info(<span class="hljs-string">"[CPU]{} %  [内存]{} MB"</span>.<span class="hljs-built_in">format</span>(cpu_usage, mem))

<span class="hljs-keyword">def</span> <span class="hljs-title function_">report</span>(<span class="hljs-params">host: <span class="hljs-built_in">str</span>, info: <span class="hljs-built_in">dict</span>, pid: <span class="hljs-built_in">str</span>, tunnel_process=<span class="hljs-literal">None</span></span>):
    <span class="hljs-keyword">global</span> report_error_num
    url = <span class="hljs-string">'http://%s/monitor/collect'</span> % host
    mem = info[<span class="hljs-string">'memResidentSize'</span>] / <span class="hljs-number">1024</span> / <span class="hljs-number">1024</span>
    data = {
        <span class="hljs-string">'device'</span>: <span class="hljs-string">'ios-%s'</span> % pid,
        <span class="hljs-string">'list'</span>: [<span class="hljs-number">0</span>, info[<span class="hljs-string">'cpuUsage'</span>], <span class="hljs-number">0</span>, mem],
        <span class="hljs-string">'app_cpu_rate'</span>: info[<span class="hljs-string">'cpuUsage'</span>],
        <span class="hljs-string">'app_mem'</span>: mem,
        <span class="hljs-string">'timestamp'</span>: <span class="hljs-built_in">int</span>(time.time() * <span class="hljs-number">1000</span>)
    }
    report_err = <span class="hljs-literal">False</span>
    <span class="hljs-keyword">try</span>:
        resp = requests.post(url=url, json=data, timeout=(<span class="hljs-number">0.5</span>, <span class="hljs-number">0.5</span>))
    <span class="hljs-keyword">except</span> Exception:
        report_err = <span class="hljs-literal">True</span>

    <span class="hljs-keyword">if</span> report_err <span class="hljs-keyword">is</span> <span class="hljs-literal">False</span> <span class="hljs-keyword">and</span> resp.status_code != <span class="hljs-number">200</span>:
        report_err = <span class="hljs-literal">True</span>

    <span class="hljs-keyword">if</span> report_err:
        report_error_num += <span class="hljs-number">1</span>
        logger.warning(<span class="hljs-string">"上报失败 %d"</span> % report_error_num)
        <span class="hljs-keyword">if</span> report_error_num &gt; <span class="hljs-number">5</span>:
            logger.info(<span class="hljs-string">"接收端已关闭, 监控退出"</span>)
            <span class="hljs-keyword">if</span> tunnel_process:
                tunnel_process.terminate()
            sys.exit(<span class="hljs-number">0</span>)
    <span class="hljs-keyword">else</span>:
        cpu_usage = <span class="hljs-string">"%.2f"</span> % info[<span class="hljs-string">'cpuUsage'</span>]
        logger.info(<span class="hljs-string">"report [CPU]{} %  [内存]{} MB"</span>.<span class="hljs-built_in">format</span>(cpu_usage, mem))
        report_error_num = <span class="hljs-number">0</span>

<span class="hljs-keyword">def</span> <span class="hljs-title function_">get_tunnel_addr</span>(<span class="hljs-params">attemp_times=<span class="hljs-number">30</span></span>):
    url = <span class="hljs-string">'http://127.0.0.1:%d/'</span> % TUNNELD_DEFAULT_ADDRESS[<span class="hljs-number">1</span>]
    try_times = <span class="hljs-number">0</span>
    <span class="hljs-keyword">while</span> try_times &lt; attemp_times:
        <span class="hljs-keyword">try</span>:
            logger.info(<span class="hljs-string">'--- 获取设备连接信息'</span>)
            resp = requests.get(url=url, timeout=(<span class="hljs-number">1</span>, <span class="hljs-number">1</span>)).json()
            <span class="hljs-keyword">for</span> v <span class="hljs-keyword">in</span> resp.values():
                <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> v:
                    <span class="hljs-keyword">continue</span>
                <span class="hljs-keyword">return</span> v[<span class="hljs-number">0</span>][<span class="hljs-string">'tunnel-address'</span>], v[<span class="hljs-number">0</span>][<span class="hljs-string">'tunnel-port'</span>]
        <span class="hljs-keyword">except</span> Exception:
            <span class="hljs-keyword">pass</span>
        try_times += <span class="hljs-number">1</span>
        time.sleep(<span class="hljs-number">1</span>)
        <span class="hljs-keyword">continue</span>
    logger.warning(<span class="hljs-string">'--- 未找到ios设备'</span>)
    <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span>, <span class="hljs-literal">None</span>

<span class="hljs-keyword">def</span> <span class="hljs-title function_">run_in_one</span>(<span class="hljs-params">bundle_id: <span class="hljs-built_in">str</span>, gap: <span class="hljs-built_in">int</span>, detail: <span class="hljs-built_in">bool</span>, report_host: <span class="hljs-built_in">str</span> = <span class="hljs-string">''</span>, write_csv: <span class="hljs-built_in">bool</span> = <span class="hljs-literal">False</span></span>):
    logger.info(<span class="hljs-string">'--- 连接设备'</span>)
    p = Process(target=run_tunneld, args=())
    p.start()

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">sys_exit</span>(<span class="hljs-params">status: <span class="hljs-built_in">int</span> = <span class="hljs-number">0</span></span>):
        p.terminate()
        <span class="hljs-comment"># 写入csv</span>
        <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(csv_data_list) &gt; <span class="hljs-number">0</span>:
            logger.info(<span class="hljs-string">'--- 写入CSV'</span>)
            filename = <span class="hljs-string">'ios-monitor-result-%d.csv'</span> % <span class="hljs-built_in">int</span>(time.time())
            filepath = os.path.join(os.getcwd(), filename)
            <span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(filepath, <span class="hljs-string">'w'</span>, encoding=<span class="hljs-string">'UTF8'</span>, newline=<span class="hljs-string">''</span>) <span class="hljs-keyword">as</span> f:
                writer = csv.DictWriter(f, fieldnames=csv_fieldnames)
                writer.writeheader()
                writer.writerows(csv_data_list)
        
        logger.info(<span class="hljs-string">' --- 退出 ---'</span>)
        sys.exit(status)

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">signal_handler</span>(<span class="hljs-params">*args, **kwargs</span>):
        sys_exit(<span class="hljs-number">0</span>)

    time.sleep(<span class="hljs-number">3</span>)
    signal.signal(signal.SIGINT, signal_handler)

    addr, port = get_tunnel_addr(attemp_times=<span class="hljs-number">30</span>)
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> addr:
        sys_exit(<span class="hljs-number">1</span>)

    logger.info(<span class="hljs-string">"--- connect device: %s %d"</span> % (addr, port))

    logger.debug(<span class="hljs-string">'start run'</span>)
    rsd = RemoteServiceDiscoveryService(address=(addr, port))
    logger.debug(<span class="hljs-string">'start rsd connect'</span>)
    asyncio.run(rsd.connect(), debug=<span class="hljs-literal">True</span>)
    time.sleep(<span class="hljs-number">1</span>)
    logger.debug(<span class="hljs-string">'get pid'</span>)
    pid = process_id_for_bundle_id(lockdown=rsd, app_bundle_identifier=bundle_id)
    logger.info(<span class="hljs-string">'获取应用(%s)PID: %d'</span> % (bundle_id, pid))

    <span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> pid:
            pid = process_id_for_bundle_id(lockdown=rsd, app_bundle_identifier=bundle_id)
            logger.info(<span class="hljs-string">'获取应用(%s)PID: %d'</span> % (bundle_id, pid))
            time.sleep(<span class="hljs-number">0.3</span>)
            <span class="hljs-keyword">continue</span>

        <span class="hljs-keyword">try</span>:
            sysmon_process_single(lockdown=rsd, pid=pid, detail=detail, report_host=report_host, write_csv=write_csv, tunnel_process=p)
            time.sleep(gap/<span class="hljs-number">1000</span>)
        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> err:
            logger.error(<span class="hljs-string">'获取性能指标失败: {}'</span>.<span class="hljs-built_in">format</span>(err))
            addr, port = get_tunnel_addr(attemp_times=<span class="hljs-number">30</span>)
            <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> addr:
                sys_exit(<span class="hljs-number">1</span>)

            pid = process_id_for_bundle_id(lockdown=rsd, app_bundle_identifier=bundle_id)
            logger.info(<span class="hljs-string">'获取应用(%s)PID: %d'</span> % (bundle_id, pid))

<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">'__main__'</span>:
    multiprocessing.freeze_support()
    parser = argparse.ArgumentParser(description=<span class="hljs-string">'ios设备性能收集'</span>, add_help=<span class="hljs-literal">True</span>)
    parser.add_argument(<span class="hljs-string">'-g'</span>, <span class="hljs-string">'--gap'</span>, <span class="hljs-built_in">type</span>=<span class="hljs-built_in">int</span>, required=<span class="hljs-literal">False</span>, default=<span class="hljs-number">1000</span>,
                        <span class="hljs-built_in">help</span>=<span class="hljs-string">'性能数据获取时间间隔(ms)，默认1000ms'</span>)
    parser.add_argument(<span class="hljs-string">'-b'</span>, <span class="hljs-string">'--bundle_id'</span>, required=<span class="hljs-literal">False</span>, default=<span class="hljs-string">'com.mi.car.mobile'</span>,
                        <span class="hljs-built_in">help</span>=<span class="hljs-string">'包名, 默认: com.mi.car.mobile'</span>)
    parser.add_argument(<span class="hljs-string">'-r'</span>, <span class="hljs-string">'--report_host'</span>, required=<span class="hljs-literal">False</span>, default=<span class="hljs-string">''</span>,
                        <span class="hljs-built_in">help</span>=<span class="hljs-string">'性能采集数据上报地址'</span>)
    parser.add_argument(<span class="hljs-string">'--detail'</span>, default=<span class="hljs-literal">False</span>, action=<span class="hljs-string">'store_true'</span>,
                        <span class="hljs-built_in">help</span>=<span class="hljs-string">'输出详细信息'</span>)
    parser.add_argument(<span class="hljs-string">'--csv'</span>, default=<span class="hljs-literal">False</span>, action=<span class="hljs-string">'store_true'</span>,
                        <span class="hljs-built_in">help</span>=<span class="hljs-string">'结果写入到CSV文件'</span>)
    parser.add_argument(<span class="hljs-string">'--debug'</span>, default=<span class="hljs-literal">False</span>, action=<span class="hljs-string">'store_true'</span>,
                        <span class="hljs-built_in">help</span>=<span class="hljs-string">'打印debug日志'</span>)

    args = parser.parse_args()

    <span class="hljs-keyword">if</span> args.debug:
        logger.setLevel(logging.DEBUG)

    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> args.bundle_id:
        logger.error(<span class="hljs-string">'bundle_id invalid'</span>)
        sys.exit(<span class="hljs-number">1</span>)

    gap_ms = args.gap
    <span class="hljs-comment"># 最低200ms间隔</span>
    <span class="hljs-keyword">if</span> gap_ms &lt; <span class="hljs-number">200</span>:
        gap_ms = <span class="hljs-number">200</span>

    rpt_host = args.report_host
    <span class="hljs-comment"># 上报到本机客户端</span>
    <span class="hljs-keyword">if</span> rpt_host <span class="hljs-keyword">in</span> {<span class="hljs-string">'local'</span>, <span class="hljs-string">'localhost'</span>, <span class="hljs-string">'*'</span>, <span class="hljs-string">'-'</span>, <span class="hljs-string">'9311'</span>}:
        rpt_host = <span class="hljs-string">'127.0.0.1:9311'</span>
    run_in_one(bundle_id=args.bundle_id, gap=gap_ms, detail=args.detail, report_host=rpt_host, write_csv=args.csv)

</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[ooderAI： Agent管理平台开源设计]]></title>    <link>https://juejin.cn/post/7595911076014194724</link>    <guid>https://juejin.cn/post/7595911076014194724</guid>    <pubDate>2026-01-17T10:23:40.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7595911076014194724" data-draft-id="7595994039108485156" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="ooderAI： Agent管理平台开源设计"/> <meta itemprop="keywords" content="人工智能"/> <meta itemprop="datePublished" content="2026-01-17T10:23:40.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="OneCodeCN"/> <meta itemprop="url" content="https://juejin.cn/user/1427583415622366"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            ooderAI： Agent管理平台开源设计
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1427583415622366/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    OneCodeCN
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-17T10:23:40.000Z" title="Sat Jan 17 2026 10:23:40 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-17
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读13分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">引言：ooder开源的初心</h2>
<p>ooder 团队是一只对技术有着执着追求的团队，在Agent，Skill的高速发展的今天 ， 让我们坚信，AI大爆发的时代可能尽在眼前。但国内的环境与国外有很大的不同，特别是开源开放方面，壁垒非常高。即使拥有Skill 这样跨时代的技术出现仍然是很难以撼动国内IT各自为营的现状。经过认真的考虑我们决定开源我们内部协作使用的基于SpringCloud的分布式的SuperAgent平台。<strong>使用MIT协议，允许任意第三方针对协议、代码无限制修改、分发</strong>。而ooder 团队则会将更多的精力放到，基于ooder 开源协议的工具链以及Skill底层支持 的开发，会做强做好包括ooderA2UI,SkillFlow产品，同时会继续维护OneCode的代码升级。但因为时间和精力有限，我们除了将现有的Agent标准，Skill规范快速的纳入到我们支持范围，同时还面临强度不小的SuperAgent平台本身的开源重构整理，在后续的发布过程中我们将分步将协议和工程代码以及AI辅助的脚手架工程推出。开源版在重构过程中大量采用了AI来辅助甚至主导完成。但我们坚持所有的设计和测试人工审核会同步发布，不过也必须友情提醒，SuperAgent开源工程仅为开源协议的参考实现，直接商用需要做认真的评估。</p>
<p>我们希望参考版本可以节省后续的开发者在设计、规范方面投入更多的精力，努力做到开箱即用，同时也将致力于以下几点：</p>
<ol>
<li><strong>标准化SKILL开发</strong>：制定统一的SKILL开发规范，让AI能力的开发更加规范化</li>
<li><strong>规范化SKILL管理</strong>：建立统一的SKILL管理机制，让企业和个人能够更高效地管理和使用AI能力</li>
<li><strong>实现顺畅协作</strong>：构建A2A、A2P、A2U之间的协作框架，让AI能力能够无缝协作</li>
<li><strong>降低使用门槛</strong>：提供可视化的编排工具，让非技术人员也能轻松使用AI能力</li>
<li><strong>保护用户隐私</strong>：支持多种部署方式，确保用户数据的安全和隐私</li>
</ol>
<p>使得我们AIAgent 生态能更加健康发展。</p>
<p><strong>下面是正文是：</strong></p>
<p>企业和个人在使用AI能力时面临的诸多挑战：AI能力分散在不同平台、缺乏统一的管理机制、跨系统协作困难、个人AI工具无法有效整合等。SuperAgent诞生了，下文是一个简单的介绍：</p>
<h2 data-id="heading-1">1. 什么是ooder SuperAgent？</h2>
<p>ooder SuperAgent是一套基于MIT协议的开源企业级AI能力分发与自动化协作框架，它通过创新的Agent架构和SKILL管理机制，为企业提供了从简单任务到复杂流程的全场景自动化解决方案。</p>
<h2 data-id="heading-2">核心设计理念</h2>
<ol>
<li><strong>MCPAgent分发网络</strong>：企业/第三方系统可以将自己的MCPAgent接入AIServer，将AI能力通过SuperAgent分发；个人用户拥有专属MCPAgent，整合个人AI工具</li>
<li><strong>AI能力标准化</strong>：定义统一的AI能力接口规范，支持1:n Capability关系，实现AI能力的模块化设计</li>
<li><strong>跨域自动化编排</strong>：通过Skillflow可视化工具，实现跨企业/个人MCPAgent的工作流编排</li>
<li><strong>安全可靠的设计</strong>：基于RBAC的权限管理，支持多种部署方式，确保系统安全可靠</li>
</ol>
<h2 data-id="heading-3">2. SuperAgent企业总体结构</h2>
<p>SuperAgent企业总体结构由六大核心组件构成：<strong>Auth认证中心</strong>、<strong>DataServer数据中心</strong>、<strong>Skill能力管理中心</strong>、<strong>LLM调度中心</strong>、<strong>Skillflow调度中心</strong>和<strong>Agent协作层</strong>，形成完整的企业级AI能力协作生态。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7cc9f19382ca4b9bb3cfe24ad2981e8a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgT25lQ29kZUNO:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769250220&amp;x-signature=uhbeoEXstr5nOBpw5ZU7CwX%2Fmto%3D" alt="请在此添加图片描述" loading="lazy"/></p>
<h2 data-id="heading-4">2.1 核心组件详细描述</h2>
<h2 data-id="heading-5">2.1.1 Auth认证中心</h2>
<p><strong>核心职责</strong>：提供统一的身份认证和授权服务，确保系统安全可靠。</p>
<ul>
<li><strong>身份管理</strong>：用户、角色、权限的集中管理</li>
<li><strong>认证服务</strong>：支持OAuth 2.0、JWT、API Key等多种认证方式</li>
<li><strong>授权管理</strong>：基于RBAC的细粒度权限控制</li>
<li><strong>单点登录</strong>：支持企业内部系统的单点登录</li>
<li><strong>审计日志</strong>：完整的操作日志记录，便于合规审计</li>
</ul>
<h2 data-id="heading-6">2.1.2 DataServer数据中心</h2>
<p><strong>核心职责</strong>：统一管理企业数据，支持多种数据类型和存储方式。</p>
<ul>
<li><strong>数据存储</strong>：支持结构化、半结构化、非结构化数据存储</li>
<li><strong>数据处理</strong>：数据清洗、转换、集成等ETL操作</li>
<li><strong>数据分析</strong>：提供基础的数据分析能力</li>
<li><strong>数据安全</strong>：数据加密、脱敏、访问控制</li>
<li><strong>数据共享</strong>：支持跨系统的数据共享和交换</li>
<li><strong>数据生命周期管理</strong>：数据的创建、使用、归档、销毁全生命周期管理</li>
</ul>
<h2 data-id="heading-7">2.1.3 Skill能力管理中心</h2>
<p><strong>核心职责</strong>：统一管理SKILL的注册、分类、发现和调用。</p>
<ul>
<li><strong>SKILL注册</strong>：管理SKILL的注册和发布</li>
<li><strong>能力分类</strong>：基于CAT（Capability And Type）的SKILL分类机制</li>
<li><strong>能力发现</strong>：支持基于多种条件的SKILL发现</li>
<li><strong>版本管理</strong>：SKILL的版本控制和更新管理</li>
<li><strong>权限控制</strong>：基于RBAC的SKILL访问权限管理</li>
<li><strong>监控统计</strong>：SKILL的使用情况监控和统计分析</li>
</ul>
<h2 data-id="heading-8">2.1.4 LLM调度中心</h2>
<p><strong>核心职责</strong>：统一管理LLM资源，实现LLM的高效调度和管控。</p>
<ul>
<li><strong>LLM资源管理</strong>：管理外部LLM和本地LLM资源</li>
<li><strong>调度策略</strong>：基于数据敏感性、成本、性能等因素的智能调度</li>
<li><strong>成本控制</strong>：LLM调用的成本计算和预算控制</li>
<li><strong>频率限制</strong>：防止过度调用导致的资源浪费</li>
<li><strong>结果缓存</strong>：缓存LLM调用结果，提高响应速度</li>
<li><strong>质量监控</strong>：监控LLM输出质量，实现自动过滤和审核</li>
</ul>
<h2 data-id="heading-9">2.1.5 Skillflow调度中心</h2>
<p><strong>核心职责</strong>：统一管理Skillflow的定义、编排、执行和监控。</p>
<ul>
<li><strong>Skillflow定义</strong>：支持可视化和代码两种方式定义Skillflow</li>
<li><strong>工作流编排</strong>：基于DAG的工作流引擎，支持复杂的流程逻辑</li>
<li><strong>任务调度</strong>：支持定时触发、事件触发、手动触发等多种方式</li>
<li><strong>执行管理</strong>：工作流的执行、暂停、恢复、终止等操作</li>
<li><strong>状态监控</strong>：实时监控工作流的执行状态和进度</li>
<li><strong>历史记录</strong>：完整的工作流执行历史，便于审计和分析</li>
<li><strong>异常处理</strong>：工作流执行异常的自动处理和告警</li>
</ul>
<h2 data-id="heading-10">2.1.6 Agent协作层</h2>
<p><strong>核心职责</strong>：实现不同Agent之间的协作和通信，执行具体的业务流程。</p>
<ul>
<li><strong>MCPAgent</strong>：服务流入口，接收外部请求，协调其他Agent</li>
<li><strong>RouteAgent</strong>：负责桥接和转发，连接MCPAgent和EndAgent</li>
<li><strong>EndAgent</strong>：执行具体任务，调用SKILL完成业务逻辑</li>
<li><strong>Agent注册中心</strong>：管理所有Agent的注册、发现和状态</li>
</ul>
<h2 data-id="heading-11">3. MCPAgent分发网络</h2>
<p>SuperAgent的核心创新在于MCPAgent分发网络，它允许企业/第三方系统和个人用户将自己的MCPAgent接入SuperAgent企业核心层，实现AI能力的统一分发和编排。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b97e78219ed54dcd8458e97a88c75862~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgT25lQ29kZUNO:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769250220&amp;x-signature=E8%2Fs8OFzVPO5ns6%2FqmH3n0hPkoo%3D" alt="请在此添加图片描述" loading="lazy"/></p>
<h2 data-id="heading-12">4. 核心概念与能力</h2>
<h2 data-id="heading-13">4.1 1:n Capability关系</h2>
<p>SuperAgent支持1:n Capability关系，一个SKILL可以提供多个能力，实现AI能力的模块化设计：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7833f69af2774effb529ffd442416ada~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgT25lQ29kZUNO:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769250220&amp;x-signature=NEegbNVcF44%2BcqNcGGSCW%2BN7mIA%3D" alt="请在此添加图片描述" loading="lazy"/></p>
<h2 data-id="heading-14">4.2 Skillflow自动化编排</h2>
<p>通过Skillflow可视化工具，用户可以轻松设计从简单到复杂的工作流，由Skillflow调度中心负责执行和监控：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cf159204ffc34783b5ae68633791ab6c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgT25lQ29kZUNO:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769250220&amp;x-signature=bA6I1bB1%2F9jxCqUMIqug%2BveqnRk%3D" alt="请在此添加图片描述" loading="lazy"/></p>
<h2 data-id="heading-15">5. 企业核心组件使用指南</h2>
<h2 data-id="heading-16">5.1 Auth认证中心使用</h2>
<p><strong>主要功能</strong>：统一身份管理和权限控制</p>
<ul>
<li><strong>企业SSO集成</strong>：</li>
</ul>
<ol>
<li>在Auth认证中心配置企业域</li>
<li>配置企业现有系统的SSO对接</li>
<li>用户通过企业账号登录SuperAgent</li>
<li>实现企业内部系统的无缝访问</li>
</ol>
<ul>
<li><strong>权限管理</strong>：</li>
</ul>
<ol>
<li>创建企业角色和权限组</li>
<li>为不同部门配置不同权限</li>
<li>实现基于角色的SKILL访问控制</li>
<li>监控和审计权限使用情况</li>
</ol>
<h2 data-id="heading-17">5.2 DataServer数据中心使用</h2>
<p><strong>主要功能</strong>：统一数据存储和管理</p>
<ul>
<li><strong>数据集成</strong>：</li>
</ul>
<ol>
<li>配置数据源连接（数据库、文件系统、API等）</li>
<li>设计数据ETL流程</li>
<li>实现数据的自动同步和更新</li>
<li>确保数据一致性和完整性</li>
</ol>
<ul>
<li><strong>数据安全</strong>：</li>
</ul>
<ol>
<li>配置数据加密策略</li>
<li>实现数据脱敏规则</li>
<li>配置数据访问权限</li>
<li>监控数据访问日志</li>
</ol>
<h2 data-id="heading-18">5.3 Skill能力管理中心使用</h2>
<p><strong>主要功能</strong>：SKILL注册、管理和发现</p>
<ul>
<li><strong>SKILL注册</strong>：</li>
</ul>
<ol>
<li>开发SKILL并通过AIServer认证</li>
<li>在Skill能力管理中心注册SKILL</li>
<li>配置SKILL的CAT分类和权限</li>
<li>发布SKILL到企业SKILL库</li>
</ol>
<ul>
<li><strong>SKILL管理</strong>：</li>
</ul>
<ol>
<li>监控SKILL的使用情况</li>
<li>管理SKILL的版本更新</li>
<li>配置SKILL的访问权限</li>
<li>统计SKILL的性能指标</li>
</ol>
<h2 data-id="heading-19">5.4 LLM调度中心使用</h2>
<p><strong>主要功能</strong>：LLM资源管理和调度</p>
<ul>
<li><strong>LLM资源配置</strong>：</li>
</ul>
<ol>
<li>配置外部LLM API（如OpenAI、阿里云AI等）</li>
<li>配置本地LLM资源（如开源模型部署）</li>
<li>设置LLM调用的成本预算</li>
<li>配置LLM调用的频率限制</li>
</ol>
<ul>
<li><strong>LLM调度策略</strong>：</li>
</ul>
<ol>
<li>基于数据敏感性选择LLM（外部/本地）</li>
<li>配置LLM调用的负载均衡</li>
<li>实现LLM结果的自动过滤</li>
<li>监控LLM调用的质量和成本</li>
</ol>
<h2 data-id="heading-20">5.5 Skillflow调度中心使用</h2>
<p><strong>主要功能</strong>：Skillflow定义、编排和执行</p>
<ul>
<li><strong>Skillflow设计</strong>：</li>
</ul>
<ol>
<li>使用可视化工具设计Skillflow</li>
<li>配置触发条件和执行逻辑</li>
<li>选择所需的SKILL和Agent</li>
<li>设置错误处理和重试策略</li>
</ol>
<ul>
<li><strong>Skillflow管理</strong>：</li>
</ul>
<ol>
<li>管理Skillflow的版本</li>
<li>监控Skillflow的执行状态</li>
<li>手动控制Skillflow的执行</li>
<li>分析Skillflow的执行效率</li>
<li>配置Skillflow的通知规则</li>
</ol>
<ul>
<li><strong>Skillflow执行</strong>：</li>
</ul>
<ol>
<li>自动触发或手动启动Skillflow</li>
<li>实时监控执行进度</li>
<li>处理执行过程中的异常</li>
<li>生成执行报告和日志</li>
</ol>
<h2 data-id="heading-21">6. 典型应用场景</h2>
<h2 data-id="heading-22">6.1 企业场景：跨系统AI能力协作</h2>
<h2 data-id="heading-23">场景描述</h2>
<p>企业用户通过Skillflow整合OA系统的文档处理AI、CRM系统的客户分析AI和ERP系统的数据分析AI，实现自动化的客户报告生成流程。</p>
<h2 data-id="heading-24">使用流程</h2>
<ol>
<li><strong>Auth认证</strong>：用户通过企业SSO登录SuperAgent</li>
<li><strong>MCPAgent接入</strong>：企业IT部门将OA、CRM、ERP系统的MCPAgent接入企业核心层</li>
<li><strong>SKILL注册</strong>：在Skill能力管理中心注册各系统的AI能力</li>
<li><strong>LLM配置</strong>：在LLM调度中心配置所需的LLM资源</li>
<li><strong>Skillflow设计</strong>：业务用户使用Skillflow编辑器设计"客户报告自动生成"工作流：</li>
</ol>
<ul>
<li>触发条件：CRM系统中客户状态变更</li>
<li>执行步骤： a. 调用OA AI生成客户相关文档摘要 b. 调用CRM AI分析客户行为数据 c. 调用ERP AI生成客户交易报告 d. 调用LLM调度中心生成完整客户报告 e. 自动发送给相关人员</li>
</ul>
<ol>
<li><strong>Skillflow执行</strong>：Skillflow调度中心负责执行和监控工作流</li>
<li><strong>数据存储</strong>：所有数据和执行结果存储到DataServer</li>
<li><strong>监控审计</strong>：通过监控系统查看工作流执行状态和审计日志</li>
</ol>
<h2 data-id="heading-25">6.2 个人场景：个人AI工具整合</h2>
<h2 data-id="heading-26">场景描述</h2>
<p>个人用户通过个人MCPAgent整合常用AI工具，实现自动化的工作提效流程。</p>
<h2 data-id="heading-27">使用流程</h2>
<ol>
<li><strong>Auth认证</strong>：个人用户注册并登录SuperAgent</li>
<li><strong>MCPAgent初始化</strong>：创建个人MCPAgent</li>
<li><strong>SKILL集成</strong>：在Skill能力管理中心发现并添加所需的个人AI工具</li>
<li><strong>LLM配置</strong>：在LLM调度中心配置个人LLM资源</li>
<li><strong>Skillflow设计</strong>：创建"会议助手"工作流：</li>
</ol>
<ul>
<li>触发条件：日历会议结束</li>
<li>执行步骤： a. 调用会议录音AI转写会议内容 b. 调用LLM生成会议摘要和行动项 c. 自动更新笔记系统 d. 将行动项添加到日历 e. 发送邮件通知相关人员</li>
</ul>
<ol>
<li><strong>Skillflow执行</strong>：Skillflow调度中心负责执行和监控工作流</li>
<li><strong>执行与监控</strong>：用户通过控制台监控执行状态</li>
</ol>
<h2 data-id="heading-28">7. OODER开源协议目录</h2>
<h2 data-id="heading-29">7.1 第三方系统MCPAgent接入文档</h2>
<ul>
<li><strong>文档简介</strong>：指导第三方系统如何将自己的MCPAgent接入SuperAgent企业核心层，实现AI能力的分发和调用</li>
<li><strong>接入流程</strong>：注册凭证获取 → 网络配置 → MCPAgent部署 → 系统接入 → 测试验证 → 上线运行</li>
<li><strong>关键特性</strong>：支持多种部署方式、提供完整的API文档、支持版本管理、提供SDK支持</li>
<li><strong>适用场景</strong>：企业系统AI能力外部分发、第三方服务集成、自定义AI能力开放</li>
</ul>
<h2 data-id="heading-30">7.2 Skill设计规范</h2>
<ul>
<li><strong>Skill开放能力设计</strong>：</li>
<li>支持1:n Capability关系</li>
<li>静态定义原则，开发完成后不可修改</li>
<li>统一的接口规范，支持RESTful API和gRPC</li>
<li>完整的权限控制机制</li>
<li><strong>LLM调用规范</strong>：</li>
<li>支持外部LLM和本地LLM调用</li>
<li>统一的LLM调用接口，封装不同LLM的差异</li>
<li>支持基于数据敏感性的LLM选择策略</li>
<li>实现LLM调用的成本控制和频率限制</li>
<li>支持LLM结果的过滤和审核</li>
</ul>
<h2 data-id="heading-31">7.3 Agent接入规范</h2>
<ul>
<li><strong>内部Agent通讯协议</strong>：</li>
<li>基于gRPC的高效二进制通信</li>
<li>支持TLS/SSL加密</li>
<li>内置心跳机制和断线重连</li>
<li>统一的消息格式和序列化机制</li>
<li><strong>Agent角色</strong>：</li>
<li><strong>MCPAgent</strong>：服务流入口，管理和协调其他Agent</li>
<li><strong>RouteAgent</strong>：桥接转发，连接MCPAgent和EndAgent</li>
<li><strong>EndAgent</strong>：功能执行，调用SKILL完成具体任务</li>
<li><strong>Agent接入流程</strong>：</li>
<li>自动发现MCPAgent服务</li>
<li>动态分配RouteAgent</li>
<li>自动注册Capability信息</li>
<li>支持批量入网</li>
</ul>
<h2 data-id="heading-32">7.4 Skillflow设计规范</h2>
<ul>
<li><strong>Skillflow定义</strong>：</li>
<li>基于DAG的工作流定义</li>
<li>支持多种触发条件</li>
<li>灵活的执行逻辑（顺序、并行、条件分支、循环）</li>
<li>完整的错误处理机制</li>
<li><strong>Skillflow执行</strong>：</li>
<li>支持同步和异步执行</li>
<li>支持断点续传</li>
<li>实时状态监控</li>
<li>完整的执行日志</li>
</ul>
<h2 data-id="heading-33">8. 加入OODER开源社区</h2>
<p>ooder SuperAgent项目采用<strong>MIT开源协议</strong>，欢迎企业和个人自由使用、修改和分发。我们欢迎社区的参与和贡献，共同构建一个强大的AI能力分发生态。</p>
<h2 data-id="heading-34">开源资源</h2>
<ul>
<li><strong>核心文档</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgitee.com%2FooderCN%2Fsuper-agent.git" target="_blank" title="https://gitee.com/ooderCN/super-agent.git" ref="nofollow noopener noreferrer">gitee.com/ooderCN/sup…</a></li>
</ul>
<h2 data-id="heading-35">开发支持</h2>
<ul>
<li>包含完整的SKILL开发示例</li>
<li>提供SKILL开发和调试工具</li>
</ul>
<h2 data-id="heading-36">关注OODER公众号</h2>
<p><strong>OODER开源</strong>公众号是SuperAgent项目的唯一首发渠道，我们将在公众号上发布：</p>
<ul>
<li>项目最新进展和版本更新</li>
<li>详细的技术文档和教程</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[taro项目踩坑指南——（一）]]></title>    <link>https://juejin.cn/post/7595994039108501540</link>    <guid>https://juejin.cn/post/7595994039108501540</guid>    <pubDate>2026-01-17T10:27:29.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7595994039108501540" data-draft-id="7594627998852300806" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="taro项目踩坑指南——（一）"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2026-01-17T10:27:29.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Snack"/> <meta itemprop="url" content="https://juejin.cn/user/3423212600562768"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            taro项目踩坑指南——（一）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3423212600562768/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Snack
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-17T10:27:29.000Z" title="Sat Jan 17 2026 10:27:29 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-17
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h3 data-id="heading-0">自定义导航栏</h3>
<p>在开发小程序的时候没有使用开发者工具，用的H5。想要有一个自定义的底部导航栏，所以就尝试了一下taro中的自定义导航栏。结果配置之后，直接让页面显示不出来内容了。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ef5992b6d6214917bca96f68a469b5e1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU25hY2s=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769250448&amp;x-signature=LDLTKggX6uh15gFKSHBcVaFz2lM%3D" alt="image.png" loading="lazy"/></p>
<p>随后查询官网后，自定义导航栏好像只支持微信小程序的。H5的应该是没有的，把这段代码删掉之后就可以正常显示了。好烦！！！</p>
<p>在自定义导航栏时，应该由导航栏组件自行控制页面的变更和导航栏的状态变化。在<code>taro</code>中使用<code>useDidShow</code>这个生命周期<code>Hook</code>，通过页面显示，判断当前路由，并根据当前路由设置<code>activeTab</code>。在点击导航栏跳转页面时，使用<code>redirectTo</code>进行跳转。</p>
<pre><code class="hljs language-JavaScript" lang="JavaScript">  <span class="hljs-title function_">useDidShow</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">const</span> pages = <span class="hljs-title class_">Taro</span>.<span class="hljs-title function_">getCurrentPages</span>();
    <span class="hljs-keyword">const</span> current = pages[pages.<span class="hljs-property">length</span> - <span class="hljs-number">1</span>];
    <span class="hljs-keyword">const</span> route = current.<span class="hljs-property">route</span>;
    <span class="hljs-keyword">const</span> matched = tabList.<span class="hljs-title function_">find</span>(<span class="hljs-function">(<span class="hljs-params">tab</span>) =&gt;</span> tab.<span class="hljs-property">pagePath</span> === route);
    <span class="hljs-keyword">if</span> (matched) {
      <span class="hljs-title function_">setActiveTab</span>(matched.<span class="hljs-property">id</span>);
    }
  });

  <span class="hljs-keyword">const</span> <span class="hljs-title function_">switchTab</span> = (<span class="hljs-params">tab</span>) =&gt; {
    <span class="hljs-keyword">if</span> (activeTab !== tab.<span class="hljs-property">id</span>) {
      <span class="hljs-title class_">Taro</span>.<span class="hljs-title function_">redirectTo</span>({ <span class="hljs-attr">url</span>: tab.<span class="hljs-property">pagePath</span> });
    }
  };
</code></pre>
<h3 data-id="heading-1">页面报错或者无渲染</h3>
<p>页面报错类型</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c230b01d0c2746ac9ac872e99ba39d5b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU25hY2s=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769250448&amp;x-signature=5aHlBwPVSud2259ckN5Qik8QNRY%3D" alt="image.png" loading="lazy"/></p>
<p>这通常是因为Taro无法识别到正确的页面组件。当使用react进行开发时，成为页面的那个组件需要默认导出
<code>export default functoin Index(){return &lt;&gt;&lt;/&gt;}</code>并且要在<code>app.config.ts</code>中配置正确的路由信息。</p>
<p>如果出现页面白屏没有节点渲染并且控制台没有出现报错的情况，这可能是因为组件需要接收的外部组件传来的数据为空或者是属性不匹配导致的。在使用的时候需要注意组件中的数据安全兜底，进行判空。</p>
<pre><code class="hljs language-react" lang="react">// 如果外部组件没有传入post，那么就不会渲染到页面上。（这是一个嵌入到页面中的组件）
export function Index(post){
    return (
        &lt;div&gt;{post.msg}&lt;/div&gt;
    )
}
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[用 Cherry Markdown 打造丝滑的 AI 对话体验：流式渲染完全指南]]></title>    <link>https://juejin.cn/post/7595847940621697074</link>    <guid>https://juejin.cn/post/7595847940621697074</guid>    <pubDate>2026-01-17T08:46:35.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7595847940621697074" data-draft-id="7595842144906805298" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="用 Cherry Markdown 打造丝滑的 AI 对话体验：流式渲染完全指南"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2026-01-17T08:46:35.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="小时前端"/> <meta itemprop="url" content="https://juejin.cn/user/1197805741808339"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            用 Cherry Markdown 打造丝滑的 AI 对话体验：流式渲染完全指南
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1197805741808339/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    小时前端
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-17T08:46:35.000Z" title="Sat Jan 17 2026 08:46:35 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-17
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{position:relative;word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden;color:#333}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:30px;margin-bottom:5px}.markdown-body h2{font-size:24px;display:inline-block;font-weight:700;background:#ef7060;color:#fff;padding:6px 8px 0 0;border-top-right-radius:6px;margin-right:2px;box-shadow:6px 3px 0 0 rgba(239,112,96,.2)}.markdown-body h2:before{content:" ";display:inline-block;width:8px}.markdown-body h2:after{content:" ";position:absolute;display:block;width:calc(100% - 50px);border-bottom:3px solid #ef7060}.markdown-body h3{font-size:18px;padding-bottom:0}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:15px}.markdown-body h6{margin-top:5px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #3e3e3e;margin-top:32px;margin-bottom:32px;height:1px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:rgba(27,31,35,.05);color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:JetBranins Mono,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75;box-shadow:0 0 8px hsla(0,0%,43.1%,.45);border-radius:4px;margin:16px}.markdown-body pre:before{content:"";display:block;height:30px;width:100%;margin-bottom:-7px;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAAAdCAYAAABcz8ldAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAhgSURBVGhD7Zp7bBTHHcdn33t7vvOdzy+ITVKDU0xIKG2ABCPTRCCaUiEVKWoqRJuASAhCitRCVKSoalFUKZBiSmmFRRJKRUnUtIpo+aNqGgwoOCmuFUIRzxjwE4zte+97drYzztji8HPvtkit/PnH+n1397Tz+83vN/PbMZhmmmmm+d+BoX8n5diihcGqgFQf5vk6BMAskWUlw3GyFnIvtqWSf91w7mKC3npfOLX7wYeiIa6BBWCOLLFRF2NB0JvIOP/80YG+k2ev6S699b/OzOfKBW5l5KsgyC4DCFQDnpEAdE1goc/dlNPc/Up7P711UiYNSMuyxeUzZPnHgGHWh5XADEkSAcdiN+AnEXIBhBComgFU0/xQR+jnj51sOUMf9Z0NKyL8S9+JPBEN8zuCMrsqGOA5QWAAyzLAxe53HBeYFgJp1c5Cx33nyIfpV3e+22/Sx32nev/sMCgVnmM4bjOniAtZWQAsz315EfsGQQc4hgWcjHkCmOj1rheuNn95cXwmDMiVp5etC/D8m5FwUWVQUYYGPh6mZYFUOgsGVa1pXvOZzVT2jRuH54RM230jEuI3RcIiL4l4UkxAJmuD/riVsqD7ct2m9nep7BtVTbVfZ0uE/UIk+CQflAHDjf8+Lg6MldYATGpH3c/Ul7p3dWXppVGM6eElJSHmnQWPbSlRlN1lJcUBjqNRnwJZVQO3B5P/uq5rK1d90pakckFcaKp5UJHY92JR8YlwkUDVySEZfGfQdO7E7Z8s2HL9TSoXTPXRud9nA8IBqSwcZgWeqpPj6BYw7yTbXBN9q2v9lQEq5zBmWA8vWLCptCi4tzwW8RQMQlFQATPLSh6vCSh/plJBkMyQBHZfWYnkKRgEktEVpTJXERN2Xzo4ex2VC6K6qXYpF5b3ypVRT8EgcAERSJXRbwCBOTFzXblM5RxGBaRt+ZPYA+LO0mgxz5K1Ig+UgAzKIuGnz39z6S+olDeaibaXRsU1RUFvgx+GwTWgPCaDgMw2XXpr9gwq50XV0bkxJiYeEiNF5cwE5XsiOEkAUkXkUW51SSOVchjl8WKef604XFSRbzCGCYeCoESStv/p8QU1VPIM3knNDynctnBRfsEYhgSlNCIGgQv2UCkvGIHZgteMh1nBW9W4F16RAM6yDVV7amZTaYQcr59cuuhhWRTWBvAMLxQGeyFSHOLnh0MvUskz5RF+fbRYDEy0mZgqQYUHOLhr//b6rGoqeaLqQG0pw3PrBbyA+4EQUkRmhvgqNUfICUipKK4OKUqIJVPKB0jpEhjmWWp64jdbKmVZZNYogcJm493gsifOqhDyeh9GYR/FM7sW+DA5CKR0MSK3tvKZkpwB5gRE4tjFEr7RL0iWBGV51vHFCyupNGWWPqLgnoer9mtyEGSJAzwLllDTGzyznDjRN/CwOFkoFb4bm0eVIXICgpvdGoEvrF7fC89zfLkkeV5HbOhWiTwTpKYvCAJLGshRdXtKMKAWlyxq+MPQLk1h66g5RE5ABJYNFrqY3wvJklJRUKg5ZWLFXIA86yek2uDOPkBNb3CM5Pf7DL2QyIrUGiLH+xC5Bmmm/ARnHUhC6PnzxWDK0RH5HuIjZGy27erU9AZ0dTIWXyG+NpBBrSFySxZw220IqeUPFoS6jVAPNadM7yDsgNB1qOkLuAziMYIb1PQGA75wIaKGPyAb+9oF16g5RE5ALIQ+tSyLWoWDEAK6aXW3JlK9VJoyx1oyvVkNdvo5KXXDAVkdnaKmNwx0xjH98w3JNmTCm+Bc9hKVhsgJSI9pvp9Vdd++jmq6AXB2/HHrhcs5aTkVDv0DFzoHvKdq/mQsKX/4t7KJLDpOJW+IbAvMGoMkxfwAWZB8DT7W1diTE+WcgKz6pK1bs6z3daPwmJDsSKt6ZsCyjlLJMz0DsDGZ8SdlDROBjOb8YeWOjptU8kTXusuaazu7oJrfEnQvdkpVcUn6PTVHyAkIIW7br/Unklni0EJIZ1WgGsauZR+fvUglz6zY0dGfVp09ybRNlfwgi3k8YSbvJJ29VMoLt9v6rZVQL7hOYUubndHJGclBtzn1byqNMCogi09/2nFb01/oj+f/5TyjauBOKtPcZ1r7qZQ3f2lRfxZPWi2anp8TSDAGExZMa2jr8u03L1M5L7q3Xc+iAeuHRl/ScvPcjSLDBnZS/cjtNHd2v3171Ewbs9N5q7Pn4otVMx3btBsCsoRbk1FxG5dMVgMDqfTpXl1/tuFMa5zKefPROdX59qLQBwLnNog8Wy1OcjB1N+QEsW/QsFNZuO35Xb1v98QLX4/Sx+O3wqujrQ6013ABUWI8+AaqBjAH01+ghL22+5X2PirnMG7r+esbnae/V1neauvGSoHjigTcVU7UGFm2DeK4ttxKpQ+mLPvl+o/PjnkAkw9HTqSMmVHhyAMx9iFcSh/BHTfLceO/C8mKjApBf9zszGhoY92m9sN+BGOY9AeD7eGniv8OTaOB4dgyTsQd9wS+IQu4lciYdkI7CLrNH3Rvbb9FL41i0tbzVP2iWJkobpN5fmM4IJfJskTP1Bk8A9HQmbpmGDBrWqdVCN/Yd7PjxKGOXn+bmbto3feVVcVB9qehIL8EJy8nChwgr0O2xxBnhGU5eP2CfYbl/m4gBRsbtneMORP9oGpjpcCsiKzHHfdOPiQ/wMniyFEu2dbiTQCAeN/vavC466BGYLttXc9fmXBXMGlAhiHHur+sq6uPiUI9z7CVHMPwBnLSuuN8FuC48/Oaz1ylt94XfrW5ouyprwWfYRkwNyCyYYjwkBHows1fa+tV/fzGxlv39b9gqvfPmQ+i/HK8KlcBjhHwfl8HEHyOd1JnuzZd66S3TTPNNNP8/wDAfwDG7G0m9LKBpwAAAABJRU5ErkJggg==) 10px 10px no-repeat;background-size:40px;background-color:#fdfdfd}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#fdfdfd}.markdown-body a{text-decoration:none;font-weight:700;color:#ef7060;border-bottom:1px solid #ef7060}.markdown-body a:active,.markdown-body a:hover{color:#ef2d26}.markdown-body table tr td,.markdown-body table tr th{border:1px solid #ccc;padding:5px 10px}.markdown-body table{display:block!important;width:auto;max-width:100%;overflow:auto;border-collapse:collapse}.markdown-body thead{background:#f0f0f0;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#f8f8f8}.markdown-body blockquote{margin-inline-start:0;margin-inline-end:0;border-left:3px solid #ef7060;background:#fff9f9;padding:1px 20px;margin-top:20px}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="atom-one-light">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#383a42;background:#fafafa}.hljs-comment,.hljs-quote{color:#a0a1a7;font-style:italic}.hljs-doctag,.hljs-formula,.hljs-keyword{color:#a626a4}.hljs-deletion,.hljs-name,.hljs-section,.hljs-selector-tag,.hljs-subst{color:#e45649}.hljs-literal{color:#0184bb}.hljs-addition,.hljs-attribute,.hljs-meta-string,.hljs-regexp,.hljs-string{color:#50a14f}.hljs-built_in,.hljs-class .hljs-title{color:#c18401}.hljs-attr,.hljs-number,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-pseudo,.hljs-template-variable,.hljs-type,.hljs-variable{color:#986801}.hljs-bullet,.hljs-link,.hljs-meta,.hljs-selector-id,.hljs-symbol,.hljs-title{color:#4078f2}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}.hljs-link{text-decoration:underline}</style><h2 data-id="heading-0">一、引言：AI 对话时代的 Markdown 渲染痛点</h2>
<h3 data-id="heading-1">1.1 ChatGPT 们的"打字机效果"是怎么实现的？</h3>
<p>当你与 ChatGPT、Claude 或文心一言对话时，是否注意到 AI 的回复会像真人打字一样，一个字一个字地"流"出来？这种流畅的体验背后，隐藏着一个技术难题：<strong>如何在流式输出过程中，实时渲染 Markdown 格式，而不露出丑陋的源码？</strong></p>
<p>传统的 Markdown 渲染器在流式场景下往往会"翻车"：</p>
<ul>
<li>代码块写到一半，用户看到的是 <code>\</code>``python\ndef hello(` 这样的源码</li>
<li>表格只输出了第一行，页面显示的是 <code>| 列1 | 列2 |</code> 这样的原始语法</li>
<li>数学公式还没写完，屏幕上出现 <code>$E = mc^</code> 这样的半成品</li>
</ul>
<h3 data-id="heading-2">1.2 传统 Markdown 渲染器的"翻车现场"</h3>
<p>让我们看一个典型的翻车案例：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// ❌ 传统方式：直接渲染不完整的 Markdown</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">streamOutput</span>(<span class="hljs-params">text</span>) {
  <span class="hljs-keyword">let</span> index = <span class="hljs-number">0</span>;
  <span class="hljs-built_in">setInterval</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">const</span> partial = text.<span class="hljs-title function_">substring</span>(<span class="hljs-number">0</span>, index++);
    <span class="hljs-title function_">renderMarkdown</span>(partial);  <span class="hljs-comment">// 问题：不完整的语法会显示源码</span>
  }, <span class="hljs-number">30</span>);
}

<span class="hljs-comment">// 当输出到 "```python\ndef" 时，页面显示：</span>
<span class="hljs-comment">// ```python</span>
<span class="hljs-comment">// def</span>
<span class="hljs-comment">// 而不是渲染后的代码块样式</span>
</code></pre>
<p>这就是为什么很多 AI 对话产品要么：</p>
<ul>
<li>等 AI 全部输出完再一次性渲染（失去了流式体验）</li>
<li>或者干脆不支持 Markdown，只用纯文本（功能受限）</li>
</ul>
<h3 data-id="heading-3">1.3 Cherry Markdown 的解决方案：智能自动补全</h3>
<p><strong>Cherry Markdown</strong>（<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FTencent%2Fcherry-markdown" target="_blank" title="https://github.com/Tencent/cherry-markdown" ref="nofollow noopener noreferrer">GitHub 项目地址</a>）是一款由腾讯开源的 JavaScript Markdown 编辑器，它就像一位贴心的"语法助手"，专门为 AI 流式输出场景设计了智能补全机制。</p>
<p>想象一下，当 AI 正在逐字输出代码块时，Cherry Markdown 会"聪明地"识别出这是一个未完成的代码块，然后自动帮你补全闭合标记。这样，用户看到的永远是渲染后的漂亮代码样式，而不是尴尬的 <code>\</code>``python\ndef` 这样的源码片段。</p>
<p>Cherry Markdown 会自动识别未闭合的 Markdown 语法，并临时补全，确保在流式输出过程中始终显示渲染后的效果，而不是源码。简单来说，它让 AI 的"打字机效果"变得专业又优雅！✨</p>
<p>开启流式渲染后，Cherry 会对以下 12 种语法进行自动补全：</p>
<ul>
<li>✅ 标题（<code># H1</code>、<code>## H2</code> 等）</li>
<li>✅ 加粗、斜体（<code>**粗体**</code>、<code>*斜体*</code>）</li>
<li>✅ 超链接（<code>[文本](url)</code>）</li>
<li>✅ 图片、音视频（<code>![alt](url)</code>）</li>
<li>✅ 行内代码块（<code>`code`</code>）</li>
<li>✅ 段落代码块（<code>```code```</code>）</li>
<li>✅ 行内公式（<code>$formula$</code>）</li>
<li>✅ 段落公式（<code>$$formula$$</code>）</li>
<li>✅ 无序列表（<code>- item</code>）</li>
<li>✅ 表格（<code>| col1 | col2 |</code>）</li>
<li>✅ mermaid 画图（<code>```mermaid ```</code>）</li>
<li>✅ 脚注（<code>[^1]</code>）</li>
</ul>
<h2 data-id="heading-4">二、快速上手：5 分钟搭建 AI 对话界面</h2>
<h3 data-id="heading-5">2.1 最小可用代码</h3>
<p>让我们用最少的代码，搭建一个支持流式渲染的 AI 对话界面：</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">html</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">"UTF-8"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>AI 对话流式渲染示例<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">link</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"https://cdn.jsdelivr.net/npm/cherry-markdown/dist/cherry-markdown.min.css"</span> <span class="hljs-attr">rel</span>=<span class="hljs-string">"stylesheet"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">style</span>&gt;</span><span class="css">
    <span class="hljs-selector-id">#chat-container</span> {
      <span class="hljs-attribute">max-width</span>: <span class="hljs-number">800px</span>;
      <span class="hljs-attribute">margin</span>: <span class="hljs-number">50px</span> auto;
      <span class="hljs-attribute">padding</span>: <span class="hljs-number">20px</span>;
      <span class="hljs-attribute">background</span>: <span class="hljs-number">#f5f5f5</span>;
      <span class="hljs-attribute">border-radius</span>: <span class="hljs-number">8px</span>;
    }
  </span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"chat-container"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
  
  <span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"https://cdn.jsdelivr.net/npm/cherry-markdown/dist/cherry-markdown.min.js"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
    <span class="hljs-comment">// 🔑 关键配置：开启流式渲染</span>
    <span class="hljs-keyword">const</span> cherry = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Cherry</span>({
      <span class="hljs-attr">el</span>: <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'chat-container'</span>),
      <span class="hljs-attr">editor</span>: {
        <span class="hljs-attr">height</span>: <span class="hljs-string">'auto'</span>,
        <span class="hljs-attr">defaultModel</span>: <span class="hljs-string">'previewOnly'</span>,  <span class="hljs-comment">// 纯预览模式，无编辑区</span>
      },
      <span class="hljs-attr">engine</span>: {
        <span class="hljs-attr">global</span>: {
          <span class="hljs-attr">flowSessionContext</span>: <span class="hljs-literal">true</span>,     <span class="hljs-comment">// 开启流式渲染</span>
          <span class="hljs-attr">flowSessionCursor</span>: <span class="hljs-string">'default'</span>, <span class="hljs-comment">// 显示打字光标效果</span>
        },
      },
      <span class="hljs-attr">previewer</span>: {
        <span class="hljs-attr">enablePreviewerBubble</span>: <span class="hljs-literal">false</span>,   <span class="hljs-comment">// 关闭预览区编辑功能</span>
      },
    });

    <span class="hljs-comment">// 模拟 AI 流式输出</span>
    <span class="hljs-keyword">const</span> aiResponse = <span class="hljs-string">`### 你好！我是 AI 助手

这是一段**加粗文字**和*斜体文字*的演示。

代码示例：

\`\`\`python
def hello():
    print("Hello, World!")
\`\`\`

数学公式：$E = mc^2$
`</span>;

    <span class="hljs-keyword">let</span> index = <span class="hljs-number">0</span>;
    <span class="hljs-keyword">function</span> <span class="hljs-title function_">streamOutput</span>(<span class="hljs-params"/>) {
      <span class="hljs-keyword">if</span> (index &lt; aiResponse.<span class="hljs-property">length</span>) {
        cherry.<span class="hljs-title function_">setMarkdown</span>(aiResponse.<span class="hljs-title function_">substring</span>(<span class="hljs-number">0</span>, index + <span class="hljs-number">1</span>));
        index++;
        <span class="hljs-built_in">setTimeout</span>(streamOutput, <span class="hljs-number">30</span>);  <span class="hljs-comment">// 每 30ms 输出一个字符</span>
      }
    }
    
    <span class="hljs-title function_">streamOutput</span>();
  </span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span>
</code></pre>
<p>将上述代码保存为 HTML 文件，在浏览器中打开，你就能看到 AI 逐字输出的效果，而且 Markdown 语法会实时渲染，不会露出源码！</p>
<h3 data-id="heading-6">2.2 关键配置项详解</h3>
<p>让我们详细解释一下每个配置项的作用：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> cherry = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Cherry</span>({
  <span class="hljs-attr">el</span>: <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'chat-container'</span>),
  
  <span class="hljs-comment">// 📝 编辑器配置</span>
  <span class="hljs-attr">editor</span>: {
    <span class="hljs-attr">height</span>: <span class="hljs-string">'auto'</span>,              <span class="hljs-comment">// 高度自适应内容</span>
    <span class="hljs-attr">defaultModel</span>: <span class="hljs-string">'previewOnly'</span>,  <span class="hljs-comment">// 纯预览模式（AI 对话不需要编辑功能）</span>
  },
  
  <span class="hljs-comment">// ⚙️ 引擎配置（核心）</span>
  <span class="hljs-attr">engine</span>: {
    <span class="hljs-attr">global</span>: {
      <span class="hljs-comment">// 🔑 开启流式渲染模式</span>
      <span class="hljs-attr">flowSessionContext</span>: <span class="hljs-literal">true</span>,
      
      <span class="hljs-comment">// 🔑 虚拟光标配置</span>
      <span class="hljs-comment">// - "default": 使用默认光标样式（推荐）</span>
      <span class="hljs-comment">// - "": 不显示光标</span>
      <span class="hljs-comment">// - "&lt;span class='custom'&gt;|&lt;/span&gt;": 自定义光标 HTML</span>
      <span class="hljs-attr">flowSessionCursor</span>: <span class="hljs-string">'default'</span>,
    },
  },
  
  <span class="hljs-comment">// 👁️ 预览器配置</span>
  <span class="hljs-attr">previewer</span>: {
    <span class="hljs-attr">enablePreviewerBubble</span>: <span class="hljs-literal">false</span>,  <span class="hljs-comment">// 关闭预览区的编辑气泡（AI 场景不需要）</span>
  },
});
</code></pre>
<h3 data-id="heading-7">2.3 效果预览：开启 vs 关闭流式适配对比</h3>






























<table><thead><tr><th>场景</th><th>关闭流式适配</th><th>开启流式适配</th></tr></thead><tbody><tr><td>代码块写到一半</td><td>显示 <code>\</code>``python\ndef`</td><td>自动补全，显示代码块样式</td></tr><tr><td>表格只输出一行</td><td>显示 <code>| col1 | col2 |</code></td><td>自动补全表格结构</td></tr><tr><td>公式未完成</td><td>显示 <code>$E = mc^</code></td><td>等待公式完整后再渲染</td></tr><tr><td>渲染频率</td><td>最快 50ms</td><td>最快 10ms（快 5 倍）</td></tr></tbody></table>
<h2 data-id="heading-8">三、核心原理：流式渲染是如何工作的？</h2>
<h3 data-id="heading-9">3.1 自动补全机制：Cherry 如何"猜"你要写什么</h3>
<p>Cherry Markdown 的流式渲染核心在于<strong>智能语法补全</strong>。当检测到未闭合的 Markdown 语法时，它会自动插入临时闭合标记，确保渲染器能正确解析。</p>
<h4 data-id="heading-10">标题自动补全</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 流式输出："# Hello"</span>
<span class="hljs-comment">// Cherry 检测到 # 开头，自动补全为完整的标题语法</span>
<span class="hljs-comment">// 渲染结果：&lt;h1&gt;Hello&lt;/h1&gt;（而不是显示 "# Hello" 源码）</span>
</code></pre>
<h4 data-id="heading-11">代码块自动补全</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 流式输出："```python\ndef hello("</span>
<span class="hljs-comment">// Cherry 检测到 ``` 开始，自动补全闭合标记</span>
<span class="hljs-comment">// 渲染结果：显示代码块样式（而不是显示源码）</span>
</code></pre>
<h4 data-id="heading-12">表格自动补全</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 流式输出第一行："| 列1 | 列2 |"</span>
<span class="hljs-comment">// Cherry 检测到表格语法，自动补全第二行占位符</span>
<span class="hljs-comment">// 渲染结果：显示完整的表格结构（而不是显示源码）</span>
</code></pre>
<h4 data-id="heading-13">公式自动补全</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 流式输出："$E = mc^"</span>
<span class="hljs-comment">// Cherry 检测到 $ 开始但未闭合，等待完整公式</span>
<span class="hljs-comment">// 完整后："$E = mc^2$" → 渲染为数学公式</span>
</code></pre>
<h3 data-id="heading-14">3.2 渲染频率优化：从 50ms 到 10ms 的极致体验</h3>
<p>Cherry Markdown 在流式模式下，将渲染频率从默认的 50ms 优化到 10ms，提升了 5 倍性能：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 普通模式：最快 50ms 渲染一次</span>
<span class="hljs-keyword">const</span> cherryNormal = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Cherry</span>({
  <span class="hljs-attr">engine</span>: {
    <span class="hljs-attr">global</span>: {
      <span class="hljs-attr">flowSessionContext</span>: <span class="hljs-literal">false</span>,  <span class="hljs-comment">// 关闭流式模式</span>
    },
  },
});

<span class="hljs-comment">// 流式模式：最快 10ms 渲染一次</span>
<span class="hljs-keyword">const</span> cherryStream = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Cherry</span>({
  <span class="hljs-attr">engine</span>: {
    <span class="hljs-attr">global</span>: {
      <span class="hljs-attr">flowSessionContext</span>: <span class="hljs-literal">true</span>,   <span class="hljs-comment">// 开启流式模式</span>
    },
  },
});
</code></pre>
<p>这意味着在流式输出场景下，用户能感受到更流畅、更实时的渲染效果。</p>
<h3 data-id="heading-15">3.3 虚拟光标：模拟真实打字效果</h3>
<p>Cherry Markdown 提供了虚拟光标功能，在流式输出时显示一个闪烁的光标，模拟真人打字的效果：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-attr">flowSessionCursor</span>: <span class="hljs-string">'default'</span>  <span class="hljs-comment">// 默认光标样式</span>
</code></pre>
<p>你也可以自定义光标样式：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-attr">flowSessionCursor</span>: <span class="hljs-string">'&lt;span class="custom-cursor"&gt;|&lt;/span&gt;'</span>

<span class="hljs-comment">// CSS</span>
.<span class="hljs-property">custom</span>-cursor {
  <span class="hljs-attr">color</span>: #0d68ff;
  <span class="hljs-attr">animation</span>: blink 1s infinite;
}
@keyframes blink {
  <span class="hljs-number">0</span>%, <span class="hljs-number">50</span>% { <span class="hljs-attr">opacity</span>: <span class="hljs-number">1</span>; }
  <span class="hljs-number">51</span>%, <span class="hljs-number">100</span>% { <span class="hljs-attr">opacity</span>: <span class="hljs-number">0</span>; }
}
</code></pre>
<h2 data-id="heading-16">四、实战案例：构建一个完整的 AI Chat 应用</h2>
<h3 data-id="heading-17">4.1 案例一：模拟 ChatGPT 流式输出</h3>
<p>这个案例展示了如何模拟 ChatGPT 的逐字输出效果：</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">html</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">"UTF-8"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>模拟 ChatGPT 流式输出<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">link</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"https://cdn.jsdelivr.net/npm/cherry-markdown/dist/cherry-markdown.min.css"</span> <span class="hljs-attr">rel</span>=<span class="hljs-string">"stylesheet"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">style</span>&gt;</span><span class="css">
    <span class="hljs-selector-tag">body</span> {
      <span class="hljs-attribute">font-family</span>: -apple-system, BlinkMacSystemFont, <span class="hljs-string">'Segoe UI'</span>, sans-serif;
      <span class="hljs-attribute">max-width</span>: <span class="hljs-number">800px</span>;
      <span class="hljs-attribute">margin</span>: <span class="hljs-number">50px</span> auto;
      <span class="hljs-attribute">background</span>: <span class="hljs-number">#f8f9fb</span>;
    }
    <span class="hljs-selector-class">.chat-message</span> {
      <span class="hljs-attribute">background</span>: white;
      <span class="hljs-attribute">padding</span>: <span class="hljs-number">16px</span>;
      <span class="hljs-attribute">border-radius</span>: <span class="hljs-number">8px</span>;
      <span class="hljs-attribute">margin-bottom</span>: <span class="hljs-number">16px</span>;
      <span class="hljs-attribute">box-shadow</span>: <span class="hljs-number">0</span> <span class="hljs-number">1px</span> <span class="hljs-number">2px</span> <span class="hljs-built_in">rgba</span>(<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0.1</span>);
    }
    <span class="hljs-selector-class">.avatar</span> {
      <span class="hljs-attribute">width</span>: <span class="hljs-number">32px</span>;
      <span class="hljs-attribute">height</span>: <span class="hljs-number">32px</span>;
      <span class="hljs-attribute">border-radius</span>: <span class="hljs-number">50%</span>;
      <span class="hljs-attribute">background</span>: <span class="hljs-number">#0d68ff</span>;
      <span class="hljs-attribute">color</span>: white;
      <span class="hljs-attribute">display</span>: inline-flex;
      <span class="hljs-attribute">align-items</span>: center;
      <span class="hljs-attribute">justify-content</span>: center;
      <span class="hljs-attribute">font-weight</span>: bold;
      <span class="hljs-attribute">margin-right</span>: <span class="hljs-number">12px</span>;
    }
  </span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"chat-container"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
  
  <span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"https://cdn.jsdelivr.net/npm/cherry-markdown/dist/cherry-markdown.min.js"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
    <span class="hljs-comment">// AI 回复内容</span>
    <span class="hljs-keyword">const</span> aiResponse = <span class="hljs-string">`### 你好！我是 AI 助手

我可以帮你解答问题、写代码、分析数据等。

**功能特点：**
- 支持 Markdown 格式
- 代码高亮显示
- 数学公式渲染

**代码示例：**

\`\`\`python
def fibonacci(n):
    if n &lt;= 1:
        return n
    return fibonacci(n-1) + fibonacci(n-2)

print(fibonacci(10))
\`\`\`

**数学公式：**

行内公式：$E = mc^2$

段落公式：

$$\\int_{-\\infty}^{\\infty} e^{-x^2} dx = \\sqrt{\\pi}$$

**表格示例：**

| 功能 | 状态 | 说明 |
|:----|:----:|------|
| Markdown | ✅ | 完全支持 |
| 代码高亮 | ✅ | 支持多种语言 |
| 数学公式 | ✅ | LaTeX 语法 |
`</span>;

    <span class="hljs-comment">// 创建 Cherry 实例</span>
    <span class="hljs-keyword">const</span> cherry = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Cherry</span>({
      <span class="hljs-attr">el</span>: <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'chat-container'</span>),
      <span class="hljs-attr">editor</span>: {
        <span class="hljs-attr">height</span>: <span class="hljs-string">'auto'</span>,
        <span class="hljs-attr">defaultModel</span>: <span class="hljs-string">'previewOnly'</span>,
      },
      <span class="hljs-attr">engine</span>: {
        <span class="hljs-attr">global</span>: {
          <span class="hljs-attr">flowSessionContext</span>: <span class="hljs-literal">true</span>,
          <span class="hljs-attr">flowSessionCursor</span>: <span class="hljs-string">'default'</span>,
        },
      },
      <span class="hljs-attr">previewer</span>: {
        <span class="hljs-attr">enablePreviewerBubble</span>: <span class="hljs-literal">false</span>,
      },
    });

    <span class="hljs-comment">// 流式输出函数</span>
    <span class="hljs-keyword">let</span> currentIndex = <span class="hljs-number">0</span>;
    <span class="hljs-keyword">const</span> outputSpeed = <span class="hljs-number">30</span>; <span class="hljs-comment">// 每 30ms 输出一个字符</span>

    <span class="hljs-keyword">function</span> <span class="hljs-title function_">streamOutput</span>(<span class="hljs-params"/>) {
      <span class="hljs-keyword">if</span> (currentIndex &lt; aiResponse.<span class="hljs-property">length</span>) {
        <span class="hljs-keyword">const</span> partialText = aiResponse.<span class="hljs-title function_">substring</span>(<span class="hljs-number">0</span>, currentIndex + <span class="hljs-number">1</span>);
        cherry.<span class="hljs-title function_">setMarkdown</span>(partialText);
        currentIndex++;
        <span class="hljs-built_in">setTimeout</span>(streamOutput, outputSpeed);
      } <span class="hljs-keyword">else</span> {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'输出完成！'</span>);
      }
    }

    <span class="hljs-comment">// 开始输出</span>
    <span class="hljs-title function_">streamOutput</span>();
  </span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span>
</code></pre>
<h3 data-id="heading-18">4.2 案例二：对接真实 LLM API（SSE 流式接口）</h3>
<p>这个案例展示如何对接真实的 AI API，实现真正的流式对话：</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">html</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">"UTF-8"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>对接真实 AI API<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">link</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"https://cdn.jsdelivr.net/npm/cherry-markdown/dist/cherry-markdown.min.css"</span> <span class="hljs-attr">rel</span>=<span class="hljs-string">"stylesheet"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">style</span>&gt;</span><span class="css">
    <span class="hljs-selector-tag">body</span> {
      <span class="hljs-attribute">font-family</span>: -apple-system, sans-serif;
      <span class="hljs-attribute">max-width</span>: <span class="hljs-number">900px</span>;
      <span class="hljs-attribute">margin</span>: <span class="hljs-number">50px</span> auto;
      <span class="hljs-attribute">padding</span>: <span class="hljs-number">20px</span>;
    }
    <span class="hljs-selector-id">#input-area</span> {
      <span class="hljs-attribute">margin-bottom</span>: <span class="hljs-number">20px</span>;
    }
    <span class="hljs-selector-id">#user-input</span> {
      <span class="hljs-attribute">width</span>: <span class="hljs-number">100%</span>;
      <span class="hljs-attribute">padding</span>: <span class="hljs-number">12px</span>;
      <span class="hljs-attribute">border</span>: <span class="hljs-number">1px</span> solid <span class="hljs-number">#ddd</span>;
      <span class="hljs-attribute">border-radius</span>: <span class="hljs-number">6px</span>;
      <span class="hljs-attribute">font-size</span>: <span class="hljs-number">14px</span>;
    }
    <span class="hljs-selector-id">#send-btn</span> {
      <span class="hljs-attribute">margin-top</span>: <span class="hljs-number">10px</span>;
      <span class="hljs-attribute">padding</span>: <span class="hljs-number">10px</span> <span class="hljs-number">20px</span>;
      <span class="hljs-attribute">background</span>: <span class="hljs-number">#0d68ff</span>;
      <span class="hljs-attribute">color</span>: white;
      <span class="hljs-attribute">border</span>: none;
      <span class="hljs-attribute">border-radius</span>: <span class="hljs-number">6px</span>;
      <span class="hljs-attribute">cursor</span>: pointer;
    }
    <span class="hljs-selector-id">#send-btn</span><span class="hljs-selector-pseudo">:disabled</span> {
      <span class="hljs-attribute">background</span>: <span class="hljs-number">#ccc</span>;
      <span class="hljs-attribute">cursor</span>: not-allowed;
    }
    <span class="hljs-selector-class">.message</span> {
      <span class="hljs-attribute">margin-bottom</span>: <span class="hljs-number">20px</span>;
      <span class="hljs-attribute">padding</span>: <span class="hljs-number">16px</span>;
      <span class="hljs-attribute">background</span>: <span class="hljs-number">#f8f9fb</span>;
      <span class="hljs-attribute">border-radius</span>: <span class="hljs-number">8px</span>;
    }
    <span class="hljs-selector-class">.message</span><span class="hljs-selector-class">.user</span> {
      <span class="hljs-attribute">background</span>: <span class="hljs-number">#e3f2fd</span>;
    }
  </span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"input-area"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"text"</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"user-input"</span> <span class="hljs-attr">placeholder</span>=<span class="hljs-string">"输入你的问题..."</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"send-btn"</span>&gt;</span>发送<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"messages-container"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>

  <span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"https://cdn.jsdelivr.net/npm/cherry-markdown/dist/cherry-markdown.min.js"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
    <span class="hljs-keyword">const</span> messagesContainer = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'messages-container'</span>);
    <span class="hljs-keyword">const</span> userInput = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'user-input'</span>);
    <span class="hljs-keyword">const</span> sendBtn = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'send-btn'</span>);

    <span class="hljs-comment">// 创建用户消息</span>
    <span class="hljs-keyword">function</span> <span class="hljs-title function_">createUserMessage</span>(<span class="hljs-params">text</span>) {
      <span class="hljs-keyword">const</span> div = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">'div'</span>);
      div.<span class="hljs-property">className</span> = <span class="hljs-string">'message user'</span>;
      div.<span class="hljs-property">textContent</span> = text;
      messagesContainer.<span class="hljs-title function_">appendChild</span>(div);
    }

    <span class="hljs-comment">// 创建 AI 消息容器</span>
    <span class="hljs-keyword">function</span> <span class="hljs-title function_">createAIMessage</span>(<span class="hljs-params"/>) {
      <span class="hljs-keyword">const</span> div = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">'div'</span>);
      div.<span class="hljs-property">className</span> = <span class="hljs-string">'message'</span>;
      <span class="hljs-keyword">const</span> container = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">'div'</span>);
      container.<span class="hljs-property">id</span> = <span class="hljs-string">`ai-msg-<span class="hljs-subst">${<span class="hljs-built_in">Date</span>.now()}</span>`</span>;
      div.<span class="hljs-title function_">appendChild</span>(container);
      messagesContainer.<span class="hljs-title function_">appendChild</span>(div);
      <span class="hljs-keyword">return</span> container;
    }

    <span class="hljs-comment">// 初始化 Cherry 实例</span>
    <span class="hljs-keyword">function</span> <span class="hljs-title function_">createCherryInstance</span>(<span class="hljs-params">container</span>) {
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Cherry</span>({
        <span class="hljs-attr">el</span>: container,
        <span class="hljs-attr">editor</span>: {
          <span class="hljs-attr">height</span>: <span class="hljs-string">'auto'</span>,
          <span class="hljs-attr">defaultModel</span>: <span class="hljs-string">'previewOnly'</span>,
        },
        <span class="hljs-attr">engine</span>: {
          <span class="hljs-attr">global</span>: {
            <span class="hljs-attr">flowSessionContext</span>: <span class="hljs-literal">true</span>,
            <span class="hljs-attr">flowSessionCursor</span>: <span class="hljs-string">'default'</span>,
          },
        },
        <span class="hljs-attr">previewer</span>: {
          <span class="hljs-attr">enablePreviewerBubble</span>: <span class="hljs-literal">false</span>,
        },
      });
    }

    <span class="hljs-comment">// 对接 SSE 流式 API</span>
    <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">chatWithAI</span>(<span class="hljs-params">prompt</span>) {
      <span class="hljs-comment">// 显示用户消息</span>
      <span class="hljs-title function_">createUserMessage</span>(prompt);

      <span class="hljs-comment">// 创建 AI 消息容器</span>
      <span class="hljs-keyword">const</span> aiContainer = <span class="hljs-title function_">createAIMessage</span>();
      <span class="hljs-keyword">const</span> cherry = <span class="hljs-title function_">createCherryInstance</span>(aiContainer);

      <span class="hljs-keyword">try</span> {
        <span class="hljs-comment">// 调用你的 AI API（这里以 OpenAI 兼容接口为例）</span>
        <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetch</span>(<span class="hljs-string">'/api/chat/stream'</span>, {
          <span class="hljs-attr">method</span>: <span class="hljs-string">'POST'</span>,
          <span class="hljs-attr">headers</span>: {
            <span class="hljs-string">'Content-Type'</span>: <span class="hljs-string">'application/json'</span>,
          },
          <span class="hljs-attr">body</span>: <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>({
            <span class="hljs-attr">messages</span>: [{ <span class="hljs-attr">role</span>: <span class="hljs-string">'user'</span>, <span class="hljs-attr">content</span>: prompt }],
          }),
        });

        <span class="hljs-keyword">const</span> reader = response.<span class="hljs-property">body</span>.<span class="hljs-title function_">getReader</span>();
        <span class="hljs-keyword">const</span> decoder = <span class="hljs-keyword">new</span> <span class="hljs-title class_">TextDecoder</span>();
        <span class="hljs-keyword">let</span> fullText = <span class="hljs-string">''</span>;

        <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) {
          <span class="hljs-keyword">const</span> { done, value } = <span class="hljs-keyword">await</span> reader.<span class="hljs-title function_">read</span>();
          <span class="hljs-keyword">if</span> (done) <span class="hljs-keyword">break</span>;

          <span class="hljs-comment">// 解析 SSE 数据</span>
          <span class="hljs-keyword">const</span> chunk = decoder.<span class="hljs-title function_">decode</span>(value);
          <span class="hljs-keyword">const</span> lines = chunk.<span class="hljs-title function_">split</span>(<span class="hljs-string">'\n'</span>);

          <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> line <span class="hljs-keyword">of</span> lines) {
            <span class="hljs-keyword">if</span> (line.<span class="hljs-title function_">startsWith</span>(<span class="hljs-string">'data: '</span>)) {
              <span class="hljs-keyword">const</span> data = line.<span class="hljs-title function_">slice</span>(<span class="hljs-number">6</span>);
              <span class="hljs-keyword">if</span> (data === <span class="hljs-string">'[DONE]'</span>) <span class="hljs-keyword">continue</span>;

              <span class="hljs-keyword">try</span> {
                <span class="hljs-keyword">const</span> json = <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(data);
                <span class="hljs-keyword">const</span> delta = json.<span class="hljs-property">choices</span>[<span class="hljs-number">0</span>].<span class="hljs-property">delta</span>.<span class="hljs-property">content</span> || <span class="hljs-string">''</span>;
                fullText += delta;
                
                <span class="hljs-comment">// 🔑 实时更新 Markdown 内容</span>
                cherry.<span class="hljs-title function_">setMarkdown</span>(fullText);
              } <span class="hljs-keyword">catch</span> (e) {
                <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'解析错误:'</span>, e);
              }
            }
          }
        }
      } <span class="hljs-keyword">catch</span> (error) {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'API 调用失败:'</span>, error);
        cherry.<span class="hljs-title function_">setMarkdown</span>(<span class="hljs-string">'**错误：** 无法连接到 AI 服务，请稍后重试。'</span>);
      }
    }

    <span class="hljs-comment">// 发送按钮事件</span>
    sendBtn.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'click'</span>, <span class="hljs-keyword">async</span> () =&gt; {
      <span class="hljs-keyword">const</span> prompt = userInput.<span class="hljs-property">value</span>.<span class="hljs-title function_">trim</span>();
      <span class="hljs-keyword">if</span> (!prompt) <span class="hljs-keyword">return</span>;

      sendBtn.<span class="hljs-property">disabled</span> = <span class="hljs-literal">true</span>;
      userInput.<span class="hljs-property">value</span> = <span class="hljs-string">''</span>;
      
      <span class="hljs-keyword">await</span> <span class="hljs-title function_">chatWithAI</span>(prompt);
      
      sendBtn.<span class="hljs-property">disabled</span> = <span class="hljs-literal">false</span>;
      userInput.<span class="hljs-title function_">focus</span>();
    });

    <span class="hljs-comment">// 回车发送</span>
    userInput.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'keypress'</span>, <span class="hljs-function">(<span class="hljs-params">e</span>) =&gt;</span> {
      <span class="hljs-keyword">if</span> (e.<span class="hljs-property">key</span> === <span class="hljs-string">'Enter'</span> &amp;&amp; !sendBtn.<span class="hljs-property">disabled</span>) {
        sendBtn.<span class="hljs-title function_">click</span>();
      }
    });
  </span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span>
</code></pre>
<h3 data-id="heading-19">4.3 案例三：支持暂停/继续的流式渲染控制</h3>
<p>这个案例展示了如何实现暂停和继续功能，让用户控制流式输出的节奏：</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">html</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">"UTF-8"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>可控制的流式输出<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">link</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"https://cdn.jsdelivr.net/npm/cherry-markdown/dist/cherry-markdown.min.css"</span> <span class="hljs-attr">rel</span>=<span class="hljs-string">"stylesheet"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">style</span>&gt;</span><span class="css">
    <span class="hljs-selector-tag">body</span> {
      <span class="hljs-attribute">font-family</span>: -apple-system, sans-serif;
      <span class="hljs-attribute">max-width</span>: <span class="hljs-number">800px</span>;
      <span class="hljs-attribute">margin</span>: <span class="hljs-number">50px</span> auto;
      <span class="hljs-attribute">padding</span>: <span class="hljs-number">20px</span>;
    }
    <span class="hljs-selector-class">.controls</span> {
      <span class="hljs-attribute">margin-bottom</span>: <span class="hljs-number">20px</span>;
      <span class="hljs-attribute">display</span>: flex;
      <span class="hljs-attribute">gap</span>: <span class="hljs-number">10px</span>;
    }
    <span class="hljs-selector-tag">button</span> {
      <span class="hljs-attribute">padding</span>: <span class="hljs-number">10px</span> <span class="hljs-number">20px</span>;
      <span class="hljs-attribute">border</span>: none;
      <span class="hljs-attribute">border-radius</span>: <span class="hljs-number">6px</span>;
      <span class="hljs-attribute">cursor</span>: pointer;
      <span class="hljs-attribute">font-size</span>: <span class="hljs-number">14px</span>;
    }
    <span class="hljs-selector-class">.btn-primary</span> {
      <span class="hljs-attribute">background</span>: <span class="hljs-number">#0d68ff</span>;
      <span class="hljs-attribute">color</span>: white;
    }
    <span class="hljs-selector-class">.btn-secondary</span> {
      <span class="hljs-attribute">background</span>: <span class="hljs-number">#6c757d</span>;
      <span class="hljs-attribute">color</span>: white;
    }
    <span class="hljs-selector-tag">button</span><span class="hljs-selector-pseudo">:disabled</span> {
      <span class="hljs-attribute">opacity</span>: <span class="hljs-number">0.5</span>;
      <span class="hljs-attribute">cursor</span>: not-allowed;
    }
  </span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"controls"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"start-btn"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"btn-primary"</span>&gt;</span>开始流式输出<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"pause-btn"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"btn-secondary"</span> <span class="hljs-attr">disabled</span>&gt;</span>暂停<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"resume-btn"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"btn-secondary"</span> <span class="hljs-attr">disabled</span>&gt;</span>继续<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"reset-btn"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"btn-secondary"</span>&gt;</span>重置<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"output-container"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>

  <span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"https://cdn.jsdelivr.net/npm/cherry-markdown/dist/cherry-markdown.min.js"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
    <span class="hljs-keyword">const</span> outputContainer = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'output-container'</span>);
    <span class="hljs-keyword">const</span> startBtn = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'start-btn'</span>);
    <span class="hljs-keyword">const</span> pauseBtn = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'pause-btn'</span>);
    <span class="hljs-keyword">const</span> resumeBtn = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'resume-btn'</span>);
    <span class="hljs-keyword">const</span> resetBtn = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'reset-btn'</span>);

    <span class="hljs-comment">// AI 回复内容</span>
    <span class="hljs-keyword">const</span> aiResponse = <span class="hljs-string">`### 可控制的流式输出演示

这段内容支持**暂停**和**继续**功能。

\`\`\`javascript
// 暂停流式输出
paused = true;

// 继续流式输出
paused = false;
\`\`\`

数学公式：$\\sum_{i=1}^{n} i = \\frac{n(n+1)}{2}$

**功能特点：**
- ✅ 可以随时暂停
- ✅ 可以继续输出
- ✅ 可以重置重新开始
`</span>;

    <span class="hljs-keyword">let</span> cherry = <span class="hljs-literal">null</span>;
    <span class="hljs-keyword">let</span> currentIndex = <span class="hljs-number">0</span>;
    <span class="hljs-keyword">let</span> paused = <span class="hljs-literal">false</span>;
    <span class="hljs-keyword">let</span> streaming = <span class="hljs-literal">false</span>;
    <span class="hljs-keyword">let</span> streamTimer = <span class="hljs-literal">null</span>;

    <span class="hljs-comment">// 初始化 Cherry</span>
    <span class="hljs-keyword">function</span> <span class="hljs-title function_">initCherry</span>(<span class="hljs-params"/>) {
      cherry = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Cherry</span>({
        <span class="hljs-attr">el</span>: outputContainer,
        <span class="hljs-attr">editor</span>: {
          <span class="hljs-attr">height</span>: <span class="hljs-string">'auto'</span>,
          <span class="hljs-attr">defaultModel</span>: <span class="hljs-string">'previewOnly'</span>,
        },
        <span class="hljs-attr">engine</span>: {
          <span class="hljs-attr">global</span>: {
            <span class="hljs-attr">flowSessionContext</span>: <span class="hljs-literal">true</span>,
            <span class="hljs-attr">flowSessionCursor</span>: <span class="hljs-string">'default'</span>,
          },
        },
        <span class="hljs-attr">previewer</span>: {
          <span class="hljs-attr">enablePreviewerBubble</span>: <span class="hljs-literal">false</span>,
        },
      });
    }

    <span class="hljs-comment">// 流式输出函数</span>
    <span class="hljs-keyword">function</span> <span class="hljs-title function_">streamOutput</span>(<span class="hljs-params"/>) {
      <span class="hljs-keyword">if</span> (paused) {
        <span class="hljs-comment">// 暂停时，每 100ms 检查一次是否恢复</span>
        streamTimer = <span class="hljs-built_in">setTimeout</span>(streamOutput, <span class="hljs-number">100</span>);
        <span class="hljs-keyword">return</span>;
      }

      <span class="hljs-keyword">if</span> (currentIndex &lt; aiResponse.<span class="hljs-property">length</span>) {
        <span class="hljs-keyword">const</span> partialText = aiResponse.<span class="hljs-title function_">substring</span>(<span class="hljs-number">0</span>, currentIndex + <span class="hljs-number">1</span>);
        cherry.<span class="hljs-title function_">setMarkdown</span>(partialText);
        currentIndex++;
        streamTimer = <span class="hljs-built_in">setTimeout</span>(streamOutput, <span class="hljs-number">30</span>);
      } <span class="hljs-keyword">else</span> {
        <span class="hljs-comment">// 输出完成</span>
        streaming = <span class="hljs-literal">false</span>;
        startBtn.<span class="hljs-property">disabled</span> = <span class="hljs-literal">false</span>;
        pauseBtn.<span class="hljs-property">disabled</span> = <span class="hljs-literal">true</span>;
        resumeBtn.<span class="hljs-property">disabled</span> = <span class="hljs-literal">true</span>;
      }
    }

    <span class="hljs-comment">// 开始输出</span>
    startBtn.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'click'</span>, <span class="hljs-function">() =&gt;</span> {
      <span class="hljs-keyword">if</span> (!cherry) <span class="hljs-title function_">initCherry</span>();
      
      currentIndex = <span class="hljs-number">0</span>;
      paused = <span class="hljs-literal">false</span>;
      streaming = <span class="hljs-literal">true</span>;
      
      startBtn.<span class="hljs-property">disabled</span> = <span class="hljs-literal">true</span>;
      pauseBtn.<span class="hljs-property">disabled</span> = <span class="hljs-literal">false</span>;
      resumeBtn.<span class="hljs-property">disabled</span> = <span class="hljs-literal">true</span>;
      
      cherry.<span class="hljs-title function_">setMarkdown</span>(<span class="hljs-string">''</span>);
      <span class="hljs-title function_">streamOutput</span>();
    });

    <span class="hljs-comment">// 暂停输出</span>
    pauseBtn.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'click'</span>, <span class="hljs-function">() =&gt;</span> {
      paused = <span class="hljs-literal">true</span>;
      pauseBtn.<span class="hljs-property">disabled</span> = <span class="hljs-literal">true</span>;
      resumeBtn.<span class="hljs-property">disabled</span> = <span class="hljs-literal">false</span>;
    });

    <span class="hljs-comment">// 继续输出</span>
    resumeBtn.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'click'</span>, <span class="hljs-function">() =&gt;</span> {
      paused = <span class="hljs-literal">false</span>;
      pauseBtn.<span class="hljs-property">disabled</span> = <span class="hljs-literal">false</span>;
      resumeBtn.<span class="hljs-property">disabled</span> = <span class="hljs-literal">true</span>;
    });

    <span class="hljs-comment">// 重置</span>
    resetBtn.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'click'</span>, <span class="hljs-function">() =&gt;</span> {
      <span class="hljs-keyword">if</span> (streamTimer) {
        <span class="hljs-built_in">clearTimeout</span>(streamTimer);
        streamTimer = <span class="hljs-literal">null</span>;
      }
      
      currentIndex = <span class="hljs-number">0</span>;
      paused = <span class="hljs-literal">false</span>;
      streaming = <span class="hljs-literal">false</span>;
      
      <span class="hljs-keyword">if</span> (cherry) {
        cherry.<span class="hljs-title function_">setMarkdown</span>(<span class="hljs-string">''</span>);
      }
      
      startBtn.<span class="hljs-property">disabled</span> = <span class="hljs-literal">false</span>;
      pauseBtn.<span class="hljs-property">disabled</span> = <span class="hljs-literal">true</span>;
      resumeBtn.<span class="hljs-property">disabled</span> = <span class="hljs-literal">true</span>;
    });

    <span class="hljs-comment">// 初始化</span>
    <span class="hljs-title function_">initCherry</span>();
  </span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span>
</code></pre>
<h2 data-id="heading-20">五、进阶技巧：让 AI 对话更专业</h2>
<h3 data-id="heading-21">5.1 异步渲染回调：mermaid 图表完成后的处理</h3>
<p>从 mermaid v10.0.0 开始，渲染逻辑由同步改为异步。Cherry Markdown 提供了 <code>afterAsyncRender</code> 回调，让你在异步渲染完成后获取结果：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> cherry = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Cherry</span>({
  <span class="hljs-attr">el</span>: <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'container'</span>),
  <span class="hljs-attr">value</span>: <span class="hljs-string">`
    \`\`\`mermaid
    graph LR
        A[开始] --&gt; B[处理]
        B --&gt; C[结束]
    \`\`\`
  `</span>,
  <span class="hljs-attr">editor</span>: {
    <span class="hljs-attr">defaultModel</span>: <span class="hljs-string">'previewOnly'</span>,
  },
  <span class="hljs-attr">engine</span>: {
    <span class="hljs-attr">global</span>: {
      <span class="hljs-attr">flowSessionContext</span>: <span class="hljs-literal">true</span>,
    },
  },
  <span class="hljs-attr">callback</span>: {
    <span class="hljs-comment">// 🔑 异步渲染完成回调</span>
    <span class="hljs-attr">afterAsyncRender</span>: <span class="hljs-function">(<span class="hljs-params">md, html</span>) =&gt;</span> {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Markdown 源码:'</span>, md);
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'渲染后的 HTML:'</span>, html);
      
      <span class="hljs-comment">// 可以在这里做一些后处理，比如：</span>
      <span class="hljs-comment">// - 统计图表数量</span>
      <span class="hljs-comment">// - 添加交互功能</span>
      <span class="hljs-comment">// - 发送分析数据</span>
    },
  },
});
</code></pre>
<h3 data-id="heading-22">5.2 自定义流式光标样式</h3>
<p>你可以完全自定义光标的样式，让它更符合你的产品设计：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> cherry = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Cherry</span>({
  <span class="hljs-attr">el</span>: <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'container'</span>),
  <span class="hljs-attr">engine</span>: {
    <span class="hljs-attr">global</span>: {
      <span class="hljs-attr">flowSessionContext</span>: <span class="hljs-literal">true</span>,
      <span class="hljs-comment">// 自定义光标 HTML</span>
      <span class="hljs-attr">flowSessionCursor</span>: <span class="hljs-string">'&lt;span class="custom-cursor"&gt;▋&lt;/span&gt;'</span>,
    },
  },
});

<span class="hljs-comment">// CSS</span>
<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">style</span>&gt;</span><span class="css">
<span class="hljs-selector-class">.custom-cursor</span> {
  <span class="hljs-attribute">color</span>: <span class="hljs-number">#0d68ff</span>;
  <span class="hljs-attribute">font-weight</span>: bold;
  <span class="hljs-attribute">animation</span>: blink <span class="hljs-number">1s</span> step-end infinite;
  <span class="hljs-attribute">margin-left</span>: <span class="hljs-number">2px</span>;
}

<span class="hljs-keyword">@keyframes</span> blink {
  <span class="hljs-number">0%</span>, <span class="hljs-number">50%</span> { <span class="hljs-attribute">opacity</span>: <span class="hljs-number">1</span>; }
  <span class="hljs-number">51%</span>, <span class="hljs-number">100%</span> { <span class="hljs-attribute">opacity</span>: <span class="hljs-number">0</span>; }
}
</span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span></span>
</code></pre>
<h3 data-id="heading-23">5.3 多轮对话的消息管理</h3>
<p>在实际的 AI 对话应用中，你需要管理多轮对话。以下是一个完整的消息管理示例：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">ChatManager</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">container</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">container</span> = container;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">messages</span> = [];
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">cherryInstances</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>();
  }

  <span class="hljs-comment">// 添加用户消息</span>
  <span class="hljs-title function_">addUserMessage</span>(<span class="hljs-params">content</span>) {
    <span class="hljs-keyword">const</span> msg = {
      <span class="hljs-attr">id</span>: <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>(),
      <span class="hljs-attr">role</span>: <span class="hljs-string">'user'</span>,
      content,
      <span class="hljs-attr">timestamp</span>: <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>(),
    };
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">messages</span>.<span class="hljs-title function_">push</span>(msg);
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">renderUserMessage</span>(msg);
  }

  <span class="hljs-comment">// 添加 AI 消息（流式）</span>
  <span class="hljs-title function_">addAIMessageStream</span>(<span class="hljs-params">streamCallback</span>) {
    <span class="hljs-keyword">const</span> msgId = <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>();
    <span class="hljs-keyword">const</span> msg = {
      <span class="hljs-attr">id</span>: msgId,
      <span class="hljs-attr">role</span>: <span class="hljs-string">'assistant'</span>,
      <span class="hljs-attr">content</span>: <span class="hljs-string">''</span>,
      <span class="hljs-attr">timestamp</span>: <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>(),
    };
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">messages</span>.<span class="hljs-title function_">push</span>(msg);

    <span class="hljs-comment">// 创建消息 DOM</span>
    <span class="hljs-keyword">const</span> msgDiv = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">'div'</span>);
    msgDiv.<span class="hljs-property">className</span> = <span class="hljs-string">'ai-message'</span>;
    msgDiv.<span class="hljs-property">id</span> = <span class="hljs-string">`msg-<span class="hljs-subst">${msgId}</span>`</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">container</span>.<span class="hljs-title function_">appendChild</span>(msgDiv);

    <span class="hljs-comment">// 创建 Cherry 实例</span>
    <span class="hljs-keyword">const</span> cherry = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Cherry</span>({
      <span class="hljs-attr">el</span>: msgDiv,
      <span class="hljs-attr">editor</span>: {
        <span class="hljs-attr">height</span>: <span class="hljs-string">'auto'</span>,
        <span class="hljs-attr">defaultModel</span>: <span class="hljs-string">'previewOnly'</span>,
      },
      <span class="hljs-attr">engine</span>: {
        <span class="hljs-attr">global</span>: {
          <span class="hljs-attr">flowSessionContext</span>: <span class="hljs-literal">true</span>,
          <span class="hljs-attr">flowSessionCursor</span>: <span class="hljs-string">'default'</span>,
        },
      },
      <span class="hljs-attr">previewer</span>: {
        <span class="hljs-attr">enablePreviewerBubble</span>: <span class="hljs-literal">false</span>,
      },
    });

    <span class="hljs-variable language_">this</span>.<span class="hljs-property">cherryInstances</span>.<span class="hljs-title function_">set</span>(msgId, cherry);

    <span class="hljs-comment">// 流式更新内容</span>
    <span class="hljs-keyword">let</span> fullText = <span class="hljs-string">''</span>;
    <span class="hljs-title function_">streamCallback</span>(<span class="hljs-function">(<span class="hljs-params">chunk</span>) =&gt;</span> {
      fullText += chunk;
      cherry.<span class="hljs-title function_">setMarkdown</span>(fullText);
      msg.<span class="hljs-property">content</span> = fullText;
    });

    <span class="hljs-keyword">return</span> msgId;
  }

  <span class="hljs-comment">// 渲染用户消息</span>
  <span class="hljs-title function_">renderUserMessage</span>(<span class="hljs-params">msg</span>) {
    <span class="hljs-keyword">const</span> div = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">'div'</span>);
    div.<span class="hljs-property">className</span> = <span class="hljs-string">'user-message'</span>;
    div.<span class="hljs-property">textContent</span> = msg.<span class="hljs-property">content</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">container</span>.<span class="hljs-title function_">appendChild</span>(div);
  }

  <span class="hljs-comment">// 获取所有消息（用于 API 调用）</span>
  <span class="hljs-title function_">getMessagesForAPI</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">messages</span>.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">msg</span> =&gt;</span> ({
      <span class="hljs-attr">role</span>: msg.<span class="hljs-property">role</span>,
      <span class="hljs-attr">content</span>: msg.<span class="hljs-property">content</span>,
    }));
  }
}

<span class="hljs-comment">// 使用示例</span>
<span class="hljs-keyword">const</span> chatManager = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ChatManager</span>(<span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'chat-container'</span>));

<span class="hljs-comment">// 用户发送消息</span>
chatManager.<span class="hljs-title function_">addUserMessage</span>(<span class="hljs-string">'你好，请介绍一下 Markdown'</span>);

<span class="hljs-comment">// AI 流式回复</span>
<span class="hljs-keyword">const</span> msgId = chatManager.<span class="hljs-title function_">addAIMessageStream</span>(<span class="hljs-function">(<span class="hljs-params">update</span>) =&gt;</span> {
  <span class="hljs-comment">// 模拟流式输出</span>
  <span class="hljs-keyword">const</span> response = <span class="hljs-string">'### Markdown 简介\n\nMarkdown 是一种轻量级标记语言...'</span>;
  <span class="hljs-keyword">let</span> index = <span class="hljs-number">0</span>;
  <span class="hljs-keyword">const</span> timer = <span class="hljs-built_in">setInterval</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">if</span> (index &lt; response.<span class="hljs-property">length</span>) {
      <span class="hljs-title function_">update</span>(response[index]);
      index++;
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-built_in">clearInterval</span>(timer);
    }
  }, <span class="hljs-number">30</span>);
});
</code></pre>
<h3 data-id="heading-24">5.4 性能优化：大量消息时的处理策略</h3>
<p>当对话消息很多时，需要注意性能优化：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">OptimizedChatManager</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">container, maxVisibleMessages = <span class="hljs-number">10</span></span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">container</span> = container;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">messages</span> = [];
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">maxVisibleMessages</span> = maxVisibleMessages;
  }

  <span class="hljs-comment">// 只渲染最近的消息</span>
  <span class="hljs-title function_">renderMessages</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// 清空容器</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">container</span>.<span class="hljs-property">innerHTML</span> = <span class="hljs-string">''</span>;

    <span class="hljs-comment">// 只渲染最后 N 条消息</span>
    <span class="hljs-keyword">const</span> visibleMessages = <span class="hljs-variable language_">this</span>.<span class="hljs-property">messages</span>.<span class="hljs-title function_">slice</span>(-<span class="hljs-variable language_">this</span>.<span class="hljs-property">maxVisibleMessages</span>);

    visibleMessages.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">msg</span> =&gt;</span> {
      <span class="hljs-keyword">if</span> (msg.<span class="hljs-property">role</span> === <span class="hljs-string">'user'</span>) {
        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">renderUserMessage</span>(msg);
      } <span class="hljs-keyword">else</span> {
        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">renderAIMessage</span>(msg);
      }
    });

    <span class="hljs-comment">// 滚动到底部</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">scrollToBottom</span>();
  }

  <span class="hljs-comment">// 虚拟滚动（适用于超大量消息）</span>
  <span class="hljs-title function_">renderWithVirtualScroll</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// 实现虚拟滚动逻辑</span>
    <span class="hljs-comment">// 只渲染可见区域的消息</span>
  }

  <span class="hljs-comment">// 懒加载历史消息</span>
  <span class="hljs-keyword">async</span> <span class="hljs-title function_">loadHistoryMessages</span>(<span class="hljs-params">offset = <span class="hljs-number">0</span>, limit = <span class="hljs-number">20</span></span>) {
    <span class="hljs-comment">// 从服务器加载历史消息</span>
    <span class="hljs-keyword">const</span> history = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetch</span>(<span class="hljs-string">`/api/messages?offset=<span class="hljs-subst">${offset}</span>&amp;limit=<span class="hljs-subst">${limit}</span>`</span>);
    <span class="hljs-keyword">const</span> messages = <span class="hljs-keyword">await</span> history.<span class="hljs-title function_">json</span>();
    
    <span class="hljs-comment">// 插入到消息列表前面</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">messages</span>.<span class="hljs-title function_">unshift</span>(...messages);
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">renderMessages</span>();
  }
}
</code></pre>
<h2 data-id="heading-25">六、总结与资源</h2>
<h3 data-id="heading-26">6.1 适用场景一览</h3>
<p>Cherry Markdown 的流式渲染功能特别适合以下场景：</p>



































<table><thead><tr><th>场景</th><th>说明</th><th>优势</th></tr></thead><tbody><tr><td>AI 对话应用</td><td>ChatGPT、Claude 等对话界面</td><td>实时渲染，不露源码</td></tr><tr><td>代码生成工具</td><td>AI 生成代码的实时展示</td><td>代码高亮完整显示</td></tr><tr><td>文档生成工具</td><td>流式生成 Markdown 文档</td><td>所见即所得</td></tr><tr><td>在线教育</td><td>实时讲解 Markdown 语法</td><td>教学演示更直观</td></tr><tr><td>协作编辑</td><td>多人实时编辑 Markdown</td><td>流畅的协作体验</td></tr></tbody></table>
<h3 data-id="heading-27">6.2 在线 Demo 与文档链接</h3>
<ul>
<li><strong>在线演示</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Ftencent.github.io%2Fcherry-markdown%2Fexamples%2Fai_chat.html" target="_blank" title="https://tencent.github.io/cherry-markdown/examples/ai_chat.html" ref="nofollow noopener noreferrer">AI Chat 流式渲染 Demo</a></li>
<li><strong>完整文档</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FTencent%2Fcherry-markdown%2Fwiki" target="_blank" title="https://github.com/Tencent/cherry-markdown/wiki" ref="nofollow noopener noreferrer">Cherry Markdown Wiki</a></li>
<li><strong>GitHub 仓库</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FTencent%2Fcherry-markdown" target="_blank" title="https://github.com/Tencent/cherry-markdown" ref="nofollow noopener noreferrer">Tencent/cherry-markdown</a></li>
<li><strong>API 文档</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Ftencent.github.io%2Fcherry-markdown%2Fexamples%2Fapi.html" target="_blank" title="https://tencent.github.io/cherry-markdown/examples/api.html" ref="nofollow noopener noreferrer">API 参考</a></li>
</ul>
<h3 data-id="heading-28">6.3 常见问题 FAQ</h3>
<p><strong>Q: 流式渲染会影响性能吗？</strong></p>
<p>A: 不会。Cherry Markdown 在流式模式下优化了渲染频率（10ms），比普通模式（50ms）更快。</p>
<p><strong>Q: 支持哪些 Markdown 语法？</strong></p>
<p>A: 支持 12 种语法的自动补全：标题、加粗、斜体、链接、图片、代码块、公式、列表、表格、mermaid、脚注等。</p>
<p><strong>Q: 可以自定义补全规则吗？</strong></p>
<p>A: 目前补全规则是内置的，但你可以通过自定义语法扩展功能。详见<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FTencent%2Fcherry-markdown%2Fwiki%2F%25E8%2587%25AA%25E5%25AE%259A%25E4%25B9%2589%25E8%25AF%25AD%25E6%25B3%2595" target="_blank" title="https://github.com/Tencent/cherry-markdown/wiki/%E8%87%AA%E5%AE%9A%E4%B9%89%E8%AF%AD%E6%B3%95" ref="nofollow noopener noreferrer">自定义语法文档</a>。</p>
<p><strong>Q: 如何对接我的 AI API？</strong></p>
<p>A: 参考本文的"案例二"，使用 SSE（Server-Sent Events）或 WebSocket 接收流式数据，然后调用 <code>cherry.setMarkdown()</code> 更新内容。</p>
<p><strong>Q: 流式渲染支持移动端吗？</strong></p>
<p>A: 完全支持。Cherry Markdown 是响应式设计，在移动端也能流畅运行。查看<a href="https://link.juejin.cn?target=https%3A%2F%2Ftencent.github.io%2Fcherry-markdown%2Fexamples%2Fh5.html" target="_blank" title="https://tencent.github.io/cherry-markdown/examples/h5.html" ref="nofollow noopener noreferrer">移动端 Demo</a>。</p>
<h2 data-id="heading-29">结语</h2>
<p>Cherry Markdown 的流式渲染功能，让 AI 对话应用的 Markdown 展示变得丝滑流畅。无论是构建 ChatGPT 类应用，还是开发代码生成工具，Cherry Markdown 都能为你提供专业级的渲染体验。</p>
<p>希望这篇文章能帮助你快速上手 Cherry Markdown 的流式渲染功能。如果你有任何问题或建议，欢迎在 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FTencent%2Fcherry-markdown%2Fissues" target="_blank" title="https://github.com/Tencent/cherry-markdown/issues" ref="nofollow noopener noreferrer">GitHub Issues</a> 中提出。</p>
<p><strong>开始构建你的 AI 对话应用吧！</strong> 🚀</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[《Git 入门指南：从零开始掌握版本控制（附高频命令速查）》]]></title>    <link>https://juejin.cn/post/7595864836360323124</link>    <guid>https://juejin.cn/post/7595864836360323124</guid>    <pubDate>2026-01-17T08:59:21.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7595864836360323124" data-draft-id="7595859552348258356" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="《Git 入门指南：从零开始掌握版本控制（附高频命令速查）》"/> <meta itemprop="keywords" content="Git"/> <meta itemprop="datePublished" content="2026-01-17T08:59:21.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="用户80110532256"/> <meta itemprop="url" content="https://juejin.cn/user/1927884034804425"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            《Git 入门指南：从零开始掌握版本控制（附高频命令速查）》
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1927884034804425/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    用户80110532256
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-17T08:59:21.000Z" title="Sat Jan 17 2026 08:59:21 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-17
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    7
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Git 入门指南：从零开始掌握版本控制（附高频命令速查）</h2>
<blockquote>
<p><strong>为什么同一个项目不能有多个 Git 仓库？</strong><br/>
<strong>为什么提交要用 hash ID 而不用 1、2、3？</strong><br/>
<strong>如何优雅地回退代码、撤销修改？</strong></p>
<p>本文用最直白的语言 + 实战命令，带你彻底搞懂 Git 核心原理与日常操作，告别“只会 git add / commit / push”！</p>
</blockquote>
<hr/>
<h3 data-id="heading-1">一、为什么需要 Git？</h3>
<p>想象你在开发一个项目：</p>
<ul>
<li>今天改了功能 A，明天想试试功能 B，但又怕搞砸</li>
<li>团队协作时，多人同时修改同一个文件，怎么合并？</li>
<li>代码写崩了，想回到昨天的状态？</li>
</ul>
<p><strong>Git 就是你的“代码时光机”</strong> —— 它能：</p>
<ul>
<li>记录每一次文件变化</li>
<li>支持多人协作不冲突</li>
<li>随时回退到任意历史版本</li>
</ul>
<blockquote>
<p>💡 <strong>关键认知</strong>：Git 管理的不是文件本身，而是<strong>文件的版本</strong>。</p>
</blockquote>
<hr/>
<h3 data-id="heading-2">二、初始化仓库：<code>git init</code></h3>
<p>要让普通文件夹变成“代码仓库”，只需一行命令：</p>
<pre><code class="hljs language-csharp" lang="csharp">git <span class="hljs-keyword">init</span>
</code></pre>
<p>执行后会发生两件事：</p>
<ol>
<li>生成隐藏目录 <code>.git</code>（包含所有版本信息）</li>
<li>自动创建默认分支 <code>master</code>（或 <code>main</code>，取决于 Git 版本）</li>
</ol>
<blockquote>
<p>⚠️ <strong>重要原则</strong>：<strong>一个项目只应有一个 Git 仓库</strong>！<br/>
多个仓库会导致版本混乱，无法统一管理。</p>
</blockquote>
<hr/>
<h3 data-id="heading-3">三、核心工作区概念（必懂！）</h3>
<p>Git 有三个关键区域：</p>

























<table><thead><tr><th>区域</th><th>作用</th><th>命令</th></tr></thead><tbody><tr><td><strong>工作区（Working Directory）</strong></td><td>你编辑的文件所在位置</td><td>直接修改文件</td></tr><tr><td><strong>暂存区（Staging Area）</strong></td><td>临时存放准备提交的修改</td><td><code>git add</code></td></tr><tr><td><strong>本地仓库（Repository）</strong></td><td>永久保存已提交的版本</td><td><code>git commit</code></td></tr></tbody></table>
<blockquote>
<p><strong>流程</strong>：<br/>
工作区 → <code>git add</code> → 暂存区 → <code>git commit</code> → 本地仓库</p>
</blockquote>
<hr/>
<h3 data-id="heading-4">四、高频命令详解（附使用场景）</h3>
<h4 data-id="heading-5">1. <code>git status</code> —— 你的“状态雷达”</h4>
<p><strong>作用</strong>：查看当前仓库状态（最重要！建议每次操作前都运行）</p>
<p>输出解读：</p>
<ul>
<li><strong>Untracked files</strong>：未跟踪的文件（不在暂存区）</li>
<li><strong>Changes not staged for commit</strong>：已修改但未 <code>add</code></li>
<li><strong>Changes to be committed</strong>：已在暂存区，等待 <code>commit</code></li>
</ul>
<blockquote>
<p><strong>好习惯</strong>：任何操作前先 <code>git status</code>，心中有数！</p>
</blockquote>
<hr/>
<h4 data-id="heading-6">2. <code>git add &lt;文件&gt;</code> —— 添加到暂存区</h4>
<pre><code class="hljs language-csharp" lang="csharp">git <span class="hljs-keyword">add</span> index.html      <span class="hljs-meta"># 添加单个文件</span>
git <span class="hljs-keyword">add</span> .               <span class="hljs-meta"># 添加所有修改</span>
</code></pre>
<blockquote>
<p>暂存区让你<strong>精确控制哪些修改进入下一次提交</strong>。</p>
</blockquote>
<hr/>
<h4 data-id="heading-7">3. <code>git commit -m "说明"</code> —— 提交到本地仓库</h4>
<pre><code class="hljs language-sql" lang="sql">git <span class="hljs-keyword">commit</span> <span class="hljs-operator">-</span>m "新增用户登录功能"
</code></pre>
<h5 data-id="heading-8">关键知识点：</h5>
<ul>
<li><strong>提交说明要清晰</strong>！描述“做了什么”，而非“改了哪里”</li>
<li>每次提交生成唯一 ID（如 <code>264c229</code>），由 SHA 算法生成</li>
<li><strong>为什么不用 1,2,3？</strong><br/>
→ 因为 Git 是分布式系统，多人协作时自增 ID 会冲突，而 hash ID 全局唯一！</li>
</ul>
<blockquote>
<p>输出示例：<br/>
<code>2 insertions(+)</code> 表示本次提交新增了 2 行代码。</p>
</blockquote>
<hr/>
<h4 data-id="heading-9">4. <code>git diff</code> —— 查看代码差异</h4>
<p><strong>作用</strong>：对比<strong>工作区</strong>与<strong>暂存区/仓库</strong>的代码差异</p>
<pre><code class="hljs language-bash" lang="bash">git diff                <span class="hljs-comment"># 工作区 vs 暂存区</span>
git diff --cached       <span class="hljs-comment"># 暂存区 vs 仓库</span>
</code></pre>
<blockquote>
<p><strong>好习惯</strong>：重大提交前先 <code>git diff</code>，确保没误改！</p>
</blockquote>
<hr/>
<h4 data-id="heading-10">5. <code>git log</code> —— 查看提交历史</h4>
<pre><code class="hljs language-bash" lang="bash">git <span class="hljs-built_in">log</span>
</code></pre>
<p>输出包含：</p>
<ul>
<li>提交 ID（hash）</li>
<li>作者 &amp; 时间</li>
<li>提交说明</li>
</ul>
<blockquote>
<p>结合 <code>git log --oneline</code> 可简洁查看历史。</p>
</blockquote>
<hr/>
<h3 data-id="heading-11">🔙 五、版本回退与撤销（救命技能！）</h3>
<h4 data-id="heading-12">场景 1：刚改了代码，想撤销（未 add）</h4>
<pre><code class="hljs language-lua" lang="lua">git checkout <span class="hljs-comment">-- 文件名</span>
</code></pre>
<blockquote>
<ul>
<li>效果：丢弃工作区修改，恢复到最后一次提交状态。</li>
</ul>
</blockquote>
<hr/>
<h4 data-id="heading-13">场景 2：已 add 到暂存区，想撤回</h4>
<pre><code class="hljs language-perl" lang="perl">git <span class="hljs-keyword">reset</span> HEAD 文件名
</code></pre>
<blockquote>
<ul>
<li>效果：文件从暂存区移出，回到工作区（修改保留）。</li>
</ul>
</blockquote>
<hr/>
<h4 data-id="heading-14">场景 3：已 commit，想回退到上一个版本</h4>
<pre><code class="hljs language-perl" lang="perl">git <span class="hljs-keyword">reset</span> --hard HEAD^     <span class="hljs-comment"># 回退 1 个版本</span>
git <span class="hljs-keyword">reset</span> --hard HEAD^^    <span class="hljs-comment"># 回退 2 个版本</span>
git <span class="hljs-keyword">reset</span> --hard &lt;commit-id&gt;  <span class="hljs-comment"># 回退到指定版本</span>
</code></pre>
<blockquote>
<ul>
<li><code>--hard</code> 会<strong>丢弃所有修改</strong>，慎用！</li>
</ul>
</blockquote>
<hr/>
<h4 data-id="heading-15">场景 4：不小心回退错了？找回丢失的版本！</h4>
<p>Git 会记录几乎所有操作，用 <code>reflog</code> 找回：</p>
<pre><code class="hljs">git reflog
</code></pre>
<p>输出类似：</p>
<pre><code class="hljs language-perl" lang="perl"><span class="hljs-number">264</span>c229 (HEAD -&gt; master) HEAD@{0}: commit: append GPL
a1b2c3d HEAD@{1}: <span class="hljs-keyword">reset</span>: moving to HEAD^
</code></pre>
<p>找到你要的 commit ID，再用 <code>git reset --hard &lt;ID&gt;</code> 恢复！</p>
<hr/>
<h3 data-id="heading-16">六、HEAD 指针：版本穿梭的关键</h3>
<ul>
<li><code>HEAD</code> 指向<strong>当前分支的最新提交</strong></li>
<li>每次 <code>commit</code>，HEAD 会自动前移</li>
<li><code>git reset</code> 本质是<strong>移动 HEAD 指针</strong></li>
</ul>
<blockquote>
<ul>
<li>你可以把 Git 历史想象成一条时间线，HEAD 就是你当前的位置。</li>
</ul>
</blockquote>
<hr/>
<h3 data-id="heading-17">七、最佳实践总结</h3>





























<table><thead><tr><th>场景</th><th>推荐操作</th></tr></thead><tbody><tr><td>开始新功能</td><td>先 <code>git status</code>，确认干净</td></tr><tr><td>提交前</td><td><code>git diff</code> 检查改动</td></tr><tr><td>写提交信息</td><td>清晰描述“做了什么”</td></tr><tr><td>代码写崩</td><td>用 <code>git reset --hard</code> 回退</td></tr><tr><td>误删提交</td><td>用 <code>git reflog</code> 找回</td></tr></tbody></table>
<hr/>
<h3 data-id="heading-18">附：Git 命令速查表</h3>

















































<table><thead><tr><th>命令</th><th>作用</th></tr></thead><tbody><tr><td><code>git init</code></td><td>初始化仓库</td></tr><tr><td><code>git status</code></td><td>查看状态</td></tr><tr><td><code>git add .</code></td><td>添加所有修改到暂存区</td></tr><tr><td><code>git commit -m "msg"</code></td><td>提交</td></tr><tr><td><code>git diff</code></td><td>查看差异</td></tr><tr><td><code>git log</code></td><td>查看历史</td></tr><tr><td><code>git checkout -- file</code></td><td>撤销工作区修改</td></tr><tr><td><code>git reset HEAD file</code></td><td>撤销暂存</td></tr><tr><td><code>git reset --hard HEAD^</code></td><td>回退版本</td></tr><tr><td><code>git reflog</code></td><td>查看操作记录</td></tr></tbody></table>
<hr/>
<h3 data-id="heading-19">结语</h3>
<p>Git 不是魔法，而是一种<strong>工程思维</strong>：</p>
<blockquote>
<p><strong>通过精确记录变化，让我们敢于尝试、不怕犯错。</strong></p>
</blockquote>
<p>掌握这些基础，你就已经超越了 80% 的“只会三板斧”的开发者。下一步，可以学习分支管理（<code>git branch</code>）、远程协作（<code>git push/pull</code>）等进阶内容。</p>
<blockquote>
<p><strong>记住：版本控制不是为了防止错误，而是为了让错误变得无害。</strong></p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Spring Cloud Alibaba+K8S 无感升级架构方案]]></title>    <link>https://juejin.cn/post/7595871887001387008</link>    <guid>https://juejin.cn/post/7595871887001387008</guid>    <pubDate>2026-01-17T08:59:42.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7595871887001387008" data-draft-id="7595859552348274740" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Spring Cloud Alibaba+K8S 无感升级架构方案"/> <meta itemprop="keywords" content="Java"/> <meta itemprop="datePublished" content="2026-01-17T08:59:42.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="wichell同学"/> <meta itemprop="url" content="https://juejin.cn/user/729731452645966"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Spring Cloud Alibaba+K8S 无感升级架构方案
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/729731452645966/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    wichell同学
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-17T08:59:42.000Z" title="Sat Jan 17 2026 08:59:42 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-17
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    8
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读12分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h3 data-id="heading-0">第一部分：Spring Cloud Alibaba 微服务项目 (<code>sc-alibaba-k8s-demo</code>)</h3>
<h4 data-id="heading-1">1. 项目结构</h4>
<p>创建一个 Maven 项目，例如命名为 <code>sc-alibaba-k8s-demo</code>。</p>
<pre><code class="hljs language-css" lang="css">sc-alibaba-k8s-demo/
├── pom<span class="hljs-selector-class">.xml</span>
└── <span class="hljs-attribute">src</span>/
    └── <span class="hljs-selector-tag">main</span>/
        ├── java/
        │   └── com/
        │       └── example/
        │           └── scalibaba/
        │               ├── ScAlibabaK8sDemoApplication<span class="hljs-selector-class">.java</span>
        │               └── controller/
        │                   └── DemoController<span class="hljs-selector-class">.java</span>
        └── resources/
            └── application<span class="hljs-selector-class">.yml</span>
</code></pre>
<h4 data-id="heading-2">2. <code>pom.xml</code></h4>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">"1.0"</span> encoding=<span class="hljs-string">"UTF-8"</span>?&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">project</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">"http://maven.apache.org/POM/4.0.0"</span> <span class="hljs-attr">xmlns:xsi</span>=<span class="hljs-string">"http://www.w3.org/2001/XMLSchema-instance"</span>
         <span class="hljs-attr">xsi:schemaLocation</span>=<span class="hljs-string">"http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">modelVersion</span>&gt;</span>4.0.0<span class="hljs-tag">&lt;/<span class="hljs-name">modelVersion</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">parent</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-parent<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.1.5<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span> <span class="hljs-comment">&lt;!-- 使用 Spring Boot 3.x 以获得最新的优雅停机支持 --&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">relativePath</span>/&gt;</span> <span class="hljs-comment">&lt;!-- lookup parent from repository --&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">parent</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.example<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>sc-alibaba-k8s-demo<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>0.0.1-SNAPSHOT<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">name</span>&gt;</span>sc-alibaba-k8s-demo<span class="hljs-tag">&lt;/<span class="hljs-name">name</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">description</span>&gt;</span>Demo project for Spring Cloud Alibaba K8s Graceful Shutdown<span class="hljs-tag">&lt;/<span class="hljs-name">description</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">properties</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">java.version</span>&gt;</span>17<span class="hljs-tag">&lt;/<span class="hljs-name">java.version</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">spring-cloud.version</span>&gt;</span>2022.0.4<span class="hljs-tag">&lt;/<span class="hljs-name">spring-cloud.version</span>&gt;</span> <span class="hljs-comment">&lt;!-- 对应 Spring Boot 3.1.x --&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">spring-cloud-alibaba.version</span>&gt;</span>2022.0.0.0<span class="hljs-tag">&lt;/<span class="hljs-name">spring-cloud-alibaba.version</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">properties</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-actuator<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.alibaba.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-nacos-discovery<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>

        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>test<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">dependencyManagement</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-dependencies<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>${spring-cloud.version}<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">type</span>&gt;</span>pom<span class="hljs-tag">&lt;/<span class="hljs-name">type</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>import<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.alibaba.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-alibaba-dependencies<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>${spring-cloud-alibaba.version}<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">type</span>&gt;</span>pom<span class="hljs-tag">&lt;/<span class="hljs-name">type</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>import<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependencyManagement</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">build</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">plugins</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">plugin</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">plugin</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">plugins</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">build</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">project</span>&gt;</span>
</code></pre>
<h4 data-id="heading-3">3. <code>src/main/java/com/example/scalibaba/ScAlibabaK8sDemoApplication.java</code></h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> com.example.scalibaba;

<span class="hljs-keyword">import</span> org.springframework.boot.SpringApplication;
<span class="hljs-keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;
<span class="hljs-keyword">import</span> org.springframework.cloud.client.discovery.EnableDiscoveryClient;
<span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.GetMapping;
<span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.RestController;

<span class="hljs-meta">@SpringBootApplication</span>
<span class="hljs-meta">@EnableDiscoveryClient</span>
<span class="hljs-meta">@RestController</span> <span class="hljs-comment">// 添加RestController注解，这样可以直接在这里定义简单的接口</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ScAlibabaK8sDemoApplication</span> {

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">instanceId</span> <span class="hljs-operator">=</span> java.util.UUID.randomUUID().toString().substring(<span class="hljs-number">0</span>, <span class="hljs-number">8</span>); <span class="hljs-comment">// 用于区分不同的Pod实例</span>

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        SpringApplication.run(ScAlibabaK8sDemoApplication.class, args);
    }

    <span class="hljs-meta">@GetMapping("/hello")</span>
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">hello</span><span class="hljs-params">()</span> {
        System.out.println(<span class="hljs-string">"Instance "</span> + instanceId + <span class="hljs-string">" received /hello request."</span>);
        <span class="hljs-keyword">return</span> <span class="hljs-string">"Hello from Spring Cloud Alibaba K8s Demo (Instance: "</span> + instanceId + <span class="hljs-string">")!"</span>;
    }

    <span class="hljs-meta">@GetMapping("/slow-hello")</span>
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">slowHello</span><span class="hljs-params">()</span> {
        System.out.println(<span class="hljs-string">"Instance "</span> + instanceId + <span class="hljs-string">" received /slow-hello request. Starting 20s processing..."</span>);
        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// 模拟一个耗时操作，例如数据库查询、RPC调用等</span>
            Thread.sleep(<span class="hljs-number">20</span> * <span class="hljs-number">1000</span>); <span class="hljs-comment">// 20秒</span>
        } <span class="hljs-keyword">catch</span> (InterruptedException e) {
            Thread.currentThread().interrupt();
            System.out.println(<span class="hljs-string">"Instance "</span> + instanceId + <span class="hljs-string">" /slow-hello interrupted."</span>);
            <span class="hljs-keyword">return</span> <span class="hljs-string">"Slow hello interrupted by instance "</span> + instanceId;
        }
        System.out.println(<span class="hljs-string">"Instance "</span> + instanceId + <span class="hljs-string">" finished /slow-hello request."</span>);
        <span class="hljs-keyword">return</span> <span class="hljs-string">"Slow Hello finished from Spring Cloud Alibaba K8s Demo (Instance: "</span> + instanceId + <span class="hljs-string">")!"</span>;
    }
}
</code></pre>
<h4 data-id="heading-4">4. <code>src/main/resources/application.yml</code></h4>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">server:</span>
  <span class="hljs-attr">port:</span> <span class="hljs-number">8080</span>
  <span class="hljs-attr">shutdown:</span> <span class="hljs-string">graceful</span> <span class="hljs-comment"># 启用优雅停机</span>
<span class="hljs-attr">spring:</span>
  <span class="hljs-attr">application:</span>
    <span class="hljs-attr">name:</span> <span class="hljs-string">sc-alibaba-k8s-demo</span>
  <span class="hljs-attr">cloud:</span>
    <span class="hljs-attr">nacos:</span>
      <span class="hljs-attr">discovery:</span>
        <span class="hljs-attr">server-addr:</span> <span class="hljs-string">nacos-service:8848</span> <span class="hljs-comment"># 指定 Nacos Server 地址，使用 K8s Service Name</span>
        <span class="hljs-comment"># 更多Nacos配置可以按需添加，例如命名空间等</span>
  <span class="hljs-attr">lifecycle:</span>
    <span class="hljs-attr">timeout-per-shutdown-phase:</span> <span class="hljs-string">60s</span> <span class="hljs-comment"># 优雅停机阶段的超时时间，建议比最长请求时间长</span>
  <span class="hljs-attr">profiles:</span>
    <span class="hljs-attr">active:</span> <span class="hljs-string">dev</span> <span class="hljs-comment"># 明确激活一个profile</span>
<span class="hljs-attr">management:</span>
  <span class="hljs-attr">endpoints:</span>
    <span class="hljs-attr">web:</span>
      <span class="hljs-attr">exposure:</span>
        <span class="hljs-attr">include:</span> <span class="hljs-string">"*"</span> <span class="hljs-comment"># 暴露所有Actuator端点</span>
  <span class="hljs-attr">endpoint:</span>
    <span class="hljs-attr">health:</span>
      <span class="hljs-attr">show-details:</span> <span class="hljs-string">always</span> <span class="hljs-comment"># 在健康检查中显示详细信息</span>
      <span class="hljs-attr">livenessstate:</span>
        <span class="hljs-attr">enabled:</span> <span class="hljs-literal">true</span>
      <span class="hljs-attr">readinessstate:</span>
        <span class="hljs-attr">enabled:</span> <span class="hljs-literal">true</span>
<span class="hljs-attr">logging:</span>
  <span class="hljs-attr">level:</span>
    <span class="hljs-attr">root:</span> <span class="hljs-string">INFO</span>
    <span class="hljs-attr">org.springframework.boot.web.servlet.context.AnnotationConfigServletWebServerApplicationContext:</span> <span class="hljs-string">INFO</span>
    <span class="hljs-comment"># 增加日志，查看优雅停机过程中的连接关闭信息</span>
    <span class="hljs-attr">org.apache.coyote.AbstractProtocol:</span> <span class="hljs-string">DEBUG</span>
    <span class="hljs-attr">org.springframework.web.servlet.DispatcherServlet:</span> <span class="hljs-string">DEBUG</span>
</code></pre>
<p>这个 <code>application.yml</code> 文件开启了优雅停机，设置了较长的停机超时时间以确保慢请求可以完成。<code>nacos.discovery.server-addr</code> 配置指向了我们稍后将在 Kubernetes 中部署的 Nacos Service。</p>
<h3 data-id="heading-5">第二部分：Docker 配置</h3>
<h4 data-id="heading-6">1. <code>Dockerfile</code></h4>
<p>在项目根目录创建 <code>Dockerfile</code> 文件：</p>
<pre><code class="hljs language-dockerfile" lang="dockerfile"># 使用官方的 Java 镜像作为基础镜像
FROM openjdk:17-jdk-slim

# 设置工作目录
WORKDIR /app

# 将 Maven 构建的 JAR 文件复制到容器中
# 注意：你需要先执行 `mvn clean package` 来生成这个 JAR 文件
COPY target/sc-alibaba-k8s-demo-0.0.1-SNAPSHOT.jar app.jar

# 暴露应用程序的端口
EXPOSE 8080

# 定义容器启动时执行的命令
# `-Djava.security.egd=file:/dev/./urandom` 用于提高随机数生成速度，避免启动慢
# `-Dserver.port=8080` 明确指定端口，Dockerfile EXPOSE 只是声明，但实际使用还是配置决定
ENTRYPOINT ["java", "-Djava.security.egd=file:/dev/./urandom", "-jar", "app.jar"]
</code></pre>
<h3 data-id="heading-7">第三部分：Kubernetes 部署文件</h3>
<p>为了在 Kubernetes 中运行我们的应用，我们需要：</p>
<ol>
<li><strong>部署 Nacos Server</strong>: Spring Cloud Alibaba 应用需要 Nacos 作为服务注册中心。</li>
<li><strong>部署我们的应用</strong>: 包含 Deployment 和 Service。</li>
</ol>
<h4 data-id="heading-8">1. Nacos Kubernetes 部署 (<code>nacos-kubernetes.yaml</code>)</h4>
<p>(为了测试的便捷性，这里部署单实例 Nacos。生产环境请部署高可用 Nacos 集群。)</p>
<p>将以下内容保存为 <code>nacos-kubernetes.yaml</code>：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">apps/v1</span>
<span class="hljs-attr">kind:</span> <span class="hljs-string">Deployment</span>
<span class="hljs-attr">metadata:</span>
  <span class="hljs-attr">name:</span> <span class="hljs-string">nacos-server</span>
  <span class="hljs-attr">labels:</span>
    <span class="hljs-attr">app:</span> <span class="hljs-string">nacos</span>
<span class="hljs-attr">spec:</span>
  <span class="hljs-attr">selector:</span>
    <span class="hljs-attr">matchLabels:</span>
      <span class="hljs-attr">app:</span> <span class="hljs-string">nacos</span>
  <span class="hljs-attr">replicas:</span> <span class="hljs-number">1</span>
  <span class="hljs-attr">template:</span>
    <span class="hljs-attr">metadata:</span>
      <span class="hljs-attr">labels:</span>
        <span class="hljs-attr">app:</span> <span class="hljs-string">nacos</span>
    <span class="hljs-attr">spec:</span>
      <span class="hljs-attr">containers:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">nacos</span>
        <span class="hljs-attr">image:</span> <span class="hljs-string">nacos/nacos-server:2.2.0</span> <span class="hljs-comment"># 使用 Nacos 官方镜像</span>
        <span class="hljs-attr">ports:</span>
        <span class="hljs-bullet">-</span> <span class="hljs-attr">containerPort:</span> <span class="hljs-number">8848</span> <span class="hljs-comment"># client port</span>
        <span class="hljs-bullet">-</span> <span class="hljs-attr">containerPort:</span> <span class="hljs-number">9848</span> <span class="hljs-comment"># raft port</span>
        <span class="hljs-bullet">-</span> <span class="hljs-attr">containerPort:</span> <span class="hljs-number">9849</span> <span class="hljs-comment"># raft port</span>
        <span class="hljs-attr">env:</span>
        <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">MODE</span>
          <span class="hljs-attr">value:</span> <span class="hljs-string">"standalone"</span> <span class="hljs-comment"># 单机模式</span>
        <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">JVM_XMS</span> <span class="hljs-comment"># 调整 JVM 内存，如果资源不足可以稍微调小</span>
          <span class="hljs-attr">value:</span> <span class="hljs-string">"256m"</span>
        <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">JVM_XMX</span>
          <span class="hljs-attr">value:</span> <span class="hljs-string">"256m"</span>
        <span class="hljs-comment"># 确保 Nacos 启动后可以响应健康检查</span>
        <span class="hljs-attr">livenessProbe:</span>
          <span class="hljs-attr">httpGet:</span>
            <span class="hljs-attr">path:</span> <span class="hljs-string">/nacos/actuator/health</span>
            <span class="hljs-attr">port:</span> <span class="hljs-number">8848</span>
          <span class="hljs-attr">initialDelaySeconds:</span> <span class="hljs-number">30</span>
          <span class="hljs-attr">periodSeconds:</span> <span class="hljs-number">10</span>
        <span class="hljs-attr">readinessProbe:</span>
          <span class="hljs-attr">httpGet:</span>
            <span class="hljs-attr">path:</span> <span class="hljs-string">/nacos/actuator/health</span>
            <span class="hljs-attr">port:</span> <span class="hljs-number">8848</span>
          <span class="hljs-attr">initialDelaySeconds:</span> <span class="hljs-number">20</span>
          <span class="hljs-attr">periodSeconds:</span> <span class="hljs-number">10</span>
        <span class="hljs-attr">volumeMounts:</span> <span class="hljs-comment"># 持久化 Nacos 数据</span>
        <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">nacos-storage</span>
          <span class="hljs-attr">mountPath:</span> <span class="hljs-string">/home/nacos/data</span>
      <span class="hljs-attr">volumes:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">nacos-storage</span>
        <span class="hljs-attr">emptyDir:</span> {} <span class="hljs-comment"># 简单起见使用 emptyDir，生产环境请使用 PersistentVolume/PersistentVolumeClaim</span>

<span class="hljs-meta">---</span>
<span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span>
<span class="hljs-attr">kind:</span> <span class="hljs-string">Service</span>
<span class="hljs-attr">metadata:</span>
  <span class="hljs-attr">name:</span> <span class="hljs-string">nacos-service</span> <span class="hljs-comment"># 这个名字要和 application.yml 中的 server-addr 匹配</span>
  <span class="hljs-attr">labels:</span>
    <span class="hljs-attr">app:</span> <span class="hljs-string">nacos</span>
<span class="hljs-attr">spec:</span>
  <span class="hljs-attr">ports:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">port:</span> <span class="hljs-number">8848</span>
    <span class="hljs-attr">targetPort:</span> <span class="hljs-number">8848</span>
    <span class="hljs-attr">name:</span> <span class="hljs-string">client</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">port:</span> <span class="hljs-number">9848</span>
    <span class="hljs-attr">targetPort:</span> <span class="hljs-number">9848</span>
    <span class="hljs-attr">name:</span> <span class="hljs-string">raft-http</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">port:</span> <span class="hljs-number">9849</span>
    <span class="hljs-attr">targetPort:</span> <span class="hljs-number">9849</span>
    <span class="hljs-attr">name:</span> <span class="hljs-string">raft-grpc</span>
  <span class="hljs-attr">selector:</span>
    <span class="hljs-attr">app:</span> <span class="hljs-string">nacos</span>
  <span class="hljs-attr">type:</span> <span class="hljs-string">ClusterIP</span> <span class="hljs-comment"># 内部服务，集群内访问</span>
</code></pre>
<h4 data-id="heading-9">2. 微服务 Kubernetes 部署 (<code>app-kubernetes.yaml</code>)</h4>
<p>将以下内容保存为 <code>app-kubernetes.yaml</code>：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">apps/v1</span>
<span class="hljs-attr">kind:</span> <span class="hljs-string">Deployment</span>
<span class="hljs-attr">metadata:</span>
  <span class="hljs-attr">name:</span> <span class="hljs-string">sc-alibaba-k8s-demo-deployment</span>
  <span class="hljs-attr">labels:</span>
    <span class="hljs-attr">app:</span> <span class="hljs-string">sc-alibaba-k8s-demo</span>
<span class="hljs-attr">spec:</span>
  <span class="hljs-attr">replicas:</span> <span class="hljs-number">3</span> <span class="hljs-comment"># 部署3个实例，方便观察滚动升级</span>
  <span class="hljs-attr">selector:</span>
    <span class="hljs-attr">matchLabels:</span>
      <span class="hljs-attr">app:</span> <span class="hljs-string">sc-alibaba-k8s-demo</span>
  <span class="hljs-attr">strategy:</span>
    <span class="hljs-attr">type:</span> <span class="hljs-string">RollingUpdate</span> <span class="hljs-comment"># 默认就是RollingUpdate，这里显式声明</span>
    <span class="hljs-attr">rollingUpdate:</span>
      <span class="hljs-attr">maxSurge:</span> <span class="hljs-number">1</span> <span class="hljs-comment"># 最多允许比期望数量多一个Pod</span>
      <span class="hljs-attr">maxUnavailable:</span> <span class="hljs-number">0</span> <span class="hljs-comment"># 最多允许有0个Pod不可用 (这是确保零停机的关键)</span>
  <span class="hljs-attr">template:</span>
    <span class="hljs-attr">metadata:</span>
      <span class="hljs-attr">labels:</span>
        <span class="hljs-attr">app:</span> <span class="hljs-string">sc-alibaba-k8s-demo</span>
        <span class="hljs-attr">version:</span> <span class="hljs-string">v1.0.0</span> <span class="hljs-comment"># 用于区分版本，方便升级</span>
    <span class="hljs-attr">spec:</span>
      <span class="hljs-attr">terminationGracePeriodSeconds:</span> <span class="hljs-number">120</span> <span class="hljs-comment"># 允许Pod最长120秒关闭，要大于 preStop hook + graceful shutdown timeout</span>
      <span class="hljs-attr">containers:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">sc-alibaba-k8s-demo</span>
        <span class="hljs-attr">image:</span> <span class="hljs-string">sc-alibaba-k8s-demo:v1.0.0</span> <span class="hljs-comment"># 初始镜像版本，需要本地构建</span>
        <span class="hljs-attr">imagePullPolicy:</span> <span class="hljs-string">IfNotPresent</span> <span class="hljs-comment"># 如果本地有就不拉取</span>
        <span class="hljs-attr">ports:</span>
        <span class="hljs-bullet">-</span> <span class="hljs-attr">containerPort:</span> <span class="hljs-number">8080</span>
        <span class="hljs-attr">livenessProbe:</span> <span class="hljs-comment"># 存活探针，检测应用是否还活着，失败则重启Pod</span>
          <span class="hljs-attr">httpGet:</span>
            <span class="hljs-attr">path:</span> <span class="hljs-string">/actuator/health/liveness</span>
            <span class="hljs-attr">port:</span> <span class="hljs-number">8080</span>
          <span class="hljs-attr">initialDelaySeconds:</span> <span class="hljs-number">15</span> <span class="hljs-comment"># 初始延迟</span>
          <span class="hljs-attr">periodSeconds:</span> <span class="hljs-number">10</span> <span class="hljs-comment"># 每10秒检查一次</span>
          <span class="hljs-attr">timeoutSeconds:</span> <span class="hljs-number">3</span>
          <span class="hljs-attr">failureThreshold:</span> <span class="hljs-number">3</span>
        <span class="hljs-attr">readinessProbe:</span> <span class="hljs-comment"># 就绪探针，检测应用是否可以接收流量，失败则从Service中移除</span>
          <span class="hljs-attr">httpGet:</span>
            <span class="hljs-attr">path:</span> <span class="hljs-string">/actuator/health/readiness</span>
            <span class="hljs-attr">port:</span> <span class="hljs-number">8080</span>
          <span class="hljs-attr">initialDelaySeconds:</span> <span class="hljs-number">30</span> <span class="hljs-comment"># 初始延迟，确保应用完全启动并注册Nacos后才Ready</span>
          <span class="hljs-attr">periodSeconds:</span> <span class="hljs-number">10</span>
          <span class="hljs-attr">timeoutSeconds:</span> <span class="hljs-number">3</span>
          <span class="hljs-attr">failureThreshold:</span> <span class="hljs-number">3</span>
        <span class="hljs-attr">lifecycle:</span>
          <span class="hljs-attr">preStop:</span> <span class="hljs-comment"># 在发送 TERM 信号前执行，给 K8s 和负载均衡器足够时间移除 Pod</span>
            <span class="hljs-attr">exec:</span>
              <span class="hljs-attr">command:</span> [<span class="hljs-string">"/bin/sh"</span>, <span class="hljs-string">"-c"</span>, <span class="hljs-string">"echo 'PreStop hook: Sleeping for 60 seconds to allow clients to drain and K8s to update endpoints.' &amp;&amp; sleep 60"</span>]
              <span class="hljs-comment"># 这个 sleep 时间应该足够长，以确保：</span>
              <span class="hljs-comment"># 1. K8s 将此 Pod 从 Service Endpoint 列表移除。</span>
              <span class="hljs-comment"># 2. 如果使用外部负载均衡 (如 Ingress Controller, LoadBalancer)，它们有时间更新路由。</span>
              <span class="hljs-comment"># 3. Nacos 上的本实例有足够时间被Service Registry移除 (通常是自动的，但延迟可以辅助)。</span>

<span class="hljs-meta">---</span>
<span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span>
<span class="hljs-attr">kind:</span> <span class="hljs-string">Service</span>
<span class="hljs-attr">metadata:</span>
  <span class="hljs-attr">name:</span> <span class="hljs-string">sc-alibaba-k8s-demo-service</span> <span class="hljs-comment"># 外部访问的服务名</span>
  <span class="hljs-attr">labels:</span>
    <span class="hljs-attr">app:</span> <span class="hljs-string">sc-alibaba-k8s-demo</span>
<span class="hljs-attr">spec:</span>
  <span class="hljs-attr">type:</span> <span class="hljs-string">LoadBalancer</span> <span class="hljs-comment"># 或者 NodePort，具体取决于你的本地 K8s 环境支持</span>
  <span class="hljs-attr">ports:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">port:</span> <span class="hljs-number">80</span>
    <span class="hljs-attr">targetPort:</span> <span class="hljs-number">8080</span>
  <span class="hljs-attr">selector:</span>
    <span class="hljs-attr">app:</span> <span class="hljs-string">sc-alibaba-k8s-demo</span>
</code></pre>
<p><strong><code>maxUnavailable: 0</code> 和 <code>maxSurge: 1</code> 策略解释：</strong></p>
<ul>
<li><code>maxUnavailable: 0</code>：在升级过程中，任何时候都不能有旧版本的 Pod 不可用。这意味着 Kubernetes 在启动并使一个新 Pod 就绪之前，不会停止任何旧 Pod。</li>
<li><code>maxSurge: 1</code>：允许的 Pod 数量比期望的 <code>replicas</code> 数量多一个。这意味着在升级开始时，Kubernetes 会先创建一个新 Pod，当这个新 Pod 成功启动并就绪后，它才会移除一个旧 Pod。</li>
</ul>
<p>这个组合确保了在升级的任何阶段，服务实例数量都不会低于期望值，从而实现零停机。</p>
<h3 data-id="heading-10">第四部分：测试验证步骤</h3>
<p>请确保您的 Docker Desktop/Minikube Kubernetes 环境已启动。</p>
<h4 data-id="heading-11">1. 部署 Nacos Server</h4>
<pre><code class="hljs language-bash" lang="bash">kubectl apply -f nacos-kubernetes.yaml
</code></pre>
<p>等待 Nacos Pod 启动并运行：</p>
<pre><code class="hljs language-bash" lang="bash">kubectl get pods -l app=nacos -w
<span class="hljs-comment"># 看到 nacos-server-xxxxx-yyyyy   1/1     Running 就绪</span>
</code></pre>
<h4 data-id="heading-12">2. 构建并推送 Docker 镜像</h4>
<p>进入 <code>sc-alibaba-k8s-demo</code> 项目根目录：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 1. 清理并打包 Spring Boot 应用为 JAR</span>
mvn clean package

<span class="hljs-comment"># 2. 构建 Docker 镜像 (版本命名为 v1.0.0)</span>
docker build -t sc-alibaba-k8s-demo:v1.0.0 .

<span class="hljs-comment"># 3. 验证镜像是否生成</span>
docker images | grep sc-alibaba-k8s-demo
</code></pre>
<p>如果您的 Kubernetes 是 Docker Desktop 内置的，那么这个镜像就会自动在 K8s 环境中可用。如果是 Minikube，您可能需要：<code>minikube docker-env</code> 然后 <code>eval $(minikube docker-env)</code>，再进行 <code>docker build</code>。</p>
<h4 data-id="heading-13">3. 部署微服务应用 v1.0.0</h4>
<pre><code class="hljs language-bash" lang="bash">kubectl apply -f app-kubernetes.yaml
</code></pre>
<p>等待应用 Pod 启动并运行：</p>
<pre><code class="hljs language-bash" lang="bash">kubectl get pods -l app=sc-alibaba-k8s-demo -w
<span class="hljs-comment"># 看到所有 Pod 都是 Running 状态 (3/3)</span>
</code></pre>
<p>获取 Service 的外部 IP/端口：</p>
<pre><code class="hljs language-bash" lang="bash">kubectl get svc sc-alibaba-k8s-demo-service
<span class="hljs-comment"># 查找 EXTERNAL-IP 和 PORT</span>
<span class="hljs-comment"># 如果是 Docker Desktop，通常 EXTERNAL-IP 是 localhost，NodePort 也会有</span>
<span class="hljs-comment"># 例如：localhost:30000 这样的，或者直接是 LoadBalancer 暴露的端口</span>
</code></pre>
<p>假设 Service 暴露在 <code>localhost:80</code> (如果是 NodePort，则可能是 <code>&lt;minikube-ip&gt;:&lt;node-port&gt;</code>)。</p>
<p>访问 <code>/hello</code> 接口验证：</p>
<pre><code class="hljs language-bash" lang="bash">curl http://localhost:80/hello
<span class="hljs-comment"># 应该会看到来自不同实例的 "Hello..." 响应</span>
</code></pre>
<h4 data-id="heading-14">4. 准备升级版本 v2.0.0</h4>
<p>我们将模拟对应用代码的修改，然后重新打包和部署。</p>
<h5 data-id="heading-15">修改代码：</h5>
<p>简单修改 <code>ScAlibabaK8sDemoApplication.java</code> 的 <code>/hello</code> 接口，例如：</p>
<pre><code class="hljs language-java" lang="java">    <span class="hljs-meta">@GetMapping("/hello")</span>
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">hello</span><span class="hljs-params">()</span> {
        System.out.println(<span class="hljs-string">"Instance "</span> + instanceId + <span class="hljs-string">" received /hello request. (v2.0.0)"</span>); <span class="hljs-comment">// 添加版本信息</span>
        <span class="hljs-keyword">return</span> <span class="hljs-string">"Hello from Spring Cloud Alibaba K8s Demo (v2.0.0, Instance: "</span> + instanceId + <span class="hljs-string">")!"</span>; <span class="hljs-comment">// 添加版本信息</span>
    }
</code></pre>
<h5 data-id="heading-16">重新构建 JAR 和 Docker 镜像：</h5>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 1. 清理并重新打包 Spring Boot 应用为 JAR</span>
mvn clean package

<span class="hljs-comment"># 2. 构建 Docker 镜像 (版本命名为 v2.0.0)</span>
docker build -t sc-alibaba-k8s-demo:v2.0.0 .
</code></pre>
<h4 data-id="heading-17">5. 执行滚动升级并验证无感</h4>
<p><strong>现在是关键步骤。</strong></p>
<h5 data-id="heading-18">5.1. 持续发送请求（模拟前端访问）</h5>
<p>打开两个终端窗口：</p>
<p><strong>终端 1 (发送慢请求):</strong></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 循环发送慢请求，观察哪个实例处理了请求</span>
<span class="hljs-comment"># 注意：第一次请求需要等待20秒才能看到结果</span>
<span class="hljs-keyword">while</span> <span class="hljs-literal">true</span>; <span class="hljs-keyword">do</span> curl http://localhost:80/slow-hello; <span class="hljs-built_in">echo</span>; <span class="hljs-built_in">sleep</span> 1; <span class="hljs-keyword">done</span>
</code></pre>
<p>这个命令会持续向服务发送慢请求。当一个 Pod 接收到 <code>TERM</code> 信号准备关闭时，如果它正在处理这样的慢请求，它应该<strong>完成</strong>这个请求，而不是中断。</p>
<p><strong>终端 2 (发送快请求):</strong></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 循环发送快请求，观察服务是否持续可用，以及版本切换情况</span>
<span class="hljs-keyword">while</span> <span class="hljs-literal">true</span>; <span class="hljs-keyword">do</span> curl http://localhost:80/hello; <span class="hljs-built_in">echo</span>; <span class="hljs-built_in">sleep</span> 0.1; <span class="hljs-keyword">done</span>
</code></pre>
<p>这个命令会高频次地向服务发送快请求。在滚动升级过程中，您应该始终看到成功响应，并且逐渐地，响应中的版本信息会从 <code>v1.0.0</code> 变为 <code>v2.0.0</code>，而不会出现连接错误或服务中断。</p>
<h5 data-id="heading-19">5.2. 在 Kubernetes 中执行升级</h5>
<p>在另一个终端修改 <code>app-kubernetes.yaml</code>，将 <code>image: sc-alibaba-k8s-demo:v1.0.0</code> 改为 <code>image: sc-alibaba-k8s-demo:v2.0.0</code>，并将 <code>template.metadata.labels.version</code> 也改为 <code>v2.0.0</code>。</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># ... (app-kubernetes.yaml 部分内容)</span>
  <span class="hljs-attr">template:</span>
    <span class="hljs-attr">metadata:</span>
      <span class="hljs-attr">labels:</span>
        <span class="hljs-attr">app:</span> <span class="hljs-string">sc-alibaba-k8s-demo</span>
        <span class="hljs-attr">version:</span> <span class="hljs-string">v2.0.0</span> <span class="hljs-comment"># &lt;--- 修改为 v2.0.0</span>
    <span class="hljs-attr">spec:</span>
      <span class="hljs-attr">terminationGracePeriodSeconds:</span> <span class="hljs-number">120</span>
      <span class="hljs-attr">containers:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">sc-alibaba-k8s-demo</span>
        <span class="hljs-attr">image:</span> <span class="hljs-string">sc-alibaba-k8s-demo:v2.0.0</span> <span class="hljs-comment"># &lt;--- 修改为 v2.0.0</span>
<span class="hljs-comment"># ...</span>
</code></pre>
<p>然后应用更新：</p>
<pre><code class="hljs language-bash" lang="bash">kubectl apply -f app-kubernetes.yaml
</code></pre>
<h5 data-id="heading-20">5.3. 观察和验证</h5>
<p>打开一个新的终端窗口：</p>
<p><strong>终端 3 (观察 Pod 生命周期):</strong></p>
<pre><code class="hljs language-bash" lang="bash">kubectl get pods -w -l app=sc-alibaba-k8s-demo
</code></pre>
<p>您将看到以下现象：</p>
<ol>
<li>一个新的 <code>v2.0.0</code> Pod 会被创建。</li>
<li>这个新 Pod 会经历 <code>Pending</code> -&gt; <code>ContainerCreating</code> -&gt; <code>Running</code>，但此时它的 <code>READY</code> 状态是 <code>0/1</code>。</li>
<li>只有当 <code>readinessProbe</code> 通过后，新 Pod 的 <code>READY</code> 状态才会变为 <code>1/1</code>。</li>
<li>此时，Kubernetes 会将这个新 Pod 添加到 Service 的 Endpoints 列表中。</li>
<li>然后，Kubernetes 会选择一个 <code>v1.0.0</code> 的旧 Pod 进行终止。</li>
<li>旧 Pod 进入 <code>Terminating</code> 状态。此时：
<ul>
<li><strong>Kubernetes 会执行 <code>preStop</code> hook (sleep 60秒)。</strong> 在这 60 秒内，Pod 会继续处理已接收的请求，但 Service 不会再向它发送新请求。</li>
<li><strong>同时，<code>kubectl get pods</code> 会显示 <code>Terminating</code> 状态。</strong> <code>READY</code> 状态可能会保持 <code>1/1</code> 或变成 <code>0/1</code>，具体取决于 <code>readinessProbe</code> 在 <code>preStop</code> hook 期间的状态。由于我们只有一个 <code>sleep</code>，<code>readinessProbe</code> 可能会在 <code>sleep</code> 期间仍是 <code>UP</code>，但 K8s 已经将其标记为 <code>Terminating</code> 并从 Service Endpoints 移除。</li>
<li><strong><code>preStop</code> hook 结束后，Kubernetes 发送 <code>TERM</code> 信号。</strong></li>
<li><strong>Spring Boot 应用启动优雅停机：</strong> 它会停止接受新请求，等待正在进行中的慢请求（20秒）完成。</li>
<li><strong>应用程序日志中会打印 Spring IoC 容器关闭、Web 服务器关闭等信息。</strong></li>
<li>当所有请求完成且应用程序关闭后，旧 Pod 会被完全移除。</li>
<li>这个过程会一直重复，直到所有 3 个 <code>v1.0.0</code> Pod 都被 3 个 <code>v2.0.0</code> Pod 替换。</li>
</ul>
</li>
</ol>
<p>您还会观察到：</p>
<ul>
<li><strong>终端 1 (慢请求):</strong> 即使旧 Pod 处于 <code>Terminating</code> 状态，它正在处理的慢请求也应该能够顺利完成，不会出现错误。当该 Pod 完全关闭后，新的慢请求会被路由到新的 <code>v2.0.0</code> 实例。</li>
<li><strong>终端 2 (快请求):</strong> 始终能得到响应。随着升级进行，您会看到响应逐渐从 <code>v1.0.0</code> 切换到 <code>v2.0.0</code>，中间不会有任何中断或错误。</li>
</ul>
<p><strong>终端 4 (观察 Pod 日志，特别是 <code>Terminating</code> 状态的 Pod):</strong></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 找出一个正在 Terminating 的旧 Pod 的名字，例如 sc-alibaba-k8s-demo-deployment-xxxxx-abcde</span>
kubectl logs -f sc-alibaba-k8s-demo-deployment-xxxxx-abcde
</code></pre>
<p>在旧 Pod 的日志中，您应该能看到：</p>
<ul>
<li>处理慢请求的 <code>"Instance ... received /slow-hello request..."</code> 和 <code>"Instance ... finished /slow-hello request."</code> 正常完成。</li>
<li>Spring Boot 捕获 <code>TERM</code> 信号并启动优雅停机的日志（例如，Tomcat 停止接收连接，关闭线程池等）。</li>
<li>Nacos 实例注销的日志。</li>
</ul>
<hr/>
<h3 data-id="heading-21">总结和关键点回顾</h3>
<ul>
<li><strong><code>maxUnavailable: 0</code> 和 <code>maxSurge: 1</code> 滚动升级策略</strong>：这是 Kubernetes 层面实现零停机的根本。它保证了始终有足够多的可用 Pod 处理流量。</li>
<li><strong><code>readinessProbe</code> (就绪探针)</strong>：
<ul>
<li><strong>新 Pod 启动时</strong>：确保只有当应用完全初始化（如连接 DB, 注册 Nacos）并真正准备好处理请求时，才会被添加到 Service 的 Endpoints。</li>
<li><strong>旧 Pod 终止前</strong>：Kubernetes 会在旧 Pod 被标记为 <code>Terminating</code> 后，等待 <code>readinessProbe</code> 最终失败（通常在 <code>preStop</code> hook 之后或 Spring Boot 停止后），才会将其从 Service Endpoints 彻底移除。</li>
</ul>
</li>
<li><strong><code>preStop</code> hook</strong>：提供了一个在 <code>TERM</code> 信号发送之前的预处理阶段。
<ul>
<li>我们使用 <code>sleep 60</code> 来给 Kubernetes 和所有中间件（如服务网格、负载均衡器）足够的时间来更新路由配置，确保旧 Pod 在开始优雅停机前，已经不再接收任何新请求。</li>
<li><code>terminationGracePeriodSeconds</code> 必须足够长，以覆盖 <code>preStop</code> hook 的执行时间，以及 Spring Boot 优雅停机处理最长请求的时间。</li>
</ul>
</li>
<li><strong>Spring Boot <code>server.shutdown: graceful</code></strong>：确保应用程序在收到 <code>TERM</code> 信号后，停止接受新请求，但会等待所有正在进行中的请求完成，从而避免客户端错误。</li>
<li><strong>Spring Cloud Alibaba Nacos 注销</strong>：当 Spring Application Context 关闭时，Spring Cloud Nacos 会自动将该实例从 Nacos 中注销，确保 Nacos Server 不会将流量路由到已关闭的实例。</li>
</ul>
<p>码字不易，点赞支持~~</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[RustFS：基于Rust的高性能分布式对象存储，重新定义数据存储新标准！]]></title>    <link>https://juejin.cn/post/7595911076014260260</link>    <guid>https://juejin.cn/post/7595911076014260260</guid>    <pubDate>2026-01-17T10:28:43.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7595911076014260260" data-draft-id="7595858760134131775" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="RustFS：基于Rust的高性能分布式对象存储，重新定义数据存储新标准！"/> <!----> <meta itemprop="datePublished" content="2026-01-17T10:28:43.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="对象存储与RustFS"/> <meta itemprop="url" content="https://juejin.cn/user/652466093570057"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            RustFS：基于Rust的高性能分布式对象存储，重新定义数据存储新标准！
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/652466093570057/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    对象存储与RustFS
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-17T10:28:43.000Z" title="Sat Jan 17 2026 10:28:43 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-17
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">RustFS：基于Rust的高性能分布式对象存储，重新定义数据存储新标准！</h2>
<blockquote>
<p>RustFS 是一个基于 Rust 语言开发的开源分布式对象存储系统，性能比 MinIO 快 2.3 倍，完全兼容 S3 协议，为企业级应用提供高性能、高可靠性的数据存储解决方案。</p>
</blockquote>
<h3 data-id="heading-1">引言：为什么需要分布式对象存储？</h3>
<p>在当今数据爆炸的时代，传统的文件系统和本地存储已经难以满足大规模数据存储的需求。企业级应用、云原生服务和大数据分析都需要处理海量的非结构化数据——图片、视频、日志文件、备份数据等。这就是分布式对象存储的用武之地。</p>
<p>与传统的文件系统不同，对象存储将数据作为独立对象进行管理，每个对象包含数据本身、元数据和全局唯一标识符。这种架构天然适合分布式环境，能够实现近乎无限的扩展性。</p>
<h3 data-id="heading-2">RustFS的设计理念</h3>
<h4 data-id="heading-3">为什么选择Rust语言？</h4>
<p>Rust语言以其内存安全、零成本抽象和高并发性能而闻名，这些特性使其成为构建分布式存储系统的理想选择：</p>
<ul>
<li><strong>内存安全</strong>：无需垃圾回收器即可防止内存泄漏和数据竞争</li>
<li><strong>高性能</strong>：接近C/C++的执行效率</li>
<li><strong>强大的并发模型</strong>：基于所有权系统的 fearless concurrency</li>
<li><strong>丰富的生态系统</strong>：拥有成熟的异步编程库和网络库</li>
</ul>
<h4 data-id="heading-4">核心架构设计</h4>
<p>RustFS采用经典的分布式存储架构，包含以下核心组件：</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-comment">// 简化的系统组件示意图</span>
<span class="hljs-keyword">pub</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">RustFSCluster</span> {
    metadata_servers: <span class="hljs-type">Vec</span>&lt;metadataserver&gt;,
    data_servers: <span class="hljs-type">Vec</span>&lt;dataserver&gt;,
    client_sdk: ClientSDK,
    load_balancer: LoadBalancer,
}
</code></pre>
<h3 data-id="heading-5">RustFS的核心特性</h3>
<h4 data-id="heading-6">1. 高性能数据存取</h4>
<p>RustFS通过多项优化技术实现极致性能：</p>
<p><strong>异步I/O和并行处理</strong></p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-comment">// 使用tokio实现异步写入</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">put_object</span>(&amp;<span class="hljs-keyword">self</span>, bucket: &amp;<span class="hljs-type">str</span>, key: &amp;<span class="hljs-type">str</span>, data: <span class="hljs-type">Vec</span>&lt;<span class="hljs-type">u8</span>&gt;) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">Result</span>&lt;putresult&gt; {
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">upload_id</span> = <span class="hljs-keyword">self</span>.<span class="hljs-title function_ invoke__">start_multipart_upload</span>(bucket, key).<span class="hljs-keyword">await</span>?;
    
    <span class="hljs-comment">// 并行上传数据分片</span>
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">chunks</span> = data.<span class="hljs-title function_ invoke__">chunks</span>(<span class="hljs-keyword">Self</span>::CHUNK_SIZE);
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">upload_tasks</span>: <span class="hljs-type">Vec</span>&lt;_&gt; = chunks.<span class="hljs-title function_ invoke__">enumerate</span>()
        .<span class="hljs-title function_ invoke__">map</span>(|(part_num, chunk)| {
            <span class="hljs-keyword">self</span>.<span class="hljs-title function_ invoke__">upload_part</span>(bucket, key, &amp;upload_id, part_num + <span class="hljs-number">1</span>, chunk.<span class="hljs-title function_ invoke__">to_vec</span>())
        })
        .<span class="hljs-title function_ invoke__">collect</span>();
    
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">results</span> = <span class="hljs-title function_ invoke__">join_all</span>(upload_tasks).<span class="hljs-keyword">await</span>;
    <span class="hljs-keyword">self</span>.<span class="hljs-title function_ invoke__">complete_multipart_upload</span>(bucket, key, &amp;upload_id, results).<span class="hljs-keyword">await</span>
}
</code></pre>
<p><strong>智能缓存机制</strong></p>
<ul>
<li>热点数据内存缓存</li>
<li>分层存储（SSD+HDD）</li>
<li>预读优化和缓存预热</li>
</ul>
<h4 data-id="heading-7">2. 强大的数据一致性保证</h4>
<p>RustFS提供多种一致性级别，满足不同场景需求：</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">pub</span> <span class="hljs-keyword">enum</span> <span class="hljs-title class_">ConsistencyLevel</span> {
    Strong,      <span class="hljs-comment">// 强一致性，写后读一致性</span>
    Eventual,    <span class="hljs-comment">// 最终一致性，更高可用性</span>
    ReadAfterWrite, <span class="hljs-comment">// 写后读一致性</span>
}
</code></pre>
<h4 data-id="heading-8">3. 企业级数据保护</h4>
<p><strong>数据冗余与纠删码</strong></p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-comment">// 使用Reed-Solomon纠删码</span>
<span class="hljs-keyword">pub</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">ErasureCoding</span> {
    data_shards: <span class="hljs-type">usize</span>,
    parity_shards: <span class="hljs-type">usize</span>,
}

<span class="hljs-keyword">impl</span> <span class="hljs-title class_">ErasureCoding</span> {
    <span class="hljs-keyword">pub</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">new</span>(data_shards: <span class="hljs-type">usize</span>, parity_shards: <span class="hljs-type">usize</span>) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-keyword">Self</span> {
        <span class="hljs-keyword">Self</span> { data_shards, parity_shards }
    }
    
    <span class="hljs-keyword">pub</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">encode</span>(&amp;<span class="hljs-keyword">self</span>, data: &amp;[<span class="hljs-type">u8</span>]) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">Result</span>&lt;vec&lt;vec&lt;<span class="hljs-type">u8</span>&gt;&gt;&gt; {
        <span class="hljs-comment">// 实现纠删码编码逻辑</span>
        <span class="hljs-comment">// 将数据分片并生成校验片</span>
    }
}
</code></pre>
<p><strong>数据加密与安全</strong></p>
<ul>
<li>传输层加密（TLS）</li>
<li>静态数据加密（AES-256）</li>
<li>客户端加密支持</li>
</ul>
<h3 data-id="heading-9">快速入门指南</h3>
<h4 data-id="heading-10">安装RustFS客户端</h4>
<p>在Cargo.toml中添加依赖：</p>
<pre><code class="hljs language-toml" lang="toml"><span class="hljs-section">[dependencies]</span>
<span class="hljs-attr">rustfs-client</span> = <span class="hljs-string">"0.1.0"</span>
<span class="hljs-attr">tokio</span> = { version = <span class="hljs-string">"1.0"</span>, features = [<span class="hljs-string">"full"</span>] }
</code></pre>
<h4 data-id="heading-11">基础使用示例</h4>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">use</span> rustfs_client::{Client, Config};
<span class="hljs-keyword">use</span> anyhow::<span class="hljs-type">Result</span>;

<span class="hljs-meta">#[tokio::main]</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">main</span>() <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">Result</span>&lt;()&gt; {
    <span class="hljs-comment">// 初始化客户端</span>
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">config</span> = Config {
        endpoint: <span class="hljs-string">"http://127.0.0.1:8080"</span>.<span class="hljs-title function_ invoke__">to_string</span>(),
        access_key: <span class="hljs-string">"your_access_key"</span>.<span class="hljs-title function_ invoke__">to_string</span>(),
        secret_key: <span class="hljs-string">"your_secret_key"</span>.<span class="hljs-title function_ invoke__">to_string</span>(),
        ..<span class="hljs-built_in">Default</span>::<span class="hljs-title function_ invoke__">default</span>()
    };
    
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">client</span> = Client::<span class="hljs-title function_ invoke__">new</span>(config)?;
    
    <span class="hljs-comment">// 创建存储桶</span>
    client.<span class="hljs-title function_ invoke__">create_bucket</span>(<span class="hljs-string">"my-bucket"</span>).<span class="hljs-keyword">await</span>?;
    
    <span class="hljs-comment">// 上传对象</span>
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">data</span> = <span class="hljs-string">b"Hello, RustFS!"</span>.<span class="hljs-title function_ invoke__">to_vec</span>();
    client.<span class="hljs-title function_ invoke__">put_object</span>(<span class="hljs-string">"my-bucket"</span>, <span class="hljs-string">"hello.txt"</span>, data).<span class="hljs-keyword">await</span>?;
    
    <span class="hljs-comment">// 下载对象</span>
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">downloaded</span> = client.<span class="hljs-title function_ invoke__">get_object</span>(<span class="hljs-string">"my-bucket"</span>, <span class="hljs-string">"hello.txt"</span>).<span class="hljs-keyword">await</span>?;
    <span class="hljs-built_in">println!</span>(<span class="hljs-string">"Downloaded: {}"</span>, <span class="hljs-type">String</span>::<span class="hljs-title function_ invoke__">from_utf8</span>(downloaded)?);
    
    <span class="hljs-title function_ invoke__">Ok</span>(())
}
</code></pre>
<h4 data-id="heading-12">高级功能示例</h4>
<p><strong>分片上传大文件</strong></p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">async</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">upload_large_file</span>(client: &amp;Client, bucket: &amp;<span class="hljs-type">str</span>, key: &amp;<span class="hljs-type">str</span>, file_path: &amp;Path) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">Result</span>&lt;()&gt; {
    <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">file</span> = File::<span class="hljs-title function_ invoke__">open</span>(file_path).<span class="hljs-keyword">await</span>?;
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">upload_id</span> = client.<span class="hljs-title function_ invoke__">create_multipart_upload</span>(bucket, key).<span class="hljs-keyword">await</span>?;
    
    <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">part_number</span> = <span class="hljs-number">1</span>;
    <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">parts</span> = <span class="hljs-type">Vec</span>::<span class="hljs-title function_ invoke__">new</span>();
    <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">buffer</span> = <span class="hljs-built_in">vec!</span>[<span class="hljs-number">0</span>; <span class="hljs-number">8</span> * <span class="hljs-number">1024</span> * <span class="hljs-number">1024</span>]; <span class="hljs-comment">// 8MB缓冲区</span>
    
    <span class="hljs-keyword">loop</span> {
        <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">bytes_read</span> = file.<span class="hljs-title function_ invoke__">read</span>(&amp;<span class="hljs-keyword">mut</span> buffer).<span class="hljs-keyword">await</span>?;
        <span class="hljs-keyword">if</span> bytes_read == <span class="hljs-number">0</span> {
            <span class="hljs-keyword">break</span>;
        }
        
        <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">part_data</span> = buffer[..bytes_read].<span class="hljs-title function_ invoke__">to_vec</span>();
        <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">part</span> = client.<span class="hljs-title function_ invoke__">upload_part</span>(bucket, key, &amp;upload_id, part_number, part_data).<span class="hljs-keyword">await</span>?;
        parts.<span class="hljs-title function_ invoke__">push</span>(part);
        part_number += <span class="hljs-number">1</span>;
    }
    
    client.<span class="hljs-title function_ invoke__">complete_multipart_upload</span>(bucket, key, &amp;upload_id, parts).<span class="hljs-keyword">await</span>?;
    <span class="hljs-title function_ invoke__">Ok</span>(())
}
</code></pre>
<h3 data-id="heading-13">性能基准测试</h3>
<p>我们在标准硬件配置下对RustFS进行了性能测试：</p>

























<table><thead><tr><th>操作类型</th><th>平均延迟</th><th>吞吐量</th></tr></thead><tbody><tr><td>小文件写入（1KB）</td><td>2.3ms</td><td>12,000 ops/s</td></tr><tr><td>大文件写入（100MB）</td><td>1.2s</td><td>830 MB/s</td></tr><tr><td>并发读取（100连接）</td><td>5.1ms</td><td>45,000 ops/s</td></tr></tbody></table>
<h3 data-id="heading-14">实际应用场景</h3>
<h4 data-id="heading-15">1. 云原生应用存储</h4>
<p>RustFS提供Kubernetes CSI驱动，无缝集成容器化环境。</p>
<h4 data-id="heading-16">2. 大数据分析平台</h4>
<p>作为数据湖存储层，支持Spark、Presto等计算引擎。</p>
<h4 data-id="heading-17">3. 媒体存储与分发</h4>
<p>为图片、视频等媒体文件提供可靠的存储和CDN集成。</p>
<h4 data-id="heading-18">4. 备份与容灾</h4>
<p>跨地域复制功能确保数据安全性和业务连续性。</p>
<h3 data-id="heading-19">最佳实践</h3>
<h4 data-id="heading-20">部署建议</h4>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># docker-compose.yml 示例</span>
<span class="hljs-attr">version:</span> <span class="hljs-string">'3.8'</span>
<span class="hljs-attr">services:</span>
  <span class="hljs-attr">rustfs-metadata:</span>
    <span class="hljs-attr">image:</span> <span class="hljs-string">rustfs/metadata:latest</span>
    <span class="hljs-attr">deploy:</span>
      <span class="hljs-attr">replicas:</span> <span class="hljs-number">3</span>
    <span class="hljs-attr">environment:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">RAFT_CLUSTER=metadata1:7000,metadata2:7000,metadata3:7000</span>
    
  <span class="hljs-attr">rustfs-data:</span>
    <span class="hljs-attr">image:</span> <span class="hljs-string">rustfs/data:latest</span>
    <span class="hljs-attr">deploy:</span>
      <span class="hljs-attr">replicas:</span> <span class="hljs-number">6</span>
    <span class="hljs-attr">environment:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">METADATA_ENDPOINTS=metadata1:7000,metadata2:7000,metadata3:7000</span>
</code></pre>
<h4 data-id="heading-21">性能调优</h4>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-comment">// 客户端配置优化</span>
<span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">optimized_config</span> = Config {
    endpoint: <span class="hljs-string">"http://rustfs-cluster:8080"</span>.<span class="hljs-title function_ invoke__">to_string</span>(),
    max_connections: <span class="hljs-number">100</span>,           <span class="hljs-comment">// 最大连接数</span>
    connect_timeout: Duration::<span class="hljs-title function_ invoke__">from_secs</span>(<span class="hljs-number">10</span>),
    timeout: Duration::<span class="hljs-title function_ invoke__">from_secs</span>(<span class="hljs-number">30</span>),
    retry_policy: RetryPolicy::ExponentialBackoff {
        max_retries: <span class="hljs-number">3</span>,
        base_delay: Duration::<span class="hljs-title function_ invoke__">from_millis</span>(<span class="hljs-number">100</span>),
    },
    ..<span class="hljs-built_in">Default</span>::<span class="hljs-title function_ invoke__">default</span>()
};
</code></pre>
<h3 data-id="heading-22">总结与展望</h3>
<p>RustFS凭借Rust语言的天然优势，在性能、安全性和可靠性方面表现出色。其简洁的API设计、丰富的功能和良好的扩展性，使其成为构建现代分布式应用的理想存储选择。</p>
<p><strong>未来规划：</strong></p>
<ul>
<li>支持S3兼容API</li>
<li>机器学习数据管道优化</li>
<li>边缘计算场景适配</li>
<li>更强的数据治理功能</li>
</ul>
<p>RustFS正在积极开发中，我们欢迎社区贡献和反馈。无论是功能建议、bug报告还是代码贡献，都将帮助RustFS变得更加完善。</p>
<hr/>
<p>以下是深入学习 RustFS 的推荐资源：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Frustfs%2Frustfs" target="_blank" title="https://github.com/rustfs/rustfs" ref="nofollow noopener noreferrer">RustFS</a></p>
<p>官方文档： <a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.rustfs.com%2Finstallation%2F" target="_blank" title="https://docs.rustfs.com/installation/" ref="nofollow noopener noreferrer">RustFS 官方文档</a>- 提供架构、安装指南和 API 参考。</p>
<p>GitHub 仓库： <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Forgs%2Frustfs%2Frepositories" target="_blank" title="https://github.com/orgs/rustfs/repositories" ref="nofollow noopener noreferrer">GitHub 仓库</a> - 获取源代码、提交问题或贡献代码。</p>
<p>社区支持： <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Forgs%2Frustfs%2Fdiscussions" target="_blank" title="https://github.com/orgs/rustfs/discussions" ref="nofollow noopener noreferrer">GitHub Discussions</a>- 与开发者交流经验和解决方案。</p>
<p>‍</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <!----></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[【2026毕设】4大维度+12项分析：Spark+Django皮肤癌数据可视化系统 毕业设计 选题推荐 毕设选题 数据分析 机器学习]]></title>    <link>https://juejin.cn/post/7595896809651847208</link>    <guid>https://juejin.cn/post/7595896809651847208</guid>    <pubDate>2026-01-17T10:59:30.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7595896809651847208" data-draft-id="7595864836360781876" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="【2026毕设】4大维度+12项分析：Spark+Django皮肤癌数据可视化系统 毕业设计 选题推荐 毕设选题 数据分析 机器学习"/> <meta itemprop="keywords" content="前端,Python,大数据"/> <meta itemprop="datePublished" content="2026-01-17T10:59:30.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="计算机编程指导师"/> <meta itemprop="url" content="https://juejin.cn/user/881156097585216"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            【2026毕设】4大维度+12项分析：Spark+Django皮肤癌数据可视化系统 毕业设计 选题推荐 毕设选题 数据分析 机器学习
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/881156097585216/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    计算机编程指导师
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-17T10:59:30.000Z" title="Sat Jan 17 2026 10:59:30 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-17
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">皮肤癌数据可视化分析系统-简介</h2>
<p>本系统是一个基于Spark+Django的皮肤癌数据可视化分析平台，旨在通过大数据技术处理和解析海量的医疗记录，从而揭示皮肤癌与多种潜在因素之间的深层关联。系统整体采用前后端分离架构，后端以Python的Django框架为核心，负责业务逻辑处理与API接口提供，并利用PySpark库与大数据集群进行交互。数据处理流程上，系统首先将存储于Hadoop HDFS中的原始皮肤癌患者数据集，通过Spark进行分布式清洗、转换和预处理，确保数据质量。核心分析引擎利用Spark SQL和DataFrame API，围绕四大核心功能模块展开计算：在患者多维画像层面，系统对患者的性别、年龄、吸烟饮酒习惯等数据进行聚合统计，构建高风险人群画像；在临床病变特征分析层面，系统对病变尺寸、高发身体部位及临床症状频率进行量化分析，为临床诊断提供数据参考；在风险因素挖掘层面，系统通过关联规则算法探索临床症状组合与诊断结果的强关联性；最后，在交叉验证分析层面，系统整合多维度数据，为不同诊断类型构建综合画像，并分析活检决策的影响因素。所有计算结果经由Django封装成RESTful API，最终由前端Vue框架结合Echarts组件，以动态、交互式的图表形式直观呈现给用户。</p>
<h2 data-id="heading-1">皮肤癌数据可视化分析系统-技术</h2>
<p>开发语言：Python或Java
大数据框架：Hadoop+Spark（本次没用Hive，支持定制）
后端框架：Django+Spring Boot(Spring+SpringMVC+Mybatis)
前端：Vue+ElementUI+Echarts+HTML+CSS+JavaScript+jQuery
详细技术点：Hadoop、HDFS、Spark、Spark SQL、Pandas、NumPy
数据库：MySQL</p>
<h2 data-id="heading-2">皮肤癌数据可视化分析系统-背景</h2>
<p>选题背景
近年来，随着公众健康意识的提升和医疗信息化的普及，医疗机构积累了海量的患者诊疗数据。皮肤癌作为最常见的恶性肿瘤之一，其早期发现与诊断对于提高患者生存率至关重要。然而，传统的数据统计分析方法往往难以有效处理和挖掘这些规模庞大、维度复杂的医疗数据中隐藏的价值，导致许多有价值的关联性规律未被充分利用。同时，对于计算机专业的学生而言，如何将前沿的大数据技术应用于实际且有社会意义的领域，是一个极具挑战性和价值的课题。因此，选择一个真实且复杂的医疗数据集，运用业界主流的大数据处理框架进行深度分析，不仅能够锻炼学生的工程实践能力，也能为医学研究提供一种新的数据驱动视角。</p>
<p>选题意义
这个毕业设计项目，虽然规模有限，但希望能带来一些实际的参考价值。从技术学习角度看，它能让同学完整地走一遍从数据采集、存储、清洗、分析到可视化展示的大数据项目全流程，深入掌握Spark和Django等核心技术，这比单纯做一个小型Web系统或CRUD项目要更有深度。从应用价值角度看，系统通过多维度数据分析得出的结论，比如特定年龄段的高发性、某些生活习惯与疾病的关联性，或许能为医学研究提供一些数据上的佐证或新的研究方向，为公众的健康科普和自我检查提供直观的参考。总的来说，它是一个将技术学习与社会价值相结合的尝试，体现了计算机科学在赋能其他学科方面的潜力。</p>
<h2 data-id="heading-3">皮肤癌数据可视化分析系统-视频展示</h2>
<p>[video(video-vrPrBp5I-1768646839144)(type-csdn)(url-<a href="https://link.juejin.cn?target=https%3A%2F%2Flive.csdn.net%2Fv%2Fembed%2F510510)(image-https%3A%2F%2Fi-blog.csdnimg.cn%2Fdirect%2F32e4c1c8a4964ce9a5b82c6d409c2067.png)(title-%25E5%259F%25BA%25E4%25BA%258ESpark%2BDjango%25E7%259A%2584%25E7%259A%25AE%25E8%2582%25A4%25E7%2599%258C%25E6%2595%25B0%25E6%258D%25AE%25E5%258F%25AF%25E8%25A7%2586%25E5%258C%2596%25E5%2588%2586%25E6%259E%2590%25E7%25B3%25BB%25E7%25BB%259F" target="_blank" title="https://live.csdn.net/v/embed/510510)(image-https://i-blog.csdnimg.cn/direct/32e4c1c8a4964ce9a5b82c6d409c2067.png)(title-%E5%9F%BA%E4%BA%8ESpark+Django%E7%9A%84%E7%9A%AE%E8%82%A4%E7%99%8C%E6%95%B0%E6%8D%AE%E5%8F%AF%E8%A7%86%E5%8C%96%E5%88%86%E6%9E%90%E7%B3%BB%E7%BB%9F" ref="nofollow noopener noreferrer">live.csdn.net/v/embed/510…</a>)]</p>
<h2 data-id="heading-4">皮肤癌数据可视化分析系统-图片展示</h2>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/20fdaed539e94f189c7fedbfd846eb53~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6K6h566X5py657yW56iL5oyH5a-85biI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769252370&amp;x-signature=T6NiT1njGrPlwbqU%2BhYOtvNXTvo%3D" alt="在这里插入图片描述" loading="lazy"/>
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3ae95d356efd41ddac85fd4dc543b956~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6K6h566X5py657yW56iL5oyH5a-85biI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769252370&amp;x-signature=LaxLSs48qcCLTl%2BqVjQRSi9lRtA%3D" alt="在这里插入图片描述" loading="lazy"/>
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/27edf02d705b4ce88d7c70ae7f453969~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6K6h566X5py657yW56iL5oyH5a-85biI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769252370&amp;x-signature=%2FLIDcD5nPjdvvkf02e0EDqnuKF0%3D" alt="在这里插入图片描述" loading="lazy"/>
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b161672b60d2491887824eb5087b179e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6K6h566X5py657yW56iL5oyH5a-85biI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769252370&amp;x-signature=urSYD8aIhEPfLYOQ%2FYtbT5Ifj2M%3D" alt="在这里插入图片描述" loading="lazy"/>
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ec00982f317545b19fc0e6cc885e9737~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6K6h566X5py657yW56iL5oyH5a-85biI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769252370&amp;x-signature=NLhkV%2FA%2Ba9EkvcyozJpY4ZoKYjs%3D" alt="在这里插入图片描述" loading="lazy"/>
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cae80deaf0444539bead3338167517ce~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6K6h566X5py657yW56iL5oyH5a-85biI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769252370&amp;x-signature=HYMSVR3OPGZdi9iR8DKFctudNVo%3D" alt="在这里插入图片描述" loading="lazy"/>
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ff4ff61513fc423ea9b7cc5e9831aa81~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6K6h566X5py657yW56iL5oyH5a-85biI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769252370&amp;x-signature=BHZqRXPImRon7u%2BmnGEwmrF1sFI%3D" alt="在这里插入图片描述" loading="lazy"/>
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1dac4a12cf054b60a65a6c750f983608~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6K6h566X5py657yW56iL5oyH5a-85biI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769252370&amp;x-signature=V%2BG%2F0DGEpDrV4j%2FAXKg%2BVGirx5k%3D" alt="在这里插入图片描述" loading="lazy"/>
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2ba2dfa86dec4e00ae16722daeaf77dc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6K6h566X5py657yW56iL5oyH5a-85biI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769252370&amp;x-signature=F3QEAyvNOypb4qCHwcI8Uy0npkw%3D" alt="在这里插入图片描述" loading="lazy"/>
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1d972214ec104337817b74715faa3cb0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6K6h566X5py657yW56iL5oyH5a-85biI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769252370&amp;x-signature=CYIpm%2BmgujdOMwyn7esIoBSww1k%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<h2 data-id="heading-5">皮肤癌数据可视化分析系统-代码展示</h2>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> pyspark.sql <span class="hljs-keyword">import</span> SparkSession, functions <span class="hljs-keyword">as</span> F

spark = SparkSession.builder.appName(<span class="hljs-string">"SkinCancerAnalysis"</span>).getOrCreate()
df = spark.read.csv(<span class="hljs-string">"hdfs://path/to/skin_cancer_data.csv"</span>, header=<span class="hljs-literal">True</span>, inferSchema=<span class="hljs-literal">True</span>)

<span class="hljs-keyword">def</span> <span class="hljs-title function_">analyze_age_structure</span>(<span class="hljs-params">df</span>):
    df_with_age_group = df.withColumn(<span class="hljs-string">"age_group"</span>, F.when((F.col(<span class="hljs-string">"age"</span>) &gt;= <span class="hljs-number">0</span>) &amp; (F.col(<span class="hljs-string">"age"</span>) &lt; <span class="hljs-number">30</span>), <span class="hljs-string">"青年"</span>)
                                     .when((F.col(<span class="hljs-string">"age"</span>) &gt;= <span class="hljs-number">30</span>) &amp; (F.col(<span class="hljs-string">"age"</span>) &lt; <span class="hljs-number">50</span>), <span class="hljs-string">"中年"</span>)
                                     .otherwise(<span class="hljs-string">"老年"</span>))
    age_diagnostic_count = df_with_age_group.groupBy(<span class="hljs-string">"age_group"</span>, <span class="hljs-string">"diagnostic"</span>).count()
    total_in_age_group = age_diagnostic_count.groupBy(<span class="hljs-string">"age_group"</span>).agg(F.<span class="hljs-built_in">sum</span>(<span class="hljs-string">"count"</span>).alias(<span class="hljs-string">"total"</span>))
    result = age_diagnostic_count.join(total_in_age_group, <span class="hljs-string">"age_group"</span>)
    result = result.withColumn(<span class="hljs-string">"percentage"</span>, F.<span class="hljs-built_in">round</span>((F.col(<span class="hljs-string">"count"</span>) / F.col(<span class="hljs-string">"total"</span>)) * <span class="hljs-number">100</span>, <span class="hljs-number">2</span>))
    result = result.orderBy(<span class="hljs-string">"age_group"</span>, <span class="hljs-string">"diagnostic"</span>)
    <span class="hljs-keyword">return</span> result.collect()

<span class="hljs-keyword">def</span> <span class="hljs-title function_">analyze_top_body_regions</span>(<span class="hljs-params">df</span>):
    region_count = df.<span class="hljs-built_in">filter</span>(F.col(<span class="hljs-string">"region"</span>).isNotNull()).groupBy(<span class="hljs-string">"region"</span>).count()
    top_regions = region_count.orderBy(F.col(<span class="hljs-string">"count"</span>).desc())
    <span class="hljs-keyword">return</span> top_regions.collect()

<span class="hljs-keyword">def</span> <span class="hljs-title function_">mine_symptom_associations_for_mel</span>(<span class="hljs-params">df</span>):
    mel_df = df.<span class="hljs-built_in">filter</span>(F.col(<span class="hljs-string">"diagnostic"</span>) == <span class="hljs-string">"MEL"</span>)
    symptom_cols = [<span class="hljs-string">"itch"</span>, <span class="hljs-string">"grew"</span>, <span class="hljs-string">"hurt"</span>, <span class="hljs-string">"changed"</span>, <span class="hljs-string">"bleed"</span>, <span class="hljs-string">"elevation"</span>]
    mel_symptoms = mel_df.select(*symptom_cols).na.fill(<span class="hljs-number">0</span>)
    frequent_itemsets = []
    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-built_in">len</span>(symptom_cols)):
        <span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(i + <span class="hljs-number">1</span>, <span class="hljs-built_in">len</span>(symptom_cols)):
            symptom_pair = mel_symptoms.<span class="hljs-built_in">filter</span>((F.col(symptom_cols[i]) == <span class="hljs-number">1</span>) &amp; (F.col(symptom_cols[j]) == <span class="hljs-number">1</span>))
            count = symptom_pair.count()
            <span class="hljs-keyword">if</span> count &gt; <span class="hljs-number">0</span>:
                frequent_itemsets.append({<span class="hljs-string">"symptom_pair"</span>: <span class="hljs-string">f"<span class="hljs-subst">{symptom_cols[i]}</span> &amp; <span class="hljs-subst">{symptom_cols[j]}</span>"</span>, <span class="hljs-string">"count"</span>: count})
    <span class="hljs-keyword">return</span> <span class="hljs-built_in">sorted</span>(frequent_itemsets, key=<span class="hljs-keyword">lambda</span> x: x[<span class="hljs-string">'count'</span>], reverse=<span class="hljs-literal">True</span>)
</code></pre>
<h2 data-id="heading-6">皮肤癌数据可视化分析系统-结语</h2>
<p>从数据处理到前端呈现，这个项目让我对大数据全流程开发有了更深的理解。虽然系统还有许多可以完善的地方，比如引入更复杂的预测模型，但它确实是一次宝贵的实践。希望这个分享能帮到正在为毕设发愁的同学，祝大家都能顺利通关。</p>
<p>毕设选题还在迷茫？这个结合了Spark大数据和Django的皮肤癌分析项目或许能给你灵感！觉得有用的话，别忘了点个赞和收藏，你的支持是我更新的最大动力！有任何问题或想法，欢迎在评论区留言交流，我们一起进步！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Hibernate（46） Hibernate的配置文件如何加载？]]></title>    <link>https://juejin.cn/post/7595801647247327251</link>    <guid>https://juejin.cn/post/7595801647247327251</guid>    <pubDate>2026-01-16T11:55:28.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7595801647247327251" data-draft-id="7595552420048338987" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Hibernate（46） Hibernate的配置文件如何加载？"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2026-01-16T11:55:28.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Victor356"/> <meta itemprop="url" content="https://juejin.cn/user/3492507879476878"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Hibernate（46） Hibernate的配置文件如何加载？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3492507879476878/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Victor356
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-16T11:55:28.000Z" title="Fri Jan 16 2026 11:55:28 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-16
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    16
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在Hibernate中，配置文件通常用于定义数据库连接信息、Hibernate属性和实体类映射等。常见的配置文件包括<code>hibernate.cfg.xml</code>和<code>hibernate.properties</code>。本文将详细介绍如何加载Hibernate的配置文件，并结合代码示例说明。</p>
<h3 data-id="heading-0">加载Hibernate配置文件</h3>
<h4 data-id="heading-1">1. 使用<code>hibernate.cfg.xml</code>加载配置</h4>
<p><code>hibernate.cfg.xml</code>是最常用的Hibernate配置文件。通常放置在类路径的根目录下。</p>
<h5 data-id="heading-2">示例配置文件 <code>hibernate.cfg.xml</code></h5>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">hibernate-configuration</span> <span class="hljs-keyword">PUBLIC</span>
        <span class="hljs-string">"-//Hibernate/Hibernate Configuration DTD 3.0//EN"</span>
        <span class="hljs-string">"http://hibernate.sourceforge.net/hibernate-configuration-3.0.dtd"</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">hibernate-configuration</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">session-factory</span>&gt;</span>
        <span class="hljs-comment">&lt;!-- 数据库连接配置 --&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"hibernate.connection.driver_class"</span>&gt;</span>com.mysql.cj.jdbc.Driver<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"hibernate.connection.url"</span>&gt;</span>jdbc:mysql://localhost:3306/your_database<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"hibernate.connection.username"</span>&gt;</span>your_username<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"hibernate.connection.password"</span>&gt;</span>your_password<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>

        <span class="hljs-comment">&lt;!-- Hibernate 属性配置 --&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"hibernate.dialect"</span>&gt;</span>org.hibernate.dialect.MySQLDialect<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"hibernate.show_sql"</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"hibernate.format_sql"</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"hibernate.hbm2ddl.auto"</span>&gt;</span>update<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>

        <span class="hljs-comment">&lt;!-- 映射类 --&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">mapping</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"com.example.domain.Product"</span>/&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">mapping</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"com.example.domain.Category"</span>/&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">session-factory</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">hibernate-configuration</span>&gt;</span>
</code></pre>
<h5 data-id="heading-3">加载<code>hibernate.cfg.xml</code>的示例代码</h5>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> org.hibernate.SessionFactory;
<span class="hljs-keyword">import</span> org.hibernate.cfg.Configuration;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HibernateUtil</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> SessionFactory sessionFactory;

    <span class="hljs-keyword">static</span> {
        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// 使用Configuration类加载hibernate.cfg.xml配置文件</span>
            sessionFactory = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Configuration</span>().configure(<span class="hljs-string">"hibernate.cfg.xml"</span>).buildSessionFactory();
        } <span class="hljs-keyword">catch</span> (Throwable ex) {
            System.err.println(<span class="hljs-string">"Initial SessionFactory creation failed."</span> + ex);
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ExceptionInInitializerError</span>(ex);
        }
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> SessionFactory <span class="hljs-title function_">getSessionFactory</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> sessionFactory;
    }
}
</code></pre>
<p>在上面的代码中，<code>new Configuration().configure("hibernate.cfg.xml")</code>会自动查找类路径下的<code>hibernate.cfg.xml</code>文件，并加载其中的配置信息。然后使用这些配置信息构建<code>SessionFactory</code>实例。</p>
<h4 data-id="heading-4">2. 使用<code>hibernate.properties</code>加载配置</h4>
<p>除了<code>hibernate.cfg.xml</code>，Hibernate还支持通过<code>hibernate.properties</code>文件加载配置信息。</p>
<h5 data-id="heading-5">示例配置文件 <code>hibernate.properties</code></h5>
<pre><code class="hljs language-properties" lang="properties">hibernate.connection.driver_class=com.mysql.cj.jdbc.Driver
hibernate.connection.url=jdbc:mysql://localhost:3306/your_database
hibernate.connection.username=your_username
hibernate.connection.password=your_password
hibernate.dialect=org.hibernate.dialect.MySQLDialect
hibernate.show_sql=true
hibernate.format_sql=true
hibernate.hbm2ddl.auto=update
</code></pre>
<h5 data-id="heading-6">加载<code>hibernate.properties</code>的示例代码</h5>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> org.hibernate.SessionFactory;
<span class="hljs-keyword">import</span> org.hibernate.cfg.Configuration;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HibernateUtil</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> SessionFactory sessionFactory;

    <span class="hljs-keyword">static</span> {
        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// 使用Configuration类加载hibernate.properties配置文件</span>
            <span class="hljs-type">Configuration</span> <span class="hljs-variable">configuration</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Configuration</span>();
            configuration.configure(); <span class="hljs-comment">// 默认会加载类路径下的hibernate.cfg.xml或hibernate.properties</span>
            sessionFactory = configuration.buildSessionFactory();
        } <span class="hljs-keyword">catch</span> (Throwable ex) {
            System.err.println(<span class="hljs-string">"Initial SessionFactory creation failed."</span> + ex);
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ExceptionInInitializerError</span>(ex);
        }
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> SessionFactory <span class="hljs-title function_">getSessionFactory</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> sessionFactory;
    }
}
</code></pre>
<p>在上面的代码中，<code>configuration.configure()</code>默认会加载类路径下的<code>hibernate.cfg.xml</code>或<code>hibernate.properties</code>文件，可以根据具体需求调整。</p>
<h3 data-id="heading-7">配置文件加载的深入解释</h3>
<ol>
<li>
<p><strong>Configuration类</strong>：</p>
<ul>
<li><code>org.hibernate.cfg.Configuration</code>类是Hibernate用来配置的核心类。它可以从XML文件或Java属性文件加载配置。</li>
<li><code>configure()</code>方法默认查找类路径根目录下的<code>hibernate.cfg.xml</code>文件。如果提供文件名参数，<code>configure("hibernate.properties")</code>则会加载指定文件。</li>
</ul>
</li>
<li>
<p><strong>SessionFactory</strong>：</p>
<ul>
<li><code>SessionFactory</code>是Hibernate框架中的关键对象，负责创建<code>Session</code>对象。<code>Session</code>对象是单线程的短期对象，用于执行CRUD操作。</li>
<li><code>SessionFactory</code>是线程安全的，可以在应用程序中全局共享，通常在应用启动时创建一次，并在整个应用生命周期中使用。</li>
</ul>
</li>
<li>
<p><strong>异常处理</strong>：</p>
<ul>
<li>在静态块中初始化<code>SessionFactory</code>，并捕获任何可能的异常。如果初始化失败，会抛出<code>ExceptionInInitializerError</code>，确保应用及时发现配置问题。</li>
</ul>
</li>
</ol>
<h3 data-id="heading-8">综合示例</h3>
<p>以下是一个完整的示例，展示如何配置并加载Hibernate配置文件，创建<code>SessionFactory</code>并执行一些基本操作。</p>
<h5 data-id="heading-9">完整示例</h5>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> org.hibernate.Session;
<span class="hljs-keyword">import</span> org.hibernate.SessionFactory;
<span class="hljs-keyword">import</span> org.hibernate.Transaction;
<span class="hljs-keyword">import</span> org.hibernate.cfg.Configuration;

<span class="hljs-comment">// HibernateUtil类</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HibernateUtil</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> SessionFactory sessionFactory;

    <span class="hljs-keyword">static</span> {
        <span class="hljs-keyword">try</span> {
            sessionFactory = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Configuration</span>().configure(<span class="hljs-string">"hibernate.cfg.xml"</span>).buildSessionFactory();
        } <span class="hljs-keyword">catch</span> (Throwable ex) {
            System.err.println(<span class="hljs-string">"Initial SessionFactory creation failed."</span> + ex);
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ExceptionInInitializerError</span>(ex);
        }
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> SessionFactory <span class="hljs-title function_">getSessionFactory</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> sessionFactory;
    }
}

<span class="hljs-comment">// Category类</span>
<span class="hljs-meta">@Entity</span>
<span class="hljs-meta">@Table(name = "category")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Category</span> {
    <span class="hljs-meta">@Id</span>
    <span class="hljs-meta">@GeneratedValue(strategy = GenerationType.IDENTITY)</span>
    <span class="hljs-keyword">private</span> Long id;

    <span class="hljs-meta">@Column(name = "name")</span>
    <span class="hljs-keyword">private</span> String name;

    <span class="hljs-meta">@OneToMany(mappedBy = "category", fetch = FetchType.LAZY, cascade = CascadeType.ALL)</span>
    <span class="hljs-keyword">private</span> Set&lt;Product&gt; products = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashSet</span>&lt;&gt;();

    <span class="hljs-comment">// Getters 和 Setters</span>
}

<span class="hljs-comment">// Product类</span>
<span class="hljs-meta">@Entity</span>
<span class="hljs-meta">@Table(name = "product")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Product</span> {
    <span class="hljs-meta">@Id</span>
    <span class="hljs-meta">@GeneratedValue(strategy = GenerationType.IDENTITY)</span>
    <span class="hljs-keyword">private</span> Long id;

    <span class="hljs-meta">@Column(name = "name")</span>
    <span class="hljs-keyword">private</span> String name;

    <span class="hljs-meta">@Column(name = "price")</span>
    <span class="hljs-keyword">private</span> Double price;

    <span class="hljs-meta">@ManyToOne</span>
    <span class="hljs-meta">@JoinColumn(name = "category_id")</span>
    <span class="hljs-keyword">private</span> Category category;

    <span class="hljs-comment">// Getters 和 Setters</span>
}

<span class="hljs-comment">// Hibernate测试类</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HibernateTest</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-comment">// 获取SessionFactory</span>
        <span class="hljs-type">SessionFactory</span> <span class="hljs-variable">sessionFactory</span> <span class="hljs-operator">=</span> HibernateUtil.getSessionFactory();

        <span class="hljs-comment">// 插入示例数据</span>
        insertSampleData(sessionFactory);

        <span class="hljs-comment">// 关闭SessionFactory</span>
        sessionFactory.close();
    }

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">insertSampleData</span><span class="hljs-params">(SessionFactory sessionFactory)</span> {
        <span class="hljs-type">Session</span> <span class="hljs-variable">session</span> <span class="hljs-operator">=</span> sessionFactory.openSession();
        <span class="hljs-type">Transaction</span> <span class="hljs-variable">transaction</span> <span class="hljs-operator">=</span> session.beginTransaction();
        <span class="hljs-keyword">try</span> {
            <span class="hljs-type">Category</span> <span class="hljs-variable">category</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Category</span>();
            category.setName(<span class="hljs-string">"Electronics"</span>);

            <span class="hljs-type">Product</span> <span class="hljs-variable">product1</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Product</span>();
            product1.setName(<span class="hljs-string">"Laptop"</span>);
            product1.setPrice(<span class="hljs-number">1000.0</span>);

            <span class="hljs-type">Product</span> <span class="hljs-variable">product2</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Product</span>();
            product2.setName(<span class="hljs-string">"Smartphone"</span>);
            product2.setPrice(<span class="hljs-number">500.0</span>);

            category.addProduct(product1);
            category.addProduct(product2);

            session.save(category);

            transaction.commit();
            System.out.println(<span class="hljs-string">"Inserted sample data"</span>);
        } <span class="hljs-keyword">catch</span> (Exception e) {
            <span class="hljs-keyword">if</span> (transaction != <span class="hljs-literal">null</span>) {
                transaction.rollback();
            }
            e.printStackTrace();
        } <span class="hljs-keyword">finally</span> {
            session.close();
        }
    }
}
</code></pre>
<p>在这个综合示例中，<code>HibernateUtil</code>类负责加载配置文件并创建<code>SessionFactory</code>，<code>Category</code>和<code>Product</code>类定义了实体，<code>HibernateTest</code>类则演示了如何使用Hibernate进行数据操作。通过这种方式，可以有效地加载和使用Hibernate的配置文件进行数据库操作。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Cursor 最新发现：超大型项目 AI 也能做了，上百个 Agent 一起上]]></title>    <link>https://juejin.cn/post/7595842144906854450</link>    <guid>https://juejin.cn/post/7595842144906854450</guid>    <pubDate>2026-01-17T09:13:48.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7595842144906854450" data-draft-id="7595831738234601481" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Cursor 最新发现：超大型项目 AI 也能做了，上百个 Agent 一起上"/> <meta itemprop="keywords" content="前端,AI编程,Cursor"/> <meta itemprop="datePublished" content="2026-01-17T09:13:48.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="张拭心"/> <meta itemprop="url" content="https://juejin.cn/user/571401775094312"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Cursor 最新发现：超大型项目 AI 也能做了，上百个 Agent 一起上
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/571401775094312/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    张拭心
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-17T09:13:48.000Z" title="Sat Jan 17 2026 09:13:48 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-17
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    3
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读10分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>大家好，我是拭心。</p>
<p>2008 年 9 月 2 日，Google Chrome 浏览器正式发布。这个项目从 2005 年立项到发布，<strong>「历时 3 年，投入了数千名工程师」</strong>。如今，Chromium 代码规模已超过 3600 万行，被称为“人类史上最复杂的软件工程项目之一”。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e5f05cf35b2346cd9a49256b01845beb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5byg5out5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769246245&amp;x-signature=mifJjS1mapz9Vx2UnF9lKUg9sDw%3D" alt="图片" loading="lazy"/></p>
<p>而就在最近，Cursor 团队做了一件让人震惊的事：<strong>「他们用上百个 AI Agent，花了不到一周时间，从零开始构建了一个浏览器，写出了超过 100 万行代码」</strong>。</p>
<p>这不是概念验证，也不是玩具项目。</p>
<p>他们用 Agent 持续运行数周，在多个超大型项目上写出了数百万行代码：Java LSP（55 万行）、Windows 7 模拟器（120 万行）、Excel（160 万行）。更令人震撼的是，它们还直接在 Cursor 自己的生产代码库中完成了一次大规模框架迁移，代码增删量达到 +266K/-193K，用时 3 周多。</p>
<p><strong>「从 3 年到 1 周，从数千名工程师到上百个 Agent，这不是量变，是质变」</strong>。</p>
<p>AI 编程正在跨越一个关键门槛：从“辅助写代码”到“自主开发项目”。</p>
<p>这篇文章我们来了解下 Cursor 是如何做到的，以及对我们意味着什么。</p>
<h2 data-id="heading-0">一、多 Agent 协作：从失败到突破</h2>
<p>单个 AI Agent 能写出几百行代码，但要开发一个百万行级别的项目，光靠一个 Agent 显然不够。</p>
<p>Cursor 团队的目标是让编码 Agent 持续运行数周，完全自主地完成超大型项目。</p>
<p>这意味着必须让上百个 Agent 同时工作。但问题来了：<strong>「怎么让它们高效协作，而不是互相干扰？」</strong></p>
<h3 data-id="heading-1">1.1 扁平结构：一场灾难</h3>
<p>Cursor 团队最初的想法很直觉：让所有 Agent 具有同等地位，通过一个共享文件自行协同。</p>
<p>每个 Agent 会检查其他 Agent 在做什么、认领一个任务并更新自己的状态。为防止两个 Agent 抢占同一项任务，他们使用了锁机制。</p>
<p>但这套方案在并发方面失败了：</p>
<p><strong>「锁机制成了瓶颈」</strong>。 Agent 会持有锁太久，或者干脆忘记释放锁。即使锁机制正常工作，它也会成为瓶颈。二十个 Agent 的速度会下降到相当于两三个 Agent 的有效吞吐量，大部分时间都花在等待上。</p>
<p><strong>「系统非常脆弱」</strong>。 Agent 可能在持有锁的情况下失败、尝试获取自己已经持有的锁，或者在完全没有获取锁的情况下更新协调文件。</p>
<p>后来他们尝试用乐观并发控制来替代锁：Agent 可以自由读取状态，但如果自上次读取后状态已经发生变化，则写入会失败。这种方式更简单、也更健壮，但更深层的问题依然存在。</p>
<p>在没有确定任务的情况下，Agent 变得非常规避风险。 它们会回避困难任务，转而做一些小而安全的修改。<strong>「没有任何一个 Agent 承担起解决难题或端到端实现的责任」</strong>（像极了曾经遇到的同事）。结果就是工作长时间在空转，却没有实质性进展。</p>
<p>这就像一个没有项目经理的团队，每个人都在做“看起来安全”的小任务，没人敢碰核心难题。</p>
<h3 data-id="heading-2">1.2 分层结构：像真实的团队一样工作</h3>
<p>Cursor 团队后来尝试里将不同角色拆分开来。不再使用每个 Agent 都什么都做的扁平结构，而是搭建了一条职责清晰的流水线：</p>
<ul>
<li><strong>「规划者」</strong>（Planners）：持续探索代码库并创建任务。他们可以针对特定区域派生子规划者，使规划过程本身也可以并行且递归地展开。</li>
<li><strong>「执行者」</strong>（Workers）：领取任务并专注于把任务完成到底。他们不会与其他执行者协调，也不关心整体大局，只是全力处理自己被分配的任务，完成后再提交变更。</li>
</ul>
<p>在每个周期结束时，会有一个**「评审 Agent」**判断是否继续，然后下一轮迭代会从干净的初始状态重新开始。</p>
<p>这套结构基本解决了协同问题，并且让他们可以扩展到非常大的项目，而不会让任何单个 Agent 陷入视野过于狭窄的状态。成百上千个 Worker 并发运行，向同一个分支推送代码，而且几乎没有冲突。</p>
<p>这就像一个真实的开发团队：<strong>「有人负责架构设计和任务拆解，有人专注执行具体任务，各司其职，高效协作。」</strong></p>
<h3 data-id="heading-3">1.3 三个震撼案例</h3>
<p>有了这套系统后，Cursor 团队开始测试它的边界：</p>
<p><strong>「从零开始构建浏览器」</strong>。 Agent 持续运行了将近一周，在 1，000 个文件中写出了超过 100 万行代码。虽然看起来只是一张简单的截图，但从零开始构建一个浏览器极其困难。尽管代码库规模庞大，新启动的 Agent 仍然可以理解它并取得实质性进展。</p>
<p><strong>「Cursor 代码库的框架迁移」</strong>。 他们在 Cursor 代码库中就地将 Solid 迁移到 React，整个过程持续了 3 周多，代码增删量达到 +266K/-193K。随着测试的进行，他们确实认为有可能合并这次大规模改动。</p>
<p><strong>「产品性能提升 25 倍」</strong>。 在一款即将上线的产品中，一个长时间运行的 Agent 通过一个高效的 Rust 实现，让视频渲染速度提升了 25 倍。它还新增了平滑缩放和平移的能力，使用自然的弹簧过渡和运动模糊效果，并能跟随光标顺畅移动。这部分代码已经合并，不久就会在生产环境中上线。</p>
<p>这些案例证明，多 Agent 开发大型项目不再是概念验证，而是真实的生产力。</p>
<h2 data-id="heading-4">二、为什么现在可以做到</h2>
<p>上百个 Agent 协作开发超大型项目，这在一年前几乎是不可想象的。Cursor 团队的成功，背后有几个关键因素。</p>
<h3 data-id="heading-5">2.1 模型能力的质变</h3>
<p>在运行时间极长的任务中，模型选择至关重要。Cursor 团队发现，不同模型在长时间自主工作时表现差异巨大。</p>
<p><strong>「GPT-5.2 系列在长时间自主工作方面要优秀得多：更能遵循指令、保持专注、避免偏离，并且在实现上更加精确和完整」</strong>。相比之下，Opus 4.5 往往会更早结束、在方便的时候走捷径，更快地把控制权交还给用户。</p>
<p>这不是说 Opus 4.5 不好，而是不同模型有不同的“性格”。Opus 4.5 更适合需要人类频繁介入的场景，而 GPT-5.2 更适合长时间无人值守的自主开发。</p>
<p>更有意思的是，不同模型在不同角色上各有所长。即便 GPT-5.1-codex 是专门为编码训练的，GPT-5.2 依然是更好的规划者。现在 Cursor 团队会**「针对每个角色选择最适合的模型，而不是依赖单一通用模型」**。</p>
<p>规划者用 GPT-5.2，执行者用 GPT-5.1-codex，评审者可能又是另一个模型。这就像组建一个真实团队，你会根据每个岗位的特点选择最合适的人。</p>
<h3 data-id="heading-6">2.2 提示词比框架更重要</h3>
<p>系统中有相当大一部分行为，很大程度上取决于如何为这些 Agent 设计提示词。要让它们良好协作、避免异常行为，并在长时间内保持专注，Cursor 团队做了大量实验。</p>
<p>运行框架和模型本身固然重要，但提示词更重要。</p>
<p>这个结论可能让很多人意外。我们往往以为技术架构和模型才是关键，但 Cursor 团队发现，同样的架构，不同的提示词设计，Agent 的表现会有天壤之别。</p>
<p>如何让规划者拆解任务时粒度合适？如何让执行者在遇到困难时不放弃？如何让评审者准确判断工作质量？这些都需要精心设计的提示词。</p>
<p>这也揭示了一个重要趋势：<strong>「Prompt Engineering（提示词工程）是成为 AI 时代的核心技能。」</strong></p>
<blockquote>
<p>❝</p>
<p>推荐阅读我写的《<a href="https://link.juejin.cn?target=https%3A%2F%2Fxiaobot.net%2Fp%2Fai_1024" target="_blank" title="https://xiaobot.net/p/ai_1024" ref="nofollow noopener noreferrer">提示词工程：你缺的不只是专业术语</a>》</p>
<p>❞</p>
</blockquote>
<h3 data-id="heading-7">2.3 减法思维：少即是多</h3>
<p>Cursor 团队的许多改进来自“减法”而不是“加法”。</p>
<p>一开始他们为质量控制和冲突解决设计了一个集成者（Integrator）角色，专门负责协调各个 Worker 的代码、解决冲突、确保质量。听起来很合理，对吧？</p>
<p>但后来发现，<strong>「集成者制造的瓶颈多于解决的问题。各个 Worker 本身就已经有能力处理彼此之间的冲突。多出来的这个角色反而让流程变得复杂、脆弱，成了整个系统的瓶颈」</strong>。</p>
<p>去掉集成者后，系统反而更流畅了。</p>
<p>这个经验很有启发性：最好的系统往往比你想的更简单。起初 Cursor 团队尝试借鉴分布式计算和组织设计中的系统模型，但并不是所有这些方法都适用于 Agent。</p>
<h2 data-id="heading-8">三、剧变来临的信号</h2>
<p>Cursor 团队告诉我们，<strong>「上百个 Agent 可以在同一个代码库上协同工作数周，推动雄心勃勃的项目取得实质进展。这不是理论，而是已经发生的现实」</strong>。</p>
<p>但他们也坦承：多智能体协同仍然是一个难题。当前的系统虽然可用，但离最优状态还差得很远。Planner 应该在任务完成时自动“醒来”规划下一步，Agent 有时会运行时间过长，他们仍然需要定期从头重启，以对抗漂移和思维视野过于狭窄的问题。</p>
<p>即便如此，对于核心问题——“能否通过投入更多 Agent 来扩展 AI 自主编码能力”——他们得到的答案依然比预期更乐观。</p>
<p>回顾过去几年 AI 编程工具的发展：</p>
<ul>
<li>2022 年：GitHub Copilot 补全代码片段</li>
<li>2023 年：ChatGPT 生成完整函数</li>
<li>2024 年：Cursor 理解项目上下文</li>
<li>2025 年：Cursor/TRAE 支持 Agent 自主开发</li>
<li>2026 年：Cursor 探索多 Agent 系统自主开发超大型项目</li>
</ul>
<p>编程工具进展神速，AI 从“辅助写代码”变成了“自主开发项目”。</p>
<p>今天，Cursor 用上百个 Agent 写出了 100 万行代码。明年呢？后年呢？AI 编程的能力边界正在快速扩张。</p>
<p>对于开发者来说：如果你的核心能力是“写代码”，那么你需要警惕了。<strong><a href="https://link.juejin.cn?target=https%3A%2F%2Fxiaobot.net%2Fp%2Fai_1024" target="_blank" title="https://xiaobot.net/p/ai_1024" ref="nofollow noopener noreferrer">但如果你的核心能力是“理解需求、设计架构、协调资源、解决问题”，那么你反而会因为 AI 而变得更强大。</a></strong></p>
<p>那些提前拥抱 AI、学会与 AI 协作的人，正在获得巨大的竞争优势。不要等到 AI 完全成熟了再去学习，因为到那时候，窗口期可能已经关闭了。</p>
<p>Cursor 用上百个 Agent 开发超大型项目，这不是终点，而是起点。剧变正在发生，你准备好了吗？</p>
<p>好了，这篇文章到这里就结束了。感谢你的阅读，愿你平安顺遂。</p>
<p>如果对你有帮助，欢迎评论点赞转发，你的支持是我最大的动力❤️</p>
<p>参考资料：</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fcursor.com%2Fcn%2Fblog%2Fscaling-agents" target="_blank" title="https://cursor.com/cn/blog/scaling-agents" ref="nofollow noopener noreferrer">cursor.com/cn/blog/sca…</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[ruoyi专题]]></title>    <link>https://juejin.cn/post/7595911076013932580</link>    <guid>https://juejin.cn/post/7595911076013932580</guid>    <pubDate>2026-01-17T06:38:30.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7595911076013932580" data-draft-id="7593296804110041128" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="ruoyi专题"/> <meta itemprop="keywords" content="Java,Spring Boot,前端"/> <meta itemprop="datePublished" content="2026-01-17T06:38:30.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="哪里的破水瓶"/> <meta itemprop="url" content="https://juejin.cn/user/4394111849466414"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            ruoyi专题
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4394111849466414/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    哪里的破水瓶
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-17T06:38:30.000Z" title="Sat Jan 17 2026 06:38:30 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-17
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#444;background-image:linear-gradient(90deg,rgba(59,59,59,.1) 3%,transparent 0),linear-gradient(1turn,rgba(122,120,121,.1) 3%,transparent 0);background-size:30px 30px;background-position:50%;letter-spacing:1px;word-spacing:1px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{position:relative;margin-top:34px;margin-bottom:16px;font-weight:700;line-height:1.3;cursor:text;color:#444;font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body h1{font-size:41px;margin-bottom:34px;line-height:1.5}.markdown-body h1:before{content:""}.markdown-body h2{font-size:30px;padding-left:.4em;border-left:.4em solid #5e5e5e;border-bottom:1px solid #444}.markdown-body h2:after{content:"🕛";position:absolute;top:0;right:0;transition:all;animation:rotate 10s linear infinite}@keyframes rotate{0%{transform:rotate(0deg)}to{transform:rotate(1turn)}}.markdown-body h3{border-left:.4em solid #8d8d8d;font-size:24px;padding-left:.4em}.markdown-body h4{font-size:20px}.markdown-body h5{font-size:16px}.markdown-body h6{font-size:14px}.markdown-body blockquote,.markdown-body dl,.markdown-body ol,.markdown-body p,.markdown-body table,.markdown-body ul{margin:.8em 0}.markdown-body strong{font-weight:1000;position:relative;color:#444;padding:0 3px}.markdown-body em{font-weight:inherit}.markdown-body a{box-sizing:border-box;color:grey;position:relative}.markdown-body a:before{position:absolute;box-sizing:border-box;content:"Go -&gt;";left:0;width:100%;max-width:0;color:#fff;background-color:hsla(0,0%,50.2%,.8);white-space:nowrap;transition:.2s ease;pointer-events:none;overflow:hidden}.markdown-body a:after{content:"";position:absolute;bottom:0;left:0;width:100%;height:1px;background-color:grey}.markdown-body a:active:before,.markdown-body a:hover:before{max-width:100%;padding-left:8px;border-radius:5px}.markdown-body hr{position:relative;width:100%;height:1px;border:none;margin-top:36px;margin-bottom:36px;background:linear-gradient(90deg,grey,#f1f1f1,#444,#444,#f1f1f1,grey);overflow:visible}.markdown-body ol,.markdown-body ul{padding-left:32px}.markdown-body ol li,.markdown-body ul li{margin-bottom:6px;list-style:inherit}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol{counter-reset:my-counter}.markdown-body ol&gt;li{padding-left:6px;list-style:none;counter-increment:my-counter;position:relative}.markdown-body ol&gt;li:before{position:absolute;left:-1.5em;content:counter(my-counter);font-weight:700}.markdown-body ol&gt;li:first-child:before{content:"1️⃣"}.markdown-body ol&gt;li:nth-child(2):before{content:"2️⃣"}.markdown-body ol&gt;li:nth-child(3):before{content:"3️⃣"}.markdown-body ol&gt;li:nth-child(4):before{content:"4️⃣"}.markdown-body ol&gt;li:nth-child(5):before{content:"5️⃣"}.markdown-body ol&gt;li:nth-child(6):before{content:"6️⃣"}.markdown-body ol&gt;li:nth-child(7):before{content:"7️⃣"}.markdown-body ol&gt;li:nth-child(8):before{content:"8️⃣"}.markdown-body ol&gt;li:nth-child(9):before{content:"9️⃣"}.markdown-body ol&gt;li:nth-child(10):before{content:"🔟"}.markdown-body ul&gt;li{list-style:none;position:relative}.markdown-body ul&gt;li:before{z-index:10;position:absolute;left:-1.57em;content:"🔹";margin-right:12px}.markdown-body ul&gt;li input{margin-left:8px!important}.markdown-body blockquote{position:relative;background-color:#d3d3d3;padding:5px 10px;border-left:.2em solid #000;border-radius:3px;transition:all .8s ease}.markdown-body blockquote:hover{opacity:.7}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:rgba(69,69,77,.8);color:#fff;font-size:.87em;padding:.07em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75;border-radius:7px;overflow:hidden}.markdown-body pre:before{z-index:10;position:absolute;top:14px;left:14px;width:12px;height:12px;border-radius:50%;background:#fc625d;-webkit-box-shadow:20px 0 #fdbc40,40px 0 #35cd4b;box-shadow:20px 0 #fdbc40,40px 0 #35cd4b;content:" "}.markdown-body pre:after{z-index:9;content:"";position:absolute;width:100%;height:40px;top:0;background-color:#1a1a1a}.markdown-body pre&gt;code{display:block;font-family:Menlo,Monaco,Consolas,Courier New,monospace;word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#171717;color:#bababa;font-size:14px;padding:40px 20px 20px}.markdown-body del{color:grey}.markdown-body table{margin-bottom:1.25rem;border-collapse:collapse}.markdown-body table td,.markdown-body table th{margin:0;padding:8px;line-height:20px;vertical-align:middle;border:1px solid #ddd}.markdown-body table thead,.markdown-body table tr:nth-child(2n){background-color:#fcfcfc}.markdown-body table thead th,.markdown-body table tr:nth-child(2n) th{font-weight:700;vertical-align:middle;color:#444}.markdown-body table tbody tr td{font-weight:400;color:#444}.markdown-body table tbody tr:hover{background-color:#d3d3d3}.markdown-body table tbody tr:hover td{color:#fff}.markdown-body img{max-width:100%;margin:0 12px}@media (max-width:720px){.markdown-body h1{font-size:32.8px}.markdown-body h2{font-size:24px}.markdown-body h3{font-size:19.2px}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:12.8px}}</style><style data-highlight="" data-highlight-key="a11y-dark">.hljs-comment,.hljs-quote{color:#d4d0ab}.hljs-deletion,.hljs-name,.hljs-regexp,.hljs-selector-class,.hljs-selector-id,.hljs-tag,.hljs-template-variable,.hljs-variable{color:#ffa07a}.hljs-built_in,.hljs-builtin-name,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-type{color:#f5ab35}.hljs-attribute{color:gold}.hljs-addition,.hljs-bullet,.hljs-string,.hljs-symbol{color:#abe338}.hljs-section,.hljs-title{color:#00e0e0}.hljs-keyword,.hljs-selector-tag{color:#dcc6e0}.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#2b2b2b;color:#f8f8f2}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}@media screen and (-ms-high-contrast:active){.hljs-addition,.hljs-attribute,.hljs-built_in,.hljs-builtin-name,.hljs-bullet,.hljs-comment,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-quote,.hljs-string,.hljs-symbol,.hljs-type{color:highlight}.hljs-keyword,.hljs-selector-tag{font-weight:700}}</style><h2 data-id="heading-0">修改器下载</h2>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgitee.com%2Flpf_project%2FRuoYi-MT" target="_blank" title="https://gitee.com/lpf_project/RuoYi-MT" ref="nofollow noopener noreferrer">gitee.com/lpf_project…</a></p>
<p>选择压缩包，配置修改内容，开始执行。会输出一个文件</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0979afba4c0c4176a77211e39a3c7068~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZOq6YeM55qE56C05rC055O2:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769247072&amp;x-signature=Q8THEbDjbgn5GYdepaad1RM8Xy8%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-1">Swagger</h2>
<p>Swagger 是一个规范和完整的框架，用于生成、描述、调用和可视化 RESTful 风格的 Web 服务</p>
<p>它的主要作用有：</p>
<ul>
<li>使得前后端分离开发更加方便，有利于团队协作</li>
<li>在线自动生成接口文档，降低后端开发人员编写接口文档的负担</li>
<li>功能测试</li>
</ul>
<p>Spring已经将Swagger纳入自身的标准，建立了Spring-Swagger项目，现在叫Springfox。通过在项目中引入Springfox ，就可以非常简单快捷的使用Swagger啦。</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- swagger3--&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>io.springfox<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>springfox-boot-starter<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>

<span class="hljs-comment">&lt;!-- 防止进入swagger页面报类型转换错误，排除3.0.0中的引用，手动增加1.6.2版本 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>io.swagger<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>swagger-models<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.6.2<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
</code></pre>
<blockquote>
<p>核心配置类</p>
</blockquote>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">/**
 * Swagger2的接口配置
 */</span>
<span class="hljs-meta">@Configuration</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SwaggerConfig</span> {
    <span class="hljs-comment">/**
     * 系统基础配置
     */</span>
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> RuoYiConfig ruoyiConfig;

    <span class="hljs-comment">/**
     * 是否开启swagger
     */</span>
    <span class="hljs-meta">@Value("${swagger.enabled}")</span>
    <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> enabled;

    <span class="hljs-comment">/**
     * 设置请求的统一前缀
     */</span>
    <span class="hljs-meta">@Value("${swagger.pathMapping}")</span>
    <span class="hljs-keyword">private</span> String pathMapping;

    <span class="hljs-comment">/**
     * 创建API
     */</span>
    <span class="hljs-meta">@Bean</span>
    <span class="hljs-keyword">public</span> Docket <span class="hljs-title function_">createRestApi</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Docket</span>(DocumentationType.OAS_30)
                <span class="hljs-comment">// 是否启用Swagger</span>
                .enable(enabled)
                <span class="hljs-comment">// 用来创建该API的基本信息，展示在文档的页面中（自定义展示的信息）</span>
                .apiInfo(apiInfo())
                <span class="hljs-comment">// 设置哪些接口暴露给Swagger展示</span>
                .select()
                <span class="hljs-comment">// 扫描所有有注解的api，用这种方式更灵活</span>
                .apis(RequestHandlerSelectors.withMethodAnnotation(ApiOperation.class))
                <span class="hljs-comment">// 扫描指定包中的swagger注解</span>
                <span class="hljs-comment">// .apis(RequestHandlerSelectors.basePackage("com.kzzyl.project.tool.swagger"))</span>
                <span class="hljs-comment">// 扫描所有 .apis(RequestHandlerSelectors.any())</span>
                .paths(PathSelectors.any())
                .build()
                <span class="hljs-comment">/* 设置安全模式，swagger可以设置访问token */</span>
                .securitySchemes(securitySchemes())
                .securityContexts(securityContexts())
                .pathMapping(pathMapping);
    }

    <span class="hljs-comment">/**
     * 安全模式，这里指定token通过Authorization头请求头传递
     */</span>
    <span class="hljs-keyword">private</span> List&lt;SecurityScheme&gt; <span class="hljs-title function_">securitySchemes</span><span class="hljs-params">()</span> {
        List&lt;SecurityScheme&gt; apiKeyList = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();
        apiKeyList.add(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ApiKey</span>(<span class="hljs-string">"Authorization"</span>, <span class="hljs-string">"Authorization"</span>, In.HEADER.toValue()));
        <span class="hljs-keyword">return</span> apiKeyList;
    }

    <span class="hljs-comment">/**
     * 安全上下文
     */</span>
    <span class="hljs-keyword">private</span> List&lt;SecurityContext&gt; <span class="hljs-title function_">securityContexts</span><span class="hljs-params">()</span> {
        List&lt;SecurityContext&gt; securityContexts = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();
        securityContexts.add(
                SecurityContext.builder()
                        .securityReferences(defaultAuth())
                        .operationSelector(o -&gt;
                                o.requestMappingPattern().matches(<span class="hljs-string">"/.*"</span>))
                        .build());
        <span class="hljs-keyword">return</span> securityContexts;
    }

    <span class="hljs-comment">/**
     * 默认的安全上引用
     */</span>
    <span class="hljs-keyword">private</span> List&lt;SecurityReference&gt; <span class="hljs-title function_">defaultAuth</span><span class="hljs-params">()</span> {
        <span class="hljs-type">AuthorizationScope</span> <span class="hljs-variable">authorizationScope</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AuthorizationScope</span>(<span class="hljs-string">"global"</span>,
                <span class="hljs-string">"accessEverything"</span>);
        AuthorizationScope[] authorizationScopes = <span class="hljs-keyword">new</span> <span class="hljs-title class_">AuthorizationScope</span>[<span class="hljs-number">1</span>];
        authorizationScopes[<span class="hljs-number">0</span>] = authorizationScope;
        List&lt;SecurityReference&gt; securityReferences = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();
        securityReferences.add(<span class="hljs-keyword">new</span> <span class="hljs-title class_">SecurityReference</span>(<span class="hljs-string">"Authorization"</span>, authorizationScopes));
        <span class="hljs-keyword">return</span> securityReferences;
    }

    <span class="hljs-comment">/**
     * 添加摘要信息
     */</span>
    <span class="hljs-keyword">private</span> ApiInfo <span class="hljs-title function_">apiInfo</span><span class="hljs-params">()</span> {
        <span class="hljs-comment">// 用ApiInfoBuilder进行定制</span>
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ApiInfoBuilder</span>()
                <span class="hljs-comment">// 设置标题</span>
                .title(<span class="hljs-string">"标题：若依管理系统_接口文档"</span>)
                <span class="hljs-comment">// 描述</span>
                .description(<span class="hljs-string">"描述：用于管理集团旗下公司的人员信息,具体包括XXX,XXX模块..."</span>)
                <span class="hljs-comment">// 作者信息</span>
                .contact(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Contact</span>(ruoyiConfig.getName(), <span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>))
                <span class="hljs-comment">// 版本</span>
                .version(<span class="hljs-string">"版本号:"</span> + ruoyiConfig.getVersion())
                .build();
    }
}

</code></pre>
<h2 data-id="heading-2">集成knife4j</h2>
<p>如果不习惯使用swagger可以使用前端UI的增强解决方案knife4j，对比swagger相比有以下优势，友好界面，离线文档，接口排序，安全控制，在线调试，文档清晰，注解增强，容易上手。
目前，企业项目中一般都使用knife4j框架。</p>
<blockquote>
<p>需要移除依赖，springfox-boot-starter 和 swagger-models</p>
</blockquote>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- SpringBoot2 使用依赖 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.github.xiaoymin<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>knife4j-spring-boot-starter<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.0.3<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
</code></pre>
<blockquote>
<p>前端修改 ry-ui\views\tool\swagger\index.vue 跳转地址，如下</p>
</blockquote>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> url = <span class="hljs-title function_">ref</span>(<span class="hljs-keyword">import</span>.<span class="hljs-property">meta</span>.<span class="hljs-property">env</span>.<span class="hljs-property">VITE_APP_BASE_API</span> + <span class="hljs-string">"/doc.html"</span>)
</code></pre>
<h3 data-id="heading-3">注解参数</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 作用到类上描述，标题</span>
<span class="hljs-meta">@Api(value = "护理项目管理", tags = "护理项目管理")</span>
<span class="hljs-comment">// 作用到方法上，描述具体的接口</span>
<span class="hljs-meta">@ApiOperation("查询护理项目列表")</span>
<span class="hljs-comment">// 作用到方法的参数上，描述参数信息</span>
<span class="hljs-meta">@ApiParam("查询条件对象")</span>
<span class="hljs-comment">// 作用到实体类上</span>
<span class="hljs-meta">@ApiModel("Entity基类")</span>
<span class="hljs-comment">// 作用到实体类的成员变量上</span>
<span class="hljs-meta">@ApiModelProperty("搜索值")</span>
</code></pre>
<h2 data-id="heading-4">Velocity模块引擎</h2>
<p>Velocity是一个基于Java的模板引擎，它可以通过特定的语法获取java对象的数据 , 填充到模板中，从而实现界面和java代码的分离。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3433d5b35001450990f095a738cd467f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZOq6YeM55qE56C05rC055O2:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769247072&amp;x-signature=aHo%2FU8y22hjMMHOlSFipBAJcnIQ%3D" alt="image.png" loading="lazy"/></p>
<p>常见的应用场景：</p>
<ul>
<li>Web应用程序 : 作为应用程序的视图, 展示数据。</li>
<li>源代码生成 : Velocity可以基于模板生成Java源代码。</li>
<li>自动电子邮件 : 网站注册， 认证等的电子邮件模板。</li>
<li>网页静态化 : 基于velocity模板生成静态网页。</li>
</ul>
<blockquote>
<p>案例</p>
</blockquote>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">//<span class="hljs-doctag">TODO:</span> 1.初始化velocity</span>
<span class="hljs-type">Properties</span> <span class="hljs-variable">p</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Properties</span>();
<span class="hljs-comment">// 加载classpath目录下的vm文件</span>
p.setProperty(<span class="hljs-string">"resource.loader.file.class"</span>, <span class="hljs-string">"org.apache.velocity.runtime.resource.loader.ClasspathResourceLoader"</span>);
<span class="hljs-comment">// 定义字符集</span>
p.setProperty(Velocity.INPUT_ENCODING, Constants.UTF8);
<span class="hljs-comment">// 初始化Velocity引擎，指定配置Properties</span>
Velocity.init(p);

<span class="hljs-comment">// <span class="hljs-doctag">TODO:</span> 2.创建Velocity上下文对象</span>
<span class="hljs-type">VelocityContext</span> <span class="hljs-variable">context</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">VelocityContext</span>();
context.put(<span class="hljs-string">"message"</span>, <span class="hljs-string">"加油朋友"</span>);

<span class="hljs-comment">// <span class="hljs-doctag">TODO:</span> 3.获取模板</span>
<span class="hljs-type">Template</span> <span class="hljs-variable">template</span> <span class="hljs-operator">=</span> Velocity.getTemplate(<span class="hljs-string">"vms/index.html.vm"</span>, Constants.UTF8);
<span class="hljs-comment">// 准备输出流，将文件写出</span>
<span class="hljs-type">FileWriter</span> <span class="hljs-variable">fileWriter</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileWriter</span>(<span class="hljs-string">"E:\\黑马ai\\kzzyl\\kzzyl-generator\\src\\main\\resources\\vms\\index.html"</span>);
<span class="hljs-comment">// <span class="hljs-doctag">TODO:</span> 4.合并模板和数据模型</span>
template.merge(context, fileWriter);

fileWriter.close();
</code></pre>
<p><strong>模板如下：使用 ${message} 传递 message 变量</strong></p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"en"</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">"UTF-8"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>Title<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">h3</span>&gt;</span>随便写点数据吧--${message}<span class="hljs-tag">&lt;/<span class="hljs-name">h3</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span>
</code></pre>
<p>Velocity语法解释</p>
<ul>
<li>${variable}: 表示插入变量值。</li>
<li>#foreach 和 #end: 循环结构，用于遍历列表。</li>
<li>#if 和 #end: 条件判断结构。</li>
<li>#set: 设置变量。</li>
<li>#elseif: 条件分支。</li>
</ul>
<h2 data-id="heading-5">集成 MybatisPlus</h2>
<p>在 common 下引入</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- MyBatis-Plus 增强CRUD --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.baomidou<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>mybatis-plus-boot-starter<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.5.2<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
</code></pre>
<p>删除 mybatis-config.xml 文件</p>
<pre><code class="hljs language-yml" lang="yml"><span class="hljs-comment"># MyBatisPlus配置</span>
<span class="hljs-attr">mybatis-plus:</span>
  <span class="hljs-comment"># 搜索指定包别名</span>
  <span class="hljs-attr">typeAliasesPackage:</span> <span class="hljs-string">com.kzzyl.**.domain</span>
  <span class="hljs-comment"># 配置mapper的扫描，找到所有的mapper.xml映射文件</span>
  <span class="hljs-attr">mapperLocations:</span> <span class="hljs-string">classpath*:mapper/**/*Mapper.xml</span>
  <span class="hljs-attr">global-config:</span>
    <span class="hljs-attr">db-config:</span>
      <span class="hljs-attr">id-type:</span> <span class="hljs-string">auto</span>
  <span class="hljs-attr">configuration:</span>
    <span class="hljs-comment"># 开启驼峰命名规则</span>
    <span class="hljs-attr">map-underscore-to-camel-case:</span> <span class="hljs-literal">true</span>
</code></pre>
<blockquote>
<p>删除 MyBatisConfig 文件，替换成 MyBatisPlusConfig 如下</p>
</blockquote>
<pre><code class="hljs language-java" lang="java">
<span class="hljs-comment">/**
 * Mybatis Plus 配置
 */</span>
<span class="hljs-meta">@EnableTransactionManagement(proxyTargetClass = true)</span>
<span class="hljs-meta">@Configuration</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MybatisPlusConfig</span> {

    <span class="hljs-meta">@Bean</span>
    <span class="hljs-keyword">public</span> MybatisPlusInterceptor <span class="hljs-title function_">mybatisPlusInterceptor</span><span class="hljs-params">()</span> {
        <span class="hljs-type">MybatisPlusInterceptor</span> <span class="hljs-variable">interceptor</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MybatisPlusInterceptor</span>();
        <span class="hljs-comment">// 分页插件</span>
        interceptor.addInnerInterceptor(paginationInnerInterceptor());
        <span class="hljs-comment">// 乐观锁插件</span>
        interceptor.addInnerInterceptor(optimisticLockerInnerInterceptor());
        <span class="hljs-comment">// 阻断插件</span>
        interceptor.addInnerInterceptor(blockAttackInnerInterceptor());
        <span class="hljs-keyword">return</span> interceptor;
    }

    <span class="hljs-comment">/**
     * 分页插件，自动识别数据库类型
     */</span>
    <span class="hljs-keyword">public</span> PaginationInnerInterceptor <span class="hljs-title function_">paginationInnerInterceptor</span><span class="hljs-params">()</span> {
        <span class="hljs-type">PaginationInnerInterceptor</span> <span class="hljs-variable">paginationInnerInterceptor</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">PaginationInnerInterceptor</span>();
        <span class="hljs-comment">// 设置数据库类型为mysql</span>
        paginationInnerInterceptor.setDbType(DbType.MYSQL);
        <span class="hljs-comment">// 设置最大单页限制数量，默认 500 条，-1 不受限制</span>
        paginationInnerInterceptor.setMaxLimit(-<span class="hljs-number">1L</span>);
        <span class="hljs-keyword">return</span> paginationInnerInterceptor;
    }

    <span class="hljs-comment">/**
     * 乐观锁插件
     */</span>
    <span class="hljs-keyword">public</span> OptimisticLockerInnerInterceptor <span class="hljs-title function_">optimisticLockerInnerInterceptor</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">OptimisticLockerInnerInterceptor</span>();
    }

    <span class="hljs-comment">/**
     * 如果是对全表的删除或更新操作，就会终止该操作
     */</span>
    <span class="hljs-keyword">public</span> BlockAttackInnerInterceptor <span class="hljs-title function_">blockAttackInnerInterceptor</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BlockAttackInnerInterceptor</span>();
    }

}
</code></pre>
<p>注意事项：</p>
<ol>
<li>需要在 BaseEntity 里 <code>params和searchValue</code> 需要设置 @TableField(exist = false)</li>
</ol>
<blockquote>
<p>方便直接拷贝</p>
</blockquote>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> com.kzzyl.common.core.domain;

<span class="hljs-keyword">import</span> java.io.Serial;
<span class="hljs-keyword">import</span> java.io.Serializable;
<span class="hljs-keyword">import</span> java.util.Date;
<span class="hljs-keyword">import</span> java.util.HashMap;
<span class="hljs-keyword">import</span> java.util.Map;

<span class="hljs-keyword">import</span> com.baomidou.mybatisplus.annotation.FieldFill;
<span class="hljs-keyword">import</span> com.baomidou.mybatisplus.annotation.TableField;
<span class="hljs-keyword">import</span> com.fasterxml.jackson.annotation.JsonFormat;
<span class="hljs-keyword">import</span> com.fasterxml.jackson.annotation.JsonIgnore;
<span class="hljs-keyword">import</span> com.fasterxml.jackson.annotation.JsonInclude;
<span class="hljs-keyword">import</span> io.swagger.annotations.ApiModel;
<span class="hljs-keyword">import</span> io.swagger.annotations.ApiModelProperty;
<span class="hljs-keyword">import</span> lombok.Data;

<span class="hljs-comment">/**
 * <span class="hljs-doctag">@author</span> Kun
 */</span>
<span class="hljs-meta">@Data</span>
<span class="hljs-meta">@ApiModel("Entity基类")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BaseEntity</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Serializable</span> {

    <span class="hljs-meta">@Serial</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">long</span> <span class="hljs-variable">serialVersionUID</span> <span class="hljs-operator">=</span> <span class="hljs-number">1L</span>;

    <span class="hljs-meta">@JsonIgnore</span>
    <span class="hljs-meta">@ApiModelProperty("搜索值")</span>
    <span class="hljs-meta">@TableField(exist = false)</span>
    <span class="hljs-keyword">private</span> String searchValue;

    <span class="hljs-meta">@ApiModelProperty("创建者")</span>
    <span class="hljs-meta">@TableField(fill = FieldFill.INSERT)</span>
    <span class="hljs-keyword">private</span> String createBy;

    <span class="hljs-meta">@JsonFormat(pattern = "yyyy-MM-dd HH:mm:ss")</span>
    <span class="hljs-meta">@TableField(fill = FieldFill.INSERT)</span>
    <span class="hljs-meta">@ApiModelProperty("创建时间")</span>
    <span class="hljs-keyword">private</span> Date createTime;

    <span class="hljs-meta">@ApiModelProperty("更新者")</span>
    <span class="hljs-meta">@TableField(fill = FieldFill.UPDATE)</span>
    <span class="hljs-keyword">private</span> String updateBy;

    <span class="hljs-meta">@JsonFormat(pattern = "yyyy-MM-dd HH:mm:ss")</span>
    <span class="hljs-meta">@TableField(fill = FieldFill.UPDATE)</span>
    <span class="hljs-meta">@ApiModelProperty("更新时间")</span>
    <span class="hljs-keyword">private</span> Date updateTime;

    <span class="hljs-comment">/**
     * 备注
     */</span>
    <span class="hljs-meta">@ApiModelProperty("备注")</span>
    <span class="hljs-keyword">private</span> String remark;

    <span class="hljs-comment">/**
     * 请求参数
     */</span>
    <span class="hljs-meta">@JsonInclude(JsonInclude.Include.NON_EMPTY)</span>
    <span class="hljs-meta">@TableField(exist = false)</span>
    <span class="hljs-meta">@ApiModelProperty("请求参数")</span>
    <span class="hljs-keyword">private</span> Map&lt;String, Object&gt; params;

    <span class="hljs-keyword">public</span> Map&lt;String, Object&gt; <span class="hljs-title function_">getParams</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">if</span> (params == <span class="hljs-literal">null</span>) {
            params = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();
        }
        <span class="hljs-keyword">return</span> params;
    }

}
</code></pre>
<h2 data-id="heading-6">MybatisPlus 自动填充</h2>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> com.kzzyl.framework.interceptor;

<span class="hljs-keyword">import</span> com.baomidou.mybatisplus.core.handlers.MetaObjectHandler;
<span class="hljs-keyword">import</span> com.kzzyl.common.utils.DateUtils;
<span class="hljs-keyword">import</span> com.kzzyl.common.utils.SecurityUtils;
<span class="hljs-keyword">import</span> org.apache.ibatis.reflection.MetaObject;
<span class="hljs-keyword">import</span> org.springframework.stereotype.Component;

<span class="hljs-keyword">import</span> java.util.Date;

<span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BaseEntityHandle</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">MetaObjectHandler</span> {
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">insertFill</span><span class="hljs-params">(MetaObject metaObject)</span> {
        <span class="hljs-built_in">this</span>.strictInsertFill(metaObject, <span class="hljs-string">"createBy"</span>, String.class, SecurityUtils.getUserId().toString());
        <span class="hljs-built_in">this</span>.strictInsertFill(metaObject, <span class="hljs-string">"createTime"</span>, Date.class, DateUtils.getNowDate());
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">updateFill</span><span class="hljs-params">(MetaObject metaObject)</span> {
        <span class="hljs-built_in">this</span>.setFieldValByName(<span class="hljs-string">"updateBy"</span>, SecurityUtils.getUserId().toString(), metaObject);
        <span class="hljs-built_in">this</span>.setFieldValByName(<span class="hljs-string">"updateTime"</span>, DateUtils.getNowDate(), metaObject);
    }

}
</code></pre>
<h2 data-id="heading-7">改造 controller 层</h2>
<p>代码模板在下面，这里只说一下需要调整的内置代码</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> lombok.Data;
<span class="hljs-keyword">import</span> lombok.NoArgsConstructor;

<span class="hljs-keyword">import</span> java.io.Serial;
<span class="hljs-keyword">import</span> java.io.Serializable;
<span class="hljs-keyword">import</span> java.util.List;

<span class="hljs-comment">/**
 * 表格分页数据对象
 */</span>
<span class="hljs-meta">@Data</span>
<span class="hljs-meta">@NoArgsConstructor</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TableDataInfo</span>&lt;T&gt; <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Serializable</span> {
    
    <span class="hljs-meta">@Serial</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">long</span> <span class="hljs-variable">serialVersionUID</span> <span class="hljs-operator">=</span> <span class="hljs-number">1L</span>;

    <span class="hljs-comment">/**
     * 总记录数
     */</span>
    <span class="hljs-keyword">private</span> <span class="hljs-type">long</span> total;

    <span class="hljs-comment">/**
     * 列表数据
     */</span>
    <span class="hljs-keyword">private</span> List&lt;T&gt; rows;

    <span class="hljs-comment">/**
     * 消息状态码
     */</span>
    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> code;

    <span class="hljs-comment">/**
     * 消息内容
     */</span>
    <span class="hljs-keyword">private</span> String msg;

    <span class="hljs-comment">/**
     * 分页
     *
     * <span class="hljs-doctag">@param</span> list  列表数据
     * <span class="hljs-doctag">@param</span> total 总记录数
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title function_">TableDataInfo</span><span class="hljs-params">(List&lt;T&gt; list, <span class="hljs-type">long</span> total)</span> {
        <span class="hljs-built_in">this</span>.rows = list;
        <span class="hljs-built_in">this</span>.total = total;
    }

}

</code></pre>
<p>还有 BaseController 中的下面方法</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">/**
 * 响应请求分页数据
 */</span>
<span class="hljs-keyword">protected</span> &lt;T&gt; TableDataInfo&lt;T&gt; <span class="hljs-title function_">getDataTable</span><span class="hljs-params">(List&lt;T&gt; list)</span> {
    TableDataInfo&lt;T&gt; rspData = <span class="hljs-keyword">new</span> <span class="hljs-title class_">TableDataInfo</span>&lt;&gt;();
    rspData.setCode(HttpStatus.SUCCESS);
    rspData.setMsg(<span class="hljs-string">"查询成功"</span>);
    rspData.setRows(list);
    rspData.setTotal(<span class="hljs-keyword">new</span> <span class="hljs-title class_">PageInfo</span>&lt;&gt;(list).getTotal());
    <span class="hljs-keyword">return</span> rspData;
}
</code></pre>
<h2 data-id="heading-8">修改时间类型为 LocalDate</h2>
<p>前端在 views/tool/editTable 文件中如下图位置。新增上 LocalDateTime</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a33e76adf0ed4e80a1d8f5b3d5f2fb7c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZOq6YeM55qE56C05rC055O2:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769247072&amp;x-signature=ruYh3D%2BFK2r95jOiACIjgvAqm20%3D" alt="image.png" loading="lazy"/></p>
<p>Java</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// src/main/java/com/kzzyl/common/constant/GenConstants.java</span>
<span class="hljs-comment">/** 时间类型 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">TYPE_LOCAL_DATE_TIME</span> <span class="hljs-operator">=</span> <span class="hljs-string">"LocalDateTime"</span>;

<span class="hljs-comment">// src/main/java/com/kzzyl/generator/util/VelocityUtils.java</span>
<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (!column.isSuperColumn() &amp;&amp; GenConstants.TYPE_LOCAL_DATE_TIME.equals(column.getJavaType())) {
    importList.add(<span class="hljs-string">"import java.time.LocalDateTime"</span>);
    importList.add(<span class="hljs-string">"com.fasterxml.jackson.annotation.JsonFormat"</span>);
}
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6714aa61f48f4757977a36549e8e28b2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZOq6YeM55qE56C05rC055O2:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769247072&amp;x-signature=QGb3nJh3bhU6Ibq%2BaF4vfAZMnt4%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-9">初始化字段对应关系修改</h2>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 在 src/main/java/com/kzzyl/generator/util/GenUtils.java</span>
<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (str != <span class="hljs-literal">null</span> &amp;&amp; str.length == <span class="hljs-number">1</span> &amp;&amp; Integer.parseInt(str[<span class="hljs-number">0</span>]) &lt;= <span class="hljs-number">10</span>
        || GenConstants.MYSQL_TINYINT.equals(column.getColumnType()) ||
        GenConstants.MYSQL_INT.equals(column.getColumnType())) {
    <span class="hljs-comment">// 修改为Integer</span>
    column.setJavaType(GenConstants.TYPE_INTEGER);
}
<span class="hljs-comment">// ---------------</span>
<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (arraysContains(GenConstants.COLUMNTYPE_TIME, dataType)) {
    <span class="hljs-comment">// 如果是时间类型 则生成LocalDateTime类型</span>
    column.setJavaType(GenConstants.TYPE_LOCAL_DATE_TIME);
    column.setHtmlType(GenConstants.HTML_DATETIME);
}

<span class="hljs-comment">// src/main/java/com/kzzyl/common/constant/GenConstants.java</span>
<span class="hljs-comment">/** MySql tinyint 类型 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">MYSQL_TINYINT</span> <span class="hljs-operator">=</span> <span class="hljs-string">"tinyint"</span>;

<span class="hljs-comment">/** MySql int 类型 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">MYSQL_INT</span> <span class="hljs-operator">=</span> <span class="hljs-string">"int"</span>;
</code></pre>
<h2 data-id="heading-10">代码生成模板</h2>
<p><strong>controller.java.vm</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> ${packageName}.controller;

<span class="hljs-keyword">import</span> java.util.List;
<span class="hljs-keyword">import</span> javax.servlet.http.HttpServletResponse;

<span class="hljs-keyword">import</span> lombok.AllArgsConstructor;
<span class="hljs-keyword">import</span> io.swagger.annotations.Api;
<span class="hljs-keyword">import</span> com.kzzyl.common.core.domain.R;
<span class="hljs-keyword">import</span> io.swagger.annotations.ApiParam;
<span class="hljs-keyword">import</span> io.swagger.annotations.ApiOperation;
<span class="hljs-keyword">import</span> org.springframework.security.access.prepost.PreAuthorize;
<span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.GetMapping;
<span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.PostMapping;
<span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.PutMapping;
<span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.DeleteMapping;
<span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.PathVariable;
<span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.RequestBody;
<span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;
<span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.RestController;
<span class="hljs-keyword">import</span> com.kzzyl.common.annotation.Log;
<span class="hljs-keyword">import</span> com.kzzyl.common.core.controller.BaseController;
<span class="hljs-keyword">import</span> com.kzzyl.common.core.domain.AjaxResult;
<span class="hljs-keyword">import</span> com.kzzyl.common.enums.BusinessType;
<span class="hljs-keyword">import</span> ${packageName}.domain.${ClassName};
<span class="hljs-keyword">import</span> ${packageName}.service.I${ClassName}Service;
<span class="hljs-keyword">import</span> com.kzzyl.common.utils.poi.ExcelUtil;
#<span class="hljs-keyword">if</span>($table.crud || $table.sub)
<span class="hljs-keyword">import</span> com.kzzyl.common.core.page.TableDataInfo;
#elseif($table.tree)
#end

<span class="hljs-comment">/**
 * ${functionName}Controller
 * 
 * <span class="hljs-doctag">@author</span> ${author}
 * date ${datetime}
 */</span>
<span class="hljs-meta">@RestController</span>
<span class="hljs-meta">@AllArgsConstructor</span>
<span class="hljs-meta">@RequestMapping("/${moduleName}/${businessName}")</span>
<span class="hljs-meta">@Api(value = "${functionName}管理", tags = "${functionName}管理")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">$</span>{ClassName}Controller <span class="hljs-keyword">extends</span> <span class="hljs-title class_">BaseController</span> {

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> I${ClassName}Service ${className}Service;

    <span class="hljs-comment">/**
     * 查询${functionName}列表
     */</span>
    <span class="hljs-meta">@ApiOperation("查询${functionName}列表")</span>
    <span class="hljs-meta">@PreAuthorize("@ss.hasPermi('${permissionPrefix}:list')")</span>
    <span class="hljs-meta">@GetMapping("/list")</span>
#<span class="hljs-keyword">if</span>($table.crud || $table.sub)
    <span class="hljs-keyword">public</span> TableDataInfo&lt;${ClassName}&gt; list(${ClassName} ${className}) {
        startPage();
        <span class="hljs-keyword">return</span> getDataTable(${className}Service.select${ClassName}List(${className}));
    }
#elseif($table.tree)
    <span class="hljs-keyword">public</span> AjaxResult <span class="hljs-title function_">list</span><span class="hljs-params">(${ClassName} ${className})</span>
    {
        List&lt;${ClassName}&gt; list = ${className}Service.select${ClassName}List(${className});
        <span class="hljs-keyword">return</span> success(list);
    }
#end

    <span class="hljs-comment">/**
     * 导出${functionName}列表
     */</span>
    <span class="hljs-meta">@ApiOperation("导出${functionName}列表")</span>
    <span class="hljs-meta">@PreAuthorize("@ss.hasPermi('${permissionPrefix}:export')")</span>
    <span class="hljs-meta">@Log(title = "${functionName}", businessType = BusinessType.EXPORT)</span>
    <span class="hljs-meta">@PostMapping("/export")</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">export</span><span class="hljs-params">(HttpServletResponse response, ${ClassName} ${className})</span> {
        List&lt;${ClassName}&gt; list = ${className}Service.select${ClassName}List(${className});
        ExcelUtil&lt;${ClassName}&gt; util = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ExcelUtil</span>&lt;&gt;(${ClassName}.class);
        util.exportExcel(response, list, <span class="hljs-string">"${functionName}数据"</span>);
    }

    <span class="hljs-comment">/**
     * 获取${functionName}详细信息
     */</span>
    <span class="hljs-meta">@ApiOperation("获取${functionName}列表")</span>
    <span class="hljs-meta">@PreAuthorize("@ss.hasPermi('${permissionPrefix}:query')")</span>
    <span class="hljs-meta">@GetMapping("/{${pkColumn.javaField}}")</span>
    <span class="hljs-keyword">public</span> R&lt;${ClassName}&gt; getInfo(<span class="hljs-meta">@PathVariable</span> <span class="hljs-meta">@ApiParam("唯一ID")</span> ${pkColumn.javaType} ${pkColumn.javaField}) {
        <span class="hljs-keyword">return</span> R.ok(${className}Service.select${ClassName}By${pkColumn.capJavaField}(${pkColumn.javaField}));
    }

    <span class="hljs-comment">/**
     * 新增${functionName}
     */</span>
    <span class="hljs-meta">@ApiOperation("新增${functionName}列表")</span>
    <span class="hljs-meta">@PreAuthorize("@ss.hasPermi('${permissionPrefix}:add')")</span>
    <span class="hljs-meta">@Log(title = "${functionName}", businessType = BusinessType.INSERT)</span>
    <span class="hljs-meta">@PostMapping</span>
    <span class="hljs-keyword">public</span> AjaxResult <span class="hljs-title function_">add</span><span class="hljs-params">(<span class="hljs-meta">@RequestBody</span> ${ClassName} ${className})</span> {
        <span class="hljs-keyword">return</span> toAjax(${className}Service.insert${ClassName}(${className}));
    }

    <span class="hljs-comment">/**
     * 修改${functionName}
     */</span>
    <span class="hljs-meta">@ApiOperation("修改${functionName}列表")</span>
    <span class="hljs-meta">@PreAuthorize("@ss.hasPermi('${permissionPrefix}:edit')")</span>
    <span class="hljs-meta">@Log(title = "${functionName}", businessType = BusinessType.UPDATE)</span>
    <span class="hljs-meta">@PutMapping</span>
    <span class="hljs-keyword">public</span> AjaxResult <span class="hljs-title function_">edit</span><span class="hljs-params">(<span class="hljs-meta">@RequestBody</span> ${ClassName} ${className})</span> {
        <span class="hljs-keyword">return</span> toAjax(${className}Service.update${ClassName}(${className}));
    }

    <span class="hljs-comment">/**
     * 删除${functionName}
     */</span>
    <span class="hljs-meta">@ApiOperation("删除${functionName}列表")</span>
    <span class="hljs-meta">@PreAuthorize("@ss.hasPermi('${permissionPrefix}:remove')")</span>
    <span class="hljs-meta">@Log(title = "${functionName}", businessType = BusinessType.DELETE)</span>
    <span class="hljs-meta">@DeleteMapping("/{${pkColumn.javaField}s}")</span>
    <span class="hljs-keyword">public</span> AjaxResult <span class="hljs-title function_">remove</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable</span> <span class="hljs-meta">@ApiParam("唯一ID集合")</span> ${pkColumn.javaType}[] ${pkColumn.javaField}s)</span> {
        <span class="hljs-keyword">return</span> toAjax(${className}Service.delete${ClassName}By${pkColumn.capJavaField}s(${pkColumn.javaField}s));
    }
}
</code></pre>
<p><strong>domain.java.vm</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> ${packageName}.domain;

<span class="hljs-keyword">import</span> lombok.*;

<span class="hljs-keyword">import</span> java.io.Serial;
#foreach ($<span class="hljs-keyword">import</span> in $importList)
<span class="hljs-keyword">import</span> ${<span class="hljs-keyword">import</span>};
#end

<span class="hljs-keyword">import</span> io.swagger.annotations.ApiModel;
<span class="hljs-keyword">import</span> com.kzzyl.common.annotation.Excel;
<span class="hljs-keyword">import</span> io.swagger.annotations.ApiModelProperty;
#<span class="hljs-keyword">if</span>($table.crud || $table.sub)
<span class="hljs-keyword">import</span> com.kzzyl.common.core.domain.BaseEntity;
#elseif($table.tree)
<span class="hljs-keyword">import</span> com.kzzyl.common.core.domain.TreeEntity;
#end

<span class="hljs-comment">/**
 * <span class="hljs-doctag">@author</span> ${author}
 * date ${datetime}
 */</span>
<span class="hljs-meta">@Data</span>
<span class="hljs-meta">@NoArgsConstructor</span>
<span class="hljs-meta">@AllArgsConstructor</span>
#<span class="hljs-keyword">if</span>($table.crud || $table.sub)
#set($Entity=<span class="hljs-string">"BaseEntity"</span>)
#elseif($table.tree)
#set($Entity=<span class="hljs-string">"TreeEntity"</span>)
#end
<span class="hljs-meta">@EqualsAndHashCode(callSuper = true)</span>
<span class="hljs-meta">@ApiModel(description = "${functionName}")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">$</span>{ClassName} <span class="hljs-keyword">extends</span> <span class="hljs-title class_">$</span>{Entity} {

    <span class="hljs-meta">@Serial</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">long</span> <span class="hljs-variable">serialVersionUID</span> <span class="hljs-operator">=</span> <span class="hljs-number">1L</span>;

#foreach ($column in $columns)
#<span class="hljs-keyword">if</span>(!$table.isSuperColumn($column.javaField))
#<span class="hljs-keyword">if</span>($column.list)
#set($parentheseIndex=$column.columnComment.indexOf(<span class="hljs-string">"（"</span>))
#<span class="hljs-keyword">if</span>($parentheseIndex != -<span class="hljs-number">1</span>)
#set($comment=$column.columnComment.substring(<span class="hljs-number">0</span>, $parentheseIndex))
#<span class="hljs-keyword">else</span>
#set($comment=$column.columnComment)
#end
#<span class="hljs-keyword">if</span>($parentheseIndex != -<span class="hljs-number">1</span>)
    <span class="hljs-meta">@Excel(name = "${comment}", readConverterExp = "$column.readConverterExp()")</span>
#elseif($column.javaType == <span class="hljs-string">'Date'</span> || $column.javaType == <span class="hljs-string">'LocalDateTime'</span>)
    <span class="hljs-meta">@JsonFormat(pattern = "yyyy-MM-dd HH:mm:ss")</span>
    <span class="hljs-meta">@Excel(name = "${comment}", width = 30, dateFormat = "yyyy-MM-dd HH:mm:ss")</span>
#<span class="hljs-keyword">else</span>
    <span class="hljs-meta">@Excel(name = "${comment}")</span>
#end
#end
    <span class="hljs-meta">@ApiModelProperty("${column.columnComment}")</span>
    <span class="hljs-keyword">private</span> $column.javaType $column.javaField;

#end
#end
#<span class="hljs-keyword">if</span>($table.sub)
    <span class="hljs-comment">/** $table.subTable.functionName信息 */</span>
    <span class="hljs-keyword">private</span> List&lt;${subClassName}&gt; ${subclassName}List;
#end
#<span class="hljs-keyword">if</span>($table.sub)
    <span class="hljs-keyword">public</span> List&lt;${subClassName}&gt; get${subClassName}List()
    {
        <span class="hljs-keyword">return</span> ${subclassName}List;
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> set${subClassName}List(List&lt;${subClassName}&gt; ${subclassName}List)
    {
        <span class="hljs-built_in">this</span>.${subclassName}List = ${subclassName}List;
    }
#end
}
</code></pre>
<p><strong>mapper.java.vm</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> ${packageName}.mapper;

<span class="hljs-keyword">import</span> java.util.List;

<span class="hljs-keyword">import</span> com.baomidou.mybatisplus.core.mapper.BaseMapper;
<span class="hljs-keyword">import</span> ${packageName}.domain.${ClassName};
#<span class="hljs-keyword">if</span>($table.sub)
<span class="hljs-keyword">import</span> ${packageName}.domain.${subClassName};
#end

<span class="hljs-comment">/**
 * ${functionName}Mapper接口
 * 
 * <span class="hljs-doctag">@author</span> ${author}
 * date ${datetime}
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">$</span>{ClassName}Mapper <span class="hljs-keyword">extends</span> <span class="hljs-title class_">BaseMapper</span>&lt;${ClassName}&gt; {

    <span class="hljs-comment">/**
     * 查询${functionName}
     * 
     * <span class="hljs-doctag">@param</span> ${pkColumn.javaField} ${functionName}主键
     */</span>
    ${ClassName} select${ClassName}By${pkColumn.capJavaField}(${pkColumn.javaType} ${pkColumn.javaField});

    <span class="hljs-comment">/**
     * 查询${functionName}列表
     * 
     * <span class="hljs-doctag">@param</span> ${className} ${functionName}
     */</span>
    List&lt;${ClassName}&gt; select${ClassName}List(${ClassName} ${className});

    <span class="hljs-comment">/**
     * 新增${functionName}
     * 
     * <span class="hljs-doctag">@param</span> ${className} ${functionName}
     */</span>
    <span class="hljs-type">int</span> insert${ClassName}(${ClassName} ${className});

    <span class="hljs-comment">/**
     * 修改${functionName}
     * 
     * <span class="hljs-doctag">@param</span> ${className} ${functionName}
     */</span>
    <span class="hljs-type">int</span> update${ClassName}(${ClassName} ${className});

    <span class="hljs-comment">/**
     * 删除${functionName}
     * 
     * <span class="hljs-doctag">@param</span> ${pkColumn.javaField} ${functionName}主键
     */</span>
    <span class="hljs-type">int</span> delete${ClassName}By${pkColumn.capJavaField}(${pkColumn.javaType} ${pkColumn.javaField});

    <span class="hljs-comment">/**
     * 批量删除${functionName}
     * 
     * <span class="hljs-doctag">@param</span> ${pkColumn.javaField}s 需要删除的数据主键集合
     */</span>
    <span class="hljs-type">int</span> delete${ClassName}By${pkColumn.capJavaField}s(${pkColumn.javaType}[] ${pkColumn.javaField}s);
#<span class="hljs-keyword">if</span>($table.sub)

    <span class="hljs-comment">/**
     * 批量删除${subTable.functionName}
     * 
     * <span class="hljs-doctag">@param</span> ${pkColumn.javaField}s 需要删除的数据主键集合
     */</span>
    <span class="hljs-type">int</span> delete${subClassName}By${subTableFkClassName}s(${pkColumn.javaType}[] ${pkColumn.javaField}s);
    
    <span class="hljs-comment">/**
     * 批量新增${subTable.functionName}
     * 
     * <span class="hljs-doctag">@param</span> ${subclassName}List ${subTable.functionName}列表
     */</span>
    <span class="hljs-type">int</span> batch${subClassName}(List&lt;${subClassName}&gt; ${subclassName}List);
    

    <span class="hljs-comment">/**
     * 通过${functionName}主键删除${subTable.functionName}信息
     * 
     * <span class="hljs-doctag">@param</span> ${pkColumn.javaField} ${functionName}ID
     */</span>
    <span class="hljs-type">int</span> delete${subClassName}By${subTableFkClassName}(${pkColumn.javaType} ${pkColumn.javaField});
#end
}
</code></pre>
<p><strong>service.java.vm</strong></p>
<pre><code class="hljs language-vm" lang="vm">package ${packageName}.service;

import java.util.List;

import com.baomidou.mybatisplus.extension.service.IService;
import ${packageName}.domain.${ClassName};

/**
 * ${functionName}Service接口
 * 
 * @author ${author}
 * date ${datetime}
 */
public interface I${ClassName}Service extends IService&lt;${ClassName}&gt; {

    /**
     * 查询${functionName}
     * 
     * @param ${pkColumn.javaField} ${functionName}主键
     */
    ${ClassName} select${ClassName}By${pkColumn.capJavaField}(${pkColumn.javaType} ${pkColumn.javaField});

    /**
     * 查询${functionName}列表
     * 
     * @param ${className} ${functionName}
     */
    List&lt;${ClassName}&gt; select${ClassName}List(${ClassName} ${className});

    /**
     * 新增${functionName}
     * 
     * @param ${className} ${functionName}
     */
    boolean insert${ClassName}(${ClassName} ${className});

    /**
     * 修改${functionName}
     * 
     * @param ${className} ${functionName}
     */
    boolean update${ClassName}(${ClassName} ${className});

    /**
     * 批量删除${functionName}
     * 
     * @param ${pkColumn.javaField}s 需要删除的${functionName}主键集合
     */
    boolean delete${ClassName}By${pkColumn.capJavaField}s(${pkColumn.javaType}[] ${pkColumn.javaField}s);

}
</code></pre>
<p><strong>serviceImpl.java.vm</strong></p>
<pre><code class="hljs language-vm" lang="vm">package ${packageName}.service;

import java.util.List;

import com.baomidou.mybatisplus.extension.service.IService;
import ${packageName}.domain.${ClassName};

/**
 * ${functionName}Service接口
 * 
 * @author ${author}
 * date ${datetime}
 */
public interface I${ClassName}Service extends IService&lt;${ClassName}&gt; {

    /**
     * 查询${functionName}
     * 
     * @param ${pkColumn.javaField} ${functionName}主键
     */
    ${ClassName} select${ClassName}By${pkColumn.capJavaField}(${pkColumn.javaType} ${pkColumn.javaField});

    /**
     * 查询${functionName}列表
     * 
     * @param ${className} ${functionName}
     */
    List&lt;${ClassName}&gt; select${ClassName}List(${ClassName} ${className});

    /**
     * 新增${functionName}
     * 
     * @param ${className} ${functionName}
     */
    boolean insert${ClassName}(${ClassName} ${className});

    /**
     * 修改${functionName}
     * 
     * @param ${className} ${functionName}
     */
    boolean update${ClassName}(${ClassName} ${className});

    /**
     * 批量删除${functionName}
     * 
     * @param ${pkColumn.javaField}s 需要删除的${functionName}主键集合
     */
    boolean delete${ClassName}By${pkColumn.capJavaField}s(${pkColumn.javaType}[] ${pkColumn.javaField}s);

}
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[使用Python在Linux上实现简单抓包工具的完整教程]]></title>    <link>https://juejin.cn/post/7596181746061295643</link>    <guid>https://juejin.cn/post/7596181746061295643</guid>    <pubDate>2026-01-17T09:42:10.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7596181746061295643" data-draft-id="7595847940621778994" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="使用Python在Linux上实现简单抓包工具的完整教程"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2026-01-17T09:42:10.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="开心就好2025"/> <meta itemprop="url" content="https://juejin.cn/user/3850962908492660"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            使用Python在Linux上实现简单抓包工具的完整教程
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3850962908492660/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    开心就好2025
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-17T09:42:10.000Z" title="Sat Jan 17 2026 09:42:10 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-17
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>Python抓包发包实现游戏自动化 python抓包程序</p>
<p>现代计算机程序大部分时候离不开网络，作为开发者，在日常开发网络相关的程序或者排查程序错误时经常会用抓包工具来分析网卡收发的数据，比如著名的tcpdump，Wireshark等。对于需要全平台支持且无需代理或越狱的抓包需求，Sniffmaster是一个强大的选择，它支持HTTPS、TCP和UDP协议，并在iOS、Android、Mac和Windows设备上提供暴力抓包和代理抓包功能。</p>
<p>今天我们尝试用100行左右的Python代码在Linux系统上实现一个简单的抓包工具。</p>
<p>本文共分为四节，前三节分别介绍了三个基本概念，包括端序、socket、以太网帧结构，最后一节介绍具体实现，文末有完整代码。</p>
<ol>
<li>端序</li>
</ol>
<p>试想一个16进制数0x12345678，大端序在内存中的储存顺序如下，高字节保存在内存的低地址，高字节在前：</p>
<p>内存地址 0 1 2 3</p>
<p>---------------------</p>
<p>字节数据 | 12 | 34 | 56 | 78 |</p>
<p>---------------------</p>
<p>而小端序高字节保存在内存的高地址，低字节在前：</p>
<p>内存地址 0 1 2 3</p>
<p>---------------------</p>
<p>字节数据 | 78 | 56 | 34 | 12 |</p>
<p>---------------------</p>
<p>大端序还是小端序是由硬件决定的，通常CPU和内存中的数据都是小端序，而网络传输都用大端序，因为大端序字节流解析起来更方便，但有些特殊的设备是例外。</p>
<p>Python中socket模块的htons，ntohs，htonl，ntohl函数用来处理网络字节顺序与本地字节顺序之间的转换。函数名中h表示host，n表示net，s表示short int（2字节），l表示long int（4字节），比如htons是将2字节长的整数从本地端序转换为网络端序。比如：</p>
<p>import socket</p>
<p>i = 0x1234 # 本地小端序</p>
<p>net_i = socket.htons(i) # 网络大端序</p>
<p>print(hex(i), hex(net_i))</p>
<p># 输出 0x1234 0x3412</p>
<ol start="2">
<li>socket编程</li>
</ol>
<p>socket是操作系统用户与TCP/IP协议族通信的接口，创建一个socket需要3个参数，地址簇，socket类型，协议。比如可以用以下代码创建一个常用的TCP套接字，用来收发TCP数据流：</p>
<p>import socket</p>
<p># AF_INET: internet协议簇</p>
<p># SOCK_STREAM: stream类型的socket</p>
<p># 0: 使用该socket类型的默认协议，即TCP协议</p>
<p>sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM, 0)</p>
<p>也可以用以下代码创建一个UDP套接字，用来收发UDP数据包：</p>
<p># SOCK_STREAM: data gram类型的socket</p>
<p># 0: 使用该socket类型的默认协议，即UDP协议</p>
<p>sock = socket.socket(socket.AF_INET, socket.SOCK_DGRAM, 0)</p>
<p>但是我们今天要用的不是这类套接字，而是更底层的原始套接字raw socket，这类套接字可以操作更底的协议比如IP协议和以太网协议，创建raw socket需要root权限。可以用以下代码创建一个接收以太网数据包的原始套接字：</p>
<p>ETH_P_ALL = 0x3</p>
<p>ETH_P_IP = 0x0800</p>
<p>ETH_P_ARP = 0x0806</p>
<p>ETH_P_RARP = 0x8035</p>
<p>ETH_P_IPV6 = 0x086dd</p>
<p>raw_sock = socket.socket(socket.AF_PACKET, socket.SOCK_RAW, socket.htons(ETH_P_ALL))</p>
<p>其中ETH_P_ALL表示监听所有协议的以太网数据包，如果改用ETH_P_IP则只会监听IP协议的数据包。（由于Windows系统上没有定义AF_PACKET，所以这段代码无法在Windows系统上运行）</p>
<p>然后可以开始监听：</p>
<p>while True:</p>
<p>packet, packet_info = raw_sock.recvfrom(1500)</p>
<p>print(packet)</p>
<p>recvfrom函数返回2个值，第一个是以太网数据包，第二个是该数据包相关的信息。</p>
<ol start="3">
<li>以太网帧格式</li>
</ol>
<p>以太网帧根据不同的标准有多种格式，常见的有Ethernet II格式和Ethernet 802.3格式。</p>
<p>Ethernet II帧格式DMAC：6字节，目标MAC地址</p>
<p>SMAC：6字节，源MAC地址</p>
<p>Type：2字节，上层协议类型</p>
<p>Data：46～1500字节可变长度，载荷数据</p>
<p>FCS：最后4字节，帧校验</p>
<p>Ethernet 802.3帧格式DMAC：6字节，目标MAC地址</p>
<p>SMAC：6字节，源MAC地址</p>
<p>Length：2字节，Data字段包含的字节数</p>
<p>LLC：3字节，逻辑链路控制</p>
<p>SNAP：5字节，Sub-network Access Protocol</p>
<p>Data：38～1492字节可变长度，载荷数据</p>
<p>FCS：最后4字节，帧校验</p>
<p>可以看到Ethernet II和Ethernet802.3格式的前12字节结构相同，由于Ethernet 802.3的头部多了8字节，所以载荷数据长度最大只能为1492字节。另外需要注意，原始套接字读取到的包最后不包含帧校验。</p>
<ol start="4">
<li>解析以太网头部</li>
</ol>
<p>在我们了解了以太网帧格式后就可以开始解析接收到的二进制数据了，我们可以用以下代码把MAC地址转换成整数：</p>
<p>BIG_ENDIAN = 'big'</p>
<p>dst_mac = int.from_bytes(packet[:6], BIG_ENDIAN)</p>
<p>src_mac = int.from_bytes(packet[6:12], BIG_ENDIAN)</p>
<p>从第12、13字节用来区分接收到的是Ethernet II帧还是Ethernet 802.3帧，如果该数字小于等于1500（0x05DC）可以判断接收到的是Ethernet 802.3帧，如果该数字大于等于1536（0x0600）则接收到的是Ethernet II帧。其他字段按照帧格式依次解析即可。</p>
<p>完整代码如下：</p>
<p>import socket</p>
<p>BIG_ENDIAN = 'big'</p>
<p>LITTLE_ENDIAN = 'little'</p>
<p>ETH_P_ALL = 0x3</p>
<p>ETH_P_IP = 0x0800</p>
<p>ETH_P_ARP = 0x0806</p>
<p>ETH_P_RARP = 0x8035</p>
<p>ETH_P_IPV6 = 0x086dd</p>
<p>ETH_TYPE_MAP = {</p>
<p>ETH_P_IP: 'IP',</p>
<p>ETH_P_ARP: 'ARP',</p>
<p>ETH_P_RARP: 'RARP',</p>
<p>ETH_P_IPV6: 'IPv6'</p>
<p>}</p>
<p>class MACAddress:</p>
<p>def __init__(self, addr: int):</p>
<p>self.addr = addr</p>
<p>def __str__(self):</p>
<p>return ':'.join('{:02x}'.format(a) for a in self.addr.to_bytes(6, BIG_ENDIAN))</p>
<p>def __repr__(self):</p>
<p>return self.__str__()</p>
<p>class EthernetHeader:</p>
<p>def __init__(self, dst_mac, src_mac):</p>
<p>self.dst_mac = dst_mac</p>
<p>self.src_mac = src_mac</p>
<p>def describe(self):</p>
<p>return {</p>
<p>'src_mac': MACAddress(self.src_mac),</p>
<p>'dst_mac': MACAddress(self.dst_mac)</p>
<p>}</p>
<p>class EthernetIIHeader(EthernetHeader):</p>
<p>def __init__(self, dst_mac, src_mac):</p>
<p>super().__init__(dst_mac, src_mac)</p>
<p>self.eth_type = 0</p>
<p>def describe(self):</p>
<p>dct = super().describe()</p>
<p>dct['eth_type'] = self._describe_eth_type(self.eth_type)</p>
<p>return dct</p>
<p>@staticmethod</p>
<p>def _describe_eth_type(eth_type):</p>
<p>if eth_type in ETH_TYPE_MAP:</p>
<p>return ETH_TYPE_MAP[eth_type]</p>
<p>return 'Unknown protocol{}'.format(eth_type)</p>
<p>class Ethernet802_3Header(EthernetHeader):</p>
<p>def __init__(self, dst_mac, src_mac):</p>
<p>super().__init__(dst_mac, src_mac)</p>
<p>self.length = 0</p>
<p>self.llc = 0</p>
<p>self.snap = 0</p>
<p>def describe(self):</p>
<p>dct = super().describe()</p>
<p>dct['length'] = self.length</p>
<p>dct['llc'] = self.llc</p>
<p>dct['snap'] = self.snap</p>
<p>return dct</p>
<p>def unpack(packet):</p>
<p>dst_mac = int.from_bytes(packet[:6], BIG_ENDIAN)</p>
<p>src_mac = int.from_bytes(packet[6:12], BIG_ENDIAN)</p>
<p>type_or_length = int.from_bytes(packet[12:14], BIG_ENDIAN)</p>
<p>if type_or_length &lt; 1500:</p>
<p>hdr = Ethernet802_3Header(dst_mac, src_mac)</p>
<p>hdr.length = type_or_length</p>
<p>hdr.llc = int.from_bytes(packet[14:17], BIG_ENDIAN)</p>
<p>hdr.snap = int.from_bytes(packet[17:22], BIG_ENDIAN)</p>
<p>return hdr, packet[22:]</p>
<p>elif type_or_length &gt;= 1536:</p>
<p>hdr = EthernetIIHeader(dst_mac, src_mac)</p>
<p>hdr.eth_type = type_or_length</p>
<p>return hdr, packet[14:]</p>
<p>else:</p>
<p>raise ValueError(type_or_length)</p>
<p>def main():</p>
<p>raw_sock = socket.socket(socket.PF_PACKET, socket.SOCK_RAW, socket.htons(ETH_P_ALL))</p>
<p>while True:</p>
<p>try:</p>
<p>packet, packet_info = raw_sock.recvfrom(1500)</p>
<p>eth_header, payload = unpack(packet)</p>
<p>print(eth_header.describe(), payload)</p>
<p>except KeyboardInterrupt:</p>
<p>break</p>
<p>except ValueError as e:</p>
<p>print('unpack failed', e)</p>
<p>if __name__ == '__main__':</p>
<p>main()</p>
<p>最后，用root权限运行抓包程序，可以看到屏幕上输出了解析后的Ethernet头部和未解析的载荷数据，如果有兴趣的话可以按照协议标准继续解析载荷数据中的上层协议。对于更复杂的抓包场景，如HTTPS解密或跨平台支持，工具如Sniffmaster提供了额外功能，包括数据流暴力抓包和代理抓包，无需越狱或root即可使用。</p>
<p>{'src_mac': 50:fa:84:aa:aa:aa, 'dst_mac': ac:d1:b8:aa:aa:aa, 'eth_type': 'IP'} b'E\x00\x00T\x0c\xfe@\x004\x01\x93*\xb4e1\x0c\xc0\xa8\x00g\x00\x00\xb6\x83-\x8e\x00\x07\xa6\xb4c^\x00\x00\x00\x00G\x01\x0c\x00\x00\x00\x00\x00\x10\x11\x12\x13\x14\x15\x16\x17\x18\x19\x1a\x1b\x1c\x1d\x1e\x1f !"#$%&amp;\'()*+,-./01234567'</p>
<p>...</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[别只把 JSON 当字符串：PostgreSQL 用 JSONB 把“半结构化数据”查快了]]></title>    <link>https://juejin.cn/post/7595864836359995444</link>    <guid>https://juejin.cn/post/7595864836359995444</guid>    <pubDate>2026-01-17T07:23:47.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7595864836359995444" data-draft-id="7595871887000862720" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="别只把 JSON 当字符串：PostgreSQL 用 JSONB 把“半结构化数据”查快了"/> <meta itemprop="keywords" content="数据库,PostgreSQL,DBA"/> <meta itemprop="datePublished" content="2026-01-17T07:23:47.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="技术不打烊"/> <meta itemprop="url" content="https://juejin.cn/user/893244690677165"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            别只把 JSON 当字符串：PostgreSQL 用 JSONB 把“半结构化数据”查快了
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/893244690677165/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    技术不打烊
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-17T07:23:47.000Z" title="Sat Jan 17 2026 07:23:47 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-17
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b0883a71e83649d6a854be714f8a1745~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oqA5pyv5LiN5omT54OK:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769239427&amp;x-signature=Uxi7L5Lkc0g7E6ZOsyVbT2OOWfk%3D" alt="1.png" loading="lazy"/>
一睁眼，隔壁大厂的DBA因为频繁改表结构和产品经理“打起来”了！
数据不会撒谎：传统研发中，<strong>高达50%的时间</strong>浪费在字段对齐、清洗和Schema迁移的无尽扯皮中。
难怪PostgreSQL社区大佬都吐槽：“Trying to fit dynamic data into rigid columns is a fool's errand.”（试图把动态数据塞进僵化列简直是自找苦吃）。</p>
<hr/>
<h2 data-id="heading-0">字段大爆炸：是技术债还是业务刚需？</h2>
<p>电商大促，运营突然要加个“鞋底材质”属性；做埋点分析，前端版本一更新，Event里的字段又变了。
这种**“半结构化数据”**的噩梦，相信每个做业务系统的兄弟都经历过。
传统的做法？要么疯狂加列（Alter Table到头秃），要么把一坨JSON直接当字符串扔进 <code>TEXT</code> 字段里。</p>
<p>结果呢？
存的时候是爽了，查的时候<strong>全表扫描</strong>，CPU直接飙到100%。你以为你在做架构，其实是在给数据库埋雷。
这时候，PostgreSQL 的 <strong>JSONB</strong> 简直就是救命稻草——它不是简单的“能存JSON”，而是把半结构化数据的<strong>存储、索引、查询</strong>变成了一套可落地的工程化能力。</p>
<blockquote>
<p><strong>灵魂拷问：</strong> 你现在的 JSON 数据是仅仅“活着”，还是在“裸奔”？</p>
</blockquote>
<hr/>
<h2 data-id="heading-1">JSON vs JSONB：选型一句话讲明白</h2>
<p>别被这俩名字绕晕了，区别就在怎么“存”。
<strong>JSON</strong> 类型就是纯文本，你怎么存它怎么放，每次读都要重新解析，就像一个封死的纸箱子。
<strong>JSONB</strong> 则是二进制存储（Binary），入库时虽然慢点（因为要预处理），但存好后自带目录，查起来飞快，就像透明的收纳盒 。</p>
<p><strong>来看一组彭博社级别的硬核测试：</strong>
同样插入大量数据，JSON可能只花13秒，而JSONB要花20秒（因为要解析和去重键值）。
<strong>但真正的质变在查询：</strong>
当你要检索某个Key时，JSONB配合索引仅需 <strong>8ms</strong>，而普通JSON可能要跑 <strong>27ms</strong> 甚至更久 。</p>
<p><strong>记这个口诀：</strong></p>
<ul>
<li><strong>只存不查</strong>（做日志存档、原样展示）：选 <strong>JSON</strong>。</li>
<li><strong>要查要筛</strong>（做搜索、过滤、关联）：无脑选 <strong>JSONB</strong>。</li>
</ul>
<hr/>
<h2 data-id="heading-2">黄金模板：把“灵活”和“规矩”同时拿到</h2>
<p>很多团队用不好JSONB，是因为走向了极端：要么不用，要么全用。
<strong>最聪明的做法是“混搭”</strong>：核心字段守规矩，长尾字段放飞自我。</p>
<p>给你们一张价值百万的**“通用事件表”**设计模板：</p>






























<table><thead><tr><th align="left">字段名</th><th align="left">类型</th><th align="left">说明</th></tr></thead><tbody><tr><td align="left"><strong>id</strong></td><td align="left">BigInt</td><td align="left"><strong>主键</strong>（雷打不动）</td></tr><tr><td align="left"><strong>created_at</strong></td><td align="left">Timestamp</td><td align="left"><strong>核心时间</strong>（索引刚需）</td></tr><tr><td align="left"><strong>tenant_id</strong></td><td align="left">Int</td><td align="left"><strong>租户隔离</strong>（强约束）</td></tr><tr><td align="left"><strong>payload</strong></td><td align="left"><strong>JSONB</strong></td><td align="left"><strong>变化字段</strong>（甚至可以塞版本号 <code>schema_ver</code>）</td></tr></tbody></table>
<blockquote>
<p><strong>设计哲学：</strong> 哪怕业务再变，<code>payload</code> 里的字段随便加，但外层的 <code>id</code> 和 <code>time</code> 永远保证你的查询底盘不崩 。</p>
</blockquote>
<hr/>
<h2 data-id="heading-3">极速查询三件套：写法+索引+解释计划</h2>
<p>把数据存进去只是第一步，怎么查得快才是老司机的功力。</p>
<p><strong>1. 更是“黑话”的查询符</strong>
别再用 <code>LIKE</code> 模糊匹配了！PostgreSQL 提供了专用的神兵利器：</p>
<ul>
<li><strong>取值</strong>：<code>payload -&gt;&gt; 'user_id'</code>（直接拿文本）</li>
<li><strong>包含</strong>：<code>payload @&gt; '{"region": "CN"}'</code>（最强匹配，包含即命中）</li>
<li><strong>存在</strong>：<code>payload ? 'vip_level'</code>（判断Key在不在）</li>
</ul>
<p><strong>2. 索引核武器：GIN</strong>
普通的 B-Tree 索引对 JSON 内部字段束手无策，这时候必须上 <strong>GIN (Generalized Inverted Index)</strong>。
这就好比给一本书的每一页都做了关键词索引。
<strong>写法很简单：</strong></p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">CREATE</span> INDEX idx_payload <span class="hljs-keyword">ON</span> events <span class="hljs-keyword">USING</span> GIN (payload);
</code></pre>
<p>一旦加上这个，千万级数据的查询也能瞬间从 <strong>秒级</strong> 掉到 <strong>毫秒级</strong> 。</p>
<p><strong>3. 必做动作：EXPLAIN</strong>
上线前，一定要用 <code>EXPLAIN ANALYZE</code> 跑一下。如果看到 <code>Seq Scan</code>（全表扫描），请立刻去面壁反省，检查你的 GIN 索引是不是漏了或者操作符用错了 。</p>
<hr/>
<h2 data-id="heading-4">拒绝垃圾场：别让JSONB成“信息孤岛”</h2>
<p>“能力越大，责任越大。”
JSONB 的灵活性如果不加约束，三个月后你的数据库就会变成垃圾场：没人知道 <code>attr1</code> 到底存的是 "100" 还是 100。</p>
<p><strong>落地治理三板斧：</strong></p>
<ol>
<li><strong>更新要克制</strong>：尽量用 <code>jsonb_set</code> 做局部更新，别把整个对象覆盖了，防止并发冲突。</li>
<li><strong>字典要维护</strong>：团队内部必须维护一份 <code>payload</code> 字段字典（Excel或飞书文档），标明 <code>payload.vip_level</code> 是啥意思，由谁负责。</li>
<li><strong>版本要控制</strong>：在 JSON 根节点加一个 <code>version: "v1"</code>，方便后续清洗数据时做兼容 。</li>
</ol>
<hr/>
<h2 data-id="heading-5">结尾：最好的重构时机是现在</h2>
<p>JSONB 的价值不在于“随便存”，而在于**“灵活存，但依然可索引、可治理”**。
不管你是做电商商品中心，还是复杂的SaaS配置系统，只要涉及高频查询的半结构化数据，请把工程资源投到 <strong>JSONB + GIN</strong> 上 。</p>
<p><strong>给所有技术人的行动清单：</strong></p>
<ol>
<li>挑一张字段变化最频繁的表（比如 UserProfile 或 OrderExtra）。</li>
<li>把长尾字段迁移到 JSONB，并加上 GIN 索引。</li>
<li>跑一下 <code>EXPLAIN</code>，享受查询速度提升 100 倍的快感。</li>
</ol>
<p><strong>最后问一句：</strong>
你们公司的业务表里，哪一张最让你头大？评论区晒出你的“慢查询”SQL，下期我们专门聊聊怎么优化它！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[WebSocket在SpringBoot中的实现：原理与案例]]></title>    <link>https://juejin.cn/post/7595808703074369562</link>    <guid>https://juejin.cn/post/7595808703074369562</guid>    <pubDate>2026-01-17T07:33:55.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7595808703074369562" data-draft-id="7595847940621500466" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="WebSocket在SpringBoot中的实现：原理与案例"/> <meta itemprop="keywords" content="后端,Java,程序员"/> <meta itemprop="datePublished" content="2026-01-17T07:33:55.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Olaf_n"/> <meta itemprop="url" content="https://juejin.cn/user/1324234125087575"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            WebSocket在SpringBoot中的实现：原理与案例
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1324234125087575/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Olaf_n
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-17T07:33:55.000Z" title="Sat Jan 17 2026 07:33:55 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-17
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    3
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">什么是websocket？</h2>
<p>WebSocket 是一种全双工的一种网络通信协议，这种协议可以支持主动向客户端推送消息，客户端也可以主动向服务器发送信息，属于服务器推送技术的一种
WebSocket协议是建立在TCP协议之上的，同时WebSocket协议和HTTP协议兼容性比较好默认端口80和443，在握手阶段采用的是Http协议。
WebSocket的数据格式比较轻量，开销也比较小，可以发送文本也可以发送二进制的数据（blob对象或ArraryBuffer对象）
没有同源策略的限制，协议的标识符是ws，如果是加密后的协议标识符则是wss</p>
<h2 data-id="heading-1">为什么要有websocket？</h2>
<p><strong>实时通信</strong>：传统的 HTTP 是请求-响应模型，每次客户端想获取数据时，都必须发起请求并等待服务器响应。而 WebSocket 协议在建立连接后，客户端和服务器可以互相发送数据，适合实时聊天、股票行情、在线游戏等应用场景。</p>
<p><strong>减少延迟</strong>：由于 WebSocket 连接是持久的，数据可以在连接建立后即时双向传输，无需每次请求时重新建立连接，降低了通信的延迟。</p>
<p><strong>减少网络开销</strong>：WebSocket 连接在建立后，不需要每次都发送 HTTP 请求的头部信息，这比传统的 HTTP 请求更加节省带宽和资源</p>
<h2 data-id="heading-2">为什么使用WebSocket？</h2>
<p>Http是你问我答，服务器不能主动找到客户端，http的流程是 ，客户端发起请求 -&gt; 服务器响应 -&gt; 断开连接；服务器不可以主动的推送消息给客户端。如果你想知道有没有新的消息就只能进行轮询或者长轮询；这两种方式再比较简单的的场景下完全可以使用，而且这两种方式实现起来也是比较简单。但如果是网页游戏呢，游戏一般会有大量的数据需要从服务器主动推送到客户端，也就是高频访问的场景下，这种轮询的实现成本就极高了，这时就需要用的websocket了。
websocket可以主动往客户端推送消息，不需要客户端来询问，而且websocket建立连接以后是可以长期使用的，避免频繁的建立连接销毁连接，节省网络资源上的开销。</p>
<h2 data-id="heading-3">什么时候用Websocket？</h2>
<p>服务器要主动通知客户端例如：IM聊天、好友申请/红点提醒
消息发送的频率非常高：实时日志、页游、实时监控面板
在线状态 / 会话存在感很重要 ： 在线用户列表 ， 是否在线等场景</p>
<h2 data-id="heading-4">Websocket的连接是如何建立？</h2>
<p>平时我们刷网页这个时候我们用的是Http协议，访问页游的时候http协议就得切换成Websocket。
为了要兼容这些场景，浏览器再TCP三次握手以后建立连接以后，都统一使用http协议先进行一次通信，如果这个时候是普通的http请求那就继续用http请求，如果这时想要建立Websocket连接，就会再http的请求头上加上一些特殊的header头</p>
<pre><code class="hljs language-makefile" lang="makefile"><span class="hljs-section">Connection: Upgrade</span>
<span class="hljs-section">Upgrade: WebSocket</span>
<span class="hljs-section">Sec-WebSocket-Key: T2a6wZ1AwhgQNqruZ2YUyg==</span>
</code></pre>
<p>Connection: Upgrade 是浏览器想要升级协议</p>
<p>Upgrade: WebSocket 表示想要升级的协议类型，证明浏览器想要升级成WebSocket</p>
<p>Sec-WebSocket-Key 一段随机Base64码</p>
<p>如果服务器支持升级成WebSocket协议的话，就会走WebSocket的握手流程，同时根据客户端生成的Base64码，用某个公开的算法变成另外一段字符串，放在Http的响应头里面，同时状态携带上101状态码，发回给浏览器</p>
<pre><code class="hljs language-makefile" lang="makefile">HTTP/1.1 101 Switching Protocols
<span class="hljs-section">Sec-WebSocket-Accept: iBJkv/ALIW2DobfoA4dmr3JHBCY=</span>
<span class="hljs-section">Upgrade: WebSocket</span>
<span class="hljs-section">Connection: Upgrade</span>
</code></pre>
<p>服务器端 base64 -》 某个函数/算法 -》服务器新字符串。</p>
<p>之后客户端也会把 base64 -》 某个函数/算法 -》客户端新字符串。</p>
<p>若是服务器新字符串和客户端新字符串相等，证明连接已经完成了，后续就可以使用websocket的数据格式来进行通信了。</p>
<h2 data-id="heading-5">后端实现WebSocket</h2>
<h3 data-id="heading-6">新建立websocket服务</h3>
<h4 data-id="heading-7">pom 依赖包</h4>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-websocket<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>

  <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>

  <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>cn.hutool<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>hutool-all<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>5.8.24<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span>
</code></pre>
<h4 data-id="heading-8">yml配置</h4>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment">#服务器配置</span>
<span class="hljs-attr">server:</span>
  <span class="hljs-attr">port:</span> <span class="hljs-number">8081</span>
  <span class="hljs-attr">servlet:</span>
    <span class="hljs-attr">context-path:</span> <span class="hljs-string">/api</span>
</code></pre>
<h4 data-id="heading-9">websocket配置类</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Configuration</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">WebsocketConfig</span> {
    <span class="hljs-meta">@Bean</span>
    <span class="hljs-keyword">public</span> ServerEndpointExporter <span class="hljs-title function_">serverEndpointExporter</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ServerEndpointExporter</span>();
    }
}
</code></pre>
<p>WebSocket注册点</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@ServerEndpoint(value = "/websocket/{userId}")</span>
<span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">WebSocket</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> ConcurrentHashMap&lt;String, WebSocket&gt; webSocketMap = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConcurrentHashMap</span>&lt;&gt;();
    <span class="hljs-comment">//实例一个session，这个session是websocket的session</span>
    <span class="hljs-keyword">private</span> Session session;

    <span class="hljs-comment">//新增一个方法用于主动向客户端发送消息</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">sendMessage</span><span class="hljs-params">(Object message, String userId)</span> {
        <span class="hljs-type">WebSocket</span> <span class="hljs-variable">webSocket</span> <span class="hljs-operator">=</span> webSocketMap.get(userId);
        <span class="hljs-keyword">if</span> (webSocket != <span class="hljs-literal">null</span>) {
            <span class="hljs-keyword">try</span> {
                webSocket.session.getBasicRemote().sendText(JSONUtil.toJsonStr(message));
                System.out.println(<span class="hljs-string">"【websocket消息】发送消息成功,用户="</span>+userId+<span class="hljs-string">",消息内容"</span>+message.toString());
            } <span class="hljs-keyword">catch</span> (IOException e) {
                e.printStackTrace();
            }
        }
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> ConcurrentHashMap&lt;String, WebSocket&gt; <span class="hljs-title function_">getWebSocketMap</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> webSocketMap;
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setWebSocketMap</span><span class="hljs-params">(ConcurrentHashMap&lt;String, WebSocket&gt; webSocketMap)</span> {
        WebSocket.webSocketMap = webSocketMap;
    }

    <span class="hljs-comment">//前端请求时一个websocket时</span>
    <span class="hljs-meta">@OnOpen</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onOpen</span><span class="hljs-params">(Session session, <span class="hljs-meta">@PathParam("userId")</span> String userId)</span> {
        <span class="hljs-built_in">this</span>.session = session;
        webSocketMap.put(userId, <span class="hljs-built_in">this</span>);
        sendMessage(<span class="hljs-string">"CONNECT_SUCCESS"</span>, userId);
        System.out.println(<span class="hljs-string">"【websocket消息】有新的连接,连接id"</span>+userId);
    }

    <span class="hljs-comment">//前端关闭时一个websocket时</span>
    <span class="hljs-meta">@OnClose</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onClose</span><span class="hljs-params">(<span class="hljs-meta">@PathParam("userId")</span> String userId)</span> {
        webSocketMap.remove(userId);
        System.out.println(<span class="hljs-string">"【websocket消息】连接断开,总数:"</span>+ webSocketMap.size());
    }

    <span class="hljs-comment">//前端向后端发送消息</span>
    <span class="hljs-meta">@OnMessage</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onMessage</span><span class="hljs-params">(String message)</span> <span class="hljs-keyword">throws</span> IOException {
        <span class="hljs-keyword">if</span> (!message.equals(<span class="hljs-string">"ping"</span>)) {
            System.out.println(<span class="hljs-string">"【websocket消息】收到客户端发来的消息:"</span>+message);
            session.getBasicRemote().sendText(<span class="hljs-string">"收到客户端发来的消息了,消息内容为:"</span>+message);
        }
    }
}
</code></pre>
<p>@ServerEndpoint 声明一个Websocket的服务点</p>
<p>@OnOpen 前端连接到后台的WebSocket</p>
<p>@OnClose 前端关闭一个连接</p>
<p>@OnMessage 前端向后端发送消息</p>
<h4 data-id="heading-10">启动类</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@SpringBootApplication</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">WebSocketMain</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        SpringApplication.run(WebSocketMain.class, args);
    }
}
</code></pre>
<h4 data-id="heading-11">前端测试页面代码</h4>
<pre><code class="hljs language-html" lang="html"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"en"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">"utf-8"</span> /&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">http-equiv</span>=<span class="hljs-string">"X-UA-Compatible"</span> <span class="hljs-attr">content</span>=<span class="hljs-string">"IE=edge"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"viewport"</span> <span class="hljs-attr">content</span>=<span class="hljs-string">"width=device-width, initial-scale=1"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>本地websocket测试<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"robots"</span> <span class="hljs-attr">content</span>=<span class="hljs-string">"all"</span> /&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"keywords"</span> <span class="hljs-attr">content</span>=<span class="hljs-string">"本地,websocket,测试工具"</span> /&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"description"</span> <span class="hljs-attr">content</span>=<span class="hljs-string">"本地,websocket,测试工具"</span> /&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">style</span>&gt;</span><span class="css">
      <span class="hljs-selector-class">.btn-group</span>{
        <span class="hljs-attribute">display</span>: inline-block;
      }
    </span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">'text'</span> <span class="hljs-attr">value</span>=<span class="hljs-string">'通信地址, ws://开头..'</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"form-control"</span> <span class="hljs-attr">style</span>=<span class="hljs-string">'width:390px;display:inline'</span>
      <span class="hljs-attr">id</span>=<span class="hljs-string">'wsaddr'</span> /&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"btn-group"</span> &gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"button"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"btn btn-default"</span> <span class="hljs-attr">onclick</span>=<span class="hljs-string">'addsocket();'</span>&gt;</span>连接<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"button"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"btn btn-default"</span> <span class="hljs-attr">onclick</span>=<span class="hljs-string">'closesocket();'</span>&gt;</span>断开<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"button"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"btn btn-default"</span> <span class="hljs-attr">onclick</span>=<span class="hljs-string">'$("#wsaddr").val("")'</span>&gt;</span>清空<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"row"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"output"</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"border:1px solid #ccc;height:365px;overflow: auto;margin: 20px 0;"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"text"</span> <span class="hljs-attr">id</span>=<span class="hljs-string">'message'</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"form-control"</span> <span class="hljs-attr">style</span>=<span class="hljs-string">'width:810px'</span> <span class="hljs-attr">placeholder</span>=<span class="hljs-string">"待发信息"</span> <span class="hljs-attr">onkeydown</span>=<span class="hljs-string">"en(event);"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"input-group-btn"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"btn btn-default"</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"button"</span> <span class="hljs-attr">onclick</span>=<span class="hljs-string">"doSend();"</span>&gt;</span>发送<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>		

  <span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"https://code.jquery.com/jquery-3.1.1.min.js"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">language</span>=<span class="hljs-string">"javascript"</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"text/javascript"</span>&gt;</span><span class="javascript">
    <span class="hljs-keyword">function</span> <span class="hljs-title function_">formatDate</span>(<span class="hljs-params">now</span>) {
      <span class="hljs-keyword">var</span> year = now.<span class="hljs-title function_">getFullYear</span>();
      <span class="hljs-keyword">var</span> month = now.<span class="hljs-title function_">getMonth</span>() + <span class="hljs-number">1</span>;
      <span class="hljs-keyword">var</span> date = now.<span class="hljs-title function_">getDate</span>();
      <span class="hljs-keyword">var</span> hour = now.<span class="hljs-title function_">getHours</span>();
      <span class="hljs-keyword">var</span> minute = now.<span class="hljs-title function_">getMinutes</span>();
      <span class="hljs-keyword">var</span> second = now.<span class="hljs-title function_">getSeconds</span>();
      <span class="hljs-keyword">return</span> year + <span class="hljs-string">"-"</span> + (month = month &lt; <span class="hljs-number">10</span> ? (<span class="hljs-string">"0"</span> + month) : month) + <span class="hljs-string">"-"</span> + (date = date &lt; <span class="hljs-number">10</span> ? (<span class="hljs-string">"0"</span> + date) : date) +
        <span class="hljs-string">" "</span> + (hour = hour &lt; <span class="hljs-number">10</span> ? (<span class="hljs-string">"0"</span> + hour) : hour) + <span class="hljs-string">":"</span> + (minute = minute &lt; <span class="hljs-number">10</span> ? (<span class="hljs-string">"0"</span> + minute) : minute) + <span class="hljs-string">":"</span> + (
          second = second &lt; <span class="hljs-number">10</span> ? (<span class="hljs-string">"0"</span> + second) : second);
    }
    <span class="hljs-keyword">var</span> output;
    <span class="hljs-keyword">var</span> websocket;

    <span class="hljs-keyword">function</span> <span class="hljs-title function_">init</span>(<span class="hljs-params"/>) {
      output = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">"output"</span>);
      <span class="hljs-title function_">testWebSocket</span>();
    }

    <span class="hljs-keyword">function</span> <span class="hljs-title function_">addsocket</span>(<span class="hljs-params"/>) {
      <span class="hljs-keyword">var</span> wsaddr = $(<span class="hljs-string">"#wsaddr"</span>).<span class="hljs-title function_">val</span>();
      <span class="hljs-keyword">if</span> (wsaddr == <span class="hljs-string">''</span>) {
        <span class="hljs-title function_">alert</span>(<span class="hljs-string">"请填写websocket的地址"</span>);
        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
      }
      <span class="hljs-title class_">StartWebSocket</span>(wsaddr);
    }

    <span class="hljs-keyword">function</span> <span class="hljs-title function_">closesocket</span>(<span class="hljs-params"/>) {
      websocket.<span class="hljs-title function_">close</span>();
    }

    <span class="hljs-keyword">function</span> <span class="hljs-title function_">StartWebSocket</span>(<span class="hljs-params">wsUri</span>) {
      websocket = <span class="hljs-keyword">new</span> <span class="hljs-title class_">WebSocket</span>(wsUri);
      websocket.<span class="hljs-property">onopen</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params">evt</span>) {
        <span class="hljs-title function_">onOpen</span>(evt)
      };
      websocket.<span class="hljs-property">onclose</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params">evt</span>) {
        <span class="hljs-title function_">onClose</span>(evt)
      };
      websocket.<span class="hljs-property">onmessage</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params">evt</span>) {
        <span class="hljs-title function_">onMessage</span>(evt)
      };
      websocket.<span class="hljs-property">onerror</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params">evt</span>) {
        <span class="hljs-title function_">onError</span>(evt)
      };
    }

    <span class="hljs-keyword">function</span> <span class="hljs-title function_">onOpen</span>(<span class="hljs-params">evt</span>) {
      <span class="hljs-title function_">writeToScreen</span>(<span class="hljs-string">"&lt;span style='color:red'&gt;连接成功，现在你可以发送信息啦！！！&lt;/span&gt;"</span>);
    }

    <span class="hljs-keyword">function</span> <span class="hljs-title function_">onClose</span>(<span class="hljs-params">evt</span>) {
      <span class="hljs-title function_">writeToScreen</span>(<span class="hljs-string">"&lt;span style='color:red'&gt;websocket连接已断开!!!&lt;/span&gt;"</span>);
      websocket.<span class="hljs-title function_">close</span>();
    }

    <span class="hljs-keyword">function</span> <span class="hljs-title function_">onMessage</span>(<span class="hljs-params">evt</span>) {
      <span class="hljs-title function_">writeToScreen</span>(<span class="hljs-string">'&lt;span style="color:blue"&gt;服务端回应&amp;nbsp;'</span> + <span class="hljs-title function_">formatDate</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>()) + <span class="hljs-string">'&lt;/span&gt;&lt;br/&gt;&lt;span class="bubble"&gt;'</span> +
                    evt.<span class="hljs-property">data</span> + <span class="hljs-string">'&lt;/span&gt;'</span>);
			}
 
			<span class="hljs-keyword">function</span> <span class="hljs-title function_">onError</span>(<span class="hljs-params">evt</span>) {
				<span class="hljs-title function_">writeToScreen</span>(<span class="hljs-string">'&lt;span style="color: red;"&gt;发生错误:&lt;/span&gt; '</span> + evt.<span class="hljs-property">data</span>);
			}
 
			<span class="hljs-keyword">function</span> <span class="hljs-title function_">doSend</span>(<span class="hljs-params"/>) {
				<span class="hljs-keyword">var</span> message = $(<span class="hljs-string">"#message"</span>).<span class="hljs-title function_">val</span>();
				<span class="hljs-keyword">if</span> (message == <span class="hljs-string">''</span>) {
					<span class="hljs-title function_">alert</span>(<span class="hljs-string">"请先填写发送信息"</span>);
					$(<span class="hljs-string">"#message"</span>).<span class="hljs-title function_">focus</span>();
					<span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
				}
				<span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> websocket === <span class="hljs-string">"undefined"</span>) {
					<span class="hljs-title function_">alert</span>(<span class="hljs-string">"websocket还没有连接，或者连接失败，请检测"</span>);
					<span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
				}
				<span class="hljs-keyword">if</span> (websocket.<span class="hljs-property">readyState</span> == <span class="hljs-number">3</span>) {
					<span class="hljs-title function_">alert</span>(<span class="hljs-string">"websocket已经关闭，请重新连接"</span>);
					<span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
				}
				<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(websocket);
				$(<span class="hljs-string">"#message"</span>).<span class="hljs-title function_">val</span>(<span class="hljs-string">''</span>);
				<span class="hljs-title function_">writeToScreen</span>(<span class="hljs-string">'&lt;span style="color:green"&gt;你发送的信息&amp;nbsp;'</span> + <span class="hljs-title function_">formatDate</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>()) + <span class="hljs-string">'&lt;/span&gt;&lt;br/&gt;'</span> + message);
				websocket.<span class="hljs-title function_">send</span>(message);
			}
 
			<span class="hljs-keyword">function</span> <span class="hljs-title function_">writeToScreen</span>(<span class="hljs-params">message</span>) {
				<span class="hljs-keyword">var</span> div = <span class="hljs-string">"&lt;div class='newmessage'&gt;"</span> + message + <span class="hljs-string">"&lt;/div&gt;"</span>;
				<span class="hljs-keyword">var</span> d = $(<span class="hljs-string">"#output"</span>);
				<span class="hljs-keyword">var</span> d = d[<span class="hljs-number">0</span>];
				<span class="hljs-keyword">var</span> doScroll = d.<span class="hljs-property">scrollTop</span> == d.<span class="hljs-property">scrollHeight</span> - d.<span class="hljs-property">clientHeight</span>;
				$(<span class="hljs-string">"#output"</span>).<span class="hljs-title function_">append</span>(div);
				<span class="hljs-keyword">if</span> (doScroll) {
					d.<span class="hljs-property">scrollTop</span> = d.<span class="hljs-property">scrollHeight</span> - d.<span class="hljs-property">clientHeight</span>;
				}
			}
 
 
			<span class="hljs-keyword">function</span> <span class="hljs-title function_">en</span>(<span class="hljs-params">event</span>) {
				<span class="hljs-keyword">var</span> evt = evt ? evt : (<span class="hljs-variable language_">window</span>.<span class="hljs-property">event</span> ? <span class="hljs-variable language_">window</span>.<span class="hljs-property">event</span> : <span class="hljs-literal">null</span>);
				<span class="hljs-keyword">if</span> (evt.<span class="hljs-property">keyCode</span> == <span class="hljs-number">13</span>) {
					<span class="hljs-title function_">doSend</span>()
				}
			}
		</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
 
<span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span>
</code></pre>
<p>前端测试网站 <a href="https://link.juejin.cn?target=http%3A%2F%2Fcoolaf.com%2Ftool%2Fchattest" target="_blank" title="http://coolaf.com/tool/chattest" ref="nofollow noopener noreferrer">在线websocket测试-在线工具-postjson</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[iOS开发APP上架全流程解析：从开发到App Store的完整指南]]></title>    <link>https://juejin.cn/post/7595868336595435539</link>    <guid>https://juejin.cn/post/7595868336595435539</guid>    <pubDate>2026-01-17T09:52:25.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7595868336595435539" data-draft-id="7595994039108436004" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="iOS开发APP上架全流程解析：从开发到App Store的完整指南"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2026-01-17T09:52:25.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="开心就好2025"/> <meta itemprop="url" content="https://juejin.cn/user/3850962908492660"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            iOS开发APP上架全流程解析：从开发到App Store的完整指南
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3850962908492660/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    开心就好2025
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-17T09:52:25.000Z" title="Sat Jan 17 2026 09:52:25 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-17
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>iOS开发APP上架全流程解析：从开发到App Store的完整指南</p>
<p>在移动互联网时代，iOS应用开发已成为许多企业和开发者的重要业务方向。然而，许多新手开发者常常困惑于如何将自己的应用成功上架到App Store。本文将详细介绍iOS开发APP的完整上架流程，帮助您规避常见问题，提高上架成功率。</p>
<p>一、前期准备工作</p>
<ol>
<li><strong>开发者账号注册</strong></li>
</ol>
<p>首先需要注册Apple开发者账号（个人账号99美元/年，企业账号299美元/年）。这是上架App Store的前提条件，注册过程可能需要1-2个工作日完成审核。</p>
<ol start="2">
<li><strong>应用信息规划</strong></li>
</ol>
<p>确定应用的名称、图标、功能介绍、关键词等元数据，这些信息将直接影响用户在App Store中搜索到您的应用的可能性。</p>
<ol start="3">
<li><strong>开发环境搭建</strong></li>
</ol>
<p>确保使用最新版本的Xcode开发工具，并熟悉iOS开发相关规范和要求。</p>
<p>二、开发阶段注意事项</p>
<ol>
<li><strong>遵循苹果设计指南</strong></li>
</ol>
<p>严格按照《Human Interface Guidelines》进行UI设计，避免因界面问题被拒。</p>
<ol start="2">
<li><strong>功能完整性检查</strong></li>
</ol>
<p>确保应用没有明显bug，所有功能都能正常运行，特别是支付、登录等核心功能。</p>
<ol start="3">
<li><strong>隐私政策准备</strong></li>
</ol>
<p>所有收集用户数据的应用都必须提供隐私政策链接，这是苹果审核的重点项目。</p>
<p>三、上架前测试与优化</p>
<ol>
<li><strong>TestFlight测试</strong></li>
</ol>
<p>通过TestFlight进行内部测试和外部测试，收集用户反馈并修复问题。</p>
<ol start="2">
<li><strong>性能优化</strong></li>
</ol>
<p>关注应用启动时间、内存占用等性能指标，避免因性能问题被拒。</p>
<ol start="3">
<li><strong>截图与预览视频</strong></li>
</ol>
<p>准备高质量的App Store展示素材，这是吸引用户下载的重要因素。</p>
<p>四、正式上架流程</p>
<ol>
<li><strong>创建App Store Connect记录</strong></li>
</ol>
<p>在开发者后台创建新应用，填写完整元数据。</p>
<ol start="2">
<li><strong>构建版本上传</strong></li>
</ol>
<p>通过Xcode或Application Loader上传构建版本。此外，开发者可以使用AppUploader工具在Windows、Linux或Mac系统中上传IPA文件到App Store，无需Mac电脑，同时支持iOS证书申请和描述文件管理，简化上架流程。</p>
<ol start="3">
<li><strong>提交审核</strong></li>
</ol>
<p>填写审核问卷，说明应用功能、使用场景等关键信息。</p>
<ol start="4">
<li><strong>等待审核</strong></li>
</ol>
<p>通常需要1-3个工作日，高峰期可能延长。</p>
<p>五、常见被拒原因及解决方案</p>
<ol>
<li><strong>功能不完整</strong></li>
</ol>
<p>确保演示账号可用，所有功能都可测试。</p>
<ol start="2">
<li><strong>设计不符合规范</strong></li>
</ol>
<p>遵循苹果设计指南，避免使用类似系统图标等元素。</p>
<ol start="3">
<li><strong>隐私政策问题</strong></li>
</ol>
<p>明确说明数据收集范围和使用方式。</p>
<ol start="4">
<li><strong>支付问题</strong></li>
</ol>
<p>虚拟商品必须使用IAP支付，实物商品可使用第三方支付。</p>
<p>六、上架后维护</p>
<ol>
<li><strong>及时更新版本</strong></li>
</ol>
<p>根据用户反馈和市场需求定期更新应用。</p>
<ol start="2">
<li><strong>监控审核状态</strong></li>
</ol>
<p>关注可能的审核延迟或被拒情况。</p>
<ol start="3">
<li><strong>优化应用商店排名</strong></li>
</ol>
<p>通过ASO优化提升应用在搜索结果中的排名。</p>
<p>iOS应用上架是一个系统工程，需要开发者具备技术能力、设计思维和市场意识。对于没有经验的开发者或企业来说，整个流程可能会遇到各种意想不到的挑战。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[使用企业微信的消息推送来发送告警]]></title>    <link>https://juejin.cn/post/7595831738234486793</link>    <guid>https://juejin.cn/post/7595831738234486793</guid>    <pubDate>2026-01-17T07:49:28.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7595831738234486793" data-draft-id="7595831738234470409" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="使用企业微信的消息推送来发送告警"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2026-01-17T07:49:28.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="何达维"/> <meta itemprop="url" content="https://juejin.cn/user/4206083706979930"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            使用企业微信的消息推送来发送告警
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4206083706979930/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    何达维
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-17T07:49:28.000Z" title="Sat Jan 17 2026 07:49:28 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-17
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    4
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">使用企业微信的消息推送来发送告警</h2>
<p>实现 Prometheus 的 Alertmanager 与企业微信集成，让 Prometheus 触发的告警能够自动推送到企业微信的群聊/机器人中。</p>
<p>先创建企业微信机器人，复制机器人的 Webhook URL（格式类似：<code>https://qyapi.weixin.qq.com/cgi-bin/webhook/send?key=xxxx-xxxx-xxxxx-xxxx-xxxx</code>），把机器人拉入群聊。</p>
<p>假设企业微信的消息推送 webhook 是 <code>https://qyapi.weixin.qq.com/cgi-bin/webhook/send?key=xxxx-xxxx-xxxxx-xxxx-xxxx</code>，对该地址发起 HTTP POST 请求，即可实现给该群组发送消息：</p>
<pre><code class="hljs language-bash" lang="bash">
curl <span class="hljs-string">'https://qyapi.weixin.qq.com/cgi-bin/webhook/send?key=xxxx-xxxx-xxxxx-xxxx-xxxx'</span> \

   -H <span class="hljs-string">'Content-Type: application/json'</span> \

   -d <span class="hljs-string">'

   {

      "msgtype": "text",

      "text": {

          "content": "hello world"

      }

   }'</span>

</code></pre>
<ul>
<li><code>msgtype</code>：必须字段，中转端点必须生成该字段以适配，否则无法推送，常用的两种类型：</li>
</ul>
<p>  - <code>text</code>：文本类型。</p>
<pre><code class="hljs language-json" lang="json">
<span class="hljs-punctuation">{</span>

    <span class="hljs-attr">"msgtype"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"text"</span><span class="hljs-punctuation">,</span>

    <span class="hljs-attr">"text"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>

        <span class="hljs-attr">"content"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"广州今日天气：29度，大部分多云，降雨概率：60%"</span><span class="hljs-punctuation">,</span>

    <span class="hljs-attr">"mentioned_list"</span><span class="hljs-punctuation">:</span><span class="hljs-punctuation">[</span><span class="hljs-string">"wangqing"</span><span class="hljs-punctuation">,</span><span class="hljs-string">"@all"</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>

    <span class="hljs-attr">"mentioned_mobile_list"</span><span class="hljs-punctuation">:</span><span class="hljs-punctuation">[</span><span class="hljs-string">"13800001111"</span><span class="hljs-punctuation">,</span><span class="hljs-string">"@all"</span><span class="hljs-punctuation">]</span>

    <span class="hljs-punctuation">}</span>

<span class="hljs-punctuation">}</span>

</code></pre>
<p>  - <code>markdown</code>：markdown 类型。</p>
<pre><code class="hljs language-json" lang="json">
<span class="hljs-punctuation">{</span>

    <span class="hljs-attr">"msgtype"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"markdown"</span><span class="hljs-punctuation">,</span>

    <span class="hljs-attr">"markdown"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>

        <span class="hljs-attr">"content"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"实时新增用户反馈&lt;font color=\"warning\"&gt;132例&lt;/font&gt;，请相关同事注意。\n&gt;类型:&lt;font color=\"comment\"&gt;用户反馈&lt;/font&gt;\n&gt;普通用户反馈:&lt;font color=\"comment\"&gt;117例&lt;/font&gt;\n&gt;VIP用户反馈:&lt;font color=\"comment\"&gt;15例&lt;/font&gt;"</span>

    <span class="hljs-punctuation">}</span>

<span class="hljs-punctuation">}</span>

</code></pre>
<p>先手动测试 <code>markdown</code> 类型的消息，看企业微信是否能正常收到消息：</p>
<pre><code class="hljs language-bash" lang="bash">
curl <span class="hljs-string">'https://qyapi.weixin.qq.com/cgi-bin/webhook/send?key=xxxx-xxxx-xxxx'</span> \

  -H <span class="hljs-string">'Content-Type: application/json'</span> \

  -d <span class="hljs-string">'{

    "msgtype": "markdown",

    "markdown": {

      "content": "### 测试告警\n&gt; 这是一条测试消息"

    }

  }'</span>

</code></pre>
<p>为什么要用 webhook 中转？目的是让 Alertmanager 模板渲染后的结果严格匹配企业微信机器人要求的消息结构，要确保：</p>
<ul>
<li>
<p>企业微信机器人只接收特定格式的 JSON 数据，上面的 <code>markdown</code> 类型是告警场景最常用的（支持排版、高亮），渲染后的 JSON 格式要符合企业微信的规范。</p>
</li>
<li>
<p><code>content</code> 字段要符合企业微信 <code>markdown</code> 的语法，要处理好一些特殊字符。</p>
</li>
</ul>
<p>Alertmanager 以 JSON 格式向配置的 webhook 端点发送 HTTP POST 请求，固定格式：</p>
<pre><code class="hljs language-json" lang="json">
<span class="hljs-punctuation">{</span>

  <span class="hljs-attr">"version"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"4"</span><span class="hljs-punctuation">,</span>

  <span class="hljs-attr">"groupKey"</span><span class="hljs-punctuation">:</span> &lt;string&gt;<span class="hljs-punctuation">,</span>              <span class="hljs-comment">// key identifying the group of alerts (e.g. to deduplicate)</span>

  <span class="hljs-attr">"truncatedAlerts"</span><span class="hljs-punctuation">:</span> &lt;int&gt;<span class="hljs-punctuation">,</span>          <span class="hljs-comment">// how many alerts have been truncated due to "max_alerts"</span>

  <span class="hljs-attr">"status"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"&lt;resolved|firing&gt;"</span><span class="hljs-punctuation">,</span>

  <span class="hljs-attr">"receiver"</span><span class="hljs-punctuation">:</span> &lt;string&gt;<span class="hljs-punctuation">,</span>

  <span class="hljs-attr">"groupLabels"</span><span class="hljs-punctuation">:</span> &lt;object&gt;<span class="hljs-punctuation">,</span>

  <span class="hljs-attr">"commonLabels"</span><span class="hljs-punctuation">:</span> &lt;object&gt;<span class="hljs-punctuation">,</span>

  <span class="hljs-attr">"commonAnnotations"</span><span class="hljs-punctuation">:</span> &lt;object&gt;<span class="hljs-punctuation">,</span>

  <span class="hljs-attr">"externalURL"</span><span class="hljs-punctuation">:</span> &lt;string&gt;<span class="hljs-punctuation">,</span>           <span class="hljs-comment">// backlink to the Alertmanager.</span>

  <span class="hljs-attr">"alerts"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>

    <span class="hljs-punctuation">{</span>

      <span class="hljs-attr">"status"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"&lt;resolved|firing&gt;"</span><span class="hljs-punctuation">,</span>

      <span class="hljs-attr">"labels"</span><span class="hljs-punctuation">:</span> &lt;object&gt;<span class="hljs-punctuation">,</span>

      <span class="hljs-attr">"annotations"</span><span class="hljs-punctuation">:</span> &lt;object&gt;<span class="hljs-punctuation">,</span>

      <span class="hljs-attr">"startsAt"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"&lt;rfc3339&gt;"</span><span class="hljs-punctuation">,</span>

      <span class="hljs-attr">"endsAt"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"&lt;rfc3339&gt;"</span><span class="hljs-punctuation">,</span>

      <span class="hljs-attr">"generatorURL"</span><span class="hljs-punctuation">:</span> &lt;string&gt;<span class="hljs-punctuation">,</span>      <span class="hljs-comment">// identifies the entity that caused the alert</span>

      <span class="hljs-attr">"fingerprint"</span><span class="hljs-punctuation">:</span> &lt;string&gt;        <span class="hljs-comment">// fingerprint to identify the alert</span>

    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>

    ...

  <span class="hljs-punctuation">]</span>

<span class="hljs-punctuation">}</span>

</code></pre>
<p>流程：</p>
<pre><code class="hljs language-rust" lang="rust">
Alertmanager（固定的原始 JSON 格式） <span class="hljs-punctuation">-&gt;</span> 中转端点（打包成企业微信机器人要求的格式） <span class="hljs-punctuation">-&gt;</span> 企业微信机器人

</code></pre>
<p>下面用 golang 来实现这个中转端，也可以用其它语言实现比如 python。</p>
<p><code>alertmanager.yml</code> 中配置：</p>
<pre><code class="hljs language-yaml" lang="yaml">
<span class="hljs-string">...</span>

<span class="hljs-comment"># 模板文件</span>

<span class="hljs-attr">templates:</span>

  <span class="hljs-bullet">-</span> <span class="hljs-string">'/etc/alertmanager/templates/*.tmpl'</span>

  


<span class="hljs-comment"># 接收器：定义告警的通知方式（邮件、WebHook 等）</span>

<span class="hljs-attr">receivers:</span>

  <span class="hljs-string">...</span>

  <span class="hljs-comment"># 企业微信接收器（通过 WebHook）</span>

  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">'wechat'</span>

    <span class="hljs-attr">webhook_configs:</span>

      <span class="hljs-comment"># golang 中转端</span>

      <span class="hljs-bullet">-</span> <span class="hljs-attr">url:</span> <span class="hljs-string">'http://10.0.0.12:5000/wechat'</span>

        <span class="hljs-attr">send_resolved:</span> <span class="hljs-literal">true</span>  <span class="hljs-comment"># 告警恢复时也发送通知</span>

        <span class="hljs-attr">timeout:</span> <span class="hljs-string">15s</span>

</code></pre>
<p><code>golang-wechat/main.go</code>：</p>
<pre><code class="hljs language-golang" lang="golang">
<span class="hljs-keyword">package</span> main

  


<span class="hljs-keyword">import</span> (

  <span class="hljs-string">"bytes"</span>

  <span class="hljs-string">"encoding/json"</span>

  <span class="hljs-string">"fmt"</span>

  <span class="hljs-string">"log"</span>

  <span class="hljs-string">"net/http"</span>

  <span class="hljs-string">"os"</span>

  <span class="hljs-string">"text/template"</span>

  <span class="hljs-string">"time"</span>

)

  


<span class="hljs-comment">// Alertmanager 原始告警数据结构（与模板变量对应）</span>

<span class="hljs-keyword">type</span> AlertmanagerData <span class="hljs-keyword">struct</span> {

  Receiver          <span class="hljs-type">string</span>            <span class="hljs-string">`json:"receiver"`</span>

  Status            <span class="hljs-type">string</span>            <span class="hljs-string">`json:"status"`</span>

  Alerts            []Alert           <span class="hljs-string">`json:"alerts"`</span>

  GroupLabels       <span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]<span class="hljs-type">string</span> <span class="hljs-string">`json:"groupLabels"`</span>

  CommonLabels      <span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]<span class="hljs-type">string</span> <span class="hljs-string">`json:"commonLabels"`</span>

  CommonAnnotations <span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]<span class="hljs-type">string</span> <span class="hljs-string">`json:"commonAnnotations"`</span>

  ExternalURL       <span class="hljs-type">string</span>            <span class="hljs-string">`json:"externalURL"`</span>

  Version           <span class="hljs-type">string</span>            <span class="hljs-string">`json:"version"`</span>

}

  


<span class="hljs-keyword">type</span> Alert <span class="hljs-keyword">struct</span> {

  Status      <span class="hljs-type">string</span>            <span class="hljs-string">`json:"status"`</span>

  Labels      <span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]<span class="hljs-type">string</span> <span class="hljs-string">`json:"labels"`</span>

  Annotations <span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]<span class="hljs-type">string</span> <span class="hljs-string">`json:"annotations"`</span>

  StartsAt    time.Time         <span class="hljs-string">`json:"startsAt"`</span>

  EndsAt      time.Time         <span class="hljs-string">`json:"endsAt"`</span>

  Fingerprint <span class="hljs-type">string</span>            <span class="hljs-string">`json:"fingerprint"`</span>

}

  


<span class="hljs-comment">// 企业微信消息结构（模板渲染结果需符合此格式）</span>

<span class="hljs-keyword">type</span> WechatMessage <span class="hljs-keyword">struct</span> {

  MsgType  <span class="hljs-type">string</span> <span class="hljs-string">`json:"msgtype"`</span>

  Markdown <span class="hljs-keyword">struct</span> {

    Content <span class="hljs-type">string</span> <span class="hljs-string">`json:"content"`</span>

  } <span class="hljs-string">`json:"markdown"`</span>

}

  


<span class="hljs-keyword">var</span> (

  wechatWebhook <span class="hljs-type">string</span>

  tpl           *template.Template <span class="hljs-comment">// 全局模板对象</span>

)

  


<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {

  <span class="hljs-comment">// 从环境变量获取配置</span>

  wechatWebhook = os.Getenv(<span class="hljs-string">"WECHAT_WEBHOOK_URL"</span>)

  port := os.Getenv(<span class="hljs-string">"PORT"</span>)

  tplPath := os.Getenv(<span class="hljs-string">"TEMPLATE_PATH"</span>) <span class="hljs-comment">// 模板文件路径</span>

  


  <span class="hljs-keyword">if</span> port == <span class="hljs-string">""</span> {

    port = <span class="hljs-string">"5000"</span> <span class="hljs-comment">// 默认端口</span>

  }

  <span class="hljs-keyword">if</span> wechatWebhook == <span class="hljs-string">""</span> {

    log.Fatal(<span class="hljs-string">"请设置环境变量 WECHAT_WEBHOOK_URL"</span>)

  }

  <span class="hljs-keyword">if</span> tplPath == <span class="hljs-string">""</span> {

    tplPath = <span class="hljs-string">"/app/templates/wechat.tmpl"</span> <span class="hljs-comment">// 默认模板路径</span>

  }

  


  <span class="hljs-comment">// 加载并解析模板文件（只渲染 content 内容，不含 JSON 结构）</span>

  <span class="hljs-keyword">var</span> err <span class="hljs-type">error</span>

  tpl, err = template.ParseFiles(tplPath)

  <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {

    log.Fatalf(<span class="hljs-string">"加载模板失败: %v"</span>, err)

  }

  log.Printf(<span class="hljs-string">"成功加载模板，名称: %s，路径: %s"</span>, tpl.Name(), tplPath)

  


  <span class="hljs-comment">// 注册 HTTP 路由</span>

  http.HandleFunc(<span class="hljs-string">"/wechat"</span>, forwardHandler)

  http.HandleFunc(<span class="hljs-string">"/health"</span>, healthHandler)

  


  <span class="hljs-comment">// 启动服务</span>

  log.Printf(<span class="hljs-string">"服务启动，监听端口: %s"</span>, port)

  log.Fatal(http.ListenAndServe(<span class="hljs-string">":"</span>+port, <span class="hljs-literal">nil</span>))

}

  


<span class="hljs-comment">// 转发处理函数</span>

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">forwardHandler</span><span class="hljs-params">(w http.ResponseWriter, r *http.Request)</span></span> {

  <span class="hljs-comment">// 解析 Alertmanager 原始数据</span>

  <span class="hljs-keyword">var</span> alertData AlertmanagerData

  <span class="hljs-keyword">if</span> err := json.NewDecoder(r.Body).Decode(&amp;alertData); err != <span class="hljs-literal">nil</span> {

    http.Error(w, <span class="hljs-string">"解析请求失败: "</span>+err.Error(), http.StatusBadRequest)

    log.Printf(<span class="hljs-string">"解析错误: %v"</span>, err)

    <span class="hljs-keyword">return</span>

  }

  log.Printf(<span class="hljs-string">"收到告警数据: %+v"</span>, alertData)

  


  <span class="hljs-comment">// 用模板渲染 markdown.content 的文本内容（不含 JSON 结构）</span>

  <span class="hljs-keyword">var</span> contentBuf bytes.Buffer

  <span class="hljs-comment">// 带有命名模板（{{ define "wechat.message" }}）的模板文件 使用 ExecuteTemplate 而不是 Execute</span>

  <span class="hljs-keyword">if</span> err := tpl.ExecuteTemplate(&amp;contentBuf, <span class="hljs-string">"wechat.message"</span>, alertData); err != <span class="hljs-literal">nil</span> {

    http.Error(w, <span class="hljs-string">"模板渲染失败: "</span>+err.Error(), http.StatusInternalServerError)

    log.Printf(<span class="hljs-string">"模板渲染错误: %v"</span>, err)

    <span class="hljs-keyword">return</span>

  }

  rawContent := contentBuf.String()

  log.Printf(<span class="hljs-string">"渲染后的 content 原始内容: %s"</span>, rawContent)

  


  escapedContent := rawContent

  


  <span class="hljs-comment">// 构造企业微信消息结构体</span>

  <span class="hljs-keyword">var</span> wechatMsg WechatMessage

  wechatMsg.MsgType = <span class="hljs-string">"markdown"</span>

  wechatMsg.Markdown.Content = escapedContent

  


  <span class="hljs-comment">// 序列化结构体为 JSON（自动处理所有特殊字符转义）</span>

  jsonData, err := json.Marshal(wechatMsg)

  <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {

    http.Error(w, <span class="hljs-string">"JSON 序列化失败: "</span>+err.Error(), http.StatusInternalServerError)

    log.Printf(<span class="hljs-string">"JSON 序列化错误: %v"</span>, err)

    <span class="hljs-keyword">return</span>

  }

  log.Printf(<span class="hljs-string">"最终发送的 JSON: %s"</span>, jsonData)

  


  <span class="hljs-comment">// 转发到企业微信</span>

  resp, err := http.Post(wechatWebhook, <span class="hljs-string">"application/json"</span>, bytes.NewBuffer(jsonData))

  <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {

    http.Error(w, <span class="hljs-string">"转发失败: "</span>+err.Error(), http.StatusInternalServerError)

    log.Printf(<span class="hljs-string">"转发错误: %v"</span>, err)

    <span class="hljs-keyword">return</span>

  }

  <span class="hljs-keyword">defer</span> resp.Body.Close()

  


  <span class="hljs-keyword">if</span> resp.StatusCode != http.StatusOK {

    http.Error(w, fmt.Sprintf(<span class="hljs-string">"企业微信接口错误，状态码: %d"</span>, resp.StatusCode), http.StatusInternalServerError)

    log.Printf(<span class="hljs-string">"企业微信接口错误，状态码: %d"</span>, resp.StatusCode)

    <span class="hljs-keyword">return</span>

  }

  


  <span class="hljs-comment">// 返回成功响应</span>

  w.WriteHeader(http.StatusOK)

  w.Write([]<span class="hljs-type">byte</span>(<span class="hljs-string">`{"status": "success"}`</span>))

}

  


<span class="hljs-comment">// 健康检查</span>

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">healthHandler</span><span class="hljs-params">(w http.ResponseWriter, r *http.Request)</span></span> {

  w.WriteHeader(http.StatusOK)

  w.Write([]<span class="hljs-type">byte</span>(<span class="hljs-string">`{"status": "healthy"}`</span>))

}

</code></pre>
<p>匹配上面 golang 中转程序的模板 <code>templates/wechat.tmpl</code>：</p>
<pre><code class="hljs language-ruby" lang="ruby">
{{ define <span class="hljs-string">"wechat.message"</span> }}

  


{{- range <span class="hljs-variable">$index</span>, <span class="hljs-variable">$alert</span> <span class="hljs-symbol">:</span>= .<span class="hljs-title class_">Alerts</span> -}}

{{- <span class="hljs-keyword">if</span> gt <span class="hljs-variable">$index</span> <span class="hljs-number">0</span> }}

---

{{ <span class="hljs-keyword">end</span> }}

  


{{- <span class="hljs-keyword">if</span> eq <span class="hljs-variable">$alert</span>.<span class="hljs-title class_">Status</span> <span class="hljs-string">"firing"</span> }}

<span class="hljs-comment">### 🚨 监控报警（故障告警通知）</span>

{{- <span class="hljs-keyword">else</span> }}

<span class="hljs-comment">### ✅ 监控报警（恢复通知）</span>

{{- <span class="hljs-keyword">end</span> }}

- **告警类型**: {{ <span class="hljs-keyword">if</span> <span class="hljs-variable">$alert</span>.<span class="hljs-title class_">Labels</span>.alertname }}{{ <span class="hljs-variable">$alert</span>.<span class="hljs-title class_">Labels</span>.alertname }}{{ <span class="hljs-keyword">else</span> }}未知告警{{ <span class="hljs-keyword">end</span> }}

- **告警级别**: {{ <span class="hljs-keyword">if</span> <span class="hljs-variable">$alert</span>.<span class="hljs-title class_">Labels</span>.severity }}{{ <span class="hljs-variable">$alert</span>.<span class="hljs-title class_">Labels</span>.severity }}{{ <span class="hljs-keyword">else</span> }}未知级别{{ <span class="hljs-keyword">end</span> }}

- **告警状态**: {{ <span class="hljs-variable">$alert</span>.<span class="hljs-title class_">Status</span> }} {{ <span class="hljs-keyword">if</span> eq <span class="hljs-variable">$alert</span>.<span class="hljs-title class_">Status</span> <span class="hljs-string">"firing"</span> }}故障{{ <span class="hljs-keyword">else</span> }}恢复{{ <span class="hljs-keyword">end</span> }}

- **故障主机**: {{ <span class="hljs-keyword">if</span> <span class="hljs-variable">$alert</span>.<span class="hljs-title class_">Labels</span>.instance }}{{ <span class="hljs-variable">$alert</span>.<span class="hljs-title class_">Labels</span>.instance }}{{ <span class="hljs-keyword">else</span> }}-{{ <span class="hljs-keyword">end</span> }} {{ <span class="hljs-keyword">if</span> <span class="hljs-variable">$alert</span>.<span class="hljs-title class_">Labels</span>.device }}{{ <span class="hljs-variable">$alert</span>.<span class="hljs-title class_">Labels</span>.device }}{{ <span class="hljs-keyword">else</span> }}-{{ <span class="hljs-keyword">end</span> }}

- **服务环境**: {{ <span class="hljs-keyword">if</span> <span class="hljs-variable">$alert</span>.<span class="hljs-title class_">Labels</span>.env }}{{ <span class="hljs-variable">$alert</span>.<span class="hljs-title class_">Labels</span>.env }}{{ <span class="hljs-keyword">else</span> }}未知环境{{ <span class="hljs-keyword">end</span> }}

- **服务名称**: {{ <span class="hljs-keyword">if</span> <span class="hljs-variable">$alert</span>.<span class="hljs-title class_">Labels</span>.servicename }}{{ <span class="hljs-variable">$alert</span>.<span class="hljs-title class_">Labels</span>.servicename }}{{ <span class="hljs-keyword">else</span> }}未知服务{{ <span class="hljs-keyword">end</span> }}

- **告警主题**: {{ <span class="hljs-keyword">if</span> <span class="hljs-variable">$alert</span>.<span class="hljs-title class_">Annotations</span>.summary }}{{ <span class="hljs-variable">$alert</span>.<span class="hljs-title class_">Annotations</span>.summary }}{{ <span class="hljs-keyword">else</span> }}无主题{{ <span class="hljs-keyword">end</span> }}

- **告警详情**: {{ <span class="hljs-keyword">if</span> <span class="hljs-variable">$alert</span>.<span class="hljs-title class_">Annotations</span>.message }}{{ <span class="hljs-variable">$alert</span>.<span class="hljs-title class_">Annotations</span>.message }}{{ <span class="hljs-keyword">end</span> }}{{ <span class="hljs-keyword">if</span> <span class="hljs-keyword">and</span> <span class="hljs-variable">$alert</span>.<span class="hljs-title class_">Annotations</span>.message <span class="hljs-variable">$alert</span>.<span class="hljs-title class_">Annotations</span>.description }}；{{ <span class="hljs-keyword">end</span> }}{{ <span class="hljs-keyword">if</span> <span class="hljs-variable">$alert</span>.<span class="hljs-title class_">Annotations</span>.description }}{{ <span class="hljs-variable">$alert</span>.<span class="hljs-title class_">Annotations</span>.description }}{{ <span class="hljs-keyword">else</span> }}无详情{{ <span class="hljs-keyword">end</span> }}

{{- <span class="hljs-keyword">if</span> <span class="hljs-variable">$alert</span>.<span class="hljs-title class_">Annotations</span>.value }}

- **触发阈值**: {{ <span class="hljs-variable">$alert</span>.<span class="hljs-title class_">Annotations</span>.value }}

{{- <span class="hljs-keyword">end</span> }}

- **故障时间**: {{ (<span class="hljs-variable">$alert</span>.<span class="hljs-title class_">StartsAt</span>.<span class="hljs-title class_">Add</span> <span class="hljs-number">28800e9</span>).<span class="hljs-title class_">Format</span> <span class="hljs-string">"2006-01-02 15:04:05"</span> }}

{{- <span class="hljs-keyword">if</span> eq <span class="hljs-variable">$alert</span>.<span class="hljs-title class_">Status</span> <span class="hljs-string">"resolved"</span> }}

- **恢复时间**: {{ <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> <span class="hljs-variable">$alert</span>.<span class="hljs-title class_">EndsAt</span>.<span class="hljs-title class_">IsZero</span> }}{{ (<span class="hljs-variable">$alert</span>.<span class="hljs-title class_">EndsAt</span>.<span class="hljs-title class_">Add</span> <span class="hljs-number">28800e9</span>).<span class="hljs-title class_">Format</span> <span class="hljs-string">"2006-01-02 15:04:05"</span> }}{{ <span class="hljs-keyword">else</span> }}持续中{{ <span class="hljs-keyword">end</span> }}

{{- <span class="hljs-keyword">end</span> }}

  


{{- <span class="hljs-keyword">end</span> }}

  


{{ <span class="hljs-keyword">end</span> }}

</code></pre>
<p>我的 Alertmanager 是用 docker 容器的形式运行的，进入容器中手动触发告警：</p>
<pre><code class="hljs language-bash" lang="bash">
<span class="hljs-comment"># docker exec -it alertmanager sh</span>

amtool alert add \

  --alertmanager.url=http://localhost:9093 \

  --annotation summary=<span class="hljs-string">"测试告警"</span> \

  --annotation description=<span class="hljs-string">"通过 amtool 发送的测试"</span> \

  alertname=TestAlert \

  severity=critical \

  instance=test-server

  


<span class="hljs-comment"># 生成测试数据（保存为 test_alert.json）</span>

<span class="hljs-built_in">cat</span> &gt; test_alert.json &lt;&lt; <span class="hljs-string">EOF

{

  "version": "4",

  "status": "firing",

  "alerts": [

    {

      "status": "firing",

      "labels": {

        "alertname": "HostOutOfMemory",

        "severity": "warning",

        "instance": "ubuntu-test-10-0-0-12",

        "hostname": "test-host",

        "env": "prod",

        "servicename": "node-exporter"

      },

      "annotations": {

        "summary": "内存不足告警",

        "description": "内存使用率超过90%"

      },

      "startsAt": "2025-08-09T08:00:00Z"

    }

  ]

}

EOF</span>

  


<span class="hljs-comment"># 用 amtool 测试模板渲染</span>

amtool template render \

  --template.glob=/etc/alertmanager/templates/wechat.tmpl \

  --template.data=test_alert.json \

  --template.text=<span class="hljs-string">'{{ template "wechat.message" . }}'</span>

</code></pre>
<p>golang 中转端也是用 docker 容器的形式运行的，一个简单的 <code>golang-wechat/Dockerfile</code>：</p>
<pre><code class="hljs language-Dockerfile" lang="Dockerfile">
FROM golang:1.23-alpine AS builder

WORKDIR /app

COPY main.go .

# 启用 CGO 禁用（静态编译，避免依赖系统库）

RUN CGO_ENABLED=0 GOOS=linux GOARCH=amd64 go build -ldflags="-s -w" -o mywechat main.go

FROM alpine:3.20

WORKDIR /app

COPY --from=builder /app/mywechat .

EXPOSE 5000

ENTRYPOINT ["./mywechat"]

</code></pre>
<p>构建、启动：</p>
<pre><code class="hljs language-bash" lang="bash">
docker build -t mywechat:v1 .

docker stop mywechat

docker <span class="hljs-built_in">rm</span> mywechat

docker run -d \

-v /etc/localtime:/etc/localtime:ro \

--user 1026:1026 \

--name mywechat \

-p 5000:5000 \

-e WECHAT_WEBHOOK_URL=<span class="hljs-string">"https://qyapi.weixin.qq.com/cgi-bin/webhook/send?key=xxxx-xxxx-xxxxx-xxxx-xxxx"</span> \

-v templates:/app/templates \

mywechat:v1

</code></pre>
<p>接下来就可以手动触发一些告警来验证告警规则的处理了。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Spring Boot 启动全解析：4 大关键动作 + 底层逻辑]]></title>    <link>https://juejin.cn/post/7596181746061197339</link>    <guid>https://juejin.cn/post/7596181746061197339</guid>    <pubDate>2026-01-17T07:52:45.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7596181746061197339" data-draft-id="7591728734983880731" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Spring Boot 启动全解析：4 大关键动作 + 底层逻辑"/> <meta itemprop="keywords" content="Spring Boot"/> <meta itemprop="datePublished" content="2026-01-17T07:52:45.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="闲煮光阴"/> <meta itemprop="url" content="https://juejin.cn/user/1523239911963420"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Spring Boot 启动全解析：4 大关键动作 + 底层逻辑
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1523239911963420/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    闲煮光阴
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-17T07:52:45.000Z" title="Sat Jan 17 2026 07:52:45 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-17
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    2
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>Spring Boot 以 “约定优于配置” 的核心思想大幅简化了 Spring 应用的开发与部署，其启动流程是理解框架底层原理的关键。本文将从 “核心动作” 和 “实现细节” 两个维度，全面拆解 Spring Boot 启动过程中完成的核心工作及底层实现逻辑。</p>
<h2 data-id="heading-0">一、Spring Boot 启动流程核心动作</h2>
<p>Spring Boot 启动的本质是完成 “环境准备 - 容器初始化 - 服务启动” 的全链路流程，核心可拆解为以下 4 个关键动作，且各动作遵循严格的执行顺序：</p>
<ol>
<li><strong>加载配置文件</strong>：整合多来源配置（内置默认、自定义配置文件、环境变量、命令行参数等），构建统一的应用环境上下文；</li>
<li><strong>加载日志组件</strong>：初始化日志系统，确保启动过程及应用运行的日志可追溯、可配置；</li>
<li><strong>创建 Spring 容器并初始化 Bean</strong>：构建 IoC 容器，扫描指定范围的 Bean 定义、解析注解、完成 Bean 的实例化与依赖注入；</li>
<li><strong>启动嵌入式 Web 服务器（如 Tomcat）</strong>：针对 Web 应用，初始化嵌入式服务器并绑定 Servlet/Filter 等组件，对外提供服务。</li>
</ol>
<h2 data-id="heading-1">二、核心动作的底层实现细节</h2>
<h3 data-id="heading-2">2.1 加载配置文件：整合多来源配置，构建环境上下文</h3>
<p>Spring Boot 配置文件的加载核心依赖 <code>ConfigFileApplicationListener</code>（Spring Boot 2.4+ 后逐步被 <code>ConfigDataEnvironmentPostProcessor</code> 替代，但核心逻辑一致），其核心作用是扫描指定路径下的配置文件（如 <code>application.yml</code>/<code>application.properties</code>），并将配置项整合到 <code>Environment</code> 上下文对象中。</p>
<h4 data-id="heading-3">调用流程</h4>
<pre><code class="hljs language-mermaid" lang="mermaid">%%{init:"wrap": false, {"flowchart":{"wrappingWidth":2000}}}%%
graph TD
A("SpringApplication.run() 入口方法")--&gt;|创建 SpringApplication 实例| B("new SpringApplication(primarySources)")
B--&gt;|构造函数初始化监听器| C("setListeners(getSpringFactoriesInstances(ApplicationListener.class))&lt;br/&gt;核心逻辑：读取 META-INF/spring.factories 文件，加载所有&lt;br/&gt; ApplicationListener 实现类，包含 ConfigFileApplicationListener")
C --&gt;D("调用 application.run(args) 执行启动流程")
D --&gt;|初始化运行监听器| E("SpringApplicationRunListeners listeners = getRunListeners(args)&lt;br/&gt;读取 META-INF/spring.factories 加载 EventPublishingRunListener&lt;br/&gt;（事件发布监听器）")
E--&gt;|准备环境上下文| F("prepareEnvironment(listeners, applicationArguments)")
F--&gt;|发布环境准备事件|G("listeners.environmentPrepared(environment)")
G--&gt;|事件分发|H("EventPublishingRunListener.environmentPrepared()&lt;br/&gt;触发 EnvironmentPreparedEvent 事件")
H--&gt;|监听器处理事件|I("ConfigFileApplicationListener.onApplicationEvent(EnvironmentPreparedEvent)")
I--&gt;|核心处理逻辑|J("onApplicationEnvironmentPreparedEvent(EnvironmentPreparedEvent)")
J--&gt;|解析配置文件|K("postProcessEnvironment(environment, applicationArguments)&lt;br/&gt;1. 扫描 classpath:/、classpath:/config/、file:./、file:./config/ 等路径；&lt;br/&gt;2. 按优先级加载 application.properties/yml、profile 专属配置；&lt;br/&gt;3. 整合环境变量、命令行参数覆盖配置项；&lt;br/&gt;4. 将配置项注入 Environment 上下文")


classDef leftAlign text-align:left;
class A,B,C,D,E,F,G,H,I,J,K,L,M,N,O,P,Q,R,S,T,U,V,W,S,Y,Z leftAlign;
</code></pre>
<h4 data-id="heading-4">关键补充说明</h4>
<ul>
<li>配置加载优先级：命令行参数 &gt; 环境变量 &gt; 自定义配置文件（如 application-dev.yml）&gt; 内置默认配置；</li>
<li>支持的配置格式：properties、yml、yaml，且支持多环境隔离（通过 <code>spring.profiles.active</code> 指定激活的 profile）；</li>
<li>核心目的：将分散的配置统一整合到 <code>Environment</code> 对象中，后续 Bean 初始化、服务器启动均可通过 <code>Environment</code> 获取配置项（如 <code>server.port</code>）。</li>
</ul>
<h3 data-id="heading-5">2.2 加载日志组件：初始化日志系统，保障日志可配置</h3>
<p>Spring Boot 启动时优先初始化日志组件，核心依赖 <code>LoggingApplicationListener</code>，其作用是根据应用配置（或默认规则）选择并初始化日志框架（如 Logback、Log4j2、Java Util Logging），确保启动过程的日志能正常输出。</p>
<h4 data-id="heading-6">调用流程</h4>
<pre><code class="hljs language-mermaid" lang="mermaid">%%{init:"wrap": false, {"flowchart":{"wrappingWidth":2000}}}%%
graph TD
A("SpringApplication.run() 入口方法")--&gt;|创建 SpringApplication 实例| B("new SpringApplication(primarySources)")
B--&gt;|构造函数初始化监听器| C("setListeners(getSpringFactoriesInstances(ApplicationListener.class))&lt;br/&gt;读取 META-INF/spring.factories 加载 LoggingApplicationListener")
C --&gt;D("调用 application.run(args) 执行启动流程")
D --&gt;|初始化运行监听器| E("SpringApplicationRunListeners listeners = getRunListeners(args)&lt;br/&gt;加载 EventPublishingRunListener")
E--&gt;|发布应用环境已准备事件|G("listeners.environmentPrepared()&lt;br/&gt;触发ApplicationEnvironmentPreparedEvent 事件")
G--&gt;|事件分发|H("EventPublishingRunListener.environmentPrepared()")
H--&gt;|监听器处理事件|I("LoggingApplicationListener.onApplicationEvent(ApplicationEvent)")
I--&gt;|核心处理逻辑|J("onApplicationEnvironmentPreparedEvent(ApplicationEnvironmentPreparedEvent)")
J--&gt;|选择并初始化日志系统|K("LoggingSystem.get(classLoader)&lt;br/&gt;1. 按优先级检测日志框架（Logback &gt; Log4j2 &gt; JUL）；&lt;br/&gt;2. 加载日志配置文件（如 logback-spring.xml）；&lt;br/&gt;3. 初始化日志级别、输出格式、输出路径等；&lt;br/&gt;4. 绑定日志系统到 Spring 环境，支持运行时动态调整")


classDef leftAlign text-align:left;
class A,B,C,D,E,F,G,H,I,J,K,L,M,N,O,P,Q,R,S,T,U,V,W,S,Y,Z leftAlign;

</code></pre>
<h4 data-id="heading-7">关键补充说明</h4>
<ul>
<li>日志框架优先级：Spring Boot 默认内置 Logback（无需额外依赖），若需切换为 Log4j2，需排除 Logback 依赖并引入 Log4j2 相关包；</li>
<li>日志配置加载路径：默认扫描 <code>classpath:logback-spring.xml</code>、<code>classpath:log4j2.xml</code> 等，也可通过 <code>logging.config</code> 配置项指定自定义路径；</li>
<li>核心目的：在应用核心逻辑启动前完成日志初始化，避免启动过程中日志丢失或格式异常。</li>
</ul>
<h3 data-id="heading-8">2.3 创建 Spring 容器并初始化 Bean：构建 IoC 核心，管理 Bean 生命周期</h3>
<p>Spring Boot 核心是构建 Spring IoC 容器，核心依赖 <code>ConfigurationClassPostProcessor</code>（Bean 定义后置处理器），其作用是解析启动类上的注解（如 <code>@SpringBootApplication</code>）、扫描指定包下的 Bean、解析自动配置类，最终完成 Bean 的注册与初始化。</p>
<h4 data-id="heading-9">调用流程</h4>
<pre><code class="hljs language-mermaid" lang="mermaid">%%{init:"wrap": false, {"flowchart":{"wrappingWidth":2000}}}%%
graph TD
A("SpringApplication.run() 入口方法")--&gt;|"创建 SpringApplication 实例"| A1("new SpringApplication(primarySources)")
A1--&gt;|执行启动逻辑| A2("application.run(args)")
A2--&gt;|创建应用上下文| B("createApplicationContext()&lt;br/&gt;根据应用类型选择上下文：Web 应用为 AnnotationConfigServletWebServerApplicationContext，&lt;br/&gt;非 Web 应用为 AnnotationConfigApplicationContext")
B--&gt;|"初始化 Web 应用上下文"| C("context = new AnnotationConfigServletWebServerApplicationContext()")
C --&gt;|"初始化 Bean 定义读取器"| D("new AnnotatedBeanDefinitionReader(beanFactory)&lt;br/&gt;用于解析注解驱动的 Bean 定义")
D --&gt;|注册核心后置处理器| E("AnnotationConfigUtils.registerAnnotationConfigProcessors(beanFactory)&lt;br/&gt;向容器中注册 ConfigurationClassPostProcessor 等核心处理器")
E--&gt;|关键处理器注册完成|F("ConfigurationClassPostProcessor 加入容器（Bean 定义解析核心）")
F--&gt;|"注册启动类为 Bean"|C1("application.load(primarySources)&lt;br/&gt;将 @SpringBootApplication 标注的启动类作为核心 Bean 注入容器")
C1--&gt;|"刷新上下文（核心步骤）"|G("refreshContext(context)")
G--&gt;|容器刷新核心方法|H("context.refresh()&lt;br/&gt;执行 Spring 容器初始化全流程")
H--&gt;|"执行 BeanFactory 后置处理器"|I("invokeBeanFactoryPostProcessors(beanFactory)")
I--&gt;|分发后置处理器执行逻辑|J("PostProcessorRegistrationDelegate.invokeBeanFactoryPostProcessors()")
J--&gt;|"执行 BeanDefinitionRegistry 后置处理器"|K("invokeBeanDefinitionRegistryPostProcessors(registryProcessors, registry)")
K--&gt;|"解析并注册 Bean 定义"|L("ConfigurationClassPostProcessor.postProcessBeanDefinitionRegistry(registry)&lt;br/&gt;1. 解析启动类上的 @ComponentScan，扫描指定包下的 @Component/@Service/@Repository 等 Bean；&lt;br/&gt;2. 解析 @EnableAutoConfiguration，读取 META-INF/spring/&lt;br/&gt;org.springframework.boot.autoconfigure.AutoConfiguration.imports 文件，加载自动配置类；&lt;br/&gt;3. 解析 @Bean 注解，注册手动声明的 Bean；&lt;br/&gt;4. 将所有 Bean 定义注册到 IoC 容器")
L--&gt;|"Bean 实例化与依赖注入"|M("finishBeanFactoryInitialization(beanFactory)&lt;br/&gt;实例化所有非懒加载 Bean，完成依赖注入、初始化方法（@PostConstruct）执行")

classDef leftAlign text-align:left;
class A,B,C,D,E,F,G,H,I,J,K,L,M,N,O,P,Q,R,S,T,U,V,W,S,Y,Z leftAlign;

</code></pre>
<h4 data-id="heading-10">关键补充说明</h4>
<ul>
<li>自动配置核心：<code>@EnableAutoConfiguration</code> 是自动配置的入口，Spring Boot 通过 <code>spring-boot-autoconfigure</code> 包中的自动配置类，实现 “按需加载”（如引入 redis 依赖则自动配置 RedisTemplate）；</li>
<li>扫描范围：默认扫描启动类所在包及其子包，可通过 <code>@ComponentScan</code> 指定自定义扫描范围；</li>
<li>核心目的：构建完整的 IoC 容器，管理所有 Bean 的生命周期，为应用提供依赖注入、AOP 等核心能力。</li>
</ul>
<h3 data-id="heading-11">2.4 启动嵌入式 Tomcat：初始化 Web 服务器，对外提供服务</h3>
<p>对于 Web 应用（引入 <code>spring-boot-starter-web</code>），Spring Boot 会自动启动嵌入式 Tomcat（默认），核心逻辑在 <code>ServletWebServerApplicationContext</code> 的 <code>onRefresh</code> 方法中，完成服务器创建、Servlet/Filter 绑定、端口监听等操作。</p>
<h4 data-id="heading-12">调用流程</h4>
<pre><code class="hljs language-mermaid" lang="mermaid">%%{init:"wrap": false, {"flowchart":{"wrappingWidth":2000}}}%%
graph TD
A("SpringApplication.run() 入口方法")--&gt;|创建 SpringApplication 实例| A1("new SpringApplication(primarySources)")
A1--&gt;|执行启动逻辑| A2("application.run(args)")
A2--&gt;|创建应用上下文| B("createApplicationContext()")
B--&gt;|初始化 Web 应用上下文| C("context = new AnnotationConfigServletWebServerApplicationContext()")
C--&gt;|刷新上下文|G("refreshContext(context)")
G--&gt;|容器刷新核心方法|H("context.refresh()")
H--&gt;|Web 服务器初始化|I("onRefresh()&lt;br/&gt;ServletWebServerApplicationContext 重写的刷新方法，专用于 Web 服务器启动")
I--&gt;|创建 Tomcat 实例|J("createWebServer()&lt;br/&gt;1. 根据 server.port 等配置创建 Tomcat 实例；&lt;br/&gt;2. 配置 Tomcat 基础路径、连接器（Connector）、引擎（Engine）等核心组件；&lt;br/&gt;3. 绑定上下文路径（server.servlet.context-path）")
J--&gt;|绑定 Servlet/Filter 等组件|L("getSelfInitializer()&lt;br/&gt;1. 从 IoC 容器中获取所有 ServletContextInitializer 实现类（如 DispatcherServletRegistrationBean）；&lt;br/&gt;2. 扫描容器中的 @Servlet/@Filter 注解组件，封装为 ServletContextInitializer 实现类；&lt;br/&gt;3. Tomcat 创建 ServletContext 时，执行这些 Initializer，完成 DispatcherServlet、Filter 等组件的注册")
L--&gt;|启动 Tomcat 服务器|K("finishRefresh()&lt;br/&gt;1. 调用 Tomcat.start() 启动服务器；&lt;br/&gt;2. 绑定端口监听，等待客户端请求；&lt;br/&gt;3. 发布 ApplicationStartedEvent 事件，标识应用启动完成")


classDef leftAlign text-align:left;
class A,B,C,D,E,F,G,H,I,J,K,L,M,N,O,P,Q,R,S,T,U,V,W,S,Y,Z leftAlign;
</code></pre>
<h4 data-id="heading-13">关键补充说明</h4>
<ul>
<li>服务器切换：若需将 Tomcat 替换为 Jetty/Undertow，只需排除 <code>spring-boot-starter-tomcat</code> 依赖，引入 <code>spring-boot-starter-jetty</code>/<code>spring-boot-starter-undertow</code>；</li>
<li>核心组件：DispatcherServlet 是 Spring MVC 的核心 Servlet，由 <code>DispatcherServletAutoConfiguration</code> 自动配置，负责接收并分发所有 Web 请求；</li>
<li>端口配置：默认端口 8080，可通过 <code>server.port</code> 配置，若配置为 0 则随机分配端口；</li>
<li>核心目的：启动嵌入式 Web 服务器，将 Spring MVC 核心组件绑定到服务器，对外提供 HTTP 服务。</li>
</ul>
<h2 data-id="heading-14">三、启动流程整体时序总结</h2>
<p>Spring Boot 启动流程的核心时序可概括为：</p>
<pre><code class="hljs language-scss" lang="scss">SpringApplication<span class="hljs-selector-class">.run</span>()
→ 初始化监听器（加载 LoggingApplicationListener/ConfigFileApplicationListener）
→ 发布 ApplicationStartingEvent（初始化日志）
→ 准备环境（加载配置文件，构建 Environment）
→ 创建 IoC 容器（AnnotationConfigServletWebServerApplicationContext）
→ 注册 ConfigurationClassPostProcessor（解析 Bean 定义）
→ 刷新容器（<span class="hljs-built_in">refresh</span>()）
 → 执行 BeanFactory 后置处理器（扫描并注册 Bean）
 → 实例化 Bean（完成依赖注入）
 → 初始化 Web 服务器（创建并启动 Tomcat）
→ 发布 ApplicationStartedEvent（启动完成）
</code></pre>
<h2 data-id="heading-15">四、核心总结</h2>
<p>Spring Boot 启动流程的本质是 “通过监听器机制完成环境准备，通过后置处理器完成 Bean 容器初始化，通过 Web 应用上下文完成嵌入式服务器启动”，其核心优势在于：</p>
<ol>
<li>自动化：通过 <code>spring.factories</code>/ 自动配置类，实现 “按需加载”，无需手动配置核心组件；</li>
<li>标准化：固定的启动流程确保应用开发的一致性，降低配置成本；</li>
<li>可扩展：通过自定义 <code>ApplicationListener</code>/<code>EnvironmentPostProcessor</code>/<code>BeanFactoryPostProcessor</code>，可灵活扩展启动逻辑。
理解上述流程，不仅能帮助开发者定位启动过程中的异常（如配置加载失败、Bean 冲突、端口占用），也能为自定义 Spring Boot Starter、扩展框架能力提供底层支撑。</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[重磅福利，TRAE 国际版全部用户限免一个月！]]></title>    <link>https://juejin.cn/post/7595868336595255315</link>    <guid>https://juejin.cn/post/7595868336595255315</guid>    <pubDate>2026-01-17T08:11:51.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7595868336595255315" data-draft-id="7595868336595238931" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="重磅福利，TRAE 国际版全部用户限免一个月！"/> <meta itemprop="keywords" content="AI编程"/> <meta itemprop="datePublished" content="2026-01-17T08:11:51.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="追逐时光者"/> <meta itemprop="url" content="https://juejin.cn/user/2770425031690333"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            重磅福利，TRAE 国际版全部用户限免一个月！
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2770425031690333/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    追逐时光者
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-17T08:11:51.000Z" title="Sat Jan 17 2026 08:11:51 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-17
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言</h2>
<p>好消息，TRAE 官方宣布为庆祝上线一周年 TRAE 国际版全部用户限免一个月！即从 2026 年 1 月 14 日 10:00 起，TRAE 国际版全部用户赠送 Fast Request 权益（不少于 1 个月 Pro 会员的用量）！</p>
<ul>
<li><strong>Free 用户：</strong> 账号增加 600 次 Fast Request，有效期至北京时间 2 月 14 日 10:00</li>
<li><strong>Pro 用户：</strong> 账号增加 800 次 Fast Request，有效期至北京时间 3 月 14 日 10:00</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2e56f08d087e492da9044f2b13a0ec1a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L-96YCQ5pe25YWJ6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769242310&amp;x-signature=Ua1SWt4bz1cULKkCGOOUvSigNV0%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-1">什么是 TRAE？</h2>
<p>TRAE 是字节跳动官方推出的 AI 原生 IDE，深度融合 AI 能力，是一名能够理解需求、调用工具并独立完成各类开发任务的“AI 开发工程师”，帮助你高效推进每一个项目。</p>
<h2 data-id="heading-2">主要功能</h2>
<p>TRAE 覆盖从编码、调试到测试、重构、部署等多类开发任务。提供智能体编程工具 CUE，支持代码补全、多行修改、智能导入和智能重命名等功能，适配多种日常开发场景，帮助你减少重复操作，专注核心创新。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bd67b575590943db9c969abde712eea8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L-96YCQ5pe25YWJ6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769242310&amp;x-signature=YQMNr%2BSFRu%2F%2Bl5VVnn%2FWTyCHbYQ%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-3">TRAE 内置 Al Coding 智能体</h2>
<p>TRAE 内置的 SOLO 模式，配备专属 Coding Agent，可理解目标、规划任务并调度工具，独立推进各阶段开发工作。从自然语言输入到可执行产出，帮助你高效完成开发任务。</p>
<ul>
<li><strong>SOLO Coder：</strong> 面向复杂项目开发的智能体。SOLO Coder 能够助力你高效完成从需求迭代到架构重构的全流程开发工作。</li>
<li><strong>SOLO Builder：</strong> 快速构建专业且功能完善的 Web 应用。你只需用自然语言描述需求，SOLO Builder 便会自动根据任务选择最合适的 AI 模型、分析需求、生成 PRD、编写代码，并产出可预览成果。</li>
</ul>
<h2 data-id="heading-4">领取限时权益包</h2>
<ul>
<li>领取地址：<a href="https://www.trae.ai/2026-anniversary-gift" target="_blank" title="https://www.trae.ai/2026-anniversary-gift" ref="nofollow noopener noreferrer">www.trae.ai/2026-annive…</a></li>
</ul>
<p><strong>或者打开 TRAE 直接调整领取：</strong></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/079f632d3f1b421587d02b83728d1782~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L-96YCQ5pe25YWJ6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769242310&amp;x-signature=N0IHyrSvj9QlN9wDAG9NlShKI%2Bk%3D" alt="" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/27d2f06ac0f94919b43e8f056855047b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L-96YCQ5pe25YWJ6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769242310&amp;x-signature=6ZCBUxVNyoQ3Cmce10mdUa1PZak%3D" alt="" loading="lazy"/></p>
<p><strong>领取成功：</strong></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/81a460a6f77d4ca29f3fd1f2e85cff34~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L-96YCQ5pe25YWJ6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769242310&amp;x-signature=b5d%2BvQbmwFoO%2BC4wu8sChPr67IM%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-5">TRAE 国际版下载安装</h2>
<ul>
<li>下载地址：<a href="https://www.trae.ai/" target="_blank" title="https://www.trae.ai/" ref="nofollow noopener noreferrer">www.trae.ai/</a></li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ff5dc7bb8c8b4ced8187a52ac96872b1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L-96YCQ5pe25YWJ6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769242310&amp;x-signature=5uNrBOx%2BhT0OD0xQKoh0zOHc%2FJI%3D" alt="" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/09e8bc5c7f0440a08cc8c225add16831~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L-96YCQ5pe25YWJ6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769242310&amp;x-signature=S1FjzZZlJk6j2P0Ky2OLeDicX7A%3D" alt="" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8541247833df43b6b85a65e834709ab3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L-96YCQ5pe25YWJ6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769242310&amp;x-signature=LzqlEasXsZ4WFzkJ%2F8mTJaBgo%2BQ%3D" alt="" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/64c96e4402e34e069bb4091d1f68e422~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L-96YCQ5pe25YWJ6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769242310&amp;x-signature=o2JYLLK%2FTqdK5IahJO%2BJ0kVtNdg%3D" alt="" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/88b31830cd6d4f809cc9b6ed7bb2c779~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L-96YCQ5pe25YWJ6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769242310&amp;x-signature=MplGuNksk5RQflq%2BjAtxXlyjkFs%3D" alt="" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4d067f8f230b4f628cf988b47cdda2db~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L-96YCQ5pe25YWJ6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769242310&amp;x-signature=5Osd7nwzu7Sn1sAIMvB%2Bn%2FeTiwc%3D" alt="" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c9f9a9348f0d41db8861d733268a1491~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L-96YCQ5pe25YWJ6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769242310&amp;x-signature=vweUe9khmcAdAT6s56UyU7vnGXQ%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-6">TRAE 开发者社区</h2>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Flcnziv86vkx6.feishu.cn%2Fwiki%2FGEEnwlfTQi8qZrkFsPycfkUKnul" target="_blank" title="https://lcnziv86vkx6.feishu.cn/wiki/GEEnwlfTQi8qZrkFsPycfkUKnul" ref="nofollow noopener noreferrer">lcnziv86vkx6.feishu.cn/wiki/GEEnwl…</a></li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/815c0911ad4347c58d3745b8a414d5fa~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L-96YCQ5pe25YWJ6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769242310&amp;x-signature=mtAwKEQWSxIC7%2ByYH%2Bq24YzUGt8%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-7">TRAE 官方文档</h2>
<ul>
<li><a href="https://docs.trae.ai/ide/what-is-trae?_lang=zh" target="_blank" title="https://docs.trae.ai/ide/what-is-trae?_lang=zh" ref="nofollow noopener noreferrer">docs.trae.ai/ide/what-is…</a></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[2026最新AI模型横评：谁才是你的最强“工作搭子”？]]></title>    <link>https://juejin.cn/post/7595831738234519561</link>    <guid>https://juejin.cn/post/7595831738234519561</guid>    <pubDate>2026-01-17T08:25:22.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7595831738234519561" data-draft-id="7595841630677205043" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content=" 2026最新AI模型横评：谁才是你的最强“工作搭子”？"/> <meta itemprop="keywords" content="人工智能"/> <meta itemprop="datePublished" content="2026-01-17T08:25:22.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Java中文社群"/> <meta itemprop="url" content="https://juejin.cn/user/61228381386487"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
             2026最新AI模型横评：谁才是你的最强“工作搭子”？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/61228381386487/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Java中文社群
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-17T08:25:22.000Z" title="Sat Jan 17 2026 08:25:22 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-17
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>AI 时代，最痛苦的不是没有工具，而是<strong>工具太多，根本不知道选哪个</strong>！</p>
<p>一边是 <strong>ChatGPT、Claude</strong> 等国外老牌霸主，一边是 <strong>DeepSeek、Kimi、通义千问</strong> 等国产新贵强势崛起。究竟是“外来的和尚好念经”，还是“国产之光”更懂中国心？</p>
<p>今天，我们实测了目前市面上最火的 8 款大模型，从<strong>逻辑推理、长文本处理、代码能力、日常交互</strong>等维度，为你送上一份<strong>保姆级选型指南</strong>。</p>
<hr/>
<h2 data-id="heading-0">🎬 视频演示</h2>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.bilibili.com%2Fvideo%2FBV1HkrUBVEpn%2F" target="_blank" title="https://www.bilibili.com/video/BV1HkrUBVEpn/" ref="nofollow noopener noreferrer">www.bilibili.com/video/BV1Hk…</a></p>
<hr/>
<h2 data-id="heading-1">第一梯队：国际“三巨头”</h2>
<p>如果你能解决网络门槛问题，这三位依然代表着<strong>目前 AI 智力的“天花板”</strong>。</p>

<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e5a0f42aeef343f2a576ad110266b43d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2YeS4reaWh-ekvue-pA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769243121&amp;x-signature=3wmhMPqJyYR0zHNwO0HsRu26UV8%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-2">1. ChatGPT (OpenAI) —— “六边形战士”</h3>
<p><strong>👑 地位：</strong> 行业标杆，所有模型的模仿对象。</p>
<ul>
<li><strong>🔥 核心优势：</strong>
<ul>
<li><strong>综合能力最强：</strong> 无论是写诗、写代码还是逻辑推理，GPT 几乎没有短板。</li>
<li><strong>生态无敌：</strong> 拥有海量的 GPTs（插件），可以画图、数据分析、联网搜索，一站式搞定。</li>
<li><strong>语音模式：</strong> 它的实时语音对话流畅度，目前仍是独一档的存在。</li>
</ul>
</li>
<li><strong>💔 缺点：</strong>
<ul>
<li>订阅费用贵（20 美元/月）。</li>
<li>国内访问门槛高，账号容易被封。</li>
</ul>
</li>
</ul>
<h3 data-id="heading-3">2. Claude (Anthropic) —— “不仅是文科生，更是程序员”</h3>
<p><strong>🦄 地位：</strong> 最像“人”的 AI，ChatGPT 最强的竞争对手。</p>
<ul>
<li><strong>🔥 核心优势：</strong>
<ul>
<li><strong>拟人化最高：</strong> 写出来的文章不仅逻辑通顺，而且文笔优美，没有“AI 味”，非常适合公文写作、邮件润色。</li>
<li><strong>Artifacts 功能：</strong> 能够直接在侧边栏预览代码效果（如网页、图表），是前端程序员和数据分析师的最爱。</li>
<li><strong>超大上下文：</strong> 能够一次性吃透整本书的内容。</li>
</ul>
</li>
<li><strong>💔 缺点：</strong>
<ul>
<li><strong>风控极严：</strong> 稍微聊点敏感话题（甚至只是为了剧情需要）就会拒绝回答。</li>
<li>免费版限制次数较多。</li>
</ul>
</li>
</ul>
<h3 data-id="heading-4">3. Gemini (Google) —— “全知全能的数据怪兽”</h3>
<p><strong>🚀 地位：</strong> Google 生态的亲儿子，拥有百万级上下文处理能力。</p>
<ul>
<li><strong>🔥 核心优势：</strong>
<ul>
<li><strong>百万上下文窗口：</strong> Gemini 3 Pro 可以一次性处理极长的视频、音频和文档，这是它的杀手锏。</li>
<li><strong>Google 全家桶集成：</strong> 直接调用 Google Docs, Gmail, Drive 里的资料，办公效率极高。</li>
<li><strong>多模态理解：</strong> 扔给它一段视频，它能精准告诉你视频里发生了什么。</li>
</ul>
</li>
<li><strong>💔 缺点：</strong>
<ul>
<li>逻辑推理偶尔会“幻觉”（一本正经胡说八道）。</li>
<li>产品线改名频繁，用户容易晕。</li>
</ul>
</li>
</ul>
<hr/>
<h2 data-id="heading-5">第二梯队：国产“五虎上将”</h2>
<p>国产模型不仅<strong>免费/便宜</strong>，而且<strong>更懂中文语境</strong>，在某些垂直领域甚至已经超越了 GPT-4。</p>

<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3a37ce125bb94db59f4df998ccfd87ba~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2YeS4reaWh-ekvue-pA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769243121&amp;x-signature=JICqUjU1aljvh7yKezpBsmCbkas%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-6">1. DeepSeek (深度求索) —— “硬核理工男，国产之光”</h3>
<p><strong>⚡ 特性：</strong> 开源界的英雄，代码与数学能力的王者。</p>
<ul>
<li><strong>👍 优点：</strong>
<ul>
<li><strong>代码/数学能力极强：</strong> 在 Coding 领域，DeepSeek V3/R1 的表现直逼甚至超越 GPT-4，深受程序员喜爱。</li>
<li><strong>开源精神：</strong> 模型权重公开，不仅 API 极其便宜（几乎是白菜价），还能本地部署。</li>
<li><strong>深度思考：</strong> R1 版本引入了类似 o1 的深度思考链，解决复杂逻辑问题能力爆表。</li>
</ul>
</li>
<li><strong>👎 缺点：</strong>
<ul>
<li>由于太火，服务器偶尔会崩。</li>
<li>文案写作略显生硬，不如文科类模型细腻。</li>
</ul>
</li>
</ul>
<h3 data-id="heading-7">2. Kimi (月之暗面) —— “长文本阅读神器”</h3>
<p><strong>📚 特性：</strong> 最早打响“长文本”招牌的国产模型。</p>
<ul>
<li><strong>👍 优点：</strong>
<ul>
<li><strong>吃透研报/论文：</strong> 扔给它 50 份 PDF，它能迅速帮你总结核心观点，是金融从业者和学生党的救星。</li>
<li><strong>联网搜索精准：</strong> 它的搜索引用链接非常规范，减少了胡编乱造的概率。</li>
<li><strong>界面清爽：</strong> UI 设计简洁，不仅好用，而且好看。</li>
</ul>
</li>
<li><strong>👎 缺点：</strong>
<ul>
<li>生成长文时，创意度有时稍显不足。</li>
</ul>
</li>
</ul>
<h3 data-id="heading-8">3. 通义千问 (Qwen - 阿里巴巴) —— “全能实干家”</h3>
<p><strong>🛠️ 特性：</strong> 阿里技术背书，开源生态极其丰富，并且最新的千问 APP 还<strong>可以帮你自动点餐</strong>。</p>
<ul>
<li><strong>👍 优点：</strong>
<ul>
<li><strong>图片理解能力强：</strong> 视觉识别（Vision）能力在国产模型中数一数二，能看懂复杂的图表和菜单。</li>
<li><strong>文档处理：</strong> 解析 Word、Excel 的能力非常稳定。</li>
<li><strong>不仅是聊天：</strong> 背后有通义听悟（做会议纪要）等一系列应用支持。</li>
</ul>
</li>
<li><strong>👎 缺点：</strong>
<ul>
<li>有时候回答过于“官方”，缺乏一点个性。</li>
</ul>
</li>
</ul>
<h3 data-id="heading-9">4. 智谱清言 (ChatGLM) —— “数据分析大师”</h3>
<p><strong>📊 特性：</strong> 源自清华系，工具调用能力强。</p>
<ul>
<li><strong>👍 优点：</strong>
<ul>
<li><strong>数据分析：</strong> 内置的代码解释器非常强大，上传 Excel 表格，它能直接帮你画出可视化的图表（柱状图、热力图等）。</li>
<li><strong>GLM 能力均衡：</strong> 综合素质很高，既能画图，又能联网，而且<strong>最新的 GLM 4.7 代码能力也不错</strong>。</li>
</ul>
</li>
<li><strong>👎 缺点：</strong>
<ul>
<li>移动端 APP 的体验偶尔有卡顿。</li>
</ul>
</li>
</ul>
<h3 data-id="heading-10">5. 豆包 (字节跳动) —— “最强语音搭子”</h3>
<p><strong>🎧 特性：</strong> 日活最高的国产 AI，主打 C 端日常陪伴。</p>
<ul>
<li><strong>👍 优点：</strong>
<ul>
<li><strong>语音交互最自然：</strong> 声音极其逼真，有情绪起伏，不像机器人在念稿，非常适合练口语或闲聊。</li>
<li><strong>功能丰富：</strong> 内置了各种“智能体”（如英语老师、小说写手），玩法很多。</li>
<li><strong>响应速度快：</strong> 字节的技术优化，让它在手机上用起来非常丝滑。</li>
</ul>
</li>
<li><strong>👎 缺点：</strong>
<ul>
<li>处理复杂逻辑和硬核代码任务时，相比 DeepSeek 稍弱。</li>
</ul>
</li>
</ul>
<hr/>
<h2 data-id="heading-11">⚡ 总结：到底该选哪一个？</h2>
<p>为了帮你省时间，我直接给出**“抄作业”建议**：</p>















































<table><thead><tr><th align="left">你的需求</th><th align="left"><strong>首选推荐 (国内)</strong></th><th align="left"><strong>首选推荐 (国外)</strong></th><th align="left">理由</th></tr></thead><tbody><tr><td align="left"><strong>写代码 / 搞数学</strong></td><td align="left"><strong>DeepSeek</strong></td><td align="left">Claude</td><td align="left">逻辑最强，不容易写出 Bug。</td></tr><tr><td align="left"><strong>读论文 / 看研报</strong></td><td align="left"><strong>Kimi</strong></td><td align="left">Gemini</td><td align="left">长文本吞吐量大，总结精准。</td></tr><tr><td align="left"><strong>写文章 / 润色邮件</strong></td><td align="left"><strong>通义千问 / Kimi</strong></td><td align="left">ChatGPT/Gemini</td><td align="left">文笔自然，读起来不尴尬。</td></tr><tr><td align="left"><strong>做图表 / 数据分析</strong></td><td align="left"><strong>智谱清言</strong></td><td align="left">ChatGPT/Gemini</td><td align="left">直接出图，省去 Excel 操作。</td></tr><tr><td align="left"><strong>练口语 / 闲聊解闷</strong></td><td align="left"><strong>豆包</strong></td><td align="left">ChatGPT</td><td align="left">声音好听，反应快，情商高。</td></tr><tr><td align="left"><strong>综合办公 / 啥都干</strong></td><td align="left"><strong>通义千问 / DeepSeek</strong></td><td align="left">ChatGPT/Gemini</td><td align="left">均衡发展，也是最稳的选择。</td></tr></tbody></table>

<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b9069286cc1744dc8f2542336fc7de4e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2YeS4reaWh-ekvue-pA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769243121&amp;x-signature=BzxMHgBq6p2btftOoqmEUf21vno%3D" alt="" loading="lazy"/><br/>
AI 模型更新速度极快（按周计算）。如果是<strong>工作重度使用</strong>，建议**“DeepSeek (逻辑) + Kimi (阅读)”**组合使用，完全免费且效率翻倍；如果有条件，<strong>ChatGPT/Gemini</strong> 依然是探索 AI 边界的最佳窗口。</p>
<p>拒绝选择困难症，现在就去打开一个试试吧！</p>
<blockquote>
<p>本文已收录到我的技术小站 <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.javacn.site" target="_blank" title="https://www.javacn.site" ref="nofollow noopener noreferrer">www.javacn.site</a>，网站包含的内容有：<strong>N8N/Coze/Dify/LangChain/SpringAI/SpringAIAlibaba/LangChain4j/AI实战项目/AI常见面试题</strong>等技术分享，欢迎各位大佬光临指导~</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[鸿蒙异步并发 async/await 最佳实践，代码瞬间优雅]]></title>    <link>https://juejin.cn/post/7595527937832861750</link>    <guid>https://juejin.cn/post/7595527937832861750</guid>    <pubDate>2026-01-16T08:00:48.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7595527937832861750" data-draft-id="7595552420047585323" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="鸿蒙异步并发 async/await 最佳实践，代码瞬间优雅"/> <meta itemprop="keywords" content="HarmonyOS,ArkTS,ArkUI"/> <meta itemprop="datePublished" content="2026-01-16T08:00:48.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="威哥爱编程"/> <meta itemprop="url" content="https://juejin.cn/user/2242659450109575"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            鸿蒙异步并发 async/await 最佳实践，代码瞬间优雅
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2242659450109575/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    威哥爱编程
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-16T08:00:48.000Z" title="Fri Jan 16 2026 08:00:48 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-16
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>Hello，兄弟们，我是 V 哥！</p>
<p>还记得以前写 Android 或者早期 JavaScript 的时候，那个传说中的**“回调地狱”**吗？</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 伪代码演示：让人崩溃的金字塔</span>
<span class="hljs-title function_">login</span>(user, <span class="hljs-function">(<span class="hljs-params">res1</span>) =&gt;</span> {
  <span class="hljs-title function_">getUserInfo</span>(res1.<span class="hljs-property">id</span>, <span class="hljs-function">(<span class="hljs-params">res2</span>) =&gt;</span> {
    <span class="hljs-title function_">getOrders</span>(res2.<span class="hljs-property">token</span>, <span class="hljs-function">(<span class="hljs-params">res3</span>) =&gt;</span> {
      <span class="hljs-title function_">getDetail</span>(res3.<span class="hljs-property">orderId</span>, <span class="hljs-function">(<span class="hljs-params">res4</span>) =&gt;</span> {
        <span class="hljs-comment">// 终于结束了... 代码已经缩进到屏幕外边了</span>
      })
    })
  })
})
</code></pre>
<p>这种代码，维护起来简直是噩梦！但在鸿蒙 ArkTS 的 API 21 环境下，兄弟们千万别再这么写了！ArkTS 是基于 TypeScript 的，它原生支持非常强大的 <strong><code>async/await</code></strong> 语法。</p>
<p>今天 V 哥就带你把这段“金字塔”拍平，用 <strong>同步的逻辑写异步的代码</strong>，优雅得像喝下午茶一样！</p>
<hr/>
<h2 data-id="heading-0">核心心法：把“等待”变成“暂停”</h2>
<p>兄弟们，记住 V 哥这两个口诀：</p>
<ol>
<li><strong><code>async</code></strong>：加在函数定义前面，表示“这里面有耗时的活儿”。</li>
<li><strong><code>await</code></strong>：加在耗时的调用前面，表示“<strong>等着这儿干完，再去干下一行，但别把界面卡死</strong>”。</li>
</ol>
<p>有了这两个神器，异步代码写出来就像在写小学作文，从上到下，一行一行读，逻辑清晰无比。</p>
<hr/>
<h2 data-id="heading-1">实战代码案例</h2>
<p>为了让大家直观感受，V 哥写了一个完整的 Demo。咱们模拟三个常见的真实场景：</p>
<ol>
<li><strong>串行执行</strong>：先登录，再拿用户信息。</li>
<li><strong>并发执行</strong>：同时拉取“广告配置”和“首页推荐”。</li>
<li><strong>异常处理</strong>：优雅地捕获网络错误。</li>
</ol>
<p><strong>操作步骤：</strong> 打开你的 DevEco Studio 6.0，新建一个 ArkTS 页面，把下面的代码完整复制进去，直接运行！</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> promptAction <span class="hljs-keyword">from</span> <span class="hljs-string">'@ohos.promptAction'</span>;

<span class="hljs-comment">/**
 * V哥的模拟网络请求类
 * 在真实项目中，这里会换成 httpRequest 或者 网络库
 */</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">NetworkSimulator</span> {
  <span class="hljs-comment">// 模拟一个异步耗时操作，返回 Promise</span>
  <span class="hljs-keyword">static</span> <span class="hljs-title function_">request</span>(<span class="hljs-attr">apiName</span>: <span class="hljs-built_in">string</span>, <span class="hljs-attr">data</span>: <span class="hljs-built_in">string</span>, <span class="hljs-attr">delay</span>: <span class="hljs-built_in">number</span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">string</span>&gt; {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> {
      <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
        <span class="hljs-comment">// 模拟 20% 的概率失败</span>
        <span class="hljs-keyword">if</span> (<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() &lt; <span class="hljs-number">0.2</span>) {
          <span class="hljs-title function_">reject</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">`<span class="hljs-subst">${apiName}</span> 请求失败，网络不给力！`</span>));
        } <span class="hljs-keyword">else</span> {
          <span class="hljs-title function_">resolve</span>(<span class="hljs-string">`<span class="hljs-subst">${apiName}</span> 返回的数据: <span class="hljs-subst">${data}</span>`</span>);
        }
      }, delay);
    });
  }
}

<span class="hljs-meta">@Entry</span>
<span class="hljs-meta">@Component</span>
struct <span class="hljs-title class_">AsyncAwaitDemo</span> {
  <span class="hljs-meta">@State</span> <span class="hljs-attr">resultLog</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">'V哥准备好输出日志了...'</span>;
  <span class="hljs-meta">@State</span> <span class="hljs-attr">isLoading</span>: <span class="hljs-built_in">boolean</span> = <span class="hljs-literal">false</span>;

  <span class="hljs-title function_">build</span>(<span class="hljs-params"/>) {
    <span class="hljs-title class_">Column</span>() {
      <span class="hljs-title class_">Text</span>(<span class="hljs-string">'鸿蒙 async/await 实战实验室'</span>)
        .<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">24</span>)
        .<span class="hljs-title function_">fontWeight</span>(<span class="hljs-title class_">FontWeight</span>.<span class="hljs-property">Bold</span>)
        .<span class="hljs-title function_">margin</span>({ <span class="hljs-attr">top</span>: <span class="hljs-number">30</span>, <span class="hljs-attr">bottom</span>: <span class="hljs-number">20</span> })

      <span class="hljs-comment">// 场景一：串行执行</span>
      <span class="hljs-title class_">Button</span>(<span class="hljs-string">'场景1：串行执行 (登录 -&gt; 获取信息)'</span>)
        .<span class="hljs-title function_">width</span>(<span class="hljs-string">'90%'</span>)
        .<span class="hljs-title function_">margin</span>({ <span class="hljs-attr">bottom</span>: <span class="hljs-number">15</span> })
        .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {
          <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">testSequential</span>();
        })

      <span class="hljs-comment">// 场景二：并发执行</span>
      <span class="hljs-title class_">Button</span>(<span class="hljs-string">'场景2：并发执行 (同时拉取配置和广告)'</span>)
        .<span class="hljs-title function_">width</span>(<span class="hljs-string">'90%'</span>)
        .<span class="hljs-title function_">margin</span>({ <span class="hljs-attr">bottom</span>: <span class="hljs-number">15</span> })
        .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {
          <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">testParallel</span>();
        })

      <span class="hljs-comment">// 场景三：异常捕获</span>
      <span class="hljs-title class_">Button</span>(<span class="hljs-string">'场景3：异常捕获 (模拟失败重试)'</span>)
        .<span class="hljs-title function_">width</span>(<span class="hljs-string">'90%'</span>)
        .<span class="hljs-title function_">margin</span>({ <span class="hljs-attr">bottom</span>: <span class="hljs-number">15</span> })
        .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {
          <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">testErrorHandling</span>();
        })

      <span class="hljs-comment">// 日志显示区域</span>
      <span class="hljs-title class_">Column</span>() {
        <span class="hljs-title class_">Text</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">resultLog</span>)
          .<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">14</span>)
          .<span class="hljs-title function_">fontColor</span>(<span class="hljs-string">'#333333'</span>)
          .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)
      }
      .<span class="hljs-title function_">width</span>(<span class="hljs-string">'90%'</span>)
      .<span class="hljs-title function_">height</span>(<span class="hljs-string">'40%'</span>)
      .<span class="hljs-title function_">padding</span>(<span class="hljs-number">15</span>)
      .<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-string">'#F1F3F5'</span>)
      .<span class="hljs-title function_">borderRadius</span>(<span class="hljs-number">10</span>)
      .<span class="hljs-title function_">margin</span>({ <span class="hljs-attr">top</span>: <span class="hljs-number">20</span> })

      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">isLoading</span>) {
        <span class="hljs-title class_">LoadingProgress</span>()
          .<span class="hljs-title function_">width</span>(<span class="hljs-number">30</span>)
          .<span class="hljs-title function_">height</span>(<span class="hljs-number">30</span>)
          .<span class="hljs-title function_">margin</span>({ <span class="hljs-attr">top</span>: <span class="hljs-number">20</span> })
          .<span class="hljs-title function_">color</span>(<span class="hljs-title class_">Color</span>.<span class="hljs-property">Blue</span>)
      }

    }
    .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)
    .<span class="hljs-title function_">height</span>(<span class="hljs-string">'100%'</span>)
    .<span class="hljs-title function_">padding</span>({ <span class="hljs-attr">left</span>: <span class="hljs-number">20</span>, <span class="hljs-attr">right</span>: <span class="hljs-number">20</span> })
  }

  <span class="hljs-comment">/**
   * V哥解析：场景1 - 串行执行
   * 特点：一步接一步，下一步依赖上一步的结果。
   * 代码逻辑：完全是线性的，像同步代码一样易读！
   */</span>
  <span class="hljs-keyword">async</span> <span class="hljs-title function_">testSequential</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">isLoading</span> = <span class="hljs-literal">true</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">resultLog</span> = <span class="hljs-string">'1. 开始登录...\n'</span>;

    <span class="hljs-keyword">try</span> {
      <span class="hljs-comment">// V哥重点：await 会暂停函数执行，直到 Promise resolve</span>
      <span class="hljs-comment">// 这里模拟先登录，耗时 1000ms</span>
      <span class="hljs-keyword">let</span> loginRes = <span class="hljs-keyword">await</span> <span class="hljs-title class_">NetworkSimulator</span>.<span class="hljs-title function_">request</span>(<span class="hljs-string">'LoginAPI'</span>, <span class="hljs-string">'Token123'</span>, <span class="hljs-number">1000</span>);
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">resultLog</span> += <span class="hljs-string">`   <span class="hljs-subst">${loginRes}</span>\n`</span>;

      <span class="hljs-variable language_">this</span>.<span class="hljs-property">resultLog</span> += <span class="hljs-string">'2. 正在获取用户信息...\n'</span>;
      <span class="hljs-comment">// 依赖上面的 Token，继续 await</span>
      <span class="hljs-keyword">let</span> userRes = <span class="hljs-keyword">await</span> <span class="hljs-title class_">NetworkSimulator</span>.<span class="hljs-title function_">request</span>(<span class="hljs-string">'GetUserInfo'</span>, <span class="hljs-string">'V哥的大名'</span>, <span class="hljs-number">800</span>);
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">resultLog</span> += <span class="hljs-string">`   <span class="hljs-subst">${userRes}</span>\n`</span>;

      <span class="hljs-variable language_">this</span>.<span class="hljs-property">resultLog</span> += <span class="hljs-string">'✅ 全部完成！(串行总耗时约 1.8s)'</span>;
      
      promptAction.<span class="hljs-title function_">showToast</span>({ <span class="hljs-attr">message</span>: <span class="hljs-string">'串行执行完成'</span> });

    } <span class="hljs-keyword">catch</span> (error) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">resultLog</span> += <span class="hljs-string">`❌ 出错了: <span class="hljs-subst">${error.message}</span>`</span>;
    } <span class="hljs-keyword">finally</span> {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">isLoading</span> = <span class="hljs-literal">false</span>;
    }
  }

  <span class="hljs-comment">/**
   * V哥解析：场景2 - 并发执行
   * 特点：两个请求互不依赖，同时发出，谁先回来谁先结束。
   * 优势：速度最快！总耗时 = 两个请求中最慢的那个，而不是两者之和。
   */</span>
  <span class="hljs-keyword">async</span> <span class="hljs-title function_">testParallel</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">isLoading</span> = <span class="hljs-literal">true</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">resultLog</span> = <span class="hljs-string">'1. 同时启动多个任务...\n'</span>;

    <span class="hljs-comment">// 记录开始时间</span>
    <span class="hljs-keyword">const</span> startTime = <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>();

    <span class="hljs-keyword">try</span> {
      <span class="hljs-comment">// V哥重点：Promise.all()</span>
      <span class="hljs-comment">// 把所有要并发的 Promise 放进数组里</span>
      <span class="hljs-comment">// await 会等数组里所有的 Promise 都 resolve 才继续</span>
      <span class="hljs-keyword">let</span> results = <span class="hljs-keyword">await</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">all</span>([
        <span class="hljs-title class_">NetworkSimulator</span>.<span class="hljs-title function_">request</span>(<span class="hljs-string">'GetConfig'</span>, <span class="hljs-string">'系统配置'</span>, <span class="hljs-number">1500</span>), <span class="hljs-comment">// 假设这个慢</span>
        <span class="hljs-title class_">NetworkSimulator</span>.<span class="hljs-title function_">request</span>(<span class="hljs-string">'GetBanner'</span>, <span class="hljs-string">'广告图片'</span>, <span class="hljs-number">1000</span>)  <span class="hljs-comment">// 假设这个快</span>
      ]);

      <span class="hljs-comment">// results 是一个数组，顺序和你传入的顺序一致，不管谁先回来</span>
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">resultLog</span> += <span class="hljs-string">`   <span class="hljs-subst">${results[<span class="hljs-number">0</span>]}</span>\n`</span>; <span class="hljs-comment">// 第一个结果</span>
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">resultLog</span> += <span class="hljs-string">`   <span class="hljs-subst">${results[<span class="hljs-number">1</span>]}</span>\n`</span>; <span class="hljs-comment">// 第二个结果</span>

      <span class="hljs-keyword">const</span> duration = <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>() - startTime;
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">resultLog</span> += <span class="hljs-string">`✅ 全部完成！(并发总耗时约 <span class="hljs-subst">${duration}</span>ms，比串行快！)`</span>;
      
      promptAction.<span class="hljs-title function_">showToast</span>({ <span class="hljs-attr">message</span>: <span class="hljs-string">'并发执行完成'</span> });

    } <span class="hljs-keyword">catch</span> (error) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">resultLog</span> += <span class="hljs-string">`❌ 出错了: <span class="hljs-subst">${error.message}</span>`</span>;
    } <span class="hljs-keyword">finally</span> {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">isLoading</span> = <span class="hljs-literal">false</span>;
    }
  }

  <span class="hljs-comment">/**
   * V哥解析：场景3 - 异常处理
   * 特点：async/await 下，我们用 try...catch...finally 代替 .then().catch()
   * 这比传统的 Promise 链式调用要直观得多，像处理 Java 异常一样舒服。
   */</span>
  <span class="hljs-keyword">async</span> <span class="hljs-title function_">testErrorHandling</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">isLoading</span> = <span class="hljs-literal">true</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">resultLog</span> = <span class="hljs-string">'尝试发送请求 (模拟20%失败率)...\n'</span>;

    <span class="hljs-keyword">try</span> {
      <span class="hljs-comment">// 这里的请求可能会抛出 Error</span>
      <span class="hljs-keyword">let</span> data = <span class="hljs-keyword">await</span> <span class="hljs-title class_">NetworkSimulator</span>.<span class="hljs-title function_">request</span>(<span class="hljs-string">'RiskyAPI'</span>, <span class="hljs-string">'试试运气'</span>, <span class="hljs-number">1000</span>);
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">resultLog</span> += <span class="hljs-string">`   成功: <span class="hljs-subst">${data}</span>`</span>;
      promptAction.<span class="hljs-title function_">showToast</span>({ <span class="hljs-attr">message</span>: <span class="hljs-string">'请求成功'</span> });

    } <span class="hljs-keyword">catch</span> (error) {
      <span class="hljs-comment">// V哥重点：一旦任何一步 await 报错，直接跳进 catch</span>
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">resultLog</span> += <span class="hljs-string">`   捕获到异常: <span class="hljs-subst">${error.message}</span>\n`</span>;
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">resultLog</span> += <span class="hljs-string">`   这里可以进行重试逻辑...`</span>;
      
      promptAction.<span class="hljs-title function_">showToast</span>({ <span class="hljs-attr">message</span>: <span class="hljs-string">'请求被拦截'</span> });

    } <span class="hljs-keyword">finally</span> {
      <span class="hljs-comment">// V哥重点：finally 无论成功失败都会执行</span>
      <span class="hljs-comment">// 适合用来关闭 Loading 弹窗</span>
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">isLoading</span> = <span class="hljs-literal">false</span>;
    }
  }
}
</code></pre>
<p>运行结果：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6818be9281524d31a73fff7d7edfe3d9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aiB5ZOl54ix57yW56iL:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769155247&amp;x-signature=zL9R6ZeXyZSmko98g2VPgKpHfNU%3D" alt="" loading="lazy"/></p>
<hr/>
<h2 data-id="heading-2">V 哥的代码深度解析</h2>
<p>兄弟们，代码能跑了，咱们得懂原理，不然面试的时候要挂！</p>
<h3 data-id="heading-3">1. 为什么 async/await 不会卡死界面？</h3>
<p>这就是并发编程的魔力。
当你写 <code>let res = await someRequest()</code> 的时候，ArkTS 的运行时会把<strong>当前任务的挂起</strong>，把主线程的控制权交还给 UI 系统。
这就好比你去排队买奶茶，你叫服务员做奶茶（发起请求），你站在旁边等（await），但**店里的其他人（UI线程）**依然可以继续进店买东西。只有当你的奶茶好了（Promise resolve），你才拿着奶茶走人（代码继续往下走）。</p>
<h3 data-id="heading-4">2. Promise.all 是性能优化的利器</h3>
<p>在场景 2 中，V 哥演示了 <code>Promise.all</code>。
如果你的首页有 5 个接口，互不依赖，你千万别写 5 行 await：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// ❌ 错误写法：慢得要死</span>
<span class="hljs-keyword">let</span> a = <span class="hljs-keyword">await</span> <span class="hljs-title function_">req1</span>(); <span class="hljs-comment">// 等1秒</span>
<span class="hljs-keyword">let</span> b = <span class="hljs-keyword">await</span> <span class="hljs-title function_">req2</span>(); <span class="hljs-comment">// 再等1秒</span>
<span class="hljs-comment">// ... 总耗时 5秒</span>
</code></pre>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// ✅ V 哥正确写法：飞快</span>
<span class="hljs-keyword">let</span> results = <span class="hljs-keyword">await</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">all</span>([<span class="hljs-title function_">req1</span>(), <span class="hljs-title function_">req2</span>(), <span class="hljs-title function_">req3</span>(), <span class="hljs-title function_">req4</span>(), <span class="hljs-title function_">req5</span>()]);
<span class="hljs-comment">// 总耗时 = 最慢的那个接口 (假设是 1.2秒)</span>
</code></pre>
<p>这可是实打实的性能提升，用户打开 App 的速度直接肉眼可见变快！</p>
<h3 data-id="heading-5">3. 不要忘记了 try-catch</h3>
<p>以前写 Promise 链，如果不加 <code>.catch()</code>，报错了可能就像石沉大海，静默失败。
用了 <code>async/await</code>，<strong>一定要</strong> 包裹在 <code>try...catch</code> 里。这是对自己代码负责，也是对用户负责。</p>
<hr/>
<h2 data-id="heading-6">总结</h2>
<p>来来来，V 哥稍微小结一下：</p>
<ol>
<li><strong>逻辑复杂？</strong> 用 <code>async/await</code> 拍平金字塔。</li>
<li><strong>请求多且慢？</strong> 用 <code>Promise.all</code> 并行加速。</li>
<li><strong>怕出错？</strong> 用 <code>try/catch</code> 稳稳兜底。</li>
</ol>
<p>在 DevEco Studio 6.0 里，这套组合拳用熟练了，你的代码质量和开发效率绝对能甩开同行一条街。</p>
<p>我是 V 哥，拒绝回调地狱，从今天开始！咱们下期见！👋</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[🔥1篇搞懂AI通识:大白话拆解核心点]]></title>    <link>https://juejin.cn/post/7595610998033727515</link>    <guid>https://juejin.cn/post/7595610998033727515</guid>    <pubDate>2026-01-16T07:25:11.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7595610998033727515" data-draft-id="7595626157909213193" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="🔥1篇搞懂AI通识:大白话拆解核心点"/> <meta itemprop="keywords" content="程序员"/> <meta itemprop="datePublished" content="2026-01-16T07:25:11.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="京东云开发者"/> <meta itemprop="url" content="https://juejin.cn/user/2634854380340008"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            🔥1篇搞懂AI通识:大白话拆解核心点
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2634854380340008/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    京东云开发者
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-16T07:25:11.000Z" title="Fri Jan 16 2026 07:25:11 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-16
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读21分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>作者：卢旭</p>
<h2 data-id="heading-0">引言</h2>
<p>随着 AI 技术从实验室走向日常，“机器学习”“大模型”“Transformer”“MOE” 等词汇已不再是技术圈的专属。从智能聊天助手到电商推荐，从语音识别到自动驾驶，AI 正以多元形态融入生活。这篇文章按 “基础→核心→优化→落地→工具→术语” 的逻辑，用最通俗的大白话，把 AI 通识技术点讲透。帮助你我他她建立更完整的 AI 认知框架，理解技术背后的核心逻辑与实际价值，“看透” AI 技术的底层逻辑，让复杂概念变得清晰易懂。</p>
<hr/>
<p>﻿</p>
<h2 data-id="heading-1">一、基础概念（搞懂 AI 的 “底层逻辑”）</h2>
<h3 data-id="heading-2">1. 什么是 AI（人工智能）？</h3>
<p>AI 本质就是 “让机器像人一样思考、干活” 的技术体系 —— 不用人一步步指挥，机器能自己学规律、做决策。比如手机人脸识别、聊天机器人、自动驾驶，都是 AI 的具体应用。它不是单一技术，而是一堆技术的 “总称”，就像 “家电” 包含冰箱、电视一样。这张网上流行的图概述了人工智能（AI）随着时间推移的发展历程，从早期阶段到机器学习、深度学习以及大型语言模型（LLM）的出现。</p>
<p>﻿</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/daa11585169c437f8b058f602f61fc0a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769153111&amp;x-signature=I7cedMjtba%2FN8BFKucvxk4dKCJA%3D" alt="" loading="lazy"/></p>
<p>﻿﻿</p>
<h3 data-id="heading-3">2. 什么是机器学习、强化学习、深度学习，它们的关系？</h3>
<p>这仨是 AI 的 “核心方法论”，是 “大圈套小圈” 的关系：</p>
<p>•<strong>机器学习</strong>：AI 的 “基础学习法”—— 让机器像 “学生刷题”，从数据里自己找规律（比如看 1000 张猫的照片，自己总结 “尖耳朵 = 猫”），不用人逐条教规则。</p>
<p>•<strong>深度学习</strong>：机器学习的 “高级版”—— 给机器配了 “多层思考大脑”（神经网络），能分层挖数据的深层规律（比如先看猫的轮廓，再看细节，最后判断），适合处理图片、长文本等复杂任务。</p>
<p>•<strong>强化学习</strong>：机器学习的 “特训法”—— 让机器像 “宠物学技能”，做对了给奖励（赢棋加分），做错了给惩罚（输棋扣分），反复试错后优化策略，比如 AI 玩游戏、下围棋都靠它。</p>
<p>关系总结：机器学习是 “总方法”，深度学习是 “高级分支”，强化学习是 “训练技巧”，三者常搭配使用（比如 ChatGPT 用深度学习架构，靠强化学习优化回答）。</p>
<h3 data-id="heading-4">3. 机器学习三大范式</h3>
<p>范式就是 “教机器干活的具体方式”，核心区别是 “给不给机器‘标准答案’”（标准答案叫 “标签”，比如 “这张是猫”）：</p>





























<table><thead><tr><th>范式类型</th><th>通俗类比</th><th>核心逻辑</th><th>实际应用</th></tr></thead><tbody><tr><td>监督学习</td><td>做 “带答案的习题册”</td><td>给机器的所有数据都标好 “对错 / 结果”，机器学完后直接套用规律</td><td>垃圾邮件识别、翻译软件、图片分类</td></tr><tr><td>无监督学习</td><td>整理 “无标签的杂物”</td><td>只给机器原始数据，不标答案，让它自己找分类 / 规律</td><td>电商 “猜你喜欢”、客户群体划分、异常交易检测</td></tr><tr><td>半监督学习</td><td>做 “一半有答案的习题册”</td><td>少量数据标答案（教基础规律），大量数据无答案（让机器举一反三）</td><td>方言识别、罕见疾病诊断（标注数据少的场景）</td></tr></tbody></table>
<p>补充：强化学习也常被单独列为一类，核心是 “靠奖励 / 惩罚试错学习”。</p>
<h3 data-id="heading-5">4. 什么是神经网络？</h3>
<p>神经网络是深度学习的 “核心骨架”，模仿人脑神经元的连接方式，本质是 “按层排列的小计算单元集合”，像 “工厂流水线”：</p>
<p>•<strong>输入层</strong>：“原材料入口”—— 接收原始数据（比如图片像素、文字）；</p>
<p>•<strong>隐藏层</strong>：“核心加工车间”—— 层数越多，深度学习越 “深”，负责一步步提取数据特征（从轮廓到细节）；</p>
<p>•<strong>输出层</strong>：“成品出口”—— 输出最终结果（比如 “这是猫”“翻译结果”）。</p>
<p>每个 “小计算单元”（神经元）就像 “小计算器”，筛选有用信息、弱化无用信息，训练模型就是调整这些单元的 “工作规则”，让它越来越精准。</p>
<h3 data-id="heading-6">5. 为什么深度学习要 “深”？</h3>
<p>“深” 指神经网络的 “隐藏层多”，不是为了凑数，而是为了 “挖深层规律”：</p>
<p>•1 层网络（浅）：只能看表面信息（比如图片的像素颜色），分不清猫和狗；</p>
<p>•3 层网络（中深）：第 1 层看 “边缘 / 明暗”→第 2 层拼 “耳朵 / 圆形轮廓”→第 3 层判断 “尖耳朵 = 猫、圆形 = 球”；</p>
<p>•10 层以上网络（深）：能分层提取特征（先轮廓→再细节→再逻辑），比如识别 “小狗在追蝴蝶”，能看懂 “动作” 和 “场景”。</p>
<p>简单说：“深” 的本质是 “分层提取特征”：从表面的 “像素 / 文字”，挖到深层的 “逻辑 / 场景”；任务越复杂（写小说、解数学题），越需要 “深” 网络，才能从表面数据挖到核心逻辑。</p>
<h3 data-id="heading-7">6. 什么是预训练？</h3>
<p>预训练就是给大模型 “打基础”—— 用海量通用数据（比如几百万本书、网页）让模型先学 “通用知识”（语法、常识、逻辑），相当于让学生先读完小学到大学的通识课程，具备基本能力。</p>
<p>预训练后的模型就像 “有基础的学霸”，不用再从零学起，后续只需针对性培训（微调），就能适配具体任务（比如当客服、写代码）。</p>
<h3 data-id="heading-8">7. 什么是大模型 LLM？</h3>
<p>LLM 是 “大语言模型” 的缩写，核心是 “用超大神经网络，学海量文字数据，能像人一样理解和生成语言”—— 通俗说就是 “读过全世界书的超级学霸”。</p>
<p>“大” 体现在三点：</p>
<p>•参数量大：相当于 “学霸的脑细胞多”，能存更多知识（比如 GPT-4 有万亿级参数）；</p>
<p>•数据量多：相当于 “学霸读的书多”，覆盖书籍、论文、网页等，知识渊博；</p>
<p>•能力全：能聊天、写文案、解数学题、编代码，不用专门训练。</p>
<h3 data-id="heading-9">8. 什么是多模态大模型？</h3>
<p>“模态” 就是 AI 能处理的 “信息类型”（文字、图片、语音、视频），多模态大模型就是 “全能选手”—— 能同时处理多种信息：</p>
<p>•比如你发一张风景照，它能描述内容、配诗，还能把诗读出来；</p>
<p>•常见例子：GPT-4V、文心一言多模态版，能看图片、听语音、写文字。</p>
<hr/>
<p>﻿</p>
<h2 data-id="heading-10">二、核心架构与机制（AI 的 “底层骨架”）</h2>
<h3 data-id="heading-11">1. 传统架构与演进：什么是 RNN/LSTM/GRU？</h3>
<p>在 Transformer 出现前，处理文字、语音等 “序列数据”（有先后顺序的数据）靠这些架构：</p>
<p>•<strong>RNN</strong>：“逐字处理” 的架构 —— 像读文章逐字念，只能记住最近的信息，处理长文本会 “忘事”（比如读 1000 字文章，后面忘了前面）；</p>
<p>•<strong>LSTM/GRU</strong>：RNN 的 “升级版”—— 加了 “记忆单元”，能记住更多长距离信息，但效率还是低，处理超长文本仍吃力。</p>
<p>这些架构是 AI 的 “老基建”，现在主流大模型已不用，但了解它们能更好理解 Transformer 的创新。</p>
<h3 data-id="heading-12">2. 现代大模型基石：什么是 Transformer 架构？</h3>
<p>Transformer 架构是一种以 “并行计算 + 自注意力机制” 为核心的神经网络结构，能高效捕捉数据（如文字）间的关联关系，是现代大模型（如 ChatGPT、DeepSeek）的基础骨架。2017 年由 Google 提出，是大模型 “高效运行” 的关键—— 决定了模型能跑多快、处理多长文本、效果多好，彻底解决了传统架构的痛点：</p>
<p>•核心创新：“并行计算 + 注意力机制”—— 不用逐字处理，能同时分析多个关键词，还能记住词与词的关系，又快又准；</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b24f4b72e34841bf830659b83f57847f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769153111&amp;x-signature=jNXWMIKEgskzQQybMbt%2B1bklkQA%3D" alt="" loading="lazy"/></p>
<p>﻿﻿</p>
<p>•核心结构：分 “编码器（Encoder）” 和 “解码器（Decoder）”—— 编码器负责 “理解信息”（比如读文章），解码器负责 “生成信息”（比如写文章）；</p>
<p>﻿</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4bd91b6a0e004a59988db4a2ffb4b698~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769153111&amp;x-signature=e7WulIpGuhX1PMah%2FfZtR%2BAtLxU%3D" alt="" loading="lazy"/></p>
<p>﻿﻿</p>
<p>简单说，Transformer 架构就是让 AI 能同时看懂文字间的关联、还能快速处理长文本的 “高效大脑骨架”～。</p>
<h3 data-id="heading-13">3. 什么是位置编码？</h3>
<p>Transformer 架构本身 “不认识文字顺序”—— 如果不加位置编码，机器会把 “我打你” 和 “你打我” 当成一回事。位置编码的核心作用是 “标记文字的先后顺序”，让机器理解语序逻辑。</p>
<p>•通俗解释</p>
<p>◦比如处理句子 “小明吃苹果”：位置编码给 “小明” 贴 “1 号”、“吃” 贴 “2 号”、“苹果” 贴 “3 号”；</p>
<p>◦机器看到标签后，就知道 “1 号（小明）做 2 号（吃）动作，对象是 3 号（苹果）”，不会搞反逻辑；</p>
<p>◦注意：位置编码不是简单的 1、2、3，而是用特殊数字编码，让机器同时理解 “相邻词关系更近”（如 “吃” 和 “小明”“苹果” 的关系比 “小明” 和 “苹果” 更近）。</p>
<p>•核心作用</p>
<p>◦位置编码解决了 “语序混乱” 的问题，让机器能正确理解 “主谓宾”“先后顺序” 等语言逻辑，是处理文本任务的关键小技巧。</p>
<h3 data-id="heading-14">4. 语义理解引擎：什么是注意力模型、自注意力机制、多头注意力？</h3>
<p>这仨是 Transformer 的 “核心能力”，本质是让机器 “抓重点、理关系”：</p>

























<table><thead><tr><th>概念名称</th><th>通俗类比</th><th>核心作用 （输入句子 “北京的故宫和上海的东方明珠，哪个更适合拍照？）</th></tr></thead><tbody><tr><td>注意力模型</td><td>读书时 “划重点”</td><td>从海量信息中筛选出关键内容（如 “北京”“故宫”“拍照”）</td></tr><tr><td>自注意力机制</td><td>划重点后 “分析关系”</td><td>不仅找重点，还能理清重点间的关联（如 “北京有故宫，故宫适合拍照”）</td></tr><tr><td>多头注意力</td><td>用 “多副眼镜看重点”</td><td>从多个角度抓重点（一副看 “谁做什么”，一副看 “在哪里做”，一副看 “怎么做”）</td></tr></tbody></table>
<h3 data-id="heading-15">5. 注意力优化升级：什么是 MLA、NSA 和代理注意力？</h3>
<p>普通注意力机制处理长文本（比如 10 万字报告）时，会 “内存不够、跑不动”，这三个是 “优化版”，核心是 “省资源、提效率”：</p>





























<table><thead><tr><th>技术名称</th><th>通俗类比</th><th>核心逻辑</th><th>应用场景</th></tr></thead><tbody><tr><td>多头潜在注意力（MLA）</td><td>把厚书做成 “思维导图”</td><td>压缩关键信息，减少内存占用（如把 10 万字报告的重点压缩成 1000 字）</td><td>如DeepSeek 可处理 12 万字长文本</td></tr><tr><td>原生稀疏注意力（NSA）</td><td>读书只看 “核心段落”</td><td>跳过无用信息，只分析关键内容的关系（如忽略 “的、了、吗” 等虚词）</td><td>如超长篇小说分析、论文摘要</td></tr><tr><td>代理注意力</td><td>先看 “目录” 再看正文</td><td>用 “摘要 / 目录” 替代原文找重点，再对应到原文（如先看书籍目录，再针对性看章节）</td><td>如百万字级文档处理、知识库问答</td></tr></tbody></table>
<p>三者的核心思路都是 “抓大放小”，在不影响理解效果的前提下，通过压缩信息、减少计算量，实现长文本的高效处理。</p>
<h3 data-id="heading-16">6. 生成逻辑差异：什么是自回归生成与非自回归生成？</h3>
<p>大模型生成文字的两种核心方式：</p>
<p>•<strong>自回归生成</strong>：“逐字写”—— 像人写字一样，写完一个字再写下一个，能保证逻辑连贯，ChatGPT、DeepSeek 都用这种；</p>
<p>•<strong>非自回归生成</strong>：“同时写多个字”—— 效率高，但容易逻辑混乱，适合对速度要求高、对连贯性要求低的场景（比如简单翻译）。</p>
<hr/>
<p>﻿</p>
<h2 data-id="heading-17">三、模型优化与适配技术（让 AI 更实用、更易部署）</h2>
<h3 data-id="heading-18">1. 什么是 MOE 混合专家架构？</h3>
<p>MOE（Mixture of Experts）即混合专家架构，核心是让 “专业的人干专业的事”—— 模型里有多个 “专家模块”，每个模块只擅长一个领域，处理任务时只激活相关专家，既省算力又高效。<strong>主要结构拆解如下：</strong></p>
<p>﻿</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/19a8576af52049dbaf4617e70b97898d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769153111&amp;x-signature=NtUV4z2F9%2FVkI8lR7yJf1eKWcm4%3D" alt="" loading="lazy"/></p>
<p>﻿﻿</p>
<p>1.<strong>专家模块</strong>：不同科室的医生，每个专家只擅长一个领域（如 “代码专家” 专做编程，“数学专家” 专解难题，“中文专家” 专处理诗词和对话）；</p>
<p>2.<strong>门控网络</strong>：医院导诊台，输入任务后先 “判断任务类型”（如 “怎么写 Python 代码” 属于编程任务）；接收输入任务后，通过计算判断任务类型，筛选出最适合处理该任务的 1-2 个专家模块；</p>
<p>3.<strong>高效协作</strong>：只叫醒需要的专家，不会让无关专家参与（如编程任务只激活 “代码专家”，不打扰 “数学专家”）。</p>
<p><strong>实际案例：DeepSeek-V3 的 MOE 架构</strong></p>
<p>•总参数量：6710 亿（相当于 256 个专家模块）；</p>
<p>•激活数量：处理任务时只激活 370 亿参数（8 个专家模块）；</p>
<p>•优势：算力浪费少，训练成本仅为传统模型的 1/3，处理任务速度更快。</p>
<h3 data-id="heading-19">2. 什么是数据并行、模型并行、张量并行？</h3>
<p>大模型参数量太大（比如万亿级），单台电脑装不下、训不动，这三种是 “分工训练” 的方式：</p>
<p>•<strong>数据并行</strong>：多台电脑 “一起练不同批次的数据”—— 比如甲练第 1-100 条，乙练第 101-200 条，最后汇总经验；</p>
<p>•<strong>模型并行</strong>：多台电脑 “各负责模型的一部分”—— 比如甲负责输入层，乙负责隐藏层，分工协作；</p>
<p>•<strong>张量并行</strong>：把模型的 “计算任务拆分”—— 比如一个复杂计算拆成 3 份，3 台电脑同时算，加快速度。</p>
<h3 data-id="heading-20">3. 什么是量化、知识蒸馏、剪枝？</h3>
<p>大模型原本 “笨重”（需超大内存），这三种是 “给模型瘦身” 的技术，让它能装在普通电脑、手机上：</p>
<p>•<strong>量化</strong>：把模型里的 “精准数字简化”—— 比如 “1.23456” 改成 “1.23”，像把 4K 照片转成清晰缩略图，体积变小但核心信息不变；</p>
<p>•<strong>知识蒸馏</strong>：让 “小模型学大模型的本事”—— 大模型像 “教授”，小模型像 “学生”，学生学教授的核心知识，体积变小 10 倍仍保精度；</p>
<p>•<strong>剪枝</strong>：给模型 “删无用部分”—— 去掉模型里没用的参数（比如很少用到的 “小计算单元”），让它更轻巧。</p>
<h3 data-id="heading-21">4. 什么是模型压缩？</h3>
<p>就是把量化、蒸馏、剪枝等技术 “打包使用”，综合给模型瘦身，比如把 10GB 的大模型压缩到 1GB，适配手机、智能手表等资源受限设备。</p>
<h3 data-id="heading-22">5. 什么是模型微调（Fine-tuning）？</h3>
<p>微调就是给 “有基础的 AI 学霸” 做 “岗前培训”—— 预训练模型已经会通用知识（会说话、懂常识），微调时用少量专项数据（比如公司客服对话），教它做具体事：</p>
<p>•流程：通用大模型→输入专项数据→训练几天→输出专项模型（比如客服 AI）；</p>
<p>•优势：省数据、省时间，不用从零训练；学完专项技能后，仍会聊天、算数学题等通用能力。</p>
<h3 data-id="heading-23">6. 什么是 LoRA、QLoRA？</h3>
<p>普通微调仍需要不少算力，这俩是 “轻量级微调” 技术：</p>
<p>•核心逻辑：不改变大模型的核心参数，只给它加 “小插件”（少量新参数），教插件专项技能；</p>
<p>•优势：用普通电脑就能做，成本低、速度快，适合中小企业和个人。</p>
<h3 data-id="heading-24">7. 什么是领域自适应（Domain Adaptation）？</h3>
<p>让大模型 “适配特定行业”—— 比如给通用大模型喂医疗数据，让它学会看病历、答医疗问题；喂金融数据，让它懂股票、基金，成为行业专用模型。</p>
<h3 data-id="heading-25">8. 什么是 RLHF（人类反馈强化学习）？</h3>
<p>让模型的输出 “符合人类偏好”—— 比如模型回答后，人给打分（好 / 不好），再用这些分数训练模型，让它越来越懂 “人喜欢什么样的回答”（比如更礼貌、更精准）。</p>
<h3 data-id="heading-26">9. 什么是 RAG、KAG？</h3>
<p>解决大模型 “知识过时、不懂专业领域” 的问题：</p>
<p>•<strong>RAG（检索增强生成）</strong> ：AI “开卷考试”—— 回答问题前，先从外部知识库（比如公司文档、最新新闻）查相关信息，再结合自己的知识生成答案，比如问 “2025 年最新政策”，它会先查 2025 年的资料；</p>
<p>•<strong>KAG（知识增强生成）</strong> ：AI “把知识点记牢再答题”—— 预训练时就把结构化知识（比如百科词条、行业术语）融入模型，不用临时查，适合回答固定常识（比如 “牛顿三大定律”）。</p>
<h3 data-id="heading-27">10. 什么是事实核查（Fact-checking）？</h3>
<p>减少大模型 “胡说八道”（幻觉）的技术 —— 模型生成答案后，自动核对事实（比如查资料确认 “北京到上海的距离”），纠正错误信息，让回答更靠谱。</p>
<h3 data-id="heading-28">11. 什么是对齐（Alignment）与安全护栏（Safety Guardrails）？</h3>
<p>•<strong>对齐</strong>：让模型的目标和人类一致 —— 比如不生成有害内容、不撒谎；</p>
<p>•<strong>安全护栏</strong>：给模型 “设禁区”—— 禁止生成暴力、歧视等有害内容，确保使用安全。</p>
<hr/>
<p>﻿</p>
<h2 data-id="heading-29">四、典型模型与生态实践（从理论到应用）</h2>
<h3 data-id="heading-30">1. 主流大模型分类与代表</h3>
<p>•<strong>通用大模型</strong>：能应对多种任务，比如 GPT 系列（OpenAI）、文心一言（百度）、Llama 系列（Meta）、通义千问（阿里）、Qwen（阿里云）；</p>
<p>•<strong>垂直领域大模型</strong>：专注某一行业，比如医疗大模型（看病历、辅助诊断）、法律大模型（查法条、写合同）、编程大模型（DeepSeek-Coder、GitHub Copilot）。</p>
<h3 data-id="heading-31">2. 典型创新案例：DeepSeek 的核心创新点</h3>
<p>DeepSeek 的核心创新围绕 “高效、低成本、高适配” 展开，通过架构优化、训练方法创新等，实现了 “用更少资源做出高性能模型” 的目标，让大模型更易普及。</p>
<p><strong>核心创新点：</strong></p>
<p>◦<strong>高效架构设计：MOE+MLA</strong>结合混合专家架构（MOE）和多头潜在注意力（MLA），6710 亿总参数量仅激活 370 亿参数处理任务，同时通过 MLA 压缩长文本信息，支持 12 万字长文本处理，算力成本降低 70% 以上。</p>
<p>◦<strong>低成本训练技术：强化学习 + 知识蒸馏</strong>采用 GRPO 强化学习算法，无需大量人工标注数据，通过 “试错反馈” 优化模型推理能力；结合动态知识蒸馏技术，将大模型能力迁移至小模型，体积减少 40% 仍保持精度，训练成本仅为 GPT-4 的 1/18。</p>
<p>◦<strong>高适配性部署：多场景 + 轻量化</strong>推出通用模型、编程模型（DeepSeek-Coder）、推理模型（DeepSeek-R1）等系列产品，适配不同场景；支持本地、云端、边缘设备部署，普通 GPU 即可运行，企业可快速集成到金融、教育、医疗等行业。</p>
<p>◦<strong>强推理能力：分步思考机制</strong>基于强化学习实现 “分步推理”，模型处理数学、编程等复杂任务时，会像人类一样拆解步骤、逐步求解，准确率比肩 OpenAI o1 系列。</p>
<h3 data-id="heading-32">3. 部署形态：云端、边缘、本地部署</h3>
<p>•<strong>云端部署</strong>：模型存在远程服务器上，通过网络使用（比如 ChatGPT 网页版），不用自己装；</p>
<p>•<strong>本地部署</strong>：把模型装在自己的电脑、服务器上，离线也能用，适合注重数据隐私的场景；</p>
<p>•<strong>边缘部署</strong>：把模型装在边缘设备上（比如手机、智能摄像头），响应快、不占网络带宽。</p>
<hr/>
<p>﻿</p>
<h2 data-id="heading-33">五、常用工具与交互技术（高效用 AI）</h2>
<h3 data-id="heading-34">1. 什么是提示工程（Prompt Engineering）？</h3>
<p>就是 “教 AI 怎么说话”—— 通过优化输入指令（提示词），让 AI 输出符合预期的结果：</p>
<p>•比如只说 “写旅游攻略”，效果一般；但说 “写一篇适合亲子家庭的北京 3 日游攻略，含景点、餐饮、交通，语言简洁”，结果更精准；</p>
<p>•核心：指令清晰、逻辑明确，帮 AI 懂你的需求。</p>
<h3 data-id="heading-35">2. 关于提示学习中的思维链、自恰性和思维树？</h3>
<p>•<strong>一句话总结：</strong></p>
<p>思维链：让 AI “会写步骤”；</p>
<p>自洽性：让 AI “会查答案”；</p>
<p>思维树：让 AI“会拆难题、选思路”；都是为了让 AI 的回答更靠谱，只是简单问题用思维链，易出错问题加自洽性，复杂问题用思维树～</p>
<p>•三者<strong>对比</strong></p>





























<table><thead><tr><th>概念</th><th>通俗类比</th><th>核心动作</th><th>适合场景</th></tr></thead><tbody><tr><td>思维链（CoT）</td><td>写解题步骤</td><td>单一线性推理（一步一步）</td><td>简单、有明确步骤的问题</td></tr><tr><td>自洽性</td><td>反复检查作业</td><td>多轮独立验证（换思路重算）</td><td>易出错、结果不确定的问题</td></tr><tr><td>思维树（ToT）</td><td>拆难题 + 多条思路探索</td><td>多分支推理（拆分 + 选优）</td><td>复杂、多选项、需权衡的问题</td></tr></tbody></table>
<p>•<strong>举例：</strong></p>
<p>1.用思维树（ToT）拆问题：把大题拆成 3 个小题，每个小题想 2 种解法；</p>
<p>2.用思维链（CoT）写步骤：每个解法都写详细推导；</p>
<p>3.用自洽性验证：每个小题的 2 种解法结果一致，再汇总大题答案。</p>
<h3 data-id="heading-36">3. 什么是少样本 / 零样本提示？</h3>
<p>提示工程的 “进阶技巧”：</p>
<p>•<strong>少样本提示：给 AI “几个例子”—— 比如让它翻译方言，先给 2 个 “方言→普通话” 的例子，它就会模仿；</strong></p>
<p>•<strong>零样本提示：不给例子，直接让 AI 做任务 —— 比如让它写一首诗，全靠它自己的知识。</strong></p>
<hr/>
<p>﻿</p>
<h2 data-id="heading-37">六、高频术语（读懂 AI 文档的关键词）</h2>
<p>1.<strong>Token</strong>：AI 处理文字的 “最小单位”—— 中文是单个字或词语（比如 “我 / 爱 / AI”），英文是单词或词根，模型能处理的 Token 数量决定了文本长度（比如 4096 个 Token 约 3000 中文字）；</p>
<p>2.<strong>标签（Label）</strong> ：数据的 “标准答案”，比如 “这张是猫”；</p>
<p>3.<strong>批次（Batch）</strong> ：训练时一次喂给模型的数据量（比如一次喂 32 条文本）；</p>
<p>4.<strong>训练步长（Step）</strong> ：模型处理一批数据 + 调整一次参数，算 1 个 Step（衡量训练进度）；</p>
<p>5.<strong>轮次（Epoch）</strong> ：把所有训练数据完整学一遍，算 1 个 Epoch（比如 10 万条数据，每批 32 条，约 3125 个 Step=1 个 Epoch）。</p>
<p>6.<strong>上下文（Context）</strong> ：AI 的 “聊天记忆”—— 记住之前的对话内容，比如你先问 “北京天气”，再问 “穿什么”，AI 知道你指北京；</p>
<p>7.<strong>上下文窗口（Context Window）</strong> ：AI 能记住的 “对话长度上限”—— 比如 4096 个 Token 窗口，超过就会忘前面的内容；</p>
<p>8.<strong>多轮对话（Multi-turn Conversation）</strong> ：和 AI 聊好几轮（比如问问题→追更→再问），AI 能连贯回应；</p>
<p>9.<strong>Agent（AI 智能体）</strong> ：“有自主能力的 AI 助手”—— 不用你一步步指挥，能自己理解任务、用工具、解决问题（比如让它规划旅游，自己查景点、订酒店）；</p>
<p>10.<strong>A2A（Agent-to-Agent）</strong> ：A2A是谷歌公开的一个协议，它能够实现不同的Agent之间能够实现直接互通，让智能体之间能够协作起来解决多任务的问题；A2A是让多个Agent能够连接起来，形成一个能力更加强大的Agent，解决多个Agent的通信效率问题。简单说就是多个 AI 智能体 “协作干活”—— 比如一个查资料、一个写文案、一个校对，合力完成复杂任务。</p>
<p>11.<strong>幻觉（Hallucination）</strong> ：AI “胡说八道”—— 编造不存在的事实（比如假新闻、假数据）。</p>
<p>12.<strong>MCP（模型上下文协议）</strong> ：MCP（Model Context Protocol）即 “模型上下文协议”，简单说就是AI 聊天的 “记忆管理规则”—— 规定能记多少轮对话、优先保留什么信息，确保连贯又省内存。MCP让所有的API、工具、数据源能够按照统一的协议通信，只要按此规范，这些工具都可以被开发者直接调用；MCP解决了搭建单个Agent的效率问题，让搭建单个Agent的效率变得更高。</p>
<p>13.<strong>AGI（通用人工智能）</strong> ：AI 的 “终极目标”—— 具备人类级智慧，能做任何人类能做的事（做饭、编程、科研），目前还在理论阶段；</p>
<p>14.<strong>ASI（超级人工智能）</strong> ：比人类智慧还强的 AI，目前仅存在于设想中。</p>
<hr/>
<p>﻿</p>
<h2 data-id="heading-38">结语</h2>
<p>AI 技术的核心逻辑可概括为 “从数据找规律到落地实用” 的递进过程，本质简洁且层层聚焦：</p>
<p>核心是让机器从数据中学习规律 —— 机器学习是基础 “找规律”，深度学习是 “多层递进找规律”，大模型则是 “海量数据 + 多层架构” 的高效找规律。具体通过四层实现：</p>
<p>1.基础层：机器学习让机器 “从数据中找规律”，神经网络是实现这一目标的 “骨架”；</p>
<p>2.进阶层：Transformer 架构 + 注意力机制让机器 “高效找规律、记重点”，解决长文本、高难度任务；</p>
<p>3.优化层：量化、蒸馏、微调、MOE 等技术让机器 “变小、变快、变便宜”，适配更多场景；</p>
<p>4.应用层：大模型（如 ChatGPT、DeepSeek）是最终成果，直接服务于日常聊天、办公、编程等需求。</p>
<p>这篇文章覆盖 AI 全链路知识，从基础概念到架构、优化技术、落地应用及术语，希望能在此找到自己需要的内容。而学习 AI 的关键，正如 Transformer 架构的逻辑 —— 先掌握整体全貌与基本原理，再层层深入剖析细节.....</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[仅两台缓存节点，如何支撑 1.45TB/s 大吞吐业务]]></title>    <link>https://juejin.cn/post/7595610998032826395</link>    <guid>https://juejin.cn/post/7595610998032826395</guid>    <pubDate>2026-01-16T05:35:04.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7595610998032826395" data-draft-id="7595513077220343854" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="仅两台缓存节点，如何支撑 1.45TB/s 大吞吐业务"/> <meta itemprop="keywords" content="后端,人工智能"/> <meta itemprop="datePublished" content="2026-01-16T05:35:04.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="JuiceFS"/> <meta itemprop="url" content="https://juejin.cn/user/2665636828032446"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            仅两台缓存节点，如何支撑 1.45TB/s 大吞吐业务
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2665636828032446/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    JuiceFS
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-16T05:35:04.000Z" title="Fri Jan 16 2026 05:35:04 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-16
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读10分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>随着面向大规模并发读取与数据分发的业务需求增加，如影视渲染等场景，传统存储方案（如 NAS）在并发客户端数量增加时，往往需要投入更多缓存资源；为了提升响应时效，通常还需提前进行数据预热，不仅带来额外的时间开销，也进一步加重了资源负担。</p>
<p>JuiceFS 作为一种基于对象存储的分布式文件系统，通过其高性能架构，利用分布式缓存聚合吞吐量并降低延迟，能够在大规模客户端并发读取时提供高效支持。本文分享的是我们近期在实际测试中的一个案例，展示如何利用 4,000 台业务节点成功聚合了 1.45TB/s 的带宽，并在此过程中通过引入二级缓存池，保障了系统的稳定性。</p>
<p>通过这篇文章，我们希望为高并发、大吞吐需求场景中的存储瓶颈提供一个切实可行的解决方案，并借此抛砖引玉，欢迎大家共同探索存储优化的思路与方法。</p>
<h2 data-id="heading-0">01 传统 NAS：节点越多，存储越慢</h2>
<p>该客户为影视渲染农场用户，日常作业中会同时启动数千台 Windows 节点进行渲染。</p>
<ul>
<li><strong>业务特点</strong>：每台节点在渲染时需同时读取一批文件（大部分为重复素材）到本地。</li>
<li><strong>原有痛点</strong>：原公有云 NAS 存储（SMB 挂载）在节点数增多时，不得不不断增加后端 SMB 服务节点来应对激增的流量和 IOPS，导致管理复杂度和成本直线上升。当并发节点超过 1,000 台时，存储系统往往不堪重负。</li>
<li><strong>核心需求</strong>：迫切需要一种在存储底座之外，能够分担业务吞吐压力的能力。</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/73608659d8f44ab9911c4f99ed4dc76a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSnVpY2VGUw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769146503&amp;x-signature=IGNCMgX%2Fo4wlqJk9z28pw2Fu%2ByA%3D" alt="" loading="lazy"/></p>
<p>在 SMB 服务模式下，每个客户端都需要从 SMB 存储读取全量数据。导致服务端流量长期高位，管理员需要持续监控 SMB 服务的健康状况，一旦接近最大负荷，就需要及时进行扩容，提供与集群规模匹配的存储能力，运维压力显著增加。</p>
<h2 data-id="heading-1">02 闲置资源利用：用大量业务节点做分布式缓存</h2>
<p>JuiceFS 在社区版 1.3 及企业版 5.2 之后发布了全新的 <a href="https://link.juejin.cn?target=https%3A%2F%2Fjuicefs.com%2Fdocs%2Fzh%2Fcloud%2Fgetting_started%23windows-installation" target="_blank" title="https://juicefs.com/docs/zh/cloud/getting_started#windows-installation" ref="nofollow noopener noreferrer">Windows 客户端</a>，支持通过 <code>.exe</code> 进程将文件系统挂载为本地盘，使用方式与 Linux 类似。</p>
<p>但在海量客户端场景下，如果仅将业务切换为标准的「JuiceFS 挂载点 —— 分布式缓存 —— 对象存储」链路，流量会集中打到独立缓存层，可能成为新的性能瓶颈。与其不断扩容专用的缓存节点，不如转换思路：<strong>利用海量业务节点自身的闲置带宽和磁盘，将它们池化为一个巨大的分布式缓存池。</strong></p>
<ul>
<li><strong>JuiceFS 分布式缓存模式（P2P 模式）</strong>：同一份文件只需在集群内读取一次，后续其他节点直接从 P2P 缓存池的邻近节点获取。</li>
<li><strong>对象存储侧</strong>：回源流量极低，文件首次冷读后，后续流量几乎全由缓存池承担。</li>
<li><strong>资源要求</strong>：无需专用缓存硬件，仅需每个业务节点贡献部分磁盘和带宽。</li>
</ul>
<p>在这个方案中，<strong>我们没有配置任何一台独立缓存节点。所有的业务节点既是消费者，也是提供者</strong>（P2P 模式）。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c3e05c72b0d6407b8f0c3aa0ba458e6a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSnVpY2VGUw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769146503&amp;x-signature=9oa9KiCrbiUMk08uRLTZ%2BvqoddA%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-2">03 实测案例：4,000 台业务节点聚合到 1.45TB/s 的巨大吞吐</h2>
<p><strong>测试任务</strong>：每台 Windows 机器在无预热（冷读）的情况下，读取 16 个 2GB 的大文件。 统计所有节点读完的总耗时，并观察各节点的耗时方差，以及是否存在长尾效应。</p>
<p><strong>配置策略</strong>：将 4,000 个节点拆分为多个子组（每组 500 个节点）。16 个 2GB 的数据块会散列分布在组内节点中，避免所有节点同时回源对象存储，造成拥塞。</p>
<p>那么现在 JuiceFS 客户端的冷读流程就变为：</p>
<ol>
<li>Windows 客户端读取 16 个 2GB 的文件，通过一致性哈希拓扑定位这些数据块在 500 个缓存组内的负责节点，向其发起请求。</li>
<li>缓存节点收到了数据块请求后，发现本地未命中缓存（冷读），则回源对象存储拉取数据块，拉取完成后将数据返回给客户端，并且写入本地缓存，供后续请求复用。</li>
<li>当客户端从所有缓存服务节点获取完整数据块后，测试结束，统计所有客户端读完的耗时分布（最大值、最小值），用于评估方差与长尾情况。</li>
</ol>
<p>下面是不同客户端节点数量读取这批 16*2GB 大文件的时间结果：</p>



































<table><thead><tr><th align="center">客户端台数</th><th align="left">聚合吞吐最高</th><th align="left">总耗时（范围/平均）</th></tr></thead><tbody><tr><td align="center">2,000 台</td><td align="left"><strong>729GB/s</strong></td><td align="left">92s~136s 平均 107s</td></tr><tr><td align="center">2,500 台</td><td align="left"><strong>921GB/s</strong></td><td align="left">87s~109s 平均 98s</td></tr><tr><td align="center">3,000 台</td><td align="left"><strong>1.11TB/s</strong></td><td align="left">93s~121s 平均 106s</td></tr><tr><td align="center">3,500 台</td><td align="left"><strong>1.34TB/s</strong></td><td align="left">89~112s 平均 100s</td></tr><tr><td align="center">4,000 台</td><td align="left"><strong>1.45TB/s</strong></td><td align="left">92s~115s 平均 101s</td></tr></tbody></table>
<p>不同数量客户端，JuiceFS 聚合吞吐表现</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5569fb6c97df4846aef07c566dc1a80c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSnVpY2VGUw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769146503&amp;x-signature=ndOp28trk%2FxpSc7GusT%2F2lFyRAY%3D" alt="" loading="lazy"/></p>
<p>整体结果各方面都符合预期：</p>
<ul>
<li><strong>稳定性</strong>：无论是 2,000 台还是 4,000 台，读完数据的总耗时都稳定在 100 秒左右。</li>
<li><strong>扩展性</strong>：<strong>4,000 台节点成功聚合出 1.45TB/s 的超大带宽，理论上，在元数据能够承载的前提下，该架构可实现持续的水平扩展，能够支持达到万台级别的缓存节点规模。</strong></li>
</ul>
<p>业务节点的挂载参数参考：</p>
<pre><code class="hljs language-bash" lang="bash">juicefs.exe mount juice-fs X: --cache-group=primary --buffer-size=4096 --enable-kernel-cache --as-root --subgroups=8
</code></pre>
<p>由此，我们未使用一台独立的缓存服务节点，仅靠用户的业务节点就聚合了 1.45TB/s 的读取能力。过客通户端节点组成的分布式缓存层，我们以零成本将绝大多数流量从对象存储中分流，减轻了底层存储的负担。</p>
<p>实际业务中，未必能达到如此高的吞吐能力，因为缓存效益通常与数据重复度相关。在实际场景中，每个节点读取的文件并不完全相同。尽管如此，这一方案仍然是有效的存储扩展方法，即使只有部分提升，也能带来非常可观的收益，且几乎不需要额外的成本投入。</p>
<h2 data-id="heading-3">04 稳定性增强：两级分布式缓存</h2>
<p>缓存效果虽然炸裂，但客户对系统的稳定性提出了担忧。例如，在某些场景下，业务节点在完成任务后会立即销毁，而这些业务节点同时也是缓存节点。当大量业务节点突然下线时，原本存储在这些节点上的缓存也随之丢失，导致大量流量回源至对象存储，进而使对象存储成为瓶颈，影响整体稳定性。为了解决因业务节点波动引发的缓存性能问题，我们提出了两级分布式缓存方案，架构图如下：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/dd3953e1d679410cb5bbe11fea476677~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSnVpY2VGUw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769146503&amp;x-signature=mCuro4zhvMMiZV47agYkk%2FIfgnU%3D" alt="" loading="lazy"/></p>
<p>第二层缓存池（L2）位于第一层（L1）缓存池和对象存储之间。当 L1 未命中时，数据首先会从 L2 获取；如果 L2 缓存也未命中，则回源到对象存储。这样可以有效抵消 L1 缓存节点波动带来的影响。加入 L2 缓存池后，读取流程发生了以下变化：</p>
<ul>
<li>在 Windows 客户端读取 16 个 2GB 的文件，通过一致性哈希拓扑确定数据块所在 L1 缓存组中的特定节点；并同时向 L2 缓存组请求数据。</li>
<li>由于是冷读，L2 缓存组中没有数据，L2 缓存节点会向对象存储发起请求并填充 L2 缓存池。</li>
<li>数据块从 L2 缓存池返回至 L1 缓存池并进行填充，然后由 L1 缓存池内的节点自行进行点对点（P2P）分发。</li>
<li><strong>此时，大部分流量集中在 L1 缓存池，L2 只处理极少数回源对象存储的流量，因此即使 L2 只有少数几个节点，也不会成为性能瓶颈。L2 缓存池的作用是就近替代对象存储，降低延迟。</strong></li>
</ul>
<p>即使大量 L1 业务节点下线，缓存拓扑发生变化并需要重新下载数据块，数据仍可从 L2 缓存池就近获取。只要合理控制下线比例，业务几乎不受影响。</p>
<p>L2 缓存组挂载参数：</p>
<pre><code class="hljs language-bash" lang="bash">juicefs mount juice-fs /jfs-cache --cache-group=secondary --cache-size=-1 --cache-dir=/data* --free-space-ratio=0.01 --buffer-size=10240 --max-downloads=400
</code></pre>
<p>L1（业务节点）挂载参数：</p>
<pre><code class="hljs language-bash" lang="bash">juicefs.exe mount juice-fs X: --cache-group=primary --second-group=secondary --buffer-size=4096 --enable-kernel-cache --as-root --subgroups=8
</code></pre>
<p><strong>此外，两级分布式缓存还非常适用于需要重复利用已有缓存池的场景</strong>。例如，我们有一批位于北京的缓存池业务，总容量为 2PiB，缓存池名为 cache-group-bj。突然，上海的业务也需要使用相同的数据，而这些数据与北京的数据几乎完全相同。如果不希望重新从北京的对象存储中预热这 2PiB 的数据，我们可以在上海的缓存组中配置 <code>--second-group=cache-group-bj</code>。这样，当上海的业务请求数据时，将优先通过专线从北京的缓存池读取数据，速度非常快且延迟稳定（在 2ms 以内），免去了重复预热数据的复杂过程，能够直接启动业务，极大地方便了操作。</p>
<h2 data-id="heading-4">05 小结</h2>
<p>通过本次 4,000 节点的极限压测，我们成功将计算集群的大规模闲置资源转化为高达 1.45TB/s 的存储池；而二级缓存的引入，有效解决了“最后一公里”的稳定性顾虑。通过使用 JuiceFS 这套存储软件架构，可充分挖掘客户端集群的潜能，在不增加额外硬件成本的情况下，实现了性能的显著提升。</p>
<p>本方案适用场景：</p>
<ul>
<li><strong>高并发重复读取场景</strong>：如模型训推数据调用、容器镜像分发、影视渲染等，节点越多，P2P 缓存收益越大；</li>
<li><strong>弹性计算场景</strong>：业务节点经常大规模扩缩容（如 Spot Instances），利用二级缓存架构可确保数据访问的连续性与稳定性；</li>
<li><strong>混合云/多云架构</strong>：利用二级缓存机制可以复用异地缓存池资源，最大程度减少重复预热带来的对象存储调用和传输成本。</li>
</ul>
<p>我们希望本文中的一些实践经验，能为正在面临类似问题的开发者提供参考，如果有其他疑问欢迎加入 <a href="https://link.juejin.cn?target=https%3A%2F%2Fjuicefs.com%2F" target="_blank" title="https://juicefs.com/" ref="nofollow noopener noreferrer">JuiceFS 社区</a>与大家共同交流。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Qunar酒店搜索排序模型的演进]]></title>    <link>https://juejin.cn/post/7595626157908869129</link>    <guid>https://juejin.cn/post/7595626157908869129</guid>    <pubDate>2026-01-16T06:36:01.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7595626157908869129" data-draft-id="7594813727053070370" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Qunar酒店搜索排序模型的演进"/> <meta itemprop="keywords" content="前端,架构,操作系统"/> <meta itemprop="datePublished" content="2026-01-16T06:36:01.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="去哪儿技术沙龙"/> <meta itemprop="url" content="https://juejin.cn/user/2251436075786791"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Qunar酒店搜索排序模型的演进
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2251436075786791/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    去哪儿技术沙龙
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-16T06:36:01.000Z" title="Fri Jan 16 2026 06:36:01 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-16
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读27分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h3 data-id="heading-0">一、背景</h3>
<p>在用户在线浏览酒店时，旅行平台需要解决一个重要问题：如何更好地为用户挑选适合的酒店，并降低用户选择的费力度。而为用户挑选符合需求的酒店，需要千人千面的模型排序。在去哪儿（Qunar）APP中，触发个性化排序的场景主要是欢迎度排序（见图1）。</p>
<p align="center"><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/030c148d0fef4833bc48244848ee773e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y675ZOq5YS_5oqA5pyv5rKZ6b6Z:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769150161&amp;x-signature=iuKj3qAYd6gOHRCAiyK4AEipxwE%3D" alt="" loading="lazy"/></p>
<p align="center">图1 Qunar酒店搜索产品形态</p>
<h3 data-id="heading-1">二、Qunar酒店搜索排序架构</h3>
<p>Qunar酒店搜索推荐系统的总体流程可以分成四块，主要是召回、粗排、精排、重排。其中精排主要会根据用户的搜索关键词和其他相关信息，选出与用户需求最相符合的酒店，确保在搜索结果中，用户能够看到那些与其需求最相关的酒店。而Qunar酒店长期优化的业务目标是s2o，即下单用户数/搜索用户数。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e976df357f39491d86bf0eb55927c8c2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y675ZOq5YS_5oqA5pyv5rKZ6b6Z:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769150161&amp;x-signature=J4FS6mJjGyxn6kSjDix5UKzojpY%3D" alt="" loading="lazy"/></p>
<p align="center">图2 Qunar搜索架构</p>
<h3 data-id="heading-2">三、Qunar酒店搜索精排排序的发展历程</h3>
<p>第一阶段升级机器学习模型，酒店搜索业务准备使用机器学习模型替换人工规则排序。为了能快速上线验证模型效果，并考虑到酒店业务天生自带大量连续特征，如酒店价格、酒店距离等，我们选择了对连续特征比较友好的树模型LambdaMart模型。</p>
<p>第二阶段升级深度模型，LambdaMart排序模型常用的迭代优化手段，如添加特征、样本调整等几乎已经无法带来增量收益，因此我们准备升级成比树模型天花板更高的深度模型架构LambdaDNN。</p>
<p>第三阶段升级多目标模型，LambdaDNN排序模型主要还是聚焦单目标建模（CTCVR），而多目标建模更好的考虑了排序全空间的曝光样本，综合考虑了下单前的用户点击行为，降低样本偏差问题，我们借鉴了Google的MMOE模型，同时学习CTR目标任务和CTCVR目标任务。</p>
<p>第四阶段升级多场景多目标模型，酒店业务搜索场景分为同城空搜、异地空搜等，每个场景单独一个模型，使得维护成本很高，并且用户出行时，会在多个场景（同城搜索、异地搜索）下搜索找到符合自己期望的酒店。若将多个场景分别单独训练模型，会使得用户连贯的搜索行为割裂，学习不到用户在不同场景下的差异和共性。因此，我们提出将信息表征拆分，融合多场景样本的多场景多目标模型。</p>
<p>下面具体阐述我们在Qunar酒店搜索排序模型的演进。</p>
<h3 data-id="heading-3">四、Qunar酒店搜索精排排序算法的迭代</h3>
<p>排序学习（Learning to Rank）是一个监督学习过程，给定一个query，搜索引擎会召回一系列相关的item，然后对这些召回的item进行排序，最后将Top N的item输出。而排序问题就是使用一个模型 f(q,d)来对该query下的item进行排序，分为PointWise，PairWise，ListWise三种排序学习方式。</p>
<p>PointWise：输入空间中样本是单个 item（和对应 query）构成的特征向量，输出空间中样本是单个 item（和对应 query）的相关度，是将所有用户的样本空间的样本同等对待。</p>
<p>PairWise：输入空间中样本是（同一 query 对应的）两个item构成的两个特征向量，输出空间中样本对的偏序关系，此方法学习了同一个query下的两个样本对比偏好。</p>
<p>ListWise：输入空间中样本是（同一 query 对应的）所有item构成的多个特征向量列表，输出空间是同一个query下的最优排序列表，是pairwise和lambda梯度的结合，如LambdaMart算法，对整个列表建模，学习一个最优排序列表。</p>















<table><thead><tr><th>pointWise</th><th>pairWise</th><th>listWise</th></tr></thead><tbody><tr><td><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1e465e1ee37546e2a082c2453b5efb31~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y675ZOq5YS_5oqA5pyv5rKZ6b6Z:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769150161&amp;x-signature=XEThDzGzChSk93nvwrmVC%2FLat5s%3D" alt="" loading="lazy"/></td><td><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/be0b25796d3448eab81e26e6200ea2fc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y675ZOq5YS_5oqA5pyv5rKZ6b6Z:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769150161&amp;x-signature=eZ1nu4KZzD%2BmEFeOZyTnp85IUYQ%3D" alt="" loading="lazy"/></td><td><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/86f7b1da238e4f408166fea126d137ec~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y675ZOq5YS_5oqA5pyv5rKZ6b6Z:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769150161&amp;x-signature=vULzqmFWqcAISTjuc%2B9dE8b6A5M%3D" alt="" loading="lazy"/></td></tr></tbody></table>
<p>模型的预测目标与业务指标之间存在一定的差距，Pointwise注重单个物品的点击率，对所有请求下的物品同等对待，与搜索业务指标存在较大的Gap，而搜索业务更关注在页面头部的搜索结果的优劣。</p>
<p>因此，初期阶段我们选择了更适合搜索排序的Listwise方式学习模型，即LambdaMart树模型作为base模型，同时树模型不需要做大量的特征处理，可以快速上线验证效果、拿到收益。</p>
<h4 data-id="heading-4">1. 由LambdaMart模型升级到LambdaDNN模型</h4>
<p>将排序模型从LambdaMart升级到LambdaDNN模型主要考虑到以下几点：</p>
<ul>
<li>旅游具有强烈的节假日周期属性，需要长时间窗的大规模数据学习。而树模型容量有限，随着数据规模的增加，很难很好的表达数据内部隐藏的知识。LambdaDNN能够实现更复杂的模型，且具备强大的表征能力，有更高的天花板。</li>
<li>基于深度学习的模型，具有更好的泛化能力，和处理高维稀疏数据的能力，此外应用深度学习模型后可以更好的应用新的研究成果，比如后面介绍的多目标排序。</li>
</ul>
<p>树模型和深度模型的主要区别见表1。</p>
<p align="center"><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f18a285af81a420e9e4fdad5d7eb6108~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y675ZOq5YS_5oqA5pyv5rKZ6b6Z:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769150161&amp;x-signature=dF%2BxcPEzjX0Llhta%2BvXvoaI8l9c%3D" alt="a44cfa7ec9874f8d0a95ed9b79884305.png" loading="lazy"/></p>
<h4 data-id="heading-5">2. LambdaDNN模型实践</h4>
<p>为了验证深度模型的有效性，我们控制了loss的学习方式，统一为listwise方式，唯一变量只是模型的结构。而LambdaDNN模型是将神经网络DNN与LamdaRank [2] 定义的NDCG排序指标梯度相结合，演进出了LambdaDNN，是一种listwise的学习方式。因此我们尝试将LambdaDNN模型应用在了Qunar搜索推荐下的精排阶段，</p>
<p>模型学习目标定义为曝光转化率（ctcvr）。LambdaDNN的搭建主要包括了框架选型、样本构造、特征工程、模型离线训练及线上化，其中样本与特征决定了模型效果的上限。接下来分别介绍下这几个部分：</p>
<h5 data-id="heading-6">2.1 框架选型</h5>
<p>TensorFlow Ranking (TFR) 是 TensorFlow 官方开发的 LTR 框架，旨在基于 TensorFlow 开发和整合 LTR 相关的技术，使开发人员可以更加方便的进行 LTR 算法的开发。TFR 使用了 Estimator API，提供了排序任务常见的损失函数和指标计算实现，比如 listwise Loss 和 NDCG指标。</p>
<p>根据训练流程，模块结构可以分成特征输入、特征转换、模型打分和损失计算等模块。这样的模块划分可以提高后续快速迭代的便利性和灵活性，而不用关注于各种实施上的细节。</p>
<p align="center"><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/46c9f88896d04b62955d7c15426048ba~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y675ZOq5YS_5oqA5pyv5rKZ6b6Z:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769150161&amp;x-signature=c0Lk9FUAZD7fFIyfho785K1RB9A%3D" alt="" loading="lazy"/></p>
<p align="center">图3 TFRanking框架</p>
<p>如上图3所示，model_fn 参数内需要自己设计和开发的算法模型模块。在这个 model_fn 中，需要自行设计模型结构 (Scoring Function)，然后用模型计算的 logit 和 label 来计算 Loss 和 Metrics，最后利用 Optimizer 来进行模型的优化。图3中的下方部分为使用 TFR 服务的整个流程。</p>
<p>为了配合 TFR 框架中的 LTR 相关的 Loss 和 Metrics 来实现 LTR 的训练，训练数据需要以 listwise 的形式组织。即LTR 模型与一次只对一个item进行分类的标准分类模型不同，它会将整个items列表接收输入，并学习排序，充分提升整个list列表的效用，如图4所示。</p>
<p align="center"><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/35f1b0bc8ad846c1b12835b31e1ff1db~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y675ZOq5YS_5oqA5pyv5rKZ6b6Z:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769150161&amp;x-signature=SJbAjGqzjFbEd33Pq%2BZCemzdVxs%3D" alt="" loading="lazy"/></p>
<p align="center">图4 listwise的学习方式</p>
<h5 data-id="heading-7">2.2 模型结构</h5>
<p>我们使用的模型结构，借鉴了Airbnb的深度学习[3]模型演进的经验，模型探索的原则是从简单到复杂，逐步积累经验，针对特征数量不多的情况下，使用非常深的网络，会导致过拟合。因此，如图5所示，采用了简单2层隐藏层的金字塔网络结构。</p>
<p>对一个query下的样本计算Lambda Loss，优化网络参数。其中，模型调优参数，batch size为1024，加入dropout和Batch Normalization（BN），梯度优化器是Adam，学习率为0.01。输入特征仅为77维，隐藏层神经元数为[128，86]。</p>
<p align="center"><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a3e9e9ca5a1b49008405301c2cd77764~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y675ZOq5YS_5oqA5pyv5rKZ6b6Z:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769150161&amp;x-signature=sOg9Q15hSmzp2zBuldyRlgMZVs4%3D" alt="" loading="lazy"/></p>
<p align="center">图5 模型结构</p>
<h5 data-id="heading-8">2.3 样本构造</h5>
<p>为了训练listwise模型，需要构造样本来表示用户的查询query和item之间的关系。图6(左图)显示了一个典型的用户搜索旅程的简化示例，其中客户在多天内进行多次query搜索，并点击多个搜索结果以查看其详细页面，最终在第M日query#3下的结果列表中用户点击了酒店（hotel-b）和下单了酒店（hotel-d），整个会话以用户下单酒店成功结束。</p>
<p align="center"><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4e73372caac2496ea7a067f68e712fc8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y675ZOq5YS_5oqA5pyv5rKZ6b6Z:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769150161&amp;x-signature=zg%2BsK07AYu7CPp%2F3tCVxNDVcsys%3D" alt="" loading="lazy"/></p>
<p align="center">图6 用户搜索行为示例</p>
<p>在我们的业务场景下，线上业务优化目标为下单转化率，对应离线建模目标为曝光转化率（ctcvr），即从search到order的转化，训练的目标是从曝光到下单的转化。</p>
<ul>
<li>list列表选择：
<ul>
<li>在以Listwise方式学习时，我们只使用含有成功下单的搜索列表（Day M的query#3）为List训练样本，Day1和Day2下的无下单列表样本将丢弃，标签见图6（右图）；</li>
<li>原因是若将只有点击标签的list加入训练，在计算NDCG时，不管点击标签的值是0.01还是1，ndcg的值都是一样，此时计算LambdaLoss时，模型会更倾向于只有点击的list，重点优化了ctr。</li>
</ul>
</li>
<li>正样本构造：
<ul>
<li>下单酒店标签1；</li>
<li>点击酒店标签0.01，标签值表示样本和query的相关度大小，可根据实验效果调整（点击和下单相关度比值我们是数据统计得来）。我们认为用户点击过的酒店是具有一定的喜好，不能简单的设置标签为0。</li>
</ul>
</li>
<li>负样本构造：
<ul>
<li>hard negative sample：曝光未下单且未点击的酒店；</li>
<li>easy negative sample：在同一个list列表中，采样list列表最底部的n家(&lt;&lt;当次请求曝光酒店数)未曝光的酒店，标签为0。由于线上精排排序家数较多，只选取曝光样本训练，模型对easy负样本学习不好。推荐结果会有部分低质量酒店，需要采样部分低质酒店作为easy negative sample，修正线上线下样本分布偏差，提升模型泛化能力。</li>
</ul>
</li>
<li>样本量：模型训练的样本以时间维度切分，30天为训练集，7天作为验证集，7天作为测试集。</li>
</ul>
<p>工程实践：Listwise学习方式的Lambda梯度需要对同Query下的样本进行计算。因此我们需要对样本进行预处理：将同一个查询(Query)的样本聚合在一起，采用ExampleListWithContext编码方式，将这些样本打包进一个TFRecord中。由于每次请求Query召回的item数不一样，对于可变Size的Query样本在拉取数据进行训练时需要注意，TF会自动补齐Mini-Batch内每个样本大小一致。</p>
<h5 data-id="heading-9">2.4特征工程</h5>
<p>特征工程主要包括特征构建、特征分析、特征处理，以及特征选择等：</p>
<p><strong>特征构建：</strong></p>
<ul>
<li>用户特征：用户行为特征，如过去1年下单的次数，下单该酒店的次数，用户画像等</li>
<li>酒店特征：属性特征等，如价格，档次，星级，点击率，转化率，节假日等</li>
<li>交叉特征：用户到酒店的距离，poi到酒店的距离等</li>
<li>上下文特征：时间，搜索场景等</li>
</ul>
<p><strong>构建原则：</strong></p>
<ul>
<li>防止特征穿越</li>
<li>尽量和业务相关</li>
<li>有区分性，尽量使特征能很好的区分出正负样本。</li>
</ul>
<p><strong>特征选择：</strong></p>
<ul>
<li>深度模型相对于树模型对特征值的大小更敏感，没有像树模型一样有自动特征选择功能，引入一些冗余特征会增大深度模型的噪声。因此我们基于LambdaMart的特征重要性排序，选取最重要的特征训练LambdaDnn，如图7所示，top49维（总维度是200维）时，测试集合的ndcg@10指标（test_ndcg）和全量特征ndcg@10（origin_test_ndcg）相比持平，且特征在top25维时指标不在增长。考虑到深度模型的参数空间更大，学习能力更强，我们在top49维特征的基础上，基于人工经验又挑选了28维特征，一共77维。</li>
</ul>
<p align="center"><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5f97d6acfe2f4dcd870fee8b89fd7f39~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y675ZOq5YS_5oqA5pyv5rKZ6b6Z:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769150161&amp;x-signature=CFy1WTk%2BLM%2FjFSCYEuK2O%2FJsLRg%3D" alt="" loading="lazy"/></p>
<p align="center">图7 选择不同top数量的特征训练后的模型效果</p>
<p><strong>特征分析：</strong></p>
<p>深度模型对特征大小较为敏感，因此特征处理的好坏直接影响后续模型的表现。</p>
<ul>
<li>长尾分布：例如点击率、点击次数等特征，80%的值分布在靠近0的附近，若直接加入模型训练，由于值差距太小，和其他特征相比没有区分性，因此需要做一些log变换后为正态分布，更有利于模型收敛。如下表：</li>
</ul>
<p align="center"><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/020bbec932a1457295073a1bb73a80a6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y675ZOq5YS_5oqA5pyv5rKZ6b6Z:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769150161&amp;x-signature=Nyfl8xGaxl4mXHDmjf%2BHMQDa6Xc%3D" alt="6ba3501906803be67bc43b369df8b67b.png" loading="lazy"/></p>
<ul>
<li>正态分布：价格等取值较大连续特征，使用了最大最小归一化方法，将特征值都转化为0-1之间的数值。</li>
<li>缺失值填补：在训练样本中不可避免地有部分连续特征存在缺失值，合理处理缺失值会对最终效果有一定帮助。填补缺失值的方式有：
<ul>
<li>取零值，会导致相应权重无法进行更新，收敛速度减慢。</li>
<li>取平均值也略显武断，毕竟不同的特征缺失所表示的含义可能不尽相同。</li>
<li>我们希望神经网络也可以通过学习的方式自适应地处理缺失值，而不是人为设置默认值。对较为重要的特征（特征重要度可通过模型的信息增益得分得到），且缺失率较大的，填补值为0，同时对缺失特征学习一个缺失权重，如下公式所示：</li>
</ul>
</li>
</ul>
<p align="center"><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/242195055ceb4845980ea7fe670e1412~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y675ZOq5YS_5oqA5pyv5rKZ6b6Z:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769150161&amp;x-signature=bGeg6MBXCJhvjZz%2BhkD8OG2YaVk%3D" alt="" loading="lazy"/></p>
<p>我们通过上述变换方式，让所有特征范围在0-1之间或者0附近，在输入模型后经过一层bn操作进行正态分布处理。当然还有其他处理方式，具体还要根据自己业务选择合适的处理方式。</p>
<h5 data-id="heading-10">2.5 实验评估</h5>
<p>baseline模型即LambdaMart，离线ndcg@10效果如下表，LambdaDnn线上转化率提升0.5%。</p>
<p align="center"><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2df1297120f343a7a846f49b23cf1444~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y675ZOq5YS_5oqA5pyv5rKZ6b6Z:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769150161&amp;x-signature=8WqxqrvSK4qIrQ6wXsWvSMZIuWo%3D" alt="61f15fcf5396064c9e98db66661b2597.png" loading="lazy"/></p>
<h4 data-id="heading-11">3. 多目标模型优化</h4>
<p>在类似电商搜索推荐系统中，用户的行为通常按照一种序列化的模式进行，即首先是曝光，然后是点击，最后是转化。因此，CTCVR模型的作用是预估在曝光发生后的转化概率。</p>
<h5 data-id="heading-12">3.1 为什么选择多目标建模？</h5>
<p><strong>单目标方式缺陷：</strong></p>
<p>1）样本选择偏差问题</p>
<ul>
<li>训练阶段：Listwise模式训练样本是用户最后一次在Day M日query#3下的下单列表，下单前的行为列表都被丢弃。</li>
<li>在线推断：query#1、query#2的列表都会经过推理，此时样本是有选择偏差的，离线训练和在线推理样本分布不一致，模型很难学习到真实样本分布信息，导致模型的泛化性能降低；</li>
<li>对无下单行为的用户学习效果较差</li>
</ul>
<p>2）模型分可解释性差</p>
<ul>
<li>Listwise模式学习的输出是偏序关系，值范围较大，不是在[0-1]之间，且每一次请求的值范围区间不同，对后续业务重排策略调整难度较大。若归一化到[0-1]后，不像实际ctr一样具有物理含义。</li>
</ul>
<p>3）数据稀疏，模型泛化能力不足</p>
<ul>
<li>若pointwise模式只使用曝光和下单样本训练CTCVR目标时，下单数据非常稀疏，下单样本的数量远远小于曝光样本。而利用CTR任务的丰富数据可以帮助CTCVR任务克服数据稀疏性问题，提高模型的泛化能力和预测性能</li>
</ul>
<p><strong>多目标优势：</strong></p>
<p>1）缓解样本偏差，及稀疏性</p>
<ul>
<li>将曝光点击下单都可以加入到模型中学习</li>
</ul>
<p>2）可解释性好</p>
<ul>
<li>输出值是概率意义，更好融合后面的重排加权策略；</li>
</ul>
<p>3）促进作用</p>
<ul>
<li>通过共享一些浅层次的特征，多任务学习可以借助彼此之间的相似性和差异性来促进学习过程</li>
</ul>
<p>4）约束作用</p>
<ul>
<li>当多个任务同时进行反向传播时，由于不同任务具有不同的噪声模式，多目标可以将多个任务的反馈信息结合起来，平均噪声模式，从而得到更一般和稳定的表征，有点像正则化的作用。通过这种方式，相对于单个任务，模型的过拟合风险会降低，泛化能力会提高。</li>
</ul>
<h5 data-id="heading-13">3.2 多目标建模选型</h5>
<p>MMOE是谷歌18年提出的模型结构，其思想是所有目标共享多个experts，但是考虑到不同任务之间的差异性，为每一个目标设置一个gate门控网络，用来控制不同目标选择每个expert的信号占比，类似于weighted sum pooling操作。</p>
<p>MMOE（如图8所示）通过共享experts学习到不同任务的联系和差异，提高了每个任务的学习效率和质量，同时通过gates来平衡多个任务对experts信号的选择，不要求目标之间必须是高相关性的，MMOE是业界通用的多目标实现算法。</p>
<p>多目标建模更好的考虑了排序全空间的曝光样本，综合考虑了下单前的用户点击行为，降低样本偏差问题，引入了多个专家、2个目标任务、一个CTR目标任务和一个CTCVR目标任务。</p>
<p align="center"><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/13cd33a45b334a079829c586a29a9183~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y675ZOq5YS_5oqA5pyv5rKZ6b6Z:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769150161&amp;x-signature=QqL9TVZAcK4beXbAo8D67gCuoNM%3D" alt="" loading="lazy"/></p>
<p align="center">图8 MMOE网络结构</p>
<h5 data-id="heading-14">3.3 MMOE样本选择</h5>
<p>1）只选取有行为的搜索列表，即该列表是有被点击或被下单的酒店的列表；</p>
<ul>
<li>原因：正负样本比例相差较大，过滤一部分认为无效负样本；其次训练时避免没有正行为用户的影响，在一批数据中如果某个用户对所有展示的物品都没有点击等行为，应当过滤掉该用户的记录（没有正行为用户只提供负例，看不出用户喜好，对模型训练没有帮助）。</li>
</ul>
<p>2）选取每个列表的曝光样本，以及每个列表的最底部未曝光的n家酒店作为easy negative sample，防止排序出一些较差的酒店。</p>
<p>3）同一个请求列表中的酒店被点击多次的，只记录一次点击行为，即一次点击正样本。</p>
<h5 data-id="heading-15">3.4 MMOE训练过程中遇到的问题</h5>
<p>1）实际的业务数据中，曝光到转化过于稀疏，具体训练过程中ctcvr的loss明显比ctr的loss小。为了使得2个目标任务的loss的量级一致，并没有采用loss加权处理，而是在样本构造过程中对下单样本进行上采样复制，保持正负样本1:1，基本上可以使得目标loss大小量级一样。</p>
<p>这样在训练shuffle时，不会使得一个正样本在batch内重复出现N次，使得ctcvr任务泛化性更好，同时对ctr任务中的上采样过的点击样本进行降权处理，恢复原先样本分布。</p>
<p>2）gate network输出进入饱和区，反向传播梯度消失：</p>
<p>expert gate输出，是由输入特征经过门网络后softmax得到，在训练的过程中，经过一段迭代次数，门控网络的输入值方差变大，经过softmax后gate network大部分输出是0，在这种情况下，multi expert的优势就没办法发挥出来，</p>
<p>一种解决方式是dropout，依然解决不了部分值偏大的问题；另一种方式对进入softmax之前的得分，进行得分除以一个lambda平滑处理（即，温度系数的调节），缓解部分专家退化现象；这里取lambda为输入特征的维度，也可以参考self-attention。</p>
<p align="center"><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b0118f6a54044ce39a428fb4bfa5eb78~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y675ZOq5YS_5oqA5pyv5rKZ6b6Z:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769150161&amp;x-signature=EgkKNgifd7oyugJLm%2BfverfEzJI%3D" alt="微信图片_2026-01-14_153851_295.png" loading="lazy"/></p>
<p>如下表指数e函数曲线中所示，x的域范围在[-10,10]区间时，softmax的值很容易在x小于-2.5时为0，x大于10时为1。如果将x缩放尺度为1/100，就会缓解退化问题。</p>
<p align="center"><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/30798f72e0334d6dbe3b5bd9678c0c4d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y675ZOq5YS_5oqA5pyv5rKZ6b6Z:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769150161&amp;x-signature=aL2ZZJA2fid2p7Mygh3OlD8XXws%3D" alt="3b9aedd9a2ea098fd6d5f8fb47021e6d.png" loading="lazy"/></p>
<h5 data-id="heading-16">3.5 实验结果</h5>
<p>线上预测时，我们会加权融合两个目标预测值作为排序分，而融合权重可以通过离线数据拟合得到。</p>
<p>从下表中，我们的MMOE最终的离线指标NDCG@10没有提升，主要的原因是测试集是只能在有下单的请求上预测，而lambda直接学习的ndcg目标，所以ndcg更高。而多目标线上的ctr有明显提升，线上点击率提升2%，转化率持平。</p>
<p align="center"><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1176845db93740caa18c492ce2534015~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y675ZOq5YS_5oqA5pyv5rKZ6b6Z:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769150161&amp;x-signature=277IzinRpbECKQIFvO2oFx%2FfMCk%3D" alt="e69c4c99b5bbf117b81801da690150a3.png" loading="lazy"/></p>
<h4 data-id="heading-17">4. 多场景多目标优化</h4>
<h5 data-id="heading-18">4.1 业务背景</h5>
<p>在用户出行想要预定酒店时，搜索酒店列表是一个常见的行为。根据用户所处空间不同、搜索行为不同，分为：异地空搜，同城空搜等场景，并且一个用户会跨不同场景进行搜索。而之前模型建模，每个场景单独训练一个模型，一是树模型容量小等历史原因延续单独建模，二是每个场景下所使用的特征不一样，特征的索引也没有对齐。</p>
<p>单独建模不会受到其他场景下的特征影响，其次也可学到单个场景独有的一些特点。但是带来的问题是不同场景下的共有信息无法相互共享、无法迁移学习，造成了信息孤岛。因为同一个用户会在不同场景下都有搜索行为，将同一个用户行为样本分开建模显然是不合理的，同时对多个模型的维护成本也很高。</p>
<p>因此，升级到了MMOE模型后，我们考虑将几个场景下的样本融合学习一个模型，宗旨是既可以学习到场景间独有信息，也能迁移学习不同场景下的共有信息。</p>
<h5 data-id="heading-19">4.2 多场景样本如何进行融合？</h5>
<p>不同场景下用户和item存在重叠，具有一定共性，不同场景下的用户行为，具有一定差异性；不同任务之间具有不同的稀疏性，同时也存在相互影响；如果在建模过程中忽略了多场景和多任务之间的共性和差异性，会影响建模效果，如果多个场景和任务不能很好地进行平衡，会存在场景跷跷板和 任务跷跷板现象。</p>
<p>一开始我们也是调研了目前不同场景下建模的方式，如阿里STAR、HMOE等多场景建模方式，但是效果不佳。原因是STAR、HMOE模型都是对不同场景下的分布差异较大的样本进行建模，会有比较好的效果。例如、淘宝的商品的主搜列表推荐、和主页的猜你喜欢等不同的多个频道的建模，而在去哪儿的酒店场景，其实还都是一个频道，用户的行为分布都是一致的，在目的地确定的前提下，无论是poi搜索、同城搜索，都是想预定目的地下的符合需求的酒店。</p>
<p>因此，我们尝试了直接将多个场景的样本放在一起学习，同时特征一起输入到MMOE中，简单的hard-share效果比STAR、HMOE效果会好。我们将训练完的模型，输出每个场景的专家权重，来分析不同场景下的权重是否分布一样。</p>
<p align="center"><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/620531d072224d5fb4bc9ea125aeb245~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y675ZOq5YS_5oqA5pyv5rKZ6b6Z:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769150161&amp;x-signature=AzAfm2Qg2IYUrVHG95Qh3jUcXig%3D" alt="" loading="lazy"/></p>
<p align="center">图9 不同场景下样本在专家下的权重占比</p>
从图9来看，不同场景下的专家权重，分布几乎一致，最高的权重是专家2。侧面验证了，在我们的业务下场景间的分布差异没有很大。线上的下单转化相对提升0.56%。
<h5 data-id="heading-20">4.3 多场景下特征如何对齐？</h5>
<p>对于酒店业务下的特征，特征主要分为4类：</p>
<ul>
<li>场景无关特征：如酒店价格、用户点击次数、下单次数等</li>
<li>场景共有特征：如酒店在poi下的转化率、点击率等，此时特征会共用一个特征索引</li>
<li>场景独有特征：如同城空搜下用户距离酒店的距离，poi场景下poi距离酒店的距离等，此时，特征索引不共用</li>
<li>场景标识特征：主要就是场景 ID 类特征</li>
</ul>
<p>如上所述，输入部分，将场景的domain信息作为特征和场景共有特征一起拼接输入到感知网络中，抽取场景间共性信息；将场景的domain信息作为特征和场景特有特征一起拼接输入到感知网络中，抽取场景间差异信息；</p>
<p>如果统一作为MMOE的输入直接输入，模型无法很好的学习到不同场景的差异，若人为先验的分为上述几类特征，拉平场景特征之间的差异。可以使得模型在一个稳定的样本分布下学习，增强模型对用户跨域行为的底层感知能力。</p>
<p align="center"><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d28ab86b110f4bce87e3ed19d8c457a9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y675ZOq5YS_5oqA5pyv5rKZ6b6Z:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769150161&amp;x-signature=fA7N5%2B6eD21BrF4FennTBtmF0b8%3D" alt="微信图片_2026-01-14_154104_798.png" loading="lazy"/></p>
<p align="center">图10 多场景多目标网络结构</p>
<h5 data-id="heading-21">4.4 实验评估</h5>
<ul>
<li>在v2阶段多场景样本合并时，ndcg@10指标提升不大，多个场景下的样本融合后，网络的参数量不能很好的表达出场景间的特性。</li>
<li>因此，将网络专家数扩大到8个，希望每个专家能充分学习到场景间差异，离线指标ndcg@10相对v1提升0.19%，上线后，s2o指标提升0.46%，另外，我们做了其他的专家数量的实验，发现增加9个以后，ndcg指标没有什么变化。</li>
<li>为了更好的对齐场景的特征差异，我们对输入特征分类建模输入MMOE（v4）。此时，离线指标ndcg@10相对提升0.22%，上线后，s2o指标提升0.51%。</li>
</ul>
<p align="center"><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/26887a13085a47f6a05120a1c194a068~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y675ZOq5YS_5oqA5pyv5rKZ6b6Z:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769150161&amp;x-signature=941VOboOfo8q4E3QLFF%2FD%2F8aABY%3D" alt="f523e796169819e3bd5fd590008d0956.png" loading="lazy"/></p>
<h4 data-id="heading-22">5. 特征选择</h4>
<h5 data-id="heading-23">5.1 为什么需要做特征选择？</h5>
<p>随着Qunar酒店排序模型业务需求的迭代，越来越多的特征被引入模型中，导致出现如下问题：</p>
<ul>
<li>冗余特征增多
<ul>
<li>有些特征可能与当下的问题无关。这意味着它们与模型要解决的任务完全无关，丢弃不相关的特征可以防止模型得到无关特征上可能携带的虚假相关性，从而避免过拟合。</li>
</ul>
</li>
<li>维度灾难
<ul>
<li>特征选择技术在具有许多特征但训练示例很少的场景中尤为重要。这种情况受到所谓的维度灾难的影响：在高维空间中，每个训练示例都与其他所有示例相距甚远，因此模型无法学习任何有用的模式。</li>
</ul>
</li>
<li>训练时间长
<ul>
<li>特征越多，训练时间就越长。这种权衡的具体细节取决于所使用的特定学习算法，但在需要实时进行再训练的情况下，可能需要限制在几个最佳特征中进行。</li>
</ul>
</li>
<li>部署工作成本高
<ul>
<li>特征越多，机器学习系统在生产中就越复杂。这会带来多种风险，包括但不限于高维护工作量、纠纷、未申报的使用者或纠正级联。</li>
</ul>
</li>
<li>可解释性差
<ul>
<li>由于特征太多，我们失去了模型的可解释性。虽然对模型结果的解释并不总是主要的建模目标，但通常很重要，在某些受监管的领域，甚至可能是法律要求。</li>
</ul>
</li>
</ul>
<h5 data-id="heading-24">5.2 传统特征选择方法</h5>
<ul>
<li>无监督的特征选择方法</li>
<li>包装器特征选择方法</li>
<li>过滤器特征选择方法</li>
<li>Boruta（布尔塔）方法</li>
</ul>
<p>上述传统方法更适合数量小，训练时间短，模型简单的场景。而我们深度模型采用了基于dropout 的特征选择，借鉴了论文Dropout Feature Ranking for Deep Learning Models 的工作。</p>
<h5 data-id="heading-25">5.3 使用变分dropout来做特征的排序</h5>
<p align="center"><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bd6610248cf4492aaed4e594ac015450~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y675ZOq5YS_5oqA5pyv5rKZ6b6Z:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769150161&amp;x-signature=tWSu32VhRWdNZJtv0mnYD9BfZ38%3D" alt="" loading="lazy"/></p>
<p align="center">图11 dropout的训练前后的丢弃概率示意图</p>
<p>基于两阶段，第一阶段需要先训练一个pretrained Model 这样先学习模型的参数，第二阶段固定模型参数不做梯度更新，对输入的特征增加一个dropout丢弃变量（可导）与输入特征元素相乘，这个阶段的主要目的是优化该dropout丢弃概率。</p>
<p>如图11所示，论文提出了Dropout Feature Ranking方法，在训练完后，可以获取到每个特征的重要度。</p>
<p>本质的思想是将不可导的离散变量dropout，采用Concrete relaxation操作，对符合伯努利分布的离散变量近似估计为一个连续可导变量。松弛为连续性的噪声扰动过程，使其可以进行梯度更新。并对1-dropout_rate添加正则，使其在训练中尽可能最小化。图12 中的p就是特征的丢弃概率。</p>
<p align="center"><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/81b817f69e9042f1be01342919c68fe8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y675ZOq5YS_5oqA5pyv5rKZ6b6Z:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769150161&amp;x-signature=3NG00dQ5uG1A4WOXDhwkHjT3jxo%3D" alt="" loading="lazy"/></p>
<p align="center">图12 dropout layer层</p>
<p>这种方案的优点：</p>
<ul>
<li>通用性高：可以应用于任何深度学习模型</li>
<li>简单方便：在训练好的模型只进行一次dropout参数训练即可得出特征重要性排序，无需进行多次实验来剔除特征</li>
<li>效果可靠：该方法在实际业务应用中展现出了出色的特征筛选效果。</li>
</ul>
<h5 data-id="heading-26">实验效果：</h5>
<p>1、为了验证无效特征会影响模型的效果，我们在模型的原特征基础上增加了10个随机生成的噪声生成噪声特征（在某些特征上添加均匀分布噪声、高斯分布噪声等）</p>
<p>2、加上DFR层后，删减了14维特征后，模型效果不但没有下降，反而有微弱的提升。删除特征重新训练模型，线上转化率提升0.2%。</p>
<p align="center"><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/94ac2afe054b45b690a6a39c3907ef33~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y675ZOq5YS_5oqA5pyv5rKZ6b6Z:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769150161&amp;x-signature=LbydBDARjkm5MJjZffdDZ%2F2yzCg%3D" alt="4cbe3a5269eb4687a95e6edaaaa684d3.png" loading="lazy"/></p>
<p>3、使用DFR算法后，特征重要性如下：</p>
<ul>
<li>基本上是实时特征更重要</li>
<li>我们将低于对照特征（高斯噪声）重要度分的特征删除，基本上是一些冗余特征。</li>
</ul>
<p align="center"><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/df6bad579cdc49b9b72d422a46eabd1d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y675ZOq5YS_5oqA5pyv5rKZ6b6Z:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769150161&amp;x-signature=zLYMWwRJjzNyKUsDuWfq9KcujpQ%3D" alt="973e23cd3794b64133c5763dbd144d8d.png" loading="lazy"/></p>
<h2 data-id="heading-27">五、阶段总结和未来规划</h2>
<p>本文主要介绍Qunar在酒店搜索精排模型上的演进实践，从实验效果来看，证明了深度模型在酒店搜索排序的有效性，以及合理引入多场景特征间的差异建模可以让模型更好的理解数据。</p>
<p>对于接下来的深度模型优化：借鉴listwise的建模方式，将pointwise loss和listwise loss融合，既可以学习排序，又可以学习判别分类。</p>
<p>[1]Chris J.C. Burges. 2010. From RankNet to LambdaRank to LambdaMART: An Overview. Technical Report. <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.microsoft.com%2Fen-us%2Fresearch%2Fpublication%2Ffrom-ranknet-to-lambdarank-to-lambdamart-an-overview%2F" target="_blank" title="https://www.microsoft.com/en-us/research/publication/from-ranknet-to-lambdarank-to-lambdamart-an-overview/" ref="nofollow noopener noreferrer">www.microsoft.com/en-us/resea…</a></p>
<p>[2] Rama Kumar Pasumarthi, Sebastian Bruch, Xuanhui Wang, Cheng Li, Michael Bendersky, Marc Najork, Jan Pfeifer, Nadav Golbandi, Rohan Anil, Stephan Wolf.</p>
<p>TF-Ranking: Scalable TensorFlow Library for Learning-to-Rank.KDD 2019.</p>
<p>[3] Haldar M, Abdool M, Ramanathan P, et al. Applying deep learning to airbnb search[C]//Proceedings of the 25th ACM SIGKDD International Conference on Knowledge Discovery &amp; Data Mining. 2019: 1927-1935.</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Java双亲委派模型工作原理]]></title>    <link>https://juejin.cn/post/7595472747455676431</link>    <guid>https://juejin.cn/post/7595472747455676431</guid>    <pubDate>2026-01-16T01:51:41.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7595472747455676431" data-draft-id="7595400254348378127" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Java双亲委派模型工作原理"/> <meta itemprop="keywords" content="Java"/> <meta itemprop="datePublished" content="2026-01-16T01:51:41.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="IT橘子皮"/> <meta itemprop="url" content="https://juejin.cn/user/3148645291002232"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Java双亲委派模型工作原理
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3148645291002232/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    IT橘子皮
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-16T01:51:41.000Z" title="Fri Jan 16 2026 01:51:41 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-16
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    18
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一、双亲委派模型的核心机制</h2>
<h3 data-id="heading-1">1.1 类加载器的层级结构</h3>
<p>Java类加载器采用<strong>树形层级结构</strong>，包含三类核心加载器：</p>
<ul>
<li><strong>Bootstrap ClassLoader（启动类加载器）</strong> ：由C++实现，负责加载JVM核心类库（如<code>java.lang.*</code>），位于<code>&lt;JAVA_HOME&gt;/lib</code>目录。</li>
<li><strong>Extension ClassLoader（扩展类加载器）</strong> ：加载<code>&lt;JAVA_HOME&gt;/lib/ext</code>目录或<code>java.ext.dirs</code>指定的扩展类。</li>
<li><strong>Application ClassLoader（应用类加载器）</strong> ：默认加载用户类路径（Classpath）上的类，是自定义类加载器的父加载器。</li>
</ul>
<p>三者通过组合关系形成层级，而非继承。</p>
<h3 data-id="heading-2">1.2 双亲委派的工作流程</h3>
<p>当类加载器收到加载请求时，执行以下步骤：</p>
<ol>
<li><strong>检查缓存</strong>：若当前加载器已加载该类，直接返回。</li>
<li><strong>委派父加载器</strong>：递归请求父加载器加载（直至Bootstrap）。</li>
<li><strong>父加载失败后自加载</strong>：若父加载器无法加载，当前加载器调用<code>findClass()</code>方法加载。</li>
</ol>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// ClassLoader源码核心逻辑（简化）</span>
protected Class&lt;?&gt; <span class="hljs-built_in">loadClass</span>(String name, boolean resolve) {
    synchronized (getClassLoadingLock(name)) {
        Class&lt;?&gt; c = <span class="hljs-built_in">findLoadedClass</span>(name);
        if (c == null) {
            try {
                if (parent != null) {
                    c = parent<span class="hljs-selector-class">.loadClass</span>(name, false); <span class="hljs-comment">// 委派父加载器</span>
                } else {
                    c = <span class="hljs-built_in">findBootstrapClassOrNull</span>(name); <span class="hljs-comment">// Bootstrap加载</span>
                }
            } catch (ClassNotFoundException ignored) {}
            if (c == null) {
                c = <span class="hljs-built_in">findClass</span>(name); <span class="hljs-comment">// 自加载</span>
            }
        }
        if (resolve) <span class="hljs-built_in">resolveClass</span>(c);
        return c;
    }
}
</code></pre>
<p>此流程确保<strong>类加载请求最终由最顶层的Bootstrap尝试处理</strong>。</p>
<hr/>
<h2 data-id="heading-3">二、双亲委派的核心优势</h2>
<h3 data-id="heading-4">2.1 安全性保障</h3>
<ul>
<li><strong>核心类库保护</strong>：用户自定义的<code>java.lang.String</code>等类会被Bootstrap加载器拦截，避免篡改核心API。</li>
<li><strong>沙箱隔离</strong>：恶意代码无法通过覆盖核心类实现攻击。</li>
</ul>
<h3 data-id="heading-5">2.2 唯一性与稳定性</h3>
<ul>
<li><strong>类唯一性</strong>：类由<strong>全限定名+加载器实例</strong>共同标识，避免重复加载。</li>
<li><strong>资源一致性</strong>：确保<code>System.getProperty("java.version")</code>等全局资源加载一致性。</li>
</ul>
<h3 data-id="heading-6">2.3 性能优化</h3>
<ul>
<li>减少重复类加载的开销，尤其对频繁使用的类（如集合框架）效果显著。</li>
</ul>
<hr/>
<h2 data-id="heading-7">三、破坏双亲委派的典型场景</h2>
<h3 data-id="heading-8">3.1 SPI机制（服务提供接口）</h3>
<ul>
<li>
<p><strong>问题</strong>：<code>java.sql.Driver</code>由Bootstrap加载，但具体实现（如MySQL驱动）需由应用类加载器加载。</p>
</li>
<li>
<p><strong>实现</strong>：通过<code>Thread.currentThread().getContextClassLoader()</code>获取上下文加载器，打破委派链。</p>
<pre><code class="hljs language-ini" lang="ini">// JDBC驱动加载示例
ServiceLoader&lt;Driver&gt; <span class="hljs-attr">loader</span> = ServiceLoader.load(Driver.class, Thread.currentThread().getContextClassLoader())<span class="hljs-comment">;</span>
</code></pre>
</li>
</ul>
<h3 data-id="heading-9">3.2 应用服务器热部署</h3>
<ul>
<li>
<p><strong>Tomcat的WebappClassLoader</strong>：优先从<code>WEB-INF/lib</code>加载类，而非委派给父加载器，实现Web应用隔离。</p>
</li>
<li>
<p><strong>代码示例</strong>：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// Tomcat类加载逻辑（简化）</span>
<span class="hljs-keyword">public</span> <span class="hljs-title class_">Class</span>&lt;?&gt; <span class="hljs-title function_">loadClass</span>(<span class="hljs-params"><span class="hljs-built_in">String</span> name</span>) {
    <span class="hljs-keyword">if</span> (name.<span class="hljs-title function_">startsWith</span>(<span class="hljs-string">"com.example.app"</span>)) {
        <span class="hljs-keyword">return</span> <span class="hljs-title function_">findClass</span>(name); <span class="hljs-comment">// 自优先加载</span>
    }
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">super</span>.<span class="hljs-title function_">loadClass</span>(name);
}
</code></pre>
</li>
</ul>
<h3 data-id="heading-10">3.3 模块化框架（OSGi）</h3>
<ul>
<li><strong>动态模块加载</strong>：每个Bundle拥有独立类加载器，支持热插拔。</li>
<li><strong>选择性委派</strong>：仅对<code>java.*</code>等核心包委派，其他包由自身加载。</li>
</ul>
<hr/>
<h2 data-id="heading-11">四、破坏双亲委派的后果与风险</h2>
<h3 data-id="heading-12">4.1 类重复加载与类型冲突</h3>
<ul>
<li>
<p><strong>问题</strong>：不同加载器加载同名类（如<code>com.user.User</code>），导致<code>ClassCastException</code>。</p>
<pre><code class="hljs language-ini" lang="ini">// 示例：两个Web应用加载不同版本的Log4j
ClassLoader <span class="hljs-attr">loader1</span> = app1.getClassLoader()<span class="hljs-comment">;</span>
ClassLoader <span class="hljs-attr">loader2</span> = app2.getClassLoader()<span class="hljs-comment">;</span>
Class&lt;?&gt; <span class="hljs-attr">log4j1</span> = loader1.loadClass(<span class="hljs-string">"org.apache.log4j.Logger"</span>)<span class="hljs-comment">;</span>
Class&lt;?&gt; <span class="hljs-attr">log4j2</span> = loader2.loadClass(<span class="hljs-string">"org.apache.log4j.Logger"</span>)<span class="hljs-comment">;</span>
// log4j1 != log4j2，类型不兼容
</code></pre>
</li>
</ul>
<h3 data-id="heading-13">4.2 核心类库篡改风险</h3>
<ul>
<li><strong>恶意代码注入</strong>：若绕过双亲委派加载伪造的<code>java.lang.Runtime</code>，可能执行危险操作。</li>
</ul>
<h3 data-id="heading-14">4.3 内存泄漏与类卸载失败</h3>
<ul>
<li><strong>类加载器泄漏</strong>：自定义加载器持有静态引用（如缓存），导致其无法被GC回收，连带类也无法卸载。</li>
<li><strong>元空间OOM</strong>：频繁加载/卸载类导致元空间膨胀。</li>
</ul>
<hr/>
<h2 data-id="heading-15">五、最佳实践与调优建议</h2>
<h3 data-id="heading-16">5.1 谨慎打破双亲委派</h3>
<ul>
<li><strong>限定范围</strong>：仅在必要时（如SPI、热部署）局部打破，避免全局破坏。</li>
<li><strong>隔离策略</strong>：使用独立类加载器加载高风险代码，并限制其权限。</li>
</ul>
<h3 data-id="heading-17">5.2 类加载器管理</h3>
<ul>
<li>
<p><strong>弱引用缓存</strong>：对<code>Class</code>对象使用<code>WeakReference</code>，避免内存泄漏。</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-built_in">WeakReference</span>&lt;Class<span class="hljs-meta">&lt;?</span>&gt;&gt; clazzRef = <span class="hljs-keyword">new</span> <span class="hljs-built_in">WeakReference</span>&lt;&gt;(MyClass.<span class="hljs-keyword">class</span>);
</code></pre>
</li>
<li>
<p><strong>清理机制</strong>：在Web应用停止时，显式卸载类加载器并释放资源。</p>
</li>
</ul>
<h3 data-id="heading-18">5.3 监控与调试</h3>
<ul>
<li>
<p><strong>JVM参数</strong>：</p>
<ul>
<li><code>-verbose:class</code>：跟踪类加载过程。</li>
<li><code>-XX:+TraceClassLoading</code>：输出详细加载日志。</li>
</ul>
</li>
<li>
<p><strong>工具分析</strong>：使用JConsole、VisualVM监控类加载器状态。</p>
</li>
</ul>
<hr/>
<h2 data-id="heading-19">六、总结</h2>
<p>双亲委派模型通过<strong>层级委派、唯一性保障</strong>和<strong>安全隔离</strong>，成为Java类加载机制的基石。尽管在SPI、热部署等场景中需灵活打破该模型，但开发者需深刻理解其风险，通过<strong>隔离加载、严格资源管理</strong>和<strong>监控调优</strong>规避潜在问题。未来，随着模块化系统（如Project Jigsaw）的普及，类加载机制将更趋精细化，但双亲委派的核心思想仍将延续。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[React从入门到出门第九章 资源加载新特性Suspense 原生协调原理与实战]]></title>    <link>https://juejin.cn/post/7595478717985243145</link>    <guid>https://juejin.cn/post/7595478717985243145</guid>    <pubDate>2026-01-16T01:22:30.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7595478717985243145" data-draft-id="7590309337861570601" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="React从入门到出门第九章 资源加载新特性Suspense 原生协调原理与实战"/> <meta itemprop="keywords" content="JavaScript,前端框架,React.js"/> <meta itemprop="datePublished" content="2026-01-16T01:22:30.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="怕浪猫"/> <meta itemprop="url" content="https://juejin.cn/user/2832784963939438"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            React从入门到出门第九章 资源加载新特性Suspense 原生协调原理与实战
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2832784963939438/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    怕浪猫
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-16T01:22:30.000Z" title="Fri Jan 16 2026 01:22:30 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-16
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读14分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>大家好～ 提到 React 的 Suspense，很多开发者的第一印象是“用来做代码分割”或“配合 lazy 加载组件”。但在 React 19 之前，Suspense 在资源加载场景下始终有个致命短板：无法原生协调多个异步资源的加载状态，导致我们需要写大量模板代码处理“多资源并行加载”“依赖资源串行加载”等场景。</p>
<p>React 19 彻底解决了这个问题，推出了 <strong>Suspense 原生协调</strong> 特性，让多资源加载的状态管理变得极简。今天这篇文章，我们就从“旧版 Suspense 的痛点”出发，一步步拆解 React 19 原生协调的核心原理，再通过 4 个高频实战案例，带你彻底掌握这个新特性的用法，让资源加载逻辑更清晰、代码更简洁～</p>
<h2 data-id="heading-0">一、先回顾：旧版 Suspense 的资源加载痛点</h2>
<p>在 React 19 之前，Suspense 虽然能处理单个异步资源的“加载中 fallback”，但面对多资源加载场景时，就显得力不从心了。我们先通过两个常见场景，看看旧版 Suspense 的问题所在。</p>
<h3 data-id="heading-1">1. 痛点 1：多资源并行加载，需手动管理整体状态</h3>
<p>假设我们需要在页面中同时加载“用户信息”和“用户订单列表”两个异步资源，要求两个资源都加载完成后再展示页面，加载过程中显示统一的 loading。在 React 19 之前，我们需要手动管理两个资源的加载状态：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// React 19 之前：多资源并行加载的繁琐实现</span>
<span class="hljs-keyword">import</span> { useState, useEffect } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;

<span class="hljs-comment">// 异步请求函数</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">fetchUser</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> res = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetch</span>(<span class="hljs-string">'/api/user'</span>);
  <span class="hljs-keyword">return</span> res.<span class="hljs-title function_">json</span>();
}

<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">fetchOrders</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> res = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetch</span>(<span class="hljs-string">'/api/orders'</span>);
  <span class="hljs-keyword">return</span> res.<span class="hljs-title function_">json</span>();
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">UserDashboard</span>(<span class="hljs-params"/>) {
  <span class="hljs-comment">// 手动管理两个资源的加载状态和结果</span>
  <span class="hljs-keyword">const</span> [user, setUser] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">null</span>);
  <span class="hljs-keyword">const</span> [orders, setOrders] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">null</span>);
  <span class="hljs-keyword">const</span> [loading, setLoading] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">true</span>);
  <span class="hljs-keyword">const</span> [error, setError] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">null</span>);

  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-title function_">setLoading</span>(<span class="hljs-literal">true</span>);
    <span class="hljs-title function_">setError</span>(<span class="hljs-literal">null</span>);

    <span class="hljs-comment">// 并行请求两个资源</span>
    <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">all</span>([<span class="hljs-title function_">fetchUser</span>(), <span class="hljs-title function_">fetchOrders</span>()])
      .<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">[userData, ordersData]</span>) =&gt;</span> {
        <span class="hljs-title function_">setUser</span>(userData);
        <span class="hljs-title function_">setOrders</span>(ordersData);
      })
      .<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">err</span>) =&gt;</span> <span class="hljs-title function_">setError</span>(err.<span class="hljs-property">message</span>))
      .<span class="hljs-title function_">finally</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">setLoading</span>(<span class="hljs-literal">false</span>));
  }, []);

  <span class="hljs-comment">// 手动处理 loading 和 error 状态</span>
  <span class="hljs-keyword">if</span> (loading) <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>加载中...<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>;
  <span class="hljs-keyword">if</span> (error) <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>加载失败：{error}<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>;
  <span class="hljs-keyword">if</span> (!user || !orders) <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">h2</span>&gt;</span>{user.name} 的仪表盘<span class="hljs-tag">&lt;/<span class="hljs-name">h2</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">h3</span>&gt;</span>我的订单<span class="hljs-tag">&lt;/<span class="hljs-name">h3</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">ul</span>&gt;</span>
        {orders.map((order) =&gt; (
          <span class="hljs-tag">&lt;<span class="hljs-name">li</span> <span class="hljs-attr">key</span>=<span class="hljs-string">{order.id}</span>&gt;</span>{order.title} - ￥{order.amount}<span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span>
        ))}
      <span class="hljs-tag">&lt;/<span class="hljs-name">ul</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
}
</code></pre>
<p>这种写法的问题很明显：<strong>需要手动用 useState 管理多个资源的状态，用 Promise.all 协调并行逻辑，代码模板化严重</strong>。如果资源数量增加到 3 个、4 个，状态管理会变得更加混乱。</p>
<h3 data-id="heading-2">2. 痛点 2：依赖资源串行加载，逻辑嵌套冗余</h3>
<p>再看一个更复杂的场景：加载“用户订单详情”需要先加载“用户信息”（获取用户 ID），再根据用户 ID 加载“订单列表”，最后根据订单 ID 加载“订单详情”。这种串行依赖的场景，在旧版 React 中需要嵌套多层 Promise，逻辑繁琐：</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// React 19 之前：串行资源加载的嵌套实现</span>
function <span class="hljs-built_in">OrderDetail</span>() {
  const <span class="hljs-selector-attr">[user, setUser]</span> = <span class="hljs-built_in">useState</span>(null);
  const <span class="hljs-selector-attr">[order, setOrder]</span> = <span class="hljs-built_in">useState</span>(null);
  const <span class="hljs-selector-attr">[detail, setDetail]</span> = <span class="hljs-built_in">useState</span>(null);
  const <span class="hljs-selector-attr">[loading, setLoading]</span> = <span class="hljs-built_in">useState</span>(true);
  const <span class="hljs-selector-attr">[error, setError]</span> = <span class="hljs-built_in">useState</span>(null);

  <span class="hljs-built_in">useEffect</span>(() =&gt; {
    <span class="hljs-built_in">setLoading</span>(true);
    <span class="hljs-built_in">setError</span>(null);

    <span class="hljs-comment">// 串行请求：用户信息 → 订单列表 → 订单详情</span>
    <span class="hljs-built_in">fetchUser</span>()
      <span class="hljs-selector-class">.then</span>((userData) =&gt; {
        <span class="hljs-built_in">setUser</span>(userData);
        return <span class="hljs-built_in">fetchOrders</span>(userData.id); <span class="hljs-comment">// 依赖用户 ID</span>
      })
      <span class="hljs-selector-class">.then</span>((ordersData) =&gt; {
        const firstOrder = ordersData<span class="hljs-selector-attr">[0]</span>;
        <span class="hljs-built_in">setOrder</span>(firstOrder);
        return <span class="hljs-built_in">fetchOrderDetail</span>(firstOrder.id); <span class="hljs-comment">// 依赖订单 ID</span>
      })
      <span class="hljs-selector-class">.then</span>((detailData) =&gt; {
        <span class="hljs-built_in">setDetail</span>(detailData);
      })
      <span class="hljs-selector-class">.catch</span>((err) =&gt; <span class="hljs-built_in">setError</span>(err.message))
      <span class="hljs-selector-class">.finally</span>(() =&gt; <span class="hljs-built_in">setLoading</span>(false));
  }, <span class="hljs-selector-attr">[]</span>);

  if (loading) return &lt;<span class="hljs-selector-tag">div</span>&gt;加载中...&lt;/<span class="hljs-selector-tag">div</span>&gt;;
  if (error) return &lt;<span class="hljs-selector-tag">div</span>&gt;加载失败：{error}&lt;/<span class="hljs-selector-tag">div</span>&gt;;
  if (!user || !order || !detail) return null;

  return (
    &lt;div&gt;
      &lt;h2&gt;{user.name} 的订单详情&lt;/h2&gt;
      &lt;p&gt;订单号：{order.id}&lt;/p&gt;
      &lt;p&gt;商品：{detail.goodsName}&lt;/p&gt;
      &lt;p&gt;金额：￥{detail.amount}&lt;/p&gt;
    &lt;/div&gt;
  );
}
</code></pre>
<p>这种嵌套写法不仅可读性差，而且一旦某个环节需要修改（比如增加一个依赖资源），就需要改动多层代码，维护成本极高。</p>
<h3 data-id="heading-3">3. 痛点总结：旧版 Suspense 为何“不省心”？</h3>
<p>旧版 Suspense 之所以无法解决这些问题，核心原因是：<strong>不具备原生的资源协调能力</strong>。它只能监听单个组件内部的异步资源（比如通过 use() 或 lazy 加载的资源），无法感知多个组件、多个资源之间的依赖关系和加载顺序。因此，开发者必须手动用 Promise 或状态管理库来协调这些资源，导致代码冗余、逻辑复杂。</p>
<h2 data-id="heading-4">二、React 19 核心升级：Suspense 原生协调原理</h2>
<p>React 19 为 Suspense 新增了 <strong>原生协调能力</strong>，核心目标是：<strong>自动感知并协调多个异步资源的加载状态，支持并行、串行等多种加载策略，无需手动管理状态</strong>。这一特性彻底解决了旧版的痛点，让多资源加载变得极简。</p>
<h3 data-id="heading-5">1. 核心概念：什么是“原生协调”？</h3>
<p>Suspense 原生协调，简单来说就是：<strong>当多个异步资源被 Suspense 包裹时，React 会自动收集所有资源的加载状态，根据你指定的策略（并行/串行）等待资源加载完成，再统一渲染内容；期间只显示一个 fallback，错误也会被统一捕获</strong>。</p>
<p>关键变化在于：React 19 让 Suspense 从“单个资源的加载容器”升级为“多个资源的协调器”，能够主动管理多个资源的加载生命周期。</p>
<h3 data-id="heading-6">2. 核心原理：3 步实现资源协调</h3>
<p>Suspense 原生协调的底层原理，依赖于 React 19 对“异步资源调度系统”的升级，核心流程可以拆解为 3 步：</p>
<ol>
<li>
<p><strong>资源收集阶段</strong>：当 Suspense 组件渲染时，React 会自动追踪其内部所有通过 use() 消费的异步资源（或通过 lazy 加载的组件），将这些资源的 Promise 收集到一个“资源队列”中；</p>
</li>
<li>
<p><strong>加载协调阶段</strong>：React 根据 Suspense 的配置（默认并行，可通过配置实现串行），协调资源队列的加载顺序：</p>
<ol>
<li>并行策略：同时触发所有资源的加载，等待所有资源都决议（成功/失败）；</li>
<li>串行策略：按资源的依赖关系依次触发加载，前一个资源成功后再加载下一个；</li>
</ol>
</li>
<li>
<p><strong>状态统一阶段</strong>：在资源加载过程中，Suspense 始终显示 fallback；当所有资源都成功加载，Suspense 会渲染内部内容；如果任何一个资源加载失败，错误会被 ErrorBoundary 统一捕获。</p>
</li>
</ol>
<h4 data-id="heading-7">Suspense 原生协调流程图</h4>
<h3 data-id="heading-8">3. 关键技术：React 19 如何追踪资源依赖？</h3>
<p>Suspense 原生协调的核心技术支撑，是 React 19 对 <code>use()</code> Hook 的增强和“资源依赖追踪机制”：</p>
<ul>
<li><strong>use() 增强</strong>：React 19 中的 use() 不仅能消费单个 Promise，还能将其对应的资源注册到最近的 Suspense 组件中，让 Suspense 感知到这个资源的存在；</li>
<li><strong>依赖追踪</strong>：React 会在组件渲染过程中，通过“上下文”记录当前 Suspense 组件与资源的对应关系，形成一个“资源依赖树”。当资源状态变化时，React 能通过这个树快速定位到对应的 Suspense 组件，触发重新协调。</li>
</ul>
<p>简单来说，React 19 让 Suspense 和 use() 形成了“父子关系”：Suspense 是“协调器”，use() 消费的资源是“被协调的子节点”，协调器统一管理所有子节点的加载状态。</p>
<h2 data-id="heading-9">三、实战演练：4 个高频场景玩转 Suspense 原生协调</h2>
<p>理解了核心原理后，我们通过 4 个真实业务场景，看看 React 19 Suspense 原生协调如何落地。所有案例都基于“use() + Suspense + ErrorBoundary”的组合，无需手动管理任何加载状态。</p>
<h3 data-id="heading-10">场景 1：多资源并行加载（基础用法）</h3>
<p>需求：同时加载“用户信息”和“订单列表”，全部加载完成后展示页面，统一显示 loading，错误统一捕获。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// React 19：Suspense 原生协调实现多资源并行加载</span>
<span class="hljs-keyword">import</span> { use, <span class="hljs-title class_">Suspense</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;

<span class="hljs-comment">// 1. 定义异步请求函数（返回 Promise）</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">fetchUser</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> res = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetch</span>(<span class="hljs-string">'/api/user'</span>);
  <span class="hljs-keyword">if</span> (!res.<span class="hljs-property">ok</span>) <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">'用户信息加载失败'</span>);
  <span class="hljs-keyword">return</span> res.<span class="hljs-title function_">json</span>();
}

<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">fetchOrders</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> res = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetch</span>(<span class="hljs-string">'/api/orders'</span>);
  <span class="hljs-keyword">if</span> (!res.<span class="hljs-property">ok</span>) <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">'订单列表加载失败'</span>);
  <span class="hljs-keyword">return</span> res.<span class="hljs-title function_">json</span>();
}

<span class="hljs-comment">// 2. 子组件：分别使用 use() 消费资源</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">UserInfo</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> user = <span class="hljs-title function_">use</span>(<span class="hljs-title function_">fetchUser</span>()); <span class="hljs-comment">// 消费用户资源</span>
  <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">h2</span>&gt;</span>{user.name} 的仪表盘<span class="hljs-tag">&lt;/<span class="hljs-name">h2</span>&gt;</span></span>;
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">OrderList</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> orders = <span class="hljs-title function_">use</span>(<span class="hljs-title function_">fetchOrders</span>()); <span class="hljs-comment">// 消费订单资源</span>
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">h3</span>&gt;</span>我的订单<span class="hljs-tag">&lt;/<span class="hljs-name">h3</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">ul</span>&gt;</span>
        {orders.map((order) =&gt; (
          <span class="hljs-tag">&lt;<span class="hljs-name">li</span> <span class="hljs-attr">key</span>=<span class="hljs-string">{order.id}</span>&gt;</span>{order.title} - ￥{order.amount}<span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span>
        ))}
      <span class="hljs-tag">&lt;/<span class="hljs-name">ul</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
}

<span class="hljs-comment">// 3. ErrorBoundary 组件（统一捕获错误）</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">ErrorBoundary</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">React.Component</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">props</span>) {
    <span class="hljs-variable language_">super</span>(props);
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span> = { <span class="hljs-attr">hasError</span>: <span class="hljs-literal">false</span>, <span class="hljs-attr">error</span>: <span class="hljs-literal">null</span> };
  }

  <span class="hljs-keyword">static</span> <span class="hljs-title function_">getDerivedStateFromError</span>(<span class="hljs-params">error</span>) {
    <span class="hljs-keyword">return</span> { <span class="hljs-attr">hasError</span>: <span class="hljs-literal">true</span>, error };
  }

  <span class="hljs-title function_">render</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span>.<span class="hljs-property">hasError</span>) {
      <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>加载失败：{this.state.error.message}<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>;
    }
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">props</span>.<span class="hljs-property">children</span>;
  }
}

<span class="hljs-comment">// 4. 父组件：用 Suspense 包裹所有子组件，实现原生协调</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">UserDashboard</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">ErrorBoundary</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">Suspense</span> <span class="hljs-attr">fallback</span>=<span class="hljs-string">{</span>&lt;<span class="hljs-attr">div</span>&gt;</span>加载中...<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>}&gt;
        <span class="hljs-tag">&lt;<span class="hljs-name">UserInfo</span> /&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">OrderList</span> /&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">Suspense</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">ErrorBoundary</span>&gt;</span></span>
  );
}
</code></pre>
<p>核心简化点：</p>
<ul>
<li>去掉了所有手动管理的 loading、error、数据状态；</li>
<li>无需用 Promise.all 协调并行资源，Suspense 会自动收集 UserInfo 和 OrderList 中的两个资源，并行加载；</li>
<li>加载状态和错误状态分别由 Suspense 和 ErrorBoundary 统一处理，代码逻辑极度简洁。</li>
</ul>
<h3 data-id="heading-11">场景 2：依赖资源串行加载（通过嵌套 Suspense 实现）</h3>
<p>需求：先加载“用户信息”（获取 user.id），再根据 user.id 加载“订单列表”，最后根据 order.id 加载“订单详情”，串行执行，统一显示 loading。</p>
<p>实现思路：利用 <strong>嵌套 Suspense</strong> 实现串行加载。因为内层 Suspense 会等待外层 Suspense 中的资源加载完成后，才会渲染自身内容，从而触发内层资源的加载。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// React 19：嵌套 Suspense 实现串行资源加载</span>
<span class="hljs-keyword">import</span> { use, <span class="hljs-title class_">Suspense</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;

<span class="hljs-comment">// 异步请求函数（订单和详情依赖前序资源的 ID）</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">fetchUser</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> res = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetch</span>(<span class="hljs-string">'/api/user'</span>);
  <span class="hljs-keyword">if</span> (!res.<span class="hljs-property">ok</span>) <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">'用户信息加载失败'</span>);
  <span class="hljs-keyword">return</span> res.<span class="hljs-title function_">json</span>();
}

<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">fetchOrders</span>(<span class="hljs-params">userId</span>) {
  <span class="hljs-keyword">const</span> res = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetch</span>(<span class="hljs-string">`/api/orders?userId=<span class="hljs-subst">${userId}</span>`</span>);
  <span class="hljs-keyword">if</span> (!res.<span class="hljs-property">ok</span>) <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">'订单列表加载失败'</span>);
  <span class="hljs-keyword">return</span> res.<span class="hljs-title function_">json</span>();
}

<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">fetchOrderDetail</span>(<span class="hljs-params">orderId</span>) {
  <span class="hljs-keyword">const</span> res = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetch</span>(<span class="hljs-string">`/api/orders/<span class="hljs-subst">${orderId}</span>/detail`</span>);
  <span class="hljs-keyword">if</span> (!res.<span class="hljs-property">ok</span>) <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">'订单详情加载失败'</span>);
  <span class="hljs-keyword">return</span> res.<span class="hljs-title function_">json</span>();
}

<span class="hljs-comment">// 子组件 1：加载用户信息</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">User</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> user = <span class="hljs-title function_">use</span>(<span class="hljs-title function_">fetchUser</span>());
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">h2</span>&gt;</span>{user.name} 的订单详情<span class="hljs-tag">&lt;/<span class="hljs-name">h2</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">Suspense</span> <span class="hljs-attr">fallback</span>=<span class="hljs-string">{</span>&lt;<span class="hljs-attr">div</span>&gt;</span>加载订单列表中...<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>}&gt;
        <span class="hljs-tag">&lt;<span class="hljs-name">OrderList</span> <span class="hljs-attr">userId</span>=<span class="hljs-string">{user.id}</span> /&gt;</span> {/* 传入 user.id 给下一层 */}
      <span class="hljs-tag">&lt;/<span class="hljs-name">Suspense</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
}

<span class="hljs-comment">// 子组件 2：加载订单列表（依赖 user.id）</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">OrderList</span>(<span class="hljs-params">{ userId }</span>) {
  <span class="hljs-keyword">const</span> orders = <span class="hljs-title function_">use</span>(<span class="hljs-title function_">fetchOrders</span>(userId));
  <span class="hljs-keyword">const</span> firstOrder = orders[<span class="hljs-number">0</span>];
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>当前订单：{firstOrder.id}<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">Suspense</span> <span class="hljs-attr">fallback</span>=<span class="hljs-string">{</span>&lt;<span class="hljs-attr">div</span>&gt;</span>加载订单详情中...<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>}&gt;
        <span class="hljs-tag">&lt;<span class="hljs-name">OrderDetail</span> <span class="hljs-attr">orderId</span>=<span class="hljs-string">{firstOrder.id}</span> /&gt;</span> {/* 传入 order.id 给下一层 */}
      <span class="hljs-tag">&lt;/<span class="hljs-name">Suspense</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
}

<span class="hljs-comment">// 子组件 3：加载订单详情（依赖 order.id）</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">OrderDetail</span>(<span class="hljs-params">{ orderId }</span>) {
  <span class="hljs-keyword">const</span> detail = <span class="hljs-title function_">use</span>(<span class="hljs-title function_">fetchOrderDetail</span>(orderId));
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>商品：{detail.goodsName}<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>金额：￥{detail.amount}<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>状态：{detail.status}<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
}

<span class="hljs-comment">// 父组件：最外层 Suspense 统一管理整体加载状态</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">OrderDetailPage</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">ErrorBoundary</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">Suspense</span> <span class="hljs-attr">fallback</span>=<span class="hljs-string">{</span>&lt;<span class="hljs-attr">div</span>&gt;</span>整体加载中...<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>}&gt;
        <span class="hljs-tag">&lt;<span class="hljs-name">User</span> /&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">Suspense</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">ErrorBoundary</span>&gt;</span></span>
  );
}
</code></pre>
<p>核心逻辑：</p>
<ul>
<li>外层 Suspense 包裹 User 组件，等待 fetchUser 完成；</li>
<li>User 组件加载完成后，渲染内层 Suspense 和 OrderList 组件，触发 fetchOrders（依赖 user.id）；</li>
<li>OrderList 组件加载完成后，渲染最内层 Suspense 和 OrderDetail 组件，触发 fetchOrderDetail（依赖 order.id）；</li>
<li>整个过程是串行执行的，最外层 Suspense 会显示整体 loading，也可以为每一层设置单独的 fallback，实现更精细的加载状态展示。</li>
</ul>
<h3 data-id="heading-12">场景 3：混合加载策略（部分并行 + 部分串行）</h3>
<p>需求：加载“用户信息”后，并行加载“订单列表”和“用户收藏”，最后加载“订单详情”。即：串行（用户）→ 并行（订单+收藏）→ 串行（详情）。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// React 19：混合加载策略（串行+并行）</span>
<span class="hljs-keyword">import</span> { use, <span class="hljs-title class_">Suspense</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;

<span class="hljs-comment">// 异步请求函数</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">fetchUser</span>(<span class="hljs-params"/>) { <span class="hljs-comment">/* ... */</span> }
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">fetchOrders</span>(<span class="hljs-params">userId</span>) { <span class="hljs-comment">/* ... */</span> }
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">fetchCollections</span>(<span class="hljs-params">userId</span>) { <span class="hljs-comment">/* ... */</span> }
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">fetchOrderDetail</span>(<span class="hljs-params">orderId</span>) { <span class="hljs-comment">/* ... */</span> }

<span class="hljs-comment">// 并行加载订单和收藏的组件</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">OrderAndCollection</span>(<span class="hljs-params">{ userId }</span>) {
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      {/* 两个组件并行加载，由内层 Suspense 协调 */}
      <span class="hljs-tag">&lt;<span class="hljs-name">OrderList</span> <span class="hljs-attr">userId</span>=<span class="hljs-string">{userId}</span> /&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">CollectionList</span> <span class="hljs-attr">userId</span>=<span class="hljs-string">{userId}</span> /&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
}

<span class="hljs-comment">// 订单列表组件</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">OrderList</span>(<span class="hljs-params">{ userId }</span>) {
  <span class="hljs-keyword">const</span> orders = <span class="hljs-title function_">use</span>(<span class="hljs-title function_">fetchOrders</span>(userId));
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">h3</span>&gt;</span>我的订单<span class="hljs-tag">&lt;/<span class="hljs-name">h3</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">ul</span>&gt;</span>{orders.map(o =&gt; <span class="hljs-tag">&lt;<span class="hljs-name">li</span> <span class="hljs-attr">key</span>=<span class="hljs-string">{o.id}</span>&gt;</span>{o.title}<span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span>)}<span class="hljs-tag">&lt;/<span class="hljs-name">ul</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
}

<span class="hljs-comment">// 收藏列表组件</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">CollectionList</span>(<span class="hljs-params">{ userId }</span>) {
  <span class="hljs-keyword">const</span> collections = <span class="hljs-title function_">use</span>(<span class="hljs-title function_">fetchCollections</span>(userId));
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">h3</span>&gt;</span>我的收藏<span class="hljs-tag">&lt;/<span class="hljs-name">h3</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">ul</span>&gt;</span>{collections.map(c =&gt; <span class="hljs-tag">&lt;<span class="hljs-name">li</span> <span class="hljs-attr">key</span>=<span class="hljs-string">{c.id}</span>&gt;</span>{c.name}<span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span>)}<span class="hljs-tag">&lt;/<span class="hljs-name">ul</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
}

<span class="hljs-comment">// 订单详情组件</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">OrderDetail</span>(<span class="hljs-params">{ orderId }</span>) {
  <span class="hljs-keyword">const</span> detail = <span class="hljs-title function_">use</span>(<span class="hljs-title function_">fetchOrderDetail</span>(orderId));
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">h3</span>&gt;</span>订单详情<span class="hljs-tag">&lt;/<span class="hljs-name">h3</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>商品：{detail.goodsName}<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
}

<span class="hljs-comment">// 父组件：通过嵌套 Suspense 实现混合策略</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">MixedLoadPage</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">ErrorBoundary</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">Suspense</span> <span class="hljs-attr">fallback</span>=<span class="hljs-string">{</span>&lt;<span class="hljs-attr">div</span>&gt;</span>加载用户信息中...<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>}&gt;
        <span class="hljs-tag">&lt;<span class="hljs-name">UserWrapper</span> /&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">Suspense</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">ErrorBoundary</span>&gt;</span></span>
  );
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">UserWrapper</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> user = <span class="hljs-title function_">use</span>(<span class="hljs-title function_">fetchUser</span>());
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">h2</span>&gt;</span>{user.name} 的个人中心<span class="hljs-tag">&lt;/<span class="hljs-name">h2</span>&gt;</span>
      {/* 并行加载订单和收藏 */}
      <span class="hljs-tag">&lt;<span class="hljs-name">Suspense</span> <span class="hljs-attr">fallback</span>=<span class="hljs-string">{</span>&lt;<span class="hljs-attr">div</span>&gt;</span>加载订单和收藏中...<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>}&gt;
        <span class="hljs-tag">&lt;<span class="hljs-name">OrderAndCollection</span> <span class="hljs-attr">userId</span>=<span class="hljs-string">{user.id}</span> /&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">Suspense</span>&gt;</span>
      {/* 加载订单详情（依赖订单列表） */}
      <span class="hljs-tag">&lt;<span class="hljs-name">Suspense</span> <span class="hljs-attr">fallback</span>=<span class="hljs-string">{</span>&lt;<span class="hljs-attr">div</span>&gt;</span>加载订单详情中...<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>}&gt;
        <span class="hljs-tag">&lt;<span class="hljs-name">OrderDetail</span> <span class="hljs-attr">orderId</span>=<span class="hljs-string">"123"</span> /&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">Suspense</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
}
</code></pre>
<p>核心思路：通过“不同层级的 Suspense 包裹不同的资源组合”，实现混合加载策略。外层 Suspense 管理串行环节，内层 Suspense 管理并行环节，逻辑清晰，可扩展性强。</p>
<h3 data-id="heading-13">场景 4：动态资源加载（根据用户操作加载资源）</h3>
<p>需求：页面初始只加载“用户信息”，用户点击“查看订单”按钮后，再加载“订单列表”，点击按钮时显示 loading。</p>
<p>实现思路：用 useState 控制动态资源的加载时机，只有当用户点击按钮后，才渲染依赖订单资源的组件，Suspense 会自动捕获这个动态加载的资源。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// React 19：动态资源加载（用户操作触发）</span>
<span class="hljs-keyword">import</span> { use, <span class="hljs-title class_">Suspense</span>, useState } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;

<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">fetchUser</span>(<span class="hljs-params"/>) { <span class="hljs-comment">/* ... */</span> }
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">fetchOrders</span>(<span class="hljs-params">userId</span>) { <span class="hljs-comment">/* ... */</span> }

<span class="hljs-comment">// 订单列表组件（动态加载）</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">OrderList</span>(<span class="hljs-params">{ userId }</span>) {
  <span class="hljs-keyword">const</span> orders = <span class="hljs-title function_">use</span>(<span class="hljs-title function_">fetchOrders</span>(userId));
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">ul</span>&gt;</span>
      {orders.map(o =&gt; <span class="hljs-tag">&lt;<span class="hljs-name">li</span> <span class="hljs-attr">key</span>=<span class="hljs-string">{o.id}</span>&gt;</span>{o.title} - ￥{o.amount}<span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span>)}
    <span class="hljs-tag">&lt;/<span class="hljs-name">ul</span>&gt;</span></span>
  );
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">UserPage</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> user = <span class="hljs-title function_">use</span>(<span class="hljs-title function_">fetchUser</span>());
  <span class="hljs-keyword">const</span> [showOrders, setShowOrders] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">false</span>); <span class="hljs-comment">// 控制是否加载订单</span>

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">h2</span>&gt;</span>{user.name} 的页面<span class="hljs-tag">&lt;/<span class="hljs-name">h2</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span> =&gt;</span> setShowOrders(true)}&gt;查看订单<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>

      {/* 动态加载订单资源：只有 showOrders 为 true 时才渲染 */}
      {showOrders &amp;&amp; (
        <span class="hljs-tag">&lt;<span class="hljs-name">Suspense</span> <span class="hljs-attr">fallback</span>=<span class="hljs-string">{</span>&lt;<span class="hljs-attr">div</span>&gt;</span>加载订单中...<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>}&gt;
          <span class="hljs-tag">&lt;<span class="hljs-name">OrderList</span> <span class="hljs-attr">userId</span>=<span class="hljs-string">{user.id}</span> /&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">Suspense</span>&gt;</span>
      )}
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
}

<span class="hljs-comment">// 父组件</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">DynamicLoadPage</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">ErrorBoundary</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">Suspense</span> <span class="hljs-attr">fallback</span>=<span class="hljs-string">{</span>&lt;<span class="hljs-attr">div</span>&gt;</span>加载用户信息中...<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>}&gt;
        <span class="hljs-tag">&lt;<span class="hljs-name">UserPage</span> /&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">Suspense</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">ErrorBoundary</span>&gt;</span></span>
  );
}
</code></pre>
<p>核心逻辑：</p>
<ul>
<li>初始状态下，showOrders 为 false，OrderList 组件不渲染，fetchOrders 不会被触发；</li>
<li>用户点击按钮后，showOrders 变为 true，OrderList 组件渲染，use(fetchOrders()) 触发请求；</li>
<li>Suspense 捕获 fetchOrders 的加载状态，显示 fallback，加载完成后展示订单列表。</li>
</ul>
<h2 data-id="heading-14">四、避坑指南：使用 Suspense 原生协调的 6 个关键注意点</h2>
<p>在实际使用过程中，有几个容易踩坑的点，需要特别注意，避免出现状态混乱或性能问题。</p>
<h3 data-id="heading-15">1. 必须配合 use() 消费资源</h3>
<p>Suspense 原生协调只能感知通过 <code>use()</code> 消费的异步资源（或通过 <code>React.lazy</code> 加载的组件）。如果直接在组件中用 Promise.then 处理异步请求，Suspense 无法捕获其状态，无法进行协调。</p>
<p>错误示例：</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// 错误：直接用 Promise.then，Suspense 无法感知</span>
function <span class="hljs-built_in">OrderList</span>() {
  const <span class="hljs-selector-attr">[orders, setOrders]</span> = <span class="hljs-built_in">useState</span>(null);
  <span class="hljs-built_in">useEffect</span>(() =&gt; {
    <span class="hljs-built_in">fetchOrders</span>()<span class="hljs-selector-class">.then</span>(setOrders);
  }, <span class="hljs-selector-attr">[]</span>);
  return &lt;<span class="hljs-selector-tag">ul</span>&gt;{orders<span class="hljs-selector-class">.map</span>(o =&gt; &amp;lt;li key={o.id}&amp;gt;{o.title}&amp;lt;/li&amp;gt;)}&amp;lt;/<span class="hljs-selector-tag">ul</span>&amp;gt;;
}
</code></pre>
<p>正确示例：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 正确：用 use() 消费资源，Suspense 可感知</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">OrderList</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> orders = <span class="hljs-title function_">use</span>(<span class="hljs-title function_">fetchOrders</span>());
  <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">ul</span>&gt;</span>{orders.map(o =&gt; <span class="hljs-tag">&lt;<span class="hljs-name">li</span> <span class="hljs-attr">key</span>=<span class="hljs-string">{o.id}</span>&gt;</span>{o.title}<span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span>)}<span class="hljs-tag">&lt;/<span class="hljs-name">ul</span>&gt;</span></span>;
}
</code></pre>
<h3 data-id="heading-16">2. 错误必须用 ErrorBoundary 捕获</h3>
<p>Suspense 只处理“加载中”状态，不处理“加载失败”状态。如果任何一个资源加载失败，会抛出错误，必须用 ErrorBoundary 组件捕获，否则会导致整个应用崩溃。</p>
<h3 data-id="heading-17">3. 嵌套 Suspense 的 fallback 优先级</h3>
<p>当存在嵌套 Suspense 时，<strong>内层 Suspense 的 fallback 会覆盖外层的 fallback</strong>。如果需要显示整体加载状态，可以在最外层设置一个全局 fallback，内层设置局部 fallback，实现分层加载提示。</p>
<h3 data-id="heading-18">4. 避免过度嵌套 Suspense</h3>
<p>虽然嵌套 Suspense 可以实现复杂的加载策略，但过度嵌套会增加 React 的协调成本，影响性能。建议根据实际需求，合理划分 Suspense 的层级，避免不必要的嵌套。</p>
<h3 data-id="heading-19">5. 动态资源加载的状态重置</h3>
<p>当动态加载的资源（如场景 4 中的订单列表）需要重新加载时（比如用户切换了用户 ID），只需修改资源依赖的参数（如 userId），Suspense 会自动重新协调，触发新的请求，无需手动重置状态。</p>
<h3 data-id="heading-20">6. 不支持同步资源的协调</h3>
<p>Suspense 原生协调只针对“异步资源”（返回 Promise 的资源）。如果资源是同步的（如直接导入的静态数据），Suspense 不会对其进行协调，会直接渲染内容。</p>
<h2 data-id="heading-21">五、核心总结</h2>
<p>今天我们详细拆解了 React 19 Suspense 原生协调的核心原理和实战用法，核心要点总结如下：</p>
<ol start="4">
<li>
<p><strong>核心价值</strong>：Suspense 从“单个资源加载容器”升级为“多资源协调器”，自动感知并协调多个异步资源的加载状态，支持并行、串行、混合等多种加载策略，彻底消除资源加载的模板代码；</p>
</li>
<li>
<p><strong>核心原理</strong>：通过“资源收集-加载协调-状态统一”三步流程，结合 use() 的增强和资源依赖追踪机制，实现多资源的自动协调；</p>
</li>
<li>
<p><strong>实战关键</strong>：</p>
<ol>
<li>并行加载：用一个 Suspense 包裹所有资源组件；</li>
<li>串行加载：用嵌套 Suspense 按依赖顺序包裹组件；</li>
<li>动态加载：用状态控制资源组件的渲染时机；</li>
<li>错误处理：必须配合 ErrorBoundary 统一捕获错误。</li>
</ol>
</li>
<li>
<p><strong>避坑要点</strong>：必须用 use() 消费资源，避免过度嵌套，错误处理不能少。</p>
</li>
</ol>
<h2 data-id="heading-22">六、进阶学习方向</h2>
<p>掌握了 Suspense 原生协调的基础用法后，可以进一步学习以下内容，深化理解：</p>
<ul>
<li>Suspense 与 React 19 Action 的协同：如何用 Action 处理表单提交后的资源重新加载；</li>
<li>Suspense 服务器组件（Server Components）的结合：在服务端渲染场景下如何优化资源加载；</li>
<li>资源预加载策略：如何通过 preload 等方式优化 Suspense 的加载体验；</li>
<li>源码阅读：查看 React 19 源码中 Suspense 协调器的实现（重点看 react-reconciler 包中的 Suspense相关逻辑）。</li>
</ul>
<p>如果这篇文章对你有帮助，欢迎点赞、收藏、转发～ 有任何问题也可以在评论区留言交流～ 我们下期再见！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[InheritableThreadLocal从入门到放弃]]></title>    <link>https://juejin.cn/post/7595771085393100851</link>    <guid>https://juejin.cn/post/7595771085393100851</guid>    <pubDate>2026-01-16T07:37:49.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7595771085393100851" data-draft-id="7595513077221031982" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="InheritableThreadLocal从入门到放弃"/> <meta itemprop="keywords" content="程序员"/> <meta itemprop="datePublished" content="2026-01-16T07:37:49.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="京东云开发者"/> <meta itemprop="url" content="https://juejin.cn/user/2634854380340008"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            InheritableThreadLocal从入门到放弃
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2634854380340008/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    京东云开发者
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-16T07:37:49.000Z" title="Fri Jan 16 2026 07:37:49 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-16
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读14分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>作者：田超辉</p>
<h2 data-id="heading-0">背景：</h2>
<p>一个上线了很久但是请求量很低(平均每天一两次)的历史功能突然出现空指针报错：</p>
<p>﻿</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8380d11214154ca3aa1ede7eee0545aa~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769153869&amp;x-signature=lNRjruk4rpSlLh5PfSXQySnxpTw%3D" alt="" loading="lazy"/></p>
<p>﻿﻿</p>
<p>我们翻开代码定位到对应的报错代码：</p>
<p>﻿</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4e753899bf0648b5b420f592accee9ab~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769153869&amp;x-signature=CKX7XSnUlViROzcJ4fZ0BtOvDoc%3D" alt="" loading="lazy"/></p>
<p>﻿﻿</p>
<p>结合堆栈和代码可以确定是由于bdIdJobMap的值为null导致往bdIdEmployeeJobMap这个map中putAll的时候空指针了。</p>
<p>而bdIdJobMap又取自employeeJobMapThread.get(); 那么这个employeeJobMapThread又是何物？</p>
<p>﻿</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7a90ab3d7ce7464ea281c7ec4c9c9482~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769153869&amp;x-signature=mUEQtevsu7H%2Fvrz6fgm2xUXhSiw%3D" alt="" loading="lazy"/></p>
<p>﻿﻿</p>
<p>哦豁，employeeJobMapThread居然是个InheritableThreadLocal。</p>
<p>梳理一下报错代码的上下文逻辑如下：</p>
<p>1.首先在当前主线程中对InheritableThreadLocal类型变量employeeJobMapThread进行赋值</p>
<p>2.把耗时操作提交到线程池中异步执行，在异步任务中去获取employeeJobMapThread的值（其中线程池配置的coreSize/maxSize均为4，queue大小为3000）</p>
<p>3.在主线程中执行employeeJobMapThread.remove()，在异步任务完成之后没有执行employeeJobMapThread.remove()</p>
<p>4.最后在异步任务中通过employeeJobMapThread获取到的值为null导致后续操作空指针</p>
<p>﻿</p>
<h2 data-id="heading-1">是否和最近的上线有关？</h2>
<p>相信大家都有这样的共识：线上出现报错，首先怀疑是否和最近的上线有关系。</p>
<p>我们做的第一件事情也是排查了近期的上线功能，从上线的功能点和相关代码上来看都和这次报错的代码没什么关系，</p>
<p>因此初步排除了这个原因。所以接下来只能进一步了解代码来排查原因了。</p>
<p>要搞清楚当前报错的根因，毫无疑问肯定是要翻过InheritableThreadLocal这座小山啦。</p>
<p>﻿</p>
<h2 data-id="heading-2">简单聊下InheritableThreadLocal：</h2>
<p>提起ThreadLocal，大家应该相对都比较熟悉了，比如存放登录用户信息到ThreadLocal变量中，然后在接口层可以比较方便的获取登录用户，帮助开发提效。</p>
<p>但是对于InheritableThreadLocal，有不少同学都不太了解。</p>
<p>挑重点来说，InheritableThreadLocal相比ThreadLocal多一个能力：在创建子线程Thread时，子线程Thread会自动继承父线程的InheritableThreadLocal信息到子线程中，进而实现在在子线程获取父线程的InheritableThreadLocal值的目的。</p>
<p>举个简单的栗子对比下InheritableThreadLocal和ThreadLocal：</p>
<pre><code class="hljs language-csharp" lang="csharp">
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">InheritableThreadLocalTest</span> {

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> final ThreadLocal&lt;String&gt; threadLocal = <span class="hljs-keyword">new</span> ThreadLocal&lt;&gt;();
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> final InheritableThreadLocal&lt;String&gt; inheritableThreadLocal = <span class="hljs-keyword">new</span> InheritableThreadLocal&lt;&gt;();

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span>(<span class="hljs-params">String[] args</span>)</span> {
        testThreadLocal();
        testInheritableThreadLocal();
    }

    <span class="hljs-comment">/**
     * threadLocal测试
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testThreadLocal</span>()</span> {
        <span class="hljs-comment">// 在主线程中设置值到threadLocal</span>
        threadLocal.<span class="hljs-keyword">set</span>(<span class="hljs-string">"我是父线程threadLocal的值"</span>);

        <span class="hljs-comment">// 创建一个新线程并启动</span>
        <span class="hljs-keyword">new</span> Thread(() -&gt; {
            <span class="hljs-comment">// 在子线程里面无法获取到父线程设置的threadLocal，结果为null</span>
            System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"从子线程获取到threadLocal的值: "</span> + threadLocal.<span class="hljs-keyword">get</span>());
        }).start();
    }

    <span class="hljs-comment">/**
     * inheritableThreadLocal测试
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testInheritableThreadLocal</span>()</span> {
        <span class="hljs-comment">// 在主线程中设置一个值到inheritableThreadLocal</span>
        inheritableThreadLocal.<span class="hljs-keyword">set</span>(<span class="hljs-string">"我是父线程inheritableThreadLocal的值"</span>);

        <span class="hljs-comment">// 创建一个新线程并启动</span>
        <span class="hljs-keyword">new</span> Thread(() -&gt; {
            <span class="hljs-comment">// 在子线程里面可以自动获取到父线程设置的inheritableThreadLocal</span>
            System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"从子线程获取到inheritableThreadLocal的值: "</span> + inheritableThreadLocal.<span class="hljs-keyword">get</span>());
        }).start();
    }

}
</code></pre>
<p>执行结果：</p>
<p>﻿</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a27e0ced731d449a9422895fdee5fa21~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769153869&amp;x-signature=1hL1sus%2FV6jSF6Bi1VeFiWZ6oN8%3D" alt="" loading="lazy"/></p>
<p>﻿﻿</p>
<p>可以看到子线程中可以获取到父线程设置的inheritableThreadLocal值，但不能获取到父线程设置的threadLocal值。</p>
<p>为什么InheritableThreadLocal能够做到这点呢？</p>
<p>是因为在父线程创建子线程Thread的时候，Thread的构造器内部会自动继承父线程的InheritableThreadLocal到子线程。</p>
<p>Thread源码这两处地方解释了原因：</p>
<p>﻿</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/29640a537a864efba81c146cd6d4bdd9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769153869&amp;x-signature=sBTcTh2NFsxVBa%2BbsOce6IVUnpM%3D" alt="" loading="lazy"/></p>
<p>﻿﻿</p>
<p>init方法内部实现：</p>
<p>﻿</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/254227b472ae40ec981fd97a27d667d0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769153869&amp;x-signature=Oc8n%2FZtoMYleuxcPSS1t%2BhFN1BA%3D" alt="" loading="lazy"/></p>
<p>﻿﻿</p>
<p>﻿</p>
<p>通过这个简单的介绍可以帮助对于InheritableThreadLocal不了解的同学有一个初步的了解，本文不是专门介绍InheritableThreadLocal的深入原理，所以就不展开聊了，大家感兴趣可以自己进一步探索。</p>
<h2 data-id="heading-3">验证InheritableThreadLocal+线程池：</h2>
<p>前面介绍了InheritableThreadLocal可以自动把父线程的InheritableThreadLocal信息继承到子线程Thread中。</p>
<p>但是在业务项目中真正需要用到子线程的时候正经人谁自己new Thread，咱可是用线程池的。</p>
<p>当然了，就像文章开头说明的，这次报错的代码里面也用线程池来执行异步任务。</p>
<p>那么InheritableThreadLocal+线程池的组合会摩擦出什么样的火花呢？</p>
<p>我把这次报错的代码精简之后得到下面的示例（实际代码中往InheritableThreadLocal赋的值类型不是字符串，后面会提到）：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> com.dada.bd.data.service;

<span class="hljs-keyword">import</span> java.util.concurrent.LinkedBlockingQueue;
<span class="hljs-keyword">import</span> java.util.concurrent.ThreadPoolExecutor;
<span class="hljs-keyword">import</span> java.util.concurrent.TimeUnit;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">InheritableThreadLocalWithThreadPoolTest</span> {

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> InheritableThreadLocal&lt;String&gt; inheritableThreadLocal = <span class="hljs-keyword">new</span> <span class="hljs-title class_">InheritableThreadLocal</span>&lt;&gt;();
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">ThreadPoolExecutor</span> <span class="hljs-variable">threadPoolExecutor</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ThreadPoolExecutor</span>(
            <span class="hljs-number">2</span>,
            <span class="hljs-number">2</span>,
            <span class="hljs-number">0L</span>,
            TimeUnit.MILLISECONDS,
            <span class="hljs-keyword">new</span> <span class="hljs-title class_">LinkedBlockingQueue</span>&lt;Runnable&gt;(<span class="hljs-number">3000</span>),
            <span class="hljs-keyword">new</span> <span class="hljs-title class_">ThreadPoolExecutor</span>.CallerRunsPolicy()
    );

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        testInheritableThreadLocalWithThreadPool();
        threadPoolExecutor.shutdown();
    }

    <span class="hljs-comment">/**
     * inheritableThreadLocal+线程池测试
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testInheritableThreadLocalWithThreadPool</span><span class="hljs-params">()</span> {
        <span class="hljs-comment">// 1. 在主线程中设置一个值到inheritableThreadLocal</span>
        inheritableThreadLocal.set(<span class="hljs-string">"我是父线程inheritableThreadLocal的值"</span>);

        <span class="hljs-comment">// 2. 提交异步任务到线程池</span>
        threadPoolExecutor.execute(() -&gt; {
            <span class="hljs-comment">// 3. 在线程池-子线程里面可以获取到父线程设置的inheritableThreadLocal吗？</span>
            System.out.println(<span class="hljs-string">"从线程池-子线程获取到inheritableThreadLocal的值: "</span> + inheritableThreadLocal.get());
        });

        <span class="hljs-comment">// 4. 清除inheritableThreadLocal</span>
        inheritableThreadLocal.remove();
    }

}
</code></pre>
<p>﻿</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/65927ab9fd254ce889a230fadecc03c0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769153869&amp;x-signature=JekI5yxB4la9CisD6N%2Bx4qZ5sII%3D" alt="" loading="lazy"/></p>
<p>﻿﻿</p>
<p>执行结果如图所示，可以看到在线程池里面也可以获取到父线程设置的inheritableThreadLocal值。</p>
<p>接下来我们来分析下InheritableThreadLocal+线程池的执行过程：</p>
<p>﻿</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0d855bd2f3a949e08b221a9a2a80fd00~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769153869&amp;x-signature=PV28SF83kkUQRHLZEiefGOhyI3w%3D" alt="" loading="lazy"/></p>
<p>﻿</p>
<p>也就说只有在以下这两个场景下才会继承父线程的InheritableThreadLocal：</p>
<p>1.线程池当前线程数 &lt; 核心线程数</p>
<p>2.线程池当前线程数 &gt;= 核心线程数 &amp;&amp; 队列已满 &amp;&amp; 线程数 &lt; 最大线程数（本次线上报错的代码使用的线程池设置的coreSize和maxSize一致，所以走不到该场景）</p>
<p>其他情况都是在复用线程池现有的Thread，自然也就不会继承父线程的InheritableThreadLocal。</p>
<p>我们提交多个异步任务到线程池来验证下：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> com.dada.bd.data.service;

<span class="hljs-keyword">import</span> java.util.concurrent.LinkedBlockingQueue;
<span class="hljs-keyword">import</span> java.util.concurrent.ThreadPoolExecutor;
<span class="hljs-keyword">import</span> java.util.concurrent.TimeUnit;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">InheritableThreadLocalWithThreadPoolTest</span> {

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> InheritableThreadLocal&lt;String&gt; inheritableThreadLocal = <span class="hljs-keyword">new</span> <span class="hljs-title class_">InheritableThreadLocal</span>&lt;&gt;();
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">ThreadPoolExecutor</span> <span class="hljs-variable">threadPoolExecutor</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ThreadPoolExecutor</span>(
            <span class="hljs-number">2</span>,
            <span class="hljs-number">2</span>,
            <span class="hljs-number">0L</span>,
            TimeUnit.MILLISECONDS,
            <span class="hljs-keyword">new</span> <span class="hljs-title class_">LinkedBlockingQueue</span>&lt;Runnable&gt;(<span class="hljs-number">3000</span>),
            <span class="hljs-keyword">new</span> <span class="hljs-title class_">ThreadPoolExecutor</span>.CallerRunsPolicy()
    );

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        testInheritableThreadLocalWithThreadPool(<span class="hljs-string">"张三"</span>);
        testInheritableThreadLocalWithThreadPool(<span class="hljs-string">"李四"</span>);
        testInheritableThreadLocalWithThreadPool(<span class="hljs-string">"王五"</span>);
        testInheritableThreadLocalWithThreadPool(<span class="hljs-string">"赵六"</span>);
        testInheritableThreadLocalWithThreadPool(<span class="hljs-string">"孙七"</span>);
        threadPoolExecutor.shutdown();
    }

    <span class="hljs-comment">/**
     * inheritableThreadLocal+线程池测试
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testInheritableThreadLocalWithThreadPool</span><span class="hljs-params">(String param)</span> {
        <span class="hljs-comment">// 1. 在主线程中设置一个值到inheritableThreadLocal</span>
        inheritableThreadLocal.set(param);

        <span class="hljs-comment">// 2. 提交异步任务到线程池</span>
        threadPoolExecutor.execute(() -&gt; {
            <span class="hljs-comment">// 3. 在线程池-子线程里面可以获取到父线程设置的inheritableThreadLocal吗？</span>
            System.out.println(<span class="hljs-string">"线程名: "</span> + Thread.currentThread().getName() + <span class="hljs-string">", 父线程设置的inheritableThreadLocal值: "</span> + param + <span class="hljs-string">", 子线程获取到inheritableThreadLocal的值: "</span> + inheritableThreadLocal.get());
        });

        <span class="hljs-comment">// 4. 清除inheritableThreadLocal</span>
        inheritableThreadLocal.remove();
    }

}
</code></pre>
<p>﻿</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5c89ea48a0e742979b98f8b6c0931014~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769153869&amp;x-signature=9B1N%2F47SLWKdWmw0pLtTvQPkHlU%3D" alt="" loading="lazy"/></p>
<p>﻿</p>
<p>执行结果用表格形式展示如下：</p>






























<table><thead><tr><th>步骤</th><th>使用线程池</th><th>结果解释说明</th></tr></thead><tbody><tr><td>提交第一个异步任务值为【张三】</td><td>创建Thread：pool-1-thread-1</td><td>自动继承父线程的InheritableThreadLocal值【张三】到pool-1-thread-1</td></tr><tr><td>提交第二个异步任务值为【李四】</td><td>创建Thread：pool-1-thread-2</td><td>自动继承父线程的InheritableThreadLocal值【李四】到pool-1-thread-2</td></tr><tr><td>提交第三个异步任务值为【王五】</td><td>复用Thread：pool-1-thread-1</td><td>没有自动继承父线程的InheritableThreadLocal值【王五】，所以拿到了第一个任务提交时Thread继承下来的值【张三】</td></tr><tr><td>提交第四个异步任务值为【赵六】</td><td>复用Thread：pool-1-thread-2</td><td>没有自动继承父线程的InheritableThreadLocal值【赵六】，所以拿到了第一个任务提交时Thread继承下来的值【李四】</td></tr></tbody></table>
<p><strong>可以看到InheritableThreadLocal+线程池的组合，会面临InheritableThreadLocal污染的问题，即异步任务可能取到其他父线程设置的InheritableThreadLocal值。</strong></p>
<p>有同学会提到我们不是在代码里面加了inheritableThreadLocal.remove()来清除inheritableThreadLocal的吗？为什么没有清除掉呢？</p>
<p>这是因为此时我们清除的只是父线程的inheritableThreadLocal，而没有清除子线程的inheritableThreadLocal的缘故。</p>
<p>﻿</p>
<h2 data-id="heading-4">为什么InheritableThreadLocal污染对线上没有产生影响？</h2>
<p>既然InheritableThreadLocal+线程池的组合，会存在InheritableThreadLocal污染的问题，那岂不是线上报错的这段代码也存在这个问题？</p>
<p>再次检查代码，确认历史代码的确存在这个问题，</p>
<p>但是，这个代码上线2年多为啥一直稳定运行且没有用户反馈过功能有问题？只有最近突然出现报错？一时之间脑袋懵懵的。</p>
<p>﻿</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ef1c66e8947748688c007ad7de5b3089~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769153869&amp;x-signature=RWhvCgfynIz91Xgnmv8Ojil9hvE%3D" alt="" loading="lazy"/></p>
<p>﻿﻿</p>
<p>仔细检代码之后发现：</p>
<p>这段代码在父子线程之间通过InheritableThreadLocal类型变量employeeJobMapThread传递的值是【全量的&lt;人员Id, 该人员基本信息&gt;结构的map】，可以近乎看做是一个不变的常量，所以虽然异步任务会拿到污染的数据，也是正常可以用的，没有产生业务影响。</p>
<p>这种感觉怎么说呢，只能说感叹前人的智慧，把几乎不可能做到了可能~</p>
<p>好了，到这里我们解释了为什么这段代码上线这么久一直没问题，<strong>因为代码确实有InheritableThreadLocal污染问题，但被污染了也不影响使用。。。所以从最终结果来看确实可以正常运行。</strong></p>
<p>﻿</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1b1a0c1c64314867a7a181d04306b3fd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769153869&amp;x-signature=wI8FplIjVejiaiVxWKw%2FTxvOghc%3D" alt="" loading="lazy"/></p>
<p>﻿﻿</p>
<p>﻿</p>
<h2 data-id="heading-5">什么原因导致子线程获取到的InheritableThreadLocal值是null？</h2>
<p>但是。。。说了这么多，还是不能解释为什么线上代码获取到的inheritableThreadLocal值会是null。</p>
<p>1.难道父线程设置的inheritableThreadLocal值可能会是null？</p>
<p>检查代码发现父线程设置的inheritableThreadLocal不可能为null，顶多会是空集合：</p>
<p>﻿</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6a80e4335b56443fbc540d1c2c701d94~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769153869&amp;x-signature=OIHRC0xFlp8KPnfvg6yYLTj80TU%3D" alt="" loading="lazy"/></p>
<p>﻿﻿</p>
<p>﻿</p>
<p>2.难道是线程池创建之后通过prestartAllCoreThreads初始化了核心线程，在执行异步任务的时候，都是复用的已有线程导致的？</p>
<p>检查了对应线程池的初始化代码，发现并没有初始化核心线程，也排除了这个可能。而且如果真的是该原因22年上线之后功能一定是有问题的，前面说过，该功能上线之后没人反馈过异常，所以也可以排除该原因。</p>
<p>﻿</p>
<p>•该功能22年上线之间2年多一直没人反馈，大概率该功能之前很长时间是正常的，近期由于某个原因导致功能异常</p>
<p>•虽然历史代码的用法存在子任务中获取到的InheritableThreadLocal被污染的问题，但是被污染的值也能用，不影响正确性</p>
<p>•只要线程池中的线程初始化的时候继承了正确的InheritableThreadLocal值，后续就不会被清除掉，也就可以正常运行功能</p>
<p>从这些已知的信息来推断，可以推断出这段历史代码写法虽然有隐患，但是不是引发当前空指针的的原因。</p>
<p>3.剩下的只有一种可能：<strong>存在线程池的共用。</strong></p>
<p><strong>在执行这个报错的异步任务的时候，复用了某个已有的线程A，并且当时创建该线程A的时候，没有继承InheritableThreadLocal，进而导致后面复用该线程的时候，从InheritableThreadLocal获取到的值为null。</strong></p>
<p><strong>而只要是通过这段历史代码创建的线程一定是没问题的，所以一定是存在其他业务共用了这个线程池，并且这个业务优先执行进而初始化了线程池的线程，导致线程池的线程没有继承InheritableThreadLocal。</strong></p>
<p>如下代码示例：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> com.dada.bd.data.service;

<span class="hljs-keyword">import</span> java.util.concurrent.LinkedBlockingQueue;
<span class="hljs-keyword">import</span> java.util.concurrent.ThreadPoolExecutor;
<span class="hljs-keyword">import</span> java.util.concurrent.TimeUnit;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">InheritableThreadLocalWithThreadPoolTest</span> {

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> InheritableThreadLocal&lt;String&gt; inheritableThreadLocal = <span class="hljs-keyword">new</span> <span class="hljs-title class_">InheritableThreadLocal</span>&lt;&gt;();
    <span class="hljs-comment">// 这里线程池core/max数量都只有2</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">ThreadPoolExecutor</span> <span class="hljs-variable">threadPoolExecutor</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ThreadPoolExecutor</span>(
            <span class="hljs-number">2</span>,
            <span class="hljs-number">2</span>,
            <span class="hljs-number">0L</span>,
            TimeUnit.MILLISECONDS,
            <span class="hljs-keyword">new</span> <span class="hljs-title class_">LinkedBlockingQueue</span>&lt;Runnable&gt;(<span class="hljs-number">3000</span>),
            <span class="hljs-keyword">new</span> <span class="hljs-title class_">ThreadPoolExecutor</span>.CallerRunsPolicy()
    );

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-comment">// 先执行了不涉及InheritableThreadLocal的子任务初始化线程池线程</span>
        testAnotherFunction();
        testAnotherFunction();
        <span class="hljs-comment">// 后执行了本次的历史代码，其涉及InheritableThreadLocal</span>
        testInheritableThreadLocalWithThreadPool(<span class="hljs-string">"张三"</span>);
        testInheritableThreadLocalWithThreadPool(<span class="hljs-string">"李四"</span>);
        threadPoolExecutor.shutdown();
    }

    <span class="hljs-comment">/**
     * inheritableThreadLocal+线程池测试
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testInheritableThreadLocalWithThreadPool</span><span class="hljs-params">(String param)</span> {
        <span class="hljs-comment">// 1. 在主线程中设置一个值到inheritableThreadLocal</span>
        inheritableThreadLocal.set(param);

        <span class="hljs-comment">// 2. 提交异步任务到线程池</span>
        threadPoolExecutor.execute(() -&gt; {
            <span class="hljs-comment">// 3. 在线程池-子线程里面可以获取到父线程设置的inheritableThreadLocal吗？</span>
            System.out.println(<span class="hljs-string">"线程名: "</span> + Thread.currentThread().getName() + <span class="hljs-string">", 父线程设置的inheritableThreadLocal值: "</span> + param + <span class="hljs-string">", 子线程获取到inheritableThreadLocal的值: "</span> + inheritableThreadLocal.get());
        });

        <span class="hljs-comment">// 4. 清除inheritableThreadLocal</span>
        inheritableThreadLocal.remove();
    }

    <span class="hljs-comment">/**
     * 模拟另一个独立的功能
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testAnotherFunction</span><span class="hljs-params">()</span> {
        <span class="hljs-comment">// 提交异步任务到线程池</span>
        threadPoolExecutor.execute(() -&gt; {
            <span class="hljs-comment">// 在线程池-子线程里面可以获取到父线程设置的inheritableThreadLocal吗？</span>
            System.out.println(<span class="hljs-string">"线程名: "</span> + Thread.currentThread().getName() + <span class="hljs-string">", 线程池-子线程摸个鱼"</span>);
        });
    }

}
</code></pre>
<p>执行结果：</p>
<p>﻿</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/dec173b5ceb94d0e9b2682e36554882a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769153869&amp;x-signature=VKoOVd2tvXKIH2Rbfbr%2FMTM%2Bv%2B8%3D" alt="" loading="lazy"/></p>
<p>﻿﻿</p>
<p>在项目里面搜一下看看，果真如此，有2出地方在用这个线程池，并且另外的一处代码中提交的异步任务不涉及inheritableThreadLocal：</p>
<p>﻿</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f1b7252364dd40c481b0e04bd6072312~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769153869&amp;x-signature=371YiGglilqaZ8puW6D2WRpgPbQ%3D" alt="" loading="lazy"/></p>
<p>﻿﻿</p>
<p>示意图如下：</p>
<p>逻辑执行顺序为：<strong>创建线程池 - 执行功能A - 执行功能A - 执行功能B</strong></p>
<p>其中：</p>
<p>功能A全流程均不涉及InheritableThreadLocal</p>
<p>功能B对应报错的代码，主线程设置InheritableThreadLocal并且在子线程使用</p>
<p>﻿</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f046ff6251fe43288c764d29f334b68e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769153869&amp;x-signature=LU9oGqcE5yfyvlF9i%2FmxCc9UuK4%3D" alt="" loading="lazy"/></p>
<p>﻿﻿</p>
<p>至此，线上报错的根因确定了：<strong>就是因为InheritableThreadLocal + 线程池共用导致。</strong></p>
<p>﻿</p>
<p>扩展一下：</p>
<p>假如执行顺序是这样呢：<strong>创建线程池 - 执行功能B - 执行功能B - 执行功能A</strong></p>
<p>﻿</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0d5962f26cae4b19a6f07e377fadf0b4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769153869&amp;x-signature=7SQpylxXpoblgFCyH5h4bOzgiTA%3D" alt="" loading="lazy"/></p>
<p>﻿﻿</p>
<p>结局居然是一切安好。</p>
<p>﻿</p>
<p>假如执行顺序是这样呢：<strong>创建线程池 - 执行功能B - 执行功能A - 执行功能B</strong></p>
<p>﻿</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0fd8326d9c354a66a1a0bcc0f5cb14dd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769153869&amp;x-signature=R5vDd%2FKkFxDw9dabEwbESC%2BMlHM%3D" alt="" loading="lazy"/></p>
<p>﻿﻿</p>
<p><strong>发现了吗？如果应用启动之后功能B先执行并且初始化了线程池所有核心线程，那么一切正常，否则就可能报错。</strong></p>
<p><strong>也就是说功能B是否正常还看运气的，运气好就正常执行，运气不好就报空指针的错。</strong></p>
<p>﻿</p>
<p>这你敢信？</p>
<p>﻿</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9f53a48af60c44188eb202b8ef47b72a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769153869&amp;x-signature=nxqA6HGHqejuSeVLmqFBwKKPDFg%3D" alt="" loading="lazy"/></p>
<p>﻿﻿</p>
<h2 data-id="heading-6">小插曲：</h2>
<p>这个问题的排查当中还遇到了2个小插曲：</p>
<p>插曲1：</p>
<p>最初怀疑是线程池复用导致的，但是在IDEA里面搜代码的时候粗心大意没有看到其他地方在复用线程池。</p>
<p>因此期间一度自我怀疑见鬼了，导致本来可以一两个小时确定根因的，结果饶了弯路多花了两个小时才确定根因。</p>
<p>所以说<strong>排查问题的时候每一步都要保持细心，得出的每一个结论都应该是证据确凿，理由充分</strong>，</p>
<p>否则会让自己兜兜转转浪费宝贵的时间。</p>
<p>﻿</p>
<p>插曲2：</p>
<p>排查代码的时候发现异步任务代码没有做任何的异常处理，这其实是很坑的。</p>
<p>有经验的同学应该知道，<strong>线程池里面提交异步任务如果没有做异常处理，出现异常的话不会有任何的日志信息。</strong></p>
<p>本地运行的时候会打印到控制台，但是线上控制台的信息可不会记录到日志里面。</p>
<p>所以经常遇到异步任务执行结果不符合预期，但是线上没有任何相关日志就是这个原因。</p>
<p>我们这里有日志是因为使用的线程池是二次封装过的，里面对异步任务做了兜底的异常记录。</p>
<p>﻿</p>
<h2 data-id="heading-7">总结：</h2>
<p>前面分析到了导致空指针的原因是线程池共用导致的老代码报错，而共用这个线程池的代码是新上线的功能引入的。</p>
<p>这就打脸了开头我们检查了上线的功能与此无关，实则有关。</p>
<p>只是我们评估复用线程池的影响时，很难想到会有这样的影响，通常我们会考虑：</p>
<p>1.是否会影响共用该线程池的老功能响应时间边长</p>
<p>2.是否存在父子任务共用线程池导致可能产生死锁</p>
<p>针对InheritableThreadLocal，我个人的建议是：</p>
<p>1.InheritableThreadLocal（其实ThreadLocal也一样）不适合应用于业务代码中，因为他们都是隐式的参数传递，而业务系统中好维护的代码应当是显式的参数传递（我们这个线上问题就采用该方式）</p>
<p>2.框架类代码才是InheritableThreadLocal和ThreadLocal主要发光发热的地方，因为对应的研发水平通常较高，且代码经过严格测试验证，并且较少变动。而业务系统研发水平参差不齐，且经常会发生同步操作变异步等</p>
<p>3.虽然InheritableThreadLocal不建议在业务代码中使用，但是我们还是需要掌握它，不为别的，只有掌握它的优缺点才能告诉自己和他人为什么应该在业务代码中放弃使用它</p>
<p>﻿</p>
<p>针对如何有效的应对业务研发遇到的一些“疑难杂症”，我的建议是：</p>
<p>1.大胆提出合理的假设，小心谨慎进行验证</p>
<p>2.没有充足理由，不要轻易下结论</p>
<p>3.没有头绪时，休息一下，或找合适的人一起探讨，给自己打开新的思路</p>
<p>﻿</p>
<p>最后，愿天下没有故障，没有线上问题，没有bug。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[别再手写 URL 解析器了：PHP 8.5 URI 扩展让 URL 处理更安全、更干净]]></title>    <link>https://juejin.cn/post/7595495896134647834</link>    <guid>https://juejin.cn/post/7595495896134647834</guid>    <pubDate>2026-01-15T23:48:00.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7595495896134647834" data-draft-id="7595478717984849929" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="别再手写 URL 解析器了：PHP 8.5 URI 扩展让 URL 处理更安全、更干净"/> <meta itemprop="keywords" content="后端,PHP"/> <meta itemprop="datePublished" content="2026-01-15T23:48:00.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="BingoGo"/> <meta itemprop="url" content="https://juejin.cn/user/993614242266077"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            别再手写 URL 解析器了：PHP 8.5 URI 扩展让 URL 处理更安全、更干净
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/993614242266077/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    BingoGo
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-15T23:48:00.000Z" title="Thu Jan 15 2026 23:48:00 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-15
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">别再手写 URL 解析器了：PHP 8.5 URI 扩展让 URL 处理更安全、更干净</h2>
<h3 data-id="heading-1">parse_url() 能用，但不够用</h3>
<p>多年来，PHP 开发者处理 URL 的方式大同小异：</p>
<ul>
<li>用 <code>parse_url()</code> 拆分各部分</li>
<li>用 <code>rawurlencode()</code> / <code>urlencode()</code> 转义</li>
<li>用字符串拼接重建最终 URL</li>
<li>遇到"奇怪"输入时，再上几个正则</li>
</ul>
<p>大多数情况下这套流程能跑通。问题在于，URL 处理恰恰是那种"在边角情况下出问题"的领域：编码、fragment、userinfo、国际化域名、"等价但不相同"的 URL，以及各种只在生产日志里才冒出来的边缘场景。</p>
<p>PHP 8.5 提供了一个内置替代方案：一个始终可用的 URI 扩展，提供 API 来按照 RFC 3986 和 WHATWG URL 标准解析、修改 URL/URI。</p>
<p>如果"标准"二字让你觉得抽象，这里给出实际含义：</p>
<ul>
<li>拿到 URI/URL 对象，而不是数组 + 字符串拼接。</li>
<li>用安全的组件 getter 和不可变的 <code>with*()</code> 方法。</li>
<li>你可以选择 RFC 3986 行为（严格 URI，"原始 vs 规范化解码"）或浏览器风格的 WHATWG 行为（Unicode/IDNA、软错误、自动编码）。</li>
</ul>
<p>本文是一篇实战教程，重点讲：</p>
<ul>
<li>为什么手动解析容易出错，</li>
<li>新 URI 对象怎么用，</li>
<li>如何安全地修改/规范化，</li>
<li>在重定向、签名链接等安全敏感场景下如何使用。</li>
</ul>
<p>不讲升级指南，不讲废弃清单——只讲 URI 扩展。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fcatchadmin.com%2Fpost%2F2026-01%2Fphp85-uri-extension-safer-cleaner-urls" target="_blank" title="https://catchadmin.com/post/2026-01/php85-uri-extension-safer-cleaner-urls" ref="nofollow noopener noreferrer">原文 别再手写 URL 解析器了：PHP 8.5 URI 扩展让 URL 处理更安全、更干净</a></p>
<h3 data-id="heading-2">手动 URL 解析的问题</h3>
<h4 data-id="heading-3">parse_url() 不解码（而且很容易忘）</h4>
<p>PHP 的 <code>parse_url()</code> 返回各组件，但<strong>不会</strong> URL 解码它们。</p>
<p>也就是说：</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-variable">$u</span> = <span class="hljs-title function_ invoke__">parse_url</span>(<span class="hljs-string">"https://example.com/t%65st?name=Ali%63e#fr%61g"</span>);
<span class="hljs-title function_ invoke__">var_dump</span>(<span class="hljs-variable">$u</span>[<span class="hljs-string">'path'</span>]);   <span class="hljs-comment">// "/t%65st"</span>
<span class="hljs-title function_ invoke__">var_dump</span>(<span class="hljs-variable">$u</span>[<span class="hljs-string">'query'</span>]);  <span class="hljs-comment">// "name=Ali%63e"</span>
<span class="hljs-title function_ invoke__">var_dump</span>(<span class="hljs-variable">$u</span>[<span class="hljs-string">'fragment'</span>]); <span class="hljs-comment">// "fr%61g"</span>
</code></pre>
<p>如果你在比较路径或应用路由规则时没有统一解码/规范化，可能会把等价的 URI 当成不同的来处理。</p>
<p>更糟的是：团队往往混用：</p>
<ul>
<li>有些地方用解码后的值，</li>
<li>有些地方用原始值，</li>
<li>再加上散落在各处的临时解码逻辑。</li>
</ul>
<p>这种混乱很容易埋下隐蔽 bug 和安全隐患。</p>
<h4 data-id="heading-4">字符串拼接容易拼出"差一点对"的 URL</h4>
<p>手动重建 URL 容易犯的错：</p>
<ul>
<li>漏掉 <code>?</code> 或 <code>#</code></li>
<li>重复编码</li>
<li>完全没编码</li>
<li>编码错了东西（比如把整个 query string 编码而不是只编码 value）</li>
<li>丢失或打乱参数顺序</li>
<li>空 query/fragment 处理不当</li>
</ul>
<p>一个常见的"差一点对"函数：</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">addQueryParam</span>(<span class="hljs-params"><span class="hljs-keyword">string</span> <span class="hljs-variable">$url</span>, <span class="hljs-keyword">string</span> <span class="hljs-variable">$key</span>, <span class="hljs-keyword">string</span> <span class="hljs-variable">$value</span></span>): <span class="hljs-title">string</span>
</span>{
    <span class="hljs-variable">$parts</span> = <span class="hljs-title function_ invoke__">parse_url</span>(<span class="hljs-variable">$url</span>);
    <span class="hljs-variable">$query</span> = <span class="hljs-variable">$parts</span>[<span class="hljs-string">'query'</span>] ?? <span class="hljs-string">''</span>;
    <span class="hljs-variable">$query</span> .= (<span class="hljs-variable">$query</span> === <span class="hljs-string">''</span> ? <span class="hljs-string">''</span> : <span class="hljs-string">'&amp;'</span>) . <span class="hljs-variable">$key</span> . <span class="hljs-string">'='</span> . <span class="hljs-title function_ invoke__">urlencode</span>(<span class="hljs-variable">$value</span>);
    <span class="hljs-variable">$out</span> = <span class="hljs-variable">$parts</span>[<span class="hljs-string">'scheme'</span>] . <span class="hljs-string">'://'</span> . <span class="hljs-variable">$parts</span>[<span class="hljs-string">'host'</span>] . (<span class="hljs-variable">$parts</span>[<span class="hljs-string">'path'</span>] ?? <span class="hljs-string">''</span>);
    <span class="hljs-keyword">if</span> (<span class="hljs-variable">$query</span> !== <span class="hljs-string">''</span>) {
        <span class="hljs-variable">$out</span> .= <span class="hljs-string">'?'</span> . <span class="hljs-variable">$query</span>;
    }
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$parts</span>[<span class="hljs-string">'fragment'</span>])) {
        <span class="hljs-variable">$out</span> .= <span class="hljs-string">'#'</span> . <span class="hljs-variable">$parts</span>[<span class="hljs-string">'fragment'</span>];
    }
    <span class="hljs-keyword">return</span> <span class="hljs-variable">$out</span>;
}
</code></pre>
<p>看起来没问题。直到遇到：</p>
<ul>
<li>没有 scheme/host 的 URL（相对 URL），</li>
<li>带 userinfo/port 的 URL，</li>
<li>已经编码过的值，</li>
<li>需要 <code>rawurlencode()</code> 规则（RFC 3986）的参数，</li>
<li>应该原样保留的 fragment。</li>
</ul>
<h4 data-id="heading-5">等价的 URL 不一定是相同的字符串</h4>
<p>下面这些可以指向同一个资源，但字符串不同：</p>
<ul>
<li>scheme/host 大小写不同（<code>HTTPS://EXAMPLE.com</code>）</li>
<li>path 中 <code>%65</code> vs <code>e</code>（<code>/t%65st</code> vs <code>/test</code>）</li>
<li>path 中的点号段（<code>/foo/../bar/</code>）</li>
<li>默认端口（https 的 <code>:443</code>）</li>
</ul>
<p>如果你把 URL 当成纯字符串处理，要么：</p>
<ul>
<li>缓存/路由出现诡异问题，</li>
<li>要么安全检查被绕过，因为你比较的是"错误的表示形式"。</li>
</ul>
<h4 data-id="heading-6">IDNA（国际化域名）还涉及安全问题</h4>
<p>如果你允许用户提交 URL，国际化域名可能是合法的——但也可能造成混淆。域名可以用 Unicode 或 punycode（ASCII 形式）表示。RFC 讨论中明确指出人为风险：punycode 域名在 Unicode 渲染时可能看起来像一个熟悉的、但实际不同的域名。</p>
<p>这不是你想用正则"手动处理"然后祈祷没问题的事。</p>
<h3 data-id="heading-7">URI 扩展的概念：URI 对象 + 两套标准</h3>
<p>PHP 8.5 的 URI 扩展提供两个主要类：</p>
<ul>
<li><code>Uri\Rfc3986\Uri</code>（RFC 3986 合规，严格 URI 规则）</li>
<li><code>Uri\WhatWg\Url</code>（WHATWG URL 合规，浏览器风格的 URL 规则）</li>
</ul>
<p>配套的类型包括：</p>
<ul>
<li><code>Uri\InvalidUriException</code></li>
<li><code>Uri\WhatWg\InvalidUrlException</code></li>
<li><code>Uri\WhatWg\UrlValidationError</code> 和 <code>UrlValidationErrorType</code></li>
<li><code>Uri\UriComparisonMode</code>（用于比较）</li>
</ul>
<p>一个关键设计决策：两个实现都是 readonly 且以不可变方式使用——<code>withPath()</code>、<code>withQuery()</code> 等方法返回新实例。</p>
<p>另一个要点：这个扩展在 PHP 8.5 中始终可用，底层由以下库驱动：</p>
<ul>
<li>uriparser（用于 RFC 3986）</li>
<li>Lexbor（用于 WHATWG URL）</li>
</ul>
<p>所以你不需要第三方库就能获得合理的 URL 处理能力。</p>
<h3 data-id="heading-8">创建和解析 URI：从字符串到组件</h3>
<h4 data-id="heading-9">最简单的情况：解析一个 HTTP URL 并访问各部分</h4>
<p>RFC 3986：</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-keyword">use</span> <span class="hljs-title">Uri</span>\<span class="hljs-title">Rfc3986</span>\<span class="hljs-title">Uri</span>;

<span class="hljs-variable">$uri</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Uri</span>(<span class="hljs-string">"https://php.net/releases/8.5/en.php"</span>);

<span class="hljs-keyword">echo</span> <span class="hljs-variable">$uri</span>-&gt;<span class="hljs-title function_ invoke__">getScheme</span>(); <span class="hljs-comment">// "https"</span>
<span class="hljs-keyword">echo</span> <span class="hljs-variable">$uri</span>-&gt;<span class="hljs-title function_ invoke__">getHost</span>();   <span class="hljs-comment">// "php.net"</span>
<span class="hljs-keyword">echo</span> <span class="hljs-variable">$uri</span>-&gt;<span class="hljs-title function_ invoke__">getPath</span>();   <span class="hljs-comment">// "/releases/8.5/en.php"</span>
</code></pre>
<p>WHATWG：</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-keyword">use</span> <span class="hljs-title">Uri</span>\<span class="hljs-title">WhatWg</span>\<span class="hljs-title">Url</span>;

<span class="hljs-variable">$url</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Url</span>(<span class="hljs-string">"https://example.com/path?query=1#frag"</span>);

<span class="hljs-keyword">echo</span> <span class="hljs-variable">$url</span>-&gt;<span class="hljs-title function_ invoke__">getScheme</span>();      <span class="hljs-comment">// "https"</span>
<span class="hljs-keyword">echo</span> <span class="hljs-variable">$url</span>-&gt;<span class="hljs-title function_ invoke__">getAsciiHost</span>();   <span class="hljs-comment">// "example.com"</span>
<span class="hljs-keyword">echo</span> <span class="hljs-variable">$url</span>-&gt;<span class="hljs-title function_ invoke__">getPath</span>();        <span class="hljs-comment">// "/path"</span>
<span class="hljs-keyword">echo</span> <span class="hljs-variable">$url</span>-&gt;<span class="hljs-title function_ invoke__">getQuery</span>();       <span class="hljs-comment">// "query=1"</span>
<span class="hljs-keyword">echo</span> <span class="hljs-variable">$url</span>-&gt;<span class="hljs-title function_ invoke__">getFragment</span>();    <span class="hljs-comment">// "frag"</span>
</code></pre>
<p>注意：WHATWG 的 getter 故意不返回分隔符（如 <code>:</code> <code>/</code> <code>?</code> <code>#</code>）。</p>
<h4 data-id="heading-10">构造函数抛异常；parse() 返回 null</h4>
<p>两个实现都支持两种解析风格：</p>
<ul>
<li>构造函数：无效时抛异常</li>
<li><code>parse()</code>：无效时返回 null</li>
</ul>
<p>RFC 3986 行为：</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-keyword">use</span> <span class="hljs-title">Uri</span>\<span class="hljs-title">Rfc3986</span>\<span class="hljs-title">Uri</span>;
<span class="hljs-keyword">use</span> <span class="hljs-title">Uri</span>\<span class="hljs-title">InvalidUriException</span>;

<span class="hljs-keyword">try</span> {
    <span class="hljs-variable">$uri</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Uri</span>(<span class="hljs-string">"not a uri"</span>);
} <span class="hljs-keyword">catch</span> (InvalidUriException <span class="hljs-variable">$e</span>) {
    <span class="hljs-comment">// 拒绝输入</span>
}

<span class="hljs-variable">$uri</span> = <span class="hljs-title class_">Uri</span>::<span class="hljs-title function_ invoke__">parse</span>(<span class="hljs-string">"not a uri"</span>);
<span class="hljs-title function_ invoke__">var_dump</span>(<span class="hljs-variable">$uri</span>); <span class="hljs-comment">// null</span>
</code></pre>
<p>WHATWG 行为提供更丰富的错误信息：</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-keyword">use</span> <span class="hljs-title">Uri</span>\<span class="hljs-title">WhatWg</span>\<span class="hljs-title">Url</span>;
<span class="hljs-keyword">use</span> <span class="hljs-title">Uri</span>\<span class="hljs-title">WhatWg</span>\<span class="hljs-title">InvalidUrlException</span>;

<span class="hljs-keyword">try</span> {
    <span class="hljs-variable">$url</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Url</span>(<span class="hljs-string">"invalid url"</span>);
} <span class="hljs-keyword">catch</span> (InvalidUrlException <span class="hljs-variable">$e</span>) {
    <span class="hljs-comment">// $e-&gt;errors 包含 UrlValidationError 实例</span>
}

<span class="hljs-variable">$errors</span> = [];
<span class="hljs-variable">$url</span> = <span class="hljs-title class_">Url</span>::<span class="hljs-title function_ invoke__">parse</span>(<span class="hljs-string">"invalid url"</span>, <span class="hljs-literal">null</span>, <span class="hljs-variable">$errors</span>);
<span class="hljs-title function_ invoke__">var_dump</span>(<span class="hljs-variable">$url</span>);    <span class="hljs-comment">// null</span>
<span class="hljs-title function_ invoke__">var_dump</span>(<span class="hljs-variable">$errors</span>); <span class="hljs-comment">// UrlValidationError 数组</span>
</code></pre>
<p>这种区分（硬错误 vs 软错误 vs parse-and-return-null）在 RFC 中有详细说明。</p>
<h4 data-id="heading-11">Base URL 和引用解析（相对 → 绝对）</h4>
<p>有了这个功能，你不再需要手动检查是否以 <code>/</code> 开头然后拼接。</p>
<p>在构造函数或 <code>parse()</code> 中使用 base URL：</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-keyword">use</span> <span class="hljs-title">Uri</span>\<span class="hljs-title">Rfc3986</span>\<span class="hljs-title">Uri</span>;

<span class="hljs-variable">$base</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Uri</span>(<span class="hljs-string">"https://example.com"</span>);
<span class="hljs-variable">$uri</span>  = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Uri</span>(<span class="hljs-string">"/foo"</span>, <span class="hljs-variable">$base</span>);

<span class="hljs-keyword">echo</span> <span class="hljs-variable">$uri</span>-&gt;<span class="hljs-title function_ invoke__">toString</span>(); <span class="hljs-comment">// "https://example.com/foo"</span>
</code></pre>
<p>WHATWG 类似：</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-keyword">use</span> <span class="hljs-title">Uri</span>\<span class="hljs-title">WhatWg</span>\<span class="hljs-title">Url</span>;

<span class="hljs-variable">$base</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Url</span>(<span class="hljs-string">"https://example.com"</span>);
<span class="hljs-variable">$url</span>  = <span class="hljs-title class_">Url</span>::<span class="hljs-title function_ invoke__">parse</span>(<span class="hljs-string">"/foo"</span>, <span class="hljs-variable">$base</span>);

<span class="hljs-keyword">echo</span> <span class="hljs-variable">$url</span>-&gt;<span class="hljs-title function_ invoke__">toAsciiString</span>(); <span class="hljs-comment">// "https://example.com/foo"</span>
</code></pre>
<p>扩展还提供了便捷的 <code>resolve()</code> 方法，以当前对象作为 base。</p>
<h3 data-id="heading-12">安全修改：设置/替换 path、query、fragment（不可变）</h3>
<p>拿到对象后，可以用 <code>with*()</code> 方法修改组件。这些方法返回新实例，原对象保持不变。</p>
<h4 data-id="heading-13">RFC 3986：withPath()、withQuery()、withFragment()</h4>
<pre><code class="hljs language-php" lang="php"><span class="hljs-keyword">use</span> <span class="hljs-title">Uri</span>\<span class="hljs-title">Rfc3986</span>\<span class="hljs-title">Uri</span>;

<span class="hljs-variable">$uri</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Uri</span>(<span class="hljs-string">"https://example.com/products?sort=asc#top"</span>);

<span class="hljs-variable">$updated</span> = <span class="hljs-variable">$uri</span>
    -&gt;<span class="hljs-title function_ invoke__">withPath</span>(<span class="hljs-string">"/products/123"</span>)
    -&gt;<span class="hljs-title function_ invoke__">withQuery</span>(<span class="hljs-string">"sort=desc&amp;ref=home"</span>)
    -&gt;<span class="hljs-title function_ invoke__">withFragment</span>(<span class="hljs-string">"reviews"</span>);

<span class="hljs-keyword">echo</span> <span class="hljs-variable">$uri</span>-&gt;<span class="hljs-title function_ invoke__">toString</span>();     <span class="hljs-comment">// 原对象不变</span>
<span class="hljs-keyword">echo</span> <span class="hljs-variable">$updated</span>-&gt;<span class="hljs-title function_ invoke__">toString</span>(); <span class="hljs-comment">// 修改后的</span>
</code></pre>
<p>RFC 3986 提供"原始"和"规范化解码"两种 getter（下一节详述），以及 <code>toString()</code> 和 <code>toRawString()</code> 方法。</p>
<h4 data-id="heading-14">WHATWG：同样的思路，外加 ASCII/Unicode 字符串输出</h4>
<pre><code class="hljs language-php" lang="php"><span class="hljs-keyword">use</span> <span class="hljs-title">Uri</span>\<span class="hljs-title">WhatWg</span>\<span class="hljs-title">Url</span>;

<span class="hljs-variable">$url</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Url</span>(<span class="hljs-string">"https://example.com/"</span>);

<span class="hljs-variable">$new</span> = <span class="hljs-variable">$url</span>
    -&gt;<span class="hljs-title function_ invoke__">withPath</span>(<span class="hljs-string">"/search"</span>)
    -&gt;<span class="hljs-title function_ invoke__">withQuery</span>(<span class="hljs-string">"q=php+8.5"</span>)
    -&gt;<span class="hljs-title function_ invoke__">withFragment</span>(<span class="hljs-string">"results"</span>);

<span class="hljs-keyword">echo</span> <span class="hljs-variable">$new</span>-&gt;<span class="hljs-title function_ invoke__">toAsciiString</span>();
<span class="hljs-keyword">echo</span> <span class="hljs-variable">$new</span>-&gt;<span class="hljs-title function_ invoke__">toUnicodeString</span>();
</code></pre>
<p>WHATWG 有 <code>toAsciiString()</code> 和 <code>toUnicodeString()</code> 两种输出，分别用于机器处理和人类展示。</p>
<h4 data-id="heading-15">一个小但重要的行为：输入中的分隔符</h4>
<p>使用 WHATWG 时，如果你在设置 query/fragment 时不小心包含了 <code>?</code> 或 <code>#</code>，它会把它们当作分隔符并去掉：</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-keyword">use</span> <span class="hljs-title">Uri</span>\<span class="hljs-title">WhatWg</span>\<span class="hljs-title">Url</span>;

<span class="hljs-variable">$url</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Url</span>(<span class="hljs-string">"https://example.com/"</span>);
<span class="hljs-variable">$url</span> = <span class="hljs-variable">$url</span>-&gt;<span class="hljs-title function_ invoke__">withQuery</span>(<span class="hljs-string">"?foo"</span>);
<span class="hljs-variable">$url</span> = <span class="hljs-variable">$url</span>-&gt;<span class="hljs-title function_ invoke__">withFragment</span>(<span class="hljs-string">"#bar"</span>);

<span class="hljs-keyword">echo</span> <span class="hljs-variable">$url</span>-&gt;<span class="hljs-title function_ invoke__">getQuery</span>();    <span class="hljs-comment">// "foo"</span>
<span class="hljs-keyword">echo</span> <span class="hljs-variable">$url</span>-&gt;<span class="hljs-title function_ invoke__">getFragment</span>(); <span class="hljs-comment">// "bar"</span>
</code></pre>
<p>这个行为在文档中有明确说明。</p>
<h3 data-id="heading-16">规范化与编码：避免重复编码和"奇怪字符"</h3>
<p>URI 扩展的价值不止于 API 设计——它让你能控制 URL 的表示形式。</p>
<h4 data-id="heading-17">RFC 3986 给你两种表示：原始 vs 规范化解码</h4>
<p>对于大多数组件，<code>Uri\Rfc3986\Uri</code> 暴露：</p>
<ul>
<li>raw：解析器给出的形式（最接近原始输入）</li>
<li>规范化解码：规范化 + 百分号解码，意在成为规范形式且可往返转换</li>
</ul>
<p>RFC 解释了为什么需要两种形式以及何时使用——签名方和 API 客户端通常偏好 raw，而路由/缓存通常偏好规范化解码。</p>
<p>具体效果：</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-keyword">use</span> <span class="hljs-title">Uri</span>\<span class="hljs-title">Rfc3986</span>\<span class="hljs-title">Uri</span>;

<span class="hljs-variable">$uri</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Uri</span>(<span class="hljs-string">"https://%61pple:p%61ss@ex%61mple.com:433/foob%61r?%61bc=%61bc#%61bc"</span>);

<span class="hljs-keyword">echo</span> <span class="hljs-variable">$uri</span>-&gt;<span class="hljs-title function_ invoke__">getRawHost</span>(); <span class="hljs-comment">// "ex%61mple.com"</span>
<span class="hljs-keyword">echo</span> <span class="hljs-variable">$uri</span>-&gt;<span class="hljs-title function_ invoke__">getHost</span>();    <span class="hljs-comment">// "example.com"</span>

<span class="hljs-keyword">echo</span> <span class="hljs-variable">$uri</span>-&gt;<span class="hljs-title function_ invoke__">getRawPath</span>(); <span class="hljs-comment">// "/foob%61r"</span>
<span class="hljs-keyword">echo</span> <span class="hljs-variable">$uri</span>-&gt;<span class="hljs-title function_ invoke__">getPath</span>();    <span class="hljs-comment">// "/foobar"</span>

<span class="hljs-keyword">echo</span> <span class="hljs-variable">$uri</span>-&gt;<span class="hljs-title function_ invoke__">getRawQuery</span>(); <span class="hljs-comment">// "%61bc=%61bc"</span>
<span class="hljs-keyword">echo</span> <span class="hljs-variable">$uri</span>-&gt;<span class="hljs-title function_ invoke__">getQuery</span>();    <span class="hljs-comment">// "abc=abc"</span>
</code></pre>
<p>规范化示例：</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-keyword">use</span> <span class="hljs-title">Uri</span>\<span class="hljs-title">Rfc3986</span>\<span class="hljs-title">Uri</span>;

<span class="hljs-variable">$uri</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Uri</span>(<span class="hljs-string">"HTTPS://EXAMPLE.COM/foo/../bar/"</span>);

<span class="hljs-keyword">echo</span> <span class="hljs-variable">$uri</span>-&gt;<span class="hljs-title function_ invoke__">getRawScheme</span>(); <span class="hljs-comment">// "HTTPS"</span>
<span class="hljs-keyword">echo</span> <span class="hljs-variable">$uri</span>-&gt;<span class="hljs-title function_ invoke__">getScheme</span>();    <span class="hljs-comment">// "https"</span>

<span class="hljs-keyword">echo</span> <span class="hljs-variable">$uri</span>-&gt;<span class="hljs-title function_ invoke__">getRawHost</span>(); <span class="hljs-comment">// "EXAMPLE.COM"</span>
<span class="hljs-keyword">echo</span> <span class="hljs-variable">$uri</span>-&gt;<span class="hljs-title function_ invoke__">getHost</span>();    <span class="hljs-comment">// "example.com"</span>

<span class="hljs-keyword">echo</span> <span class="hljs-variable">$uri</span>-&gt;<span class="hljs-title function_ invoke__">getRawPath</span>(); <span class="hljs-comment">// "/foo/../bar/"</span>
<span class="hljs-keyword">echo</span> <span class="hljs-variable">$uri</span>-&gt;<span class="hljs-title function_ invoke__">getPath</span>();    <span class="hljs-comment">// "/bar/"</span>
</code></pre>
<h4 data-id="heading-18">WHATWG 在修改时自动编码某些字符</h4>
<p>如果你设置的 path 包含该组件必须百分号编码的字符，WHATWG 会自动编码：</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-keyword">use</span> <span class="hljs-title">Uri</span>\<span class="hljs-title">WhatWg</span>\<span class="hljs-title">Url</span>;

<span class="hljs-variable">$url</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Url</span>(<span class="hljs-string">"https://example.com"</span>);
<span class="hljs-variable">$url</span> = <span class="hljs-variable">$url</span>-&gt;<span class="hljs-title function_ invoke__">withPath</span>(<span class="hljs-string">"/?#:"</span>);

<span class="hljs-keyword">echo</span> <span class="hljs-variable">$url</span>-&gt;<span class="hljs-title function_ invoke__">getPath</span>(); <span class="hljs-comment">// "/%3F%23:"</span>
</code></pre>
<p>这能防止意外构建出损坏的 URL。</p>
<h4 data-id="heading-19">"重复编码"陷阱（以及新 API 如何帮忙）</h4>
<p>重复编码通常这样发生：</p>
<ol>
<li>你用 <code>rawurlencode()</code> 编码一个值，因为"它要放进 URL"</li>
<li>你手动把它加到 query string</li>
<li>后来某处又编码了一次（框架、代理、客户端）</li>
</ol>
<p>使用 URI 对象，一个好做法是：</p>
<ul>
<li>数据保持为普通字符串（未编码）</li>
<li>用 <code>http_build_query()</code> 构建 query（或你偏好的编码器）</li>
<li>把结果传给 <code>withQuery()</code></li>
</ul>
<p>示例：</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-keyword">use</span> <span class="hljs-title">Uri</span>\<span class="hljs-title">Rfc3986</span>\<span class="hljs-title">Uri</span>;

<span class="hljs-variable">$base</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Uri</span>(<span class="hljs-string">"https://example.com/search"</span>);

<span class="hljs-variable">$params</span> = [
    <span class="hljs-string">'q'</span> =&gt; <span class="hljs-string">'php 8.5 uri'</span>,
    <span class="hljs-string">'tag'</span> =&gt; <span class="hljs-string">'url/encoding'</span>,
];

<span class="hljs-comment">// RFC 3986 风格编码（空格用 %20 而非 +）</span>
<span class="hljs-variable">$query</span> = <span class="hljs-title function_ invoke__">str_replace</span>(<span class="hljs-string">'+'</span>, <span class="hljs-string">'%20'</span>, <span class="hljs-title function_ invoke__">http_build_query</span>(<span class="hljs-variable">$params</span>));

<span class="hljs-variable">$uri</span> = <span class="hljs-variable">$base</span>-&gt;<span class="hljs-title function_ invoke__">withQuery</span>(<span class="hljs-variable">$query</span>);
<span class="hljs-keyword">echo</span> <span class="hljs-variable">$uri</span>-&gt;<span class="hljs-title function_ invoke__">toString</span>();
</code></pre>
<p><code>http_build_query()</code> 不一定适合所有场景，但好处是编码规则集中在一处，而非散落在各种字符串拼接里。</p>
<p>如果确实需要对 path 段进行 RFC 3986 原始编码，PHP 的 <code>rawurlencode()</code> 遵循 RFC 3986 规则。</p>
<h3 data-id="heading-20">验证用户输入的 URL：实用的最低规则</h3>
<p>如果输入来自用户（或不可信来源），验证应该有明确的立场。</p>
<p>对于你打算 fetch 或跳转的 URL，一个务实的安全导向模式：</p>
<ul>
<li>必须解析成功（硬错误直接拒绝）</li>
<li>只允许 http / https</li>
<li>URL 中不能有用户名/密码</li>
<li>域名白名单（用 ASCII 形式比较）</li>
<li>可选：限制端口</li>
<li>可选：要求绝对 URL（或相对 URL 基于已知 base 解析）</li>
</ul>
<h4 data-id="heading-21">严格验证 helper（WHATWG 版本）</h4>
<p>WHATWG 适合处理"浏览器风格"URL 和 IDNA。</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-keyword">use</span> <span class="hljs-title">Uri</span>\<span class="hljs-title">WhatWg</span>\<span class="hljs-title">Url</span>;
<span class="hljs-keyword">use</span> <span class="hljs-title">Uri</span>\<span class="hljs-title">WhatWg</span>\<span class="hljs-title">InvalidUrlException</span>;

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">validateExternalUrl</span>(<span class="hljs-params"><span class="hljs-keyword">string</span> <span class="hljs-variable">$input</span>, <span class="hljs-keyword">array</span> <span class="hljs-variable">$allowedHosts</span></span>): <span class="hljs-title">Url</span>
</span>{
    <span class="hljs-keyword">try</span> {
        <span class="hljs-variable">$softErrors</span> = [];
        <span class="hljs-variable">$url</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Url</span>(<span class="hljs-variable">$input</span>, <span class="hljs-literal">null</span>, <span class="hljs-variable">$softErrors</span>);
    } <span class="hljs-keyword">catch</span> (InvalidUrlException <span class="hljs-variable">$e</span>) {
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">InvalidArgumentException</span>(<span class="hljs-string">"Invalid URL."</span>);
    }

    <span class="hljs-comment">// Scheme 白名单</span>
    <span class="hljs-variable">$scheme</span> = <span class="hljs-variable">$url</span>-&gt;<span class="hljs-title function_ invoke__">getScheme</span>();
    <span class="hljs-keyword">if</span> (!<span class="hljs-title function_ invoke__">in_array</span>(<span class="hljs-variable">$scheme</span>, [<span class="hljs-string">'http'</span>, <span class="hljs-string">'https'</span>], <span class="hljs-literal">true</span>)) {
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">InvalidArgumentException</span>(<span class="hljs-string">"Unsupported scheme."</span>);
    }

    <span class="hljs-comment">// 禁止凭证</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-variable">$url</span>-&gt;<span class="hljs-title function_ invoke__">getUsername</span>() !== <span class="hljs-literal">null</span> || <span class="hljs-variable">$url</span>-&gt;<span class="hljs-title function_ invoke__">getPassword</span>() !== <span class="hljs-literal">null</span>) {
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">InvalidArgumentException</span>(<span class="hljs-string">"Credentials in URL are not allowed."</span>);
    }

    <span class="hljs-comment">// Host 白名单（ASCII 比较）</span>
    <span class="hljs-variable">$host</span> = <span class="hljs-variable">$url</span>-&gt;<span class="hljs-title function_ invoke__">getAsciiHost</span>();
    <span class="hljs-keyword">if</span> (<span class="hljs-variable">$host</span> === <span class="hljs-literal">null</span> || !<span class="hljs-title function_ invoke__">in_array</span>(<span class="hljs-title function_ invoke__">strtolower</span>(<span class="hljs-variable">$host</span>), <span class="hljs-variable">$allowedHosts</span>, <span class="hljs-literal">true</span>)) {
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">InvalidArgumentException</span>(<span class="hljs-string">"Host not allowed."</span>);
    }

    <span class="hljs-comment">// 可选：端口限制</span>
    <span class="hljs-variable">$port</span> = <span class="hljs-variable">$url</span>-&gt;<span class="hljs-title function_ invoke__">getPort</span>();
    <span class="hljs-keyword">if</span> (<span class="hljs-variable">$port</span> !== <span class="hljs-literal">null</span> &amp;&amp; !<span class="hljs-title function_ invoke__">in_array</span>(<span class="hljs-variable">$port</span>, [<span class="hljs-number">80</span>, <span class="hljs-number">443</span>], <span class="hljs-literal">true</span>)) {
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">InvalidArgumentException</span>(<span class="hljs-string">"Port not allowed."</span>);
    }

    <span class="hljs-keyword">return</span> <span class="hljs-variable">$url</span>;
}
</code></pre>
<p>几点说明：</p>
<ul>
<li><code>Url</code> 即使解析成功也可能返回软错误。RFC 解释了"软 vs 硬"模型，并给出了解析继续但报告验证错误的例子。</li>
<li>WHATWG 同时暴露 <code>getAsciiHost()</code> 和 <code>getUnicodeHost()</code>；比较通常用 ASCII，展示用 Unicode。</li>
</ul>
<h4 data-id="heading-22">RFC 3986 验证：严格 URI 解析 + 规范化选项</h4>
<p>如果你在验证通用 URI（不只是 HTTP URL），或者你关心 raw vs 规范化解码的表示，<code>Uri\Rfc3986\Uri</code> 是个好选择。</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-keyword">use</span> <span class="hljs-title">Uri</span>\<span class="hljs-title">Rfc3986</span>\<span class="hljs-title">Uri</span>;
<span class="hljs-keyword">use</span> <span class="hljs-title">Uri</span>\<span class="hljs-title">InvalidUriException</span>;

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">validateHttpUri</span>(<span class="hljs-params"><span class="hljs-keyword">string</span> <span class="hljs-variable">$input</span>, <span class="hljs-keyword">array</span> <span class="hljs-variable">$allowedHosts</span></span>): <span class="hljs-title">Uri</span>
</span>{
    <span class="hljs-keyword">try</span> {
        <span class="hljs-variable">$uri</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Uri</span>(<span class="hljs-variable">$input</span>);
    } <span class="hljs-keyword">catch</span> (InvalidUriException <span class="hljs-variable">$e</span>) {
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">InvalidArgumentException</span>(<span class="hljs-string">"Invalid URI."</span>);
    }

    <span class="hljs-variable">$scheme</span> = <span class="hljs-variable">$uri</span>-&gt;<span class="hljs-title function_ invoke__">getScheme</span>();
    <span class="hljs-keyword">if</span> (!<span class="hljs-title function_ invoke__">in_array</span>(<span class="hljs-variable">$scheme</span>, [<span class="hljs-string">'http'</span>, <span class="hljs-string">'https'</span>], <span class="hljs-literal">true</span>)) {
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">InvalidArgumentException</span>(<span class="hljs-string">"Unsupported scheme."</span>);
    }

    <span class="hljs-comment">// Userinfo 在大多数 Web 应用中是个坑</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-variable">$uri</span>-&gt;<span class="hljs-title function_ invoke__">getUserInfo</span>() !== <span class="hljs-literal">null</span>) {
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">InvalidArgumentException</span>(<span class="hljs-string">"Userinfo is not allowed."</span>);
    }

    <span class="hljs-variable">$host</span> = <span class="hljs-variable">$uri</span>-&gt;<span class="hljs-title function_ invoke__">getHost</span>();
    <span class="hljs-keyword">if</span> (<span class="hljs-variable">$host</span> === <span class="hljs-literal">null</span> || !<span class="hljs-title function_ invoke__">in_array</span>(<span class="hljs-title function_ invoke__">strtolower</span>(<span class="hljs-variable">$host</span>), <span class="hljs-variable">$allowedHosts</span>, <span class="hljs-literal">true</span>)) {
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">InvalidArgumentException</span>(<span class="hljs-string">"Host not allowed."</span>);
    }

    <span class="hljs-keyword">return</span> <span class="hljs-variable">$uri</span>;
}
</code></pre>
<h3 data-id="heading-23">实际用例：签名链接、安全重定向、规范 URL</h3>
<h4 data-id="heading-24">用例：签名链接而不破坏编码</h4>
<p>签名 URL（HMAC token、临时访问链接、CDN 认证）对表示形式极其敏感。一个小的"规范化变更"就能使签名失效。</p>
<p>这也是 RFC 明确指出"API 客户端或签名方"通常偏好原始表示的原因。</p>
<p>一个简单的签名 URL 方法：</p>
<ol>
<li>构建 URL</li>
<li>对稳定的字符串表示计算签名</li>
<li>把签名作为 query 参数加进去</li>
</ol>
<p>示例，使用 RFC 3986 和 <code>toRawString()</code> 签名：</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-keyword">use</span> <span class="hljs-title">Uri</span>\<span class="hljs-title">Rfc3986</span>\<span class="hljs-title">Uri</span>;

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">signUri</span>(<span class="hljs-params">Uri <span class="hljs-variable">$uri</span>, <span class="hljs-keyword">string</span> <span class="hljs-variable">$secret</span></span>): <span class="hljs-title">Uri</span>
</span>{
    <span class="hljs-comment">// 当你想避免意外转换时，用 raw string</span>
    <span class="hljs-variable">$baseString</span> = <span class="hljs-variable">$uri</span>-&gt;<span class="hljs-title function_ invoke__">toRawString</span>();
    <span class="hljs-variable">$sig</span> = <span class="hljs-title function_ invoke__">hash_hmac</span>(<span class="hljs-string">'sha256'</span>, <span class="hljs-variable">$baseString</span>, <span class="hljs-variable">$secret</span>);

    <span class="hljs-variable">$query</span> = <span class="hljs-variable">$uri</span>-&gt;<span class="hljs-title function_ invoke__">getRawQuery</span>();
    <span class="hljs-variable">$query</span> = <span class="hljs-variable">$query</span> ? <span class="hljs-variable">$query</span> . <span class="hljs-string">'&amp;'</span> : <span class="hljs-string">''</span>;
    <span class="hljs-variable">$query</span> .= <span class="hljs-string">'sig='</span> . <span class="hljs-title function_ invoke__">rawurlencode</span>(<span class="hljs-variable">$sig</span>);

    <span class="hljs-keyword">return</span> <span class="hljs-variable">$uri</span>-&gt;<span class="hljs-title function_ invoke__">withQuery</span>(<span class="hljs-variable">$query</span>);
}

<span class="hljs-variable">$uri</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Uri</span>(<span class="hljs-string">"https://download.example.com/file/%2Fsafe?expires=1736035200"</span>);
<span class="hljs-variable">$signed</span> = <span class="hljs-title function_ invoke__">signUri</span>(<span class="hljs-variable">$uri</span>, <span class="hljs-string">"super-secret-key"</span>);

<span class="hljs-keyword">echo</span> <span class="hljs-variable">$signed</span>-&gt;<span class="hljs-title function_ invoke__">toRawString</span>();
</code></pre>
<p>两个要点：</p>
<ul>
<li>你是故意选择 raw 的，因为签名关心的是"线上实际发送的是什么"。</li>
<li>query 构建仍然要小心，避免编码错误。</li>
</ul>
<p>如果你的签名算法需要规范形式（有些确实需要），可以故意对 <code>toString()</code> 签名——但要知道自己在做什么，而不是意外这么做。</p>
<h4 data-id="heading-25">用例：安全重定向（避免开放重定向 + 解析混淆）</h4>
<p>安全重定向问题通常长这样：</p>
<ol>
<li>你有 <code>/login?next=&lt;something&gt;</code></li>
<li>登录后跳转到 next</li>
<li>攻击者尝试 <code>next=https://evil.com</code> 或各种变体</li>
</ol>
<p>一个健壮的模式是：</p>
<ol>
<li>把用户输入解析为相对 URL 或绝对 URL</li>
<li>相对 URL 基于你自己的已知 base 解析</li>
<li>验证 host/scheme 是你的（或在允许列表中）</li>
</ol>
<p>使用 WHATWG：</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-keyword">use</span> <span class="hljs-title">Uri</span>\<span class="hljs-title">WhatWg</span>\<span class="hljs-title">Url</span>;

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">safeRedirectTarget</span>(<span class="hljs-params"><span class="hljs-keyword">string</span> <span class="hljs-variable">$next</span>, <span class="hljs-keyword">string</span> <span class="hljs-variable">$appBase</span></span>): <span class="hljs-title">string</span>
</span>{
    <span class="hljs-variable">$base</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Url</span>(<span class="hljs-variable">$appBase</span>);

    <span class="hljs-comment">// 安全解析相对引用</span>
    <span class="hljs-variable">$errors</span> = [];
    <span class="hljs-variable">$resolved</span> = <span class="hljs-title class_">Url</span>::<span class="hljs-title function_ invoke__">parse</span>(<span class="hljs-variable">$next</span>, <span class="hljs-variable">$base</span>, <span class="hljs-variable">$errors</span>);

    <span class="hljs-keyword">if</span> (<span class="hljs-variable">$resolved</span> === <span class="hljs-literal">null</span>) {
        <span class="hljs-keyword">return</span> <span class="hljs-variable">$base</span>-&gt;<span class="hljs-title function_ invoke__">toAsciiString</span>(); <span class="hljs-comment">// fallback</span>
    }

    <span class="hljs-comment">// 只允许同 host</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">strtolower</span>(<span class="hljs-variable">$resolved</span>-&gt;<span class="hljs-title function_ invoke__">getAsciiHost</span>() ?? <span class="hljs-string">''</span>) !== <span class="hljs-title function_ invoke__">strtolower</span>(<span class="hljs-variable">$base</span>-&gt;<span class="hljs-title function_ invoke__">getAsciiHost</span>() ?? <span class="hljs-string">''</span>)) {
        <span class="hljs-keyword">return</span> <span class="hljs-variable">$base</span>-&gt;<span class="hljs-title function_ invoke__">toAsciiString</span>();
    }

    <span class="hljs-comment">// 只允许 http/https</span>
    <span class="hljs-keyword">if</span> (!<span class="hljs-title function_ invoke__">in_array</span>(<span class="hljs-variable">$resolved</span>-&gt;<span class="hljs-title function_ invoke__">getScheme</span>(), [<span class="hljs-string">'http'</span>, <span class="hljs-string">'https'</span>], <span class="hljs-literal">true</span>)) {
        <span class="hljs-keyword">return</span> <span class="hljs-variable">$base</span>-&gt;<span class="hljs-title function_ invoke__">toAsciiString</span>();
    }

    <span class="hljs-keyword">return</span> <span class="hljs-variable">$resolved</span>-&gt;<span class="hljs-title function_ invoke__">toAsciiString</span>();
}

<span class="hljs-keyword">echo</span> <span class="hljs-title function_ invoke__">safeRedirectTarget</span>(<span class="hljs-string">"/dashboard"</span>, <span class="hljs-string">"https://app.example.com"</span>);
</code></pre>
<p>这里用到了 base URL 解析和引用解析功能。</p>
<h4 data-id="heading-26">用例：规范 URL（SEO 和缓存的一致表示）</h4>
<p>规范化通常意味着：</p>
<ul>
<li>scheme/host 小写</li>
<li>移除 path 中的点号段</li>
<li>移除默认端口</li>
<li>query 保持一致（有时排序）</li>
<li>决定如何处理末尾斜杠</li>
</ul>
<p>使用 <code>Uri\Rfc3986\Uri</code>，你已经可以通过 <code>get*()</code> vs <code>getRaw*()</code>（以及 <code>toString()</code> vs <code>toRawString()</code>）清晰地获得规范化行为。</p>
<p>一个简单的规范化示例：</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-keyword">use</span> <span class="hljs-title">Uri</span>\<span class="hljs-title">Rfc3986</span>\<span class="hljs-title">Uri</span>;

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">canonicalizeForCache</span>(<span class="hljs-params">Uri <span class="hljs-variable">$uri</span></span>): <span class="hljs-title">Uri</span>
</span>{
    <span class="hljs-comment">// 从规范化解码的部分开始</span>
    <span class="hljs-variable">$uri</span> = <span class="hljs-variable">$uri</span>
        -&gt;<span class="hljs-title function_ invoke__">withScheme</span>(<span class="hljs-variable">$uri</span>-&gt;<span class="hljs-title function_ invoke__">getScheme</span>())
        -&gt;<span class="hljs-title function_ invoke__">withHost</span>(<span class="hljs-variable">$uri</span>-&gt;<span class="hljs-title function_ invoke__">getHost</span>())
        -&gt;<span class="hljs-title function_ invoke__">withPath</span>(<span class="hljs-variable">$uri</span>-&gt;<span class="hljs-title function_ invoke__">getPath</span>());

    <span class="hljs-comment">// 为缓存 key 排序 query 参数（这是一种策略选择）</span>
    <span class="hljs-variable">$query</span> = <span class="hljs-variable">$uri</span>-&gt;<span class="hljs-title function_ invoke__">getQuery</span>();
    <span class="hljs-keyword">if</span> (<span class="hljs-variable">$query</span>) {
        <span class="hljs-title function_ invoke__">parse_str</span>(<span class="hljs-variable">$query</span>, <span class="hljs-variable">$params</span>);
        <span class="hljs-title function_ invoke__">ksort</span>(<span class="hljs-variable">$params</span>);
        <span class="hljs-variable">$sorted</span> = <span class="hljs-title function_ invoke__">http_build_query</span>(<span class="hljs-variable">$params</span>, <span class="hljs-string">''</span>, <span class="hljs-string">'&amp;'</span>, PHP_QUERY_RFC3986);
        <span class="hljs-variable">$uri</span> = <span class="hljs-variable">$uri</span>-&gt;<span class="hljs-title function_ invoke__">withQuery</span>(<span class="hljs-variable">$sorted</span>);
    }

    <span class="hljs-keyword">return</span> <span class="hljs-variable">$uri</span>;
}

<span class="hljs-variable">$u</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Uri</span>(<span class="hljs-string">"HTTPS://EXAMPLE.COM/foo/../bar/?b=2&amp;a=1"</span>);
<span class="hljs-keyword">echo</span> <span class="hljs-title function_ invoke__">canonicalizeForCache</span>(<span class="hljs-variable">$u</span>)-&gt;<span class="hljs-title function_ invoke__">toString</span>();
</code></pre>
<p>这个函数不试图覆盖所有规范化策略（那是应用层面的事），但结构化 API 的好处是：规则可以显式构建、可以测试。</p>
<h3 data-id="heading-27">从 parse_url() + 字符串拼接迁移（不痛苦）</h3>
<p>你不需要一次性重写所有代码。最简单的迁移路径是：</p>
<p><strong>1. 找出 URL 处理对安全敏感或容易出 bug 的地方：</strong></p>
<ul>
<li>重定向</li>
<li>webhook 验证</li>
<li>签名 URL</li>
<li>域名白名单</li>
<li>路由/缓存 key</li>
</ul>
<p><strong>2. 先替换这些。</strong></p>
<p><strong>3. 纯展示用途的简单解析，等到有必要时再处理。</strong></p>
<h4 data-id="heading-28">迁移前：数组解析 + 手动重建</h4>
<pre><code class="hljs language-php" lang="php"><span class="hljs-variable">$parts</span> = <span class="hljs-title function_ invoke__">parse_url</span>(<span class="hljs-variable">$input</span>);
<span class="hljs-variable">$host</span>  = <span class="hljs-variable">$parts</span>[<span class="hljs-string">'host'</span>] ?? <span class="hljs-literal">null</span>;

<span class="hljs-keyword">if</span> (<span class="hljs-variable">$host</span> !== <span class="hljs-string">'example.com'</span>) {
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Exception</span>(<span class="hljs-string">"Bad host"</span>);
}

<span class="hljs-variable">$newUrl</span> = <span class="hljs-variable">$parts</span>[<span class="hljs-string">'scheme'</span>] . <span class="hljs-string">'://'</span> . <span class="hljs-variable">$parts</span>[<span class="hljs-string">'host'</span>] . <span class="hljs-string">'/new-path'</span>;
</code></pre>
<p>问题：</p>
<ul>
<li>没处理 port、userinfo、fragment、相对 URL</li>
<li>没有规范化</li>
<li>没有规范化选择</li>
<li>容易构建出无效输出</li>
</ul>
<h4 data-id="heading-29">迁移后：使用 Url/Uri，改动局部化</h4>
<pre><code class="hljs language-php" lang="php"><span class="hljs-keyword">use</span> <span class="hljs-title">Uri</span>\<span class="hljs-title">WhatWg</span>\<span class="hljs-title">Url</span>;

<span class="hljs-variable">$url</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Url</span>(<span class="hljs-variable">$input</span>);

<span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">strtolower</span>(<span class="hljs-variable">$url</span>-&gt;<span class="hljs-title function_ invoke__">getAsciiHost</span>() ?? <span class="hljs-string">''</span>) !== <span class="hljs-string">'example.com'</span>) {
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">InvalidArgumentException</span>(<span class="hljs-string">"Bad host"</span>);
}

<span class="hljs-variable">$new</span> = <span class="hljs-variable">$url</span>-&gt;<span class="hljs-title function_ invoke__">withPath</span>(<span class="hljs-string">'/new-path'</span>);
<span class="hljs-keyword">echo</span> <span class="hljs-variable">$new</span>-&gt;<span class="hljs-title function_ invoke__">toAsciiString</span>();
</code></pre>
<p>代码更短，意图更明确，细节上更难出错。</p>
<h4 data-id="heading-30">RFC 3986 和 WHATWG 怎么选（经验法则）</h4>
<p><strong>使用 <code>Uri\WhatWg\Url</code> 当：</strong></p>
<ul>
<li>你在处理来自浏览器/用户的 HTTP(S) URL</li>
<li>你需要 IDNA/Unicode 域名处理（<code>getUnicodeHost()</code> 用于展示，<code>getAsciiHost()</code> 用于比较）</li>
<li>你想要 WHATWG 解析行为和错误报告（软错误）</li>
</ul>
<p><strong>使用 <code>Uri\Rfc3986\Uri</code> 当：</strong></p>
<ul>
<li>你在处理"Web URL"之外的通用 URI</li>
<li>你需要 raw vs 规范化解码的表示</li>
<li>你在做签名或协议层面的工作，表示形式很重要</li>
</ul>
<p>RFC 明确区分了这两种方法，包括 Unicode/IDNA 支持的差异。</p>
<h3 data-id="heading-31">附加内容：正确比较 URL（equals() 以及为什么没有 __toString()）</h3>
<p>一个值得留意的设计：内置 URI 类故意不实现 <code>__toString()</code>，因为松散比较（<code>==</code>）容易出错。</p>
<p>取而代之，你用 <code>equals()</code> 比较：</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-keyword">use</span> <span class="hljs-title">Uri</span>\<span class="hljs-title">Rfc3986</span>\<span class="hljs-title">Uri</span>;
<span class="hljs-keyword">use</span> <span class="hljs-title">Uri</span>\<span class="hljs-title">UriComparisonMode</span>;

<span class="hljs-variable">$u1</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Uri</span>(<span class="hljs-string">"https://example.COM#foo"</span>);
<span class="hljs-variable">$u2</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Uri</span>(<span class="hljs-string">"https://EXAMPLE.COM"</span>);

<span class="hljs-title function_ invoke__">var_dump</span>(<span class="hljs-variable">$u1</span>-&gt;<span class="hljs-title function_ invoke__">equals</span>(<span class="hljs-variable">$u2</span>)); <span class="hljs-comment">// true</span>
<span class="hljs-title function_ invoke__">var_dump</span>(<span class="hljs-variable">$u1</span>-&gt;<span class="hljs-title function_ invoke__">equals</span>(<span class="hljs-variable">$u2</span>, <span class="hljs-title class_">UriComparisonMode</span>::<span class="hljs-variable constant_">IncludeFragment</span>)); <span class="hljs-comment">// false</span>
</code></pre>
<p>WHATWG 类似：</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-keyword">use</span> <span class="hljs-title">Uri</span>\<span class="hljs-title">WhatWg</span>\<span class="hljs-title">Url</span>;
<span class="hljs-keyword">use</span> <span class="hljs-title">Uri</span>\<span class="hljs-title">UriComparisonMode</span>;

<span class="hljs-variable">$a</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Url</span>(<span class="hljs-string">"https:////example.COM/"</span>);
<span class="hljs-variable">$b</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Url</span>(<span class="hljs-string">"https://EXAMPLE.COM"</span>);

<span class="hljs-title function_ invoke__">var_dump</span>(<span class="hljs-variable">$a</span>-&gt;<span class="hljs-title function_ invoke__">equals</span>(<span class="hljs-variable">$b</span>)); <span class="hljs-comment">// true</span>
</code></pre>
<h3 data-id="heading-32">结论</h3>
<p>PHP 8.5 的 URI 扩展看起来是个小功能，用一段时间后才会发现它挡掉了多少细微的 URL bug。</p>
<p>核心价值在于<strong>控制</strong>：</p>
<ul>
<li>你可以选择 RFC 3986 vs WHATWG 语义。</li>
<li>你可以决定要 raw 还是规范化解码的表示。</li>
<li>你可以不可变且安全地修改组件。</li>
<li>你可以用更难意外削弱的方式验证和比较 URL。</li>
</ul>
<p>如果你曾经发布过一个"快速 URL 修复"，后来在安全报告或生产事故中看到它，这个扩展值得尽早采用——从重定向和签名 URL 开始。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Java结合大模型文生图实战]]></title>    <link>https://juejin.cn/post/7595513077220524078</link>    <guid>https://juejin.cn/post/7595513077220524078</guid>    <pubDate>2026-01-16T06:13:45.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7595513077220524078" data-draft-id="7595619510042181670" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Java结合大模型文生图实战"/> <meta itemprop="keywords" content="AIGC"/> <meta itemprop="datePublished" content="2026-01-16T06:13:45.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="雨中飘荡的记忆"/> <meta itemprop="url" content="https://juejin.cn/user/694547077666606"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Java结合大模型文生图实战
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/694547077666606/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    雨中飘荡的记忆
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-16T06:13:45.000Z" title="Fri Jan 16 2026 06:13:45 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-16
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>Java结合大模型文生图实战</p>
<blockquote>
<p><strong>导读</strong>：随着AIGC技术的快速发展，文生图已成为软件开发中的热门功能。本文将带你从零开始，使用Java结合OpenAI的DALL-E模型，构建一个完整的文生图系统。</p>
</blockquote>
<h2 data-id="heading-0">一、技术背景与选型</h2>
<p>2023年全球AIGC市场规模达到150亿美元，预计2025年将突破500亿美元。Java作为企业级开发的主力语言，与AI大模型的结合正成为开发者关注的焦点。</p>
<h2 data-id="heading-1">为什么选择OpenAI DALL-E？</h2>
<pre><code class="hljs">✅ 技术成熟：API稳定，文档完善
✅ 效果优质：生成图片质量高
✅ 集成便捷：提供官方Java SDK
✅ 商业友好：清晰的定价模型
</code></pre>
<h2 data-id="heading-2"><strong>二、系统架构设计</strong></h2>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1386ab3fc2e54d8b89e8e7231e1eef67~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zuo5Lit6aOY6I2h55qE6K6w5b-G:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769148824&amp;x-signature=4mGg5JlUAxHy7AE4eaF8tCb0R%2F0%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-3"><strong>六层架构体系</strong>：</h2>
<pre><code class="hljs">1️⃣ 表现层：React/Vue前端
2️⃣ API网关层：认证授权、流量管理
3️⃣ 应用服务层：业务逻辑编排
4️⃣ 业务逻辑层：核心算法处理
5️⃣ 数据层：MySQL/Redis/MongoDB
6️⃣ AI服务层：OpenAI DALL-E调用
</code></pre>
<h2 data-id="heading-4"><strong>三、核心代码实现</strong></h2>
<h2 data-id="heading-5">核心依赖配置</h2>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- Spring Boot Webflux --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-webflux<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>

    <span class="hljs-comment">&lt;!-- OpenAI Client --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.theokanning.openai-gpt3-java<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>service<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>0.17.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>

    <span class="hljs-comment">&lt;!-- Caffeine缓存 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.github.ben-manes.caffeine<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>caffeine<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span>
</code></pre>
<h2 data-id="heading-6"><strong>核心类图</strong></h2>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/27d9893693224fbf9d2ada3fa85bdcaf~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zuo5Lit6aOY6I2h55qE6K6w5b-G:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769148824&amp;x-signature=gJeyeXKTZvrzeN8PaJjqHNC6v8U%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-7"><strong>五个核心类</strong>：</h2>
<pre><code class="hljs">🔹 ImageController：处理HTTP请求
🔹 OpenAiImageService：调用OpenAI API
🔹 ImageRequest：请求参数封装
🔹 ImageResponse：响应结果封装
🔹 CacheService：缓存管理
</code></pre>
<h2 data-id="heading-8">核心代码示例</h2>
<h2 data-id="heading-9">ImageRequest - 请求模型</h2>
<pre><code class="hljs language-arduino" lang="arduino">package com.example.textToImage.model;

<span class="hljs-keyword">import</span> lombok.AllArgsConstructor;
<span class="hljs-keyword">import</span> lombok.Data;
<span class="hljs-keyword">import</span> lombok.NoArgsConstructor;

<span class="hljs-keyword">import</span> javax.validation.constraints.*;

<span class="hljs-comment">/**
 * 文生图请求参数
 */</span>
@Data
@NoArgsConstructor
@AllArgsConstructor
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ImageRequest</span> {

    <span class="hljs-comment">/**
     * 提示词
     */</span>
    @<span class="hljs-built_in">NotBlank</span>(message = <span class="hljs-string">"提示词不能为空"</span>)
    @<span class="hljs-built_in">Size</span>(max = <span class="hljs-number">1000</span>, message = <span class="hljs-string">"提示词长度不能超过1000字符"</span>)
    <span class="hljs-keyword">private</span> <span class="hljs-type">String</span> prompt;

    <span class="hljs-comment">/**
     * 图片尺寸
     */</span>
    @<span class="hljs-built_in">NotNull</span>(message = <span class="hljs-string">"图片尺寸不能为空"</span>)
    <span class="hljs-keyword">private</span> ImageSize size = ImageSize.S1024X1024;

    <span class="hljs-comment">/**
     * 图片数量
     */</span>
    @<span class="hljs-built_in">Min</span>(value = <span class="hljs-number">1</span>, message = <span class="hljs-string">"图片数量至少为1"</span>)
    @<span class="hljs-built_in">Max</span>(value = <span class="hljs-number">10</span>, message = <span class="hljs-string">"图片数量最多为10"</span>)
    <span class="hljs-keyword">private</span> Integer n = <span class="hljs-number">1</span>;

    <span class="hljs-comment">/**
     * 图片风格
     */</span>
    <span class="hljs-keyword">private</span> ImageStyle style = ImageStyle.VIVID;

    <span class="hljs-comment">/**
     * 用户ID（用于缓存）
     */</span>
    <span class="hljs-keyword">private</span> <span class="hljs-type">String</span> userId;

    <span class="hljs-comment">/**
     * 图片尺寸枚举
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">enum</span> <span class="hljs-title class_">ImageSize</span> {
        <span class="hljs-built_in">S256X256</span>(<span class="hljs-string">"256x256"</span>),
        <span class="hljs-built_in">S512X512</span>(<span class="hljs-string">"512x512"</span>),
        <span class="hljs-built_in">S1024X1024</span>(<span class="hljs-string">"1024x1024"</span>);

        <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> value;

        <span class="hljs-built_in">ImageSize</span>(<span class="hljs-type">String</span> value) {
            <span class="hljs-keyword">this</span>.value = value;
        }

        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-type">String</span> <span class="hljs-title">getValue</span><span class="hljs-params">()</span> </span>{
            <span class="hljs-keyword">return</span> value;
        }
    }

    <span class="hljs-comment">/**
     * 图片风格枚举
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">enum</span> <span class="hljs-title class_">ImageStyle</span> {
        <span class="hljs-built_in">NATURAL</span>(<span class="hljs-string">"natural"</span>),
        <span class="hljs-built_in">VIVID</span>(<span class="hljs-string">"vivid"</span>);

        <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> value;

        <span class="hljs-built_in">ImageStyle</span>(<span class="hljs-type">String</span> value) {
            <span class="hljs-keyword">this</span>.value = value;
        }

        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-type">String</span> <span class="hljs-title">getValue</span><span class="hljs-params">()</span> </span>{
            <span class="hljs-keyword">return</span> value;
        }
    }
}
</code></pre>
<h2 data-id="heading-10">ImageController - REST接口</h2>
<pre><code class="hljs language-less" lang="less"><span class="hljs-selector-tag">package</span> <span class="hljs-selector-tag">com</span><span class="hljs-selector-class">.example</span><span class="hljs-selector-class">.textToImage</span><span class="hljs-selector-class">.controller</span>;

<span class="hljs-selector-tag">import</span> <span class="hljs-selector-tag">com</span><span class="hljs-selector-class">.example</span><span class="hljs-selector-class">.textToImage</span><span class="hljs-selector-class">.model</span><span class="hljs-selector-class">.ImageRequest</span>;
<span class="hljs-selector-tag">import</span> <span class="hljs-selector-tag">com</span><span class="hljs-selector-class">.example</span><span class="hljs-selector-class">.textToImage</span><span class="hljs-selector-class">.model</span><span class="hljs-selector-class">.ImageResponse</span>;
<span class="hljs-selector-tag">import</span> <span class="hljs-selector-tag">com</span><span class="hljs-selector-class">.example</span><span class="hljs-selector-class">.textToImage</span><span class="hljs-selector-class">.service</span><span class="hljs-selector-class">.OpenAiImageService</span>;
<span class="hljs-selector-tag">import</span> <span class="hljs-selector-tag">lombok</span><span class="hljs-selector-class">.extern</span><span class="hljs-selector-class">.slf4j</span><span class="hljs-selector-class">.Slf4j</span>;
<span class="hljs-selector-tag">import</span> <span class="hljs-selector-tag">org</span><span class="hljs-selector-class">.springframework</span><span class="hljs-selector-class">.beans</span><span class="hljs-selector-class">.factory</span><span class="hljs-selector-class">.annotation</span><span class="hljs-selector-class">.Autowired</span>;
<span class="hljs-selector-tag">import</span> <span class="hljs-selector-tag">org</span><span class="hljs-selector-class">.springframework</span><span class="hljs-selector-class">.http</span><span class="hljs-selector-class">.ResponseEntity</span>;
<span class="hljs-selector-tag">import</span> <span class="hljs-selector-tag">org</span><span class="hljs-selector-class">.springframework</span><span class="hljs-selector-class">.web</span><span class="hljs-selector-class">.bind</span><span class="hljs-selector-class">.annotation</span>.*;

<span class="hljs-selector-tag">import</span> <span class="hljs-selector-tag">javax</span><span class="hljs-selector-class">.validation</span><span class="hljs-selector-class">.Valid</span>;
<span class="hljs-selector-tag">import</span> <span class="hljs-selector-tag">java</span><span class="hljs-selector-class">.util</span><span class="hljs-selector-class">.Arrays</span>;
<span class="hljs-selector-tag">import</span> <span class="hljs-selector-tag">java</span><span class="hljs-selector-class">.util</span><span class="hljs-selector-class">.List</span>;
<span class="hljs-selector-tag">import</span> <span class="hljs-selector-tag">java</span><span class="hljs-selector-class">.util</span><span class="hljs-selector-class">.concurrent</span><span class="hljs-selector-class">.CompletableFuture</span>;
<span class="hljs-selector-tag">import</span> <span class="hljs-selector-tag">java</span><span class="hljs-selector-class">.util</span><span class="hljs-selector-class">.stream</span><span class="hljs-selector-class">.Collectors</span>;

<span class="hljs-comment">/**
 * 文生图控制器
 *
 * 提供RESTful API接口
 */</span>
@<span class="hljs-selector-tag">Slf4j</span>
@<span class="hljs-selector-tag">RestController</span>
@<span class="hljs-selector-tag">RequestMapping</span>(<span class="hljs-string">"/api/images"</span>)
@<span class="hljs-selector-tag">CrossOrigin</span>(origins = <span class="hljs-string">"*"</span>)
<span class="hljs-selector-tag">public</span> <span class="hljs-selector-tag">class</span> <span class="hljs-selector-tag">ImageController</span> {

    <span class="hljs-variable">@Autowired</span>
    private OpenAiImageService imageService;

    <span class="hljs-comment">/**
     * 生成图片 - 同步接口
     */</span>
    <span class="hljs-variable">@PostMapping</span>
    public ResponseEntity&lt;ImageResponse&gt; <span class="hljs-built_in">generateImage</span>(<span class="hljs-variable">@Valid</span> <span class="hljs-variable">@RequestBody</span> ImageRequest request) {
        <span class="hljs-selector-tag">log</span><span class="hljs-selector-class">.info</span>(<span class="hljs-string">"收到图片生成请求: prompt={}, size={}"</span>, request.<span class="hljs-built_in">getPrompt</span>(), request.<span class="hljs-built_in">getSize</span>());

        <span class="hljs-selector-tag">try</span> {
            <span class="hljs-selector-tag">ImageResponse</span> <span class="hljs-selector-tag">response</span> = <span class="hljs-selector-tag">imageService</span><span class="hljs-selector-class">.generateImage</span>(request);

            <span class="hljs-selector-tag">if</span> (response.<span class="hljs-built_in">getSuccess</span>()) {
                <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">ResponseEntity</span><span class="hljs-selector-class">.ok</span>(response);
            } <span class="hljs-selector-tag">else</span> {
                <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">ResponseEntity</span><span class="hljs-selector-class">.internalServerError</span>()<span class="hljs-selector-class">.body</span>(response);
            }
        } <span class="hljs-selector-tag">catch</span> (Exception e) {
            <span class="hljs-selector-tag">log</span><span class="hljs-selector-class">.error</span>(<span class="hljs-string">"图片生成请求处理失败"</span>, e);
            <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">ResponseEntity</span><span class="hljs-selector-class">.internalServerError</span>()
                    <span class="hljs-selector-class">.body</span>(ImageResponse.<span class="hljs-built_in">builder</span>()
                            .<span class="hljs-built_in">error</span>(e.<span class="hljs-built_in">getMessage</span>())
                            .<span class="hljs-built_in">success</span>(false)
                            .<span class="hljs-built_in">build</span>());
        }
    }

    <span class="hljs-comment">/**
     * 生成图片 - 异步接口
     */</span>
    @<span class="hljs-selector-tag">PostMapping</span>(<span class="hljs-string">"/async"</span>)
    <span class="hljs-selector-tag">public</span> <span class="hljs-selector-tag">CompletableFuture</span>&lt;<span class="hljs-selector-tag">ResponseEntity</span>&lt;<span class="hljs-selector-tag">ImageResponse</span>&gt;&gt; <span class="hljs-selector-tag">generateImageAsync</span>(<span class="hljs-variable">@Valid</span> <span class="hljs-variable">@RequestBody</span> ImageRequest request) {
        <span class="hljs-selector-tag">log</span><span class="hljs-selector-class">.info</span>(<span class="hljs-string">"收到异步图片生成请求: prompt={}"</span>, request.<span class="hljs-built_in">getPrompt</span>());

        <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">CompletableFuture</span><span class="hljs-selector-class">.supplyAsync</span>(() -&gt; {
            <span class="hljs-selector-tag">try</span> {
                <span class="hljs-selector-tag">ImageResponse</span> <span class="hljs-selector-tag">response</span> = <span class="hljs-selector-tag">imageService</span><span class="hljs-selector-class">.generateImage</span>(request);

                <span class="hljs-selector-tag">if</span> (response.<span class="hljs-built_in">getSuccess</span>()) {
                    <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">ResponseEntity</span><span class="hljs-selector-class">.ok</span>(response);
                } <span class="hljs-selector-tag">else</span> {
                    <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">ResponseEntity</span><span class="hljs-selector-class">.internalServerError</span>()<span class="hljs-selector-class">.body</span>(response);
                }
            } <span class="hljs-selector-tag">catch</span> (Exception e) {
                <span class="hljs-selector-tag">log</span><span class="hljs-selector-class">.error</span>(<span class="hljs-string">"异步图片生成请求处理失败"</span>, e);
                <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">ResponseEntity</span><span class="hljs-selector-class">.internalServerError</span>()
                        <span class="hljs-selector-class">.body</span>(ImageResponse.<span class="hljs-built_in">builder</span>()
                                .<span class="hljs-built_in">error</span>(e.<span class="hljs-built_in">getMessage</span>())
                                .<span class="hljs-built_in">success</span>(false)
                                .<span class="hljs-built_in">build</span>());
            }
        });
    }

    <span class="hljs-comment">/**
     * 批量生成图片
     */</span>
    @<span class="hljs-selector-tag">PostMapping</span>(<span class="hljs-string">"/batch"</span>)
    <span class="hljs-selector-tag">public</span> <span class="hljs-selector-tag">CompletableFuture</span>&lt;<span class="hljs-selector-tag">ResponseEntity</span>&lt;<span class="hljs-selector-tag">List</span>&lt;<span class="hljs-selector-tag">ImageResponse</span>&gt;&gt;&gt; <span class="hljs-selector-tag">generateImages</span>(
            <span class="hljs-variable">@Valid</span> <span class="hljs-variable">@RequestBody</span> List&lt;ImageRequest&gt; requests) {

        <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">CompletableFuture</span><span class="hljs-selector-class">.supplyAsync</span>(() -&gt; {
            <span class="hljs-selector-tag">try</span> {
                <span class="hljs-selector-tag">List</span>&lt;<span class="hljs-selector-tag">ImageResponse</span>&gt; <span class="hljs-selector-tag">responses</span> = <span class="hljs-selector-tag">requests</span><span class="hljs-selector-class">.stream</span>()
                        <span class="hljs-selector-class">.map</span>(<span class="hljs-attribute">imageService</span>::generateImage)
                        <span class="hljs-selector-class">.collect</span>(Collectors.<span class="hljs-built_in">toList</span>());

                <span class="hljs-selector-tag">boolean</span> <span class="hljs-selector-tag">allSuccess</span> = <span class="hljs-selector-tag">responses</span><span class="hljs-selector-class">.stream</span>()<span class="hljs-selector-class">.allMatch</span>(<span class="hljs-attribute">ImageResponse</span>::getSuccess);

                <span class="hljs-selector-tag">if</span> (allSuccess) {
                    <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">ResponseEntity</span><span class="hljs-selector-class">.ok</span>(responses);
                } <span class="hljs-selector-tag">else</span> {
                    <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">ResponseEntity</span><span class="hljs-selector-class">.internalServerError</span>()<span class="hljs-selector-class">.body</span>(responses);
                }
            } <span class="hljs-selector-tag">catch</span> (Exception e) {
                <span class="hljs-selector-tag">log</span><span class="hljs-selector-class">.error</span>(<span class="hljs-string">"批量图片生成请求处理失败"</span>, e);
                <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">ResponseEntity</span><span class="hljs-selector-class">.internalServerError</span>()
                        <span class="hljs-selector-class">.body</span>(Arrays.<span class="hljs-built_in">asList</span>(ImageResponse.<span class="hljs-built_in">builder</span>()
                                .<span class="hljs-built_in">error</span>(e.<span class="hljs-built_in">getMessage</span>())
                                .<span class="hljs-built_in">success</span>(false)
                                .<span class="hljs-built_in">build</span>()));
            }
        });
    }

    <span class="hljs-comment">/**
     * 生成示例图片
     */</span>
    @<span class="hljs-selector-tag">GetMapping</span>(<span class="hljs-string">"/examples"</span>)
    <span class="hljs-selector-tag">public</span> <span class="hljs-selector-tag">ResponseEntity</span>&lt;<span class="hljs-selector-tag">List</span>&lt;<span class="hljs-selector-tag">ImageRequest</span>&gt;&gt; <span class="hljs-selector-tag">getExampleRequests</span>() {
        <span class="hljs-selector-tag">List</span>&lt;<span class="hljs-selector-tag">ImageRequest</span>&gt; <span class="hljs-selector-tag">examples</span> = <span class="hljs-selector-tag">Arrays</span><span class="hljs-selector-class">.asList</span>(
                <span class="hljs-built_in">createExampleRequest</span>(<span class="hljs-string">"一只可爱的卡通猫，坐在花园里，阳光明媚"</span>, ImageRequest.ImageSize.S1024X1024, <span class="hljs-number">1</span>, ImageRequest.ImageStyle.VIVID),
                <span class="hljs-built_in">createExampleRequest</span>(<span class="hljs-string">"现代城市天际线，夜晚，霓虹灯"</span>, ImageRequest.ImageSize.S1024X1024, <span class="hljs-number">1</span>, ImageRequest.ImageStyle.NATURAL),
                <span class="hljs-built_in">createExampleRequest</span>(<span class="hljs-string">"抽象艺术，彩色几何形状"</span>, ImageRequest.ImageSize.S512X512, <span class="hljs-number">2</span>, ImageRequest.ImageStyle.VIVID)
        );

        <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">ResponseEntity</span><span class="hljs-selector-class">.ok</span>(examples);
    }

    <span class="hljs-comment">/**
     * 检查服务状态
     */</span>
    @<span class="hljs-selector-tag">GetMapping</span>(<span class="hljs-string">"/health"</span>)
    <span class="hljs-selector-tag">public</span> <span class="hljs-selector-tag">ResponseEntity</span>&lt;<span class="hljs-selector-tag">String</span>&gt; <span class="hljs-selector-tag">healthCheck</span>() {
        <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">ResponseEntity</span><span class="hljs-selector-class">.ok</span>(<span class="hljs-string">"Image Generation Service is running"</span>);
    }

    <span class="hljs-comment">/**
     * 创建请求
     */</span>
    <span class="hljs-selector-tag">private</span> <span class="hljs-selector-tag">ImageRequest</span> <span class="hljs-selector-tag">createExampleRequest</span>(String prompt, ImageRequest.ImageSize size, int n, ImageRequest.ImageStyle style) {
        <span class="hljs-selector-tag">ImageRequest</span> <span class="hljs-selector-tag">request</span> = <span class="hljs-selector-tag">new</span> <span class="hljs-selector-tag">ImageRequest</span>();
        <span class="hljs-selector-tag">request</span><span class="hljs-selector-class">.setPrompt</span>(prompt);
        <span class="hljs-selector-tag">request</span><span class="hljs-selector-class">.setSize</span>(size);
        <span class="hljs-selector-tag">request</span><span class="hljs-selector-class">.setN</span>(n);
        <span class="hljs-selector-tag">request</span><span class="hljs-selector-class">.setStyle</span>(style);
        <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">request</span>;
    }
}
</code></pre>
<h2 data-id="heading-11"><strong>OpenAiImageService</strong></h2>
<pre><code class="hljs language-scss" lang="scss">package com<span class="hljs-selector-class">.example</span><span class="hljs-selector-class">.textToImage</span><span class="hljs-selector-class">.service</span>;

import com<span class="hljs-selector-class">.example</span><span class="hljs-selector-class">.textToImage</span><span class="hljs-selector-class">.model</span><span class="hljs-selector-class">.ApiKeyConfig</span>;
import com<span class="hljs-selector-class">.example</span><span class="hljs-selector-class">.textToImage</span><span class="hljs-selector-class">.model</span><span class="hljs-selector-class">.ImageRequest</span>;
import com<span class="hljs-selector-class">.example</span><span class="hljs-selector-class">.textToImage</span><span class="hljs-selector-class">.model</span><span class="hljs-selector-class">.ImageResponse</span>;
import com<span class="hljs-selector-class">.theokanning</span><span class="hljs-selector-class">.openai</span><span class="hljs-selector-class">.image</span><span class="hljs-selector-class">.CreateImageRequest</span>;
import com<span class="hljs-selector-class">.theokanning</span><span class="hljs-selector-class">.openai</span><span class="hljs-selector-class">.image</span><span class="hljs-selector-class">.ImageResult</span>;
import com<span class="hljs-selector-class">.theokanning</span><span class="hljs-selector-class">.openai</span><span class="hljs-selector-class">.service</span><span class="hljs-selector-class">.OpenAiService</span>;
import lombok<span class="hljs-selector-class">.extern</span><span class="hljs-selector-class">.slf4j</span><span class="hljs-selector-class">.Slf4j</span>;
import org<span class="hljs-selector-class">.springframework</span><span class="hljs-selector-class">.beans</span><span class="hljs-selector-class">.factory</span><span class="hljs-selector-class">.annotation</span><span class="hljs-selector-class">.Autowired</span>;
import org<span class="hljs-selector-class">.springframework</span><span class="hljs-selector-class">.cache</span><span class="hljs-selector-class">.annotation</span><span class="hljs-selector-class">.Cacheable</span>;
import org<span class="hljs-selector-class">.springframework</span><span class="hljs-selector-class">.stereotype</span><span class="hljs-selector-class">.Service</span>;

import java<span class="hljs-selector-class">.time</span><span class="hljs-selector-class">.Duration</span>;
import java<span class="hljs-selector-class">.util</span><span class="hljs-selector-class">.Arrays</span>;
import java<span class="hljs-selector-class">.util</span><span class="hljs-selector-class">.Collections</span>;
import java<span class="hljs-selector-class">.util</span><span class="hljs-selector-class">.List</span>;
import java<span class="hljs-selector-class">.util</span><span class="hljs-selector-class">.UUID</span>;
import java<span class="hljs-selector-class">.util</span><span class="hljs-selector-class">.stream</span><span class="hljs-selector-class">.Collectors</span>;

<span class="hljs-comment">/**
 * OpenAI文生图服务实现
 *
 * 使用DALL-E 3/2模型生成图片
 * 支持多种参数配置
 */</span>
<span class="hljs-keyword">@Slf</span>4j
<span class="hljs-keyword">@Service</span>
public class OpenAiImageService {

    <span class="hljs-keyword">@Autowired</span>
    private ApiKeyConfig apiKeyConfig;

    <span class="hljs-comment">/**
     * 生成图片
     */</span>
    <span class="hljs-keyword">@Cacheable</span>(value = <span class="hljs-string">"images"</span>, key = <span class="hljs-string">"#request.prompt + '_' + #request.size + '_' + #request.style"</span>)
    public ImageResponse generateImage(ImageRequest request) {
        long startTime = System<span class="hljs-selector-class">.currentTimeMillis</span>();
        String requestId = UUID<span class="hljs-selector-class">.randomUUID</span>()<span class="hljs-selector-class">.toString</span>();

        try {
            <span class="hljs-comment">// 创建OpenAI服务</span>
            OpenAiService service = <span class="hljs-built_in">createOpenAiService</span>();

            <span class="hljs-comment">// 构建请求参数</span>
            CreateImageRequest imageRequest = <span class="hljs-built_in">buildCreateImageRequest</span>(request);

            <span class="hljs-comment">// 调用API生成图片</span>
            ImageResult result = service<span class="hljs-selector-class">.createImage</span>(imageRequest);

            <span class="hljs-comment">// 构建响应</span>
            ImageResponse response = <span class="hljs-built_in">buildResponse</span>(request, requestId, result, startTime);

            log<span class="hljs-selector-class">.info</span>("图片生成成功: requestId={}, prompt={}", requestId, request.getPrompt());
            return response;

        } catch (Exception e) {
            log<span class="hljs-selector-class">.error</span>("图片生成失败: requestId={}, prompt={}", requestId, request.getPrompt(), e);
            return <span class="hljs-built_in">buildErrorResponse</span>(requestId, e.getMessage(), startTime);
        }
    }

    <span class="hljs-comment">/**
     * 创建OpenAI服务
     */</span>
    private OpenAiService <span class="hljs-built_in">createOpenAiService</span>() {
        if (apiKeyConfig.getUseProxy() &amp;&amp; apiKeyConfig<span class="hljs-selector-class">.getProxy</span>() != null) {
            <span class="hljs-comment">// 代理配置（示例）</span>
            return new <span class="hljs-built_in">OpenAiService</span>(apiKeyConfig.getOpenaiKey(), Duration<span class="hljs-selector-class">.ofSeconds</span>(apiKeyConfig.getTimeout()));
        } else {
            <span class="hljs-comment">// 直接连接</span>
            return new <span class="hljs-built_in">OpenAiService</span>(apiKeyConfig.getOpenaiKey(), Duration<span class="hljs-selector-class">.ofSeconds</span>(apiKeyConfig.getTimeout()));
        }
    }

    <span class="hljs-comment">/**
     * 构建图片请求
     */</span>
    private CreateImageRequest <span class="hljs-built_in">buildCreateImageRequest</span>(ImageRequest request) {
        return CreateImageRequest<span class="hljs-selector-class">.builder</span>()
                <span class="hljs-selector-class">.prompt</span>(request.getPrompt())
                <span class="hljs-selector-class">.n</span>(request.getN())
                <span class="hljs-selector-class">.size</span>(request.getSize()<span class="hljs-selector-class">.getValue</span>())
                <span class="hljs-selector-class">.responseFormat</span>("url")
                <span class="hljs-selector-class">.user</span>(request.getUserId() != null ? request<span class="hljs-selector-class">.getUserId</span>() : <span class="hljs-string">"anonymous"</span>)
                .<span class="hljs-built_in">build</span>();
    }

    <span class="hljs-comment">/**
     * 构建成功响应
     */</span>
    private ImageResponse <span class="hljs-built_in">buildResponse</span>(ImageRequest request, String requestId,
                                       ImageResult result, long startTime) {
        List&lt;String&gt; urls = Arrays<span class="hljs-selector-class">.asList</span>(result.getData()<span class="hljs-selector-class">.stream</span>()
                <span class="hljs-selector-class">.map</span>(image -&gt; image.getUrl())
                <span class="hljs-selector-class">.toArray</span>(String[]::new));

        List&lt;String&gt; imageIds = Collections<span class="hljs-selector-class">.emptyList</span>(); <span class="hljs-comment">// 暂时使用空列表</span>

        return ImageResponse<span class="hljs-selector-class">.builder</span>()
                <span class="hljs-selector-class">.requestId</span>(requestId)
                <span class="hljs-selector-class">.prompt</span>(request.getPrompt())
                <span class="hljs-selector-class">.createdAt</span>(java.time.LocalDateTime.now())
                <span class="hljs-selector-class">.urls</span>(urls)
                <span class="hljs-selector-class">.imageIds</span>(imageIds)
                <span class="hljs-selector-class">.duration</span>(System.currentTimeMillis() - startTime)
                <span class="hljs-selector-class">.success</span>(true)
                <span class="hljs-selector-class">.build</span>();
    }

    <span class="hljs-comment">/**
     * 构建错误响应
     */</span>
    private ImageResponse <span class="hljs-built_in">buildErrorResponse</span>(String requestId, String errorMessage, long startTime) {
        return ImageResponse<span class="hljs-selector-class">.builder</span>()
                <span class="hljs-selector-class">.requestId</span>(requestId)
                <span class="hljs-selector-class">.error</span>(errorMessage)
                <span class="hljs-selector-class">.createdAt</span>(java.time.LocalDateTime.now())
                <span class="hljs-selector-class">.duration</span>(System.currentTimeMillis() - startTime)
                <span class="hljs-selector-class">.success</span>(false)
                <span class="hljs-selector-class">.build</span>();
    }
}
</code></pre>
<h2 data-id="heading-12">四、业务流程详解</h2>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0805a9c66498428b80e59e848aa70aaa~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zuo5Lit6aOY6I2h55qE6K6w5b-G:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769148824&amp;x-signature=T83iGvnktqU8tT1ADDDbTOGRDlo%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-13"><strong>8步完整流程</strong>：</h2>
<pre><code class="hljs">1️⃣ 用户输入文本：前端提交文本描述
2️⃣ 参数验证：校验参数格式和内容
3️⃣ 缓存查询：检查是否已生成过
4️⃣ 构建API请求：组装OpenAI请求
5️⃣ 调用OpenAI：发送图片生成请求
6️⃣ 接收响应：获取图片URL
7️⃣ 处理结果：保存到数据库
8️⃣ 返回图片：响应给用户
</code></pre>
<h2 data-id="heading-14">时序图</h2>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2caa60ec4ec946d7b19738e5a807eb95~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zuo5Lit6aOY6I2h55qE6K6w5b-G:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769148824&amp;x-signature=5Q5ko1T06kut0cPjPe8Y1ntAsco%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-15"><strong>关键交互流程</strong>：</h2>
<p>前端→控制器：POST请求</p>
<p>控制器→服务：参数验证</p>
<p>服务→缓存：查询缓存</p>
<p>服务→OpenAI：API调用</p>
<p>OpenAI→服务：返回图片URL</p>
<p>服务→缓存：更新缓存</p>
<p>服务→控制器：返回响应</p>
<h2 data-id="heading-16">五、缓存机制优化</h2>
<h2 data-id="heading-17">多级缓存策略</h2>
<h2 data-id="heading-18">L1 - Caffeine本地缓存</h2>
<p>读写速度快，适合热点数据</p>
<p>减少网络调用</p>
<h2 data-id="heading-19">L2 - Redis分布式缓存</h2>
<p>支持集群，容量大</p>
<p>集群环境数据共享</p>
<h2 data-id="heading-20">L3 - OpenAI API缓存</h2>
<p>第三方服务自带缓存</p>
<p>降低API成本</p>
<h2 data-id="heading-21">Caffeine</h2>
<pre><code class="hljs language-csharp" lang="csharp">package com.example.textToImage.demo;

import com.github.benmanes.caffeine.cache.Cache;
import com.github.benmanes.caffeine.cache.Caffeine;
import com.github.benmanes.caffeine.cache.Expiry;
import org.springframework.stereotype.Component;

import java.util.concurrent.TimeUnit;

<span class="hljs-comment">/**
 * Caffeine缓存演示类
 *
 * Caffeine缓存的基本用法和高级特性
 */</span>
@Component
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">CaffeineDemo</span> {

    <span class="hljs-comment">/**
     * 创建基础缓存
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">Cache</span>&lt;<span class="hljs-title">String</span>, <span class="hljs-title">String</span>&gt; <span class="hljs-title">createBasicCache</span>()</span> {
        <span class="hljs-keyword">return</span> Caffeine.newBuilder()
                .maximumSize(<span class="hljs-number">1000</span>) <span class="hljs-comment">// 最大缓存数量</span>
                .expireAfterWrite(<span class="hljs-number">1</span>, TimeUnit.HOURS) <span class="hljs-comment">// 写入后1小时过期</span>
                .build();
    }

    <span class="hljs-comment">/**
     * 带有自定义过期策略的缓存
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">Cache</span>&lt;<span class="hljs-title">String</span>, <span class="hljs-title">Object</span>&gt; <span class="hljs-title">createCustomExpiryCache</span>()</span> {
        <span class="hljs-keyword">return</span> Caffeine.newBuilder()
                .expireAfter(<span class="hljs-keyword">new</span> Expiry&lt;String, Object&gt;() {
                    @Override
                    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-built_in">long</span> <span class="hljs-title">expireAfterCreate</span>(<span class="hljs-params">String key, Object <span class="hljs-keyword">value</span>, <span class="hljs-built_in">long</span> currentTime</span>)</span> {
                        <span class="hljs-keyword">return</span> TimeUnit.MINUTES.toNanos(<span class="hljs-number">30</span>); <span class="hljs-comment">// 创建后30分钟过期</span>
                    }

                    @Override
                    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-built_in">long</span> <span class="hljs-title">expireAfterUpdate</span>(<span class="hljs-params">String key, Object <span class="hljs-keyword">value</span>, <span class="hljs-built_in">long</span> currentTime, <span class="hljs-built_in">long</span> currentDuration</span>)</span> {
                        <span class="hljs-keyword">return</span> currentDuration; <span class="hljs-comment">// 更新时不重置过期时间</span>
                    }

                    @Override
                    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-built_in">long</span> <span class="hljs-title">expireAfterRead</span>(<span class="hljs-params">String key, Object <span class="hljs-keyword">value</span>, <span class="hljs-built_in">long</span> currentTime, <span class="hljs-built_in">long</span> currentDuration</span>)</span> {
                        <span class="hljs-keyword">return</span> currentDuration; <span class="hljs-comment">// 读取时不重置过期时间</span>
                    }
                })
                .maximumSize(<span class="hljs-number">500</span>)
                .build();
    }

    <span class="hljs-comment">/**
     * 带有统计信息的缓存
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> Cache&lt;String, String&gt; <span class="hljs-title">createStatsCache</span>()</span> {
        <span class="hljs-keyword">return</span> Caffeine.newBuilder()
                .maximumSize(<span class="hljs-number">1000</span>)
                .recordStats() <span class="hljs-comment">// 开启统计功能</span>
                .expireAfterWrite(<span class="hljs-number">1</span>, TimeUnit.HOURS)
                .build();
    }

    <span class="hljs-comment">/**
     * 缓存操作
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">demonstrateCacheOperations</span>()</span> {
        System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"=== Caffeine缓存演示 ==="</span>);

        <span class="hljs-comment">// 创建缓存</span>
        Cache&lt;String, String&gt; cache = createBasicCache();

        <span class="hljs-comment">// 1. 基本操作</span>
        System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"\n1. 基本缓存操作:"</span>);

        <span class="hljs-comment">// 存储</span>
        cache.put(<span class="hljs-string">"user:1001"</span>, <span class="hljs-string">"张三"</span>);
        cache.put(<span class="hljs-string">"user:1002"</span>, <span class="hljs-string">"李四"</span>);
        cache.put(<span class="hljs-string">"user:1003"</span>, <span class="hljs-string">"王五"</span>);

        <span class="hljs-comment">// 获取</span>
        String user1 = cache.getIfPresent(<span class="hljs-string">"user:1001"</span>);
        System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"获取用户1001: "</span> + user1);

        <span class="hljs-comment">// 使用computeIfAbsent（原子操作）</span>
        String user4 = cache.<span class="hljs-keyword">get</span>(<span class="hljs-string">"user:1004"</span>, k -&gt; <span class="hljs-string">"新用户"</span> + k.substring(k.lastIndexOf(<span class="hljs-string">":"</span>) + <span class="hljs-number">1</span>));
        System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"获取用户1004: "</span> + user4);

        <span class="hljs-comment">// 2. 统计信息</span>
        System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"\n2. 缓存统计:"</span>);
        Cache&lt;String, String&gt; statsCache = createStatsCache();

        <span class="hljs-comment">// 模拟一些操作</span>
        <span class="hljs-keyword">for</span> (<span class="hljs-built_in">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">100</span>; i++) {
            statsCache.put(<span class="hljs-string">"key:"</span> + i, <span class="hljs-string">"value:"</span> + i);
        }

        <span class="hljs-keyword">for</span> (<span class="hljs-built_in">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">50</span>; i++) {
            statsCache.getIfPresent(<span class="hljs-string">"key:"</span> + i);
        }

        <span class="hljs-comment">// 打印统计信息</span>
        com.github.benmanes.caffeine.cache.stats.CacheStats stats = statsCache.stats();
        System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"缓存命中次数: "</span> + stats.hitCount());
        System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"缓存未命中次数: "</span> + stats.missCount());
        System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"缓存命中率: "</span> + stats.hitRate());
        System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"加载时间: "</span> + stats.totalLoadTime() + <span class="hljs-string">" ns"</span>);

        <span class="hljs-comment">// 3. 手动失效</span>
        System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"\n3. 缓存失效:"</span>);
        cache.invalidate(<span class="hljs-string">"user:1001"</span>); <span class="hljs-comment">// 单个key失效</span>
        cache.invalidateAll(); <span class="hljs-comment">// 全部失效</span>

        System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"缓存演示完成!"</span>);
    }

    <span class="hljs-comment">/**
     * 图片缓存场景
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">demonstrateImageCache</span>()</span> {
        System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"\n=== 图片缓存演示 ==="</span>);

        Cache&lt;String, <span class="hljs-built_in">byte</span>[]&gt; imageCache = Caffeine.newBuilder()
                .maximumSize(<span class="hljs-number">100</span>) <span class="hljs-comment">// 缓存100张图片</span>
                .maximumWeight(<span class="hljs-number">10</span> * <span class="hljs-number">1024</span> * <span class="hljs-number">1024</span>) <span class="hljs-comment">// 最大10MB</span>
                .expireAfterWrite(<span class="hljs-number">24</span>, TimeUnit.HOURS) <span class="hljs-comment">// 24小时过期</span>
                .build();

        <span class="hljs-comment">// 模拟图片数据</span>
        <span class="hljs-built_in">byte</span>[] smallImage = <span class="hljs-keyword">new</span> <span class="hljs-built_in">byte</span>[<span class="hljs-number">50</span> * <span class="hljs-number">1024</span>]; <span class="hljs-comment">// 50KB</span>
        <span class="hljs-built_in">byte</span>[] largeImage = <span class="hljs-keyword">new</span> <span class="hljs-built_in">byte</span>[<span class="hljs-number">2</span> * <span class="hljs-number">1024</span> * <span class="hljs-number">1024</span>]; <span class="hljs-comment">// 2MB</span>

        <span class="hljs-comment">// 存储图片</span>
        imageCache.put(<span class="hljs-string">"image:small"</span>, smallImage);
        imageCache.put(<span class="hljs-string">"image:large"</span>, largeImage);

        System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"小图片缓存状态: "</span> +
            (imageCache.getIfPresent(<span class="hljs-string">"image:small"</span>) != <span class="hljs-literal">null</span> ? <span class="hljs-string">"已缓存"</span> : <span class="hljs-string">"未缓存"</span>));
        System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"大图片缓存状态: "</span> +
            (imageCache.getIfPresent(<span class="hljs-string">"image:large"</span>) != <span class="hljs-literal">null</span> ? <span class="hljs-string">"已缓存"</span> : <span class="hljs-string">"未缓存"</span>));

        <span class="hljs-comment">// 获取缓存统计</span>
        com.github.benmanes.caffeine.cache.stats.CacheStats stats = imageCache.stats();
        System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"图片缓存命中率: "</span> + String.format(<span class="hljs-string">"%.2f%%"</span>, stats.hitRate() * <span class="hljs-number">100</span>));
    }
}
</code></pre>
<h2 data-id="heading-22">数据流转</h2>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9b40904f168e40d0a82d234f2f1c85d4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zuo5Lit6aOY6I2h55qE6K6w5b-G:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769148824&amp;x-signature=sokObZi%2FIcvu5uom26rRt4gDaEU%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-23"><strong>智能缓存查询流程</strong>：</h2>
<pre><code class="hljs">1、用户发起请求
2、验证并查询缓存
3、缓存未命中调用API
4、OpenAI生成图片
5、处理结果并缓存
6、返回结果给用户
</code></pre>
<h2 data-id="heading-24">六、性能优化与部署</h2>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e20de3c3a4d44566993e0949d237dc71~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zuo5Lit6aOY6I2h55qE6K6w5b-G:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769148824&amp;x-signature=QCo8%2Fedj%2BFofoXqJgW4SjfNJA30%3D" alt="部署图.png" loading="lazy"/></p>
<h2 data-id="heading-25">JVM参数优化</h2>
<pre><code class="hljs language-diff" lang="diff"><span class="hljs-deletion">-Xms2g -Xmx4g </span>
<span class="hljs-deletion">-XX:+UseG1GC </span>
<span class="hljs-deletion">-XX:MaxGCPauseMillis=200</span>
</code></pre>
<h2 data-id="heading-26">异步处理配置</h2>
<pre><code class="hljs language-less" lang="less"><span class="hljs-variable">@Configuration</span>
<span class="hljs-variable">@EnableAsync</span>
public class AsyncConfig {
    <span class="hljs-variable">@Bean</span>
    public Executor <span class="hljs-built_in">taskExecutor</span>() {
        <span class="hljs-selector-tag">ThreadPoolTaskExecutor</span> <span class="hljs-selector-tag">executor</span> = 
            <span class="hljs-selector-tag">new</span> <span class="hljs-selector-tag">ThreadPoolTaskExecutor</span>();
        <span class="hljs-selector-tag">executor</span><span class="hljs-selector-class">.setCorePoolSize</span>(<span class="hljs-number">5</span>);
        <span class="hljs-selector-tag">executor</span><span class="hljs-selector-class">.setMaxPoolSize</span>(<span class="hljs-number">20</span>);
        <span class="hljs-selector-tag">executor</span><span class="hljs-selector-class">.setQueueCapacity</span>(<span class="hljs-number">100</span>);
        <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">executor</span>;
    }
}
</code></pre>
<h2 data-id="heading-27">七、总结</h2>
<h2 data-id="heading-28">多模态融合</h2>
<pre><code class="hljs">文+图→图
图+图→视频
AR/VR内容生成
</code></pre>
<h2 data-id="heading-29">本地化部署</h2>
<pre><code class="hljs">模型小型化
推理优化
成本可控
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[ArcGIS Pro 实现影像波段合成]]></title>    <link>https://juejin.cn/post/7595878718171496484</link>    <guid>https://juejin.cn/post/7595878718171496484</guid>    <pubDate>2026-01-17T07:17:49.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7595878718171496484" data-draft-id="7595878718171447332" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="ArcGIS Pro 实现影像波段合成"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2026-01-17T07:17:49.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="GIS之路"/> <meta itemprop="url" content="https://juejin.cn/user/4346787284915481"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            ArcGIS Pro 实现影像波段合成
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4346787284915481/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    GIS之路
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-17T07:17:49.000Z" title="Sat Jan 17 2026 07:17:49 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-17
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">^ 关注我，带你一起学GIS ^</h2>
<h2 data-id="heading-1">前言</h2>
<blockquote>
<p>❝</p>
<p>通常，我们下载的卫星影像数据每个波段都存在一个单独的波段中，但是在生产实践中，我们往往需要由各个波段组成的完整数据集。所以，这个时候就需要进行波段合成操作。</p>
</blockquote>
<p>本节主要讲解如何在<code>ArcGIS Pro</code>中实现TIFF影像波段合成。</p>
<h2 data-id="heading-2">1. 软件环境</h2>
<p>本文使用以下软件环境，仅供参考。</p>
<p>时间：2026 年</p>
<p>操作软件：ArcGIS Pro 3.5</p>
<p>操作系统：windows 11</p>
<h2 data-id="heading-3">2. 下载卫星影像数据</h2>
<p>俗话说巧妇难为无米之炊，数据就是软件的基石，没有数据，再美好的设想都是空中楼阁。因此，第一步需要下载遥感影像数据。</p>
<p>但是，影像数据在哪里下载呢？别着急，本文都给你整理好了。</p>
<p>数据下载可参考文章：<strong><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2F5c_J7f0xkUXEv7_z0eNweQ" target="_blank" title="https://mp.weixin.qq.com/s/5c_J7f0xkUXEv7_z0eNweQ" ref="nofollow noopener noreferrer">GIS 影像数据源介绍</a></strong></p>
<hr/>
<p>如下，这是我在【地理空间数据云】平台下载的<code>landsat8</code>遥感影像。<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d84b92a0b40d4034963934177df1a031~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgR0lT5LmL6Lev:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769239069&amp;x-signature=of2Fly6Jshn0NSPXuxWzZhYbV80%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-4">3. ArcGIS Pro 软件安装</h2>
<p>要想使用<code>ArcGIS Pro</code>实现影像波段合成，那你得安装好<code>ArcGIS Pro</code>软件。</p>
<p>但是，软件安装说明不在本文的教程之内，就不进行介绍了，请未安装的同学自行解决。</p>
<h2 data-id="heading-5">4. 波段合成</h2>
<p>好了，经过上面一堆废话，下面正式进入主题，进行实操。</p>
<p>如果有过<code>ArcGIS</code>版本软件基础的同学，可以很快完成，因为<code>ArcGIS Pro</code>和<code>ArcGIS</code>的工具设置大体相同。</p>
<p>我们首先需要找到数据处理工具箱。点击菜单栏分析按钮<code>Analysis</code>，然后再点击工具<code>Tools</code><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f7c8076dc07845479102d90dd17d308a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgR0lT5LmL6Lev:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769239069&amp;x-signature=OSDuOcG9NRBTxxGad5f1WlZlJ4U%3D" alt="" loading="lazy"/></p>
<p>或者点击软件搜索框中，其中会出现推荐的地理处理工具箱。<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a5fff6d3407a4e3fb2f8374db9359252~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgR0lT5LmL6Lev:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769239069&amp;x-signature=X%2Fx9moBCXTD6c%2FQQoVqsTsQ%2BLPs%3D" alt="" loading="lazy"/></p>
<p>打开工具之后，点击数据数据处理工具<code>Data Management Tools</code>。<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f1b3e6e05dec4467bd3e8cc4b681b24d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgR0lT5LmL6Lev:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769239069&amp;x-signature=iebeNhWxQ7lVOPMgrOmx7O72sG0%3D" alt="" loading="lazy"/></p>
<p>然后依次点击栅格<code>Raster</code>、栅格处理<code>Raster Processing</code>、波段合成<code>Composite Bands</code>即可。<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8f510cb90a704b508a978116ba2ef779~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgR0lT5LmL6Lev:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769239069&amp;x-signature=AG0UNLFjvlcGr5GK9ZclORqIJYI%3D" alt="" loading="lazy"/></p>
<p>如果你觉得上述操作路径太长，或者你熟悉操作工具名称的话，可以直接在页面顶部搜索框输入工具名称<code>Composite Bands</code>进行检索。<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ec6b42d3a9c24b4084223de64da05b7c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgR0lT5LmL6Lev:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769239069&amp;x-signature=flCgGSeanif6XunNBJTROOpdmpk%3D" alt="" loading="lazy"/>又或者在地理处理搜索框输入工具名称<code>Composite Bands</code>进行检索。<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d8b25223e45d456ca4e3abab70ecb9ff~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgR0lT5LmL6Lev:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769239069&amp;x-signature=uewFzBIH4aBse9eAYUXx0R5GtOw%3D" alt="" loading="lazy"/></p>
<p>打开波段合成工具，先在输入栅格中选择需要进行合成的波段数据，然后选择输出位置，最后点击运行。<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/89bacb94e89a4131ab6db1d68c3a1f2b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgR0lT5LmL6Lev:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769239069&amp;x-signature=usZeSG6NRqEdp5fd4rzI5%2B8nnyQ%3D" alt="" loading="lazy"/></p>
<p>如下为波段4、波段3、波段2合成的彩色效果图。<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/34917ce015fd4ce5ade7870358129a15~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgR0lT5LmL6Lev:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769239069&amp;x-signature=MNASd9tuC3QJLLRCmt16Popl%2FCQ%3D" alt="" loading="lazy"/></p>
<p>如下为波段5、波段4、波段3合成的彩色效果图。<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3587d067d40a452a861ee370223a94fa~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgR0lT5LmL6Lev:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769239069&amp;x-signature=M7mI4xsjsA1YzXz9QXb1%2BHchzoA%3D" alt="" loading="lazy"/></p>
<p>可在属性中查看源数据信息，其中三个波段显示如下。<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/443efe33146949759ecf91f538658ada~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgR0lT5LmL6Lev:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769239069&amp;x-signature=W0KAGiPSKV0nywM84wscE6SFm%2FY%3D" alt="" loading="lazy"/></p>
<p><strong><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a464e74f3dd1474297f5c6b912c7c142~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgR0lT5LmL6Lev:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769239069&amp;x-signature=DrwtKbkVjkCn%2BWP5e32RMwsFZAs%3D" alt="" loading="lazy"/></strong></p>
<blockquote>
<p>❝</p>
<p>OpenLayers示例数据下载，请在公众号后台回复：<strong>ol数据</strong></p>
<p>全国信息化工程师－GIS 应用水平考试资料，请在公众号后台回复：<strong>GIS考试</strong></p>
</blockquote>
<blockquote>
<p>❝</p>
<p><em><strong>GIS之路</strong></em> 公众号已经接入了<strong>智能</strong> <strong>助手</strong>，可以在对话框进行提问，也可以直接搜索历史文章进行查看。</p>
</blockquote>
<p>都看到这了，不要忘记<em><strong>点赞、收藏</strong></em> <strong>+</strong> <em><strong>关注</strong></em> 哦 <strong>！</strong></p>
<p>本号不定时更新有关 <em><strong>GIS开发</strong></em> 相关内容，<em><strong>欢迎关注 <img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/98fb3fd9bb7a4811aea7749e685e59ad~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgR0lT5LmL6Lev:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769239069&amp;x-signature=xDF%2Bixl%2FX68BrkFtZzyeGWri1zs%3D" alt="" loading="lazy"/><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/73ee6be123244a598088074583d02a14~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgR0lT5LmL6Lev:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769239069&amp;x-signature=2D81qCPIatgudDFCfp6FwhehdK4%3D" alt="" loading="lazy"/></strong></em></p>
<hr/>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7df248a6f1614c67a274cebeaad1fd51~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgR0lT5LmL6Lev:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769239069&amp;x-signature=aQ2DqpsmJynDTpbZt5kktnADd2g%3D" alt="" loading="lazy"/></p>
<p>   <img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ca3c1964cf644a608241df989ebf3ed7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgR0lT5LmL6Lev:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769239069&amp;x-signature=zzPiuq4%2BaowJ0pxpdjAM1Gx%2FwNA%3D" alt="" loading="lazy"/> </p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzkwOTEzNjI5NQ%3D%3D%26mid%3D2247487953%26idx%3D1%26sn%3D0b2d5aeefdb290583cf8cdd82f3c2077%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzkwOTEzNjI5NQ==&amp;mid=2247487953&amp;idx=1&amp;sn=0b2d5aeefdb290583cf8cdd82f3c2077&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">GeoTools 开发合集（全）</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzkwOTEzNjI5NQ%3D%3D%26mid%3D2247487119%26idx%3D1%26sn%3Dc313efa84c27bf933ef2f2a47991ef2d%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzkwOTEzNjI5NQ==&amp;mid=2247487119&amp;idx=1&amp;sn=c313efa84c27bf933ef2f2a47991ef2d&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">OpenLayers 开发合集</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FwkHv2NnJfuPhtyjJcFLrEQ" target="_blank" title="https://mp.weixin.qq.com/s/wkHv2NnJfuPhtyjJcFLrEQ" ref="nofollow noopener noreferrer">GDAL 实现矢量数据转换处理（全）</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FMZIQ57Ka3NQfKFi9AuEQEg" target="_blank" title="https://mp.weixin.qq.com/s/MZIQ57Ka3NQfKFi9AuEQEg" ref="nofollow noopener noreferrer">GDAL 实现投影转换</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FQVFiW5C5wXQ6a1WODCaH0g" target="_blank" title="https://mp.weixin.qq.com/s/QVFiW5C5wXQ6a1WODCaH0g" ref="nofollow noopener noreferrer">自然资源部党组关于苗泽等4名同志职务任免的通知</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FSX2u2ww1iNOtqR5m3BE93g" target="_blank" title="https://mp.weixin.qq.com/s/SX2u2ww1iNOtqR5m3BE93g" ref="nofollow noopener noreferrer">国产版的Google Earth，吉林一号卫星App“共生地球”来了</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FfWufqSyplniNj4Q3BRRbAQ" target="_blank" title="https://mp.weixin.qq.com/s/fWufqSyplniNj4Q3BRRbAQ" ref="nofollow noopener noreferrer">2026年全国自然资源工作会议召开</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FRq7mCSrKU7DA7WRGDEy6Cg" target="_blank" title="https://mp.weixin.qq.com/s/Rq7mCSrKU7DA7WRGDEy6Cg" ref="nofollow noopener noreferrer">日本欲打造“本土版”星链系统</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FEqpOD--IdOUO6gyzwBc6RA" target="_blank" title="https://mp.weixin.qq.com/s/EqpOD--IdOUO6gyzwBc6RA" ref="nofollow noopener noreferrer">吉林一号国内首张高分辨率彩色夜光卫星影像发布</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FznfhqB1_3JbQHG7CEqWSCw" target="_blank" title="https://mp.weixin.qq.com/s/znfhqB1_3JbQHG7CEqWSCw" ref="nofollow noopener noreferrer">2025 年度信创领军企业名单出炉！</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[你的手势冲突解决了吗？鸿蒙事件拦截机制全解析]]></title>    <link>https://juejin.cn/post/7595552420047568939</link>    <guid>https://juejin.cn/post/7595552420047568939</guid>    <pubDate>2026-01-16T08:00:04.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7595552420047568939" data-draft-id="7595552420047552555" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="你的手势冲突解决了吗？鸿蒙事件拦截机制全解析"/> <meta itemprop="keywords" content="HarmonyOS,ArkTS,ArkUI"/> <meta itemprop="datePublished" content="2026-01-16T08:00:04.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="威哥爱编程"/> <meta itemprop="url" content="https://juejin.cn/user/2242659450109575"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            你的手势冲突解决了吗？鸿蒙事件拦截机制全解析
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2242659450109575/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    威哥爱编程
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-16T08:00:04.000Z" title="Fri Jan 16 2026 08:00:04 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-16
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    13
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>哈喽，兄弟们，我是 V 哥！
在鸿蒙开发中，尤其是做复杂的交互页面（比如<strong>列表里套按钮</strong>、<strong>横滑菜单</strong>、<strong>地图缩放</strong>）时，手势事件就像是一群调皮的孩子，谁都想抢着接盘。如果你不管好他们，App的体验会差强人意。</p>
<p>关于鸿蒙API 21 的事件拦截机制。这三招，专治各种“乱跳”、“误触”和“滑动失效”。代码我都给你写好了，直接复制就能治好你的 App！</p>
<hr/>
<h2 data-id="heading-0">痛点一：点击冒泡 —— “我点的按钮，你关列表什么事？”</h2>
<h3 data-id="heading-1">📜 案发现场</h3>
<p>最常见的场景：一个 <code>ListItem</code> 本身是可以点击跳转详情的，但里面有一个“删除”按钮。
用户想点删除，结果手指稍微偏了一点点，或者系统判定失误，不仅删除了数据，还顺手跳到了详情页。用户体验极其糟糕。</p>
<h3 data-id="heading-2">🔍 原理剖析</h3>
<p>这是典型的<strong>事件冒泡</strong>。触摸事件从子组件（按钮）传递到父组件（列表项）。子组件处理完了，如果没说“别传了”，父组件就会觉得：“哦？有人点了我的地盘？那我也响应一下吧。”</p>
<h3 data-id="heading-3">✅ V 哥的一招制敌：hitTestBehavior</h3>
<p>我们要做的就是：<strong>给子组件（按钮）设个“路障”，告诉父组件：这事我办了，你别插手！</strong></p>
<hr/>
<h2 data-id="heading-4">痛点二：滑动打架 —— “我想横滑，你非要竖着滚？”</h2>
<h3 data-id="heading-5">📜 案发现场</h3>
<p>你在做一个音乐播放器，进度条支持横向拖动。但是，这个播放器是放在一个 <code>Scroll</code>（垂直滚动）容器里的。
当你想拖动进度条时，手指稍微带点垂直角度，页面就开始上下滚动，进度条根本拖不动。</p>
<h3 data-id="heading-6">🔍 原理剖析</h3>
<p>父容器的 <code>VerticalScroll</code>（垂直滚动手势）和子组件的 <code>PanGesture</code>（拖动手势）发生了<strong>竞争</strong>。系统不知道你是想切歌还是想看歌词。</p>
<h3 data-id="heading-7">✅ V 哥的一招制敌：PanGesture &amp; ParallelGesture</h3>
<p>我们需要精细化控制手势的<strong>方向</strong>和<strong>并发模式</strong>。</p>
<hr/>
<h2 data-id="heading-8">代码案例</h2>
<p>我们打开 DevEco Studio 6.0，新建一个页面 <code>GestureDemo.ets</code>。这段代码包含了上面两个问题的完整解决方案，跑一遍你就全懂了。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> promptAction <span class="hljs-keyword">from</span> <span class="hljs-string">'@ohos.promptAction'</span>;

<span class="hljs-meta">@Entry</span>
<span class="hljs-meta">@Component</span>
struct <span class="hljs-title class_">GestureDemo</span> {
  <span class="hljs-meta">@State</span> <span class="hljs-attr">deleteLog</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">'操作日志：等待操作...'</span>;

  <span class="hljs-title function_">build</span>(<span class="hljs-params"/>) {
    <span class="hljs-title class_">Column</span>() {
      <span class="hljs-title class_">Text</span>(<span class="hljs-string">'V哥的手势冲突诊疗室'</span>)
        .<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">24</span>)
        .<span class="hljs-title function_">fontWeight</span>(<span class="hljs-title class_">FontWeight</span>.<span class="hljs-property">Bold</span>)
        .<span class="hljs-title function_">margin</span>({ <span class="hljs-attr">top</span>: <span class="hljs-number">30</span>, <span class="hljs-attr">bottom</span>: <span class="hljs-number">20</span> })

      <span class="hljs-comment">// ==========================================</span>
      <span class="hljs-comment">// 场景一：点击冲突（冒泡问题）</span>
      <span class="hljs-comment">// ==========================================</span>
      <span class="hljs-title class_">Text</span>(<span class="hljs-string">'场景1：列表项点击 vs 按钮点击'</span>)
        .<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">18</span>)
        .<span class="hljs-title function_">margin</span>({ <span class="hljs-attr">bottom</span>: <span class="hljs-number">10</span> })
        .<span class="hljs-title function_">fontColor</span>(<span class="hljs-string">'#666'</span>)

      <span class="hljs-comment">// 模拟一个列表项</span>
      <span class="hljs-title class_">Row</span>() {
        <span class="hljs-title class_">Text</span>(<span class="hljs-string">'V哥的鸿蒙实战教程.mp4'</span>)
          .<span class="hljs-title function_">layoutWeight</span>(<span class="hljs-number">1</span>)
        
        <span class="hljs-title class_">Button</span>(<span class="hljs-string">'删除'</span>)
          .<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">14</span>)
          .<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-title class_">Color</span>.<span class="hljs-property">Red</span>)
          .<span class="hljs-title function_">padding</span>({ <span class="hljs-attr">left</span>: <span class="hljs-number">12</span>, <span class="hljs-attr">right</span>: <span class="hljs-number">12</span> })
          <span class="hljs-comment">// --- V哥的关键神技 ---</span>
          <span class="hljs-comment">// HitTestMode.Block 表示：我（按钮）是挡箭牌。</span>
          <span class="hljs-comment">// 只要点击落在按钮区域，就由我处理，绝不传给父组件 Row。</span>
          <span class="hljs-comment">// 这样父组件的 onClick 就不会被误触了！</span>
          .<span class="hljs-title function_">hitTestBehavior</span>(<span class="hljs-title class_">HitTestMode</span>.<span class="hljs-property">Block</span>)
          .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {
            <span class="hljs-variable language_">this</span>.<span class="hljs-property">deleteLog</span> = <span class="hljs-string">'🔥 操作：点击了【删除】按钮（父组件被拦截）'</span>;
            promptAction.<span class="hljs-title function_">showToast</span>({ <span class="hljs-attr">message</span>: <span class="hljs-string">'删除成功！'</span> });
          })
      }
      .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)
      .<span class="hljs-title function_">padding</span>(<span class="hljs-number">15</span>)
      .<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-string">'#F1F3F5'</span>)
      .<span class="hljs-title function_">borderRadius</span>(<span class="hljs-number">8</span>)
      .<span class="hljs-title function_">margin</span>({ <span class="hljs-attr">bottom</span>: <span class="hljs-number">20</span> })
      .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {
        <span class="hljs-comment">// 点击 Row 的空白处会触发这里，但点按钮不会</span>
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">deleteLog</span> = <span class="hljs-string">'📖 操作：点击了【列表项】，应该跳转详情'</span>;
      })

      <span class="hljs-comment">// ==========================================</span>
      <span class="hljs-comment">// 场景二：滑动冲突（纵横问题）</span>
      <span class="hljs-comment">// ==========================================</span>
      <span class="hljs-title class_">Text</span>(<span class="hljs-string">'场景2：竖向滚动 vs 横向拖拽'</span>)
        .<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">18</span>)
        .<span class="hljs-title function_">margin</span>({ <span class="hljs-attr">bottom</span>: <span class="hljs-number">10</span> })
        .<span class="hljs-title function_">fontColor</span>(<span class="hljs-string">'#666'</span>)

      <span class="hljs-comment">// 外层：竖向滚动容器</span>
      <span class="hljs-title class_">Scroll</span>() {
        <span class="hljs-title class_">Column</span>() {
          <span class="hljs-title class_">Text</span>(<span class="hljs-string">'这是顶部内容'</span>)
            .<span class="hljs-title function_">height</span>(<span class="hljs-number">100</span>)
            .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)
            .<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-title class_">Color</span>.<span class="hljs-property">Pink</span>)

          <span class="hljs-comment">// 这是一个专门用于横向拖拽的区域</span>
          <span class="hljs-title class_">Row</span>() {
            <span class="hljs-title class_">Text</span>(<span class="hljs-string">'拖动我 -&gt; '</span>)
              .<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">16</span>)
            <span class="hljs-title class_">Text</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">value</span>.<span class="hljs-title function_">toString</span>())
              .<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">16</span>)
          }
          .<span class="hljs-title function_">width</span>(<span class="hljs-string">'90%'</span>)
          .<span class="hljs-title function_">height</span>(<span class="hljs-number">100</span>)
          .<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-title class_">Color</span>.<span class="hljs-property">Orange</span>)
          .<span class="hljs-title function_">borderRadius</span>(<span class="hljs-number">8</span>)
          .<span class="hljs-title function_">justifyContent</span>(<span class="hljs-title class_">FlexAlign</span>.<span class="hljs-property">Center</span>)
          .<span class="hljs-title function_">margin</span>({ <span class="hljs-attr">top</span>: <span class="hljs-number">20</span> })
          <span class="hljs-comment">// --- V哥的关键神技 ---</span>
          <span class="hljs-comment">// 1. 定义一个横向拖动手势</span>
          .<span class="hljs-title function_">gesture</span>(
            <span class="hljs-title class_">PanGesture</span>({ <span class="hljs-attr">direction</span>: <span class="hljs-title class_">PanDirection</span>.<span class="hljs-property">Horizontal</span> })
              .<span class="hljs-title function_">onActionStart</span>(<span class="hljs-function">() =&gt;</span> {
                <span class="hljs-variable language_">this</span>.<span class="hljs-property">deleteLog</span> = <span class="hljs-string">'🤚 操作：开始【横向】拖拽'</span>;
              })
              .<span class="hljs-title function_">onActionUpdate</span>(<span class="hljs-function">(<span class="hljs-params">event: GestureEvent</span>) =&gt;</span> {
                <span class="hljs-comment">// V哥演示：简单累加一下偏移量</span>
                <span class="hljs-variable language_">this</span>.<span class="hljs-property">value</span> += event.<span class="hljs-property">offsetX</span>;
              })
          )

          <span class="hljs-title class_">Text</span>(<span class="hljs-string">'这是底部内容，多撑开点高度'</span>)
            .<span class="hljs-title function_">height</span>(<span class="hljs-number">400</span>)
            .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)
            .<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-title class_">Color</span>.<span class="hljs-property">Grey</span>)
        }
        .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)
      }
      .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)
      .<span class="hljs-title function_">height</span>(<span class="hljs-number">300</span>)
      .<span class="hljs-title function_">scrollable</span>(<span class="hljs-title class_">ScrollDirection</span>.<span class="hljs-property">Vertical</span>) <span class="hljs-comment">// 申明竖向滚动</span>
      .<span class="hljs-title function_">border</span>({ <span class="hljs-attr">width</span>: <span class="hljs-number">2</span>, <span class="hljs-attr">color</span>: <span class="hljs-title class_">Color</span>.<span class="hljs-property">Blue</span> })

      <span class="hljs-comment">// 日志显示</span>
      <span class="hljs-title class_">Text</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">deleteLog</span>)
        .<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">14</span>)
        .<span class="hljs-title function_">fontColor</span>(<span class="hljs-string">'#333'</span>)
        .<span class="hljs-title function_">margin</span>({ <span class="hljs-attr">top</span>: <span class="hljs-number">20</span> })
        .<span class="hljs-title function_">padding</span>(<span class="hljs-number">10</span>)
        .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)
        .<span class="hljs-title function_">borderRadius</span>(<span class="hljs-number">5</span>)
        .<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-string">'#E0E0E0'</span>)

    }
    .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)
    .<span class="hljs-title function_">height</span>(<span class="hljs-string">'100%'</span>)
    .<span class="hljs-title function_">padding</span>({ <span class="hljs-attr">left</span>: <span class="hljs-number">20</span>, <span class="hljs-attr">right</span>: <span class="hljs-number">20</span> })
  }

  <span class="hljs-comment">// 用于存储滑块值的变量</span>
  <span class="hljs-meta">@State</span> <span class="hljs-attr">value</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">0</span>;
}
</code></pre>
<hr/>
<h2 data-id="heading-9">复盘一下：手势机制的三个“挡箭牌”</h2>
<p>代码跑通了，咱们得把 API 21 里的这几个参数吃透，以后遇到变种 Bug 也能一招制敌。</p>
<h3 data-id="heading-10">1. hitTestBehavior 的四个境界</h3>
<p>这是最常用的属性，修饰在组件上。</p>
<ul>
<li>
<p><strong><code>HitTestMode.Default</code>（默认）</strong>：</p>
<ul>
<li>特点：该谁是谁。如果组件本身是 <code>Button</code> 这类可点击的，它就拦截；如果是 <code>Text</code> 这种，它就放行给父组件。</li>
<li><strong>V 哥吐槽</strong>：有时候系统误判，导致布局透明的 <code>Row</code> 挡住了下层按钮，这时候你就得改它。</li>
</ul>
</li>
<li>
<p><strong><code>HitTestMode.None</code>（透明人）</strong>：</p>
<ul>
<li>特点：<strong>我不拦截</strong>。点击我这个区域，就好像我不存在一样，事件直接穿透我，传给我的孩子或者兄弟。</li>
<li><strong>场景</strong>：你做了一个复杂的背景布局，但不想它挡住背后的按钮。</li>
</ul>
</li>
<li>
<p><strong><code>HitTestMode.Block</code>（拦路虎）</strong>：🌟 <strong>V 哥推荐</strong></p>
<ul>
<li>特点：<strong>我全收了</strong>。不管我下面是什么，只要点到我，我就处理，绝不往外传。</li>
<li><strong>场景</strong>：这就是咱们代码里解决“列表里套按钮”的神器。给按钮加上它，父组件再也不会误触跳转。</li>
</ul>
</li>
<li>
<p><strong><code>HitTestMode.Transparent</code>（传声筒）</strong>：</p>
<ul>
<li>特点：我拦截到事件后，处理完，还要传给父组件。</li>
<li><strong>场景</strong>：很少用，除非你想实现“点子组件，父子一起动”的效果（通常不推荐，容易乱）。</li>
</ul>
</li>
</ul>
<h3 data-id="heading-11">2. 手势的优先级</h3>
<p>如果两个手势都想响应，听谁的？</p>
<ul>
<li><strong>系统默认</strong>：<code>TapGesture</code> (点击) &gt; <code>LongPressGesture</code> (长按) &gt; <code>PanGesture</code> (拖动) &gt; <code>PinchGesture</code> (捏合)。</li>
<li><strong>手动干预</strong>：如果你想强行让某个手势优先，可以用 <code>priorityGesture</code> 包裹手势。</li>
</ul>
<pre><code class="hljs language-typescript" lang="typescript">    .<span class="hljs-title function_">gesture</span>(
      <span class="hljs-comment">// 即使父组件想滚动，子组件的横向拖动优先级更高</span>
      <span class="hljs-title function_">priorityGesture</span>(<span class="hljs-title class_">PanGesture</span>({ <span class="hljs-attr">direction</span>: <span class="hljs-title class_">PanDirection</span>.<span class="hljs-property">Horizontal</span> }))
    )
</code></pre>
<h3 data-id="heading-12">3. 并发手势</h3>
<p>如果两个手势可以<strong>同时发生</strong>（比如一边缩放一边旋转），用 <code>GestureGroup</code> 配合 <code>GestureMode.Parallel</code>。
不过，对于大多数“纵横冲突”，鸿蒙系统 API 21 已经能很智能地通过 <code>PanGesture</code> 的 <code>direction</code> 属性自动区分方向了。如果你发现它分不清，通常是<strong>布局重叠</strong>或者<strong>触摸区域设置不合理</strong>导致的。</p>
<hr/>
<h2 data-id="heading-13">小结一下</h2>
<p>下次再做列表、相册、播放器的时候，把这三招拿出来，产品经理看你的眼神绝对不一样！</p>
<ol>
<li><strong>怕误触（点击冲突）</strong>：给按钮加 <strong><code>hitTestBehavior(HitTestMode.Block)</code></strong>。</li>
<li><strong>怕抢滑（滑动冲突）</strong>：给子组件绑定明确方向的 <strong><code>PanGesture</code></strong>，必要时加 <strong><code>priorityGesture</code></strong>。</li>
<li><strong>怕透传</strong>：给遮挡层加 <strong><code>hitTestBehavior(HitTestMode.None)</code></strong>。</li>
</ol>
<p>我是V哥，咱们下期技术复盘见！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[【Linux】文件系统与 fsck.ext4 修复 - 我踩过的坑与总结]]></title>    <link>https://juejin.cn/post/7595994039108173860</link>    <guid>https://juejin.cn/post/7595994039108173860</guid>    <pubDate>2026-01-17T07:27:41.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7595994039108173860" data-draft-id="7595878718171562020" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="【Linux】文件系统与 fsck.ext4 修复 - 我踩过的坑与总结"/> <meta itemprop="keywords" content="运维,Linux"/> <meta itemprop="datePublished" content="2026-01-17T07:27:41.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Kida的躺平小屋"/> <meta itemprop="url" content="https://juejin.cn/user/1684864740889758"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            【Linux】文件系统与 fsck.ext4 修复 - 我踩过的坑与总结
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1684864740889758/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Kida的躺平小屋
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-17T07:27:41.000Z" title="Sat Jan 17 2026 07:27:41 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-17
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>承接上一回，这期依然是 Linux 的总结。但这次我想聊聊文件系统和 fsck，这个我踩过千百遍的坑。</p>
<h2 data-id="heading-0">一、首先什么是 fsck？</h2>
<p>在我早期使用 Linux 的时候，对磁盘问题的理解非常肤浅：</p>
<blockquote>
<p>“系统起不来了？那就 fsck 一下试试。”</p>
</blockquote>
<p>直到我遇到 <strong>ext4 分区无法挂载、系统进入 emergency mode、fsck 直接报错</strong>，我才意识到：<br/>
<strong>fsck 不是“万能修复键”，而是“最后的外科手术刀”。</strong></p>
<p>理解下面三件事，对我来说是分水岭：</p>
<ol>
<li><strong>什么时候能用 fsck，什么时候绝对不能用</strong></li>
<li><strong>fsck 到底在“修什么”</strong></li>
<li><strong>哪些参数会救命，哪些参数会毁数据</strong></li>
</ol>
<h2 data-id="heading-1">二、fsck 在 Linux 中的定位</h2>
<p>从本质上讲：</p>
<blockquote>
<p><strong>fsck（File System Consistency Check）是用来“校验并修复文件系统结构一致性”的工具，而不是数据恢复工具。</strong></p>
</blockquote>
<p>它主要检查和修复的是：</p>
<ul>
<li>superblock（超级块）</li>
<li>inode 表</li>
<li>block bitmap</li>
<li>inode bitmap</li>
<li>目录结构与引用关系</li>
</ul>
<p><strong>值得注意的是 fsck 关心的是“结构是否一致”，它是不保证你的文件内容“正确或完整”的。</strong></p>
<h2 data-id="heading-2">三、在 fsck 之前必做的三件事（重点）</h2>
<h3 data-id="heading-3">1.确认分区没有被挂载</h3>
<p>fsck 对“已挂载分区”执行是极其危险的行为。我通常用：</p>
<pre><code class="hljs language-bash" lang="bash">mount | grep sda
lsblk
</code></pre>
<p>如果是根分区：</p>
<ul>
<li>必须进入单用户模式</li>
<li>或使用 Live CD / 救援系统</li>
</ul>
<h3 data-id="heading-4">2.能备份就先备份（哪怕是 dd）</h3>
<p>如果磁盘还能读，我至少会做一份原始镜像：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">dd</span> <span class="hljs-keyword">if</span>=/dev/sda of=/backup/sda.img bs=4M status=progress
</code></pre>
<p>我宁愿慢，总比事后后悔强。</p>
<h3 data-id="heading-5">3.搞清楚文件系统类型</h3>
<pre><code class="hljs language-bash" lang="bash">blkid
lsblk -f
</code></pre>
<p>确认是 ext4，而不是 xfs / btrfs</p>
<h2 data-id="heading-6">四、fsck.ext4 的核心用法</h2>
<h3 data-id="heading-7">1.基础检查（只读，不修改）</h3>
<pre><code class="hljs language-bash" lang="bash">fsck.ext4 -n /dev/sda1
</code></pre>
<p>一般我会采用 -n（不做任何修改）参数先做一次评估，先看损坏程度。</p>
<h3 data-id="heading-8">2.自动修复（踩坑最多）</h3>
<pre><code class="hljs language-bash" lang="bash">fsck.ext4 -y /dev/sda1
</code></pre>
<p>这可以算是我踩坑最多的参数，-y（对所有修复询问自动回答 yes）。以前常用，现在的话只在我已经有备份，或别无选择时使用。</p>
<h3 data-id="heading-9">3.指定备用 superblock 修复</h3>
<p>这是我最常“救活”分区的一招。先查看备用 superblock：</p>
<pre><code class="hljs language-bash" lang="bash">dumpe2fs /dev/sda1 | grep -i superblock
</code></pre>
<p>然后指定一个：</p>
<pre><code class="hljs language-bash" lang="bash">fsck.ext4 -b 32768 /dev/sda1
</code></pre>
<h2 data-id="heading-10">五、lost+found？</h2>
<p>fsck 修复后，经常会看到：</p>
<pre><code class="hljs language-bash" lang="bash">/lost+found
</code></pre>
<p>里面是：</p>
<ul>
<li>找不到原目录结构的 inode</li>
<li>文件名通常是数字</li>
</ul>
<p>我的过往经验是若是小文件，那一般内容还算是完整的，如果是大文件（譬如，数据库、镜像等）那么可用性就不高了，那如果是目录结构的话，那基本就不可能完全恢复的。那么我的做法是：</p>
<ul>
<li>逐个 file + less 判断</li>
<li>能确认用途的，手动归位</li>
<li>其余长期留档，不轻易删除</li>
</ul>
<h2 data-id="heading-11">六、我踩过的坑（血的教训）</h2>
<h3 data-id="heading-12">1.在已挂载的根分区上跑 fsck</h3>
<p>结果可想而知，文件系统状态直接混乱，最后只能进救援系统重修。这也让我意识到 “fsck ≠ 在线修复工具” 这个道理。</p>
<h3 data-id="heading-13">2.对 XFS 分区使用 fsck.ext4</h3>
<p>fsck 根本就“看不懂”，并且造成二次损坏。后面我知道了 XFS 用 xfs_repair，只有 ext4 才用 fsck.ext4。</p>
<h2 data-id="heading-14">七、我现在的做法</h2>
<p>说实话，我并不想经常用 fsck。现在我更倾向于：</p>
<ul>
<li>RAID + 定期 SMART 检测</li>
<li>UPS 防断电</li>
<li>日志与业务数据分盘</li>
<li>关键数据 快照 + 备份</li>
<li>新系统优先考虑 btrfs / zfs</li>
</ul>
<p>fsck 对我来说，已经变成了“最后的止血手段”，而不是常规维护方式。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Caffeine入门到实战]]></title>    <link>https://juejin.cn/post/7595841630677106739</link>    <guid>https://juejin.cn/post/7595841630677106739</guid>    <pubDate>2026-01-17T07:46:22.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7595841630677106739" data-draft-id="7595842144906625074" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Caffeine入门到实战"/> <meta itemprop="keywords" content="Java"/> <meta itemprop="datePublished" content="2026-01-17T07:46:22.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="雨中飘荡的记忆"/> <meta itemprop="url" content="https://juejin.cn/user/694547077666606"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Caffeine入门到实战
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/694547077666606/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    雨中飘荡的记忆
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-17T07:46:22.000Z" title="Sat Jan 17 2026 07:46:22 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-17
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读10分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>高性能Java缓存框架实战，让你秒懂缓存优化</p>
</blockquote>
<h2 data-id="heading-0">前言</h2>
<p>在当今高并发的互联网应用中，缓存已经成为提升系统性能的关键技术之一。本文将带你从零开始，深入浅出地学习Caffeine这款高性能的Java缓存框架，并通过实际案例让你掌握缓存技术的精髓。</p>
<h2 data-id="heading-1">1. Caffeine简介</h2>
<p>Caffeine是一个基于Java的高性能缓存库，由Google开发并开源。它被认为是Java缓存领域的王者，在性能测试中表现优异。</p>
<h3 data-id="heading-2">为什么选择Caffeine？</h3>
<ul>
<li><strong>高性能</strong>：采用先进的算法，读写性能卓越</li>
<li><strong>功能丰富</strong>：支持多种过期策略、异步加载、统计信息等</li>
<li><strong>线程安全</strong>：并发性能优秀</li>
<li><strong>易于使用</strong>：API设计简洁直观</li>
<li><strong>活跃社区</strong>：持续维护和更新</li>
</ul>
<h3 data-id="heading-3">架构设计</h3>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a3e6e0d899e14fbaaafafa3123056baf~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zuo5Lit6aOY6I2h55qE6K6w5b-G:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769240782&amp;x-signature=hfMSuIcQysmqzw2OjT3WiDv4Wtw%3D" alt="" loading="lazy"/></p>
<p>Caffeine的核心架构包括：</p>
<ol>
<li><strong>缓存容器</strong>：使用ConcurrentHashMap作为底层数据结构</li>
<li><strong>访问策略</strong>：采用Window TinyLFU算法进行频率统计</li>
<li><strong>淘汰策略</strong>：基于时间窗口和频率的混合淘汰策略</li>
<li><strong>事件机制</strong>：支持监听缓存的各种事件</li>
</ol>
<h2 data-id="heading-4">2. 快速入门</h2>
<h3 data-id="heading-5">Maven依赖</h3>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.github.ben-manes.caffeine<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>caffeine<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.1.8<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
</code></pre>
<h3 data-id="heading-6">基础使用示例</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> com.<span class="hljs-property">github</span>.<span class="hljs-property">benmanes</span>.<span class="hljs-property">caffeine</span>.<span class="hljs-property">cache</span>.<span class="hljs-property">Cache</span>;
<span class="hljs-keyword">import</span> com.<span class="hljs-property">github</span>.<span class="hljs-property">benmanes</span>.<span class="hljs-property">caffeine</span>.<span class="hljs-property">cache</span>.<span class="hljs-property">Caffeine</span>;
<span class="hljs-keyword">import</span> java.<span class="hljs-property">util</span>.<span class="hljs-property">concurrent</span>.<span class="hljs-property">TimeUnit</span>;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BasicCacheExample</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">main</span>(<span class="hljs-params"><span class="hljs-built_in">String</span>[] args</span>) {
        <span class="hljs-comment">// 创建缓存</span>
        <span class="hljs-title class_">Cache</span>&lt;<span class="hljs-title class_">String</span>, <span class="hljs-title class_">String</span>&gt; cache = <span class="hljs-title class_">Caffeine</span>.<span class="hljs-title function_">newBuilder</span>()
            .<span class="hljs-title function_">maximumSize</span>(<span class="hljs-number">1000</span>) <span class="hljs-comment">// 最大缓存数量</span>
            .<span class="hljs-title function_">expireAfterWrite</span>(<span class="hljs-number">10</span>, <span class="hljs-title class_">TimeUnit</span>.<span class="hljs-property">MINUTES</span>) <span class="hljs-comment">// 写入后10分钟过期</span>
            .<span class="hljs-title function_">build</span>();

        <span class="hljs-comment">// 存储数据</span>
        cache.<span class="hljs-title function_">put</span>(<span class="hljs-string">"key1"</span>, <span class="hljs-string">"value1"</span>);

        <span class="hljs-comment">// 获取数据</span>
        <span class="hljs-title class_">String</span> value = cache.<span class="hljs-title function_">getIfPresent</span>(<span class="hljs-string">"key1"</span>);
        <span class="hljs-title class_">System</span>.<span class="hljs-property">out</span>.<span class="hljs-title function_">println</span>(<span class="hljs-string">"缓存值: "</span> + value);

        <span class="hljs-comment">// 获取或计算</span>
        <span class="hljs-title class_">String</span> value2 = cache.<span class="hljs-title function_">get</span>(<span class="hljs-string">"key2"</span>, k -&gt; <span class="hljs-string">"defaultValue"</span>);
        <span class="hljs-title class_">System</span>.<span class="hljs-property">out</span>.<span class="hljs-title function_">println</span>(<span class="hljs-string">"缓存值: "</span> + value2);

        <span class="hljs-comment">// 移除数据</span>
        cache.<span class="hljs-title function_">invalidate</span>(<span class="hljs-string">"key1"</span>);
    }
}
</code></pre>
<h2 data-id="heading-7">3. 核心概念</h2>
<h3 data-id="heading-8">3.1 Cache vs LoadingCache vs AsyncLoadingCache</h3>
<p>Caffeine提供了三种缓存类型：</p>
<ol>
<li><strong>Cache</strong>：基础缓存，需要手动管理数据</li>
<li><strong>LoadingCache</strong>：自动加载数据的缓存</li>
<li><strong>AsyncLoadingCache</strong>：异步加载数据的缓存</li>
</ol>
<h3 data-id="heading-9">3.2 过期策略</h3>
<p>Caffeine提供了三种过期策略：</p>
<pre><code class="hljs language-scss" lang="scss">Caffeine<span class="hljs-selector-class">.newBuilder</span>()
    <span class="hljs-selector-class">.expireAfterWrite</span>(<span class="hljs-number">10</span>, TimeUnit.MINUTES) <span class="hljs-comment">// 写入后过期</span>
    <span class="hljs-selector-class">.expireAfterAccess</span>(<span class="hljs-number">5</span>, TimeUnit.MINUTES)  <span class="hljs-comment">// 最后访问后过期</span>
    <span class="hljs-selector-class">.expireAfter</span>(<span class="hljs-number">30</span>, TimeUnit.MINUTES);       <span class="hljs-comment">// 自定义过期逻辑</span>
</code></pre>
<h3 data-id="heading-10">3.3 淘汰策略</h3>
<pre><code class="hljs language-scss" lang="scss">Caffeine<span class="hljs-selector-class">.newBuilder</span>()
    <span class="hljs-selector-class">.maximumSize</span>(<span class="hljs-number">1000</span>)         <span class="hljs-comment">// 基于数量</span>
    <span class="hljs-selector-class">.maximumWeight</span>(<span class="hljs-number">10000</span>)      <span class="hljs-comment">// 基于权重</span>
    <span class="hljs-selector-class">.weakKeys</span>()               <span class="hljs-comment">// 弱引用键</span>
    <span class="hljs-selector-class">.weakValues</span>()             <span class="hljs-comment">// 弱引用值</span>
    <span class="hljs-selector-class">.softValues</span>();            <span class="hljs-comment">// 软引用值</span>
</code></pre>
<h2 data-id="heading-11">4. 高级特性</h2>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ff936a2d76c04f1aaf866ccba450d2fa~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zuo5Lit6aOY6I2h55qE6K6w5b-G:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769240782&amp;x-signature=vIDzfY5%2B20eLh9huJFxIDK%2FnZbk%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-12">4.1 异步加载</h3>
<pre><code class="hljs language-ini" lang="ini">AsyncLoadingCache&lt;String, User&gt; <span class="hljs-attr">asyncCache</span> = Caffeine.newBuilder()
    .maximumSize(1000)
    .expireAfterWrite(10, TimeUnit.MINUTES)
    .buildAsync(key -&gt; loadUserFromDatabase(key))<span class="hljs-comment">;</span>

// 异步获取
CompletableFuture&lt;User&gt; <span class="hljs-attr">userFuture</span> = asyncCache.get(<span class="hljs-string">"user1"</span>)<span class="hljs-comment">;</span>
userFuture.thenAccept(user -&gt; {
    System.out.println("获取用户: " + user.getName())<span class="hljs-comment">;</span>
})<span class="hljs-comment">;</span>
</code></pre>
<h3 data-id="heading-13">4.2 事件监听</h3>
<pre><code class="hljs language-vbnet" lang="vbnet">Cache&lt;<span class="hljs-type">String</span>, <span class="hljs-type">String</span>&gt; cache = Caffeine.newBuilder()
    .maximumSize(<span class="hljs-number">1000</span>)
    .removalListener((<span class="hljs-keyword">key</span>, value, cause) -&gt; {
        System.out.println(<span class="hljs-string">"缓存移除: "</span> + <span class="hljs-keyword">key</span> + <span class="hljs-string">" -&gt; "</span> + value + <span class="hljs-string">", 原因: "</span> + cause);
    })
    .build();
</code></pre>
<h3 data-id="heading-14">4.3 统计信息</h3>
<pre><code class="hljs language-scss" lang="scss">Cache&lt;String, String&gt; cache = Caffeine<span class="hljs-selector-class">.newBuilder</span>()
    <span class="hljs-selector-class">.maximumSize</span>(<span class="hljs-number">1000</span>)
    <span class="hljs-selector-class">.recordStats</span>() <span class="hljs-comment">// 启用统计</span>
    <span class="hljs-selector-class">.build</span>();

<span class="hljs-comment">// 使用缓存...</span>
cache<span class="hljs-selector-class">.put</span>("key1", "value1");
cache<span class="hljs-selector-class">.getIfPresent</span>("key1");

<span class="hljs-comment">// 获取统计信息</span>
CacheStats stats = cache<span class="hljs-selector-class">.stats</span>();
System<span class="hljs-selector-class">.out</span><span class="hljs-selector-class">.println</span>("命中率: " + stats.hitRate());
System<span class="hljs-selector-class">.out</span><span class="hljs-selector-class">.println</span>("加载时间: " + stats.averageLoadPenalty());
System<span class="hljs-selector-class">.out</span><span class="hljs-selector-class">.println</span>("请求数: " + stats.requestCount());
</code></pre>
<h2 data-id="heading-15">5. Spring Boot集成</h2>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/aff82efaf278437f8045c4dae72c58be~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zuo5Lit6aOY6I2h55qE6K6w5b-G:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769240782&amp;x-signature=x8wXynqrw1CSWo8vv794U8KA5Sg%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-16">5.1 添加依赖</h3>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-cache<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.github.ben-manes.caffeine<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>caffeine<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
</code></pre>
<h3 data-id="heading-17">5.2 配置类</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> com.<span class="hljs-property">github</span>.<span class="hljs-property">benmanes</span>.<span class="hljs-property">caffeine</span>.<span class="hljs-property">cache</span>.<span class="hljs-property">Caffeine</span>;
<span class="hljs-keyword">import</span> org.<span class="hljs-property">springframework</span>.<span class="hljs-property">cache</span>.<span class="hljs-property">CacheManager</span>;
<span class="hljs-keyword">import</span> org.<span class="hljs-property">springframework</span>.<span class="hljs-property">cache</span>.<span class="hljs-property">annotation</span>.<span class="hljs-property">EnableCaching</span>;
<span class="hljs-keyword">import</span> org.<span class="hljs-property">springframework</span>.<span class="hljs-property">cache</span>.<span class="hljs-property">caffeine</span>.<span class="hljs-property">CaffeineCacheManager</span>;
<span class="hljs-keyword">import</span> org.<span class="hljs-property">springframework</span>.<span class="hljs-property">context</span>.<span class="hljs-property">annotation</span>.<span class="hljs-property">Bean</span>;
<span class="hljs-keyword">import</span> org.<span class="hljs-property">springframework</span>.<span class="hljs-property">context</span>.<span class="hljs-property">annotation</span>.<span class="hljs-property">Configuration</span>;
<span class="hljs-keyword">import</span> java.<span class="hljs-property">util</span>.<span class="hljs-property">concurrent</span>.<span class="hljs-property">TimeUnit</span>;

<span class="hljs-meta">@Configuration</span>
<span class="hljs-meta">@EnableCaching</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CacheConfig</span> {

    <span class="hljs-meta">@Bean</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title class_">CacheManager</span> <span class="hljs-title function_">cacheManager</span>(<span class="hljs-params"/>) {
        <span class="hljs-title class_">CaffeineCacheManager</span> cacheManager = <span class="hljs-keyword">new</span> <span class="hljs-title class_">CaffeineCacheManager</span>();
        cacheManager.<span class="hljs-title function_">setCaffeine</span>(<span class="hljs-title function_">caffeineCacheBuilder</span>());
        <span class="hljs-keyword">return</span> cacheManager;
    }

    <span class="hljs-keyword">private</span> <span class="hljs-title class_">Caffeine</span>&lt;<span class="hljs-title class_">Object</span>, <span class="hljs-title class_">Object</span>&gt; <span class="hljs-title function_">caffeineCacheBuilder</span>(<span class="hljs-params"/>) {
        <span class="hljs-keyword">return</span> <span class="hljs-title class_">Caffeine</span>.<span class="hljs-title function_">newBuilder</span>()
                .<span class="hljs-title function_">initialCapacity</span>(<span class="hljs-number">100</span>)
                .<span class="hljs-title function_">maximumSize</span>(<span class="hljs-number">1000</span>)
                .<span class="hljs-title function_">expireAfterWrite</span>(<span class="hljs-number">10</span>, <span class="hljs-title class_">TimeUnit</span>.<span class="hljs-property">MINUTES</span>)
                .<span class="hljs-title function_">recordStats</span>();
    }
}
</code></pre>
<h3 data-id="heading-18">5.3 使用注解</h3>
<pre><code class="hljs language-typescript" lang="typescript">package com.<span class="hljs-property">example</span>.<span class="hljs-property">caffeine</span>.<span class="hljs-property">demo</span>.<span class="hljs-property">service</span>;

<span class="hljs-keyword">import</span> com.<span class="hljs-property">example</span>.<span class="hljs-property">caffeine</span>.<span class="hljs-property">demo</span>.<span class="hljs-property">model</span>.<span class="hljs-property">User</span>;
<span class="hljs-keyword">import</span> org.<span class="hljs-property">springframework</span>.<span class="hljs-property">cache</span>.<span class="hljs-property">annotation</span>.<span class="hljs-property">CacheEvict</span>;
<span class="hljs-keyword">import</span> org.<span class="hljs-property">springframework</span>.<span class="hljs-property">cache</span>.<span class="hljs-property">annotation</span>.<span class="hljs-property">CachePut</span>;
<span class="hljs-keyword">import</span> org.<span class="hljs-property">springframework</span>.<span class="hljs-property">cache</span>.<span class="hljs-property">annotation</span>.<span class="hljs-property">Cacheable</span>;
<span class="hljs-keyword">import</span> org.<span class="hljs-property">springframework</span>.<span class="hljs-property">stereotype</span>.<span class="hljs-property">Service</span>;

<span class="hljs-keyword">import</span> java.<span class="hljs-property">util</span>.*;
<span class="hljs-keyword">import</span> java.<span class="hljs-property">util</span>.<span class="hljs-property">concurrent</span>.<span class="hljs-property">ConcurrentHashMap</span>;
<span class="hljs-keyword">import</span> java.<span class="hljs-property">util</span>.<span class="hljs-property">concurrent</span>.<span class="hljs-property">TimeUnit</span>;

<span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserService</span> {

    <span class="hljs-comment">// 模拟数据库存储</span>
    <span class="hljs-keyword">private</span> final <span class="hljs-title class_">Map</span>&lt;<span class="hljs-title class_">Long</span>, <span class="hljs-title class_">User</span>&gt; userMap = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConcurrentHashMap</span>&lt;&gt;();

    <span class="hljs-keyword">public</span> <span class="hljs-title class_">UserService</span>() {
        <span class="hljs-comment">// 初始化一些测试数据</span>
        userMap.<span class="hljs-title function_">put</span>(1L, <span class="hljs-keyword">new</span> <span class="hljs-title class_">User</span>(1L, <span class="hljs-string">"张三"</span>, <span class="hljs-string">"zhangsan@example.com"</span>, <span class="hljs-string">"13800138000"</span>));
        userMap.<span class="hljs-title function_">put</span>(2L, <span class="hljs-keyword">new</span> <span class="hljs-title class_">User</span>(2L, <span class="hljs-string">"李四"</span>, <span class="hljs-string">"lisi@example.com"</span>, <span class="hljs-string">"13900139000"</span>));
        userMap.<span class="hljs-title function_">put</span>(3L, <span class="hljs-keyword">new</span> <span class="hljs-title class_">User</span>(3L, <span class="hljs-string">"王五"</span>, <span class="hljs-string">"wangwu@example.com"</span>, <span class="hljs-string">"13700137000"</span>));
    }

    <span class="hljs-comment">/**
     * 获取用户信息（带缓存）
     * <span class="hljs-doctag">@param</span> userId 用户ID
     * <span class="hljs-doctag">@return</span> 用户信息
     */</span>
    <span class="hljs-meta">@Cacheable</span>(value = <span class="hljs-string">"users"</span>, key = <span class="hljs-string">"#userId"</span>)
    <span class="hljs-keyword">public</span> <span class="hljs-title class_">User</span> <span class="hljs-title function_">getUserById</span>(<span class="hljs-params">Long userId</span>) {
        <span class="hljs-comment">// 模拟数据库查询耗时</span>
        <span class="hljs-keyword">try</span> {
            <span class="hljs-title class_">TimeUnit</span>.<span class="hljs-property">MILLISECONDS</span>.<span class="hljs-title function_">sleep</span>(<span class="hljs-number">100</span>);
        } <span class="hljs-keyword">catch</span> (<span class="hljs-title class_">InterruptedException</span> e) {
            <span class="hljs-title class_">Thread</span>.<span class="hljs-title function_">currentThread</span>().<span class="hljs-title function_">interrupt</span>();
        }

        <span class="hljs-title class_">User</span> user = userMap.<span class="hljs-title function_">get</span>(userId);
        <span class="hljs-keyword">if</span> (user == <span class="hljs-literal">null</span>) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">"用户不存在: "</span> + userId);
        }
        <span class="hljs-keyword">return</span> user;
    }

    <span class="hljs-comment">/**
     * 获取用户信息（异步）
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title class_">CompletableFuture</span>&lt;<span class="hljs-title class_">User</span>&gt; <span class="hljs-title function_">getUserByIdAsync</span>(<span class="hljs-params">Long userId</span>) {
        <span class="hljs-keyword">return</span> <span class="hljs-title class_">CompletableFuture</span>.<span class="hljs-title function_">supplyAsync</span>(() -&gt; <span class="hljs-title function_">getUserById</span>(userId));
    }

    <span class="hljs-comment">/**
     * 获取所有用户信息
     */</span>
    <span class="hljs-meta">@Cacheable</span>(value = <span class="hljs-string">"users"</span>, key = <span class="hljs-string">"'all'"</span>)
    <span class="hljs-keyword">public</span> <span class="hljs-title class_">List</span>&lt;<span class="hljs-title class_">User</span>&gt; <span class="hljs-title function_">getAllUsers</span>(<span class="hljs-params"/>) {
        <span class="hljs-comment">// 模拟数据库查询耗时</span>
        <span class="hljs-keyword">try</span> {
            <span class="hljs-title class_">TimeUnit</span>.<span class="hljs-property">MILLISECONDS</span>.<span class="hljs-title function_">sleep</span>(<span class="hljs-number">200</span>);
        } <span class="hljs-keyword">catch</span> (<span class="hljs-title class_">InterruptedException</span> e) {
            <span class="hljs-title class_">Thread</span>.<span class="hljs-title function_">currentThread</span>().<span class="hljs-title function_">interrupt</span>();
        }

        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;(userMap.<span class="hljs-title function_">values</span>());
    }

    <span class="hljs-comment">/**
     * 创建用户
     */</span>
    <span class="hljs-meta">@CachePut</span>(value = <span class="hljs-string">"users"</span>, key = <span class="hljs-string">"#user.id"</span>)
    <span class="hljs-keyword">public</span> <span class="hljs-title class_">User</span> <span class="hljs-title function_">createUser</span>(<span class="hljs-params">User user</span>) {
        userMap.<span class="hljs-title function_">put</span>(user.<span class="hljs-title function_">getId</span>(), user);
        <span class="hljs-keyword">return</span> user;
    }

    <span class="hljs-comment">/**
     * 更新用户信息
     */</span>
    <span class="hljs-meta">@CachePut</span>(value = <span class="hljs-string">"users"</span>, key = <span class="hljs-string">"#user.id"</span>)
    <span class="hljs-keyword">public</span> <span class="hljs-title class_">User</span> <span class="hljs-title function_">updateUser</span>(<span class="hljs-params">User user</span>) {
        <span class="hljs-keyword">if</span> (!userMap.<span class="hljs-title function_">containsKey</span>(user.<span class="hljs-title function_">getId</span>())) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">"用户不存在: "</span> + user.<span class="hljs-title function_">getId</span>());
        }
        user.<span class="hljs-title function_">setUpdateTime</span>(<span class="hljs-title class_">LocalDateTime</span>.<span class="hljs-title function_">now</span>());
        userMap.<span class="hljs-title function_">put</span>(user.<span class="hljs-title function_">getId</span>(), user);
        <span class="hljs-keyword">return</span> user;
    }

    <span class="hljs-comment">/**
     * 删除用户
     */</span>
    <span class="hljs-meta">@CacheEvict</span>(value = <span class="hljs-string">"users"</span>, key = <span class="hljs-string">"#userId"</span>)
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">deleteUser</span>(<span class="hljs-params">Long userId</span>) {
        <span class="hljs-title class_">User</span> removed = userMap.<span class="hljs-title function_">remove</span>(userId);
        <span class="hljs-keyword">if</span> (removed == <span class="hljs-literal">null</span>) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">"用户不存在: "</span> + userId);
        }
    }

    <span class="hljs-comment">/**
     * 批量获取用户信息
     */</span>
    <span class="hljs-meta">@Cacheable</span>(value = <span class="hljs-string">"users"</span>, key = <span class="hljs-string">"'batch:' + #userIds.hashCode()"</span>)
    <span class="hljs-keyword">public</span> <span class="hljs-title class_">Map</span>&lt;<span class="hljs-title class_">Long</span>, <span class="hljs-title class_">User</span>&gt; <span class="hljs-title function_">batchGetUsers</span>(<span class="hljs-params"><span class="hljs-built_in">Set</span>&lt;Long&gt; userIds</span>) {
        <span class="hljs-comment">// 模拟批量查询耗时</span>
        <span class="hljs-keyword">try</span> {
            <span class="hljs-title class_">TimeUnit</span>.<span class="hljs-property">MILLISECONDS</span>.<span class="hljs-title function_">sleep</span>(<span class="hljs-number">150</span>);
        } <span class="hljs-keyword">catch</span> (<span class="hljs-title class_">InterruptedException</span> e) {
            <span class="hljs-title class_">Thread</span>.<span class="hljs-title function_">currentThread</span>().<span class="hljs-title function_">interrupt</span>();
        }

        <span class="hljs-title class_">Map</span>&lt;<span class="hljs-title class_">Long</span>, <span class="hljs-title class_">User</span>&gt; result = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();
        <span class="hljs-keyword">for</span> (<span class="hljs-title class_">Long</span> userId : userIds) {
            <span class="hljs-title class_">User</span> user = userMap.<span class="hljs-title function_">get</span>(userId);
            <span class="hljs-keyword">if</span> (user != <span class="hljs-literal">null</span>) {
                result.<span class="hljs-title function_">put</span>(userId, user);
            }
        }
        <span class="hljs-keyword">return</span> result;
    }

    <span class="hljs-comment">/**
     * 根据用户名模糊查询
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title class_">List</span>&lt;<span class="hljs-title class_">User</span>&gt; <span class="hljs-title function_">searchUsersByUsername</span>(<span class="hljs-params"><span class="hljs-built_in">String</span> keyword</span>) {
        <span class="hljs-title class_">List</span>&lt;<span class="hljs-title class_">User</span>&gt; result = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();
        <span class="hljs-keyword">for</span> (<span class="hljs-title class_">User</span> user : userMap.<span class="hljs-title function_">values</span>()) {
            <span class="hljs-keyword">if</span> (user.<span class="hljs-title function_">getUsername</span>().<span class="hljs-title function_">contains</span>(keyword)) {
                result.<span class="hljs-title function_">add</span>(user);
            }
        }
        <span class="hljs-keyword">return</span> result;
    }

    <span class="hljs-comment">/**
     * 清空所有缓存
     */</span>
    <span class="hljs-meta">@CacheEvict</span>(value = <span class="hljs-string">"users"</span>, allEntries = <span class="hljs-literal">true</span>)
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">clearAllCache</span>(<span class="hljs-params"/>) {
        <span class="hljs-title class_">System</span>.<span class="hljs-property">out</span>.<span class="hljs-title function_">println</span>(<span class="hljs-string">"清空所有用户缓存"</span>);
    }

    <span class="hljs-comment">/**
     * 获取用户总数
     */</span>
    <span class="hljs-keyword">public</span> long <span class="hljs-title function_">getUserCount</span>(<span class="hljs-params"/>) {
        <span class="hljs-keyword">return</span> userMap.<span class="hljs-title function_">size</span>();
    }
}
</code></pre>
<h2 data-id="heading-19">6. 生产环境最佳实践</h2>
<h3 data-id="heading-20">6.1 缓存雪崩与击穿</h3>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0ae45c5ae2c644e7b19813de7bb61db4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zuo5Lit6aOY6I2h55qE6K6w5b-G:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769240782&amp;x-signature=s5Bj%2B0%2FpD1TT%2FcUtgYIihfc%2BzFI%3D" alt="" loading="lazy"/></p>
<h4 data-id="heading-21">缓存雪崩解决方案</h4>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-comment">// 1. 设置随机过期时间</span>
Caffeine.newBuilder()
    .expireAfterWrite(<span class="hljs-number">10</span> + <span class="hljs-keyword">new</span> Random().nextInt(<span class="hljs-number">5</span>), TimeUnit.MINUTES);

<span class="hljs-comment">// 2. 使用互斥锁</span>
<span class="hljs-keyword">private</span> final Lock <span class="hljs-keyword">lock</span> = <span class="hljs-keyword">new</span> ReentrantLock();

<span class="hljs-function"><span class="hljs-keyword">public</span> User <span class="hljs-title">getUserWithLock</span>(<span class="hljs-params">Long id</span>)</span> {
    User user = cache.getIfPresent(id);
    <span class="hljs-keyword">if</span> (user != <span class="hljs-literal">null</span>) {
        <span class="hljs-keyword">return</span> user;
    }

    <span class="hljs-keyword">lock</span>.<span class="hljs-keyword">lock</span>();
    <span class="hljs-keyword">try</span> {
        <span class="hljs-comment">// 双重检查</span>
        user = cache.getIfPresent(id);
        <span class="hljs-keyword">if</span> (user != <span class="hljs-literal">null</span>) {
            <span class="hljs-keyword">return</span> user;
        }

        user = userRepository.findById(id);
        cache.put(id, user);
        <span class="hljs-keyword">return</span> user;
    } <span class="hljs-keyword">finally</span> {
        <span class="hljs-keyword">lock</span>.unlock();
    }
}
</code></pre>
<h4 data-id="heading-22">缓存击穿解决方案</h4>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// 使用Caffeine的异步加载</span>
AsyncLoadingCache&lt;Long, User&gt; asyncCache = Caffeine<span class="hljs-selector-class">.newBuilder</span>()
    <span class="hljs-selector-class">.maximumSize</span>(<span class="hljs-number">1000</span>)
    <span class="hljs-selector-class">.expireAfterWrite</span>(<span class="hljs-number">10</span>, TimeUnit.MINUTES)
    <span class="hljs-selector-class">.buildAsync</span>(key -&gt; loadUserFromDatabase(key));

public User <span class="hljs-built_in">getUser</span>(Long id) {
    return asyncCache<span class="hljs-selector-class">.get</span>(id)<span class="hljs-selector-class">.join</span>();
}
</code></pre>
<h3 data-id="heading-23">6.2 缓存预热</h3>
<pre><code class="hljs language-scss" lang="scss">package com<span class="hljs-selector-class">.example</span><span class="hljs-selector-class">.caffeine</span><span class="hljs-selector-class">.demo</span><span class="hljs-selector-class">.cache</span>;

import com<span class="hljs-selector-class">.example</span><span class="hljs-selector-class">.caffeine</span><span class="hljs-selector-class">.demo</span><span class="hljs-selector-class">.model</span><span class="hljs-selector-class">.User</span>;
import com<span class="hljs-selector-class">.example</span><span class="hljs-selector-class">.caffeine</span><span class="hljs-selector-class">.demo</span><span class="hljs-selector-class">.service</span><span class="hljs-selector-class">.UserService</span>;
import lombok<span class="hljs-selector-class">.extern</span><span class="hljs-selector-class">.slf4j</span><span class="hljs-selector-class">.Slf4j</span>;
import org<span class="hljs-selector-class">.springframework</span><span class="hljs-selector-class">.beans</span><span class="hljs-selector-class">.factory</span><span class="hljs-selector-class">.annotation</span><span class="hljs-selector-class">.Autowired</span>;
import org<span class="hljs-selector-class">.springframework</span><span class="hljs-selector-class">.boot</span><span class="hljs-selector-class">.CommandLineRunner</span>;
import org<span class="hljs-selector-class">.springframework</span><span class="hljs-selector-class">.stereotype</span><span class="hljs-selector-class">.Component</span>;

import java<span class="hljs-selector-class">.util</span><span class="hljs-selector-class">.Arrays</span>;
import java<span class="hljs-selector-class">.util</span><span class="hljs-selector-class">.List</span>;
import java<span class="hljs-selector-class">.util</span><span class="hljs-selector-class">.concurrent</span><span class="hljs-selector-class">.CompletableFuture</span>;
import java<span class="hljs-selector-class">.util</span><span class="hljs-selector-class">.concurrent</span><span class="hljs-selector-class">.ExecutorService</span>;
import java<span class="hljs-selector-class">.util</span><span class="hljs-selector-class">.concurrent</span><span class="hljs-selector-class">.Executors</span>;
import java<span class="hljs-selector-class">.util</span><span class="hljs-selector-class">.concurrent</span><span class="hljs-selector-class">.TimeUnit</span>;
import java<span class="hljs-selector-class">.util</span><span class="hljs-selector-class">.stream</span><span class="hljs-selector-class">.Collectors</span>;

<span class="hljs-comment">/**
 * 缓存预热启动器
 *
 * 功能：
 * 1. 在应用启动时自动预热热点数据到缓存
 * 2. 支持同步和异步预热方式
 * 3. 支持批量预热
 * 4. 提供预热进度监控
 * 5. 异常处理和重试机制
 */</span>
<span class="hljs-keyword">@Slf</span>4j
<span class="hljs-keyword">@Component</span>
public class CacheWarmupRunner implements CommandLineRunner {

    <span class="hljs-keyword">@Autowired</span>
    private UserService userService;

    <span class="hljs-comment">/**
     * 预热配置
     */</span>
    private static class WarmupConfig {
        <span class="hljs-comment">// 预热用户ID列表（可以根据业务需求配置）</span>
        private static final List&lt;Long&gt; HOT_USER_IDS = Arrays<span class="hljs-selector-class">.asList</span>(<span class="hljs-number">1</span>L, <span class="hljs-number">2</span>L, <span class="hljs-number">3</span>L, <span class="hljs-number">4</span>L, <span class="hljs-number">5</span>L);

        <span class="hljs-comment">// 预热批次大小</span>
        private static final int BATCH_SIZE = <span class="hljs-number">3</span>;

        <span class="hljs-comment">// 线程池大小</span>
        private static final int THREAD_POOL_SIZE = <span class="hljs-number">2</span>;

        <span class="hljs-comment">// 是否启用异步预热</span>
        private static final boolean ASYNC_WARMUP = true;

        <span class="hljs-comment">// 最大重试次数</span>
        private static final int MAX_RETRY_TIMES = <span class="hljs-number">3</span>;

        <span class="hljs-comment">// 重试间隔（毫秒）</span>
        private static final long RETRY_INTERVAL = <span class="hljs-number">1000</span>L;
    }

    <span class="hljs-keyword">@Override</span>
    public void run(String... args) throws Exception {
        log<span class="hljs-selector-class">.info</span>("开始执行缓存预热...");
        long startTime = System<span class="hljs-selector-class">.currentTimeMillis</span>();

        try {
            if (WarmupConfig.ASYNC_WARMUP) {
                <span class="hljs-comment">// 异步预热</span>
                <span class="hljs-built_in">asyncWarmup</span>();
            } else {
                <span class="hljs-comment">// 同步预热</span>
                <span class="hljs-built_in">syncWarmup</span>();
            }

            long endTime = System<span class="hljs-selector-class">.currentTimeMillis</span>();
            log<span class="hljs-selector-class">.info</span>("缓存预热完成！耗时: {} ms", endTime - startTime);

        } catch (Exception e) {
            log<span class="hljs-selector-class">.error</span>("缓存预热失败！错误信息: {}", e.getMessage(), e);
        }
    }

    <span class="hljs-comment">/**
     * 同步预热方式
     */</span>
    private void <span class="hljs-built_in">syncWarmup</span>() {
        log<span class="hljs-selector-class">.info</span>("使用同步方式预热缓存...");

        <span class="hljs-comment">// 方法1：逐个预热</span>
        log<span class="hljs-selector-class">.info</span>("逐个预热用户数据...");
        for (Long userId : WarmupConfig.HOT_USER_IDS) {
            <span class="hljs-built_in">warmupSingleUser</span>(userId);
        }

        <span class="hljs-comment">// 方法2：批量预热</span>
        log<span class="hljs-selector-class">.info</span>("批量预热用户数据...");
        <span class="hljs-built_in">batchWarmupUsers</span>(WarmupConfig.HOT_USER_IDS);

        <span class="hljs-comment">// 方法3：预热所有用户</span>
        log<span class="hljs-selector-class">.info</span>("预热所有用户数据...");
        <span class="hljs-built_in">warmupAllUsers</span>();
    }

    <span class="hljs-comment">/**
     * 异步预热方式
     */</span>
    private void <span class="hljs-built_in">asyncWarmup</span>() {
        log<span class="hljs-selector-class">.info</span>("使用异步方式预热缓存...");

        ExecutorService executor = Executors<span class="hljs-selector-class">.newFixedThreadPool</span>(WarmupConfig.THREAD_POOL_SIZE);

        <span class="hljs-comment">// 创建异步预热任务</span>
        List&lt;CompletableFuture&lt;Void&gt;&gt; futures = WarmupConfig<span class="hljs-selector-class">.HOT_USER_IDS</span><span class="hljs-selector-class">.stream</span>()
            <span class="hljs-selector-class">.map</span>(userId -&gt; CompletableFuture.runAsync(() -&gt; {
                try {
                    <span class="hljs-built_in">warmupSingleUserWithRetry</span>(userId);
                } catch (Exception e) {
                    log<span class="hljs-selector-class">.error</span>("预热用户 {} 失败: {}", userId, e.getMessage());
                }
            }, executor))
            <span class="hljs-selector-class">.collect</span>(Collectors.toList());

        <span class="hljs-comment">// 等待所有任务完成</span>
        CompletableFuture<span class="hljs-selector-class">.allOf</span>(futures.toArray(new CompletableFuture[<span class="hljs-number">0</span>]))
            <span class="hljs-selector-class">.whenComplete</span>((result, ex) -&gt; {
                if (ex != null) {
                    log<span class="hljs-selector-class">.error</span>("部分预热任务失败", ex);
                } else {
                    log<span class="hljs-selector-class">.info</span>("所有预热任务完成");
                }
                executor<span class="hljs-selector-class">.shutdown</span>();
            })
            <span class="hljs-selector-class">.join</span>();
    }

    <span class="hljs-comment">/**
     * 预热单个用户数据（带重试机制）
     */</span>
    private void <span class="hljs-built_in">warmupSingleUserWithRetry</span>(Long userId) {
        int retryCount = <span class="hljs-number">0</span>;
        boolean success = false;

        while (retryCount &lt; WarmupConfig.MAX_RETRY_TIMES &amp;&amp; !success) {
            try {
                <span class="hljs-built_in">warmupSingleUser</span>(userId);
                success = true;
                log<span class="hljs-selector-class">.debug</span>("用户 {} 预热成功，尝试次数: {}", userId, retryCount + <span class="hljs-number">1</span>);
            } catch (Exception e) {
                retryCount++;
                if (retryCount &gt;= WarmupConfig.MAX_RETRY_TIMES) {
                    log<span class="hljs-selector-class">.error</span>("用户 {} 预热失败，已达到最大重试次数: {}", userId, e.getMessage());
                    throw new <span class="hljs-built_in">RuntimeException</span>("预热用户 " + userId + " 失败", e);
                }
                log<span class="hljs-selector-class">.warn</span>("用户 {} 预热失败，第{}次重试。错误: {}", userId, retryCount, e.getMessage());
                try {
                    Thread<span class="hljs-selector-class">.sleep</span>(WarmupConfig.RETRY_INTERVAL);
                } catch (InterruptedException ie) {
                    Thread<span class="hljs-selector-class">.currentThread</span>()<span class="hljs-selector-class">.interrupt</span>();
                    throw new <span class="hljs-built_in">RuntimeException</span>("预热被中断", ie);
                }
            }
        }
    }

    <span class="hljs-comment">/**
     * 预热单个用户
     */</span>
    private void <span class="hljs-built_in">warmupSingleUser</span>(Long userId) {
        log<span class="hljs-selector-class">.info</span>("预热用户: {}", userId);
        try {
            <span class="hljs-comment">// 预热用户基本信息</span>
            User user = userService<span class="hljs-selector-class">.getUserById</span>(userId);
            log<span class="hljs-selector-class">.debug</span>("用户 {} 基本信息预热完成", userId);
            <span class="hljs-comment">// 预热相关数据（如果有）</span>
            <span class="hljs-built_in">warmupRelatedData</span>(user);

        } catch (Exception e) {
            log<span class="hljs-selector-class">.error</span>("预热用户 {} 失败: {}", userId, e.getMessage());
            throw e;
        }
    }

    <span class="hljs-comment">/**
     * 批量预热用户数据
     */</span>
    private void <span class="hljs-built_in">batchWarmupUsers</span>(List&lt;Long&gt; userIds) {
        log<span class="hljs-selector-class">.info</span>("批量预热用户: {}", userIds);

        <span class="hljs-comment">// 按批次处理</span>
        for (int i = <span class="hljs-number">0</span>; i &lt; userIds.size(); <span class="hljs-selector-tag">i</span> += WarmupConfig<span class="hljs-selector-class">.BATCH_SIZE</span>) {
            int end = Math<span class="hljs-selector-class">.min</span>(i + WarmupConfig.BATCH_SIZE, userIds.size());
            List&lt;Long&gt; batch = userIds<span class="hljs-selector-class">.subList</span>(i, end);

            log<span class="hljs-selector-class">.info</span>("预热第 {} 批，用户ID: {}", (i / WarmupConfig.BATCH_SIZE) + <span class="hljs-number">1</span>, batch);

            try {
                <span class="hljs-comment">// 批量查询</span>
                Map&lt;Long, User&gt; users = userService<span class="hljs-selector-class">.batchGetUsers</span>(new HashSet&lt;&gt;(batch));
                log<span class="hljs-selector-class">.info</span>("批量预热完成，成功预热 {} 个用户", users.size());

                <span class="hljs-comment">// 添加批次间间隔，避免压力过大</span>
                if (end &lt; userIds.size()) {
                    Thread<span class="hljs-selector-class">.sleep</span>(<span class="hljs-number">500</span>);
                }

            } catch (Exception e) {
                log<span class="hljs-selector-class">.error</span>("批量预热失败: {}", e.getMessage());
                <span class="hljs-comment">// 单个预热降级</span>
                for (Long userId : batch) {
                    try {
                        <span class="hljs-built_in">warmupSingleUser</span>(userId);
                    } catch (Exception ex) {
                        log<span class="hljs-selector-class">.error</span>("降级预热用户 {} 失败: {}", userId, ex.getMessage());
                    }
                }
            }
        }
    }

    <span class="hljs-comment">/**
     * 预热所有用户
     */</span>
    private void <span class="hljs-built_in">warmupAllUsers</span>() {
        log<span class="hljs-selector-class">.info</span>("开始预热所有用户数据...");
        try {
            List&lt;User&gt; allUsers = userService<span class="hljs-selector-class">.getAllUsers</span>();
            log<span class="hljs-selector-class">.info</span>("预热所有用户完成，共 {} 个用户", allUsers.size());
            <span class="hljs-comment">// 预热用户的其他关联数据</span>
            for (User user : allUsers) {
                <span class="hljs-built_in">warmupRelatedData</span>(user);
                <span class="hljs-comment">// 添加间隔，避免一次性加载过多数据</span>
                Thread<span class="hljs-selector-class">.sleep</span>(<span class="hljs-number">100</span>);
            }
        } catch (Exception e) {
            log<span class="hljs-selector-class">.error</span>("预热所有用户失败: {}", e.getMessage());
            throw e;
        }
    }

    <span class="hljs-comment">/**
     * 预热相关数据
     */</span>
    private void <span class="hljs-built_in">warmupRelatedData</span>(User user) {
        <span class="hljs-comment">// 预热用户的行为数据</span>
        <span class="hljs-built_in">warmupUserActivities</span>(user.getId());
    }

    <span class="hljs-comment">/**
     * 预热用户行为数据
     */</span>
    private void <span class="hljs-built_in">warmupUserActivities</span>(Long userId) {
        try {
            <span class="hljs-comment">// 调用行为服务预热</span>
            <span class="hljs-comment">// activityService.warmupUserActivities(userId);</span>
            log<span class="hljs-selector-class">.debug</span>("预热用户 {} 的行为数据", userId);
        } catch (Exception e) {
            log<span class="hljs-selector-class">.warn</span>("预热用户 {} 的行为数据失败: {}", userId, e.getMessage());
        }
    }


    <span class="hljs-comment">/**
     * 验证预热结果
     */</span>
    public void <span class="hljs-built_in">verifyWarmupResult</span>() {
        log<span class="hljs-selector-class">.info</span>("验证预热结果...");
        int successCount = <span class="hljs-number">0</span>;
        int totalCount = WarmupConfig<span class="hljs-selector-class">.HOT_USER_IDS</span><span class="hljs-selector-class">.size</span>();
        for (Long userId : WarmupConfig.HOT_USER_IDS) {
            try {
                <span class="hljs-comment">// 测试缓存是否命中</span>
                long startTime = System<span class="hljs-selector-class">.nanoTime</span>();
                User user = userService<span class="hljs-selector-class">.getUserById</span>(userId);
                long endTime = System<span class="hljs-selector-class">.nanoTime</span>();
                long duration = TimeUnit<span class="hljs-selector-class">.NANOSECONDS</span><span class="hljs-selector-class">.toMillis</span>(endTime - startTime);
                if (duration &lt; <span class="hljs-number">10</span>) { <span class="hljs-comment">// 如果响应时间小于10ms，说明命中了缓存</span>
                    successCount++;
                    log<span class="hljs-selector-class">.debug</span>("用户 {} 缓存预热验证成功，响应时间: {} ms", userId, duration);
                } else {
                    log<span class="hljs-selector-class">.warn</span>("用户 {} 缓存预热验证失败，响应时间: {} ms", userId, duration);
                }
            } catch (Exception e) {
                log<span class="hljs-selector-class">.error</span>("验证用户 {} 失败: {}", userId, e.getMessage());
            }
        }
        log<span class="hljs-selector-class">.info</span>("预热结果验证完成，成功率: {} / {} ({:.<span class="hljs-number">2</span>f}%)",
                successCount, totalCount, (double) successCount / totalCount * <span class="hljs-number">100</span>);
    }
}
</code></pre>
<h3 data-id="heading-24">6.3 缓存监控</h3>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3e4458c72707476fb32e692560b310cd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zuo5Lit6aOY6I2h55qE6K6w5b-G:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769240782&amp;x-signature=wky0TvmiONYywhTeIPUlOrfciO0%3D" alt="" loading="lazy"/></p>
<pre><code class="hljs language-typescript" lang="typescript"> <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> <span class="hljs-title class_">CacheManager</span> cacheManager;
    <span class="hljs-comment">// 预警阈值配置</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AlertThreshold</span> {
        <span class="hljs-comment">// 命中率阈值（低于此值发出警告）</span>
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> final double <span class="hljs-variable constant_">MIN_HIT_RATE</span> = <span class="hljs-number">0.8</span>;
        <span class="hljs-comment">// 平均加载时间阈值（超过此值发出警告）</span>
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> final long <span class="hljs-variable constant_">MAX_AVG_LOAD_TIME_MS</span> = <span class="hljs-number">100</span>;
        <span class="hljs-comment">// 内存使用率阈值</span>
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> final double <span class="hljs-variable constant_">MAX_MEMORY_USAGE_PERCENT</span> = <span class="hljs-number">80.0</span>;
        <span class="hljs-comment">// 错误率阈值</span>
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> final double <span class="hljs-variable constant_">MAX_ERROR_RATE</span> = <span class="hljs-number">0.01</span>;
        <span class="hljs-comment">// 缓存大小阈值</span>
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> final long <span class="hljs-variable constant_">MAX_CACHE_SIZE</span> = <span class="hljs-number">10000</span>;
    }

    <span class="hljs-comment">/**
     * 获取所有缓存的统计信息
     */</span>
    <span class="hljs-meta">@GetMapping</span>(<span class="hljs-string">"/stats"</span>)
    <span class="hljs-keyword">public</span> <span class="hljs-title class_">ResponseEntity</span>&lt;<span class="hljs-title class_">Map</span>&lt;<span class="hljs-title class_">String</span>, <span class="hljs-title class_">Object</span>&gt;&gt; <span class="hljs-title function_">getAllCacheStats</span>(<span class="hljs-params"/>) {
        <span class="hljs-title class_">Map</span>&lt;<span class="hljs-title class_">String</span>, <span class="hljs-title class_">Object</span>&gt; result = <span class="hljs-keyword">new</span> <span class="hljs-title class_">LinkedHashMap</span>&lt;&gt;();
        <span class="hljs-comment">// 获取所有缓存名称</span>
        <span class="hljs-title class_">List</span>&lt;<span class="hljs-title class_">String</span>&gt; cacheNames = cacheManager.<span class="hljs-title function_">getCacheNames</span>();
        result.<span class="hljs-title function_">put</span>(<span class="hljs-string">"timestamp"</span>, <span class="hljs-title class_">LocalDateTime</span>.<span class="hljs-title function_">now</span>());
        result.<span class="hljs-title function_">put</span>(<span class="hljs-string">"cacheNames"</span>, cacheNames);
        result.<span class="hljs-title function_">put</span>(<span class="hljs-string">"cacheCount"</span>, cacheNames.<span class="hljs-title function_">size</span>());
        <span class="hljs-comment">// 统计汇总</span>
        <span class="hljs-title class_">CacheSummary</span> summary = <span class="hljs-keyword">new</span> <span class="hljs-title class_">CacheSummary</span>();
        <span class="hljs-keyword">for</span> (<span class="hljs-title class_">String</span> cacheName : cacheNames) {
            <span class="hljs-keyword">try</span> {
                <span class="hljs-title class_">Map</span>&lt;<span class="hljs-title class_">String</span>, <span class="hljs-title class_">Object</span>&gt; cacheStat = <span class="hljs-title function_">getCacheStat</span>(cacheName);
                result.<span class="hljs-title function_">put</span>(cacheName, cacheStat);
                <span class="hljs-comment">// 汇总统计</span>
                summary.<span class="hljs-title function_">aggregate</span>(cacheStat);
            } <span class="hljs-keyword">catch</span> (<span class="hljs-title class_">Exception</span> e) {
                log.<span class="hljs-title function_">error</span>(<span class="hljs-string">"获取缓存 {} 的统计信息失败: {}"</span>, cacheName, e.<span class="hljs-title function_">getMessage</span>());
                result.<span class="hljs-title function_">put</span>(cacheName, <span class="hljs-string">"获取统计信息失败: "</span> + e.<span class="hljs-title function_">getMessage</span>());
            }
        }
        result.<span class="hljs-title function_">put</span>(<span class="hljs-string">"summary"</span>, summary);
        result.<span class="hljs-title function_">put</span>(<span class="hljs-string">"health"</span>, <span class="hljs-title function_">getCacheHealthStatus</span>(summary));
        <span class="hljs-keyword">return</span> <span class="hljs-title class_">ResponseEntity</span>.<span class="hljs-title function_">ok</span>(result);
    }

    <span class="hljs-comment">/**
     * 获取指定缓存的统计信息
     */</span>
    <span class="hljs-meta">@GetMapping</span>(<span class="hljs-string">"/stats/{cacheName}"</span>)
    <span class="hljs-keyword">public</span> <span class="hljs-title class_">ResponseEntity</span>&lt;<span class="hljs-title class_">Map</span>&lt;<span class="hljs-title class_">String</span>, <span class="hljs-title class_">Object</span>&gt;&gt; <span class="hljs-title function_">getCacheStat</span>(<span class="hljs-params"><span class="hljs-meta">@PathVariable</span> <span class="hljs-built_in">String</span> cacheName</span>) {
        log.<span class="hljs-title function_">info</span>(<span class="hljs-string">"获取缓存 {} 的统计信息"</span>, cacheName);
        <span class="hljs-title class_">Map</span>&lt;<span class="hljs-title class_">String</span>, <span class="hljs-title class_">Object</span>&gt; result = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();
        <span class="hljs-keyword">try</span> {
            org.<span class="hljs-property">springframework</span>.<span class="hljs-property">cache</span>.<span class="hljs-property">Cache</span> springCache = cacheManager.<span class="hljs-title function_">getCache</span>(cacheName);
            <span class="hljs-keyword">if</span> (springCache == <span class="hljs-literal">null</span>) {
                <span class="hljs-keyword">return</span> <span class="hljs-title class_">ResponseEntity</span>.<span class="hljs-title function_">notFound</span>().<span class="hljs-title function_">build</span>();
            }
            <span class="hljs-title class_">Object</span> nativeCache = springCache.<span class="hljs-title function_">getNativeCache</span>();
            <span class="hljs-keyword">if</span> (nativeCache <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">Cache</span>) {
                <span class="hljs-title class_">Cache</span>&lt;?, ?&gt; cache = (<span class="hljs-title class_">Cache</span>&lt;?, ?&gt;) nativeCache;
                <span class="hljs-title class_">CacheStats</span> stats = cache.<span class="hljs-title function_">stats</span>();
                <span class="hljs-comment">// 基本信息</span>
                result.<span class="hljs-title function_">put</span>(<span class="hljs-string">"name"</span>, cacheName);
                result.<span class="hljs-title function_">put</span>(<span class="hljs-string">"size"</span>, <span class="hljs-title function_">estimateCacheSize</span>(cache));
                result.<span class="hljs-title function_">put</span>(<span class="hljs-string">"estimatedMemoryUsage"</span>, <span class="hljs-title function_">estimateMemoryUsage</span>(cache));
                <span class="hljs-comment">// 统计数据</span>
                result.<span class="hljs-title function_">put</span>(<span class="hljs-string">"requestCount"</span>, stats.<span class="hljs-title function_">requestCount</span>());
                result.<span class="hljs-title function_">put</span>(<span class="hljs-string">"hitCount"</span>, stats.<span class="hljs-title function_">hitCount</span>());
                result.<span class="hljs-title function_">put</span>(<span class="hljs-string">"missCount"</span>, stats.<span class="hljs-title function_">missCount</span>());
                result.<span class="hljs-title function_">put</span>(<span class="hljs-string">"hitRate"</span>, stats.<span class="hljs-title function_">hitRate</span>());
                result.<span class="hljs-title function_">put</span>(<span class="hljs-string">"missRate"</span>, stats.<span class="hljs-title function_">missRate</span>());
                <span class="hljs-comment">// 加载统计</span>
                result.<span class="hljs-title function_">put</span>(<span class="hljs-string">"loadSuccessCount"</span>, stats.<span class="hljs-title function_">loadSuccessCount</span>());
                result.<span class="hljs-title function_">put</span>(<span class="hljs-string">"loadFailureCount"</span>, stats.<span class="hljs-title function_">loadFailureCount</span>());
                result.<span class="hljs-title function_">put</span>(<span class="hljs-string">"loadFailureRate"</span>, <span class="hljs-title function_">calculateLoadFailureRate</span>(stats));
                result.<span class="hljs-title function_">put</span>(<span class="hljs-string">"totalLoadTime"</span>, stats.<span class="hljs-title function_">totalLoadTime</span>());
                result.<span class="hljs-title function_">put</span>(<span class="hljs-string">"averageLoadPenalty"</span>, stats.<span class="hljs-title function_">averageLoadPenalty</span>());
                <span class="hljs-comment">// 淘汰统计</span>
                result.<span class="hljs-title function_">put</span>(<span class="hljs-string">"evictionCount"</span>, stats.<span class="hljs-title function_">evictionCount</span>());
                result.<span class="hljs-title function_">put</span>(<span class="hljs-string">"evictionWeight"</span>, stats.<span class="hljs-title function_">evictionWeight</span>());
                <span class="hljs-comment">// 其他统计</span>
                result.<span class="hljs-title function_">put</span>(<span class="hljs-string">"rejectionCount"</span>, stats.<span class="hljs-title function_">rejectionCount</span>());
                <span class="hljs-comment">// 计算衍生指标</span>
                result.<span class="hljs-title function_">put</span>(<span class="hljs-string">"errorRate"</span>, <span class="hljs-title function_">calculateErrorRate</span>(stats));
                result.<span class="hljs-title function_">put</span>(<span class="hljs-string">"loadSuccessRate"</span>, <span class="hljs-title function_">calculateLoadSuccessRate</span>(stats));
                <span class="hljs-comment">// 预警信息</span>
                result.<span class="hljs-title function_">put</span>(<span class="hljs-string">"alerts"</span>, <span class="hljs-title function_">checkCacheAlerts</span>(cacheName, stats, cache.<span class="hljs-title function_">estimatedSize</span>()));
            } <span class="hljs-keyword">else</span> {
                result.<span class="hljs-title function_">put</span>(<span class="hljs-string">"error"</span>, <span class="hljs-string">"不支持的缓存类型: "</span> + nativeCache.<span class="hljs-title function_">getClass</span>().<span class="hljs-title function_">getName</span>());
            }
        } <span class="hljs-keyword">catch</span> (<span class="hljs-title class_">Exception</span> e) {
            log.<span class="hljs-title function_">error</span>(<span class="hljs-string">"获取缓存 {} 统计信息失败: {}"</span>, cacheName, e.<span class="hljs-title function_">getMessage</span>());
            result.<span class="hljs-title function_">put</span>(<span class="hljs-string">"error"</span>, e.<span class="hljs-title function_">getMessage</span>());
        }
        result.<span class="hljs-title function_">put</span>(<span class="hljs-string">"timestamp"</span>, <span class="hljs-title class_">LocalDateTime</span>.<span class="hljs-title function_">now</span>());
        <span class="hljs-keyword">return</span> <span class="hljs-title class_">ResponseEntity</span>.<span class="hljs-title function_">ok</span>(result);
    }
</code></pre>
<h2 data-id="heading-25">7. 性能优化技巧</h2>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d2dffb22ad91461a8f99e3004d37810b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zuo5Lit6aOY6I2h55qE6K6w5b-G:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769240782&amp;x-signature=wNJ8gy1A7MDRs2dww%2FMgRI0bpkg%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-26">7.1 批量加载优化</h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 批量加载优化</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BatchUserService</span> {

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> AsyncLoadingCache&lt;<span class="hljs-built_in">Long</span>, User&gt; userCache;

    <span class="hljs-keyword">public</span> BatchUserService() {
        <span class="hljs-keyword">this</span>.userCache = Caffeine.newBuilder()
            .maximumSize(<span class="hljs-number">1000</span>)
            .expireAfterWrite(<span class="hljs-number">10</span>, TimeUnit.MINUTES)
            .buildAsync(<span class="hljs-keyword">this</span>::batchLoadUsers);
    }

    <span class="hljs-keyword">private</span> Map&lt;<span class="hljs-built_in">Long</span>, User&gt; batchLoadUsers(Set&lt;<span class="hljs-built_in">Long</span>&gt; userIds) {
        <span class="hljs-keyword">if</span> (userIds.isEmpty()) {
            <span class="hljs-keyword">return</span> Collections.emptyMap();
        }

        <span class="hljs-comment">// 批量查询数据库</span>
        List&lt;User&gt; users = userRepository.findAllById(userIds);

        <span class="hljs-comment">// 转换为Map</span>
        <span class="hljs-keyword">return</span> users.stream()
            .collect(Collectors.toMap(User::getId, user -&gt; user));
    }

    <span class="hljs-keyword">public</span> Map&lt;<span class="hljs-built_in">Long</span>, User&gt; getUsers(Set&lt;<span class="hljs-built_in">Long</span>&gt; userIds) {
        <span class="hljs-keyword">return</span> userCache.getAll(userIds).join();
    }
}
</code></pre>
<h2 data-id="heading-27">8. 实战案例</h2>
<h3 data-id="heading-28">8.1 用户信息缓存服务</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> com.<span class="hljs-property">github</span>.<span class="hljs-property">benmanes</span>.<span class="hljs-property">caffeine</span>.<span class="hljs-property">cache</span>.<span class="hljs-property">Cache</span>;
<span class="hljs-keyword">import</span> com.<span class="hljs-property">github</span>.<span class="hljs-property">benmanes</span>.<span class="hljs-property">caffeine</span>.<span class="hljs-property">cache</span>.<span class="hljs-property">Caffeine</span>;
<span class="hljs-keyword">import</span> org.<span class="hljs-property">springframework</span>.<span class="hljs-property">stereotype</span>.<span class="hljs-property">Service</span>;

<span class="hljs-keyword">import</span> java.<span class="hljs-property">util</span>.<span class="hljs-property">concurrent</span>.<span class="hljs-property">TimeUnit</span>;

<span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserInfoCacheService</span> {

    <span class="hljs-keyword">private</span> final <span class="hljs-title class_">Cache</span>&lt;<span class="hljs-title class_">Long</span>, <span class="hljs-title class_">UserInfo</span>&gt; userInfoCache;

    <span class="hljs-keyword">public</span> <span class="hljs-title class_">UserInfoCacheService</span>() {
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">userInfoCache</span> = <span class="hljs-title class_">Caffeine</span>.<span class="hljs-title function_">newBuilder</span>()
            .<span class="hljs-title function_">maximumSize</span>(<span class="hljs-number">10000</span>)
            .<span class="hljs-title function_">expireAfterWrite</span>(<span class="hljs-number">30</span>, <span class="hljs-title class_">TimeUnit</span>.<span class="hljs-property">MINUTES</span>)
            .<span class="hljs-title function_">expireAfterAccess</span>(<span class="hljs-number">10</span>, <span class="hljs-title class_">TimeUnit</span>.<span class="hljs-property">MINUTES</span>)
            .<span class="hljs-title function_">recordStats</span>()
            .<span class="hljs-title function_">build</span>();
    }

    <span class="hljs-comment">/**
     * 获取用户信息
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title class_">UserInfo</span> <span class="hljs-title function_">getUserInfo</span>(<span class="hljs-params">Long userId</span>) {
        <span class="hljs-keyword">return</span> userInfoCache.<span class="hljs-title function_">get</span>(userId, <span class="hljs-attr">this</span>::loadUserInfoFromDB);
    }

    <span class="hljs-comment">/**
     * 批量获取用户信息
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title class_">Map</span>&lt;<span class="hljs-title class_">Long</span>, <span class="hljs-title class_">UserInfo</span>&gt; <span class="hljs-title function_">batchGetUserInfo</span>(<span class="hljs-params"><span class="hljs-built_in">Set</span>&lt;Long&gt; userIds</span>) {
        <span class="hljs-keyword">return</span> userInfoCache.<span class="hljs-title function_">getAll</span>(userIds, <span class="hljs-attr">this</span>::batchLoadUserInfoFromDB);
    }

    <span class="hljs-comment">/**
     * 更新用户信息
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">updateUserInfo</span>(<span class="hljs-params">Long userId, UserInfo userInfo</span>) {
        userInfoCache.<span class="hljs-title function_">put</span>(userId, userInfo);
    }

    <span class="hljs-comment">/**
     * 删除用户信息
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">removeUserInfo</span>(<span class="hljs-params">Long userId</span>) {
        userInfoCache.<span class="hljs-title function_">invalidate</span>(userId);
    }

    <span class="hljs-comment">/**
     * 获取缓存统计
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title class_">CacheStats</span> <span class="hljs-title function_">getCacheStats</span>(<span class="hljs-params"/>) {
        <span class="hljs-keyword">return</span> userInfoCache.<span class="hljs-title function_">stats</span>();
    }

    <span class="hljs-comment">/**
     * 从数据库加载用户信息
     */</span>
    <span class="hljs-keyword">private</span> <span class="hljs-title class_">UserInfo</span> <span class="hljs-title function_">loadUserInfoFromDB</span>(<span class="hljs-params">Long userId</span>) {
        <span class="hljs-comment">// 模拟数据库查询</span>
        <span class="hljs-keyword">try</span> {
            <span class="hljs-title class_">Thread</span>.<span class="hljs-title function_">sleep</span>(<span class="hljs-number">100</span>); <span class="hljs-comment">// 模拟数据库查询耗时</span>
        } <span class="hljs-keyword">catch</span> (<span class="hljs-title class_">InterruptedException</span> e) {
            <span class="hljs-title class_">Thread</span>.<span class="hljs-title function_">currentThread</span>().<span class="hljs-title function_">interrupt</span>();
        }
        <span class="hljs-keyword">return</span> userRepository.<span class="hljs-title function_">findById</span>(userId);
    }

    <span class="hljs-comment">/**
     * 批量从数据库加载用户信息
     */</span>
    <span class="hljs-keyword">private</span> <span class="hljs-title class_">Map</span>&lt;<span class="hljs-title class_">Long</span>, <span class="hljs-title class_">UserInfo</span>&gt; <span class="hljs-title function_">batchLoadUserInfoFromDB</span>(<span class="hljs-params"><span class="hljs-built_in">Set</span>&lt;Long&gt; userIds</span>) {
        <span class="hljs-keyword">return</span> userRepository.<span class="hljs-title function_">findAllById</span>(userIds).<span class="hljs-title function_">stream</span>()
            .<span class="hljs-title function_">collect</span>(<span class="hljs-title class_">Collectors</span>.<span class="hljs-title function_">toMap</span>(<span class="hljs-title class_">UserInfo</span>::getId, <span class="hljs-title class_">Function</span>.<span class="hljs-title function_">identity</span>()));
    }
}
</code></pre>
<h2 data-id="heading-29">9. 总结</h2>
<p>Caffeine作为Java缓存领域的佼佼者，凭借其出色的性能和丰富的功能，已经成为许多项目的首选缓存方案。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[5大核心分析维度+3种可视化方案：脑肿瘤大数据分析系统全解析 毕业设计 选题推荐 毕设选题 数据分析 机器学习]]></title>    <link>https://juejin.cn/post/7595859552347979828</link>    <guid>https://juejin.cn/post/7595859552347979828</guid>    <pubDate>2026-01-17T07:51:17.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7595859552347979828" data-draft-id="7595878718171234340" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="5大核心分析维度+3种可视化方案：脑肿瘤大数据分析系统全解析 毕业设计 选题推荐 毕设选题 数据分析 机器学习"/> <meta itemprop="keywords" content="后端,Python,大数据"/> <meta itemprop="datePublished" content="2026-01-17T07:51:17.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="计算机编程指导师"/> <meta itemprop="url" content="https://juejin.cn/user/881156097585216"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            5大核心分析维度+3种可视化方案：脑肿瘤大数据分析系统全解析 毕业设计 选题推荐 毕设选题 数据分析 机器学习
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/881156097585216/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    计算机编程指导师
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-17T07:51:17.000Z" title="Sat Jan 17 2026 07:51:17 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-17
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">脑肿瘤数据可视化分系统-简介</h2>
<p>本系统是一个基于Hadoop+Spark的大数据分析平台，专注于脑肿瘤医疗数据的可视化研究。系统后端采用Python语言，结合Django框架构建服务接口，并利用Spark进行大规模数据的高效处理与计算。原始脑肿瘤数据存储于Hadoop分布式文件系统（HDFS）中，通过Spark SQL对数据进行清洗、转换和多维度聚合分析。分析功能涵盖患者人口学特征、肿瘤临床特征、治疗方案与预后效果、临床症状关联性以及高风险因素探索等五大核心模块。处理后的结果经由Django API传递至前端，前端则运用Vue框架结合ElementUI组件库与Echarts图表库，将复杂的数据关系转化为直观的交互式图表，如性别年龄分布、肿瘤位置与恶性程度关联、不同治疗方案生存率对比等，为医疗研究者和临床医生提供一个全面、高效的数据洞察工具。</p>
<h2 data-id="heading-1">脑肿瘤数据可视化分系统-技术</h2>
<p>开发语言：Python或Java
大数据框架：Hadoop+Spark（本次没用Hive，支持定制）
后端框架：Django+Spring Boot(Spring+SpringMVC+Mybatis)
前端：Vue+ElementUI+Echarts+HTML+CSS+JavaScript+jQuery
详细技术点：Hadoop、HDFS、Spark、Spark SQL、Pandas、NumPy
数据库：MySQL</p>
<h2 data-id="heading-2">脑肿瘤数据可视化分系统-背景</h2>
<p>选题背景
随着医疗信息化进程的加快，医院积累了海量的脑肿瘤患者诊疗数据，这些数据包含了从患者基本信息到复杂治疗方案的多个维度。脑肿瘤本身作为一种复杂的疾病，其成因、发展和治疗效果受到众多因素交织影响。面对如此庞大且关系错综复杂的数据集，传统的统计分析工具往往显得力不从心，难以快速、全面地揭示隐藏在数据背后的规律。如何有效利用这些宝贵的数据资产，从中发现有价值的临床洞见，辅助医生进行更精准的诊断和治疗决策，成为了当前医疗领域面临的一个实际问题。因此，构建一个能够处理和分析这类复杂数据的系统显得尤为必要。</p>
<p>选题意义
本课题的意义在于将前沿的大数据技术应用于具体的医疗数据分析场景中，具有很强的实践价值。从技术层面看，它完整地实践了从数据存储、分布式计算到前端可视化的全流程，巩固了对Hadoop和Spark生态的理解与应用能力。从应用角度看，系统通过多维度的交互式图表，将原本枯燥的脑肿瘤数据变得直观易懂，能够帮助医学专业的学生或初级研究人员快速把握数据特征，发现一些潜在的临床关联模式，比如特定年龄段的高发肿瘤类型或不同治疗方案的疗效对比。虽然作为一个毕业设计，其分析深度和模型精度有限，但它为探索医疗数据的价值提供了一个可行的方法和思路，展示了大数据技术在精准医疗领域的应用潜力。</p>
<h2 data-id="heading-3">脑肿瘤数据可视化分系统-视频展示</h2>
<p>[video(video-53oW3KNj-1768628790189)(type-csdn)(url-<a href="https://link.juejin.cn?target=https%3A%2F%2Flive.csdn.net%2Fv%2Fembed%2F510509)(image-https%3A%2F%2Fi-blog.csdnimg.cn%2Fdirect%2Fba107941315b4411b07040a15571a3d1.png)(title-%25E5%259F%25BA%25E4%25BA%258EHadoop%2BSpark%25E7%259A%2584%25E8%2584%2591%25E8%2582%25BF%25E7%2598%25A4%25E6%2595%25B0%25E6%258D%25AE%25E5%258F%25AF%25E8%25A7%2586%25E5%258C%2596%25E5%2588%2586%25E7%25B3%25BB%25E7%25BB%259F" target="_blank" title="https://live.csdn.net/v/embed/510509)(image-https://i-blog.csdnimg.cn/direct/ba107941315b4411b07040a15571a3d1.png)(title-%E5%9F%BA%E4%BA%8EHadoop+Spark%E7%9A%84%E8%84%91%E8%82%BF%E7%98%A4%E6%95%B0%E6%8D%AE%E5%8F%AF%E8%A7%86%E5%8C%96%E5%88%86%E7%B3%BB%E7%BB%9F" ref="nofollow noopener noreferrer">live.csdn.net/v/embed/510…</a>)]</p>
<h2 data-id="heading-4">脑肿瘤数据可视化分系统-图片展示</h2>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b1ca6479f27640cea8fc037c722e9626~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6K6h566X5py657yW56iL5oyH5a-85biI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769241077&amp;x-signature=L0L4Ooc%2BC%2BVlgNYPQq3nDbOt%2BAk%3D" alt="在这里插入图片描述" loading="lazy"/>
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/61167753b6894641894b32b7db9fb88d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6K6h566X5py657yW56iL5oyH5a-85biI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769241077&amp;x-signature=czPlR0ro48G9eNe2e7Wp7OQ%2B9ME%3D" alt="在这里插入图片描述" loading="lazy"/>
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1ef857ad3c8f470ab1f897a47ed43b19~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6K6h566X5py657yW56iL5oyH5a-85biI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769241077&amp;x-signature=V%2Bw1wUNaYt8rgqSj9RndYKmQiBE%3D" alt="在这里插入图片描述" loading="lazy"/>
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d34aff6a7fc54254b5da103426ef75c6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6K6h566X5py657yW56iL5oyH5a-85biI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769241077&amp;x-signature=k12dpiENNLtfduJjMg9ISoNFvb0%3D" alt="在这里插入图片描述" loading="lazy"/>
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d51ab6cab7144bfb9e3c3bddfd65c128~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6K6h566X5py657yW56iL5oyH5a-85biI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769241077&amp;x-signature=Ne8fzBXWEk31IeFo3Iq%2BhCRzZCM%3D" alt="在这里插入图片描述" loading="lazy"/>
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4517d050331f47d98cb50fec03307c63~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6K6h566X5py657yW56iL5oyH5a-85biI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769241077&amp;x-signature=aMU5wKvmetBFw%2BWL1qBC%2Bj2VKzg%3D" alt="在这里插入图片描述" loading="lazy"/>
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8bf6a4bb6e794084babc2721a675edd8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6K6h566X5py657yW56iL5oyH5a-85biI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769241077&amp;x-signature=4bFpALfQjiyQfdqLAob4BCFqyi0%3D" alt="在这里插入图片描述" loading="lazy"/>
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b64fe039a2e3403c9b66be7c381c5f72~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6K6h566X5py657yW56iL5oyH5a-85biI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769241077&amp;x-signature=Uf5IHjRxrequrUB30UpDqS0t4xk%3D" alt="在这里插入图片描述" loading="lazy"/>
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ebbdbb846879468591e47ed6cd5b03ea~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6K6h566X5py657yW56iL5oyH5a-85biI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769241077&amp;x-signature=G0yXRlkvPLkgPWOMFnDKSjd3CUg%3D" alt="在这里插入图片描述" loading="lazy"/>
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8668a1825a574a5da064bd933f3bc979~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6K6h566X5py657yW56iL5oyH5a-85biI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769241077&amp;x-signature=CMK7xL3HL4W7t%2BvwZ2hWvxBpKpo%3D" alt="在这里插入图片描述" loading="lazy"/>
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/66a048459d774ab3bc78a6a73acdbca9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6K6h566X5py657yW56iL5oyH5a-85biI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769241077&amp;x-signature=9wk1%2FM%2BH1lWcRTGtc6i0MMbP6NY%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<h2 data-id="heading-5">脑肿瘤数据可视化分系统-代码展示</h2>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> pyspark.sql <span class="hljs-keyword">import</span> SparkSession, functions <span class="hljs-keyword">as</span> F
<span class="hljs-keyword">from</span> pyspark.sql.types <span class="hljs-keyword">import</span> IntegerType
spark = SparkSession.builder.appName(<span class="hljs-string">"BrainTumorAnalysis"</span>).getOrCreate()
df = spark.read.csv(<span class="hljs-string">"hdfs://path/to/brain_tumor_data.csv"</span>, header=<span class="hljs-literal">True</span>, inferSchema=<span class="hljs-literal">True</span>)
<span class="hljs-keyword">def</span> <span class="hljs-title function_">analyze_age_gender_distribution</span>():
    age_group_df = df.withColumn(<span class="hljs-string">"Age_Group"</span>, F.when((df.Age &lt; <span class="hljs-number">18</span>), <span class="hljs-string">"少年"</span>).when((df.Age &gt;= <span class="hljs-number">18</span>) &amp; (df.Age &lt; <span class="hljs-number">40</span>), <span class="hljs-string">"青年"</span>).when((df.Age &gt;= <span class="hljs-number">40</span>) &amp; (df.Age &lt; <span class="hljs-number">60</span>), <span class="hljs-string">"中年"</span>).otherwise(<span class="hljs-string">"老年"</span>))
    result_df = age_group_df.groupBy(<span class="hljs-string">"Age_Group"</span>, <span class="hljs-string">"Gender"</span>).count().orderBy(<span class="hljs-string">"Age_Group"</span>, <span class="hljs-string">"Gender"</span>)
    result_df.show()
    <span class="hljs-keyword">return</span> result_df
<span class="hljs-keyword">def</span> <span class="hljs-title function_">analyze_treatment_survival</span>():
    treatment_df = df.withColumn(<span class="hljs-string">"Treatment_Combination"</span>, F.concat_ws(<span class="hljs-string">"+"</span>, F.when(df.Surgery_Performed == <span class="hljs-string">"Yes"</span>, <span class="hljs-string">"手术"</span>), F.when(df.Radiation_Treatment == <span class="hljs-string">"Yes"</span>, <span class="hljs-string">"放疗"</span>), F.when(df.Chemotherapy == <span class="hljs-string">"Yes"</span>, <span class="hljs-string">"化疗"</span>)))
    survival_df = treatment_df.groupBy(<span class="hljs-string">"Treatment_Combination"</span>).agg(F.avg(<span class="hljs-string">"Survival_Rate"</span>).alias(<span class="hljs-string">"Average_Survival_Rate"</span>), F.count(<span class="hljs-string">"*"</span>).alias(<span class="hljs-string">"Patient_Count"</span>)).orderBy(F.desc(<span class="hljs-string">"Average_Survival_Rate"</span>))
    survival_df.show()
    <span class="hljs-keyword">return</span> survival_df
<span class="hljs-keyword">def</span> <span class="hljs-title function_">analyze_correlation</span>():
    correlation_df = df.select(<span class="hljs-string">"Age"</span>, <span class="hljs-string">"Tumor_Size"</span>, <span class="hljs-string">"Survival_Rate"</span>, <span class="hljs-string">"Tumor_Growth_Rate"</span>).na.drop()
    age_size_corr = correlation_df.stat.corr(<span class="hljs-string">"Age"</span>, <span class="hljs-string">"Tumor_Size"</span>)
    age_survival_corr = correlation_df.stat.corr(<span class="hljs-string">"Age"</span>, <span class="hljs-string">"Survival_Rate"</span>)
    size_survival_corr = correlation_df.stat.corr(<span class="hljs-string">"Tumor_Size"</span>, <span class="hljs-string">"Survival_Rate"</span>)
    growth_survival_corr = correlation_df.stat.corr(<span class="hljs-string">"Tumor_Growth_Rate"</span>, <span class="hljs-string">"Survival_Rate"</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"年龄与肿瘤尺寸的相关系数: <span class="hljs-subst">{age_size_corr}</span>"</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"年龄与生存率的相关系数: <span class="hljs-subst">{age_survival_corr}</span>"</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"肿瘤尺寸与生存率的相关系数: <span class="hljs-subst">{size_survival_corr}</span>"</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"肿瘤生长速率与生存率的相关系数: <span class="hljs-subst">{growth_survival_corr}</span>"</span>)
    <span class="hljs-keyword">return</span> {<span class="hljs-string">"age_size"</span>: age_size_corr, <span class="hljs-string">"age_survival"</span>: age_survival_corr, <span class="hljs-string">"size_survival"</span>: size_survival_corr, <span class="hljs-string">"growth_survival"</span>: growth_survival_corr}
</code></pre>
<h2 data-id="heading-6">脑肿瘤数据可视化分系统-结语</h2>
<p>这个项目完整走通了大数据分析流程，从Hadoop存储到Spark计算，再到前端可视化，技术栈很扎实。希望能给正在做毕设的同学一点启发。如果觉得有帮助，别忘了点赞收藏，你的支持是我更新的最大动力！</p>
<p>刚肝完这个基于Spark的脑肿瘤分析毕设，感觉头发又掉了不少😂。数据清洗和特征工程真的太磨人了，但最后看到Echarts图表出来的那一刻，值了！大家选题都定了吗？评论区聊聊，互相避坑啊！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[nestjs学习3：核心概念扫盲]]></title>    <link>https://juejin.cn/post/7595873251165257769</link>    <guid>https://juejin.cn/post/7595873251165257769</guid>    <pubDate>2026-01-17T03:21:02.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7595873251165257769" data-draft-id="7595491816776040489" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="nestjs学习3：核心概念扫盲"/> <meta itemprop="keywords" content="NestJS"/> <meta itemprop="datePublished" content="2026-01-17T03:21:02.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="一江东流水"/> <meta itemprop="url" content="https://juejin.cn/user/1151943917181880"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            nestjs学习3：核心概念扫盲
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1151943917181880/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    一江东流水
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-17T03:21:02.000Z" title="Sat Jan 17 2026 03:21:02 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-17
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>声明：本文来自于光神的文章，复制到这里只是为了自己更好的复习。</p>
<p>Nest 是对标 Java 的 Spring 框架的后端框架，它有很多概念。对于新手来说，上来就接触这些概念可能会有点懵，今天主要是过一下概念。</p>
<p>我们通过不同的 url 来访问后端接口：/user/create 、/user/list、/book/create、/book/list，不同的 url 是不同的路由。</p>
<p>这些路由在 Controller 里声明：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3181246e60004f85bfefc5afe96ebc49~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiA5rGf5Lic5rWB5rC0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769224862&amp;x-signature=uGDa6K40G5cxVK9E%2BuxiHQifeGs%3D" alt="image.png" loading="lazy"/></p>
<p>在 class 上和它方法的方法上加上 @Controller、@Get、@Post 的装饰器就可以了。</p>
<p>controller里面的方法，比如 create、findAll等叫做 <code>handler</code>，是处理路由的。</p>
<p>post 的请求体，get 的请求参数，都可以通过装饰来取：</p>
<p>通过 @Param 取 url 中的参数，比如 /user/111 里的 111:</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7b18cdebe39f49f88aa9d6bda3772bcd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiA5rGf5Lic5rWB5rC0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769224862&amp;x-signature=dFTUpGAxAyyq6akjUa7e3NTFI%2Fk%3D" alt="image.png" loading="lazy"/></p>
<p>通过 @Query 来取 url 中的 query 参数，比如 /user/xx?id=222 里的 222</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5b2cb2c2484d46aa87bd119e16022472~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiA5rGf5Lic5rWB5rC0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769224862&amp;x-signature=m9aWInXUgnqYm0bYXpVcNmJ1%2BUM%3D" alt="image.png" loading="lazy"/></p>
<p>通过 @Body 取 /book/create 的请求体内容：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e3fde21f100a4369b1fb0b2e88b0579f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiA5rGf5Lic5rWB5rC0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769224862&amp;x-signature=4NX0db%2B15cH5JGysqbc2CMQYNlU%3D" alt="image.png" loading="lazy"/></p>
<p>那<code>@Param、@Query、@Body</code>装饰器在其中起了什么作用呢？</p>
<ul>
<li>当 NestJS 应用启动、加载控制器类时，装饰器会<strong>先执行</strong>（装饰器的执行时机是类 / 方法定义时，而非请求到来时），<code>@Param('id')</code> 的核心逻辑如下：</li>
</ul>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> <span class="hljs-string">'reflect-metadata'</span>; 
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">Param</span>(<span class="hljs-params">paramKey?: string</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-function">(<span class="hljs-params">target: object, methodKey: string | symbol, paramIndex: number</span>) =&gt;</span> {
        <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">METADATA_KEY</span> = <span class="hljs-string">'nest:params:metadata'</span>;
        <span class="hljs-comment">// 先获取该方法已有的元数据</span>
        <span class="hljs-keyword">const</span> existingMetadata = <span class="hljs-title class_">Reflect</span>.<span class="hljs-title function_">getMetadata</span>(<span class="hljs-variable constant_">METADATA_KEY</span>, target, methodKey) || [];
        existingMetadata[paramIndex] = { 
            <span class="hljs-attr">type</span>: <span class="hljs-string">'param'</span>, <span class="hljs-comment">// 标识参数类型是路由参数 </span>
            <span class="hljs-attr">key</span>: paramKey, <span class="hljs-comment">// 要提取的参数名（比如 'id'） </span>
        };
        <span class="hljs-title class_">Reflect</span>.<span class="hljs-title function_">defineMetadata</span>(<span class="hljs-variable constant_">METADATA_KEY</span>, existingMetadata, target, methodKey);
}
</code></pre>
<ul>
<li>当客户端发起 <code>GET /users/123</code> 请求时，NestJS 的底层 HTTP 适配器（Express/Fastify）解析请求，得到 <code>request</code> 对象，其中 <code>request.params = { id: '123' }</code>。NestJS 会创建执行上下文（ExecutionContext），把 <code>request</code>、<code>response</code>、路由匹配结果等都封装进去。NestJS 的参数处理器（Parameter Handler）会执行以下操作：</li>
</ul>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">getParamValue</span>(<span class="hljs-params">target: object, methodKey: string, paramIndex: number, context: ExecutionContext</span>) {
  <span class="hljs-comment">// 1. 获取步骤 1 中存入的元数据</span>
  <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">METADATA_KEY</span> = <span class="hljs-string">'nest:params:metadata'</span>;
  <span class="hljs-keyword">const</span> paramMetadata = <span class="hljs-title class_">Reflect</span>.<span class="hljs-title function_">getMetadata</span>(<span class="hljs-variable constant_">METADATA_KEY</span>, target, methodKey)[paramIndex];
  
  <span class="hljs-comment">// 2. 从上下文获取 request 对象</span>
  <span class="hljs-keyword">const</span> request = context.<span class="hljs-title function_">switchToHttp</span>().<span class="hljs-title function_">getRequest</span>();
  
  <span class="hljs-comment">// 3. 根据元数据提取对应值</span>
  <span class="hljs-keyword">if</span> (paramMetadata.<span class="hljs-property">type</span> === <span class="hljs-string">'param'</span>) {
    <span class="hljs-comment">// 如果指定了 key（比如 'id'），取单个值；否则取整个 params 对象</span>
    <span class="hljs-keyword">return</span> paramMetadata.<span class="hljs-property">key</span> ? request.<span class="hljs-property">params</span>[paramMetadata.<span class="hljs-property">key</span>] : request.<span class="hljs-property">params</span>;
  }
}
</code></pre>
<ul>
<li>NestJS 把上面提取到的 <code>'123'</code> 赋值给 <code>findOne</code> 方法的第 0 个参数（也就是 <code>id</code>），执行 <code>findOne</code> 函数时<code>id</code> 被赋值为 <code>'123'</code>。</li>
</ul>
<p>总的来说就是这样：</p>
<ol>
<li>
<p><strong>定义元数据</strong>：应用启动时，<code>@Param</code> 装饰器通过 <code>Reflect.defineMetadata</code> 把参数要从哪里取值的规则存在方法的元数据中；</p>
</li>
<li>
<p><strong>运行时注入</strong>：请求到来时，NestJS 先通过 <code>Reflect.getMetadata</code> 读取元数据，再从请求上下文的 <code>request.params</code> 中提取对应值，最后注入到函数参数中执行；</p>
</li>
<li>
<p><strong>核心依赖</strong>：整个过程的基础是 <code>Reflect Metadata</code> API，它让 NestJS 能 “记住” 装饰器的规则，实现参数的自动注入，<strong>无需手动操作 <code>request</code> 对象</strong>。</p>
</li>
</ol>
<blockquote>
<p>框架这样做的好处是什么呢？</p>
<p>好处是我们无需手动处理<code>request</code>对象，全是框架帮我们做了。你在写express时是不是自己从request对象中获取参数，特别繁琐。</p>
</blockquote>
<p>回归正题，也就是说 <strong>controller 是处理路由和解析请求参数的</strong>。</p>
<p>请求参数解析出来了，下一步就是做业务逻辑的处理了，这些东西不写在 controller 里，而是放在 service 里。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/144f7d1085724893bf3ddbdf4311f099~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiA5rGf5Lic5rWB5rC0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769224862&amp;x-signature=g%2BpUfqYehgfL%2Bd%2Fj0MHSJAwC35U%3D" alt="image.png" loading="lazy"/></p>
<p><strong>service 里做业务逻辑的具体实现，比如操作数据库等</strong></p>
<p>同理，/book/list、/book/create 接口是在另一个 BookController 里，它的业务逻辑实现也是在 BookService 里。</p>
<p>很明显，UserController 和 UserService 是一块的，BookController 和 BookService 是一块的。</p>
<p>所以，Nest 有了模块的划分，每个模块里都包含 controller 和 service：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1c452baa95e24e109258a584904a769f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiA5rGf5Lic5rWB5rC0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769224862&amp;x-signature=faqdr2kQaPV9ffyB9QKkSY2UT1w%3D" alt="image.png" loading="lazy"/></p>
<p>通过 @Module 声明模块，它包含 controllers 和 providers。</p>
<p>为啥不是 services 而是 providers 呢？</p>
<p>因为 Nest 实现了一套依赖注入机制，叫做 IoC（Inverse of Control 反转控制）。</p>
<p>简单说就是你只需要声明依赖了啥就行，不需要手动去 new 依赖，Nest 的 IoC 容器会自动给你创建并注入依赖。</p>
<p>比如这个 UserController 依赖了 JwtService，那只需要通过 @Inject 声明依赖，然后就可以在方法里用了。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b39ec6743c2f4051a84af012f2644b70~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiA5rGf5Lic5rWB5rC0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769224862&amp;x-signature=NiWMSzXFfWWKLavk%2B3jHitYF3%2FA%3D" alt="image.png" loading="lazy"/></p>
<p>运行的时候会自动查找这个 JwtServcie 的实例来注入。</p>
<p><strong>在 @Module 里的 providers 数组里，就是声明要往 IoC 容器里提供的对象，所以这里叫做 providers。</strong></p>
<p>provider 有很多种写法：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4410d7fe085748d39efd8949f4e47248~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiA5rGf5Lic5rWB5rC0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769224862&amp;x-signature=8nnerrkKgLvTDerPZvPZW%2FvdVqI%3D" alt="image.png" loading="lazy"/></p>
<p>默认的 XxxService 只是一种简化的写法。</p>
<p>还可以直接 useValue 创建，通过 useFactory 创建等。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ad7a6761a1e74507baa6c7e49a3e2769~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiA5rGf5Lic5rWB5rC0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769224862&amp;x-signature=JmvkW7WSlLixwdKaC1V84jJz7Ac%3D" alt="image.png" loading="lazy"/></p>
<p>刚才提到了 IoC 会自动从容器中查找实例来注入，注入的方式有两种：</p>
<p><strong>属性注入和构造器注入。</strong></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/67e2068d805f4e25901c6fcf5e04a162~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiA5rGf5Lic5rWB5rC0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769224862&amp;x-signature=VUyJvI5Tn6WJBGI%2BGMA32NiPVrw%3D" alt="image.png" loading="lazy"/></p>
<p>这种写在构造器里的依赖，就是构造器注入。</p>
<p>@Inject 写在属性上的依赖，就是属性注入。</p>
<p>效果是一样的，只是注入的时机不同。</p>
<p>每个模块都会包含 controller、service、module、dto、entities 这些东西：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/accdd60bafff4c5b9ffeaaeb0274cbe1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiA5rGf5Lic5rWB5rC0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769224862&amp;x-signature=d2%2BhuQzY2waoUohU7aCZJ2Upgwk%3D" alt="image.png" loading="lazy"/></p>
<p>controller 是处理路由，解析请求参数的。</p>
<p>service 是处理业务逻辑的，比如操作数据库。</p>
<p>dto 是封装请求参数的。</p>
<p>entities 是封装对应数据库表的实体的。</p>
<p>nest 应用跑起来后，会从 AppModule 开始解析，初始化 IoC 容器，加载所有的 service 到容器里，然后解析 controller 里的路由，接下来就可以接收请求了。</p>
<p>应用中会有很多 controller、service，那如果是跨多个 controller 的逻辑呢？</p>
<p>这种在 Nest 提供了 AOP （Aspect Oriented Programming 面向切面编程）的机制</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cbe82217eb164362b240efc1c3dae1e0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiA5rGf5Lic5rWB5rC0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769224862&amp;x-signature=QkkKSKL182OVLuGYMv7%2BHroFwEU%3D" alt="image.png" loading="lazy"/></p>
<p>具体来说，有 Middleware、Guard、Interceptor、Pipe、Exception Filter 这五种。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b377262312524529acbf6e47cdd404e4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiA5rGf5Lic5rWB5rC0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769224862&amp;x-signature=xwuk%2FP%2F8q6Pqf%2FJrkzTLCb4fBfg%3D" alt="image.png" loading="lazy"/></p>
<p>它们都是在目标 controller 的 handler 前后，额外加一段逻辑的。</p>
<p>比如你可以通过 interceptor 实现请求到响应的时间的记录：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f084f2355e184a6d98d3e04f979465ab~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiA5rGf5Lic5rWB5rC0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769224862&amp;x-signature=9ExCE89cD8xOanwtI4L%2FIV2PXuo%3D" alt="image.png" loading="lazy"/></p>
<p>这种逻辑适合放在 controller 里么？</p>
<p>不适合，这种通用逻辑应该通过 interceptor 等方式抽离出来，然后需要用的时候在 controller 上声明一下：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b30e27c45f1a4d5d9e78e2bdf074189f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiA5rGf5Lic5rWB5rC0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769224862&amp;x-signature=DGqdYLUY1bbWke9dZkY9WHHq71g%3D" alt="image.png" loading="lazy"/></p>
<p>我们可以通过一个简单的例子来理解下 <code>@UseInterceptors</code>的逻辑：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">Intercept</span>(<span class="hljs-params">interceptor: { before?: <span class="hljs-built_in">Function</span>; after?: <span class="hljs-built_in">Function</span> }</span>) {
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">function</span> (<span class="hljs-params">target: any, propertyKey: string, descriptor: PropertyDescriptor</span>) {
    <span class="hljs-comment">// 保存原始方法</span>
    <span class="hljs-keyword">const</span> originalMethod = descriptor.<span class="hljs-property">value</span>;

    <span class="hljs-comment">// 重写方法</span>
    descriptor.<span class="hljs-property">value</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params">...args: any[]</span>) {
      <span class="hljs-comment">// 执行前置拦截逻辑</span>
      <span class="hljs-keyword">if</span> (interceptor.<span class="hljs-property">before</span>) {
        interceptor.<span class="hljs-title function_">before</span>(args);
      }

      <span class="hljs-comment">// 调用原始方法</span>
      <span class="hljs-keyword">const</span> result = originalMethod.<span class="hljs-title function_">apply</span>(<span class="hljs-variable language_">this</span>, args);

      <span class="hljs-comment">// 执行后置拦截逻辑</span>
      <span class="hljs-keyword">if</span> (interceptor.<span class="hljs-property">after</span>) {
        interceptor.<span class="hljs-title function_">after</span>(result);
      }

      <span class="hljs-comment">// 返回原始方法的结果</span>
      <span class="hljs-keyword">return</span> result;
    };

    <span class="hljs-keyword">return</span> descriptor;
  };
}

<span class="hljs-keyword">class</span> <span class="hljs-title class_">MyClass</span> {
  @<span class="hljs-title class_">Intercept</span>({
    <span class="hljs-attr">before</span>: <span class="hljs-function">(<span class="hljs-params">args: any[]</span>) =&gt;</span> {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`[BEFORE] Method is about to be called with args: <span class="hljs-subst">${<span class="hljs-built_in">JSON</span>.stringify(args)}</span>`</span>);
    },
    <span class="hljs-attr">after</span>: <span class="hljs-function">(<span class="hljs-params">result: any</span>) =&gt;</span> {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`[AFTER] Method returned: <span class="hljs-subst">${<span class="hljs-built_in">JSON</span>.stringify(result)}</span>`</span>);
    },
  })
  <span class="hljs-title function_">myMethod</span>(<span class="hljs-params">arg1: string, arg2: number</span>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"Executing myMethod"</span>);
    <span class="hljs-keyword">return</span> <span class="hljs-string">`Received: <span class="hljs-subst">${arg1}</span>, <span class="hljs-subst">${arg2}</span>`</span>;
  }
}

<span class="hljs-keyword">const</span> instance = <span class="hljs-keyword">new</span> <span class="hljs-title class_">MyClass</span>();
instance.<span class="hljs-title function_">myMethod</span>(<span class="hljs-string">"Hello"</span>, <span class="hljs-number">42</span>);

</code></pre>
<p>这些就是 Nest 的核心概念了。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[高并发 Kafka 消息发送：基于 Go 的并发安全实现与最佳实践]]></title>    <link>https://juejin.cn/post/7595871887000420352</link>    <guid>https://juejin.cn/post/7595871887000420352</guid>    <pubDate>2026-01-17T03:33:05.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7595871887000420352" data-draft-id="7595871887000403968" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="高并发 Kafka 消息发送：基于 Go 的并发安全实现与最佳实践"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2026-01-17T03:33:05.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Kevin666"/> <meta itemprop="url" content="https://juejin.cn/user/1549628692501449"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            高并发 Kafka 消息发送：基于 Go 的并发安全实现与最佳实践
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1549628692501449/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Kevin666
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-17T03:33:05.000Z" title="Sat Jan 17 2026 03:33:05 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-17
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    4
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读11分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在高吞吐业务场景中，Kafka 作为分布式消息队列，是实现消息异步投递、削峰填谷的核心组件。而基于 Go 语言开发 Kafka 生产者时，如何通过并发提升发送速度，同时保证并发安全，是很多开发者面临的核心问题。本文将通过一个实际场景，拆解「多生产者 + 多协程」的并发模型，详解其并发安全性，并基于开源组件完成可落地的实现。</p>
<h2 data-id="heading-0">一、场景背景：为什么需要并发发送 Kafka 消息？</h2>
<p>在内容审核、日志采集、数据同步等业务场景中，常常会遇到每秒数万条甚至数十万条消息的发送需求。单生产者实例的处理能力存在上限，受限于网络 IO、消息批量打包、服务器资源等因素，无法满足高并发投递要求，容易出现消息积压、发送延迟升高等问题。</p>
<p>Go 语言凭借其轻量级协程（Goroutine）的优势，能够轻松实现高并发处理。而「多生产者 + 多协程」的并发模型，正是突破单生产者性能瓶颈，实现高吞吐消息发送的最优方案之一。</p>
<p>本文将基于开源的 <code>sarama</code> 库（Kafka 官方推荐的 Go 语言客户端），实现高并发 Kafka 消息发送，并重点解答：<strong>并发场景下，Kafka 消息发送的安全性如何保证？</strong></p>
<h2 data-id="heading-1">二、核心疑问：并发发送 Kafka 消息，会存在安全问题吗？</h2>
<p>很多开发者在实现并发发送时，都会有这样的顾虑：多个协程同时调用消息发送方法，会不会出现数据竞争、消息丢失、消息错乱等问题？</p>
<p>答案先抛出来：<strong>合理的并发设计下，Kafka 消息发送是并发安全的</strong>。具体可从两个核心层面保障，这也是本文实现的核心依据。</p>
<h3 data-id="heading-2">1. 消息发送方法本身：无状态、无共享，天然并发安全</h3>
<p>消息发送的核心方法，本身只负责参数传递和底层客户端调用，不维护任何全局状态、静态变量，也不修改传入参数的内容。每个调用都是独立的，多个协程同时调用不会相互干扰。</p>
<h3 data-id="heading-3">2. 开源 Kafka 客户端（sarama）：生产者实例协程安全</h3>
<p><code>sarama</code> 库实现的 Kafka 生产者（<code>sarama.SyncProducer</code>/<code>sarama.AsyncProducer</code>）本身是协程安全的，支持多个协程同时调用其发送方法。底层通过锁机制、内部消息队列，处理并发请求的竞争问题，开发者无需手动处理同步锁，降低了并发开发的复杂度。</p>
<h3 data-id="heading-4">3. 额外保障：「一个协程对应一个独立生产者实例」</h3>
<p>即使在某些场景下，客户端生产者实例非协程安全（极少出现），我们也可以通过「一个协程对应一个独立生产者实例」的设计，避免共享实例的竞争问题，实现双重保障。这也是本文实现的核心设计思路。</p>
<h2 data-id="heading-5">三、可落地实现：基于 sarama 的高并发 Kafka 生产者</h2>
<h3 data-id="heading-6">1. 前期准备：安装 sarama 开源库</h3>
<p>首先安装官方推荐的<code>sarama</code>库，这是实现 Kafka 消息发送的基础：</p>
<pre><code class="hljs language-arduino" lang="arduino">go get github.com/Shopify/sarama
</code></pre>
<h3 data-id="heading-7">2. 全局配置定义：替换业务变量，统一配置管理</h3>
<p>我们先定义全局的配置常量和通道，替换原业务代码中的私有变量，保证代码的可复用性：</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-keyword">package</span> main

<span class="hljs-keyword">import</span> (
	<span class="hljs-string">"context"</span>
	<span class="hljs-string">"log"</span>
	<span class="hljs-string">"os"</span>
	<span class="hljs-string">"os/signal"</span>
	<span class="hljs-string">"syscall"</span>
	<span class="hljs-string">"time"</span>

	<span class="hljs-string">"github.com/Shopify/sarama"</span>
)

<span class="hljs-comment">// 全局配置：替换原业务中的 MAX_WORKERS、JobQue、JobQuitChan</span>
<span class="hljs-keyword">const</span> (
	<span class="hljs-comment">// 并发生产者数量（可根据业务需求、服务器资源调整）</span>
	ConcurrentProducerNum = <span class="hljs-number">5</span>
	<span class="hljs-comment">// 任务通道缓冲区大小：防止协程阻塞，削峰填谷</span>
	JobChanBufferSize = <span class="hljs-number">10000</span>
)

<span class="hljs-comment">// 消息任务结构体：替换原业务中的 job，封装发送所需的核心数据</span>
<span class="hljs-keyword">type</span> KafkaSendJob <span class="hljs-keyword">struct</span> {
	Ctx  context.Context <span class="hljs-comment">// 上下文：用于超时控制、取消操作</span>
	Msg  []<span class="hljs-type">byte</span>          <span class="hljs-comment">// 待发送的消息内容</span>
	Key  <span class="hljs-type">string</span>          <span class="hljs-comment">// Kafka消息Key：用于分区路由</span>
}

<span class="hljs-comment">// 全局变量：任务通道和退出通道</span>
<span class="hljs-keyword">var</span> (
	<span class="hljs-comment">// 消息任务通道：接收待发送的消息任务</span>
	KafkaJobChan = <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> KafkaSendJob, JobChanBufferSize)
	<span class="hljs-comment">// 协程退出通道：用于优雅关闭所有生产者协程</span>
	ProducerQuitChan = <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> <span class="hljs-keyword">struct</span>{}, ConcurrentProducerNum)
	<span class="hljs-comment">// Kafka集群地址：替换原业务中的 kafkaEnv.ProducerEnv.Cluster</span>
	KafkaBrokerList = []<span class="hljs-type">string</span>{<span class="hljs-string">"127.0.0.1:9092"</span>}
	<span class="hljs-comment">// Kafka主题：替换原业务中的 kafkaEnv.ProducerEnv.KafkaTopic</span>
	KafkaTopic = <span class="hljs-string">"test_high_concurrency_topic"</span>
)
</code></pre>
<h3 data-id="heading-8">3. 核心实现 1：初始化多生产者，启动并发协程</h3>
<p>这部分对应原业务中的<code>InitProducers</code>函数，我们基于<code>sarama</code>创建多个生产者实例，每个实例对应一个独立协程，实现并发发送：</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-comment">// InitKafkaProducers 初始化多个Kafka生产者实例，启动并发发送协程</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">InitKafkaProducers</span><span class="hljs-params">()</span></span> <span class="hljs-type">error</span> {
	<span class="hljs-comment">// 1. 配置sarama生产者参数</span>
	saramaConfig := sarama.NewConfig()
	<span class="hljs-comment">// 设置生产者ACK级别：-1=等待所有副本确认，保证消息不丢失</span>
	saramaConfig.Producer.RequiredAcks = sarama.WaitForAll
	<span class="hljs-comment">// 启用消息批量发送：提升发送吞吐量</span>
	saramaConfig.Producer.Flush.Bytes = <span class="hljs-number">1024</span> * <span class="hljs-number">1024</span> <span class="hljs-comment">// 批量发送阈值：1MB</span>
	saramaConfig.Producer.Flush.Frequency = <span class="hljs-number">50</span> * time.Millisecond <span class="hljs-comment">// 批量发送间隔：50ms</span>
	<span class="hljs-comment">// 配置消息序列化格式</span>
	saramaConfig.Producer.Return.Successes = <span class="hljs-literal">true</span>
	saramaConfig.Producer.Return.Errors = <span class="hljs-literal">true</span>
	<span class="hljs-comment">// 设置版本兼容（根据你的Kafka集群版本调整）</span>
	saramaConfig.Version = sarama.V2_8_1_0

	<span class="hljs-comment">// 2. 循环创建多个生产者实例，启动对应协程</span>
	<span class="hljs-keyword">for</span> i := <span class="hljs-number">1</span>; i &lt;= ConcurrentProducerNum; i++ {
		<span class="hljs-comment">// 创建同步生产者实例（同步发送：等待发送结果返回，便于重试）</span>
		producer, err := sarama.NewSyncProducer(KafkaBrokerList, saramaConfig)
		<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
			log.Printf(<span class="hljs-string">"创建第%d个Kafka生产者失败：%v"</span>, i, err)
			<span class="hljs-keyword">return</span> err
		}
		log.Printf(<span class="hljs-string">"第%d个Kafka生产者创建成功，已启动对应发送协程"</span>, i)

		<span class="hljs-comment">// 启动独立协程，处理消息发送任务（每个协程独占一个生产者实例）</span>
		<span class="hljs-keyword">go</span> RunKafkaProducer(producer, i)
	}

	<span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>
}
</code></pre>
<h3 data-id="heading-9">4. 核心实现 2：协程业务逻辑，处理消息发送任务</h3>
<p>这部分对应原业务中的<code>Run</code>函数，每个协程从任务通道中获取消息，调用发送方法完成投递，并支持优雅退出：</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-comment">// RunKafkaProducer 单个生产者协程的业务逻辑，循环处理消息任务</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">RunKafkaProducer</span><span class="hljs-params">(producer sarama.SyncProducer, producerID <span class="hljs-type">int</span>)</span></span> {
	<span class="hljs-comment">// 优雅退出：关闭生产者实例，释放资源</span>
	<span class="hljs-keyword">defer</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> {
		<span class="hljs-keyword">if</span> err := producer.Close(); err != <span class="hljs-literal">nil</span> {
			log.Printf(<span class="hljs-string">"第%d个生产者关闭失败：%v"</span>, producerID, err)
		} <span class="hljs-keyword">else</span> {
			log.Printf(<span class="hljs-string">"第%d个生产者已正常关闭"</span>, producerID)
		}
		<span class="hljs-comment">// 捕获协程panic，防止单个协程异常导致整个服务崩溃</span>
		<span class="hljs-keyword">if</span> r := <span class="hljs-built_in">recover</span>(); r != <span class="hljs-literal">nil</span> {
			log.Printf(<span class="hljs-string">"第%d个生产者协程发生panic：%v"</span>, producerID, r)
		}
	}()

	log.Printf(<span class="hljs-string">"第%d个生产者协程已启动，开始监听消息任务"</span>, producerID)

	<span class="hljs-comment">// 循环监听任务通道和退出通道</span>
	<span class="hljs-keyword">for</span> {
		<span class="hljs-keyword">select</span> {
		<span class="hljs-comment">// 从任务通道获取待发送的消息</span>
		<span class="hljs-keyword">case</span> job := &lt;-KafkaJobChan:
			<span class="hljs-comment">// 记录发送指标（此处简化，实际可接入Prometheus）</span>
			log.Printf(<span class="hljs-string">"第%d个生产者获取到消息任务，消息长度：%d"</span>, producerID, <span class="hljs-built_in">len</span>(job.Msg))
			<span class="hljs-comment">// 调用发送方法，支持3次重试</span>
			err := RetryKafkaMsgSend(producer, job, <span class="hljs-number">3</span>)
			<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
				log.Printf(<span class="hljs-string">"第%d个生产者消息发送失败（已重试3次）：%v"</span>, producerID, err)
			}
		<span class="hljs-comment">// 接收退出信号，优雅关闭协程</span>
		<span class="hljs-keyword">case</span> &lt;-ProducerQuitChan:
			log.Printf(<span class="hljs-string">"第%d个生产者接收到退出信号，即将停止工作"</span>, producerID)
			<span class="hljs-keyword">return</span>
		}
	}
}
</code></pre>
<h3 data-id="heading-10">5. 核心实现 3：消息发送与重试机制</h3>
<p>这部分对应原业务中的<code>MsgSend</code>和<code>RetryMsgSend</code>函数，实现消息的核心发送逻辑，并添加重试机制，保证消息投递的可靠性：</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-comment">// KafkaMsgSend 核心消息发送方法，调用sarama生产者完成消息投递</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">KafkaMsgSend</span><span class="hljs-params">(producer sarama.SyncProducer, job KafkaSendJob)</span></span> <span class="hljs-type">error</span> {
	<span class="hljs-comment">// 构建Kafka消息</span>
	msg := &amp;sarama.ProducerMessage{
		Topic: KafkaTopic,
		Key:   sarama.StringEncoder(job.Key),
		Value: sarama.ByteEncoder(job.Msg),
	}

	<span class="hljs-comment">// 调用sarama同步发送方法</span>
	partition, offset, err := producer.SendMessage(msg)
	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
		<span class="hljs-keyword">return</span> err
	}

	<span class="hljs-comment">// 发送成功，打印日志（实际场景可省略或接入监控）</span>
	log.Printf(<span class="hljs-string">"消息发送成功：分区=%d，偏移量=%d"</span>, partition, offset)
	<span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>
}

<span class="hljs-comment">// RetryKafkaMsgSend 消息发送重试机制，支持指定重试次数</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">RetryKafkaMsgSend</span><span class="hljs-params">(producer sarama.SyncProducer, job KafkaSendJob, retryTimes <span class="hljs-type">int</span>)</span></span> <span class="hljs-type">error</span> {
	<span class="hljs-keyword">var</span> err <span class="hljs-type">error</span>

	<span class="hljs-comment">// 循环重试发送</span>
	<span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; retryTimes; i++ {
		err = KafkaMsgSend(producer, job)
		<span class="hljs-keyword">if</span> err == <span class="hljs-literal">nil</span> {
			<span class="hljs-comment">// 发送成功，直接返回</span>
			<span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>
		}

		<span class="hljs-comment">// 发送失败，打印重试日志，延迟后重试（指数退避，优化版可调整）</span>
		log.Printf(<span class="hljs-string">"消息发送第%d次失败，即将重试：%v"</span>, i+<span class="hljs-number">1</span>, err)
		time.Sleep(time.Duration(i+<span class="hljs-number">1</span>) * <span class="hljs-number">100</span> * time.Millisecond)
	}

	<span class="hljs-comment">// 所有重试次数耗尽，返回最终错误</span>
	<span class="hljs-keyword">return</span> err
}
</code></pre>
<h3 data-id="heading-11">6. 优雅关闭：处理系统信号，保证消息不丢失</h3>
<p>在实际生产环境中，服务停止时需要优雅关闭生产者，防止正在发送的消息丢失，我们通过监听系统信号实现这一功能：</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-comment">// SetupGracefulShutdown 配置优雅关闭，处理系统停止信号</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">SetupGracefulShutdown</span><span class="hljs-params">()</span></span> {
	<span class="hljs-comment">// 创建系统信号通道</span>
	sigChan := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> os.Signal, <span class="hljs-number">1</span>)
	<span class="hljs-comment">// 监听SIGINT（Ctrl+C）和SIGTERM（容器停止）信号</span>
	signal.Notify(sigChan, syscall.SIGINT, syscall.SIGTERM)

	<span class="hljs-comment">// 阻塞等待系统信号</span>
	&lt;-sigChan
	log.Println(<span class="hljs-string">"接收到系统停止信号，开始优雅关闭Kafka生产者..."</span>)

	<span class="hljs-comment">// 1. 关闭任务通道，停止接收新任务</span>
	<span class="hljs-built_in">close</span>(KafkaJobChan)
	log.Println(<span class="hljs-string">"消息任务通道已关闭，不再接收新任务"</span>)

	<span class="hljs-comment">// 2. 向所有生产者协程发送退出信号</span>
	<span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; ConcurrentProducerNum; i++ {
		ProducerQuitChan &lt;- <span class="hljs-keyword">struct</span>{}{}
	}
	<span class="hljs-built_in">close</span>(ProducerQuitChan)
	log.Println(<span class="hljs-string">"已向所有生产者协程发送退出信号"</span>)

	<span class="hljs-comment">// 3. 等待所有协程退出（此处简化，实际可通过sync.WaitGroup实现精准等待）</span>
	time.Sleep(<span class="hljs-number">5</span> * time.Second)
	log.Println(<span class="hljs-string">"Kafka生产者优雅关闭完成，服务退出"</span>)
}
</code></pre>
<h3 data-id="heading-12">7. 测试主函数：模拟消息生产，验证并发效果</h3>
<p>最后，我们编写主函数，模拟高并发消息生产，验证整个方案的可行性：</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
	<span class="hljs-comment">// 1. 初始化Kafka生产者</span>
	err := InitKafkaProducers()
	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
		log.Fatalf(<span class="hljs-string">"初始化Kafka生产者失败：%v"</span>, err)
	}

	<span class="hljs-comment">// 2. 配置优雅关闭</span>
	<span class="hljs-keyword">go</span> SetupGracefulShutdown()

	<span class="hljs-comment">// 3. 模拟生产1000条测试消息，投递到任务通道</span>
	<span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> {
		<span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">1000</span>; i++ {
			job := KafkaSendJob{
				Ctx:  context.Background(),
				Msg:  []<span class="hljs-type">byte</span>(fmt.Sprintf(<span class="hljs-string">"高并发测试消息：%d"</span>, i)),
				Key:  fmt.Sprintf(<span class="hljs-string">"test_key_%d"</span>, i%<span class="hljs-number">10</span>), <span class="hljs-comment">// 均匀分布到10个分区</span>
			}
			<span class="hljs-comment">// 投递任务到通道（非阻塞，利用缓冲区削峰）</span>
			<span class="hljs-keyword">select</span> {
			<span class="hljs-keyword">case</span> KafkaJobChan &lt;- job:
			<span class="hljs-keyword">default</span>:
				log.Printf(<span class="hljs-string">"消息任务通道已满，丢弃第%d条消息"</span>, i)
			}
			<span class="hljs-comment">// 模拟消息生产间隔</span>
			time.Sleep(<span class="hljs-number">1</span> * time.Millisecond)
		}
		log.Println(<span class="hljs-string">"1000条测试消息已全部投递到任务通道"</span>)
	}()

	<span class="hljs-comment">// 4. 阻塞主线程，保持服务运行</span>
	<span class="hljs-keyword">select</span> {}
}
</code></pre>
<h2 data-id="heading-13">四、关键总结：并发安全的核心保障与最佳实践</h2>
<h3 data-id="heading-14">1. 并发安全的核心保障</h3>
<ol>
<li><strong><code>KafkaMsgSend</code> 方法天然安全</strong>：无内部共享状态，仅做参数传递和<code>sarama</code>方法调用，多个协程同时调用无干扰；</li>
<li><strong><code>sarama</code> 生产者协程安全</strong>：底层封装了锁机制和并发处理逻辑，支持多协程共享调用；</li>
<li><strong>「一个协程一个生产者」的设计</strong>：避免共享实例的竞争问题，即使客户端非协程安全，也能保证并发安全，同时提升发送效率；</li>
<li><strong>panic 捕获与优雅关闭</strong>：防止单个协程异常扩散，保证服务稳定性，避免消息丢失。</li>
</ol>
<h3 data-id="heading-15">2. 最佳实践</h3>
<ol>
<li><strong>合理配置并发数</strong>：<code>ConcurrentProducerNum</code> 不宜过大，需结合服务器 CPU、内存和 Kafka 集群处理能力调整，一般建议与 CPU 核心数相当；</li>
<li><strong>启用批量发送</strong>：通过<code>sarama</code>的批量配置，减少网络请求次数，大幅提升吞吐量；</li>
<li><strong>添加重试机制</strong>：针对网络抖动、Kafka 集群临时不可用等场景，重试机制能提升消息投递的可靠性；</li>
<li><strong>使用通道缓冲区</strong>：任务通道的缓冲区能有效削峰填谷，避免高并发场景下的协程阻塞；</li>
<li><strong>优雅关闭不可少</strong>：服务停止时，先关闭任务通道，再等待生产者协程处理完剩余消息，最后关闭生产者实例，防止消息丢失。</li>
</ol>
<h2 data-id="heading-16">五、扩展场景</h2>
<ol>
<li>若追求更高的吞吐量，可使用 <code>sarama.AsyncProducer</code>（异步生产者），进一步提升并发性能；</li>
<li>可接入 Prometheus 监控，统计消息发送成功率、延迟、积压量等指标，便于问题排查；</li>
<li>可添加消息持久化机制，对于发送失败的消息，落地到本地文件或数据库，后续进行重试补偿，实现消息零丢失。</li>
</ol>
<h2 data-id="heading-17">总结</h2>
<p>本文基于开源的<code>sarama</code>库，实现了高并发 Kafka 消息发送的方案，既保证了发送速度，又解决了并发安全的核心问题。「多生产者 + 多协程」的模型，充分发挥了 Go 语言协程的优势，能够满足大多数高吞吐业务场景的需求。同时，文中的最佳实践和扩展方案，也为生产环境的落地提供了参考，帮助开发者避开常见的坑，构建稳定、高效的 Kafka 消息发送服务。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[📁 Java IO流完全指南：从字节流到高级操作]]></title>    <link>https://juejin.cn/post/7595868336594731027</link>    <guid>https://juejin.cn/post/7595868336594731027</guid>    <pubDate>2026-01-17T03:44:19.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7595868336594731027" data-draft-id="7595800318519263238" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="📁 Java IO流完全指南：从字节流到高级操作"/> <meta itemprop="keywords" content="后端,面试"/> <meta itemprop="datePublished" content="2026-01-17T03:44:19.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="总会落叶"/> <meta itemprop="url" content="https://juejin.cn/user/766787307710060"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            📁 Java IO流完全指南：从字节流到高级操作
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/766787307710060/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    总会落叶
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-17T03:44:19.000Z" title="Sat Jan 17 2026 03:44:19 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-17
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    5
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读10分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">📁 Java IO流完全指南：从字节流到高级操作</h2>
<h3 data-id="heading-1">🎯 前言</h3>
<p>Java I/O流是处理输入输出的核心API，用于读写文件、网络通信等。掌握IO流是Java程序员的必备技能！让我们一起来系统学习吧~ 😊</p>
<h3 data-id="heading-2">📊 IO流体系总览</h3>
<pre><code class="hljs language-kotlin" lang="kotlin">Java IO流
├── 按数据类型分
│   ├── 字节流（<span class="hljs-built_in">Byte</span> Streams）
│   │   ├── InputStream（抽象类）
│   │   └── OutputStream（抽象类）
│   └── 字符流（Character Streams）
│       ├── Reader（抽象类）
│       └── Writer（抽象类）
├── 按功能分
│   ├── 节点流（直接操作数据源）
│   └── 处理流（包装节点流，增强功能）
└── 特殊流
    ├── 对象流（序列化）
    ├── 打印流
    ├── 转换流
    └── 压缩流
</code></pre>
<h3 data-id="heading-3">🔢 字节流（Byte Streams）</h3>
<h4 data-id="heading-4"><strong>FileOutputStream</strong> - 字节输出流 💾</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> java.io.FileOutputStream;
<span class="hljs-keyword">import</span> java.io.IOException;
​
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">FileOutputStreamDemo</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-comment">// 方法1：直接使用文件路径</span>
        <span class="hljs-type">FileOutputStream</span> <span class="hljs-variable">fos1</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;
        <span class="hljs-comment">// 方法2：使用File对象（更灵活）</span>
        <span class="hljs-comment">// FileOutputStream fos2 = new FileOutputStream(new File("test.txt"));</span>
        
        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// 1. 创建对象（会清空原文件内容）</span>
            fos1 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileOutputStream</span>(<span class="hljs-string">"test.txt"</span>);
            
            <span class="hljs-comment">// 2. 写入数据</span>
            fos1.write(<span class="hljs-number">97</span>);           <span class="hljs-comment">// 写入字节 'a'</span>
            fos1.write(<span class="hljs-string">"\r\n"</span>.getBytes());  <span class="hljs-comment">// 换行</span>
            fos1.write(<span class="hljs-string">"Hello Java!"</span>.getBytes());
            
            <span class="hljs-comment">// 3. 续写模式（不会清空原内容）</span>
            <span class="hljs-type">FileOutputStream</span> <span class="hljs-variable">fos2</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileOutputStream</span>(<span class="hljs-string">"test.txt"</span>, <span class="hljs-literal">true</span>);
            fos2.write(<span class="hljs-string">"\n追加内容"</span>.getBytes());
            fos2.close();
            
        } <span class="hljs-keyword">catch</span> (IOException e) {
            e.printStackTrace();
        } <span class="hljs-keyword">finally</span> {
            <span class="hljs-comment">// 4. 释放资源（必须执行）</span>
            <span class="hljs-keyword">try</span> {
                <span class="hljs-keyword">if</span> (fos1 != <span class="hljs-literal">null</span>) {
                    fos1.close();
                }
            } <span class="hljs-keyword">catch</span> (IOException e) {
                e.printStackTrace();
            }
        }
    }
}
</code></pre>
<h5 data-id="heading-5">💡 注意事项：</h5>
<ul>
<li>换行符：Windows用 <code>\r\n</code>，Linux/Mac用 <code>\n</code></li>
<li>路径不存在会自动创建，但父目录必须存在</li>
<li>使用 try-with-resources 更安全（Java 7+）</li>
</ul>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 推荐：使用try-with-resources自动关闭流</span>
<span class="hljs-keyword">try</span> (<span class="hljs-type">FileOutputStream</span> <span class="hljs-variable">fos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileOutputStream</span>(<span class="hljs-string">"test.txt"</span>)) {
    fos.write(<span class="hljs-string">"自动关闭流，安全！"</span>.getBytes());
} <span class="hljs-keyword">catch</span> (IOException e) {
    e.printStackTrace();
}
</code></pre>
<h4 data-id="heading-6"><strong>FileInputStream</strong> - 字节输入流 📖</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> java.io.FileInputStream;
<span class="hljs-keyword">import</span> java.io.IOException;
​
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">FileInputStreamDemo</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-comment">// 1. 单个字节读取（效率低）</span>
        <span class="hljs-keyword">try</span> (<span class="hljs-type">FileInputStream</span> <span class="hljs-variable">fis</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileInputStream</span>(<span class="hljs-string">"test.txt"</span>)) {
            <span class="hljs-type">int</span> b;
            <span class="hljs-keyword">while</span> ((b = fis.read()) != -<span class="hljs-number">1</span>) {
                System.out.print((<span class="hljs-type">char</span>) b);
            }
        } <span class="hljs-keyword">catch</span> (IOException e) {
            e.printStackTrace();
        }
        
        <span class="hljs-comment">// 2. 字节数组读取（高效推荐）</span>
        <span class="hljs-keyword">try</span> (<span class="hljs-type">FileInputStream</span> <span class="hljs-variable">fis</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileInputStream</span>(<span class="hljs-string">"test.txt"</span>)) {
            <span class="hljs-type">byte</span>[] buffer = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[<span class="hljs-number">1024</span>];  <span class="hljs-comment">// 1KB缓冲区</span>
            <span class="hljs-type">int</span> len;
            <span class="hljs-keyword">while</span> ((len = fis.read(buffer)) != -<span class="hljs-number">1</span>) {
                System.out.println(<span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>(buffer, <span class="hljs-number">0</span>, len));
            }
        } <span class="hljs-keyword">catch</span> (IOException e) {
            e.printStackTrace();
        }
        
        <span class="hljs-comment">// 3. 读取指定长度</span>
        <span class="hljs-keyword">try</span> (<span class="hljs-type">FileInputStream</span> <span class="hljs-variable">fis</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileInputStream</span>(<span class="hljs-string">"test.txt"</span>)) {
            <span class="hljs-type">byte</span>[] buffer = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[<span class="hljs-number">5</span>];
            <span class="hljs-type">int</span> <span class="hljs-variable">len</span> <span class="hljs-operator">=</span> fis.read(buffer, <span class="hljs-number">0</span>, <span class="hljs-number">5</span>);  <span class="hljs-comment">// 最多读5个字节</span>
            System.out.println(<span class="hljs-string">"读取了 "</span> + len + <span class="hljs-string">" 字节"</span>);
        } <span class="hljs-keyword">catch</span> (IOException e) {
            e.printStackTrace();
        }
    }
}
</code></pre>
<h3 data-id="heading-7">🔤 字符流（Character Streams）</h3>
<h4 data-id="heading-8"><strong>FileReader</strong> - 字符输入流 📚</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> java.io.FileReader;
<span class="hljs-keyword">import</span> java.io.IOException;
​
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">FileReaderDemo</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-comment">// 1. 单个字符读取</span>
        <span class="hljs-keyword">try</span> (<span class="hljs-type">FileReader</span> <span class="hljs-variable">fr</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileReader</span>(<span class="hljs-string">"test.txt"</span>)) {
            <span class="hljs-type">int</span> ch;
            <span class="hljs-keyword">while</span> ((ch = fr.read()) != -<span class="hljs-number">1</span>) {
                System.out.print((<span class="hljs-type">char</span>) ch);
            }
        } <span class="hljs-keyword">catch</span> (IOException e) {
            e.printStackTrace();
        }
        
        <span class="hljs-comment">// 2. 字符数组读取（推荐）</span>
        <span class="hljs-keyword">try</span> (<span class="hljs-type">FileReader</span> <span class="hljs-variable">fr</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileReader</span>(<span class="hljs-string">"test.txt"</span>)) {
            <span class="hljs-type">char</span>[] chars = <span class="hljs-keyword">new</span> <span class="hljs-title class_">char</span>[<span class="hljs-number">1024</span>];
            <span class="hljs-type">int</span> len;
            <span class="hljs-keyword">while</span> ((len = fr.read(chars)) != -<span class="hljs-number">1</span>) {
                System.out.print(<span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>(chars, <span class="hljs-number">0</span>, len));
            }
        } <span class="hljs-keyword">catch</span> (IOException e) {
            e.printStackTrace();
        }
        
        <span class="hljs-comment">// 3. 读取到指定数组位置</span>
        <span class="hljs-keyword">try</span> (<span class="hljs-type">FileReader</span> <span class="hljs-variable">fr</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileReader</span>(<span class="hljs-string">"test.txt"</span>)) {
            <span class="hljs-type">char</span>[] chars = <span class="hljs-keyword">new</span> <span class="hljs-title class_">char</span>[<span class="hljs-number">10</span>];
            <span class="hljs-type">int</span> <span class="hljs-variable">len</span> <span class="hljs-operator">=</span> fr.read(chars, <span class="hljs-number">2</span>, <span class="hljs-number">5</span>);  <span class="hljs-comment">// 从数组索引2开始存，最多读5个</span>
            System.out.println(<span class="hljs-string">"实际读取字符数："</span> + len);
        } <span class="hljs-keyword">catch</span> (IOException e) {
            e.printStackTrace();
        }
    }
}
</code></pre>
<h4 data-id="heading-9"><strong>FileWriter</strong> - 字符输出流 📝</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> java.io.FileWriter;
<span class="hljs-keyword">import</span> java.io.IOException;
​
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">FileWriterDemo</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-comment">// 1. 基本写入</span>
        <span class="hljs-keyword">try</span> (<span class="hljs-type">FileWriter</span> <span class="hljs-variable">fw</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileWriter</span>(<span class="hljs-string">"output.txt"</span>)) {
            fw.write(<span class="hljs-string">"Hello World!\n"</span>);
            fw.write(<span class="hljs-number">65</span>);  <span class="hljs-comment">// 写入字符 'A'</span>
            fw.write(<span class="hljs-keyword">new</span> <span class="hljs-title class_">char</span>[]{<span class="hljs-string">'B'</span>, <span class="hljs-string">'C'</span>, <span class="hljs-string">'D'</span>});
            fw.write(<span class="hljs-string">"Java编程"</span>, <span class="hljs-number">0</span>, <span class="hljs-number">4</span>);  <span class="hljs-comment">// 写入"Java"</span>
        } <span class="hljs-keyword">catch</span> (IOException e) {
            e.printStackTrace();
        }
        
        <span class="hljs-comment">// 2. 追加模式</span>
        <span class="hljs-keyword">try</span> (<span class="hljs-type">FileWriter</span> <span class="hljs-variable">fw</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileWriter</span>(<span class="hljs-string">"output.txt"</span>, <span class="hljs-literal">true</span>)) {
            fw.write(<span class="hljs-string">"\n这是追加的内容"</span>);
            fw.flush();  <span class="hljs-comment">// 刷新缓冲区，立即写入</span>
        } <span class="hljs-keyword">catch</span> (IOException e) {
            e.printStackTrace();
        }
        
        <span class="hljs-comment">// 3. 写入字符数组的一部分</span>
        <span class="hljs-keyword">try</span> (<span class="hljs-type">FileWriter</span> <span class="hljs-variable">fw</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileWriter</span>(<span class="hljs-string">"output.txt"</span>)) {
            <span class="hljs-type">char</span>[] data = {<span class="hljs-string">'J'</span>, <span class="hljs-string">'a'</span>, <span class="hljs-string">'v'</span>, <span class="hljs-string">'a'</span>, <span class="hljs-string">'编'</span>, <span class="hljs-string">'程'</span>};
            fw.write(data, <span class="hljs-number">0</span>, <span class="hljs-number">4</span>);  <span class="hljs-comment">// 只写入"Java"</span>
        } <span class="hljs-keyword">catch</span> (IOException e) {
            e.printStackTrace();
        }
    }
}
</code></pre>
<h3 data-id="heading-10">🔄 编码与解码详解</h3>
<h4 data-id="heading-11"><strong>编码过程</strong> 🔡→🔢</h4>
<pre><code class="hljs language-csharp" lang="csharp">import java.util.Arrays;
​
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">EncodingDemo</span> {
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span>(<span class="hljs-params">String[] args</span>) throws Exception</span> {
        String str = <span class="hljs-string">"ai你哟❤"</span>;
        
        System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"=== 不同编码方式比较 ==="</span>);
        
        <span class="hljs-comment">// 1. 平台默认编码（通常是UTF-8）</span>
        <span class="hljs-built_in">byte</span>[] defaultBytes = str.getBytes();
        System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"默认编码（"</span> + System.getProperty(<span class="hljs-string">"file.encoding"</span>) + <span class="hljs-string">"）："</span>);
        System.<span class="hljs-keyword">out</span>.println(Arrays.toString(defaultBytes));
        System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"字节数："</span> + defaultBytes.length);
        
        <span class="hljs-comment">// 2. UTF-8编码（变长，中文3-4字节）</span>
        <span class="hljs-built_in">byte</span>[] utf8Bytes = str.getBytes(<span class="hljs-string">"UTF-8"</span>);
        System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"\nUTF-8编码："</span>);
        System.<span class="hljs-keyword">out</span>.println(Arrays.toString(utf8Bytes));
        System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"字节数："</span> + utf8Bytes.length);
        
        <span class="hljs-comment">// 3. GBK编码（中文2字节）</span>
        <span class="hljs-built_in">byte</span>[] gbkBytes = str.getBytes(<span class="hljs-string">"GBK"</span>);
        System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"\nGBK编码："</span>);
        System.<span class="hljs-keyword">out</span>.println(Arrays.toString(gbkBytes));
        System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"字节数："</span> + gbkBytes.length);
        
        <span class="hljs-comment">// 4. ISO-8859-1（不支持中文，会丢失信息）</span>
        <span class="hljs-built_in">byte</span>[] isoBytes = str.getBytes(<span class="hljs-string">"ISO-8859-1"</span>);
        System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"\nISO-8859-1编码（不支持中文）："</span>);
        System.<span class="hljs-keyword">out</span>.println(Arrays.toString(isoBytes));
        System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"解码后："</span> + <span class="hljs-keyword">new</span> String(isoBytes, <span class="hljs-string">"ISO-8859-1"</span>));
    }
}
</code></pre>
<h4 data-id="heading-12"><strong>解码过程</strong> 🔢→🔡</h4>
<pre><code class="hljs language-ini" lang="ini">public class DecodingDemo {
    public static void main(String<span class="hljs-section">[]</span> args) throws Exception {
        String <span class="hljs-attr">original</span> = <span class="hljs-string">"你好Java🎉"</span><span class="hljs-comment">;</span>
        
        // 1. 正确解码（编码解码一致）
        byte<span class="hljs-section">[]</span> <span class="hljs-attr">utf8Bytes</span> = original.getBytes(<span class="hljs-string">"UTF-8"</span>)<span class="hljs-comment">;</span>
        String <span class="hljs-attr">correct</span> = new String(utf8Bytes, <span class="hljs-string">"UTF-8"</span>)<span class="hljs-comment">;</span>
        System.out.println("正确解码：" + correct)<span class="hljs-comment">;</span>
        
        // 2. 错误解码（编码解码不一致）
        byte<span class="hljs-section">[]</span> <span class="hljs-attr">gbkBytes</span> = original.getBytes(<span class="hljs-string">"GBK"</span>)<span class="hljs-comment">;</span>
        String <span class="hljs-attr">wrong1</span> = new String(gbkBytes, <span class="hljs-string">"UTF-8"</span>)<span class="hljs-comment">;</span>
        System.out.println("错误解码（GBK→UTF-8）：" + wrong1)<span class="hljs-comment">;</span>
        
        // 3. 恢复乱码
        byte<span class="hljs-section">[]</span> <span class="hljs-attr">wrongBytes</span> = wrong1.getBytes(<span class="hljs-string">"UTF-8"</span>)<span class="hljs-comment">;</span>
        String <span class="hljs-attr">recovered</span> = new String(wrongBytes, <span class="hljs-string">"GBK"</span>)<span class="hljs-comment">;</span>
        System.out.println("恢复后：" + recovered)<span class="hljs-comment">;</span>
    }
}
</code></pre>
<h3 data-id="heading-13">⚡ 缓冲流（高效流）</h3>
<h4 data-id="heading-14"><strong>字节缓冲流</strong> 🚀</h4>
<pre><code class="hljs language-ini" lang="ini">import java.io.*<span class="hljs-comment">;</span>

public class BufferedStreamDemo {
    public static void main(String<span class="hljs-section">[]</span> args) {
        String <span class="hljs-attr">srcFile</span> = <span class="hljs-string">"largefile.mp4"</span><span class="hljs-comment">;</span>
        String <span class="hljs-attr">destFile</span> = <span class="hljs-string">"copy.mp4"</span><span class="hljs-comment">;</span>
        
        // 1. 基本拷贝（单个字节，慢！）
        long <span class="hljs-attr">start1</span> = System.currentTimeMillis()<span class="hljs-comment">;</span>
        try (FileInputStream <span class="hljs-attr">fis</span> = new FileInputStream(srcFile)<span class="hljs-comment">;</span>
             FileOutputStream <span class="hljs-attr">fos</span> = new FileOutputStream(<span class="hljs-string">"copy1.mp4"</span>)) {
            int b<span class="hljs-comment">;</span>
            while ((<span class="hljs-attr">b</span> = fis.read()) != -<span class="hljs-number">1</span>) {
                fos.write(b)<span class="hljs-comment">;</span>
            }
        } catch (IOException e) {
            e.printStackTrace()<span class="hljs-comment">;</span>
        }
        long <span class="hljs-attr">end1</span> = System.currentTimeMillis()<span class="hljs-comment">;</span>
        System.out.println("基本拷贝耗时：" + (end1 - start1) + "ms")<span class="hljs-comment">;</span>
        
        // 2. 缓冲流拷贝（高效）
        long <span class="hljs-attr">start2</span> = System.currentTimeMillis()<span class="hljs-comment">;</span>
        try (BufferedInputStream <span class="hljs-attr">bis</span> = new BufferedInputStream(
                new FileInputStream(srcFile))<span class="hljs-comment">;</span>
             BufferedOutputStream <span class="hljs-attr">bos</span> = new BufferedOutputStream(
                new FileOutputStream("copy2.mp4"))) {
            int b<span class="hljs-comment">;</span>
            while ((<span class="hljs-attr">b</span> = bis.read()) != -<span class="hljs-number">1</span>) {
                bos.write(b)<span class="hljs-comment">;</span>
            }
        } catch (IOException e) {
            e.printStackTrace()<span class="hljs-comment">;</span>
        }
        long <span class="hljs-attr">end2</span> = System.currentTimeMillis()<span class="hljs-comment">;</span>
        System.out.println("缓冲流拷贝耗时：" + (end2 - start2) + "ms")<span class="hljs-comment">;</span>
        
        // 3. 缓冲流+数组（最快）
        long <span class="hljs-attr">start3</span> = System.currentTimeMillis()<span class="hljs-comment">;</span>
        try (BufferedInputStream <span class="hljs-attr">bis</span> = new BufferedInputStream(
                new FileInputStream(srcFile))<span class="hljs-comment">;</span>
             BufferedOutputStream <span class="hljs-attr">bos</span> = new BufferedOutputStream(
                new FileOutputStream("copy3.mp4"))) {
            byte<span class="hljs-section">[]</span> <span class="hljs-attr">buffer</span> = new byte[<span class="hljs-number">8192</span>]<span class="hljs-comment">;  // 8KB缓冲区</span>
            int len<span class="hljs-comment">;</span>
            while ((<span class="hljs-attr">len</span> = bis.read(buffer)) != -<span class="hljs-number">1</span>) {
                bos.write(buffer, 0, len)<span class="hljs-comment">;</span>
            }
        } catch (IOException e) {
            e.printStackTrace()<span class="hljs-comment">;</span>
        }
        long <span class="hljs-attr">end3</span> = System.currentTimeMillis()<span class="hljs-comment">;</span>
        System.out.println("缓冲流+数组拷贝耗时：" + (end3 - start3) + "ms")<span class="hljs-comment">;</span>
    }
}
</code></pre>
<h4 data-id="heading-15"><strong>字符缓冲流</strong> 📚</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> java.io.*;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BufferedReaderWriterDemo</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-comment">// 1. BufferedReader - 按行读取</span>
        <span class="hljs-keyword">try</span> (<span class="hljs-type">BufferedReader</span> <span class="hljs-variable">br</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BufferedReader</span>(
                <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileReader</span>(<span class="hljs-string">"test.txt"</span>))) {
            String line;
            <span class="hljs-type">int</span> <span class="hljs-variable">lineNumber</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span>;
            <span class="hljs-keyword">while</span> ((line = br.readLine()) != <span class="hljs-literal">null</span>) {
                System.out.println(lineNumber++ + <span class="hljs-string">": "</span> + line);
            }
        } <span class="hljs-keyword">catch</span> (IOException e) {
            e.printStackTrace();
        }
        
        <span class="hljs-comment">// 2. BufferedWriter - 高效写入</span>
        <span class="hljs-keyword">try</span> (<span class="hljs-type">BufferedWriter</span> <span class="hljs-variable">bw</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BufferedWriter</span>(
                <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileWriter</span>(<span class="hljs-string">"output.txt"</span>))) {
            bw.write(<span class="hljs-string">"第一行"</span>);
            bw.newLine();  <span class="hljs-comment">// 跨平台换行</span>
            bw.write(<span class="hljs-string">"第二行"</span>);
            bw.flush();  <span class="hljs-comment">// 立即写入</span>
            
            <span class="hljs-comment">// 批量写入</span>
            String[] lines = {<span class="hljs-string">"第三行"</span>, <span class="hljs-string">"第四行"</span>, <span class="hljs-string">"第五行"</span>};
            <span class="hljs-keyword">for</span> (String l : lines) {
                bw.write(l);
                bw.newLine();
            }
        } <span class="hljs-keyword">catch</span> (IOException e) {
            e.printStackTrace();
        }
        
        <span class="hljs-comment">// 3. 标准输入读取</span>
        <span class="hljs-keyword">try</span> (<span class="hljs-type">BufferedReader</span> <span class="hljs-variable">consoleReader</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BufferedReader</span>(
                <span class="hljs-keyword">new</span> <span class="hljs-title class_">InputStreamReader</span>(System.in))) {
            System.out.print(<span class="hljs-string">"请输入："</span>);
            <span class="hljs-type">String</span> <span class="hljs-variable">input</span> <span class="hljs-operator">=</span> consoleReader.readLine();
            System.out.println(<span class="hljs-string">"您输入的是："</span> + input);
        } <span class="hljs-keyword">catch</span> (IOException e) {
            e.printStackTrace();
        }
    }
}
</code></pre>
<h3 data-id="heading-16">🔀 转换流（InputStreamReader/OutputStreamWriter）</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> java.io.*;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ConvertStreamDemo</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception {
        <span class="hljs-comment">// 1. 读取GBK编码文件，转换为UTF-8</span>
        <span class="hljs-keyword">try</span> (<span class="hljs-type">InputStreamReader</span> <span class="hljs-variable">isr</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InputStreamReader</span>(
                <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileInputStream</span>(<span class="hljs-string">"gbkfile.txt"</span>), <span class="hljs-string">"GBK"</span>);
             <span class="hljs-type">OutputStreamWriter</span> <span class="hljs-variable">osw</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">OutputStreamWriter</span>(
                <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileOutputStream</span>(<span class="hljs-string">"utf8file.txt"</span>), <span class="hljs-string">"UTF-8"</span>)) {
            
            <span class="hljs-type">char</span>[] buffer = <span class="hljs-keyword">new</span> <span class="hljs-title class_">char</span>[<span class="hljs-number">1024</span>];
            <span class="hljs-type">int</span> len;
            <span class="hljs-keyword">while</span> ((len = isr.read(buffer)) != -<span class="hljs-number">1</span>) {
                osw.write(buffer, <span class="hljs-number">0</span>, len);
            }
        }
        
        <span class="hljs-comment">// 2. 控制台指定编码读取</span>
        System.out.println(<span class="hljs-string">"请输入中文："</span>);
        <span class="hljs-keyword">try</span> (<span class="hljs-type">BufferedReader</span> <span class="hljs-variable">br</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BufferedReader</span>(
                <span class="hljs-keyword">new</span> <span class="hljs-title class_">InputStreamReader</span>(System.in, <span class="hljs-string">"GBK"</span>))) {
            <span class="hljs-type">String</span> <span class="hljs-variable">input</span> <span class="hljs-operator">=</span> br.readLine();
            System.out.println(<span class="hljs-string">"您输入的是："</span> + input);
            
            <span class="hljs-comment">// 以UTF-8保存</span>
            <span class="hljs-keyword">try</span> (<span class="hljs-type">OutputStreamWriter</span> <span class="hljs-variable">osw</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">OutputStreamWriter</span>(
                    <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileOutputStream</span>(<span class="hljs-string">"input.txt"</span>), <span class="hljs-string">"UTF-8"</span>)) {
                osw.write(input);
            }
        }
        
        <span class="hljs-comment">// 3. 文件编码检测和转换</span>
        convertFileEncoding(<span class="hljs-string">"source.txt"</span>, <span class="hljs-string">"GBK"</span>, <span class="hljs-string">"target.txt"</span>, <span class="hljs-string">"UTF-8"</span>);
    }
    
    <span class="hljs-comment">// 通用编码转换方法</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">convertFileEncoding</span><span class="hljs-params">(String srcFile, String srcCharset,
                                          String destFile, String destCharset)</span> 
                                          <span class="hljs-keyword">throws</span> IOException {
        <span class="hljs-keyword">try</span> (<span class="hljs-type">InputStreamReader</span> <span class="hljs-variable">isr</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InputStreamReader</span>(
                <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileInputStream</span>(srcFile), srcCharset);
             <span class="hljs-type">OutputStreamWriter</span> <span class="hljs-variable">osw</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">OutputStreamWriter</span>(
                <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileOutputStream</span>(destFile), destCharset)) {
            
            <span class="hljs-type">char</span>[] buffer = <span class="hljs-keyword">new</span> <span class="hljs-title class_">char</span>[<span class="hljs-number">4096</span>];
            <span class="hljs-type">int</span> len;
            <span class="hljs-keyword">while</span> ((len = isr.read(buffer)) != -<span class="hljs-number">1</span>) {
                osw.write(buffer, <span class="hljs-number">0</span>, len);
            }
        }
    }
}
</code></pre>
<h3 data-id="heading-17">💾 序列化流（ObjectInputStream/ObjectOutputStream）</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> java.io.*;
<span class="hljs-keyword">import</span> java.util.Date;

<span class="hljs-comment">// 必须实现Serializable接口</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">User</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Serializable</span> {
    <span class="hljs-comment">// 序列化版本ID，防止类修改后反序列化失败</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">long</span> <span class="hljs-variable">serialVersionUID</span> <span class="hljs-operator">=</span> <span class="hljs-number">1L</span>;
    
    <span class="hljs-keyword">private</span> String name;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">transient</span> String password;  <span class="hljs-comment">// transient修饰的字段不序列化</span>
    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> age;
    <span class="hljs-keyword">private</span> Date birthday;
    
    <span class="hljs-comment">// 构造方法、getter/setter省略...</span>
    
    <span class="hljs-comment">// 自定义序列化过程（可选）</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">writeObject</span><span class="hljs-params">(ObjectOutputStream oos)</span> <span class="hljs-keyword">throws</span> IOException {
        oos.defaultWriteObject();  <span class="hljs-comment">// 默认序列化</span>
        <span class="hljs-comment">// 自定义序列化逻辑</span>
    }
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">readObject</span><span class="hljs-params">(ObjectInputStream ois)</span> 
            <span class="hljs-keyword">throws</span> IOException, ClassNotFoundException {
        ois.defaultReadObject();  <span class="hljs-comment">// 默认反序列化</span>
        <span class="hljs-comment">// 自定义反序列化逻辑</span>
    }
}

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SerializationDemo</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-type">User</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">User</span>(<span class="hljs-string">"张三"</span>, <span class="hljs-string">"123456"</span>, <span class="hljs-number">25</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>());
        
        <span class="hljs-comment">// 1. 序列化（对象→字节）</span>
        <span class="hljs-keyword">try</span> (<span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">oos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(
                <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileOutputStream</span>(<span class="hljs-string">"user.dat"</span>))) {
            oos.writeObject(user);
            oos.writeInt(<span class="hljs-number">100</span>);  <span class="hljs-comment">// 可以写入基本类型</span>
            oos.writeObject(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>());
        } <span class="hljs-keyword">catch</span> (IOException e) {
            e.printStackTrace();
        }
        
        <span class="hljs-comment">// 2. 反序列化（字节→对象）</span>
        <span class="hljs-keyword">try</span> (<span class="hljs-type">ObjectInputStream</span> <span class="hljs-variable">ois</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectInputStream</span>(
                <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileInputStream</span>(<span class="hljs-string">"user.dat"</span>))) {
            <span class="hljs-type">User</span> <span class="hljs-variable">readUser</span> <span class="hljs-operator">=</span> (User) ois.readObject();
            <span class="hljs-type">int</span> <span class="hljs-variable">num</span> <span class="hljs-operator">=</span> ois.readInt();
            <span class="hljs-type">Date</span> <span class="hljs-variable">date</span> <span class="hljs-operator">=</span> (Date) ois.readObject();
            
            System.out.println(<span class="hljs-string">"用户名："</span> + readUser.getName());
            System.out.println(<span class="hljs-string">"密码："</span> + readUser.getPassword());  <span class="hljs-comment">// null</span>
        } <span class="hljs-keyword">catch</span> (IOException | ClassNotFoundException e) {
            e.printStackTrace();
        }
        
        <span class="hljs-comment">// 3. 序列化集合</span>
        <span class="hljs-keyword">try</span> (<span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">oos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(
                <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileOutputStream</span>(<span class="hljs-string">"list.dat"</span>))) {
            java.util.List&lt;User&gt; users = <span class="hljs-keyword">new</span> <span class="hljs-title class_">java</span>.util.ArrayList&lt;&gt;();
            users.add(<span class="hljs-keyword">new</span> <span class="hljs-title class_">User</span>(<span class="hljs-string">"李四"</span>, <span class="hljs-string">"111"</span>, <span class="hljs-number">30</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>()));
            users.add(<span class="hljs-keyword">new</span> <span class="hljs-title class_">User</span>(<span class="hljs-string">"王五"</span>, <span class="hljs-string">"222"</span>, <span class="hljs-number">28</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>()));
            oos.writeObject(users);
        } <span class="hljs-keyword">catch</span> (IOException e) {
            e.printStackTrace();
        }
    }
}
</code></pre>
<h3 data-id="heading-18">🖨️ 打印流（PrintStream/PrintWriter）</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> java.io.*;
<span class="hljs-keyword">import</span> java.util.Date;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PrintStreamDemo</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception {
        <span class="hljs-comment">// 1. PrintStream（字节打印流）</span>
        <span class="hljs-keyword">try</span> (<span class="hljs-type">PrintStream</span> <span class="hljs-variable">ps</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">PrintStream</span>(<span class="hljs-string">"print.txt"</span>)) {
            ps.println(<span class="hljs-string">"Hello PrintStream!"</span>);
            ps.printf(<span class="hljs-string">"当前时间：%tF %tT%n"</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>(), <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>());
            ps.print(<span class="hljs-string">"不换行"</span>);
            ps.println(<span class="hljs-string">"接着写"</span>);
            
            <span class="hljs-comment">// 不会抛出异常，用checkError()检查</span>
            ps.write(<span class="hljs-number">65</span>);  <span class="hljs-comment">// 'A'</span>
            <span class="hljs-keyword">if</span> (ps.checkError()) {
                System.err.println(<span class="hljs-string">"写入出错！"</span>);
            }
        }
        
        <span class="hljs-comment">// 2. PrintWriter（字符打印流，更常用）</span>
        <span class="hljs-keyword">try</span> (<span class="hljs-type">PrintWriter</span> <span class="hljs-variable">pw</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">PrintWriter</span>(
                <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileWriter</span>(<span class="hljs-string">"print2.txt"</span>), <span class="hljs-literal">true</span>)) {  <span class="hljs-comment">// true表示自动刷新</span>
            
            pw.println(<span class="hljs-string">"=== 学生信息 ==="</span>);
            pw.printf(<span class="hljs-string">"姓名：%-10s 年龄：%d%n"</span>, <span class="hljs-string">"张三"</span>, <span class="hljs-number">20</span>);
            pw.printf(<span class="hljs-string">"分数：%.2f%n"</span>, <span class="hljs-number">95.5</span>);
            pw.println(<span class="hljs-string">"=============="</span>);
            
            <span class="hljs-comment">// 支持链式调用</span>
            pw.append(<span class="hljs-string">"追加内容"</span>)
              .append(<span class="hljs-string">"\n"</span>)
              .append(<span class="hljs-string">"另一行"</span>);
        }
        
        <span class="hljs-comment">// 3. 重定向System.out</span>
        <span class="hljs-keyword">try</span> (<span class="hljs-type">PrintStream</span> <span class="hljs-variable">fileOut</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">PrintStream</span>(<span class="hljs-string">"system_out.txt"</span>)) {
            <span class="hljs-type">PrintStream</span> <span class="hljs-variable">originalOut</span> <span class="hljs-operator">=</span> System.out;
            System.setOut(fileOut);  <span class="hljs-comment">// 重定向</span>
            
            System.out.println(<span class="hljs-string">"这行会写到文件里"</span>);
            System.out.println(<span class="hljs-string">"控制台看不到我"</span>);
            
            System.setOut(originalOut);  <span class="hljs-comment">// 恢复</span>
            System.out.println(<span class="hljs-string">"回到控制台"</span>);
        }
        
        <span class="hljs-comment">// 4. 格式化输出</span>
        <span class="hljs-keyword">try</span> (<span class="hljs-type">PrintWriter</span> <span class="hljs-variable">pw</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">PrintWriter</span>(<span class="hljs-string">"format.txt"</span>)) {
            pw.printf(<span class="hljs-string">"商品\t单价\t数量\t小计%n"</span>);
            pw.printf(<span class="hljs-string">"%-10s\t%8.2f\t%4d\t%8.2f%n"</span>, 
                     <span class="hljs-string">"Java书"</span>, <span class="hljs-number">89.50</span>, <span class="hljs-number">2</span>, <span class="hljs-number">179.00</span>);
            pw.printf(<span class="hljs-string">"%-10s\t%8.2f\t%4d\t%8.2f%n"</span>,
                     <span class="hljs-string">"鼠标"</span>, <span class="hljs-number">150.00</span>, <span class="hljs-number">1</span>, <span class="hljs-number">150.00</span>);
            pw.printf(<span class="hljs-string">"%-10s\t%8s\t%4s\t%8.2f%n"</span>,
                     <span class="hljs-string">""</span>, <span class="hljs-string">""</span>, <span class="hljs-string">"合计"</span>, <span class="hljs-number">329.00</span>);
        }
    }
}
</code></pre>
<h3 data-id="heading-19">📦 压缩与解压缩流</h3>
<pre><code class="hljs language-ini" lang="ini">import java.io.*<span class="hljs-comment">;</span>
import java.util.zip.*<span class="hljs-comment">;</span>
import java.util.Enumeration<span class="hljs-comment">;</span>

public class ZipDemo {
    public static void main(String<span class="hljs-section">[]</span> args) {
        // 1. 单个文件压缩
        try (FileInputStream <span class="hljs-attr">fis</span> = new FileInputStream(<span class="hljs-string">"test.txt"</span>)<span class="hljs-comment">;</span>
             FileOutputStream <span class="hljs-attr">fos</span> = new FileOutputStream(<span class="hljs-string">"test.zip"</span>)<span class="hljs-comment">;</span>
             ZipOutputStream <span class="hljs-attr">zos</span> = new ZipOutputStream(fos)) {
            
            ZipEntry <span class="hljs-attr">entry</span> = new ZipEntry(<span class="hljs-string">"test.txt"</span>)<span class="hljs-comment">;</span>
            zos.putNextEntry(entry)<span class="hljs-comment">;</span>
            
            byte<span class="hljs-section">[]</span> <span class="hljs-attr">buffer</span> = new byte[<span class="hljs-number">1024</span>]<span class="hljs-comment">;</span>
            int len<span class="hljs-comment">;</span>
            while ((<span class="hljs-attr">len</span> = fis.read(buffer)) != -<span class="hljs-number">1</span>) {
                zos.write(buffer, 0, len)<span class="hljs-comment">;</span>
            }
            zos.closeEntry()<span class="hljs-comment">;</span>
        } catch (IOException e) {
            e.printStackTrace()<span class="hljs-comment">;</span>
        }
        
        // 2. 多个文件压缩
        String<span class="hljs-section">[]</span> <span class="hljs-attr">files</span> = {<span class="hljs-string">"file1.txt"</span>, <span class="hljs-string">"file2.txt"</span>, <span class="hljs-string">"file3.txt"</span>}<span class="hljs-comment">;</span>
        try (ZipOutputStream <span class="hljs-attr">zos</span> = new ZipOutputStream(
                new FileOutputStream("multi.zip"))) {
            
            for (String file : files) {
                try (FileInputStream <span class="hljs-attr">fis</span> = new FileInputStream(file)) {
                    ZipEntry <span class="hljs-attr">entry</span> = new ZipEntry(file)<span class="hljs-comment">;</span>
                    zos.putNextEntry(entry)<span class="hljs-comment">;</span>
                    
                    byte<span class="hljs-section">[]</span> <span class="hljs-attr">buffer</span> = new byte[<span class="hljs-number">1024</span>]<span class="hljs-comment">;</span>
                    int len<span class="hljs-comment">;</span>
                    while ((<span class="hljs-attr">len</span> = fis.read(buffer)) != -<span class="hljs-number">1</span>) {
                        zos.write(buffer, 0, len)<span class="hljs-comment">;</span>
                    }
                    zos.closeEntry()<span class="hljs-comment">;</span>
                }
            }
        } catch (IOException e) {
            e.printStackTrace()<span class="hljs-comment">;</span>
        }
        
        // 3. 解压缩
        try (ZipInputStream <span class="hljs-attr">zis</span> = new ZipInputStream(
                new FileInputStream("multi.zip"))) {
            
            ZipEntry entry<span class="hljs-comment">;</span>
            while ((<span class="hljs-attr">entry</span> = zis.getNextEntry()) != null) {
                System.out.println("解压: " + entry.getName())<span class="hljs-comment">;</span>
                
                // 创建目录结构
                File <span class="hljs-attr">file</span> = new File(<span class="hljs-string">"extracted/"</span> + entry.getName())<span class="hljs-comment">;</span>
                if (entry.isDirectory()) {
                    file.mkdirs()<span class="hljs-comment">;</span>
                } else {
                    file.getParentFile().mkdirs()<span class="hljs-comment">;</span>
                    
                    try (FileOutputStream <span class="hljs-attr">fos</span> = new FileOutputStream(file)) {
                        byte<span class="hljs-section">[]</span> <span class="hljs-attr">buffer</span> = new byte[<span class="hljs-number">1024</span>]<span class="hljs-comment">;</span>
                        int len<span class="hljs-comment">;</span>
                        while ((<span class="hljs-attr">len</span> = zis.read(buffer)) != -<span class="hljs-number">1</span>) {
                            fos.write(buffer, 0, len)<span class="hljs-comment">;</span>
                        }
                    }
                }
                zis.closeEntry()<span class="hljs-comment">;</span>
            }
        } catch (IOException e) {
            e.printStackTrace()<span class="hljs-comment">;</span>
        }
        
        // 4. 使用ZipFile类（更方便）
        try (ZipFile <span class="hljs-attr">zipFile</span> = new ZipFile(<span class="hljs-string">"multi.zip"</span>)) {
            Enumeration&lt;? extends ZipEntry&gt; <span class="hljs-attr">entries</span> = zipFile.entries()<span class="hljs-comment">;</span>
            
            while (entries.hasMoreElements()) {
                ZipEntry <span class="hljs-attr">entry</span> = entries.nextElement()<span class="hljs-comment">;</span>
                System.out.println("文件: " + entry.getName() + 
                                 " 大小: " + entry.getSize())<span class="hljs-comment">;</span>
                
                if (!entry.isDirectory()) {
                    try (InputStream <span class="hljs-attr">is</span> = zipFile.getInputStream(entry)) {
                        // 处理文件内容
                    }
                }
            }
        } catch (IOException e) {
            e.printStackTrace()<span class="hljs-comment">;</span>
        }
    }
}
</code></pre>
<h3 data-id="heading-20">🔧 Apache Commons IO 工具库</h3>
<h4 data-id="heading-21"><strong>添加依赖</strong> 📦</h4>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- Maven --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>commons-io<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>commons-io<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>2.13.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
</code></pre>
<h4 data-id="heading-22"><strong>常用工具类</strong> 🛠️</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> org.apache.commons.io.FileUtils;
<span class="hljs-keyword">import</span> org.apache.commons.io.IOUtils;
<span class="hljs-keyword">import</span> org.apache.commons.io.FilenameUtils;
<span class="hljs-keyword">import</span> org.apache.commons.io.FileExistsUtils;
​
<span class="hljs-keyword">import</span> java.io.*;
<span class="hljs-keyword">import</span> java.nio.charset.StandardCharsets;
<span class="hljs-keyword">import</span> java.util.List;
​
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CommonsIODemo</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception {
        <span class="hljs-comment">// 1. FileUtils - 文件操作神器</span>
        <span class="hljs-type">File</span> <span class="hljs-variable">src</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(<span class="hljs-string">"source.txt"</span>);
        <span class="hljs-type">File</span> <span class="hljs-variable">dest</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(<span class="hljs-string">"backup.txt"</span>);
        
        <span class="hljs-comment">// 复制文件</span>
        FileUtils.copyFile(src, dest);
        FileUtils.copyFile(src, dest, <span class="hljs-literal">true</span>);  <span class="hljs-comment">// 强制覆盖</span>
        
        <span class="hljs-comment">// 复制目录</span>
        FileUtils.copyDirectory(<span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(<span class="hljs-string">"srcDir"</span>), <span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(<span class="hljs-string">"destDir"</span>));
        
        <span class="hljs-comment">// 读取文件内容</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">content</span> <span class="hljs-operator">=</span> FileUtils.readFileToString(src, <span class="hljs-string">"UTF-8"</span>);
        List&lt;String&gt; lines = FileUtils.readLines(src, <span class="hljs-string">"UTF-8"</span>);
        
        <span class="hljs-comment">// 写入文件</span>
        FileUtils.writeStringToFile(dest, <span class="hljs-string">"Hello Commons IO"</span>, <span class="hljs-string">"UTF-8"</span>);
        FileUtils.writeLines(dest, <span class="hljs-string">"UTF-8"</span>, lines, <span class="hljs-literal">true</span>);  <span class="hljs-comment">// true表示追加</span>
        
        <span class="hljs-comment">// 删除目录（包括子目录）</span>
        FileUtils.deleteDirectory(<span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(<span class="hljs-string">"tempDir"</span>));
        FileUtils.forceDelete(<span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(<span class="hljs-string">"file.txt"</span>));  <span class="hljs-comment">// 强制删除</span>
        
        <span class="hljs-comment">// 清空目录</span>
        FileUtils.cleanDirectory(<span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(<span class="hljs-string">"cache"</span>));
        
        <span class="hljs-comment">// 2. IOUtils - 流操作简化</span>
        <span class="hljs-keyword">try</span> (<span class="hljs-type">InputStream</span> <span class="hljs-variable">is</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileInputStream</span>(<span class="hljs-string">"input.txt"</span>);
             <span class="hljs-type">OutputStream</span> <span class="hljs-variable">os</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileOutputStream</span>(<span class="hljs-string">"output.txt"</span>)) {
            
            <span class="hljs-comment">// 复制流（自动处理缓冲和关闭）</span>
            IOUtils.copy(is, os);
            
            <span class="hljs-comment">// 读取全部字节</span>
            <span class="hljs-type">byte</span>[] bytes = IOUtils.toByteArray(is);
            
            <span class="hljs-comment">// 读取为字符串</span>
            <span class="hljs-type">String</span> <span class="hljs-variable">text</span> <span class="hljs-operator">=</span> IOUtils.toString(is, <span class="hljs-string">"UTF-8"</span>);
            
            <span class="hljs-comment">// 写入字符串到流</span>
            IOUtils.write(<span class="hljs-string">"Hello"</span>, os, <span class="hljs-string">"UTF-8"</span>);
            
            <span class="hljs-comment">// 关闭多个流</span>
            IOUtils.closeQuietly(is, os);  <span class="hljs-comment">// 静默关闭，不抛异常</span>
            
            <span class="hljs-comment">// 3. 资源复制（自动关闭）</span>
            <span class="hljs-keyword">try</span> (<span class="hljs-type">InputStream</span> <span class="hljs-variable">in</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileInputStream</span>(<span class="hljs-string">"a.txt"</span>);
                 <span class="hljs-type">OutputStream</span> <span class="hljs-variable">out</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileOutputStream</span>(<span class="hljs-string">"b.txt"</span>)) {
                IOUtils.copy(in, out);
            }
        }
        
        <span class="hljs-comment">// 3. FilenameUtils - 文件名处理</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">filename</span> <span class="hljs-operator">=</span> <span class="hljs-string">"C:/test/file.txt"</span>;
        
        System.out.println(<span class="hljs-string">"扩展名: "</span> + FilenameUtils.getExtension(filename));
        System.out.println(<span class="hljs-string">"文件名（无扩展名）: "</span> + FilenameUtils.getBaseName(filename));
        System.out.println(<span class="hljs-string">"完整文件名: "</span> + FilenameUtils.getName(filename));
        System.out.println(<span class="hljs-string">"路径: "</span> + FilenameUtils.getFullPath(filename));
        System.out.println(<span class="hljs-string">"规范路径: "</span> + FilenameUtils.normalize(filename));
        
        <span class="hljs-comment">// 路径比较</span>
        <span class="hljs-type">boolean</span> <span class="hljs-variable">same</span> <span class="hljs-operator">=</span> FilenameUtils.equals(
            <span class="hljs-string">"C:/test/../test/file.txt"</span>, 
            <span class="hljs-string">"C:/test/file.txt"</span>);  <span class="hljs-comment">// true</span>
        
        <span class="hljs-comment">// 4. FileSystemUtils - 文件系统工具</span>
        <span class="hljs-type">long</span> <span class="hljs-variable">freeSpace</span> <span class="hljs-operator">=</span> FileSystemUtils.freeSpaceKb(<span class="hljs-string">"C:"</span>);
        System.out.println(<span class="hljs-string">"C盘剩余空间: "</span> + freeSpace + <span class="hljs-string">"KB"</span>);
        
        <span class="hljs-comment">// 5. 监控文件变化</span>
        <span class="hljs-comment">// FileAlterationMonitor monitor = new FileAlterationMonitor(1000);</span>
        <span class="hljs-comment">// FileAlterationObserver observer = new FileAlterationObserver("watchDir");</span>
        <span class="hljs-comment">// observer.addListener(new FileAlterationListenerAdaptor() {</span>
        <span class="hljs-comment">//     public void onFileCreate(File file) {</span>
        <span class="hljs-comment">//         System.out.println("创建: " + file.getName());</span>
        <span class="hljs-comment">//     }</span>
        <span class="hljs-comment">// });</span>
        <span class="hljs-comment">// monitor.addObserver(observer);</span>
        <span class="hljs-comment">// monitor.start();</span>
    }
}
</code></pre>
<h3 data-id="heading-23">🎯 最佳实践总结</h3>
<h4 data-id="heading-24"><strong>1. 选择正确的流类型</strong></h4>






























<table><thead><tr><th>场景</th><th>推荐流</th><th>说明</th></tr></thead><tbody><tr><td>文本文件</td><td>FileReader/FileWriter</td><td>字符流处理文本更合适</td></tr><tr><td>二进制文件</td><td>FileInputStream/FileOutputStream</td><td>图片、视频等用字节流</td></tr><tr><td>需要高效</td><td>BufferedXXX</td><td>总是使用缓冲流提升性能</td></tr><tr><td>网络传输</td><td>字节流</td><td>网络传输都是字节</td></tr></tbody></table>
<h4 data-id="heading-25"><strong>2. 资源管理规范</strong></h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// ❌ 错误：忘记关闭流</span>
<span class="hljs-type">FileInputStream</span> <span class="hljs-variable">fis</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileInputStream</span>(<span class="hljs-string">"file.txt"</span>);
<span class="hljs-comment">// 处理数据...</span>
<span class="hljs-comment">// fis.close();  // 忘记调用</span>
​
<span class="hljs-comment">// ✅ 正确1：try-with-resources（Java 7+）</span>
<span class="hljs-keyword">try</span> (<span class="hljs-type">FileInputStream</span> <span class="hljs-variable">fis</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileInputStream</span>(<span class="hljs-string">"file.txt"</span>);
     <span class="hljs-type">FileOutputStream</span> <span class="hljs-variable">fos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileOutputStream</span>(<span class="hljs-string">"output.txt"</span>)) {
    <span class="hljs-comment">// 自动关闭</span>
}
​
<span class="hljs-comment">// ✅ 正确2：传统try-catch-finally</span>
<span class="hljs-type">FileInputStream</span> <span class="hljs-variable">fis</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;
<span class="hljs-keyword">try</span> {
    fis = <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileInputStream</span>(<span class="hljs-string">"file.txt"</span>);
    <span class="hljs-comment">// 处理数据</span>
} <span class="hljs-keyword">catch</span> (IOException e) {
    e.printStackTrace();
} <span class="hljs-keyword">finally</span> {
    <span class="hljs-keyword">if</span> (fis != <span class="hljs-literal">null</span>) {
        <span class="hljs-keyword">try</span> {
            fis.close();
        } <span class="hljs-keyword">catch</span> (IOException e) {
            e.printStackTrace();
        }
    }
}
</code></pre>
<h4 data-id="heading-26"><strong>3. 性能优化建议</strong></h4>
<pre><code class="hljs language-ini" lang="ini">// 缓冲区大小选择（经验值）
byte<span class="hljs-section">[]</span> <span class="hljs-attr">buffer</span> = new byte[<span class="hljs-number">8192</span>]<span class="hljs-comment">;  // 8KB - 适合大多数场景</span>
// 或
char<span class="hljs-section">[]</span> <span class="hljs-attr">charBuffer</span> = new char[<span class="hljs-number">8192</span>]<span class="hljs-comment">;</span>
​
// 批量操作优于单字节操作
while ((<span class="hljs-attr">len</span> = input.read(buffer)) != -<span class="hljs-number">1</span>) {
    output.write(buffer, 0, len)<span class="hljs-comment">;  // 批量写入</span>
}
​
// 使用NIO（大文件或高并发）
Path <span class="hljs-attr">source</span> = Paths.get(<span class="hljs-string">"largefile.iso"</span>)<span class="hljs-comment">;</span>
Path <span class="hljs-attr">target</span> = Paths.get(<span class="hljs-string">"copy.iso"</span>)<span class="hljs-comment">;</span>
Files.copy(source, target, StandardCopyOption.REPLACE_EXISTING)<span class="hljs-comment">;</span>
</code></pre>
<h4 data-id="heading-27"><strong>4. 编码处理黄金法则</strong></h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 原则：编码解码必须一致</span>
<span class="hljs-type">String</span> <span class="hljs-variable">text</span> <span class="hljs-operator">=</span> <span class="hljs-string">"你好世界"</span>;
​
<span class="hljs-comment">// 保存时指定编码</span>
<span class="hljs-keyword">try</span> (<span class="hljs-type">OutputStreamWriter</span> <span class="hljs-variable">osw</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">OutputStreamWriter</span>(
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileOutputStream</span>(<span class="hljs-string">"file.txt"</span>), StandardCharsets.UTF_8)) {
    osw.write(text);
}
​
<span class="hljs-comment">// 读取时使用相同编码</span>
<span class="hljs-keyword">try</span> (<span class="hljs-type">InputStreamReader</span> <span class="hljs-variable">isr</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InputStreamReader</span>(
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileInputStream</span>(<span class="hljs-string">"file.txt"</span>), StandardCharsets.UTF_8)) {
    <span class="hljs-comment">// 读取...</span>
}
​
<span class="hljs-comment">// 网页处理使用UTF-8</span>
response.setCharacterEncoding(<span class="hljs-string">"UTF-8"</span>);
request.setCharacterEncoding(<span class="hljs-string">"UTF-8"</span>);
</code></pre>
<h3 data-id="heading-28">🚀 快速参考卡</h3>






















































<table><thead><tr><th>操作</th><th>字节流</th><th>字符流</th><th>缓冲流</th><th>Commons IO</th></tr></thead><tbody><tr><td><strong>读取文件</strong></td><td><code>FileInputStream</code></td><td><code>FileReader</code></td><td><code>BufferedReader</code></td><td><code>FileUtils.readFileToString()</code></td></tr><tr><td><strong>写入文件</strong></td><td><code>FileOutputStream</code></td><td><code>FileWriter</code></td><td><code>BufferedWriter</code></td><td><code>FileUtils.writeStringToFile()</code></td></tr><tr><td><strong>复制文件</strong></td><td>手动循环</td><td>手动循环</td><td>缓冲+数组</td><td><code>FileUtils.copyFile()</code></td></tr><tr><td><strong>读取行</strong></td><td>N/A</td><td><code>readLine()</code></td><td><code>BufferedReader.readLine()</code></td><td><code>FileUtils.readLines()</code></td></tr><tr><td><strong>处理编码</strong></td><td>字节数组+String</td><td><code>InputStreamReader</code></td><td>指定Charset</td><td>自动UTF-8</td></tr><tr><td><strong>关闭资源</strong></td><td>try-with-resources</td><td>try-with-resources</td><td>try-with-resources</td><td>自动管理</td></tr></tbody></table>
<h3 data-id="heading-29">📝 常见问题解答</h3>
<p><strong>Q: 字节流和字符流怎么选择？</strong> A: 文本用字符流（Reader/Writer），二进制数据用字节流（InputStream/OutputStream）</p>
<p><strong>Q: 为什么用缓冲流？</strong> A: 减少物理读写次数，提升性能几十到几百倍！</p>
<p><strong>Q: 如何处理大文件？</strong> A: 使用缓冲流+适当缓冲区，或考虑NIO的FileChannel</p>
<p><strong>Q: 中文乱码怎么解决？</strong> A: 确保编码一致，推荐统一使用UTF-8</p>
<p><strong>Q: 流为什么要关闭？</strong> A: 释放系统资源，避免内存泄漏和文件锁定</p>
<p>希望这篇全面的IO流指南能帮助你！编程愉快！ 🚀💻</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[SpringAI快速上手教程]]></title>    <link>https://juejin.cn/post/7595858353660461090</link>    <guid>https://juejin.cn/post/7595858353660461090</guid>    <pubDate>2026-01-17T04:09:26.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7595858353660461090" data-draft-id="7592803747471917106" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="SpringAI快速上手教程"/> <meta itemprop="keywords" content="Spring Boot"/> <meta itemprop="datePublished" content="2026-01-17T04:09:26.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="devlogix01"/> <meta itemprop="url" content="https://juejin.cn/user/2701937351075513"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            SpringAI快速上手教程
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2701937351075513/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    devlogix01
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-17T04:09:26.000Z" title="Sat Jan 17 2026 04:09:26 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-17
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body .octicon{display:inline-block;fill:currentColor;vertical-align:text-bottom}.markdown-body .anchor{float:left;line-height:1;margin-left:-20px;padding-right:4px}.markdown-body .anchor:focus{outline:none}.markdown-body h1 .octicon-link,.markdown-body h2 .octicon-link,.markdown-body h3 .octicon-link,.markdown-body h4 .octicon-link,.markdown-body h5 .octicon-link,.markdown-body h6 .octicon-link{color:#1b1f23;vertical-align:middle;visibility:hidden}.markdown-body h1:hover .anchor,.markdown-body h2:hover .anchor,.markdown-body h3:hover .anchor,.markdown-body h4:hover .anchor,.markdown-body h5:hover .anchor,.markdown-body h6:hover .anchor{text-decoration:none}.markdown-body h1:hover .anchor .octicon-link,.markdown-body h2:hover .anchor .octicon-link,.markdown-body h3:hover .anchor .octicon-link,.markdown-body h4:hover .anchor .octicon-link,.markdown-body h5:hover .anchor .octicon-link,.markdown-body h6:hover .anchor .octicon-link{visibility:visible}.markdown-body h1:hover .anchor .octicon-link:before,.markdown-body h2:hover .anchor .octicon-link:before,.markdown-body h3:hover .anchor .octicon-link:before,.markdown-body h4:hover .anchor .octicon-link:before,.markdown-body h5:hover .anchor .octicon-link:before,.markdown-body h6:hover .anchor .octicon-link:before{width:16px;height:16px;content:" ";display:inline-block;background-image:url("data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' aria-hidden='true'%3E%3Cpath fill-rule='evenodd' d='M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z'/%3E%3C/svg%3E")}.markdown-body{-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%;color:#24292e;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Helvetica,Arial,sans-serif,Apple Color Emoji,Segoe UI Emoji;font-size:16px;line-height:1.5;word-wrap:break-word}.markdown-body details{display:block}.markdown-body summary{display:list-item}.markdown-body a{background-color:initial}.markdown-body a:active,.markdown-body a:hover{outline-width:0}.markdown-body strong{font-weight:inherit;font-weight:bolder}.markdown-body h1{margin:.67em 0}.markdown-body img{border-style:none}.markdown-body code,.markdown-body kbd,.markdown-body pre{font-family:monospace,monospace;font-size:1em}.markdown-body hr{box-sizing:initial;overflow:visible}.markdown-body input{font:inherit;margin:0;overflow:visible}.markdown-body [type=checkbox]{box-sizing:border-box;padding:0}.markdown-body *{box-sizing:border-box}.markdown-body input{font-family:inherit;font-size:inherit;line-height:inherit}.markdown-body a{color:#0366d6;text-decoration:none}.markdown-body a:hover{text-decoration:underline}.markdown-body strong{font-weight:600}.markdown-body hr{height:0;margin:15px 0;overflow:hidden;background:transparent;border-bottom:1px solid #dfe2e5}.markdown-body hr:after,.markdown-body hr:before{display:table;content:""}.markdown-body hr:after{clear:both}.markdown-body table{border-spacing:0;border-collapse:collapse}.markdown-body td,.markdown-body th{padding:0}.markdown-body details summary{cursor:pointer}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{margin-top:0;margin-bottom:0}.markdown-body h1{font-size:32px}.markdown-body h1,.markdown-body h2{font-weight:600}.markdown-body h2{font-size:24px}.markdown-body h3{font-size:20px}.markdown-body h3,.markdown-body h4{font-weight:600}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:14px}.markdown-body h5,.markdown-body h6{font-weight:600}.markdown-body h6{font-size:12px}.markdown-body p{margin-top:0;margin-bottom:10px}.markdown-body blockquote{margin:0}.markdown-body ol,.markdown-body ul{padding-left:0;margin-top:0;margin-bottom:0}.markdown-body ol ol,.markdown-body ul ol{list-style-type:lower-roman}.markdown-body ol ol ol,.markdown-body ol ul ol,.markdown-body ul ol ol,.markdown-body ul ul ol{list-style-type:lower-alpha}.markdown-body dd{margin-left:0}.markdown-body code,.markdown-body pre{font-family:SFMono-Regular,Consolas,Liberation Mono,Menlo,monospace;font-size:12px}.markdown-body pre{margin-top:0;margin-bottom:0}.markdown-body input::-webkit-inner-spin-button,.markdown-body input::-webkit-outer-spin-button{margin:0;-webkit-appearance:none;appearance:none}.markdown-body :checked+.radio-label{position:relative;z-index:1;border-color:#0366d6}.markdown-body .border{border:1px solid #e1e4e8!important}.markdown-body .border-0{border:0!important}.markdown-body .border-bottom{border-bottom:1px solid #e1e4e8!important}.markdown-body .rounded-1{border-radius:3px!important}.markdown-body .bg-white{background-color:#fff!important}.markdown-body .bg-gray-light{background-color:#fafbfc!important}.markdown-body .text-gray-light{color:#6a737d!important}.markdown-body .pl-3,.markdown-body .px-3{padding-left:16px!important}.markdown-body .px-3{padding-right:16px!important}.markdown-body .f6{font-size:12px!important}.markdown-body .lh-condensed{line-height:1.25!important}.markdown-body .text-bold{font-weight:600!important}.markdown-body .pl-c{color:#6a737d}.markdown-body .pl-c1,.markdown-body .pl-s .pl-v{color:#005cc5}.markdown-body .pl-e,.markdown-body .pl-en{color:#6f42c1}.markdown-body .pl-s .pl-s1,.markdown-body .pl-smi{color:#24292e}.markdown-body .pl-ent{color:#22863a}.markdown-body .pl-k{color:#d73a49}.markdown-body .pl-pds,.markdown-body .pl-s,.markdown-body .pl-s .pl-pse .pl-s1,.markdown-body .pl-sr,.markdown-body .pl-sr .pl-cce,.markdown-body .pl-sr .pl-sra,.markdown-body .pl-sr .pl-sre{color:#032f62}.markdown-body .pl-smw,.markdown-body .pl-v{color:#e36209}.markdown-body .pl-bu{color:#b31d28}.markdown-body .pl-ii{color:#fafbfc;background-color:#b31d28}.markdown-body .pl-c2{color:#fafbfc;background-color:#d73a49}.markdown-body .pl-c2:before{content:"^M"}.markdown-body .pl-sr .pl-cce{font-weight:700;color:#22863a}.markdown-body .pl-ml{color:#735c0f}.markdown-body .pl-mh,.markdown-body .pl-mh .pl-en,.markdown-body .pl-ms{font-weight:700;color:#005cc5}.markdown-body .pl-mi{font-style:italic;color:#24292e}.markdown-body .pl-mb{font-weight:700;color:#24292e}.markdown-body .pl-md{color:#b31d28;background-color:#ffeef0}.markdown-body .pl-mi1{color:#22863a;background-color:#f0fff4}.markdown-body .pl-mc{color:#e36209;background-color:#ffebda}.markdown-body .pl-mi2{color:#f6f8fa;background-color:#005cc5}.markdown-body .pl-mdr{font-weight:700;color:#6f42c1}.markdown-body .pl-ba{color:#586069}.markdown-body .pl-sg{color:#959da5}.markdown-body .pl-corl{text-decoration:underline;color:#032f62}.markdown-body .mb-0{margin-bottom:0!important}.markdown-body .my-2{margin-bottom:8px!important;margin-top:8px!important}.markdown-body .pl-0{padding-left:0!important}.markdown-body .py-0{padding-top:0!important;padding-bottom:0!important}.markdown-body .pl-1{padding-left:4px!important}.markdown-body .pl-2{padding-left:8px!important}.markdown-body .py-2{padding-top:8px!important;padding-bottom:8px!important}.markdown-body .pl-3{padding-left:16px!important}.markdown-body .pl-4{padding-left:24px!important}.markdown-body .pl-5{padding-left:32px!important}.markdown-body .pl-6{padding-left:40px!important}.markdown-body .pl-7{padding-left:48px!important}.markdown-body .pl-8{padding-left:64px!important}.markdown-body .pl-9{padding-left:80px!important}.markdown-body .pl-10{padding-left:96px!important}.markdown-body .pl-11{padding-left:112px!important}.markdown-body .pl-12{padding-left:128px!important}.markdown-body hr{border-bottom-color:#eee}.markdown-body kbd{display:inline-block;padding:3px 5px;font:11px SFMono-Regular,Consolas,Liberation Mono,Menlo,monospace;line-height:10px;color:#444d56;vertical-align:middle;background-color:#fafbfc;border:1px solid #d1d5da;border-radius:3px;box-shadow:inset 0 -1px 0 #d1d5da}.markdown-body:after,.markdown-body:before{display:table;content:""}.markdown-body:after{clear:both}.markdown-body&gt;:first-child{margin-top:0!important}.markdown-body&gt;:last-child{margin-bottom:0!important}.markdown-body a:not([href]){color:inherit;text-decoration:none}.markdown-body blockquote,.markdown-body details,.markdown-body dl,.markdown-body ol,.markdown-body p,.markdown-body pre,.markdown-body table,.markdown-body ul{margin-top:0;margin-bottom:16px}.markdown-body hr{height:.25em;padding:0;margin:24px 0;background-color:#e1e4e8;border:0}.markdown-body blockquote{padding:0 1em;color:#6a737d;border-left:.25em solid #dfe2e5}.markdown-body blockquote&gt;:first-child{margin-top:0}.markdown-body blockquote&gt;:last-child{margin-bottom:0}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{margin-top:24px;margin-bottom:16px;font-weight:600;line-height:1.25}.markdown-body h1{font-size:2em}.markdown-body h1,.markdown-body h2{padding-bottom:.3em;border-bottom:1px solid #eaecef}.markdown-body h2{font-size:1.5em}.markdown-body h3{font-size:1.25em}.markdown-body h4{font-size:1em}.markdown-body h5{font-size:.875em}.markdown-body h6{font-size:.85em;color:#6a737d}.markdown-body ol,.markdown-body ul{padding-left:2em}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:0;margin-bottom:0}.markdown-body li{word-wrap:break-all}.markdown-body li&gt;p{margin-top:16px}.markdown-body li+li{margin-top:.25em}.markdown-body dl{padding:0}.markdown-body dl dt{padding:0;margin-top:16px;font-size:1em;font-style:italic;font-weight:600}.markdown-body dl dd{padding:0 16px;margin-bottom:16px}.markdown-body table{display:block;width:100%;overflow:auto}.markdown-body table th{font-weight:600}.markdown-body table td,.markdown-body table th{padding:6px 13px;border:1px solid #dfe2e5}.markdown-body table tr{background-color:#fff;border-top:1px solid #c6cbd1}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}.markdown-body img{max-width:100%;box-sizing:initial;background-color:#fff}.markdown-body img[align=right]{padding-left:20px}.markdown-body img[align=left]{padding-right:20px}.markdown-body code{padding:.2em .4em;margin:0;font-size:85%;background-color:rgba(27,31,35,.05);border-radius:3px}.markdown-body pre{word-wrap:normal}.markdown-body pre&gt;code{padding:0;margin:0;font-size:100%;word-break:normal;white-space:pre;background:transparent;border:0}.markdown-body .highlight{margin-bottom:16px}.markdown-body .highlight pre{margin-bottom:0;word-break:normal}.markdown-body .highlight pre,.markdown-body pre{padding:16px;overflow:auto;font-size:85%;line-height:1.45;background-color:#f6f8fa;border-radius:3px}.markdown-body pre code{display:inline;max-width:auto;padding:0;margin:0;overflow:visible;line-height:inherit;word-wrap:normal;background-color:initial;border:0}.markdown-body .commit-tease-sha{display:inline-block;font-family:SFMono-Regular,Consolas,Liberation Mono,Menlo,monospace;font-size:90%;color:#444d56}.markdown-body .full-commit .btn-outline:not(:disabled):hover{color:#005cc5;border-color:#005cc5}.markdown-body .blob-wrapper{overflow-x:auto;overflow-y:hidden}.markdown-body .blob-wrapper-embedded{max-height:240px;overflow-y:auto}.markdown-body .blob-num{width:1%;min-width:50px;padding-right:10px;padding-left:10px;font-family:SFMono-Regular,Consolas,Liberation Mono,Menlo,monospace;font-size:12px;line-height:20px;color:rgba(27,31,35,.3);text-align:right;white-space:nowrap;vertical-align:top;cursor:pointer;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}.markdown-body .blob-num:hover{color:rgba(27,31,35,.6)}.markdown-body .blob-num:before{content:attr(data-line-number)}.markdown-body .blob-code{position:relative;padding-right:10px;padding-left:10px;line-height:20px;vertical-align:top}.markdown-body .blob-code-inner{overflow:visible;font-family:SFMono-Regular,Consolas,Liberation Mono,Menlo,monospace;font-size:12px;color:#24292e;word-wrap:normal;white-space:pre}.markdown-body .pl-token.active,.markdown-body .pl-token:hover{cursor:pointer;background:#ffea7f}.markdown-body .tab-size[data-tab-size="1"]{-moz-tab-size:1;tab-size:1}.markdown-body .tab-size[data-tab-size="2"]{-moz-tab-size:2;tab-size:2}.markdown-body .tab-size[data-tab-size="3"]{-moz-tab-size:3;tab-size:3}.markdown-body .tab-size[data-tab-size="4"]{-moz-tab-size:4;tab-size:4}.markdown-body .tab-size[data-tab-size="5"]{-moz-tab-size:5;tab-size:5}.markdown-body .tab-size[data-tab-size="6"]{-moz-tab-size:6;tab-size:6}.markdown-body .tab-size[data-tab-size="7"]{-moz-tab-size:7;tab-size:7}.markdown-body .tab-size[data-tab-size="8"]{-moz-tab-size:8;tab-size:8}.markdown-body .tab-size[data-tab-size="9"]{-moz-tab-size:9;tab-size:9}.markdown-body .tab-size[data-tab-size="10"]{-moz-tab-size:10;tab-size:10}.markdown-body .tab-size[data-tab-size="11"]{-moz-tab-size:11;tab-size:11}.markdown-body .tab-size[data-tab-size="12"]{-moz-tab-size:12;tab-size:12}.markdown-body .task-list-item{list-style-type:none}.markdown-body .task-list-item+.task-list-item{margin-top:3px}.markdown-body .task-list-item input{margin:0 .2em .25em -1.6em;vertical-align:middle}</style><style data-highlight="" data-highlight-key="github">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">01-SpringAI的介绍</h2>
<p><strong>Spring AI</strong> 是由 VMware / Spring 团队推出的一个 <strong>面向 AI 的 Spring 官方项目</strong>，目标是让 Java / Spring 开发者 <strong>像用 Spring Data、Spring Security 一样，用统一、规范的方式接入大模型（LLM）和 AI 能力</strong>。</p>
<p>一句话理解：   <strong>Spring AI = 给大模型用的 Spring Framework</strong></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2507e2c2e46c49b79270824041199b65~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgZGV2bG9naXgwMQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769227766&amp;x-signature=RJR3F8qFwIUmcNM3adlsHCs%2FBtc%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-1">02-创建项目远程调用deepseek大模型</h2>
<p>1 创建项目
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/965c31c9ed9e4a86ae39a3193d383331~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgZGV2bG9naXgwMQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769227766&amp;x-signature=rH14fobITTqfAWHXT2DNiyHBPXM%3D" alt="image.png" loading="lazy"/></p>
<h4 data-id="heading-2">Releases - Use Maven Central</h4>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- Maven Central is included by default in Maven builds.
     You usually don’t need to configure it explicitly,
     but it's shown here for clarity. --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">repositories</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">repository</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">id</span>&gt;</span>central<span class="hljs-tag">&lt;/<span class="hljs-name">id</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">url</span>&gt;</span>https://repo.maven.apache.org/maven2<span class="hljs-tag">&lt;/<span class="hljs-name">url</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">repository</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">repositories</span>&gt;</span>
</code></pre>
<h4 data-id="heading-3">Snapshots - Add Snapshot Repositories</h4>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">repositories</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">repository</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">id</span>&gt;</span>spring-snapshots<span class="hljs-tag">&lt;/<span class="hljs-name">id</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">name</span>&gt;</span>Spring Snapshots<span class="hljs-tag">&lt;/<span class="hljs-name">name</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">url</span>&gt;</span>https://repo.spring.io/snapshot<span class="hljs-tag">&lt;/<span class="hljs-name">url</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">releases</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">enabled</span>&gt;</span>false<span class="hljs-tag">&lt;/<span class="hljs-name">enabled</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">releases</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">repository</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">repository</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">name</span>&gt;</span>Central Portal Snapshots<span class="hljs-tag">&lt;/<span class="hljs-name">name</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">id</span>&gt;</span>central-portal-snapshots<span class="hljs-tag">&lt;/<span class="hljs-name">id</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">url</span>&gt;</span>https://central.sonatype.com/repository/maven-snapshots/<span class="hljs-tag">&lt;/<span class="hljs-name">url</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">releases</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">enabled</span>&gt;</span>false<span class="hljs-tag">&lt;/<span class="hljs-name">enabled</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">releases</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">snapshots</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">enabled</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">enabled</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">snapshots</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">repository</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">repositories</span>&gt;</span>
</code></pre>
<p>deepseek dependency</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.ai<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-ai-starter-model-deepseek<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
</code></pre>
<p>ChatController.java</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> org.example.springaidemo.controller;

<span class="hljs-keyword">import</span> org.springframework.ai.chat.messages.UserMessage;
<span class="hljs-keyword">import</span> org.springframework.ai.chat.model.ChatResponse;
<span class="hljs-keyword">import</span> org.springframework.ai.chat.prompt.Prompt;
<span class="hljs-keyword">import</span> org.springframework.ai.deepseek.DeepSeekChatModel;
<span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;
<span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.GetMapping;
<span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.RequestParam;
<span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.RestController;
<span class="hljs-keyword">import</span> reactor.core.publisher.Flux;
<span class="hljs-keyword">import</span> java.util.Map;

<span class="hljs-meta">@RestController</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ChatController</span> {

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> DeepSeekChatModel chatModel;

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title function_">ChatController</span><span class="hljs-params">(DeepSeekChatModel chatModel)</span> {
        <span class="hljs-built_in">this</span>.chatModel = chatModel;
    }

    <span class="hljs-meta">@GetMapping("/ai/generate")</span>
    <span class="hljs-keyword">public</span> Map <span class="hljs-title function_">generate</span><span class="hljs-params">(<span class="hljs-meta">@RequestParam(value = "message", defaultValue = "Tell me a joke")</span> String message)</span> {
        <span class="hljs-keyword">return</span> Map.of(<span class="hljs-string">"generation"</span>, chatModel.call(message));
    }

    <span class="hljs-meta">@GetMapping(value = "/ai/generateStream", produces = "text/html; charset=UTF-8")</span>
    <span class="hljs-keyword">public</span> Flux&lt;String&gt; <span class="hljs-title function_">generateStream</span><span class="hljs-params">(<span class="hljs-meta">@RequestParam(value = "message", defaultValue = "Tell me a joke")</span> String message)</span> {
        <span class="hljs-type">var</span> <span class="hljs-variable">prompt</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Prompt</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">UserMessage</span>(message));
        <span class="hljs-keyword">return</span> chatModel.stream(prompt).map(ChatResponse -&gt; ChatResponse.getResult().getOutput().getText());
    }
}
</code></pre>
<p>测试接口</p>
<p><code>http://localhost:8080/ai/generateStream?message=讲个笑话</code></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e6c48a8cd86749f691ebad3c1f8ec7ad~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgZGV2bG9naXgwMQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769227766&amp;x-signature=gqVLCi4%2FnL3FrmPh9per90nFLxk%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-4">03-SpringAI调用本地大模型ollama</h2>
<p>1 引入依赖</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
   <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.ai<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
   <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-ai-starter-model-ollama<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
</code></pre>
<p>2 配置yml</p>
<pre><code class="hljs language-yml" lang="yml"><span class="hljs-comment"># In application.yml</span>
<span class="hljs-attr">server:</span>
  <span class="hljs-attr">port:</span> <span class="hljs-number">8080</span>
  <span class="hljs-attr">error:</span>
    <span class="hljs-attr">include-message:</span> <span class="hljs-string">always</span>
    <span class="hljs-attr">include-binding-errors:</span> <span class="hljs-string">always</span>
    <span class="hljs-attr">include-stacktrace:</span> <span class="hljs-string">on_param</span>
    <span class="hljs-attr">include-exception:</span> <span class="hljs-literal">false</span>

<span class="hljs-attr">spring:</span>
  <span class="hljs-attr">ai:</span>
    <span class="hljs-attr">deepseek:</span>
      <span class="hljs-attr">api-key:</span> <span class="hljs-string">sk-7fee8ebd8c0744ac9c1d91d9f0d81372</span>
    <span class="hljs-attr">ollama:</span>
      <span class="hljs-attr">chat:</span>
        <span class="hljs-attr">model:</span> <span class="hljs-string">deepseek-r1-1.5b</span>
</code></pre>
<p>3 chatController.java 调用本地ollama的大模型</p>
<pre><code class="hljs language-typescript" lang="typescript">package org.<span class="hljs-property">example</span>.<span class="hljs-property">springaidemo</span>.<span class="hljs-property">controller</span>;

<span class="hljs-keyword">import</span> jakarta.<span class="hljs-property">annotation</span>.<span class="hljs-property">Resource</span>;
<span class="hljs-keyword">import</span> org.<span class="hljs-property">springframework</span>.<span class="hljs-property">ai</span>.<span class="hljs-property">chat</span>.<span class="hljs-property">messages</span>.<span class="hljs-property">UserMessage</span>;
<span class="hljs-keyword">import</span> org.<span class="hljs-property">springframework</span>.<span class="hljs-property">ai</span>.<span class="hljs-property">chat</span>.<span class="hljs-property">prompt</span>.<span class="hljs-property">Prompt</span>;
<span class="hljs-keyword">import</span> org.<span class="hljs-property">springframework</span>.<span class="hljs-property">ai</span>.<span class="hljs-property">ollama</span>.<span class="hljs-property">OllamaChatModel</span>;
<span class="hljs-keyword">import</span> org.<span class="hljs-property">springframework</span>.<span class="hljs-property">web</span>.<span class="hljs-property">bind</span>.<span class="hljs-property">annotation</span>.<span class="hljs-property">GetMapping</span>;
<span class="hljs-keyword">import</span> org.<span class="hljs-property">springframework</span>.<span class="hljs-property">web</span>.<span class="hljs-property">bind</span>.<span class="hljs-property">annotation</span>.<span class="hljs-property">RequestParam</span>;
<span class="hljs-keyword">import</span> org.<span class="hljs-property">springframework</span>.<span class="hljs-property">web</span>.<span class="hljs-property">bind</span>.<span class="hljs-property">annotation</span>.<span class="hljs-property">RestController</span>;
<span class="hljs-keyword">import</span> reactor.<span class="hljs-property">core</span>.<span class="hljs-property">publisher</span>.<span class="hljs-property">Flux</span>;
<span class="hljs-keyword">import</span> java.<span class="hljs-property">util</span>.<span class="hljs-property">Map</span>;

<span class="hljs-meta">@RestController</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ChatController</span> {

    <span class="hljs-meta">@Resource</span>
    <span class="hljs-keyword">private</span> <span class="hljs-title class_">OllamaChatModel</span> chatModel;


    <span class="hljs-meta">@GetMapping</span>(<span class="hljs-string">"/ai/generate"</span>)
    <span class="hljs-keyword">public</span> <span class="hljs-title class_">Map</span> <span class="hljs-title function_">generate</span>(<span class="hljs-params"><span class="hljs-meta">@RequestParam</span>(value = <span class="hljs-string">"message"</span>, defaultValue = <span class="hljs-string">"Tell me a joke"</span>) <span class="hljs-built_in">String</span> message</span>) {
        <span class="hljs-keyword">return</span> <span class="hljs-title class_">Map</span>.<span class="hljs-title function_">of</span>(<span class="hljs-string">"generation"</span>, chatModel.<span class="hljs-title function_">call</span>(message));
    }

    <span class="hljs-meta">@GetMapping</span>(value = <span class="hljs-string">"/ai/generateStream"</span>, produces = <span class="hljs-string">"text/html; charset=UTF-8"</span>)
    <span class="hljs-keyword">public</span> <span class="hljs-title class_">Flux</span>&lt;<span class="hljs-title class_">String</span>&gt; <span class="hljs-title function_">generateStream</span>(<span class="hljs-params"><span class="hljs-meta">@RequestParam</span>(value = <span class="hljs-string">"message"</span>, defaultValue = <span class="hljs-string">"Tell me a joke"</span>) <span class="hljs-built_in">String</span> message</span>) {
        <span class="hljs-keyword">var</span> prompt = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Prompt</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">UserMessage</span>(message));
        <span class="hljs-keyword">return</span> chatModel.<span class="hljs-title function_">stream</span>(prompt).<span class="hljs-title function_">map</span>(<span class="hljs-title class_">ChatResponse</span> -&gt; <span class="hljs-title class_">ChatResponse</span>.<span class="hljs-title function_">getResult</span>().<span class="hljs-title function_">getOutput</span>().<span class="hljs-title function_">getText</span>());
    }
}
</code></pre>
<h2 data-id="heading-5">04-SpringAI创建ChatClient示例实现AI人设</h2>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> org.example.springaidemo.controller;


<span class="hljs-keyword">import</span> jakarta.annotation.Resource;
<span class="hljs-keyword">import</span> org.springframework.ai.chat.client.ChatClient;
<span class="hljs-keyword">import</span> org.springframework.ai.deepseek.DeepSeekChatModel;
<span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;
<span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.GetMapping;
<span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.RequestParam;
<span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.RestController;
<span class="hljs-keyword">import</span> reactor.core.publisher.Flux;

<span class="hljs-meta">@RestController</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ChatController</span> {

    <span class="hljs-meta">@Resource</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> DeepSeekChatModel chatModel;
    <span class="hljs-meta">@Resource</span>
    <span class="hljs-keyword">private</span> ChatClient chatClient;

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title function_">ChatController</span><span class="hljs-params">(DeepSeekChatModel chatModel)</span> {
        <span class="hljs-built_in">this</span>.chatModel = chatModel;
    }


    <span class="hljs-meta">@GetMapping("/ai/generate")</span>
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">generate</span><span class="hljs-params">(<span class="hljs-meta">@RequestParam(value = "message", defaultValue = "Tell me a joke")</span> String message)</span> {
        <span class="hljs-keyword">return</span>  chatClient.prompt(<span class="hljs-string">"你是ai助手小黑"</span>).user( message).call().content();

    }

    <span class="hljs-meta">@GetMapping(value = "/ai/generateStream", produces = "text/html; charset=UTF-8")</span>
    <span class="hljs-keyword">public</span> Flux&lt;String&gt; <span class="hljs-title function_">generateStream</span><span class="hljs-params">(<span class="hljs-meta">@RequestParam(value = "message", defaultValue = "Tell me a joke")</span> String message)</span> {
        <span class="hljs-keyword">return</span>  chatClient.prompt(<span class="hljs-string">"你是ai助手小黑"</span>).user( message).stream().content();
    }
}
</code></pre>
<p>测试
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2fba5ef9c07643e092b3c0b3eac6e9b7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgZGV2bG9naXgwMQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769227766&amp;x-signature=qpk%2B%2BBl4Y6EATRXcZBUV%2Bh4Fws0%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-6">05-SpringAI实现记录上下文</h2>
<p><strong>1 创建数据库</strong></p>
<p>打开 navicat 进行创建</p>
<p>数据库的名称就叫</p>
<p>20260110-ai</p>
<p>字符集编码选择为 utf8mb4</p>
<p>创建成功</p>
<p>点击 查询的选项</p>
<p>然后把聊天记录表的 sql 语句给复制粘贴进来</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> `sys_history` (
  `id` <span class="hljs-type">bigint</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> AUTO_INCREMENT COMMENT <span class="hljs-string">'序列号'</span>,
  `datetime` datetime <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">'聊天时间'</span>,
  `content` longtext <span class="hljs-type">CHARACTER</span> <span class="hljs-keyword">SET</span> utf8mb4 <span class="hljs-keyword">COLLATE</span> utf8mb4_unicode_ci COMMENT <span class="hljs-string">'聊天内容'</span>,
  `role` <span class="hljs-type">varchar</span>(<span class="hljs-number">255</span>) <span class="hljs-type">CHARACTER</span> <span class="hljs-keyword">SET</span> utf8mb4 <span class="hljs-keyword">COLLATE</span> utf8mb4_unicode_ci <span class="hljs-keyword">DEFAULT</span> <span class="hljs-string">'user'</span> COMMENT <span class="hljs-string">'角色'</span>,
  `sessionId` <span class="hljs-type">bigint</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">'会话Id'</span>,
  <span class="hljs-keyword">PRIMARY</span> KEY (`id`) <span class="hljs-keyword">USING</span> BTREE
) ENGINE<span class="hljs-operator">=</span>InnoDB AUTO_INCREMENT<span class="hljs-operator">=</span><span class="hljs-number">227</span> <span class="hljs-keyword">DEFAULT</span> CHARSET<span class="hljs-operator">=</span>utf8mb4 <span class="hljs-keyword">COLLATE</span><span class="hljs-operator">=</span>utf8mb4_unicode_ci ROW_FORMAT<span class="hljs-operator">=</span><span class="hljs-keyword">DYNAMIC</span> COMMENT<span class="hljs-operator">=</span><span class="hljs-string">'聊天记录'</span>;
</code></pre>
<p><strong>2 导入依赖坐标</strong></p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!--Mysql驱动        --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.mysql<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>mysql-connector-j<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>8.3.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
<span class="hljs-comment">&lt;!--  Mybatis——Plus 插件    --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.baomidou<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>mybatis-plus-jsqlparser<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
<span class="hljs-comment">&lt;!--  Mybatis——Plus     --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.baomidou<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>mybatis-plus-spring-boot3-starter<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
</code></pre>
<p><strong>3 配置数据源</strong></p>
<pre><code class="hljs language-yml" lang="yml"><span class="hljs-attr">datasource:</span>
  <span class="hljs-attr">driver-class-name:</span> <span class="hljs-string">com.mysql.cj.jdbc.Driver</span>
  <span class="hljs-attr">url:</span> <span class="hljs-string">jdbc:mysql://localhost:3306/20260110-ai?allowPublicKeyRetrieval=true&amp;useUnicode=true&amp;useSSL=false&amp;characterEncoding=utf8&amp;serverTimezone=Asia/Shanghai</span>
  <span class="hljs-attr">username:</span> <span class="hljs-string">root</span>
  <span class="hljs-attr">password:</span> <span class="hljs-string">root</span>
</code></pre>
<p><strong>4 配置其他文件夹</strong></p>
<p>config/AiConfig.java</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> org.example.springaidemo.entity.impl;

<span class="hljs-keyword">import</span> com.baomidou.mybatisplus.extension.service.impl.ServiceImpl;

<span class="hljs-keyword">import</span> org.example.springaidemo.entity.History;
<span class="hljs-keyword">import</span> org.example.springaidemo.mapper.HistoryMapper;
<span class="hljs-keyword">import</span> org.example.springaidemo.service.HistoryService;
<span class="hljs-keyword">import</span> org.springframework.stereotype.Service;



<span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HistoryServiceImpl</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">ServiceImpl</span>&lt;HistoryMapper, History&gt; <span class="hljs-keyword">implements</span> <span class="hljs-title class_">HistoryService</span> {

}
</code></pre>
<p>config/MybatisPlusConfig.java</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> org.example.springaidemo.config;


<span class="hljs-keyword">import</span> com.baomidou.mybatisplus.extension.plugins.MybatisPlusInterceptor;

<span class="hljs-keyword">import</span> lombok.extern.slf4j.Slf4j;
<span class="hljs-keyword">import</span> org.mybatis.spring.annotation.MapperScan;
<span class="hljs-keyword">import</span> org.springframework.context.annotation.Bean;
<span class="hljs-keyword">import</span> org.springframework.context.annotation.Configuration;

<span class="hljs-meta">@Configuration</span>

<span class="hljs-meta">@MapperScan("org.example.springaidemo.mapper")</span>
<span class="hljs-meta">@Slf4j</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MybatisPlusConfig</span> {
    <span class="hljs-meta">@Bean</span>
    <span class="hljs-keyword">public</span> MybatisPlusInterceptor <span class="hljs-title function_">mybatisPlusInterceptor</span><span class="hljs-params">()</span> {
        <span class="hljs-type">MybatisPlusInterceptor</span> <span class="hljs-variable">interceptor</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MybatisPlusInterceptor</span>();
        <span class="hljs-keyword">return</span> interceptor;
    }
}
</code></pre>
<p>entity/History.java</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> org.example.springaidemo.entity;


<span class="hljs-keyword">import</span> com.baomidou.mybatisplus.annotation.IdType;
<span class="hljs-keyword">import</span> com.baomidou.mybatisplus.annotation.TableField;
<span class="hljs-keyword">import</span> com.baomidou.mybatisplus.annotation.TableId;
<span class="hljs-keyword">import</span> com.baomidou.mybatisplus.annotation.TableName;
<span class="hljs-keyword">import</span> com.fasterxml.jackson.annotation.JsonFormat;
<span class="hljs-keyword">import</span> io.swagger.v3.oas.annotations.media.Schema;
<span class="hljs-keyword">import</span> lombok.AllArgsConstructor;
<span class="hljs-keyword">import</span> lombok.Builder;
<span class="hljs-keyword">import</span> lombok.Data;
<span class="hljs-keyword">import</span> lombok.NoArgsConstructor;

<span class="hljs-keyword">import</span> java.io.Serializable;
<span class="hljs-keyword">import</span> java.time.LocalDateTime;


<span class="hljs-comment">/**
 * 聊天记录实体类
 */</span>

<span class="hljs-meta">@Data</span>
<span class="hljs-meta">@Builder(toBuilder = true)</span>
<span class="hljs-meta">@AllArgsConstructor</span>
<span class="hljs-meta">@NoArgsConstructor</span>
<span class="hljs-meta">@TableName("sys_history")</span>

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">History</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Serializable</span> {

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">long</span> <span class="hljs-variable">serialVersionUID</span> <span class="hljs-operator">=</span> <span class="hljs-number">1L</span>;

    <span class="hljs-meta">@TableId(value = "id", type = IdType.AUTO)</span>
    <span class="hljs-keyword">private</span> Long id;

    <span class="hljs-meta">@Schema(title = "聊天时间")</span>
    <span class="hljs-meta">@TableField("datetime")</span>

    <span class="hljs-meta">@JsonFormat( pattern = "yyyy-MM-dd HH:mm:ss")</span>
    <span class="hljs-keyword">private</span> LocalDateTime datetime;
    <span class="hljs-meta">@Schema(title = "聊天内容")</span>
    <span class="hljs-meta">@TableField("content")</span>

    <span class="hljs-keyword">private</span> String content;
    <span class="hljs-meta">@Schema(title = "角色")</span>
    <span class="hljs-meta">@TableField("role")</span>

    <span class="hljs-keyword">private</span> String role;
    <span class="hljs-meta">@Schema(title = "会话Id")</span>
    <span class="hljs-meta">@TableField("sessionId")</span>

    <span class="hljs-keyword">private</span> Long sessionId;
}
</code></pre>
<p>service/HistoryService.java</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> org.example.springaidemo.service;

<span class="hljs-keyword">import</span> com.baomidou.mybatisplus.extension.service.IService;
<span class="hljs-keyword">import</span> org.example.springaidemo.entity.History;


<span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">HistoryService</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">IService</span>&lt;History&gt; {

}
</code></pre>
<p>service/impl/HistoryServiceImpl.java</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> org.example.springaidemo.service.impl;

<span class="hljs-keyword">import</span> com.baomidou.mybatisplus.extension.service.impl.ServiceImpl;

<span class="hljs-keyword">import</span> org.example.springaidemo.entity.History;
<span class="hljs-keyword">import</span> org.example.springaidemo.mapper.HistoryMapper;
<span class="hljs-keyword">import</span> org.example.springaidemo.service.HistoryService;
<span class="hljs-keyword">import</span> org.springframework.stereotype.Service;



<span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HistoryServiceImpl</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">ServiceImpl</span>&lt;HistoryMapper, History&gt; <span class="hljs-keyword">implements</span> <span class="hljs-title class_">HistoryService</span> {

}
</code></pre>
<p>mapper/HistoryMapper.java</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> org.example.springaidemo.mapper;

<span class="hljs-keyword">import</span> com.baomidou.mybatisplus.core.mapper.BaseMapper;
<span class="hljs-keyword">import</span> org.apache.ibatis.annotations.Mapper;
<span class="hljs-keyword">import</span> org.example.springaidemo.entity.History;


<span class="hljs-meta">@Mapper</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">HistoryMapper</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">BaseMapper</span>&lt;History&gt; {

}
</code></pre>
<p>更新chatController.java</p>
<p>使用MyBatis-Plus进行数据库操作</p>
<p>Spring AI框架的各种组件（ChatClient、消息类型等）</p>
<p>DeepSeek和Ollama两个AI模型（虽然导入了Ollama但未使用）</p>
<p>响应式编程库Reactor的Flux</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> org.example.springaidemo.controller;


<span class="hljs-keyword">import</span> com.baomidou.mybatisplus.core.conditions.query.LambdaQueryWrapper;
<span class="hljs-keyword">import</span> jakarta.annotation.Resource;
<span class="hljs-keyword">import</span> org.example.springaidemo.entity.History;
<span class="hljs-keyword">import</span> org.example.springaidemo.service.HistoryService;
<span class="hljs-keyword">import</span> org.springframework.ai.chat.client.ChatClient;
<span class="hljs-keyword">import</span> org.springframework.ai.chat.messages.AssistantMessage;
<span class="hljs-keyword">import</span> org.springframework.ai.chat.messages.Message;
<span class="hljs-keyword">import</span> org.springframework.ai.chat.messages.UserMessage;
<span class="hljs-keyword">import</span> org.springframework.ai.deepseek.DeepSeekChatModel;
<span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;
<span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.GetMapping;
<span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.RequestParam;
<span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.RestController;
<span class="hljs-keyword">import</span> reactor.core.publisher.Flux;

<span class="hljs-keyword">import</span> java.time.LocalDateTime;
<span class="hljs-keyword">import</span> java.util.List;
<span class="hljs-keyword">import</span> java.util.stream.Collectors;

<span class="hljs-meta">@RestController</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ChatController</span> {
    <span class="hljs-comment">//依赖注入</span>
    <span class="hljs-meta">@Resource</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> DeepSeekChatModel chatModel;
    <span class="hljs-meta">@Resource</span>
    <span class="hljs-keyword">private</span> ChatClient chatClient;
    <span class="hljs-meta">@Resource</span>
    <span class="hljs-keyword">private</span> HistoryService historyService;

    <span class="hljs-comment">//构造函数注入</span>
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title function_">ChatController</span><span class="hljs-params">(DeepSeekChatModel chatModel)</span> {
        <span class="hljs-built_in">this</span>.chatModel = chatModel;
    }

    <span class="hljs-comment">/*
    * HTTP GET端点：/ai/generate
    接收用户消息参数，默认值为"Tell me a joke"
    返回AI助手"小黑"对用户消息的同步响应内容
    * */</span>
    <span class="hljs-meta">@GetMapping("/ai/generate")</span>
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">generate</span><span class="hljs-params">(<span class="hljs-meta">@RequestParam(value = "message", defaultValue = "Tell me a joke")</span> String message)</span> {
        <span class="hljs-keyword">return</span>  chatClient.prompt(<span class="hljs-string">"你是ai助手小黑"</span>).user( message).call().content();

    }

    <span class="hljs-meta">@GetMapping(value = "/ai/generateStream", produces = "text/html; charset=UTF-8")</span>
    <span class="hljs-keyword">public</span> Flux&lt;String&gt; <span class="hljs-title function_">generateStream</span><span class="hljs-params">(<span class="hljs-meta">@RequestParam(value = "message", defaultValue = "Tell me a joke")</span> String message,
                                       <span class="hljs-meta">@RequestParam(value = "sessionId", defaultValue = " 1 ")</span> <span class="hljs-type">long</span> sessionId
                                       )</span> {
        <span class="hljs-comment">//用户消息保存</span>
        <span class="hljs-type">History</span> <span class="hljs-variable">userhistory</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">History</span>();
        userhistory.setDatetime(LocalDateTime.now());
        userhistory.setRole(<span class="hljs-string">"user"</span>);
        userhistory.setContent(message);
        userhistory.setSessionId(sessionId);
        historyService.save(userhistory); <span class="hljs-comment">//创建并保存用户发送的消息到数据库</span>

        <span class="hljs-comment">//获取历史对话</span>
        <span class="hljs-comment">//查询指定会话ID的所有历史记录</span>
        <span class="hljs-comment">//排除刚刚保存的当前用户消息（避免重复）</span>
        List&lt;History&gt; histories = historyService.list(
                <span class="hljs-keyword">new</span> <span class="hljs-title class_">LambdaQueryWrapper</span>&lt;History&gt;().eq(History::getSessionId, sessionId).ne(History::getId , userhistory.getId())
        ) ;

        <span class="hljs-comment">//转换历史消息格式: 将历史记录转换为AI模型能理解的消息格式</span>
        List&lt;Message&gt; messages = histories.stream().map(history -&gt;
                <span class="hljs-string">"user"</span>.equals(history.getRole())?<span class="hljs-keyword">new</span> <span class="hljs-title class_">UserMessage</span>(history.getContent()):<span class="hljs-keyword">new</span> <span class="hljs-title class_">AssistantMessage</span>(history.getContent())).collect(Collectors.toList());

        <span class="hljs-comment">//数组 用来累积AI流式回复内容</span>
        <span class="hljs-comment">//使用数组是为了在lambda表达式中能够修改变量</span>
        StringBuilder[] builder = {<span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuilder</span>()};

        <span class="hljs-comment">//构建包含上下文的AI请求并返回流式响应</span>
        Flux&lt;String&gt; stream = chatClient.prompt(<span class="hljs-string">"你是ai助手小黑"</span>).user( message).messages( messages).stream().content();
        <span class="hljs-keyword">return</span>  stream.doOnNext(s -&gt; builder[<span class="hljs-number">0</span>].append(s)) <span class="hljs-comment">//当AI返回每个片段时，将其追加到builder中进行累积</span>
                .doOnComplete(() -&gt; {
                    <span class="hljs-type">History</span> <span class="hljs-variable">aihistory</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">History</span>();
                    aihistory.setId(<span class="hljs-literal">null</span>);
                    aihistory.setDatetime(LocalDateTime.now());
                    aihistory.setRole(<span class="hljs-string">"assistant"</span>);
                    aihistory.setContent(builder[<span class="hljs-number">0</span>].toString());
                    aihistory.setSessionId(sessionId);
                    historyService.save(aihistory);
                });
        <span class="hljs-comment">/*
        当AI流式回复完成后，执行以下操作：
        创建新的历史记录对象
        设置时间戳
        设置角色为"assistant"
        将累积的完整回复内容保存
        设置会话ID
        保存到数据库
        这种方式确保了只有在AI完全生成回复后，才会将其保存到历史记录中，同时保持了流式响应的实时性*/</span>
    }
}
</code></pre>
<h2 data-id="heading-7">06-语义向量化、向量数据库、RAG的概念</h2>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e243d5d55b42430fb96499a218aa2fbd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgZGV2bG9naXgwMQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769227766&amp;x-signature=xIm672r%2F7cPLR6YDpRUqTuZhokk%3D" alt="image.png" loading="lazy"/></p>
<h4 data-id="heading-8">1 RAG 检索增强生成 Retrieval Augmented Generated</h4>
<p>文本读取 - 文本分割 - 转向量化 - 存向量数据库
用户问题 - 向量化 - 检索相关内容 - 构造prompt - 大模型生成答案</p>
<h2 data-id="heading-9">07-SpringAI实现语义向量化</h2>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.spring.io%2Fspring-ai%2Freference%2Fapi%2Fembeddings.html" target="_blank" title="https://docs.spring.io/spring-ai/reference/api/embeddings.html" ref="nofollow noopener noreferrer">docs.spring.io/spring-ai/r…</a></p>
<p>导入的依赖</p>
<pre><code class="hljs language-java" lang="java">        &lt;dependency&gt;
            &lt;groupId&gt;com.alibaba.cloud.ai&lt;/groupId&gt;
            &lt;artifactId&gt;spring-ai-alibaba-starter-dashscope&lt;/artifactId&gt;
        &lt;/dependency&gt;
    &lt;dependencyManagement&gt;
        &lt;dependencies&gt;
            &lt;dependency&gt;
                &lt;groupId&gt;com.alibaba.cloud.ai&lt;/groupId&gt;
                &lt;artifactId&gt;spring-ai-alibaba-bom&lt;/artifactId&gt;
                &lt;version&gt;<span class="hljs-number">1.0</span><span class="hljs-number">.0</span><span class="hljs-number">.2</span>&lt;/version&gt;
                &lt;type&gt;pom&lt;/type&gt;
                &lt;scope&gt;<span class="hljs-keyword">import</span>&lt;/scope&gt;
            &lt;/dependency&gt;
    &lt;/dependencyManagement&gt;
</code></pre>
<p>配置示例</p>
<pre><code class="hljs language-yml" lang="yml">    <span class="hljs-attr">ollama:</span>
      <span class="hljs-attr">chat:</span>
        <span class="hljs-attr">model:</span> <span class="hljs-string">deepseek-r1:8b</span>
      <span class="hljs-attr">embedding:</span>
        <span class="hljs-attr">enabled:</span> <span class="hljs-literal">false</span>
    <span class="hljs-attr">dashscope:</span>
      <span class="hljs-attr">api-key:</span> 
      <span class="hljs-attr">embedding:</span>
        <span class="hljs-attr">enabled:</span> <span class="hljs-literal">true</span>
        <span class="hljs-attr">options:</span>
          <span class="hljs-attr">model:</span> <span class="hljs-string">text-embedding-v4</span>
</code></pre>
<p>示例方法</p>
<pre><code class="hljs language-java" lang="java">   <span class="hljs-meta">@GetMapping("/ai/embedding")</span>
    <span class="hljs-keyword">public</span> Map <span class="hljs-title function_">embed</span><span class="hljs-params">(<span class="hljs-meta">@RequestParam(value = "message", defaultValue = "Tell me a joke")</span> String message)</span> {
        <span class="hljs-type">EmbeddingResponse</span> <span class="hljs-variable">embeddingResponse</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.embeddingModel.embedForResponse(List.of(message));
        <span class="hljs-keyword">return</span> Map.of(<span class="hljs-string">"embedding"</span>, embeddingResponse);
    }
</code></pre>
<h2 data-id="heading-10">08-SpringAI实现文本分割</h2>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.spring.io%2Fspring-ai%2Freference%2Fapi%2Fetl-pipeline.html" target="_blank" title="https://docs.spring.io/spring-ai/reference/api/etl-pipeline.html" ref="nofollow noopener noreferrer">docs.spring.io/spring-ai/r…</a></p>
<p>因为在日常工作的过程中, 文本都是以文档的形式进行存储的, 常见的文档格式有 txt 文件、markdown 文件、pdf 文件, 需要把这个文档给读出来, 读出来文档以后才能进行分割, SpringAI 给我们定义了文本读取的规范规范接口, 同时给我们提供了很多类型的文本阅读工具 , 例如 JSON 类型的、txt 类型的、MarkDown 类型的、PDF 类型等</p>
<p>PDF 的有两种读取方式</p>
<p>一种是按页读取</p>
<p>另外一种是按章节读取</p>
<p>他们都是按照 SpringAI 的接口进行实现，特别的规范</p>
<p>1 添加依赖</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.ai<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-ai-pdf-document-reader<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
</code></pre>
<p>2 测试方法</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Test</span>
<span class="hljs-keyword">void</span> <span class="hljs-title function_">testPdf</span><span class="hljs-params">()</span>{
    <span class="hljs-type">PagePdfDocumentReader</span> <span class="hljs-variable">pdfReader</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">PagePdfDocumentReader</span>(<span class="hljs-string">"classpath:/阿里巴巴Java开发手册(终极版).pdf"</span>,
            PdfDocumentReaderConfig.builder()
                    .withPageTopMargin(<span class="hljs-number">0</span>)
                    .withPageExtractedTextFormatter(ExtractedTextFormatter.builder()
                            .withNumberOfTopTextLinesToDelete(<span class="hljs-number">0</span>)
                            .build())
                    .withPagesPerDocument(<span class="hljs-number">1</span>)
                    .build());
    System.out.println( pdfReader.read().size());
}
</code></pre>
<p>3 按Token进行分割</p>
<pre><code class="hljs language-java" lang="java">
<span class="hljs-meta">@Test</span>
<span class="hljs-keyword">void</span> <span class="hljs-title function_">testPdf</span><span class="hljs-params">()</span>{
    <span class="hljs-type">PagePdfDocumentReader</span> <span class="hljs-variable">pdfReader</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">PagePdfDocumentReader</span>(<span class="hljs-string">"classpath:/阿里巴巴Java开发手册(终极版).pdf"</span>,
            PdfDocumentReaderConfig.builder()
                    .withPageTopMargin(<span class="hljs-number">0</span>)
                    .withPageExtractedTextFormatter(ExtractedTextFormatter.builder()
                            .withNumberOfTopTextLinesToDelete(<span class="hljs-number">0</span>)
                            .build())
                    .withPagesPerDocument(<span class="hljs-number">1</span>)
                    .build());


    <span class="hljs-type">TokenTextSplitter</span> <span class="hljs-variable">splitter</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TokenTextSplitter</span>(<span class="hljs-number">1000</span>, <span class="hljs-number">400</span>, <span class="hljs-number">10</span>, <span class="hljs-number">100000</span>, <span class="hljs-literal">true</span>);
    splitter.apply(pdfReader.read()).forEach(document -&gt; {
    System.out.printf(Arrays.toString(embeddingModel.embed(document)));
    });
}
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/011678f6ada64f0894d60f4e9ced7589~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgZGV2bG9naXgwMQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769227766&amp;x-signature=gMU%2FUqM14enbAfdbdM7w6gAAmGU%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-11">09-SpringAI实现向量数据库的存储</h2>
<p>1 docker 配置</p>
<p>维度选择 1024 保持一致
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b5ede2e0d01443c78ee84e308589fa7b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgZGV2bG9naXgwMQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769227766&amp;x-signature=KqCKGEWr3UfTMMlKBcpUzgyAlqc%3D" alt="image.png" loading="lazy"/></p>
<p>2 依赖</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.ai<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-ai-starter-vector-store-qdrant<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
</code></pre>
<pre><code class="hljs language-yml" lang="yml"><span class="hljs-attr">spring:</span>
  <span class="hljs-attr">ai:</span>
    <span class="hljs-attr">vectorstore:</span>
      <span class="hljs-attr">qdrant:</span>
        <span class="hljs-attr">host:</span> <span class="hljs-string">localhost</span>
        <span class="hljs-attr">port:</span> <span class="hljs-number">6334</span>
        <span class="hljs-attr">collection-name:</span> <span class="hljs-string">vector_store</span>
</code></pre>
<h2 data-id="heading-12">10-SpringAI实现检索增强</h2>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> org.example.springaidemo.controller;


<span class="hljs-keyword">import</span> com.baomidou.mybatisplus.core.conditions.query.LambdaQueryWrapper;
<span class="hljs-keyword">import</span> jakarta.annotation.Resource;
<span class="hljs-keyword">import</span> org.example.springaidemo.entity.History;
<span class="hljs-keyword">import</span> org.example.springaidemo.service.HistoryService;
<span class="hljs-keyword">import</span> org.springframework.ai.chat.client.ChatClient;
<span class="hljs-keyword">import</span> org.springframework.ai.chat.messages.AssistantMessage;
<span class="hljs-keyword">import</span> org.springframework.ai.chat.messages.Message;
<span class="hljs-keyword">import</span> org.springframework.ai.chat.messages.UserMessage;
<span class="hljs-keyword">import</span> org.springframework.ai.deepseek.DeepSeekChatModel;
<span class="hljs-keyword">import</span> org.springframework.ai.document.Document;
<span class="hljs-keyword">import</span> org.springframework.ai.embedding.EmbeddingModel;
<span class="hljs-keyword">import</span> org.springframework.ai.embedding.EmbeddingResponse;
<span class="hljs-keyword">import</span> org.springframework.ai.vectorstore.VectorStore;
<span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;
<span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.GetMapping;
<span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.RequestParam;
<span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.RestController;
<span class="hljs-keyword">import</span> reactor.core.publisher.Flux;

<span class="hljs-keyword">import</span> java.time.LocalDateTime;
<span class="hljs-keyword">import</span> java.util.List;
<span class="hljs-keyword">import</span> java.util.Map;
<span class="hljs-keyword">import</span> java.util.stream.Collectors;

<span class="hljs-meta">@RestController</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ChatController</span> {
    <span class="hljs-comment">//依赖注入</span>
    <span class="hljs-meta">@Resource</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> DeepSeekChatModel chatModel;
    <span class="hljs-meta">@Resource</span>
    <span class="hljs-keyword">private</span> ChatClient chatClient;
    <span class="hljs-meta">@Resource</span>
    <span class="hljs-keyword">private</span> HistoryService historyService;
    <span class="hljs-meta">@Resource</span>
    <span class="hljs-keyword">private</span> EmbeddingModel embeddingModel;
    <span class="hljs-meta">@Resource</span>
    <span class="hljs-keyword">private</span> VectorStore vectorStore;


    <span class="hljs-comment">//构造函数注入</span>
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title function_">ChatController</span><span class="hljs-params">(DeepSeekChatModel chatModel)</span> {
        <span class="hljs-built_in">this</span>.chatModel = chatModel;
    }

    <span class="hljs-comment">/*
    * HTTP GET端点：/ai/generate
    接收用户消息参数，默认值为"Tell me a joke"
    返回AI助手"小黑"对用户消息的同步响应内容
    * */</span>
    <span class="hljs-meta">@GetMapping("/ai/generate")</span>
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">generate</span><span class="hljs-params">(<span class="hljs-meta">@RequestParam(value = "message", defaultValue = "Tell me a joke")</span> String message)</span> {
        <span class="hljs-keyword">return</span>  chatClient.prompt(<span class="hljs-string">"你是ai助手小黑"</span>).user( message).call().content();

    }

    <span class="hljs-meta">@GetMapping(value = "/ai/generateStream", produces = "text/html; charset=UTF-8")</span>
    <span class="hljs-keyword">public</span> Flux&lt;String&gt; <span class="hljs-title function_">generateStream</span><span class="hljs-params">(<span class="hljs-meta">@RequestParam(value = "message", defaultValue = "Tell me a joke")</span> String message,
                                       <span class="hljs-meta">@RequestParam(value = "sessionId", defaultValue = " 1 ")</span> <span class="hljs-type">long</span> sessionId
                                       )</span> {

        List&lt;Document&gt; documentList = vectorStore.similaritySearch(message);
        <span class="hljs-type">StringBuilder</span> <span class="hljs-variable">contextBuilder</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuilder</span>();
        documentList.forEach(document -&gt; contextBuilder.append(document).append(<span class="hljs-string">"\n"</span>));
        <span class="hljs-type">String</span> <span class="hljs-variable">prompt</span>  <span class="hljs-operator">=</span> <span class="hljs-string">"你是编程助手小红 , 以下是本次会话传递的信息"</span>+contextBuilder.toString()+
                <span class="hljs-string">"/n 请根据以上信息，回答用户的问题："</span>+message;
        <span class="hljs-comment">//用户消息保存</span>
        <span class="hljs-type">History</span> <span class="hljs-variable">userhistory</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">History</span>();
        userhistory.setDatetime(LocalDateTime.now());
        userhistory.setRole(<span class="hljs-string">"user"</span>);
        userhistory.setContent(message);
        userhistory.setSessionId(sessionId);
        historyService.save(userhistory); <span class="hljs-comment">//创建并保存用户发送的消息到数据库</span>

        <span class="hljs-comment">//获取历史对话</span>
        <span class="hljs-comment">//查询指定会话ID的所有历史记录</span>
        <span class="hljs-comment">//排除刚刚保存的当前用户消息（避免重复）</span>
        List&lt;History&gt; histories = historyService.list(
                <span class="hljs-keyword">new</span> <span class="hljs-title class_">LambdaQueryWrapper</span>&lt;History&gt;().eq(History::getSessionId, sessionId).ne(History::getId , userhistory.getId())
        ) ;

        <span class="hljs-comment">//转换历史消息格式: 将历史记录转换为AI模型能理解的消息格式</span>
        List&lt;Message&gt; messages = histories.stream().map(history -&gt;
                <span class="hljs-string">"user"</span>.equals(history.getRole())?<span class="hljs-keyword">new</span> <span class="hljs-title class_">UserMessage</span>(history.getContent()):<span class="hljs-keyword">new</span> <span class="hljs-title class_">AssistantMessage</span>(history.getContent())).collect(Collectors.toList());

        <span class="hljs-comment">//数组 用来累积AI流式回复内容</span>
        <span class="hljs-comment">//使用数组是为了在lambda表达式中能够修改变量</span>
        StringBuilder[] builder = {<span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuilder</span>()};

        <span class="hljs-comment">//构建包含上下文的AI请求并返回流式响应</span>
        Flux&lt;String&gt; stream = chatClient.prompt(prompt).user( message).messages( messages).stream().content();
        <span class="hljs-keyword">return</span>  stream.doOnNext(s -&gt; builder[<span class="hljs-number">0</span>].append(s)) <span class="hljs-comment">//当AI返回每个片段时，将其追加到builder中进行累积</span>
                .doOnComplete(() -&gt; {
                    <span class="hljs-type">History</span> <span class="hljs-variable">aihistory</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">History</span>();
                    aihistory.setId(<span class="hljs-literal">null</span>);
                    aihistory.setDatetime(LocalDateTime.now());
                    aihistory.setRole(<span class="hljs-string">"assistant"</span>);
                    aihistory.setContent(builder[<span class="hljs-number">0</span>].toString());
                    aihistory.setSessionId(sessionId);
                    historyService.save(aihistory);
                });
        <span class="hljs-comment">/*
        当AI流式回复完成后，执行以下操作：
        创建新的历史记录对象
        设置时间戳
        设置角色为"assistant"
        将累积的完整回复内容保存
        设置会话ID
        保存到数据库
        这种方式确保了只有在AI完全生成回复后，才会将其保存到历史记录中，同时保持了流式响应的实时性*/</span>
    }

    <span class="hljs-meta">@GetMapping("/ai/embedding")</span>
    <span class="hljs-keyword">public</span> Map <span class="hljs-title function_">embed</span><span class="hljs-params">(<span class="hljs-meta">@RequestParam(value = "message", defaultValue = "Tell me a joke")</span> String message)</span> {
        <span class="hljs-type">EmbeddingResponse</span> <span class="hljs-variable">embeddingResponse</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.embeddingModel.embedForResponse(List.of(message));
        <span class="hljs-keyword">return</span> Map.of(<span class="hljs-string">"embedding"</span>, embeddingResponse);
    }
}
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item>  </channel></rss>