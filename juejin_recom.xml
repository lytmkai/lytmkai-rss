<?xml version="1.0" encoding="UTF-8"?><rss version="2.0">  <channel>      <title>掘金文章推荐</title>      <link>https://juejin.cn/recommended?sort=newest</link>      <description>一个帮助开发者成长的社区</description>      <generator>python juejin_recom.py @Pi20</generator>      <item>    <title><![CDATA[Vue 3中何时用watch，何时用watchEffect？核心区别及性能优化策略是什么？]]></title>    <link>https://juejin.cn/post/7600489282823241778</link>    <guid>https://juejin.cn/post/7600489282823241778</guid>    <pubDate>2026-01-29T06:26:47.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600489282823241778" data-draft-id="7600370554069139482" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Vue 3中何时用watch，何时用watchEffect？核心区别及性能优化策略是什么？    "/> <meta itemprop="keywords" content="前端,Vue.js,Trae"/> <meta itemprop="datePublished" content="2026-01-29T06:26:47.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="kknone"/> <meta itemprop="url" content="https://juejin.cn/user/1366025597879930"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Vue 3中何时用watch，何时用watchEffect？核心区别及性能优化策略是什么？    
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1366025597879930/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    kknone
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-29T06:26:47.000Z" title="Thu Jan 29 2026 06:26:47 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读17分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一、watch 基本概念与用法</h2>
<h3 data-id="heading-1">1.1 核心概念</h3>
<p>watch 是 Vue 3 中用于监听特定数据源变化并执行副作用的 API。它默认是惰性的，只有当监听的源发生变化时才会触发回调函数。这使得 watch 非常适合处理那些需要在特定状态变化时执行的异步操作或复杂逻辑。</p>
<h3 data-id="heading-2">1.2 基本用法示例</h3>
<h4 data-id="heading-3">Options API 方式</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-title function_">data</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> {
      <span class="hljs-attr">question</span>: <span class="hljs-string">''</span>,
      <span class="hljs-attr">answer</span>: <span class="hljs-string">'Questions usually contain a question mark. ;-)'</span>,
      <span class="hljs-attr">loading</span>: <span class="hljs-literal">false</span>
    }
  },
  <span class="hljs-attr">watch</span>: {
    <span class="hljs-comment">// 当 question 变化时，执行此函数</span>
    <span class="hljs-title function_">question</span>(<span class="hljs-params">newQuestion, oldQuestion</span>) {
      <span class="hljs-keyword">if</span> (newQuestion.<span class="hljs-title function_">includes</span>(<span class="hljs-string">'?'</span>)) {
        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getAnswer</span>()
      }
    }
  },
  <span class="hljs-attr">methods</span>: {
    <span class="hljs-keyword">async</span> <span class="hljs-title function_">getAnswer</span>(<span class="hljs-params"/>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">loading</span> = <span class="hljs-literal">true</span>
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">answer</span> = <span class="hljs-string">'Thinking...'</span>
      <span class="hljs-keyword">try</span> {
        <span class="hljs-keyword">const</span> res = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetch</span>(<span class="hljs-string">'https://yesno.wtf/api'</span>)
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">answer</span> = (<span class="hljs-keyword">await</span> res.<span class="hljs-title function_">json</span>()).<span class="hljs-property">answer</span>
      } <span class="hljs-keyword">catch</span> (error) {
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">answer</span> = <span class="hljs-string">'Error! Could not reach the API. '</span> + error
      } <span class="hljs-keyword">finally</span> {
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">loading</span> = <span class="hljs-literal">false</span>
      }
    }
  }
}
</code></pre>
<h4 data-id="heading-4">Composition API 方式</h4>
<pre><code class="hljs language-vue" lang="vue">&lt;script setup&gt;
import { ref, watch } from 'vue'

const question = ref('')
const answer = ref('Questions usually contain a question mark. ;-)')
const loading = ref(false)

// 直接监听 ref
watch(question, async (newQuestion, oldQuestion) =&gt; {
  if (newQuestion.includes('?')) {
    loading.value = true
    answer.value = 'Thinking...'
    try {
      const res = await fetch('https://yesno.wtf/api')
      answer.value = (await res.json()).answer
    } catch (error) {
      answer.value = 'Error! Could not reach the API. ' + error
    } finally {
      loading.value = false
    }
  }
})
&lt;/script&gt;

&lt;template&gt;
  &lt;p&gt;
    Ask a yes/no question:
    &lt;input v-model="question" :disabled="loading" /&gt;
  &lt;/p&gt;
  &lt;p&gt;{{ answer }}&lt;/p&gt;
&lt;/template&gt;
</code></pre>
<h3 data-id="heading-5">1.3 高级用法</h3>
<h4 data-id="heading-6">监听嵌套属性</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// Options API</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-attr">watch</span>: {
    <span class="hljs-string">'some.nested.key'</span>(newValue) {
      <span class="hljs-comment">// 当嵌套属性变化时触发</span>
    }
  }
}

<span class="hljs-comment">// Composition API</span>
<span class="hljs-keyword">const</span> obj = <span class="hljs-title function_">reactive</span>({ <span class="hljs-attr">some</span>: { <span class="hljs-attr">nested</span>: { <span class="hljs-attr">key</span>: <span class="hljs-number">0</span> } } })
<span class="hljs-title function_">watch</span>(
  <span class="hljs-function">() =&gt;</span> obj.<span class="hljs-property">some</span>.<span class="hljs-property">nested</span>.<span class="hljs-property">key</span>,
  <span class="hljs-function">(<span class="hljs-params">newValue</span>) =&gt;</span> {
    <span class="hljs-comment">// 当嵌套属性变化时触发</span>
  }
)
</code></pre>
<h4 data-id="heading-7">深度监听</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// Options API</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-attr">watch</span>: {
    <span class="hljs-attr">someObject</span>: {
      <span class="hljs-title function_">handler</span>(<span class="hljs-params">newValue, oldValue</span>) {
        <span class="hljs-comment">// 监听对象的所有嵌套属性变化</span>
      },
      <span class="hljs-attr">deep</span>: <span class="hljs-literal">true</span>
    }
  }
}

<span class="hljs-comment">// Composition API</span>
<span class="hljs-keyword">const</span> obj = <span class="hljs-title function_">reactive</span>({ <span class="hljs-attr">count</span>: <span class="hljs-number">0</span> })
<span class="hljs-comment">// 直接监听 reactive 对象会自动创建深度监听</span>
<span class="hljs-title function_">watch</span>(obj, <span class="hljs-function">(<span class="hljs-params">newValue, oldValue</span>) =&gt;</span> {
  <span class="hljs-comment">// 当对象的任何嵌套属性变化时触发</span>
})
</code></pre>
<h4 data-id="heading-8">立即执行</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// Options API</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-attr">watch</span>: {
    <span class="hljs-attr">question</span>: {
      <span class="hljs-title function_">handler</span>(<span class="hljs-params">newQuestion</span>) {
        <span class="hljs-comment">// 组件创建时立即执行一次</span>
      },
      <span class="hljs-attr">immediate</span>: <span class="hljs-literal">true</span>
    }
  }
}

<span class="hljs-comment">// Composition API</span>
<span class="hljs-title function_">watch</span>(
  question,
  <span class="hljs-function">(<span class="hljs-params">newQuestion</span>) =&gt;</span> {
    <span class="hljs-comment">// 组件创建时立即执行一次</span>
  },
  { <span class="hljs-attr">immediate</span>: <span class="hljs-literal">true</span> }
)
</code></pre>
<h2 data-id="heading-9">二、watchEffect 基本概念与用法</h2>
<h3 data-id="heading-10">2.1 核心概念</h3>
<p>watchEffect 是 Vue 3 中另一个强大的侦听器 API，它会自动收集回调函数中的依赖，并在依赖发生变化时重新执行回调。与 watch 不同，watchEffect 会在组件创建时立即执行一次，然后在依赖变化时再次执行。</p>
<h3 data-id="heading-11">2.2 基本用法示例</h3>
<pre><code class="hljs language-vue" lang="vue">&lt;script setup&gt;
import { ref, watchEffect } from 'vue'

const todoId = ref(1)
const data = ref(null)

// 自动收集 todoId.value 作为依赖
watchEffect(async () =&gt; {
  const response = await fetch(
    `https://jsonplaceholder.typicode.com/todos/${todoId.value}`
  )
  data.value = await response.json()
})
&lt;/script&gt;
</code></pre>
<h3 data-id="heading-12">2.3 高级用法</h3>
<h4 data-id="heading-13">副作用清理</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-title function_">watchEffect</span>(<span class="hljs-function">(<span class="hljs-params">onCleanup</span>) =&gt;</span> {
  <span class="hljs-keyword">const</span> controller = <span class="hljs-keyword">new</span> <span class="hljs-title class_">AbortController</span>()
  
  <span class="hljs-title function_">fetch</span>(<span class="hljs-string">`/api/<span class="hljs-subst">${id.value}</span>`</span>, { <span class="hljs-attr">signal</span>: controller.<span class="hljs-property">signal</span> })
    .<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">response</span> =&gt;</span> response.<span class="hljs-title function_">json</span>())
    .<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">data</span> =&gt;</span> {
      <span class="hljs-comment">// 处理数据</span>
    })
  
  <span class="hljs-comment">// 当依赖变化时，先执行清理函数</span>
  <span class="hljs-title function_">onCleanup</span>(<span class="hljs-function">() =&gt;</span> {
    controller.<span class="hljs-title function_">abort</span>()
  })
})
</code></pre>
<h4 data-id="heading-14">调整执行时机</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 默认：在组件更新前执行</span>
<span class="hljs-title function_">watchEffect</span>(<span class="hljs-function">() =&gt;</span> {})

<span class="hljs-comment">// 在组件更新后执行</span>
<span class="hljs-title function_">watchEffect</span>(<span class="hljs-function">() =&gt;</span> {}, { <span class="hljs-attr">flush</span>: <span class="hljs-string">'post'</span> })
<span class="hljs-comment">// 或使用别名</span>
<span class="hljs-title function_">watchPostEffect</span>(<span class="hljs-function">() =&gt;</span> {})

<span class="hljs-comment">// 同步执行，不进行批处理</span>
<span class="hljs-title function_">watchEffect</span>(<span class="hljs-function">() =&gt;</span> {}, { <span class="hljs-attr">flush</span>: <span class="hljs-string">'sync'</span> })
<span class="hljs-comment">// 或使用别名</span>
<span class="hljs-title function_">watchSyncEffect</span>(<span class="hljs-function">() =&gt;</span> {})
</code></pre>
<h2 data-id="heading-15">三、watch 与 watchEffect 对比选型</h2>
<h3 data-id="heading-16">3.1 核心区别对比</h3>






























<table><thead><tr><th>特性</th><th>watch</th><th>watchEffect</th></tr></thead><tbody><tr><td><strong>依赖追踪</strong></td><td>手动指定监听源</td><td>自动收集回调中的依赖</td></tr><tr><td><strong>执行时机</strong></td><td>惰性执行，仅在源变化时触发</td><td>立即执行，然后在依赖变化时触发</td></tr><tr><td><strong>参数获取</strong></td><td>可以获取新旧值</td><td>无法直接获取新旧值</td></tr><tr><td><strong>使用场景</strong></td><td>监听特定数据源，需要获取新旧值</td><td>监听多个依赖，不需要关心具体哪个依赖变化</td></tr></tbody></table>
<h3 data-id="heading-17">3.2 工作流程对比</h3>
<pre><code class="hljs language-mermaid" lang="mermaid">flowchart TD
    A[组件创建] --&gt; B{使用 watch?}
    B --&gt;|是| C[指定监听源]
    C --&gt; D{源变化?}
    D --&gt;|是| E[执行回调，获取新旧值]
    D --&gt;|否| F[等待源变化]
    
    A --&gt; G{使用 watchEffect?}
    G --&gt;|是| H[执行回调，自动收集依赖]
    H --&gt; I{依赖变化?}
    I --&gt;|是| J[先执行清理函数]
    J --&gt; H
    I --&gt;|否| K[等待依赖变化]
</code></pre>
<h3 data-id="heading-18">3.3 选型建议</h3>
<ol>
<li>
<p><strong>使用 watch 的场景</strong>：</p>
<ul>
<li>需要监听特定的数据源变化</li>
<li>需要获取变化前后的具体值</li>
<li>需要执行惰性操作（仅在源变化时执行）</li>
<li>需要深度监听或立即执行等高级配置</li>
</ul>
</li>
<li>
<p><strong>使用 watchEffect 的场景</strong>：</p>
<ul>
<li>需要监听多个依赖，且不关心具体哪个依赖变化</li>
<li>需要在组件创建时立即执行一次</li>
<li>需要自动管理依赖，减少代码维护成本</li>
<li>处理异步操作时需要自动清理副作用</li>
</ul>
</li>
</ol>
<h2 data-id="heading-19">四、性能优化技巧</h2>
<h3 data-id="heading-20">4.1 避免不必要的监听</h3>
<ul>
<li>只监听实际需要的数据源，避免监听整个大对象</li>
<li>使用 getter 函数监听嵌套属性，而不是使用 deep 选项</li>
<li>对于不需要深度监听的对象，避免使用 deep: true</li>
</ul>
<h3 data-id="heading-21">4.2 合理使用清理函数</h3>
<ul>
<li>在处理异步操作时，务必使用清理函数取消未完成的请求</li>
<li>避免内存泄漏，及时清理定时器、事件监听器等资源</li>
</ul>
<h3 data-id="heading-22">4.3 优化执行时机</h3>
<ul>
<li>根据实际需求选择合适的 flush 选项</li>
<li>对于不需要立即执行的操作，使用默认的 pre 时机</li>
<li>对于需要访问更新后 DOM 的操作，使用 post 时机</li>
</ul>
<h3 data-id="heading-23">4.4 避免在侦听器中执行昂贵操作</h3>
<ul>
<li>将复杂计算逻辑提取到计算属性中</li>
<li>对于需要频繁执行的操作，考虑使用防抖或节流</li>
</ul>
<h2 data-id="heading-24">五、课后 Quiz</h2>
<h3 data-id="heading-25">问题 1：</h3>
<p>在 Vue 3 中，watch 和 watchEffect 的主要区别是什么？请至少列举 3 点。</p>
<p><strong>答案解析：</strong></p>
<ol>
<li><strong>依赖追踪方式</strong>：watch 需要手动指定监听源，而 watchEffect 会自动收集回调中的依赖。</li>
<li><strong>执行时机</strong>：watch 默认是惰性的，只有当监听源变化时才会触发；而 watchEffect 会在组件创建时立即执行一次，然后在依赖变化时再次执行。</li>
</ol>
<details>
<summary>往期文章归档</summary>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F09551ab614c463a6d6ca69818e8c2d52%2F" target="_blank" title="https://blog.cmdragon.cn/posts/09551ab614c463a6d6ca69818e8c2d52/" ref="nofollow noopener noreferrer">Vue 3中如何有效管理侦听器的暂停、恢复与副作用清理？</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fb7bca5d20f628ac09f7192ad935ef664%2F" target="_blank" title="https://blog.cmdragon.cn/posts/b7bca5d20f628ac09f7192ad935ef664/" ref="nofollow noopener noreferrer">Vue 3 watchEffect：如何实现响应式依赖的自动追踪与副作用管理？</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F2c6cdb100a20f10c7e7d4413617c7ea9%2F" target="_blank" title="https://blog.cmdragon.cn/posts/2c6cdb100a20f10c7e7d4413617c7ea9/" ref="nofollow noopener noreferrer">Vue 3 watch如何利用immediate、once、deep选项实现初始化、一次性与深度监听？</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F757a1728bc1b9c0c8b317b0354d85568%2F" target="_blank" title="https://blog.cmdragon.cn/posts/757a1728bc1b9c0c8b317b0354d85568/" ref="nofollow noopener noreferrer">Vue 3中watch如何高效监听多数据源、计算结果与数组变化？</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F8e70552f0f61e0dc8c7f567a2d272345%2F" target="_blank" title="https://blog.cmdragon.cn/posts/8e70552f0f61e0dc8c7f567a2d272345/" ref="nofollow noopener noreferrer">Vue 3中watch监听ref和reactive的核心差异与注意事项是什么？</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fdde70ab90dc5062c435e0501f5a6e7cb%2F" target="_blank" title="https://blog.cmdragon.cn/posts/dde70ab90dc5062c435e0501f5a6e7cb/" ref="nofollow noopener noreferrer">Vue3中Watch与watchEffect的核心差异及适用场景是什么？</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F1f5ed5047850ed52c0fd0386f76bd4ae%2F" target="_blank" title="https://blog.cmdragon.cn/posts/1f5ed5047850ed52c0fd0386f76bd4ae/" ref="nofollow noopener noreferrer">Vue 3自定义指令如何赋能表单自动聚焦与防抖输入的高效实现？</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fe3d4e128815ad731611b8ef29e37616b%2F" target="_blank" title="https://blog.cmdragon.cn/posts/e3d4e128815ad731611b8ef29e37616b/" ref="nofollow noopener noreferrer">Vue3中如何优雅实现支持多绑定变量和修饰符的双向绑定组件？</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F7d1caedd822f70542aa0eed67e30963b%2F" target="_blank" title="https://blog.cmdragon.cn/posts/7d1caedd822f70542aa0eed67e30963b/" ref="nofollow noopener noreferrer">Vue 3表单验证如何从基础规则到异步交互构建完整验证体系？</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F3687a5437ab56cb082b5b813d5577a40%2F" target="_blank" title="https://blog.cmdragon.cn/posts/3687a5437ab56cb082b5b813d5577a40/" ref="nofollow noopener noreferrer">Vue3响应式系统如何支撑表单数据的集中管理、动态扩展与实时计算？</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fad67c4eb6d76cf7707bdfe6a8146c34f%2F" target="_blank" title="https://blog.cmdragon.cn/posts/ad67c4eb6d76cf7707bdfe6a8146c34f/" ref="nofollow noopener noreferrer">Vue3跨组件通信中，全局事件总线与provide/inject该如何正确选择？</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F1c1e80d697cca0923f29ec70ebb8ccd1%2F" target="_blank" title="https://blog.cmdragon.cn/posts/1c1e80d697cca0923f29ec70ebb8ccd1/" ref="nofollow noopener noreferrer">Vue3表单事件处理：v-model如何实现数据绑定、验证与提交？</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fb990828143d70aa87f9aa52e16692e48%2F" target="_blank" title="https://blog.cmdragon.cn/posts/b990828143d70aa87f9aa52e16692e48/" ref="nofollow noopener noreferrer">Vue应用如何基于DOM事件传播机制与事件修饰符实现高效事件处理？</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fb44316e0866e9f2e6aef927dbcf5152b%2F" target="_blank" title="https://blog.cmdragon.cn/posts/b44316e0866e9f2e6aef927dbcf5152b/" ref="nofollow noopener noreferrer">Vue3中如何在调用事件处理函数时同时传递自定义参数和原生DOM事件？参数顺序有哪些注意事项？</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F021636c2a06f5e2d3d01977a12ddf559%2F" target="_blank" title="https://blog.cmdragon.cn/posts/021636c2a06f5e2d3d01977a12ddf559/" ref="nofollow noopener noreferrer">从捕获到冒泡：Vue事件修饰符如何重塑事件执行顺序？</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fb3cddf7023ab537e623a61bc01dab6bb%2F" target="_blank" title="https://blog.cmdragon.cn/posts/b3cddf7023ab537e623a61bc01dab6bb/" ref="nofollow noopener noreferrer">Vue事件处理：内联还是方法事件处理器，该如何抉择？</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fbd4d9607ce1bc34cc3bda0a1a46c40f6%2F" target="_blank" title="https://blog.cmdragon.cn/posts/bd4d9607ce1bc34cc3bda0a1a46c40f6/" ref="nofollow noopener noreferrer">Vue事件绑定中v-on与@语法如何取舍？参数传递与原生事件处理有哪些实战技巧？</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fa5f2bacb74476fd7f5e02bb3f1ba6b2b%2F" target="_blank" title="https://blog.cmdragon.cn/posts/a5f2bacb74476fd7f5e02bb3f1ba6b2b/" ref="nofollow noopener noreferrer">Vue 3中列表排序时为何必须复制数组而非直接修改原始数据？</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fd3b06b57fb7f126787e6ed22dce1e341%2F" target="_blank" title="https://blog.cmdragon.cn/posts/d3b06b57fb7f126787e6ed22dce1e341/" ref="nofollow noopener noreferrer">Vue虚拟滚动如何将列表DOM数量从万级降至十位数？</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F3100cc5a2e16f8dac36f722594e6af32%2F" target="_blank" title="https://blog.cmdragon.cn/posts/3100cc5a2e16f8dac36f722594e6af32/" ref="nofollow noopener noreferrer">Vue3中v-if与v-for直接混用为何会报错？计算属性如何解决优先级冲突？</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F455dc2d47c38d12c1cf350e490041e8b%2F" target="_blank" title="https://blog.cmdragon.cn/posts/455dc2d47c38d12c1cf350e490041e8b/" ref="nofollow noopener noreferrer">为何在Vue3递归组件中必须用v-if判断子项存在？</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F3f842bbd7ba0f9c91151b983bf784c8b%2F" target="_blank" title="https://blog.cmdragon.cn/posts/3f842bbd7ba0f9c91151b983bf784c8b/" ref="nofollow noopener noreferrer">Vue3列表渲染中，如何用数组方法与计算属性优化v-for的数据处理？</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F1eb3ffac668a743843b5ea1738301d40%2F" target="_blank" title="https://blog.cmdragon.cn/posts/1eb3ffac668a743843b5ea1738301d40/" ref="nofollow noopener noreferrer">Vue v-for的key：为什么它能解决列表渲染中的“玄学错误”？选错会有哪些后果？</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F138b13c5341f6a1fa9015400433a3611%2F" target="_blank" title="https://blog.cmdragon.cn/posts/138b13c5341f6a1fa9015400433a3611/" ref="nofollow noopener noreferrer">Vue3中v-for与v-if为何不能直接共存于同一元素？</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F0242a94dc552b93a1bc335ac4fc33db5%2F" target="_blank" title="https://blog.cmdragon.cn/posts/0242a94dc552b93a1bc335ac4fc33db5/" ref="nofollow noopener noreferrer">Vue3中v-if与v-show的本质区别及动态组件状态保持的关键策略是什么？</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F97c66a18ae0e9b57c6a69b8b3a41ddf6%2F" target="_blank" title="https://blog.cmdragon.cn/posts/97c66a18ae0e9b57c6a69b8b3a41ddf6/" ref="nofollow noopener noreferrer">Vue3中v-show如何通过CSS修改display属性控制条件显示？与v-if的应用场景该如何区分？</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F8a1ddfac64b25062ac56403e4c1201d2%2F" target="_blank" title="https://blog.cmdragon.cn/posts/8a1ddfac64b25062ac56403e4c1201d2/" ref="nofollow noopener noreferrer">Vue3条件渲染中v-if系列指令如何合理使用与规避错误？</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F218c3a59282c3b757447ee08a01937bb%2F" target="_blank" title="https://blog.cmdragon.cn/posts/218c3a59282c3b757447ee08a01937bb/" ref="nofollow noopener noreferrer">Vue3动态样式控制：ref、reactive、watch与computed的应用场景与区别是什么？</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F1bab953e41f66ac53de099fa9fe76483%2F" target="_blank" title="https://blog.cmdragon.cn/posts/1bab953e41f66ac53de099fa9fe76483/" ref="nofollow noopener noreferrer">Vue3中动态样式数组的后项覆盖规则如何与计算属性结合实现复杂状态样式管理？</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fc85e1fe16a7ae45e965b4e2df4d9d2f4%2F" target="_blank" title="https://blog.cmdragon.cn/posts/c85e1fe16a7ae45e965b4e2df4d9d2f4/" ref="nofollow noopener noreferrer">Vue浅响应式如何解决深层响应式的性能问题？适用场景有哪些？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fbe04b02d2723994632de0d4ca22a3391%2F" target="_blank" title="https://blog.cmdragon.cn/posts/be04b02d2723994632de0d4ca22a3391/" ref="nofollow noopener noreferrer">Vue 3组合式API中ref与reactive的核心响应式差异及使用最佳实践是什么？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fbe04b02d2723994632de0d4ca22a3391%2F" target="_blank" title="https://blog.cmdragon.cn/posts/be04b02d2723994632de0d4ca22a3391/" ref="nofollow noopener noreferrer">Vue 3组合式API中ref与reactive的核心响应式差异及使用最佳实践是什么？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fa0af08dd60a37b9a890a9957f2cbfc9f%2F" target="_blank" title="https://blog.cmdragon.cn/posts/a0af08dd60a37b9a890a9957f2cbfc9f/" ref="nofollow noopener noreferrer">Vue3响应式系统中，对象新增属性、数组改索引、原始值代理的问题如何解决？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fbc287e1e36287afd90750fd907eca85e%2F" target="_blank" title="https://blog.cmdragon.cn/posts/bc287e1e36287afd90750fd907eca85e/" ref="nofollow noopener noreferrer">Vue 3中watch侦听器的正确使用姿势你掌握了吗？深度监听、与watchEffect的差异及常见报错解析 - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F654b9447ef1ba7ec1126a1bc26a4726d%2F" target="_blank" title="https://blog.cmdragon.cn/posts/654b9447ef1ba7ec1126a1bc26a4726d/" ref="nofollow noopener noreferrer">Vue响应式声明的API差异、底层原理与常见陷阱你都搞懂了吗 - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F654b9447ef1ba7ec1126a1bc26a4726d%2F" target="_blank" title="https://blog.cmdragon.cn/posts/654b9447ef1ba7ec1126a1bc26a4726d/" ref="nofollow noopener noreferrer">Vue响应式声明的API差异、底层原理与常见陷阱你都搞懂了吗 - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fc405a8d9950af5b7c63b56c348ac36b6%2F" target="_blank" title="https://blog.cmdragon.cn/posts/c405a8d9950af5b7c63b56c348ac36b6/" ref="nofollow noopener noreferrer">为什么Vue 3需要ref函数？它的响应式原理与正确用法是什么？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fa7e9abb9691a81e4404d9facabe0f7c3%2F" target="_blank" title="https://blog.cmdragon.cn/posts/a7e9abb9691a81e4404d9facabe0f7c3/" ref="nofollow noopener noreferrer">Vue 3中reactive函数如何通过Proxy实现响应式？使用时要避开哪些误区？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fbd995ea45161727597fb85b62566c43d%2F" target="_blank" title="https://blog.cmdragon.cn/posts/bd995ea45161727597fb85b62566c43d/" ref="nofollow noopener noreferrer">Vue3响应式系统的底层原理与实践要点你真的懂吗？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F53e3f270a80675df662c6857a3332c0f%2F" target="_blank" title="https://blog.cmdragon.cn/posts/53e3f270a80675df662c6857a3332c0f/" ref="nofollow noopener noreferrer">Vue 3模板如何通过编译三阶段实现从声明式语法到高效渲染的跨越 - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fddbce4f2a23aa72c96b1c0473900321e%2F" target="_blank" title="https://blog.cmdragon.cn/posts/ddbce4f2a23aa72c96b1c0473900321e/" ref="nofollow noopener noreferrer">快速入门Vue模板引用：从收DOM“快递”到调子组件方法，你玩明白了吗？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F23a2d5a334e15575277814c16e45df50%2F" target="_blank" title="https://blog.cmdragon.cn/posts/23a2d5a334e15575277814c16e45df50/" ref="nofollow noopener noreferrer">快速入门Vue模板里的JS表达式有啥不能碰？计算属性为啥比方法更能打？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F6be38de6382e31d282659b689c5b17f0%2F" target="_blank" title="https://blog.cmdragon.cn/posts/6be38de6382e31d282659b689c5b17f0/" ref="nofollow noopener noreferrer">快速入门Vue的v-model表单绑定：语法糖、动态值、修饰符的小技巧你都掌握了吗？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F60ce517684f4a418f453d66aa805606c%2F" target="_blank" title="https://blog.cmdragon.cn/posts/60ce517684f4a418f453d66aa805606c/" ref="nofollow noopener noreferrer">快速入门Vue3事件处理的挑战题：v-on、修饰符、自定义事件你能通关吗？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fe4ae7d5e4a9205bb11b2baccb230c637%2F" target="_blank" title="https://blog.cmdragon.cn/posts/e4ae7d5e4a9205bb11b2baccb230c637/" ref="nofollow noopener noreferrer">快速入门Vue3的v-指令：数据和DOM的“翻译官”到底有多少本事？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F999ce4fb32259ff4fbf4bf7bcb851654%2F" target="_blank" title="https://blog.cmdragon.cn/posts/999ce4fb32259ff4fbf4bf7bcb851654/" ref="nofollow noopener noreferrer">快速入门Vue3，插值、动态绑定和避坑技巧你都搞懂了吗？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fa6997d81b49cd232b87e1cf603888ad1%2F" target="_blank" title="https://blog.cmdragon.cn/posts/a6997d81b49cd232b87e1cf603888ad1/" ref="nofollow noopener noreferrer">想让PostgreSQL快到飞起？先找健康密码还是先换引擎？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F1fee7afbb9abd4540b8aa9c141d6845d%2F" target="_blank" title="https://blog.cmdragon.cn/posts/1fee7afbb9abd4540b8aa9c141d6845d/" ref="nofollow noopener noreferrer">想让PostgreSQL查询快到飞起？分区表、物化视图、并行查询这三招灵不灵？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F79c590fbd87ece535b11a71c9667884f%2F" target="_blank" title="https://blog.cmdragon.cn/posts/79c590fbd87ece535b11a71c9667884f/" ref="nofollow noopener noreferrer">子查询总拖慢查询？把它变成连接就能解决？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F748cdac2536008199abf8a8a2cd0ec85%2F" target="_blank" title="https://blog.cmdragon.cn/posts/748cdac2536008199abf8a8a2cd0ec85/" ref="nofollow noopener noreferrer">PostgreSQL全表扫描慢到崩溃？建索引+改查询+更统计信息三招能破？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F32ca943703226d317d4276a8fb53b0dd%2F" target="_blank" title="https://blog.cmdragon.cn/posts/32ca943703226d317d4276a8fb53b0dd/" ref="nofollow noopener noreferrer">复杂查询总拖后腿？PostgreSQL多列索引+覆盖索引的神仙技巧你get没？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fca93f1d53aa910e7ba5ffd8df611c12b%2F" target="_blank" title="https://blog.cmdragon.cn/posts/ca93f1d53aa910e7ba5ffd8df611c12b/" ref="nofollow noopener noreferrer">只给表子集建索引？用函数结果建索引？PostgreSQL这俩操作凭啥能省空间又加速？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Ff507856ebfddd592448813c510a53669%2F" target="_blank" title="https://blog.cmdragon.cn/posts/f507856ebfddd592448813c510a53669/" ref="nofollow noopener noreferrer">B-tree索引像字典查词一样工作？那哪些数据库查询它能加速，哪些不能？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fb2213bfcb5b88a862f2138404c03d596%2F" target="_blank" title="https://blog.cmdragon.cn/posts/b2213bfcb5b88a862f2138404c03d596/" ref="nofollow noopener noreferrer">想抓PostgreSQL里的慢SQL？pg_stat_statements基础黑匣子和pg_stat_monitor时间窗，谁能帮你更准揪出性能小偷？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F26614eb7da6c476dde41d367ad888d2f%2F" target="_blank" title="https://blog.cmdragon.cn/posts/26614eb7da6c476dde41d367ad888d2f/" ref="nofollow noopener noreferrer">PostgreSQL的“时光机”MVCC和锁机制是怎么搞定高并发的？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F69f99bc6972a860d559c74aad7280da4%2F" target="_blank" title="https://blog.cmdragon.cn/posts/69f99bc6972a860d559c74aad7280da4/" ref="nofollow noopener noreferrer">PostgreSQL性能暴涨的关键？内存IO并发参数居然要这么设置？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F7b7053f392147a8b3b1a16bebeb08d0a%2F" target="_blank" title="https://blog.cmdragon.cn/posts/7b7053f392147a8b3b1a16bebeb08d0a/" ref="nofollow noopener noreferrer">大表查询慢到翻遍整个书架？PostgreSQL分区表教你怎么“分类”才高效</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fc856e3cb073822349f3bf2d29995dcfc%2F" target="_blank" title="https://blog.cmdragon.cn/posts/c856e3cb073822349f3bf2d29995dcfc/" ref="nofollow noopener noreferrer">PostgreSQL 查询慢？是不是忘了优化 GROUP BY、ORDER BY 和窗口函数？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fc096347d18e67b7431faacd2c4757093%2F" target="_blank" title="https://blog.cmdragon.cn/posts/c096347d18e67b7431faacd2c4757093/" ref="nofollow noopener noreferrer">PostgreSQL里的子查询和CTE居然在性能上“掐架”？到底该站哪边？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F2eca89463454fd4250d7b66243b9fe5a%2F" target="_blank" title="https://blog.cmdragon.cn/posts/2eca89463454fd4250d7b66243b9fe5a/" ref="nofollow noopener noreferrer">PostgreSQL选Join策略有啥小九九？Nested Loop/Merge/Hash谁是它的菜？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F068ecb772a87d7df20a8c9fb4b233f8e%2F" target="_blank" title="https://blog.cmdragon.cn/posts/068ecb772a87d7df20a8c9fb4b233f8e/" ref="nofollow noopener noreferrer">PostgreSQL新手SQL总翻车？这7个性能陷阱你踩过没？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fd498f63cd0a2d5a77e445c688a8b88db%2F" target="_blank" title="https://blog.cmdragon.cn/posts/d498f63cd0a2d5a77e445c688a8b88db/" ref="nofollow noopener noreferrer">PostgreSQL索引选B-Tree还是GiST？“瑞士军刀”和“多面手”的差别你居然还不知道？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F9101b75bdec6faea9b35d54f14e37f36%2F" target="_blank" title="https://blog.cmdragon.cn/posts/9101b75bdec6faea9b35d54f14e37f36/" ref="nofollow noopener noreferrer">想知道数据库怎么给查询“算成本选路线”？EXPLAIN能帮你看明白？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fd527f8ebb6e3dae2c7dfe4c8d8979444%2F" target="_blank" title="https://blog.cmdragon.cn/posts/d527f8ebb6e3dae2c7dfe4c8d8979444/" ref="nofollow noopener noreferrer">PostgreSQL处理SQL居然像做蛋糕？解析到执行的4步里藏着多少查询优化的小心机？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F6bfdae84f313cf7ad0bb7045c4392347%2F" target="_blank" title="https://blog.cmdragon.cn/posts/6bfdae84f313cf7ad0bb7045c4392347/" ref="nofollow noopener noreferrer">PostgreSQL备份不是复制文件？物理vs逻辑咋选？误删还能精准恢复到1分钟前？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fde3672803de34dbad244d0a8d48b0eb5%2F" target="_blank" title="https://blog.cmdragon.cn/posts/de3672803de34dbad244d0a8d48b0eb5/" ref="nofollow noopener noreferrer">转账不翻车、并发不干扰，PostgreSQL的ACID特性到底有啥魔法？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fe463e8a2668abdf00a228c9b79324ded%2F" target="_blank" title="https://blog.cmdragon.cn/posts/e463e8a2668abdf00a228c9b79324ded/" ref="nofollow noopener noreferrer">银行转账不白扣钱、电商下单不超卖，PostgreSQL事务的诀窍是啥？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F5c967e595058c4a1fc4474a68e64031d%2F" target="_blank" title="https://blog.cmdragon.cn/posts/5c967e595058c4a1fc4474a68e64031d/" ref="nofollow noopener noreferrer">PostgreSQL里的PL/pgSQL到底是啥？能让SQL从“说目标”变“讲步骤”？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F325047855e3e23b5ef82f7d2db134fbd%2F" target="_blank" title="https://blog.cmdragon.cn/posts/325047855e3e23b5ef82f7d2db134fbd/" ref="nofollow noopener noreferrer">PostgreSQL视图不存数据？那它怎么简化查询还能递归生成序列和控制权限？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fd2dba50bb6e4df7b27e735245a06a2a2%2F" target="_blank" title="https://blog.cmdragon.cn/posts/d2dba50bb6e4df7b27e735245a06a2a2/" ref="nofollow noopener noreferrer">PostgreSQL索引这么玩，才能让你的查询真的“飞”起来？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F849ae5bab0f8c66e94c2f6ad1bb798e3%2F" target="_blank" title="https://blog.cmdragon.cn/posts/849ae5bab0f8c66e94c2f6ad1bb798e3/" ref="nofollow noopener noreferrer">PostgreSQL的表关系和约束，咋帮你搞定用户订单不混乱、学生选课不重复？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fef4800975ffa84f1ca51976a70a1585b%2F" target="_blank" title="https://blog.cmdragon.cn/posts/ef4800975ffa84f1ca51976a70a1585b/" ref="nofollow noopener noreferrer">PostgreSQL查询的筛子、排序、聚合、分组？你会用它们搞定数据吗？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fbf54711525c507c5eacfa7b0151c39d2%2F" target="_blank" title="https://blog.cmdragon.cn/posts/bf54711525c507c5eacfa7b0151c39d2/" ref="nofollow noopener noreferrer">PostgreSQL数据类型怎么选才高效不踩坑？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F887809b3e0375f5956873cd442f516d8%2F" target="_blank" title="https://blog.cmdragon.cn/posts/887809b3e0375f5956873cd442f516d8/" ref="nofollow noopener noreferrer">想解锁PostgreSQL查询从基础到进阶的核心知识点？你都get了吗？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F934be1203725e8be9d6f6e9104e5abcc%2F" target="_blank" title="https://blog.cmdragon.cn/posts/934be1203725e8be9d6f6e9104e5abcc/" ref="nofollow noopener noreferrer">PostgreSQL DELETE居然有这些操作？返回数据、连表删你试过没？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F0f0622e9b7402b599e618150d0596ffe%2F" target="_blank" title="https://blog.cmdragon.cn/posts/0f0622e9b7402b599e618150d0596ffe/" ref="nofollow noopener noreferrer">PostgreSQL UPDATE语句怎么玩？从改邮箱到批量更新的避坑技巧你都会吗？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F0e3bf7efc030b024ea67ee855a00f2de%2F" target="_blank" title="https://blog.cmdragon.cn/posts/0e3bf7efc030b024ea67ee855a00f2de/" ref="nofollow noopener noreferrer">PostgreSQL插入数据还在逐条敲？批量、冲突处理、返回自增ID的技巧你会吗？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fb6cd3c86da6aac26ed829e472d34078e%2F" target="_blank" title="https://blog.cmdragon.cn/posts/b6cd3c86da6aac26ed829e472d34078e/" ref="nofollow noopener noreferrer">PostgreSQL的“仓库-房间-货架”游戏，你能建出电商数据库和表吗？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fba1f545a3410144552fbdbfcf31b5265%2F" target="_blank" title="https://blog.cmdragon.cn/posts/ba1f545a3410144552fbdbfcf31b5265/" ref="nofollow noopener noreferrer">PostgreSQL 17安装总翻车？Windows/macOS/Linux避坑指南帮你搞定？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fb5474d1480509c5072085abc80b3dd9f%2F" target="_blank" title="https://blog.cmdragon.cn/posts/b5474d1480509c5072085abc80b3dd9f/" ref="nofollow noopener noreferrer">能当关系型数据库还能玩对象特性，能拆复杂查询还能自动管库存，PostgreSQL凭什么这么香？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fcc098d8836e787baa8a4d92e4d56d5c5%2F" target="_blank" title="https://blog.cmdragon.cn/posts/cc098d8836e787baa8a4d92e4d56d5c5/" ref="nofollow noopener noreferrer">给接口加新字段又不搞崩老客户端？FastAPI的多版本API靠哪三招实现？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F46d05151c5bd31cf37a7bcf0b8f5b0b8%2F" target="_blank" title="https://blog.cmdragon.cn/posts/46d05151c5bd31cf37a7bcf0b8f5b0b8/" ref="nofollow noopener noreferrer">流量突增要搞崩FastAPI？熔断测试是怎么防系统雪崩的？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F65ce343cc5df9faf3a8e2eeaab42ae45%2F" target="_blank" title="https://blog.cmdragon.cn/posts/65ce343cc5df9faf3a8e2eeaab42ae45/" ref="nofollow noopener noreferrer">FastAPI秒杀库存总变负数？Redis分布式锁能帮你守住底线吗 - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Feed6cd8985d9be0a4b092a7da38b3e0c%2F" target="_blank" title="https://blog.cmdragon.cn/posts/eed6cd8985d9be0a4b092a7da38b3e0c/" ref="nofollow noopener noreferrer">FastAPI的CI流水线怎么自动测端点，还能让Allure报告美到犯规？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F6157d87338ce894d18c013c3c4777abb%2F" target="_blank" title="https://blog.cmdragon.cn/posts/6157d87338ce894d18c013c3c4777abb/" ref="nofollow noopener noreferrer">如何用GitHub Actions为FastAPI项目打造自动化测试流水线？ - cmdragon's Blog</a></li>
</ul>
</details>
<details>
<summary>免费好用的热门在线工具</summary>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Ffile-converter" target="_blank" title="https://tools.cmdragon.cn/zh/apps/file-converter" ref="nofollow noopener noreferrer">文件格式转换器 - 应用商店 | By cmdragon</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fm3u8-player" target="_blank" title="https://tools.cmdragon.cn/zh/apps/m3u8-player" ref="nofollow noopener noreferrer">M3U8在线播放器 - 应用商店 | By cmdragon</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fquick-image-design" target="_blank" title="https://tools.cmdragon.cn/zh/apps/quick-image-design" ref="nofollow noopener noreferrer">快图设计 - 应用商店 | By cmdragon</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Ftext-to-image-advanced" target="_blank" title="https://tools.cmdragon.cn/zh/apps/text-to-image-advanced" ref="nofollow noopener noreferrer">高级文字转图片转换器 - 应用商店 | By cmdragon</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fraid-calculator" target="_blank" title="https://tools.cmdragon.cn/zh/apps/raid-calculator" ref="nofollow noopener noreferrer">RAID 计算器 - 应用商店 | By cmdragon</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fphotoshop-online" target="_blank" title="https://tools.cmdragon.cn/zh/apps/photoshop-online" ref="nofollow noopener noreferrer">在线PS - 应用商店 | By cmdragon</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fmermaid-live-editor" target="_blank" title="https://tools.cmdragon.cn/zh/apps/mermaid-live-editor" ref="nofollow noopener noreferrer">Mermaid 在线编辑器 - 应用商店 | By cmdragon</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fmath-solver-calculator" target="_blank" title="https://tools.cmdragon.cn/zh/apps/math-solver-calculator" ref="nofollow noopener noreferrer">数学求解计算器 - 应用商店 | By cmdragon</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fsmart-teleprompter" target="_blank" title="https://tools.cmdragon.cn/zh/apps/smart-teleprompter" ref="nofollow noopener noreferrer">智能提词器 - 应用商店 | By cmdragon</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fmagic-resume" target="_blank" title="https://tools.cmdragon.cn/zh/apps/magic-resume" ref="nofollow noopener noreferrer">魔法简历 - 应用商店 | By cmdragon</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fimage-puzzle-tool" target="_blank" title="https://tools.cmdragon.cn/zh/apps/image-puzzle-tool" ref="nofollow noopener noreferrer">Image Puzzle Tool - 图片拼图工具 | By cmdragon</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fsubtitle-downloader" target="_blank" title="https://tools.cmdragon.cn/zh/apps/subtitle-downloader" ref="nofollow noopener noreferrer">字幕下载工具 - 应用商店 | By cmdragon</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Flyrics-generator" target="_blank" title="https://tools.cmdragon.cn/zh/apps/lyrics-generator" ref="nofollow noopener noreferrer">歌词生成工具 - 应用商店 | By cmdragon</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fcloud-drive-search" target="_blank" title="https://tools.cmdragon.cn/zh/apps/cloud-drive-search" ref="nofollow noopener noreferrer">网盘资源聚合搜索 - 应用商店 | By cmdragon</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fascii-art-generator" target="_blank" title="https://tools.cmdragon.cn/zh/apps/ascii-art-generator" ref="nofollow noopener noreferrer">ASCII字符画生成器 - 应用商店 | By cmdragon</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fjwt-tool" target="_blank" title="https://tools.cmdragon.cn/zh/apps/jwt-tool" ref="nofollow noopener noreferrer">JSON Web Tokens 工具 - 应用商店 | By cmdragon</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fbcrypt-tool" target="_blank" title="https://tools.cmdragon.cn/zh/apps/bcrypt-tool" ref="nofollow noopener noreferrer">Bcrypt 密码工具 - 应用商店 | By cmdragon</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fgif-composer" target="_blank" title="https://tools.cmdragon.cn/zh/apps/gif-composer" ref="nofollow noopener noreferrer">GIF 合成器 - 应用商店 | By cmdragon</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fgif-decomposer" target="_blank" title="https://tools.cmdragon.cn/zh/apps/gif-decomposer" ref="nofollow noopener noreferrer">GIF 分解器 - 应用商店 | By cmdragon</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Ftext-steganography" target="_blank" title="https://tools.cmdragon.cn/zh/apps/text-steganography" ref="nofollow noopener noreferrer">文本隐写术 - 应用商店 | By cmdragon</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh" target="_blank" title="https://tools.cmdragon.cn/zh" ref="nofollow noopener noreferrer">CMDragon 在线工具 - 高级AI工具箱与开发者套件 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%3Fcategory%3Dtrending" target="_blank" title="https://tools.cmdragon.cn/zh/apps?category=trending" ref="nofollow noopener noreferrer">应用商店 - 发现1000+提升效率与开发的AI工具和实用程序 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fchangelog" target="_blank" title="https://tools.cmdragon.cn/zh/changelog" ref="nofollow noopener noreferrer">CMDragon 更新日志 - 最新更新、功能与改进 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fsponsor" target="_blank" title="https://tools.cmdragon.cn/zh/sponsor" ref="nofollow noopener noreferrer">支持我们 - 成为赞助者 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Ftext-to-image-ai" target="_blank" title="https://tools.cmdragon.cn/zh/apps/text-to-image-ai" ref="nofollow noopener noreferrer">AI文本生成图像 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Ftemp-email" target="_blank" title="https://tools.cmdragon.cn/zh/apps/temp-email" ref="nofollow noopener noreferrer">临时邮箱 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fqrcode-parser" target="_blank" title="https://tools.cmdragon.cn/zh/apps/qrcode-parser" ref="nofollow noopener noreferrer">二维码解析器 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Ftext-to-mindmap" target="_blank" title="https://tools.cmdragon.cn/zh/apps/text-to-mindmap" ref="nofollow noopener noreferrer">文本转思维导图 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fregex-visualizer" target="_blank" title="https://tools.cmdragon.cn/zh/apps/regex-visualizer" ref="nofollow noopener noreferrer">正则表达式可视化工具 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fsteganography-tool" target="_blank" title="https://tools.cmdragon.cn/zh/apps/steganography-tool" ref="nofollow noopener noreferrer">文件隐写工具 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fiptv-explorer" target="_blank" title="https://tools.cmdragon.cn/zh/apps/iptv-explorer" ref="nofollow noopener noreferrer">IPTV 频道探索器 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fsnapdrop" target="_blank" title="https://tools.cmdragon.cn/zh/apps/snapdrop" ref="nofollow noopener noreferrer">快传 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Flucky-draw" target="_blank" title="https://tools.cmdragon.cn/zh/apps/lucky-draw" ref="nofollow noopener noreferrer">随机抽奖工具 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fanime-scene-finder" target="_blank" title="https://tools.cmdragon.cn/zh/apps/anime-scene-finder" ref="nofollow noopener noreferrer">动漫场景查找器 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Ftime-toolkit" target="_blank" title="https://tools.cmdragon.cn/zh/apps/time-toolkit" ref="nofollow noopener noreferrer">时间工具箱 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fspeed-test" target="_blank" title="https://tools.cmdragon.cn/zh/apps/speed-test" ref="nofollow noopener noreferrer">网速测试 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fbackground-remover" target="_blank" title="https://tools.cmdragon.cn/zh/apps/background-remover" ref="nofollow noopener noreferrer">AI 智能抠图工具 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fbackground-replacer" target="_blank" title="https://tools.cmdragon.cn/zh/apps/background-replacer" ref="nofollow noopener noreferrer">背景替换工具 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fartistic-qrcode" target="_blank" title="https://tools.cmdragon.cn/zh/apps/artistic-qrcode" ref="nofollow noopener noreferrer">艺术二维码生成器 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fopen-graph-generator" target="_blank" title="https://tools.cmdragon.cn/zh/apps/open-graph-generator" ref="nofollow noopener noreferrer">Open Graph 元标签生成器 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fimage-comparison" target="_blank" title="https://tools.cmdragon.cn/zh/apps/image-comparison" ref="nofollow noopener noreferrer">图像对比工具 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fimage-compressor" target="_blank" title="https://tools.cmdragon.cn/zh/apps/image-compressor" ref="nofollow noopener noreferrer">图片压缩专业版 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fpassword-generator" target="_blank" title="https://tools.cmdragon.cn/zh/apps/password-generator" ref="nofollow noopener noreferrer">密码生成器 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fsvg-optimizer" target="_blank" title="https://tools.cmdragon.cn/zh/apps/svg-optimizer" ref="nofollow noopener noreferrer">SVG优化器 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fcolor-palette" target="_blank" title="https://tools.cmdragon.cn/zh/apps/color-palette" ref="nofollow noopener noreferrer">调色板生成器 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fonline-metronome" target="_blank" title="https://tools.cmdragon.cn/zh/apps/online-metronome" ref="nofollow noopener noreferrer">在线节拍器 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fip-geolocation" target="_blank" title="https://tools.cmdragon.cn/zh/apps/ip-geolocation" ref="nofollow noopener noreferrer">IP归属地查询 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fcss-grid-layout" target="_blank" title="https://tools.cmdragon.cn/zh/apps/css-grid-layout" ref="nofollow noopener noreferrer">CSS网格布局生成器 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Femail-validator" target="_blank" title="https://tools.cmdragon.cn/zh/apps/email-validator" ref="nofollow noopener noreferrer">邮箱验证工具 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fcalligraphy-practice" target="_blank" title="https://tools.cmdragon.cn/zh/apps/calligraphy-practice" ref="nofollow noopener noreferrer">书法练习字帖 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Ffinance-calculator-suite" target="_blank" title="https://tools.cmdragon.cn/zh/apps/finance-calculator-suite" ref="nofollow noopener noreferrer">金融计算器套件 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fchinese-kinship-calculator" target="_blank" title="https://tools.cmdragon.cn/zh/apps/chinese-kinship-calculator" ref="nofollow noopener noreferrer">中国亲戚关系计算器 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fprotobuf-toolkit" target="_blank" title="https://tools.cmdragon.cn/zh/apps/protobuf-toolkit" ref="nofollow noopener noreferrer">Protocol Buffer 工具箱 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fip-geolocation" target="_blank" title="https://tools.cmdragon.cn/zh/apps/ip-geolocation" ref="nofollow noopener noreferrer">IP归属地查询 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fimage-upscaler" target="_blank" title="https://tools.cmdragon.cn/zh/apps/image-upscaler" ref="nofollow noopener noreferrer">图片无损放大 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Ftext-compare" target="_blank" title="https://tools.cmdragon.cn/zh/apps/text-compare" ref="nofollow noopener noreferrer">文本比较工具 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fip-batch-lookup" target="_blank" title="https://tools.cmdragon.cn/zh/apps/ip-batch-lookup" ref="nofollow noopener noreferrer">IP批量查询工具 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fdomain-finder" target="_blank" title="https://tools.cmdragon.cn/zh/apps/domain-finder" ref="nofollow noopener noreferrer">域名查询工具 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fdns-toolkit" target="_blank" title="https://tools.cmdragon.cn/zh/apps/dns-toolkit" ref="nofollow noopener noreferrer">DNS工具箱 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Ffavicon-generator" target="_blank" title="https://tools.cmdragon.cn/zh/apps/favicon-generator" ref="nofollow noopener noreferrer">网站图标生成器 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fsitemap_index.xml" target="_blank" title="https://tools.cmdragon.cn/sitemap_index.xml" ref="nofollow noopener noreferrer">XML Sitemap</a></li>
</ul>
</details>
<ol start="3">
<li><strong>参数获取</strong>：watch 的回调函数可以获取变化前后的新旧值，而 watchEffect 无法直接获取这些值。</li>
<li><strong>使用复杂度</strong>：watch 需要手动维护监听源列表，而 watchEffect 自动管理依赖，代码更简洁。</li>
</ol>
<h3 data-id="heading-26">问题 2：</h3>
<p>如何在 watchEffect 中处理异步操作的副作用清理？请给出代码示例。</p>
<p><strong>答案解析：</strong>
可以使用 watchEffect 回调函数的第一个参数 onCleanup 来注册清理函数：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-title function_">watchEffect</span>(<span class="hljs-function">(<span class="hljs-params">onCleanup</span>) =&gt;</span> {
  <span class="hljs-keyword">const</span> controller = <span class="hljs-keyword">new</span> <span class="hljs-title class_">AbortController</span>()
  
  <span class="hljs-title function_">fetch</span>(<span class="hljs-string">`/api/data`</span>, { <span class="hljs-attr">signal</span>: controller.<span class="hljs-property">signal</span> })
    .<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">response</span> =&gt;</span> response.<span class="hljs-title function_">json</span>())
    .<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">data</span> =&gt;</span> {
      <span class="hljs-comment">// 处理数据</span>
    })
  
  <span class="hljs-comment">// 当依赖变化时，先执行此清理函数</span>
  <span class="hljs-title function_">onCleanup</span>(<span class="hljs-function">() =&gt;</span> {
    controller.<span class="hljs-title function_">abort</span>() <span class="hljs-comment">// 取消未完成的请求</span>
  })
})
</code></pre>
<p>这个清理函数会在 watchEffect 重新执行前被调用，确保之前的异步操作被正确取消，避免不必要的资源消耗和潜在的错误。</p>
<h2 data-id="heading-27">六、常见报错解决方案</h2>
<h3 data-id="heading-28">错误 1：watch 监听 reactive 对象属性时无反应</h3>
<p><strong>错误表现：</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> obj = <span class="hljs-title function_">reactive</span>({ <span class="hljs-attr">count</span>: <span class="hljs-number">0</span> })
<span class="hljs-comment">// 此代码不会生效</span>
<span class="hljs-title function_">watch</span>(obj.<span class="hljs-property">count</span>, <span class="hljs-function">(<span class="hljs-params">newValue</span>) =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'count changed:'</span>, newValue)
})
</code></pre>
<p><strong>原因分析：</strong>
watch 无法直接监听 reactive 对象的属性，需要使用 getter 函数。</p>
<p><strong>解决办法：</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-title function_">watch</span>(
  <span class="hljs-function">() =&gt;</span> obj.<span class="hljs-property">count</span>,
  <span class="hljs-function">(<span class="hljs-params">newValue</span>) =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'count changed:'</span>, newValue)
  }
)
</code></pre>
<h3 data-id="heading-29">错误 2：watchEffect 无法正确追踪异步操作中的依赖</h3>
<p><strong>错误表现：</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-title function_">watchEffect</span>(<span class="hljs-keyword">async</span> () =&gt; {
  <span class="hljs-keyword">const</span> data = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetchData</span>()
  <span class="hljs-comment">// 此处的依赖不会被正确追踪</span>
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(user.<span class="hljs-property">value</span>.<span class="hljs-property">name</span>)
})
</code></pre>
<p><strong>原因分析：</strong>
watchEffect 只在同步执行阶段收集依赖，异步操作中的依赖不会被追踪。</p>
<p><strong>解决办法：</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-title function_">watchEffect</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-comment">// 在同步阶段访问依赖</span>
  <span class="hljs-keyword">const</span> userId = user.<span class="hljs-property">value</span>.<span class="hljs-property">id</span>
  <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">fetchData</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> data = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetch</span>(<span class="hljs-string">`/api/user/<span class="hljs-subst">${userId}</span>`</span>)
    <span class="hljs-comment">// 处理数据</span>
  }
  <span class="hljs-title function_">fetchData</span>()
})
</code></pre>
<h3 data-id="heading-30">错误 3：内存泄漏问题</h3>
<p><strong>错误表现：</strong>
在组件卸载后，watch 或 watchEffect 仍然在执行，导致内存泄漏。</p>
<p><strong>原因分析：</strong>
异步创建的侦听器不会自动与组件绑定，需要手动停止。</p>
<p><strong>解决办法：</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 手动停止侦听器</span>
<span class="hljs-keyword">const</span> unwatch = <span class="hljs-title function_">watchEffect</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-comment">// 侦听逻辑</span>
})

<span class="hljs-comment">// 在组件卸载时停止</span>
<span class="hljs-title function_">onUnmounted</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-title function_">unwatch</span>()
})
</code></pre>
<h2 data-id="heading-31">七、参考链接</h2>
<ul>
<li>Vue 3 官方文档 - 侦听器：<a href="https://link.juejin.cn?target=https%3A%2F%2Fvuejs.org%2Fguide%2Fessentials%2Fwatchers.html" target="_blank" title="https://vuejs.org/guide/essentials/watchers.html" ref="nofollow noopener noreferrer">vuejs.org/guide/essen…</a></li>
<li>Vue 3 官方文档 - Composition API：<a href="https://link.juejin.cn?target=https%3A%2F%2Fvuejs.org%2Fguide%2Fextras%2Fcomposition-api-faq.html" target="_blank" title="https://vuejs.org/guide/extras/composition-api-faq.html" ref="nofollow noopener noreferrer">vuejs.org/guide/extra…</a></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[执行计划跑偏，你了解背后的根因吗？]]></title>    <link>https://juejin.cn/post/7600340964084596742</link>    <guid>https://juejin.cn/post/7600340964084596742</guid>    <pubDate>2026-01-29T07:19:00.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600340964084596742" data-draft-id="7600430748781641771" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="执行计划跑偏，你了解背后的根因吗？"/> <meta itemprop="keywords" content="PostgreSQL,开源,数据库"/> <meta itemprop="datePublished" content="2026-01-29T07:19:00.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="IvorySQL"/> <meta itemprop="url" content="https://juejin.cn/user/761327331579511"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            执行计划跑偏，你了解背后的根因吗？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/761327331579511/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    IvorySQL
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-29T07:19:00.000Z" title="Thu Jan 29 2026 07:19:00 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>关于作者：</p>
<p>Nickyoung，数据库领域从业者。PostgreSQL ACE，IvorySQL 专家顾问委员会成员。</p>
<p>公众号“👉PostgreSQL 运维之道”。</p>
</blockquote>
<p>还在以最终 cost 来判断计划是否最优？那就大错特错了！！！本篇老杨和大家一起抽丝剥茧，从源码入手分析计划跑偏的原因。</p>
<h2 data-id="heading-0">问题现象</h2>
<p>一个简单查询运行 240s，从执行计划看耗时主要在 nestloop join，Outter 扫描了 2293 行，inner loop 扫描了 2293 次，耗时 103.1 * 2293 = 236408ms</p>
<pre><code class="hljs language-sql" lang="sql">test<span class="hljs-operator">=</span><span class="hljs-operator">&gt;</span> explain analyze <span class="hljs-keyword">select</span> <span class="hljs-built_in">count</span>(<span class="hljs-operator">*</span>),zone_id <span class="hljs-keyword">from</span> instance_info <span class="hljs-keyword">where</span> instanceid <span class="hljs-keyword">in</span> (<span class="hljs-keyword">SELECT</span> instanceid
<span class="hljs-keyword">FROM</span>
    instance_info
wherevisible <span class="hljs-operator">=</span> <span class="hljs-number">1</span>
GROUPBY
    instanceid
<span class="hljs-keyword">HAVING</span>
    <span class="hljs-built_in">COUNT</span>(<span class="hljs-keyword">DISTINCT</span> zone_id) <span class="hljs-operator">&gt;</span> <span class="hljs-number">1</span>) andvisible <span class="hljs-operator">=</span> <span class="hljs-number">1</span>groupby zone_id;
                                                                   QUERY PLAN                                                                    
<span class="hljs-comment">-------------------------------------------------------------------------------------------------------------------------------------------------</span>
 GroupAggregate  (cost<span class="hljs-operator">=</span><span class="hljs-number">232.45</span>.<span class="hljs-number">.232</span><span class="hljs-number">.47</span> <span class="hljs-keyword">rows</span><span class="hljs-operator">=</span><span class="hljs-number">1</span> width<span class="hljs-operator">=</span><span class="hljs-number">12</span>) (actual <span class="hljs-type">time</span><span class="hljs-operator">=</span><span class="hljs-number">244941.317</span>.<span class="hljs-number">.244942</span><span class="hljs-number">.725</span> <span class="hljs-keyword">rows</span><span class="hljs-operator">=</span><span class="hljs-number">4.00</span> loops<span class="hljs-operator">=</span><span class="hljs-number">1</span>)
   <span class="hljs-keyword">Group</span> Key: instance_info.zone_id
   Buffers: shared hit<span class="hljs-operator">=</span><span class="hljs-number">3</span>
   <span class="hljs-operator">-</span><span class="hljs-operator">&gt;</span>  Sort  (cost<span class="hljs-operator">=</span><span class="hljs-number">232.45</span>.<span class="hljs-number">.232</span><span class="hljs-number">.45</span> <span class="hljs-keyword">rows</span><span class="hljs-operator">=</span><span class="hljs-number">1</span> width<span class="hljs-operator">=</span><span class="hljs-number">4</span>) (actual <span class="hljs-type">time</span><span class="hljs-operator">=</span><span class="hljs-number">244940.890</span>.<span class="hljs-number">.244941</span><span class="hljs-number">.590</span> <span class="hljs-keyword">rows</span><span class="hljs-operator">=</span><span class="hljs-number">4588.00</span> loops<span class="hljs-operator">=</span><span class="hljs-number">1</span>)
         Sort Key: instance_info.zone_id
         Sort <span class="hljs-keyword">Method</span>: quicksort  Memory: <span class="hljs-number">193</span>kB
         Buffers: shared hit<span class="hljs-operator">=</span><span class="hljs-number">3</span>
         <span class="hljs-operator">-</span><span class="hljs-operator">&gt;</span>  Nested Loop  (cost<span class="hljs-operator">=</span><span class="hljs-number">200.01</span>.<span class="hljs-number">.232</span><span class="hljs-number">.44</span> <span class="hljs-keyword">rows</span><span class="hljs-operator">=</span><span class="hljs-number">1</span> width<span class="hljs-operator">=</span><span class="hljs-number">4</span>) (actual <span class="hljs-type">time</span><span class="hljs-operator">=</span><span class="hljs-number">124.292</span>.<span class="hljs-number">.244935</span><span class="hljs-number">.769</span> <span class="hljs-keyword">rows</span><span class="hljs-operator">=</span><span class="hljs-number">4588.00</span> loops<span class="hljs-operator">=</span><span class="hljs-number">1</span>)
               <span class="hljs-keyword">Join</span> <span class="hljs-keyword">Filter</span>: ((instance_info.instanceid)::text <span class="hljs-operator">=</span> (instance_info_1.instanceid)::text)
               <span class="hljs-keyword">Rows</span> Removed <span class="hljs-keyword">by</span> <span class="hljs-keyword">Join</span> <span class="hljs-keyword">Filter</span>: <span class="hljs-number">20185277</span>
               <span class="hljs-operator">-</span><span class="hljs-operator">&gt;</span>  <span class="hljs-keyword">Foreign</span> Scan  (cost<span class="hljs-operator">=</span><span class="hljs-number">100.01</span>.<span class="hljs-number">.116</span><span class="hljs-number">.12</span> <span class="hljs-keyword">rows</span><span class="hljs-operator">=</span><span class="hljs-number">1</span> width<span class="hljs-operator">=</span><span class="hljs-number">146</span>) (actual <span class="hljs-type">time</span><span class="hljs-operator">=</span><span class="hljs-number">25.421</span>.<span class="hljs-number">.137</span><span class="hljs-number">.939</span> <span class="hljs-keyword">rows</span><span class="hljs-operator">=</span><span class="hljs-number">2293.00</span> loops<span class="hljs-operator">=</span><span class="hljs-number">1</span>)
                     Relations: Aggregate <span class="hljs-keyword">on</span> (instance_info instance_info_1)
               <span class="hljs-operator">-</span><span class="hljs-operator">&gt;</span>  <span class="hljs-keyword">Foreign</span> Scan <span class="hljs-keyword">on</span> instance_info  (cost<span class="hljs-operator">=</span><span class="hljs-number">100.00</span>.<span class="hljs-number">.116</span><span class="hljs-number">.30</span> <span class="hljs-keyword">rows</span><span class="hljs-operator">=</span><span class="hljs-number">2</span> width<span class="hljs-operator">=</span><span class="hljs-number">150</span>) (actual <span class="hljs-type">time</span><span class="hljs-operator">=</span><span class="hljs-number">1.290</span>.<span class="hljs-number">.103</span><span class="hljs-number">.183</span> <span class="hljs-keyword">rows</span><span class="hljs-operator">=</span><span class="hljs-number">8805.00</span> loops<span class="hljs-operator">=</span><span class="hljs-number">2293</span>)
 Planning:
   Buffers: shared hit<span class="hljs-operator">=</span><span class="hljs-number">173</span>
 Planning <span class="hljs-type">Time</span>: <span class="hljs-number">1.516</span> ms
 Execution <span class="hljs-type">Time</span>: <span class="hljs-number">244953.762</span> ms
(<span class="hljs-number">17</span> <span class="hljs-keyword">rows</span>)

test<span class="hljs-operator">=</span><span class="hljs-operator">&gt;</span>
</code></pre>
<p>一般遇到这种情况，肯定是尝试“关闭”nestloop 试试看，走了 Hashjoin 后执行耗时仅 287ms，性能提升快 1000 倍。</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">test</span>=&gt; set enable_nestloop to<span class="hljs-literal">off</span><span class="hljs-comment">;</span>
SET
<span class="hljs-attr">test</span>=&gt; explain analyze select count(*),zone_id from instance_info where instanceid in (SELECT instanceid
FROM
    instance_info
<span class="hljs-attr">wherevisible</span> = <span class="hljs-number">1</span>
GROUPBY
    instanceid
HAVING
    COUNT(DISTINCT zone_id) &gt; 1) <span class="hljs-attr">andvisible</span> = <span class="hljs-number">1</span>groupby zone_id<span class="hljs-comment">;</span>
                                                                  QUERY PLAN                                                                  
----------------------------------------------------------------------------------------------------------------------------------------------
 GroupAggregate  (<span class="hljs-attr">cost</span>=<span class="hljs-number">232.44</span>..<span class="hljs-number">232.46</span> rows=<span class="hljs-number">1</span> width=<span class="hljs-number">12</span>) (actual time=<span class="hljs-number">273.475</span>..<span class="hljs-number">274.907</span> rows=<span class="hljs-number">4.00</span> loops=<span class="hljs-number">1</span>)
   Group Key: instance_info.zone_id
   Buffers: shared <span class="hljs-attr">hit</span>=<span class="hljs-number">3</span>
   -&gt;  Sort  (<span class="hljs-attr">cost</span>=<span class="hljs-number">232.44</span>..<span class="hljs-number">232.45</span> rows=<span class="hljs-number">1</span> width=<span class="hljs-number">4</span>) (actual time=<span class="hljs-number">273.006</span>..<span class="hljs-number">273.722</span> rows=<span class="hljs-number">4588.00</span> loops=<span class="hljs-number">1</span>)
         Sort Key: instance_info.zone_id
         Sort Method: quicksort  Memory: 193kB
         Buffers: shared <span class="hljs-attr">hit</span>=<span class="hljs-number">3</span>
         -&gt;  Hash Join  (<span class="hljs-attr">cost</span>=<span class="hljs-number">216.13</span>..<span class="hljs-number">232.43</span> rows=<span class="hljs-number">1</span> width=<span class="hljs-number">4</span>) (actual time=<span class="hljs-number">160.901</span>..<span class="hljs-number">271.843</span> rows=<span class="hljs-number">4588.00</span> loops=<span class="hljs-number">1</span>)
               Hash Cond: ((instance_info.instanceid)::<span class="hljs-attr">text</span> = (instance_info_1.instanceid)::text)
               -&gt;  Foreign Scan on instance_info  (<span class="hljs-attr">cost</span>=<span class="hljs-number">100.00</span>..<span class="hljs-number">116.30</span> rows=<span class="hljs-number">2</span> width=<span class="hljs-number">150</span>) (actual time=<span class="hljs-number">4.691</span>..<span class="hljs-number">109.722</span> rows=<span class="hljs-number">8805.00</span> loops=<span class="hljs-number">1</span>)
               -&gt;  Hash  (<span class="hljs-attr">cost</span>=<span class="hljs-number">116.12</span>..<span class="hljs-number">116.12</span> rows=<span class="hljs-number">1</span> width=<span class="hljs-number">146</span>) (actual time=<span class="hljs-number">156.185</span>..<span class="hljs-number">156.186</span> rows=<span class="hljs-number">2293.00</span> loops=<span class="hljs-number">1</span>)
                     Buckets: 4096 (originally 1024)  Batches: 1 (originally 1)  Memory Usage: 144kB
                     -&gt;  Foreign Scan  (<span class="hljs-attr">cost</span>=<span class="hljs-number">100.01</span>..<span class="hljs-number">116.12</span> rows=<span class="hljs-number">1</span> width=<span class="hljs-number">146</span>) (actual time=<span class="hljs-number">21.939</span>..<span class="hljs-number">155.037</span> rows=<span class="hljs-number">2293.00</span> loops=<span class="hljs-number">1</span>)
                           Relations: Aggregate on (instance_info instance_info_1)
 Planning Time: 0.242 ms
 Execution Time: 287.414 ms
(16 rows)

<span class="hljs-attr">test</span>=&gt; 
</code></pre>
<p>为什么优化器走了效率更差的 nested loop？</p>
<p>统计信息不准？优化器代价计算偏差？</p>
<h2 data-id="heading-1">问题分析</h2>
<p>从 nestloop 和 Hashjoin 对应 path 的最终 cost 来看</p>
<p>GroupAggregate  (cost=232.45..232.47）</p>
<p>GroupAggregate  (cost=232.44..232.46)</p>
<p>后者对应 path 最终的 startup_cost 和 total_cost 都要小，为什么优化器没有选择 Hashjoin 这条路径？</p>
<p>所以这里会有一个误区：老杨也曾以为优化器选择最优执行计划，肯定是生成每种路径后，比较最终的 cost，最终 cost 最小的为最优计划。</p>
<p>事实上在 add_path 生成路径的过程中，每个节点都会进行 cost 比较，可能采用 new_path，或者保留 old_path，或者都保留。比如说在生成 Joinpath 时，可能只保留了一种 JoinMethod 进入下一计划节点，生成最终执行计划。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4728c512ba0a4b749093f7e654bbd4ba~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSXZvcnlTUUw=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770275940&amp;x-signature=j32UdIfzHmtVp1jlu9dQWctHw2I%3D" alt="01.png" loading="lazy"/></p>
<p>那么这个案例中有没有可能是 Hashjoin 在 Joinpath 环节被“淘汰了”？</p>
<p>Nested Loop  (cost=200.01..232.44 rows=1 width=4)</p>
<p>Hash Join  (cost=216.13..232.43 rows=1 width=4)</p>
<p>从 cost 来看，两种路径的 cost 比较接近，由于之前研究过这里，我已经大概猜到问题的原因了。</p>
<p>在 add_path 生成路径时，首先使用模糊 cost 比较来决定路径的去留。</p>
<p>cost 模糊比较函数为<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fpostgres%2Fpostgres%2Fblob%2FREL_18_0%2Fsrc%2Fbackend%2Foptimizer%2Futil%2Fpathnode.c%23L185" title="https://github.com/postgres/postgres/blob/REL_18_0/src/backend/optimizer/util/pathnode.c#L185" target="_blank" ref="nofollow noopener noreferrer">compare_path_costs_fuzzily</a>
[1]
：</p>
<p>path1 即 new_path 为 HashPath，path2 即 old_path 为 NestPath。</p>
<ul>
<li><strong>首先比较两条路径的 disabled_nodes</strong>。</li>
</ul>
<p>enable_nestloop 和 enable_hashjoin 均为 on，所以 disabled_nodes 均为 0。</p>
<ul>
<li>
<p><strong>若未果，再比较 total_cost，并通过模糊系数将路径 cost 提升 1%，和另外一条路径比较</strong>。</p>
<p>232.43 &gt; 232.44 _ 1.01 和 232.44 &gt; 232.43 _ 1.01 均不成立，total_cost 模糊近似。</p>
</li>
<li>
<p><strong>若未果，再比较 startup_cost，并通过模糊系数将路径 cost 提升 1%，和另外一条路径比较</strong>。</p>
<p>216.13 &gt; 200.01 * 1.01 所以返回 COSTS_BETTER2。</p>
</li>
</ul>
<p>经过比较确定两条路径中更优路径为 NestPath。 那么 HashPath 就被淘汰了，然后进行后续 SORT 和 AGG 节点的 path 生成。</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">static</span> PathCostComparison
<span class="hljs-title function_ invoke__">compare_path_costs_fuzzily</span>(Path *path1, Path *path2, double fuzz_factor)
{
#define <span class="hljs-title function_ invoke__">CONSIDER_PATH_STARTUP_COST</span>(p)  \
 ((p)<span class="hljs-punctuation">-&gt;</span>param_info == NULL ? (p)<span class="hljs-punctuation">-&gt;</span>parent<span class="hljs-punctuation">-&gt;</span>consider_startup : (p)<span class="hljs-punctuation">-&gt;</span>parent<span class="hljs-punctuation">-&gt;</span>consider_param_startup)

<span class="hljs-comment">/* Number of disabled nodes, if different, trumps all else. */</span>
<span class="hljs-title function_ invoke__">if</span> (<span class="hljs-title function_ invoke__">unlikely</span>(path1<span class="hljs-punctuation">-&gt;</span>disabled_nodes != path2<span class="hljs-punctuation">-&gt;</span>disabled_nodes))
 {
<span class="hljs-title function_ invoke__">if</span> (path1<span class="hljs-punctuation">-&gt;</span>disabled_nodes &lt; path2<span class="hljs-punctuation">-&gt;</span>disabled_nodes)
   <span class="hljs-keyword">return</span> COSTS_BETTER1;
<span class="hljs-keyword">else</span>
   <span class="hljs-keyword">return</span> COSTS_BETTER2;
 }

<span class="hljs-comment">/*
  * Check total cost first since it's more likely to be different; many
  * paths have zero startup cost.
  */</span>
<span class="hljs-title function_ invoke__">if</span> (path1<span class="hljs-punctuation">-&gt;</span>total_cost &gt; path2<span class="hljs-punctuation">-&gt;</span>total_cost * fuzz_factor)
 {
<span class="hljs-comment">/* path1 fuzzily worse on total cost */</span>
<span class="hljs-title function_ invoke__">if</span> (<span class="hljs-title function_ invoke__">CONSIDER_PATH_STARTUP_COST</span>(path1) &amp;&amp;
   path2<span class="hljs-punctuation">-&gt;</span>startup_cost &gt; path1<span class="hljs-punctuation">-&gt;</span>startup_cost * fuzz_factor)
  {
   <span class="hljs-comment">/* ... but path2 fuzzily worse on startup, so DIFFERENT */</span>
   <span class="hljs-keyword">return</span> COSTS_DIFFERENT;
  }
<span class="hljs-comment">/* else path2 dominates */</span>
<span class="hljs-keyword">return</span> COSTS_BETTER2;
 }
<span class="hljs-title function_ invoke__">if</span> (path2<span class="hljs-punctuation">-&gt;</span>total_cost &gt; path1<span class="hljs-punctuation">-&gt;</span>total_cost * fuzz_factor)
 {
<span class="hljs-comment">/* path2 fuzzily worse on total cost */</span>
<span class="hljs-title function_ invoke__">if</span> (<span class="hljs-title function_ invoke__">CONSIDER_PATH_STARTUP_COST</span>(path2) &amp;&amp;
   path1<span class="hljs-punctuation">-&gt;</span>startup_cost &gt; path2<span class="hljs-punctuation">-&gt;</span>startup_cost * fuzz_factor)
  {
   <span class="hljs-comment">/* ... but path1 fuzzily worse on startup, so DIFFERENT */</span>
   <span class="hljs-keyword">return</span> COSTS_DIFFERENT;
  }
<span class="hljs-comment">/* else path1 dominates */</span>
<span class="hljs-keyword">return</span> COSTS_BETTER1;
 }
<span class="hljs-comment">/* fuzzily the same on total cost ... */</span>
<span class="hljs-title function_ invoke__">if</span> (path1<span class="hljs-punctuation">-&gt;</span>startup_cost &gt; path2<span class="hljs-punctuation">-&gt;</span>startup_cost * fuzz_factor)
 {
<span class="hljs-comment">/* ... but path1 fuzzily worse on startup, so path2 wins */</span>
<span class="hljs-keyword">return</span> COSTS_BETTER2;
 }
<span class="hljs-title function_ invoke__">if</span> (path2<span class="hljs-punctuation">-&gt;</span>startup_cost &gt; path1<span class="hljs-punctuation">-&gt;</span>startup_cost * fuzz_factor)
 {
<span class="hljs-comment">/* ... but path2 fuzzily worse on startup, so path1 wins */</span>
<span class="hljs-keyword">return</span> COSTS_BETTER1;
 }
<span class="hljs-comment">/* fuzzily the same on both costs */</span>
<span class="hljs-keyword">return</span> COSTS_EQUAL;

#undef CONSIDER_PATH_STARTUP_COST
}
</code></pre>
<p><strong>debug 做下验证：</strong></p>
<p>在生成 Joinpath 时，依次生成 MergePath、NestPath、HashPath 并进行 cost 模糊比较。</p>
<p>这里省去 MergePath 和 NestPath 的比较过程，NestPath 胜出。</p>
<p>当生成 HashPath 后，和 NestPath 比较 Total_cost 差异并未达到 1%。而进一步比较 startup_cost，明显差异大于 1%所以返回 COSTS_BETTER2，即 NestPath 胜出。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e7443200633b4a21be0d517f218be3c3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSXZvcnlTUUw=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770275940&amp;x-signature=hJVzPv3TJfGQOVq%2Bm7PIs2kKmSE%3D" alt="02.png" loading="lazy"/></p>
<p>case COSTS_BETTER2：当前满足 outercmp == BMS_EQUAL 等条件，将 accept_new 置为 false.</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4a256a3c5c414b4880d03201ca35b280~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSXZvcnlTUUw=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770275940&amp;x-signature=GaT4cc9FswIrHqh4hVpdS%2BFHDRA%3D" alt="03.png" loading="lazy"/></p>
<p>accept_new 为 false，所以拒绝并且回收了 new_path，也就是 HashPath 被淘汰了。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3751ee09745f4e909d442f330bafe277~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSXZvcnlTUUw=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770275940&amp;x-signature=OM3pS9wlkwU3Fun9jZjyiJt2E9I%3D" alt="04.png" loading="lazy"/></p>
<p>经过 cost 精确比较，角逐出 cheapest_total_cost 和 cheapest_startup_cost 都为 NestPath。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d57cfd17a19e4e9386a014cf4930d7e9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSXZvcnlTUUw=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770275940&amp;x-signature=zLSLKyW0ll%2F1pSdGNtD0Fd0PpUU%3D" alt="05.png" loading="lazy"/></p>
<p>最终，使用 best_path 去生成执行计划。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d201c3a08d38450e852cfac3cd57ff1a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSXZvcnlTUUw=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770275940&amp;x-signature=2bgIDJ4U%2BzAPDg57mFX9aKtLERg%3D" alt="06.png" loading="lazy"/></p>
<p>到这里，<strong>大家已经感觉到这个 cost 模糊比较有坑了吧，特别当两条路径的 cost 差别比较小，total_cost 或者 startup_cost 差别小于 1%时，可能会导致选错路径，最终生成了一个次优计划。</strong></p>
<p>STD_FUZZ_FACTOR 默认就是 1.01，是不是可以把它调整得更小，这样就能更精准？但得慎重，这里也是优化器最核心的部分，弄不好真是牵一发则动全身。我觉得这个模糊比较目前看起来不太优雅，甚至后续版本有可能去除这里的逻辑，当然各位有想法的话可以发到社区和 Tom Lane 一众大佬 solo 下。</p>
<p>当然不能指望优化器一直都是最正确的，这是违背现实的，我之前也写了很多篇文章，多次分享相关的内容。</p>
<p>ok，那么为什么这个 case 走了不优计划，大家应该都清楚了。可能已经有朋友看出来还有点小问题，Foreign table 预估扫描 1 行，实际扫描了 2000+行，肯定是统计信息不准啊？</p>
<p>大家思考下 Foreign table 有统计信息吗？</p>
<p>sure，篇幅问题，我简述下原理：Foreign table 只是表映射，没有物理元组，它的统计信息，是通过 fdw 访问目的端表进行采集的。 但是只能手动挡，因为 Foreign table 没法进行 vacuum/autovacuum，需要手动 analyze 触发。</p>
<p>示例的表我做了下 analyze，更新了下统计信息，各种 path 的 cost 差异比较大，默认走了 Hashjoin。</p>
<p>因此，一定要定时收集外表统计信息，不然可能会拖垮整个实例。</p>
<h2 data-id="heading-2">小结</h2>
<p>本篇我们分析了一例执行计划跑偏的根本原因，从中看得到当路径间的 cost 接近时（1%以下），可能在 add_path 时 cost 模糊比较中会选择次优路径，生成不优计划。</p>
<p>当然遇到这样的场景可以尝试各种 hint 手段去干预，不过可以考虑利用强化学习来实现自动化的 hint 干预，让数据库自动管理执行计划。我在之前的文章《AI4DB 试玩-Bao/Balsa 适配 PG18》中研究过类似的模型，并在 PCC2025 大会中做了分享。</p>
<p>当然专业的事要专业的人来做，我们的好友崔鹏博士已有相关的 AI4DB 课题研究和落地，将会在 HOW2026 大会中与大家见面，敬请期待。</p>
<hr/>
<h2 data-id="heading-3"><a href="https://link.juejin.cn?target=https%3A%2F%2Fjsj.top%2Ff%2FuebqBc" target="_blank" title="https://jsj.top/f/uebqBc" ref="nofollow noopener noreferrer">HOW 2026 议题招募中</a></h2>
<p>2026 年 4 月 27-28 日，由 IvorySQL 社区联合 PGEU（欧洲 PG 社区）、PGAsia（亚洲 PG 社区）共同打造的 HOW 2026（IvorySQL &amp; PostgreSQL 技术峰会） 将再度落地济南。届时，PostgreSQL 联合创始人 Bruce Momjian 等顶级大师将亲临现场。</p>
<p>自开启征集以来，HOW 2026 筹备组已感受到来自全球 PostgreSQL 爱好者的澎湃热情。为了确保大会议题的深度与广度，我们诚邀您在 2026 年 2 月 27 日截止日期前，提交您的技术见解。</p>
<p>投递链接：<a href="https://link.juejin.cn?target=https%3A%2F%2Fjsj.top%2Ff%2FuebqBc" target="_blank" title="https://jsj.top/f/uebqBc" ref="nofollow noopener noreferrer">jsj.top/f/uebqBc</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[前端向架构突围系列 - 编译原理 [6 - 2]：Babel 插件开发与访问者模式]]></title>    <link>https://juejin.cn/post/7600581247019679753</link>    <guid>https://juejin.cn/post/7600581247019679753</guid>    <pubDate>2026-01-29T07:37:12.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600581247019679753" data-draft-id="7600489282838986762" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="前端向架构突围系列 - 编译原理 [6 - 2]：Babel 插件开发与访问者模式"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2026-01-29T07:37:12.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="前端王壮壮"/> <meta itemprop="url" content="https://juejin.cn/user/4473272506789485"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            前端向架构突围系列 - 编译原理 [6 - 2]：Babel 插件开发与访问者模式
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4473272506789485/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    前端王壮壮
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-29T07:37:12.000Z" title="Thu Jan 29 2026 07:37:12 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:14px;overflow-x:hidden;color:var(--cyanosis-base-color);transition:color .35s;--cyanosis-base-color:#353535;--cyanosis-title-color:#005bb7;--cyanosis-strong-color:#2196f3;--cyanosis-em-color:#4fc3f7;--cyanosis-del-color:#ccc;--cyanosis-link-color:#3da8f5;--cyanosis-linkh-color:#007fff;--cyanosis-border-color:#bedcff;--cyanosis-border-color-2:#ececec;--cyanosis-bg-color:#fff;--cyanosis-blockquote-color:#8c8c8c;--cyanosis-blockquote-bg-color:#f0fdff;--cyanosis-code-color:#c2185b;--cyanosis-code-bg-color:#fff4f4;--cyanosis-code-pre-color:#f8f8f8;--cyanosis-table-border-color:#c3e0fd;--cyanosis-table-th-color:#dff0ff;--cyanosis-table-tht-color:#005bb7;--cyanosis-table-tr-nc-color:#f7fbff;--cyanosis-table-trh-color:#e0edf7;--cyanosis-slct-title-color:#005bb7;--cyanosis-slct-titlebg-color:rgba(175,207,247,0.25);--cyanosis-slct-text-color:#c80000;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#e8ebec;--cyanosis-slct-codebg-color:#ffeaeb;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body.__dark{--cyanosis-base-color:#cacaca;--cyanosis-title-color:#ddd;--cyanosis-strong-color:#fe9900;--cyanosis-em-color:#ffd28e;--cyanosis-del-color:#ccc;--cyanosis-link-color:#ffb648;--cyanosis-linkh-color:#fe9900;--cyanosis-border-color:#ffe3ba;--cyanosis-border-color-2:#ffcb7b;--cyanosis-bg-color:#2f2f2f;--cyanosis-blockquote-color:#c7c7c7;--cyanosis-blockquote-bg-color:rgba(255,199,116,0.1);--cyanosis-code-color:#000;--cyanosis-code-bg-color:#ffcb7b;--cyanosis-code-pre-color:rgba(255,227,185,0.5);--cyanosis-table-border-color:#fe9900;--cyanosis-table-th-color:#ffb648;--cyanosis-table-tht-color:#000;--cyanosis-table-tr-nc-color:#6d5736;--cyanosis-table-trh-color:#947443;--cyanosis-slct-title-color:#000;--cyanosis-slct-titlebg-color:#fe9900;--cyanosis-slct-text-color:#00c888;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#000;--cyanosis-slct-codebg-color:#ffcb7b;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body h1{padding-bottom:4px;font-size:30px}.markdown-body h1,.markdown-body h2{margin-top:36px;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);transition:color .35s}.markdown-body h2{position:relative;padding-left:10px;padding-right:10px;padding-bottom:10px;font-size:24px;border-bottom:1px solid var(--cyanosis-border-color-2)}.markdown-body h2:before{content:"「";position:absolute;top:-6px;left:-14px}.markdown-body h2:after{content:"」";position:relative;top:6px;right:auto}.markdown-body h3{position:relative;padding-bottom:0;margin-top:30px;margin-bottom:10px;font-size:20px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h3:before{content:"»";padding-right:6px;color:var(--cyanosis-strong-color)}.markdown-body h4{margin-top:24px;font-size:16px}.markdown-body h4,.markdown-body h5{padding-bottom:0;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h5{margin-top:18px;font-size:14px}.markdown-body h6{padding-bottom:0;margin-top:12px;margin-bottom:10px;font-size:12px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body p{line-height:inherit;margin-top:16px;margin-bottom:16px}.markdown-body img{max-width:100%}.markdown-body hr{position:relative;width:98%;height:1px;margin-top:32px;margin-bottom:32px;background-image:linear-gradient(90deg,var(--cyanosis-link-color),rgba(255,0,0,.3),hsla(0,0%,100%,.1),rgba(255,0,0,.3),var(--cyanosis-link-color));border-width:0;overflow:visible}.markdown-body hr:after{content:"";position:absolute;margin:auto;left:0;right:0;bottom:0;top:0;display:inline-block;width:60px;height:20px;background-color:var(--cyanosis-bg-color);background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAgCAYAAABgrToAAAADoklEQVRYR82XTYgcRRTHf2933Q1RjAa9eFO8JHoJ8RQVBQ2iBwXBET0YEUTXNVmNQtTpmeqaWV0XNRq/o4KoECSCEPSg4CF+BYUkIIiCoCJCPIhC/Ihh2Z0nVV27VnZnenumW9i6ddV7//frV69fVQurfMgq56NawFTPAU6QyomqXrw6wIZeyhCPebA5buNR+akKyGoAjd6BshthnYdSjqNcRVuOlIUsD2j0SuA94IwuMHdh5ZUykOUBXfSGbmKI54EtAeYIHSZoy5dl4JxvNYBOKdW1KE8BQ8AkVk6WhasWsAiN0TX9gveXQaPP+Aytpc4u+bMI06JNohsYYYYOR2lJWtS3OKDRfcAtQfgDoI6Vo4UCGb0OmAEuDvZvYmVbEd/igC3dzDz7gQu8sPA9kJDK27mBmjqBeLjTg90PDFOjWawFFQd06kZHEfaj3LAIpTRpSXsZ5E06zEYP9sDimnAApYaV2SLZG/wjMeqAkijwW4xQJ5Gf/ZzRC8OW3hiBTGGlURRswW55Bh/Ssxljrwew8l1PQaM14GngvGDzBUKdDsMeTtgU5o8B92PFlUf3YXUrHa7Fys6lBqcCGnX15YQ2A18FyPd7Crd1A3M8C1wdbH4DD3hWeP6IEXbQkG97ajR1HPFnuPP5jFFq1OWX7hl8WM9l1AO648uNfwLk7tytMeogty+xeQ4rO3r6bdcx1nuwOGsHmaXGtPzae4uzGnLH1kQkvpdZGrHjssBZJrL+pqS05KWc8tgITAPXRzYvYOXe/C2OV43eDcRBDtIhoS2f9wzc0Cv8Wls+zoFzUC5zF0U241h5uZtPfptp6OUM8wbK+cH5GEpCS17P3fJei0Z3+npTxryJ8CPzbKMtn/ZyWbkPGl0PuFPkmkjkcb4h4R2ZLwRq1H0ALmvjkf2HwK1Y+T1PY2XABe/sHJ6MxN5lnoSpnC/UGbsTaI5phK2R7x6s3Ffk5YoDOrWm3onwJHBmEP86bPmBrsGaenNoIdnxCH+gPEhLXi0Cl1VBvyPVLSh7gEuC62yAfOIUqabWEaaiucMIk6RyqJ+Q/QM69V26jjW86Gvov/EaoyT8zRCn+Xq7PVrbx0nuYUaO9wM3WAbjCE1NEUw09Um4UV+2OKfYfu5/S19gsAzGKqm6LE5FrShbdS0ku465DjDwKA/oQht19ejqbaEVuRbiLhuHByYLjtUAZpDutzP7cYdHsPJXWbjyNVgFwQoa1WXwf4Jd9YD/Ap80+yE7+u9aAAAAAElFTkSuQmCC);background-repeat:no-repeat;background-size:auto 100%;background-position-x:center;transition:background-color .5s}.markdown-body code{padding:.065em .4em;font-size:.87em;color:var(--cyanosis-code-color);word-break:break-word;overflow-x:auto;background-color:var(--cyanosis-code-bg-color);border-radius:2px}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{display:block;padding:16px 12px;margin:0;font-size:12px;color:#333;word-break:normal;overflow-x:auto;background:var(--cyanosis-code-pre-color)}.markdown-body pre&gt;code::-webkit-scrollbar{width:4px;height:4px}.markdown-body pre&gt;code::-webkit-scrollbar-track{background-color:var(--cyanosis-border-color)}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:var(--cyanosis-strong-color);border-radius:10px}.markdown-body a{position:relative;text-decoration:none;color:var(--cyanosis-link-color);border-bottom:1px solid var(--cyanosis-border-color)}.markdown-body a:hover{border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body a:active,.markdown-body a:hover{color:var(--cyanosis-linkh-color)}.markdown-body a:after{position:absolute;content:"";top:100%;left:0;width:100%;opacity:0;border-bottom:1px solid var(--cyanosis-border-color);transition:top .3s,opacity .3s;transform:translateZ(0)}.markdown-body a:hover:after{top:0;opacity:1;border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid var(--cyanosis-table-border-color);border-spacing:0;border-collapse:collapse}.markdown-body table thead{color:#000;text-align:left;font-size:14px;background:#f6f6f6}.markdown-body table tr:nth-child(2n){background-color:var(--cyanosis-table-tr-nc-color)}.markdown-body table tr:hover{background-color:var(--cyanosis-table-trh-color)}.markdown-body table td,.markdown-body table th{padding:12px 8px;line-height:24px;border:1px solid var(--cyanosis-table-border-color)}.markdown-body table th{color:var(--cyanosis-table-tht-color);background-color:var(--cyanosis-table-th-color)}.markdown-body table td{min-width:120px}.markdown-body blockquote{color:var(--cyanosis-blockquote-color);border-left:4px solid var(--cyanosis-strong-color);background-color:var(--cyanosis-blockquote-bg-color);padding:1px 20px;margin:22px 0;transition:color .35s}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body b,.markdown-body blockquote&gt;b,.markdown-body blockquote&gt;strong,.markdown-body strong{color:var(--cyanosis-strong-color)}.markdown-body em,.markdown-body i{color:var(--cyanosis-em-color)}.markdown-body del{color:var(--cyanosis-del-color)}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:4px}.markdown-body ol li{padding-left:6px}.markdown-body details&gt;summary{outline:none;color:var(--cyanosis-title-color);font-size:20px;font-weight:bolder;border-bottom:1px solid var(--cyanosis-border-color);cursor:pointer}.markdown-body details&gt;p{padding:10px 20px;margin:10px 0 0;color:#666;background-color:var(--cyanosis-blockquote-bg-color);border:2px dashed var(--cyanosis-strong-color)}.markdown-body h1::selection,.markdown-body h2::selection,.markdown-body h3::selection,.markdown-body h4::selection,.markdown-body h5::selection,.markdown-body h6::selection{color:var(--cyanosis-slct-title-color);background-color:var(--cyanosis-slct-titlebg-color)}.markdown-body ol li::selection,.markdown-body p::selection,.markdown-body ul li::selection{color:var(--cyanosis-slct-text-color);background-color:var(--cyanosis-slct-bg-color)}.markdown-body a::selection,.markdown-body b::selection,.markdown-body em::selection,.markdown-body i::selection,.markdown-body strong::selection{background-color:var(--cyanosis-slct-elbg-color)}.markdown-body del::selection{color:var(--cyanosis-slct-del-color);background-color:var(--cyanosis-slct-elbg-color)}.markdown-body table thead th::selection{background-color:transparent}.markdown-body table tbody td::selection{background-color:var(--cyanosis-slct-bg-color)}.markdown-body code::selection{background-color:var(--cyanosis-slct-codebg-color)}.markdown-body pre&gt;code::selection{background-color:var(--cyanosis-slct-prebg-color)}.markdown-body .contains-task-list{padding-left:14px;list-style:none}.markdown-body .contains-task-list input[type=checkbox]{position:relative}.markdown-body .contains-task-list input[type=checkbox]:before{content:"";position:absolute;top:0;left:0;right:0;bottom:0;width:inherit;height:inherit;background:#f0f8ff;border:1px solid #add6ff;border-radius:2px;box-sizing:border-box;z-index:1}.markdown-body .contains-task-list input[type=checkbox]:checked:after{content:"✓";position:absolute;top:-12px;left:0;right:0;bottom:0;width:0;height:0;color:#f55;font-size:20px;font-weight:700;z-index:2}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="atom-one-dark">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#abb2bf;background:#282c34}.hljs-comment,.hljs-quote{color:#5c6370;font-style:italic}.hljs-doctag,.hljs-formula,.hljs-keyword{color:#c678dd}.hljs-deletion,.hljs-name,.hljs-section,.hljs-selector-tag,.hljs-subst{color:#e06c75}.hljs-literal{color:#56b6c2}.hljs-addition,.hljs-attribute,.hljs-meta-string,.hljs-regexp,.hljs-string{color:#98c379}.hljs-built_in,.hljs-class .hljs-title{color:#e6c07b}.hljs-attr,.hljs-number,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-pseudo,.hljs-template-variable,.hljs-type,.hljs-variable{color:#d19a66}.hljs-bullet,.hljs-link,.hljs-meta,.hljs-selector-id,.hljs-symbol,.hljs-title{color:#61aeee}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}.hljs-link{text-decoration:underline}</style><blockquote>
<p><strong>写在前面</strong></p>
<p>很多高级的前端库都在用 Babel 插件做“魔法”。</p>
<ul>
<li><strong>React:</strong> JSX 语法根本不是 JS，是 Babel 把它变成了 <code>React.createElement</code>。</li>
<li><strong>Vue:</strong> <code>v-model</code> 的语法糖，是在编译阶段展开的。</li>
<li><strong>babel-plugin-import:</strong> 为什么 Ant Design 可以按需加载？因为它悄悄把 <code>import { Button } from 'antd'</code> 改写成了引用具体文件的路径。</li>
</ul>
<p>学会写 Babel 插件，意味着你拥有了<strong>改写语言规则</strong>的能力。</p>
</blockquote>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ce72ee99ca0b4093bef22a0b910de43f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YmN56uv546L5aOu5aOu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770277039&amp;x-signature=tMfRBdJK%2BNTJmTOTVk6YpqixTE8%3D" alt="unnamed.jpg" loading="lazy"/></p>
<hr/>
<h2 data-id="heading-0">一、 核心设计模式：访问者模式 (Visitor Pattern)</h2>
<p>AST 是一棵深度极深、结构复杂的树。如果让你手动写递归函数去遍历每一个节点，还得判断“这是不是函数”、“这是不是变量”，你会疯掉的。</p>
<p>Babel 采用 <strong>访问者模式</strong> 来解决这个问题。</p>
<h3 data-id="heading-1">1.1 什么是 Visitor？</h3>
<p>想象 AST 是一个巨大的<strong>迷宫</strong>。</p>
<ul>
<li><strong>Babel (Traverser):</strong> 是一个不知疲倦的导游，他负责走遍迷宫的每一个角落（深度优先遍历）。</li>
<li><strong>你 (Visitor):</strong> 是游客。你不需要自己走，你只需要在特定的“景点”等着。</li>
<li><strong>工作流：</strong> 导游走到一个节点（比如“函数声明节点”），就会大喊：“这里有个函数声明！”如果你对这个节点感兴趣，你就处理它；不感兴趣，导游就继续走。</li>
</ul>
<h3 data-id="heading-2">1.2 代码中的 Visitor</h3>
<p>在 Babel 插件中，Visitor 就是一个对象，对象的<strong>Key</strong> 是你感兴趣的 AST 节点类型。</p>
<pre><code class="hljs language-scss" lang="scss">const visitor = {
  <span class="hljs-comment">// 当遍历到 Identifier（标识符/变量名）节点时，执行这个函数</span>
  <span class="hljs-built_in">Identifier</span>(path) {
    console<span class="hljs-selector-class">.log</span>("我发现了一个变量:", path.node.name);
  },
  
  <span class="hljs-comment">// 当遍历到 BinaryExpression（二元表达式，如 a + b）节点时...</span>
  <span class="hljs-built_in">BinaryExpression</span>(path) {
    console<span class="hljs-selector-class">.log</span>("我发现了一个运算");
  }
};
</code></pre>
<hr/>
<h2 data-id="heading-3">二、 手术刀的核心：Path 与 Types</h2>
<p>在编写插件时，有两个最重要的概念：<code>path</code> 和 <code>@babel/types</code>。</p>
<h3 data-id="heading-4">2.1 Path：节点之间的桥梁</h3>
<p>注意，Visitor 函数接收的参数不是 <code>node</code>，而是 <code>path</code>。</p>
<ul>
<li>
<p><strong>Node (节点):</strong> 只是静态的数据（JSON 对象），比如 <code>{ type: "Identifier", name: "a" }</code>。它没有灵魂。</p>
</li>
<li>
<p><strong>Path (路径):</strong> 是一个<strong>响应式对象</strong>。它不仅包含当前节点的信息，还包含<strong>父节点</strong>、<strong>作用域</strong>以及<strong>增删改查的方法</strong>。</p>
<ul>
<li><code>path.node</code>: 获取当前节点数据。</li>
<li><code>path.parent</code>: 获取父节点。</li>
<li><code>path.remove()</code>: 自杀（把自己从树中移除）。</li>
<li><code>path.replaceWith(newNode)</code>: 变身（把自己替换成新节点）。</li>
<li><code>path.stop()</code>: 告诉导游（Babel），停止遍历，不要往下走了。</li>
</ul>
</li>
</ul>
<h3 data-id="heading-5">2.2 @babel/types：节点的生成器与验证器</h3>
<p>如果你想把 <code>a</code> 替换成 <code>b</code>，你不能直接写 <code>path.node.name = 'b'</code>（虽然有时候也能跑，但不规范）。你需要创建一个标准的 AST 节点。 <code>@babel/types</code> (通常简写为 <code>t</code>) 就是干这个的。</p>
<ul>
<li><code>t.isIdentifier(node)</code>: 判断是不是标识符。</li>
<li><code>t.stringLiteral("hello")</code>: 创建一个字符串字面量节点。</li>
</ul>
<hr/>
<h2 data-id="heading-6">三、 实战演练：编写一个“去除 console.log”的插件</h2>
<p>这是 Babel 插件开发的 "Hello World"。 <strong>需求：</strong> 生产环境构建时，自动删除代码里所有的 <code>console.log</code>，但保留 <code>console.error</code>。</p>
<h3 data-id="heading-7">3.1 第一步：在 AST Explorer 中观察</h3>
<p>输入源码：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'hello'</span>);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'oops'</span>);
</code></pre>
<p>观察 AST 结构，发现 <code>console.log('hello')</code> 是一个 <strong>CallExpression</strong> (调用表达式)。</p>
<ul>
<li>
<p><code>callee</code> 是一个 <strong>MemberExpression</strong> (成员表达式 <code>console.log</code>)。</p>
<ul>
<li><code>object</code>: <code>console</code> (Identifier)</li>
<li><code>property</code>: <code>log</code> (Identifier)</li>
</ul>
</li>
</ul>
<h3 data-id="heading-8">3.2 第二步：编写插件代码</h3>
<p>一个 Babel 插件就是一个函数，返回一个包含 <code>visitor</code> 的对象。</p>
<pre><code class="hljs language-lua" lang="lua">// my-babel-plugin.js
<span class="hljs-built_in">module</span>.exports = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">({ types: t })</span></span> {
  <span class="hljs-keyword">return</span> {
    name: <span class="hljs-string">"remove-console-log"</span>,
    visitor: {
      // 监听 CallExpression 节点
      CallExpression(<span class="hljs-built_in">path</span>) {
        // <span class="hljs-number">1.</span> 获取 callee (被调用的函数，比如 console.<span class="hljs-built_in">log</span>)
        const { callee } = <span class="hljs-built_in">path</span>.node;

        // <span class="hljs-number">2.</span> 判断是否是成员表达式 (MemberExpression)，且不是计算属性 (a[<span class="hljs-string">'b'</span>])
        <span class="hljs-keyword">if</span> (t.isMemberExpression(callee) &amp;&amp; !callee.computed) {
          
          // <span class="hljs-number">3.</span> 检查 object 是不是 <span class="hljs-string">'console'</span>，property 是不是 <span class="hljs-string">'log'</span>
          <span class="hljs-keyword">if</span> (t.isIdentifier(callee.object, { name: <span class="hljs-string">'console'</span> }) &amp;&amp;
              t.isIdentifier(callee.property, { name: <span class="hljs-string">'log'</span> })) {
            
            // <span class="hljs-number">4.</span> 这里的 <span class="hljs-built_in">path</span> 就是 console.<span class="hljs-built_in">log</span>(<span class="hljs-string">'...'</span>) 这一整行
            // 直接由手术刀切除！
            <span class="hljs-built_in">path</span>.<span class="hljs-built_in">remove</span>();
          }
        }
      }
    }
  };
};
</code></pre>
<h3 data-id="heading-9">3.3 第三步：测试效果</h3>
<p><strong>输入：</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">a, b</span>) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'debug:'</span>, a);
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'fatal error'</span>);
  <span class="hljs-keyword">return</span> a + b;
}
</code></pre>
<p><strong>输出：</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">a, b</span>) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'fatal error'</span>);
  <span class="hljs-keyword">return</span> a + b;
}
</code></pre>
<p><em>Bingo！</em> 你刚刚成功完成了一次代码外科手术。</p>
<hr/>
<h2 data-id="heading-10">四、 进阶：作用域 (Scope) 的魔咒</h2>
<p>架构师和普通开发者的区别在于对<strong>副作用</strong>的考虑。 上面的插件有个 Bug：如果用户自己定义了一个叫 <code>console</code> 的变量怎么办？</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">test</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> <span class="hljs-variable language_">console</span> = { <span class="hljs-attr">log</span>: <span class="hljs-function">() =&gt;</span> {} };
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'这不应该被删除'</span>); <span class="hljs-comment">// 我们的插件会错误地删除这一行！</span>
}
</code></pre>
<h3 data-id="heading-11">4.1 作用域检查</h3>
<p>Babel 的 <code>path.scope</code> 提供了强大的作用域分析能力。 我们需要检查：<code>console</code> 这个引用，是否<strong>绑定(Binding)</strong> 到了全局？还是被局部变量覆盖了？</p>
<p><strong>优化后的代码：</strong></p>
<pre><code class="hljs language-less" lang="less"><span class="hljs-selector-tag">CallExpression</span>(path) {
  <span class="hljs-selector-tag">const</span> { <span class="hljs-selector-tag">callee</span> } = <span class="hljs-selector-tag">path</span><span class="hljs-selector-class">.node</span>;
  <span class="hljs-selector-tag">if</span> (t.<span class="hljs-built_in">isMemberExpression</span>(callee) &amp;&amp; 
      t.<span class="hljs-built_in">isIdentifier</span>(callee.object, { <span class="hljs-attribute">name</span>: <span class="hljs-string">'console'</span> }) &amp;&amp;
      t.<span class="hljs-built_in">isIdentifier</span>(callee.property, { <span class="hljs-attribute">name</span>: <span class="hljs-string">'log'</span> })) {

    <span class="hljs-comment">// 【新增】核心检查：获取 'console' 这个标识符的绑定信息</span>
    <span class="hljs-selector-tag">const</span> <span class="hljs-selector-tag">binding</span> = <span class="hljs-selector-tag">path</span><span class="hljs-selector-class">.scope</span><span class="hljs-selector-class">.getBinding</span>(<span class="hljs-string">'console'</span>);
    
    <span class="hljs-comment">// 如果没有绑定（说明是全局变量），才删除</span>
    <span class="hljs-selector-tag">if</span> (!binding) {
      <span class="hljs-selector-tag">path</span><span class="hljs-selector-class">.remove</span>();
    }
  }
}
</code></pre>
<p>现在，Babel 能够识别出局部变量 <code>console</code>，从而放过它。</p>
<hr/>
<h2 data-id="heading-12">五、 总结与脑洞：Babel 还能干什么？</h2>
<p>通过这个简单的例子，你掌握了 Babel 插件的精髓：<strong>Find (Visitor) -&gt; Check (Path/Types) -&gt; Modify (Remove/Replace)</strong> 。</p>
<p>在架构设计中，Babel 插件有无限的潜力：</p>
<ol>
<li><strong>自动埋点：</strong> 找到所有的 Click 事件函数，在函数体第一行自动插入 <code>track('click')</code> 代码。</li>
<li><strong>国际化 (i18n) 提取：</strong> 扫描所有中文字符串，自动提取到 JSON 文件中，并替换为 <code>t('key')</code>。</li>
<li><strong>代码卫士：</strong> 禁止使用某些落后的 API，一旦发现直接构建报错（比 ESLint 更暴力）。</li>
</ol>
<hr/>
<h2 data-id="heading-13">结语：从手术刀到守门员</h2>
<p>我们现在已经拥有了修改代码的手术刀（Babel Plugin）。 但是，手术刀太锋利了，容易伤人。在日常开发中，我们更多时候不需要“修改”代码，而是需要“检查”代码，或者进行大规模的、安全的“自动化重构”。</p>
<p>这时候，我们需要另一套基于 AST 的工具体系。</p>
<blockquote>
<p><strong>Next Step:</strong> 既然我们能分析代码结构，那是不是可以制定一套“代码法律”？ 下一节，我们将探讨**《第三篇：工具——代码质量的守门员：ESLint 原理、自定义规则与 Codemod 自动化重构》**。我们将学习如何编写自定义的 ESLint 规则，以及如何用 Codemod 瞬间修改 1000 个文件。</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[clawbot接入飞书阿里云，立即拥有24小时AI助理贾维斯]]></title>    <link>https://juejin.cn/post/7600581247019646985</link>    <guid>https://juejin.cn/post/7600581247019646985</guid>    <pubDate>2026-01-29T07:36:31.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600581247019646985" data-draft-id="7600344784945971246" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="clawbot接入飞书阿里云，立即拥有24小时AI助理贾维斯"/> <meta itemprop="keywords" content="人工智能,算法"/> <meta itemprop="datePublished" content="2026-01-29T07:36:31.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="阿星AI工作室"/> <meta itemprop="url" content="https://juejin.cn/user/2250051536050763"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            clawbot接入飞书阿里云，立即拥有24小时AI助理贾维斯
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2250051536050763/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    阿星AI工作室
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-29T07:36:31.000Z" title="Thu Jan 29 2026 07:36:31 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/037387fb52d84e4bae719b4a77f07add~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_5pifQUnlt6XkvZzlrqQ=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770276990&amp;x-signature=ysfCNmMQVboTgEw0n1g%2BMrHdQAQ%3D" alt="图片" loading="lazy"/></p>
<p>哈喽大家好，</p>
<p>我是阿星👋</p>
<p>最近clawbot太火了，阿星今天就跟大家介绍部署claw的方法。</p>
<p>这张图是我和 <strong>新AI老公claw</strong> 的聊天记录。聊完我就把老公删了，AI老公太多了😂</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3767ffe38f3742308d68efa35913bbd5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_5pifQUnlt6XkvZzlrqQ=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770276990&amp;x-signature=smzeXvpxVGj%2Buo3bjMQPIbspfXU%3D" alt="图片" loading="lazy"/></p>
<p>今天讲2个方案。</p>
<p>一个是麻烦但是可以装x的飞书，</p>
<p>一个是不麻烦但是不太好装的阿里云。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/360a49373a6a443792066bea7f729687~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_5pifQUnlt6XkvZzlrqQ=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770276990&amp;x-signature=qqEL4ApEh6zw44VDYvzpTi8a0%2Bg%3D" alt="图片" loading="lazy"/></p>
<p>它情绪价值还是很大的，</p>
<p>当然了咱们用的是千问的模型不要想不该想的。</p>
<p>你要换成其他模型那就……</p>
<h2 data-id="heading-0">clawbot是啥</h2>
<p><strong>Moltbot</strong>（原 Clawdbot） 是一款开源的 AI 个人助手，支持本地部署，</p>
<p>兼容 MacOS、Windows 及 Linux 等多种系统，</p>
<p>支持接入常用聊天工具，让用户能够通过自然语言来控制各种设备和服务。</p>
<p>比如他的作用包括但不限于——</p>
<blockquote>
<p>24小时在线的 AI 助手</p>
<p>自动化邮件、日程、提醒等</p>
<p>个人知识库，随时回答你的问题</p>
</blockquote>
<h2 data-id="heading-1">方案一：通过飞书接入</h2>
<h2 data-id="heading-2">部署clawbot</h2>
<p>本地还没clawbot的需要先下载。</p>
<pre><code class="hljs language-bash" lang="bash">git <span class="hljs-built_in">clone</span> https://github.com/moltbot/moltbot.git
<span class="hljs-built_in">cd</span> moltbot

pnpm install
pnpm ui:build <span class="hljs-comment"># auto-installs UI deps on first run</span>
pnpm build

pnpm moltbot onboard --install-daemon

<span class="hljs-comment"># Dev loop (auto-reload on TS changes)</span>
pnpm gateway:watch
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/494ce102c55b42a8a7c39c2279a3e6d1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_5pifQUnlt6XkvZzlrqQ=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770276990&amp;x-signature=SvoAuGSFB1GnDJmBDu5sBlviBpY%3D" alt="图片" loading="lazy"/></p>
<p>注意确认 Node.js 版本，clawdbot 要求 Node &gt;=22。</p>
<p>如果不是 22+，需要先升级 Node （你用 nvm / fnm / brew 都行）</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ccd75841dc7e4f2292aa933b20c18c5d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_5pifQUnlt6XkvZzlrqQ=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770276990&amp;x-signature=TZwVMnYYu%2FOomYb2jWJqOJ%2FG0Kw%3D" alt="图片" loading="lazy"/></p>
<p>安装之后，会问你几个问题，依次选择选择 “Yes”、选择 “QuickStart”、"Skip for now"、"All providers"、默认配置、“Skip for now”、“No”即可。反正就是那种事儿多的要求先不处理。</p>
<h2 data-id="heading-3"><strong>创建飞书机器人</strong></h2>
<p>这是实现  <strong>“在飞书里跟你的clawbot”</strong>  的关键。</p>
<ol>
<li>1. <strong>造个应用</strong> ：登录 <strong>飞书开放平台</strong> ，点击 <strong>「创建企业自建应用」</strong> 。</li>
</ol>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bd85db4985404d57bcf2e21e8eeb1da1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_5pifQUnlt6XkvZzlrqQ=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770276990&amp;x-signature=Wr56Iwi06i%2FnikVp0b2OfXbhSCI%3D" alt="图片" loading="lazy"/></p>
<ol>
<li>2. <strong>添加机器人</strong> ：在应用里，找到  <strong>“添加应用能力” -&gt; “机器人”</strong>  ，打开它。</li>
</ol>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6f119397405e46219deb5e9bdbbd5a7e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_5pifQUnlt6XkvZzlrqQ=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770276990&amp;x-signature=7WXEhXG4UY9Rp3mTMGYkuDoBX4o%3D" alt="图片" loading="lazy"/></p>
<ol>
<li>
<p>3. <strong>给足权限</strong> （在「权限管理」里搜，这几个必须勾上）：</p>
<p>  获取用户基本信息</p>
<p>  获取群组信息</p>
<p>  获取与发送单聊、群组消息</p>
<p>  查看消息表情回复</p>
<p>  ……</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/962570bc5a3a40cca8dfa16d5ee3057b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_5pifQUnlt6XkvZzlrqQ=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770276990&amp;x-signature=BWH%2Bh2yRejcZzddZ65TRvlCIk6U%3D" alt="图片" loading="lazy"/></p>
</li>
<li>
<p>4. <strong>拿好凭证</strong> ：在 <strong>「凭据与基础信息」</strong> 里，复制 <strong>App ID</strong> 和 <strong>App Secret</strong> ，下一步马上用。</p>
</li>
</ol>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/196abd3288b946e88112dda18da77b1a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_5pifQUnlt6XkvZzlrqQ=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770276990&amp;x-signature=xZCm7%2Bx33zwZa%2BHTT5OyatrMQ64%3D" alt="图片" loading="lazy"/></p>
<h2 data-id="heading-4">核心联通：对齐“claw大脑”与飞书</h2>
<p>接下来，请在终端依次执行这三步</p>
<h3 data-id="heading-5"><strong>1、安装飞书插件</strong></h3>
<pre><code class="hljs language-bash" lang="bash">clawdbot plugins install @m1heng-clawd/feishu
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5b392763bf124935a37f4934661914f1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_5pifQUnlt6XkvZzlrqQ=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770276990&amp;x-signature=zVKcVpe0FsK3%2Fav1Uzf8J7ICtJ0%3D" alt="图片" loading="lazy"/></p>
<p>就可以看到插件已经安装成功了</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e7d59b660e814b258a48efb2c51baad9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_5pifQUnlt6XkvZzlrqQ=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770276990&amp;x-signature=jCggQqH9E17T6NNhTr5eq%2F2f%2B1k%3D" alt="图片" loading="lazy"/></p>
<p>查看是否已自动加载已安装的飞书插件。</p>
<pre><code class="hljs language-perl" lang="perl">clawdbot plugins list | <span class="hljs-keyword">grep</span> feishu
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e20ca69cd19d401887bc0af702bf9195~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_5pifQUnlt6XkvZzlrqQ=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770276990&amp;x-signature=pZTlvCkG8VNGAmr%2BGjYJ3KhkQsg%3D" alt="图片" loading="lazy"/></p>
<h3 data-id="heading-6"><strong>2、配置百炼“大脑” (解决 404 与协议问题)：</strong></h3>
<p>由于 Moltbot 源码版对供应商协议的识别存在偏差。</p>
<p>如果你前面胡乱捯饬了配置这里就容易出错。</p>
<p>我们将强制使用官方推荐的 <code>bailian</code> 模式，</p>
<p>此命令强行开启 <code>openai-completions</code> 协议模式，确保请求精准命中阿里云 API。</p>
<blockquote>
<p><em>请将</em> <em><code>你的API-KEY</code></em> <em>替换为阿里云百炼后台拿到的真实 Key。</em></p>
</blockquote>
<pre><code class="hljs language-swift" lang="swift">clawdbot config <span class="hljs-keyword">set</span> models.providers.bailian '{<span class="hljs-string">"baseUrl"</span>:<span class="hljs-string">"https://dashscope.aliyuncs.com/compatible-mode/v1"</span>,<span class="hljs-string">"apiKey"</span>:<span class="hljs-string">"你的API-KEY"</span>,<span class="hljs-string">"api"</span>:<span class="hljs-string">"openai-completions"</span>,<span class="hljs-string">"models"</span>:[{<span class="hljs-string">"id"</span>:<span class="hljs-string">"qwen-vl-plus"</span>,<span class="hljs-string">"name"</span>:<span class="hljs-string">"Qwen VL Plus"</span>}]}'
</code></pre>
<h3 data-id="heading-7"><strong>3、绑定飞书并重启网关</strong></h3>
<blockquote>
<p><em>请替换为你自己的**飞书</em> <em><code>AppID</code></em> <em>和</em> <em><code>Secret</code>**。</em></p>
</blockquote>
<p>Bash</p>
<pre><code class="hljs language-swift" lang="swift">clawdbot config <span class="hljs-keyword">set</span> channels.feishu '{<span class="hljs-string">"enabled"</span>:<span class="hljs-literal">true</span>,<span class="hljs-string">"appId"</span>:<span class="hljs-string">"你的AppID"</span>,<span class="hljs-string">"appSecret"</span>:<span class="hljs-string">"你的AppSecret"</span>,<span class="hljs-string">"connectionMode"</span>:<span class="hljs-string">"websocket"</span>,<span class="hljs-string">"groupPolicy"</span>:<span class="hljs-string">"open"</span>}'
clawdbot config <span class="hljs-keyword">set</span> agents.defaults.model.primary <span class="hljs-string">"bailian/qwen-vl-plus"</span># 必须重启，让 <span class="hljs-type">Moltbot</span> 主动去勾搭飞书，后续后台保存才能通过
clawdbot gateway restart
</code></pre>
<p><strong>阿星提示：</strong>  只有重启网关后，再去飞书后台点击“保存长连接”，你会发现长连接瞬间变绿，彻底联通。</p>
<h2 data-id="heading-8"><strong>飞书后台激活</strong></h2>
<ol>
<li>
<p>1. <strong>开启长连接</strong> ：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/92c0d4f00dee4decbbbc8d7b71f52449~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_5pifQUnlt6XkvZzlrqQ=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770276990&amp;x-signature=lpwghV8Oi4GIHARvPh9ksphZin4%3D" alt="图片" loading="lazy"/></p>
</li>
<li>
<ol>
<li>
<ol>
<li>回到飞书开发者后台，进入 <strong>「事件与回调」</strong> 。</li>
</ol>
</li>
<li>
<ol start="2">
<li>订阅方式选择 <strong>「使用长连接」</strong> （因为你上一步已经在云端启动好了，这里直接点保存就能成功）。</li>
</ol>
</li>
</ol>
</li>
</ol>
<p>然后点击右边添加事件加权限。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ed17eaee852e4b1f8609ec669b10e062~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_5pifQUnlt6XkvZzlrqQ=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770276990&amp;x-signature=pJ5tWpMlF2RnM%2Fz5TcZtBN7l2SY%3D" alt="图片" loading="lazy"/></p>
<ol>
<li>3. <strong>发布上线</strong> ：进入 <strong>「版本管理与发布」</strong> ， <strong>创建版本</strong> （版本号随便写，比如1.0.0），然后 <strong>保存并发布。</strong></li>
</ol>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/502f61fca7a844be801d824580e3263c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_5pifQUnlt6XkvZzlrqQ=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770276990&amp;x-signature=wyc5QBOnSf%2FlMlEXXa2xWdw1nko%3D" alt="图片" loading="lazy"/></p>
<ol>
<li>
<ol start="4">
<li>如果你想添加到外部群，在 <strong>版本管理与发布</strong> 页面右上角，点击 <strong>创建版本</strong> 。在 <strong>版本详情</strong> 页面选中 <strong>允许机器人被添加到外部群中使用</strong> 。但是企业必须完成企业法人认证或加盖公章授权书认证（团队认证不支持）才可以使用应用对外共享能力。</li>
</ol>
</li>
</ol>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7de7cc2095a64e2ea91140a9db8fb66d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_5pifQUnlt6XkvZzlrqQ=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770276990&amp;x-signature=A%2F2EaKQrmkpqgDW5fkmdXWf8hi0%3D" alt="图片" loading="lazy"/></p>
<ol>
<li>
<ol start="5">
<li>所以我没对外建群，直接自己群里添加自己的机器人。</li>
</ol>
</li>
</ol>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5762fa37634e4cd09f8e7c0684200e7d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_5pifQUnlt6XkvZzlrqQ=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770276990&amp;x-signature=bE41w9NYrahmRE8yThGn0L5Cu0w%3D" alt="图片" loading="lazy"/></p>
<p>它就能给你畅聊了，你的代价就一点阿里云key而已。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/94e244661eb94b9ab7bef08982c7ff98~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_5pifQUnlt6XkvZzlrqQ=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770276990&amp;x-signature=JPvXndYLqWMTPRcBFYaLM1fTFVs%3D" alt="图片" loading="lazy"/></p>
<h2 data-id="heading-9">方案二：通过阿里云接入</h2>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/497f3b735bb84c07af90eb9901c4d1bd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_5pifQUnlt6XkvZzlrqQ=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770276990&amp;x-signature=AjT9qtxNdtzy1JjkXsyfNga2L4s%3D" alt="图片" loading="lazy"/></p>
<p>这步最省心，因为阿里云把 <strong>环境都给你装好了</strong> ，不用你吭哧吭哧敲命令。</p>
<ol>
<li>
<p>1. <strong>租服务器</strong> ：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2b79b4411ca547d099fe70546ff75851~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_5pifQUnlt6XkvZzlrqQ=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770276990&amp;x-signature=3uHbT1y1U9umYEdCUF%2BFnEFkGsg%3D" alt="图片" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2ff601c7b8214ff28396cf0aa6e36d1d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_5pifQUnlt6XkvZzlrqQ=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770276990&amp;x-signature=Ipj4YEY6TtZXM8CGiJXLdtsdSWY%3D" alt="图片" loading="lazy"/></p>
</li>
<li>
<ol>
<li>5. <strong>最关键一步</strong> ：镜像务必选 <strong>「Moltbot」</strong> （这就是Clawdbot的新家，一键全包）。</li>
</ol>
</li>
<li>
<ol>
<li>
<ol start="3">
<li>选择按月付费，下个月大家不一定玩儿了。</li>
</ol>
</li>
</ol>
</li>
<li>
<ol>
<li>
<ol>
<li>去 <strong>阿里云控制台</strong> ，找  <strong>“轻量应用服务器”</strong>  。</li>
</ol>
</li>
</ol>
</li>
</ol>
<ul>
<li>• 然后去百炼云拿key</li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/37bd0e0bc2c447c0803fc8de1e235235~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_5pifQUnlt6XkvZzlrqQ=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770276990&amp;x-signature=mtkDVB2gEB6q0zvlweWPbKRmqlI%3D" alt="图片" loading="lazy"/></p>
<p>右上角随便创建一个就可以了。</p>
<ol>
<li>
<p>2. <strong>开个门</strong> ：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/eac9453c6f874fe2aa28e7e3d8d2967e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_5pifQUnlt6XkvZzlrqQ=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770276990&amp;x-signature=C6y1wG%2Fd5VnuKhoCt63pQMQ8JiA%3D" alt="图片" loading="lazy"/></p>
</li>
<li>
<ol>
<li>
<ol>
<li>在服务器控制台的「应用详情」  <strong>，无脑放行 <code>18789</code> 端口</strong> （这是后续用浏览器管理后台的入口）。</li>
</ol>
</li>
</ol>
</li>
<li>
<p>3. <strong>配把“钥匙”</strong>  ：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8649732b54c54dd8b8216fb467007422~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_5pifQUnlt6XkvZzlrqQ=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770276990&amp;x-signature=po1aJG2mWwUvvhfUMADFojm91do%3D" alt="图片" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a879437eb44444f3ba922bced5f06e4d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_5pifQUnlt6XkvZzlrqQ=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770276990&amp;x-signature=%2BtgCvklcs%2FeTd3HncmSAGBevlmc%3D" alt="图片" loading="lazy"/></p>
</li>
<li>
<ol>
<li>
<ol start="3">
<li>复制保存好。</li>
</ol>
</li>
</ol>
</li>
<li>
<ol>
<li>
<ol>
<li>去 <strong>阿里云百炼控制台</strong> ，在「API-KEY」管理里 <strong>创建一个新的Key</strong> ，</li>
</ol>
</li>
</ol>
</li>
<li>
<p>4. <strong>一键配置</strong> ：</p>
<p>  就可以看到自己的clawbot了。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fca91e42fab4450981bc822e18347419~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_5pifQUnlt6XkvZzlrqQ=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770276990&amp;x-signature=D0USBgxOwkHSJFv3maGhpWfc3AI%3D" alt="图片" loading="lazy"/></p>
</li>
<li>
<ol>
<li>
<ol>
<li>回到服务器「应用详情」，点击 <strong>「一键配置」.</strong>  把刚才的百炼API Key贴进去，执行。搞定，AI大脑初始化完毕。</li>
</ol>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7bbb3b4fe0df4ccc888b8e4c7d911895~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_5pifQUnlt6XkvZzlrqQ=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770276990&amp;x-signature=vhCJ%2B0EZaljPYnLcM3C%2Bsj4c%2Foo%3D" alt="图片" loading="lazy"/></p>
<p>    然后点击打开页面后面的执行命令，</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/410bb0c7154340c4a06ba9784e5cec2d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_5pifQUnlt6XkvZzlrqQ=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770276990&amp;x-signature=GjE%2F3jQgwRSTFUUGzJbtVI05WEI%3D" alt="图片" loading="lazy"/></p>
<p>    就能看到地址，</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/65ee2bfd83bb43b4840786707c3c65ef~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_5pifQUnlt6XkvZzlrqQ=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770276990&amp;x-signature=wkO6QHtp2iNAYHoSZfgsdrmcogk%3D" alt="图片" loading="lazy"/></p>
</li>
</ol>
</li>
</ol>
<p>到了这个阶段你就已经能在阿里云上用了。测试一下即可。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6ef5ae26e10b49daba8d4f5e4f3e2d0b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_5pifQUnlt6XkvZzlrqQ=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770276990&amp;x-signature=x50ndH9IkEyb98OpTPu6FhNqOqc%3D" alt="图片" loading="lazy"/></p>
<p>这套路子的最大好处，就是 <strong>阿里云帮你扛下了所有环境配置的脏活累活</strong> ，你只需要专注于“连接”和“使用”。就是 <strong>专门给“不想折腾命令行”的朋友准备的。</strong></p>
<p>然后再往下看raw，就可以配置其他模型json</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5c12cb36746a475fbd39ed3f4acd7f3b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_5pifQUnlt6XkvZzlrqQ=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770276990&amp;x-signature=ZlNXjd%2FsVwEbj4vV3WmTjoDuHFU%3D" alt="图片" loading="lazy"/></p>
<p>从此，你的飞书和阿里云里就住进了一个 <strong>永不下线、随叫随到的云端大脑</strong> 。</p>
<p>ok我是阿星更多AI应用</p>
<p>我们下期再见👋</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c3da9c2bb91b4472a1d88bf2f6b16443~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_5pifQUnlt6XkvZzlrqQ=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770276990&amp;x-signature=1Rf9Oa%2FAPVx%2FPGlRqMyVojjllW4%3D" alt="8e230dd104215678d7d8e7eaea1f3090.jpg" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[AAAI 2026｜基于思维链与强化学习的可解释多模态广告审核护栏]]></title>    <link>https://juejin.cn/post/7600344784946118702</link>    <guid>https://juejin.cn/post/7600344784946118702</guid>    <pubDate>2026-01-29T07:41:18.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600344784946118702" data-draft-id="7600344784946053166" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="AAAI 2026｜基于思维链与强化学习的可解释多模态广告审核护栏"/> <meta itemprop="keywords" content="前端,后端,架构"/> <meta itemprop="datePublished" content="2026-01-29T07:41:18.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="快手技术"/> <meta itemprop="url" content="https://juejin.cn/user/3736571181793721"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            AAAI 2026｜基于思维链与强化学习的可解释多模态广告审核护栏
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3736571181793721/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    快手技术
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-29T07:41:18.000Z" title="Thu Jan 29 2026 07:41:18 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>你是否刷到过这样的短视频广告：如何在家躺着日赚几百块”、“通过手相预测未来姻缘”。在快手商业化广告素材审核过程中，快手商业化生态与体验团队每天也会拦截大量的风险素材。这些内容轻则破坏用户体验、损伤商业化生态，重则触及底线问题、危害整个商业化业务。团队的任务是通过技术手段将下述这些不同的风险都识别出来并拦截。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8c862003c8a64886b043b7aed1e50b55~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b-r5omL5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770277277&amp;x-signature=KBhZHw3HRr6pscY94RbvMuS8KBM%3D" alt="" loading="lazy"/></p>
<p>图 1 风险素材案例</p>
<p>与传统的显性风险不同，商业广告的违规往往隐藏在跨模态的错位中——画面合规但口播违规、字幕合规但暗示性极强。这类“高风险、强对抗”的内容，对审核系统提出了极高的要求：不仅要判得准（准确性），还要说得清（可解释性），更要跟得上政策的快速迭代（政策对齐）。面对这一挑战，传统的“黑盒”判别模型或通用多模态大模型（VLM）往往力不从心：前者缺乏因果推理能力，后者难以适应细粒度的商业审核策略。</p>
<p>为解决这一痛点，快手商业生态与体验算法团队提出了 BLM-Guard，这是一个专为高风险短视频广告设计的可解释性多模态审核框架。该框架融合了多模态思维链（CoT）推理与策略对齐的强化学习（RL），通过模拟人类审核员的“观察-归因-判断”逻辑，提升了模型在商业化场景下的审核精度与推理一致性。</p>
<p>本研究相关成果《BLM-Guard: Explainable Multimodal Ad Moderation with Chain-of-Thought and Policy-Aligned Rewards》已被人工智能顶级会议 AAAI 2026（Main Track） 接收。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b31b113da8b345b096cc59f5dae20d35~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b-r5omL5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770277277&amp;x-signature=qIN8aKWHtQ8pYge%2Byf2Vl4OoQP8%3D" alt="" loading="lazy"/></p>
<p>图 2 BLM-Guard 两阶段训练框架示意图</p>
<p><strong>核心亮点：</strong></p>
<ul>
<li>【像审核员一样思考】 针对短视频广告违规隐蔽性强的问题，本文提出 ICoT（Interleaved-modal Chain-of-Thought） 流水线。通过规则驱动的数据合成，生成包含“视觉定位-风险筛查-因果分析-最终判决”的结构化推理链，解决模型“只知其一不知其二”的黑盒问题。</li>
<li>【动态策略自适应】 面对不断变化的审核规则，创新性提出 SCA-R（Self-Adaptive Critique Reward） 奖励机制。基于动态原则对模型的推理过程进行打分，结合 GRPO 强化学习算法，确保模型在策略漂移下仍能保持高一致性。</li>
<li>【首个多模态广告风控基准】 发布了 BLM-Guard Benchmark，这是业界首个包含三级风险分类体系（风险场景、违规类型、严重程度）的短视频广告数据集，涵盖非法内容、虚假营销、误导性操作等七大核心场景，填补了精细化广告审核评测的空白。</li>
</ul>
<h2 data-id="heading-0">一、研究背景</h2>
<p>随着短视频商业化深入，广告已成为平台核心支柱，但违规内容日益呈现“隐蔽化、协同化、对抗化”趋势。这种高风险、强对抗的业态对现有的审核体系提出了严峻挑战，主要体现在以下三个维度：</p>
<ol>
<li>违规形态演变</li>
</ol>
<p>多模态协同欺骗生成式 AI 的普及使得违规手段从单一的显性违规（如敏感词、违规画面）升级为“多模态协同欺骗”。这类内容通常单模态看似合规，但通过跨模态的信息错位（如画面正常但口播违规）传递恶意意图，极大地增加了识别难度。</p>
<ol start="2">
<li>审核标准困境</li>
</ol>
<p>动态性与复杂性的多重矛盾商业广告审核面临政策、场景与风险的三重复杂性：</p>
<ul>
<li>
<p>政策漂移与规则适配： 法规（如《广告法》）与平台规范的动态更新，导致静态模型难以适应不断漂移的政策边界。</p>
</li>
<li>
<p>场景差异与通用性： 医疗、金融、教育等不同行业审核逻辑迥异，通用模型难以兼顾细粒度的领域规则。</p>
</li>
<li>
<p>风险分层与二元判决： 现有模型多为“通过/拦截”的二元判决，无法区分高风险（非法）、中风险（误导）与低风险（体验）内容，难以满足精细化运营需求。</p>
</li>
</ul>
<ol start="3">
<li>行业落地诉求</li>
</ol>
<p>从“黑盒”到全链路可解释审核不仅是技术判别，更需服务于平台监管、商家整改与合规追溯的全链路。传统规则模型泛化差，通用大模型（VLM）虽有理解力但决策过程如“黑盒”，缺乏结构化的归因逻辑。商家无法获知具体违规点，监管难以追溯证据链，且行业缺乏针对多模态协同违规的高质量数据集。</p>
<p>面对上述“违规识别难、规则适配难、结果落地难”的困境，本研究提出 BLM-Guard 框架。通过引入模拟人类审核逻辑的“多模态思维链（CoT）”与策略对齐的强化学习（RL），旨在实现对隐蔽违规的精准识别与动态政策适配，并构建业界首个精细化多模态广告风控基准，为短视频商业生态的安全与可持续发展提供技术支撑。</p>
<h2 data-id="heading-1">二、技术方案</h2>
<p>BLM-Guard 采用了一种渐进式的“两阶段”训练范式，分别是第一阶段中规则锚定的 ICoT 冷启动（Rule-Anchored SFT）和第二阶段中基于 SCA-R 的强化学习（Self-Consistency RL），确保模型既能学到规则，又能灵活应用。</p>
<h3 data-id="heading-2">2.1 第一阶段：规则锚定的 ICoT 冷启动</h3>
<p>这一阶段的目标不是简单地微调 VLM，而是解决“黑盒模型无法理解细粒度商业规则”的问题。</p>
<h4 data-id="heading-3">2.1.1 数据构造——自适应关键帧与 ICoT 生成</h4>
<p>为了让模型“看懂”违规细节，采用了一套新的提取流程 ：</p>
<ol>
<li>自适应关键帧采样 (AKS):</li>
</ol>
<ul>
<li>
<p>CLIP 相似度筛选： 计算每一帧图像嵌入<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>v</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">v_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span>与预定义风险提示词（如"false marketing", "illegal content"）嵌入 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>t</mi><mi>k</mi></msub></mrow><annotation encoding="application/x-tex">t_k</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7651em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">t</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span>的余弦相似度 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>s</mi><mi>i</mi><mtext>​</mtext><mo>=</mo><mi>m</mi><mi>a</mi><mi>x</mi><mi>k</mi><mtext>​</mtext><mo stretchy="false">(</mo><mi>v</mi><mi>i</mi><mi>T</mi><mtext>​</mtext><mi>t</mi><mi>k</mi><mtext>​</mtext><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">si​=maxk​(viT​tk​)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6595em;"/><span class="mord mathnormal">s</span><span class="mord mathnormal">i</span><span class="mord">​</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal">ma</span><span class="mord mathnormal">x</span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mord">​</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="mord mathnormal">i</span><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="mord">​</span><span class="mord mathnormal">t</span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mord">​</span><span class="mclose">)</span></span></span></span></span>。</p>
</li>
<li>
<p>BIN+TOP 策略： 将视频划分为<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>m</mi></mrow><annotation encoding="application/x-tex">m</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"/><span class="mord mathnormal">m</span></span></span></span></span>个时间桶（BIN）选局部最优，若不足则补充全局最高分帧，确保既有时间覆盖又有语义显著性 。</p>
</li>
</ul>
<p>2.Patch 级区域定位： 使用 InternViT-6B 提取 Patch 特征，计算 L2 范数作为显著性分数<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>s</mi><mi>c</mi><mi>o</mi><mi>r</mi><mi>e</mi><mi>i</mi><mo separator="true">,</mo><mi>p</mi><mtext>​</mtext><mo>=</mo><mo>∣</mo><mo>∣</mo><mi>H</mi><mi>i</mi><mo stretchy="false">(</mo><mi>p</mi><mo stretchy="false">)</mo><mtext>​</mtext><mo>∣</mo><mo>∣</mo><mn>2</mn><mtext>​</mtext></mrow><annotation encoding="application/x-tex">scorei,p​=∣∣Hi(p)​∣∣2​</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal">score</span><span class="mord mathnormal">i</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal">p</span><span class="mord">​</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=∣∣</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.08125em;">H</span><span class="mord mathnormal">i</span><span class="mopen">(</span><span class="mord mathnormal">p</span><span class="mclose">)</span><span class="mord">​</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">∣∣</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">2​</span></span></span></span></span>，定位出关键图像区域（如字幕、产品特写） 。</p>
<ol start="3">
<li>ICoT（交错模态思维链）生成：利用冻结的 InternVL-3-78B 作为教师模型，生成结构化的推理链：</li>
</ol>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6dc9dc75c67a4bae95edd67f5cce9180~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b-r5omL5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770277277&amp;x-signature=gm%2BJH0Q62JddgH4pX1eU%2Fm5a%2BoY%3D" alt="" loading="lazy"/></p>
<h4 data-id="heading-4">2.1.2 训练目标——引入规则先验</h4>
<p>在 SFT 阶段，BLM-Guard 修改了标准的 Cross-Entropy 损失，加入了 KL 散度约束 ：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/21871f7d381f4728ba1aedafb8202fe6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b-r5omL5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770277277&amp;x-signature=Rot%2B%2F%2BatsLjRjIBCs8KfCNVg8SA%3D" alt="" loading="lazy"/></p>
<ul>
<li><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>L</mi><mi>C</mi><mi>E</mi><mtext>​</mtext></mrow><annotation encoding="application/x-tex">LCE​</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal">L</span><span class="mord mathnormal" style="margin-right:0.05764em;">CE</span><span class="mord">​</span></span></span></span></span>: 保证最终判罚（Answer）的准确性 。</li>
<li><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>K</mi><mi>L</mi><mo stretchy="false">(</mo><mi>p</mi><mi>t</mi><mi>h</mi><mi>i</mi><mi>n</mi><mi>k</mi><mtext>​</mtext><mo>∣</mo><mo>∣</mo><mi>p</mi><mi>r</mi><mi>u</mi><mi>l</mi><mi>e</mi><mtext>​</mtext><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">KL(pthink​∣∣prule​)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="mord mathnormal">L</span><span class="mopen">(</span><span class="mord mathnormal">pt</span><span class="mord mathnormal" style="margin-right:0.03148em;">hink</span><span class="mord">​</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">∣∣</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal">p</span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mord mathnormal">u</span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord mathnormal">e</span><span class="mord">​</span><span class="mclose">)</span></span></span></span></span>: 这是一个关键设计。prule​是基于违规场景关键词构建的软分布。该项强制模型的推理过程中的 token 分布向这些规则关键词靠拢，防止模型推理“跑偏”或产生幻觉 。</li>
</ul>
<h3 data-id="heading-5">2.2 第二阶段：基于 SCA-R 的强化学习</h3>
<p>SFT 模型虽然具备了初步推理能力，但在面对由于政策快速迭代导致的“策略漂移”时，泛化性不足。该阶段引入了 GRPO（Group-wise Relative Policy Optimization）算法进行优化。其中，混合奖励函数设计如下：</p>
<p>为了平衡准确性、格式规范和逻辑一致性，奖励函数由三部分组成 ：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6fab3dd93ecb48ed98d8ba887651a1d8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b-r5omL5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770277277&amp;x-signature=FZm3Tg4CywP3Gk03P7WoH%2F7ohuI%3D" alt="" loading="lazy"/></p>
<ul>
<li><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>r</mi><mi>r</mi><mi>u</mi><mi>l</mi><mi>e</mi></mrow><annotation encoding="application/x-tex">rrule</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"/><span class="mord mathnormal" style="margin-right:0.02778em;">rr</span><span class="mord mathnormal">u</span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord mathnormal">e</span></span></span></span></span>​(规则正确性): 离散奖励。如果场景和违规类型全对给 1.0，仅场景对给 0.5，否则为 0 。</li>
<li><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>r</mi><mi>f</mi><mi>o</mi><mi>r</mi><mi>m</mi><mi>a</mi><mi>t</mi></mrow><annotation encoding="application/x-tex">rformat</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"/><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mord mathnormal" style="margin-right:0.02778em;">or</span><span class="mord mathnormal">ma</span><span class="mord mathnormal">t</span></span></span></span></span>​(结构约束)：强约束奖励，确保输出严格包含和标签，便于后续解析 。</li>
<li><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>r</mi><mi>s</mi><mi>c</mi><mi>a</mi><mi>R</mi></mrow><annotation encoding="application/x-tex">rscaR</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal">rsc</span><span class="mord mathnormal">a</span><span class="mord mathnormal" style="margin-right:0.00773em;">R</span></span></span></span></span>​(SCA-R: 自适应批判奖励):</li>
</ul>
<p>动态 Critique: 引入一个 Guide Model（ GPT-4o），它不依赖静态标签，而是 根据当前的审核 Policy 和输入，动态构建评分原则 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>P</mi><mo>=</mo><mrow><mi>p</mi><mi>k</mi><mtext>​</mtext></mrow></mrow><annotation encoding="application/x-tex">P={pk​}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"/><span class="mord"><span class="mord mathnormal">p</span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mord">​</span></span></span></span></span></span>。</p>
<p>评分逻辑: Critic 针对推理链进行打分（0, 0.5, 1），计算加权和：<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>r</mi><mi>s</mi><mi>c</mi><mi>a</mi><mi>R</mi><mtext>​</mtext><mo>=</mo><mo>∑</mo><mi>w</mi><mi>k</mi><mtext>​</mtext><mo>⋅</mo><mi>s</mi><mi>c</mi><mi>o</mi><mi>r</mi><mi>e</mi><mi>p</mi><mi>k</mi><mtext>​</mtext></mrow><annotation encoding="application/x-tex">rscaR​=∑wk​⋅scorepk​</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal">rsc</span><span class="mord mathnormal">a</span><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="mord">​</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mop op-symbol small-op" style="position:relative;top:0em;">∑</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mord">​</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"/><span class="mord mathnormal">score</span><span class="mord mathnormal">p</span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mord">​</span></span></span></span></span>​。这解决了“判决对了但理由错了”的逻辑一致性问题。</p>
<h3 data-id="heading-6">2.3 总结</h3>
<p>从技术架构角度看，BLM-Guard 的核心壁垒在于：</p>
<ul>
<li>显式因果建模： 通过 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>K</mi><mi>L</mi></mrow><annotation encoding="application/x-tex">KL</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="mord mathnormal">L</span></span></span></span></span>散度将规则“注入”到模型的隐空间推理路径中。</li>
<li>抗策略漂移： 利用<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>r</mi><mi>s</mi><mi>c</mi><mi>a</mi><mi>R</mi></mrow><annotation encoding="application/x-tex">rscaR</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal">rsc</span><span class="mord mathnormal">a</span><span class="mord mathnormal" style="margin-right:0.00773em;">R</span></span></span></span></span>​ 动态奖励，使得模型不仅拟合数据分布，更是在拟合“审核逻辑”，从而适应不断变化的业务规则。</li>
</ul>
<h2 data-id="heading-7">三、效果性能</h2>
<h3 data-id="heading-8">3.1 核心指标</h3>
<p>在构建的 BLM-Guard Benchmark 以及 UCF 等五个公开数据集上，BLM-Guard 均展现了 SOTA（State-of-the-Art）性能。</p>
<ol>
<li>
<p>准确率提升：相比 Qwen2.5-VL、InternVL3-8B 等强力基线，BLM-Guard 在七大风险场景下的严格准确率（Strict Accuracy） 平均提升超过 20%，尤其在“虚假营销”和“误导性操作”等高难度场景表现突出。</p>
</li>
<li>
<p>推理一致性：通过 GPT-4o 进行的一致性评分显示，BLM-Guard 的推理逻辑得分达 0.845，超基线模型的 0.5-0.6 水平。这意味着模型不仅判得对，而且理由充分、逻辑自洽。</p>
</li>
</ol>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ee4fea6934dd4defb2c527cf4394e384~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b-r5omL5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770277277&amp;x-signature=ONSOAzWZB%2B1vivZ8jjZGpyiKxFg%3D" alt="" loading="lazy"/></p>
<p>图 3 BLM-Guard Benchmark 风险分类体系</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/06cf1b9d5e174c729fde3a7b783f4ee8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b-r5omL5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770277277&amp;x-signature=nCAIOHfGUJkTduMhP9umqvLNd90%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-9">3.2 消融实验</h3>
<p>实验证明，“规则微调（Rule-SFT）+ SCA-R 强化学习” 的组合是性能提升的关键。仅依靠 SFT，模型容易产生幻觉；而加入 SCA-R 后，模型学会了在不确定时更加谨慎，提升了模型的泛化效果。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5488373245054383ae8cdf0f8eb4fc50~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b-r5omL5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770277277&amp;x-signature=8R3GhXSyP5NEZiEcDDeYfkioKcY%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-10">四、未来展望</h2>
<p>快手商业生态与体验研发中心始终致力于用技术守护快手广告的清朗。</p>
<p>未来，团队将继续深耕以下方向：</p>
<ol>
<li>
<p>理解+生成 OneModel：探索理解+生成深度融合的 oneModel 新范式，进一步精准识别违规内容，同时引入营销视角生成高转化、有吸引力的修复建议，提升商家体验；</p>
</li>
<li>
<p>风控大模型基座 KwaiBLM：自主研发 KwaiBLM 风控大模型基座，作为风控领域的统一认知底座，支撑内容理解、风险识别、策略生成等多项核心能力，推动风控从经验驱动向数据智能驱动转型；</p>
</li>
<li>
<p>RiskAgent 智能体：构建多 Agent 协作的智能体系统，建设下一代人机协同的智能风控引擎 RiskMatrix，提升业务场景风险防控效率与防控效果；</p>
</li>
<li>
<p>Deepfake 攻防能力：针对 AI 生成内容带来的新型风险，构建 Deepfake 检测与对抗技术体系。通过多模态特征融合、内容理解等技术手段，提升识别 AI 生成的虚假素材、篡改内容、合成视频等，守护平台内容真实性；</p>
</li>
<li>
<p>动态图算法：探索融合图神经网络与 Attention 机制，将 Graph RAG 图表征能力与大模型 KwaiBLM 相结合提升识别能力，挖掘隐蔽关联风险。</p>
</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[IDEA 里终于能爽用 Claude Code了！]]></title>    <link>https://juejin.cn/post/7599975633478647846</link>    <guid>https://juejin.cn/post/7599975633478647846</guid>    <pubDate>2026-01-28T09:31:25.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7599975633478647846" data-draft-id="7600068892988424202" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="IDEA 里终于能爽用 Claude Code了！"/> <meta itemprop="keywords" content="Java,IntelliJ IDEA"/> <meta itemprop="datePublished" content="2026-01-28T09:31:25.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="JavaGuide"/> <meta itemprop="url" content="https://juejin.cn/user/166781497383294"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            IDEA 里终于能爽用 Claude Code了！
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/166781497383294/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    JavaGuide
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-28T09:31:25.000Z" title="Wed Jan 28 2026 09:31:25 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-28
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>如果你是 JetBrains 家 IDE 的重度用户，大概率有过这样的体验：想用 Claude Code、Codex 这类终端 AI 工具时，只能在 Terminal 里跑着用。这些 CLI 工具虽强大，但缺少原生 UI 交互，体验上有些局限。虽然可以通过 <a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FGYaq_HNo5mKh2WjWtuEMyg" target="_blank" title="https://mp.weixin.qq.com/s/GYaq_HNo5mKh2WjWtuEMyg" ref="nofollow noopener noreferrer">Claude Code UI 类开源项目</a>来缓解，如 vibe kanban、1Code，但在写代码这件事上，没有什么比“在熟悉的 IDE 面板里直接对话”更爽了。</p>
<p>2025 年底，JetBrains 给 AI Assistant 插件更新了一个重磅功能：<strong>支持自定义 ACP（Agent Client Protocol）配置</strong>。这意味着你现在可以把任何支持 ACP 的 Agent 接入到 AI Assistant 里，包括 Claude Code。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8b21adaa0ed1472f9d1999a7dd3b10d8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2YUd1aWRl:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770197598&amp;x-signature=5EWb%2BjUyPlFLZS672hu19jqWQNg%3D" alt="" loading="lazy"/></p>
<p>这篇文章 Guide 就来手把手带大家在 IDEA 里通过 ACP 爽用 Claude Code，希望能给喜欢 IDEA 的朋友提供一个不一样选择。</p>
<blockquote>
<p><strong>需要注意</strong>：目前 ACP 还是 Beta 版，体验上可能存在一些小问题，Guide 在周末用了之后整体感觉还是很不错的。</p>
</blockquote>
<h2 data-id="heading-0">ACP 是什么？</h2>
<p>ACP 全称 <strong>Agent Client Protocol</strong>，是一个开放协议，用来规范 AI Agent 与代码编辑器/IDE 之间的通信方式。它类似于 Language Server Protocol (LSP)，但专注于 AI 代理的集成，帮助开发者在不同编辑器中使用各种 AI 工具，而无需为每个组合构建自定义适配器。</p>
<p>简单理解，它就是一个让 AI Agent 和 IDE "即插即用"的通用接口——就像 USB-C 之于设备连接一样。</p>
<p>ACP 由 Zed Industries（Zed 编辑器的开发者）主导开发，与 Anthropic、Google 等合作，JetBrains 目前也加入了。</p>
<h3 data-id="heading-1">为什么需要 ACP？</h3>
<p>在没有 ACP 之前，每个 AI Agent 想接入某个 IDE，都需要单独开发适配器。Claude Code 要写一套，Cursor 要写一套，Windsurf 也要写一套——重复造轮子，而且一旦 Agent 更新，适配器还得跟着改。</p>
<p>ACP 的核心思路是：<strong>定义一套标准的通信协议，任何 Agent 只要实现了 ACP Server，任何 IDE 只要实现了 ACP Client，两者就能直接对接</strong>。</p>
<p>关于 ACP 更详细的介绍，可以查看官方文档：<strong><a href="https://link.juejin.cn?target=https%3A%2F%2Fagentclientprotocol.com%2Foverview%2Fintroduction" target="_blank" title="https://agentclientprotocol.com/overview/introduction" ref="nofollow noopener noreferrer">agentclientprotocol.com/overview/in…</a></strong> 。</p>
<h3 data-id="heading-2">生态现状</h3>
<p>目前加入 ACP 生态的成员包括：</p>
<ul>
<li><strong>IDE 端</strong>：JetBrains 全家桶、Zed 等。</li>
<li><strong>Agent 端</strong>：Claude Code、Codex、Gemini CLI、Kimi CLI、Qoder CLI 等。</li>
</ul>
<p>就连 Docker 也在 2025 年 11 月 13 日宣布将其开源多代理运行时 cagent 内置到 Docker Desktop，并支持 Agent Client Protocol (ACP)，以实现 AI 代理与 IDE/编辑器（如 Zed、VS Code）的无缝集成。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bcdb19228b9d477fb28062cb87937e1f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2YUd1aWRl:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770197598&amp;x-signature=4Q2bHBMysasvJxqvmj%2FzHrrwXCw%3D" alt="" loading="lazy"/></p>
<p>这意味着可以在容器化环境中运行 AI 代理，简化开发工作流，如代码生成、测试和重构，同时保持容器隔离性。</p>
<h3 data-id="heading-3">技术原理</h3>
<p>ACP 底层基于 <strong>JSON-RPC 2.0</strong> 协议（与 LSP 完全相同），Agent 作为 Server 运行一个独立的进程，IDE 通过 stdin/stdout 与之通信。好处是 Agent 不需要被打包进 IDE 插件里，保持独立性和可维护性。</p>
<pre><code class="hljs language-mermaid" lang="mermaid">flowchart LR
    subgraph IDE["IDE (ACP Client)"]
        AIAI["AI Assistant&lt;br/&gt;Plugin"]
    end

    subgraph ACP_Agent["ACP Agent Process"]
        ACPServer["ACP Server&lt;br/&gt;JSON-RPC"]
        LLM["AI Backend&lt;br/&gt;(Claude/GPT/...)"]
        Tools["MCP Tools&lt;br/&gt;Filesystem/Git/..."]
    end

    AIAI &lt;--&gt;|"stdin/stdout&lt;br/&gt;JSON-RPC"| ACPServer
    ACPServer --&gt; LLM
    ACPServer --&gt; Tools
</code></pre>
<h2 data-id="heading-4">前置条件</h2>
<p>要在 IDEA 里用 ACP 接入 Claude Code，需要满足：</p>
<ol>
<li><strong>IDE 版本</strong>：IntelliJ IDEA 2024.2 到 2025.3.x 或更高版本。ACP 支持从 2025 年底开始逐步集成，确保你的 IDEA 已更新到支持 ACP 的构建。</li>
<li><strong>AI Assistant 插件</strong>：确保已安装并启用</li>
<li><strong>Claude Code</strong>：已安装并能正常运行</li>
<li><strong>claude-code-acp</strong>：Zed 提供的 ACP 适配器（下文会讲如何安装）</li>
</ol>
<p>你可以检查 AI Assistant 插件版本，在 <code>File &gt; Settings &gt; Plugins</code> 里搜索 "JetBrains AI Assistant"，确认版本号在 2025.12 之后。</p>
<h2 data-id="heading-5">配置 ACP</h2>
<h3 data-id="heading-6">第一步：找到配置入口</h3>
<p>打开 AI Assistant 的聊天面板，点击右上角选择下拉框，你会看到 <strong>「配置 ACP 智能体」</strong> 选项。</p>
<p>点击后，IDE 会自动打开一个 <code>acp.json</code> 配置文件。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/366cba9af1444df9b10a3ea4a6022a2e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2YUd1aWRl:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770197598&amp;x-signature=XdD02417833414koz9HlgJMWhSY%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-7">第二步：安装 claude-code-acp</h3>
<p>Zed 官方提供了一个 ACP 适配器 <code>@zed-industries/claude-code-acp</code>，用来桥接 Claude Code 和 ACP 协议。</p>
<pre><code class="hljs language-bash" lang="bash">pnpm install -g @zed-industries/claude-code-acp
</code></pre>
<p>注意必须用 <code>-g</code> 全局安装，这样 ACP Server 才能作为独立命令被调用。</p>
<p>安装完成后，你会在全局 bin 目录里看到 <code>claude-code-acp</code> 命令。</p>
<pre><code class="hljs language-bash" lang="bash">❯ pnpm bin -g
/Users/guide/Library/pnpm
❯ <span class="hljs-built_in">ls</span> /Users/guide/Library/pnpm
claude-code-acp global          store
</code></pre>
<h3 data-id="heading-8">第三步：编辑 acp.json</h3>
<p>在 <code>acp.json</code> 中添加 Claude Code 的配置：</p>
<pre><code class="hljs language-json" lang="json">  <span class="hljs-attr">"agent_servers"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"Claude Code"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"command"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"/Users/guide/Library/pnpm/claude-code-acp"</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span>
</code></pre>
<p>注意将路径替换为你本地的，或者将其添加到环境变量中。</p>
<p>保存文件后，回到 AI Assistant 的聊天面板，再次点击模型选择下拉框，你应该能看到 <strong>Claude Code</strong> 出现在列表里了。</p>
<h2 data-id="heading-9">爽用 Claude Code</h2>
<h3 data-id="heading-10">基础对话</h3>
<p>选择 Claude Code 作为 Agent 后，你就可以像用内置 Claude 一样进行对话：</p>
<ul>
<li>代码编写</li>
<li>代码解释</li>
<li>Bug 诊断</li>
<li>重构建议</li>
<li>生成单元测试</li>
</ul>
<p>这个周末，我就通过这种方式成功重构优化了 <a href="https://link.juejin.cn?target=https%3A%2F%2Fjavaguide.cn%2Fzhuanlan%2Finterview-guide.html" target="_blank" title="https://javaguide.cn/zhuanlan/interview-guide.html" ref="nofollow noopener noreferrer">《SpringAI 智能面试平台+RAG 知识库》</a>这个项目：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/698b720bea144c17965a8323ca3f9443~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2YUd1aWRl:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770197598&amp;x-signature=84ysSaJ5K4uwWlPAjH7pOyniYLE%3D" alt="" loading="lazy"/></p>
<p>这个项目的配套实战项目教程正在更新，涉及到 Prompt Engineering、大模型集成、RAG（检索增强生成）、高性能对象存储与向量数据库。后续的话，还会同步上Agent 项目。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/da03c8521a574eb1a8e5f6c8f81b43b0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2YUd1aWRl:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770197598&amp;x-signature=gSrToHuo58ck3OhKyIAQoRyCEKY%3D" alt="" loading="lazy"/></p>
<p>内容非常全面，非常适合想要实战 AI 项目或者准备 AI 大模型应用开发岗位面试的朋友，来一张刚写完的<strong>3.4w 字+35 道题目</strong>的 RAG 面试题总结，大家感受一下（点此链接了解： <a href="https://link.juejin.cn?target=https%3A%2F%2Fjavaguide.cn%2Fabout-the-author%2Fzhishixingqiu-two-years.html" target="_blank" title="https://javaguide.cn/about-the-author/zhishixingqiu-two-years.html" ref="nofollow noopener noreferrer">星球</a>）：</p>
<h3 data-id="heading-11">模式和模型选择</h3>
<p>Claude Code 的 ACP 模式会识别你原本配置的所有设置，包括：</p>
<ol>
<li><strong>模式选择</strong>：Plan 模式、Code 模式等</li>
<li><strong>模型选择</strong>：claude-sonnet-4.5、claude-opus-4.5 等</li>
<li><strong>第三方中转站</strong>：如果你配置了自定义 API 地址，也会生效</li>
</ol>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9d34ba5ea908473a95f4dd44e604f8a7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2YUd1aWRl:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770197598&amp;x-signature=zO9ZIrJE7WJQMYu%2FRlrGyXGeDNE%3D" alt="" loading="lazy"/></p>
<p>可以看到我这里目前就成功对接了第三方 GLM 模型，这个在国内也是用的人比较多的：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/09e775f898014550a526b502f13bcba8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2YUd1aWRl:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770197598&amp;x-signature=2Qn%2By8xyQpDMOmJRQr3nlXOZcX0%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-12">MCP 工具支持</h3>
<p>这是 ACP 方式相比内置 Agent 的最大优势——<strong>完整支持 MCP（Model Context Protocol）工具</strong>。</p>
<p>MCP 是 Anthropic 推出的另一个协议，用来让 LLM 接入外部工具和数据源。比如你可以配置：</p>
<ul>
<li><strong>文件系统工具</strong>：让 Agent 读写项目文件</li>
<li><strong>Git 工具</strong>：让 Agent 执行 commit、diff 操作</li>
<li><strong>数据库工具</strong>：让 Agent 查询生产环境数据</li>
<li><strong>自定义 API</strong>：接入公司内部服务</li>
</ul>
<p>用 ACP 接入 Claude Code 后，这些 MCP 工具都会被识别并可用。而 AI Assistant 内置的 Claude Agent 只能识别第三方 API 地址，MCP 工具是<strong>不支持</strong>的。</p>
<h2 data-id="heading-13">ACP vs 内置 Agent：如何选择？</h2>













































<table><thead><tr><th><strong>特性</strong></th><th><strong>ACP (Claude Code + Adapter)</strong></th><th><strong>IDEA 内置 Claude Agent (官方/三方插件)</strong></th></tr></thead><tbody><tr><td><strong>核心定位</strong></td><td>终端驱动的任务型机器人 (Task-Oriented)</td><td>侧边栏对话型助手 (Chat-Oriented)</td></tr><tr><td><strong>MCP 工具支持</strong></td><td><strong>✅ 完整原生支持</strong> (可调用本地 Python/DB 等)</td><td><strong>❌ 支持有限</strong> (多局限于 IDE 内部 API)</td></tr><tr><td><strong>模型灵活性</strong></td><td><strong>✅ 极高</strong> (自由切换 3.5 Sonnet / 3.7 / Opus)</td><td><strong>⚠️ 受限</strong> (通常绑定插件商提供的特定版本)</td></tr><tr><td><strong>API 兼容性</strong></td><td><strong>✅ 支持</strong> 中转站 / OneAPI 等自定义 Endpoint</td><td><strong>⚠️ 部分支持</strong> (官方插件常强制要求官方 Key)</td></tr><tr><td><strong>工作模式</strong></td><td><strong>✅ 拥有 Plan / Act 独立模式</strong></td><td><strong>❌ 主要是单轮或多轮对话</strong></td></tr><tr><td><strong>环境上下文</strong></td><td><strong>✅ 强</strong> (通过 MCP 直接读取系统/库文档)</td><td><strong>✅ 强</strong> (深度集成 IDE 索引，理解代码库)</td></tr><tr><td><strong>配置门槛</strong></td><td><strong>较高</strong> (需要配置 Node 环境及 Proxy)</td><td><strong>极低</strong> (插件市场一键安装)</td></tr></tbody></table>
<p><strong>建议</strong>：</p>
<ul>
<li>如果你<strong>需要 MCP 工具</strong>，必须用 ACP 方式</li>
<li>如果你<strong>习惯 Claude Code 的 Plan 模式</strong>，用 ACP 更顺手</li>
<li>如果你<strong>想要开箱即用</strong>，内置 Agent 更省心</li>
</ul>
<h2 data-id="heading-14">接入其他 Agent</h2>
<p>除了 Claude Code，你也可以接入其他支持 ACP 的 Agent。比如 Gemini CLI (Google) 、 Cagent (Docker)：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"agent_servers"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"Claude Code"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"command"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"/Users/guide/Library/pnpm/claude-code-acp"</span>
    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"Gemini CLI"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"command"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"gemini-acp"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"args"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"--model"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"gemini-2.0-pro"</span><span class="hljs-punctuation">]</span>
    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"Docker Cagent"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"command"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"cagent"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"args"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"acp"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"agent.yml"</span><span class="hljs-punctuation">]</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h2 data-id="heading-15">踩坑与排查</h2>
<h3 data-id="heading-16">ACP 初始化失败</h3>
<p>JetBrains AI Assistant 无法运行 "pnpm" 命令（<code>IOException: Cannot run program "pnpm", error=2, No such file or directory</code>）。</p>
<pre><code class="hljs language-bash" lang="bash">❯ pnpm bin -g
/Users/guide/Library/pnpm
❯ <span class="hljs-built_in">ls</span> /Users/guide/Library/pnpm
claude-code-acp global
</code></pre>
<p>注意将 command 路径替换为你本地的，或者将其添加到环境变量中。</p>
<h3 data-id="heading-17">Agent 无响应</h3>
<p>如果选择 Agent 后聊天没反应：</p>
<ol>
<li>检查 Agent 进程是否启动：<code>ps aux | grep claude-code-acp</code></li>
<li>查看 AI Assistant 的日志：<code>Help &gt; Show Log in Finder</code></li>
<li>确认 Claude Code 本身能正常在终端运行</li>
</ol>
<h2 data-id="heading-18">总结</h2>
<p>ACP 目前还处于快速发展阶段，2025 年底才正式进入 Beta。有几个值得期待的方向：</p>
<ol>
<li><strong>更多 Agent 支持</strong>：Cursor、Windsurf 等热门 AI 工具可能会推出 ACP Server</li>
<li><strong>Per-Project 配置</strong>：JetBrains 的 Issue 追踪显示，他们正在计划支持项目级别的 ACP 配置</li>
<li><strong>社区生态</strong>：随着协议开放，可能会出现更多第三方 Agent</li>
</ol>
<p>如果你是 JetBrains IDE 的重度用户，又不太喜欢在终端环境使用 Claude Code ，或者你需要 MCP 工具的强大能力，那么 ACP 就是目前的终极解决方案。</p>
<p>虽然配置稍微麻烦一点，但一旦搞定，你就能在熟悉的 IDE 环境里获得：</p>
<ul>
<li>稳定的 UI 体验</li>
<li>完整的 Claude Code 功能</li>
<li>MCP 工具的加持</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Bun v1.3.7更新短评]]></title>    <link>https://juejin.cn/post/7599927813602000936</link>    <guid>https://juejin.cn/post/7599927813602000936</guid>    <pubDate>2026-01-28T04:52:23.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7599927813602000936" data-draft-id="7599927813601984552" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Bun v1.3.7更新短评"/> <meta itemprop="keywords" content="前端,后端,程序员"/> <meta itemprop="datePublished" content="2026-01-28T04:52:23.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="前端之虎陈随易"/> <meta itemprop="url" content="https://juejin.cn/user/1239904846873326"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Bun v1.3.7更新短评
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1239904846873326/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    前端之虎陈随易
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-28T04:52:23.000Z" title="Wed Jan 28 2026 04:52:23 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-28
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>大家好，我是农村程序员，独立开发者，前端之虎陈随易，技术群与交朋友请在个人网站 👇 联系我 ✌️</p>
<ul>
<li>个人网站 1️⃣：<a href="https://link.juejin.cn?target=https%3A%2F%2Fchensuiyi.me" target="_blank" title="https://chensuiyi.me" ref="nofollow noopener noreferrer">chensuiyi.me</a></li>
<li>个人网站 2️⃣：<a href="https://link.juejin.cn?target=https%3A%2F%2Fme.yicode.tech" target="_blank" title="https://me.yicode.tech" ref="nofollow noopener noreferrer">me.yicode.tech</a></li>
</ul>
<p>我的所有文章均为古法手写，无 AI 添加剂，请放心食用，如果你觉得本文有用，一键三连 (<code>点赞</code>、<code>评论</code>、<code>转发</code>)，就是对我最大的支持~</p>
<hr/>
<p>距离v1.3.6发布应该不到半个月吧，v1.3.7已经发布了，Bun的发版节奏真是比火箭还快。</p>
<p>发版快就算了，更牛的是，每次都能带来一些亮眼的功能，本文就来简单盘点一下。</p>
<h2 data-id="heading-0">快，快，快</h2>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/72ac7599408347e39c54474e5c07eb06~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YmN56uv5LmL6JmO6ZmI6ZqP5piT:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770180743&amp;x-signature=42Y00%2BNu4JMhZcqeIfxn0RTJZwc%3D" alt="" loading="lazy"/></p>
<p>性能是Bun的主打方向，这次也不例外，带来了大量的性能提升。</p>
<ul>
<li><code>Buffer.from</code> 快了<code>50%</code></li>
<li><code>JavaScriptCore</code> 升级到最新版</li>
<li><code>async/await</code> 快了 <code>35%</code></li>
<li><code>Array.from</code> 快了 <code>2倍</code></li>
<li><code>string.padStart</code> 和 <code>string.padEnd</code>快了<code>90%</code></li>
<li><code>array.flat</code>快了<code>3倍</code></li>
<li><code>ARM64</code> 上面性能提升</li>
</ul>
<h2 data-id="heading-1">fetch 发送 HTTP 请求时保留头部大小写</h2>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">await</span> <span class="hljs-title function_">fetch</span>(<span class="hljs-string">'https://api.example.com/data'</span>, {
    <span class="hljs-attr">headers</span>: {
        <span class="hljs-title class_">Authorization</span>: <span class="hljs-string">'Bearer token123'</span>, <span class="hljs-comment">// 发送 "Authorization"</span>
        <span class="hljs-string">'Content-Type'</span>: <span class="hljs-string">'application/json'</span>, <span class="hljs-comment">// 发送 "Content-Type"</span>
        <span class="hljs-string">'X-Custom-Header'</span>: <span class="hljs-string">'value'</span> <span class="hljs-comment">// 发送 "X-Custom-Header"</span>
    }
});

<span class="hljs-keyword">const</span> headers = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Headers</span>();
headers.<span class="hljs-title function_">set</span>(<span class="hljs-string">'Content-Type'</span>, <span class="hljs-string">'text/plain'</span>); <span class="hljs-comment">// 发送 "Content-Type"</span>
</code></pre>
<p>这个我挺喜欢的，编程就应该要具备确定性，虽然http协议不区分头部属性的大小写，但你明明传了<code>Authorization</code>，服务端接受却变成了<code>authorization</code>，还是怪别扭的。</p>
<h2 data-id="heading-2">新增 Bun.wrapAnsi()</h2>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/01d2aab533754581b680c2138675d98b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YmN56uv5LmL6JmO6ZmI6ZqP5piT:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770180743&amp;x-signature=q0%2BhTV9GACDjmK33gFPs0ca0OW4%3D" alt="" loading="lazy"/></p>
<p>Bun已经内置了npm包wrap-ansi的实现，这是在终端显示转义字符，彩色输出的方法。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/49b066683ed9462ab9fec22f8eea75dd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YmN56uv5LmL6JmO6ZmI6ZqP5piT:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770180743&amp;x-signature=1oudFCDvMAYhrp2ejFHiUYsmTbE%3D" alt="" loading="lazy"/></p>
<p>我之前写过的一篇文章<a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FUjsuNUOnrIoDwiXsnlaYZw" target="_blank" title="https://mp.weixin.qq.com/s/UjsuNUOnrIoDwiXsnlaYZw" ref="nofollow noopener noreferrer">盘点Bun内置了哪些npm包功能</a>现在又能新增一个内置可替换的npm包了。</p>
<p>我特别喜欢这种<code>全包干</code>，为啥呢？因为很多东西本就简单，几乎万年不变的，内置到运行时里面，方便又快捷。</p>
<p>同时呢，内置实现一般性能更高，比如<code>Bun.wrapAnsi</code>就比<code>wrap-ansi</code>快了<code>33倍-88倍</code>，也减少了很多找库，找包的时间，非常Nice。</p>
<h2 data-id="heading-3">Markdown CPU Profile 输出</h2>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/584ceb4aea2e493789326199f78da611~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YmN56uv5LmL6JmO6ZmI6ZqP5piT:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770180743&amp;x-signature=OlYtEUw2BXjBXml36bZI8aZACMo%3D" alt="" loading="lazy"/></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 仅生成 Markdown 配置文件</span>
bun --cpu-prof-md script.js

<span class="hljs-comment"># 生成 Chrome DevTools JSON 和 Markdown 格式</span>
bun --cpu-prof --cpu-prof-md script.js

<span class="hljs-comment"># 生成与 V8 兼容的堆快照（在 Chrome 开发者工具中打开）</span>
bun --heap-prof script.js

<span class="hljs-comment"># 生成 Markdown 堆配置文件（用于使用 grep/sed/awk 进行 CLI 分析）</span>
bun --heap-prof-md script.js

<span class="hljs-comment"># 指定输出位置</span>
bun --heap-prof --heap-prof-dir ./profiles --heap-prof-name my-snapshot.heapsnapshot script.js

</code></pre>
<p>重磅功能，老铁们，AI友好的性能分析，调优，直接得到一个性能方面的md文档，扔给AI，项目性能问题，内存泄漏，一清二楚，估计这个功能其他几个运行时，包括其他语言也会很快跟上。</p>
<h2 data-id="heading-4">原生 JSON5 支持</h2>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 解析JSON5字符</span>
<span class="hljs-keyword">const</span> config = <span class="hljs-title class_">Bun</span>.<span class="hljs-property">JSON5</span>.<span class="hljs-title function_">parse</span>(<span class="hljs-string">`{
  // Database configuration
  host: 'localhost',
  port: 5432,
  ssl: true,
}`</span>);

<span class="hljs-comment">// JSON5字符串化</span>
<span class="hljs-keyword">const</span> output = <span class="hljs-title class_">Bun</span>.<span class="hljs-property">JSON5</span>.<span class="hljs-title function_">stringify</span>({ <span class="hljs-attr">name</span>: <span class="hljs-string">'app'</span>, <span class="hljs-attr">version</span>: <span class="hljs-number">1</span> });

<span class="hljs-comment">// 直接导入JSON5文件</span>
<span class="hljs-keyword">import</span> settings <span class="hljs-keyword">from</span> <span class="hljs-string">'./config.json5'</span>;
</code></pre>
<p>JSON5 是 JSON 的超集，增加了开发者友好的特性，如注释、尾随逗号、未加引号的键、单引号字符串和十六进制数字。</p>
<p>它被 Chromium、Next.js、Babel 和 WebStorm 等主要项目使用。</p>
<p>JSON5 特别适用于配置文件，其中注释和尾随逗号可以提高可读性和可维护性。</p>
<h2 data-id="heading-5">Bun.JSONL 用于流式解析 JSONL</h2>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> results = <span class="hljs-title class_">Bun</span>.<span class="hljs-property">JSONL</span>.<span class="hljs-title function_">parse</span>(<span class="hljs-string">'{"name":"Alice"}\n{"name":"Bob"}\n'</span>);
<span class="hljs-comment">// [{ name: "Alice" }, { name: "Bob" }]</span>

<span class="hljs-comment">// Uint8Array 也能正常工作 (UTF-8 BOM 自动忽略)</span>
<span class="hljs-keyword">const</span> buffer = <span class="hljs-keyword">new</span> <span class="hljs-title class_">TextEncoder</span>().<span class="hljs-title function_">encode</span>(<span class="hljs-string">'{"a":1}\n{"b":2}\n'</span>);
<span class="hljs-keyword">const</span> records = <span class="hljs-title class_">Bun</span>.<span class="hljs-property">JSONL</span>.<span class="hljs-title function_">parse</span>(buffer);
<span class="hljs-comment">// [{ a: 1 }, { b: 2 }]</span>
</code></pre>
<p>Bun 现在内置支持解析 JSONL（换行符分隔的 JSON）。</p>
<p>该解析器使用 JavaScriptCore 的优化 JSON 解析器以 C++实现，为完整输入和流式使用场景提供快速解析。</p>
<p>我能想到的一个场景就是，json格式的日志分析，应该会很方便。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> chunk = <span class="hljs-string">'{"id":1}\n{"id":2}\n{"id":3'</span>;

<span class="hljs-keyword">const</span> result = <span class="hljs-title class_">Bun</span>.<span class="hljs-property">JSONL</span>.<span class="hljs-title function_">parseChunk</span>(chunk);
result.<span class="hljs-property">values</span>; <span class="hljs-comment">// [{ id: 1 }, { id: 2 }]</span>
result.<span class="hljs-property">read</span>; <span class="hljs-comment">// 17 — characters consumed</span>
result.<span class="hljs-property">done</span>; <span class="hljs-comment">// false — incomplete value remains</span>
result.<span class="hljs-property">error</span>; <span class="hljs-comment">// null — no parse error</span>
</code></pre>
<p>在流式场景中， parseChunk 尽可能解析多个完整值，并返回解析的进度——当从网络流逐步接收数据时很有用。</p>
<h2 data-id="heading-6">S3 presign() 现在支持 contentDisposition 和 type 选项</h2>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> { S3Client } <span class="hljs-keyword">from</span> <span class="hljs-string">'bun'</span>;

<span class="hljs-keyword">const</span> s3 = <span class="hljs-keyword">new</span> <span class="hljs-title function_">S3Client</span>({
    <span class="hljs-attr">region</span>: <span class="hljs-string">'us-east-1'</span>,
    <span class="hljs-attr">endpoint</span>: <span class="hljs-string">'https://s3.us-east-1.amazonaws.com'</span>,
    <span class="hljs-attr">accessKeyId</span>: process.<span class="hljs-property">env</span>.<span class="hljs-property">AWS_ACCESS_KEY_ID</span>,
    <span class="hljs-attr">secretAccessKey</span>: process.<span class="hljs-property">env</span>.<span class="hljs-property">AWS_SECRET_ACCESS_KEY</span>,
    <span class="hljs-attr">bucket</span>: <span class="hljs-string">'my-bucket'</span>
});

<span class="hljs-keyword">const</span> file = s3.<span class="hljs-title function_">file</span>(<span class="hljs-string">'report.pdf'</span>);

<span class="hljs-keyword">const</span> url = file.<span class="hljs-title function_">presign</span>({
    <span class="hljs-attr">method</span>: <span class="hljs-string">'GET'</span>,
    <span class="hljs-attr">expiresIn</span>: <span class="hljs-number">900</span>,
    <span class="hljs-attr">contentDisposition</span>: <span class="hljs-string">'attachment; filename="quarterly-report.pdf"'</span>,
    <span class="hljs-attr">type</span>: <span class="hljs-string">'application/octet-stream'</span>
});
</code></pre>
<p>修复了一个问题，即在生成预签名 URL 时 S3File.presign() 会忽略 contentDisposition 和 type 选项。</p>
<p>这些选项现在被正确地包含为 response-content-disposition 和 response-content-type 查询参数。</p>
<p>这在你希望浏览器将文件作为附件下载而不是内联显示时特别有用。</p>
<h2 data-id="heading-7">bun pm pack 现在会尊重来自生命周期脚本对 package.json 的更改</h2>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// package.json</span>
{
  <span class="hljs-string">"name"</span>: <span class="hljs-string">"my-package"</span>,
  <span class="hljs-string">"version"</span>: <span class="hljs-string">"1.0.0"</span>,
  <span class="hljs-string">"scripts"</span>: {
    <span class="hljs-string">"prepack"</span>: <span class="hljs-string">"node prepack.js"</span>
  },
  <span class="hljs-string">"description"</span>: <span class="hljs-string">"Original description"</span>,
  <span class="hljs-string">"devDependencies"</span>: { <span class="hljs-comment">/* ... */</span> }
}

<span class="hljs-comment">// prepack.js - 打包之前改变package.json</span>
<span class="hljs-keyword">const</span> fs = <span class="hljs-built_in">require</span>(<span class="hljs-string">'fs'</span>);
<span class="hljs-keyword">const</span> pkg = <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(fs.<span class="hljs-title function_">readFileSync</span>(<span class="hljs-string">'package.json'</span>, <span class="hljs-string">'utf8'</span>));
<span class="hljs-keyword">delete</span> pkg.<span class="hljs-property">devDependencies</span>;
pkg.<span class="hljs-property">description</span> = <span class="hljs-string">'Production build'</span>;
fs.<span class="hljs-title function_">writeFileSync</span>(<span class="hljs-string">'package.json'</span>, <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(pkg, <span class="hljs-literal">null</span>, <span class="hljs-number">2</span>));

</code></pre>
<p>bun pm pack 在运行 prepack 、 prepare 和 prepublishOnly 脚本后重新读取 package.json ，确保这些脚本所做的任何修改都包含在 tarball 中。</p>
<h2 data-id="heading-8">node:inspector 分析器 API</h2>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> inspector <span class="hljs-keyword">from</span> <span class="hljs-string">'node:inspector/promises'</span>;

<span class="hljs-keyword">const</span> session = <span class="hljs-keyword">new</span> inspector.<span class="hljs-title class_">Session</span>();
session.<span class="hljs-title function_">connect</span>();

<span class="hljs-keyword">await</span> session.<span class="hljs-title function_">post</span>(<span class="hljs-string">'Profiler.enable'</span>);
<span class="hljs-keyword">await</span> session.<span class="hljs-title function_">post</span>(<span class="hljs-string">'Profiler.start'</span>);

<span class="hljs-keyword">const</span> { profile } = <span class="hljs-keyword">await</span> session.<span class="hljs-title function_">post</span>(<span class="hljs-string">'Profiler.stop'</span>);
<span class="hljs-keyword">await</span> session.<span class="hljs-title function_">post</span>(<span class="hljs-string">'Profiler.disable'</span>);
</code></pre>
<p>Bun 现在通过 Chrome DevTools Protocol 实现了 node:inspector Profiler API，用于 CPU 分析。</p>
<h2 data-id="heading-9">增加最大 HTTP 头数量</h2>
<p>请求和响应中允许的最大 HTTP 头数量已从 100 增加到 200。</p>
<p>这提高了与发送大量头的服务的兼容性，例如具有广泛元数据的 API 或附加多个转发头的代理。</p>
<h2 data-id="heading-10">WebSocket URL 凭证支持</h2>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 凭证会自动转发</span>
<span class="hljs-keyword">const</span> ws = <span class="hljs-keyword">new</span> <span class="hljs-title class_">WebSocket</span>(<span class="hljs-string">'ws://username:password@example.com/socket'</span>);

<span class="hljs-comment">// 用户提供的授权标头具有优先权</span>
<span class="hljs-keyword">const</span> ws2 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">WebSocket</span>(<span class="hljs-string">'ws://user:pass@example.com/socket'</span>, {
    <span class="hljs-attr">headers</span>: {
        <span class="hljs-title class_">Authorization</span>: <span class="hljs-string">'Bearer custom-token'</span> <span class="hljs-comment">// 这将替换默认转发的 Authorization</span>
    }
});
</code></pre>
<p>WebSocket 连接现在正确地将 URL 中嵌入的凭证作为基本授权头转发，与 Node.js 行为一致。</p>
<p>当连接到一个包含凭证的 WebSocket URL（如 ws://user:pass@host ）时，Bun 现在会自动提取凭证，并在 WebSocket 升级握手过程中将其作为正确编码的 Authorization: Basic 头部发送。</p>
<hr/>
<p>以上就是本次更新内容，我是<code>编程记者陈随易</code>，给大家分享行业热点，代码技术，编程资讯等，欢迎关注~</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Clawdbot 完整对接飞书教程 手把手搭建你的专属 AI 助手]]></title>    <link>https://juejin.cn/post/7600238071038197769</link>    <guid>https://juejin.cn/post/7600238071038197769</guid>    <pubDate>2026-01-28T10:43:37.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600238071038197769" data-draft-id="7600224355294199835" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Clawdbot 完整对接飞书教程 手把手搭建你的专属 AI 助手"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2026-01-28T10:43:37.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="BingoGo"/> <meta itemprop="url" content="https://juejin.cn/user/993614242266077"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Clawdbot 完整对接飞书教程 手把手搭建你的专属 AI 助手
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/993614242266077/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    BingoGo
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-28T10:43:37.000Z" title="Wed Jan 28 2026 10:43:37 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-28
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    272
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Clawdbot 完整对接飞书教程 手把手搭建你的专属 AI 助手</h2>
<blockquote>
<p>注意本教程在 Linux 系统下进行</p>
</blockquote>
<p>Clawdbot 由于 Claude 的版权问题，已更名为 Moltbot，因此本教程基于最新版本编写。下面进入安装流程</p>
<p>首先准备一台闲置的云服务器或 VPS（推荐使用香港或海外节点）。由于 Moltbot 运行时权限较大，出于安全考虑，不建议在本地或工作机上安装，推荐在一台独立的空服务器上部署。准备完成后，登录到服务器。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fcatchadmin.com%2Fpost%2F2026-01%2Fclawedbot-install" target="_blank" title="https://catchadmin.com/post/2026-01/clawedbot-install" ref="nofollow noopener noreferrer">原文 Clawdbot 完整对接飞书教程 手把手搭建你的专属 AI 助手</a></p>
<h3 data-id="heading-1">安装</h3>
<blockquote>
<p>如果你不想安装，可以直接使用阿里云的<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.aliyun.com%2Factivity%2Fecs%2Fclawdbot%3FuserCode%3Doq2t54oi" target="_blank" title="https://www.aliyun.com/activity/ecs/clawdbot?userCode=oq2t54oi" ref="nofollow noopener noreferrer">Clawdbot 一键部署</a>，部署之后可以直接跳到<a href="#%E5%AF%B9%E6%8E%A5%E9%A3%9E%E4%B9%A6" title="#%E5%AF%B9%E6%8E%A5%E9%A3%9E%E4%B9%A6">对接飞书</a>。</p>
</blockquote>
<p>第一步安装 Git</p>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_"># </span><span class="bash">安装 Git</span>
sudo apt update
sudo apt install git -y
</code></pre>
<p>第二步安装 Node.js</p>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_"># </span><span class="bash">安装 NVM</span>
<span class="hljs-meta prompt_"># </span><span class="bash">国内使用 gitee 的镜像源</span>
curl -o- https://gitee.com/RubyMetric/nvm-cn/raw/main/install.sh | bash
<span class="hljs-meta prompt_">
# </span><span class="bash">国外使用</span>
curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.1/install.sh | bash
<span class="hljs-meta prompt_">
# </span><span class="bash">重新加载环境变量</span>
source ~/.bashrc
<span class="hljs-meta prompt_">
# </span><span class="bash">安装 Node.js 22</span>
nvm install 22
<span class="hljs-meta prompt_">
# </span><span class="bash">查看 nodejs 版本</span>
node -v # 输出 v22 即可，版本只要 22 就行
</code></pre>
<h3 data-id="heading-2">安装 Moltbot (原 Clawdbot)</h3>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_"># </span><span class="bash">使用官方脚本安装</span>
curl -fsSL https://molt.bot/install.sh | bash
</code></pre>
<blockquote>
<p>服务器在国内，如果安装失败的话，可能需要解决网络问题</p>
</blockquote>
<p>其他平台安装方式请参考<a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.molt.bot%2Finstall%2Finstaller" target="_blank" title="https://docs.molt.bot/install/installer" ref="nofollow noopener noreferrer">Moltbot (原Clawdbot) 安装文档</a></p>
<p>你会看到如下图输出
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4432daf195774d8eabdf531139f0ecf2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQmluZ29Hbw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770251050&amp;x-signature=o3t2VKxEchRj%2FtuoSThFLmwiyyo%3D" alt="Clawedbot 安装过程 - AI 助手部署初始化" loading="lazy"/>
如果首次安装，时间会很长，需要耐心等待。
如果最后输出如下内容：</p>
<pre><code class="hljs language-shell" lang="shell">→ npm install failed; cleaning up and retrying...
</code></pre>
<p><code>ctrl+c</code> 退出，重新运行安装脚本然后继续等待下。</p>
<p>成功之后会输出如下图片
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4c265e7182c94702b1462a96fba49440~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQmluZ29Hbw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770251050&amp;x-signature=zxN7chpihwXv5SDMqr%2BOVpiBmXw%3D" alt="Clawedbot 安装成功 - AI 机器人配置向导" loading="lazy"/>
第一个选项选择 <code>yes</code>, 就是询问你是否知道风险的。
第二步选择 <code>QuickStart</code>
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/90baa7dd9f44408fa805a6a013c2a9d5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQmluZ29Hbw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770251050&amp;x-signature=4uSH5bscN8BDyCK8RadJRt%2Bc19M%3D" alt="Clawedbot QuickStart 快速开始选项" loading="lazy"/>
第三步选择模型服务商，这里选择 <code>Qwen</code>，免费额度充足，适合入门使用
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bb675fe30be84601872b05a2d3de31a8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQmluZ29Hbw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770251050&amp;x-signature=qaEfL0q1vUfxbrzYHs1fVAXKyjw%3D" alt="Clawedbot 选择 AI 模型服务商 Qwen 千问" loading="lazy"/>
选择千问模型后，会提供一个链接，复制并在浏览器中打开，如下图
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fecf1577d1d6417ea7e46a6048f940ec~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQmluZ29Hbw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770251050&amp;x-signature=MD3dh2GSAE7H8CDV2KuKps4kfv0%3D" alt="Clawedbot 千问模型授权链接" loading="lazy"/>
打开浏览器后，会看到如下界面。由于我已登录过，所以显示账户信息；如果尚未登录，按照提示完成登录即可。
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6c8ccc1ef92f46e2ad7c9ab8595a8b40~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQmluZ29Hbw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770251050&amp;x-signature=tEgrzQMvsLWvg3OZJ2h2PzGkXvg%3D" alt="Clawedbot 千问 AI 账户登录页面" loading="lazy"/>
登录完成后，会出现以下选项，提示选择对应的千问模型，如下图
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9bcb66e809f94b6591fb158840f51786~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQmluZ29Hbw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770251050&amp;x-signature=hbhi2JMKpZh7accgqzR%2FETudNSo%3D" alt="Clawedbot 选择千问 AI 模型版本" loading="lazy"/>
选择默认模型即可。接下来会提示选择 channel，这里先跳过，后续再添加
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e902fc02e34a495ab66e360877d2ecab~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQmluZ29Hbw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770251050&amp;x-signature=XXp0eqFvHQEWIJg88zhMoARNzqE%3D" alt="Clawedbot channel 渠道配置选项" loading="lazy"/>
继续下面选择 skills，也是选择 <code>No</code>，如下图
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e3af053853d44ca78a5335c172d5ef63~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQmluZ29Hbw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770251050&amp;x-signature=ZIpQFIM9XsOgWdCPi%2BHbm6%2F6LRE%3D" alt="Clawedbot skills 技能配置选项" loading="lazy"/>
继续下面选择 hooks，也是使用<code>空格</code>选择 <code>No</code>，如下图
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d5a3c06acdd94c4faf91c9aa50c85c5d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQmluZ29Hbw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770251050&amp;x-signature=Gk6IvYYtV8m1mXPoYm8xTWWKacs%3D" alt="Clawedbot hooks 配置选项" loading="lazy"/>
然后等待安装完成，最后会出现以下选项，这里选择 <code>TUI</code>
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8b533bdafa394a189de53975355baad1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQmluZ29Hbw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770251050&amp;x-signature=qCDWG485%2F2QDXGNRWLatjw7VxlE%3D" alt="Clawedbot 选择 TUI 终端界面" loading="lazy"/>
如果看到 TUI 聊天界面，说明安装成功，可以尝试输入 <code>Hello</code> 进行测试。
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/03b591ac4ba847c1973f9e633f9976cd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQmluZ29Hbw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770251050&amp;x-signature=gHa3bbD4rz%2BjB5%2F7yA9zp0HJk5I%3D" alt="Clawedbot TUI 聊天界面 - AI 助手对话测试" loading="lazy"/>
然后直接使用 <code>ctrl+c</code> 先关闭，后面我们再来设置</p>
<h4 data-id="heading-3">查看服务</h4>
<p>可以使用下面的命令来查看</p>
<pre><code class="hljs language-shell" lang="shell">clawdbot status
</code></pre>
<p>会看到如下图的结果就说明服务启动了
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f027b3ffccec4a03ae17506048a98df8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQmluZ29Hbw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770251050&amp;x-signature=dsPRavYwSLzcznixo1lg%2BeCrE3s%3D" alt="Clawedbot 服务状态检查 - AI 助手运行中" loading="lazy"/></p>
<h4 data-id="heading-4">访问 Web UI 面板</h4>
<p>如何访问面板？服务监听在 <code>http://127.0.0.1:18789/</code> 端口上，我们现在通过 ssh 隧道来访问，输入下面的命令</p>
<pre><code class="hljs language-shell" lang="shell">ssh -N -L 18789:127.0.0.1:18789 用户名@服务器IP
<span class="hljs-meta prompt_"># </span><span class="bash">回车之后</span>
用户名@服务器IP's password: # 输入密码
</code></pre>
<p>然后在浏览器打开 <code>http://127.0.0.1:18789/</code>, 你会看到 Dashboard 了，如下图
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/40398e25cb2d469583b8a8239d8d1060~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQmluZ29Hbw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770251050&amp;x-signature=XazLmIegoDbaCwelNoLxRZI5K7g%3D" alt="Clawedbot Web UI Dashboard 未授权页面" loading="lazy"/>
图中显示的是未授权状态，回到服务器，输入以下命令</p>
<pre><code class="hljs language-shell" lang="shell">clawdbot dashboard
</code></pre>
<p>会看到下面的面板数据
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cddaf0d7687f47d986c54d9303ac1730~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQmluZ29Hbw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770251050&amp;x-signature=r55d9h2KdKvqdc%2F4pJKV5ITcno4%3D" alt="Clawedbot Dashboard URL 获取命令" loading="lazy"/>
复制对应的 <code>Dashboard URL</code> 到浏览器打开，即可正常查看聊天记录。
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/dca7f431b4b24c618cbad4d2ba97e58b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQmluZ29Hbw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770251050&amp;x-signature=9NnNq1DTC6Ajhtt%2BoyDfyC7O6QA%3D" alt="Clawedbot Web UI 管理面板 - AI 助手聊天记录" loading="lazy"/></p>
<p>至此 Moltbot 已安装完成，可以正常访问了。</p>
<h3 data-id="heading-5">对接飞书</h3>
<p>首先安装飞书插件，输入以下命令</p>
<pre><code class="hljs language-shell" lang="shell">clawdbot plugins install @m1heng-clawd/feishu
</code></pre>
<p>登录飞书开放平台 <a href="https://link.juejin.cn?target=https%3A%2F%2Fopen.feishu.cn%25EF%25BC%258C%25E7%2582%25B9%25E5%2587%25BB%25E3%2580%258C%25E5%25BC%2580%25E5%258F%2591%25E8%2580%2585%25E5%2590%258E%25E5%258F%25B0" target="_blank" title="https://open.feishu.cn%EF%BC%8C%E7%82%B9%E5%87%BB%E3%80%8C%E5%BC%80%E5%8F%91%E8%80%85%E5%90%8E%E5%8F%B0" ref="nofollow noopener noreferrer">open.feishu.cn，点击「开发者后台</a> -&gt; 创建企业自建应用」，如下图
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cce2257a2fed4ed5bb7f27f097a3bd49~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQmluZ29Hbw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770251050&amp;x-signature=N7vWLEoRyiDgrP6E4L4psOQVl4M%3D" alt="飞书开放平台创建企业自建应用 - Clawedbot 对接" loading="lazy"/>
然后点击创建应用，如下
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d948b8631a424c43be3c44f13ad54f80~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQmluZ29Hbw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770251050&amp;x-signature=yER3heT%2FgdM%2BgMywbZSwyja1tVk%3D" alt="飞书创建应用 - Clawedbot AI 机器人" loading="lazy"/>
创建完成后，首先到凭据管理中获取 App ID 和 App Secret，注意保存，后续配置需要使用。
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2c52a64d1c724b16b96af9ce4715d9d7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQmluZ29Hbw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770251050&amp;x-signature=jCqxYqZQFpMUfSfSuUnIsiM2gnU%3D" alt="飞书 App ID 和 App Secret 凭据管理" loading="lazy"/>
然后添加机器人，如下操作
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/feecd307b9d244d3851103fbdd5da8f5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQmluZ29Hbw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770251050&amp;x-signature=wE2emMlpjlAMJguLetPB4oRzYU0%3D" alt="飞书添加机器人能力 - Clawedbot AI 助手" loading="lazy"/>
首先配置个名字
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c27542c578994a40b3a4bee84ee340f7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQmluZ29Hbw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770251050&amp;x-signature=8j%2FRGIAlIEnHVLcVDFBAw9m2%2FyA%3D" alt="飞书机器人名称配置 - Clawedbot" loading="lazy"/></p>
<p>飞书的其他配置先暂停，回到服务器配置 Moltbot 的飞书参数</p>
<h4 data-id="heading-6">添加飞书配置</h4>
<pre><code class="hljs language-shell" lang="shell">clawdbot config set channels.feishu.appId "飞书 app id"

clawdbot config set channels.feishu.appSecret "飞书 app secret"

clawdbot config set channels.feishu.enabled true
<span class="hljs-meta prompt_">
# </span><span class="bash">推荐使用 websocket</span>
clawdbot config set channels.feishu.connectionMode websocket

clawdbot config set channels.feishu.dmPolicy pairing

clawdbot config set channels.feishu.groupPolicy allowlist

clawdbot config set channels.feishu.requireMention true
</code></pre>
<p>配置完成之后，重启</p>
<pre><code class="hljs language-shell" lang="shell">clawdbot gateway restart
</code></pre>
<p>重启完成后回到飞书，找到「事件和回调」，选择长连接模式，如下图
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e0756e47f1604c30bffd4dd482314bf7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQmluZ29Hbw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770251050&amp;x-signature=F%2FIUUHeed0c%2FMAVa8PldM31YmTY%3D" alt="飞书事件和回调配置 - Clawedbot 长连接模式" loading="lazy"/>
如果配置成功，说明连接已建立。继续下面的配置，添加事件，选择「接收消息」事件
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4d66580508aa4fdd8807d486da200d2c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQmluZ29Hbw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770251050&amp;x-signature=79XmlTWqj%2B1%2BCxpd9fENztFkogo%3D" alt="飞书添加接收消息事件 - Clawedbot AI 助手" loading="lazy"/>
事件添加完成之后，还需要开通权限，有以下权限全部勾选</p>




















<table><thead><tr><th>权限</th><th>Scope（范围）</th><th>Description（说明）</th></tr></thead><tbody><tr><td>contact:user.base:readonly</td><td>用户信息</td><td>获取基础用户信息</td></tr><tr><td>im:message</td><td>消息 全部勾选</td><td>发送和接收消息</td></tr></tbody></table>
<p>如下图
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/99562afeaf8e403da6e20f8647c68e85~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQmluZ29Hbw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770251050&amp;x-signature=Epl0nZh1iLkPvGRLt%2BQ1gEK5dqM%3D" alt="飞书权限配置 - Clawedbot 用户信息权限" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/16863de4c8a74b70b1f88c8f3f3356aa~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQmluZ29Hbw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770251050&amp;x-signature=HX8YaAXaou9VC6lqJdWk95nf%2FGQ%3D" alt="飞书消息权限配置 - Clawedbot AI 机器人" loading="lazy"/></p>
<p>以上步骤全部完成后，即可与机器人对话。但在此之前需要先创建一个版本
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0f3525577dfc42af865ef7500f86d26f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQmluZ29Hbw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770251050&amp;x-signature=xJIe%2FPCXtttn0pK%2Bq9HxGRGc5cM%3D" alt="飞书应用版本发布 - Clawedbot AI 助手上线" loading="lazy"/></p>
<blockquote>
<p>注意：每次修改配置后都需要重新发布版本，建议全部配置完成后再统一发布。</p>
</blockquote>
<p>发布完成后，回到飞书客户端，可以看到应用已上线，点击打开应用
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ccd2ad8e87344c5f9aaace124b2d78b3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQmluZ29Hbw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770251050&amp;x-signature=6lyzx6BMz7hxA7ZEX0Dc%2FyaiO%2BU%3D" alt="飞书应用发布成功 - Clawedbot AI 机器人" loading="lazy"/>
向机器人发送 <code>Hello</code>，即可收到 Moltbot 的回复
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/852469090e234d3f9b24ce1738ae29e9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQmluZ29Hbw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770251050&amp;x-signature=s2RhYm38760hrOulrIBU4THpOZk%3D" alt="飞书 Clawedbot AI 助手回复测试成功" loading="lazy"/></p>
<p>由于流程较长，如有勘误，还请指正</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Android 嵌入式照片选择器，让体验更加丝滑]]></title>    <link>https://juejin.cn/post/7599963665039081522</link>    <guid>https://juejin.cn/post/7599963665039081522</guid>    <pubDate>2026-01-28T02:13:30.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7599963665039081522" data-draft-id="7599912857392726062" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Android 嵌入式照片选择器，让体验更加丝滑"/> <meta itemprop="keywords" content="Android,Android Jetpack"/> <meta itemprop="datePublished" content="2026-01-28T02:13:30.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="黄林晴"/> <meta itemprop="url" content="https://juejin.cn/user/3985057546510423"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Android 嵌入式照片选择器，让体验更加丝滑
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3985057546510423/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    黄林晴
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-28T02:13:30.000Z" title="Wed Jan 28 2026 02:13:30 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-28
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>许多应用程序希望在选择照片或视频时为用户提供高度集成和无缝的体验。Embedded Photo Picker（嵌入式照片选择器）为用户提供了一种无缝且注重隐私的方式来选择照片和视频，并且就在你的应用界面内。</p>
</blockquote>
<hr/>
<h2 data-id="heading-0">为什么需要官方照片选择器？</h2>
<h3 data-id="heading-1">传统方案的痛点</h3>
<p>过去，App 要让用户选择照片，通常有两种方式：</p>
<p><strong>方式一：申请存储权限</strong></p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 需要声明危险权限</span>
&lt;uses-permission android:name=<span class="hljs-string">"android.permission.READ_EXTERNAL_STORAGE"</span>/&gt;
&lt;uses-permission android:name=<span class="hljs-string">"android.permission.READ_MEDIA_IMAGES"</span>/&gt;
</code></pre>
<p>问题是：用户一旦授权，App 就能访问<strong>所有照片</strong>。这既是隐私风险，也让很多用户直接拒绝授权。</p>
<p><strong>方式二：自己实现选择器</strong></p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 自建选择器需要大量代码</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">CustomPhotoPickerActivity</span> : <span class="hljs-type">AppCompatActivity</span>() {
    <span class="hljs-comment">// 需要处理权限、加载图片、分页、缩略图、多选...</span>
    <span class="hljs-comment">// 还要适配不同厂商的相册结构</span>
    <span class="hljs-comment">// 维护成本极高</span>
}
</code></pre>
<p>问题是：开发成本高，用户体验参差不齐，而且<strong>仍然需要权限</strong>。</p>
<h3 data-id="heading-2">官方方案的优势</h3>



































<table><thead><tr><th>特性</th><th>自建方案</th><th>官方 Photo Picker</th></tr></thead><tbody><tr><td>需要权限</td><td>✅ 必须</td><td>❌ 完全不需要</td></tr><tr><td>云端照片</td><td>❌ 仅本地</td><td>✅ Google Photos</td></tr><tr><td>开发成本</td><td>高</td><td>极低</td></tr><tr><td>用户信任</td><td>低</td><td>高（系统级UI）</td></tr><tr><td>安全性</td><td>自行保证</td><td>系统沙箱保护</td></tr></tbody></table>
<p>核心理念：<strong>App 只能访问用户明确选择的那几张照片，其他照片完全看不到。</strong></p>
<hr/>
<h2 data-id="heading-3">嵌入式 vs 标准照片选择器</h2>
<p>Google 其实早在 Android 13 就推出了 Photo Picker，但那是<strong>弹窗式</strong>的——用户点击后会跳转到系统界面选择。</p>
<p>新的 <strong>Embedded Photo Picker</strong> 是革命性的升级：</p>
<pre><code class="hljs">┌─────────────────────────────────────┐
│  你的 App 界面                       │
│  ┌─────────────────────────────────┐│
│  │  消息输入框...                   ││
│  └─────────────────────────────────┘│
│  ┌─────────────────────────────────┐│
│  │  📷  📷  📷    ← 嵌入式选择器    ││
│  │  📷  📷  📷       就在这里！     ││
│  └─────────────────────────────────┘│
└─────────────────────────────────────┘
</code></pre>
<p><strong>核心差异：</strong></p>



































<table><thead><tr><th>特性</th><th>标准 Photo Picker</th><th>嵌入式 Photo Picker</th></tr></thead><tbody><tr><td>交互方式</td><td>跳转系统界面</td><td>嵌入 App 内部</td></tr><tr><td>App 状态</td><td>进入后台暂停</td><td>保持前台活跃</td></tr><tr><td>选择体验</td><td>单次选择完成</td><td>可持续选择/取消</td></tr><tr><td>UI 定制</td><td>无法定制</td><td>支持主题色</td></tr><tr><td>实时反馈</td><td>选完才知道</td><td>实时更新</td></tr></tbody></table>
<p>Google Messages 已经采用了这个方案，体验非常丝滑——照片选择器就在输入框下方，选中的照片实时显示缩略图，取消选择后缩略图立即消失。</p>
<hr/>
<h2 data-id="heading-4">如何接入？</h2>
<h3 data-id="heading-5">设备要求</h3>
<ul>
<li>Android 14（API 34）或更高</li>
<li>SDK Extensions 版本 15+</li>
<li>不满足条件的设备自动回退到标准 Photo Picker</li>
</ul>
<h3 data-id="heading-6">添加依赖</h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// build.gradle.kts</span>

<span class="hljs-comment">// Jetpack Compose 项目（推荐）</span>
implementation(<span class="hljs-string">"androidx.photopicker:photopicker-compose:1.0.0-alpha01"</span>)

<span class="hljs-comment">// 传统 Views 项目</span>
implementation(<span class="hljs-string">"androidx.photopicker:photopicker:1.0.0-alpha01"</span>)
</code></pre>
<h3 data-id="heading-7">Compose 实现</h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">MessageScreen</span><span class="hljs-params">()</span></span> {
    <span class="hljs-keyword">val</span> coroutineScope = rememberCoroutineScope()
    <span class="hljs-keyword">val</span> pickerState = rememberEmbeddedPhotoPickerState()

    <span class="hljs-comment">// 已选择的照片</span>
    <span class="hljs-keyword">var</span> selectedUris <span class="hljs-keyword">by</span> remember { mutableStateOf(emptyList&lt;Uri&gt;()) }

    Column {
        <span class="hljs-comment">// 你的消息列表</span>
        MessageList()

        <span class="hljs-comment">// 输入框</span>
        MessageInput()

        <span class="hljs-comment">// 嵌入式照片选择器</span>
        EmbeddedPhotoPicker(
            state = pickerState,
            modifier = Modifier
                .fillMaxWidth()
                .height(<span class="hljs-number">300.</span>dp),
            onUriPermissionGranted = { uris -&gt;
                <span class="hljs-comment">// 用户选择了新照片</span>
                selectedUris = selectedUris + uris
            },
            onUriPermissionRevoked = { uris -&gt;
                <span class="hljs-comment">// 用户取消选择</span>
                selectedUris = selectedUris - uris.toSet()
            },
            onSelectionComplete = {
                <span class="hljs-comment">// 用户完成选择（可选）</span>
            }
        )
    }
}
</code></pre>
<h3 data-id="heading-8">自定义主题色</h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">val</span> featureInfo = EmbeddedPhotoPickerFeatureInfo.Builder()
    .setAccentColor(<span class="hljs-number">0xFF6200EE</span>.toInt())  <span class="hljs-comment">// 你的品牌色</span>
    .build()

EmbeddedPhotoPicker(
    state = pickerState,
    embeddedPhotoPickerFeatureInfo = featureInfo,
    <span class="hljs-comment">// ...</span>
)
</code></pre>
<blockquote>
<p>⚠️ 注意：主题色必须完全不透明，亮度值需在 0.05 ~ 0.9 之间。</p>
</blockquote>
<h3 data-id="heading-9">Views 实现</h3>
<p>如果你的项目还在用传统 Views：</p>
<p><strong>布局文件：</strong></p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">androidx.photopicker.EmbeddedPhotoPickerView</span>
    <span class="hljs-attr">android:id</span>=<span class="hljs-string">"@+id/photoPicker"</span>
    <span class="hljs-attr">android:layout_width</span>=<span class="hljs-string">"match_parent"</span>
    <span class="hljs-attr">android:layout_height</span>=<span class="hljs-string">"300dp"</span> /&gt;</span>
</code></pre>
<p><strong>Activity 代码：</strong></p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">MainActivity</span> : <span class="hljs-type">AppCompatActivity</span>() {

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">lateinit</span> <span class="hljs-keyword">var</span> picker: EmbeddedPhotoPickerView
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> session: EmbeddedPhotoPickerSession? = <span class="hljs-literal">null</span>

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> listener = <span class="hljs-keyword">object</span> : EmbeddedPhotoPickerStateChangeListener {

        <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onSessionOpened</span><span class="hljs-params">(newSession: <span class="hljs-type">EmbeddedPhotoPickerSession</span>)</span></span> {
            session = newSession
        }

        <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onUriPermissionGranted</span><span class="hljs-params">(uris: <span class="hljs-type">List</span>&lt;<span class="hljs-type">Uri</span>&gt;)</span></span> {
            <span class="hljs-comment">// 处理新选择的照片</span>
            handleSelectedPhotos(uris)
        }

        <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onUriPermissionRevoked</span><span class="hljs-params">(uris: <span class="hljs-type">List</span>&lt;<span class="hljs-type">Uri</span>&gt;)</span></span> {
            <span class="hljs-comment">// 处理取消选择</span>
            removePhotos(uris)
        }

        <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onSelectionComplete</span><span class="hljs-params">()</span></span> {
            <span class="hljs-comment">// 隐藏选择器（可选）</span>
        }

        <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onSessionError</span><span class="hljs-params">(throwable: <span class="hljs-type">Throwable</span>)</span></span> {
            <span class="hljs-comment">// 错误处理</span>
        }
    }

    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onCreate</span><span class="hljs-params">(savedInstanceState: <span class="hljs-type">Bundle</span>?)</span></span> {
        <span class="hljs-keyword">super</span>.onCreate(savedInstanceState)
        setContentView(R.layout.activity_main)

        picker = findViewById(R.id.photoPicker)
        picker.addEmbeddedPhotoPickerStateChangeListener(listener)
    }
}
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c0da85a4361b4ea1867b7c92466f5075~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6buE5p6X5pm0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770171210&amp;x-signature=ZYFEpZyjUD39jIf1s62WJh%2BUwdk%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e572dee31f8e422da2b81954c2178f4b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6buE5p6X5pm0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770171210&amp;x-signature=jm5S5wr3sE4SOtD7HQ0jCisdPp4%3D" alt="image.png" loading="lazy"/></p>
<hr/>
<h2 data-id="heading-10">高级用法</h2>
<h3 data-id="heading-11">同步取消选择状态</h3>
<p>当用户在你的 UI 中移除已选照片时，需要通知选择器同步状态：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// Compose</span>
coroutineScope.launch {
    pickerState.deselectUris(urisToRemove)
}

<span class="hljs-comment">// Views</span>
session?.requestRevokeUriPermission(urisToRemove)
</code></pre>
<h3 data-id="heading-12">处理配置变更</h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 屏幕旋转时</span>
session?.notifyConfigurationChanged(newConfig)

<span class="hljs-comment">// 展开/收起状态</span>
session?.notifyPhotoPickerExpanded(isExpanded)

<span class="hljs-comment">// 尺寸变化</span>
session?.notifyResized(newWidth, newHeight)
</code></pre>
<h3 data-id="heading-13">检测设备支持</h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">isEmbeddedPickerAvailable</span><span class="hljs-params">()</span></span>: <span class="hljs-built_in">Boolean</span> {
    <span class="hljs-keyword">return</span> Build.VERSION.SDK_INT &gt;= <span class="hljs-number">34</span> &amp;&amp;
           SdkExtensions.getExtensionVersion(Build.VERSION_CODES.UPSIDE_DOWN_CAKE) &gt;= <span class="hljs-number">15</span>
}
</code></pre>
<hr/>
<h2 data-id="heading-14">最佳实践</h2>
<h3 data-id="heading-15">1. 把选择器当作独立元素设计</h3>
<p>由于安全原因，系统会阻止任何覆盖在选择器上的 UI 元素。设计时要把它当作一个「神圣不可侵犯」的区域。</p>
<h3 data-id="heading-16">2. 提供回退方案</h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">PhotoPickerWrapper</span><span class="hljs-params">()</span></span> {
    <span class="hljs-keyword">if</span> (isEmbeddedPickerAvailable()) {
        EmbeddedPhotoPicker(<span class="hljs-comment">/* ... */</span>)
    } <span class="hljs-keyword">else</span> {
        <span class="hljs-comment">// 回退到标准 Photo Picker</span>
        StandardPhotoPickerButton(<span class="hljs-comment">/* ... */</span>)
    }
}
</code></pre>
<h3 data-id="heading-17">3. 实时反馈用户选择</h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 在输入框上方显示已选照片缩略图</span>
LazyRow {
    items(selectedUris) { uri -&gt;
        AsyncImage(
            model = uri,
            modifier = Modifier
                .size(<span class="hljs-number">60.</span>dp)
                .clickable {
                    <span class="hljs-comment">// 点击可移除</span>
                    coroutineScope.launch {
                        pickerState.deselectUris(listOf(uri))
                    }
                }
        )
    }
}
</code></pre>
<hr/>
<h2 data-id="heading-18">总结</h2>
<p><strong>Embedded Photo Picker 的核心价值：</strong></p>
<ol>
<li><strong>零权限</strong> —— 彻底告别「请求访问所有照片」</li>
<li><strong>云端集成</strong> —— 用户的 Google Photos 也能选</li>
<li><strong>原生体验</strong> —— 嵌入 App，不再跳转</li>
<li><strong>开发简单</strong> —— 几行代码搞定</li>
</ol>
<p>这不仅是 API 的更新，更是 Android 隐私保护理念的又一次进化。</p>
<hr/>
<p><em>如果这篇文章对你有帮助，欢迎点赞、在看、转发三连！有问题也欢迎在评论区交流 👇</em></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[我把 Claude Code 搬进了 Slack，从此蹲坑也能 Vibe Coding]]></title>    <link>https://juejin.cn/post/7600223321041158150</link>    <guid>https://juejin.cn/post/7600223321041158150</guid>    <pubDate>2026-01-28T09:31:14.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600223321041158150" data-draft-id="7599933828544823359" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="我把 Claude Code 搬进了 Slack，从此蹲坑也能 Vibe Coding"/> <meta itemprop="keywords" content="前端,人工智能,Claude"/> <meta itemprop="datePublished" content="2026-01-28T09:31:14.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="刮涂层_赢大奖"/> <meta itemprop="url" content="https://juejin.cn/user/1521379826214119"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            我把 Claude Code 搬进了 Slack，从此蹲坑也能 Vibe Coding
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1521379826214119/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    刮涂层_赢大奖
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-28T09:31:14.000Z" title="Wed Jan 28 2026 09:31:14 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-28
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">我把 Claude Code 搬进了 Slack，从此蹲坑也能 Vibe Coding</h2>
<blockquote>
<p>周末两天肝出一个工具，让 AI 帮我干活，我在 Slack 里指挥就行</p>
</blockquote>
<h3 data-id="heading-1">🤔 起因：一次深刻的厕所沉思</h3>
<p>那是一个普通的下午，我正在电脑前和 Claude Code 愉快地 vibe coding。需求聊着聊着，代码写着写着，突然，肚子一阵翻涌 —— 该去解决人生大事了。</p>
<p>坐在马桶上，我习惯性地掏出手机刷了会儿。刷着刷着突然想起来：卧槽，刚才让 Claude 改的那个函数，我还没确认呢，它现在在干嘛？</p>
<p>更要命的是，我还想继续和它聊，让它把剩下的逻辑也写了。但是... <strong>我在厕所啊！</strong></p>
<p>我盯着手机屏幕陷入了沉思：</p>
<ul>
<li>回去继续？—— 但这坨还没解决完</li>
<li>用手机 SSH？—— 上次试过，vim 在手机上简直是酷刑</li>
<li>干等着？—— 这也太浪费时间了</li>
</ul>
<p>就在这个充满哲学意味的时刻，一个想法击中了我：</p>
<p><strong>为什么我不能在手机上继续 vibe coding？</strong></p>
<p>现在 AI 编程这么火，Claude Code 那么好用，凭什么非得坐在电脑前？我就不能蹲着坑，发条消息，让 Claude 继续帮我干活？</p>
<p>想到这里，我感觉这坨💩都拉得更顺畅了。</p>
<p>说干就干。</p>
<h3 data-id="heading-2">💡 想法：让 Claude Code 成为我的远程员工</h3>
<p>思路其实很简单：</p>
<pre><code class="hljs language-rust" lang="rust">我 (Slack) -<span class="hljs-punctuation">-&gt;</span> 消息 -<span class="hljs-punctuation">-&gt;</span> 服务器 -<span class="hljs-punctuation">-&gt;</span> Claude Code -<span class="hljs-punctuation">-&gt;</span> 代码修改 -<span class="hljs-punctuation">-&gt;</span> 结果返回 -<span class="hljs-punctuation">-&gt;</span> Slack
</code></pre>
<p>把 Claude Code CLI 包装成一个服务，跑在我的开发服务器上，然后通过 Slack 这类 IM 工具来和它对话。这样我就可以：</p>
<ul>
<li>🚽 蹲坑的时候继续 vibe coding</li>
<li>📱 躺床上用手机改代码</li>
<li>🚇 地铁上处理紧急 bug</li>
<li>🍜 吃饭的时候让 AI 跑着任务</li>
</ul>
<p>我给它起名叫 <strong>Heimerdinger</strong> —— 英雄联盟里那个小矮子发明家。因为这工具就像有个小机器人帮你干活一样。</p>
<h3 data-id="heading-3">🏗️ 架构设计：踩过的第一个坑</h3>
<h4 data-id="heading-4">最初的设想</h4>
<p>一开始我想得很简单：</p>
<ol>
<li>监听 Slack 消息</li>
<li>调用 Claude CLI</li>
<li>把结果发回去</li>
</ol>
<p>三步走，完事儿。</p>
<h4 data-id="heading-5">现实的暴击</h4>
<p>实际做的时候才发现，事情没那么简单：</p>
<p><strong>问题一：Claude Code 的输出是流式的</strong></p>
<p>Claude 不是一下子吐出所有结果，而是一个字一个字往外蹦的。如果我等它全部输出完再发 Slack，用户体验会很差 —— 要等好久才能看到结果。</p>
<p><strong>问题二：一个 Slack workspace 可能有多个项目</strong></p>
<p>不同的频道可能在聊不同的项目，我需要记住"这个频道正在操作哪个项目"。</p>
<p><strong>问题三：会话连续性</strong></p>
<p>Claude Code 有会话概念，同一个会话里它能记住上下文。如果每次都开新会话，那用户说"把刚才那个函数改一下"，Claude 根本不知道"刚才"是啥。</p>
<h4 data-id="heading-6">最终架构</h4>
<pre><code class="hljs language-mermaid" lang="mermaid">flowchart TB
    subgraph daemon["hmdg daemon"]
        subgraph adapters["IM Adapters"]
            slack["Slack Adapter"]
            feishu["Feishu Adapter"]
            discord["Discord...&lt;br/&gt;(Future)"]
        end

        subgraph processor["Message Processor"]
            state["Session State&lt;br/&gt;Project State"]
        end

        claude["Claude Code CLI&lt;br/&gt;(streaming JSON)"]

        slack --&gt; processor
        feishu --&gt; processor
        discord --&gt; processor
        processor --&gt; claude
    end

    user["📱 你 (手机/电脑)"] &lt;--&gt; slack
    user &lt;--&gt; feishu
</code></pre>
<p>我设计了一个<strong>适配器模式</strong>，把不同 IM 平台的差异封装起来。这样以后想支持飞书、Discord 什么的，只需要写个新 Adapter 就行。</p>
<h3 data-id="heading-7">🔧 技术实现：细节里全是魔鬼</h3>
<h4 data-id="heading-8">1. 流式输出的处理</h4>
<p>Claude Code 支持 <code>--output-format stream-json</code> 参数，会输出 JSONL 格式的流式数据：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span><span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span><span class="hljs-string">"assistant"</span><span class="hljs-punctuation">,</span><span class="hljs-attr">"message"</span><span class="hljs-punctuation">:</span><span class="hljs-punctuation">{</span><span class="hljs-attr">"content"</span><span class="hljs-punctuation">:</span><span class="hljs-punctuation">[</span><span class="hljs-punctuation">{</span><span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span><span class="hljs-string">"text"</span><span class="hljs-punctuation">,</span><span class="hljs-attr">"text"</span><span class="hljs-punctuation">:</span><span class="hljs-string">"让我来"</span><span class="hljs-punctuation">}</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">}</span><span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">{</span><span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span><span class="hljs-string">"assistant"</span><span class="hljs-punctuation">,</span><span class="hljs-attr">"message"</span><span class="hljs-punctuation">:</span><span class="hljs-punctuation">{</span><span class="hljs-attr">"content"</span><span class="hljs-punctuation">:</span><span class="hljs-punctuation">[</span><span class="hljs-punctuation">{</span><span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span><span class="hljs-string">"text"</span><span class="hljs-punctuation">,</span><span class="hljs-attr">"text"</span><span class="hljs-punctuation">:</span><span class="hljs-string">"让我来看看"</span><span class="hljs-punctuation">}</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">}</span><span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">{</span><span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span><span class="hljs-string">"assistant"</span><span class="hljs-punctuation">,</span><span class="hljs-attr">"message"</span><span class="hljs-punctuation">:</span><span class="hljs-punctuation">{</span><span class="hljs-attr">"content"</span><span class="hljs-punctuation">:</span><span class="hljs-punctuation">[</span><span class="hljs-punctuation">{</span><span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span><span class="hljs-string">"text"</span><span class="hljs-punctuation">,</span><span class="hljs-attr">"text"</span><span class="hljs-punctuation">:</span><span class="hljs-string">"让我来看看这个bug"</span><span class="hljs-punctuation">}</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">}</span><span class="hljs-punctuation">}</span>
</code></pre>
<p>我需要实时解析这些 JSON，然后更新 Slack 消息。</p>
<p>但这里有个坑：<strong>Slack 有 API 频率限制</strong>。</p>
<p>如果每收到一个 JSON 就更新一次消息，很快就会被限流。所以我做了个节流处理：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 至少间隔 1 秒才更新一次消息</span>
<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">MIN_UPDATE_INTERVAL</span> = <span class="hljs-number">1000</span>;
<span class="hljs-keyword">let</span> lastUpdateTime = <span class="hljs-number">0</span>;

<span class="hljs-keyword">function</span> <span class="hljs-title function_">throttledUpdate</span>(<span class="hljs-params">content: <span class="hljs-built_in">string</span></span>) {
  <span class="hljs-keyword">const</span> now = <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>();
  <span class="hljs-keyword">if</span> (now - lastUpdateTime &gt;= <span class="hljs-variable constant_">MIN_UPDATE_INTERVAL</span>) {
    <span class="hljs-title function_">updateMessage</span>(content);
    lastUpdateTime = now;
  }
}
</code></pre>
<h4 data-id="heading-9">2. 会话状态管理</h4>
<p>这是整个项目最复杂的部分。我需要维护三层状态：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 每个频道当前选择的项目</span>
<span class="hljs-keyword">const</span> userStates = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>&lt;<span class="hljs-built_in">string</span>, <span class="hljs-title class_">ChannelState</span>&gt;();

<span class="hljs-comment">// 每个项目最后使用的会话 ID</span>
<span class="hljs-keyword">const</span> projectSessions = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>&lt;<span class="hljs-built_in">string</span>, <span class="hljs-built_in">string</span>&gt;();

<span class="hljs-comment">// 正在执行的任务（用于支持 /stop 命令）</span>
<span class="hljs-keyword">const</span> activeExecutions = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>&lt;<span class="hljs-built_in">string</span>, <span class="hljs-title class_">ExecutionInfo</span>&gt;();
</code></pre>
<p>而且这些状态要持久化，不然服务重启就全丢了：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 状态持久化到 ~/.heimerdinger/sessions-state.json</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">saveState</span>(<span class="hljs-params"/>) {
  fs.<span class="hljs-title function_">writeFileSync</span>(<span class="hljs-variable constant_">STATE_FILE</span>, <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>({
    <span class="hljs-attr">userStates</span>: <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">fromEntries</span>(userStates),
    <span class="hljs-attr">projectSessions</span>: <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">fromEntries</span>(projectSessions)
  }));
}
</code></pre>
<h4 data-id="heading-10">3. 项目发现机制</h4>
<p>Claude Code 会把项目信息存在 <code>~/.claude/projects/</code> 目录下，目录名是项目路径的编码形式：</p>
<pre><code class="hljs language-perl" lang="perl">~<span class="hljs-regexp">/.claude/pr</span>ojects/
├── home-dev-project-a/
├── home-dev-<span class="hljs-keyword">my</span>-project/
└── Users-test-<span class="hljs-keyword">my</span>-app/
</code></pre>
<p>编码规则很简单：把 <code>/</code> 替换成 <code>-</code>。但解码就头疼了。</p>
<p>比如 <code>home-dev-my-project</code>，它可能是：</p>
<ul>
<li><code>/home/dev/my/project</code> —— 4 层目录</li>
<li><code>/home/dev/my-project</code> —— 3 层目录，最后一层本身带连字符</li>
</ul>
<p><strong>没法直接区分哪个 <code>-</code> 是原来的 <code>/</code>，哪个是路径本身就有的。</strong></p>
<p>一开始我想简单处理：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 简单粗暴，但是错的</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">decodePath</span>(<span class="hljs-params">encoded: <span class="hljs-built_in">string</span></span>): <span class="hljs-built_in">string</span> {
  <span class="hljs-keyword">return</span> <span class="hljs-string">'/'</span> + encoded.<span class="hljs-title function_">replace</span>(<span class="hljs-regexp">/-/g</span>, <span class="hljs-string">'/'</span>);
}
<span class="hljs-comment">// home-dev-my-project -&gt; /home/dev/my/project ❌ 错！</span>
</code></pre>
<p>后来想到一个办法：<strong>穷举所有可能的组合，看哪个路径在文件系统里真实存在</strong>。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">decodeProjectPath</span>(<span class="hljs-params">encodedPath: <span class="hljs-built_in">string</span></span>): <span class="hljs-built_in">string</span> {
  <span class="hljs-keyword">const</span> parts = encodedPath.<span class="hljs-title function_">split</span>(<span class="hljs-string">'-'</span>);  <span class="hljs-comment">// ['home', 'dev', 'my', 'project']</span>
  <span class="hljs-keyword">const</span> result = <span class="hljs-title function_">findValidPath</span>(<span class="hljs-string">''</span>, parts, <span class="hljs-number">0</span>);
  <span class="hljs-keyword">return</span> result || <span class="hljs-string">`/<span class="hljs-subst">${encodedPath.replace(/-/g, <span class="hljs-string">'/'</span>)}</span>`</span>;  <span class="hljs-comment">// fallback</span>
}

<span class="hljs-comment">// 递归 + 回溯，尝试所有可能的路径组合</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">findValidPath</span>(<span class="hljs-params">current: <span class="hljs-built_in">string</span>, parts: <span class="hljs-built_in">string</span>[], index: <span class="hljs-built_in">number</span></span>): <span class="hljs-built_in">string</span> | <span class="hljs-literal">null</span> {
  <span class="hljs-keyword">if</span> (index &gt;= parts.<span class="hljs-property">length</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-title function_">existsSync</span>(current) ? current : <span class="hljs-literal">null</span>;
  }

  <span class="hljs-comment">// 从 index 开始，尝试把连续的 parts 拼成一个目录名</span>
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = index; i &lt; parts.<span class="hljs-property">length</span>; i++) {
    <span class="hljs-keyword">const</span> segment = parts.<span class="hljs-title function_">slice</span>(index, i + <span class="hljs-number">1</span>).<span class="hljs-title function_">join</span>(<span class="hljs-string">'-'</span>);  <span class="hljs-comment">// 'my' 或 'my-project'</span>
    <span class="hljs-keyword">const</span> newPath = <span class="hljs-string">`<span class="hljs-subst">${current}</span>/<span class="hljs-subst">${segment}</span>`</span>;

    <span class="hljs-keyword">if</span> (i === parts.<span class="hljs-property">length</span> - <span class="hljs-number">1</span>) {
      <span class="hljs-comment">// 最后一段了，检查路径是否存在</span>
      <span class="hljs-keyword">if</span> (<span class="hljs-title function_">existsSync</span>(newPath)) <span class="hljs-keyword">return</span> newPath;
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-comment">// 继续递归</span>
      <span class="hljs-keyword">const</span> result = <span class="hljs-title function_">findValidPath</span>(newPath, parts, i + <span class="hljs-number">1</span>);
      <span class="hljs-keyword">if</span> (result) <span class="hljs-keyword">return</span> result;
    }
  }
  <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
}
</code></pre>
<p>举个例子，对于 <code>home-dev-my-project</code>：</p>
<pre><code class="hljs language-arduino" lang="arduino">尝试 /home/dev/my/project  → <span class="hljs-built_in">existsSync</span>() = <span class="hljs-literal">false</span> ❌
尝试 /home/dev/my-project  → <span class="hljs-built_in">existsSync</span>() = <span class="hljs-literal">true</span>  ✅ 找到了！
</code></pre>
<p>本质就是暴力搜索，但因为目录层级不会太深，性能完全可以接受。</p>
<p><strong>有时候最笨的办法就是最好的办法</strong></p>
<h4 data-id="heading-11">4. 权限系统</h4>
<p>Claude Code 有权限控制，执行某些操作需要用户确认。在 CLI 里是交互式的，但在 Slack 里怎么办？</p>
<p>我做了个<strong>交互式卡片</strong>：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 当 Claude 需要权限时，发送一个带按钮的卡片</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">sendPermissionCard</span>(<span class="hljs-params">channel: <span class="hljs-built_in">string</span>, tool: <span class="hljs-built_in">string</span>, input: <span class="hljs-built_in">any</span></span>) {
  <span class="hljs-keyword">await</span> slack.<span class="hljs-property">chat</span>.<span class="hljs-title function_">postMessage</span>({
    channel,
    <span class="hljs-attr">blocks</span>: [
      {
        <span class="hljs-attr">type</span>: <span class="hljs-string">'section'</span>,
        <span class="hljs-attr">text</span>: { <span class="hljs-attr">type</span>: <span class="hljs-string">'mrkdwn'</span>, <span class="hljs-attr">text</span>: <span class="hljs-string">`🔐 *需要权限确认*\n工具: <span class="hljs-subst">${tool}</span>`</span> }
      },
      {
        <span class="hljs-attr">type</span>: <span class="hljs-string">'actions'</span>,
        <span class="hljs-attr">elements</span>: [
          { <span class="hljs-attr">type</span>: <span class="hljs-string">'button'</span>, <span class="hljs-attr">text</span>: { <span class="hljs-attr">type</span>: <span class="hljs-string">'plain_text'</span>, <span class="hljs-attr">text</span>: <span class="hljs-string">'✅ 允许'</span> }, <span class="hljs-attr">action_id</span>: <span class="hljs-string">'approve'</span> },
          { <span class="hljs-attr">type</span>: <span class="hljs-string">'button'</span>, <span class="hljs-attr">text</span>: { <span class="hljs-attr">type</span>: <span class="hljs-string">'plain_text'</span>, <span class="hljs-attr">text</span>: <span class="hljs-string">'❌ 拒绝'</span> }, <span class="hljs-attr">action_id</span>: <span class="hljs-string">'deny'</span> }
        ]
      }
    ]
  });
}
</code></pre>
<p>用户点击按钮后，我再用更高权限重新执行请求。</p>
<h4 data-id="heading-12">5. Slack 斜杠命令</h4>
<p>光发消息还不够，我还想要一些快捷操作。Slack 的斜杠命令（Slash Commands）正好派上用场：</p>
<ul>
<li><code>/project</code> —— 切换项目</li>
<li><code>/stop</code> —— 停止当前正在执行的任务</li>
<li><code>/clear</code> —— 清除会话，重新开始</li>
</ul>
<p>实现分两层：</p>
<p><strong>第一层：Slack Adapter 注册命令</strong></p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 注册 /project 命令</span>
<span class="hljs-variable language_">this</span>.<span class="hljs-property">app</span>.<span class="hljs-title function_">command</span>(<span class="hljs-string">'/project'</span>, <span class="hljs-keyword">async</span> ({ command, ack }) =&gt; {
  <span class="hljs-keyword">await</span> <span class="hljs-title function_">ack</span>();  <span class="hljs-comment">// 必须在 3 秒内响应，否则 Slack 会报错</span>

  <span class="hljs-keyword">const</span> context = {
    <span class="hljs-attr">channelId</span>: command.<span class="hljs-property">channel_id</span>,
    <span class="hljs-attr">userId</span>: command.<span class="hljs-property">user_id</span>,
  };

  <span class="hljs-comment">// 触发交互处理</span>
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> handler <span class="hljs-keyword">of</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">interactionHandlers</span>) {
    <span class="hljs-keyword">await</span> <span class="hljs-title function_">handler</span>(<span class="hljs-string">'show_project_selector'</span>, <span class="hljs-string">''</span>, context);
  }
});
</code></pre>
<p><strong>第二层：Message Processor 处理交互</strong></p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">async</span> <span class="hljs-title function_">handleInteraction</span>(<span class="hljs-params">action: <span class="hljs-built_in">string</span>, value: <span class="hljs-built_in">string</span>, context: MessageContext</span>) {
  <span class="hljs-keyword">if</span> (action === <span class="hljs-string">'show_project_selector'</span>) {
    <span class="hljs-comment">// 展示项目选择卡片</span>
    <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">showProjectSelector</span>(adapter, context);
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (action === <span class="hljs-string">'stop_execution'</span>) {
    <span class="hljs-comment">// 停止当前任务</span>
    <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">handleStopExecution</span>(adapter, context);
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (action === <span class="hljs-string">'clear_session'</span>) {
    <span class="hljs-comment">// 清除会话</span>
    <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">handleClearSession</span>(adapter, context);
  }
}
</code></pre>
<p><code>/stop</code> 的实现有点意思 —— 需要能够中断正在运行的 Claude 进程：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">private</span> <span class="hljs-keyword">async</span> <span class="hljs-title function_">handleStopExecution</span>(<span class="hljs-params">adapter: IMAdapter, context: MessageContext</span>) {
  <span class="hljs-keyword">const</span> execution = <span class="hljs-variable language_">this</span>.<span class="hljs-property">activeExecutions</span>.<span class="hljs-title function_">get</span>(context.<span class="hljs-property">channelId</span>);

  <span class="hljs-keyword">if</span> (!execution) {
    <span class="hljs-keyword">await</span> adapter.<span class="hljs-title function_">sendMessage</span>(context.<span class="hljs-property">channelId</span>, <span class="hljs-string">'没有正在运行的任务。'</span>);
    <span class="hljs-keyword">return</span>;
  }

  <span class="hljs-comment">// 标记为已中止，防止后续消息更新</span>
  execution.<span class="hljs-property">aborted</span> = <span class="hljs-literal">true</span>;
  <span class="hljs-comment">// 触发 AbortController</span>
  execution.<span class="hljs-title function_">abort</span>();

  <span class="hljs-keyword">await</span> adapter.<span class="hljs-title function_">updateMessage</span>(context.<span class="hljs-property">channelId</span>, execution.<span class="hljs-property">messageTs</span>, <span class="hljs-string">'🛑 已停止'</span>);
}
</code></pre>
<p>这里用了 <code>AbortController</code>，它是 Node.js 原生支持的中止信号机制。在启动 Claude 进程时传入 <code>abortSignal</code>，调用 <code>abort()</code> 就能优雅地终止进程。</p>
<p><strong>一个小细节</strong>：Slack 要求斜杠命令必须在 3 秒内响应（<code>ack()</code>），否则会显示错误。所以我先 <code>ack()</code>，再异步处理实际逻辑。这样用户体验会好很多。</p>
<h3 data-id="heading-13">😱 踩坑实录：那些让我头秃的问题</h3>
<h4 data-id="heading-14">坑 1：Bun + Slack WebSocket = 💥</h4>
<p>我一开始用 Bun 来开发，build 也用 Bun。结果发现一个诡异的问题：Slack 的 Socket Mode 在 Bun 运行时下经常断连。</p>
<p>排查了半天，发现是 Bun 的 WebSocket 实现和 <code>@slack/bolt</code> 不太兼容。</p>
<p><strong>解决方案</strong>：开发时用 <code>tsx</code>（Node.js 运行时），生产构建用 Bun 打包但改成 Node.js 的 shebang：</p>
<pre><code class="hljs language-bash" lang="bash">bun build ./src/cli.ts --outdir ./dist --target node &amp;&amp; \
sed -i <span class="hljs-string">'1s|#!/usr/bin/env bun|#!/usr/bin/env node|'</span> ./dist/cli.js
</code></pre>
<p>是的，有点丑陋，但它能用。</p>
<h4 data-id="heading-15">坑 2：Slack 消息长度限制</h4>
<p>Slack 单条消息最大 40KB（实际建议 38KB 以内）。但 Claude 有时候会输出很长的内容，特别是它在解释代码的时候。</p>
<p>直接截断？不行，可能截到一半把 markdown 格式搞坏了。</p>
<p><strong>解决方案</strong>：按字节长度截断，并确保截断点不在多字节字符中间：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">truncateToByteLength</span>(<span class="hljs-params">str: <span class="hljs-built_in">string</span>, maxBytes: <span class="hljs-built_in">number</span></span>): <span class="hljs-built_in">string</span> {
  <span class="hljs-keyword">const</span> encoder = <span class="hljs-keyword">new</span> <span class="hljs-title class_">TextEncoder</span>();
  <span class="hljs-keyword">const</span> encoded = encoder.<span class="hljs-title function_">encode</span>(str);

  <span class="hljs-keyword">if</span> (encoded.<span class="hljs-property">length</span> &lt;= maxBytes) <span class="hljs-keyword">return</span> str;

  <span class="hljs-comment">// 找到合适的截断点</span>
  <span class="hljs-keyword">let</span> truncated = encoded.<span class="hljs-title function_">slice</span>(<span class="hljs-number">0</span>, maxBytes);
  <span class="hljs-comment">// 确保不截断 UTF-8 多字节字符</span>
  <span class="hljs-keyword">while</span> (truncated.<span class="hljs-property">length</span> &gt; <span class="hljs-number">0</span> &amp;&amp; (truncated[truncated.<span class="hljs-property">length</span> - <span class="hljs-number">1</span>] &amp; <span class="hljs-number">0xc0</span>) === <span class="hljs-number">0x80</span>) {
    truncated = truncated.<span class="hljs-title function_">slice</span>(<span class="hljs-number">0</span>, -<span class="hljs-number">1</span>);
  }

  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TextDecoder</span>().<span class="hljs-title function_">decode</span>(truncated) + <span class="hljs-string">'\n\n... (内容过长，已截断)'</span>;
}
</code></pre>
<h4 data-id="heading-16">坑 3：Markdown 格式转换</h4>
<p>Claude 输出的是标准 Markdown，但 Slack 用的是自己的 <code>mrkdwn</code> 格式。两者语法不一样：</p>

























<table><thead><tr><th>Markdown</th><th>Slack mrkdwn</th></tr></thead><tbody><tr><td><code>**bold**</code></td><td><code>*bold*</code></td></tr><tr><td><code>*italic*</code></td><td><code>_italic_</code></td></tr><tr><td><code>[text](url)</code></td><td><code>&lt;url|text&gt;</code></td></tr><tr><td><code>`code`</code></td><td><code>`code`</code></td></tr></tbody></table>
<p>我写了个转换函数，处理这些差异。但最坑的是代码块 —— Slack 对代码块的渲染很奇怪，超过一定长度就会出问题。</p>
<p><strong>最终方案</strong>：长代码不放在消息里，而是上传成代码片段（Snippet）：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">if</span> (codeBlock.<span class="hljs-property">length</span> &gt; <span class="hljs-number">2000</span>) {
  <span class="hljs-keyword">await</span> slack.<span class="hljs-property">files</span>.<span class="hljs-title function_">uploadV2</span>({
    <span class="hljs-attr">channel_id</span>: channel,
    <span class="hljs-attr">content</span>: codeBlock,
    <span class="hljs-attr">filename</span>: <span class="hljs-string">'code.txt'</span>,
    <span class="hljs-attr">title</span>: <span class="hljs-string">'Code Output'</span>
  });
}
</code></pre>
<h4 data-id="heading-17">坑 4：语音消息支持</h4>
<p>既然是在手机上用，那支持语音消息岂不是更方便？说一句话就能让 Claude 干活。</p>
<p>我集成了 <code>whisper.cpp</code> 做语音转文字：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">transcribe</span>(<span class="hljs-params">audioPath: <span class="hljs-built_in">string</span></span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">string</span>&gt; {
  <span class="hljs-comment">// 先用 ffmpeg 转换成 whisper 需要的格式</span>
  <span class="hljs-keyword">await</span> <span class="hljs-title function_">exec</span>(<span class="hljs-string">`ffmpeg -i <span class="hljs-subst">${audioPath}</span> -ar 16000 -ac 1 -f wav <span class="hljs-subst">${wavPath}</span>`</span>);

  <span class="hljs-comment">// 调用 whisper</span>
  <span class="hljs-keyword">const</span> { stdout } = <span class="hljs-keyword">await</span> <span class="hljs-title function_">exec</span>(<span class="hljs-string">`whisper-cli -m <span class="hljs-subst">${modelPath}</span> -f <span class="hljs-subst">${wavPath}</span>`</span>);
  <span class="hljs-keyword">return</span> stdout.<span class="hljs-title function_">trim</span>();
}
</code></pre>
<p>但这里又有坑：Slack 发来的语音是 <code>.mp4</code> 格式，需要先下载再转换。而且 whisper 模型挺大的，第一次运行要下载...</p>
<h4 data-id="heading-18">坑 5：进程管理</h4>
<p>作为一个后台服务，进程管理是必须的：</p>
<ul>
<li>如何优雅地启动/停止？</li>
<li>如何检测服务是否在运行？</li>
<li>如何处理僵尸进程？</li>
</ul>
<p>我用 PID 文件 + 信号量来管理：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">stop</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> pid = <span class="hljs-title function_">readPidFile</span>();
  <span class="hljs-keyword">if</span> (!pid) <span class="hljs-keyword">return</span>;

  <span class="hljs-comment">// 先尝试优雅退出</span>
  process.<span class="hljs-title function_">kill</span>(pid, <span class="hljs-string">'SIGTERM'</span>);

  <span class="hljs-comment">// 等待 5 秒</span>
  <span class="hljs-keyword">await</span> <span class="hljs-title function_">sleep</span>(<span class="hljs-number">5000</span>);

  <span class="hljs-comment">// 如果还在运行，强制杀掉</span>
  <span class="hljs-keyword">if</span> (<span class="hljs-title function_">isRunning</span>(pid)) {
    process.<span class="hljs-title function_">kill</span>(pid, <span class="hljs-string">'SIGKILL'</span>);
  }
}
</code></pre>
<h3 data-id="heading-19">✨ 最终效果</h3>
<p>折腾了两天，终于能用了：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 安装</span>
npm install -g chat-heimerdinger

<span class="hljs-comment"># 初始化配置</span>
hmdg init

<span class="hljs-comment"># 启动服务</span>
hmdg start
</code></pre>
<p>然后在 Slack 里：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e9bbf37e25a444669824261a7208d970~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Yiu5raC5bGCX-i1ouWkp-Wllg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770197474&amp;x-signature=6LgEiu2tVnnnd%2BhdBn0%2Bn9c4N5c%3D" alt="2db91133029cfc157e7dbbcea5630576.jpg" loading="lazy"/></p>
<p><strong>或者直接发语音</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ac7f7df145434743a566bd802a638a7d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Yiu5raC5bGCX-i1ouWkp-Wllg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770197474&amp;x-signature=ixMQg9iJqc%2FEf3cGoLTtujlh7Zo%3D" alt="cae84620508677ae00533e3fc5d68573.jpg" loading="lazy"/></p>
<p>蹲在马桶上，动动手指，代码就改好了。Vibe coding，永不断档！</p>
<p>如果不确定Claude code的改动是否正确，每次对话的thread里还有本次修改的diff</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/65803658919e4b7aac248bfe5cc51f09~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Yiu5raC5bGCX-i1ouWkp-Wllg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770197474&amp;x-signature=h3YTO9ioCZIu0xzerH%2Fk7UMCPWo%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-20">写在最后</h3>
<p><strong>工具的价值在于节省时间。</strong> 虽然开发这个工具花了我两个整天，但以后每次蹲坑时继续 vibe coding 省下的时间，迟早会赚回来的（大概）。</p>
<p>slack目前支持已经基本完善，但飞书我是盲调的（公司内网有防火墙，连不到飞书的socket，所以飞书的不保证可用，后续我还会继续调整）。后续我还会考虑支持上钉钉、企微、微信，<strong>让更多的IM工具都能实现马桶vibe coding</strong>。</p>
<hr/>
<p>项目地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fa1245582339%2Fchat-heimerdinger" target="_blank" title="https://github.com/a1245582339/chat-heimerdinger" ref="nofollow noopener noreferrer">GitHub - chat-heimerdinger</a></p>
<p>如果觉得有用，欢迎 Star ⭐</p>
<p>有问题欢迎评论区交流，我会尽量回复（如果我不是在厕所里指挥 Claude 干活的话）。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[完整的白屏检测 SDK]]></title>    <link>https://juejin.cn/post/7599933828544036927</link>    <guid>https://juejin.cn/post/7599933828544036927</guid>    <pubDate>2026-01-28T03:32:54.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7599933828544036927" data-draft-id="7599983917664108587" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="完整的白屏检测 SDK "/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2026-01-28T03:32:54.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="小小小小宇"/> <meta itemprop="url" content="https://juejin.cn/user/3386151546662077"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            完整的白屏检测 SDK 
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3386151546662077/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    小小小小宇
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-28T03:32:54.000Z" title="Wed Jan 28 2026 03:32:54 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-28
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    34
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读17分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前端白屏检测完整方案</h2>
<p>白屏检测是前端监控体系中非常重要的一环，用于检测页面是否正常渲染，及时发现并上报白屏异常。</p>
<h3 data-id="heading-1">一、白屏检测的核心原理</h3>
<p>白屏检测主要有以下几种实现思路：</p>
<ol>
<li><strong>采样点检测法</strong> - 在页面关键位置采样，判断是否有有效内容</li>
<li><strong>DOM 元素检测法</strong> - 检测页面关键 DOM 元素是否存在</li>
<li><strong>MutationObserver 监听法</strong> - 监听 DOM 变化判断页面渲染状态</li>
<li><strong>骨架屏检测法</strong> - 检测骨架屏是否被替换为实际内容</li>
<li><strong>截图对比法</strong> - 通过 Canvas 截图分析页面内容</li>
<li><strong>Performance API 检测法</strong> - 利用浏览器性能 API 判断渲染状态</li>
</ol>
<h3 data-id="heading-2">二、完整的白屏检测 SDK 实现</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// ==================== 类型定义 ====================</span>

<span class="hljs-comment">/**
 * 白屏检测配置接口
 */</span>
<span class="hljs-keyword">interface</span> <span class="hljs-title class_">WhiteScreenConfig</span> {
  <span class="hljs-comment">// 采样点数量（水平和垂直方向）</span>
  samplingPoints?: <span class="hljs-built_in">number</span>;
  <span class="hljs-comment">// 检测延迟时间（毫秒）</span>
  delay?: <span class="hljs-built_in">number</span>;
  <span class="hljs-comment">// 检测超时时间（毫秒）</span>
  timeout?: <span class="hljs-built_in">number</span>;
  <span class="hljs-comment">// 白屏阈值（0-1之间，超过该比例认为是白屏）</span>
  threshold?: <span class="hljs-built_in">number</span>;
  <span class="hljs-comment">// 是否启用 DOM 检测</span>
  enableDOMDetection?: <span class="hljs-built_in">boolean</span>;
  <span class="hljs-comment">// 是否启用采样点检测</span>
  enableSamplingDetection?: <span class="hljs-built_in">boolean</span>;
  <span class="hljs-comment">// 是否启用 MutationObserver 检测</span>
  enableMutationDetection?: <span class="hljs-built_in">boolean</span>;
  <span class="hljs-comment">// 是否启用截图检测</span>
  enableScreenshotDetection?: <span class="hljs-built_in">boolean</span>;
  <span class="hljs-comment">// 是否启用骨架屏检测</span>
  enableSkeletonDetection?: <span class="hljs-built_in">boolean</span>;
  <span class="hljs-comment">// 骨架屏容器选择器</span>
  skeletonSelector?: <span class="hljs-built_in">string</span>;
  <span class="hljs-comment">// 关键元素选择器列表</span>
  keyElementSelectors?: <span class="hljs-built_in">string</span>[];
  <span class="hljs-comment">// 需要忽略的元素选择器</span>
  ignoreSelectors?: <span class="hljs-built_in">string</span>[];
  <span class="hljs-comment">// 容器元素（默认为 document.body）</span>
  container?: <span class="hljs-title class_">HTMLElement</span> | <span class="hljs-literal">null</span>;
  <span class="hljs-comment">// 上报回调函数</span>
  onReport?: <span class="hljs-function">(<span class="hljs-params">data: WhiteScreenReport</span>) =&gt;</span> <span class="hljs-built_in">void</span>;
  <span class="hljs-comment">// 检测完成回调</span>
  onDetectionComplete?: <span class="hljs-function">(<span class="hljs-params">result: DetectionResult</span>) =&gt;</span> <span class="hljs-built_in">void</span>;
  <span class="hljs-comment">// 是否在开发环境启用</span>
  enableInDev?: <span class="hljs-built_in">boolean</span>;
  <span class="hljs-comment">// 最大重试次数</span>
  maxRetries?: <span class="hljs-built_in">number</span>;
  <span class="hljs-comment">// 重试间隔（毫秒）</span>
  retryInterval?: <span class="hljs-built_in">number</span>;
  <span class="hljs-comment">// 自定义白屏判断函数</span>
  customDetector?: <span class="hljs-function">() =&gt;</span> <span class="hljs-built_in">boolean</span> | <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">boolean</span>&gt;;
}

<span class="hljs-comment">/**
 * 白屏检测报告接口
 */</span>
<span class="hljs-keyword">interface</span> <span class="hljs-title class_">WhiteScreenReport</span> {
  <span class="hljs-comment">// 是否白屏</span>
  <span class="hljs-attr">isWhiteScreen</span>: <span class="hljs-built_in">boolean</span>;
  <span class="hljs-comment">// 检测时间戳</span>
  <span class="hljs-attr">timestamp</span>: <span class="hljs-built_in">number</span>;
  <span class="hljs-comment">// 页面 URL</span>
  <span class="hljs-attr">url</span>: <span class="hljs-built_in">string</span>;
  <span class="hljs-comment">// 检测方法</span>
  <span class="hljs-attr">detectionMethod</span>: <span class="hljs-title class_">DetectionMethod</span>;
  <span class="hljs-comment">// 采样点结果</span>
  samplingResult?: <span class="hljs-title class_">SamplingResult</span>;
  <span class="hljs-comment">// DOM 检测结果</span>
  domResult?: <span class="hljs-title class_">DOMDetectionResult</span>;
  <span class="hljs-comment">// 截图检测结果</span>
  screenshotResult?: <span class="hljs-title class_">ScreenshotResult</span>;
  <span class="hljs-comment">// 骨架屏检测结果</span>
  skeletonResult?: <span class="hljs-title class_">SkeletonResult</span>;
  <span class="hljs-comment">// 页面性能数据</span>
  performanceData?: <span class="hljs-title class_">PerformanceData</span>;
  <span class="hljs-comment">// 用户代理信息</span>
  <span class="hljs-attr">userAgent</span>: <span class="hljs-built_in">string</span>;
  <span class="hljs-comment">// 视口尺寸</span>
  <span class="hljs-attr">viewport</span>: <span class="hljs-title class_">ViewportSize</span>;
  <span class="hljs-comment">// 设备像素比</span>
  <span class="hljs-attr">devicePixelRatio</span>: <span class="hljs-built_in">number</span>;
  <span class="hljs-comment">// 网络信息</span>
  networkInfo?: <span class="hljs-title class_">NetworkInfo</span>;
  <span class="hljs-comment">// 错误信息</span>
  errorInfo?: <span class="hljs-title class_">ErrorInfo</span>;
  <span class="hljs-comment">// 自定义数据</span>
  customData?: <span class="hljs-title class_">Record</span>&lt;<span class="hljs-built_in">string</span>, <span class="hljs-built_in">unknown</span>&gt;;
}

<span class="hljs-comment">/**
 * 检测方法枚举
 */</span>
<span class="hljs-keyword">enum</span> <span class="hljs-title class_">DetectionMethod</span> {
  <span class="hljs-variable constant_">SAMPLING</span> = <span class="hljs-string">'sampling'</span>,
  <span class="hljs-variable constant_">DOM</span> = <span class="hljs-string">'dom'</span>,
  <span class="hljs-variable constant_">MUTATION</span> = <span class="hljs-string">'mutation'</span>,
  <span class="hljs-variable constant_">SCREENSHOT</span> = <span class="hljs-string">'screenshot'</span>,
  <span class="hljs-variable constant_">SKELETON</span> = <span class="hljs-string">'skeleton'</span>,
  <span class="hljs-variable constant_">PERFORMANCE</span> = <span class="hljs-string">'performance'</span>,
  <span class="hljs-variable constant_">CUSTOM</span> = <span class="hljs-string">'custom'</span>,
  <span class="hljs-variable constant_">COMBINED</span> = <span class="hljs-string">'combined'</span>
}

<span class="hljs-comment">/**
 * 采样点结果接口
 */</span>
<span class="hljs-keyword">interface</span> <span class="hljs-title class_">SamplingResult</span> {
  <span class="hljs-comment">// 总采样点数</span>
  <span class="hljs-attr">totalPoints</span>: <span class="hljs-built_in">number</span>;
  <span class="hljs-comment">// 空白点数</span>
  <span class="hljs-attr">emptyPoints</span>: <span class="hljs-built_in">number</span>;
  <span class="hljs-comment">// 空白比例</span>
  <span class="hljs-attr">emptyRatio</span>: <span class="hljs-built_in">number</span>;
  <span class="hljs-comment">// 采样点详情</span>
  <span class="hljs-attr">pointDetails</span>: <span class="hljs-title class_">SamplingPointDetail</span>[];
}

<span class="hljs-comment">/**
 * 采样点详情
 */</span>
<span class="hljs-keyword">interface</span> <span class="hljs-title class_">SamplingPointDetail</span> {
  <span class="hljs-comment">// X 坐标</span>
  <span class="hljs-attr">x</span>: <span class="hljs-built_in">number</span>;
  <span class="hljs-comment">// Y 坐标</span>
  <span class="hljs-attr">y</span>: <span class="hljs-built_in">number</span>;
  <span class="hljs-comment">// 元素标签名</span>
  <span class="hljs-attr">tagName</span>: <span class="hljs-built_in">string</span> | <span class="hljs-literal">null</span>;
  <span class="hljs-comment">// 是否为空白点</span>
  <span class="hljs-attr">isEmpty</span>: <span class="hljs-built_in">boolean</span>;
  <span class="hljs-comment">// 元素类名</span>
  className?: <span class="hljs-built_in">string</span>;
  <span class="hljs-comment">// 元素 ID</span>
  id?: <span class="hljs-built_in">string</span>;
}

<span class="hljs-comment">/**
 * DOM 检测结果接口
 */</span>
<span class="hljs-keyword">interface</span> <span class="hljs-title class_">DOMDetectionResult</span> {
  <span class="hljs-comment">// 是否通过检测</span>
  <span class="hljs-attr">passed</span>: <span class="hljs-built_in">boolean</span>;
  <span class="hljs-comment">// 检测到的关键元素数量</span>
  <span class="hljs-attr">foundElements</span>: <span class="hljs-built_in">number</span>;
  <span class="hljs-comment">// 期望的关键元素数量</span>
  <span class="hljs-attr">expectedElements</span>: <span class="hljs-built_in">number</span>;
  <span class="hljs-comment">// 缺失的元素选择器</span>
  <span class="hljs-attr">missingSelectors</span>: <span class="hljs-built_in">string</span>[];
  <span class="hljs-comment">// 元素详情</span>
  <span class="hljs-attr">elementDetails</span>: <span class="hljs-title class_">ElementDetail</span>[];
}

<span class="hljs-comment">/**
 * 元素详情
 */</span>
<span class="hljs-keyword">interface</span> <span class="hljs-title class_">ElementDetail</span> {
  <span class="hljs-comment">// 选择器</span>
  <span class="hljs-attr">selector</span>: <span class="hljs-built_in">string</span>;
  <span class="hljs-comment">// 是否存在</span>
  <span class="hljs-attr">exists</span>: <span class="hljs-built_in">boolean</span>;
  <span class="hljs-comment">// 是否可见</span>
  isVisible?: <span class="hljs-built_in">boolean</span>;
  <span class="hljs-comment">// 元素尺寸</span>
  dimensions?: {
    <span class="hljs-attr">width</span>: <span class="hljs-built_in">number</span>;
    <span class="hljs-attr">height</span>: <span class="hljs-built_in">number</span>;
  };
}

<span class="hljs-comment">/**
 * 截图检测结果
 */</span>
<span class="hljs-keyword">interface</span> <span class="hljs-title class_">ScreenshotResult</span> {
  <span class="hljs-comment">// 是否白屏</span>
  <span class="hljs-attr">isWhiteScreen</span>: <span class="hljs-built_in">boolean</span>;
  <span class="hljs-comment">// 白色像素比例</span>
  <span class="hljs-attr">whitePixelRatio</span>: <span class="hljs-built_in">number</span>;
  <span class="hljs-comment">// 总像素数</span>
  <span class="hljs-attr">totalPixels</span>: <span class="hljs-built_in">number</span>;
  <span class="hljs-comment">// 白色像素数</span>
  <span class="hljs-attr">whitePixels</span>: <span class="hljs-built_in">number</span>;
  <span class="hljs-comment">// 颜色分布</span>
  colorDistribution?: <span class="hljs-title class_">ColorDistribution</span>;
}

<span class="hljs-comment">/**
 * 颜色分布
 */</span>
<span class="hljs-keyword">interface</span> <span class="hljs-title class_">ColorDistribution</span> {
  <span class="hljs-attr">white</span>: <span class="hljs-built_in">number</span>;
  <span class="hljs-attr">black</span>: <span class="hljs-built_in">number</span>;
  <span class="hljs-attr">gray</span>: <span class="hljs-built_in">number</span>;
  <span class="hljs-attr">colored</span>: <span class="hljs-built_in">number</span>;
}

<span class="hljs-comment">/**
 * 骨架屏检测结果
 */</span>
<span class="hljs-keyword">interface</span> <span class="hljs-title class_">SkeletonResult</span> {
  <span class="hljs-comment">// 骨架屏是否存在</span>
  <span class="hljs-attr">skeletonExists</span>: <span class="hljs-built_in">boolean</span>;
  <span class="hljs-comment">// 骨架屏是否已移除</span>
  <span class="hljs-attr">skeletonRemoved</span>: <span class="hljs-built_in">boolean</span>;
  <span class="hljs-comment">// 检测时间</span>
  <span class="hljs-attr">detectionTime</span>: <span class="hljs-built_in">number</span>;
}

<span class="hljs-comment">/**
 * 性能数据
 */</span>
<span class="hljs-keyword">interface</span> <span class="hljs-title class_">PerformanceData</span> {
  <span class="hljs-comment">// DOM 加载完成时间</span>
  domContentLoaded?: <span class="hljs-built_in">number</span>;
  <span class="hljs-comment">// 页面完全加载时间</span>
  loadComplete?: <span class="hljs-built_in">number</span>;
  <span class="hljs-comment">// 首次内容绘制时间</span>
  firstContentfulPaint?: <span class="hljs-built_in">number</span>;
  <span class="hljs-comment">// 最大内容绘制时间</span>
  largestContentfulPaint?: <span class="hljs-built_in">number</span>;
  <span class="hljs-comment">// 首次输入延迟</span>
  firstInputDelay?: <span class="hljs-built_in">number</span>;
  <span class="hljs-comment">// 累计布局偏移</span>
  cumulativeLayoutShift?: <span class="hljs-built_in">number</span>;
  <span class="hljs-comment">// 可交互时间</span>
  timeToInteractive?: <span class="hljs-built_in">number</span>;
}

<span class="hljs-comment">/**
 * 视口尺寸
 */</span>
<span class="hljs-keyword">interface</span> <span class="hljs-title class_">ViewportSize</span> {
  <span class="hljs-attr">width</span>: <span class="hljs-built_in">number</span>;
  <span class="hljs-attr">height</span>: <span class="hljs-built_in">number</span>;
}

<span class="hljs-comment">/**
 * 网络信息
 */</span>
<span class="hljs-keyword">interface</span> <span class="hljs-title class_">NetworkInfo</span> {
  <span class="hljs-comment">// 网络类型</span>
  effectiveType?: <span class="hljs-built_in">string</span>;
  <span class="hljs-comment">// 下行带宽</span>
  downlink?: <span class="hljs-built_in">number</span>;
  <span class="hljs-comment">// RTT</span>
  rtt?: <span class="hljs-built_in">number</span>;
  <span class="hljs-comment">// 是否在线</span>
  <span class="hljs-attr">online</span>: <span class="hljs-built_in">boolean</span>;
}

<span class="hljs-comment">/**
 * 错误信息
 */</span>
<span class="hljs-keyword">interface</span> <span class="hljs-title class_">ErrorInfo</span> {
  <span class="hljs-comment">// 错误消息</span>
  <span class="hljs-attr">message</span>: <span class="hljs-built_in">string</span>;
  <span class="hljs-comment">// 错误堆栈</span>
  stack?: <span class="hljs-built_in">string</span>;
  <span class="hljs-comment">// 错误类型</span>
  <span class="hljs-attr">type</span>: <span class="hljs-built_in">string</span>;
}

<span class="hljs-comment">/**
 * 检测结果
 */</span>
<span class="hljs-keyword">interface</span> <span class="hljs-title class_">DetectionResult</span> {
  <span class="hljs-comment">// 是否白屏</span>
  <span class="hljs-attr">isWhiteScreen</span>: <span class="hljs-built_in">boolean</span>;
  <span class="hljs-comment">// 置信度（0-1）</span>
  <span class="hljs-attr">confidence</span>: <span class="hljs-built_in">number</span>;
  <span class="hljs-comment">// 检测方法</span>
  <span class="hljs-attr">methods</span>: <span class="hljs-title class_">DetectionMethod</span>[];
  <span class="hljs-comment">// 各方法结果</span>
  <span class="hljs-attr">methodResults</span>: <span class="hljs-title class_">Map</span>&lt;<span class="hljs-title class_">DetectionMethod</span>, <span class="hljs-built_in">boolean</span>&gt;;
  <span class="hljs-comment">// 最终判定依据</span>
  <span class="hljs-attr">basis</span>: <span class="hljs-built_in">string</span>;
}

<span class="hljs-comment">// ==================== 工具函数 ====================</span>

<span class="hljs-comment">/**
 * 防抖函数
 */</span>
<span class="hljs-keyword">function</span> debounce&lt;T <span class="hljs-keyword">extends</span> (...<span class="hljs-attr">args</span>: <span class="hljs-built_in">unknown</span>[]) =&gt; <span class="hljs-built_in">unknown</span>&gt;(
  <span class="hljs-attr">func</span>: T,
  <span class="hljs-attr">wait</span>: <span class="hljs-built_in">number</span>
): <span class="hljs-function">(<span class="hljs-params">...args: Parameters&lt;T&gt;</span>) =&gt;</span> <span class="hljs-built_in">void</span> {
  <span class="hljs-keyword">let</span> <span class="hljs-attr">timeoutId</span>: <span class="hljs-title class_">ReturnType</span>&lt;<span class="hljs-keyword">typeof</span> <span class="hljs-built_in">setTimeout</span>&gt; | <span class="hljs-literal">null</span> = <span class="hljs-literal">null</span>;
  
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">function</span> (<span class="hljs-params"><span class="hljs-variable language_">this</span>: <span class="hljs-built_in">unknown</span>, ...args: Parameters&lt;T&gt;</span>) {
    <span class="hljs-keyword">if</span> (timeoutId !== <span class="hljs-literal">null</span>) {
      <span class="hljs-built_in">clearTimeout</span>(timeoutId);
    }
    
    timeoutId = <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
      func.<span class="hljs-title function_">apply</span>(<span class="hljs-variable language_">this</span>, args);
      timeoutId = <span class="hljs-literal">null</span>;
    }, wait);
  };
}

<span class="hljs-comment">/**
 * 节流函数
 */</span>
<span class="hljs-keyword">function</span> throttle&lt;T <span class="hljs-keyword">extends</span> (...<span class="hljs-attr">args</span>: <span class="hljs-built_in">unknown</span>[]) =&gt; <span class="hljs-built_in">unknown</span>&gt;(
  <span class="hljs-attr">func</span>: T,
  <span class="hljs-attr">limit</span>: <span class="hljs-built_in">number</span>
): <span class="hljs-function">(<span class="hljs-params">...args: Parameters&lt;T&gt;</span>) =&gt;</span> <span class="hljs-built_in">void</span> {
  <span class="hljs-keyword">let</span> inThrottle = <span class="hljs-literal">false</span>;
  
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">function</span> (<span class="hljs-params"><span class="hljs-variable language_">this</span>: <span class="hljs-built_in">unknown</span>, ...args: Parameters&lt;T&gt;</span>) {
    <span class="hljs-keyword">if</span> (!inThrottle) {
      func.<span class="hljs-title function_">apply</span>(<span class="hljs-variable language_">this</span>, args);
      inThrottle = <span class="hljs-literal">true</span>;
      <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
        inThrottle = <span class="hljs-literal">false</span>;
      }, limit);
    }
  };
}

<span class="hljs-comment">/**
 * 延迟执行
 */</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">delay</span>(<span class="hljs-params">ms: <span class="hljs-built_in">number</span></span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">void</span>&gt; {
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function"><span class="hljs-params">resolve</span> =&gt;</span> <span class="hljs-built_in">setTimeout</span>(resolve, ms));
}

<span class="hljs-comment">/**
 * 带超时的 Promise
 */</span>
<span class="hljs-keyword">function</span> withTimeout&lt;T&gt;(
  <span class="hljs-attr">promise</span>: <span class="hljs-title class_">Promise</span>&lt;T&gt;,
  <span class="hljs-attr">ms</span>: <span class="hljs-built_in">number</span>,
  errorMessage = <span class="hljs-string">'Operation timed out'</span>
): <span class="hljs-title class_">Promise</span>&lt;T&gt; {
  <span class="hljs-keyword">const</span> timeout = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">never</span>&gt;(<span class="hljs-function">(<span class="hljs-params">_, reject</span>) =&gt;</span> {
    <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">reject</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(errorMessage)), ms);
  });
  
  <span class="hljs-keyword">return</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">race</span>([promise, timeout]);
}

<span class="hljs-comment">/**
 * 重试函数
 */</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> retry&lt;T&gt;(
  <span class="hljs-attr">fn</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-title class_">Promise</span>&lt;T&gt;,
  <span class="hljs-attr">maxRetries</span>: <span class="hljs-built_in">number</span>,
  <span class="hljs-attr">retryInterval</span>: <span class="hljs-built_in">number</span>
): <span class="hljs-title class_">Promise</span>&lt;T&gt; {
  <span class="hljs-keyword">let</span> <span class="hljs-attr">lastError</span>: <span class="hljs-title class_">Error</span> | <span class="hljs-literal">null</span> = <span class="hljs-literal">null</span>;
  
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; maxRetries; i++) {
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">await</span> <span class="hljs-title function_">fn</span>();
    } <span class="hljs-keyword">catch</span> (error) {
      lastError = error <span class="hljs-keyword">as</span> <span class="hljs-title class_">Error</span>;
      <span class="hljs-keyword">if</span> (i &lt; maxRetries - <span class="hljs-number">1</span>) {
        <span class="hljs-keyword">await</span> <span class="hljs-title function_">delay</span>(retryInterval);
      }
    }
  }
  
  <span class="hljs-keyword">throw</span> lastError;
}

<span class="hljs-comment">/**
 * 生成唯一 ID
 */</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">generateUniqueId</span>(<span class="hljs-params"/>): <span class="hljs-built_in">string</span> {
  <span class="hljs-keyword">return</span> <span class="hljs-string">`<span class="hljs-subst">${<span class="hljs-built_in">Date</span>.now()}</span>-<span class="hljs-subst">${<span class="hljs-built_in">Math</span>.random().toString(<span class="hljs-number">36</span>).substr(<span class="hljs-number">2</span>, <span class="hljs-number">9</span>)}</span>`</span>;
}

<span class="hljs-comment">/**
 * 深度合并对象
 */</span>
<span class="hljs-keyword">function</span> deepMerge&lt;T <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Record</span>&lt;<span class="hljs-built_in">string</span>, <span class="hljs-built_in">unknown</span>&gt;&gt;(
  <span class="hljs-attr">target</span>: T,
  <span class="hljs-attr">source</span>: <span class="hljs-title class_">Partial</span>&lt;T&gt;
): T {
  <span class="hljs-keyword">const</span> result = { ...target };
  
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> key <span class="hljs-keyword">in</span> source) {
    <span class="hljs-keyword">if</span> (<span class="hljs-title class_">Object</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">hasOwnProperty</span>.<span class="hljs-title function_">call</span>(source, key)) {
      <span class="hljs-keyword">const</span> sourceValue = source[key];
      <span class="hljs-keyword">const</span> targetValue = result[key];
      
      <span class="hljs-keyword">if</span> (
        <span class="hljs-keyword">typeof</span> sourceValue === <span class="hljs-string">'object'</span> &amp;&amp;
        sourceValue !== <span class="hljs-literal">null</span> &amp;&amp;
        !<span class="hljs-title class_">Array</span>.<span class="hljs-title function_">isArray</span>(sourceValue) &amp;&amp;
        <span class="hljs-keyword">typeof</span> targetValue === <span class="hljs-string">'object'</span> &amp;&amp;
        targetValue !== <span class="hljs-literal">null</span> &amp;&amp;
        !<span class="hljs-title class_">Array</span>.<span class="hljs-title function_">isArray</span>(targetValue)
      ) {
        result[key] = <span class="hljs-title function_">deepMerge</span>(
          targetValue <span class="hljs-keyword">as</span> <span class="hljs-title class_">Record</span>&lt;<span class="hljs-built_in">string</span>, <span class="hljs-built_in">unknown</span>&gt;,
          sourceValue <span class="hljs-keyword">as</span> <span class="hljs-title class_">Record</span>&lt;<span class="hljs-built_in">string</span>, <span class="hljs-built_in">unknown</span>&gt;
        ) <span class="hljs-keyword">as</span> T[<span class="hljs-title class_">Extract</span>&lt;keyof T, <span class="hljs-built_in">string</span>&gt;];
      } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (sourceValue !== <span class="hljs-literal">undefined</span>) {
        result[key] = sourceValue <span class="hljs-keyword">as</span> T[<span class="hljs-title class_">Extract</span>&lt;keyof T, <span class="hljs-built_in">string</span>&gt;];
      }
    }
  }
  
  <span class="hljs-keyword">return</span> result;
}

<span class="hljs-comment">/**
 * 检查元素是否可见
 */</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">isElementVisible</span>(<span class="hljs-params">element: Element</span>): <span class="hljs-built_in">boolean</span> {
  <span class="hljs-keyword">if</span> (!element) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
  
  <span class="hljs-keyword">const</span> style = <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">getComputedStyle</span>(element);
  
  <span class="hljs-keyword">if</span> (style.<span class="hljs-property">display</span> === <span class="hljs-string">'none'</span>) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
  <span class="hljs-keyword">if</span> (style.<span class="hljs-property">visibility</span> === <span class="hljs-string">'hidden'</span>) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
  <span class="hljs-keyword">if</span> (style.<span class="hljs-property">opacity</span> === <span class="hljs-string">'0'</span>) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
  
  <span class="hljs-keyword">const</span> rect = element.<span class="hljs-title function_">getBoundingClientRect</span>();
  <span class="hljs-keyword">if</span> (rect.<span class="hljs-property">width</span> === <span class="hljs-number">0</span> || rect.<span class="hljs-property">height</span> === <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
  
  <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
}

<span class="hljs-comment">/**
 * 获取元素在指定坐标处
 */</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">getElementAtPoint</span>(<span class="hljs-params">x: <span class="hljs-built_in">number</span>, y: <span class="hljs-built_in">number</span></span>): <span class="hljs-title class_">Element</span> | <span class="hljs-literal">null</span> {
  <span class="hljs-keyword">try</span> {
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">elementFromPoint</span>(x, y);
  } <span class="hljs-keyword">catch</span> {
    <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
  }
}

<span class="hljs-comment">/**
 * 判断是否为包装元素（通常用于布局的空元素）
 */</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">isWrapperElement</span>(<span class="hljs-params">element: Element | <span class="hljs-literal">null</span></span>): <span class="hljs-built_in">boolean</span> {
  <span class="hljs-keyword">if</span> (!element) <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
  
  <span class="hljs-keyword">const</span> wrapperTags = [
    <span class="hljs-string">'HTML'</span>, <span class="hljs-string">'BODY'</span>, <span class="hljs-string">'DIV'</span>, <span class="hljs-string">'SECTION'</span>, <span class="hljs-string">'ARTICLE'</span>, <span class="hljs-string">'MAIN'</span>,
    <span class="hljs-string">'HEADER'</span>, <span class="hljs-string">'FOOTER'</span>, <span class="hljs-string">'NAV'</span>, <span class="hljs-string">'ASIDE'</span>, <span class="hljs-string">'SPAN'</span>
  ];
  
  <span class="hljs-keyword">const</span> tagName = element.<span class="hljs-property">tagName</span>.<span class="hljs-title function_">toUpperCase</span>();
  
  <span class="hljs-keyword">if</span> (!wrapperTags.<span class="hljs-title function_">includes</span>(tagName)) {
    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
  }
  
  <span class="hljs-comment">// 检查是否有实际内容</span>
  <span class="hljs-keyword">const</span> hasText = element.<span class="hljs-property">textContent</span>?.<span class="hljs-title function_">trim</span>().<span class="hljs-property">length</span> ?? <span class="hljs-number">0</span> &gt; <span class="hljs-number">0</span>;
  <span class="hljs-keyword">const</span> hasChildren = element.<span class="hljs-property">children</span>.<span class="hljs-property">length</span> &gt; <span class="hljs-number">0</span>;
  <span class="hljs-keyword">const</span> hasBackground = <span class="hljs-title function_">hasBackgroundContent</span>(element);
  
  <span class="hljs-comment">// 如果只是空的包装元素，认为是包装元素</span>
  <span class="hljs-keyword">if</span> (!hasText &amp;&amp; !hasBackground &amp;&amp; element === <span class="hljs-variable language_">document</span>.<span class="hljs-property">body</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
  }
  
  <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
}

<span class="hljs-comment">/**
 * 检查元素是否有背景内容
 */</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">hasBackgroundContent</span>(<span class="hljs-params">element: Element</span>): <span class="hljs-built_in">boolean</span> {
  <span class="hljs-keyword">const</span> style = <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">getComputedStyle</span>(element);
  
  <span class="hljs-comment">// 检查背景颜色（排除白色和透明）</span>
  <span class="hljs-keyword">const</span> bgColor = style.<span class="hljs-property">backgroundColor</span>;
  <span class="hljs-keyword">if</span> (bgColor &amp;&amp; bgColor !== <span class="hljs-string">'rgba(0, 0, 0, 0)'</span> &amp;&amp; bgColor !== <span class="hljs-string">'transparent'</span>) {
    <span class="hljs-comment">// 解析颜色值判断是否为白色</span>
    <span class="hljs-keyword">const</span> isWhite = <span class="hljs-title function_">isWhiteColor</span>(bgColor);
    <span class="hljs-keyword">if</span> (!isWhite) <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
  }
  
  <span class="hljs-comment">// 检查背景图片</span>
  <span class="hljs-keyword">const</span> bgImage = style.<span class="hljs-property">backgroundImage</span>;
  <span class="hljs-keyword">if</span> (bgImage &amp;&amp; bgImage !== <span class="hljs-string">'none'</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
  }
  
  <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
}

<span class="hljs-comment">/**
 * 判断颜色是否为白色
 */</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">isWhiteColor</span>(<span class="hljs-params">color: <span class="hljs-built_in">string</span></span>): <span class="hljs-built_in">boolean</span> {
  <span class="hljs-comment">// 处理 rgb/rgba 格式</span>
  <span class="hljs-keyword">const</span> rgbMatch = color.<span class="hljs-title function_">match</span>(<span class="hljs-regexp">/rgba?\((\d+),\s*(\d+),\s*(\d+)/</span>);
  <span class="hljs-keyword">if</span> (rgbMatch) {
    <span class="hljs-keyword">const</span> [, r, g, b] = rgbMatch.<span class="hljs-title function_">map</span>(<span class="hljs-title class_">Number</span>);
    <span class="hljs-comment">// 接近白色的阈值</span>
    <span class="hljs-keyword">return</span> r &gt; <span class="hljs-number">250</span> &amp;&amp; g &gt; <span class="hljs-number">250</span> &amp;&amp; b &gt; <span class="hljs-number">250</span>;
  }
  
  <span class="hljs-comment">// 处理十六进制格式</span>
  <span class="hljs-keyword">if</span> (color.<span class="hljs-title function_">startsWith</span>(<span class="hljs-string">'#'</span>)) {
    <span class="hljs-keyword">const</span> hex = color.<span class="hljs-title function_">slice</span>(<span class="hljs-number">1</span>);
    <span class="hljs-keyword">const</span> r = <span class="hljs-built_in">parseInt</span>(hex.<span class="hljs-title function_">slice</span>(<span class="hljs-number">0</span>, <span class="hljs-number">2</span>), <span class="hljs-number">16</span>);
    <span class="hljs-keyword">const</span> g = <span class="hljs-built_in">parseInt</span>(hex.<span class="hljs-title function_">slice</span>(<span class="hljs-number">2</span>, <span class="hljs-number">4</span>), <span class="hljs-number">16</span>);
    <span class="hljs-keyword">const</span> b = <span class="hljs-built_in">parseInt</span>(hex.<span class="hljs-title function_">slice</span>(<span class="hljs-number">4</span>, <span class="hljs-number">6</span>), <span class="hljs-number">16</span>);
    <span class="hljs-keyword">return</span> r &gt; <span class="hljs-number">250</span> &amp;&amp; g &gt; <span class="hljs-number">250</span> &amp;&amp; b &gt; <span class="hljs-number">250</span>;
  }
  
  <span class="hljs-keyword">return</span> color === <span class="hljs-string">'white'</span> || color === <span class="hljs-string">'#fff'</span> || color === <span class="hljs-string">'#ffffff'</span>;
}

<span class="hljs-comment">/**
 * 获取网络信息
 */</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">getNetworkInfo</span>(<span class="hljs-params"/>): <span class="hljs-title class_">NetworkInfo</span> {
  <span class="hljs-keyword">const</span> connection = (navigator <span class="hljs-keyword">as</span> <span class="hljs-title class_">Navigator</span> &amp; {
    connection?: {
      effectiveType?: <span class="hljs-built_in">string</span>;
      downlink?: <span class="hljs-built_in">number</span>;
      rtt?: <span class="hljs-built_in">number</span>;
    };
  }).<span class="hljs-property">connection</span>;
  
  <span class="hljs-keyword">return</span> {
    <span class="hljs-attr">effectiveType</span>: connection?.<span class="hljs-property">effectiveType</span>,
    <span class="hljs-attr">downlink</span>: connection?.<span class="hljs-property">downlink</span>,
    <span class="hljs-attr">rtt</span>: connection?.<span class="hljs-property">rtt</span>,
    <span class="hljs-attr">online</span>: navigator.<span class="hljs-property">onLine</span>
  };
}

<span class="hljs-comment">/**
 * 获取性能数据
 */</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">getPerformanceData</span>(<span class="hljs-params"/>): <span class="hljs-title class_">PerformanceData</span> {
  <span class="hljs-keyword">const</span> <span class="hljs-attr">performanceData</span>: <span class="hljs-title class_">PerformanceData</span> = {};
  
  <span class="hljs-comment">// 获取导航性能数据</span>
  <span class="hljs-keyword">const</span> navigation = performance.<span class="hljs-title function_">getEntriesByType</span>(<span class="hljs-string">'navigation'</span>)[<span class="hljs-number">0</span>] <span class="hljs-keyword">as</span> <span class="hljs-title class_">PerformanceNavigationTiming</span>;
  <span class="hljs-keyword">if</span> (navigation) {
    performanceData.<span class="hljs-property">domContentLoaded</span> = navigation.<span class="hljs-property">domContentLoadedEventEnd</span> - navigation.<span class="hljs-property">startTime</span>;
    performanceData.<span class="hljs-property">loadComplete</span> = navigation.<span class="hljs-property">loadEventEnd</span> - navigation.<span class="hljs-property">startTime</span>;
  }
  
  <span class="hljs-comment">// 获取绘制性能数据</span>
  <span class="hljs-keyword">const</span> paintEntries = performance.<span class="hljs-title function_">getEntriesByType</span>(<span class="hljs-string">'paint'</span>);
  paintEntries.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">entry</span> =&gt;</span> {
    <span class="hljs-keyword">if</span> (entry.<span class="hljs-property">name</span> === <span class="hljs-string">'first-contentful-paint'</span>) {
      performanceData.<span class="hljs-property">firstContentfulPaint</span> = entry.<span class="hljs-property">startTime</span>;
    }
  });
  
  <span class="hljs-comment">// 获取 LCP</span>
  <span class="hljs-keyword">try</span> {
    <span class="hljs-keyword">const</span> lcpEntries = performance.<span class="hljs-title function_">getEntriesByType</span>(<span class="hljs-string">'largest-contentful-paint'</span>);
    <span class="hljs-keyword">if</span> (lcpEntries.<span class="hljs-property">length</span> &gt; <span class="hljs-number">0</span>) {
      <span class="hljs-keyword">const</span> lastLcp = lcpEntries[lcpEntries.<span class="hljs-property">length</span> - <span class="hljs-number">1</span>] <span class="hljs-keyword">as</span> <span class="hljs-title class_">PerformanceEntry</span> &amp; { <span class="hljs-attr">startTime</span>: <span class="hljs-built_in">number</span> };
      performanceData.<span class="hljs-property">largestContentfulPaint</span> = lastLcp.<span class="hljs-property">startTime</span>;
    }
  } <span class="hljs-keyword">catch</span> {
    <span class="hljs-comment">// LCP 可能不被支持</span>
  }
  
  <span class="hljs-keyword">return</span> performanceData;
}

<span class="hljs-comment">// ==================== 采样点检测器 ====================</span>

<span class="hljs-comment">/**
 * 采样点检测器类
 */</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">SamplingDetector</span> {
  <span class="hljs-keyword">private</span> <span class="hljs-attr">config</span>: <span class="hljs-title class_">Required</span>&lt;<span class="hljs-title class_">Pick</span>&lt;<span class="hljs-title class_">WhiteScreenConfig</span>, 
    <span class="hljs-string">'samplingPoints'</span> | <span class="hljs-string">'threshold'</span> | <span class="hljs-string">'ignoreSelectors'</span> | <span class="hljs-string">'container'</span>
  &gt;&gt;;
  
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">config: Partial&lt;WhiteScreenConfig&gt; = {}</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">config</span> = {
      <span class="hljs-attr">samplingPoints</span>: config.<span class="hljs-property">samplingPoints</span> ?? <span class="hljs-number">17</span>,
      <span class="hljs-attr">threshold</span>: config.<span class="hljs-property">threshold</span> ?? <span class="hljs-number">0.95</span>,
      <span class="hljs-attr">ignoreSelectors</span>: config.<span class="hljs-property">ignoreSelectors</span> ?? [],
      <span class="hljs-attr">container</span>: config.<span class="hljs-property">container</span> ?? <span class="hljs-variable language_">document</span>.<span class="hljs-property">body</span>
    };
  }
  
  <span class="hljs-comment">/**
   * 执行采样检测
   */</span>
  <span class="hljs-title function_">detect</span>(): <span class="hljs-title class_">SamplingResult</span> {
    <span class="hljs-keyword">const</span> { samplingPoints, ignoreSelectors, container } = <span class="hljs-variable language_">this</span>.<span class="hljs-property">config</span>;
    <span class="hljs-keyword">const</span> <span class="hljs-attr">points</span>: <span class="hljs-title class_">SamplingPointDetail</span>[] = [];
    
    <span class="hljs-comment">// 获取视口尺寸</span>
    <span class="hljs-keyword">const</span> viewportWidth = <span class="hljs-variable language_">window</span>.<span class="hljs-property">innerWidth</span> || <span class="hljs-variable language_">document</span>.<span class="hljs-property">documentElement</span>.<span class="hljs-property">clientWidth</span>;
    <span class="hljs-keyword">const</span> viewportHeight = <span class="hljs-variable language_">window</span>.<span class="hljs-property">innerHeight</span> || <span class="hljs-variable language_">document</span>.<span class="hljs-property">documentElement</span>.<span class="hljs-property">clientHeight</span>;
    
    <span class="hljs-comment">// 计算采样间隔</span>
    <span class="hljs-keyword">const</span> horizontalStep = viewportWidth / (samplingPoints + <span class="hljs-number">1</span>);
    <span class="hljs-keyword">const</span> verticalStep = viewportHeight / (samplingPoints + <span class="hljs-number">1</span>);
    
    <span class="hljs-keyword">let</span> emptyPoints = <span class="hljs-number">0</span>;
    
    <span class="hljs-comment">// 生成采样点矩阵</span>
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">1</span>; i &lt;= samplingPoints; i++) {
      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> j = <span class="hljs-number">1</span>; j &lt;= samplingPoints; j++) {
        <span class="hljs-keyword">const</span> x = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">floor</span>(horizontalStep * i);
        <span class="hljs-keyword">const</span> y = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">floor</span>(verticalStep * j);
        
        <span class="hljs-keyword">const</span> pointResult = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">checkPoint</span>(x, y, ignoreSelectors);
        points.<span class="hljs-title function_">push</span>(pointResult);
        
        <span class="hljs-keyword">if</span> (pointResult.<span class="hljs-property">isEmpty</span>) {
          emptyPoints++;
        }
      }
    }
    
    <span class="hljs-comment">// 添加中心点检测（权重更高）</span>
    <span class="hljs-keyword">const</span> centerX = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">floor</span>(viewportWidth / <span class="hljs-number">2</span>);
    <span class="hljs-keyword">const</span> centerY = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">floor</span>(viewportHeight / <span class="hljs-number">2</span>);
    <span class="hljs-keyword">const</span> centerPoints = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">checkCenterRegion</span>(centerX, centerY, ignoreSelectors);
    points.<span class="hljs-title function_">push</span>(...centerPoints);
    
    centerPoints.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">point</span> =&gt;</span> {
      <span class="hljs-keyword">if</span> (point.<span class="hljs-property">isEmpty</span>) emptyPoints++;
    });
    
    <span class="hljs-keyword">const</span> totalPoints = points.<span class="hljs-property">length</span>;
    <span class="hljs-keyword">const</span> emptyRatio = totalPoints &gt; <span class="hljs-number">0</span> ? emptyPoints / totalPoints : <span class="hljs-number">1</span>;
    
    <span class="hljs-keyword">return</span> {
      totalPoints,
      emptyPoints,
      emptyRatio,
      <span class="hljs-attr">pointDetails</span>: points
    };
  }
  
  <span class="hljs-comment">/**
   * 检查单个采样点
   */</span>
  <span class="hljs-keyword">private</span> <span class="hljs-title function_">checkPoint</span>(
    <span class="hljs-attr">x</span>: <span class="hljs-built_in">number</span>,
    <span class="hljs-attr">y</span>: <span class="hljs-built_in">number</span>,
    <span class="hljs-attr">ignoreSelectors</span>: <span class="hljs-built_in">string</span>[]
  ): <span class="hljs-title class_">SamplingPointDetail</span> {
    <span class="hljs-keyword">const</span> element = <span class="hljs-title function_">getElementAtPoint</span>(x, y);
    
    <span class="hljs-keyword">const</span> <span class="hljs-attr">detail</span>: <span class="hljs-title class_">SamplingPointDetail</span> = {
      x,
      y,
      <span class="hljs-attr">tagName</span>: element?.<span class="hljs-property">tagName</span> ?? <span class="hljs-literal">null</span>,
      <span class="hljs-attr">isEmpty</span>: <span class="hljs-literal">true</span>,
      <span class="hljs-attr">className</span>: element?.<span class="hljs-property">className</span>?.<span class="hljs-title function_">toString</span>(),
      <span class="hljs-attr">id</span>: element?.<span class="hljs-property">id</span>
    };
    
    <span class="hljs-keyword">if</span> (!element) {
      <span class="hljs-keyword">return</span> detail;
    }
    
    <span class="hljs-comment">// 检查是否在忽略列表中</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">shouldIgnoreElement</span>(element, ignoreSelectors)) {
      <span class="hljs-keyword">return</span> detail;
    }
    
    <span class="hljs-comment">// 检查是否为有效内容元素</span>
    detail.<span class="hljs-property">isEmpty</span> = !<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">isContentElement</span>(element);
    
    <span class="hljs-keyword">return</span> detail;
  }
  
  <span class="hljs-comment">/**
   * 检查中心区域（九宫格）
   */</span>
  <span class="hljs-keyword">private</span> <span class="hljs-title function_">checkCenterRegion</span>(
    <span class="hljs-attr">centerX</span>: <span class="hljs-built_in">number</span>,
    <span class="hljs-attr">centerY</span>: <span class="hljs-built_in">number</span>,
    <span class="hljs-attr">ignoreSelectors</span>: <span class="hljs-built_in">string</span>[]
  ): <span class="hljs-title class_">SamplingPointDetail</span>[] {
    <span class="hljs-keyword">const</span> <span class="hljs-attr">points</span>: <span class="hljs-title class_">SamplingPointDetail</span>[] = [];
    <span class="hljs-keyword">const</span> offsets = [-<span class="hljs-number">50</span>, <span class="hljs-number">0</span>, <span class="hljs-number">50</span>];
    
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> offsetX <span class="hljs-keyword">of</span> offsets) {
      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> offsetY <span class="hljs-keyword">of</span> offsets) {
        <span class="hljs-keyword">if</span> (offsetX === <span class="hljs-number">0</span> &amp;&amp; offsetY === <span class="hljs-number">0</span>) <span class="hljs-keyword">continue</span>; <span class="hljs-comment">// 跳过正中心，已在主循环中处理</span>
        
        <span class="hljs-keyword">const</span> x = centerX + offsetX;
        <span class="hljs-keyword">const</span> y = centerY + offsetY;
        
        <span class="hljs-keyword">if</span> (x &gt; <span class="hljs-number">0</span> &amp;&amp; y &gt; <span class="hljs-number">0</span>) {
          points.<span class="hljs-title function_">push</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">checkPoint</span>(x, y, ignoreSelectors));
        }
      }
    }
    
    <span class="hljs-keyword">return</span> points;
  }
  
  <span class="hljs-comment">/**
   * 判断元素是否应被忽略
   */</span>
  <span class="hljs-keyword">private</span> <span class="hljs-title function_">shouldIgnoreElement</span>(<span class="hljs-attr">element</span>: <span class="hljs-title class_">Element</span>, <span class="hljs-attr">ignoreSelectors</span>: <span class="hljs-built_in">string</span>[]): <span class="hljs-built_in">boolean</span> {
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> selector <span class="hljs-keyword">of</span> ignoreSelectors) {
      <span class="hljs-keyword">try</span> {
        <span class="hljs-keyword">if</span> (element.<span class="hljs-title function_">matches</span>(selector) || element.<span class="hljs-title function_">closest</span>(selector)) {
          <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
        }
      } <span class="hljs-keyword">catch</span> {
        <span class="hljs-comment">// 选择器无效，忽略</span>
      }
    }
    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
  }
  
  <span class="hljs-comment">/**
   * 判断是否为有内容的元素
   */</span>
  <span class="hljs-keyword">private</span> <span class="hljs-title function_">isContentElement</span>(<span class="hljs-attr">element</span>: <span class="hljs-title class_">Element</span>): <span class="hljs-built_in">boolean</span> {
    <span class="hljs-keyword">const</span> tagName = element.<span class="hljs-property">tagName</span>.<span class="hljs-title function_">toUpperCase</span>();
    
    <span class="hljs-comment">// 明确的内容元素</span>
    <span class="hljs-keyword">const</span> contentTags = [
      <span class="hljs-string">'IMG'</span>, <span class="hljs-string">'VIDEO'</span>, <span class="hljs-string">'AUDIO'</span>, <span class="hljs-string">'CANVAS'</span>, <span class="hljs-string">'SVG'</span>, <span class="hljs-string">'IFRAME'</span>,
      <span class="hljs-string">'INPUT'</span>, <span class="hljs-string">'TEXTAREA'</span>, <span class="hljs-string">'SELECT'</span>, <span class="hljs-string">'BUTTON'</span>,
      <span class="hljs-string">'H1'</span>, <span class="hljs-string">'H2'</span>, <span class="hljs-string">'H3'</span>, <span class="hljs-string">'H4'</span>, <span class="hljs-string">'H5'</span>, <span class="hljs-string">'H6'</span>,
      <span class="hljs-string">'P'</span>, <span class="hljs-string">'A'</span>, <span class="hljs-string">'SPAN'</span>, <span class="hljs-string">'LABEL'</span>, <span class="hljs-string">'LI'</span>, <span class="hljs-string">'TD'</span>, <span class="hljs-string">'TH'</span>,
      <span class="hljs-string">'STRONG'</span>, <span class="hljs-string">'EM'</span>, <span class="hljs-string">'B'</span>, <span class="hljs-string">'I'</span>, <span class="hljs-string">'U'</span>, <span class="hljs-string">'CODE'</span>, <span class="hljs-string">'PRE'</span>
    ];
    
    <span class="hljs-keyword">if</span> (contentTags.<span class="hljs-title function_">includes</span>(tagName)) {
      <span class="hljs-keyword">return</span> <span class="hljs-title function_">isElementVisible</span>(element);
    }
    
    <span class="hljs-comment">// 检查是否有文本内容</span>
    <span class="hljs-keyword">const</span> textContent = element.<span class="hljs-property">textContent</span>?.<span class="hljs-title function_">trim</span>();
    <span class="hljs-keyword">if</span> (textContent &amp;&amp; textContent.<span class="hljs-property">length</span> &gt; <span class="hljs-number">0</span>) {
      <span class="hljs-keyword">return</span> <span class="hljs-title function_">isElementVisible</span>(element);
    }
    
    <span class="hljs-comment">// 检查是否有背景内容</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-title function_">hasBackgroundContent</span>(element)) {
      <span class="hljs-keyword">return</span> <span class="hljs-title function_">isElementVisible</span>(element);
    }
    
    <span class="hljs-comment">// 检查是否为包装元素</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-title function_">isWrapperElement</span>(element)) {
      <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    }
    
    <span class="hljs-keyword">return</span> <span class="hljs-title function_">isElementVisible</span>(element);
  }
  
  <span class="hljs-comment">/**
   * 判断是否为白屏
   */</span>
  <span class="hljs-title function_">isWhiteScreen</span>(<span class="hljs-attr">result</span>: <span class="hljs-title class_">SamplingResult</span>): <span class="hljs-built_in">boolean</span> {
    <span class="hljs-keyword">return</span> result.<span class="hljs-property">emptyRatio</span> &gt;= <span class="hljs-variable language_">this</span>.<span class="hljs-property">config</span>.<span class="hljs-property">threshold</span>;
  }
}

<span class="hljs-comment">// ==================== DOM 检测器 ====================</span>

<span class="hljs-comment">/**
 * DOM 检测器类
 */</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">DOMDetector</span> {
  <span class="hljs-keyword">private</span> <span class="hljs-attr">config</span>: <span class="hljs-title class_">Required</span>&lt;<span class="hljs-title class_">Pick</span>&lt;<span class="hljs-title class_">WhiteScreenConfig</span>, 
    <span class="hljs-string">'keyElementSelectors'</span> | <span class="hljs-string">'container'</span>
  &gt;&gt;;
  
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">config: Partial&lt;WhiteScreenConfig&gt; = {}</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">config</span> = {
      <span class="hljs-attr">keyElementSelectors</span>: config.<span class="hljs-property">keyElementSelectors</span> ?? [
        <span class="hljs-string">'#app'</span>, <span class="hljs-string">'#root'</span>, <span class="hljs-string">'.app'</span>, <span class="hljs-string">'.main-content'</span>,
        <span class="hljs-string">'main'</span>, <span class="hljs-string">'[data-page]'</span>, <span class="hljs-string">'.page-container'</span>
      ],
      <span class="hljs-attr">container</span>: config.<span class="hljs-property">container</span> ?? <span class="hljs-variable language_">document</span>.<span class="hljs-property">body</span>
    };
  }
  
  <span class="hljs-comment">/**
   * 执行 DOM 检测
   */</span>
  <span class="hljs-title function_">detect</span>(): <span class="hljs-title class_">DOMDetectionResult</span> {
    <span class="hljs-keyword">const</span> { keyElementSelectors, container } = <span class="hljs-variable language_">this</span>.<span class="hljs-property">config</span>;
    <span class="hljs-keyword">const</span> <span class="hljs-attr">elementDetails</span>: <span class="hljs-title class_">ElementDetail</span>[] = [];
    <span class="hljs-keyword">const</span> <span class="hljs-attr">missingSelectors</span>: <span class="hljs-built_in">string</span>[] = [];
    <span class="hljs-keyword">let</span> foundElements = <span class="hljs-number">0</span>;
    
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> selector <span class="hljs-keyword">of</span> keyElementSelectors) {
      <span class="hljs-keyword">const</span> result = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">checkElement</span>(selector, container);
      elementDetails.<span class="hljs-title function_">push</span>(result);
      
      <span class="hljs-keyword">if</span> (result.<span class="hljs-property">exists</span> &amp;&amp; result.<span class="hljs-property">isVisible</span>) {
        foundElements++;
      } <span class="hljs-keyword">else</span> {
        missingSelectors.<span class="hljs-title function_">push</span>(selector);
      }
    }
    
    <span class="hljs-keyword">const</span> expectedElements = keyElementSelectors.<span class="hljs-property">length</span>;
    <span class="hljs-keyword">const</span> passed = foundElements &gt; <span class="hljs-number">0</span>;
    
    <span class="hljs-keyword">return</span> {
      passed,
      foundElements,
      expectedElements,
      missingSelectors,
      elementDetails
    };
  }
  
  <span class="hljs-comment">/**
   * 检查单个元素
   */</span>
  <span class="hljs-keyword">private</span> <span class="hljs-title function_">checkElement</span>(
    <span class="hljs-attr">selector</span>: <span class="hljs-built_in">string</span>,
    <span class="hljs-attr">container</span>: <span class="hljs-title class_">HTMLElement</span> | <span class="hljs-literal">null</span>
  ): <span class="hljs-title class_">ElementDetail</span> {
    <span class="hljs-keyword">const</span> searchRoot = container ?? <span class="hljs-variable language_">document</span>;
    
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">const</span> element = searchRoot.<span class="hljs-title function_">querySelector</span>(selector);
      
      <span class="hljs-keyword">if</span> (!element) {
        <span class="hljs-keyword">return</span> {
          selector,
          <span class="hljs-attr">exists</span>: <span class="hljs-literal">false</span>,
          <span class="hljs-attr">isVisible</span>: <span class="hljs-literal">false</span>
        };
      }
      
      <span class="hljs-keyword">const</span> isVisible = <span class="hljs-title function_">isElementVisible</span>(element);
      <span class="hljs-keyword">const</span> rect = element.<span class="hljs-title function_">getBoundingClientRect</span>();
      
      <span class="hljs-keyword">return</span> {
        selector,
        <span class="hljs-attr">exists</span>: <span class="hljs-literal">true</span>,
        isVisible,
        <span class="hljs-attr">dimensions</span>: {
          <span class="hljs-attr">width</span>: rect.<span class="hljs-property">width</span>,
          <span class="hljs-attr">height</span>: rect.<span class="hljs-property">height</span>
        }
      };
    } <span class="hljs-keyword">catch</span> {
      <span class="hljs-keyword">return</span> {
        selector,
        <span class="hljs-attr">exists</span>: <span class="hljs-literal">false</span>,
        <span class="hljs-attr">isVisible</span>: <span class="hljs-literal">false</span>
      };
    }
  }
  
  <span class="hljs-comment">/**
   * 检测页面是否有有效内容
   */</span>
  <span class="hljs-title function_">hasValidContent</span>(): <span class="hljs-built_in">boolean</span> {
    <span class="hljs-keyword">const</span> body = <span class="hljs-variable language_">document</span>.<span class="hljs-property">body</span>;
    <span class="hljs-keyword">if</span> (!body) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    
    <span class="hljs-comment">// 检查 body 是否有子元素</span>
    <span class="hljs-keyword">if</span> (body.<span class="hljs-property">children</span>.<span class="hljs-property">length</span> === <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    
    <span class="hljs-comment">// 检查是否有可见的子元素</span>
    <span class="hljs-keyword">const</span> children = <span class="hljs-title class_">Array</span>.<span class="hljs-title function_">from</span>(body.<span class="hljs-property">children</span>);
    <span class="hljs-keyword">const</span> visibleChildren = children.<span class="hljs-title function_">filter</span>(<span class="hljs-function"><span class="hljs-params">child</span> =&gt;</span> <span class="hljs-title function_">isElementVisible</span>(child));
    
    <span class="hljs-keyword">if</span> (visibleChildren.<span class="hljs-property">length</span> === <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    
    <span class="hljs-comment">// 检查是否有实际内容（文本或媒体）</span>
    <span class="hljs-keyword">const</span> hasContent = visibleChildren.<span class="hljs-title function_">some</span>(<span class="hljs-function"><span class="hljs-params">child</span> =&gt;</span> {
      <span class="hljs-comment">// 检查文本内容</span>
      <span class="hljs-keyword">const</span> text = child.<span class="hljs-property">textContent</span>?.<span class="hljs-title function_">trim</span>();
      <span class="hljs-keyword">if</span> (text &amp;&amp; text.<span class="hljs-property">length</span> &gt; <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
      
      <span class="hljs-comment">// 检查媒体元素</span>
      <span class="hljs-keyword">const</span> mediaElements = child.<span class="hljs-title function_">querySelectorAll</span>(<span class="hljs-string">'img, video, canvas, svg, iframe'</span>);
      <span class="hljs-keyword">if</span> (mediaElements.<span class="hljs-property">length</span> &gt; <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
      
      <span class="hljs-comment">// 检查背景</span>
      <span class="hljs-keyword">if</span> (<span class="hljs-title function_">hasBackgroundContent</span>(child)) <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
      
      <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    });
    
    <span class="hljs-keyword">return</span> hasContent;
  }
  
  <span class="hljs-comment">/**
   * 获取页面 DOM 统计信息
   */</span>
  <span class="hljs-title function_">getDOMStats</span>(): {
    <span class="hljs-attr">totalElements</span>: <span class="hljs-built_in">number</span>;
    <span class="hljs-attr">visibleElements</span>: <span class="hljs-built_in">number</span>;
    <span class="hljs-attr">textNodes</span>: <span class="hljs-built_in">number</span>;
    <span class="hljs-attr">mediaElements</span>: <span class="hljs-built_in">number</span>;
    <span class="hljs-attr">interactiveElements</span>: <span class="hljs-built_in">number</span>;
  } {
    <span class="hljs-keyword">const</span> allElements = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelectorAll</span>(<span class="hljs-string">'*'</span>);
    <span class="hljs-keyword">let</span> visibleElements = <span class="hljs-number">0</span>;
    <span class="hljs-keyword">let</span> textNodes = <span class="hljs-number">0</span>;
    <span class="hljs-keyword">let</span> mediaElements = <span class="hljs-number">0</span>;
    <span class="hljs-keyword">let</span> interactiveElements = <span class="hljs-number">0</span>;
    
    allElements.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">element</span> =&gt;</span> {
      <span class="hljs-keyword">if</span> (<span class="hljs-title function_">isElementVisible</span>(element)) {
        visibleElements++;
      }
      
      <span class="hljs-keyword">const</span> tagName = element.<span class="hljs-property">tagName</span>.<span class="hljs-title function_">toUpperCase</span>();
      
      <span class="hljs-keyword">if</span> ([<span class="hljs-string">'IMG'</span>, <span class="hljs-string">'VIDEO'</span>, <span class="hljs-string">'AUDIO'</span>, <span class="hljs-string">'CANVAS'</span>, <span class="hljs-string">'SVG'</span>, <span class="hljs-string">'IFRAME'</span>].<span class="hljs-title function_">includes</span>(tagName)) {
        mediaElements++;
      }
      
      <span class="hljs-keyword">if</span> ([<span class="hljs-string">'INPUT'</span>, <span class="hljs-string">'BUTTON'</span>, <span class="hljs-string">'SELECT'</span>, <span class="hljs-string">'TEXTAREA'</span>, <span class="hljs-string">'A'</span>].<span class="hljs-title function_">includes</span>(tagName)) {
        interactiveElements++;
      }
    });
    
    <span class="hljs-comment">// 统计文本节点</span>
    <span class="hljs-keyword">const</span> walker = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createTreeWalker</span>(
      <span class="hljs-variable language_">document</span>.<span class="hljs-property">body</span>,
      <span class="hljs-title class_">NodeFilter</span>.<span class="hljs-property">SHOW_TEXT</span>,
      <span class="hljs-literal">null</span>
    );
    
    <span class="hljs-keyword">while</span> (walker.<span class="hljs-title function_">nextNode</span>()) {
      <span class="hljs-keyword">const</span> node = walker.<span class="hljs-property">currentNode</span>;
      <span class="hljs-keyword">if</span> (node.<span class="hljs-property">textContent</span>?.<span class="hljs-title function_">trim</span>()) {
        textNodes++;
      }
    }
    
    <span class="hljs-keyword">return</span> {
      <span class="hljs-attr">totalElements</span>: allElements.<span class="hljs-property">length</span>,
      visibleElements,
      textNodes,
      mediaElements,
      interactiveElements
    };
  }
}

<span class="hljs-comment">// ==================== MutationObserver 检测器 ====================</span>

<span class="hljs-comment">/**
 * MutationObserver 检测器类
 */</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">MutationDetector</span> {
  <span class="hljs-keyword">private</span> <span class="hljs-attr">observer</span>: <span class="hljs-title class_">MutationObserver</span> | <span class="hljs-literal">null</span> = <span class="hljs-literal">null</span>;
  <span class="hljs-keyword">private</span> <span class="hljs-attr">mutations</span>: <span class="hljs-title class_">MutationRecord</span>[] = [];
  <span class="hljs-keyword">private</span> <span class="hljs-attr">startTime</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">0</span>;
  <span class="hljs-keyword">private</span> <span class="hljs-attr">isObserving</span>: <span class="hljs-built_in">boolean</span> = <span class="hljs-literal">false</span>;
  <span class="hljs-keyword">private</span> <span class="hljs-attr">config</span>: {
    <span class="hljs-attr">timeout</span>: <span class="hljs-built_in">number</span>;
    <span class="hljs-attr">minMutations</span>: <span class="hljs-built_in">number</span>;
    <span class="hljs-attr">stableTime</span>: <span class="hljs-built_in">number</span>;
  };
  
  <span class="hljs-keyword">private</span> <span class="hljs-attr">resolvePromise</span>: (<span class="hljs-function">(<span class="hljs-params">value: <span class="hljs-built_in">boolean</span></span>) =&gt;</span> <span class="hljs-built_in">void</span>) | <span class="hljs-literal">null</span> = <span class="hljs-literal">null</span>;
  <span class="hljs-keyword">private</span> <span class="hljs-attr">timeoutId</span>: <span class="hljs-title class_">ReturnType</span>&lt;<span class="hljs-keyword">typeof</span> <span class="hljs-built_in">setTimeout</span>&gt; | <span class="hljs-literal">null</span> = <span class="hljs-literal">null</span>;
  <span class="hljs-keyword">private</span> <span class="hljs-attr">stableTimeoutId</span>: <span class="hljs-title class_">ReturnType</span>&lt;<span class="hljs-keyword">typeof</span> <span class="hljs-built_in">setTimeout</span>&gt; | <span class="hljs-literal">null</span> = <span class="hljs-literal">null</span>;
  
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">config: Partial&lt;WhiteScreenConfig&gt; = {}</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">config</span> = {
      <span class="hljs-attr">timeout</span>: config.<span class="hljs-property">timeout</span> ?? <span class="hljs-number">10000</span>,
      <span class="hljs-attr">minMutations</span>: <span class="hljs-number">10</span>,
      <span class="hljs-attr">stableTime</span>: <span class="hljs-number">1000</span>
    };
  }
  
  <span class="hljs-comment">/**
   * 开始观察
   */</span>
  <span class="hljs-title function_">observe</span>(): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">boolean</span>&gt; {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve</span>) =&gt;</span> {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">resolvePromise</span> = resolve;
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">startTime</span> = <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>();
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">mutations</span> = [];
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">isObserving</span> = <span class="hljs-literal">true</span>;
      
      <span class="hljs-comment">// 创建 MutationObserver</span>
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">observer</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">MutationObserver</span>(<span class="hljs-function">(<span class="hljs-params">mutations</span>) =&gt;</span> {
        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">handleMutations</span>(mutations);
      });
      
      <span class="hljs-comment">// 配置观察选项</span>
      <span class="hljs-keyword">const</span> <span class="hljs-attr">observerConfig</span>: <span class="hljs-title class_">MutationObserverInit</span> = {
        <span class="hljs-attr">childList</span>: <span class="hljs-literal">true</span>,
        <span class="hljs-attr">subtree</span>: <span class="hljs-literal">true</span>,
        <span class="hljs-attr">attributes</span>: <span class="hljs-literal">true</span>,
        <span class="hljs-attr">characterData</span>: <span class="hljs-literal">true</span>,
        <span class="hljs-attr">attributeOldValue</span>: <span class="hljs-literal">false</span>,
        <span class="hljs-attr">characterDataOldValue</span>: <span class="hljs-literal">false</span>
      };
      
      <span class="hljs-comment">// 开始观察</span>
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">observer</span>.<span class="hljs-title function_">observe</span>(<span class="hljs-variable language_">document</span>.<span class="hljs-property">body</span>, observerConfig);
      
      <span class="hljs-comment">// 设置超时</span>
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">timeoutId</span> = <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">complete</span>(<span class="hljs-literal">false</span>);
      }, <span class="hljs-variable language_">this</span>.<span class="hljs-property">config</span>.<span class="hljs-property">timeout</span>);
    });
  }
  
  <span class="hljs-comment">/**
   * 处理 mutation 记录
   */</span>
  <span class="hljs-keyword">private</span> <span class="hljs-title function_">handleMutations</span>(<span class="hljs-attr">mutations</span>: <span class="hljs-title class_">MutationRecord</span>[]): <span class="hljs-built_in">void</span> {
    <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-property">isObserving</span>) <span class="hljs-keyword">return</span>;
    
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">mutations</span>.<span class="hljs-title function_">push</span>(...mutations);
    
    <span class="hljs-comment">// 重置稳定计时器</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">stableTimeoutId</span>) {
      <span class="hljs-built_in">clearTimeout</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">stableTimeoutId</span>);
    }
    
    <span class="hljs-comment">// 设置新的稳定计时器</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">stableTimeoutId</span> = <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">checkStability</span>();
    }, <span class="hljs-variable language_">this</span>.<span class="hljs-property">config</span>.<span class="hljs-property">stableTime</span>);
  }
  
  <span class="hljs-comment">/**
   * 检查页面稳定性
   */</span>
  <span class="hljs-keyword">private</span> <span class="hljs-title function_">checkStability</span>(): <span class="hljs-built_in">void</span> {
    <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-property">isObserving</span>) <span class="hljs-keyword">return</span>;
    
    <span class="hljs-comment">// 检查是否有足够的 mutations（表示页面有渲染活动）</span>
    <span class="hljs-keyword">const</span> hasSufficientMutations = <span class="hljs-variable language_">this</span>.<span class="hljs-property">mutations</span>.<span class="hljs-property">length</span> &gt;= <span class="hljs-variable language_">this</span>.<span class="hljs-property">config</span>.<span class="hljs-property">minMutations</span>;
    
    <span class="hljs-comment">// 检查是否有有意义的内容变化</span>
    <span class="hljs-keyword">const</span> hasContentChanges = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">hasContentMutations</span>();
    
    <span class="hljs-keyword">if</span> (hasSufficientMutations &amp;&amp; hasContentChanges) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">complete</span>(<span class="hljs-literal">true</span>);
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>() - <span class="hljs-variable language_">this</span>.<span class="hljs-property">startTime</span> &gt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">config</span>.<span class="hljs-property">timeout</span> / <span class="hljs-number">2</span>) {
      <span class="hljs-comment">// 如果已经过了一半的超时时间，且没有足够的活动，可能是白屏</span>
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">complete</span>(<span class="hljs-literal">false</span>);
    }
  }
  
  <span class="hljs-comment">/**
   * 检查是否有内容相关的 mutations
   */</span>
  <span class="hljs-keyword">private</span> <span class="hljs-title function_">hasContentMutations</span>(): <span class="hljs-built_in">boolean</span> {
    <span class="hljs-keyword">let</span> contentMutations = <span class="hljs-number">0</span>;
    
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> mutation <span class="hljs-keyword">of</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">mutations</span>) {
      <span class="hljs-keyword">if</span> (mutation.<span class="hljs-property">type</span> === <span class="hljs-string">'childList'</span>) {
        <span class="hljs-comment">// 检查是否添加了有意义的节点</span>
        <span class="hljs-keyword">const</span> addedNodes = <span class="hljs-title class_">Array</span>.<span class="hljs-title function_">from</span>(mutation.<span class="hljs-property">addedNodes</span>);
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> node <span class="hljs-keyword">of</span> addedNodes) {
          <span class="hljs-keyword">if</span> (node.<span class="hljs-property">nodeType</span> === <span class="hljs-title class_">Node</span>.<span class="hljs-property">ELEMENT_NODE</span>) {
            <span class="hljs-keyword">const</span> element = node <span class="hljs-keyword">as</span> <span class="hljs-title class_">Element</span>;
            <span class="hljs-keyword">if</span> (<span class="hljs-title function_">isElementVisible</span>(element)) {
              contentMutations++;
            }
          } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (node.<span class="hljs-property">nodeType</span> === <span class="hljs-title class_">Node</span>.<span class="hljs-property">TEXT_NODE</span>) {
            <span class="hljs-keyword">if</span> (node.<span class="hljs-property">textContent</span>?.<span class="hljs-title function_">trim</span>()) {
              contentMutations++;
            }
          }
        }
      }
    }
    
    <span class="hljs-keyword">return</span> contentMutations &gt;= <span class="hljs-number">5</span>;
  }
  
  <span class="hljs-comment">/**
   * 完成检测
   */</span>
  <span class="hljs-keyword">private</span> <span class="hljs-title function_">complete</span>(<span class="hljs-attr">hasContent</span>: <span class="hljs-built_in">boolean</span>): <span class="hljs-built_in">void</span> {
    <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-property">isObserving</span>) <span class="hljs-keyword">return</span>;
    
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">isObserving</span> = <span class="hljs-literal">false</span>;
    
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">observer</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">observer</span>.<span class="hljs-title function_">disconnect</span>();
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">observer</span> = <span class="hljs-literal">null</span>;
    }
    
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">timeoutId</span>) {
      <span class="hljs-built_in">clearTimeout</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">timeoutId</span>);
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">timeoutId</span> = <span class="hljs-literal">null</span>;
    }
    
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">stableTimeoutId</span>) {
      <span class="hljs-built_in">clearTimeout</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">stableTimeoutId</span>);
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">stableTimeoutId</span> = <span class="hljs-literal">null</span>;
    }
    
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">resolvePromise</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">resolvePromise</span>(hasContent);
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">resolvePromise</span> = <span class="hljs-literal">null</span>;
    }
  }
  
  <span class="hljs-comment">/**
   * 获取 mutation 统计
   */</span>
  <span class="hljs-title function_">getMutationStats</span>(): {
    <span class="hljs-attr">totalMutations</span>: <span class="hljs-built_in">number</span>;
    <span class="hljs-attr">childListMutations</span>: <span class="hljs-built_in">number</span>;
    <span class="hljs-attr">attributeMutations</span>: <span class="hljs-built_in">number</span>;
    <span class="hljs-attr">characterDataMutations</span>: <span class="hljs-built_in">number</span>;
    <span class="hljs-attr">duration</span>: <span class="hljs-built_in">number</span>;
  } {
    <span class="hljs-keyword">let</span> childListMutations = <span class="hljs-number">0</span>;
    <span class="hljs-keyword">let</span> attributeMutations = <span class="hljs-number">0</span>;
    <span class="hljs-keyword">let</span> characterDataMutations = <span class="hljs-number">0</span>;
    
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> mutation <span class="hljs-keyword">of</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">mutations</span>) {
      <span class="hljs-keyword">switch</span> (mutation.<span class="hljs-property">type</span>) {
        <span class="hljs-keyword">case</span> <span class="hljs-string">'childList'</span>:
          childListMutations++;
          <span class="hljs-keyword">break</span>;
        <span class="hljs-keyword">case</span> <span class="hljs-string">'attributes'</span>:
          attributeMutations++;
          <span class="hljs-keyword">break</span>;
        <span class="hljs-keyword">case</span> <span class="hljs-string">'characterData'</span>:
          characterDataMutations++;
          <span class="hljs-keyword">break</span>;
      }
    }
    
    <span class="hljs-keyword">return</span> {
      <span class="hljs-attr">totalMutations</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">mutations</span>.<span class="hljs-property">length</span>,
      childListMutations,
      attributeMutations,
      characterDataMutations,
      <span class="hljs-attr">duration</span>: <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>() - <span class="hljs-variable language_">this</span>.<span class="hljs-property">startTime</span>
    };
  }
  
  <span class="hljs-comment">/**
   * 停止观察
   */</span>
  <span class="hljs-title function_">stop</span>(): <span class="hljs-built_in">void</span> {
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">complete</span>(<span class="hljs-literal">false</span>);
  }
}

<span class="hljs-comment">// ==================== 截图检测器 ====================</span>

<span class="hljs-comment">/**
 * 截图检测器类
 */</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">ScreenshotDetector</span> {
  <span class="hljs-keyword">private</span> <span class="hljs-attr">canvas</span>: <span class="hljs-title class_">HTMLCanvasElement</span> | <span class="hljs-literal">null</span> = <span class="hljs-literal">null</span>;
  <span class="hljs-keyword">private</span> <span class="hljs-attr">ctx</span>: <span class="hljs-title class_">CanvasRenderingContext2D</span> | <span class="hljs-literal">null</span> = <span class="hljs-literal">null</span>;
  <span class="hljs-keyword">private</span> <span class="hljs-attr">config</span>: {
    <span class="hljs-attr">sampleWidth</span>: <span class="hljs-built_in">number</span>;
    <span class="hljs-attr">sampleHeight</span>: <span class="hljs-built_in">number</span>;
    <span class="hljs-attr">whiteThreshold</span>: <span class="hljs-built_in">number</span>;
    <span class="hljs-attr">brightnessThreshold</span>: <span class="hljs-built_in">number</span>;
  };
  
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">config: Partial&lt;WhiteScreenConfig&gt; = {}</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">config</span> = {
      <span class="hljs-attr">sampleWidth</span>: <span class="hljs-number">100</span>,
      <span class="hljs-attr">sampleHeight</span>: <span class="hljs-number">100</span>,
      <span class="hljs-attr">whiteThreshold</span>: config.<span class="hljs-property">threshold</span> ?? <span class="hljs-number">0.95</span>,
      <span class="hljs-attr">brightnessThreshold</span>: <span class="hljs-number">250</span>
    };
  }
  
  <span class="hljs-comment">/**
   * 初始化 Canvas
   */</span>
  <span class="hljs-keyword">private</span> <span class="hljs-title function_">initCanvas</span>(): <span class="hljs-built_in">boolean</span> {
    <span class="hljs-keyword">try</span> {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">canvas</span> = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">'canvas'</span>);
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">canvas</span>.<span class="hljs-property">width</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">config</span>.<span class="hljs-property">sampleWidth</span>;
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">canvas</span>.<span class="hljs-property">height</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">config</span>.<span class="hljs-property">sampleHeight</span>;
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">ctx</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">canvas</span>.<span class="hljs-title function_">getContext</span>(<span class="hljs-string">'2d'</span>, { <span class="hljs-attr">willReadFrequently</span>: <span class="hljs-literal">true</span> });
      <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">ctx</span> !== <span class="hljs-literal">null</span>;
    } <span class="hljs-keyword">catch</span> {
      <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    }
  }
  
  <span class="hljs-comment">/**
   * 执行截图检测
   */</span>
  <span class="hljs-keyword">async</span> <span class="hljs-title function_">detect</span>(): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-title class_">ScreenshotResult</span>&gt; {
    <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">initCanvas</span>() || !<span class="hljs-variable language_">this</span>.<span class="hljs-property">canvas</span> || !<span class="hljs-variable language_">this</span>.<span class="hljs-property">ctx</span>) {
      <span class="hljs-keyword">return</span> {
        <span class="hljs-attr">isWhiteScreen</span>: <span class="hljs-literal">false</span>,
        <span class="hljs-attr">whitePixelRatio</span>: <span class="hljs-number">0</span>,
        <span class="hljs-attr">totalPixels</span>: <span class="hljs-number">0</span>,
        <span class="hljs-attr">whitePixels</span>: <span class="hljs-number">0</span>
      };
    }
    
    <span class="hljs-keyword">try</span> {
      <span class="hljs-comment">// 使用 html2canvas 或原生方法截图</span>
      <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">captureScreen</span>();
      
      <span class="hljs-comment">// 分析图像</span>
      <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">analyzeImage</span>();
    } <span class="hljs-keyword">catch</span> (error) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'Screenshot detection failed:'</span>, error);
      <span class="hljs-keyword">return</span> {
        <span class="hljs-attr">isWhiteScreen</span>: <span class="hljs-literal">false</span>,
        <span class="hljs-attr">whitePixelRatio</span>: <span class="hljs-number">0</span>,
        <span class="hljs-attr">totalPixels</span>: <span class="hljs-number">0</span>,
        <span class="hljs-attr">whitePixels</span>: <span class="hljs-number">0</span>
      };
    }
  }
  
  <span class="hljs-comment">/**
   * 捕获屏幕
   */</span>
  <span class="hljs-keyword">private</span> <span class="hljs-keyword">async</span> <span class="hljs-title function_">captureScreen</span>(): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">void</span>&gt; {
    <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-property">canvas</span> || !<span class="hljs-variable language_">this</span>.<span class="hljs-property">ctx</span>) <span class="hljs-keyword">return</span>;
    
    <span class="hljs-keyword">const</span> { sampleWidth, sampleHeight } = <span class="hljs-variable language_">this</span>.<span class="hljs-property">config</span>;
    
    <span class="hljs-comment">// 方案1: 使用 html2canvas（需要引入库）</span>
    <span class="hljs-comment">// 这里使用简化的方案：遍历可见元素并绘制</span>
    
    <span class="hljs-comment">// 先填充白色背景</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">ctx</span>.<span class="hljs-property">fillStyle</span> = <span class="hljs-string">'#ffffff'</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">ctx</span>.<span class="hljs-title function_">fillRect</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, sampleWidth, sampleHeight);
    
    <span class="hljs-comment">// 获取 body 的背景色</span>
    <span class="hljs-keyword">const</span> bodyStyle = <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">getComputedStyle</span>(<span class="hljs-variable language_">document</span>.<span class="hljs-property">body</span>);
    <span class="hljs-keyword">const</span> bodyBgColor = bodyStyle.<span class="hljs-property">backgroundColor</span>;
    <span class="hljs-keyword">if</span> (bodyBgColor &amp;&amp; bodyBgColor !== <span class="hljs-string">'rgba(0, 0, 0, 0)'</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">ctx</span>.<span class="hljs-property">fillStyle</span> = bodyBgColor;
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">ctx</span>.<span class="hljs-title function_">fillRect</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, sampleWidth, sampleHeight);
    }
    
    <span class="hljs-comment">// 绘制可见元素的简化表示</span>
    <span class="hljs-keyword">const</span> elements = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelectorAll</span>(<span class="hljs-string">'*'</span>);
    <span class="hljs-keyword">const</span> viewportWidth = <span class="hljs-variable language_">window</span>.<span class="hljs-property">innerWidth</span>;
    <span class="hljs-keyword">const</span> viewportHeight = <span class="hljs-variable language_">window</span>.<span class="hljs-property">innerHeight</span>;
    <span class="hljs-keyword">const</span> scaleX = sampleWidth / viewportWidth;
    <span class="hljs-keyword">const</span> scaleY = sampleHeight / viewportHeight;
    
    elements.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">element</span> =&gt;</span> {
      <span class="hljs-keyword">if</span> (!<span class="hljs-title function_">isElementVisible</span>(element)) <span class="hljs-keyword">return</span>;
      
      <span class="hljs-keyword">const</span> rect = element.<span class="hljs-title function_">getBoundingClientRect</span>();
      <span class="hljs-keyword">if</span> (rect.<span class="hljs-property">width</span> === <span class="hljs-number">0</span> || rect.<span class="hljs-property">height</span> === <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span>;
      
      <span class="hljs-comment">// 检查是否在视口内</span>
      <span class="hljs-keyword">if</span> (rect.<span class="hljs-property">right</span> &lt; <span class="hljs-number">0</span> || rect.<span class="hljs-property">bottom</span> &lt; <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span>;
      <span class="hljs-keyword">if</span> (rect.<span class="hljs-property">left</span> &gt; viewportWidth || rect.<span class="hljs-property">top</span> &gt; viewportHeight) <span class="hljs-keyword">return</span>;
      
      <span class="hljs-keyword">const</span> style = <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">getComputedStyle</span>(element);
      <span class="hljs-keyword">const</span> bgColor = style.<span class="hljs-property">backgroundColor</span>;
      
      <span class="hljs-comment">// 只绘制有背景色的元素</span>
      <span class="hljs-keyword">if</span> (bgColor &amp;&amp; bgColor !== <span class="hljs-string">'rgba(0, 0, 0, 0)'</span> &amp;&amp; bgColor !== <span class="hljs-string">'transparent'</span>) {
        <span class="hljs-keyword">const</span> x = rect.<span class="hljs-property">left</span> * scaleX;
        <span class="hljs-keyword">const</span> y = rect.<span class="hljs-property">top</span> * scaleY;
        <span class="hljs-keyword">const</span> width = rect.<span class="hljs-property">width</span> * scaleX;
        <span class="hljs-keyword">const</span> height = rect.<span class="hljs-property">height</span> * scaleY;
        
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">ctx</span>!.<span class="hljs-property">fillStyle</span> = bgColor;
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">ctx</span>!.<span class="hljs-title function_">fillRect</span>(x, y, width, height);
      }
      
      <span class="hljs-comment">// 绘制文本区域</span>
      <span class="hljs-keyword">const</span> text = element.<span class="hljs-property">textContent</span>?.<span class="hljs-title function_">trim</span>();
      <span class="hljs-keyword">if</span> (text &amp;&amp; text.<span class="hljs-property">length</span> &gt; <span class="hljs-number">0</span> &amp;&amp; element.<span class="hljs-property">children</span>.<span class="hljs-property">length</span> === <span class="hljs-number">0</span>) {
        <span class="hljs-keyword">const</span> x = rect.<span class="hljs-property">left</span> * scaleX;
        <span class="hljs-keyword">const</span> y = rect.<span class="hljs-property">top</span> * scaleY;
        <span class="hljs-keyword">const</span> width = rect.<span class="hljs-property">width</span> * scaleX;
        <span class="hljs-keyword">const</span> height = rect.<span class="hljs-property">height</span> * scaleY;
        
        <span class="hljs-comment">// 用深色表示文本区域</span>
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">ctx</span>!.<span class="hljs-property">fillStyle</span> = style.<span class="hljs-property">color</span> || <span class="hljs-string">'#000000'</span>;
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">ctx</span>!.<span class="hljs-title function_">fillRect</span>(x, y, <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">max</span>(width, <span class="hljs-number">2</span>), <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">max</span>(height, <span class="hljs-number">2</span>));
      }
    });
    
    <span class="hljs-comment">// 绘制图片元素</span>
    <span class="hljs-keyword">const</span> images = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelectorAll</span>(<span class="hljs-string">'img'</span>);
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> img <span class="hljs-keyword">of</span> images) {
      <span class="hljs-keyword">if</span> (!<span class="hljs-title function_">isElementVisible</span>(img)) <span class="hljs-keyword">continue</span>;
      
      <span class="hljs-keyword">const</span> rect = img.<span class="hljs-title function_">getBoundingClientRect</span>();
      <span class="hljs-keyword">if</span> (rect.<span class="hljs-property">width</span> === <span class="hljs-number">0</span> || rect.<span class="hljs-property">height</span> === <span class="hljs-number">0</span>) <span class="hljs-keyword">continue</span>;
      
      <span class="hljs-keyword">try</span> {
        <span class="hljs-keyword">const</span> x = rect.<span class="hljs-property">left</span> * scaleX;
        <span class="hljs-keyword">const</span> y = rect.<span class="hljs-property">top</span> * scaleY;
        <span class="hljs-keyword">const</span> width = rect.<span class="hljs-property">width</span> * scaleX;
        <span class="hljs-keyword">const</span> height = rect.<span class="hljs-property">height</span> * scaleY;
        
        <span class="hljs-comment">// 用灰色表示图片区域</span>
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">ctx</span>!.<span class="hljs-property">fillStyle</span> = <span class="hljs-string">'#808080'</span>;
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">ctx</span>!.<span class="hljs-title function_">fillRect</span>(x, y, width, height);
      } <span class="hljs-keyword">catch</span> {
        <span class="hljs-comment">// 跨域图片无法绘制</span>
      }
    }
  }
  
  <span class="hljs-comment">/**
   * 分析图像
   */</span>
  <span class="hljs-keyword">private</span> <span class="hljs-title function_">analyzeImage</span>(): <span class="hljs-title class_">ScreenshotResult</span> {
    <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-property">canvas</span> || !<span class="hljs-variable language_">this</span>.<span class="hljs-property">ctx</span>) {
      <span class="hljs-keyword">return</span> {
        <span class="hljs-attr">isWhiteScreen</span>: <span class="hljs-literal">false</span>,
        <span class="hljs-attr">whitePixelRatio</span>: <span class="hljs-number">0</span>,
        <span class="hljs-attr">totalPixels</span>: <span class="hljs-number">0</span>,
        <span class="hljs-attr">whitePixels</span>: <span class="hljs-number">0</span>
      };
    }
    
    <span class="hljs-keyword">const</span> { sampleWidth, sampleHeight, brightnessThreshold } = <span class="hljs-variable language_">this</span>.<span class="hljs-property">config</span>;
    <span class="hljs-keyword">const</span> imageData = <span class="hljs-variable language_">this</span>.<span class="hljs-property">ctx</span>.<span class="hljs-title function_">getImageData</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, sampleWidth, sampleHeight);
    <span class="hljs-keyword">const</span> data = imageData.<span class="hljs-property">data</span>;
    
    <span class="hljs-keyword">let</span> whitePixels = <span class="hljs-number">0</span>;
    <span class="hljs-keyword">let</span> blackPixels = <span class="hljs-number">0</span>;
    <span class="hljs-keyword">let</span> grayPixels = <span class="hljs-number">0</span>;
    <span class="hljs-keyword">let</span> coloredPixels = <span class="hljs-number">0</span>;
    <span class="hljs-keyword">const</span> totalPixels = (sampleWidth * sampleHeight);
    
    <span class="hljs-comment">// 遍历像素</span>
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; data.<span class="hljs-property">length</span>; i += <span class="hljs-number">4</span>) {
      <span class="hljs-keyword">const</span> r = data[i];
      <span class="hljs-keyword">const</span> g = data[i + <span class="hljs-number">1</span>];
      <span class="hljs-keyword">const</span> b = data[i + <span class="hljs-number">2</span>];
      
      <span class="hljs-comment">// 计算亮度</span>
      <span class="hljs-keyword">const</span> brightness = (r + g + b) / <span class="hljs-number">3</span>;
      
      <span class="hljs-comment">// 判断像素颜色类型</span>
      <span class="hljs-keyword">if</span> (brightness &gt;= brightnessThreshold) {
        whitePixels++;
      } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (brightness &lt;= <span class="hljs-number">10</span>) {
        blackPixels++;
      } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">abs</span>(r - g) &lt;= <span class="hljs-number">20</span> &amp;&amp; <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">abs</span>(g - b) &lt;= <span class="hljs-number">20</span> &amp;&amp; <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">abs</span>(r - b) &lt;= <span class="hljs-number">20</span>) {
        grayPixels++;
      } <span class="hljs-keyword">else</span> {
        coloredPixels++;
      }
    }
    
    <span class="hljs-keyword">const</span> whitePixelRatio = whitePixels / totalPixels;
    <span class="hljs-keyword">const</span> isWhiteScreen = whitePixelRatio &gt;= <span class="hljs-variable language_">this</span>.<span class="hljs-property">config</span>.<span class="hljs-property">whiteThreshold</span>;
    
    <span class="hljs-keyword">return</span> {
      isWhiteScreen,
      whitePixelRatio,
      totalPixels,
      whitePixels,
      <span class="hljs-attr">colorDistribution</span>: {
        <span class="hljs-attr">white</span>: whitePixels / totalPixels,
        <span class="hljs-attr">black</span>: blackPixels / totalPixels,
        <span class="hljs-attr">gray</span>: grayPixels / totalPixels,
        <span class="hljs-attr">colored</span>: coloredPixels / totalPixels
      }
    };
  }
  
  <span class="hljs-comment">/**
   * 释放资源
   */</span>
  <span class="hljs-title function_">dispose</span>(): <span class="hljs-built_in">void</span> {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">canvas</span> = <span class="hljs-literal">null</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">ctx</span> = <span class="hljs-literal">null</span>;
  }
}

<span class="hljs-comment">// ==================== 骨架屏检测器 ====================</span>

<span class="hljs-comment">/**
 * 骨架屏检测器类
 */</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">SkeletonDetector</span> {
  <span class="hljs-keyword">private</span> <span class="hljs-attr">config</span>: {
    <span class="hljs-attr">skeletonSelector</span>: <span class="hljs-built_in">string</span>;
    <span class="hljs-attr">timeout</span>: <span class="hljs-built_in">number</span>;
    <span class="hljs-attr">checkInterval</span>: <span class="hljs-built_in">number</span>;
  };
  
  <span class="hljs-keyword">private</span> <span class="hljs-attr">intervalId</span>: <span class="hljs-title class_">ReturnType</span>&lt;<span class="hljs-keyword">typeof</span> <span class="hljs-built_in">setInterval</span>&gt; | <span class="hljs-literal">null</span> = <span class="hljs-literal">null</span>;
  <span class="hljs-keyword">private</span> <span class="hljs-attr">startTime</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">0</span>;
  
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">config: Partial&lt;WhiteScreenConfig&gt; = {}</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">config</span> = {
      <span class="hljs-attr">skeletonSelector</span>: config.<span class="hljs-property">skeletonSelector</span> ?? <span class="hljs-string">'.skeleton, [data-skeleton], .loading-skeleton'</span>,
      <span class="hljs-attr">timeout</span>: config.<span class="hljs-property">timeout</span> ?? <span class="hljs-number">10000</span>,
      <span class="hljs-attr">checkInterval</span>: <span class="hljs-number">500</span>
    };
  }
  
  <span class="hljs-comment">/**
   * 检测骨架屏状态
   */</span>
  <span class="hljs-title function_">detect</span>(): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-title class_">SkeletonResult</span>&gt; {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve</span>) =&gt;</span> {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">startTime</span> = <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>();
      
      <span class="hljs-comment">// 首先检查骨架屏是否存在</span>
      <span class="hljs-keyword">const</span> skeletonExists = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">isSkeletonPresent</span>();
      
      <span class="hljs-keyword">if</span> (!skeletonExists) {
        <span class="hljs-comment">// 骨架屏不存在，可能已经加载完成或根本没有骨架屏</span>
        <span class="hljs-title function_">resolve</span>({
          <span class="hljs-attr">skeletonExists</span>: <span class="hljs-literal">false</span>,
          <span class="hljs-attr">skeletonRemoved</span>: <span class="hljs-literal">true</span>,
          <span class="hljs-attr">detectionTime</span>: <span class="hljs-number">0</span>
        });
        <span class="hljs-keyword">return</span>;
      }
      
      <span class="hljs-comment">// 开始定期检查骨架屏是否消失</span>
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">intervalId</span> = <span class="hljs-built_in">setInterval</span>(<span class="hljs-function">() =&gt;</span> {
        <span class="hljs-keyword">const</span> elapsed = <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>() - <span class="hljs-variable language_">this</span>.<span class="hljs-property">startTime</span>;
        
        <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">isSkeletonPresent</span>()) {
          <span class="hljs-comment">// 骨架屏已消失</span>
          <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">stop</span>();
          <span class="hljs-title function_">resolve</span>({
            <span class="hljs-attr">skeletonExists</span>: <span class="hljs-literal">true</span>,
            <span class="hljs-attr">skeletonRemoved</span>: <span class="hljs-literal">true</span>,
            <span class="hljs-attr">detectionTime</span>: elapsed
          });
          <span class="hljs-keyword">return</span>;
        }
        
        <span class="hljs-keyword">if</span> (elapsed &gt;= <span class="hljs-variable language_">this</span>.<span class="hljs-property">config</span>.<span class="hljs-property">timeout</span>) {
          <span class="hljs-comment">// 超时，骨架屏仍然存在</span>
          <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">stop</span>();
          <span class="hljs-title function_">resolve</span>({
            <span class="hljs-attr">skeletonExists</span>: <span class="hljs-literal">true</span>,
            <span class="hljs-attr">skeletonRemoved</span>: <span class="hljs-literal">false</span>,
            <span class="hljs-attr">detectionTime</span>: elapsed
          });
        }
      }, <span class="hljs-variable language_">this</span>.<span class="hljs-property">config</span>.<span class="hljs-property">checkInterval</span>);
    });
  }
  
  <span class="hljs-comment">/**
   * 检查骨架屏是否存在
   */</span>
  <span class="hljs-keyword">private</span> <span class="hljs-title function_">isSkeletonPresent</span>(): <span class="hljs-built_in">boolean</span> {
    <span class="hljs-keyword">const</span> { skeletonSelector } = <span class="hljs-variable language_">this</span>.<span class="hljs-property">config</span>;
    
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">const</span> selectors = skeletonSelector.<span class="hljs-title function_">split</span>(<span class="hljs-string">','</span>).<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">s</span> =&gt;</span> s.<span class="hljs-title function_">trim</span>());
      
      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> selector <span class="hljs-keyword">of</span> selectors) {
        <span class="hljs-keyword">const</span> elements = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelectorAll</span>(selector);
        
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> element <span class="hljs-keyword">of</span> elements) {
          <span class="hljs-keyword">if</span> (<span class="hljs-title function_">isElementVisible</span>(element)) {
            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
          }
        }
      }
      
      <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    } <span class="hljs-keyword">catch</span> {
      <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    }
  }
  
  <span class="hljs-comment">/**
   * 停止检测
   */</span>
  <span class="hljs-title function_">stop</span>(): <span class="hljs-built_in">void</span> {
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">intervalId</span>) {
      <span class="hljs-built_in">clearInterval</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">intervalId</span>);
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">intervalId</span> = <span class="hljs-literal">null</span>;
    }
  }
  
  <span class="hljs-comment">/**
   * 获取所有骨架屏元素
   */</span>
  <span class="hljs-title function_">getSkeletonElements</span>(): <span class="hljs-title class_">Element</span>[] {
    <span class="hljs-keyword">const</span> { skeletonSelector } = <span class="hljs-variable language_">this</span>.<span class="hljs-property">config</span>;
    <span class="hljs-keyword">const</span> <span class="hljs-attr">elements</span>: <span class="hljs-title class_">Element</span>[] = [];
    
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">const</span> selectors = skeletonSelector.<span class="hljs-title function_">split</span>(<span class="hljs-string">','</span>).<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">s</span> =&gt;</span> s.<span class="hljs-title function_">trim</span>());
      
      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> selector <span class="hljs-keyword">of</span> selectors) {
        <span class="hljs-keyword">const</span> found = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelectorAll</span>(selector);
        elements.<span class="hljs-title function_">push</span>(...<span class="hljs-title class_">Array</span>.<span class="hljs-title function_">from</span>(found));
      }
    } <span class="hljs-keyword">catch</span> {
      <span class="hljs-comment">// 选择器无效</span>
    }
    
    <span class="hljs-keyword">return</span> elements;
  }
}

<span class="hljs-comment">// ==================== Performance API 检测器 ====================</span>

<span class="hljs-comment">/**
 * Performance API 检测器类
 */</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">PerformanceDetector</span> {
  <span class="hljs-keyword">private</span> <span class="hljs-attr">config</span>: {
    <span class="hljs-attr">fcpThreshold</span>: <span class="hljs-built_in">number</span>;
    <span class="hljs-attr">lcpThreshold</span>: <span class="hljs-built_in">number</span>;
  };
  
  <span class="hljs-keyword">private</span> <span class="hljs-attr">lcpObserver</span>: <span class="hljs-title class_">PerformanceObserver</span> | <span class="hljs-literal">null</span> = <span class="hljs-literal">null</span>;
  <span class="hljs-keyword">private</span> <span class="hljs-attr">lcpValue</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">0</span>;
  
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">config: Partial&lt;WhiteScreenConfig&gt; = {}</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">config</span> = {
      <span class="hljs-attr">fcpThreshold</span>: <span class="hljs-number">3000</span>,
      <span class="hljs-attr">lcpThreshold</span>: <span class="hljs-number">4000</span>
    };
  }
  
  <span class="hljs-comment">/**
   * 初始化 LCP 观察器
   */</span>
  <span class="hljs-title function_">initLCPObserver</span>(): <span class="hljs-built_in">void</span> {
    <span class="hljs-keyword">try</span> {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">lcpObserver</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">PerformanceObserver</span>(<span class="hljs-function">(<span class="hljs-params">entryList</span>) =&gt;</span> {
        <span class="hljs-keyword">const</span> entries = entryList.<span class="hljs-title function_">getEntries</span>();
        <span class="hljs-keyword">if</span> (entries.<span class="hljs-property">length</span> &gt; <span class="hljs-number">0</span>) {
          <span class="hljs-keyword">const</span> lastEntry = entries[entries.<span class="hljs-property">length</span> - <span class="hljs-number">1</span>] <span class="hljs-keyword">as</span> <span class="hljs-title class_">PerformanceEntry</span> &amp; { <span class="hljs-attr">startTime</span>: <span class="hljs-built_in">number</span> };
          <span class="hljs-variable language_">this</span>.<span class="hljs-property">lcpValue</span> = lastEntry.<span class="hljs-property">startTime</span>;
        }
      });
      
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">lcpObserver</span>.<span class="hljs-title function_">observe</span>({ <span class="hljs-attr">type</span>: <span class="hljs-string">'largest-contentful-paint'</span>, <span class="hljs-attr">buffered</span>: <span class="hljs-literal">true</span> });
    } <span class="hljs-keyword">catch</span> {
      <span class="hljs-comment">// LCP 观察器可能不被支持</span>
    }
  }
  
  <span class="hljs-comment">/**
   * 获取性能指标
   */</span>
  <span class="hljs-title function_">getMetrics</span>(): <span class="hljs-title class_">PerformanceData</span> {
    <span class="hljs-keyword">const</span> data = <span class="hljs-title function_">getPerformanceData</span>();
    
    <span class="hljs-comment">// 添加 LCP</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">lcpValue</span> &gt; <span class="hljs-number">0</span>) {
      data.<span class="hljs-property">largestContentfulPaint</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">lcpValue</span>;
    }
    
    <span class="hljs-keyword">return</span> data;
  }
  
  <span class="hljs-comment">/**
   * 判断是否可能白屏（基于性能指标）
   */</span>
  <span class="hljs-title function_">isPotentialWhiteScreen</span>(): <span class="hljs-built_in">boolean</span> {
    <span class="hljs-keyword">const</span> metrics = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getMetrics</span>();
    
    <span class="hljs-comment">// 如果 FCP 超过阈值，可能是白屏</span>
    <span class="hljs-keyword">if</span> (metrics.<span class="hljs-property">firstContentfulPaint</span> &amp;&amp; metrics.<span class="hljs-property">firstContentfulPaint</span> &gt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">config</span>.<span class="hljs-property">fcpThreshold</span>) {
      <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    }
    
    <span class="hljs-comment">// 如果 LCP 超过阈值，可能有问题</span>
    <span class="hljs-keyword">if</span> (metrics.<span class="hljs-property">largestContentfulPaint</span> &amp;&amp; metrics.<span class="hljs-property">largestContentfulPaint</span> &gt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">config</span>.<span class="hljs-property">lcpThreshold</span>) {
      <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    }
    
    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
  }
  
  <span class="hljs-comment">/**
   * 获取资源加载统计
   */</span>
  <span class="hljs-title function_">getResourceStats</span>(): {
    <span class="hljs-attr">totalResources</span>: <span class="hljs-built_in">number</span>;
    <span class="hljs-attr">failedResources</span>: <span class="hljs-built_in">number</span>;
    <span class="hljs-attr">slowResources</span>: <span class="hljs-built_in">number</span>;
    <span class="hljs-attr">resourceDetails</span>: {
      <span class="hljs-attr">name</span>: <span class="hljs-built_in">string</span>;
      <span class="hljs-attr">type</span>: <span class="hljs-built_in">string</span>;
      <span class="hljs-attr">duration</span>: <span class="hljs-built_in">number</span>;
      <span class="hljs-attr">size</span>: <span class="hljs-built_in">number</span>;
      <span class="hljs-attr">failed</span>: <span class="hljs-built_in">boolean</span>;
    }[];
  } {
    <span class="hljs-keyword">const</span> resources = performance.<span class="hljs-title function_">getEntriesByType</span>(<span class="hljs-string">'resource'</span>) <span class="hljs-keyword">as</span> <span class="hljs-title class_">PerformanceResourceTiming</span>[];
    <span class="hljs-keyword">const</span> <span class="hljs-attr">resourceDetails</span>: {
      <span class="hljs-attr">name</span>: <span class="hljs-built_in">string</span>;
      <span class="hljs-attr">type</span>: <span class="hljs-built_in">string</span>;
      <span class="hljs-attr">duration</span>: <span class="hljs-built_in">number</span>;
      <span class="hljs-attr">size</span>: <span class="hljs-built_in">number</span>;
      <span class="hljs-attr">failed</span>: <span class="hljs-built_in">boolean</span>;
    }[] = [];
    
    <span class="hljs-keyword">let</span> failedResources = <span class="hljs-number">0</span>;
    <span class="hljs-keyword">let</span> slowResources = <span class="hljs-number">0</span>;
    
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> resource <span class="hljs-keyword">of</span> resources) {
      <span class="hljs-keyword">const</span> failed = resource.<span class="hljs-property">transferSize</span> === <span class="hljs-number">0</span> &amp;&amp; resource.<span class="hljs-property">decodedBodySize</span> === <span class="hljs-number">0</span>;
      <span class="hljs-keyword">const</span> slow = resource.<span class="hljs-property">duration</span> &gt; <span class="hljs-number">2000</span>;
      
      <span class="hljs-keyword">if</span> (failed) failedResources++;
      <span class="hljs-keyword">if</span> (slow) slowResources++;
      
      resourceDetails.<span class="hljs-title function_">push</span>({
        <span class="hljs-attr">name</span>: resource.<span class="hljs-property">name</span>,
        <span class="hljs-attr">type</span>: resource.<span class="hljs-property">initiatorType</span>,
        <span class="hljs-attr">duration</span>: resource.<span class="hljs-property">duration</span>,
        <span class="hljs-attr">size</span>: resource.<span class="hljs-property">transferSize</span> || <span class="hljs-number">0</span>,
        failed
      });
    }
    
    <span class="hljs-keyword">return</span> {
      <span class="hljs-attr">totalResources</span>: resources.<span class="hljs-property">length</span>,
      failedResources,
      slowResources,
      resourceDetails
    };
  }
  
  <span class="hljs-comment">/**
   * 停止观察
   */</span>
  <span class="hljs-title function_">stop</span>(): <span class="hljs-built_in">void</span> {
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">lcpObserver</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">lcpObserver</span>.<span class="hljs-title function_">disconnect</span>();
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">lcpObserver</span> = <span class="hljs-literal">null</span>;
    }
  }
}

<span class="hljs-comment">// ==================== 错误监听器 ====================</span>

<span class="hljs-comment">/**
 * 错误监听器类
 */</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">ErrorMonitor</span> {
  <span class="hljs-keyword">private</span> <span class="hljs-attr">errors</span>: <span class="hljs-title class_">ErrorInfo</span>[] = [];
  <span class="hljs-keyword">private</span> <span class="hljs-attr">maxErrors</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">50</span>;
  <span class="hljs-keyword">private</span> <span class="hljs-attr">listeners</span>: {
    <span class="hljs-attr">error</span>: <span class="hljs-function">(<span class="hljs-params">event: ErrorEvent</span>) =&gt;</span> <span class="hljs-built_in">void</span>;
    <span class="hljs-attr">unhandledrejection</span>: <span class="hljs-function">(<span class="hljs-params">event: PromiseRejectionEvent</span>) =&gt;</span> <span class="hljs-built_in">void</span>;
  };
  
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">listeners</span> = {
      <span class="hljs-attr">error</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">handleError</span>.<span class="hljs-title function_">bind</span>(<span class="hljs-variable language_">this</span>),
      <span class="hljs-attr">unhandledrejection</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">handleUnhandledRejection</span>.<span class="hljs-title function_">bind</span>(<span class="hljs-variable language_">this</span>)
    };
  }
  
  <span class="hljs-comment">/**
   * 开始监听
   */</span>
  <span class="hljs-title function_">start</span>(): <span class="hljs-built_in">void</span> {
    <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'error'</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">listeners</span>.<span class="hljs-property">error</span>, <span class="hljs-literal">true</span>);
    <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'unhandledrejection'</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">listeners</span>.<span class="hljs-property">unhandledrejection</span>);
  }
  
  <span class="hljs-comment">/**
   * 停止监听
   */</span>
  <span class="hljs-title function_">stop</span>(): <span class="hljs-built_in">void</span> {
    <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">removeEventListener</span>(<span class="hljs-string">'error'</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">listeners</span>.<span class="hljs-property">error</span>, <span class="hljs-literal">true</span>);
    <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">removeEventListener</span>(<span class="hljs-string">'unhandledrejection'</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">listeners</span>.<span class="hljs-property">unhandledrejection</span>);
  }
  
  <span class="hljs-comment">/**
   * 处理错误事件
   */</span>
  <span class="hljs-keyword">private</span> <span class="hljs-title function_">handleError</span>(<span class="hljs-attr">event</span>: <span class="hljs-title class_">ErrorEvent</span>): <span class="hljs-built_in">void</span> {
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">errors</span>.<span class="hljs-property">length</span> &gt;= <span class="hljs-variable language_">this</span>.<span class="hljs-property">maxErrors</span>) <span class="hljs-keyword">return</span>;
    
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">errors</span>.<span class="hljs-title function_">push</span>({
      <span class="hljs-attr">message</span>: event.<span class="hljs-property">message</span> || <span class="hljs-string">'Unknown error'</span>,
      <span class="hljs-attr">stack</span>: event.<span class="hljs-property">error</span>?.<span class="hljs-property">stack</span>,
      <span class="hljs-attr">type</span>: <span class="hljs-string">'error'</span>
    });
  }
  
  <span class="hljs-comment">/**
   * 处理未处理的 Promise 拒绝
   */</span>
  <span class="hljs-keyword">private</span> <span class="hljs-title function_">handleUnhandledRejection</span>(<span class="hljs-attr">event</span>: <span class="hljs-title class_">PromiseRejectionEvent</span>): <span class="hljs-built_in">void</span> {
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">errors</span>.<span class="hljs-property">length</span> &gt;= <span class="hljs-variable language_">this</span>.<span class="hljs-property">maxErrors</span>) <span class="hljs-keyword">return</span>;
    
    <span class="hljs-keyword">let</span> message = <span class="hljs-string">'Unhandled Promise rejection'</span>;
    <span class="hljs-keyword">let</span> <span class="hljs-attr">stack</span>: <span class="hljs-built_in">string</span> | <span class="hljs-literal">undefined</span>;
    
    <span class="hljs-keyword">if</span> (event.<span class="hljs-property">reason</span> <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">Error</span>) {
      message = event.<span class="hljs-property">reason</span>.<span class="hljs-property">message</span>;
      stack = event.<span class="hljs-property">reason</span>.<span class="hljs-property">stack</span>;
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> event.<span class="hljs-property">reason</span> === <span class="hljs-string">'string'</span>) {
      message = event.<span class="hljs-property">reason</span>;
    }
    
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">errors</span>.<span class="hljs-title function_">push</span>({
      message,
      stack,
      <span class="hljs-attr">type</span>: <span class="hljs-string">'unhandledrejection'</span>
    });
  }
  
  <span class="hljs-comment">/**
   * 获取所有错误
   */</span>
  <span class="hljs-title function_">getErrors</span>(): <span class="hljs-title class_">ErrorInfo</span>[] {
    <span class="hljs-keyword">return</span> [...<span class="hljs-variable language_">this</span>.<span class="hljs-property">errors</span>];
  }
  
  <span class="hljs-comment">/**
   * 判断是否有关键错误
   */</span>
  <span class="hljs-title function_">hasCriticalErrors</span>(): <span class="hljs-built_in">boolean</span> {
    <span class="hljs-comment">// 检查是否有可能导致白屏的错误</span>
    <span class="hljs-keyword">const</span> criticalPatterns = [
      <span class="hljs-regexp">/chunk.*failed/i</span>,
      <span class="hljs-regexp">/loading.*chunk/i</span>,
      <span class="hljs-regexp">/script.*error/i</span>,
      <span class="hljs-regexp">/syntaxerror/i</span>,
      <span class="hljs-regexp">/referenceerror/i</span>,
      <span class="hljs-regexp">/cannot read/i</span>,
      <span class="hljs-regexp">/is not defined/i</span>,
      <span class="hljs-regexp">/unexpected token/i</span>
    ];
    
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> error <span class="hljs-keyword">of</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">errors</span>) {
      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> pattern <span class="hljs-keyword">of</span> criticalPatterns) {
        <span class="hljs-keyword">if</span> (pattern.<span class="hljs-title function_">test</span>(error.<span class="hljs-property">message</span>)) {
          <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
        }
      }
    }
    
    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
  }
  
  <span class="hljs-comment">/**
   * 清除错误
   */</span>
  <span class="hljs-title function_">clear</span>(): <span class="hljs-built_in">void</span> {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">errors</span> = [];
  }
}

<span class="hljs-comment">// ==================== 数据上报器 ====================</span>

<span class="hljs-comment">/**
 * 数据上报器类
 */</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Reporter</span> {
  <span class="hljs-keyword">private</span> <span class="hljs-attr">config</span>: {
    endpoint?: <span class="hljs-built_in">string</span>;
    <span class="hljs-attr">enableConsole</span>: <span class="hljs-built_in">boolean</span>;
    <span class="hljs-attr">enableBeacon</span>: <span class="hljs-built_in">boolean</span>;
    <span class="hljs-attr">sampleRate</span>: <span class="hljs-built_in">number</span>;
    customHeaders?: <span class="hljs-title class_">Record</span>&lt;<span class="hljs-built_in">string</span>, <span class="hljs-built_in">string</span>&gt;;
  };
  
  <span class="hljs-keyword">private</span> <span class="hljs-attr">queue</span>: <span class="hljs-title class_">WhiteScreenReport</span>[] = [];
  <span class="hljs-keyword">private</span> <span class="hljs-attr">maxQueueSize</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">10</span>;
  <span class="hljs-keyword">private</span> <span class="hljs-attr">isFlushing</span>: <span class="hljs-built_in">boolean</span> = <span class="hljs-literal">false</span>;
  
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">config: {
    endpoint?: <span class="hljs-built_in">string</span>;
    enableConsole?: <span class="hljs-built_in">boolean</span>;
    enableBeacon?: <span class="hljs-built_in">boolean</span>;
    sampleRate?: <span class="hljs-built_in">number</span>;
    customHeaders?: Record&lt;<span class="hljs-built_in">string</span>, <span class="hljs-built_in">string</span>&gt;;
  } = {}</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">config</span> = {
      <span class="hljs-attr">endpoint</span>: config.<span class="hljs-property">endpoint</span>,
      <span class="hljs-attr">enableConsole</span>: config.<span class="hljs-property">enableConsole</span> ?? <span class="hljs-literal">true</span>,
      <span class="hljs-attr">enableBeacon</span>: config.<span class="hljs-property">enableBeacon</span> ?? <span class="hljs-literal">true</span>,
      <span class="hljs-attr">sampleRate</span>: config.<span class="hljs-property">sampleRate</span> ?? <span class="hljs-number">1</span>,
      <span class="hljs-attr">customHeaders</span>: config.<span class="hljs-property">customHeaders</span>
    };
    
    <span class="hljs-comment">// 页面卸载时发送队列中的数据</span>
    <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'beforeunload'</span>, <span class="hljs-function">() =&gt;</span> {
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">flush</span>();
    });
    
    <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'pagehide'</span>, <span class="hljs-function">() =&gt;</span> {
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">flush</span>();
    });
  }
  
  <span class="hljs-comment">/**
   * 上报数据
   */</span>
  <span class="hljs-title function_">report</span>(<span class="hljs-attr">data</span>: <span class="hljs-title class_">WhiteScreenReport</span>): <span class="hljs-built_in">void</span> {
    <span class="hljs-comment">// 采样</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() &gt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">config</span>.<span class="hljs-property">sampleRate</span>) {
      <span class="hljs-keyword">return</span>;
    }
    
    <span class="hljs-comment">// 控制台输出</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">config</span>.<span class="hljs-property">enableConsole</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">logToConsole</span>(data);
    }
    
    <span class="hljs-comment">// 加入队列</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">queue</span>.<span class="hljs-title function_">push</span>(data);
    
    <span class="hljs-comment">// 队列满了就发送</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">queue</span>.<span class="hljs-property">length</span> &gt;= <span class="hljs-variable language_">this</span>.<span class="hljs-property">maxQueueSize</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">flush</span>();
    }
    
    <span class="hljs-comment">// 也可以立即发送（针对白屏这种重要事件）</span>
    <span class="hljs-keyword">if</span> (data.<span class="hljs-property">isWhiteScreen</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">flush</span>();
    }
  }
  
  <span class="hljs-comment">/**
   * 发送队列中的数据
   */</span>
  <span class="hljs-title function_">flush</span>(): <span class="hljs-built_in">void</span> {
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">isFlushing</span> || <span class="hljs-variable language_">this</span>.<span class="hljs-property">queue</span>.<span class="hljs-property">length</span> === <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span>;
    
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">isFlushing</span> = <span class="hljs-literal">true</span>;
    <span class="hljs-keyword">const</span> dataToSend = [...<span class="hljs-variable language_">this</span>.<span class="hljs-property">queue</span>];
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">queue</span> = [];
    
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">config</span>.<span class="hljs-property">endpoint</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">sendData</span>(dataToSend);
    }
    
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">isFlushing</span> = <span class="hljs-literal">false</span>;
  }
  
  <span class="hljs-comment">/**
   * 发送数据
   */</span>
  <span class="hljs-keyword">private</span> <span class="hljs-title function_">sendData</span>(<span class="hljs-attr">data</span>: <span class="hljs-title class_">WhiteScreenReport</span>[]): <span class="hljs-built_in">void</span> {
    <span class="hljs-keyword">const</span> payload = <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(data);
    
    <span class="hljs-comment">// 优先使用 Beacon API</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">config</span>.<span class="hljs-property">enableBeacon</span> &amp;&amp; navigator.<span class="hljs-property">sendBeacon</span>) {
      <span class="hljs-keyword">try</span> {
        <span class="hljs-keyword">const</span> blob = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Blob</span>([payload], { <span class="hljs-attr">type</span>: <span class="hljs-string">'application/json'</span> });
        <span class="hljs-keyword">const</span> success = navigator.<span class="hljs-title function_">sendBeacon</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">config</span>.<span class="hljs-property">endpoint</span>!, blob);
        <span class="hljs-keyword">if</span> (success) <span class="hljs-keyword">return</span>;
      } <span class="hljs-keyword">catch</span> {
        <span class="hljs-comment">// Beacon 失败，降级到 fetch</span>
      }
    }
    
    <span class="hljs-comment">// 降级使用 fetch</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">sendWithFetch</span>(payload);
  }
  
  <span class="hljs-comment">/**
   * 使用 fetch 发送
   */</span>
  <span class="hljs-keyword">private</span> <span class="hljs-title function_">sendWithFetch</span>(<span class="hljs-attr">payload</span>: <span class="hljs-built_in">string</span>): <span class="hljs-built_in">void</span> {
    <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-property">config</span>.<span class="hljs-property">endpoint</span>) <span class="hljs-keyword">return</span>;
    
    <span class="hljs-keyword">const</span> <span class="hljs-attr">headers</span>: <span class="hljs-title class_">Record</span>&lt;<span class="hljs-built_in">string</span>, <span class="hljs-built_in">string</span>&gt; = {
      <span class="hljs-string">'Content-Type'</span>: <span class="hljs-string">'application/json'</span>,
      ...<span class="hljs-variable language_">this</span>.<span class="hljs-property">config</span>.<span class="hljs-property">customHeaders</span>
    };
    
    <span class="hljs-title function_">fetch</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">config</span>.<span class="hljs-property">endpoint</span>, {
      <span class="hljs-attr">method</span>: <span class="hljs-string">'POST'</span>,
      headers,
      <span class="hljs-attr">body</span>: payload,
      <span class="hljs-attr">keepalive</span>: <span class="hljs-literal">true</span>
    }).<span class="hljs-keyword">catch</span>(<span class="hljs-function">() =&gt;</span> {
      <span class="hljs-comment">// 静默失败</span>
    });
  }
  
  <span class="hljs-comment">/**
   * 控制台输出
   */</span>
  <span class="hljs-keyword">private</span> <span class="hljs-title function_">logToConsole</span>(<span class="hljs-attr">data</span>: <span class="hljs-title class_">WhiteScreenReport</span>): <span class="hljs-built_in">void</span> {
    <span class="hljs-keyword">const</span> prefix = <span class="hljs-string">'[WhiteScreen]'</span>;
    
    <span class="hljs-keyword">if</span> (data.<span class="hljs-property">isWhiteScreen</span>) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">warn</span>(
        <span class="hljs-string">`<span class="hljs-subst">${prefix}</span> 检测到白屏！`</span>,
        <span class="hljs-string">'\n方法:'</span>, data.<span class="hljs-property">detectionMethod</span>,
        <span class="hljs-string">'\nURL:'</span>, data.<span class="hljs-property">url</span>,
        <span class="hljs-string">'\n时间:'</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>(data.<span class="hljs-property">timestamp</span>).<span class="hljs-title function_">toISOString</span>(),
        <span class="hljs-string">'\n详情:'</span>, data
      );
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(
        <span class="hljs-string">`<span class="hljs-subst">${prefix}</span> 页面正常`</span>,
        <span class="hljs-string">'\n方法:'</span>, data.<span class="hljs-property">detectionMethod</span>,
        <span class="hljs-string">'\n耗时:'</span>, <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>() - data.<span class="hljs-property">timestamp</span>, <span class="hljs-string">'ms'</span>
      );
    }
  }
  
  <span class="hljs-comment">/**
   * 设置上报端点
   */</span>
  <span class="hljs-title function_">setEndpoint</span>(<span class="hljs-attr">endpoint</span>: <span class="hljs-built_in">string</span>): <span class="hljs-built_in">void</span> {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">config</span>.<span class="hljs-property">endpoint</span> = endpoint;
  }
  
  <span class="hljs-comment">/**
   * 设置采样率
   */</span>
  <span class="hljs-title function_">setSampleRate</span>(<span class="hljs-attr">rate</span>: <span class="hljs-built_in">number</span>): <span class="hljs-built_in">void</span> {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">config</span>.<span class="hljs-property">sampleRate</span> = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">max</span>(<span class="hljs-number">0</span>, <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">min</span>(<span class="hljs-number">1</span>, rate));
  }
}

<span class="hljs-comment">// ==================== 主 SDK 类 ====================</span>

<span class="hljs-comment">/**
 * 白屏检测 SDK 主类
 */</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">WhiteScreenSDK</span> {
  <span class="hljs-keyword">private</span> <span class="hljs-attr">config</span>: <span class="hljs-title class_">Required</span>&lt;<span class="hljs-title class_">WhiteScreenConfig</span>&gt;;
  <span class="hljs-keyword">private</span> <span class="hljs-attr">samplingDetector</span>: <span class="hljs-title class_">SamplingDetector</span>;
  <span class="hljs-keyword">private</span> <span class="hljs-attr">domDetector</span>: <span class="hljs-title class_">DOMDetector</span>;
  <span class="hljs-keyword">private</span> <span class="hljs-attr">mutationDetector</span>: <span class="hljs-title class_">MutationDetector</span>;
  <span class="hljs-keyword">private</span> <span class="hljs-attr">screenshotDetector</span>: <span class="hljs-title class_">ScreenshotDetector</span>;
  <span class="hljs-keyword">private</span> <span class="hljs-attr">skeletonDetector</span>: <span class="hljs-title class_">SkeletonDetector</span>;
  <span class="hljs-keyword">private</span> <span class="hljs-attr">performanceDetector</span>: <span class="hljs-title class_">PerformanceDetector</span>;
  <span class="hljs-keyword">private</span> <span class="hljs-attr">errorMonitor</span>: <span class="hljs-title class_">ErrorMonitor</span>;
  <span class="hljs-keyword">private</span> <span class="hljs-attr">reporter</span>: <span class="hljs-title class_">Reporter</span>;
  
  <span class="hljs-keyword">private</span> <span class="hljs-attr">isInitialized</span>: <span class="hljs-built_in">boolean</span> = <span class="hljs-literal">false</span>;
  <span class="hljs-keyword">private</span> <span class="hljs-attr">isDetecting</span>: <span class="hljs-built_in">boolean</span> = <span class="hljs-literal">false</span>;
  <span class="hljs-keyword">private</span> <span class="hljs-attr">detectionCount</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">0</span>;
  <span class="hljs-keyword">private</span> <span class="hljs-attr">lastDetectionTime</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">0</span>;
  
  <span class="hljs-comment">// 默认配置</span>
  <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-attr">defaultConfig</span>: <span class="hljs-title class_">Required</span>&lt;<span class="hljs-title class_">WhiteScreenConfig</span>&gt; = {
    <span class="hljs-attr">samplingPoints</span>: <span class="hljs-number">17</span>,
    <span class="hljs-attr">delay</span>: <span class="hljs-number">1000</span>,
    <span class="hljs-attr">timeout</span>: <span class="hljs-number">10000</span>,
    <span class="hljs-attr">threshold</span>: <span class="hljs-number">0.95</span>,
    <span class="hljs-attr">enableDOMDetection</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-attr">enableSamplingDetection</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-attr">enableMutationDetection</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-attr">enableScreenshotDetection</span>: <span class="hljs-literal">false</span>,
    <span class="hljs-attr">enableSkeletonDetection</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-attr">skeletonSelector</span>: <span class="hljs-string">'.skeleton, [data-skeleton], .loading-skeleton'</span>,
    <span class="hljs-attr">keyElementSelectors</span>: [<span class="hljs-string">'#app'</span>, <span class="hljs-string">'#root'</span>, <span class="hljs-string">'.app'</span>, <span class="hljs-string">'main'</span>],
    <span class="hljs-attr">ignoreSelectors</span>: [<span class="hljs-string">'script'</span>, <span class="hljs-string">'style'</span>, <span class="hljs-string">'link'</span>, <span class="hljs-string">'meta'</span>],
    <span class="hljs-attr">container</span>: <span class="hljs-literal">null</span>,
    <span class="hljs-attr">onReport</span>: <span class="hljs-function">() =&gt;</span> {},
    <span class="hljs-attr">onDetectionComplete</span>: <span class="hljs-function">() =&gt;</span> {},
    <span class="hljs-attr">enableInDev</span>: <span class="hljs-literal">false</span>,
    <span class="hljs-attr">maxRetries</span>: <span class="hljs-number">3</span>,
    <span class="hljs-attr">retryInterval</span>: <span class="hljs-number">1000</span>,
    <span class="hljs-attr">customDetector</span>: <span class="hljs-literal">undefined</span> <span class="hljs-keyword">as</span> <span class="hljs-built_in">unknown</span> <span class="hljs-keyword">as</span> () =&gt; <span class="hljs-built_in">boolean</span>
  };
  
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">config: Partial&lt;WhiteScreenConfig&gt; = {}</span>) {
    <span class="hljs-comment">// 合并配置</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">config</span> = <span class="hljs-title function_">deepMerge</span>(<span class="hljs-title class_">WhiteScreenSDK</span>.<span class="hljs-property">defaultConfig</span>, config);
    
    <span class="hljs-comment">// 初始化各个检测器</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">samplingDetector</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">SamplingDetector</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">config</span>);
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">domDetector</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">DOMDetector</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">config</span>);
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">mutationDetector</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">MutationDetector</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">config</span>);
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">screenshotDetector</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ScreenshotDetector</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">config</span>);
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">skeletonDetector</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">SkeletonDetector</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">config</span>);
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">performanceDetector</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">PerformanceDetector</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">config</span>);
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">errorMonitor</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ErrorMonitor</span>();
    
    <span class="hljs-comment">// 初始化上报器</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">reporter</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Reporter</span>({
      <span class="hljs-attr">enableConsole</span>: <span class="hljs-literal">true</span>,
      <span class="hljs-attr">enableBeacon</span>: <span class="hljs-literal">true</span>
    });
  }
  
  <span class="hljs-comment">/**
   * 初始化 SDK
   */</span>
  <span class="hljs-title function_">init</span>(): <span class="hljs-title class_">WhiteScreenSDK</span> {
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">isInitialized</span>) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">warn</span>(<span class="hljs-string">'[WhiteScreenSDK] Already initialized'</span>);
      <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>;
    }
    
    <span class="hljs-comment">// 检查是否在开发环境</span>
    <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-property">config</span>.<span class="hljs-property">enableInDev</span> &amp;&amp; <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">isDevelopment</span>()) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'[WhiteScreenSDK] Disabled in development environment'</span>);
      <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>;
    }
    
    <span class="hljs-comment">// 开始错误监听</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">errorMonitor</span>.<span class="hljs-title function_">start</span>();
    
    <span class="hljs-comment">// 初始化性能检测器</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">performanceDetector</span>.<span class="hljs-title function_">initLCPObserver</span>();
    
    <span class="hljs-comment">// 在页面加载完成后开始检测</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">document</span>.<span class="hljs-property">readyState</span> === <span class="hljs-string">'complete'</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">scheduleDetection</span>();
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'load'</span>, <span class="hljs-function">() =&gt;</span> {
        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">scheduleDetection</span>();
      });
    }
    
    <span class="hljs-comment">// 监听页面可见性变化</span>
    <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'visibilitychange'</span>, <span class="hljs-function">() =&gt;</span> {
      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">document</span>.<span class="hljs-property">visibilityState</span> === <span class="hljs-string">'visible'</span> &amp;&amp; !<span class="hljs-variable language_">this</span>.<span class="hljs-property">isDetecting</span>) {
        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">scheduleDetection</span>();
      }
    });
    
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">isInitialized</span> = <span class="hljs-literal">true</span>;
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'[WhiteScreenSDK] Initialized'</span>);
    
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>;
  }
  
  <span class="hljs-comment">/**
   * 判断是否为开发环境
   */</span>
  <span class="hljs-keyword">private</span> <span class="hljs-title function_">isDevelopment</span>(): <span class="hljs-built_in">boolean</span> {
    <span class="hljs-keyword">return</span> (
      <span class="hljs-variable language_">window</span>.<span class="hljs-property">location</span>.<span class="hljs-property">hostname</span> === <span class="hljs-string">'localhost'</span> ||
      <span class="hljs-variable language_">window</span>.<span class="hljs-property">location</span>.<span class="hljs-property">hostname</span> === <span class="hljs-string">'127.0.0.1'</span> ||
      <span class="hljs-variable language_">window</span>.<span class="hljs-property">location</span>.<span class="hljs-property">hostname</span>.<span class="hljs-title function_">includes</span>(<span class="hljs-string">'.local'</span>) ||
      <span class="hljs-variable language_">window</span>.<span class="hljs-property">location</span>.<span class="hljs-property">port</span> !== <span class="hljs-string">''</span>
    );
  }
  
  <span class="hljs-comment">/**
   * 调度检测
   */</span>
  <span class="hljs-keyword">private</span> <span class="hljs-title function_">scheduleDetection</span>(): <span class="hljs-built_in">void</span> {
    <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">detect</span>();
    }, <span class="hljs-variable language_">this</span>.<span class="hljs-property">config</span>.<span class="hljs-property">delay</span>);
  }
  
  <span class="hljs-comment">/**
   * 执行检测
   */</span>
  <span class="hljs-keyword">async</span> <span class="hljs-title function_">detect</span>(): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-title class_">DetectionResult</span>&gt; {
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">isDetecting</span>) {
      <span class="hljs-keyword">return</span> {
        <span class="hljs-attr">isWhiteScreen</span>: <span class="hljs-literal">false</span>,
        <span class="hljs-attr">confidence</span>: <span class="hljs-number">0</span>,
        <span class="hljs-attr">methods</span>: [],
        <span class="hljs-attr">methodResults</span>: <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>(),
        <span class="hljs-attr">basis</span>: <span class="hljs-string">'Already detecting'</span>
      };
    }
    
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">isDetecting</span> = <span class="hljs-literal">true</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">detectionCount</span>++;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">lastDetectionTime</span> = <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>();
    
    <span class="hljs-keyword">const</span> methodResults = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>&lt;<span class="hljs-title class_">DetectionMethod</span>, <span class="hljs-built_in">boolean</span>&gt;();
    <span class="hljs-keyword">const</span> <span class="hljs-attr">usedMethods</span>: <span class="hljs-title class_">DetectionMethod</span>[] = [];
    
    <span class="hljs-keyword">try</span> {
      <span class="hljs-comment">// 执行各种检测方法</span>
      
      <span class="hljs-comment">// 1. 采样点检测</span>
      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">config</span>.<span class="hljs-property">enableSamplingDetection</span>) {
        <span class="hljs-keyword">const</span> samplingResult = <span class="hljs-variable language_">this</span>.<span class="hljs-property">samplingDetector</span>.<span class="hljs-title function_">detect</span>();
        <span class="hljs-keyword">const</span> isWhite = <span class="hljs-variable language_">this</span>.<span class="hljs-property">samplingDetector</span>.<span class="hljs-title function_">isWhiteScreen</span>(samplingResult);
        methodResults.<span class="hljs-title function_">set</span>(<span class="hljs-title class_">DetectionMethod</span>.<span class="hljs-property">SAMPLING</span>, isWhite);
        usedMethods.<span class="hljs-title function_">push</span>(<span class="hljs-title class_">DetectionMethod</span>.<span class="hljs-property">SAMPLING</span>);
      }
      
      <span class="hljs-comment">// 2. DOM 检测</span>
      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">config</span>.<span class="hljs-property">enableDOMDetection</span>) {
        <span class="hljs-keyword">const</span> domResult = <span class="hljs-variable language_">this</span>.<span class="hljs-property">domDetector</span>.<span class="hljs-title function_">detect</span>();
        <span class="hljs-keyword">const</span> isWhite = !domResult.<span class="hljs-property">passed</span> || !<span class="hljs-variable language_">this</span>.<span class="hljs-property">domDetector</span>.<span class="hljs-title function_">hasValidContent</span>();
        methodResults.<span class="hljs-title function_">set</span>(<span class="hljs-title class_">DetectionMethod</span>.<span class="hljs-property">DOM</span>, isWhite);
        usedMethods.<span class="hljs-title function_">push</span>(<span class="hljs-title class_">DetectionMethod</span>.<span class="hljs-property">DOM</span>);
      }
      
      <span class="hljs-comment">// 3. 骨架屏检测</span>
      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">config</span>.<span class="hljs-property">enableSkeletonDetection</span>) {
        <span class="hljs-keyword">const</span> skeletonResult = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">skeletonDetector</span>.<span class="hljs-title function_">detect</span>();
        <span class="hljs-keyword">const</span> isWhite = skeletonResult.<span class="hljs-property">skeletonExists</span> &amp;&amp; !skeletonResult.<span class="hljs-property">skeletonRemoved</span>;
        methodResults.<span class="hljs-title function_">set</span>(<span class="hljs-title class_">DetectionMethod</span>.<span class="hljs-property">SKELETON</span>, isWhite);
        usedMethods.<span class="hljs-title function_">push</span>(<span class="hljs-title class_">DetectionMethod</span>.<span class="hljs-property">SKELETON</span>);
      }
      
      <span class="hljs-comment">// 4. 截图检测（较慢，可选）</span>
      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">config</span>.<span class="hljs-property">enableScreenshotDetection</span>) {
        <span class="hljs-keyword">const</span> screenshotResult = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">screenshotDetector</span>.<span class="hljs-title function_">detect</span>();
        methodResults.<span class="hljs-title function_">set</span>(<span class="hljs-title class_">DetectionMethod</span>.<span class="hljs-property">SCREENSHOT</span>, screenshotResult.<span class="hljs-property">isWhiteScreen</span>);
        usedMethods.<span class="hljs-title function_">push</span>(<span class="hljs-title class_">DetectionMethod</span>.<span class="hljs-property">SCREENSHOT</span>);
      }
      
      <span class="hljs-comment">// 5. 自定义检测器</span>
      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">config</span>.<span class="hljs-property">customDetector</span>) {
        <span class="hljs-keyword">try</span> {
          <span class="hljs-keyword">const</span> customResult = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">config</span>.<span class="hljs-title function_">customDetector</span>();
          methodResults.<span class="hljs-title function_">set</span>(<span class="hljs-title class_">DetectionMethod</span>.<span class="hljs-property">CUSTOM</span>, customResult);
          usedMethods.<span class="hljs-title function_">push</span>(<span class="hljs-title class_">DetectionMethod</span>.<span class="hljs-property">CUSTOM</span>);
        } <span class="hljs-keyword">catch</span> {
          <span class="hljs-comment">// 自定义检测器失败</span>
        }
      }
      
      <span class="hljs-comment">// 综合判断</span>
      <span class="hljs-keyword">const</span> result = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">combineResults</span>(methodResults, usedMethods);
      
      <span class="hljs-comment">// 生成报告</span>
      <span class="hljs-keyword">const</span> report = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">generateReport</span>(result, methodResults);
      
      <span class="hljs-comment">// 上报</span>
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">reporter</span>.<span class="hljs-title function_">report</span>(report);
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">config</span>.<span class="hljs-title function_">onReport</span>(report);
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">config</span>.<span class="hljs-title function_">onDetectionComplete</span>(result);
      
      <span class="hljs-comment">// 如果检测到白屏，可能需要重试</span>
      <span class="hljs-keyword">if</span> (result.<span class="hljs-property">isWhiteScreen</span> &amp;&amp; <span class="hljs-variable language_">this</span>.<span class="hljs-property">detectionCount</span> &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">config</span>.<span class="hljs-property">maxRetries</span>) {
        <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
          <span class="hljs-variable language_">this</span>.<span class="hljs-property">isDetecting</span> = <span class="hljs-literal">false</span>;
          <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">detect</span>();
        }, <span class="hljs-variable language_">this</span>.<span class="hljs-property">config</span>.<span class="hljs-property">retryInterval</span>);
      }
      
      <span class="hljs-keyword">return</span> result;
    } <span class="hljs-keyword">catch</span> (error) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'[WhiteScreenSDK] Detection error:'</span>, error);
      <span class="hljs-keyword">return</span> {
        <span class="hljs-attr">isWhiteScreen</span>: <span class="hljs-literal">false</span>,
        <span class="hljs-attr">confidence</span>: <span class="hljs-number">0</span>,
        <span class="hljs-attr">methods</span>: usedMethods,
        methodResults,
        <span class="hljs-attr">basis</span>: <span class="hljs-string">`Error: <span class="hljs-subst">${(error <span class="hljs-keyword">as</span> <span class="hljs-built_in">Error</span>).message}</span>`</span>
      };
    } <span class="hljs-keyword">finally</span> {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">isDetecting</span> = <span class="hljs-literal">false</span>;
    }
  }
  
  <span class="hljs-comment">/**
   * 综合各方法结果
   */</span>
  <span class="hljs-keyword">private</span> <span class="hljs-title function_">combineResults</span>(
    <span class="hljs-attr">methodResults</span>: <span class="hljs-title class_">Map</span>&lt;<span class="hljs-title class_">DetectionMethod</span>, <span class="hljs-built_in">boolean</span>&gt;,
    <span class="hljs-attr">usedMethods</span>: <span class="hljs-title class_">DetectionMethod</span>[]
  ): <span class="hljs-title class_">DetectionResult</span> {
    <span class="hljs-keyword">if</span> (usedMethods.<span class="hljs-property">length</span> === <span class="hljs-number">0</span>) {
      <span class="hljs-keyword">return</span> {
        <span class="hljs-attr">isWhiteScreen</span>: <span class="hljs-literal">false</span>,
        <span class="hljs-attr">confidence</span>: <span class="hljs-number">0</span>,
        <span class="hljs-attr">methods</span>: [],
        methodResults,
        <span class="hljs-attr">basis</span>: <span class="hljs-string">'No detection methods enabled'</span>
      };
    }
    
    <span class="hljs-comment">// 计算白屏票数</span>
    <span class="hljs-keyword">let</span> whiteVotes = <span class="hljs-number">0</span>;
    <span class="hljs-keyword">let</span> totalVotes = <span class="hljs-number">0</span>;
    
    <span class="hljs-comment">// 不同方法的权重</span>
    <span class="hljs-keyword">const</span> <span class="hljs-attr">weights</span>: <span class="hljs-title class_">Record</span>&lt;<span class="hljs-title class_">DetectionMethod</span>, <span class="hljs-built_in">number</span>&gt; = {
      [<span class="hljs-title class_">DetectionMethod</span>.<span class="hljs-property">SAMPLING</span>]: <span class="hljs-number">3</span>,
      [<span class="hljs-title class_">DetectionMethod</span>.<span class="hljs-property">DOM</span>]: <span class="hljs-number">2</span>,
      [<span class="hljs-title class_">DetectionMethod</span>.<span class="hljs-property">MUTATION</span>]: <span class="hljs-number">2</span>,
      [<span class="hljs-title class_">DetectionMethod</span>.<span class="hljs-property">SCREENSHOT</span>]: <span class="hljs-number">2</span>,
      [<span class="hljs-title class_">DetectionMethod</span>.<span class="hljs-property">SKELETON</span>]: <span class="hljs-number">1</span>,
      [<span class="hljs-title class_">DetectionMethod</span>.<span class="hljs-property">PERFORMANCE</span>]: <span class="hljs-number">1</span>,
      [<span class="hljs-title class_">DetectionMethod</span>.<span class="hljs-property">CUSTOM</span>]: <span class="hljs-number">2</span>,
      [<span class="hljs-title class_">DetectionMethod</span>.<span class="hljs-property">COMBINED</span>]: <span class="hljs-number">1</span>
    };
    
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> method <span class="hljs-keyword">of</span> usedMethods) {
      <span class="hljs-keyword">const</span> isWhite = methodResults.<span class="hljs-title function_">get</span>(method);
      <span class="hljs-keyword">const</span> weight = weights[method] || <span class="hljs-number">1</span>;
      
      totalVotes += weight;
      <span class="hljs-keyword">if</span> (isWhite) {
        whiteVotes += weight;
      }
    }
    
    <span class="hljs-comment">// 计算置信度</span>
    <span class="hljs-keyword">const</span> confidence = totalVotes &gt; <span class="hljs-number">0</span> ? <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">abs</span>(whiteVotes - totalVotes / <span class="hljs-number">2</span>) / (totalVotes / <span class="hljs-number">2</span>) : <span class="hljs-number">0</span>;
    
    <span class="hljs-comment">// 判断是否白屏（超过半数加权投票）</span>
    <span class="hljs-keyword">const</span> isWhiteScreen = whiteVotes &gt; totalVotes / <span class="hljs-number">2</span>;
    
    <span class="hljs-comment">// 确定判定依据</span>
    <span class="hljs-keyword">let</span> basis = isWhiteScreen ? <span class="hljs-string">'Multiple methods indicate white screen'</span> : <span class="hljs-string">'Page appears normal'</span>;
    
    <span class="hljs-comment">// 检查是否有关键错误</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">errorMonitor</span>.<span class="hljs-title function_">hasCriticalErrors</span>()) {
      basis += <span class="hljs-string">' (Critical JS errors detected)'</span>;
    }
    
    <span class="hljs-keyword">return</span> {
      isWhiteScreen,
      confidence,
      <span class="hljs-attr">methods</span>: usedMethods,
      methodResults,
      basis
    };
  }
  
  <span class="hljs-comment">/**
   * 生成报告
   */</span>
  <span class="hljs-keyword">private</span> <span class="hljs-title function_">generateReport</span>(
    <span class="hljs-attr">result</span>: <span class="hljs-title class_">DetectionResult</span>,
    <span class="hljs-attr">methodResults</span>: <span class="hljs-title class_">Map</span>&lt;<span class="hljs-title class_">DetectionMethod</span>, <span class="hljs-built_in">boolean</span>&gt;
  ): <span class="hljs-title class_">WhiteScreenReport</span> {
    <span class="hljs-keyword">const</span> <span class="hljs-attr">report</span>: <span class="hljs-title class_">WhiteScreenReport</span> = {
      <span class="hljs-attr">isWhiteScreen</span>: result.<span class="hljs-property">isWhiteScreen</span>,
      <span class="hljs-attr">timestamp</span>: <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>(),
      <span class="hljs-attr">url</span>: <span class="hljs-variable language_">window</span>.<span class="hljs-property">location</span>.<span class="hljs-property">href</span>,
      <span class="hljs-attr">detectionMethod</span>: result.<span class="hljs-property">methods</span>.<span class="hljs-property">length</span> &gt; <span class="hljs-number">1</span> ? <span class="hljs-title class_">DetectionMethod</span>.<span class="hljs-property">COMBINED</span> : result.<span class="hljs-property">methods</span>[<span class="hljs-number">0</span>],
      <span class="hljs-attr">userAgent</span>: navigator.<span class="hljs-property">userAgent</span>,
      <span class="hljs-attr">viewport</span>: {
        <span class="hljs-attr">width</span>: <span class="hljs-variable language_">window</span>.<span class="hljs-property">innerWidth</span>,
        <span class="hljs-attr">height</span>: <span class="hljs-variable language_">window</span>.<span class="hljs-property">innerHeight</span>
      },
      <span class="hljs-attr">devicePixelRatio</span>: <span class="hljs-variable language_">window</span>.<span class="hljs-property">devicePixelRatio</span>,
      <span class="hljs-attr">networkInfo</span>: <span class="hljs-title function_">getNetworkInfo</span>(),
      <span class="hljs-attr">performanceData</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">performanceDetector</span>.<span class="hljs-title function_">getMetrics</span>()
    };
    
    <span class="hljs-comment">// 添加采样结果</span>
    <span class="hljs-keyword">if</span> (methodResults.<span class="hljs-title function_">has</span>(<span class="hljs-title class_">DetectionMethod</span>.<span class="hljs-property">SAMPLING</span>)) {
      report.<span class="hljs-property">samplingResult</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">samplingDetector</span>.<span class="hljs-title function_">detect</span>();
    }
    
    <span class="hljs-comment">// 添加 DOM 检测结果</span>
    <span class="hljs-keyword">if</span> (methodResults.<span class="hljs-title function_">has</span>(<span class="hljs-title class_">DetectionMethod</span>.<span class="hljs-property">DOM</span>)) {
      report.<span class="hljs-property">domResult</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">domDetector</span>.<span class="hljs-title function_">detect</span>();
    }
    
    <span class="hljs-comment">// 添加错误信息</span>
    <span class="hljs-keyword">const</span> errors = <span class="hljs-variable language_">this</span>.<span class="hljs-property">errorMonitor</span>.<span class="hljs-title function_">getErrors</span>();
    <span class="hljs-keyword">if</span> (errors.<span class="hljs-property">length</span> &gt; <span class="hljs-number">0</span>) {
      report.<span class="hljs-property">errorInfo</span> = errors[<span class="hljs-number">0</span>];
    }
    
    <span class="hljs-keyword">return</span> report;
  }
  
  <span class="hljs-comment">/**
   * 手动触发检测
   */</span>
  <span class="hljs-title function_">manualDetect</span>(): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-title class_">DetectionResult</span>&gt; {
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">detect</span>();
  }
  
  <span class="hljs-comment">/**
   * 设置上报回调
   */</span>
  <span class="hljs-title function_">setReportCallback</span>(<span class="hljs-attr">callback</span>: <span class="hljs-function">(<span class="hljs-params">data: WhiteScreenReport</span>) =&gt;</span> <span class="hljs-built_in">void</span>): <span class="hljs-built_in">void</span> {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">config</span>.<span class="hljs-property">onReport</span> = callback;
  }
  
  <span class="hljs-comment">/**
   * 设置检测完成回调
   */</span>
  <span class="hljs-title function_">setDetectionCompleteCallback</span>(<span class="hljs-attr">callback</span>: <span class="hljs-function">(<span class="hljs-params">result: DetectionResult</span>) =&gt;</span> <span class="hljs-built_in">void</span>): <span class="hljs-built_in">void</span> {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">config</span>.<span class="hljs-property">onDetectionComplete</span> = callback;
  }
  
  <span class="hljs-comment">/**
   * 获取检测统计
   */</span>
  <span class="hljs-title function_">getStats</span>(): {
    <span class="hljs-attr">detectionCount</span>: <span class="hljs-built_in">number</span>;
    <span class="hljs-attr">lastDetectionTime</span>: <span class="hljs-built_in">number</span>;
    <span class="hljs-attr">errors</span>: <span class="hljs-title class_">ErrorInfo</span>[];
    <span class="hljs-attr">performance</span>: <span class="hljs-title class_">PerformanceData</span>;
  } {
    <span class="hljs-keyword">return</span> {
      <span class="hljs-attr">detectionCount</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">detectionCount</span>,
      <span class="hljs-attr">lastDetectionTime</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">lastDetectionTime</span>,
      <span class="hljs-attr">errors</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">errorMonitor</span>.<span class="hljs-title function_">getErrors</span>(),
      <span class="hljs-attr">performance</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">performanceDetector</span>.<span class="hljs-title function_">getMetrics</span>()
    };
  }
  
  <span class="hljs-comment">/**
   * 销毁 SDK
   */</span>
  <span class="hljs-title function_">destroy</span>(): <span class="hljs-built_in">void</span> {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">errorMonitor</span>.<span class="hljs-title function_">stop</span>();
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">performanceDetector</span>.<span class="hljs-title function_">stop</span>();
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">skeletonDetector</span>.<span class="hljs-title function_">stop</span>();
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">screenshotDetector</span>.<span class="hljs-title function_">dispose</span>();
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">isInitialized</span> = <span class="hljs-literal">false</span>;
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'[WhiteScreenSDK] Destroyed'</span>);
  }
}

<span class="hljs-comment">// ==================== 导出 ====================</span>

<span class="hljs-comment">// 创建单例</span>
<span class="hljs-keyword">let</span> <span class="hljs-attr">sdkInstance</span>: <span class="hljs-title class_">WhiteScreenSDK</span> | <span class="hljs-literal">null</span> = <span class="hljs-literal">null</span>;

<span class="hljs-comment">/**
 * 获取 SDK 实例（单例模式）
 */</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">getWhiteScreenSDK</span>(<span class="hljs-params">config?: Partial&lt;WhiteScreenConfig&gt;</span>): <span class="hljs-title class_">WhiteScreenSDK</span> {
  <span class="hljs-keyword">if</span> (!sdkInstance) {
    sdkInstance = <span class="hljs-keyword">new</span> <span class="hljs-title class_">WhiteScreenSDK</span>(config);
  }
  <span class="hljs-keyword">return</span> sdkInstance;
}

<span class="hljs-comment">/**
 * 快速初始化并返回实例
 */</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">initWhiteScreenDetection</span>(<span class="hljs-params">config?: Partial&lt;WhiteScreenConfig&gt;</span>): <span class="hljs-title class_">WhiteScreenSDK</span> {
  <span class="hljs-keyword">const</span> sdk = <span class="hljs-title function_">getWhiteScreenSDK</span>(config);
  sdk.<span class="hljs-title function_">init</span>();
  <span class="hljs-keyword">return</span> sdk;
}

<span class="hljs-comment">// ES Module 导出</span>
<span class="hljs-keyword">export</span> {
  <span class="hljs-title class_">WhiteScreenSDK</span>,
  <span class="hljs-title class_">WhiteScreenConfig</span>,
  <span class="hljs-title class_">WhiteScreenReport</span>,
  <span class="hljs-title class_">DetectionMethod</span>,
  <span class="hljs-title class_">DetectionResult</span>,
  <span class="hljs-title class_">SamplingDetector</span>,
  <span class="hljs-title class_">DOMDetector</span>,
  <span class="hljs-title class_">MutationDetector</span>,
  <span class="hljs-title class_">ScreenshotDetector</span>,
  <span class="hljs-title class_">SkeletonDetector</span>,
  <span class="hljs-title class_">PerformanceDetector</span>,
  <span class="hljs-title class_">ErrorMonitor</span>,
  <span class="hljs-title class_">Reporter</span>,
  getWhiteScreenSDK,
  initWhiteScreenDetection
};

<span class="hljs-comment">// UMD 导出（兼容浏览器直接使用）</span>
<span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> <span class="hljs-variable language_">window</span> !== <span class="hljs-string">'undefined'</span>) {
  (<span class="hljs-variable language_">window</span> <span class="hljs-keyword">as</span> <span class="hljs-title class_">Window</span> &amp; { <span class="hljs-title class_">WhiteScreenSDK</span>: <span class="hljs-keyword">typeof</span> <span class="hljs-title class_">WhiteScreenSDK</span>; <span class="hljs-attr">initWhiteScreenDetection</span>: <span class="hljs-keyword">typeof</span> initWhiteScreenDetection }).<span class="hljs-property">WhiteScreenSDK</span> = <span class="hljs-title class_">WhiteScreenSDK</span>;
  (<span class="hljs-variable language_">window</span> <span class="hljs-keyword">as</span> <span class="hljs-title class_">Window</span> &amp; { <span class="hljs-attr">initWhiteScreenDetection</span>: <span class="hljs-keyword">typeof</span> initWhiteScreenDetection }).<span class="hljs-property">initWhiteScreenDetection</span> = initWhiteScreenDetection;
}
</code></pre>
<h3 data-id="heading-3">三、使用示例</h3>
<h4 data-id="heading-4">1. 基础使用</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 最简单的使用方式</span>
<span class="hljs-keyword">import</span> { initWhiteScreenDetection } <span class="hljs-keyword">from</span> <span class="hljs-string">'./white-screen-sdk'</span>;

<span class="hljs-comment">// 初始化并开始检测</span>
<span class="hljs-keyword">const</span> sdk = <span class="hljs-title function_">initWhiteScreenDetection</span>({
  <span class="hljs-attr">threshold</span>: <span class="hljs-number">0.9</span>,
  <span class="hljs-attr">delay</span>: <span class="hljs-number">2000</span>,
  <span class="hljs-attr">onReport</span>: <span class="hljs-function">(<span class="hljs-params">report</span>) =&gt;</span> {
    <span class="hljs-keyword">if</span> (report.<span class="hljs-property">isWhiteScreen</span>) {
      <span class="hljs-comment">// 发送到监控平台</span>
      <span class="hljs-title function_">sendToMonitor</span>(report);
    }
  }
});
</code></pre>
<h4 data-id="heading-5">2. 完整配置示例</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">WhiteScreenSDK</span>, <span class="hljs-title class_">WhiteScreenReport</span>, <span class="hljs-title class_">DetectionResult</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./white-screen-sdk'</span>;

<span class="hljs-comment">// 创建 SDK 实例，完整配置</span>
<span class="hljs-keyword">const</span> sdk = <span class="hljs-keyword">new</span> <span class="hljs-title class_">WhiteScreenSDK</span>({
  <span class="hljs-comment">// 采样配置</span>
  <span class="hljs-attr">samplingPoints</span>: <span class="hljs-number">20</span>,
  <span class="hljs-attr">threshold</span>: <span class="hljs-number">0.9</span>,
  
  <span class="hljs-comment">// 时间配置</span>
  <span class="hljs-attr">delay</span>: <span class="hljs-number">1500</span>,
  <span class="hljs-attr">timeout</span>: <span class="hljs-number">15000</span>,
  
  <span class="hljs-comment">// 功能开关</span>
  <span class="hljs-attr">enableDOMDetection</span>: <span class="hljs-literal">true</span>,
  <span class="hljs-attr">enableSamplingDetection</span>: <span class="hljs-literal">true</span>,
  <span class="hljs-attr">enableMutationDetection</span>: <span class="hljs-literal">true</span>,
  <span class="hljs-attr">enableScreenshotDetection</span>: <span class="hljs-literal">false</span>,
  <span class="hljs-attr">enableSkeletonDetection</span>: <span class="hljs-literal">true</span>,
  
  <span class="hljs-comment">// 选择器配置</span>
  <span class="hljs-attr">keyElementSelectors</span>: [
    <span class="hljs-string">'#app'</span>,
    <span class="hljs-string">'#root'</span>,
    <span class="hljs-string">'.main-content'</span>,
    <span class="hljs-string">'[data-page-ready]'</span>
  ],
  <span class="hljs-attr">skeletonSelector</span>: <span class="hljs-string">'.skeleton, .loading-placeholder'</span>,
  <span class="hljs-attr">ignoreSelectors</span>: [
    <span class="hljs-string">'script'</span>,
    <span class="hljs-string">'style'</span>,
    <span class="hljs-string">'.loading-indicator'</span>,
    <span class="hljs-string">'.modal-backdrop'</span>
  ],
  
  <span class="hljs-comment">// 重试配置</span>
  <span class="hljs-attr">maxRetries</span>: <span class="hljs-number">3</span>,
  <span class="hljs-attr">retryInterval</span>: <span class="hljs-number">2000</span>,
  
  <span class="hljs-comment">// 环境配置</span>
  <span class="hljs-attr">enableInDev</span>: <span class="hljs-literal">false</span>,
  
  <span class="hljs-comment">// 回调函数</span>
  <span class="hljs-attr">onReport</span>: <span class="hljs-function">(<span class="hljs-params">report: WhiteScreenReport</span>) =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'检测报告:'</span>, report);
    
    <span class="hljs-keyword">if</span> (report.<span class="hljs-property">isWhiteScreen</span>) {
      <span class="hljs-comment">// 上报到监控系统</span>
      <span class="hljs-title function_">reportToMonitoringSystem</span>(report);
      
      <span class="hljs-comment">// 可选：尝试恢复页面</span>
      <span class="hljs-title function_">attemptPageRecovery</span>();
    }
  },
  
  <span class="hljs-attr">onDetectionComplete</span>: <span class="hljs-function">(<span class="hljs-params">result: DetectionResult</span>) =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'检测完成:'</span>, result);
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'置信度:'</span>, result.<span class="hljs-property">confidence</span>);
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'判定依据:'</span>, result.<span class="hljs-property">basis</span>);
  },
  
  <span class="hljs-comment">// 自定义检测逻辑</span>
  <span class="hljs-attr">customDetector</span>: <span class="hljs-function">() =&gt;</span> {
    <span class="hljs-comment">// 自定义白屏判断逻辑</span>
    <span class="hljs-keyword">const</span> appElement = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'app'</span>);
    <span class="hljs-keyword">if</span> (!appElement) <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    
    <span class="hljs-comment">// 检查是否有实际内容</span>
    <span class="hljs-keyword">const</span> hasContent = appElement.<span class="hljs-property">children</span>.<span class="hljs-property">length</span> &gt; <span class="hljs-number">0</span>;
    <span class="hljs-keyword">const</span> hasText = (appElement.<span class="hljs-property">textContent</span>?.<span class="hljs-title function_">trim</span>().<span class="hljs-property">length</span> ?? <span class="hljs-number">0</span>) &gt; <span class="hljs-number">100</span>;
    
    <span class="hljs-keyword">return</span> !hasContent &amp;&amp; !hasText;
  }
});

<span class="hljs-comment">// 初始化</span>
sdk.<span class="hljs-title function_">init</span>();

<span class="hljs-comment">// 手动触发检测</span>
<span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'checkBtn'</span>)?.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'click'</span>, <span class="hljs-keyword">async</span> () =&gt; {
  <span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> sdk.<span class="hljs-title function_">manualDetect</span>();
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'手动检测结果:'</span>, result);
});

<span class="hljs-comment">// 上报函数</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">reportToMonitoringSystem</span>(<span class="hljs-params">report: WhiteScreenReport</span>): <span class="hljs-built_in">void</span> {
  <span class="hljs-comment">// 发送到监控后端</span>
  <span class="hljs-title function_">fetch</span>(<span class="hljs-string">'/api/monitor/white-screen'</span>, {
    <span class="hljs-attr">method</span>: <span class="hljs-string">'POST'</span>,
    <span class="hljs-attr">headers</span>: {
      <span class="hljs-string">'Content-Type'</span>: <span class="hljs-string">'application/json'</span>
    },
    <span class="hljs-attr">body</span>: <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(report)
  }).<span class="hljs-keyword">catch</span>(<span class="hljs-variable language_">console</span>.<span class="hljs-property">error</span>);
}

<span class="hljs-comment">// 页面恢复尝试</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">attemptPageRecovery</span>(<span class="hljs-params"/>): <span class="hljs-built_in">void</span> {
  <span class="hljs-comment">// 尝试重新加载关键资源</span>
  <span class="hljs-keyword">const</span> failedScripts = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelectorAll</span>(<span class="hljs-string">'script[data-retry]'</span>);
  failedScripts.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">script</span> =&gt;</span> {
    <span class="hljs-keyword">const</span> newScript = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">'script'</span>);
    newScript.<span class="hljs-property">src</span> = (script <span class="hljs-keyword">as</span> <span class="hljs-title class_">HTMLScriptElement</span>).<span class="hljs-property">src</span>;
    <span class="hljs-variable language_">document</span>.<span class="hljs-property">body</span>.<span class="hljs-title function_">appendChild</span>(newScript);
  });
  
  <span class="hljs-comment">// 或者刷新页面</span>
  <span class="hljs-comment">// window.location.reload();</span>
}
</code></pre>
<h4 data-id="heading-6">3. Vue 3 集成示例</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// white-screen-plugin.ts</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">App</span>, <span class="hljs-title class_">Plugin</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">WhiteScreenSDK</span>, <span class="hljs-title class_">WhiteScreenConfig</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./white-screen-sdk'</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">WhiteScreenPluginOptions</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Partial</span>&lt;<span class="hljs-title class_">WhiteScreenConfig</span>&gt; {
  reportEndpoint?: <span class="hljs-built_in">string</span>;
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title class_">WhiteScreenPlugin</span>: <span class="hljs-title class_">Plugin</span> = {
  <span class="hljs-title function_">install</span>(<span class="hljs-params">app: App, options: WhiteScreenPluginOptions = {}</span>) {
    <span class="hljs-comment">// 创建 SDK 实例</span>
    <span class="hljs-keyword">const</span> sdk = <span class="hljs-keyword">new</span> <span class="hljs-title class_">WhiteScreenSDK</span>({
      <span class="hljs-comment">// 默认配置</span>
      <span class="hljs-attr">keyElementSelectors</span>: [<span class="hljs-string">'#app'</span>, <span class="hljs-string">'[data-v-app]'</span>],
      <span class="hljs-attr">enableInDev</span>: <span class="hljs-literal">false</span>,
      
      <span class="hljs-comment">// 合并用户配置</span>
      ...options,
      
      <span class="hljs-comment">// 设置上报回调</span>
      <span class="hljs-attr">onReport</span>: <span class="hljs-function">(<span class="hljs-params">report</span>) =&gt;</span> {
        <span class="hljs-comment">// 调用用户提供的回调</span>
        options.<span class="hljs-property">onReport</span>?.(report);
        
        <span class="hljs-comment">// 如果提供了上报端点，自动上报</span>
        <span class="hljs-keyword">if</span> (options.<span class="hljs-property">reportEndpoint</span> &amp;&amp; report.<span class="hljs-property">isWhiteScreen</span>) {
          <span class="hljs-title function_">fetch</span>(options.<span class="hljs-property">reportEndpoint</span>, {
            <span class="hljs-attr">method</span>: <span class="hljs-string">'POST'</span>,
            <span class="hljs-attr">headers</span>: { <span class="hljs-string">'Content-Type'</span>: <span class="hljs-string">'application/json'</span> },
            <span class="hljs-attr">body</span>: <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>({
              ...report,
              <span class="hljs-attr">framework</span>: <span class="hljs-string">'vue'</span>,
              <span class="hljs-attr">version</span>: app.<span class="hljs-property">version</span>
            })
          }).<span class="hljs-keyword">catch</span>(<span class="hljs-variable language_">console</span>.<span class="hljs-property">error</span>);
        }
      }
    });
    
    <span class="hljs-comment">// 注册全局属性</span>
    app.<span class="hljs-property">config</span>.<span class="hljs-property">globalProperties</span>.<span class="hljs-property">$whiteScreen</span> = sdk;
    
    <span class="hljs-comment">// 提供给 Composition API 使用</span>
    app.<span class="hljs-title function_">provide</span>(<span class="hljs-string">'whiteScreenSDK'</span>, sdk);
    
    <span class="hljs-comment">// 在应用挂载后初始化</span>
    <span class="hljs-keyword">const</span> originalMount = app.<span class="hljs-property">mount</span>.<span class="hljs-title function_">bind</span>(app);
    app.<span class="hljs-property">mount</span> = <span class="hljs-function">(<span class="hljs-params">rootContainer</span>) =&gt;</span> {
      <span class="hljs-keyword">const</span> vm = <span class="hljs-title function_">originalMount</span>(rootContainer);
      
      <span class="hljs-comment">// 延迟初始化，等待 Vue 渲染完成</span>
      <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
        sdk.<span class="hljs-title function_">init</span>();
      }, <span class="hljs-number">100</span>);
      
      <span class="hljs-keyword">return</span> vm;
    };
    
    <span class="hljs-comment">// 在应用卸载时销毁</span>
    <span class="hljs-keyword">const</span> originalUnmount = app.<span class="hljs-property">unmount</span>.<span class="hljs-title function_">bind</span>(app);
    app.<span class="hljs-property">unmount</span> = <span class="hljs-function">() =&gt;</span> {
      sdk.<span class="hljs-title function_">destroy</span>();
      <span class="hljs-title function_">originalUnmount</span>();
    };
  }
};

<span class="hljs-comment">// 类型声明</span>
<span class="hljs-keyword">declare</span> <span class="hljs-variable language_">module</span> <span class="hljs-string">'@vue/runtime-core'</span> {
  <span class="hljs-keyword">interface</span> <span class="hljs-title class_">ComponentCustomProperties</span> {
    <span class="hljs-attr">$whiteScreen</span>: <span class="hljs-title class_">WhiteScreenSDK</span>;
  }
}

<span class="hljs-comment">// 组合式 API Hook</span>
<span class="hljs-keyword">import</span> { inject } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">useWhiteScreen</span>(<span class="hljs-params"/>): <span class="hljs-title class_">WhiteScreenSDK</span> | <span class="hljs-literal">undefined</span> {
  <span class="hljs-keyword">return</span> inject&lt;<span class="hljs-title class_">WhiteScreenSDK</span>&gt;(<span class="hljs-string">'whiteScreenSDK'</span>);
}
</code></pre>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// main.ts</span>
<span class="hljs-keyword">import</span> { createApp } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-title class_">App</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'./App.vue'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">WhiteScreenPlugin</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./plugins/white-screen-plugin'</span>;

<span class="hljs-keyword">const</span> app = <span class="hljs-title function_">createApp</span>(<span class="hljs-title class_">App</span>);

app.<span class="hljs-title function_">use</span>(<span class="hljs-title class_">WhiteScreenPlugin</span>, {
  <span class="hljs-attr">threshold</span>: <span class="hljs-number">0.9</span>,
  <span class="hljs-attr">delay</span>: <span class="hljs-number">2000</span>,
  <span class="hljs-attr">reportEndpoint</span>: <span class="hljs-string">'/api/monitor/white-screen'</span>,
  <span class="hljs-attr">enableInDev</span>: <span class="hljs-literal">false</span>,
  <span class="hljs-attr">keyElementSelectors</span>: [<span class="hljs-string">'#app'</span>, <span class="hljs-string">'.main-layout'</span>, <span class="hljs-string">'[data-page-content]'</span>],
  <span class="hljs-attr">onDetectionComplete</span>: <span class="hljs-function">(<span class="hljs-params">result</span>) =&gt;</span> {
    <span class="hljs-keyword">if</span> (result.<span class="hljs-property">isWhiteScreen</span>) {
      <span class="hljs-comment">// 可以在这里触发重试逻辑或显示友好提示</span>
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">warn</span>(<span class="hljs-string">'页面可能出现白屏，正在尝试恢复...'</span>);
    }
  }
});

app.<span class="hljs-title function_">mount</span>(<span class="hljs-string">'#app'</span>);
</code></pre>
<pre><code class="hljs language-vue" lang="vue">&lt;!-- 在组件中使用 --&gt;
&lt;template&gt;
  &lt;div class="page"&gt;
    &lt;h1&gt;示例页面&lt;/h1&gt;
    &lt;button @click="checkWhiteScreen"&gt;手动检测白屏&lt;/button&gt;
  &lt;/div&gt;
&lt;/template&gt;

&lt;script setup lang="ts"&gt;
import { useWhiteScreen } from '@/plugins/white-screen-plugin';

const whiteScreenSDK = useWhiteScreen();

async function checkWhiteScreen() {
  if (whiteScreenSDK) {
    const result = await whiteScreenSDK.manualDetect();
    console.log('检测结果:', result);
    
    if (result.isWhiteScreen) {
      alert('检测到白屏问题！');
    } else {
      alert('页面正常');
    }
  }
}
&lt;/script&gt;
</code></pre>
<h4 data-id="heading-7">4. React 集成示例</h4>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-comment">// WhiteScreenContext.tsx</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">React</span>, { createContext, useContext, useEffect, useRef, <span class="hljs-title class_">ReactNode</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">WhiteScreenSDK</span>, <span class="hljs-title class_">WhiteScreenConfig</span>, <span class="hljs-title class_">DetectionResult</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./white-screen-sdk'</span>;

<span class="hljs-keyword">interface</span> <span class="hljs-title class_">WhiteScreenContextValue</span> {
  <span class="hljs-attr">sdk</span>: <span class="hljs-title class_">WhiteScreenSDK</span> | <span class="hljs-literal">null</span>;
  <span class="hljs-attr">manualDetect</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-title class_">DetectionResult</span> | <span class="hljs-literal">null</span>&gt;;
  <span class="hljs-attr">getStats</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-title class_">ReturnType</span>&lt;<span class="hljs-title class_">WhiteScreenSDK</span>[<span class="hljs-string">'getStats'</span>]&gt; | <span class="hljs-literal">null</span>;
}

<span class="hljs-keyword">const</span> <span class="hljs-title class_">WhiteScreenContext</span> = createContext&lt;<span class="hljs-title class_">WhiteScreenContextValue</span>&gt;({
  <span class="hljs-attr">sdk</span>: <span class="hljs-literal">null</span>,
  <span class="hljs-attr">manualDetect</span>: <span class="hljs-keyword">async</span> () =&gt; <span class="hljs-literal">null</span>,
  <span class="hljs-attr">getStats</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-literal">null</span>
});

<span class="hljs-keyword">export</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">WhiteScreenProviderProps</span> {
  <span class="hljs-attr">children</span>: <span class="hljs-title class_">ReactNode</span>;
  config?: <span class="hljs-title class_">Partial</span>&lt;<span class="hljs-title class_">WhiteScreenConfig</span>&gt;;
  onWhiteScreen?: <span class="hljs-function">(<span class="hljs-params">result: DetectionResult</span>) =&gt;</span> <span class="hljs-built_in">void</span>;
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">WhiteScreenProvider</span>(<span class="hljs-params">{ 
  children, 
  config = {},
  onWhiteScreen 
}: WhiteScreenProviderProps</span>) {
  <span class="hljs-keyword">const</span> sdkRef = useRef&lt;<span class="hljs-title class_">WhiteScreenSDK</span> | <span class="hljs-literal">null</span>&gt;(<span class="hljs-literal">null</span>);
  
  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-comment">// 创建 SDK 实例</span>
    <span class="hljs-keyword">const</span> sdk = <span class="hljs-keyword">new</span> <span class="hljs-title class_">WhiteScreenSDK</span>({
      <span class="hljs-attr">keyElementSelectors</span>: [<span class="hljs-string">'#root'</span>, <span class="hljs-string">'[data-reactroot]'</span>, <span class="hljs-string">'.app-container'</span>],
      <span class="hljs-attr">enableInDev</span>: <span class="hljs-literal">false</span>,
      ...config,
      <span class="hljs-attr">onDetectionComplete</span>: <span class="hljs-function">(<span class="hljs-params">result</span>) =&gt;</span> {
        config.<span class="hljs-property">onDetectionComplete</span>?.(result);
        
        <span class="hljs-keyword">if</span> (result.<span class="hljs-property">isWhiteScreen</span> &amp;&amp; onWhiteScreen) {
          <span class="hljs-title function_">onWhiteScreen</span>(result);
        }
      }
    });
    
    sdkRef.<span class="hljs-property">current</span> = sdk;
    
    <span class="hljs-comment">// 初始化</span>
    sdk.<span class="hljs-title function_">init</span>();
    
    <span class="hljs-comment">// 清理</span>
    <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> {
      sdk.<span class="hljs-title function_">destroy</span>();
      sdkRef.<span class="hljs-property">current</span> = <span class="hljs-literal">null</span>;
    };
  }, []);
  
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">manualDetect</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params"/>) =&gt; {
    <span class="hljs-keyword">if</span> (sdkRef.<span class="hljs-property">current</span>) {
      <span class="hljs-keyword">return</span> sdkRef.<span class="hljs-property">current</span>.<span class="hljs-title function_">manualDetect</span>();
    }
    <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
  };
  
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">getStats</span> = (<span class="hljs-params"/>) =&gt; {
    <span class="hljs-keyword">if</span> (sdkRef.<span class="hljs-property">current</span>) {
      <span class="hljs-keyword">return</span> sdkRef.<span class="hljs-property">current</span>.<span class="hljs-title function_">getStats</span>();
    }
    <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
  };
  
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">WhiteScreenContext.Provider</span> <span class="hljs-attr">value</span>=<span class="hljs-string">{{</span> 
      <span class="hljs-attr">sdk:</span> <span class="hljs-attr">sdkRef.current</span>, 
      <span class="hljs-attr">manualDetect</span>, 
      <span class="hljs-attr">getStats</span> 
    }}&gt;</span>
      {children}
    <span class="hljs-tag">&lt;/<span class="hljs-name">WhiteScreenContext.Provider</span>&gt;</span></span>
  );
}

<span class="hljs-comment">// Hook</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">useWhiteScreen</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">return</span> <span class="hljs-title function_">useContext</span>(<span class="hljs-title class_">WhiteScreenContext</span>);
}

<span class="hljs-comment">// HOC</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> withWhiteScreenDetection&lt;P <span class="hljs-keyword">extends</span> <span class="hljs-built_in">object</span>&gt;(
  <span class="hljs-title class_">WrappedComponent</span>: <span class="hljs-title class_">React</span>.<span class="hljs-property">ComponentType</span>&lt;P&gt;,
  config?: <span class="hljs-title class_">Partial</span>&lt;<span class="hljs-title class_">WhiteScreenConfig</span>&gt;
) {
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">WithWhiteScreenComponent</span>(<span class="hljs-params">props: P</span>) {
    <span class="hljs-keyword">return</span> (
      <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">WhiteScreenProvider</span> <span class="hljs-attr">config</span>=<span class="hljs-string">{config}</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">WrappedComponent</span> {<span class="hljs-attr">...props</span>} /&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">WhiteScreenProvider</span>&gt;</span></span>
    );
  };
}
</code></pre>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-comment">// App.tsx</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">React</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">WhiteScreenProvider</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./contexts/WhiteScreenContext'</span>;

<span class="hljs-keyword">function</span> <span class="hljs-title function_">App</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleWhiteScreen</span> = (<span class="hljs-params">result</span>) =&gt; {
    <span class="hljs-comment">// 白屏时的处理逻辑</span>
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'检测到白屏:'</span>, result);
    
    <span class="hljs-comment">// 可以显示错误边界或重试按钮</span>
    <span class="hljs-comment">// setShowErrorBoundary(true);</span>
  };

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">WhiteScreenProvider</span> 
      <span class="hljs-attr">config</span>=<span class="hljs-string">{{</span>
        <span class="hljs-attr">threshold:</span> <span class="hljs-attr">0.85</span>,
        <span class="hljs-attr">delay:</span> <span class="hljs-attr">2000</span>,
        <span class="hljs-attr">enableScreenshotDetection:</span> <span class="hljs-attr">false</span>
      }}
      <span class="hljs-attr">onWhiteScreen</span>=<span class="hljs-string">{handleWhiteScreen}</span>
    &gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"app"</span>&gt;</span>
        {/* 应用内容 */}
      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">WhiteScreenProvider</span>&gt;</span></span>
  );
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title class_">App</span>;
</code></pre>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-comment">// 在组件中使用</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">React</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;
<span class="hljs-keyword">import</span> { useWhiteScreen } <span class="hljs-keyword">from</span> <span class="hljs-string">'./contexts/WhiteScreenContext'</span>;

<span class="hljs-keyword">function</span> <span class="hljs-title function_">DebugPanel</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> { manualDetect, getStats } = <span class="hljs-title function_">useWhiteScreen</span>();
  
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleCheck</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params"/>) =&gt; {
    <span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> <span class="hljs-title function_">manualDetect</span>();
    <span class="hljs-keyword">if</span> (result) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'检测结果:'</span>, result);
      <span class="hljs-title function_">alert</span>(result.<span class="hljs-property">isWhiteScreen</span> ? <span class="hljs-string">'检测到白屏'</span> : <span class="hljs-string">'页面正常'</span>);
    }
  };
  
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleShowStats</span> = (<span class="hljs-params"/>) =&gt; {
    <span class="hljs-keyword">const</span> stats = <span class="hljs-title function_">getStats</span>();
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'统计信息:'</span>, stats);
  };
  
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"debug-panel"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{handleCheck}</span>&gt;</span>手动检测白屏<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{handleShowStats}</span>&gt;</span>查看统计<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
}
</code></pre>
<h3 data-id="heading-8">四、服务端数据处理示例</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// server/white-screen-handler.ts</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Request</span>, <span class="hljs-title class_">Response</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'express'</span>;

<span class="hljs-keyword">interface</span> <span class="hljs-title class_">WhiteScreenReport</span> {
  <span class="hljs-attr">isWhiteScreen</span>: <span class="hljs-built_in">boolean</span>;
  <span class="hljs-attr">timestamp</span>: <span class="hljs-built_in">number</span>;
  <span class="hljs-attr">url</span>: <span class="hljs-built_in">string</span>;
  <span class="hljs-attr">detectionMethod</span>: <span class="hljs-built_in">string</span>;
  <span class="hljs-attr">userAgent</span>: <span class="hljs-built_in">string</span>;
  <span class="hljs-attr">viewport</span>: { <span class="hljs-attr">width</span>: <span class="hljs-built_in">number</span>; <span class="hljs-attr">height</span>: <span class="hljs-built_in">number</span> };
  performanceData?: <span class="hljs-title class_">Record</span>&lt;<span class="hljs-built_in">string</span>, <span class="hljs-built_in">number</span>&gt;;
  errorInfo?: { <span class="hljs-attr">message</span>: <span class="hljs-built_in">string</span>; stack?: <span class="hljs-built_in">string</span>; <span class="hljs-attr">type</span>: <span class="hljs-built_in">string</span> };
  <span class="hljs-comment">// ... 其他字段</span>
}

<span class="hljs-keyword">interface</span> <span class="hljs-title class_">WhiteScreenStats</span> {
  <span class="hljs-attr">totalReports</span>: <span class="hljs-built_in">number</span>;
  <span class="hljs-attr">whiteScreenCount</span>: <span class="hljs-built_in">number</span>;
  <span class="hljs-attr">whiteScreenRate</span>: <span class="hljs-built_in">number</span>;
  <span class="hljs-attr">topUrls</span>: { <span class="hljs-attr">url</span>: <span class="hljs-built_in">string</span>; <span class="hljs-attr">count</span>: <span class="hljs-built_in">number</span> }[];
  <span class="hljs-attr">topErrors</span>: { <span class="hljs-attr">message</span>: <span class="hljs-built_in">string</span>; <span class="hljs-attr">count</span>: <span class="hljs-built_in">number</span> }[];
  <span class="hljs-attr">hourlyDistribution</span>: { <span class="hljs-attr">hour</span>: <span class="hljs-built_in">number</span>; <span class="hljs-attr">count</span>: <span class="hljs-built_in">number</span> }[];
}

<span class="hljs-keyword">class</span> <span class="hljs-title class_">WhiteScreenAnalyzer</span> {
  <span class="hljs-keyword">private</span> <span class="hljs-attr">reports</span>: <span class="hljs-title class_">WhiteScreenReport</span>[] = [];
  <span class="hljs-keyword">private</span> <span class="hljs-attr">maxReports</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">10000</span>;
  
  <span class="hljs-comment">/**
   * 添加报告
   */</span>
  <span class="hljs-title function_">addReport</span>(<span class="hljs-attr">report</span>: <span class="hljs-title class_">WhiteScreenReport</span>): <span class="hljs-built_in">void</span> {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">reports</span>.<span class="hljs-title function_">push</span>(report);
    
    <span class="hljs-comment">// 保持报告数量在限制内</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">reports</span>.<span class="hljs-property">length</span> &gt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">maxReports</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">reports</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">reports</span>.<span class="hljs-title function_">slice</span>(-<span class="hljs-variable language_">this</span>.<span class="hljs-property">maxReports</span>);
    }
  }
  
  <span class="hljs-comment">/**
   * 获取统计数据
   */</span>
  <span class="hljs-title function_">getStats</span>(timeRange?: { <span class="hljs-attr">start</span>: <span class="hljs-built_in">number</span>; <span class="hljs-attr">end</span>: <span class="hljs-built_in">number</span> }): <span class="hljs-title class_">WhiteScreenStats</span> {
    <span class="hljs-keyword">let</span> filteredReports = <span class="hljs-variable language_">this</span>.<span class="hljs-property">reports</span>;
    
    <span class="hljs-keyword">if</span> (timeRange) {
      filteredReports = <span class="hljs-variable language_">this</span>.<span class="hljs-property">reports</span>.<span class="hljs-title function_">filter</span>(
        <span class="hljs-function"><span class="hljs-params">r</span> =&gt;</span> r.<span class="hljs-property">timestamp</span> &gt;= timeRange.<span class="hljs-property">start</span> &amp;&amp; r.<span class="hljs-property">timestamp</span> &lt;= timeRange.<span class="hljs-property">end</span>
      );
    }
    
    <span class="hljs-keyword">const</span> totalReports = filteredReports.<span class="hljs-property">length</span>;
    <span class="hljs-keyword">const</span> whiteScreenReports = filteredReports.<span class="hljs-title function_">filter</span>(<span class="hljs-function"><span class="hljs-params">r</span> =&gt;</span> r.<span class="hljs-property">isWhiteScreen</span>);
    <span class="hljs-keyword">const</span> whiteScreenCount = whiteScreenReports.<span class="hljs-property">length</span>;
    <span class="hljs-keyword">const</span> whiteScreenRate = totalReports &gt; <span class="hljs-number">0</span> ? whiteScreenCount / totalReports : <span class="hljs-number">0</span>;
    
    <span class="hljs-comment">// 统计 Top URLs</span>
    <span class="hljs-keyword">const</span> urlCounts = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>&lt;<span class="hljs-built_in">string</span>, <span class="hljs-built_in">number</span>&gt;();
    whiteScreenReports.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">r</span> =&gt;</span> {
      <span class="hljs-keyword">const</span> url = <span class="hljs-keyword">new</span> <span class="hljs-title function_">URL</span>(r.<span class="hljs-property">url</span>).<span class="hljs-property">pathname</span>;
      urlCounts.<span class="hljs-title function_">set</span>(url, (urlCounts.<span class="hljs-title function_">get</span>(url) || <span class="hljs-number">0</span>) + <span class="hljs-number">1</span>);
    });
    
    <span class="hljs-keyword">const</span> topUrls = <span class="hljs-title class_">Array</span>.<span class="hljs-title function_">from</span>(urlCounts.<span class="hljs-title function_">entries</span>())
      .<span class="hljs-title function_">map</span>(<span class="hljs-function">(<span class="hljs-params">[url, count]</span>) =&gt;</span> ({ url, count }))
      .<span class="hljs-title function_">sort</span>(<span class="hljs-function">(<span class="hljs-params">a, b</span>) =&gt;</span> b.<span class="hljs-property">count</span> - a.<span class="hljs-property">count</span>)
      .<span class="hljs-title function_">slice</span>(<span class="hljs-number">0</span>, <span class="hljs-number">10</span>);
    
    <span class="hljs-comment">// 统计 Top Errors</span>
    <span class="hljs-keyword">const</span> errorCounts = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>&lt;<span class="hljs-built_in">string</span>, <span class="hljs-built_in">number</span>&gt;();
    whiteScreenReports.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">r</span> =&gt;</span> {
      <span class="hljs-keyword">if</span> (r.<span class="hljs-property">errorInfo</span>?.<span class="hljs-property">message</span>) {
        <span class="hljs-keyword">const</span> msg = r.<span class="hljs-property">errorInfo</span>.<span class="hljs-property">message</span>.<span class="hljs-title function_">slice</span>(<span class="hljs-number">0</span>, <span class="hljs-number">100</span>);
        errorCounts.<span class="hljs-title function_">set</span>(msg, (errorCounts.<span class="hljs-title function_">get</span>(msg) || <span class="hljs-number">0</span>) + <span class="hljs-number">1</span>);
      }
    });
    
    <span class="hljs-keyword">const</span> topErrors = <span class="hljs-title class_">Array</span>.<span class="hljs-title function_">from</span>(errorCounts.<span class="hljs-title function_">entries</span>())
      .<span class="hljs-title function_">map</span>(<span class="hljs-function">(<span class="hljs-params">[message, count]</span>) =&gt;</span> ({ message, count }))
      .<span class="hljs-title function_">sort</span>(<span class="hljs-function">(<span class="hljs-params">a, b</span>) =&gt;</span> b.<span class="hljs-property">count</span> - a.<span class="hljs-property">count</span>)
      .<span class="hljs-title function_">slice</span>(<span class="hljs-number">0</span>, <span class="hljs-number">10</span>);
    
    <span class="hljs-comment">// 小时分布</span>
    <span class="hljs-keyword">const</span> hourCounts = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Array</span>(<span class="hljs-number">24</span>).<span class="hljs-title function_">fill</span>(<span class="hljs-number">0</span>);
    whiteScreenReports.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">r</span> =&gt;</span> {
      <span class="hljs-keyword">const</span> hour = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>(r.<span class="hljs-property">timestamp</span>).<span class="hljs-title function_">getHours</span>();
      hourCounts[hour]++;
    });
    
    <span class="hljs-keyword">const</span> hourlyDistribution = hourCounts.<span class="hljs-title function_">map</span>(<span class="hljs-function">(<span class="hljs-params">count, hour</span>) =&gt;</span> ({ hour, count }));
    
    <span class="hljs-keyword">return</span> {
      totalReports,
      whiteScreenCount,
      whiteScreenRate,
      topUrls,
      topErrors,
      hourlyDistribution
    };
  }
  
  <span class="hljs-comment">/**
   * 检查是否需要告警
   */</span>
  <span class="hljs-title function_">shouldAlert</span>(): { <span class="hljs-attr">alert</span>: <span class="hljs-built_in">boolean</span>; <span class="hljs-attr">reason</span>: <span class="hljs-built_in">string</span> } {
    <span class="hljs-keyword">const</span> recentReports = <span class="hljs-variable language_">this</span>.<span class="hljs-property">reports</span>.<span class="hljs-title function_">filter</span>(
      <span class="hljs-function"><span class="hljs-params">r</span> =&gt;</span> <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>() - r.<span class="hljs-property">timestamp</span> &lt; <span class="hljs-number">5</span> * <span class="hljs-number">60</span> * <span class="hljs-number">1000</span> <span class="hljs-comment">// 最近5分钟</span>
    );
    
    <span class="hljs-keyword">if</span> (recentReports.<span class="hljs-property">length</span> === <span class="hljs-number">0</span>) {
      <span class="hljs-keyword">return</span> { <span class="hljs-attr">alert</span>: <span class="hljs-literal">false</span>, <span class="hljs-attr">reason</span>: <span class="hljs-string">''</span> };
    }
    
    <span class="hljs-keyword">const</span> whiteScreenRate = recentReports.<span class="hljs-title function_">filter</span>(<span class="hljs-function"><span class="hljs-params">r</span> =&gt;</span> r.<span class="hljs-property">isWhiteScreen</span>).<span class="hljs-property">length</span> / recentReports.<span class="hljs-property">length</span>;
    
    <span class="hljs-keyword">if</span> (whiteScreenRate &gt; <span class="hljs-number">0.1</span>) {
      <span class="hljs-keyword">return</span> { 
        <span class="hljs-attr">alert</span>: <span class="hljs-literal">true</span>, 
        <span class="hljs-attr">reason</span>: <span class="hljs-string">`白屏率过高: <span class="hljs-subst">${(whiteScreenRate * <span class="hljs-number">100</span>).toFixed(<span class="hljs-number">1</span>)}</span>%`</span> 
      };
    }
    
    <span class="hljs-keyword">return</span> { <span class="hljs-attr">alert</span>: <span class="hljs-literal">false</span>, <span class="hljs-attr">reason</span>: <span class="hljs-string">''</span> };
  }
}

<span class="hljs-comment">// Express 路由处理</span>
<span class="hljs-keyword">const</span> analyzer = <span class="hljs-keyword">new</span> <span class="hljs-title class_">WhiteScreenAnalyzer</span>();

<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">handleWhiteScreenReport</span>(<span class="hljs-params">req: Request, res: Response</span>): <span class="hljs-built_in">void</span> {
  <span class="hljs-keyword">try</span> {
    <span class="hljs-keyword">const</span> <span class="hljs-attr">reports</span>: <span class="hljs-title class_">WhiteScreenReport</span>[] = <span class="hljs-title class_">Array</span>.<span class="hljs-title function_">isArray</span>(req.<span class="hljs-property">body</span>) ? req.<span class="hljs-property">body</span> : [req.<span class="hljs-property">body</span>];
    
    reports.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">report</span> =&gt;</span> {
      analyzer.<span class="hljs-title function_">addReport</span>(report);
    });
    
    <span class="hljs-comment">// 检查是否需要告警</span>
    <span class="hljs-keyword">const</span> alertStatus = analyzer.<span class="hljs-title function_">shouldAlert</span>();
    <span class="hljs-keyword">if</span> (alertStatus.<span class="hljs-property">alert</span>) {
      <span class="hljs-comment">// 发送告警（例如：发送邮件、短信、钉钉通知等）</span>
      <span class="hljs-title function_">sendAlert</span>(alertStatus.<span class="hljs-property">reason</span>);
    }
    
    res.<span class="hljs-title function_">status</span>(<span class="hljs-number">200</span>).<span class="hljs-title function_">json</span>({ <span class="hljs-attr">success</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">received</span>: reports.<span class="hljs-property">length</span> });
  } <span class="hljs-keyword">catch</span> (error) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'处理白屏报告失败:'</span>, error);
    res.<span class="hljs-title function_">status</span>(<span class="hljs-number">500</span>).<span class="hljs-title function_">json</span>({ <span class="hljs-attr">success</span>: <span class="hljs-literal">false</span>, <span class="hljs-attr">error</span>: (error <span class="hljs-keyword">as</span> <span class="hljs-title class_">Error</span>).<span class="hljs-property">message</span> });
  }
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">getWhiteScreenStats</span>(<span class="hljs-params">req: Request, res: Response</span>): <span class="hljs-built_in">void</span> {
  <span class="hljs-keyword">try</span> {
    <span class="hljs-keyword">const</span> { start, end } = req.<span class="hljs-property">query</span>;
    
    <span class="hljs-keyword">const</span> timeRange = start &amp;&amp; end 
      ? { <span class="hljs-attr">start</span>: <span class="hljs-title class_">Number</span>(start), <span class="hljs-attr">end</span>: <span class="hljs-title class_">Number</span>(end) }
      : <span class="hljs-literal">undefined</span>;
    
    <span class="hljs-keyword">const</span> stats = analyzer.<span class="hljs-title function_">getStats</span>(timeRange);
    res.<span class="hljs-title function_">json</span>(stats);
  } <span class="hljs-keyword">catch</span> (error) {
    res.<span class="hljs-title function_">status</span>(<span class="hljs-number">500</span>).<span class="hljs-title function_">json</span>({ <span class="hljs-attr">error</span>: (error <span class="hljs-keyword">as</span> <span class="hljs-title class_">Error</span>).<span class="hljs-property">message</span> });
  }
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">sendAlert</span>(<span class="hljs-params">reason: <span class="hljs-built_in">string</span></span>): <span class="hljs-built_in">void</span> {
  <span class="hljs-comment">// 实现告警逻辑</span>
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">warn</span>(<span class="hljs-string">'[白屏告警]'</span>, reason);
  <span class="hljs-comment">// 可以集成各种告警渠道：邮件、短信、钉钉、企业微信等</span>
}
</code></pre>
<h3 data-id="heading-9">五、总结</h3>
<p>以上代码实现了一个完整的前端白屏检测 SDK，包含以下核心功能：</p>
<ol>
<li>
<p><strong>多种检测方法</strong>：</p>
<ul>
<li>采样点检测 - 在页面关键位置采样判断</li>
<li>DOM 检测 - 检查关键 DOM 元素是否存在和可见</li>
<li>MutationObserver 检测 - 监听 DOM 变化</li>
<li>截图检测 - 通过 Canvas 分析页面内容</li>
<li>骨架屏检测 - 检测 loading 状态</li>
</ul>
</li>
<li>
<p><strong>完善的上报机制</strong>：</p>
<ul>
<li>支持 Beacon API 和 fetch 降级</li>
<li>队列批量上报</li>
<li>页面卸载时发送</li>
</ul>
</li>
<li>
<p><strong>框架集成</strong>：</p>
<ul>
<li>Vue 3 插件和 Composition API Hook</li>
<li>React Context 和 Hook</li>
</ul>
</li>
<li>
<p><strong>服务端处理</strong>：</p>
<ul>
<li>数据统计分析</li>
<li>告警机制</li>
</ul>
</li>
</ol>
<p>实际使用时，可以根据项目需求选择合适的检测方法组合，并配置合理的阈值和延迟时间，以达到最佳的检测效果。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[SpringAI Agent开发秘籍：让javaer也可以用上Agent Skills]]></title>    <link>https://juejin.cn/post/7599929684021837843</link>    <guid>https://juejin.cn/post/7599929684021837843</guid>    <pubDate>2026-01-28T02:32:18.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7599929684021837843" data-draft-id="7599929684021805075" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="SpringAI Agent开发秘籍：让javaer也可以用上Agent Skills"/> <meta itemprop="keywords" content="后端,Agent,LLM"/> <meta itemprop="datePublished" content="2026-01-28T02:32:18.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="一灰灰"/> <meta itemprop="url" content="https://juejin.cn/user/377887729916126"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            SpringAI Agent开发秘籍：让javaer也可以用上Agent Skills
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/377887729916126/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    一灰灰
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-28T02:32:18.000Z" title="Wed Jan 28 2026 02:32:18 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-28
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读12分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FujxVleNhjxzUgL-rjfFcVA" target="_blank" title="https://mp.weixin.qq.com/s/ujxVleNhjxzUgL-rjfFcVA" ref="nofollow noopener noreferrer">告别传统AI开发！SpringAI Agent + Skills重新定义智能应用</a></p>
</blockquote>
<p>要说最近AI相关话题中什么最火，毫无疑问是<strong>Claude Skills</strong>，让我感到震惊的倒不是它为什么火爆，而是SpringAI居然已经迅速支持上Skills了，这效率真的是堪比🚀了。</p>
<p>谁说AI时代java开发者要掉队了？ 肉虽然不一定吃得上，但是喝口汤还是妥妥的</p>
<p>接下来我们通过构建一个code reviewer, 来实际体验一把，如何将SpringAI和Skills结合起来使用</p>
<h2 data-id="heading-0">一、项目创建</h2>
<h3 data-id="heading-1">1. 基础环境要求</h3>
<p>要体验SpringAI &amp; Skills，目前需要升级到SpringAI 2.x版本，同时我们的SpringBoot也可以升级到4.x</p>
<ul>
<li>SpringAI: 2.0.0-M2</li>
<li>JDK21</li>
<li>SpringBoot: 4.0.1</li>
</ul>
<p>除了这几个基本依赖之外，我们可以选择一个支持Function Tool的大模型来作为这个实现的大脑中枢</p>
<p>我们这里选择智谱的大模型<code>GLM-4.5-Flash</code> （原因就是因为它免费，且效果还行，对所有想体验的小伙伴没有任何额外成本投入）</p>
<h3 data-id="heading-2">2. 项目创建</h3>
<p>接下来我们创建一个SpringAI应用，对于一个标准的SpringAI应用，在<code>pom.xml</code>配置中，你会看到下面这些基础版本指定，这个也没什么好说的</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">parent</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-parent<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>4.0.1<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">relativePath</span> /&gt;</span> 
<span class="hljs-tag">&lt;/<span class="hljs-name">parent</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">properties</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">maven.compiler.source</span>&gt;</span>21<span class="hljs-tag">&lt;/<span class="hljs-name">maven.compiler.source</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">maven.compiler.target</span>&gt;</span>21<span class="hljs-tag">&lt;/<span class="hljs-name">maven.compiler.target</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">project.build.sourceEncoding</span>&gt;</span>UTF-8<span class="hljs-tag">&lt;/<span class="hljs-name">project.build.sourceEncoding</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">spring-ai.version</span>&gt;</span>2.0.0-M2<span class="hljs-tag">&lt;/<span class="hljs-name">spring-ai.version</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">properties</span>&gt;</span>


<span class="hljs-tag">&lt;<span class="hljs-name">dependencyManagement</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.ai<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-ai-bom<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>${spring-ai.version}<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">type</span>&gt;</span>pom<span class="hljs-tag">&lt;/<span class="hljs-name">type</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>import<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependencyManagement</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">build</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">plugins</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">plugin</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">plugin</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">plugins</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">build</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">repositories</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">repository</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">id</span>&gt;</span>spring-snapshots<span class="hljs-tag">&lt;/<span class="hljs-name">id</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">name</span>&gt;</span>Spring Snapshots<span class="hljs-tag">&lt;/<span class="hljs-name">name</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">url</span>&gt;</span>https://repo.spring.io/snapshot<span class="hljs-tag">&lt;/<span class="hljs-name">url</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">releases</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">enabled</span>&gt;</span>false<span class="hljs-tag">&lt;/<span class="hljs-name">enabled</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">releases</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">repository</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">repository</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">name</span>&gt;</span>Central Portal Snapshots<span class="hljs-tag">&lt;/<span class="hljs-name">name</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">id</span>&gt;</span>central-portal-snapshots<span class="hljs-tag">&lt;/<span class="hljs-name">id</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">url</span>&gt;</span>https://central.sonatype.com/repository/maven-snapshots/<span class="hljs-tag">&lt;/<span class="hljs-name">url</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">releases</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">enabled</span>&gt;</span>false<span class="hljs-tag">&lt;/<span class="hljs-name">enabled</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">releases</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">snapshots</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">enabled</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">enabled</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">snapshots</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">repository</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">repositories</span>&gt;</span>
</code></pre>
<p>接下来重点看一下我们这个项目所用到的几个核心依赖</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springaicommunity<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-ai-agent-utils<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>0.4.1<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.ai<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-ai-starter-model-zhipuai<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span>
</code></pre>
<ul>
<li>spring-ai-agent-utils: 这个就是SpringAI进行agent开发的关键依赖包</li>
<li>spring-ai-starter-model-zhipuai: 这个是智谱大模型进行交互的依赖包</li>
</ul>
<h3 data-id="heading-3">3. 项目配置</h3>
<p>依赖搞定之后，接下来就是在配置文件中，配置LLM访问的相关信息、以及agent相关配置参数，对应的配置文件 <code>resources/application.yml</code></p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">spring:</span>
  <span class="hljs-attr">ai:</span>
    <span class="hljs-attr">zhipuai:</span>
      <span class="hljs-comment"># api-key 使用你自己申请的进行替换；如果为了安全考虑，可以通过启动参数进行设置</span>
      <span class="hljs-attr">api-key:</span> <span class="hljs-string">${zhipuai-api-key}</span>
      <span class="hljs-attr">chat:</span> <span class="hljs-comment"># 聊天模型</span>
        <span class="hljs-attr">options:</span>
          <span class="hljs-attr">model:</span> <span class="hljs-string">GLM-4.5-Flash</span>

<span class="hljs-comment">## Agent Configuration</span>
<span class="hljs-attr">agent:</span>
  <span class="hljs-attr">skills:</span>
    <span class="hljs-attr">dirs:</span> <span class="hljs-string">classpath:/.claude/skills</span>
  <span class="hljs-attr">model:</span> <span class="hljs-string">GLM-4.5-Flash</span>
</code></pre>
<p>这几个配置看起来和之前SpringAI相关的并没有太多的区别，其中 <code>agent</code> 相关的配置中，主要设置了skills的存放路径，使用的model</p>
<p>根据上面的定义，我们将skills信息，放在<code>resources/.claude/skills</code>目录下</p>
<p>新增一个目录<code>code-reviewer</code>，目录下的文件为 <code>SKILL.md</code></p>
<pre><code class="hljs language-bash" lang="bash">.claude/skills/code-reviewer/
└── SKILL.md
</code></pre>
<p>对应的内容如下</p>
<pre><code class="hljs language-markdown" lang="markdown">---
name: code-reviewer
<span class="hljs-section">description: Reviews Java code for best practices, security issues, and Spring Framework conventions. Use when user asks to review, analyze, or audit code.
---</span>

<span class="hljs-section"># Code Reviewer</span>

<span class="hljs-section">## Instructions</span>

在审查代码时：

<span class="hljs-bullet">1.</span> 检查是否存在安全漏洞（如SQL注入、XSS等）
<span class="hljs-bullet">2.</span> 验证是否遵循了Spring Boot的最佳实践（如正确使用@Service、@Repository等注解）
<span class="hljs-bullet">3.</span> 查找潜在的空指针异常
<span class="hljs-bullet">4.</span> 提出提高代码可读性和可维护性的建议
<span class="hljs-bullet">5.</span> 提供具体的逐行反馈，并附上代码示例
<span class="hljs-bullet">6.</span> 以中文的方式返回代码评审结果
</code></pre>
<h3 data-id="heading-4">4. Skills简要说明</h3>
<p>我们上面的Skill比较简单，就是一个markdown文档，SpringAI支持的Skills中，除了包含基本的<code>SKILL.md</code>文件（包含元数据（名称和描述）以及指导代理如何执行特定任务的说明）之外，还可以有相关的脚本、模板和参考资料</p>
<p>一个常见的skills结构如下</p>
<pre><code class="hljs language-perl" lang="perl"><span class="hljs-keyword">my</span>-skill/
├── SKILL.md          <span class="hljs-comment"># Required: instructions + metadata</span>
├── scripts/          <span class="hljs-comment"># Optional: executable code</span>
├── references/       <span class="hljs-comment"># Optional: documentation</span>
└── assets/           <span class="hljs-comment"># Optional: templates, resources</span>
</code></pre>
<h2 data-id="heading-5">二、核心实现</h2>
<p>现在前置准备已经完成，接下来开始正式的体验吧</p>
<h3 data-id="heading-6">2.1 交互日志打印 MyLoggingAdvisor</h3>
<p>为了让系统与大模型之间的交互更清晰，我们将双方交互的日志进行更友好的打印（也顺便看一下，一次用户感知的问答过程中，实际上有几次交互）</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MyLoggingAdvisor</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">BaseAdvisor</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> order;

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-type">boolean</span> showSystemMessage;

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-type">boolean</span> showAvailableTools;

    <span class="hljs-keyword">private</span> <span class="hljs-type">AtomicInteger</span> <span class="hljs-variable">cnt</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AtomicInteger</span>(<span class="hljs-number">1</span>);

    <span class="hljs-keyword">private</span> <span class="hljs-title function_">MyLoggingAdvisor</span><span class="hljs-params">(<span class="hljs-type">int</span> order, <span class="hljs-type">boolean</span> showSystemMessage, <span class="hljs-type">boolean</span> showAvailableTools)</span> {
        <span class="hljs-built_in">this</span>.order = order;
        <span class="hljs-built_in">this</span>.showSystemMessage = showSystemMessage;
        <span class="hljs-built_in">this</span>.showAvailableTools = showAvailableTools;
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getOrder</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.order;
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> ChatClientRequest <span class="hljs-title function_">before</span><span class="hljs-params">(ChatClientRequest chatClientRequest, AdvisorChain advisorChain)</span> {
        System.out.println(<span class="hljs-string">"======================= 第 "</span> + cnt.getAndAdd(<span class="hljs-number">1</span>) + <span class="hljs-string">" 轮 ===================================="</span>);

        <span class="hljs-type">StringBuilder</span> <span class="hljs-variable">sb</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuilder</span>(<span class="hljs-string">"\nUSER: "</span>);

        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.showSystemMessage &amp;&amp; chatClientRequest.prompt().getSystemMessage() != <span class="hljs-literal">null</span>) {
            sb.append(<span class="hljs-string">"\n - SYSTEM: "</span>).append(first(chatClientRequest.prompt().getSystemMessage().getText(), <span class="hljs-number">300</span>));
        }

        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.showAvailableTools) {
            <span class="hljs-type">Object</span> <span class="hljs-variable">tools</span> <span class="hljs-operator">=</span> <span class="hljs-string">"No Tools"</span>;

            <span class="hljs-keyword">if</span> (chatClientRequest.prompt().getOptions() <span class="hljs-keyword">instanceof</span> ToolCallingChatOptions toolOptions) {
                tools = toolOptions.getToolCallbacks().stream().map(tc -&gt; tc.getToolDefinition().name()).toList();
            }

            sb.append(<span class="hljs-string">"\n - TOOLS: "</span>).append(ModelOptionsUtils.toJsonString(tools));
        }

        <span class="hljs-type">Message</span> <span class="hljs-variable">lastMessage</span> <span class="hljs-operator">=</span> chatClientRequest.prompt().getLastUserOrToolResponseMessage();

        <span class="hljs-keyword">if</span> (lastMessage.getMessageType() == MessageType.TOOL) {
            <span class="hljs-type">ToolResponseMessage</span> <span class="hljs-variable">toolResponseMessage</span> <span class="hljs-operator">=</span> (ToolResponseMessage) lastMessage;
            <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> toolResponse : toolResponseMessage.getResponses()) {
                <span class="hljs-type">var</span> <span class="hljs-variable">tr</span> <span class="hljs-operator">=</span> toolResponse.name() + <span class="hljs-string">": "</span> + first(toolResponse.responseData(), <span class="hljs-number">1000</span>);
                sb.append(<span class="hljs-string">"\n - TOOL-RESPONSE: "</span>).append(tr);
            }
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (lastMessage.getMessageType() == MessageType.USER) {
            <span class="hljs-keyword">if</span> (StringUtils.hasText(lastMessage.getText())) {
                sb.append(<span class="hljs-string">"\n - TEXT: "</span>).append(first(lastMessage.getText(), <span class="hljs-number">1000</span>));
            }
        }

        System.out.println(<span class="hljs-string">"before: "</span> + sb);
        <span class="hljs-keyword">return</span> chatClientRequest;
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> ChatClientResponse <span class="hljs-title function_">after</span><span class="hljs-params">(ChatClientResponse chatClientResponse, AdvisorChain advisorChain)</span> {
        <span class="hljs-type">StringBuilder</span> <span class="hljs-variable">sb</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuilder</span>(<span class="hljs-string">"\nASSISTANT: "</span>);

        <span class="hljs-keyword">if</span> (chatClientResponse.chatResponse() == <span class="hljs-literal">null</span> || chatClientResponse.chatResponse().getResults() == <span class="hljs-literal">null</span>) {
            sb.append(<span class="hljs-string">" No chat response "</span>);
            System.out.println(<span class="hljs-string">"after: "</span> + sb);
            <span class="hljs-keyword">return</span> chatClientResponse;
        }

        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> generation : chatClientResponse.chatResponse().getResults()) {
            <span class="hljs-type">var</span> <span class="hljs-variable">message</span> <span class="hljs-operator">=</span> generation.getOutput();
            <span class="hljs-keyword">if</span> (message.getToolCalls() != <span class="hljs-literal">null</span>) {
                <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> toolCall : message.getToolCalls()) {
                    sb.append(<span class="hljs-string">"\n - TOOL-CALL: "</span>)
                            .append(toolCall.name())
                            .append(<span class="hljs-string">" ("</span>)
                            .append(toolCall.arguments())
                            .append(<span class="hljs-string">")"</span>);
                }
            }

            <span class="hljs-keyword">if</span> (message.getText() != <span class="hljs-literal">null</span>) {
                <span class="hljs-keyword">if</span> (StringUtils.hasText(message.getText())) {
                    sb.append(<span class="hljs-string">"\n - TEXT: "</span>).append(first(message.getText(), <span class="hljs-number">1200</span>));
                }
            }
        }

        System.out.println(<span class="hljs-string">"after: "</span> + sb);
        <span class="hljs-keyword">return</span> chatClientResponse;
    }

    <span class="hljs-keyword">private</span> String <span class="hljs-title function_">first</span><span class="hljs-params">(String text, <span class="hljs-type">int</span> n)</span> {
        <span class="hljs-keyword">if</span> (text.length() &lt;= n) {
            <span class="hljs-keyword">return</span> text;
        }
        <span class="hljs-keyword">return</span> text.substring(<span class="hljs-number">0</span>, n) + <span class="hljs-string">"..."</span>;
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Builder <span class="hljs-title function_">builder</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Builder</span>();
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Builder</span> {

        <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> <span class="hljs-variable">order</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;

        <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-variable">showSystemMessage</span> <span class="hljs-operator">=</span> <span class="hljs-literal">true</span>;

        <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-variable">showAvailableTools</span> <span class="hljs-operator">=</span> <span class="hljs-literal">true</span>;

        <span class="hljs-keyword">public</span> Builder <span class="hljs-title function_">order</span><span class="hljs-params">(<span class="hljs-type">int</span> order)</span> {
            <span class="hljs-built_in">this</span>.order = order;
            <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>;
        }

        <span class="hljs-keyword">public</span> Builder <span class="hljs-title function_">showSystemMessage</span><span class="hljs-params">(<span class="hljs-type">boolean</span> showSystemMessage)</span> {
            <span class="hljs-built_in">this</span>.showSystemMessage = showSystemMessage;
            <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>;
        }

        <span class="hljs-keyword">public</span> Builder <span class="hljs-title function_">showAvailableTools</span><span class="hljs-params">(<span class="hljs-type">boolean</span> showAvailableTools)</span> {
            <span class="hljs-built_in">this</span>.showAvailableTools = showAvailableTools;
            <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>;
        }

        <span class="hljs-keyword">public</span> MyLoggingAdvisor <span class="hljs-title function_">build</span><span class="hljs-params">()</span> {
            <span class="hljs-type">MyLoggingAdvisor</span> <span class="hljs-variable">advisor</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MyLoggingAdvisor</span>(<span class="hljs-built_in">this</span>.order, <span class="hljs-built_in">this</span>.showSystemMessage,
                    <span class="hljs-built_in">this</span>.showAvailableTools);
            <span class="hljs-keyword">return</span> advisor;
        }
    }
}
</code></pre>
<h3 data-id="heading-7">2.2 准备用于评审的代码</h3>
<p>我们直接使用 <a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FNHqLJbos-_nrxNNmhg7IBQ" target="_blank" title="https://mp.weixin.qq.com/s/NHqLJbos-_nrxNNmhg7IBQ" ref="nofollow noopener noreferrer">实战 | 零基础搭建知识库问答机器人：基于SpringAI+RAG的完整实现</a> 中的代码分块的内容作为待评审的内容，看下这段简单的文本分块工具会评审出什么内容</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> com.git.hui.springai.app.demo;

<span class="hljs-keyword">import</span> org.springframework.ai.document.Document;

<span class="hljs-keyword">import</span> java.util.ArrayList;
<span class="hljs-keyword">import</span> java.util.List;

<span class="hljs-comment">/**
 * 文档分块工具类
 * 将长文档分割成较小的块，以便更好地进行向量化和检索
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DocumentChunker</span> {
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> maxChunkSize;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> overlapSize;

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">DocumentChunker</span> <span class="hljs-variable">DEFAULT_CHUNKER</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DocumentChunker</span>();
    
    <span class="hljs-keyword">public</span> <span class="hljs-title function_">DocumentChunker</span><span class="hljs-params">()</span> {
        <span class="hljs-built_in">this</span>(<span class="hljs-number">500</span>, <span class="hljs-number">50</span>); <span class="hljs-comment">// 默认值：最大块大小500个字符，重叠50个字符</span>
    }
    
    <span class="hljs-keyword">public</span> <span class="hljs-title function_">DocumentChunker</span><span class="hljs-params">(<span class="hljs-type">int</span> maxChunkSize, <span class="hljs-type">int</span> overlapSize)</span> {
        <span class="hljs-built_in">this</span>.maxChunkSize = maxChunkSize;
        <span class="hljs-built_in">this</span>.overlapSize = overlapSize;
    }
    
    <span class="hljs-comment">/**
     * 将文档分割成块
     * 
     * <span class="hljs-doctag">@param</span> document 输入文档
     * <span class="hljs-doctag">@return</span> 分割后的文档块列表
     */</span>
    <span class="hljs-keyword">public</span> List&lt;Document&gt; <span class="hljs-title function_">chunkDocument</span><span class="hljs-params">(Document document)</span> {
        <span class="hljs-type">String</span> <span class="hljs-variable">content</span> <span class="hljs-operator">=</span> document.getText();
        <span class="hljs-keyword">if</span> (content == <span class="hljs-literal">null</span> || content.trim().isEmpty()) {
            <span class="hljs-keyword">return</span> List.of(document);
        }
        
        List&lt;String&gt; chunks = splitText(content);
        List&lt;Document&gt; chunkedDocuments = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();
        
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; chunks.size(); i++) {
            <span class="hljs-type">String</span> <span class="hljs-variable">chunk</span> <span class="hljs-operator">=</span> chunks.get(i);
            <span class="hljs-type">String</span> <span class="hljs-variable">chunkId</span> <span class="hljs-operator">=</span> document.getId() + <span class="hljs-string">"_chunk_"</span> + i;
            
            <span class="hljs-comment">// 创建新的文档块，保留原始文档的元数据</span>
            <span class="hljs-type">Document</span> <span class="hljs-variable">chunkDoc</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Document</span>(chunkId, chunk, <span class="hljs-keyword">new</span> <span class="hljs-title class_">java</span>.util.HashMap&lt;&gt;(document.getMetadata()));
            
            <span class="hljs-comment">// 添加块相关的元数据</span>
            chunkDoc.getMetadata().put(<span class="hljs-string">"chunk_index"</span>, i);
            chunkDoc.getMetadata().put(<span class="hljs-string">"total_chunks"</span>, chunks.size());
            chunkDoc.getMetadata().put(<span class="hljs-string">"original_document_id"</span>, document.getId());
            
            chunkedDocuments.add(chunkDoc);
        }
        
        <span class="hljs-keyword">return</span> chunkedDocuments;
    }
    
    <span class="hljs-comment">/**
     * 将文本分割成块
     * 
     * <span class="hljs-doctag">@param</span> text 输入文本
     * <span class="hljs-doctag">@return</span> 分割后的文本块列表
     */</span>
    <span class="hljs-keyword">private</span> List&lt;String&gt; <span class="hljs-title function_">splitText</span><span class="hljs-params">(String text)</span> {
        List&lt;String&gt; chunks = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();
        
        <span class="hljs-comment">// 按多种分隔符分割，优先在语义边界处分割（包括中文句号、问号、感叹号等）</span>
        String[] sentences = text.split(<span class="hljs-string">"(?&lt;=。)|(?&lt;=！)|(?&lt;=!)|(?&lt;=？)|(?&lt;=\\?)|(?&lt;=\\n\\n)"</span>);
        
        <span class="hljs-type">StringBuilder</span> <span class="hljs-variable">currentChunk</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuilder</span>();
        
        <span class="hljs-keyword">for</span> (String sentence : sentences) {
            <span class="hljs-comment">// 跳过空句子</span>
            <span class="hljs-keyword">if</span> (sentence.trim().isEmpty()) {
                <span class="hljs-keyword">continue</span>;
            }
            
            <span class="hljs-comment">// 如果当前块加上新句子不超过最大大小，就添加到当前块</span>
            <span class="hljs-keyword">if</span> (currentChunk.length() + sentence.length() &lt;= maxChunkSize) {
                <span class="hljs-keyword">if</span> (currentChunk.length() &gt; <span class="hljs-number">0</span>) {
                    currentChunk.append(sentence);
                } <span class="hljs-keyword">else</span> {
                    currentChunk.append(sentence);
                }
            } <span class="hljs-keyword">else</span> {
                <span class="hljs-comment">// 如果当前块为空，但是单个句子太长，需要强制分割</span>
                <span class="hljs-keyword">if</span> (currentChunk.length() == <span class="hljs-number">0</span>) {
                    List&lt;String&gt; subChunks = forceSplit(sentence, maxChunkSize);
                    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; subChunks.size(); i++) {
                        <span class="hljs-type">String</span> <span class="hljs-variable">subChunk</span> <span class="hljs-operator">=</span> subChunks.get(i);
                        <span class="hljs-comment">// 如果不是最后一个子块，添加到当前块并保存</span>
                        <span class="hljs-keyword">if</span> (i &lt; subChunks.size() - <span class="hljs-number">1</span>) {
                            chunks.add(subChunk);
                        } <span class="hljs-keyword">else</span> {
                            currentChunk.append(subChunk);
                        }
                    }
                } <span class="hljs-keyword">else</span> {
                    <span class="hljs-comment">// 保存当前块</span>
                    chunks.add(currentChunk.toString());
                    <span class="hljs-comment">// 开始新块，包含重叠部分</span>
                    currentChunk = <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuilder</span>();
                    
                    <span class="hljs-comment">// 添加重叠部分，如果句子长度大于重叠大小，则只取末尾部分</span>
                    <span class="hljs-keyword">if</span> (sentence.length() &gt; overlapSize) {
                        <span class="hljs-type">String</span> <span class="hljs-variable">overlap</span> <span class="hljs-operator">=</span> sentence.substring(Math.max(<span class="hljs-number">0</span>, sentence.length() - overlapSize));
                        currentChunk.append(overlap);
                        currentChunk.append(sentence);
                    } <span class="hljs-keyword">else</span> {
                        currentChunk.append(sentence);
                    }
                }
            }
        }
        
        <span class="hljs-comment">// 添加最后一个块</span>
        <span class="hljs-keyword">if</span> (currentChunk.length() &gt; <span class="hljs-number">0</span>) {
            chunks.add(currentChunk.toString());
        }
        
        <span class="hljs-keyword">return</span> chunks;
    }
    
    <span class="hljs-comment">/**
     * 强制将长文本分割成指定大小的块
     * 
     * <span class="hljs-doctag">@param</span> text 输入文本
     * <span class="hljs-doctag">@param</span> maxSize 最大块大小
     * <span class="hljs-doctag">@return</span> 分割后的文本块列表
     */</span>
    <span class="hljs-keyword">private</span> List&lt;String&gt; <span class="hljs-title function_">forceSplit</span><span class="hljs-params">(String text, <span class="hljs-type">int</span> maxSize)</span> {
        List&lt;String&gt; chunks = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();
        
        <span class="hljs-type">int</span> <span class="hljs-variable">start</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;
        <span class="hljs-keyword">while</span> (start &lt; text.length()) {
            <span class="hljs-type">int</span> <span class="hljs-variable">end</span> <span class="hljs-operator">=</span> Math.min(start + maxSize, text.length());
            <span class="hljs-type">String</span> <span class="hljs-variable">chunk</span> <span class="hljs-operator">=</span> text.substring(start, end);
            chunks.add(chunk);
            start = end;
        }
        
        <span class="hljs-keyword">return</span> chunks;
    }
    
    <span class="hljs-comment">/**
     * 将多个文档分别分割成块
     * 
     * <span class="hljs-doctag">@param</span> documents 输入文档列表
     * <span class="hljs-doctag">@return</span> 分割后的文档块列表
     */</span>
    <span class="hljs-keyword">public</span> List&lt;Document&gt; <span class="hljs-title function_">chunkDocuments</span><span class="hljs-params">(List&lt;Document&gt; documents)</span> {
        List&lt;Document&gt; allChunks = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();
        
        <span class="hljs-keyword">for</span> (Document document : documents) {
            allChunks.addAll(chunkDocument(document));
        }
        
        <span class="hljs-keyword">return</span> allChunks;
    }
}
</code></pre>
<h3 data-id="heading-8">2.3 核心实现</h3>
<p>配置Agent实现代码评审</p>
<p><strong>Bean定义与依赖注入</strong></p>
<ul>
<li>CommandLineRunner: Spring启动后自动执行的接口</li>
<li>ChatClient.Builder: 用于构建聊天客户端</li>
<li>@Value("${agent.skills.dirs:Unknown}"): 注入配置属性，获取技能目录资源列表</li>
</ul>
<p><strong>ChatClient配置链</strong></p>
<ul>
<li>系统提示词配置：</li>
<li>技能工具配置：
<ul>
<li>SkillsTool.builder().addSkillsResources(agentSkillsDirs).build(): 动态加载预定义的技能资源</li>
<li>FileSystemTools.builder().build(): 提供文件系统访问能力</li>
<li>ShellTools.builder().build(): 提供命令行执行能力</li>
</ul>
</li>
<li>Advisor配置:
<ul>
<li>ToolCallAdvisor.builder().build(): 处理工具调用逻辑</li>
<li>MyLoggingAdvisor.builder().showAvailableTools(false).showSystemMessage(false).build(): 自定义日志记录，隐藏工具和系统消息详情</li>
</ul>
</li>
</ul>
<p><strong>代码评审执行流程</strong></p>
<p>请求执行</p>
<ul>
<li>prompt(): 构建提示词</li>
<li>.call(): 发起AI请求</li>
<li>.content(): 获取返回结果</li>
</ul>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Bean</span>
CommandLineRunner <span class="hljs-title function_">commandLineRunner</span><span class="hljs-params">(ChatClient.Builder chatClientBuilder,
                                    <span class="hljs-meta">@Value("${agent.skills.dirs:Unknown}")</span> List&lt;Resource&gt; agentSkillsDirs)</span> <span class="hljs-keyword">throws</span> IOException {

    <span class="hljs-keyword">return</span> args -&gt; {

        <span class="hljs-type">ChatClient</span> <span class="hljs-variable">chatClient</span> <span class="hljs-operator">=</span> chatClientBuilder <span class="hljs-comment">// @formatter:off</span>
                .defaultSystem(<span class="hljs-string">"始终运用现有技能协助用户满足其要求."</span>)

                <span class="hljs-comment">// Skills tool</span>
                .defaultToolCallbacks(SkillsTool.builder().addSkillsResources(agentSkillsDirs).build())
                <span class="hljs-comment">// 支持读取系统文件内容，用于读取我们需要评审的代码</span>
                .defaultTools(FileSystemTools.builder().build())
                <span class="hljs-comment">// 支持执行脚本，如果skills中存在script，那么这些脚本的执行，靠的就是它</span>
                .defaultTools(ShellTools.builder().build())

                .defaultAdvisors(
                        <span class="hljs-comment">// Tool Calling advisor</span>
                        ToolCallAdvisor.builder().build(),
                        <span class="hljs-comment">// Custom logging advisor</span>
                        MyLoggingAdvisor.builder()
                                .showAvailableTools(<span class="hljs-literal">false</span>)
                                .showSystemMessage(<span class="hljs-literal">false</span>)
                                .build())
                .build();
        <span class="hljs-comment">// @formatter:on</span>

        <span class="hljs-type">var</span> <span class="hljs-variable">answer</span> <span class="hljs-operator">=</span> chatClient
                <span class="hljs-comment">// 下面具体的代码位置，请根据实际的位置进行替换</span>
                .prompt(<span class="hljs-string">"""
                        按照最佳实际的方式，评审下面的代码实现:

                         D:\\Workspace\\hui\\project\\spring-ai-demo\\v2\\T01-agentic-skills-simple-design\\src\\main\\java\\com\\git\\hui\\springai\\app\\demo\\DocumentChunker.java
                         """</span>)
                .call()
                .content();

        System.out.println(<span class="hljs-string">"The Answer: "</span> + answer);
    };
}
</code></pre>
<h3 data-id="heading-9">2.4 执行演示</h3>
<p>接下来我们启动项目，验证一下效果如何（在启动命令行参数中，配置上大模型的api-key，当然也可以直接在yml配置文件中进行配置）</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Slf4j</span>
<span class="hljs-meta">@SpringBootApplication</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">T01Application</span> {

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        SpringApplication.run(T01Application.class, args);
    }
}
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bc72c6c5b56542f4ac76fc43dddb45fc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiA54Gw54Gw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770172382&amp;x-signature=dcfVt18Om%2Bkt9RFPEBq5nUonh2o%3D" alt="" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8dd829f7048640d8949f8aefdc516218~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiA54Gw54Gw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770172382&amp;x-signature=0%2BlE%2Fwy4ASS3V2nzUYLMztqTRTU%3D" alt="" loading="lazy"/></p>
<p>从上面的截图也可以看出，系统与大模型之间进行了三轮对话，</p>
<ol>
<li>第一轮： 用户的原始诉求 -&gt; 大模型</li>
</ol>
<ul>
<li>大模型识别到需要进行代码评审，给系统响应 <code>{"command":"code-reviewer"}</code></li>
</ul>
<ol start="2">
<li>第二轮：系统接收到响应之后，读取skills的约束进行响应</li>
</ol>
<ul>
<li>大模型返回需要读取需要评审的代码内容，对应的响应为 <code>{"filePath":"D:\\Workspace\\hui\\project\\spring-ai-demo\\v2\\T01-agentic-skills-simple-design\\src\\main\\java\\com\\git\\hui\\springai\\app\\demo\\DocumentChunker.java"}</code></li>
</ul>
<ol start="3">
<li>第三轮：系统读取代码内容，发送给大模型</li>
</ol>
<ul>
<li>大模型返回评审结果</li>
</ul>
<p>下面是完整的返回文本，有兴趣的小伙伴可以看看</p>
<pre><code class="hljs language-markdown" lang="markdown">基于对代码的详细分析，我为您提供以下代码评审报告：

<span class="hljs-section">## 📋 代码评审报告 - DocumentChunker.java</span>

<span class="hljs-section">### ✅ <span class="hljs-strong">**优点**</span></span>

<span class="hljs-bullet">1.</span> <span class="hljs-strong">**功能完整性强**</span>：代码实现了完整的文档分块功能，包括：
<span class="hljs-bullet">   -</span> 单文档分块
<span class="hljs-bullet">   -</span> 批量文档分块
<span class="hljs-bullet">   -</span> 智能语义边界分割
<span class="hljs-bullet">   -</span> 重叠机制
<span class="hljs-bullet">   -</span> 长文本强制分割

<span class="hljs-bullet">2.</span> <span class="hljs-strong">**良好的文档注释**</span>：类和方法都有清晰的中文注释，说明了功能用途

<span class="hljs-bullet">3.</span> <span class="hljs-strong">**合理的默认值**</span>：提供了合理的默认参数（maxChunkSize=500, overlapSize=50）

<span class="hljs-bullet">4.</span> <span class="hljs-strong">**元数据保留**</span>：正确保留了原始文档的元数据，并添加了块相关的元数据

<span class="hljs-section">### ⚠️ <span class="hljs-strong">**需要改进的问题**</span></span>

<span class="hljs-section">#### 1. <span class="hljs-strong">**线程安全问题**</span></span>

// 问题：静态实例不是线程安全的
public static DocumentChunker DEFAULT<span class="hljs-emphasis">_CHUNKER = new DocumentChunker();

<span class="hljs-strong">**建议**</span>：使用 `volatile` 或 `AtomicReference`，或者移除静态实例让用户自己管理。

#### 2. <span class="hljs-strong">**参数验证不足**</span>

// 问题：构造函数没有参数验证
public DocumentChunker(int maxChunkSize, int overlapSize) {
    this.maxChunkSize = maxChunkSize;
    this.overlapSize = overlapSize;
}

<span class="hljs-strong">**建议**</span>：添加参数验证，确保 `maxChunkSize &gt; 0` 且 `overlapSize &lt; maxChunkSize`。

#### 3. <span class="hljs-strong">**正则表达式复杂度**</span>

// 问题：正则表达式过于复杂，难以维护
String[] sentences = text.split("(?&lt;={。})|(?&lt;=！)|(?&lt;=!)|(?&lt;=？)|(?&lt;=\\?)|(?&lt;=\\n\\n)");

<span class="hljs-strong">**建议**</span>：提取为常量或使用更清晰的方式处理多语言分隔符。

#### 4. <span class="hljs-strong">**性能优化空间**</span>

// 问题：StringBuilder操作可以优化
if (currentChunk.length() &gt; 0) {
    currentChunk.append(sentence);
} else {
    currentChunk.append(sentence);
}

<span class="hljs-strong">**建议**</span>：简化为 `currentChunk.append(sentence);`

#### 5. <span class="hljs-strong">**异常处理缺失**</span>
代码中没有处理可能的异常情况，如：
- 内存不足
- 文档过大导致性能问题

### 🔧 <span class="hljs-strong">**具体改进建议**</span>

#### 1. <span class="hljs-strong">**添加参数验证**</span>

public DocumentChunker(int maxChunkSize, int overlapSize) {
    if (maxChunkSize &lt;= 0) {
        throw new IllegalArgumentException("maxChunkSize must be positive");
    }
    if (overlapSize &gt;= maxChunkSize) {
        throw new IllegalArgumentException("overlapSize must be less than maxChunkSize");
    }
    this.maxChunkSize = maxChunkSize;
    this.overlapSize = overlapSize;
}


#### 2. <span class="hljs-strong">**线程安全改进**</span>

public static final DocumentChunker DEFAULT_</span>CHUNKER = new DocumentChunker();
// 或者移除静态实例，让用户自己管理


<span class="hljs-section">#### 3. <span class="hljs-strong">**提取常量**</span></span>

private static final String SENTENCE<span class="hljs-emphasis">_SEPARATOR_</span>PATTERN = 
<span class="hljs-code">    "(?&lt;={。})|(?&lt;=！)|(?&lt;=!)|(?&lt;=？)|(?&lt;=\\?)|(?&lt;=\\n\\n)";
</span>

<span class="hljs-section">#### 4. <span class="hljs-strong">**添加Builder模式**</span></span>
考虑使用Builder模式来更灵活地配置参数。

<span class="hljs-section">#### 5. <span class="hljs-strong">**性能优化**</span></span>

// 优化StringBuilder操作
private List<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">String</span>&gt;</span></span> splitText(String text) {
<span class="hljs-code">    List&lt;String&gt; chunks = new ArrayList&lt;&gt;();
    String[] sentences = text.split(SENTENCE_SEPARATOR_PATTERN);
    StringBuilder currentChunk = new StringBuilder();
    
    for (String sentence : sentences) {
        if (sentence.trim().isEmpty()) continue;
        
        if (currentChunk.length() + sentence.length() &lt;= maxChunkSize) {
            currentChunk.append(sentence);
        } else {
            // 处理块分割逻辑
        }
    }
    // ...
}
</span>

<span class="hljs-section">### 🎯 <span class="hljs-strong">**总体评价**</span></span>

这是一个功能完整、设计合理的文档分块工具类，主要问题集中在线程安全、参数验证和代码可维护性方面。通过上述改进，可以显著提升代码的健壮性和可维护性。

<span class="hljs-strong">**建议优先级**</span>：
<span class="hljs-bullet">1.</span> 高优先级：参数验证、线程安全
<span class="hljs-bullet">2.</span> 中优先级：性能优化、代码简化
<span class="hljs-bullet">3.</span> 低优先级：Builder模式、异常处理
</code></pre>
<h2 data-id="heading-10">三、小结</h2>
<p>SpringAI的Agent开发范式配合Skills机制，非常简单就实现了AI应用的工程化。整个过程实现下来，门槛还是比较低的。 不得不高喊一声：<code>Spring🐂🍺</code></p>
<p>实现方式虽然简单，但是这个背后的设计哲学、开发思维的转变，还是很值得我们学习参考的——在AI时代，如何将我们现有的技能（如可复用、模块化思设计等）转变到大模型应用开发，这可能是我们每一个<code>旧时代</code>程序员最大的财富。</p>
<p>那么这一套是怎么实现的呢？</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5dc77a4aac3c4c9da90d93f6be1fa000~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiA54Gw54Gw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770172382&amp;x-signature=bmCKCp0qwhnrbxjLL4YQa%2FXIZ3U%3D" alt="" loading="lazy"/></p>
<p>Spring AI采用基于工具的集成方法，通过实现各种工具，使任何LLM都能回调执行，Skills的运行过程，通常是下面三步：</p>
<ol>
<li>发现（启动阶段）</li>
</ol>
<ul>
<li>通过<code>SKILL.md</code>文件中的元数据，快速实现技能的安装注册</li>
</ul>
<ol start="2">
<li>语义匹配（对话过程中）</li>
</ol>
<ul>
<li>当用户发出请求时，LLM 会检查工具定义中嵌入的技能描述。如果 LLM 判断用户请求在语义上与某个技能的描述匹配，则会调用该技能工具，并将技能名称作为参数传递给它。</li>
</ul>
<ol start="3">
<li>执行（技能调用时）</li>
</ol>
<ul>
<li>当调用技能工具时，SkillsTool会从磁盘加载完整的SKILL.md内容，并将其与技能的基础目录路径一起返回给大型语言模型（LLM）。然后，LLM会按照技能内容中的指令执行。如果技能引用了其他文件或辅助脚本，LLM会使用<code>FileSystemTools</code>的<code>Read</code>函数或<code>ShellTools</code>的<code>Bash</code>函数来按需访问它们</li>
</ul>
<hr/>
<p>项目源码：</p>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fliuyueyi%2Fspring-ai-demo%2Ftree%2Fmaster%2Fv2%2FT01-agentic-skills-simple-design" target="_blank" title="https://github.com/liuyueyi/spring-ai-demo/tree/master/v2/T01-agentic-skills-simple-design" ref="nofollow noopener noreferrer">github.com/liuyueyi/sp…</a></li>
</ul>
<p>零基础入门：</p>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FqCn8x2XO2shA8MheYbHq0w" target="_blank" title="https://mp.weixin.qq.com/s/qCn8x2XO2shA8MheYbHq0w" ref="nofollow noopener noreferrer">LLM 应用开发是什么：零基础也可以读懂的科普文(极简版)</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2F2GXBNOUq3jlysipftz8TpA" target="_blank" title="https://mp.weixin.qq.com/s/2GXBNOUq3jlysipftz8TpA" ref="nofollow noopener noreferrer">大模型应用开发系列教程：序-为什么你“会用 LLM”，但做不出复杂应用？</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2Fv-z6EHY300ElOxdGPdzc0w" target="_blank" title="https://mp.weixin.qq.com/s/v-z6EHY300ElOxdGPdzc0w" ref="nofollow noopener noreferrer">大模型应用开发系列教程：第一章LLM到底在做什么？</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2Ft_BuAW9i0npcaJdua3Am2Q" target="_blank" title="https://mp.weixin.qq.com/s/t_BuAW9i0npcaJdua3Am2Q" ref="nofollow noopener noreferrer">大模型应用开发系列教程：第二章 模型不是重点，参数才是你真正的控制面板</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2Fvzt0bGwcfnASOiBa0Kc7VQ" target="_blank" title="https://mp.weixin.qq.com/s/vzt0bGwcfnASOiBa0Kc7VQ" ref="nofollow noopener noreferrer">大模型应用开发系列教程：第三章 为什么我的Prompt表现很糟？</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FNk-N34TLJVCTI5F4k5rGaQ" target="_blank" title="https://mp.weixin.qq.com/s/Nk-N34TLJVCTI5F4k5rGaQ" ref="nofollow noopener noreferrer">大模型应用开发系列教程：第四章Prompt 的工程化结构设计</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FZQbztqBq7_PzynG06N4-mg" target="_blank" title="https://mp.weixin.qq.com/s/ZQbztqBq7_PzynG06N4-mg" ref="nofollow noopener noreferrer">大模型应用开发系列教程：第五章 从 Prompt 到 Prompt 模板与工程治理</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FnnKspRO87xbrn4-LBV3RNA" target="_blank" title="https://mp.weixin.qq.com/s/nnKspRO87xbrn4-LBV3RNA" ref="nofollow noopener noreferrer">大模型应用开发系列教程：第六章 上下文窗口的真实边界</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2F_5D2tF6CPnafj5mlmlwLNw" target="_blank" title="https://mp.weixin.qq.com/s/_5D2tF6CPnafj5mlmlwLNw" ref="nofollow noopener noreferrer">大模型应用开发系列教程：第七章：从 “堆上下文” 到 “管理上下文”</a></li>
</ul>
<hr/>
<p>实战</p>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2F96rHyp_gBUgmA2dhSbzNww" target="_blank" title="https://mp.weixin.qq.com/s/96rHyp_gBUgmA2dhSbzNww" ref="nofollow noopener noreferrer">大模型应用开发实战：两百行实现一个自然语言地址提取智能体</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FSnXdTB6tYqAzG7HgbnTSAQ" target="_blank" title="https://mp.weixin.qq.com/s/SnXdTB6tYqAzG7HgbnTSAQ" ref="nofollow noopener noreferrer">大模型应用开发实战：基于SpringAI与大模型的零配置发票智能提取架构</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FNHqLJbos-_nrxNNmhg7IBQ" target="_blank" title="https://mp.weixin.qq.com/s/NHqLJbos-_nrxNNmhg7IBQ" ref="nofollow noopener noreferrer">实战 | 零基础搭建知识库问答机器人：基于SpringAI+RAG的完整实现</a></li>
</ul>
<p>参考：</p>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fspring.io%2Fblog%2F2026%2F01%2F13%2Fspring-ai-generic-agent-skills" target="_blank" title="https://spring.io/blog/2026/01/13/spring-ai-generic-agent-skills" ref="nofollow noopener noreferrer">Spring AI Agentic Patterns (Part 1): Agent Skills - Modular, Reusable Capabilities</a></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[3d拼图我不会，老板：用Cocos做个会动的拼图总可以了吧！]]></title>    <link>https://juejin.cn/post/7599910677578973184</link>    <guid>https://juejin.cn/post/7599910677578973184</guid>    <pubDate>2026-01-28T00:50:27.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7599910677578973184" data-draft-id="7599873006258831394" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="3d拼图我不会，老板：用Cocos做个会动的拼图总可以了吧！"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2026-01-28T00:50:27.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="亿元程序员"/> <meta itemprop="url" content="https://juejin.cn/user/1972988307323236"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            3d拼图我不会，老板：用Cocos做个会动的拼图总可以了吧！
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1972988307323236/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    亿元程序员
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-28T00:50:27.000Z" title="Wed Jan 28 2026 00:50:27 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-28
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cace3d14b8194b2bb9d818a6c2315b68~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770166227&amp;x-signature=tg%2Fk8SnxYY%2FgEJ4PdU2GWsSoxM4%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-0">引言</h2>
<p><strong>哈喽大家好</strong>，我是亿元程序员，上次老板让做<code>3d</code>拼图的那个小伙伴又双叒叕来了：</p>
<blockquote>
<p><strong>亿哥</strong>，我又双叒叕来了，<code>3d</code>拼图太难了，我这没有经验实在做不出来（捂脸）。</p>
<p><strong>幸好</strong>老板没有一意孤行，但是无论如何都让我做个变种的拼图出来：做个会动的<code>spine</code>拼图总可以了吧！</p>
<p><strong>大佬</strong>给我支支招，<code>spine</code>可以动态分割吗？</p>
</blockquote>
<p><strong>spine骨骼动画？</strong>，果然人的思维能力是无穷无尽的，一个拼图游戏都玩出花了。</p>
<p><strong>spine</strong>动态分割的方法应该有很多，笔者想到了通过<code>RTT</code>的方法。</p>
<p><strong>言归正传</strong>，本期带大家一起来看看，在<code>Cocos</code>游戏开发中，<strong>如何通过RTT动态分割spine骨骼动画</strong>。</p>
<p><strong>本文源工程可在文末获取，小伙伴们自行前往。</strong></p>
<h2 data-id="heading-1">什么是RTT？</h2>
<blockquote>
<p><strong>RenderToTexture</strong>是将场景 / 节点的渲染结果输出到一张纹理（Texture） 而非直接显示在屏幕上。</p>
<p><strong>你可以</strong>把它理解成“给指定的游戏内容拍一张‘数字照片’，并把这张照片保存成可复用的纹理资源”。</p>
</blockquote>
<p><strong>我们</strong>可以通过<code>RTT</code>动态将<code>spine动画</code>渲染到纹理上，然后通过<code>Sprite</code>显示出来。</p>
<p><strong>那么问题来了，我们如何在游戏开发中使用RTT？</strong></p>
<h2 data-id="heading-2">RTT的使用</h2>
<p><strong>1.资源准备</strong></p>
<p><strong>既然是</strong>动态分割<code>spine</code>动画，我们需要准备一个<code>spine</code>动画，大家熟悉的：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c6721399d1ae45a4ae8755a9807ffb88~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770166227&amp;x-signature=1fVL%2F%2FAW0qYtoHpoH%2BNqHXgpTMk%3D" alt="" loading="lazy"/></p>
<p><strong>直接运行</strong>就能看到效果：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ce26c11173184e94b397cb1d666a423c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770166227&amp;x-signature=6uFRT745MwTTZKoE2x8Inlz7Fow%3D" alt="" loading="lazy"/></p>
<p><strong>2.创建渲染纹理</strong></p>
<p><strong>我们</strong>可以通过资源管理器<code>assets</code>目录右键创建一个渲染纹理(<code>RenderTexture</code>)：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4ea3d153014d43baad593962b40c3e08~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770166227&amp;x-signature=lIBFe9I6UFSuEI4S8XVXzZLMpiw%3D" alt="" loading="lazy"/></p>
<p><strong>调整</strong>合适的大小。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cee1053818b549148a04316ee5e9eef0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770166227&amp;x-signature=C2aFjr6Koq9hZsGV4ngZ6y1UsZw%3D" alt="" loading="lazy"/></p>
<p><strong>3.创建相机</strong></p>
<p><strong>我们</strong>需要借助相机，把相机的画面渲染到渲染纹理，于是我们在<code>spine</code>节点下创建一个：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9519e516785b441f93253d11fec6d625~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770166227&amp;x-signature=mHw8zF1AbD5unOIiAkI8e1wxwRU%3D" alt="" loading="lazy"/></p>
<p><strong>修改</strong>相机的<code>Visibility</code>属性去掉<code>DEFAULT</code>，否者会有警告。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/210722ff9ee84c3495be3eb6c03fd214~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770166227&amp;x-signature=qN6LX1L03H6WJXZvADCX%2BIcHLlw%3D" alt="" loading="lazy"/></p>
<p><strong>然后</strong>在属性面板调整位置、正交大小等参数，让相机完全拍到<code>spine</code>动画，把背景颜色设置成白色便于观看区分。</p>
<p><strong>设置</strong><code>Target Texture</code>为我们刚创建的<code>RenderTexture</code>：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f8e2fe59c2c84513aa4823336d681ff9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770166227&amp;x-signature=5JFwK3%2BrnsibB%2FgJOx14%2FhmyEag%3D" alt="" loading="lazy"/></p>
<p><strong>为了</strong>避免<code>spine</code>动画被原相机拍到，我们可以调整位置，将它移出到画面外：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b49815b14ef24d34bca62688469d9b31~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770166227&amp;x-signature=56pL4Pzts7QhkEK3H%2BBvcIfCy1k%3D" alt="" loading="lazy"/></p>
<p><strong>4.创建Sprite</strong></p>
<p><strong>我们</strong>可以直接把<code>RenderTexture</code>拖到场景中，会自动创建一个<code>Sprite</code>组件，并且自动将<code>RenderTexture</code>作为图片资源。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b22a28832efc4827bb169e63c3399fa3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770166227&amp;x-signature=lradT3TzRVPFDntaw0y9OB%2FhFm8%3D" alt="" loading="lazy"/></p>
<p><strong>属性</strong>如下：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/48ba13a42c274b09a1bd31d38469d410~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770166227&amp;x-signature=JeM58aozWuVUOWupE8XXBtVOcDQ%3D" alt="" loading="lazy"/></p>
<p><strong>5.查看效果</strong></p>
<p><strong>直接运行</strong>就能看到效果：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c7b0c49c5ccc468baaa29aa5e9177df0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770166227&amp;x-signature=HeXQob%2B8E5FrdNewfR3RSSea8lk%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-3">动态分割</h2>
<p><strong>有了</strong><code>SpriteFrame</code>之后，我们就可以按照之前动态分割图片的逻辑进行分割了。</p>
<p><strong>首先</strong>创建一个脚本，拿到<code>Sprite</code>引用，定义行列数和间隙：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f856e95a54d14692a059e756d7447c7c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770166227&amp;x-signature=WL79%2BW3Az1Dm8B4m74yxRCID9pU%3D" alt="" loading="lazy"/></p>
<p><strong>然后</strong>按照之前动态分割拼图的原理分割即可：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f5a87a8eae0f4f2092aeb66a0dd8db91~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770166227&amp;x-signature=g2JvVa%2BEEodMcBXfdV4JE7oRobk%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-4">效果演示</h2>
<p><strong>最终效果</strong>如下，可以看到<code>spine</code>已经被成功分割，剩下游戏逻辑因为和之前一样，我们就不重复了：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c02508c92c894562a2e7f7cc30a0bc9f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770166227&amp;x-signature=lElBjnENmddCSsbF63rAwRk1JOA%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-5">结语</h2>
<p><strong>这样的动态拼图</strong>市面上好像还没有，会成为下一个变种的模仿对象吗？</p>
<p><strong>小伙伴们</strong>，你们都学会了吗？</p>
<p><strong>本文完整源码</strong>可以点赞后通过私信<code>puzzlespine</code>获取。</p>
<p><strong>更多实用源码</strong>可以通过<a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FFOi5gCiGzF3LnT03DpPMXA" target="_blank" title="https://mp.weixin.qq.com/s/FOi5gCiGzF3LnT03DpPMXA" ref="nofollow noopener noreferrer">亿元Cocos小游戏实战合集</a>获取，感谢支持。</p>
<hr/>
<p><strong>我是"亿元程序员"，一位有着8年游戏行业经验的主程。在游戏开发中，希望能给到您帮助, 也希望通过您能帮助到大家。</strong></p>
<p>AD:笔者线上的小游戏《打螺丝闯关》《贪吃蛇掌机经典》《重力迷宫球》《填色之旅》《方块掌机经典》大家可以自行点击搜索体验。</p>
<p>实不相瞒，想要个<strong>赞</strong>和<strong>爱心</strong>！请把该文章<strong>分享</strong>给你觉得有需要的其他小伙伴。谢谢！</p>
<p>推荐文章：</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FFOi5gCiGzF3LnT03DpPMXA" target="_blank" title="https://mp.weixin.qq.com/s/FOi5gCiGzF3LnT03DpPMXA" ref="nofollow noopener noreferrer">亿元Cocos小游戏实战合集</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FXLCknL3fJDubec2GW6KLFA" target="_blank" title="https://mp.weixin.qq.com/s/XLCknL3fJDubec2GW6KLFA" ref="nofollow noopener noreferrer">Cocos游戏如何接入安卓穿山甲广告变现？</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2F3_VrSld4KnDKY_7hxjSoKg" target="_blank" title="https://mp.weixin.qq.com/s/3_VrSld4KnDKY_7hxjSoKg" ref="nofollow noopener noreferrer">你知道和不知道的微信小游戏常用API整理，赶紧收藏用起来~</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2F0Lj24VHJ-pL8z82hHqQLiA" target="_blank" title="https://mp.weixin.qq.com/s/0Lj24VHJ-pL8z82hHqQLiA" ref="nofollow noopener noreferrer">Cocos游戏如何快速接入抖音小游戏广告变现？</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FZ7DusUJA2v1IFZDFtBsueg" target="_blank" title="https://mp.weixin.qq.com/s/Z7DusUJA2v1IFZDFtBsueg" ref="nofollow noopener noreferrer">如何在CocosCreator3.8中实现割绳子游戏效果</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2F3BzzFBzeVAO-a6LPTeFTrA" target="_blank" title="https://mp.weixin.qq.com/s/3BzzFBzeVAO-a6LPTeFTrA" ref="nofollow noopener noreferrer">如何在CocosCreator3.8中实现动态切割模型？</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FZIph332u_r24OTY4r6_jow" target="_blank" title="https://mp.weixin.qq.com/s/ZIph332u_r24OTY4r6_jow" ref="nofollow noopener noreferrer">Cocos游戏开发中的贴花效果</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[TypeScript 类型体操练习笔记（一）]]></title>    <link>https://juejin.cn/post/7600341731048030243</link>    <guid>https://juejin.cn/post/7600341731048030243</guid>    <pubDate>2026-01-29T07:51:51.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600341731048030243" data-draft-id="7590054976489455656" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="TypeScript 类型体操练习笔记（一）"/> <meta itemprop="keywords" content="TypeScript"/> <meta itemprop="datePublished" content="2026-01-29T07:51:51.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="我不吃饼干"/> <meta itemprop="url" content="https://juejin.cn/user/3263006241480605"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            TypeScript 类型体操练习笔记（一）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3263006241480605/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    我不吃饼干
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-29T07:51:51.000Z" title="Thu Jan 29 2026 07:51:51 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    5
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读21分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body cache result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden;color:#333}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin:30px 0 10px;color:#cca152;position:relative;padding-left:50px;border-bottom:2px solid rgba(209,163,78,.6);padding-bottom:0}.markdown-body h1{font-size:30px}.markdown-body h1:before{content:"";width:50px;height:42px;display:block;position:absolute;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACcAAAAhBAMAAACo1K8bAAAABGdBTUEAALGPC/xhBQAAAAFzUkdCAK7OHOkAAAFZaVRYdFhNTDpjb20uYWRvYmUueG1wAAAAAAA8eDp4bXBtZXRhIHhtbG5zOng9ImFkb2JlOm5zOm1ldGEvIiB4OnhtcHRrPSJYTVAgQ29yZSA1LjQuMCI+CiAgIDxyZGY6UkRGIHhtbG5zOnJkZj0iaHR0cDovL3d3dy53My5vcmcvMTk5OS8wMi8yMi1yZGYtc3ludGF4LW5zIyI+CiAgICAgIDxyZGY6RGVzY3JpcHRpb24gcmRmOmFib3V0PSIiCiAgICAgICAgICAgIHhtbG5zOnRpZmY9Imh0dHA6Ly9ucy5hZG9iZS5jb20vdGlmZi8xLjAvIj4KICAgICAgICAgPHRpZmY6T3JpZW50YXRpb24+MTwvdGlmZjpPcmllbnRhdGlvbj4KICAgICAgPC9yZGY6RGVzY3JpcHRpb24+CiAgIDwvcmRmOlJERj4KPC94OnhtcG1ldGE+CkzCJ1kAAAAJcEhZcwAACxMAAAsTAQCanBgAAAAnUExURUdwTMyhUsqkUMyhUsyiUcyhUsyhUsyhUcyhUsyhUs2hUtytWNWoVX44si8AAAAKdFJOUwD8Bfcge95QncCWSSDAAAABh0lEQVQoz2WSPUvDQBjHjyPSOB7drh2OUOs36NA6pKAFwaEo4tDFIUWxGYLgKw4BEYUuHaQg7XJ0kccsUmrT2qUUQZp8KO/y1hSfIYEf/5eHu0MoGU1+sIbSw5Bypd92S+dWWrd34b15vuOPY4QxuvtYZp0lIVk3Zgjt+5zkh12AvBHnbW85BOjXySPwhc5CYcY0OdDh5dEUqIEj4cN8Dty3a1MqYJS4MaWU5wzVLwMMxqGSNQgA/VFa4gf50yhxSUW+db8ACa2gBxfnABVDFYHCPYrc7TLwCepJM8/ZoVsRwpxdHEozHUXd6idwVzFFM5BFmIhQVQjrNdnCvdd48wblI2VHtsAZioSsTYVwLoXvjMXH1icuNgPhQE+Ot1+xi8HeA3d1Df1f1JPVUOmsYLujBjuSySqSXYt+yTwbJ0pcyIhqTrxkn0BazRLizJosxRBued+z0jPD6VewOXl5utHRGmMNK3k0iTkzxpq2/oIQO6gLprF12kT/R20eyzlcg7iwK0dPsz/ibpdsCHweWwAAAABJRU5ErkJggg==) 0 0 no-repeat;background-size:80%;bottom:-10px;left:-2px}.markdown-body h2{font-size:24px}.markdown-body h2:before{content:"";width:50px;height:42px;display:block;position:absolute;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACcAAAAhBAMAAACo1K8bAAAABGdBTUEAALGPC/xhBQAAAAFzUkdCAK7OHOkAAAFZaVRYdFhNTDpjb20uYWRvYmUueG1wAAAAAAA8eDp4bXBtZXRhIHhtbG5zOng9ImFkb2JlOm5zOm1ldGEvIiB4OnhtcHRrPSJYTVAgQ29yZSA1LjQuMCI+CiAgIDxyZGY6UkRGIHhtbG5zOnJkZj0iaHR0cDovL3d3dy53My5vcmcvMTk5OS8wMi8yMi1yZGYtc3ludGF4LW5zIyI+CiAgICAgIDxyZGY6RGVzY3JpcHRpb24gcmRmOmFib3V0PSIiCiAgICAgICAgICAgIHhtbG5zOnRpZmY9Imh0dHA6Ly9ucy5hZG9iZS5jb20vdGlmZi8xLjAvIj4KICAgICAgICAgPHRpZmY6T3JpZW50YXRpb24+MTwvdGlmZjpPcmllbnRhdGlvbj4KICAgICAgPC9yZGY6RGVzY3JpcHRpb24+CiAgIDwvcmRmOlJERj4KPC94OnhtcG1ldGE+CkzCJ1kAAAAJcEhZcwAACxMAAAsTAQCanBgAAAAnUExURUdwTMyhUsqkUMyhUsyiUcyhUsyhUsyhUcyhUsyhUs2hUtytWNWoVX44si8AAAAKdFJOUwD8Bfcge95QncCWSSDAAAABh0lEQVQoz2WSPUvDQBjHjyPSOB7drh2OUOs36NA6pKAFwaEo4tDFIUWxGYLgKw4BEYUuHaQg7XJ0kccsUmrT2qUUQZp8KO/y1hSfIYEf/5eHu0MoGU1+sIbSw5Bypd92S+dWWrd34b15vuOPY4QxuvtYZp0lIVk3Zgjt+5zkh12AvBHnbW85BOjXySPwhc5CYcY0OdDh5dEUqIEj4cN8Dty3a1MqYJS4MaWU5wzVLwMMxqGSNQgA/VFa4gf50yhxSUW+db8ACa2gBxfnABVDFYHCPYrc7TLwCepJM8/ZoVsRwpxdHEozHUXd6idwVzFFM5BFmIhQVQjrNdnCvdd48wblI2VHtsAZioSsTYVwLoXvjMXH1icuNgPhQE+Ot1+xi8HeA3d1Df1f1JPVUOmsYLujBjuSySqSXYt+yTwbJ0pcyIhqTrxkn0BazRLizJosxRBued+z0jPD6VewOXl5utHRGmMNK3k0iTkzxpq2/oIQO6gLprF12kT/R20eyzlcg7iwK0dPsz/ibpdsCHweWwAAAABJRU5ErkJggg==) 0 0 no-repeat;background-size:70%;bottom:-15px;left:-1px}.markdown-body h3{font-size:18px}.markdown-body h3:before{content:"";width:50px;height:42px;display:block;position:absolute;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACcAAAAhBAMAAACo1K8bAAAABGdBTUEAALGPC/xhBQAAAAFzUkdCAK7OHOkAAAFZaVRYdFhNTDpjb20uYWRvYmUueG1wAAAAAAA8eDp4bXBtZXRhIHhtbG5zOng9ImFkb2JlOm5zOm1ldGEvIiB4OnhtcHRrPSJYTVAgQ29yZSA1LjQuMCI+CiAgIDxyZGY6UkRGIHhtbG5zOnJkZj0iaHR0cDovL3d3dy53My5vcmcvMTk5OS8wMi8yMi1yZGYtc3ludGF4LW5zIyI+CiAgICAgIDxyZGY6RGVzY3JpcHRpb24gcmRmOmFib3V0PSIiCiAgICAgICAgICAgIHhtbG5zOnRpZmY9Imh0dHA6Ly9ucy5hZG9iZS5jb20vdGlmZi8xLjAvIj4KICAgICAgICAgPHRpZmY6T3JpZW50YXRpb24+MTwvdGlmZjpPcmllbnRhdGlvbj4KICAgICAgPC9yZGY6RGVzY3JpcHRpb24+CiAgIDwvcmRmOlJERj4KPC94OnhtcG1ldGE+CkzCJ1kAAAAJcEhZcwAACxMAAAsTAQCanBgAAAAnUExURUdwTMyhUsqkUMyhUsyiUcyhUsyhUsyhUcyhUsyhUs2hUtytWNWoVX44si8AAAAKdFJOUwD8Bfcge95QncCWSSDAAAABh0lEQVQoz2WSPUvDQBjHjyPSOB7drh2OUOs36NA6pKAFwaEo4tDFIUWxGYLgKw4BEYUuHaQg7XJ0kccsUmrT2qUUQZp8KO/y1hSfIYEf/5eHu0MoGU1+sIbSw5Bypd92S+dWWrd34b15vuOPY4QxuvtYZp0lIVk3Zgjt+5zkh12AvBHnbW85BOjXySPwhc5CYcY0OdDh5dEUqIEj4cN8Dty3a1MqYJS4MaWU5wzVLwMMxqGSNQgA/VFa4gf50yhxSUW+db8ACa2gBxfnABVDFYHCPYrc7TLwCepJM8/ZoVsRwpxdHEozHUXd6idwVzFFM5BFmIhQVQjrNdnCvdd48wblI2VHtsAZioSsTYVwLoXvjMXH1icuNgPhQE+Ot1+xi8HeA3d1Df1f1JPVUOmsYLujBjuSySqSXYt+yTwbJ0pcyIhqTrxkn0BazRLizJosxRBued+z0jPD6VewOXl5utHRGmMNK3k0iTkzxpq2/oIQO6gLprF12kT/R20eyzlcg7iwK0dPsz/ibpdsCHweWwAAAABJRU5ErkJggg==) 0 0 no-repeat;background-size:60%;bottom:-19px;left:-2px}.markdown-body h4{font-size:16px;padding-left:0;border-bottom:1px solid rgba(209,163,78,.6)}.markdown-body h5{font-size:15px;padding-left:0}.markdown-body em{color:#cca152}.markdown-body del{text-decoration-color:#cca152;text-decoration-thickness:2px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:80%;margin:6px auto;box-shadow:0 6px 15px #8e8e8e;display:block;margin:20px auto!important;object-fit:contain;border-radius:8px}.markdown-body hr{border:none;border-top:2px solid #e0c9a1;margin-top:32px 0}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background:#f6efde;color:#b69454;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Mono,Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75;background:#fef6e1;border-radius:4px;box-shadow:0 0 8px hsla(0,0%,47%,.45)}.markdown-body pre:before{content:"";display:block;height:30px;width:100%;margin-bottom:-7px;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADIAAAAOCAMAAABaWb9VAAAABGdBTUEAALGPC/xhBQAAAAFzUkdCAK7OHOkAAAFZaVRYdFhNTDpjb20uYWRvYmUueG1wAAAAAAA8eDp4bXBtZXRhIHhtbG5zOng9ImFkb2JlOm5zOm1ldGEvIiB4OnhtcHRrPSJYTVAgQ29yZSA1LjQuMCI+CiAgIDxyZGY6UkRGIHhtbG5zOnJkZj0iaHR0cDovL3d3dy53My5vcmcvMTk5OS8wMi8yMi1yZGYtc3ludGF4LW5zIyI+CiAgICAgIDxyZGY6RGVzY3JpcHRpb24gcmRmOmFib3V0PSIiCiAgICAgICAgICAgIHhtbG5zOnRpZmY9Imh0dHA6Ly9ucy5hZG9iZS5jb20vdGlmZi8xLjAvIj4KICAgICAgICAgPHRpZmY6T3JpZW50YXRpb24+MTwvdGlmZjpPcmllbnRhdGlvbj4KICAgICAgPC9yZGY6RGVzY3JpcHRpb24+CiAgIDwvcmRmOlJERj4KPC94OnhtcG1ldGE+CkzCJ1kAAAAJcEhZcwAADsQAAA7EAZUrDhsAAACHUExURUdwTMxCKdc8NvdYT/9hVyLJPABBAGubKNiIOv+/K+ytJBakH9aZG+5QR5VZDOBDPhmtJ8+VGuGjH/CwJR26MR6+NBq0LPW1KBmwKetNRfJUTONHP92fHuSmIeFEPhu3LR29M/BTS+mqIuqsI5qdHyLKPP++Kv9gVf9lW//KLSXXQCTQP//FLMVm5KQAAAAldFJOUwAlPPz7+woBBPu8Mzu+FlRRKmvnweeG+Wqg6mVNXmuc1OCbmjZJWF/9AAABKklEQVQoz3WS6XaCMBCFRzAM++KGsqhtDwES3//5OtmA2uP9A9zwzRoAgBC0QgQrdA68OZsDr229YGHoIEj7Pl0ZOgjKa5lYJ4Rd1vijn3nuD4Qurjmv48o6RFyfbGDnS6DeEXZfk5ZfuBhdPb9I87ECNMh1EFJKIU6agWzaa01NbmLkxznSmmObJBkkUxrERf3i+ftRiZi7ShPCYY64UhTx1AR5CDYoMXkOKEY7GmTcTzeD/FiER68DfSLgSRqEIBoB3P8h3x8RZhBXGJGusJdD6rfCBl0YqvZNkrV9zej2cWlfJWG6fRpyM41qYH+GTPPi2yFLQYC0Qybm5o96lW77kMbcrBKtgeWTsthVamNXFF4I6x0DTPuugsVRFyYpyxzWqNvHJwed8ws7QyP1UwjNjwAAAABJRU5ErkJggg==) 10px 10px no-repeat;background-size:40px}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#fef6e1}.markdown-body a{text-decoration:none;color:#d8ac5a;border-bottom:1px solid #d8ac5a}.markdown-body a:active,.markdown-body a:hover{color:#93753f;border-color:#93753f}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f4e8c7;border-collapse:collapse}.markdown-body thead{background:rgba(255,227,176,.6588235294);text-align:left;display:table-header-group;border-bottom:1px solid rgba(255,227,176,.6588235294)}.markdown-body tbody{background:rgba(255,247,229,.3882352941)}.markdown-body td,.markdown-body th{padding:7px;line-height:24px;min-width:100px}.markdown-body blockquote{color:#bd954f;padding:1px 23px;margin:22px 0;border-left:4px solid #dcb267;background-color:#fff7e5}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol .task-list-item,.markdown-body ul .task-list-item{list-style:none}.markdown-body ol li{padding-left:6px}.markdown-body::marker{color:#dcb267}.markdown-body .contains-task-list{padding-left:0}.markdown-body .contains-task-list .task-list-item{list-style:none;position:relative}.markdown-body .contains-task-list .task-list-item input[type=checkbox]{position:relative;top:2px}.markdown-body .contains-task-list .task-list-item input[type=checkbox]:before{content:"";display:inline-block;height:12px;width:12px;position:absolute;left:-2px;top:-2px;border:2px solid #cda152;border-radius:5px}.markdown-body .contains-task-list .task-list-item input[type=checkbox]:checked{position:relative;top:2px}.markdown-body .contains-task-list .task-list-item input[type=checkbox]:checked:before{border:none;content:"";display:inline-block;height:17px;width:17px;position:absolute;left:-2px;top:-2px;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAFo9M/3AAAAAXNSR0IArs4c6QAAAYhJREFUOBFjYACC0/MDGsDEiyvr/zOCeUwMJxn/A8HZRUEMYBFGJsZ6kFoQYALiAyAGCgDpA+sFijKeWRj4H1kWpIWBW1SDQcm+BCzOAiK/vr7BcO/gDbAAI4hE1waWgRBnmWCGIwkyKFjnwow0BhsJk9QLncvw5dV1oPE9MCEGmBWrgCKhcFEowyR+PSNYwemFAZ4M/xjMkRWYJm5oAPFB/joDpI1BHHQANgGPDxj+//vfCA4IdJ3GcevgQnAFhlHLwYIgSVA0wABcwY3tFQzokiBFGIEP0wmigW5wZAK5FFkQib0a6NUDcEmgb7AGFpIGZOZqoMFhIAFQknEAJpn9yLLEssFOBCp2IFaDkl0xg6C8FbJyB3gowUS5RdQYBORQYpVB1iwVHIIMwJh///AYTCmYRklNIBFmNi4GeYt0BhnjeIa3dw8wSBlEgDUhxw2yCRgGfHp2geHiqiSwUwUVrFAiFVkjjA1LrjgTHEwhFvosMCZM4NEIUoAtWWNoBGZ70/gN22HiAD2uhAzsYNBZAAAAAElFTkSuQmCC) 0 0 no-repeat;background-size:100%}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="atelier-seaside-light">.hljs-comment,.hljs-quote{color:#687d68}.hljs-attribute,.hljs-link,.hljs-name,.hljs-regexp,.hljs-selector-class,.hljs-selector-id,.hljs-tag,.hljs-template-variable,.hljs-variable{color:#e6193c}.hljs-built_in,.hljs-builtin-name,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-type{color:#87711d}.hljs-bullet,.hljs-string,.hljs-symbol{color:#29a329}.hljs-section,.hljs-title{color:#3d62f5}.hljs-keyword,.hljs-selector-tag{color:#ad2bee}.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#f4fbf4;color:#5e6e5e}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>2026三百题计划一（41 / 300）</p>
<p>其中标记 ※ 的是我认为比较难或者涉及新知识点的题目</p>
</blockquote>
<p><em>刷题也许没有什么意义，但是喜欢一个人思考一整天的灵光一现，也喜欢看到新奇的答案时的恍然大悟，仅此而已。</em></p>
<h2 data-id="heading-0">Easy</h2>
<h3 data-id="heading-1">1. Easy - 4 - Pick</h3>
<p>从类型 <code>T</code> 中选出符合 <code>K</code> 的属性，构造一个新的类型</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">type</span> <span class="hljs-title class_">MyPick</span>&lt;T, K <span class="hljs-keyword">extends</span> keyof T&gt; = {
  [key <span class="hljs-keyword">in</span> K]: T[key]
}
</code></pre>
<ul>
<li><code>keyof</code> 是 TypeScript 中的一个关键字，用于获取一个类型的所有属性名组成的联合类型。</li>
<li><code>extends</code> 可以用于约束泛型类型参数、定义类型继承关系和条件类型的判断。</li>
<li>在映射类型中，可以通过 <code>in</code> 关键字遍历联合类型，可以用于遍历一个类型的属性名（需要通过 <code>keyof</code> 获取属性名组成的联合类型），并对每个属性进行相应的操作。</li>
</ul>
<h3 data-id="heading-2">2. Easy - 7 - Readonly</h3>
<p>泛型 <code>Readonly&lt;T&gt;</code> 会接收一个泛型参数，并返回一个完全一样的类型，只是所有属性都会是只读 (readonly) 的。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">type</span> <span class="hljs-title class_">MyReadonly</span>&lt;T&gt; = {
  <span class="hljs-keyword">readonly</span> [key <span class="hljs-keyword">in</span> keyof T]: T[key];
}
</code></pre>
<ul>
<li>在 TypeScript 中，可以使用 readonly 修饰符来指定一个只读属性。</li>
</ul>
<h3 data-id="heading-3">3. Easy - 11 - Tuple to Object</h3>
<p>将一个元组类型转换为对象类型，这个对象类型的键/值和元组中的元素对应。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">type</span> <span class="hljs-title class_">TupleToObject</span>&lt;T <span class="hljs-keyword">extends</span> <span class="hljs-keyword">readonly</span> (<span class="hljs-built_in">string</span> | <span class="hljs-built_in">number</span> | <span class="hljs-built_in">symbol</span>)[]&gt; = {
 [key <span class="hljs-keyword">in</span> T[<span class="hljs-built_in">number</span>]]: key
}
</code></pre>
<ul>
<li>表示多种类型的数据，先通过 <code>(string | number | symbol)</code> 表示一个联合，然后 <code>(string | number | symbol)[]</code> 表示联合类型的数组</li>
<li>元组类型是 TypeScript 中的一种特殊数据类型，它允许我们定义一个固定长度和固定类型顺序的数组。</li>
<li>通过 <code>T[number]</code> 可以获取元组 <code>T</code> 所有成员组成的联合类型。</li>
<li>加readonly 的作用，因为测试用例定义的变量都是 <code>const</code>，<code>const</code>的作如下：</li>
</ul>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">const</span> tupleNumber = [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-string">'33'</span>] <span class="hljs-comment">// (string | number)[]</span>
<span class="hljs-keyword">const</span> tupleNumber = [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-string">'33'</span>] <span class="hljs-keyword">as</span> <span class="hljs-keyword">const</span> <span class="hljs-comment">// readonly [1, 2, "33"]</span>
</code></pre>
<h3 data-id="heading-4">4. Easy - 14 - First of Array</h3>
<p>实现一个 <code>First&lt;T&gt;</code> 泛型，它接受一个数组 <code>T</code> 并返回它的第一个元素的类型。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// 解法一：判断数组长度是否为0</span>
<span class="hljs-keyword">type</span> <span class="hljs-title class_">First</span>&lt;T <span class="hljs-keyword">extends</span> <span class="hljs-built_in">any</span>[]&gt; = T[<span class="hljs-string">'length'</span>] <span class="hljs-keyword">extends</span> <span class="hljs-number">0</span> ? <span class="hljs-built_in">never</span> : T[<span class="hljs-number">0</span>]
<span class="hljs-comment">// 解法二：判断是否为空数组</span>
<span class="hljs-keyword">type</span> <span class="hljs-title class_">First</span>&lt;T <span class="hljs-keyword">extends</span> <span class="hljs-built_in">any</span>[]&gt; = T <span class="hljs-keyword">extends</span> [] ? <span class="hljs-built_in">never</span> : T[<span class="hljs-number">0</span>]
<span class="hljs-comment">// 解法三：获取T所有元素类型组成的联合类型，如果为never证明为空数组</span>
<span class="hljs-keyword">type</span> <span class="hljs-title class_">First</span>&lt;T <span class="hljs-keyword">extends</span> <span class="hljs-built_in">any</span>[]&gt; = T[<span class="hljs-built_in">number</span>] <span class="hljs-keyword">extends</span> <span class="hljs-built_in">never</span> ? <span class="hljs-built_in">never</span> : T[<span class="hljs-number">0</span>];
<span class="hljs-comment">// 解法四：我们可以通过 keyof T 来获取类型 T 所有键的类型组合，那么如果 '0' 是 T 的键就表示 T 是一个非空数组</span>
<span class="hljs-keyword">type</span> <span class="hljs-title class_">First</span>&lt;T <span class="hljs-keyword">extends</span> <span class="hljs-built_in">any</span>[]&gt; = <span class="hljs-string">'0'</span> <span class="hljs-keyword">extends</span> keyof T ? T[<span class="hljs-number">0</span>] : <span class="hljs-built_in">never</span>;
<span class="hljs-comment">// 解法五：infer进行模式匹配</span>
<span class="hljs-keyword">type</span> <span class="hljs-title class_">First</span>&lt;T <span class="hljs-keyword">extends</span> <span class="hljs-built_in">any</span>[]&gt; = T <span class="hljs-keyword">extends</span> [infer A, ...infer _rest] ? A : <span class="hljs-built_in">never</span>
</code></pre>
<ul>
<li>在 TS 中 <code>A extends B ? C : D</code> 的意思是“如果 <code>A</code> 可以赋值给 <code>B</code>，那么类型就是 <code>C</code>，否则就是 <code>D</code>”。</li>
<li>T[0] 获取数组 <code>T</code> 下标为 0 的元素类型</li>
<li>在 TS 中，我们通过 extends 和 infer 可以实现一个类似于模式匹配的效果，</li>
<li>其中 ...infer _rest 是我们对元组类型使用的扩展运算，在这里用于表示剩余元素。</li>
</ul>
<h3 data-id="heading-5">5. Easy - 18 - Length of Tuple</h3>
<p>创建一个Length泛型，这个泛型接受一个只读的元组，返回这个元组的长度。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">type</span> <span class="hljs-title class_">Length</span>&lt;T <span class="hljs-keyword">extends</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">unknown</span>[]&gt; = T[<span class="hljs-string">'length'</span>]
</code></pre>
<ul>
<li><code>T['length']</code> 是索引访问类型，用于获取对象/数组类型的属性类型</li>
<li>对于元组（tuple），<code>length</code> 是字面量数字类型（如 3）</li>
<li>对于普通数组，<code>length</code> 是 number 类型</li>
</ul>
<h3 data-id="heading-6">6. Easy - 43 - Exclude ※</h3>
<p>从联合类型 T 中排除 U 中的类型，来构造一个新的类型。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">type</span> <span class="hljs-title class_">MyExclude</span>&lt;T, U&gt; = T <span class="hljs-keyword">extends</span> U ? <span class="hljs-built_in">never</span> : T;
</code></pre>
<ul>
<li>当 <code>T extends U ? ...</code> 中的 <code>T</code> 为联合类型时，会把联合类型中的每一个类型单独进行判断，然后再把结果组合成一个联合类型返回。</li>
<li>如果你想避免这种行为，那么使用 [] 包裹你的类型参数即可，注意在 extends 关键字的两侧都需要： <code>[T] extends [U] ? ...</code></li>
</ul>
<p>详解见 <a href="https://juejin.cn/post/7280430525700964386" target="_blank" title="https://juejin.cn/post/7280430525700964386">《TypeScript 类型体操之 Exclude》</a></p>
<h3 data-id="heading-7">7. Easy - 189 - Awaited</h3>
<p>假如我们有一个 <code>Promise</code> 对象，这个 <code>Promise</code> 对象会返回一个类型。在 TS 中，我们用 <code>Promise</code> 中的 <code>T</code> 来描述这个 <code>Promise</code> 返回的类型。请你实现一个类型，可以获取这个类型。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">interface</span> <span class="hljs-title class_">Thenable</span>&lt;T&gt; {
  <span class="hljs-attr">then</span>: <span class="hljs-function">(<span class="hljs-params">onfulfilled: (arg: T) =&gt; <span class="hljs-built_in">any</span></span>) =&gt;</span> <span class="hljs-built_in">any</span>
}

<span class="hljs-keyword">type</span> <span class="hljs-title class_">MyAwaited</span>&lt;T <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">any</span>&gt; | <span class="hljs-title class_">Thenable</span>&lt;<span class="hljs-built_in">any</span>&gt;&gt; = T <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Promise</span>&lt;infer A&gt; | <span class="hljs-title class_">Thenable</span>&lt;infer A&gt;
  ? A <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Promise</span>&lt;infer _X&gt; | <span class="hljs-title class_">Thenable</span>&lt;infer _X&gt; ? <span class="hljs-title class_">MyAwaited</span>&lt;A&gt; : A
  : <span class="hljs-built_in">never</span>
</code></pre>
<h3 data-id="heading-8">8. Easy - 268 - IF</h3>
<p>实现一个 <code>IF</code> 类型，它接收一个条件类型 <code>C</code> ，一个判断为真时的返回类型 <code>T</code> ，以及一个判断为假时的返回类型 <code>F</code>。 <code>C</code> 只能是 <code>true</code> 或者 <code>false</code>， <code>T</code> 和 <code>F</code> 可以是任意类型。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">type</span> <span class="hljs-title class_">If</span>&lt;C <span class="hljs-keyword">extends</span> <span class="hljs-built_in">boolean</span>, T, F&gt; = C <span class="hljs-keyword">extends</span> <span class="hljs-literal">true</span> ? T : F;
</code></pre>
<p>通过 <code>C extends true</code> 来判断 C 是否为 true。</p>
<h3 data-id="heading-9">9. Easy - 533 - Concat</h3>
<p>在类型系统里实现 JavaScript 内置的 <code>Array.concat</code> 方法，这个类型接受两个参数，返回的新数组类型应该按照输入参数从左到右的顺序合并为一个新的数组。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">type</span> <span class="hljs-title class_">Concat</span>&lt;T <span class="hljs-keyword">extends</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">unknown</span>[], U <span class="hljs-keyword">extends</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">unknown</span>[]&gt; = [...T, ...U]
</code></pre>
<ul>
<li><strong>在 TS 中，扩展语法可以对元组类型使用，用法类似于在 JS 中对值的使用</strong></li>
</ul>
<h3 data-id="heading-10">10. Easy - 898 - Includes ※</h3>
<p>在类型系统里实现 JavaScript 的 <code>Array.includes</code> 方法，这个类型接受两个参数，返回的类型要么是 <code>true</code> 要么是 <code>false</code>。</p>
<p>一开始我想的是 <code>type Includes&lt;T extends readonly any[], U&gt; =  U extends T[number] ? true : false</code></p>
<p>但是 <code>extends</code> 无法保证全等，<code>  Expect&lt;Equal&lt;Includes&lt;[{}], { a: 'A' }&gt;, false&gt;&gt;</code> 比如这个 case 会失败。</p>
<p>正确答案为</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">type</span> <span class="hljs-title class_">Equal</span>&lt;X, Y&gt; = (&lt;T&gt;<span class="hljs-function">() =&gt;</span> T <span class="hljs-keyword">extends</span> X ? <span class="hljs-number">1</span> : <span class="hljs-number">2</span>) <span class="hljs-keyword">extends</span> &lt;T&gt;<span class="hljs-function">() =&gt;</span> T <span class="hljs-keyword">extends</span> Y ? <span class="hljs-number">1</span> : <span class="hljs-number">2</span>
  ? <span class="hljs-literal">true</span>
  : <span class="hljs-literal">false</span>;
<span class="hljs-keyword">type</span> <span class="hljs-title class_">Includes</span>&lt;T <span class="hljs-keyword">extends</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">unknown</span>[], U&gt; = 
  T <span class="hljs-keyword">extends</span> [infer F, ...infer <span class="hljs-title class_">Rest</span>]
    ? <span class="hljs-title class_">Equal</span>&lt;F, U&gt; <span class="hljs-keyword">extends</span> <span class="hljs-literal">true</span> ? <span class="hljs-literal">true</span> : <span class="hljs-title class_">Includes</span>&lt;<span class="hljs-title class_">Rest</span>, U&gt;
    : <span class="hljs-literal">false</span>;
</code></pre>
<ul>
<li>其中 <code>[infer F, ...infer Rest]</code> 来提取出元组中的第一个类型，然后通过递归的方式，依次判断每一个类型元素是否和 <code>U</code> 相等。</li>
<li>Equal 实现原理很复杂，暂时搞不懂，记住就行</li>
</ul>
<h3 data-id="heading-11">11. Easy - 3057 - Push</h3>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">type</span> <span class="hljs-title class_">Push</span>&lt;T <span class="hljs-keyword">extends</span> <span class="hljs-built_in">unknown</span>[], U&gt; = [...T, U]
</code></pre>
<p>做过上面的 Concat 这道题就很简单了，注意需要通过 <code>T extends unknown[]</code> 来限定 <code>T</code> 的类型，否则无法使用 <code>...T</code>。</p>
<h3 data-id="heading-12">12. Easy - 3060 - Unshift</h3>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">type</span> <span class="hljs-title class_">Unshift</span>&lt;T <span class="hljs-keyword">extends</span> <span class="hljs-built_in">unknown</span>[], U&gt; = [U, ...T]
</code></pre>
<h3 data-id="heading-13">13. Easy - 3312 - Parameters</h3>
<p>实现内置的 Parameters 类型</p>
<p>这种题目一看就是要使用 <code>infer</code> 让 T extends xxx，其中 xxx 里面通过 infer 标记出入参的类型名。不过这里一开始写错了写成了</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">type</span> <span class="hljs-title class_">MyParameters</span>&lt;T <span class="hljs-keyword">extends</span> (...<span class="hljs-attr">args</span>: <span class="hljs-built_in">any</span>[]) =&gt; <span class="hljs-built_in">any</span>&gt; = 
    T <span class="hljs-keyword">extends</span> (infer A =&gt; <span class="hljs-built_in">any</span>) ? A : <span class="hljs-built_in">never</span>
</code></pre>
<p>错误的原因：<strong>把类型当变量来用了</strong> 在做类型体操的时候已经出了很多次错误了。谨记谨记。</p>
<p>正确解法：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">type</span> <span class="hljs-title class_">MyParameters</span>&lt;T <span class="hljs-keyword">extends</span> (...<span class="hljs-attr">args</span>: <span class="hljs-built_in">any</span>[]) =&gt; <span class="hljs-built_in">any</span>&gt; = 
    T <span class="hljs-keyword">extends</span> (...<span class="hljs-attr">args</span>: infer A) =&gt; <span class="hljs-built_in">any</span> ? A :<span class="hljs-built_in">never</span>
</code></pre>
<ul>
<li>使用 <code>infer</code> 表示待推断的类型变量，由于 <code>...args</code> 本身已经是元组类型，因此 <code>infer P</code> 最终推导出的，也是元组类型。</li>
</ul>
<h2 data-id="heading-14">Medium</h2>
<h3 data-id="heading-15">14. Medium - 2 - Get Return Type 获取函数返回类型</h3>
<p>和获取参数类型的逻辑是一模一样的。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">type</span> <span class="hljs-title class_">MyReturnType</span>&lt;T&gt; = T <span class="hljs-keyword">extends</span> (...<span class="hljs-attr">args</span>: <span class="hljs-built_in">any</span>) =&gt; infer R ? R : <span class="hljs-built_in">never</span>
</code></pre>
<h3 data-id="heading-16">15. Medium - 3 - 实现 Omit *</h3>
<p>解法一，去遍历 T 中除了 K 的键。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">type</span> <span class="hljs-title class_">MyExclude</span>&lt;T, P&gt; = T <span class="hljs-keyword">extends</span> P ? <span class="hljs-built_in">never</span> : T;
<span class="hljs-keyword">type</span> <span class="hljs-title class_">MyOmit</span>&lt;T, K <span class="hljs-keyword">extends</span> keyof T&gt; = {
  [P <span class="hljs-keyword">in</span> <span class="hljs-title class_">MyExclude</span>&lt;keyof T, K&gt;]: T[key]
}
</code></pre>
<p>解法二，利用 Pick 实现，获取 T 中除了 K 的键</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">type</span> <span class="hljs-title class_">MyOmit</span>&lt;T, K <span class="hljs-keyword">extends</span> keyof T&gt; = <span class="hljs-title class_">Pick</span>&lt;T, <span class="hljs-title class_">Exclude</span>&lt;keyof T, K&gt;&gt;
</code></pre>
<p>解法三，直接实现</p>
<p>一开始我是这样想的，但是这样不对，因为不应该存在的键也会存在，只不过类型为 <code>never</code>。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">type</span> <span class="hljs-title class_">MyOmit</span>&lt;T, K <span class="hljs-keyword">extends</span> keyof T&gt; = {
  [P <span class="hljs-keyword">in</span> keyof T]: P <span class="hljs-keyword">extends</span> K ? <span class="hljs-built_in">never</span> : T[key]
}
</code></pre>
<p>要将对应的键设置为 <code>never</code></p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">type</span> <span class="hljs-title class_">MyOmit</span>&lt;T, K <span class="hljs-keyword">extends</span> keyof T&gt; = {
  [P <span class="hljs-keyword">in</span> keyof T <span class="hljs-keyword">as</span> P <span class="hljs-keyword">extends</span> K ? <span class="hljs-built_in">never</span> : P]: T[P];
};
</code></pre>
<p>注意这里的 <code>as</code> 其实是这样的 <code>[P in keyof T as (P extends K ? never : P)]: T[A]</code>，<code>as</code> 后面的 <code>P</code> 和前面的命名必须是一样的。</p>
<h3 data-id="heading-17">16. Medium - 8 - Readonly 2 对象部分属性只读</h3>
<p><code>MyReadonly2&lt;T, K&gt;</code> 在 <code>T</code> 把 <code>K</code> 包含的属性置为 <code>readonly</code> 其余不变，不传 <code>K</code> 就把所有的属性变成 <code>readonly</code>，此时同 <code>Readonly</code>。</p>
<p>重点是 <code>K</code> 可以不传，所以要赋默认值。</p>
<p>从 medium 题目开始，大家可以慢慢地把不同的类型结合起来使用了，一句话写还是比较难。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">type</span> <span class="hljs-title class_">MyReadonly2</span>&lt;T, K <span class="hljs-keyword">extends</span> keyof T = 
    keyof T&gt; = <span class="hljs-title class_">Readonly</span>&lt;<span class="hljs-title class_">Pick</span>&lt;T, K&gt;&gt; &amp; <span class="hljs-title class_">Omit</span>&lt;T, K&gt;
</code></pre>
<h3 data-id="heading-18">17. Medium - 9 - Deep Readonly 对象属性只读（递归）※</h3>
<p>题目要求：实现一个泛型 <code>DeepReadonly&lt;T&gt;</code>，它将对象的每个参数及其子对象递归地设为只读。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">type</span> <span class="hljs-title class_">DeepReadonly</span>&lt;T&gt; = {
  <span class="hljs-keyword">readonly</span> [P <span class="hljs-keyword">in</span> keyof T]: keyof T[P] <span class="hljs-keyword">extends</span> <span class="hljs-built_in">never</span> ? T[P] : <span class="hljs-title class_">DeepReadonly</span>&lt;T[P]&gt;;
};
</code></pre>
<p>这道题目最难的就是，如何判断一个类型是否需要继续递归只读，而这里最精彩的地方就是关于 <code>never</code> 的应用: <code>keyof T extends never</code> 表示检查 <code>T</code> 是否有可枚举的键。接下来问题就简单多了，如果是存在就递归调用 DeepReadonly 否则直接返回当前类型。</p>
<p>关于 <code>never</code> 的应用其实有很多，在这篇文章中，我曾经总结过一些 <a href="https://juejin.cn/post/7514244463226863625" target="_blank" title="https://juejin.cn/post/7514244463226863625">《从 Vue3 源码中了解你所不知道的 never》</a></p>
<h3 data-id="heading-19">18. Medium - 10 - Tuple to Union 元组转合集</h3>
<p>题目要求：实现泛型 <code>TupleToUnion&lt;T&gt;</code>，它返回元组所有值的合集。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">type</span> <span class="hljs-title class_">TupleToUnion</span>&lt;T <span class="hljs-keyword">extends</span> <span class="hljs-built_in">any</span>[]&gt; = T[<span class="hljs-built_in">number</span>];
</code></pre>
<p>这类题目单纯考验语法。</p>
<ul>
<li><code>T[number]</code> 使用了 <strong>索引访问类型（Indexed Access Types）</strong> 。</li>
<li>在 TypeScript 中，数组或元组的索引是数字。通过使用 <code>number</code> 关键字作为索引，TypeScript 会获取该数组/元组中 <strong>所有</strong> 数值索引位置对应的类型，并将它们组合成一个联合类型。</li>
</ul>
<h3 data-id="heading-20">19. Medium - 12 - Chainable Options 可串联构造器 ※</h3>
<p>这道题比较复杂，实现一个可以链式调用的串联构造器的类型定义。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">type</span> <span class="hljs-title class_">Chainable</span> = {
  <span class="hljs-title function_">option</span>(<span class="hljs-attr">key</span>: <span class="hljs-built_in">string</span>, <span class="hljs-attr">value</span>: <span class="hljs-built_in">any</span>): <span class="hljs-built_in">any</span>
  <span class="hljs-title function_">get</span>(): <span class="hljs-built_in">any</span>
}

<span class="hljs-keyword">const</span> result = config
  .<span class="hljs-title function_">option</span>(<span class="hljs-string">'foo'</span>, <span class="hljs-number">123</span>)
  .<span class="hljs-title function_">option</span>(<span class="hljs-string">'name'</span>, <span class="hljs-string">'type-challenges'</span>)
  .<span class="hljs-title function_">option</span>(<span class="hljs-string">'bar'</span>, { <span class="hljs-attr">value</span>: <span class="hljs-string">'Hello World'</span> })
  .<span class="hljs-title function_">get</span>()

<span class="hljs-comment">// 期望 result 的类型是：</span>
<span class="hljs-keyword">interface</span> <span class="hljs-title class_">Result</span> {
  <span class="hljs-attr">foo</span>: <span class="hljs-built_in">number</span>
  <span class="hljs-attr">name</span>: <span class="hljs-built_in">string</span>
  <span class="hljs-attr">bar</span>: {
    <span class="hljs-attr">value</span>: <span class="hljs-built_in">string</span>
  }
}
</code></pre>
<p>其中 <code>get</code> 比较简单，直接返回当前传入的类型即可。
重点是 <code>option(key: K, value: V)</code>，它会接受两个参数，然后返回一个新的 <code>Chainable&lt;X&gt;</code>。X 为 <code>T</code> 和 <code>Record&lt;K, V&gt;</code> 的联合类型。当前答案：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">type</span> <span class="hljs-title class_">Chainable</span>&lt;T = {}&gt; = {
  option&lt;K <span class="hljs-keyword">extends</span> keyof <span class="hljs-built_in">any</span>, V&gt;(<span class="hljs-attr">key</span>: K, <span class="hljs-attr">value</span>: V): <span class="hljs-title class_">Chainable</span>&lt;T &amp; <span class="hljs-title class_">Record</span>&lt;K, V&gt;&gt;
  <span class="hljs-title function_">get</span>(): T
}
</code></pre>
<p>如果不限制 <code>K</code> 的类型，会报错，因为 <code>K</code> 作为对象的键，类型必须为 <code>string | number | symbol</code>，而 <code>keyof any</code> 的结果刚好就是 <code>string | number | symbol</code>，乍一看很神奇，仔细想想也合理:&gt;。</p>
<p>但是在这个case中会报错：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">const</span> result3 = a
  .<span class="hljs-title function_">option</span>(<span class="hljs-string">'name'</span>, <span class="hljs-string">'another name'</span>)
  <span class="hljs-comment">// @ts-expect-error</span>
  .<span class="hljs-title function_">option</span>(<span class="hljs-string">'name'</span>, <span class="hljs-number">123</span>)
  .<span class="hljs-title function_">get</span>();
  
<span class="hljs-comment">/*
type Expected3 = {
  name: number;
};
*/</span>
</code></pre>
<p>这里要求传入重复的 <code>key</code> 类型时需要报错，同时存在重复的 <code>key</code> 类型时，后面的传入的类型会覆盖前面的类型。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">type</span> <span class="hljs-title class_">Chainable</span>&lt;T = {}&gt; = {
  option&lt;K <span class="hljs-keyword">extends</span> keyof <span class="hljs-built_in">any</span>, V&gt;(
    <span class="hljs-attr">key</span>: K <span class="hljs-keyword">extends</span> keyof T ? <span class="hljs-built_in">never</span> : K,
    <span class="hljs-attr">value</span>: V
  ): <span class="hljs-title class_">Chainable</span>&lt;<span class="hljs-title class_">Omit</span>&lt;T, K&gt; &amp; <span class="hljs-title class_">Record</span>&lt;K, V&gt;&gt;;
  <span class="hljs-title function_">get</span>(): T;
};
</code></pre>
<p>通过指定 <code>K</code> 的类型 <code>K extends keyof T ? never : K</code> 来限制不允许传 <code>T</code> 中已有的属性，在通过 <code>Omit&lt;T, K&gt;</code> 保证 <code>T</code> 中重复属性被覆盖。</p>
<h3 data-id="heading-21">20. Medium - 15 - Last of Array 最后一个元素</h3>
<p>实现一个 <code>Last&lt;T&gt;</code> 泛型，它接受一个数组 <code>T</code> 并返回其最后一个元素的类型。</p>
<p>这道题不难，但是有一些有趣的解法：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">type</span> <span class="hljs-title class_">Last</span>&lt;T <span class="hljs-keyword">extends</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">any</span>[]&gt; = T <span class="hljs-keyword">extends</span> [...infer _, infer L]
  ? <span class="hljs-title class_">Last</span>
  : <span class="hljs-built_in">never</span>;
</code></pre>
<p>这是最直观的解法，<code>[...infer _, infer L]</code> 是 TS 的数组模式匹配。它尝试将数组分为两部分：前面的任意个元素（<code>_</code>）和最后一个元素（<code>L</code>），如果匹配成功，就直接返回 <code>L</code>。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">type</span> <span class="hljs-title class_">Last</span>&lt;T <span class="hljs-keyword">extends</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">any</span>[]&gt; = T <span class="hljs-keyword">extends</span> [infer <span class="hljs-title class_">Only</span>]
  ? <span class="hljs-title class_">Only</span>
  : T <span class="hljs-keyword">extends</span> [<span class="hljs-built_in">any</span>, ...infer <span class="hljs-title class_">Rest</span>]
  ? <span class="hljs-title class_">Last</span>&lt;<span class="hljs-title class_">Rest</span>&gt;
  : T[<span class="hljs-number">0</span>];
</code></pre>
<p>尝试通过递归获取最后一个元素，注意一定要先判断数组是否只有一个元素，否则只有一个元素的时候，<code>Rest</code> 会被匹配为 <code>[]</code> 我们就无法拿到最后一个元素了。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">type</span> <span class="hljs-title class_">Last</span>&lt;T <span class="hljs-keyword">extends</span> <span class="hljs-built_in">any</span>[]&gt; = [<span class="hljs-built_in">any</span>, ...T][T[<span class="hljs-string">'length'</span>]];
</code></pre>
<p>很天才的解法，我想通过 <code>T['length' - 1]</code> 来获取最后一个元素，但是 TS 的类型无法被计算，这种解法是反向思维，在数组的最前面加一个元素，这样 <code>length</code> 对应的就是最后一个类型元素了。</p>
<h3 data-id="heading-22">21. Medium - 16 - Pop 排除最后一项</h3>
<p>实现一个泛型 <code>Pop&lt;T&gt;</code>，它接受一个数组 <code>T</code>，并返回一个由数组 <code>T</code> 的前 N-1 项（N 为数组 <code>T</code> 的长度）以相同的顺序组成的数组。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">type</span> <span class="hljs-title class_">Pop</span>&lt;T <span class="hljs-keyword">extends</span> <span class="hljs-built_in">any</span>[]&gt; = T <span class="hljs-keyword">extends</span> [...infer F, infer _] ? F : [];
</code></pre>
<p>这道题目也不难，掌握 <code>infer</code> 的应用即可。因为 <code>Pop&lt;[]&gt;</code> 也是 <code>[]</code> 所以不匹配的时候也为 <code>[]</code>。</p>
<h3 data-id="heading-23">22. Medium - 20 - Promise.all ※</h3>
<p>好难的题T^T</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">type</span> <span class="hljs-title class_">Awaited</span>&lt;T&gt; = T <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Promise</span>&lt;infer R&gt; ? <span class="hljs-title class_">Awaited</span>&lt;R&gt; : T 

<span class="hljs-keyword">declare</span> <span class="hljs-keyword">function</span> <span class="hljs-title class_">PromiseAll</span>&lt;T <span class="hljs-keyword">extends</span> <span class="hljs-built_in">any</span>[]&gt;(<span class="hljs-attr">values</span>: <span class="hljs-keyword">readonly</span> [...T]):
    <span class="hljs-title class_">Promise</span>&lt;{ [P <span class="hljs-keyword">in</span> keyof T]: <span class="hljs-title class_">Awaited</span>&lt;T[P]&gt; }&gt;
</code></pre>
<p><code>Awaited</code> 部分前面的题目做过就不赘述了。</p>
<p><code>readonly</code> 表示输入的数组是只读的，<code>[...T]</code> 表示使用了<strong>变长元组类型（Variadic Tuple Types）</strong> 。它的作用是将传入的参数视为一个元组（Tuple）而不是普通的数组。</p>
<p><code>[P in keyof T]: Awaited&lt;T[P]&gt;</code> 是一个 <strong>映射元组类型（Mapped Tuple Type）</strong>，它会遍历元组 <code>T</code> 的每一个索引 <code>P</code>，然后把它的类型映射为 <code>Awaited&lt;T[P]&gt;</code>。</p>
<h3 data-id="heading-24">23. Medium - 62 - Type Lookup 查找类型</h3>
<p>通过在联合类型中通过指定公共属性 <code>type</code> 的值来获取相应的类型，例：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">interface</span> <span class="hljs-title class_">Cat</span> {
  <span class="hljs-attr">type</span>: <span class="hljs-string">'cat'</span>
  <span class="hljs-attr">breeds</span>: <span class="hljs-string">'Abyssinian'</span> | <span class="hljs-string">'Shorthair'</span> | <span class="hljs-string">'Curl'</span> | <span class="hljs-string">'Bengal'</span>
}

<span class="hljs-keyword">interface</span> <span class="hljs-title class_">Dog</span> {
  <span class="hljs-attr">type</span>: <span class="hljs-string">'dog'</span>
  <span class="hljs-attr">breeds</span>: <span class="hljs-string">'Hound'</span> | <span class="hljs-string">'Brittany'</span> | <span class="hljs-string">'Bulldog'</span> | <span class="hljs-string">'Boxer'</span>
  <span class="hljs-attr">color</span>: <span class="hljs-string">'brown'</span> | <span class="hljs-string">'white'</span> | <span class="hljs-string">'black'</span>
}

<span class="hljs-keyword">type</span> <span class="hljs-title class_">MyDog</span> = <span class="hljs-title class_">LookUp</span>&lt;<span class="hljs-title class_">Cat</span> | <span class="hljs-title class_">Dog</span>, <span class="hljs-string">'dog'</span>&gt; <span class="hljs-comment">// expected to be `Dog`</span>
</code></pre>
<p>很有趣的题目，因为前面 <code>Exclude</code> 中我们学到了：</p>
<blockquote>
<p><code>type MyExclude&lt;T, U&gt; = T extends U ? never : T;</code></p>
<p>当 <code>T extends U ? ...</code> 中的 <code>T</code> 为联合类型时，会把联合类型中的每一个类型单独进行判断，然后再把结果组合成一个联合类型返回。</p>
</blockquote>
<p>所以一开始我理所当然地写成：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">type</span> <span class="hljs-title class_">LookUp</span>&lt;U <span class="hljs-keyword">extends</span> { <span class="hljs-attr">type</span>: <span class="hljs-built_in">string</span> }, T&gt; = U[<span class="hljs-string">'type'</span>] <span class="hljs-keyword">extends</span> T ? U : <span class="hljs-built_in">never</span>
</code></pre>
<p>但是 TS 语法博大精深，但是只有单独使用联合类型时（naked type），才会使用<strong>分布式条件类型</strong>，也就是说我们 <code>extends</code> 左边必须是单独的 <code>U</code>。</p>
<p>换个思路，我们调整 <code>extends</code> 的右边。所以答案为：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">type</span> <span class="hljs-title class_">LookUp</span>&lt;U <span class="hljs-keyword">extends</span> { <span class="hljs-attr">type</span>: <span class="hljs-built_in">string</span> }, T&gt; = U <span class="hljs-keyword">extends</span> { <span class="hljs-attr">type</span>: T } ? U : <span class="hljs-built_in">never</span>;
</code></pre>
<h3 data-id="heading-25">24. Medium - 106 - Trim Left 去除左侧空白 ※</h3>
<p>实现 <code>TrimLeft&lt;T&gt;</code> ，它接收确定的字符串类型并返回一个新的字符串，其中新返回的字符串删除了原字符串开头的空白字符串。例如：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">type</span> trimmed = <span class="hljs-title class_">TrimLeft</span>&lt;<span class="hljs-string">'  Hello World  '</span>&gt; <span class="hljs-comment">// 应推导出 'Hello World  '</span>
</code></pre>
<p>这是到目前为止遇到的第一个字符串模板类型的题目。相关知识点可以看下这个文章 <a href="https://juejin.cn/post/7597664149170192426" target="_blank" title="https://juejin.cn/post/7597664149170192426">《你不知道的 TypeScript：模板字符串类型》</a></p>
<p>直接看答案吧：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">type</span> <span class="hljs-title class_">Space</span> = <span class="hljs-string">' '</span> | <span class="hljs-string">'\n'</span> | <span class="hljs-string">'\t'</span>
<span class="hljs-keyword">type</span> <span class="hljs-title class_">TrimLeft</span>&lt;S <span class="hljs-keyword">extends</span> <span class="hljs-built_in">string</span>&gt; = S <span class="hljs-keyword">extends</span> <span class="hljs-string">`<span class="hljs-subst">${Space}</span><span class="hljs-subst">${infer R}</span>`</span> ? <span class="hljs-title class_">TrimLeft</span>&lt;R&gt; : S
</code></pre>
<p>在模板字符串类型中，可以通过 <code>infer</code> 实现类似于正则匹配的效果。</p>
<p>首先定义空白字符联合类型 <code>type Space = ' ' | '\n' | '\t'</code>。注意这里 <code>''</code> 和 <code>'\n'</code> 或 <code>'\t'</code> 都是 <strong>字符串字面量类型</strong>，千万不能写成 <code>\s</code> 那不是字符串字面量，而是正则表达式中的语法，TS并没有内置正则表达式引擎。</p>
<p>当联合类型出现在模板字符串插值中时，TS 会尝试匹配联合类型中的任意一个成员。也就是说，它会检查字符串是否以 <code>' '</code> <strong>或</strong> <code>'\n'</code> <strong>或</strong> <code>'\t'</code> 开头。</p>
<p>如果 <code>S</code> 能匹配 <code>${Space}${infer R}</code> 模式，则 <code>R</code> 为除了第一个空白字符外的剩余字符串组成的类型。这样通过递归我们就能得到 <code>TrimLeft</code>。</p>
<h3 data-id="heading-26">25. Medium - 108 - Trim 去除两端空白字符</h3>
<p>有了上面的题目，这道题就比较简单了，先移除左边，再移除右边空白即可</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">type</span> <span class="hljs-title class_">Space</span> = <span class="hljs-string">' '</span> | <span class="hljs-string">'\t'</span> | <span class="hljs-string">'\n'</span>;
<span class="hljs-keyword">type</span> <span class="hljs-title class_">TrimLeft</span>&lt;S <span class="hljs-keyword">extends</span> <span class="hljs-built_in">string</span>&gt; = S <span class="hljs-keyword">extends</span> <span class="hljs-string">`<span class="hljs-subst">${Space}</span><span class="hljs-subst">${infer R}</span>`</span> ? <span class="hljs-title class_">TrimLeft</span>&lt;R&gt; : S;
<span class="hljs-keyword">type</span> <span class="hljs-title class_">TrimRight</span>&lt;S <span class="hljs-keyword">extends</span> <span class="hljs-built_in">string</span>&gt; = S <span class="hljs-keyword">extends</span> <span class="hljs-string">`<span class="hljs-subst">${infer L}</span><span class="hljs-subst">${Space}</span>`</span> ? <span class="hljs-title class_">TrimRight</span>&lt;L&gt; : S;
<span class="hljs-keyword">type</span> <span class="hljs-title class_">Trim</span>&lt;S <span class="hljs-keyword">extends</span> <span class="hljs-built_in">string</span>&gt; = <span class="hljs-title class_">TrimRight</span>&lt;<span class="hljs-title class_">TrimLeft</span>&lt;S&gt;&gt;
</code></pre>
<p>也可以巧妙地使用联合类型，一次性匹配两边的空白：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">type</span> <span class="hljs-title class_">Trim</span>&lt;S <span class="hljs-keyword">extends</span> <span class="hljs-built_in">string</span>&gt; =
  S <span class="hljs-keyword">extends</span> <span class="hljs-string">`<span class="hljs-subst">${Space}</span><span class="hljs-subst">${infer T}</span>`</span> | <span class="hljs-string">`<span class="hljs-subst">${infer T}</span><span class="hljs-subst">${Space}</span>`</span> ? <span class="hljs-title class_">Trim</span>&lt;T&gt; : S;
</code></pre>
<h3 data-id="heading-27">26. Medium - 110 -  Capitalize</h3>
<p>将一个字符串类型的首字母转为大写。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">type</span> <span class="hljs-title class_">MyCapitalize</span>&lt;S <span class="hljs-keyword">extends</span> <span class="hljs-built_in">string</span>&gt; = 
    S <span class="hljs-keyword">extends</span> <span class="hljs-string">`<span class="hljs-subst">${infer F}</span><span class="hljs-subst">${infer X}</span>`</span> ? <span class="hljs-string">`<span class="hljs-subst">${Uppercase&lt;F&gt;}</span><span class="hljs-subst">${X}</span>`</span> : S
</code></pre>
<ul>
<li>当使用 <code>${infer A}${infer B}</code> 这种格式匹配字符串时，TS会采取“非贪婪”策略匹配第一个变量。也就是 <code>A</code>会是第一个字符，<code>B</code> 是剩余所有字符。</li>
<li><code>Uppercase&lt;F&gt;</code> 是 TypeScript 内置的固有类型（Intrinsic Type），将一个字符串类型的全部字符转为大写。</li>
</ul>
<h3 data-id="heading-28">27. Medium - 116 -  Replace</h3>
<p>实现 <code>Replace&lt;S, From, To&gt;</code> 将字符串 <code>S</code> 中的第一个子字符串 <code>From</code> 替换为 <code>To</code> 。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">type</span> <span class="hljs-title class_">Replace</span>&lt;S <span class="hljs-keyword">extends</span> <span class="hljs-built_in">string</span>, <span class="hljs-title class_">From</span> <span class="hljs-keyword">extends</span> <span class="hljs-built_in">string</span>, <span class="hljs-title class_">To</span> <span class="hljs-keyword">extends</span> <span class="hljs-built_in">string</span>&gt; = 
    <span class="hljs-title class_">From</span> <span class="hljs-keyword">extends</span> <span class="hljs-string">''</span>
      ? S
      : S <span class="hljs-keyword">extends</span> <span class="hljs-string">`<span class="hljs-subst">${infer A}</span><span class="hljs-subst">${From}</span><span class="hljs-subst">${infer B}</span>`</span>
      ? <span class="hljs-string">`<span class="hljs-subst">${A}</span><span class="hljs-subst">${To}</span><span class="hljs-subst">${B}</span>`</span>
      : S
</code></pre>
<p>由于测试用例中存在 <code>From</code> 为空串的情况 <code>Equal&lt;Replace&lt;'foobarbar', '', 'foo'&gt;, 'foobarbar'&gt;</code> 此时不需要做任何处理，所以这里先判断了一下，如果 <code>From</code> 为空直接返回原字符串。</p>
<p>然后通过 <code>${infer A}${From}${infer B}</code> 的模式匹配字符串中出现的第一个 <code>{From}</code> 再通过 <code>${A}${To}${B}</code> 完成替换。</p>
<p>TS的特性，非贪婪匹配，所以永远会匹配到第一个 <code>{From}</code> 。</p>
<h3 data-id="heading-29">28. Medium - 119 -  ReplaceAll</h3>
<p>实现 <code>ReplaceAll&lt;S, From, To&gt;</code> 将一个字符串 <code>S</code> 中的所有子字符串 <code>From</code> 替换为 <code>To</code>。</p>
<p>一开始就想到了递归处理，实现也就是在上一题稍稍改下。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">type</span> <span class="hljs-title class_">ReplaceAll</span>&lt;S <span class="hljs-keyword">extends</span> <span class="hljs-built_in">string</span>, <span class="hljs-title class_">From</span> <span class="hljs-keyword">extends</span> <span class="hljs-built_in">string</span>, <span class="hljs-title class_">To</span> <span class="hljs-keyword">extends</span> <span class="hljs-built_in">string</span>&gt; =
  <span class="hljs-title class_">From</span> <span class="hljs-keyword">extends</span> <span class="hljs-string">''</span>
    ? S
    : S <span class="hljs-keyword">extends</span> <span class="hljs-string">`<span class="hljs-subst">${infer A}</span><span class="hljs-subst">${From}</span><span class="hljs-subst">${infer B}</span>`</span>
    ? <span class="hljs-title class_">ReplaceAll</span>&lt;<span class="hljs-string">`<span class="hljs-subst">${A}</span><span class="hljs-subst">${To}</span><span class="hljs-subst">${B}</span>`</span>, <span class="hljs-title class_">From</span>, <span class="hljs-title class_">To</span>&gt;
    : S
</code></pre>
<p>不过很明显这样不对，把修改过的部分再整体替换，会导致下面这种错误。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">type</span> <span class="hljs-title class_">Test</span> = <span class="hljs-title class_">ReplaceAll</span>&lt;<span class="hljs-string">'foooob'</span>, <span class="hljs-string">'ob'</span>, <span class="hljs-string">'b'</span>&gt; <span class="hljs-comment">// "fb"</span>
</code></pre>
<p>不过也比较好处理，因为我们知道每次处理的都只会是第一个匹配到的字符串，那么直接递归处理后面的部分就可以了，正确答案：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">type</span> <span class="hljs-title class_">ReplaceAll</span>&lt;S <span class="hljs-keyword">extends</span> <span class="hljs-built_in">string</span>, <span class="hljs-title class_">From</span> <span class="hljs-keyword">extends</span> <span class="hljs-built_in">string</span>, <span class="hljs-title class_">To</span> <span class="hljs-keyword">extends</span> <span class="hljs-built_in">string</span>&gt; =
 <span class="hljs-title class_">From</span> <span class="hljs-keyword">extends</span> <span class="hljs-string">''</span>
  ? S
  : S <span class="hljs-keyword">extends</span> <span class="hljs-string">`<span class="hljs-subst">${infer A}</span><span class="hljs-subst">${From}</span><span class="hljs-subst">${infer B}</span>`</span>
  ? <span class="hljs-string">`<span class="hljs-subst">${A}</span><span class="hljs-subst">${To}</span><span class="hljs-subst">${ReplaceAll&lt;B, From, To&gt;}</span>`</span>
  : S
</code></pre>
<h3 data-id="heading-30">29. Medium - 191 -  Append Argument 追加参数</h3>
<p>实现一个泛型 <code>AppendArgument&lt;Fn, A&gt;</code>，对于给定的函数类型 <code>Fn</code>，以及一个任意类型 <code>A</code>，返回一个新的函数 <code>G</code>。<code>G</code> 拥有 <code>Fn</code> 的所有参数并在末尾追加类型为 <code>A</code> 的参数。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">type</span> <span class="hljs-title class_">AppendArgument</span>&lt;<span class="hljs-title class_">Fn</span> <span class="hljs-keyword">extends</span> (...<span class="hljs-attr">args</span>: <span class="hljs-built_in">any</span>) =&gt; <span class="hljs-built_in">any</span>, A&gt; = 
  <span class="hljs-title class_">Fn</span> <span class="hljs-keyword">extends</span> (...<span class="hljs-attr">args</span>: infer P) =&gt; infer R 
  ? <span class="hljs-function">(<span class="hljs-params">...args: [...P, A]</span>) =&gt;</span> R
  : <span class="hljs-built_in">never</span>
</code></pre>
<p>这道题就是把之前的获取函数参数和返回值结合起来了，参考 533、3312、2 几道题即可。</p>
<h3 data-id="heading-31">30. Medium - 296 -  Permutation 联合类型的全排列 ※</h3>
<p>实现联合类型的全排列，将联合类型转换成所有可能的全排列数组的联合类型。</p>
<p>题解在此 <a href="https://juejin.cn/post/7598532592456007707" target="_blank" title="https://juejin.cn/post/7598532592456007707">你不知道的 TypeScript：联合类型与分布式条件类型》</a>，完成此题需要对分布式条件类型有深入理解。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">type</span> <span class="hljs-title class_">Permutation</span>&lt;T, K = T&gt; = [T] <span class="hljs-keyword">extends</span> [<span class="hljs-built_in">never</span>]
  ? []
  : T <span class="hljs-keyword">extends</span> <span class="hljs-built_in">any</span> ? [T, ...<span class="hljs-title class_">Permutation</span>&lt;<span class="hljs-title class_">Exclude</span>&lt;K, T&gt;&gt;] : []
</code></pre>
<h3 data-id="heading-32">31. Medium - 298 -  Length of String</h3>
<p>计算字符串的长度，类似于 <code>String#length</code> 。</p>
<p>思路：字符串类型没有办法通过 <code>S['length']</code> 获取长度，但是元组可以，所以最简单的解法就是先把字符串按单个字母分割成元组，然后再取长度。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">type</span> <span class="hljs-title class_">Split</span>&lt;S <span class="hljs-keyword">extends</span> <span class="hljs-built_in">string</span>&gt; = S <span class="hljs-keyword">extends</span> <span class="hljs-string">`<span class="hljs-subst">${infer F}</span><span class="hljs-subst">${infer R}</span>`</span>
  ? [F, ...<span class="hljs-title class_">Split</span>&lt;R&gt;] : []
<span class="hljs-keyword">type</span> <span class="hljs-title class_">LengthOfString</span>&lt;S <span class="hljs-keyword">extends</span> <span class="hljs-built_in">string</span>&gt; = <span class="hljs-title class_">Split</span>&lt;S&gt;[<span class="hljs-string">'length'</span>]
</code></pre>
<p>看了社区的答案，可以通过新增一个参数的方式，一次解决问题，虽然不太直观，凡事挺有趣的。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">type</span> <span class="hljs-title class_">LengthOfString</span>&lt;S <span class="hljs-keyword">extends</span> <span class="hljs-built_in">string</span>, T <span class="hljs-keyword">extends</span> <span class="hljs-built_in">string</span>[] = []&gt; = 
  S <span class="hljs-keyword">extends</span> <span class="hljs-string">`<span class="hljs-subst">${infer F}</span><span class="hljs-subst">${infer R}</span>`</span> ? <span class="hljs-title class_">LengthOfString</span>&lt;R, [F, ...T]&gt; : T[<span class="hljs-string">'length'</span>]
</code></pre>
<h3 data-id="heading-33">32. Medium - 459 - Flatten</h3>
<p>你需要写一个接受数组的类型，并且返回扁平化的数组类型。</p>
<p>这道题的思路也是递归，TS中递归的思路就是先处理第一个元素 <code>F</code>，然后递归处理后面的 <code>R</code>。在处理第一个元素的时候，判断是否为数组，是则用 <code>Flatten</code> 递归处理，否则不需要再处理了，把第一个元素的结果和后面的处理结果拼接起来即可。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">type</span> <span class="hljs-title class_">Flatten</span>&lt;A <span class="hljs-keyword">extends</span> <span class="hljs-built_in">any</span>[]&gt; =  
A <span class="hljs-keyword">extends</span> [infer F, ...infer R] <span class="hljs-comment">// 判断A存在第一个元素F</span>
  ? F <span class="hljs-keyword">extends</span> <span class="hljs-built_in">any</span>[] <span class="hljs-comment">// 判断 F 是否为数组</span>
    ? [...<span class="hljs-title class_">Flatten</span>&lt;F&gt;, ...<span class="hljs-title class_">Flatten</span>&lt;R&gt;] <span class="hljs-comment">// F为数组则递归处理 F 和剩余部分</span>
    : [F, ...<span class="hljs-title class_">Flatten</span>&lt;R&gt;] <span class="hljs-comment">// F不为数组则不需要处理 只需要递归处理剩余部分</span>
  : [] <span class="hljs-comment">// A 不存在第一个元素直接返回空数组</span>
</code></pre>
<h3 data-id="heading-34">33. Medium - 527 - Append to object</h3>
<p>实现一个为接口添加一个新字段的类型。该类型接收三个参数，返回带有新字段的接口类型。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">type</span> <span class="hljs-title class_">AppendToObject</span>&lt;T, U <span class="hljs-keyword">extends</span> keyof <span class="hljs-built_in">any</span>, V&gt; = {
  [K <span class="hljs-keyword">in</span> keyof T | U]: K <span class="hljs-keyword">extends</span> keyof T ? T[K] : V
}
</code></pre>
<p>这题看着不难，但是还是要注意一点，指定泛型约束 <code>U extends keyof any</code> 因为不是所有类型都能做对象的建。</p>
<h3 data-id="heading-35">34. Medium - 529 - Absolute</h3>
<p>实现一个接收 <code>string</code>, <code>number</code> 或 <code>bigInt</code> 类型参数的 <code>Absolute</code> 类型, 返回一个正数字符串。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">type</span> <span class="hljs-title class_">Absolute</span>&lt;T <span class="hljs-keyword">extends</span> <span class="hljs-built_in">number</span> | <span class="hljs-built_in">string</span> | <span class="hljs-built_in">bigint</span>&gt; = 
  <span class="hljs-string">`<span class="hljs-subst">${T}</span>`</span> <span class="hljs-keyword">extends</span> <span class="hljs-string">`-<span class="hljs-subst">${infer F}</span>`</span>
  ? <span class="hljs-title class_">Absolute</span>&lt;F&gt;
  : <span class="hljs-string">`<span class="hljs-subst">${T}</span>`</span>
</code></pre>
<p>这题很简单，先把 <code>number</code> 或 <code>bigint</code> 类型转为字符串，再通过字符串模板类型的模式匹配，去掉前面的 <code>-</code>。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">type</span> <span class="hljs-title class_">Absolute</span>&lt;T <span class="hljs-keyword">extends</span> <span class="hljs-built_in">number</span> | <span class="hljs-built_in">string</span> | <span class="hljs-built_in">bigint</span>&gt; = <span class="hljs-string">`<span class="hljs-subst">${T}</span>`</span> <span class="hljs-keyword">extends</span> <span class="hljs-string">`-<span class="hljs-subst">${infer F}</span>`</span> ? F : <span class="hljs-string">`<span class="hljs-subst">${T}</span>`</span>;
</code></pre>
<p>这里涉及到 <code>bigint</code> 的一个知识点</p>
<blockquote>
<p>代码末尾的 <code>n</code> 是 JavaScript 和 TypeScript 中 BigInt 数据类型的标志。
数字中间的下划线 _ 是 ES2021 引入的特性（TypeScript 早就支持）。编译器在处理时会完全忽略这些下划线。<code>-1_000_000n</code> 等同于 <code>-1000000n</code>。</p>
</blockquote>
<p>在模板字符串中引用 <code>bigint</code> 类型。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">type</span> A = -<span class="hljs-number">1_000_000n</span>; <span class="hljs-comment">// -1000000n</span>
<span class="hljs-keyword">type</span> S = <span class="hljs-string">`<span class="hljs-subst">${A}</span>`</span>; <span class="hljs-comment">// "-1000000"</span>
</code></pre>
<h3 data-id="heading-36">35. Medium - 531 - String to Union</h3>
<p>实现一个将接收到的 String 参数转换为一个字母 Union 的类型。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">type</span> <span class="hljs-title class_">StringToUnion</span>&lt;T <span class="hljs-keyword">extends</span> <span class="hljs-built_in">string</span>&gt; = 
  T <span class="hljs-keyword">extends</span> <span class="hljs-string">`<span class="hljs-subst">${infer F}</span><span class="hljs-subst">${infer R}</span>`</span>
  ? F | <span class="hljs-title class_">StringToUnion</span>&lt;R&gt;
  : <span class="hljs-built_in">never</span>
</code></pre>
<p>这题也属于比较简单，没有新的知识点，每次取首字符然后递归处理。</p>
<h3 data-id="heading-37">36. Medium - 599 - Merge</h3>
<p>将两个类型合并成一个类型，第二个类型的键会覆盖第一个类型的键。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">type</span> <span class="hljs-title class_">Merge</span>&lt;F, S&gt; = {
  [K <span class="hljs-keyword">in</span> keyof F | keyof S]: K <span class="hljs-keyword">extends</span> keyof S
    ? S[K]
    : K <span class="hljs-keyword">extends</span> keyof F
    ? F[K]
    : <span class="hljs-built_in">never</span>;
};
</code></pre>
<p>解决难度不大，遍历两个对象的 key，然后优先判断是否为 <code>S</code> 的键，输出 <code>S</code> 对应类型，否则为 <code>F</code> 对应的类型。</p>
<h3 data-id="heading-38">37. Medium - 612 - KebabCase</h3>
<p>将 驼峰式（camelCase） 或 帕斯卡式（PascalCase） 字符串替换为分号分隔式（kebab-case）。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">type</span> <span class="hljs-variable constant_">DAXIE</span> = <span class="hljs-string">'A'</span>|<span class="hljs-string">'B'</span>| <span class="hljs-string">'C'</span>| <span class="hljs-string">'D'</span>| <span class="hljs-string">'E'</span>| <span class="hljs-string">'F'</span>| <span class="hljs-string">'G'</span>| <span class="hljs-string">'H'</span>| <span class="hljs-string">'I'</span>| <span class="hljs-string">'J'</span>| <span class="hljs-string">'K'</span>| <span class="hljs-string">'L'</span>| <span class="hljs-string">'M'</span>| <span class="hljs-string">'N'</span>| <span class="hljs-string">'O'</span>| <span class="hljs-string">'P'</span>| <span class="hljs-string">'Q'</span>| <span class="hljs-string">'R'</span>| <span class="hljs-string">'S'</span>| <span class="hljs-string">'T'</span>| <span class="hljs-string">'U'</span>| <span class="hljs-string">'V'</span>| <span class="hljs-string">'W'</span>| <span class="hljs-string">'X'</span>| <span class="hljs-string">'Y'</span>| <span class="hljs-string">'Z'</span>;

<span class="hljs-keyword">type</span> <span class="hljs-title class_">KebabCase</span>&lt;S, X <span class="hljs-keyword">extends</span> <span class="hljs-built_in">string</span> = <span class="hljs-string">''</span>&gt; = 
  S <span class="hljs-keyword">extends</span> <span class="hljs-string">`<span class="hljs-subst">${infer F}</span><span class="hljs-subst">${infer R}</span>`</span> <span class="hljs-comment">// 是否有第一个字母</span>
    ? F <span class="hljs-keyword">extends</span> <span class="hljs-variable constant_">DAXIE</span> <span class="hljs-comment">// 存在首字母，判断是否为大写</span>
      ? X <span class="hljs-keyword">extends</span> <span class="hljs-string">''</span> <span class="hljs-comment">// 看看前面有字符吗</span>
        ? <span class="hljs-title class_">KebabCase</span>&lt;R, <span class="hljs-string">`<span class="hljs-subst">${X}</span><span class="hljs-subst">${Lowercase&lt;F&gt;}</span>`</span>&gt; <span class="hljs-comment">//  前面没有其他字符改成小写但是不加分割线</span>
        : <span class="hljs-title class_">KebabCase</span>&lt;R, <span class="hljs-string">`<span class="hljs-subst">${X}</span>-<span class="hljs-subst">${Lowercase&lt;F&gt;}</span>`</span>&gt; <span class="hljs-comment">// 前面有字符 F 处理为 分割线+小写</span>
      : <span class="hljs-title class_">KebabCase</span>&lt;R, <span class="hljs-string">`<span class="hljs-subst">${X}</span><span class="hljs-subst">${F}</span>`</span>&gt; <span class="hljs-comment">// 不是大写字母不做处理</span>
    : X <span class="hljs-comment">// S处理完了直接返回X</span>
</code></pre>
<p>此题有点复杂，但是不涉及新的知识点，还是可以做出来的，我加了完整的注释方便阅读。当然通过枚举的方式来判断是否大写字母有点蠢，肯定有更简单的方式。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">type</span> <span class="hljs-title class_">KebabCase</span>&lt;S&gt; = S <span class="hljs-keyword">extends</span> <span class="hljs-string">`<span class="hljs-subst">${infer F}</span><span class="hljs-subst">${infer R}</span>`</span>
  ? R <span class="hljs-keyword">extends</span> <span class="hljs-string">`<span class="hljs-subst">${Uncapitalize&lt;R&gt;}</span>`</span> <span class="hljs-comment">// R首字母为小写或者R为空串时条件为真</span>
    ? <span class="hljs-string">`<span class="hljs-subst">${Uncapitalize&lt;F&gt;}</span><span class="hljs-subst">${KebabCase&lt;Uncapitalize&lt;R&gt;&gt;}</span>`</span>
    : <span class="hljs-string">`<span class="hljs-subst">${Uncapitalize&lt;F&gt;}</span>-<span class="hljs-subst">${KebabCase&lt;Uncapitalize&lt;R&gt;&gt;}</span>`</span>
  : S;
</code></pre>
<h3 data-id="heading-39">38. Medium - 645 - Diff</h3>
<p>获取两个接口类型中的差值属性。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">type</span> <span class="hljs-title class_">Diff</span>&lt;O, <span class="hljs-variable constant_">O1</span>&gt; = {
  [K <span class="hljs-keyword">in</span> keyof O | keyof <span class="hljs-variable constant_">O1</span> <span class="hljs-keyword">as</span> K <span class="hljs-keyword">extends</span> keyof O &amp; keyof <span class="hljs-variable constant_">O1</span>
    ? <span class="hljs-built_in">never</span>
    : K]: K <span class="hljs-keyword">extends</span> keyof O ? O[K] : K <span class="hljs-keyword">extends</span> keyof <span class="hljs-variable constant_">O1</span> ? <span class="hljs-variable constant_">O1</span>[K] : <span class="hljs-built_in">never</span>;
};
</code></pre>
<p>虽然是很顺利地写出来了，但是看了别人的答案= =</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">type</span> <span class="hljs-title class_">Diff</span>&lt;O, <span class="hljs-variable constant_">O1</span>&gt; = <span class="hljs-title class_">Omit</span>&lt;O &amp; <span class="hljs-variable constant_">O1</span>, keyof O &amp; keyof <span class="hljs-variable constant_">O1</span>&gt;
</code></pre>
<p>这里比较反直觉的是，对象的交叉类型（Intersection）存在全部对象的属性键。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">type</span> A = { <span class="hljs-attr">name</span>: <span class="hljs-built_in">string</span> };
<span class="hljs-keyword">type</span> B = { <span class="hljs-attr">age</span>: <span class="hljs-built_in">number</span> };

<span class="hljs-keyword">type</span> C = A &amp; B;
<span class="hljs-comment">// 结果：{ name: string; age: number; }</span>
</code></pre>
<p>这是因为 A 和 B 的交集就是找一个类型，即符合 A 又符合 B。</p>
<p>集合 A：包含所有 “带有 name 属性” 的对象。<br/>
集合 B：包含所有 “带有 age 属性” 的对象。<br/>
集合 A &amp; B：我要找一个对象，这个对象必须同时拥有 name 和 age。</p>
<p>所以：类型的交集 = 属性名的并集<br/>
<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><mi>T</mi><mi>y</mi><mi>p</mi><mi>e</mi><mi>A</mi><mo>∩</mo><mi>T</mi><mi>y</mi><mi>p</mi><mi>e</mi><mi>B</mi><mo stretchy="false">)</mo><mo>⟺</mo><mo stretchy="false">(</mo><mi>K</mi><mi>e</mi><mi>y</mi><mi>s</mi><mi>A</mi><mo>∪</mo><mi>K</mi><mi>e</mi><mi>y</mi><mi>s</mi><mi>B</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">(TypeA ∩ TypeB) ⟺ (KeysA ∪ KeysB)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="mord mathnormal">p</span><span class="mord mathnormal">e</span><span class="mord mathnormal">A</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">∩</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="mord mathnormal">p</span><span class="mord mathnormal">e</span><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">⟺</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mopen">(</span><span class="mord mathnormal">Keys</span><span class="mord mathnormal">A</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">∪</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal">Keys</span><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="mclose">)</span></span></span></span></span></p>
<h3 data-id="heading-40">39. Medium - 949 - AnyOf</h3>
<p>在类型系统中实现类似于 Python 中 any 函数。类型接收一个数组，如果数组中任一个元素为真，则返回 true，否则返回 false。如果数组为空，返回 false。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">type</span> <span class="hljs-title class_">AnyOf</span>&lt;T <span class="hljs-keyword">extends</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">any</span>[]&gt; = T[<span class="hljs-built_in">number</span>] <span class="hljs-keyword">extends</span> <span class="hljs-number">0</span> | <span class="hljs-string">''</span> | <span class="hljs-literal">false</span> | [] | <span class="hljs-literal">undefined</span> | <span class="hljs-literal">null</span> | {[<span class="hljs-attr">key</span>: <span class="hljs-built_in">string</span>]: <span class="hljs-built_in">never</span>} ? <span class="hljs-literal">false</span> : <span class="hljs-literal">true</span>
</code></pre>
<h3 data-id="heading-41">40. Medium - 1042 - IsNever</h3>
<p>实现一个类型 <code>IsNever</code>，它接收输入类型 <code>T</code>。如果该类型解析为 <code>never</code>，则返回 <code>true</code>，否则返回 <code>false</code>。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">type</span> <span class="hljs-title class_">IsNever</span>&lt;T&gt; = [T] <span class="hljs-keyword">extends</span> [<span class="hljs-built_in">never</span>] ? <span class="hljs-literal">true</span> : <span class="hljs-literal">false</span>
</code></pre>
<p>这题也简单，主要考察分布式条件类型，当一个联合类型作为泛型应用到条件类型，会有分发效果，而 <code>never</code> 可以被视为空的联合类型，它被应用于条件类型，会直接返回 <code>never</code>，所以需要用 <code>[]</code> 包裹起来，阻止分布式条件类型。</p>
<h3 data-id="heading-42">41. Medium - 1097 - IsUnion</h3>
<p>实现一个类型 <code>IsUnion</code>，它接受输入类型 <code>T</code> 并返回 <code>T</code> 是否为联合类型。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">type</span> <span class="hljs-title class_">IsUnion</span>&lt;T, F = T&gt; = [T] <span class="hljs-keyword">extends</span> [<span class="hljs-built_in">never</span>]
  ? <span class="hljs-literal">false</span>
  : T <span class="hljs-keyword">extends</span> T
    ? [F] <span class="hljs-keyword">extends</span> [T] ? <span class="hljs-literal">false</span> : <span class="hljs-literal">true</span>
  : <span class="hljs-literal">true</span>;
</code></pre>
<p>联合类型特殊的地方就是分布式条件类型，那就利用这个特性：如上代码，如果 <code>T</code> 是条件类型，那么 <code>T</code> 和 <code>F</code> 就是不一样的，否则它俩是一样的类型。</p>
<h2 data-id="heading-43">AI总结</h2>
<p>通过以上题目，系统地学习了 TypeScript 类型系统的核心知识点：</p>
<p><strong>1. 基础语法</strong></p>
<ul>
<li><code>keyof</code>、<code>extends</code>、<code>in</code> 三大关键字的灵活运用</li>
<li>索引访问类型 <code>T[K]</code> 和 <code>T[number]</code></li>
<li><code>readonly</code> 修饰符与 <code>as const</code> 断言</li>
</ul>
<p><strong>2. 条件类型与类型推断</strong></p>
<ul>
<li>条件类型 <code>A extends B ? C : D</code> 是类型体操的核心</li>
<li><code>infer</code> 关键字实现模式匹配和类型推断</li>
<li><strong>分布式条件类型</strong>：联合类型在裸类型参数上的自动分发特性</li>
<li>使用 <code>[T] extends [U]</code> 阻止分布式行为</li>
</ul>
<p><strong>3. 映射类型</strong></p>
<ul>
<li><code>[P in keyof T]</code> 遍历对象属性</li>
<li><code>as</code> 关键字重映射键名，可配合条件类型过滤属性</li>
<li>交叉类型 <code>&amp;</code> 合并对象属性</li>
</ul>
<p><strong>4. 元组与数组</strong></p>
<ul>
<li>扩展运算符 <code>[...T, U]</code> 在类型层面的应用</li>
<li><code>T[number]</code> 提取元组所有成员的联合类型</li>
<li>元组的 <code>length</code> 是字面量数字类型</li>
</ul>
<p><strong>5. 字符串模板类型</strong></p>
<ul>
<li>模板字符串类型支持 <code>infer</code> 进行模式匹配</li>
<li>内置工具：<code>Uppercase</code>、<code>Lowercase</code>、<code>Capitalize</code>、<code>Uncapitalize</code></li>
<li>联合类型在模板插槽中会匹配任意成员</li>
</ul>
<p><strong>6. 递归思维</strong></p>
<ul>
<li>处理数组/字符串：提取首元素 + 递归处理剩余部分</li>
<li>递归终止条件的设计很关键</li>
<li>递归深度有限制，但通常够用</li>
</ul>
<p><strong>7. 特殊类型特性</strong></p>
<ul>
<li><code>never</code> 是空联合类型，在条件类型中会直接返回</li>
<li>交叉类型的属性是各类型属性的并集</li>
<li>泛型约束 <code>T extends keyof any</code> 确保类型可作对象键</li>
</ul>
<p><strong>核心技巧</strong>：多数难题都是基础语法的组合应用，关键是理解分布式条件类型和 <code>infer</code> 的工作机制，然后通过递归思维拆解问题。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[🚀 前端5分钟极速转全栈！orpc + cloudflare 项目实践]]></title>    <link>https://juejin.cn/post/7600234310964789286</link>    <guid>https://juejin.cn/post/7600234310964789286</guid>    <pubDate>2026-01-28T09:57:39.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600234310964789286" data-draft-id="7600238071037853705" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="🚀 前端5分钟极速转全栈！orpc + cloudflare 项目实践"/> <meta itemprop="keywords" content="前端,全栈,Node.js"/> <meta itemprop="datePublished" content="2026-01-28T09:57:39.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="代码小学僧"/> <meta itemprop="url" content="https://juejin.cn/user/255519436842030"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            🚀 前端5分钟极速转全栈！orpc + cloudflare 项目实践
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/255519436842030/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    代码小学僧
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-28T09:57:39.000Z" title="Wed Jan 28 2026 09:57:39 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-28
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    74
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#595959;font-size:15px;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(60,10,30,.04) 3%,transparent 0),linear-gradient(1turn,rgba(60,10,30,.04) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body p{color:#595959;font-size:15px;line-height:2;font-weight:400}.markdown-body p+p{margin-top:16px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin:0;color:#135ce0}.markdown-body h1{position:relative;text-align:center;font-size:22px;margin:50px 0}.markdown-body h1:before{position:absolute;content:"";top:-10px;left:50%;width:32px;height:32px;transform:translateX(-50%);background-size:100% 100%;opacity:.36;background-repeat:no-repeat;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC)}.markdown-body h2{position:relative;font-size:20px;border-left:4px solid;padding:0 0 0 10px;margin:30px 0}.markdown-body h3{font-size:16px}.markdown-body ul{list-style:disc outside;margin-left:2em;margin-top:1em}.markdown-body li{line-height:2;color:#595959}.markdown-body img.loaded{margin:0 auto;display:block}.markdown-body blockquote{background:#fff9f9;margin:2em 0;padding:2px 20px;border-left:4px solid #b2aec5}.markdown-body blockquote p{color:#666;line-height:2}.markdown-body a{color:#036aca;border-bottom:1px solid rgba(3,106,202,.8);font-weight:400;text-decoration:none}.markdown-body em strong,.markdown-body strong{color:#036aca}.markdown-body hr{border-top:1px solid #135ce0}.markdown-body pre{overflow:auto}.markdown-body code,.markdown-body pre{overflow:auto;position:relative;line-height:1.75;font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body table{border-collapse:collapse;margin:1rem 0;overflow-x:auto}.markdown-body table td,.markdown-body table th{border:1px solid #dfe2e5;padding:.6em 1em}.markdown-body table tr{border-top:1px solid #dfe2e5}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言</h2>
<p>标题党了一下哈哈，全栈还是有很多知识要学习的，这里只是简单介绍一套我觉得还不错的技术栈，希望对大家有帮助。</p>
<p>大前提: 请先注册一个 cloudflare 账户。5块钱买个域名绑定到 cloudflare 上，可以参考我之前的文章。</p>
<h2 data-id="heading-1">快速创建项目</h2>
<p>我在 GitHub 上偶然发现了一个很有意思的项目，想推荐给大家： <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.better-t-stack.dev%2Fnew" target="_blank" title="https://www.better-t-stack.dev/new" ref="nofollow noopener noreferrer">www.better-t-stack.dev/new</a></p>
<p>它提供了一个可视化页面，可以自由选择自己需要的技术栈，并自动生成初始化命令，一行命令就能创建完整项目。即使对技术栈不太熟悉，也可以直接使用社区中使用人数较多的预设配置，例如左下角提供的 T3 Stack、PERN Stack 等方案。同时还支持在线预览项目的文件结构，整体体验做得相当成熟。</p>
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2271102e88b14775b336ce5d61648518~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Luj56CB5bCP5a2m5YOn:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770256809&amp;x-signature=Blbzg69d9tk9nRyGhxiBE%2Fd1VFs%3D" alt="" width="100%" loading="lazy"/>
<p>这次我选择的是前后端统一部署到 Cloudflare，运行时使用 Cloudflare Workers，前后端之间通过 oRPC 通信。对于技术栈中一些不太熟悉的部分，我会在后文单独说明。通过复制生成的命令行即可完成项目初始化，最终得到的是一个前后端共存的 monorepo 项目结构，使用 Turbo 统一管理前后端的运行、调试和构建流程。</p>
<p>前后端代码全部采用 TypeScript 编写，对前端同学非常友好，上手成本也很低。(题外话: 我觉得写 JS / TS真幸福，应了那句话: 能用 JS 写的最后都用 JS 写😂)</p>
<pre><code class="hljs language-sql" lang="sql">pnpm <span class="hljs-keyword">create</span> better<span class="hljs-operator">-</span>t<span class="hljs-operator">-</span>stack<span class="hljs-variable">@latest</span> cf<span class="hljs-operator">-</span>todo <span class="hljs-comment">--frontend tanstack-router --backend hono --runtime workers --api orpc --auth none --payments none --database sqlite --orm drizzle --db-setup d1 --package-manager pnpm --git --web-deploy cloudflare --server-deploy cloudflare --install --addons biome turborepo --examples todo</span>
</code></pre>
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/79eb711a8f3b43ff8c54e22288ebae02~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Luj56CB5bCP5a2m5YOn:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770256809&amp;x-signature=h4%2BOJU7pH4rQe97i6wMyojFXLrA%3D" alt="" width="100%" loading="lazy"/>
<h2 data-id="heading-2">运行项目</h2>
<p>我们先把项目运行起来再看看代码。根据提示先运行一些Database的命令。<code>pnpm run db:generate</code></p>
<p>然后启动本地看看效果 <code>pnpm run dev</code> （注: 如果项目运行不起来，尝试升级一下pnpm版本，这个monorepo借助了pnpm-workspace的特性，一些 catalog 可能需要 pnpm 高版本才支持。）</p>
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0ed422af36734aa6984cd8cf133ae688~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Luj56CB5bCP5a2m5YOn:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770256809&amp;x-signature=2Fhdejo1NuZnJySMc6jMOWKfNTo%3D" alt="" width="100%" loading="lazy"/>
<p>可以看到项目运行成功分别在本地 3001、3002端口，作者贴心的展示了一个TODO list示例。</p>
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ef572e2054f846a2a783f54cf02097ec~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Luj56CB5bCP5a2m5YOn:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770256809&amp;x-signature=nrdfDbXKnuEoHsY0dumZ8lE69fk%3D" alt="" width="100%" loading="lazy"/>
<h2 data-id="heading-3">了解代码</h2>
<h3 data-id="heading-4">文件结构</h3>
<p>很清爽的文件结构，apps下有前后端，然后packages下是一些共用的内容，根目录是格式化的biome与pnpm与turbo的配置。</p>
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/651dbb89a668441e96b2892a8ed38ada~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Luj56CB5bCP5a2m5YOn:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770256809&amp;x-signature=T7Kf8cRRIHOlBLhPjDzse%2BQrNdo%3D" alt="" width="50%" loading="lazy"/>
<h3 data-id="heading-5">Pnpm-workspace</h3>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.pnpm.cn%2Fcatalogs" target="_blank" title="https://www.pnpm.cn/catalogs" ref="nofollow noopener noreferrer">www.pnpm.cn/catalogs</a> 使用了catalogs 方便在各个子包中共享同一个npm包避免重复安装。</p>
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/200280409d31438299c69d72882c5049~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Luj56CB5bCP5a2m5YOn:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770256809&amp;x-signature=J4yCKa6DDVTMRoWLlAAwD5sQBS8%3D" alt="" width="50%" loading="lazy"/>
<p>然后在 <code>/apps/web/package.json</code> 与 <code>/apps/server/package.json</code> 我们就可以看到使用根目录的catalogs了。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e21f40753a5348eb86e01c8652f2be73~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Luj56CB5bCP5a2m5YOn:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770256809&amp;x-signature=VQ80OWv1Knbwa8if9jQzXzwDbJs%3D" alt="" width="50%" loading="lazy"/><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9deac12f0d4d49d1b2c84a0a4f2e84d3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Luj56CB5bCP5a2m5YOn:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770256809&amp;x-signature=mF1i0UjpeAWClzJqUW2m9FSDzvE%3D" alt="" width="100%" loading="lazy"/></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.pnpm.cn%2Fworkspaces" target="_blank" title="https://www.pnpm.cn/workspaces" ref="nofollow noopener noreferrer">www.pnpm.cn/workspaces</a> workspaces 方便引用同一工作区的其他子模块的文件。</p>
<h3 data-id="heading-6">Hono</h3>
<p>Hono 是一个轻量级的 Web 框架，主要面向 JavaScript 和 TypeScript 生态。它的设计目标是高性能、低开销，以及在不同运行时环境中的一致体验</p>
<p>官网: <a href="https://link.juejin.cn?target=https%3A%2F%2Fhono.dev%2F" target="_blank" title="https://hono.dev/" ref="nofollow noopener noreferrer">hono.dev/</a> ,常用与于 cloudflare 相结合出现。nodejs backend 框架也是多种多样的，选择自己喜欢的即可。</p>
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d6c2dccc45764a2a88cabec21bfca044~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Luj56CB5bCP5a2m5YOn:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770256809&amp;x-signature=sLaCFSgjfFwl7WMY27xuUQCLDyg%3D" alt="" width="100%" loading="lazy"/>
<h3 data-id="heading-7">ORPC</h3>
<p>orpc 简单讲就是 trpc 的进化版。</p>
<p>trpc可能有的同学也不是很了解，引用自官网的介绍 <code>快速迭代，无忧无虑。轻松构建端到端类型安全的 API </code>。</p>
<p>说人话就是前后端共用一套TS，然后前端调用接口就可以直接以函数调用的方式访问后端接口，前端可以直接获得后端暴露的 API 类型定义。不用传统的前后端联调，后端给openapi文档，前端生成对应的TS接口响应入参与出参了，直接一套前端要调用接口直接点出来。</p>
<p>orpc 就是在 trpc 的基础上进行改造，官网: <a href="https://link.juejin.cn?target=https%3A%2F%2Forpc.dev%2Fdocs%2Fgetting-started" target="_blank" title="https://orpc.dev/docs/getting-started" ref="nofollow noopener noreferrer">orpc.dev/docs/gettin…</a> <code>oRPC（开放 API 远程过程调用）结合了 RPC（远程过程调用）与 OpenAPI，允许您通过类型安全的 API 定义和调用远程（或本地）过程，同时遵循 OpenAPI 规范。</code> 可以在享受trpc的同时生成openapi规范的文档。</p>
<p>访问我们这个示例项目的 <a href="https://link.juejin.cn?target=http%3A%2F%2Flocalhost%3A3000%2Fapi-reference" target="_blank" title="http://localhost:3000/api-reference" ref="nofollow noopener noreferrer">http://localhost:3000/api-reference</a> 就可以看到一个美观的openapi规范的在线接口示例</p>
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/00012fc6bbb6422c83fc426149e826cb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Luj56CB5bCP5a2m5YOn:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770256809&amp;x-signature=rMybMGmMar3Z68hfgiVns2D6Ps4%3D" alt="" width="100%" loading="lazy"/>
<p>我们来看orpc有多方便。</p>
<p><code>packages\api\src\routers\todo.ts</code> 接口的定义</p>
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/73c0988577694466b24db74066a68ad6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Luj56CB5bCP5a2m5YOn:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770256809&amp;x-signature=yOGe%2BjHh%2FDHEf1F1zA3%2B8t5ADNo%3D" alt="" width="100%" loading="lazy"/>
<p><code>apps\web\src\routes\todos.tsx</code> 前端界面直接调用点出来要使用的函数。然后用 <code>@tanstack/react-query</code> 相关的hook进行处理，</p>
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5f5cfdccb1d54645b748c5860c98bd25~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Luj56CB5bCP5a2m5YOn:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770256809&amp;x-signature=zMZsO6pYjHlCfoqurKhQ0ZqY6UI%3D" alt="" width="100%" loading="lazy"/>
<p>orpc也可以很好的与tanstack-query相结合。这样子直接开发个人项目的时候就免去了接口联调的麻烦，写完后端前端直接调用。</p>
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b38a83e0fbd0484c837ed64470f9e4c0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Luj56CB5bCP5a2m5YOn:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770256809&amp;x-signature=nR4yLP0CNHVerIBfDAcZhqCMcfE%3D" alt="" width="100%" loading="lazy"/>
<h3 data-id="heading-8">drizzle</h3>
<p>drizzle orm 就是方便你来增删改查数据的，在没有这些ORM的时候需要直接写SQL语句执行，有了这些ORM他们封装了一些方法让你更轻松的掌控数据。然后实在复杂的SQL也可以自定义。</p>
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/768274e612fb415aa9abb81735744f92~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Luj56CB5bCP5a2m5YOn:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770256809&amp;x-signature=NyLIOY9I67NDOo%2FDcoH5N3W2yQI%3D" alt="" width="100%" loading="lazy"/>
<p>node的ORM选择有蛮多的 选自己喜欢的或者大家推荐比较多的即可。</p>
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b46a3cc33ec4441987d05446ac17dd90~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Luj56CB5bCP5a2m5YOn:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770256809&amp;x-signature=ZGbz72txRtQJc0je7wALs8T3F5w%3D" alt="" width="100%" loading="lazy"/>
<h3 data-id="heading-9">Alchemy</h3>
<p>这个东西我也是第一次见到，我直接在bing搜还搜不到 需要加一些关键词，但感觉做的还不错，这里是官网: <a href="https://link.juejin.cn?target=https%3A%2F%2Falchemy.run%2Fwhat-is-alchemy%2F" target="_blank" title="https://alchemy.run/what-is-alchemy/" ref="nofollow noopener noreferrer">alchemy.run/what-is-alc…</a> 简单讲就是帮你管理一些部署用的基础设施信息，我这里是部署到 cloudflare，然后有一个 <code>alchemy.run.ts</code> 文件就是管理全部部署到 cloudflare相关的事情。</p>
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cc7f519d73e24e27b7a41ad34bc813ee~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Luj56CB5bCP5a2m5YOn:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770256809&amp;x-signature=hgPXzlxrkQkkIQ08afYRYpl90GE%3D" alt="" width="100%" loading="lazy"/>
<p>如果你尝试 <code>pnpm run deploy</code> 部署这个项目的时候会发现运行不成功，因为你还没有给本地的 alchemy 授权你的 cloudflare 账户。</p>
<p><code>npm i -g alchemy</code>安装完成后 <code>alchemy configure</code> 会打开一个授权页授权到本地即可。如果打不开或授权失败，请尝试打开vpn的 TUN 模式试下。</p>
<h3 data-id="heading-10">Turborepo</h3>
<p>Turborepo 是一个用于 JavaScript 和 TypeScript 代码库的高性能构建系统。它专为扩展单体仓库而设计，也能加速<a href="https://link.juejin.cn?target=https%3A%2F%2Fturbo.net.cn%2Fdocs%2Fguides%2Fsingle-package-workspaces" target="_blank" title="https://turbo.net.cn/docs/guides/single-package-workspaces" ref="nofollow noopener noreferrer">单包工作区</a>中的工作流。</p>
<p>vercel开源的一个项目，常用于处理 monorepo 类型仓库的构建。</p>
<h3 data-id="heading-11">Cloudflare</h3>
<p>我们这个项目前后端都部署到 cf 的 woker上，有很多的免费额度，cf真是大善人。然后数据存储的数据库使用的也是 cf 的D1数据库，个人MVP的项目初期应该够用了，升级了也不贵，不愧是赛博佛祖。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/241ba89fd47f4055b4d789c8d407b3a7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Luj56CB5bCP5a2m5YOn:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770256809&amp;x-signature=NGTE%2BWgy0cQk2NwV%2B1CPddllLM0%3D" alt="" width="50%" loading="lazy"/><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9ffbf7eeebfe4b67a851a2cc71229c4a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Luj56CB5bCP5a2m5YOn:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770256809&amp;x-signature=zG07HZWj6wjXGEidcF0HjYv0XRs%3D" alt="" width="50%" loading="lazy"/></p>
<h2 data-id="heading-12">项目部署</h2>
<p>授权完成后，我们运行 <code>pnpm run deploy</code> 试一下。可以看到给出了前后端两个地址。</p>
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/876832ac0f0543c485a7b8e3b057d3b7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Luj56CB5bCP5a2m5YOn:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770256809&amp;x-signature=wi82FkQX%2BlewTl4CNCROXvq7%2BUs%3D" alt="" width="100%" loading="lazy"/>
<p>访问前端后发现，我靠这么请求的是localhost:3000, 原来我们前后端的 .env 文件都没进行修改。</p>
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/da949dc8b16845568c6c90a52706c7d9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Luj56CB5bCP5a2m5YOn:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770256809&amp;x-signature=fFKve0cnsqdM%2Fxj9oJODs8lcRM0%3D" alt="" width="100%" loading="lazy"/>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3c817a38bdee47ea8a67cc55ce583ab8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Luj56CB5bCP5a2m5YOn:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770256809&amp;x-signature=OazjozjXS43OLACX%2F%2BFlLiAQs6Q%3D" alt="" loading="lazy"/><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/02ad08bcaa12498cb729dcb6d7045eeb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Luj56CB5bCP5a2m5YOn:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770256809&amp;x-signature=vlzsJ8Cu4PyH46TjlF1SI63nKSI%3D" alt="" loading="lazy"/>
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/de53f0acd85e4efba517023e261c1e73~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Luj56CB5bCP5a2m5YOn:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770256809&amp;x-signature=hw7GgQnlHYs0GxZTXgCoocuNo6Y%3D" alt="" loading="lazy"/></p>
<p>在后端的根目录创建一个<code>.env.dev</code>文件，CORS_ORIGIN 填写前端访问的地址。</p>
<pre><code class="hljs language-shell" lang="shell">CORS_ORIGIN=[填写前端地址]
</code></pre>
<p>前端创建一个 <code>.env.dev</code>文件</p>
<pre><code class="hljs language-shell" lang="shell">VITE_SERVER_URL=[填写后端地址]
</code></pre>
<p>然后添加一个 <code>pnpm run deploy:dev</code> 命令在根目录的 package.json 文件，表示我们要对 env.dev 环境变量的内容进行打包构建。复制上一行的 deploy 命令基础上再添加了一个 ALCHEMY_ENV=dev 的标识。</p>
<pre><code class="hljs language-shell" lang="shell">"deploy:dev": "cross-env ALCHEMY_ENV=dev turbo -F @cf-todo/infra deploy",
</code></pre>
<p>再修改 <code>alchemy.run.ts</code> 文件，根据环境变量读取对应的env文件</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> alchemy <span class="hljs-keyword">from</span> <span class="hljs-string">"alchemy"</span>;
<span class="hljs-keyword">import</span> { D1Database, <span class="hljs-title class_">Vite</span>, <span class="hljs-title class_">Worker</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"alchemy/cloudflare"</span>;
<span class="hljs-keyword">import</span> { config } <span class="hljs-keyword">from</span> <span class="hljs-string">"dotenv"</span>;

<span class="hljs-keyword">const</span> mode = process.<span class="hljs-property">env</span>.<span class="hljs-property">ALCHEMY_ENV</span> ?? process.<span class="hljs-property">env</span>.<span class="hljs-property">NODE_ENV</span> ?? <span class="hljs-string">"development"</span>;
<span class="hljs-keyword">const</span> <span class="hljs-title function_">loadEnv</span> = (<span class="hljs-params">path: string, override = <span class="hljs-literal">false</span></span>) =&gt; {
  <span class="hljs-title function_">config</span>({ path, override });
};

<span class="hljs-title function_">loadEnv</span>(<span class="hljs-string">"./.env"</span>);
<span class="hljs-title function_">loadEnv</span>(<span class="hljs-string">`./.env.<span class="hljs-subst">${mode}</span>`</span>, <span class="hljs-literal">true</span>);
<span class="hljs-title function_">loadEnv</span>(<span class="hljs-string">"../../apps/web/.env"</span>);
<span class="hljs-title function_">loadEnv</span>(<span class="hljs-string">`../../apps/web/.env.<span class="hljs-subst">${mode}</span>`</span>, <span class="hljs-literal">true</span>);
<span class="hljs-title function_">loadEnv</span>(<span class="hljs-string">"../../apps/server/.env"</span>);
<span class="hljs-title function_">loadEnv</span>(<span class="hljs-string">`../../apps/server/.env.<span class="hljs-subst">${mode}</span>`</span>, <span class="hljs-literal">true</span>);

<span class="hljs-keyword">const</span> app = <span class="hljs-keyword">await</span> <span class="hljs-title function_">alchemy</span>(<span class="hljs-string">"cf-todo"</span>);

<span class="hljs-keyword">const</span> db = <span class="hljs-keyword">await</span> <span class="hljs-title function_">D1Database</span>(<span class="hljs-string">"database"</span>, {
  <span class="hljs-attr">migrationsDir</span>: <span class="hljs-string">"../../packages/db/src/migrations"</span>,
});

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> web = <span class="hljs-keyword">await</span> <span class="hljs-title class_">Vite</span>(<span class="hljs-string">"web"</span>, {
  <span class="hljs-attr">cwd</span>: <span class="hljs-string">"../../apps/web"</span>,
  <span class="hljs-attr">assets</span>: <span class="hljs-string">"dist"</span>,
  <span class="hljs-attr">bindings</span>: {
    <span class="hljs-attr">VITE_SERVER_URL</span>: alchemy.<span class="hljs-property">env</span>.<span class="hljs-property">VITE_SERVER_URL</span>!,
  },
});

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> server = <span class="hljs-keyword">await</span> <span class="hljs-title class_">Worker</span>(<span class="hljs-string">"server"</span>, {
  <span class="hljs-attr">cwd</span>: <span class="hljs-string">"../../apps/server"</span>,
  <span class="hljs-attr">entrypoint</span>: <span class="hljs-string">"src/index.ts"</span>,
  <span class="hljs-attr">compatibility</span>: <span class="hljs-string">"node"</span>,
  <span class="hljs-attr">bindings</span>: {
    <span class="hljs-attr">DB</span>: db,
    <span class="hljs-attr">CORS_ORIGIN</span>: alchemy.<span class="hljs-property">env</span>.<span class="hljs-property">CORS_ORIGIN</span>!,
  },
  <span class="hljs-attr">dev</span>: {
    <span class="hljs-attr">port</span>: <span class="hljs-number">3000</span>,
  },
});

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`Web    -&gt; <span class="hljs-subst">${web.url}</span>`</span>);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`Server -&gt; <span class="hljs-subst">${server.url}</span>`</span>);

<span class="hljs-keyword">await</span> app.<span class="hljs-title function_">finalize</span>();
</code></pre>
<p>最后还需要在turbo.json 文件添加下构建传递的这个标识变量。</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-attr">"deploy"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"cache"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">false</span></span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"env"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"ALCHEMY_ENV"</span><span class="hljs-punctuation">]</span>
<span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
</code></pre>
<h2 data-id="heading-13">重新部署</h2>
<p>先运行 <code>pnpm run destory</code> 销毁之前的资源。再执行 <code>pnpm run deploy:dev</code>。nice 可以使用了，美滋滋~</p>
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/639bcdbe0ac84d56a18634a17199db6f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Luj56CB5bCP5a2m5YOn:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770256809&amp;x-signature=5tg1r0TDShQIdHfpe6KZ6FVIPIY%3D" alt="" width="100%" loading="lazy"/>
<h2 data-id="heading-14">结语</h2>
<p>现在，一个简单完整的前后端项目已经准备好，并且可以零成本完成部署，已经交到你手里了。接下来就可以充分发挥想象力和创造力，去打磨一个让人眼前一亮的产品。你也可以选择继续深入研究这个项目，借助AI的能力不断学习或创作。希望对大家有帮助！</p>
<p>改造部署文件参考: <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FLLmoskk%2Forpc-todolist%2Ftree%2Ffeature%2Ftodolist" target="_blank" title="https://github.com/LLmoskk/orpc-todolist/tree/feature/todolist" ref="nofollow noopener noreferrer">github.com/LLmoskk/orp…</a></p>
<p>最后，感恩Cloudflare！感恩 <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.better-t-stack.dev%2Fnew" target="_blank" title="https://www.better-t-stack.dev/new" ref="nofollow noopener noreferrer">better-t-stack.dev/new</a> 项目！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[老项目 Vue2 函数式打开弹层【附源码】]]></title>    <link>https://juejin.cn/post/7600060708932141066</link>    <guid>https://juejin.cn/post/7600060708932141066</guid>    <pubDate>2026-01-28T05:59:24.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600060708932141066" data-draft-id="7600034446947303462" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="老项目 Vue2 函数式打开弹层【附源码】"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2026-01-28T05:59:24.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="程序员大卫"/> <meta itemprop="url" content="https://juejin.cn/user/1961184474695213"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            老项目 Vue2 函数式打开弹层【附源码】
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1961184474695213/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    程序员大卫
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-28T05:59:24.000Z" title="Wed Jan 28 2026 05:59:24 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-28
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    4
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>大家好，我是<strong>前端架构师</strong>，关注微信公众号【@<strong>程序员大卫</strong>】免费领取前端精品资料。</p>
<h2 data-id="heading-0">前言</h2>
<p>在老项目（Vue2 + ElementUI）里写弹层，大家一定很熟悉下面这种写法：</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">dialog-test</span>
  <span class="hljs-attr">v-if</span>=<span class="hljs-string">"dialogVisible"</span>
  <span class="hljs-attr">:text</span>=<span class="hljs-string">"text"</span>
  @<span class="hljs-attr">confirm</span>=<span class="hljs-string">"handleConfirm"</span>
  @<span class="hljs-attr">close</span>=<span class="hljs-string">"dialogVisible = false"</span>
/&gt;</span>
</code></pre>
<p>问题是：</p>
<ul>
<li>每个页面都要写一堆 <code>visible</code></li>
<li>关闭弹层还得手动销毁组件</li>
<li>多个弹层时，代码又臭又长</li>
<li>只是想 <strong>“点个按钮弹个框”</strong>，却要改一堆模板</li>
</ul>
<p>所以我在老项目里封装了一个 <strong>函数式打开弹层</strong> 的方法：</p>
<ul>
<li>不用写 template，不用定义变量 dialogVisible</li>
<li>直接 JS 调用</li>
<li>自动创建 / 销毁</li>
<li>支持缓存，不销毁反复用</li>
</ul>
<h2 data-id="heading-1">最终效果</h2>
<p>像这样直接调用即可：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-title function_">dialogOpen</span>(
  <span class="hljs-title class_">DialogTest</span>,
  {
    <span class="hljs-attr">text</span>: <span class="hljs-string">"Hello World!"</span>,
    <span class="hljs-attr">onConfirm</span>: <span class="hljs-function">(<span class="hljs-params">text</span>) =&gt;</span> {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(text);
    },
  },
  { <span class="hljs-attr">context</span>: <span class="hljs-variable language_">this</span> },
);
</code></pre>
<p>一句话总结：</p>
<blockquote>
<p><strong>把“写组件”这件事，变成“调函数”</strong></p>
</blockquote>
<h2 data-id="heading-2">一、弹层组件本身（DialogTest.vue）</h2>
<p>这个组件本身非常普通，没有任何黑魔法。</p>
<pre><code class="hljs language-vue" lang="vue">&lt;template&gt;
  &lt;el-dialog title="提示" visible width="30%" @close="doClose" append-to-body&gt;
    &lt;span&gt;{{ text }}&lt;/span&gt;

    &lt;span slot="footer" class="dialog-footer"&gt;
      &lt;el-button type="primary" @click="doCancle"&gt;取消&lt;/el-button&gt;
      &lt;el-button type="primary" @click="doConfirm"&gt;确 定&lt;/el-button&gt;
    &lt;/span&gt;
  &lt;/el-dialog&gt;
&lt;/template&gt;
</code></pre>
<h3 data-id="heading-3">关键点说明</h3>
<ul>
<li><code>visible</code> 由外部控制（函数式传入）</li>
<li>所有行为通过 <code>$emit</code> 往外抛</li>
</ul>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-attr">name</span>: <span class="hljs-string">"DialogTest"</span>, <span class="hljs-comment">// ⚠️ 必须有 name，后面做缓存用</span>
  <span class="hljs-attr">props</span>: {
    <span class="hljs-attr">text</span>: <span class="hljs-title class_">String</span>,
  },
  <span class="hljs-attr">methods</span>: {
    <span class="hljs-title function_">doClose</span>(<span class="hljs-params"/>) {
      <span class="hljs-variable language_">this</span>.$emit(<span class="hljs-string">"close"</span>);
    },
    <span class="hljs-title function_">doCancle</span>(<span class="hljs-params"/>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">doClose</span>();
    },
    <span class="hljs-title function_">doConfirm</span>(<span class="hljs-params"/>) {
      <span class="hljs-variable language_">this</span>.$emit(<span class="hljs-string">"confirm"</span>, <span class="hljs-string">"点击确认按钮"</span>);
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">doClose</span>();
    },
  },
};
</code></pre>
<blockquote>
<p><strong>记住一句话：组件只负责展示和抛事件，不管怎么被创建。</strong></p>
</blockquote>
<h2 data-id="heading-4">二、核心思路：函数式弹层是怎么实现的？</h2>
<p>一句话概括实现原理：</p>
<blockquote>
<p><strong>用 <code>new Vue()</code> 在 JS 里动态创建组件，并手动挂载到 body 上</strong></p>
</blockquote>
<p>也就是说，我们不再依赖 template，而是：</p>
<ol>
<li>JS 创建 Vue 实例</li>
<li>render 一个 Dialog 组件</li>
<li>挂载到 DOM</li>
<li>关闭时销毁或隐藏</li>
</ol>
<h2 data-id="heading-5">三、dialogOpen.js 整体结构说明</h2>
<p>我们先看函数签名：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-title function_">dialogOpen</span>(<span class="hljs-title class_">Component</span>, props = {}, options = {})
</code></pre>
<h3 data-id="heading-6">三个参数分别是：</h3>





























<table><thead><tr><th>参数</th><th>说明</th></tr></thead><tbody><tr><td>Component</td><td>弹层组件</td></tr><tr><td>props</td><td>传给组件的 props + 事件</td></tr><tr><td>options.context</td><td>当前页面的 this</td></tr><tr><td>options.destroyOnClose</td><td>关闭是否销毁（默认 true）</td></tr><tr><td>options.key</td><td>缓存 key</td></tr></tbody></table>
<h2 data-id="heading-7">四、为什么必须传 context？</h2>
<pre><code class="hljs language-js" lang="js"><span class="hljs-title function_">dialogOpen</span>(<span class="hljs-title class_">DialogTest</span>, {...}, { <span class="hljs-attr">context</span>: <span class="hljs-variable language_">this</span> })
</code></pre>
<p>这是很多人第一次看不懂的地方。</p>
<h3 data-id="heading-8">原因只有一个：</h3>
<blockquote>
<p><strong>让弹层组件继承当前页面的 <code>$router</code>、<code>$store</code> 等上下文</strong></p>
</blockquote>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">new</span> <span class="hljs-title class_">Vue</span>({
  <span class="hljs-attr">parent</span>: context
})
</code></pre>
<p>否则：</p>
<ul>
<li><code>$router</code> 可能是 undefined</li>
<li><code>$store</code> 用不了</li>
<li>inject / provide 失效</li>
</ul>
<h2 data-id="heading-9">五、props 和事件是如何区分的？</h2>
<p>调用时我们这样写：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-title function_">dialogOpen</span>(<span class="hljs-title class_">DialogTest</span>, {
  <span class="hljs-attr">text</span>: <span class="hljs-string">"Hello World"</span>,
  <span class="hljs-attr">onConfirm</span>: <span class="hljs-function">() =&gt;</span> {},
  <span class="hljs-attr">onClose</span>: <span class="hljs-function">() =&gt;</span> {}
})
</code></pre>
<p>那问题来了：</p>
<ul>
<li>哪些是 props？</li>
<li>哪些是事件？</li>
</ul>
<h3 data-id="heading-10">解决方案：统一约定</h3>
<pre><code class="hljs language-js" lang="js">onXxx =&gt; 事件
其它 =&gt; props
</code></pre>
<p>对应代码：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> <span class="hljs-title function_">splitPropsAndListeners</span> = (<span class="hljs-params">input = {}</span>) =&gt; {
  <span class="hljs-keyword">const</span> props = {};
  <span class="hljs-keyword">const</span> on = {};

  <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">keys</span>(input).<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">key</span> =&gt;</span> {
    <span class="hljs-keyword">if</span> (<span class="hljs-regexp">/^on[A-Z]/</span>.<span class="hljs-title function_">test</span>(key) &amp;&amp; <span class="hljs-keyword">typeof</span> input[key] === <span class="hljs-string">'function'</span>) {
      <span class="hljs-keyword">const</span> event = key.<span class="hljs-title function_">slice</span>(<span class="hljs-number">2</span>).<span class="hljs-title function_">replace</span>(<span class="hljs-regexp">/^[A-Z]/</span>, <span class="hljs-function"><span class="hljs-params">s</span> =&gt;</span> s.<span class="hljs-title function_">toLowerCase</span>());
      on[event] = input[key];
    } <span class="hljs-keyword">else</span> {
      props[key] = input[key];
    }
  });

  <span class="hljs-keyword">return</span> { props, on };
};
</code></pre>
<p>最终会变成：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-title function_">h</span>(<span class="hljs-title class_">Component</span>, {
  <span class="hljs-attr">props</span>: { text },
  <span class="hljs-attr">on</span>: { confirm, close }
})
</code></pre>
<h2 data-id="heading-11">六、真正创建弹层的地方（核心代码）</h2>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">let</span> wrapperVm = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Vue</span>({
  <span class="hljs-attr">parent</span>: context,
  <span class="hljs-title function_">data</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> {
      <span class="hljs-attr">rawProps</span>: initialProps
    };
  },
  <span class="hljs-attr">computed</span>: {
    <span class="hljs-title function_">vnodeData</span>(<span class="hljs-params"/>) {
      <span class="hljs-keyword">const</span> { props, on } = <span class="hljs-title function_">splitPropsAndListeners</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">rawProps</span>);
      <span class="hljs-keyword">return</span> { props, on };
    }
  },
  <span class="hljs-title function_">render</span>(<span class="hljs-params">h</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-title function_">h</span>(<span class="hljs-title class_">Component</span>, {
      <span class="hljs-attr">props</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">vnodeData</span>.<span class="hljs-property">props</span>,
      <span class="hljs-attr">on</span>: {
        ...<span class="hljs-variable language_">this</span>.<span class="hljs-property">vnodeData</span>.<span class="hljs-property">on</span>,
        <span class="hljs-attr">close</span>: <span class="hljs-function">(<span class="hljs-params">...args</span>) =&gt;</span> {
          <span class="hljs-variable language_">this</span>.<span class="hljs-property">vnodeData</span>.<span class="hljs-property">on</span>.<span class="hljs-property">close</span>?.(...args);
          <span class="hljs-title function_">closeHandler</span>();
        }
      }
    });
  }
});
</code></pre>
<h3 data-id="heading-12">这里发生了什么？</h3>
<ol>
<li><code>rawProps</code> 保存所有传入参数</li>
<li><code>computed</code> 动态拆分 props / 事件</li>
<li><code>render</code> 手动渲染组件</li>
<li>拦截 <code>close</code>，统一处理销毁逻辑</li>
</ol>
<h2 data-id="heading-13">七、弹层是怎么挂载到页面上的？</h2>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">let</span> container = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">'div'</span>);
<span class="hljs-variable language_">document</span>.<span class="hljs-property">body</span>.<span class="hljs-title function_">appendChild</span>(container);
wrapperVm.$mount(container);
</code></pre>
<p>👉 这一步相当于：</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- Dialog 组件 --&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>
</code></pre>
<h2 data-id="heading-14">八、关闭时销毁 vs 不销毁（缓存机制）</h2>
<h3 data-id="heading-15">默认行为（destroyOnClose = true）</h3>
<pre><code class="hljs language-js" lang="js">wrapperVm.$destroy();
<span class="hljs-title function_">removeElement</span>(wrapperVm.<span class="hljs-property">$el</span>);
</code></pre>
<p><strong>好处：</strong></p>
<ul>
<li>不占内存</li>
<li>最安全</li>
</ul>
<h3 data-id="heading-16">开启缓存（destroyOnClose = false）</h3>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> instanceCache = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>();
</code></pre>
<ul>
<li>同一个 key 只创建一次</li>
<li>关闭时只是 <code>visible = false</code></li>
<li>再次打开直接复用</li>
</ul>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">if</span> (!destroyOnClose &amp;&amp; instanceCache.<span class="hljs-title function_">has</span>(key)) {
  <span class="hljs-keyword">const</span> cacheWrapperVm = instanceCache.<span class="hljs-title function_">get</span>(key);
  cacheWrapperVm.<span class="hljs-title function_">updateProps</span>(initialProps);
  <span class="hljs-keyword">return</span> cacheWrapperVm.<span class="hljs-property">triggerClose</span>;
}
</code></pre>
<p>适合：</p>
<ul>
<li>表单弹层</li>
<li>频繁打开的弹窗</li>
</ul>
<h2 data-id="heading-17">九、为什么要监听页面销毁？</h2>
<pre><code class="hljs language-js" lang="js">context.$once(<span class="hljs-string">'hook:beforeDestroy'</span>, destroy);
</code></pre>
<p>防止：</p>
<ul>
<li>页面销毁了</li>
<li>弹层还留在 body</li>
<li>造成内存泄漏</li>
</ul>
<h2 data-id="heading-18">十、总结</h2>
<p>这个方案适合：</p>
<ul>
<li>Vue2 老项目</li>
<li>ElementUI 弹层</li>
<li>不想每个页面都写 dialog</li>
</ul>
<h2 data-id="heading-19">附源码</h2>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fzm8%2Fwechat-oa%2Ftree%2Fmain%2Fexamples%2Fvue2-dialogOpen" target="_blank" title="https://github.com/zm8/wechat-oa/tree/main/examples/vue2-dialogOpen" ref="nofollow noopener noreferrer">github.com/zm8/wechat-…</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[GC性能之王：ZGC（含分代ZGC解释）]]></title>    <link>https://juejin.cn/post/7600229327436218418</link>    <guid>https://juejin.cn/post/7600229327436218418</guid>    <pubDate>2026-01-28T10:49:35.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600229327436218418" data-draft-id="7600234310964887590" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="GC性能之王：ZGC（含分代ZGC解释）"/> <meta itemprop="keywords" content="Java"/> <meta itemprop="datePublished" content="2026-01-28T10:49:35.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Lystran"/> <meta itemprop="url" content="https://juejin.cn/user/2052152412356427"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            GC性能之王：ZGC（含分代ZGC解释）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2052152412356427/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Lystran
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-28T10:49:35.000Z" title="Wed Jan 28 2026 10:49:35 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-28
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读25分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>原文链接：<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.lystran.com%2Fposts%2Fbackend%2Fjvm%2Fjvm-zgc%3Futm_source%3Djuejin%26utm_medium%3Dwebsite" target="_blank" title="https://www.lystran.com/posts/backend/jvm/jvm-zgc?utm_source=juejin&amp;utm_medium=website" ref="nofollow noopener noreferrer">GC性能之王：ZGC（含分代ZGC解释）</a></p>
<p>感谢支持</p>
</blockquote>
<h2 data-id="heading-0">概论</h2>
<p>本文需要读者对Java GC有基本的认识，同时本文会多次与<strong>G1</strong>垃圾回收器进行对比，便于理解</p>
<p>在JDK21中推出了分代zgc，相对于不分代zgc，进一步提升了吞吐量，且cpu算力使用效率更高，本文<strong>先进行不分代zgc的解释</strong>，然后解释分代zgc（基本原理相同）。</p>
<h3 data-id="heading-1">特点</h3>
<ul>
<li>停顿时间（STW）不超过10ms</li>
<li>堆的大小和活跃对象的大小对停顿时间影响不大</li>
<li>支持最大16TB的内存（jdk15）</li>
</ul>
<p>由上可知，ZGC适合 <strong>大内存低延迟</strong> 服务的内存管理和回收</p>
<h3 data-id="heading-2">主要解决的痛点</h3>
<h4 data-id="heading-3">1. 停顿时间长</h4>
<p>在ZGC之前，jdk默认使用<strong>G1</strong>回收器，G1回收器使用<strong>标记-复制算法</strong>，在回收阶段（复制阶段）会暂停所有的应用线程（STW），复制完存活对象之后再恢复线程（虽然一般g1会为了保证一次的STW时间比较小，会分多次STW来对对象进行复制，但是总的STW时间是差不多的），这在<strong>堆的大小非常大</strong>的情况下时耗时非常高，会有较长的停顿时间，此时用户的感觉就是系统死机了一小段时间。</p>
<blockquote>
<p><strong>复制算法</strong>中的转移阶段需要分配新内存和复制对象的成员变量</p>
</blockquote>
<p>而且G1的<strong>再标记阶段</strong>（重新标记那些在并发标记阶段发生变化的对象）也是STW的，这个停顿时间也是和堆的大小有关系的，但是主要的停顿时间还是来源于<strong>回收阶段</strong>。</p>
<p><strong>ZGC 的解法</strong>：<strong>并发转移</strong></p>
<ul>
<li>ZGC进行转移和应用线程是并发的</li>
<li><strong>结果</strong>：ZGC 的 STW 时间跟<strong>堆的大小</strong>、<strong>存活对象的数量</strong>几乎无关，只跟<strong>根节点（GC Roots）的数量</strong>有关。所以不管堆是 10GB 还是 10TB，停顿都是常数级的。</li>
</ul>
<h4 data-id="heading-4">2. 不可预测性</h4>
<p>G1 的“不可预测性”随着堆变大而恶化</p>
<p>G1 的目标是“可预测停顿”（比如设置 <code>-XX:MaxGCPauseMillis=200</code>）。
G1 会尽力去满足这个目标，它会计算：“为了不超过 200ms，我这次只能回收 5 个 Region。”</p>
<ul>
<li><strong>G1 的痛点</strong>：当堆大到一定程度，或者内存碎片化严重时，G1 常常“<strong>食言</strong>”。
<ul>
<li>为了不 OOM（内存溢出），G1 有时被迫触发 <strong>Full GC</strong>。</li>
<li>G1 的 Full GC 以前是单线程的（后来改成了多线程），但依然是<strong>全堆 STW</strong>。那停顿时间就是灾难级的。</li>
</ul>
</li>
<li><strong>ZGC 的解法</strong>：<strong>O(1) 复杂度的停顿</strong>。
<ul>
<li>ZGC 彻底解耦了“停顿时间”和“堆大小”的关系。</li>
<li>通过<strong>并发转移</strong>直接避免了这种情况：无须对停顿进行预测，因为根本无须进行STW</li>
</ul>
</li>
</ul>
<h2 data-id="heading-5">关键技术</h2>
<p>ZGC通过<strong>着色指针</strong>和<strong>读屏障</strong>技术，解决了转移过程中<strong>准确访问对象</strong>的问题，实现了<strong>并发转移</strong>。</p>
<p>并发转移需要应对的问题：GC线程在转移对象的过程中，应用线程也在不停地访问对象，如果一个对象被转移了，但是对象地址还未来得及更新，如何保证应用线程能够准确访问到正确的对象地址而不是这个旧地址？</p>
<p>在ZGC中，应用线程访问对象将触发“<strong>读屏障</strong>”，如果发现对象被移动了，读屏障会把读出来的指针更新到对象的新地址上，这样访问到的就是正确的对象地址了。</p>
<p>但是JVM是如何判断对象被移动过呢？就是利用对象引用的地址，即<strong>着色指针</strong>。</p>
<blockquote>
<p>着色指针对应计算机科学中的 <strong>标签指针 Tagged Pointers</strong> 这个概念
这个技术的物理基础在于：<strong>现代 CPU 的 64 位地址空间并没有被完全利用。</strong>
64 位指针可以寻址 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mn>2</mn><mn>64</mn></msup></mrow><annotation encoding="application/x-tex">2^{64}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8141em;"/><span class="mord"><span class="mord">2</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">64</span></span></span></span></span></span></span></span></span></span></span></span></span> 个字节（16 EB），这大得惊人；通常只使用了低 48 位来作为实际的内存地址（支持 256TB 内存），<strong>高 16 位是闲置的</strong>
既然高 16 位空着也是空着，我能不能在里面存点私货？ 这就是“染色指针/带标签指针”的由来——<strong>利用指针中未使用的位（Bits）来存储额外的元数据。</strong></p>
</blockquote>
<p>ZGC实际仅使用64位地址空间的第041位，而第4245位存储元数据，第47~63位固定为0。
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9e07282fde8d468db8dcb2a1205e5301~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTHlzdHJhbg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770202178&amp;x-signature=VA5ZCDphsQNpSqM1ChiNh%2B1zj%2Fc%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-6">着色指针</h3>
<p>ZGC仅支持64位系统，它把64位<strong>虚拟地址空间</strong>划分为多个子空间，如下图所示：
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7dfe0200c9f64113b7e81f30fb444a7a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTHlzdHJhbg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770202178&amp;x-signature=6GfGGy773%2BBTCke%2FjBp97HYGBiA%3D" alt="image.png" loading="lazy"/></p>
<p>其中，[0~4TB) 对应Java堆，[4TB ~ 8TB) 称为M0地址空间，[8TB ~ 12TB) 称为M1地址空间，[12TB ~ 16TB) 预留未使用，[16TB ~ 20TB) 称为Remapped空间。</p>
<p>当应用程序创建对象时，首先在<strong>堆空间</strong>申请一个虚拟地址，但该虚拟地址并不会映射到真正的物理地址。ZGC同时会为该对象在M0、M1和Remapped地址空间分别申请一个虚拟地址，且这三个虚拟地址对应<strong>同一个物理地址</strong>，但这三个空间在<strong>同一时间</strong>有且只有一个空间有效。这是ZGC中经典的<strong>以空间换时间</strong>的做法。</p>
<p>设置 M0、M1 这两个状态，是为了解决一个核心问题：<strong>如何在不暂停所有线程的情况下，区分“这一轮 GC 标记过的对象”和“上一轮 GC 留下的旧标记”？</strong>。ZGC会有一个全局变量存储当前GC轮次的有效标记（M0或M1），每轮<strong>标记阶段</strong>中这个变量都会在M0和M1之间切换，当在为M1的轮次中访问了M0的地址，就说明这是上一轮GC的旧标记，需要进行一系列更新操作（后文讲）</p>
<p>设置Remapped是为了表示“<strong>地址已更新（无需更新）</strong>”。将指针改为Remapped标记这个动作发生在<strong>并发转移</strong>阶段，线程每搬一个对象就会在搬完后将指针改为Remapped，下一次遇到就无须再搬了。</p>
<blockquote>
<p>另外：当M0/M1阶段遇到Remapped指针，会进行更新，更新为M0/M1,表示这个对象是存活的，只要理解：“标记阶段的任务是标记对象存活，会将对象标记更新为当前的合法标记，同时进行更新任务”就行</p>
</blockquote>
<blockquote>
<p><em>注：此处描述的是 ZGC 经典的基于多重映射的实现，JDK 21 的分代 ZGC 对此进行了底层架构层面的重构，详见后文‘分代 ZGC’章节。</em></p>
</blockquote>
<h2 data-id="heading-7">基本原理</h2>
<p>ZGC对<strong>标记-复制算法</strong>进行了重大改进：在<strong>标记</strong>、<strong>转移</strong>和<strong>重定位阶段</strong>几乎都是<strong>并发</strong>的，这是ZGC实现停顿时间小于10ms目标的最关键原因。</p>
<p>ZGC垃圾回收周期如下图所示：
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/40b870105db748d6b6a902ee864304db~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTHlzdHJhbg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770202178&amp;x-signature=pHrwiA7w50AMBmj2w17suP1prKE%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-8">ZGC内存结构</h3>
<p>对于G1固定大小的region，会有内存碎片的问题，而且对于大对象而言就是噩梦（需要多个region拼凑，巨形对象Humongous Region），甚至还需要通过 Full GC 来清理内存碎片（无法分配连续的Region给巨型对象使用）。</p>
<p>ZGC 抛弃了“固定大小”的执念。它引入了 <strong>Page（页面）</strong> 的概念（其实就是 Region 的变体），但是它支持<strong>三种尺寸</strong>，而且是<strong>动态创建</strong>的。</p>
<p>ZGC 的核心逻辑是：<strong>“对象多大，我就给你造多大的盒子，绝不强行拼凑。”</strong></p>
<p>ZGC 的 Page 分为三类：</p>
<h4 data-id="heading-9">A. Small Page（小页面）</h4>
<ul>
<li><strong>容量</strong>：固定 <strong>2MB</strong>。</li>
<li><strong>适用对象</strong>：小型对象（Size ≤ 256KB）。</li>
<li><strong>特点</strong>：这里面挤满了各种小对象，利用率很高。</li>
<li><strong>占比</strong>：这是最常用的页面类型。</li>
</ul>
<h4 data-id="heading-10">B. Medium Page（中页面）</h4>
<ul>
<li><strong>容量</strong>：固定 <strong>32MB</strong>。</li>
<li><strong>适用对象</strong>：中型对象（256KB &lt; Size ≤ 4MB）。</li>
<li><strong>特点</strong>：专门用来存那些“不大不小”的对象，避免它们去挤占小页面，或者浪费大页面。</li>
</ul>
<h4 data-id="heading-11">C. Large Page（大页面）—— 应对巨型对象</h4>
<ul>
<li><strong>容量</strong>：<strong>动态变化</strong>（N × 2MB）。</li>
<li><strong>适用对象</strong>：大型对象（Size &gt; 4MB）。</li>
<li><strong>特点</strong>：
<ol>
<li><strong>量身定做</strong>：如果你要存一个 7MB 的对象，ZGC 就给你分配一个 8MB（4 × 2MB）的 Page。如果你要存 20MB，就分配 20MB 的 Page。</li>
<li><strong>独享</strong>：<strong>Large Page 里只能存 1 个对象！</strong> 它是为这个大对象专属定制的。</li>
<li><strong>不重分配</strong>：在 GC 过程中，Small/Medium Page 里的对象会被搬运（复制），但 <strong>Large Page 里的对象永远不会被搬运</strong>。ZGC 只是修改一下页面的映射关系（Remap），因为搬运大对象的成本太高了。</li>
</ol>
</li>
</ul>
<h3 data-id="heading-12">ZGC过程（一个GC周期）</h3>
<h4 data-id="heading-13">第一步：初始标记 (Pause Mark Start) —— 【STW】</h4>
<ul>
<li><strong>干什么</strong>：标记 <strong>根节点（GC Roots）</strong> 直接引用的对象。</li>
<li><strong>耗时</strong>：极短（仅跟线程数量和根节点数量有关，与堆大小无关）。</li>
<li><strong>关键动作</strong>：切换全局视图（比如从 Remapped 切到 M0）。</li>
</ul>
<h4 data-id="heading-14">第二步：并发标记 (Concurrent Mark) —— 【并发】</h4>
<ul>
<li><strong>干什么</strong>：从根节点出发，顺藤摸瓜遍历整个对象图，给活对象“染色”（标记为当前全局视图合法的标记M0/M1, 以及在位图上标记）。
<blockquote>
<p>ZGC中存在一个<strong>全局的Bitmap（Live map）</strong>，用于标记<strong>某个位置</strong>是否存在对象以及该对象是否为存活的（1为存活对象，0为可回收对象或者无对象），这可以大幅度加快zgc寻找存活对象的时间（比如并发转移时），但是只在<strong>当前gc周期</strong>中有效</p>
</blockquote>
</li>
<li><strong>自愈</strong>：如果有应用线程在此时访问了对象，<strong>读屏障</strong>会介入，分担标记线程的工作，顺便把当前对象标记为存活，确保读到的指针是当前视图颜色的（自愈：将坏指针变成好指针）。</li>
</ul>
<h5 data-id="heading-15">G1和ZGC的并发标记对比</h5>
<p>G1的并发标记阶段是用于对老年代的回收，当达到了设置的 IHOP（老年代在堆的占比），比如45%，G1才开始触发并发标记阶段
<strong>缺点</strong>：这是一种“<strong>反应式</strong>”的逻辑。如果你的流量突然暴涨，内存瞬间填满，G1 可能来不及反应，直接导致 Full GC。</p>
<p>ZGC引入了“<strong>分配速率自适应</strong>”</p>
<ul>
<li><strong>原理</strong>：ZGC 会根据历史数据计算当前的对象<strong>平均分配速率</strong>（Allocation Rate）和<strong>分配峰值</strong>（Spike）。它会计算：“按照现在的分配速度，堆内存还能撑多久？”以及“GC 完成一轮回收需要多久？”。当分配速率变快时，ZGC 会自动提前触发 GC 周期，预留更多的缓冲空间，以确保在堆内存耗尽前完成回收。</li>
</ul>
<p><strong>触发规则</strong>：</p>
<blockquote>
<p><strong>当（剩余可用内存 / 分配速率） &lt; （GC 耗时 + 安全缓冲时间） 时，立即触发 GC。</strong></p>
</blockquote>
<p>同时，ZGC还引入了 <strong>流量整形(Allocation Pacing)</strong>
当<strong>内存分配速率</strong>超过了gc回收速率，ZGC 不会直接抛出 OOM 错误，也不会像传统 GC 那样直接进行长时间的 Full GC 停顿。ZGC 会在应用线程<strong>申请内存时</strong>引入微小的停顿，强制应用线程“慢下来”。降低内存分配速率，至少避免了Full GC甚至OOM</p>
<h4 data-id="heading-16">第三步：标记结束停顿 (Pause Mark End) —— 【STW】</h4>
<ul>
<li><strong>干什么</strong>：处理并发期间遗留的少量边缘情况（比如弱引用、并发期间新产生的引用变化）。</li>
<li><strong>耗时</strong>：极短（1ms 左右）。</li>
<li><strong>结束</strong>：此时，谁是活的、谁是垃圾，已经全部算清楚了。</li>
</ul>
<p><strong>再标记阶段主要的任务：</strong>
它主要处理那些“<strong>不能靠读屏障解决</strong>”的边缘情况：</p>
<ol>
<li><strong>线程局部标记栈 (Thread-Local Mark Stacks)</strong>：
<ul>
<li>并发标记期间，每个线程都有自己的小本本，记了一些还没来得及提交到全局的标记信息。STW 时候要汇总一下。</li>
</ul>
</li>
<li><strong>弱引用/软引用/虚引用 (Weak/Soft/Phantom References)</strong>：
<ul>
<li>这些引用的处理逻辑比较特殊，通常需要在 STW 下做最终判定（虽然 ZGC 做了很多并发处理，但最终清理还是需要一点点 STW 时间）。</li>
</ul>
</li>
<li><strong>字符串去重/符号表清理</strong>：
<ul>
<li>一些 JVM 内部的杂活。</li>
</ul>
</li>
</ol>
<h5 data-id="heading-17">与G1再标记(Remark)区分</h5>
<p>G1需要一个STW时间，去处理剩下的<strong>SATB日志缓冲区</strong>和所有更新，找出所有未被访问的存活对象，这些都是G1并发标记中用户线程操作对象导致的，是实打实的需要重新更新的对象</p>
<h4 data-id="heading-18">第四步：并发准备 (Concurrent Prepare for Relocate) —— 【并发】</h4>
<p><strong>干什么</strong>：
1. <strong>选出重分配集（Relocation Set）</strong>：挑出那些<strong>垃圾最多的 Page</strong>，准备回收它们。
2. <strong>创建转发表（Forwarding Table）</strong>：为这些 Page 初始化一张表，用来记录“旧地址 -&gt; 新地址”的映射。</p>
<h4 data-id="heading-19">第五步：初始转移 (Pause Relocate Start) —— 【STW】</h4>
<ul>
<li><strong>干什么</strong>：<strong>只搬运</strong> 被 <strong>根节点</strong> 直接引用的对象（且这些对象在重分配集中）。</li>
<li><strong>为什么停顿</strong>：因为要修改线程栈里的指针，必须暂停。</li>
<li><strong>耗时</strong>：极短（因为根引用的对象很少）。</li>
<li><strong>结果</strong>：根节点现在都指向了新地址（Remapped 状态）。</li>
</ul>
<h4 data-id="heading-20">第六步：并发转移 (Concurrent Relocation) —— 【并发】</h4>
<ul>
<li><strong>干什么</strong>：把重分配集里剩下的活对象，搬运到新 Page 中。</li>
<li><strong>自愈</strong>：
<ul>
<li><strong>搬家</strong>：GC 线程在后台搬。</li>
<li><strong>拦截</strong>：如果用户线程访问了还没搬走的对象，<strong>读屏障</strong>拦截，分担gc线程的工作，顺便帮忙搬走，并修正指针（自愈，与并发标记阶段的自愈一样，都是修复指针）。</li>
<li><strong>记录</strong>：搬运关系记录在<strong>转发表</strong>中。</li>
</ul>
</li>
</ul>
<h4 data-id="heading-21">第七步：并发重映射 (Concurrent Remap) —— 【并发】（通常合并到下一次 GC 的标记阶段）</h4>
<ul>
<li><strong>干什么</strong>：修正堆中所有指向旧地址的指针。</li>
<li><strong>说明</strong>：ZGC 很懒。对象搬走了，转发表也记了，但堆里可能还有几百万个指针指向旧地址。ZGC 不会专门花时间去修它们，而是<strong>留到下一次 GC 的“并发标记”阶段</strong>，顺路看到一个修一个。</li>
<li><strong>结果</strong>：当所有指针都修好了，<strong>旧 Page</strong> 和<strong>转发表</strong>才能真正释放。</li>
</ul>
<hr/>
<p>ZGC只有三个STW阶段：<strong>初始标记</strong>，<strong>再标记</strong>，<strong>初始转移</strong>。其中，初始标记和初始转移分别都只需要扫描所有GC Roots，其处理时间和GC Roots的数量成正比，一般情况耗时非常短；再标记阶段STW时间很短,一般最多1ms，超过1ms则再次进入并发标记阶段。</p>
<h2 data-id="heading-22">分代ZGC (Gen ZGC)</h2>
<p>分代zgc于jdk21被正式引入，分代zgc的出现，本质上是为了解决 <strong>“弱分代假说（Weak Generational Hypothesis）”</strong> 在不分代 ZGC中无法被利用而导致的效率瓶颈。（人话：重点扫年轻代，偶尔一起扫老年代）</p>
<p>分代zgc对于不分代zgc：吞吐量提升<strong>4倍</strong>、内存需求降低30%，Allocation Stall降低85%。</p>
<h3 data-id="heading-23">解决不分代ZGC的痛点</h3>
<ol>
<li>“<strong>分配速率上限（Allocation Stall）</strong>”问题
<ul>
<li><strong>非分代 ZGC 的问题</strong>：
<ul>
<li>因为不分代，ZGC 每次回收都必须扫描<strong>全堆</strong>。</li>
<li>如果你的应用狂创建对象（高分配速率），而 ZGC 扫描全堆的速度赶不上gc的速度，内存就会被填满。</li>
<li><strong>后果</strong>：触发 <strong>Allocation Stall</strong>，强制暂停应用线程，直到腾出空间。这会导致原本承诺的 &lt;1ms 停顿变成几百毫秒甚至更久。</li>
</ul>
</li>
<li><strong>分代 ZGC 的解决</strong>：
<ul>
<li>引入<strong>年轻代</strong>。绝大多数对象是“朝生夕死”的。</li>
<li>ZGC 只需要高频、快速地扫描这一小块区域，就能回收掉 90% 以上的垃圾。</li>
<li><strong>效果</strong>：回收速度大幅提升，能扛住极高的对象分配速率，不再容易“卡壳”。</li>
</ul>
</li>
</ul>
</li>
<li>CPU 资源利用率低
<ul>
<li><strong>非分代 ZGC 的问题</strong>：
<ul>
<li><strong>陪跑现象</strong>：老年代对象通常长期存活。在非分代 ZGC 中，每次 GC 都要去扫描、标记、重定位这些<strong>根本没变</strong>的老对象</li>
<li>这浪费了大量的 CPU 资源</li>
</ul>
</li>
<li><strong>分代 ZGC 的解决</strong>：
<ul>
<li><strong>忽略老年代</strong>：在 Minor GC 期间，完全不看 Old Gen（除非有跨代引用），CPU 资源全聚焦在“垃圾最多”的 Young Gen。</li>
<li><strong>结果</strong>：腾出了更多 CPU 给业务线程，<strong>吞吐量提升显著</strong>（通常提升 10%~20% 以上）。</li>
</ul>
</li>
</ul>
</li>
<li>内存开销过大
<ul>
<li><strong>非分代 ZGC 的问题</strong>：
<ul>
<li>为了维持低延迟，非分代 ZGC 需要预留较大的<strong>堆空间缓冲</strong>，否则容易来不及回收(Allocation Stall问题）。通常建议堆大小要比实际使用量大 2-3 倍。</li>
<li>底层使用多重映射(M0 M1 Remapped)，虽然物理内存不浪费，但<strong>虚拟内存地址</strong>占用极大。</li>
</ul>
</li>
<li><strong>分代 ZGC 的解决</strong>：
<ul>
<li>因为回收效率高，不需要预留那么大的 <strong>堆空间缓冲</strong> 也能跑得稳。</li>
<li><strong>相同堆大小下，分代 ZGC 能承载更多的业务负载</strong>；或者说，同样的业务负载，分代 ZGC 可以用更小的堆跑起来。</li>
</ul>
</li>
</ul>
</li>
<li>单次 GC 周期过长
<ul>
<li><strong>非分代 ZGC 的问题</strong>：
<ul>
<li><strong>GC 周期耗时</strong>与<strong>堆中存活对象的总数量</strong>成正比。如果存活对象多（比如几十 GB 的缓存），一轮 GC 可能要跑好几秒甚至更久。</li>
<li>虽然停顿（STW）很短，但 GC 线程长时间占用 CPU，会持续干扰业务。</li>
</ul>
</li>
<li><strong>分代 ZGC 的解决</strong>：
<ul>
<li>Minor GC 的耗时只与<strong>Young Gen 里的存活对象</strong>有关，通常极短。</li>
<li>GC 变成了“短平快”的节奏。</li>
</ul>
</li>
</ul>
</li>
</ol>
<h3 data-id="heading-24">分代模型</h3>
<p>在非分代 ZGC 中，Page 只有大小之分（Small/Medium/Large Page）。 在分代 ZGC 中，Page 除了大小，还多了<strong>代（Generation）</strong> 的属性。</p>
<ul>
<li><strong>Young Generation Pages</strong>（新生代）：
<ul>
<li>存放新分配的对象。</li>
<li><strong>特点</strong>：分配速度极快，回收频率极高。</li>
<li><strong>区别</strong>：这里不再需要像 G1 那样复杂的 Region Set，ZGC 依然用 Page 管理，但这些 Page 被打上了“Young”的标签。</li>
</ul>
</li>
<li><strong>Old Generation Pages</strong>（老年代）：
<ul>
<li>存放从 Young Gen 晋升过来的长寿对象。</li>
<li><strong>特点</strong>：只有在 Major GC 时才会被扫描。</li>
</ul>
</li>
</ul>
<h4 data-id="heading-25">RSet（Remembered Set）</h4>
<p>引入 <strong>RSet（Remembered Set）</strong> 来解决跨代引用，RSet是分代gc的通用做法，目的是为了在进行 Minor GC 时，不用扫描整个老年代。</p>
<p>对比<strong>G1</strong>的RSet：哈希表 + 卡表，每个 Region 都有一个独立的 RSet（哈希表）,需要记录“<strong>谁引用了我</strong>”，例如，Region B 的 RSet 会记录：“Region A 的第 5 张卡片引用了我”，这样做内存占用高，且维护更加昂贵（需要一个优化线程不断处理写屏障产生的脏卡片）</p>
<p><strong>分代ZGC</strong> 的 RSet：<strong>双重缓冲位图（Double-Buffered Bitmaps）</strong>，精度是<strong>精确到具体的对象字段地址</strong></p>
<ul>
<li><strong>结构</strong>：<strong>没有全局卡表，也没有独立的哈希表</strong>。
<ul>
<li>它依赖的是挂在每个老年代分页（ZPage）上的 **双重缓冲位图。</li>
<li>每个分页有两套位图：一套给<strong>应用线程写</strong>，一套给 <strong>GC 线程读</strong>。</li>
</ul>
</li>
<li><strong>记录内容</strong>：
<ul>
<li><strong>不是</strong>记录“哪块内存(Card)脏了”（粗粒度）。</li>
<li><strong>而是</strong>精确记录“<strong>老年代对象中，哪个具体字段持有年轻代的引用</strong>”。</li>
<li><strong>精度</strong>：1 个 bit 对应内存中一个可能的指针位置（精确度极高）。</li>
</ul>
</li>
<li><strong>工作流程（双重缓冲机制）</strong>：
<ol>
<li><strong>应用线程</strong>：通过写屏障，直接在当前的位图上标记具体的字段地址</li>
<li><strong>GC 开始时</strong>：原子交换两个位图</li>
<li><strong>GC 线程</strong>：读取刚才写满的位图，扫描精确的地址，无需扫描周围无关内存</li>
</ol>
</li>
<li><strong>优势</strong>：
<ul>
<li><strong>无并发冲突</strong>：应用线程和 GC 线程操作不同的位图，不需要锁，也不需要内存屏障</li>
<li><strong>无需后台线程</strong></li>
<li><strong>扫描极快</strong>：因为记录的是精确地址，GC 扫描时可以直接定位，不像卡表那样扫描一整个Card的范围。</li>
</ul>
</li>
</ul>
<h4 data-id="heading-26">处理跨代</h4>
<p>由上一节可知：分代ZGC通过RSet来解决跨代引用问题，分代ZGC对于不分代ZGC，还新增了<strong>读屏障(Store Barrier)</strong>，当一个<strong>老年代对象</strong>新增了对<strong>年轻代对象</strong>的引用指针时（<code>oldObj.var = youngObj</code>）,写屏障会介入，它会先检查当前对象（oldObj）是否在老年代，如果是老年代对象，直接在<strong>位图</strong>上把这个<strong>老年代对象的这个引用字段</strong>对应的<strong>位</strong>标记为1，开销很小。</p>
<p>进行Minor GC时，GC线程直接扫描<strong>RemSet Bitmap（记忆集位图）</strong> 中设置为1的位，直接根据位图定位到内存地址，读取指针，将其指向的年轻代对象<strong>标记为存活</strong>。</p>
<p>且 ZGC 倾向于更快地让对象晋升,被老年代引用的这个年轻代对象只会经过较少次数的标记就能得到晋升，从而消除跨代引用，减少 RSet 的负担。</p>
<h4 data-id="heading-27">GC触发时机</h4>
<p>在分代 ZGC 中，<strong>Major GC 和 Minor GC 是完全独立的</strong>，且也都是可以与应用线程并发执行的，甚至Major GC与Minor GC之间也可以并发执行</p>
<ul>
<li><strong>Minor GC</strong>：
<ul>
<li><strong>触发</strong>：Eden 区满了就触发。</li>
<li><strong>行为</strong>：只回收年轻代。</li>
</ul>
</li>
<li><strong>Major GC</strong>：
<ul>
<li><strong>触发</strong>：继承了 不分代ZGC 核心的“<strong>自适应预测</strong>”，但其监控的核心指标从“<strong>内存分配速率</strong>”变成了“<strong>对象晋升速率</strong>”。</li>
<li><strong>行为</strong>：<strong>只回收老年代</strong>（这与 G1 Mixed GC 不同）。</li>
<li><strong>并发性</strong>：Major GC 运行时，应用线程依然可以分配对象（在年轻代），甚至可能在 Major GC 进行的过程中，穿插发生多次 Minor GC。[</li>
</ul>
</li>
</ul>
<p>Major GC通过预测<strong>对象晋升速率</strong>来决定触发：</p>
<ol>
<li><strong>晋升速率 (Promotion Rate)</strong>：
<ul>
<li>Minor GC 结束后，有多少对象存活并被移动到了老年代。</li>
<li>ZGC 会计算这个速率的平均值和峰值。</li>
</ul>
</li>
<li><strong>老年代回收耗时 (Old GC Duration)</strong>：
<ul>
<li>基于历史数据，预测完成一轮老年代并发标记和并发转移<strong>需要多少时间</strong>。</li>
</ul>
</li>
</ol>
<p><strong>触发公式逻辑</strong>：
<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>T</mi><mtext>老年代堆满的时间</mtext></msub><mo>&lt;</mo><msub><mi>T</mi><mtext>老年代回收耗时</mtext></msub><mo>+</mo><mtext>安全缓冲时间</mtext></mrow><annotation encoding="application/x-tex">T_{\text{老年代堆满的时间}} &lt; T_{\text{老年代回收耗时}} + \text{安全缓冲时间}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord cjk_fallback mtight">老年代堆满的时间</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">&lt;</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord cjk_fallback mtight">老年代回收耗时</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord text"><span class="mord cjk_fallback">安全缓冲时间</span></span></span></span></span></span></p>
<p>当预测到“<strong>老年代剩余空间被填满的时间</strong>”快要小于“<strong>老年代回收所需的时间</strong>”时，ZGC 就会立即触发 Major GC</p>
<hr/>
<p><strong>此外ZGC还引入了两个机制：</strong></p>
<ol>
<li>兜底触发规则：High Usage Rule (高占用阈值)</li>
</ol>
<p>如果预测模型失效（例如流量极其突发，或者历史数据不足），ZGC 还有一个保底机制。</p>
<ul>
<li><strong>逻辑</strong>：当老年代的内存占用率达到一个<strong>固定阈值</strong>时，强制触发 Major GC。</li>
<li><strong>动态调整</strong>：这个阈值不是固定的。ZGC 会根据堆的大小和历史 GC 的效率动态调整这个阈值，通常会在老年代占用较高时（例如 75% 或更高，具体取决于<strong>启发式算法</strong>）强制介入。</li>
</ul>
<ol start="2">
<li>主动触发规则：Proactive Rule (主动回收)</li>
</ol>
<p>如果系统当前比较空闲（晋升速率很低），老年代可能很久都不会满。为了避免垃圾长期堆积导致内存浪费，ZGC 会在系统负载较低时“主动”发起一次 Major GC。</p>
<h3 data-id="heading-28">染色指针优化</h3>
<p><strong>不分代ZGC</strong>使用<strong>多重映射（Multi-Mapping）</strong>，即将多段虚拟内存映射到同一段物理内存（3个识视图M0、M1、Remapped，这3种是不同的堆内存指针），这种技巧非常消耗文件描述符和内存映射表，且不仅限制了堆大小（最大 16TB），还让元数据管理很麻烦。</p>
<blockquote>
<p>而且操作系统可能还会错误地通报内存使用量，显示的内存占用是实际的3倍，而且因为虚拟地址的不同，对于Linux系统而言，还会占用更多的页表缓存 <strong>TLB(Translation Lookaside Buffer)</strong> ，而且每次都要进行切换</p>
</blockquote>
<p><strong>分代ZGC</strong>抛弃了多重映射，使用新的<strong>染色指针</strong>数据结构，它直接在 64 位指针的<strong>低位</strong>（不再是高位）存储元数据（颜色位），且优化了屏障代码，在<strong>读写屏障</strong>中直接处理这些颜色位，而不再依赖操作系统层面的虚拟地址别名，指令数更少，屏障指令更快。</p>
<h4 data-id="heading-29">显式的元数据</h4>
<p>不同于<strong>不分代ZGC</strong>的<strong>多重映射</strong>（通过操作系统虚拟地址别名实现的），操作系统“隐式”地解决了地址转换问题，只需要访问对应的虚拟地址就行。</p>
<p>在<strong>分代ZGC</strong>中，依然利用指针存储颜色信息，但<strong>不再依赖操作系统映射</strong>，ZGC 的 <strong>JIT 编译器</strong>会在每次访问内存前，插入一条<strong>位运算指令</strong>，<strong>消除颜色位</strong>，还原成纯净的内存地址，然后再交给 CPU 去访问，需要对元数据进行“<strong>显式</strong>”地读取和处理，这样就没有多重映射那些问题了。</p>
<blockquote>
<p>这个消除颜色位的指令是一个位运算，CPU运行位运算指令的速度极快，基本都可以忽略</p>
</blockquote>
<p>对于写屏障，处理的逻辑和不分代ZGC相同，就是查看指针的颜色是否为当前内存识图的颜色，如果是就直接放行，如果不是就进行一系列处理</p>
<h3 data-id="heading-30">内存屏障优化</h3>
<h4 data-id="heading-31">引入写屏障</h4>
<p>分代ZGC还引入了<strong>写屏障(Store Barrier)</strong>，上文已经描述，用于解决跨代引用的相关问题。</p>
<p>同时，写屏障还有以下的功能：</p>
<p><strong>自愈</strong>：当创建了一个引用时，写屏障介入，写屏障会帮忙将该对象标记为<strong>存活</strong>，将当前指针修改为当前视图的正确颜色。
<em>注意：比如执行<code>obj.field = var</code>时，变量<code>val</code>可能来自寄存器或栈，它的指针颜色可能是“坏”的（例如指向旧地址，或者颜色位是上一轮 GC 的），此时写指针还有“修复指针颜色”，或者“查找转发表设置为正确的地址”的功能</em></p>
<p><strong>SATB 标记屏障</strong>：这也是写屏障内部的一段逻辑代码，类似于G1的SATB，GC 流程开始时，逻辑上认为堆是一个静态快照。当执行<code>obj.field = var</code>时，zgc会将<code>obj.field</code>引用的原来的对象放入 SATB 缓冲区，GC线程会扫描这个缓冲区，把旧的那个对象标记为存活；下一小节会详细描述下。</p>
<h4 data-id="heading-32">轻量读屏障</h4>
<p>众所周知，一个系统中<strong>读操作</strong>一般远大于写操作，不分代zgc引入了读屏障，导致进行读操作时还需要执行一段读屏障代码，所以一般情况下不分代ZGC的<strong>吞吐量</strong>会小于G1</p>
<p>一方面原因是<strong>不分代zgc</strong>的读屏障<strong>职责过重</strong>，不仅要进行重定位的操作（查询转发表修改为正确的地址），还要进行标记的工作（并发标记阶段读屏障会帮助gc线程进行标记任务）</p>
<p><strong>分代ZGC</strong>进行了一些优化，让读屏障主要就进行<strong>重定位</strong>和<strong>分代状态检查</strong>的工作，然后通过<strong>写屏障</strong>和<strong>SATB(Snapshot-At-The-Beginning)</strong> 算法，将标记任务彻底转移给了写屏障和后台的并发标记线程</p>
<p>工作方式和G1的相似，即将断开的引用对象放入SATB 缓冲区，GC线程会扫描这个缓冲区，把旧的那个对象标记为存活，然后<strong>下一轮GC再进行处理</strong> ，会产生浮动垃圾，但至少不会误清理存活的对象</p>
<p>这样做，有效地提高了系统的<strong>吞吐量</strong></p>
<h4 data-id="heading-33">性能优化</h4>
<h5 data-id="heading-34">快慢路径</h5>
<p>在<strong>分代 ZGC</strong> 中，因为要维护 RSet，应用线程每次修改老年代对象的引用时，都必须触发<strong>写屏障</strong>。如果每次写操作都直接调用 C++ 代码去更新位图，性能会拉胯。</p>
<p>所以，ZGC 设计了 <strong>快路径（Fast Path）</strong> 和 <strong>慢路径（Slow Path）</strong> 的层级结构。</p>
<p>快路径检测是否<strong>需要额外的 GC 工作</strong>，当需要时，会跳转进入<strong>慢路径</strong>，开始相关工作。快路径由 JIT 实现，会在编译时直接将GC代码插入到屏障的位置，而无须进行函数调用。而慢路径不经常调用，所以使用 C++ 实现。</p>
<h5 data-id="heading-35">写屏障缓冲这（中间路径）</h5>
<p>通过引入快路径，并且结合染色指针技术，可以有效减少对 C++ 慢路径函数的调用次数。除了<strong>快路径</strong>和<strong>慢路径</strong>，分代 ZGC 还进一步对<strong>写屏障</strong>加入 JIT 编译的<strong>中间路径</strong></p>
<p>如果快路径检查通过，说明需要记录 RSet。但如果<strong>立刻去更新</strong>那个复杂的“双重位图”，或者调用 C++ 函数，开销太大（需要寄存器保存、栈切换等操作）。</p>
<p>中间路径将<strong>待覆盖的值</strong>和<strong>对象字段的地址</strong>存储在<strong>写屏障缓冲区</strong>中,随后<strong>直接返回</strong>至已编译的应用程序代码，从而避开了昂贵的慢路径。只有当写屏障缓冲区<strong>填满</strong>时，才会触发慢路径。这种机制分摊了从已编译应用代码切换到 C++ 慢路径代码所产生的性能损耗。</p>
<h2 data-id="heading-36">参考文献</h2>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwiki.openjdk.org%2Fspaces%2Fzgc%2Fpages%2F34668579%2FMain" target="_blank" title="https://wiki.openjdk.org/spaces/zgc/pages/34668579/Main" ref="nofollow noopener noreferrer">ZGC Wiki</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftech.meituan.com%2F2020%2F08%2F06%2Fnew-zgc-practice-in-meituan.html" target="_blank" title="https://tech.meituan.com/2020/08/06/new-zgc-practice-in-meituan.html" ref="nofollow noopener noreferrer">新一代垃圾回收器ZGC的探索与实践</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fopenjdk.org%2Fjeps%2F439" target="_blank" title="https://openjdk.org/jeps/439" ref="nofollow noopener noreferrer">JEP439</a></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[3分钟Solidity: 15.9 DeFi - Uniswap V4 兑换]]></title>    <link>https://juejin.cn/post/7599917711792930826</link>    <guid>https://juejin.cn/post/7599917711792930826</guid>    <pubDate>2026-01-27T16:04:16.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7599917711792930826" data-draft-id="7599852042530193418" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="3分钟Solidity: 15.9 DeFi - Uniswap V4 兑换"/> <meta itemprop="keywords" content="Solidity,web3,智能合约"/> <meta itemprop="datePublished" content="2026-01-27T16:04:16.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Rockbean"/> <meta itemprop="url" content="https://juejin.cn/user/4054654615823560"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            3分钟Solidity: 15.9 DeFi - Uniswap V4 兑换
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4054654615823560/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Rockbean
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-27T16:04:16.000Z" title="Tue Jan 27 2026 16:04:16 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    4
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><strong>欢迎订阅专栏</strong>：<a href="https://juejin.cn/column/7578762210285977663" title="https://juejin.cn/column/7578762210285977663" target="_blank">3分钟Solidity--智能合约--Web3区块链技术必学</a></p>
<h2 data-id="heading-0">Uniswap V4 兑换</h2>
<p>Uniswap V4 引入了单一实例 <code>PoolManager</code>，将所有流动性池集中在一个智能合约中管理。</p>
<p>V3版本的主要区别：</p>
<ul>
<li><strong>单例架构</strong>​ - 所有资金池都存在于一个合约中</li>
<li><strong>闪存记账</strong>​ - 代币转移仅在最后阶段发生，降低Gas费用</li>
<li><strong>解锁/回调模式</strong>​ - 通过回调机制进行交互</li>
</ul>
<p>要兑换：</p>
<ol>
<li>调用带有编码参数的<code>poolManager.unlock()</code></li>
<li>PoolManager会调用你的<code>unlockCallback()</code></li>
<li>在回调函数中：执行交换、结算输入、获取输出</li>
<li>在解锁完成前，差额必须净值为零</li>
</ol>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// SPDX-License-Identifier: MIT</span>
pragma solidity ^<span class="hljs-number">0.8</span><span class="hljs-selector-class">.26</span>;

<span class="hljs-comment">// 以太坊主网上的Uniswap V4 PoolManager</span>
<span class="hljs-selector-tag">address</span> constant POOL_MANAGER = <span class="hljs-number">0</span>x000000000004444c5dc75cB358380D2e3dE08A90;
<span class="hljs-selector-tag">address</span> constant WETH = <span class="hljs-number">0</span>xC02aaA39b223FE8D0A0e5C4F27eAD9083C756Cc2;
<span class="hljs-selector-tag">address</span> constant USDC = <span class="hljs-number">0</span>xA0b86991c6218b36c1d19D4a2e9Eb0cE3606eB48;

<span class="hljs-comment">/// @notice 直接在Uniswap V4上使用PoolManager进行交换的示例</span>
<span class="hljs-comment">/// @dev V4 使用单例PoolManager并采用unlock/unlockCallback模式</span>
contract UniswapV4Swap is IUnlockCallback {
    IPoolManager public immutable poolManager;

    error <span class="hljs-built_in">NotPoolManager</span>();
    error <span class="hljs-built_in">SwapFailed</span>();

    <span class="hljs-built_in">constructor</span>() {
        poolManager = <span class="hljs-built_in">IPoolManager</span>(POOL_MANAGER);
    }

    <span class="hljs-comment">/// @notice 将输入的精确金额兑换为输出代币</span>
    <span class="hljs-comment">/// @param key 标识池的池密钥</span>
    <span class="hljs-comment">/// @param amountIn 输入代币的交换数量</span>
    <span class="hljs-comment">/// @param minAmountOut 最低可接受输出量</span>
    function <span class="hljs-built_in">swapExactInput</span>(
        PoolKey calldata key,
        uint128 amountIn,
        uint128 minAmountOut
    ) external returns (uint256 amountOut) {
        <span class="hljs-comment">// Encode swap parameters to pass through unlock callback</span>
        bytes memory data = abi<span class="hljs-selector-class">.encode</span>(
            SwapParams({
                key: key,
                amountIn: amountIn,
                minAmountOut: minAmountOut,
                zeroForOne: true,
                sender: msg.sender
            })
        );

        <span class="hljs-comment">// 发起交换 - PoolManager将调用unlockCallback</span>
        bytes memory result = poolManager<span class="hljs-selector-class">.unlock</span>(data);
        amountOut = abi<span class="hljs-selector-class">.decode</span>(result, (uint256));
    }

    <span class="hljs-comment">/// @notice PoolManager解锁后的回调</span>
    <span class="hljs-comment">/// @dev 这里是实际执行交换逻辑的地方</span>
    function <span class="hljs-built_in">unlockCallback</span>(bytes calldata data)
        external
        override
        returns (bytes memory)
    {
        if (msg.sender != address(poolManager)) revert <span class="hljs-built_in">NotPoolManager</span>();

        SwapParams memory params = abi<span class="hljs-selector-class">.decode</span>(data, (SwapParams));

        <span class="hljs-comment">// 执行交换</span>
        <span class="hljs-comment">// zeroForOne: true = token0 -&gt; token1, false = token1 -&gt; token0</span>
        <span class="hljs-comment">// amountSpecified: negative = exact input, positive = exact output</span>
        BalanceDelta delta = poolManager<span class="hljs-selector-class">.swap</span>(
            params.key,
            IPoolManager.SwapParams({
                zeroForOne: params.zeroForOne,
                amountSpecified: -int256(uint256(params.amountIn)),
                sqrtPriceLimitX96: params.zeroForOne
                    ? MIN_SQRT_PRICE + <span class="hljs-number">1</span>
                    : MAX_SQRT_PRICE - <span class="hljs-number">1</span>
            }),
            <span class="hljs-built_in">bytes</span>("")
        );

        <span class="hljs-comment">// 根据差值计算金额</span>
        <span class="hljs-comment">// delta.amount0() is negative (we owe the pool)</span>
        <span class="hljs-comment">// delta.amount1() is positive (pool owes us)</span>
        uint256 amountOut = params<span class="hljs-selector-class">.zeroForOne</span>
            ? <span class="hljs-built_in">uint256</span>(int256(delta.amount1()))
            : <span class="hljs-built_in">uint256</span>(<span class="hljs-built_in">int256</span>(delta.<span class="hljs-built_in">amount0</span>()));

        if (amountOut &lt; params.minAmountOut) revert <span class="hljs-built_in">SwapFailed</span>();

        <span class="hljs-comment">// 结算输入代币（支付我们所欠款项）</span>
        Currency inputCurrency = params<span class="hljs-selector-class">.zeroForOne</span>
            ? params<span class="hljs-selector-class">.key</span><span class="hljs-selector-class">.currency0</span>
            : params.key.currency1;

        <span class="hljs-built_in">IERC20</span>(Currency.unwrap(inputCurrency))<span class="hljs-selector-class">.transferFrom</span>(
            params.sender,
            address(poolManager),
            params<span class="hljs-selector-class">.amountIn</span>
        );
        poolManager<span class="hljs-selector-class">.settle</span>(inputCurrency);

        <span class="hljs-comment">// Take the output token (receive what we're owed)</span>
        Currency outputCurrency = params<span class="hljs-selector-class">.zeroForOne</span>
            ? params<span class="hljs-selector-class">.key</span><span class="hljs-selector-class">.currency1</span>
            : params.key.currency0;

        poolManager<span class="hljs-selector-class">.take</span>(outputCurrency, params.sender, amountOut);

        return abi<span class="hljs-selector-class">.encode</span>(amountOut);
    }

    struct SwapParams {
        PoolKey key;
        uint128 amountIn;
        uint128 minAmountOut;
        bool zeroForOne;
        <span class="hljs-selector-tag">address</span> sender;
    }
}

<span class="hljs-comment">// 交换的平方根价格限制</span>
uint160 constant MIN_SQRT_PRICE = <span class="hljs-number">4295128739</span>;
uint160 constant MAX_SQRT_PRICE =
    <span class="hljs-number">1461446703485210103287273052203988822378723970342</span>;

<span class="hljs-comment">// 货币是一个地址包装器（address(0) = 原生ETH）</span>
type Currency is <span class="hljs-selector-tag">address</span>;

library CurrencyLibrary {
    function <span class="hljs-built_in">unwrap</span>(Currency currency) internal pure returns (address) {
        return Currency<span class="hljs-selector-class">.unwrap</span>(currency);
    }
}

using CurrencyLibrary for Currency;

struct PoolKey {
    Currency currency0;
    Currency currency1;
    uint24 fee;
    int24 tickSpacing;
    <span class="hljs-selector-tag">address</span> hooks;
}

<span class="hljs-comment">/// @notice 交换操作返回的余额差额</span>
<span class="hljs-comment">/// @dev 负 = 你欠池子，正 = 池子欠你</span>
type BalanceDelta is int256;

library BalanceDeltaLibrary {
    function <span class="hljs-built_in">amount0</span>(BalanceDelta delta) internal pure returns (int128) {
        return <span class="hljs-built_in">int128</span>(int256(BalanceDelta.unwrap(delta) &gt;&gt; <span class="hljs-number">128</span>));
    }

    function <span class="hljs-built_in">amount1</span>(BalanceDelta delta) internal pure returns (int128) {
        return <span class="hljs-built_in">int128</span>(int256(BalanceDelta.unwrap(delta)));
    }
}

using BalanceDeltaLibrary for BalanceDelta;

interface IPoolManager {
    struct SwapParams {
        bool zeroForOne;
        int256 amountSpecified;
        uint160 sqrtPriceLimitX96;
    }

    function <span class="hljs-built_in">unlock</span>(bytes calldata data) external returns (bytes memory);
    function <span class="hljs-built_in">swap</span>(PoolKey memory key, SwapParams memory params, bytes calldata hookData)
        external
        returns (BalanceDelta);
    function <span class="hljs-built_in">settle</span>(Currency currency) external payable returns (uint256);
    function <span class="hljs-built_in">take</span>(Currency currency, address to, uint256 amount) external;
}

interface IUnlockCallback {
    function <span class="hljs-built_in">unlockCallback</span>(bytes calldata data) external returns (bytes memory);
}

interface IERC20 {
    function <span class="hljs-built_in">transferFrom</span>(address sender, address recipient, uint256 amount)
        external
        returns (bool);
    function <span class="hljs-built_in">approve</span>(address spender, uint256 amount) external returns (bool);
}
</code></pre>
<h3 data-id="heading-1">Try on Remix</h3>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fremix.ethereum.org%2F%3F%23code%3DLy8gU1BEWC1MaWNlbnNlLUlkZW50aWZpZXI6IE1JVApwcmFnbWEgc29saWRpdHkgXjAuOC4yNjsKCi8vIFVuaXN3YXAgVjQgUG9vbE1hbmFnZXIgb24gRXRoZXJldW0gbWFpbm5ldAphZGRyZXNzIGNvbnN0YW50IFBPT0xfTUFOQUdFUiA9IDB4MDAwMDAwMDAwMDA0NDQ0YzVkYzc1Y0IzNTgzODBEMmUzZEUwOEE5MDsKYWRkcmVzcyBjb25zdGFudCBXRVRIID0gMHhDMDJhYUEzOWIyMjNGRThEMEEwZTVDNEYyN2VBRDkwODNDNzU2Q2MyOwphZGRyZXNzIGNvbnN0YW50IFVTREMgPSAweEEwYjg2OTkxYzYyMThiMzZjMWQxOUQ0YTJlOUViMGNFMzYwNmVCNDg7CgovLy8gQG5vdGljZSBFeGFtcGxlIG9mIHN3YXBwaW5nIG9uIFVuaXN3YXAgVjQgdXNpbmcgdGhlIFBvb2xNYW5hZ2VyIGRpcmVjdGx5Ci8vLyBAZGV2IFY0IHVzZXMgYSBzaW5nbGV0b24gUG9vbE1hbmFnZXIgd2l0aCB1bmxvY2svdW5sb2NrQ2FsbGJhY2sgcGF0dGVybgpjb250cmFjdCBVbmlzd2FwVjRTd2FwIGlzIElVbmxvY2tDYWxsYmFjayB7CiAgICBJUG9vbE1hbmFnZXIgcHVibGljIGltbXV0YWJsZSBwb29sTWFuYWdlcjsKCiAgICBlcnJvciBOb3RQb29sTWFuYWdlcigpOwogICAgZXJyb3IgU3dhcEZhaWxlZCgpOwoKICAgIGNvbnN0cnVjdG9yKCkgewogICAgICAgIHBvb2xNYW5hZ2VyID0gSVBvb2xNYW5hZ2VyKFBPT0xfTUFOQUdFUik7CiAgICB9CgogICAgLy8vIEBub3RpY2UgU3dhcCBleGFjdCBpbnB1dCBhbW91bnQgZm9yIG91dHB1dCB0b2tlbnMKICAgIC8vLyBAcGFyYW0ga2V5IFRoZSBwb29sIGtleSBpZGVudGlmeWluZyB0aGUgcG9vbAogICAgLy8vIEBwYXJhbSBhbW91bnRJbiBBbW91bnQgb2YgaW5wdXQgdG9rZW5zIHRvIHN3YXAKICAgIC8vLyBAcGFyYW0gbWluQW1vdW50T3V0IE1pbmltdW0gYWNjZXB0YWJsZSBvdXRwdXQgYW1vdW50CiAgICBmdW5jdGlvbiBzd2FwRXhhY3RJbnB1dCgKICAgICAgICBQb29sS2V5IGNhbGxkYXRhIGtleSwKICAgICAgICB1aW50MTI4IGFtb3VudEluLAogICAgICAgIHVpbnQxMjggbWluQW1vdW50T3V0CiAgICApIGV4dGVybmFsIHJldHVybnMgKHVpbnQyNTYgYW1vdW50T3V0KSB7CiAgICAgICAgLy8gRW5jb2RlIHN3YXAgcGFyYW1ldGVycyB0byBwYXNzIHRocm91Z2ggdW5sb2NrIGNhbGxiYWNrCiAgICAgICAgYnl0ZXMgbWVtb3J5IGRhdGEgPSBhYmkuZW5jb2RlKAogICAgICAgICAgICBTd2FwUGFyYW1zKHsKICAgICAgICAgICAgICAgIGtleToga2V5LAogICAgICAgICAgICAgICAgYW1vdW50SW46IGFtb3VudEluLAogICAgICAgICAgICAgICAgbWluQW1vdW50T3V0OiBtaW5BbW91bnRPdXQsCiAgICAgICAgICAgICAgICB6ZXJvRm9yT25lOiB0cnVlLAogICAgICAgICAgICAgICAgc2VuZGVyOiBtc2cuc2VuZGVyCiAgICAgICAgICAgIH0pCiAgICAgICAgKTsKCiAgICAgICAgLy8gSW5pdGlhdGUgdGhlIHN3YXAgLSBQb29sTWFuYWdlciB3aWxsIGNhbGwgdW5sb2NrQ2FsbGJhY2sKICAgICAgICBieXRlcyBtZW1vcnkgcmVzdWx0ID0gcG9vbE1hbmFnZXIudW5sb2NrKGRhdGEpOwogICAgICAgIGFtb3VudE91dCA9IGFiaS5kZWNvZGUocmVzdWx0LCAodWludDI1NikpOwogICAgfQoKICAgIC8vLyBAbm90aWNlIENhbGxiYWNrIGZyb20gUG9vbE1hbmFnZXIgYWZ0ZXIgdW5sb2NrCiAgICAvLy8gQGRldiBUaGlzIGlzIHdoZXJlIHRoZSBhY3R1YWwgc3dhcCBsb2dpYyBleGVjdXRlcwogICAgZnVuY3Rpb24gdW5sb2NrQ2FsbGJhY2soYnl0ZXMgY2FsbGRhdGEgZGF0YSkKICAgICAgICBleHRlcm5hbAogICAgICAgIG92ZXJyaWRlCiAgICAgICAgcmV0dXJucyAoYnl0ZXMgbWVtb3J5KQogICAgewogICAgICAgIGlmIChtc2cuc2VuZGVyICE9IGFkZHJlc3MocG9vbE1hbmFnZXIpKSByZXZlcnQgTm90UG9vbE1hbmFnZXIoKTsKCiAgICAgICAgU3dhcFBhcmFtcyBtZW1vcnkgcGFyYW1zID0gYWJpLmRlY29kZShkYXRhLCAoU3dhcFBhcmFtcykpOwoKICAgICAgICAvLyBFeGVjdXRlIHRoZSBzd2FwCiAgICAgICAgLy8gemVyb0Zvck9uZTogdHJ1ZSA9IHRva2VuMCAtPiB0b2tlbjEsIGZhbHNlID0gdG9rZW4xIC0%2BIHRva2VuMAogICAgICAgIC8vIGFtb3VudFNwZWNpZmllZDogbmVnYXRpdmUgPSBleGFjdCBpbnB1dCwgcG9zaXRpdmUgPSBleGFjdCBvdXRwdXQKICAgICAgICBCYWxhbmNlRGVsdGEgZGVsdGEgPSBwb29sTWFuYWdlci5zd2FwKAogICAgICAgICAgICBwYXJhbXMua2V5LAogICAgICAgICAgICBJUG9vbE1hbmFnZXIuU3dhcFBhcmFtcyh7CiAgICAgICAgICAgICAgICB6ZXJvRm9yT25lOiBwYXJhbXMuemVyb0Zvck9uZSwKICAgICAgICAgICAgICAgIGFtb3VudFNwZWNpZmllZDogLWludDI1Nih1aW50MjU2KHBhcmFtcy5hbW91bnRJbikpLAogICAgICAgICAgICAgICAgc3FydFByaWNlTGltaXRYOTY6IHBhcmFtcy56ZXJvRm9yT25lCiAgICAgICAgICAgICAgICAgICAgPyBNSU5fU1FSVF9QUklDRSArIDEKICAgICAgICAgICAgICAgICAgICA6IE1BWF9TUVJUX1BSSUNFIC0gMQogICAgICAgICAgICB9KSwKICAgICAgICAgICAgYnl0ZXMoIiIpCiAgICAgICAgKTsKCiAgICAgICAgLy8gQ2FsY3VsYXRlIGFtb3VudHMgZnJvbSBkZWx0YQogICAgICAgIC8vIGRlbHRhLmFtb3VudDAoKSBpcyBuZWdhdGl2ZSAod2Ugb3dlIHRoZSBwb29sKQogICAgICAgIC8vIGRlbHRhLmFtb3VudDEoKSBpcyBwb3NpdGl2ZSAocG9vbCBvd2VzIHVzKQogICAgICAgIHVpbnQyNTYgYW1vdW50T3V0ID0gcGFyYW1zLnplcm9Gb3JPbmUKICAgICAgICAgICAgPyB1aW50MjU2KGludDI1NihkZWx0YS5hbW91bnQxKCkpKQogICAgICAgICAgICA6IHVpbnQyNTYoaW50MjU2KGRlbHRhLmFtb3VudDAoKSkpOwoKICAgICAgICBpZiAoYW1vdW50T3V0IDwgcGFyYW1zLm1pbkFtb3VudE91dCkgcmV2ZXJ0IFN3YXBGYWlsZWQoKTsKCiAgICAgICAgLy8gU2V0dGxlIHRoZSBpbnB1dCB0b2tlbiAocGF5IHdoYXQgd2Ugb3dlKQogICAgICAgIEN1cnJlbmN5IGlucHV0Q3VycmVuY3kgPSBwYXJhbXMuemVyb0Zvck9uZQogICAgICAgICAgICA%2FIHBhcmFtcy5rZXkuY3VycmVuY3kwCiAgICAgICAgICAgIDogcGFyYW1zLmtleS5jdXJyZW5jeTE7CgogICAgICAgIElFUkMyMChDdXJyZW5jeS51bndyYXAoaW5wdXRDdXJyZW5jeSkpLnRyYW5zZmVyRnJvbSgKICAgICAgICAgICAgcGFyYW1zLnNlbmRlciwKICAgICAgICAgICAgYWRkcmVzcyhwb29sTWFuYWdlciksCiAgICAgICAgICAgIHBhcmFtcy5hbW91bnRJbgogICAgICAgICk7CiAgICAgICAgcG9vbE1hbmFnZXIuc2V0dGxlKGlucHV0Q3VycmVuY3kpOwoKICAgICAgICAvLyBUYWtlIHRoZSBvdXRwdXQgdG9rZW4gKHJlY2VpdmUgd2hhdCB3ZSdyZSBvd2VkKQogICAgICAgIEN1cnJlbmN5IG91dHB1dEN1cnJlbmN5ID0gcGFyYW1zLnplcm9Gb3JPbmUKICAgICAgICAgICAgPyBwYXJhbXMua2V5LmN1cnJlbmN5MQogICAgICAgICAgICA6IHBhcmFtcy5rZXkuY3VycmVuY3kwOwoKICAgICAgICBwb29sTWFuYWdlci50YWtlKG91dHB1dEN1cnJlbmN5LCBwYXJhbXMuc2VuZGVyLCBhbW91bnRPdXQpOwoKICAgICAgICByZXR1cm4gYWJpLmVuY29kZShhbW91bnRPdXQpOwogICAgfQoKICAgIHN0cnVjdCBTd2FwUGFyYW1zIHsKICAgICAgICBQb29sS2V5IGtleTsKICAgICAgICB1aW50MTI4IGFtb3VudEluOwogICAgICAgIHVpbnQxMjggbWluQW1vdW50T3V0OwogICAgICAgIGJvb2wgemVyb0Zvck9uZTsKICAgICAgICBhZGRyZXNzIHNlbmRlcjsKICAgIH0KfQoKLy8gU3FydCBwcmljZSBsaW1pdHMgZm9yIHN3YXBzCnVpbnQxNjAgY29uc3RhbnQgTUlOX1NRUlRfUFJJQ0UgPSA0Mjk1MTI4NzM5Owp1aW50MTYwIGNvbnN0YW50IE1BWF9TUVJUX1BSSUNFID0KICAgIDE0NjE0NDY3MDM0ODUyMTAxMDMyODcyNzMwNTIyMDM5ODg4MjIzNzg3MjM5NzAzNDI7CgovLyBDdXJyZW5jeSBpcyBhbiBhZGRyZXNzIHdyYXBwZXIgKGFkZHJlc3MoMCkgPSBuYXRpdmUgRVRIKQp0eXBlIEN1cnJlbmN5IGlzIGFkZHJlc3M7CgpsaWJyYXJ5IEN1cnJlbmN5TGlicmFyeSB7CiAgICBmdW5jdGlvbiB1bndyYXAoQ3VycmVuY3kgY3VycmVuY3kpIGludGVybmFsIHB1cmUgcmV0dXJucyAoYWRkcmVzcykgewogICAgICAgIHJldHVybiBDdXJyZW5jeS51bndyYXAoY3VycmVuY3kpOwogICAgfQp9Cgp1c2luZyBDdXJyZW5jeUxpYnJhcnkgZm9yIEN1cnJlbmN5OwoKc3RydWN0IFBvb2xLZXkgewogICAgQ3VycmVuY3kgY3VycmVuY3kwOwogICAgQ3VycmVuY3kgY3VycmVuY3kxOwogICAgdWludDI0IGZlZTsKICAgIGludDI0IHRpY2tTcGFjaW5nOwogICAgYWRkcmVzcyBob29rczsKfQoKLy8vIEBub3RpY2UgQmFsYW5jZSBkZWx0YSByZXR1cm5lZCBmcm9tIHN3YXAgb3BlcmF0aW9ucwovLy8gQGRldiBOZWdhdGl2ZSA9IHlvdSBvd2UgdGhlIHBvb2wsIFBvc2l0aXZlID0gcG9vbCBvd2VzIHlvdQp0eXBlIEJhbGFuY2VEZWx0YSBpcyBpbnQyNTY7CgpsaWJyYXJ5IEJhbGFuY2VEZWx0YUxpYnJhcnkgewogICAgZnVuY3Rpb24gYW1vdW50MChCYWxhbmNlRGVsdGEgZGVsdGEpIGludGVybmFsIHB1cmUgcmV0dXJucyAoaW50MTI4KSB7CiAgICAgICAgcmV0dXJuIGludDEyOChpbnQyNTYoQmFsYW5jZURlbHRhLnVud3JhcChkZWx0YSkgPj4gMTI4KSk7CiAgICB9CgogICAgZnVuY3Rpb24gYW1vdW50MShCYWxhbmNlRGVsdGEgZGVsdGEpIGludGVybmFsIHB1cmUgcmV0dXJucyAoaW50MTI4KSB7CiAgICAgICAgcmV0dXJuIGludDEyOChpbnQyNTYoQmFsYW5jZURlbHRhLnVud3JhcChkZWx0YSkpKTsKICAgIH0KfQoKdXNpbmcgQmFsYW5jZURlbHRhTGlicmFyeSBmb3IgQmFsYW5jZURlbHRhOwoKaW50ZXJmYWNlIElQb29sTWFuYWdlciB7CiAgICBzdHJ1Y3QgU3dhcFBhcmFtcyB7CiAgICAgICAgYm9vbCB6ZXJvRm9yT25lOwogICAgICAgIGludDI1NiBhbW91bnRTcGVjaWZpZWQ7CiAgICAgICAgdWludDE2MCBzcXJ0UHJpY2VMaW1pdFg5NjsKICAgIH0KCiAgICBmdW5jdGlvbiB1bmxvY2soYnl0ZXMgY2FsbGRhdGEgZGF0YSkgZXh0ZXJuYWwgcmV0dXJucyAoYnl0ZXMgbWVtb3J5KTsKICAgIGZ1bmN0aW9uIHN3YXAoUG9vbEtleSBtZW1vcnkga2V5LCBTd2FwUGFyYW1zIG1lbW9yeSBwYXJhbXMsIGJ5dGVzIGNhbGxkYXRhIGhvb2tEYXRhKQogICAgICAgIGV4dGVybmFsCiAgICAgICAgcmV0dXJucyAoQmFsYW5jZURlbHRhKTsKICAgIGZ1bmN0aW9uIHNldHRsZShDdXJyZW5jeSBjdXJyZW5jeSkgZXh0ZXJuYWwgcGF5YWJsZSByZXR1cm5zICh1aW50MjU2KTsKICAgIGZ1bmN0aW9uIHRha2UoQ3VycmVuY3kgY3VycmVuY3ksIGFkZHJlc3MgdG8sIHVpbnQyNTYgYW1vdW50KSBleHRlcm5hbDsKfQoKaW50ZXJmYWNlIElVbmxvY2tDYWxsYmFjayB7CiAgICBmdW5jdGlvbiB1bmxvY2tDYWxsYmFjayhieXRlcyBjYWxsZGF0YSBkYXRhKSBleHRlcm5hbCByZXR1cm5zIChieXRlcyBtZW1vcnkpOwp9CgppbnRlcmZhY2UgSUVSQzIwIHsKICAgIGZ1bmN0aW9uIHRyYW5zZmVyRnJvbShhZGRyZXNzIHNlbmRlciwgYWRkcmVzcyByZWNpcGllbnQsIHVpbnQyNTYgYW1vdW50KQogICAgICAgIGV4dGVybmFsCiAgICAgICAgcmV0dXJucyAoYm9vbCk7CiAgICBmdW5jdGlvbiBhcHByb3ZlKGFkZHJlc3Mgc3BlbmRlciwgdWludDI1NiBhbW91bnQpIGV4dGVybmFsIHJldHVybnMgKGJvb2wpOwp9Cg%3D%3D" target="_blank" title="https://remix.ethereum.org/?#code=Ly8gU1BEWC1MaWNlbnNlLUlkZW50aWZpZXI6IE1JVApwcmFnbWEgc29saWRpdHkgXjAuOC4yNjsKCi8vIFVuaXN3YXAgVjQgUG9vbE1hbmFnZXIgb24gRXRoZXJldW0gbWFpbm5ldAphZGRyZXNzIGNvbnN0YW50IFBPT0xfTUFOQUdFUiA9IDB4MDAwMDAwMDAwMDA0NDQ0YzVkYzc1Y0IzNTgzODBEMmUzZEUwOEE5MDsKYWRkcmVzcyBjb25zdGFudCBXRVRIID0gMHhDMDJhYUEzOWIyMjNGRThEMEEwZTVDNEYyN2VBRDkwODNDNzU2Q2MyOwphZGRyZXNzIGNvbnN0YW50IFVTREMgPSAweEEwYjg2OTkxYzYyMThiMzZjMWQxOUQ0YTJlOUViMGNFMzYwNmVCNDg7CgovLy8gQG5vdGljZSBFeGFtcGxlIG9mIHN3YXBwaW5nIG9uIFVuaXN3YXAgVjQgdXNpbmcgdGhlIFBvb2xNYW5hZ2VyIGRpcmVjdGx5Ci8vLyBAZGV2IFY0IHVzZXMgYSBzaW5nbGV0b24gUG9vbE1hbmFnZXIgd2l0aCB1bmxvY2svdW5sb2NrQ2FsbGJhY2sgcGF0dGVybgpjb250cmFjdCBVbmlzd2FwVjRTd2FwIGlzIElVbmxvY2tDYWxsYmFjayB7CiAgICBJUG9vbE1hbmFnZXIgcHVibGljIGltbXV0YWJsZSBwb29sTWFuYWdlcjsKCiAgICBlcnJvciBOb3RQb29sTWFuYWdlcigpOwogICAgZXJyb3IgU3dhcEZhaWxlZCgpOwoKICAgIGNvbnN0cnVjdG9yKCkgewogICAgICAgIHBvb2xNYW5hZ2VyID0gSVBvb2xNYW5hZ2VyKFBPT0xfTUFOQUdFUik7CiAgICB9CgogICAgLy8vIEBub3RpY2UgU3dhcCBleGFjdCBpbnB1dCBhbW91bnQgZm9yIG91dHB1dCB0b2tlbnMKICAgIC8vLyBAcGFyYW0ga2V5IFRoZSBwb29sIGtleSBpZGVudGlmeWluZyB0aGUgcG9vbAogICAgLy8vIEBwYXJhbSBhbW91bnRJbiBBbW91bnQgb2YgaW5wdXQgdG9rZW5zIHRvIHN3YXAKICAgIC8vLyBAcGFyYW0gbWluQW1vdW50T3V0IE1pbmltdW0gYWNjZXB0YWJsZSBvdXRwdXQgYW1vdW50CiAgICBmdW5jdGlvbiBzd2FwRXhhY3RJbnB1dCgKICAgICAgICBQb29sS2V5IGNhbGxkYXRhIGtleSwKICAgICAgICB1aW50MTI4IGFtb3VudEluLAogICAgICAgIHVpbnQxMjggbWluQW1vdW50T3V0CiAgICApIGV4dGVybmFsIHJldHVybnMgKHVpbnQyNTYgYW1vdW50T3V0KSB7CiAgICAgICAgLy8gRW5jb2RlIHN3YXAgcGFyYW1ldGVycyB0byBwYXNzIHRocm91Z2ggdW5sb2NrIGNhbGxiYWNrCiAgICAgICAgYnl0ZXMgbWVtb3J5IGRhdGEgPSBhYmkuZW5jb2RlKAogICAgICAgICAgICBTd2FwUGFyYW1zKHsKICAgICAgICAgICAgICAgIGtleToga2V5LAogICAgICAgICAgICAgICAgYW1vdW50SW46IGFtb3VudEluLAogICAgICAgICAgICAgICAgbWluQW1vdW50T3V0OiBtaW5BbW91bnRPdXQsCiAgICAgICAgICAgICAgICB6ZXJvRm9yT25lOiB0cnVlLAogICAgICAgICAgICAgICAgc2VuZGVyOiBtc2cuc2VuZGVyCiAgICAgICAgICAgIH0pCiAgICAgICAgKTsKCiAgICAgICAgLy8gSW5pdGlhdGUgdGhlIHN3YXAgLSBQb29sTWFuYWdlciB3aWxsIGNhbGwgdW5sb2NrQ2FsbGJhY2sKICAgICAgICBieXRlcyBtZW1vcnkgcmVzdWx0ID0gcG9vbE1hbmFnZXIudW5sb2NrKGRhdGEpOwogICAgICAgIGFtb3VudE91dCA9IGFiaS5kZWNvZGUocmVzdWx0LCAodWludDI1NikpOwogICAgfQoKICAgIC8vLyBAbm90aWNlIENhbGxiYWNrIGZyb20gUG9vbE1hbmFnZXIgYWZ0ZXIgdW5sb2NrCiAgICAvLy8gQGRldiBUaGlzIGlzIHdoZXJlIHRoZSBhY3R1YWwgc3dhcCBsb2dpYyBleGVjdXRlcwogICAgZnVuY3Rpb24gdW5sb2NrQ2FsbGJhY2soYnl0ZXMgY2FsbGRhdGEgZGF0YSkKICAgICAgICBleHRlcm5hbAogICAgICAgIG92ZXJyaWRlCiAgICAgICAgcmV0dXJucyAoYnl0ZXMgbWVtb3J5KQogICAgewogICAgICAgIGlmIChtc2cuc2VuZGVyICE9IGFkZHJlc3MocG9vbE1hbmFnZXIpKSByZXZlcnQgTm90UG9vbE1hbmFnZXIoKTsKCiAgICAgICAgU3dhcFBhcmFtcyBtZW1vcnkgcGFyYW1zID0gYWJpLmRlY29kZShkYXRhLCAoU3dhcFBhcmFtcykpOwoKICAgICAgICAvLyBFeGVjdXRlIHRoZSBzd2FwCiAgICAgICAgLy8gemVyb0Zvck9uZTogdHJ1ZSA9IHRva2VuMCAtPiB0b2tlbjEsIGZhbHNlID0gdG9rZW4xIC0+IHRva2VuMAogICAgICAgIC8vIGFtb3VudFNwZWNpZmllZDogbmVnYXRpdmUgPSBleGFjdCBpbnB1dCwgcG9zaXRpdmUgPSBleGFjdCBvdXRwdXQKICAgICAgICBCYWxhbmNlRGVsdGEgZGVsdGEgPSBwb29sTWFuYWdlci5zd2FwKAogICAgICAgICAgICBwYXJhbXMua2V5LAogICAgICAgICAgICBJUG9vbE1hbmFnZXIuU3dhcFBhcmFtcyh7CiAgICAgICAgICAgICAgICB6ZXJvRm9yT25lOiBwYXJhbXMuemVyb0Zvck9uZSwKICAgICAgICAgICAgICAgIGFtb3VudFNwZWNpZmllZDogLWludDI1Nih1aW50MjU2KHBhcmFtcy5hbW91bnRJbikpLAogICAgICAgICAgICAgICAgc3FydFByaWNlTGltaXRYOTY6IHBhcmFtcy56ZXJvRm9yT25lCiAgICAgICAgICAgICAgICAgICAgPyBNSU5fU1FSVF9QUklDRSArIDEKICAgICAgICAgICAgICAgICAgICA6IE1BWF9TUVJUX1BSSUNFIC0gMQogICAgICAgICAgICB9KSwKICAgICAgICAgICAgYnl0ZXMoIiIpCiAgICAgICAgKTsKCiAgICAgICAgLy8gQ2FsY3VsYXRlIGFtb3VudHMgZnJvbSBkZWx0YQogICAgICAgIC8vIGRlbHRhLmFtb3VudDAoKSBpcyBuZWdhdGl2ZSAod2Ugb3dlIHRoZSBwb29sKQogICAgICAgIC8vIGRlbHRhLmFtb3VudDEoKSBpcyBwb3NpdGl2ZSAocG9vbCBvd2VzIHVzKQogICAgICAgIHVpbnQyNTYgYW1vdW50T3V0ID0gcGFyYW1zLnplcm9Gb3JPbmUKICAgICAgICAgICAgPyB1aW50MjU2KGludDI1NihkZWx0YS5hbW91bnQxKCkpKQogICAgICAgICAgICA6IHVpbnQyNTYoaW50MjU2KGRlbHRhLmFtb3VudDAoKSkpOwoKICAgICAgICBpZiAoYW1vdW50T3V0IDwgcGFyYW1zLm1pbkFtb3VudE91dCkgcmV2ZXJ0IFN3YXBGYWlsZWQoKTsKCiAgICAgICAgLy8gU2V0dGxlIHRoZSBpbnB1dCB0b2tlbiAocGF5IHdoYXQgd2Ugb3dlKQogICAgICAgIEN1cnJlbmN5IGlucHV0Q3VycmVuY3kgPSBwYXJhbXMuemVyb0Zvck9uZQogICAgICAgICAgICA/IHBhcmFtcy5rZXkuY3VycmVuY3kwCiAgICAgICAgICAgIDogcGFyYW1zLmtleS5jdXJyZW5jeTE7CgogICAgICAgIElFUkMyMChDdXJyZW5jeS51bndyYXAoaW5wdXRDdXJyZW5jeSkpLnRyYW5zZmVyRnJvbSgKICAgICAgICAgICAgcGFyYW1zLnNlbmRlciwKICAgICAgICAgICAgYWRkcmVzcyhwb29sTWFuYWdlciksCiAgICAgICAgICAgIHBhcmFtcy5hbW91bnRJbgogICAgICAgICk7CiAgICAgICAgcG9vbE1hbmFnZXIuc2V0dGxlKGlucHV0Q3VycmVuY3kpOwoKICAgICAgICAvLyBUYWtlIHRoZSBvdXRwdXQgdG9rZW4gKHJlY2VpdmUgd2hhdCB3ZSdyZSBvd2VkKQogICAgICAgIEN1cnJlbmN5IG91dHB1dEN1cnJlbmN5ID0gcGFyYW1zLnplcm9Gb3JPbmUKICAgICAgICAgICAgPyBwYXJhbXMua2V5LmN1cnJlbmN5MQogICAgICAgICAgICA6IHBhcmFtcy5rZXkuY3VycmVuY3kwOwoKICAgICAgICBwb29sTWFuYWdlci50YWtlKG91dHB1dEN1cnJlbmN5LCBwYXJhbXMuc2VuZGVyLCBhbW91bnRPdXQpOwoKICAgICAgICByZXR1cm4gYWJpLmVuY29kZShhbW91bnRPdXQpOwogICAgfQoKICAgIHN0cnVjdCBTd2FwUGFyYW1zIHsKICAgICAgICBQb29sS2V5IGtleTsKICAgICAgICB1aW50MTI4IGFtb3VudEluOwogICAgICAgIHVpbnQxMjggbWluQW1vdW50T3V0OwogICAgICAgIGJvb2wgemVyb0Zvck9uZTsKICAgICAgICBhZGRyZXNzIHNlbmRlcjsKICAgIH0KfQoKLy8gU3FydCBwcmljZSBsaW1pdHMgZm9yIHN3YXBzCnVpbnQxNjAgY29uc3RhbnQgTUlOX1NRUlRfUFJJQ0UgPSA0Mjk1MTI4NzM5Owp1aW50MTYwIGNvbnN0YW50IE1BWF9TUVJUX1BSSUNFID0KICAgIDE0NjE0NDY3MDM0ODUyMTAxMDMyODcyNzMwNTIyMDM5ODg4MjIzNzg3MjM5NzAzNDI7CgovLyBDdXJyZW5jeSBpcyBhbiBhZGRyZXNzIHdyYXBwZXIgKGFkZHJlc3MoMCkgPSBuYXRpdmUgRVRIKQp0eXBlIEN1cnJlbmN5IGlzIGFkZHJlc3M7CgpsaWJyYXJ5IEN1cnJlbmN5TGlicmFyeSB7CiAgICBmdW5jdGlvbiB1bndyYXAoQ3VycmVuY3kgY3VycmVuY3kpIGludGVybmFsIHB1cmUgcmV0dXJucyAoYWRkcmVzcykgewogICAgICAgIHJldHVybiBDdXJyZW5jeS51bndyYXAoY3VycmVuY3kpOwogICAgfQp9Cgp1c2luZyBDdXJyZW5jeUxpYnJhcnkgZm9yIEN1cnJlbmN5OwoKc3RydWN0IFBvb2xLZXkgewogICAgQ3VycmVuY3kgY3VycmVuY3kwOwogICAgQ3VycmVuY3kgY3VycmVuY3kxOwogICAgdWludDI0IGZlZTsKICAgIGludDI0IHRpY2tTcGFjaW5nOwogICAgYWRkcmVzcyBob29rczsKfQoKLy8vIEBub3RpY2UgQmFsYW5jZSBkZWx0YSByZXR1cm5lZCBmcm9tIHN3YXAgb3BlcmF0aW9ucwovLy8gQGRldiBOZWdhdGl2ZSA9IHlvdSBvd2UgdGhlIHBvb2wsIFBvc2l0aXZlID0gcG9vbCBvd2VzIHlvdQp0eXBlIEJhbGFuY2VEZWx0YSBpcyBpbnQyNTY7CgpsaWJyYXJ5IEJhbGFuY2VEZWx0YUxpYnJhcnkgewogICAgZnVuY3Rpb24gYW1vdW50MChCYWxhbmNlRGVsdGEgZGVsdGEpIGludGVybmFsIHB1cmUgcmV0dXJucyAoaW50MTI4KSB7CiAgICAgICAgcmV0dXJuIGludDEyOChpbnQyNTYoQmFsYW5jZURlbHRhLnVud3JhcChkZWx0YSkgPj4gMTI4KSk7CiAgICB9CgogICAgZnVuY3Rpb24gYW1vdW50MShCYWxhbmNlRGVsdGEgZGVsdGEpIGludGVybmFsIHB1cmUgcmV0dXJucyAoaW50MTI4KSB7CiAgICAgICAgcmV0dXJuIGludDEyOChpbnQyNTYoQmFsYW5jZURlbHRhLnVud3JhcChkZWx0YSkpKTsKICAgIH0KfQoKdXNpbmcgQmFsYW5jZURlbHRhTGlicmFyeSBmb3IgQmFsYW5jZURlbHRhOwoKaW50ZXJmYWNlIElQb29sTWFuYWdlciB7CiAgICBzdHJ1Y3QgU3dhcFBhcmFtcyB7CiAgICAgICAgYm9vbCB6ZXJvRm9yT25lOwogICAgICAgIGludDI1NiBhbW91bnRTcGVjaWZpZWQ7CiAgICAgICAgdWludDE2MCBzcXJ0UHJpY2VMaW1pdFg5NjsKICAgIH0KCiAgICBmdW5jdGlvbiB1bmxvY2soYnl0ZXMgY2FsbGRhdGEgZGF0YSkgZXh0ZXJuYWwgcmV0dXJucyAoYnl0ZXMgbWVtb3J5KTsKICAgIGZ1bmN0aW9uIHN3YXAoUG9vbEtleSBtZW1vcnkga2V5LCBTd2FwUGFyYW1zIG1lbW9yeSBwYXJhbXMsIGJ5dGVzIGNhbGxkYXRhIGhvb2tEYXRhKQogICAgICAgIGV4dGVybmFsCiAgICAgICAgcmV0dXJucyAoQmFsYW5jZURlbHRhKTsKICAgIGZ1bmN0aW9uIHNldHRsZShDdXJyZW5jeSBjdXJyZW5jeSkgZXh0ZXJuYWwgcGF5YWJsZSByZXR1cm5zICh1aW50MjU2KTsKICAgIGZ1bmN0aW9uIHRha2UoQ3VycmVuY3kgY3VycmVuY3ksIGFkZHJlc3MgdG8sIHVpbnQyNTYgYW1vdW50KSBleHRlcm5hbDsKfQoKaW50ZXJmYWNlIElVbmxvY2tDYWxsYmFjayB7CiAgICBmdW5jdGlvbiB1bmxvY2tDYWxsYmFjayhieXRlcyBjYWxsZGF0YSBkYXRhKSBleHRlcm5hbCByZXR1cm5zIChieXRlcyBtZW1vcnkpOwp9CgppbnRlcmZhY2UgSUVSQzIwIHsKICAgIGZ1bmN0aW9uIHRyYW5zZmVyRnJvbShhZGRyZXNzIHNlbmRlciwgYWRkcmVzcyByZWNpcGllbnQsIHVpbnQyNTYgYW1vdW50KQogICAgICAgIGV4dGVybmFsCiAgICAgICAgcmV0dXJucyAoYm9vbCk7CiAgICBmdW5jdGlvbiBhcHByb3ZlKGFkZHJlc3Mgc3BlbmRlciwgdWludDI1NiBhbW91bnQpIGV4dGVybmFsIHJldHVybnMgKGJvb2wpOwp9Cg==" ref="nofollow noopener noreferrer">UniswapV4Swap.sol</a></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[构建专业命令行工具：解析 Commander 与 Inquirer 的协作之道]]></title>    <link>https://juejin.cn/post/7600344784945381422</link>    <guid>https://juejin.cn/post/7600344784945381422</guid>    <pubDate>2026-01-29T06:23:57.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600344784945381422" data-draft-id="7600344784945348654" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="构建专业命令行工具：解析 Commander 与 Inquirer 的协作之道"/> <meta itemprop="keywords" content="后端,前端,JavaScript"/> <meta itemprop="datePublished" content="2026-01-29T06:23:57.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="火车叼位"/> <meta itemprop="url" content="https://juejin.cn/user/1345457960792808"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            构建专业命令行工具：解析 Commander 与 Inquirer 的协作之道
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1345457960792808/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    火车叼位
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-29T06:23:57.000Z" title="Thu Jan 29 2026 06:23:57 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在 Node.js 生态中，开发一个命令行界面（CLI）工具几乎是每个高级开发者的必经之路。然而，面对 <strong>Commander.js</strong> 和 <strong>Inquirer.js</strong> 这两个顶级库时，很多开发者会产生困惑：“我到底该选哪一个？”</p>
<p>实际上，这种困惑源于对两者定位的重叠性误解。Commander 负责的是**“命令的结构”<strong>，而 Inquirer 负责的是</strong>“互动的体验”**。本文将带你深入底层，看清它们的相同点与本质区别，助你做出最理性的技术选型。</p>
<hr/>
<h2 data-id="heading-0">1. Commander.js：CLI 的骨架与规则</h2>
<h3 data-id="heading-1">1.1 核心定位</h3>
<p>Commander 是一个完整的 Node.js 命令行解决方案。它效仿了 Ruby 的 <code>commander</code>，其核心目标是<strong>解析（Parsing）</strong>。它负责告诉程序：用户在启动时输入了什么指令、带了什么参数、设置了哪些选项。</p>
<h3 data-id="heading-2">1.2 核心功能特性</h3>
<ul>
<li><strong>参数解析</strong>：自动处理 <code>process.argv</code>，支持必填参数 <code>&lt;arg&gt;</code> 和可选参数 <code>[arg]</code>。</li>
<li><strong>选项定义</strong>：支持短选项（<code>-f</code>）和长选项（<code>--force</code>），并自动生成布尔值或参数值。</li>
<li><strong>子命令系统</strong>：通过 <code>.command()</code> 构建类似 <code>git push</code>、<code>git pull</code> 的嵌套结构。</li>
<li><strong>自动文档</strong>：基于定义自动生成 <code>-h, --help</code> 帮助信息。</li>
</ul>
<h3 data-id="heading-3">1.3 代码示例（基于文档）</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> { program } = <span class="hljs-built_in">require</span>(<span class="hljs-string">'commander'</span>);

program
  .<span class="hljs-title function_">name</span>(<span class="hljs-string">'pizza-cli'</span>)
  .<span class="hljs-title function_">description</span>(<span class="hljs-string">'订购皮萨的工具'</span>)
  .<span class="hljs-title function_">version</span>(<span class="hljs-string">'1.0.0'</span>);

program
  .<span class="hljs-title function_">option</span>(<span class="hljs-string">'-s, --size &lt;type&gt;'</span>, <span class="hljs-string">'皮萨尺寸'</span>, <span class="hljs-string">'medium'</span>)
  .<span class="hljs-title function_">option</span>(<span class="hljs-string">'-d, --debug'</span>, <span class="hljs-string">'开启调试模式'</span>)
  .<span class="hljs-title function_">action</span>(<span class="hljs-function">(<span class="hljs-params">options</span>) =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`您订购了一个 <span class="hljs-subst">${options.size}</span> 尺寸的皮萨。`</span>);
  });

program.<span class="hljs-title function_">parse</span>();
</code></pre>
<hr/>
<h2 data-id="heading-4">2. Inquirer.js：CLI 的血肉与交互</h2>
<h3 data-id="heading-5">2.1 核心定位</h3>
<p>Inquirer 是一个交互式命令行用户界面的集合。它的目标是<strong>引导（Guiding）</strong>。当你的程序需要从用户那里获取非预设的、复杂的信息时，Inquirer 提供了丰富的 UI 组件。</p>
<h3 data-id="heading-6">2.2 核心功能特性</h3>
<ul>
<li><strong>多样化输入</strong>：支持 <code>input</code>（文本）、<code>password</code>（遮罩）、<code>confirm</code>（确认）、<code>select</code>（单选）、<code>checkbox</code>（多选）等。</li>
<li><strong>流式对话</strong>：可以根据上一步的回答动态决定下一步提问的内容。</li>
<li><strong>输入校验</strong>：内置 <code>validate</code> 钩子，实时反馈输入错误。</li>
<li><strong>新版优化</strong>：最新版（<code>@inquirer/prompts</code>）采用了更轻量、性能更高的架构，并支持更灵活的异步操作。</li>
</ul>
<h3 data-id="heading-7">2.3 代码示例（基于文档）</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { input, select } <span class="hljs-keyword">from</span> <span class="hljs-string">'@inquirer/prompts'</span>;

<span class="hljs-keyword">const</span> name = <span class="hljs-keyword">await</span> <span class="hljs-title function_">input</span>({ <span class="hljs-attr">message</span>: <span class="hljs-string">'请输入您的名字'</span> });
<span class="hljs-keyword">const</span> color = <span class="hljs-keyword">await</span> <span class="hljs-title function_">select</span>({
  <span class="hljs-attr">message</span>: <span class="hljs-string">'选择你喜欢的颜色'</span>,
  <span class="hljs-attr">choices</span>: [
    { <span class="hljs-attr">name</span>: <span class="hljs-string">'红色'</span>, <span class="hljs-attr">value</span>: <span class="hljs-string">'red'</span> },
    { <span class="hljs-attr">name</span>: <span class="hljs-string">'蓝色'</span>, <span class="hljs-attr">value</span>: <span class="hljs-string">'blue'</span> },
  ],
});

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`你好 <span class="hljs-subst">${name}</span>，你选择了 <span class="hljs-subst">${color}</span>。`</span>);
</code></pre>
<hr/>
<h2 data-id="heading-8">3. 深度对比：相同点与不同点</h2>
<p>为了辅助选型，我们将两者进行多维度的横向对比：</p>



































<table><thead><tr><th align="left">维度</th><th align="left">Commander.js</th><th align="left">Inquirer.js</th></tr></thead><tbody><tr><td align="left"><strong>交互模式</strong></td><td align="left"><strong>静态/声明式</strong>：用户启动前决定一切</td><td align="left"><strong>动态/交互式</strong>：程序运行中实时问答</td></tr><tr><td align="left"><strong>主要职责</strong></td><td align="left">命令解析、版本管理、帮助信息、子命令调度</td><td align="left">收集用户输入、数据校验、流程引导、UI 呈现</td></tr><tr><td align="left"><strong>自动化支持</strong></td><td align="left"><strong>极佳</strong>：完美支持 CI/CD、脚本自动化调用</td><td align="left"><strong>较差</strong>：通常需要人工干预（除非 Mock 标准输入）</td></tr><tr><td align="left"><strong>学习曲线</strong></td><td align="left">低：主要是声明 API 及其回调</td><td align="left">中：需处理异步流程、逻辑分支和校验</td></tr><tr><td align="left"><strong>用户群体</strong></td><td align="left">高级用户（偏向脚本化、快速指令）</td><td align="left">普通用户（偏向配置向导、初始化工具）</td></tr></tbody></table>
<h3 data-id="heading-9">相同点</h3>
<ol>
<li><strong>基础环境</strong>：两者都运行在 Node.js 环境，均对原生 <code>process.stdin</code> 和 <code>process.stdout</code> 进行了高级封装。</li>
<li><strong>社区标准</strong>：它们都是各自领域的“事实标准”，npm 下载量均为千万级。</li>
<li><strong>扩展性</strong>：都支持自定义扩展，Commander 可以自定义配置 Help 类，Inquirer 可以开发自定义 Prompt 插件。</li>
</ol>
<h3 data-id="heading-10">核心区别</h3>
<ul>
<li><strong>触发时机不同</strong>：Commander 关注的是命令启动那一刻的状态；Inquirer 关注的是启动后与用户的持续对话。</li>
<li><strong>CI/CD 友好度不同</strong>：如果你的工具要在服务器脚本（如 Jenkins）中运行，Commander 是必须的，因为它可以通过 Flag（如 <code>--yes</code>）避开人工干预；而 Inquirer 在这种场景下会阻塞进程。</li>
</ul>
<hr/>
<h2 data-id="heading-11">4. 混合选型策略：1 + 1 &gt; 2</h2>
<p>在现代 CLI 开发中，**“Commander 构建骨架 + Inquirer 填充交互”**是最成熟的方案。</p>
<h3 data-id="heading-12">实践案例：脚手架初始化</h3>
<p>想象你要开发一个类似 <code>vue-cli</code> 的工具：</p>
<ol>
<li><strong>使用 Commander 解析指令</strong>：用户输入 <code>my-cli create my-project</code>。</li>
<li><strong>缺省检测</strong>：如果用户没传参数，或者需要进一步配置，则唤起 <strong>Inquirer</strong>。</li>
<li><strong>交互式问答</strong>：询问“是否使用 TypeScript？”、“是否集成 ESLint？”。</li>
<li><strong>结果合并</strong>：将 Commander 解析的初始参数与 Inquirer 收集的配置合并，最后执行文件创建任务。</li>
</ol>
<hr/>
<h2 data-id="heading-13">5. 结论与行动建议</h2>
<p>针对你的技术选型，我给出以下结论：</p>
<ol>
<li><strong>如果你的工具主要用于自动化脚本、数据处理或拥有大量复杂参数</strong>：请优先确保 <strong>Commander</strong> 的稳健实现。它能让你的工具像 <code>ls</code> 或 <code>git</code> 一样专业且易于集成。</li>
<li><strong>如果你的工具主要面向初级用户，或者涉及复杂的初始化配置（如脚手架、安装向导）</strong>：<strong>Inquirer</strong>（推荐使用新版 <code>@inquirer/prompts</code>）将极大提升用户体验。</li>
<li><strong>行动建议</strong>：
<ul>
<li><strong>立即可做</strong>：定义你的 CLI 核心命令结构，使用 Commander 建立第一个 <code>--help</code>。</li>
<li><strong>中期计划</strong>：识别用户容易输错或难以记忆的复杂参数，将其转化为 Inquirer 的交互式问答流程。</li>
</ul>
</li>
</ol>
<hr/>
<p><strong>参考来源：</strong></p>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FSBoudrias%2FInquirer.js" target="_blank" title="https://github.com/SBoudrias/Inquirer.js" ref="nofollow noopener noreferrer">Inquirer.js GitHub Repository</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Ftj%2Fcommander.js" target="_blank" title="https://github.com/tj/commander.js" ref="nofollow noopener noreferrer">Commander.js GitHub Repository</a></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[最强Kimi K2.5 真能做到一句话开发一个应用 - 3分钟简单上手体验]]></title>    <link>https://juejin.cn/post/7600318091832197147</link>    <guid>https://juejin.cn/post/7600318091832197147</guid>    <pubDate>2026-01-29T06:24:06.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600318091832197147" data-draft-id="7600508556124143667" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="最强Kimi K2.5 真能做到一句话开发一个应用 - 3分钟简单上手体验"/> <meta itemprop="keywords" content="前端,后端"/> <meta itemprop="datePublished" content="2026-01-29T06:24:06.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="万少"/> <meta itemprop="url" content="https://juejin.cn/user/4441682708283191"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            最强Kimi K2.5 真能做到一句话开发一个应用 - 3分钟简单上手体验
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4441682708283191/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    万少
  </span> <!----> <!----> <div class="vip-level" data-v-cd7d0a50="" data-v-292f6e48=""><span class="tooltip" data-v-cd7d0a50=""><div class="byte-tooltip byte-tooltip--dark" style="display:none;">
        VIP.5 如鱼得水
      </div><span class="byte-tooltip__wrapper"><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADwAAAA8AQMAAAAAMksxAAAAA1BMVEUAAACnej3aAAAAAXRSTlMAQObYZgAAAA5JREFUKM9jGAWjAAcAAAIcAAE27nY6AAAAAElFTkSuQmCC" alt="VIP.5 如鱼得水" title="VIP.5 如鱼得水" class="lazy" style="aspect-ratio:NaN;" data-v-5244ef91="" data-v-cd7d0a50=""/></span></span></div> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-29T06:24:06.000Z" title="Thu Jan 29 2026 06:24:06 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">最强Kimi K2.5 真能做到一句话开发一个应用 - 3分钟简单上手体验</h2>
<blockquote>
<p><strong>万少：华为HDE、鸿蒙极客、个人独立开发者</strong></p>
<p>个人主页：<a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.zbztb.cn%2F" target="_blank" title="https://blog.zbztb.cn/" ref="nofollow noopener noreferrer">blog.zbztb.cn/</a></p>
<p><strong>2025年参与孵化了20+鸿蒙应用、技术文章300+、鸿蒙知识库用户500+、鸿蒙免费课程2套。</strong></p>
<p>如果你也喜欢交流AI和鸿蒙技术，欢迎扣我。</p>
</blockquote>
<h3 data-id="heading-1">1月27日</h3>
<p>月之暗面 在1月27日 推出号称<strong>迄今为止最强大的开源模型</strong> 《<strong>Kimi K2.5</strong>》</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2f683a8e85dc4ae1b704eae61d02e2c8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiH5bCR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770272645&amp;x-signature=src4GufReTjAsuclocHIl8hBwv4%3D" alt="图片" loading="lazy"/></p>
<p>Kimi K2.5 基于 <strong>Kimi K2</strong> 构建，通过约 <strong>15T</strong> 混合视觉和文本 <strong>token</strong> 的持续预训练。</p>
<p>作为原生多模态模型，K2.5 提供了最先进的编码和视觉能力，以及自导向的代理群范式。</p>
<p>对于复杂任务，<strong>Kimi K2.5 可以自导向一个最多包含 100 个子代理的代理群，执行跨越最多 1,500 个工具调用的并行工作流</strong>。</p>
<p>与单代理设置相比，<strong>这可将执行时间缩短高达 4.5 倍</strong>。</p>
<p>代理群由 Kimi K2.5 自动创建和编排，无需任何预定义的子代理或工作流。</p>
<hr/>
<p>100多个子代理，这不就是一堆专家围着你转了吗？</p>
<p>想象一个场景:</p>
<p>你进到了饭店点一盘<strong>鱼香肉丝</strong>：</p>
<ol>
<li><strong>有农业专家帮你选择最好的食材</strong></li>
<li><strong>有营养专家帮你搭配最合适的食材比例</strong></li>
<li><strong>有大厨师帮你烹饪最美味的食物</strong></li>
<li><strong>有艺术家帮你做最精美的摆盘</strong></li>
<li><strong>有音乐家帮你在旁边奏乐</strong></li>
<li>。。。</li>
</ol>
<p>还有很多专家围绕你的需求去服务。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cb85d327c3d24a89838552514162c0b9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiH5bCR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770272645&amp;x-signature=0AO9GMrEgsry9G4xpcxiYAKLkfE%3D" alt="图片" loading="lazy"/></p>
<h3 data-id="heading-2">能力对比</h3>
<p>Kimi K2.5 可通过 Kimi.com、Kimi App、API 和 Kimi Code 获取。</p>
<p>Kimi.com &amp; Kimi App 现在支持 4 种模式：K2.5 即时模式、K2.5 思考模式、K2.5 代理模式和 K2.5 代理群（Beta 版）。</p>
<p>代理群目前在 Kimi.com 上处于 Beta 测试阶段，高等级付费用户可免费使用。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4f0650a3cb2c463b9669a78694f8b6fe~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiH5bCR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770272645&amp;x-signature=r1nqMGNfolzn%2BkF2ACT5Qj4mznc%3D" alt="图片" loading="lazy"/></p>
<p>可以看到和国外顶尖的大模型相比也是毫不逊色。</p>
<h3 data-id="heading-3">如何体验</h3>
<p>大家如果想要简单体验一下，可以使用腾讯的<strong>CodeBuddy CN</strong>，它已经内置了K2.5模型，可以通过AI编辑器简单感受一下编程的能力。</p>
<blockquote>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fcopilot.tencent.com%2Fpromotion%2F%3Fref%3Dvlt2x31eyhp8a1" target="_blank" title="https://copilot.tencent.com/promotion/?ref=vlt2x31eyhp8a1" ref="nofollow noopener noreferrer">copilot.tencent.com/promotion/?…</a></p>
</blockquote>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c40be741e4d34c3ab9d986cc82cf1dac~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiH5bCR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770272645&amp;x-signature=lRs%2Btuew3hCtxRE1SvYE%2BPtkbZc%3D" alt="图片" loading="lazy"/></p>
<p>如果想要感受 100个代理（牛马）给你服务的感觉，你可以在Kimi官网上去体验一下。</p>
<blockquote>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.kimi.com%2Fagent-swarm" target="_blank" title="https://www.kimi.com/agent-swarm" ref="nofollow noopener noreferrer">www.kimi.com/agent-swarm</a></p>
</blockquote>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d51575b805d94fb688d63c3dd6ee6daa~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiH5bCR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770272645&amp;x-signature=qmfIxPctWgf1Vr453HPetzEFS%2Bg%3D" alt="图片" loading="lazy"/></p>
<p>目前新业务营业大酬宾 ￥4.99 可以享受7天的使用。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/eb3c6cec33d34e40a6f2a5795a18e35b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiH5bCR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770272645&amp;x-signature=cJzHM6tGgy7uMo9kkKR9G6Au5lA%3D" alt="图片" loading="lazy"/></p>
<h3 data-id="heading-4">一句话生成应用</h3>
<p>回到<strong>CodeBuddy CN</strong>编辑器内，打开对话框，输入以下提示词：</p>
<blockquote>
<p>帮我做一个单机版本的 HarmonyOS应用单机唯美风格，主题是 时光心情簿。</p>
<p>1首屏上是 4个tab，分别是首页-记录-统计-我的 1 首页是一个透明有边框的存钱罐，点击不同的心情图标可以往存钱罐里面存图标，图标下落要有动画效果，存钱罐在瓶子里也有有真实的碰撞效果</p>
<p>2 记录页面是一个可以根据日历来添加心情状态的页面，接受上传最多3章图片</p>
<p>3 统计使用好看的图标技术，可以实现按照年、月、日、不同的心情种类开始统计</p>
<p>4 我的 页面提供常见的一些功能，比如设置风格、字体大小、震动等等 所有页面设计都要有好看的过渡动画，一些页面也可以加入你找到的免费的背景图</p>
</blockquote>
<p><strong>CodeBuddy CN</strong>会帮我制定计划，确认无误后，开始干活。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/59433c7a19f5480ab72e1283c55e1639~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiH5bCR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770272645&amp;x-signature=%2F099NrmsU6rSTJVlUbq7QFtBhO4%3D" alt="图片" loading="lazy"/></p>
<h3 data-id="heading-5">最终效果</h3>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3407d10915c0410f8503306c3c01089c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiH5bCR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770272645&amp;x-signature=QxHOjog9Dgnkig69%2BFb1Iu7sBxs%3D" alt="图片" loading="lazy"/></p>
<p>可以看到，<strong>UI 效果整体还是不错的</strong>，功能是还存在需要仔细调整的部分。</p>
<p>但是这个可是生成<strong>HarmonyOS 鸿蒙应用</strong>呀，</p>
<p>不是传统的安卓和 iOS，很多AI编辑器做鸿蒙开发还处在语法都不过关的时代！</p>
<hr/>
<p>参考链接：<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.kimi.com%2Fblog%2Fkimi-k2-5.html" target="_blank" title="https://www.kimi.com/blog/kimi-k2-5.html" ref="nofollow noopener noreferrer">www.kimi.com/blog/kimi-k…</a></p>
<h3 data-id="heading-6">关注我</h3>
<p><strong>关注我</strong>，持续分享鸿蒙开发 + AI 提效的实战技巧。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[断网、弱网、关页都不怕：前端日志上报怎么做到不丢包 | 掘金一周 1.29]]></title>    <link>https://juejin.cn/post/7600345782173466658</link>    <guid>https://juejin.cn/post/7600345782173466658</guid>    <pubDate>2026-01-29T06:43:08.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600345782173466658" data-draft-id="7600326947505946676" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="断网、弱网、关页都不怕：前端日志上报怎么做到不丢包 | 掘金一周 1.29"/> <meta itemprop="keywords" content="前端,后端,人工智能"/> <meta itemprop="datePublished" content="2026-01-29T06:43:08.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="掘金一周"/> <meta itemprop="url" content="https://juejin.cn/user/53218623894222"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            断网、弱网、关页都不怕：前端日志上报怎么做到不丢包 | 掘金一周 1.29
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/53218623894222/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    掘金一周
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-29T06:43:08.000Z" title="Thu Jan 29 2026 06:43:08 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><em>本文字数1600+ ，阅读时间大约需要 5分钟。</em></p>
<blockquote>
<p>【掘金一周】本期亮点：</p>
</blockquote>
<ul>
<li>
<p><a href="https://juejin.cn/post/7596247009815412762" target="_blank" title="https://juejin.cn/post/7596247009815412762">断网、弱网、关页都不怕：前端日志上报怎么做到不丢包</a></p>
</li>
<li>
<p><a href="https://juejin.cn/post/7596932640727056419" target="_blank" title="https://juejin.cn/post/7596932640727056419">AI辅助研发的落地实践：工具、效率与成长</a></p>
</li>
<li>
<p><a href="https://juejin.cn/post/7596926832912498751" target="_blank" title="https://juejin.cn/post/7596926832912498751">还在无脑 .map().filter()？实测改用 Iterator Helpers 后，内存占用降低了 99%</a></p>
</li>
<li>
<p><a href="https://juejin.cn/post/7597278451030294538" target="_blank" title="https://juejin.cn/post/7597278451030294538">一个月搞定100+表迁移：我的“偷师”Navicat实战复盘</a></p>
</li>
<li>
<p><a href="https://juejin.cn/post/7596245612558319625" target="_blank" title="https://juejin.cn/post/7596245612558319625">Flutter 又迎大坑修改？iOS 26 键盘变化可能带来大量底层改动</a></p>
</li>
<li>
<p><a href="https://juejin.cn/post/7598390354292621358" target="_blank" title="https://juejin.cn/post/7598390354292621358">Jetpack Compose重组稳定性分析器</a></p>
</li>
<li>
<p><a href="https://juejin.cn/post/7597776334065516596" target="_blank" title="https://juejin.cn/post/7597776334065516596">Agent Skills在货拉拉AI应用尝试</a></p>
</li>
<li>
<p><a href="https://juejin.cn/post/7596478936387108906" target="_blank" title="https://juejin.cn/post/7596478936387108906">从0开发大模型之实现Agent（Bash 到 SKILL）</a></p>
</li>
</ul>
<blockquote>
<p><strong>「上榜规则」</strong>：文章发布时间在本期「掘金一周」发布时间的前一周内；且符合各个栏目的内容定位和要求。 如发现文章有抄袭、洗稿等违反社区规则的行为，将取消当期及后续上榜资格。</p>
</blockquote>
<h2 data-id="heading-0">一周“金”选</h2>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/73d5bf990a124e3a87cffb06443ad9ca~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5o6Y6YeR5LiA5ZGo:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770273787&amp;x-signature=1xpz0ksz%2BLPwxKfHLV%2BRgtwKPjE%3D" alt="掘金一周 文章头图 1303x734.jpg" loading="lazy"/></p>
<p><em>内容评审们会在过去的一周内对社区深度技术好文进行挖掘和筛选，优质的技术文章有机会出现在下方榜单中，排名不分先后。</em></p>
<h3 data-id="heading-1">前端</h3>
<p><a href="https://juejin.cn/post/7596247009815412762" target="_blank" title="https://juejin.cn/post/7596247009815412762">断网、弱网、关页都不怕：前端日志上报怎么做到不丢包</a> <a href="https://juejin.cn/user/3035079961218551/posts" target="_blank" title="https://juejin.cn/user/3035079961218551/posts">@不一样的少年_</a></p>
<blockquote>
<p>我们用一个数组（<code>queue</code>）来暂存日志，然后通过  <strong>“量够了”、“时间到了”或“页面要关了”</strong>  这三个时机来触发发送，确保既不积压也不频繁打扰服务器。</p>
</blockquote>
<p><a href="https://juejin.cn/post/7596932640727056419" target="_blank" title="https://juejin.cn/post/7596932640727056419">AI辅助研发的落地实践：工具、效率与成长</a> <a href="https://juejin.cn/user/3456520257288974/posts" target="_blank" title="https://juejin.cn/user/3456520257288974/posts">@政采云技术</a></p>
<blockquote>
<p>从整体来看，AI 辅助研发并不是简单的“用 AI 写代码”，而是一种<strong>分工明确、责任清晰的人机协作模式</strong>：   AI 擅长发散、整理、生成；人类擅长判断、取舍、收敛。当二者边界清晰、职责明确时，AI 才能真正成为研发效率的放大器，而不是新的复杂度来源。</p>
</blockquote>
<p><a href="https://juejin.cn/post/7596926832912498751" target="_blank" title="https://juejin.cn/post/7596926832912498751">还在无脑 .map().filter()？实测改用 Iterator Helpers 后，内存占用降低了 99%</a> <a href="https://juejin.cn/user/2175258804632332/posts" target="_blank" title="https://juejin.cn/user/2175258804632332/posts">@也无风雨也雾晴</a></p>
<blockquote>
<p>Iterator Helpers 是 JavaScript 新加的特性，提供了一套"惰性求值"（lazy evaluation）的方法。关键区别是：<strong>传统数组方法</strong>，每一步都立即执行，创建中间数组；<strong>Iterator Helpers</strong>，只描述要做什么，真正需要数据时才执行。</p>
</blockquote>
<p><a href="https://juejin.cn/post/7596970073750552612" target="_blank" title="https://juejin.cn/post/7596970073750552612">前端指纹技术是如何实现的？（Canvas、Audio、硬件API 核心原理解密）</a> <a href="https://juejin.cn/user/3878732754331096/posts" target="_blank" title="https://juejin.cn/user/3878732754331096/posts">@ErpanOmer</a></p>
<blockquote>
<p>所谓的前端指纹技术，本质上就是<strong>找不同</strong>的一种方式。开发者利用一切可以调用的 API（Canvas, Audio, WebGL, 硬件信息），强迫浏览器进行某种复杂的运算。由于硬件和驱动的细微差别，运算结果必然存在差异。这些差异被收集起来，生成了一个字符串。</p>
</blockquote>
<p><a href="https://juejin.cn/post/7597314244269228086" target="_blank" title="https://juejin.cn/post/7597314244269228086">从痛点到架构：用 Chrome DevTools Panel 做埋点校验，我是怎么落地的</a> <a href="https://juejin.cn/user/606586148237431/posts" target="_blank" title="https://juejin.cn/user/606586148237431/posts">@转转技术团队</a></p>
<blockquote>
<p>Chrome MV3 是一堵墙，但技术不仅能砌墙，也能架桥。 通过对底层原理的深入挖掘，我们证明了即使在最严格的安全限制下，依然可以打造出极致的开发者工具。 希望本文能给你带来两方面的收获：一是关于 Chrome 插件开发的硬核知识，二是一种“不凑合、不妥协”的极客精神。</p>
</blockquote>
<h3 data-id="heading-2">后端</h3>
<p><a href="https://juejin.cn/post/7597278451030294538" target="_blank" title="https://juejin.cn/post/7597278451030294538">一个月搞定100+表迁移：我的“偷师”Navicat实战复盘</a> <a href="https://juejin.cn/user/3485898277388519/posts" target="_blank" title="https://juejin.cn/user/3485898277388519/posts">@一旅人</a></p>
<blockquote>
<p>100+张表，每张表的字段、类型、主键都不一样。传统MyBatis方式意味着要写100+个Mapper、100+个实体类。后续新增表还得继续写，<strong>代码复用度≈0</strong>。</p>
</blockquote>
<h3 data-id="heading-3">Android</h3>
<p><a href="https://juejin.cn/post/7596245612558319625" target="_blank" title="https://juejin.cn/post/7596245612558319625">Flutter 又迎大坑修改？iOS 26 键盘变化可能带来大量底层改动</a> <a href="https://juejin.cn/user/817692379985752/posts" target="_blank" title="https://juejin.cn/user/817692379985752/posts">@恋猫de小郭</a></p>
<blockquote>
<p>虽然问题看起来是一个圆角问题，但是实际上这是 <strong>iOS 26 系统键盘增加了“半透明”后带来的问题，Flutter 在键盘后面那一层在某些场景下没有正确渲染内容</strong>，导致键盘半透明区域透出来的不是底下 BottomSheet 的真实内容，而是一整块黑色区域。</p>
</blockquote>
<p><a href="https://juejin.cn/post/7597900782910685203" target="_blank" title="https://juejin.cn/post/7597900782910685203">Android Gradle Plugin 9.0 发布，为什么这会是个史诗级大坑版本</a> <a href="https://juejin.cn/user/817692379985752/posts" target="_blank" title="https://juejin.cn/user/817692379985752/posts">@恋猫de小郭</a></p>
<blockquote>
<p>AGP 9.0 开始<strong>只暴露新的 public DSL interfaces</strong>，旧的 DSL 类型（比如历史上很多插件/脚本会强转到 <code>BaseExtension</code> 之类）不再提供，并且<strong>旧的 variant API（<code>applicationVariants</code> 等）也一起被切断</strong>，要迁移到 <code>androidComponents</code> API。</p>
</blockquote>
<p><a href="https://juejin.cn/post/7598390354292621358" target="_blank" title="https://juejin.cn/post/7598390354292621358">Jetpack Compose重组稳定性分析器</a> <a href="https://juejin.cn/user/2788017216685784/posts" target="_blank" title="https://juejin.cn/user/2788017216685784/posts">@稀有猿诉</a></p>
<blockquote>
<p>本文将探讨 Compose 稳定性分析器的工作原理，包括：IntelliJ 插件（为你的 IDE 提供可视化的稳定性指示器）、编译器插件（启用运行时重组跟踪）以及稳定性验证系统（防止回归问题影响生产环境）。</p>
</blockquote>
<h3 data-id="heading-4">人工智能</h3>
<p><a href="https://juejin.cn/post/7597776334065516596" target="_blank" title="https://juejin.cn/post/7597776334065516596">Agent Skills在货拉拉AI应用尝试</a> <a href="https://juejin.cn/user/1768489241815070/posts" target="_blank" title="https://juejin.cn/user/1768489241815070/posts">@货拉拉技术</a></p>
<blockquote>
<p><strong>渐进式披露</strong>是Agent技能设计中的核心原则，它让智能体的技能体系既<strong>灵活又可扩展</strong>。就像一本结构清晰的说明书，先给目录，再分章节，最后附上详细附录——技能的设计也是如此，让Claude<strong>只在需要时</strong>才加载对应的信息。</p>
</blockquote>
<p><a href="https://juejin.cn/post/7596478936387108906" target="_blank" title="https://juejin.cn/post/7596478936387108906">从0开发大模型之实现Agent（Bash 到 SKILL）</a> <a href="https://juejin.cn/user/3245414056989757/posts" target="_blank" title="https://juejin.cn/user/3245414056989757/posts">@周末程序猿</a></p>
<blockquote>
<p>模型、工具、指令三者构成了 <code>AI Agent</code> 的下限和上限，模型越强，对于指令和工具的调度能力更准确，但是从工程学的角度来考虑，较弱的模型通过对工具和指令的结合，一样能制造功能强大的 <code>Agent</code>。</p>
</blockquote>
<p><a href="https://juejin.cn/post/7596926832913055807" target="_blank" title="https://juejin.cn/post/7596926832913055807">2026 最新 Claude Skills 保姆级教程及实践！</a> <a href="https://juejin.cn/user/588993963763405/posts" target="_blank" title="https://juejin.cn/user/588993963763405/posts">@苍何</a></p>
<blockquote>
<p>Skills 改变了我们与 AI 协作的基本方式。它们将一次性的提示，转变为持久、可组合的知识资产。通过为 AI 建立一个可扩展的程序性记忆库，Skills 正在为下一代代更强大、更自主、更能与人类专家无缝协作的 AI Agent 奠定基础。</p>
</blockquote>
<h2 data-id="heading-5">📖 投稿专区</h2>
<blockquote>
<p>大家可以在评论区推荐认为不错的文章，并附上链接和推荐理由，有机会呈现在下一期。文章创建日期必须在下期掘金一周发布前一周以内；可以推荐自己的文章、也可以推荐他人的文章。</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[深入浅出FastAPI：现代Python Web开发的利器]]></title>    <link>https://juejin.cn/post/7600333405979410473</link>    <guid>https://juejin.cn/post/7600333405979410473</guid>    <pubDate>2026-01-29T05:43:31.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600333405979410473" data-draft-id="7600491179499094070" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="深入浅出FastAPI：现代Python Web开发的利器"/> <meta itemprop="keywords" content="后端,Python"/> <meta itemprop="datePublished" content="2026-01-29T05:43:31.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="诸神缄默不语"/> <meta itemprop="url" content="https://juejin.cn/user/2036746568087502"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            深入浅出FastAPI：现代Python Web开发的利器
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2036746568087502/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    诸神缄默不语
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-29T05:43:31.000Z" title="Thu Jan 29 2026 05:43:31 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.csdn.net%2FPolarisRisingWar%2Farticle%2Fdetails%2F116396744" target="_blank" title="https://blog.csdn.net/PolarisRisingWar/article/details/116396744" ref="nofollow noopener noreferrer">诸神缄默不语-个人技术博文与视频目录</a></p>
<p>官方文档：<a href="https://link.juejin.cn?target=https%3A%2F%2Ffastapi.tiangolo.com%2F" target="_blank" title="https://fastapi.tiangolo.com/" ref="nofollow noopener noreferrer">FastAPI</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fpypi.org%2Fproject%2Ffastapi%2F" target="_blank" title="https://pypi.org/project/fastapi/" ref="nofollow noopener noreferrer">fastapi · PyPI</a></p>
<blockquote>
<p>还在为Python Web开发的速度和性能发愁？FastAPI或许是你一直在寻找的解决方案！</p>
</blockquote>
<h2 data-id="heading-0">什么是FastAPI？</h2>
<p>FastAPI是一个现代、快速（高性能）的Python Web框架，专门用于构建API。它基于标准Python类型提示，使用Python 3.6+版本的类型提示特性，让API开发变得简单而强大。</p>
<h2 data-id="heading-1">FastAPI的核心优势</h2>
<ul>
<li>⚡ <strong>极快的性能</strong>：与NodeJS和Go相当，是Python领域最快的框架之一</li>
<li>🚀 <strong>高效的编码</strong>：开发速度提升约200%-300%</li>
<li>📝 <strong>更少的bug</strong>：减少约40%的人为错误</li>
<li>💡 <strong>直观的API</strong>：强大的编辑器支持，自动补全无处不在</li>
<li>📚 <strong>完整的标准</strong>：基于并完全兼容开放的API标准（OpenAPI和JSON Schema）</li>
</ul>
<h2 data-id="heading-2">安装FastAPI</h2>
<pre><code class="hljs language-bash" lang="bash">pip install <span class="hljs-string">"fastapi[standard]"</span>
</code></pre>
<h2 data-id="heading-3">第一个FastAPI应用</h2>
<p>让我们从一个简单的"Hello World"开始：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> fastapi <span class="hljs-keyword">import</span> FastAPI

<span class="hljs-comment"># 创建FastAPI实例</span>
app = FastAPI()

<span class="hljs-comment"># 定义根路径的路由</span>
<span class="hljs-meta">@app.get(<span class="hljs-params"><span class="hljs-string">"/"</span></span>)</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">read_root</span>():
    <span class="hljs-keyword">return</span> {<span class="hljs-string">"message"</span>: <span class="hljs-string">"Hello World"</span>}

<span class="hljs-comment"># 带路径参数的路由</span>
<span class="hljs-meta">@app.get(<span class="hljs-params"><span class="hljs-string">"/items/{item_id}"</span></span>)</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">read_item</span>(<span class="hljs-params">item_id: <span class="hljs-built_in">int</span>, q: <span class="hljs-built_in">str</span> = <span class="hljs-literal">None</span></span>):
    <span class="hljs-keyword">return</span> {<span class="hljs-string">"item_id"</span>: item_id, <span class="hljs-string">"q"</span>: q}
</code></pre>
<p>保存为 <code>try1.py</code>，然后运行：</p>
<pre><code class="hljs language-bash" lang="bash">python -m uvicorn try1:app --reload
</code></pre>
<p>访问 <code>http://127.0.0.1:8000</code>，你将看到JSON响应：<code>{"message": "Hello World"}</code></p>
<p>uvicorn也可以使用Python脚本运行：
创建一个 try2.py 文件：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> uvicorn

<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">"__main__"</span>:
    uvicorn.run(<span class="hljs-string">"try1:app"</span>, host=<span class="hljs-string">"127.0.0.1"</span>, port=<span class="hljs-number">8000</span>, reload=<span class="hljs-literal">True</span>)
</code></pre>
<p>然后运行：</p>
<pre><code class="hljs">python try2.py
</code></pre>
<h2 data-id="heading-4">自动API文档</h2>
<p>FastAPI最酷的特性之一就是自动生成交互式API文档！</p>
<ul>
<li><strong>Swagger UI</strong>: <a href="https://link.juejin.cn?target=http%3A%2F%2F127.0.0.1%3A8000%2Fdocs" target="_blank" title="http://127.0.0.1:8000/docs" ref="nofollow noopener noreferrer">http://127.0.0.1:8000/docs</a></li>
<li><strong>ReDoc</strong>: <a href="https://link.juejin.cn?target=http%3A%2F%2F127.0.0.1%3A8000%2Fredoc" target="_blank" title="http://127.0.0.1:8000/redoc" ref="nofollow noopener noreferrer">http://127.0.0.1:8000/redoc</a></li>
</ul>
<p>这些文档是完全交互的，你可以直接在浏览器中测试API！</p>
<p>由于网络问题，可能打开后无法显示内容，可以在F12中看到需要从外网下js：
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/86cb9cd4da764d13b49aac0e550f66bc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6K-456We57yE6buY5LiN6K-t:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770270213&amp;x-signature=Ttyazsag8IeoNOtuuY0vjM6c7SI%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<h2 data-id="heading-5">深入FastAPI特性</h2>
<h3 data-id="heading-6">1. 类型提示和数据验证</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> <span class="hljs-type">Optional</span>
<span class="hljs-keyword">from</span> pydantic <span class="hljs-keyword">import</span> BaseModel

<span class="hljs-comment"># 定义数据模型</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Item</span>(<span class="hljs-title class_ inherited__">BaseModel</span>):
    name: <span class="hljs-built_in">str</span>
    description: <span class="hljs-type">Optional</span>[<span class="hljs-built_in">str</span>] = <span class="hljs-literal">None</span>
    price: <span class="hljs-built_in">float</span>
    tax: <span class="hljs-type">Optional</span>[<span class="hljs-built_in">float</span>] = <span class="hljs-literal">None</span>

<span class="hljs-meta">@app.post(<span class="hljs-params"><span class="hljs-string">"/items/"</span></span>)</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">create_item</span>(<span class="hljs-params">item: Item</span>):
    item_dict = item.<span class="hljs-built_in">dict</span>()
    <span class="hljs-keyword">if</span> item.tax:
        price_with_tax = item.price + item.tax
        item_dict.update({<span class="hljs-string">"price_with_tax"</span>: price_with_tax})
    <span class="hljs-keyword">return</span> item_dict
</code></pre>
<h3 data-id="heading-7">2. 路径参数和查询参数</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> enum <span class="hljs-keyword">import</span> Enum

<span class="hljs-keyword">class</span> <span class="hljs-title class_">ModelName</span>(<span class="hljs-built_in">str</span>, Enum):
    alexnet = <span class="hljs-string">"alexnet"</span>
    resnet = <span class="hljs-string">"resnet"</span>
    lenet = <span class="hljs-string">"lenet"</span>

<span class="hljs-meta">@app.get(<span class="hljs-params"><span class="hljs-string">"/models/{model_name}"</span></span>)</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">get_model</span>(<span class="hljs-params">model_name: ModelName</span>):
    <span class="hljs-keyword">if</span> model_name == ModelName.alexnet:
        <span class="hljs-keyword">return</span> {<span class="hljs-string">"model_name"</span>: model_name, <span class="hljs-string">"message"</span>: <span class="hljs-string">"Deep Learning FTW!"</span>}
    
    <span class="hljs-keyword">if</span> model_name.value == <span class="hljs-string">"lenet"</span>:
        <span class="hljs-keyword">return</span> {<span class="hljs-string">"model_name"</span>: model_name, <span class="hljs-string">"message"</span>: <span class="hljs-string">"LeCNN all the images"</span>}
    
    <span class="hljs-keyword">return</span> {<span class="hljs-string">"model_name"</span>: model_name, <span class="hljs-string">"message"</span>: <span class="hljs-string">"Have some residuals"</span>}

<span class="hljs-meta">@app.get(<span class="hljs-params"><span class="hljs-string">"/users/"</span></span>)</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">read_users</span>(<span class="hljs-params">skip: <span class="hljs-built_in">int</span> = <span class="hljs-number">0</span>, limit: <span class="hljs-built_in">int</span> = <span class="hljs-number">10</span>, q: <span class="hljs-type">Optional</span>[<span class="hljs-built_in">str</span>] = <span class="hljs-literal">None</span></span>):
    <span class="hljs-comment"># 模拟从数据库获取用户</span>
    users = [{<span class="hljs-string">"id"</span>: i, <span class="hljs-string">"name"</span>: <span class="hljs-string">f"User <span class="hljs-subst">{i}</span>"</span>} <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">100</span>)]
    
    <span class="hljs-keyword">if</span> q:
        users = [user <span class="hljs-keyword">for</span> user <span class="hljs-keyword">in</span> users <span class="hljs-keyword">if</span> q.lower() <span class="hljs-keyword">in</span> user[<span class="hljs-string">"name"</span>].lower()]
    
    <span class="hljs-keyword">return</span> users[skip: skip + limit]
</code></pre>
<h3 data-id="heading-8">3. 请求体和复杂数据模型</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> datetime <span class="hljs-keyword">import</span> datetime
<span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> <span class="hljs-type">List</span>

<span class="hljs-keyword">class</span> <span class="hljs-title class_">User</span>(<span class="hljs-title class_ inherited__">BaseModel</span>):
    <span class="hljs-built_in">id</span>: <span class="hljs-built_in">int</span>
    name: <span class="hljs-built_in">str</span> = <span class="hljs-string">"John Doe"</span>
    signup_ts: <span class="hljs-type">Optional</span>[datetime] = <span class="hljs-literal">None</span>
    friends: <span class="hljs-type">List</span>[<span class="hljs-built_in">int</span>] = []

<span class="hljs-keyword">class</span> <span class="hljs-title class_">ComplexData</span>(<span class="hljs-title class_ inherited__">BaseModel</span>):
    user: User
    items: <span class="hljs-type">List</span>[Item]

<span class="hljs-meta">@app.put(<span class="hljs-params"><span class="hljs-string">"/complex-data/{data_id}"</span></span>)</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">update_complex_data</span>(<span class="hljs-params">data_id: <span class="hljs-built_in">int</span>, data: ComplexData</span>):
    <span class="hljs-keyword">return</span> {
        <span class="hljs-string">"data_id"</span>: data_id,
        <span class="hljs-string">"data"</span>: data.<span class="hljs-built_in">dict</span>(),
        <span class="hljs-string">"received_at"</span>: datetime.now()
    }
</code></pre>
<h3 data-id="heading-9">4. 依赖注入系统</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> fastapi <span class="hljs-keyword">import</span> Depends, HTTPException, status

<span class="hljs-comment"># 简单的依赖</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">common_parameters</span>(<span class="hljs-params">
    skip: <span class="hljs-built_in">int</span> = <span class="hljs-number">0</span>, 
    limit: <span class="hljs-built_in">int</span> = <span class="hljs-number">100</span>,
    q: <span class="hljs-type">Optional</span>[<span class="hljs-built_in">str</span>] = <span class="hljs-literal">None</span>
</span>):
    <span class="hljs-keyword">return</span> {<span class="hljs-string">"skip"</span>: skip, <span class="hljs-string">"limit"</span>: limit, <span class="hljs-string">"q"</span>: q}

<span class="hljs-meta">@app.get(<span class="hljs-params"><span class="hljs-string">"/items/"</span></span>)</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">read_items</span>(<span class="hljs-params">commons: <span class="hljs-built_in">dict</span> = Depends(<span class="hljs-params">common_parameters</span>)</span>):
    <span class="hljs-keyword">return</span> commons

<span class="hljs-comment"># 更复杂的依赖注入示例</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Database</span>:
    <span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">get_user</span>(<span class="hljs-params">self, user_id: <span class="hljs-built_in">int</span></span>):
        <span class="hljs-comment"># 模拟数据库查询</span>
        <span class="hljs-keyword">return</span> {<span class="hljs-string">"user_id"</span>: user_id, <span class="hljs-string">"name"</span>: <span class="hljs-string">f"User <span class="hljs-subst">{user_id}</span>"</span>}

<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">get_database</span>():
    <span class="hljs-keyword">return</span> Database()

<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">get_current_user</span>(<span class="hljs-params">
    user_id: <span class="hljs-built_in">int</span>, 
    db: Database = Depends(<span class="hljs-params">get_database</span>)
</span>):
    user = <span class="hljs-keyword">await</span> db.get_user(user_id)
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> user:
        <span class="hljs-keyword">raise</span> HTTPException(status_code=<span class="hljs-number">404</span>, detail=<span class="hljs-string">"User not found"</span>)
    <span class="hljs-keyword">return</span> user

<span class="hljs-meta">@app.get(<span class="hljs-params"><span class="hljs-string">"/users/me"</span></span>)</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">read_current_user</span>(<span class="hljs-params">current_user: <span class="hljs-built_in">dict</span> = Depends(<span class="hljs-params">get_current_user</span>)</span>):
    <span class="hljs-keyword">return</span> current_user
</code></pre>
<h3 data-id="heading-10">5. 错误处理</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> fastapi <span class="hljs-keyword">import</span> HTTPException
<span class="hljs-keyword">from</span> fastapi.responses <span class="hljs-keyword">import</span> JSONResponse

<span class="hljs-comment"># 自定义异常处理器</span>
<span class="hljs-meta">@app.exception_handler(<span class="hljs-params">HTTPException</span>)</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">http_exception_handler</span>(<span class="hljs-params">request, exc</span>):
    <span class="hljs-keyword">return</span> JSONResponse(
        status_code=exc.status_code,
        content={<span class="hljs-string">"message"</span>: exc.detail, <span class="hljs-string">"error"</span>: <span class="hljs-literal">True</span>}
    )

<span class="hljs-comment"># 抛出HTTP异常</span>
<span class="hljs-meta">@app.get(<span class="hljs-params"><span class="hljs-string">"/protected-route"</span></span>)</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">protected_route</span>(<span class="hljs-params">token: <span class="hljs-built_in">str</span> = <span class="hljs-literal">None</span></span>):
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> token <span class="hljs-keyword">or</span> token != <span class="hljs-string">"secret-token"</span>:
        <span class="hljs-keyword">raise</span> HTTPException(
            status_code=status.HTTP_401_UNAUTHORIZED,
            detail=<span class="hljs-string">"Invalid authentication credentials"</span>,
            headers={<span class="hljs-string">"WWW-Authenticate"</span>: <span class="hljs-string">"Bearer"</span>},
        )
    <span class="hljs-keyword">return</span> {<span class="hljs-string">"message"</span>: <span class="hljs-string">"Access granted"</span>}
</code></pre>
<h3 data-id="heading-11">6. 中间件和CORS</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> fastapi.middleware.cors <span class="hljs-keyword">import</span> CORSMiddleware
<span class="hljs-keyword">import</span> time

<span class="hljs-comment"># 添加CORS中间件</span>
app.add_middleware(
    CORSMiddleware,
    allow_origins=[<span class="hljs-string">"*"</span>],  <span class="hljs-comment"># 生产环境中应该指定具体域名</span>
    allow_credentials=<span class="hljs-literal">True</span>,
    allow_methods=[<span class="hljs-string">"*"</span>],
    allow_headers=[<span class="hljs-string">"*"</span>],
)

<span class="hljs-comment"># 自定义中间件：添加处理时间头</span>
<span class="hljs-meta">@app.middleware(<span class="hljs-params"><span class="hljs-string">"http"</span></span>)</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">add_process_time_header</span>(<span class="hljs-params">request, call_next</span>):
    start_time = time.time()
    response = <span class="hljs-keyword">await</span> call_next(request)
    process_time = time.time() - start_time
    response.headers[<span class="hljs-string">"X-Process-Time"</span>] = <span class="hljs-built_in">str</span>(process_time)
    <span class="hljs-keyword">return</span> response
</code></pre>
<h2 data-id="heading-12">完整示例：待办事项API</h2>
<p>让我们构建一个完整的待办事项管理API：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> fastapi <span class="hljs-keyword">import</span> FastAPI, HTTPException, Depends
<span class="hljs-keyword">from</span> pydantic <span class="hljs-keyword">import</span> BaseModel
<span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> <span class="hljs-type">List</span>, <span class="hljs-type">Optional</span>
<span class="hljs-keyword">from</span> uuid <span class="hljs-keyword">import</span> UUID, uuid4

app = FastAPI(title=<span class="hljs-string">"Todo API"</span>, version=<span class="hljs-string">"1.0.0"</span>)

<span class="hljs-comment"># 数据模型</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">TodoItem</span>(<span class="hljs-title class_ inherited__">BaseModel</span>):
    <span class="hljs-built_in">id</span>: <span class="hljs-type">Optional</span>[UUID] = <span class="hljs-literal">None</span>
    title: <span class="hljs-built_in">str</span>
    description: <span class="hljs-type">Optional</span>[<span class="hljs-built_in">str</span>] = <span class="hljs-literal">None</span>
    completed: <span class="hljs-built_in">bool</span> = <span class="hljs-literal">False</span>

<span class="hljs-comment"># 模拟数据库</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">TodoDB</span>:
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self</span>):
        self.todos: <span class="hljs-type">List</span>[TodoItem] = []
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">get_all</span>(<span class="hljs-params">self</span>) -&gt; <span class="hljs-type">List</span>[TodoItem]:
        <span class="hljs-keyword">return</span> self.todos
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">get</span>(<span class="hljs-params">self, todo_id: UUID</span>) -&gt; <span class="hljs-type">Optional</span>[TodoItem]:
        <span class="hljs-keyword">for</span> todo <span class="hljs-keyword">in</span> self.todos:
            <span class="hljs-keyword">if</span> todo.<span class="hljs-built_in">id</span> == todo_id:
                <span class="hljs-keyword">return</span> todo
        <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span>
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">create</span>(<span class="hljs-params">self, todo: TodoItem</span>) -&gt; TodoItem:
        todo.<span class="hljs-built_in">id</span> = uuid4()
        self.todos.append(todo)
        <span class="hljs-keyword">return</span> todo
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">update</span>(<span class="hljs-params">self, todo_id: UUID, updated_todo: TodoItem</span>) -&gt; <span class="hljs-type">Optional</span>[TodoItem]:
        <span class="hljs-keyword">for</span> idx, todo <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(self.todos):
            <span class="hljs-keyword">if</span> todo.<span class="hljs-built_in">id</span> == todo_id:
                updated_todo.<span class="hljs-built_in">id</span> = todo_id
                self.todos[idx] = updated_todo
                <span class="hljs-keyword">return</span> updated_todo
        <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span>
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">delete</span>(<span class="hljs-params">self, todo_id: UUID</span>) -&gt; <span class="hljs-built_in">bool</span>:
        <span class="hljs-keyword">for</span> idx, todo <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(self.todos):
            <span class="hljs-keyword">if</span> todo.<span class="hljs-built_in">id</span> == todo_id:
                <span class="hljs-keyword">del</span> self.todos[idx]
                <span class="hljs-keyword">return</span> <span class="hljs-literal">True</span>
        <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span>

<span class="hljs-comment"># 依赖注入</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">get_db</span>():
    <span class="hljs-keyword">return</span> TodoDB()

<span class="hljs-comment"># API路由</span>
<span class="hljs-meta">@app.get(<span class="hljs-params"><span class="hljs-string">"/todos"</span>, response_model=<span class="hljs-type">List</span>[TodoItem]</span>)</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">list_todos</span>(<span class="hljs-params">db: TodoDB = Depends(<span class="hljs-params">get_db</span>)</span>):
    <span class="hljs-keyword">return</span> db.get_all()

<span class="hljs-meta">@app.get(<span class="hljs-params"><span class="hljs-string">"/todos/{todo_id}"</span>, response_model=TodoItem</span>)</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">get_todo</span>(<span class="hljs-params">todo_id: UUID, db: TodoDB = Depends(<span class="hljs-params">get_db</span>)</span>):
    todo = db.get(todo_id)
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> todo:
        <span class="hljs-keyword">raise</span> HTTPException(status_code=<span class="hljs-number">404</span>, detail=<span class="hljs-string">"Todo not found"</span>)
    <span class="hljs-keyword">return</span> todo

<span class="hljs-meta">@app.post(<span class="hljs-params"><span class="hljs-string">"/todos"</span>, response_model=TodoItem</span>)</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">create_todo</span>(<span class="hljs-params">todo: TodoItem, db: TodoDB = Depends(<span class="hljs-params">get_db</span>)</span>):
    <span class="hljs-keyword">return</span> db.create(todo)

<span class="hljs-meta">@app.put(<span class="hljs-params"><span class="hljs-string">"/todos/{todo_id}"</span>, response_model=TodoItem</span>)</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">update_todo</span>(<span class="hljs-params">todo_id: UUID, updated_todo: TodoItem, db: TodoDB = Depends(<span class="hljs-params">get_db</span>)</span>):
    todo = db.update(todo_id, updated_todo)
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> todo:
        <span class="hljs-keyword">raise</span> HTTPException(status_code=<span class="hljs-number">404</span>, detail=<span class="hljs-string">"Todo not found"</span>)
    <span class="hljs-keyword">return</span> todo

<span class="hljs-meta">@app.delete(<span class="hljs-params"><span class="hljs-string">"/todos/{todo_id}"</span></span>)</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">delete_todo</span>(<span class="hljs-params">todo_id: UUID, db: TodoDB = Depends(<span class="hljs-params">get_db</span>)</span>):
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> db.delete(todo_id):
        <span class="hljs-keyword">raise</span> HTTPException(status_code=<span class="hljs-number">404</span>, detail=<span class="hljs-string">"Todo not found"</span>)
    <span class="hljs-keyword">return</span> {<span class="hljs-string">"message"</span>: <span class="hljs-string">"Todo deleted successfully"</span>}
</code></pre>
<h2 data-id="heading-13">部署FastAPI应用</h2>
<p>使用Uvicorn部署：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 开发环境（带热重载）</span>
uvicorn main:app --reload --host 0.0.0.0 --port 8000

<span class="hljs-comment"># 生产环境</span>
uvicorn main:app --host 0.0.0.0 --port 8000 --workers 4
</code></pre>
<p>使用Docker + uvicorn部署：</p>
<pre><code class="hljs language-dockerfile" lang="dockerfile">FROM python:3.9

WORKDIR /code

COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

COPY . .

CMD ["uvicorn", "main:app", "--host", "0.0.0.0", "--port", "80"]
</code></pre>
<h2 data-id="heading-14">常见bug</h2>
<ol>
<li><kbd>Ctrl+C</kbd>无法关闭进程，无法返回终端prompt
如果运行<code>uv run uvicorn app.main:app --host 0.0.0.0 --port 8000 --reload</code>就无法正常关闭，只能用Python脚本来运行。就直接在入口脚本（<code>uvicorn.run()</code>的脚本）上直接加：
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">receive_signal</span>(<span class="hljs-params">signalNumber, frame</span>):
    <span class="hljs-built_in">print</span>(<span class="hljs-string">'\nReceived signal:'</span>, signalNumber)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">'正在关闭FastAPI服务...'</span>)
    <span class="hljs-comment"># 强制退出，不等待子进程</span>
    os._exit(<span class="hljs-number">0</span>)

<span class="hljs-comment"># 注册信号处理</span>
signal.signal(signal.SIGINT, receive_signal)  <span class="hljs-comment"># 处理Ctrl+C</span>
signal.signal(signal.SIGTERM, receive_signal)  <span class="hljs-comment"># 处理终止信号</span>
</code></pre>
参考资料：<a href="https://link.juejin.cn?target=https%3A%2F%2Fstackoverflow.com%2Fquestions%2F74116435" target="_blank" title="https://stackoverflow.com/questions/74116435" ref="nofollow noopener noreferrer">stackoverflow.com/questions/7…</a></li>
</ol>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f59d79eb36e242dab687d0ea1a7b688d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6K-456We57yE6buY5LiN6K-t:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770270213&amp;x-signature=J6KVu0ebYtI2Stc%2FUUaEtlgCmvg%3D" alt="image.png" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[# 震惊！GaussDB事务中断后拒绝执行后续操作]]></title>    <link>https://juejin.cn/post/7600341731047129123</link>    <guid>https://juejin.cn/post/7600341731047129123</guid>    <pubDate>2026-01-29T05:58:55.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600341731047129123" data-draft-id="7600341731047096355" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="# 震惊！GaussDB事务中断后拒绝执行后续操作"/> <meta itemprop="keywords" content="Java,数据库"/> <meta itemprop="datePublished" content="2026-01-29T05:58:55.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="用户903846366581"/> <meta itemprop="url" content="https://juejin.cn/user/1602415871147403"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            # 震惊！GaussDB事务中断后拒绝执行后续操作
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1602415871147403/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    用户903846366581
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-29T05:58:55.000Z" title="Thu Jan 29 2026 05:58:55 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    8
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">震惊！GaussDB事务中断后拒绝执行后续操作，你的Java程序可能正面临巨大风险！</h2>
<h3 data-id="heading-1">1. 生产问题引出：<code>current transaction is aborted, commands ignored until end of transaction block</code></h3>
<p>在生产环境中，抓取到这样的错误信息：</p>
<pre><code class="hljs language-vbnet" lang="vbnet">org.postgresql.util.PSQLException: <span class="hljs-keyword">ERROR</span>: current transaction <span class="hljs-built_in">is</span> aborted, commands ignored <span class="hljs-keyword">until</span> <span class="hljs-keyword">end</span> <span class="hljs-keyword">of</span> transaction block
</code></pre>
<p>找开发，人家反馈业务代码当中明确捕获了异常的！！</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 错误的做法示例</span>
<span class="hljs-meta">@Transactional</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">badExample</span><span class="hljs-params">()</span> {
    <span class="hljs-keyword">try</span> {
        userRepository.save(user);
        orderRepository.save(order); 
      
      	<span class="hljs-comment">// 构造日志，但写库失败了：比如某个字段超长、没满足非空约束、主键冲突...</span>
      	operateLogService.regiest(badLog); 
    } <span class="hljs-keyword">catch</span> (DataIntegrityViolationException e) {
        <span class="hljs-comment">// 即使捕获了异常，事务仍处于aborted状态</span>
        auditLogRepository.save(auditLog); <span class="hljs-comment">// 整个操作都废了，前面的正常操作也提交不了</span>
    }
}
</code></pre>
<p>纳尼！！ 这个ruleService入库因为一个not null约束导致失败，居然让主业务的入库也失败了！！</p>
<p><strong>特注：这不是个性专有数据库才出现的情况，在这种代码实现下，当前这些数据库都会失败，除非你显性做额外处理！</strong></p>
<h3 data-id="heading-2">2. 问题复现</h3>
<p>赶紧写个程序验证一下。</p>
<ol>
<li>准备一张测试表</li>
</ol>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">create</span> <span class="hljs-keyword">table</span> t_test ( name <span class="hljs-type">varchar</span>(<span class="hljs-number">20</span>) <span class="hljs-keyword">not</span> <span class="hljs-keyword">null</span>);
</code></pre>
<ol start="2">
<li>
<p>用原生jdbc模拟操作</p>
<blockquote>
<p>传统认识：执行完会有aa，bb两条记录。但实际上，啥也没有...</p>
</blockquote>
</li>
</ol>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 这里就是获取连接，不重要，可自己写</span>
<span class="hljs-type">Connection</span> <span class="hljs-variable">conn</span> <span class="hljs-operator">=</span> JdbcUtil.initConnection();

<span class="hljs-comment">// 关闭事务自动提交</span>
conn.setAutoCommit(<span class="hljs-literal">false</span>);

<span class="hljs-comment">// 1. 模拟主业务的正常操作</span>
<span class="hljs-type">PreparedStatement</span> <span class="hljs-variable">pstm</span> <span class="hljs-operator">=</span> conn.prepareStatement(<span class="hljs-string">"insert into t_test(name) values (?)"</span>);
pstm.setString(<span class="hljs-number">1</span>, <span class="hljs-string">"aa"</span>);
pstm.executeUpdate();

<span class="hljs-comment">// 2. 准备执行操作：插入一条""记录，预估失败，捕获异常，插入bb记录</span>
<span class="hljs-keyword">try</span>{
		pstm.setString(<span class="hljs-number">1</span>, <span class="hljs-string">""</span>);
		pstm.executeUpdate();
} <span class="hljs-keyword">catch</span>(Exception e){
    System.out.println(e);
  	pstm.setString(<span class="hljs-number">1</span>, <span class="hljs-string">"bb"</span>);
  	pstm.executeUpdate();
}

<span class="hljs-comment">// 正常提交</span>
<span class="hljs-number">3.</span> conn.commit();
</code></pre>
<ol start="3">
<li>查看数据库</li>
</ol>
<pre><code class="hljs language-css" lang="css">期望：数据库中有两条记录：aa，bb。但实际上，啥也没有... 啥也不是

突然想起这样的业务流程设计：
	先写<span class="hljs-selector-tag">A</span>表；再写<span class="hljs-selector-tag">B</span>表，如果失败了，C表登记一条异常记录；
交易结束，系统保存<span class="hljs-selector-tag">A</span>，<span class="hljs-selector-tag">B</span> 或者<span class="hljs-selector-tag">A</span>，C
</code></pre>
<p><strong>这种需求不少，实现都这样的。 不行，赶紧改代码去, 😭😭</strong></p>
<h3 data-id="heading-3">3. 常见误解：@Transactional方法内捕获异常的陷阱</h3>
<p>许多开发者存在一个常见误解：<strong>在<code>@Transactional</code>注解的方法内部捕获异常就能让逻辑符合期望的执行</strong>。如</p>
<p>这种理解在某些数据库系统中是正确的，但在PostgreSQL和GaussDB中却行不通。</p>
<h4 data-id="heading-4">传统认知 vs 现实情况</h4>
<p><strong>传统认知</strong>：</p>
<ul>
<li>在<code>@Transactional</code>方法中发生异常</li>
<li>使用try-catch捕获异常</li>
<li>执行补偿逻辑</li>
<li>操作都可以正常进行</li>
</ul>
<p><strong>现实情况（PostgreSQL/GaussDB）</strong>：</p>
<ul>
<li>一旦事务中的任何SQL语句失败</li>
<li>整个事务进入"aborted"状态</li>
<li>即使在应用层捕获了异常</li>
<li>后续的所有SQL操作都会失败</li>
</ul>
<h4 data-id="heading-5">PostgreSQL/GaussDB 行为</h4>
<ul>
<li>事务中任何错误都会导致整个事务进入"aborted"状态</li>
<li>后续所有SQL命令都会被忽略，直到事务结束</li>
<li>必须执行ROLLBACK或COMMIT来退出aborted状态</li>
<li>这种设计保证了数据的一致性，但限制了灵活性</li>
</ul>
<h4 data-id="heading-6">MySQL 行为（默认隔离级别）</h4>
<ul>
<li>对于非事务性存储引擎，行为类似PostgreSQL</li>
<li>对于InnoDB存储引擎，支持SAVEPOINT</li>
<li>可以在事务中设置保存点，部分回滚到保存点</li>
<li>相对更灵活，但需要显式使用SAVEPOINT</li>
</ul>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- MySQL中使用SAVEPOINT的例子</span>
<span class="hljs-keyword">BEGIN</span>;
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> users <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">1</span>, <span class="hljs-string">'Alice'</span>);
<span class="hljs-keyword">SAVEPOINT</span> sp1;
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> orders <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">1</span>, <span class="hljs-string">'invalid_order'</span>); <span class="hljs-comment">-- 失败</span>
<span class="hljs-keyword">ROLLBACK</span> <span class="hljs-keyword">TO</span> <span class="hljs-keyword">SAVEPOINT</span> sp1; <span class="hljs-comment">-- 回滚到保存点</span>
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> orders <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">1</span>, <span class="hljs-string">'valid_order'</span>); <span class="hljs-comment">-- 成功</span>
<span class="hljs-keyword">COMMIT</span>;
</code></pre>
<h4 data-id="heading-7">Oracle 行为</h4>
<ul>
<li>类似PostgreSQL，错误会导致当前事务状态异常</li>
<li>支持SAVEPOINT机制</li>
<li>可以回滚到特定保存点而不影响整个事务</li>
<li>需要显式的错误处理和保存点管理</li>
</ul>
<h4 data-id="heading-8">关键差异总结</h4>





























<table><thead><tr><th>数据库</th><th>错误后行为</th><th>恢复方式</th><th>灵活性</th></tr></thead><tbody><tr><td>PostgreSQL/GaussDB</td><td>事务aborted，后续命令被忽略</td><td>ROLLBACK或重新开始事务</td><td>低</td></tr><tr><td>MySQL(InnoDB)</td><td>可使用SAVEPOINT部分恢复</td><td>SAVEPOINT + ROLLBACK TO SAVEPOINT</td><td>中等</td></tr><tr><td>Oracle</td><td>可使用SAVEPOINT部分恢复</td><td>SAVEPOINT + ROLLBACK TO SAVEPOINT</td><td>中等</td></tr></tbody></table>
<p>这种差异意味着同样的Java代码在不同数据库上可能表现完全不同，特别是在涉及复杂事务逻辑的应用中。</p>
<h3 data-id="heading-9">4. Java编程推荐实践</h3>
<p>面对PostgreSQL/GaussDB的这种事务行为，我们需要采用不同的策略来处理事务中的错误：</p>
<h4 data-id="heading-10">4.1 使用独立的事务 做不影响主业务的事情</h4>
<p>最直接的解决方案是将错误日志记录放在独立的事务中</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 省略注入</span>
<span class="hljs-meta">@Transactional</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">createUserWithOrder</span><span class="hljs-params">(User user, Order order)</span> {
      userRepository.save(user);
      orderRepository.save(order);

  		<span class="hljs-comment">// 独立子事务、吞吃异常</span>
      logService.busiLog(logvo);
}

<span class="hljs-meta">@Slf4j</span>
<span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">LogService</span> {
    
    <span class="hljs-meta">@Transactional(propagation = Propagation.REQUIRES_NEW)</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">logError</span><span class="hljs-params">(logvo)</span> {
       <span class="hljs-keyword">try</span>{
       	 logRepository.save(logvo);
       } <span class="hljs-keyword">catch</span>(Exception e){
         <span class="hljs-comment">// 只打日志，不抛异常</span>
         log.error(e);
       }
    }
}
</code></pre>
<h4 data-id="heading-11">4.2 如果要不回滚，则要尽量规避db出现中断事务的异常</h4>
<p><strong>对联机操作：</strong></p>
<ul>
<li>插入时使用<code>UPSERT</code>语法或显示前检查</li>
<li>在db操作前，将待入库的vo做合规检查，如字段长度、非空约束等</li>
</ul>
<p><strong>对批量操作：</strong></p>
<ul>
<li>在框架层设计批量回滚机制，如批量回滚后逐笔独立事务重试或逐笔业务设置保存点，出现异常的则登记异常并跳过，后续继续，直到该批次处理完进入下一批。</li>
</ul>
<blockquote>
<p>只要不落库引起事务abort，一切都还在你掌控！</p>
</blockquote>
<h3 data-id="heading-12">5. 总结</h3>
<p>GaussDB作为兼容PostgreSQL协议的分布式数据库，继承了PostgreSQL严格的事务状态管理机制。当事务中的某个操作失败时，整个事务进入"aborted"状态，后续所有SQL操作都会被忽略，直到事务结束。这一特性虽然保证了数据一致性，但也给Java开发者带来了挑战。</p>
<p>本文深入分析了这一问题的本质，对比了主流数据库在事务错误处理方面的差异，并提供了多种Java编程推荐实践：关键在于理解数据库事务状态管理的差异，避免在PostgreSQL/GaussDB环境中使用仅适用于其他数据库的行为假设。通过合理的架构设计和事务管理策略，可以有效避免<code>current transaction is aborted</code>错误，确保应用程序的稳定性和可靠性。</p>
<p>对于使用GaussDB或PostgreSQL的企业级应用，建议开发团队充分了解这一特性，并在系统设计阶段就考虑相应的错误处理策略，以避免在生产环境中遇到意外的事务问题。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[从“人治”到“机治”：得物离线数仓发布流水线质量门禁实践]]></title>    <link>https://juejin.cn/post/7600341731047555107</link>    <guid>https://juejin.cn/post/7600341731047555107</guid>    <pubDate>2026-01-29T06:52:20.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600341731047555107" data-draft-id="7600491179499159606" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="从“人治”到“机治”：得物离线数仓发布流水线质量门禁实践"/> <meta itemprop="keywords" content="大数据"/> <meta itemprop="datePublished" content="2026-01-29T06:52:20.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="得物技术"/> <meta itemprop="url" content="https://juejin.cn/user/2392954206960247"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            从“人治”到“机治”：得物离线数仓发布流水线质量门禁实践
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2392954206960247/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    得物技术
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-29T06:52:20.000Z" title="Thu Jan 29 2026 06:52:20 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#595959;font-size:15px;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(60,10,30,.04) 3%,transparent 0),linear-gradient(1turn,rgba(60,10,30,.04) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body p{color:#595959;font-size:15px;line-height:2;font-weight:400}.markdown-body p+p{margin-top:16px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin:0;color:#135ce0}.markdown-body h1{position:relative;text-align:center;font-size:22px;margin:50px 0}.markdown-body h1:before{position:absolute;content:"";top:-10px;left:50%;width:32px;height:32px;transform:translateX(-50%);background-size:100% 100%;opacity:.36;background-repeat:no-repeat;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC)}.markdown-body h2{position:relative;font-size:20px;border-left:4px solid;padding:0 0 0 10px;margin:30px 0}.markdown-body h3{font-size:16px}.markdown-body ul{list-style:disc outside;margin-left:2em;margin-top:1em}.markdown-body li{line-height:2;color:#595959}.markdown-body img.loaded{margin:0 auto;display:block}.markdown-body blockquote{background:#fff9f9;margin:2em 0;padding:2px 20px;border-left:4px solid #b2aec5}.markdown-body blockquote p{color:#666;line-height:2}.markdown-body a{color:#036aca;border-bottom:1px solid rgba(3,106,202,.8);font-weight:400;text-decoration:none}.markdown-body em strong,.markdown-body strong{color:#036aca}.markdown-body hr{border-top:1px solid #135ce0}.markdown-body pre{overflow:auto}.markdown-body code,.markdown-body pre{overflow:auto;position:relative;line-height:1.75;font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body table{border-collapse:collapse;margin:1rem 0;overflow-x:auto}.markdown-body table td,.markdown-body table th{border:1px solid #dfe2e5;padding:.6em 1em}.markdown-body table tr{border-top:1px solid #dfe2e5}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一、前言</h2>
<p>随着企业数字化转型加速推进，大数据业务规模呈现指数级增长，迭代变更越发频繁。此背景下，呈现"高频变更"与"超大规模"并存的特征，这种双重特性给大数据任务的发布变更带来了严峻挑战。</p>
<h2 data-id="heading-1">二、项目目标</h2>
<p><strong>离线数仓任务资产管理</strong></p>
<p>增量：通过大数据变更发布流水线进行卡点，确保末端任务发布前，消费场景&amp;风险等级完成绑定。增量任务发布消费场景绑定率100%覆盖。</p>
<p>存量：盘点存量资产任务，人工梳理打标，完成初始化消费场景绑定。</p>
<p><strong>大数据变更发布流水线</strong></p>
<p>数仓任务发布流水线管控100%覆盖，任务发布效率提升60%。</p>
<h2 data-id="heading-2">三、项目方案</h2>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/dcbbcbdf03ae4c869a91b4799f8179fd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770274403&amp;x-signature=QZE13mEVp5cv6Tsx6rr6em2WzPM%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<h3 data-id="heading-3">数仓任务资产管理</h3>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5d6954c35f584787b99df00ed967578b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770274403&amp;x-signature=0jv6VAoQYcAFbrplwcLprBM8Bww%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p><strong>消费场景定义</strong></p>
<p>根据业务用途梳理消费端内容，根据风险高低定义风险等级P0、P1、P2，从末节点自动倒推追溯上游全链路，并全部打上风险等级P0、P1、P2标识，以相同的生产规范标准要求上下游各方协同保障。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ba6a1b928c3c4763afc4868e6ea87c0e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770274403&amp;x-signature=c%2BYgadRA44Mj3ohKsnzatoBevSU%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p><strong>风险等级定义</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5eb42fe993c14ff0a996420bd470633f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770274403&amp;x-signature=FKQ%2B9CuEQsB9NkMs20RLfQY7mk4%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p><strong>消费场景注册&amp;绑定</strong></p>
<ul>
<li><strong>消费场景注册</strong></li>
</ul>
<p>当前数仓任务消费场景已经完成初步盘点和梳理，并且将盘点的消费场景数据初始化到平台中。随着迭代场景的新增，需要注册新的场景，从而应业务所需。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a44db55d88a747288596b986ae51adad~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770274403&amp;x-signature=Z6di80hvl2Zqe4JZzlXp2jaaApc%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<ul>
<li><strong>存量资产任务绑定</strong></li>
</ul>
<p>针对当前数仓存量资产任务进行盘点，将adm、ads层表进行梳理、打标，最终初始化到平台中，完成存量资产绑定消费场景。</p>
<ul>
<li><strong>任务消费场景应用</strong></li>
</ul>
<p>任务和消费场景完成绑定后，从而决定任务的应用场景、风险等级，P0、P1任务将在变更管控、线上稳定性保障等得到重保。</p>
<h3 data-id="heading-4">数仓变更管控流水线</h3>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/dd3ec25b6c174764bbefe31ef8f678c9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770274403&amp;x-signature=d%2BQ3NXjO3p3RJAzM6SFQySKci5g%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p><strong>质量定义(DQC)</strong></p>
<p>在离线数据仓库（数仓）中，数据质量检查（DQC，Data Quality Check）是确保数据准确性、一致性、完整性的重要环节。数仓ETL任务在加工完成后，会执行DQC检查，从而有效、及时发现数据质量问题，便于研发人员及时修复，避免问题数据对业务造成损失。</p>
<ul>
<li><strong>DQC强规则</strong></li>
</ul>
<p>当强规则执行不通过后，直接失败任务，及时通知任务Owner，并拦截下游任务执行，待修复后下游链路再继续执行。（拦截任务，需要值班人员及时修复。）</p>
<ul>
<li><strong>DQC弱规则</strong></li>
</ul>
<p>当弱规则执行不通过后，及时通知任务Owner。任务正常执行成功，下游任务也正在运行。（不拦截任务，会通知到任务Owner。）</p>
<p><strong>质量定义配置</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/974a23fb07ba43d98f01b66c0cecb206~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770274403&amp;x-signature=puuYyBdSDog231%2B8%2BeWtjjVbbIY%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<ul>
<li><strong>通用型DQC规则</strong></li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d3512b3f1aab4648b9ba778cdfb4c63e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770274403&amp;x-signature=1UkUpg7fLuZGXTSivlugXMYoAyM%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d98c1542c8154560927cf261bd0ff6e4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770274403&amp;x-signature=uLhY%2F6i5BBrqr4FmeAmcBgUuaNw%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/79a2fa1812f748bcbb90081b3a5a25ef~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770274403&amp;x-signature=vWv8spTY%2F7flnSngyhgL3v8Ni0M%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p>质量定义通过可视化界面操作，让用户可以直接通过简单的勾选方式，即可生成对应的DQC规则，大大提高研发人员配置DQC的效率。</p>
<ul>
<li><strong>自定义DQC规则</strong></li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d810c6bbd9e14324826a623e71239657~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770274403&amp;x-signature=gLG73ppalBoRWLZ8umEQIg9d3BM%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p>用户可以按照规则SQL补充规则逻辑，从而实现自定义验证SQL融入DQC-SQL中，达到自定义DQC规则的效果。</p>
<p><strong>强弱规则配置</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5962e1b7c45242d9bf90bfc4b3c2e965~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770274403&amp;x-signature=XldHabsNTfOMJ6sPXO6znTkJFfw%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p>DQC强规则和弱规则的配置方式完全一致，通过Tab的切换，可以完成强弱规则的配置。</p>
<p><strong>质量DQC试运行</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/63209616aa5c4f23a6585636ea201e16~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770274403&amp;x-signature=VwH6bLAI7qETWL86u9mqJsg1hZY%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p>所有DQC配置完成后，需要通过试运行之后才能保存上线，确保DQC配置的合理性、有效性。</p>
<p><strong>告警策略</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/924be0c0232847fb985fff63432c9d40~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770274403&amp;x-signature=u064XJgH0xNHpZMB15dZK2lysiA%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p>支持飞书、电话、短信、邮箱等方式告警通知。其中强规则一旦触发，必定电话告警（采取15分钟无响应即逐级上升原则）。</p>
<p><strong>发布流水线管控</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ce8d58bbb15b4e5aa6bd4d3963452cc2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770274403&amp;x-signature=qcRcaLfzKFjoU3s1IRryc12MpeE%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b9feb9ce26724d57aa8ca88768e0a6a3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770274403&amp;x-signature=IK4SX69%2FGUyIHEnNW%2B5Q%2FTRsntk%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p><strong>静态扫描</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/32ad381e710944d2b45b515c01af2f0d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770274403&amp;x-signature=zOpY7suZOCLsCUZgMzDyZZcX0TM%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8b192059f63b44e3a4bfc774e33a628b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770274403&amp;x-signature=%2B8iTU3GXC8epX8Vlh%2FPuIKmonmY%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p>检测规则：任务依赖、建表规范、编码规范、集成规范、DQC规范等。</p>
<p><strong>冒烟测试</strong></p>
<p>在数仓测试环境下，完成任务冒烟测试执行，执行内容包含：ETL任务、DQC规则。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6eeb933954cb4c3e83e8255b003d02ff~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770274403&amp;x-signature=8lcZK1qNQ1RISk1MXWUupsqFHPs%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p><strong>CodeReview</strong></p>
<p>描述：根据业务熟悉对，由数据域数仓PM 或者 业务数仓技术负责人进行评审，给出评审结论。</p>
<p>内容：ETL代码、调度配置、质量定义配置、DQC-SQL等。</p>
<p>注意：审批人飞书会接收到来自“xx稳定中心”机器人推送的消息，点击进入审批详情完成审批即可。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b1ecd73992434cb79c77b75eab7164c4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770274403&amp;x-signature=7uX7O1vN6ZbbD7DDZttpIzF%2BAL4%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p><strong>数据探查</strong></p>
<p>描述：针对表内所有字段进行探查和校验，主要场景：数字探查、字符探查、主键验证、无效字段验证、异常字段验证</p>
<p>PS：数字探查和字符探查会给出明显问题红色高亮标识。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/dd1305690b6d44dbb26c20f6057358f7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770274403&amp;x-signature=FrYlzF6QEGxUgVHxHaNfyPvgjGg%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/79697b5c131b432bac3440ceb2ec194e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770274403&amp;x-signature=8o6JPjaV8O9lg%2F0iPBIC5e1Oep0%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p><strong>数据比对</strong></p>
<p>描述：针对生产表和测试表进行数据比对，比对场景：数据量对比、聚合指标对比、明细对比。</p>
<p>注意信息：对比的两张表用户无法输入，用户需要输入执行分区、主键字段、去噪字段、风险阈值（针对明细对比生效）。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1fda58c471ee46108b5e520e644ecf4e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770274403&amp;x-signature=AwYFo9VTNy6Gw3%2BPoC%2F%2FxwV4Hy0%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p><strong>发布审批</strong></p>
<p>描述：发布审批节点，用户输入本次发布的基础信息，提交审批即可。</p>
<p>所有需求都需要数据域PM和对应数据域的责任QA进行审批。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ee84a4e7a23743dcbf98092ab8e909e0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770274403&amp;x-signature=iyZwVJ%2Fl3uvhqnWpTmGfNxQpEQw%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<h2 data-id="heading-5">四、总结&amp;未来规划</h2>
<h3 data-id="heading-6">实践总结</h3>
<p>得物离线数仓发布流水线过去1年有着从0到1的建设，以及后期从1到10的优化和改进。当前流水线能力已经足以支撑数仓内部日常迭代变更需求的发布管控，为发布准出规则执行提供了巨大帮助。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7c5761a470744a7e8d0d9fe86f1c8815~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770274403&amp;x-signature=mDN6ddVP0IZQze8m%2F1EMU3jFu%2Bg%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p>发布管控对于QA来说是最重要的一个环节，所有发布都能够达到准出标准的要求，从而才能守住发布的最后一道线。</p>
<h3 data-id="heading-7">未来规划</h3>
<p><strong>节点能力优化</strong></p>
<p>当前数仓表单分区大于3TB（十亿、百亿、千亿级别）存储数据后，数据探查、数据比对将不提供验证服务，主要源于数据量、存储过大、字段过多，对计算资源、计算存储带来巨大的消耗，严重影响其他任务的执行进度。后续通过数据抽样验证的方式从而降低资源的消耗，从而提升场景覆盖度。</p>
<p><strong>流水线能力补充</strong></p>
<p>数据探查未来考虑通过和历史探查结果比对参考的方式，给出诊断结果，进一步提升工具卡点能力。</p>
<h3 data-id="heading-8">往期回顾</h3>
<p>1.AI编程实践：从Claude Code实践到团队协作的优化思考｜得物技术</p>
<p>2.入选AAAI-PerFM｜得物社区推荐之基于大语言模型的新颖性推荐算法 </p>
<p>3.Galaxy比数平台功能介绍及实现原理｜得物技术</p>
<p>4.得物App智能巡检技术的探索与实践</p>
<p>5.深度实践：得物算法域全景可观测性从 0 到 1 的演进之路</p>
<h3 data-id="heading-9">文 /家森</h3>
<p>关注得物技术，每周更新技术干货</p>
<p>要是觉得文章对你有帮助的话，欢迎评论转发点赞～</p>
<p>未经得物技术许可严禁转载，否则依法追究法律责任。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[miglite: 极简高效的数据库迁移工具]]></title>    <link>https://juejin.cn/post/7600326947506192436</link>    <guid>https://juejin.cn/post/7600326947506192436</guid>    <pubDate>2026-01-29T06:31:49.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600326947506192436" data-draft-id="7600355625474359348" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="miglite: 极简高效的数据库迁移工具"/> <meta itemprop="keywords" content="Go,GitHub"/> <meta itemprop="datePublished" content="2026-01-29T06:31:49.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="inhere"/> <meta itemprop="url" content="https://juejin.cn/user/1099167359829453"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            miglite: 极简高效的数据库迁移工具
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1099167359829453/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    inhere
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-29T06:31:49.000Z" title="Thu Jan 29 2026 06:31:49 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>🚀 miglite: 极简高效的数据库迁移工具！</p>
<blockquote>
<p>如果你厌倦了复杂庞大的数据库迁移工具，渴望一个轻量级、零配置且功能强大的解决方案，那么 miglite 绝对值得一试。它用最纯粹的方式解决数据库 Schema 迁移问题，让开发者回归编码本身。</p>
</blockquote>
<hr/>
<h2 data-id="heading-0">✨ 项目简介</h2>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fgookit%2Fmiglite" target="_blank" title="https://github.com/gookit/miglite" ref="nofollow noopener noreferrer">miglite</a> 是一个用 Golang 实现的<strong>极简数据库 Schema 迁移工具</strong>，它秉持"做一件事并做好"的设计哲学，提供了核心迁移功能的同时，保持了极致的轻量和易用性。</p>
<h3 data-id="heading-1">🎯 核心特性</h3>



































<table><thead><tr><th align="left">特性</th><th align="left">描述</th><th align="left">优势</th></tr></thead><tbody><tr><td align="left"><strong>🪶 极简依赖</strong></td><td align="left">基于 <code>database/sql</code> 接口开发，默认<strong>不添加</strong>任何驱动依赖包</td><td align="left">保持项目轻量，避免依赖冲突</td></tr><tr><td align="left"><strong>📝 原生 SQL</strong></td><td align="left">使用原始 SQL 文件作为迁移方式，无特定 DSL 学习成本</td><td align="left">直接利用现有 SQL 技能，迁移逻辑透明可控</td></tr><tr><td align="left"><strong>🔒 事务保障</strong></td><td align="left">所有迁移操作均在事务中执行，确保数据一致性</td><td align="left">出现问题可自动回滚，避免数据库处于不一致状态</td></tr><tr><td align="left"><strong>🔧 零配置支持</strong></td><td align="left">支持通过环境变量直接运行，自动加载 <code>.env</code> 和默认配置文件</td><td align="left">快速启动，减少配置烦恼</td></tr><tr><td align="left"><strong>🗄️ 多数据库支持</strong></td><td align="left">支持 MySQL、SQLite、PostgreSQL 等主流数据库</td><td align="left">一套工具，多个项目复用</td></tr></tbody></table>
<h2 data-id="heading-2">🛠️ 快速开始</h2>
<h3 data-id="heading-3">安装方式</h3>
<h4 data-id="heading-4">作为命令行工具使用</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 通过 go 安装</span>
go install github.com/gookit/miglite/cmd/miglite@latest
</code></pre>
<h4 data-id="heading-5">作为 Go 库集成</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 添加依赖</span>
go get github.com/gookit/miglite

<span class="hljs-comment"># 导入使用</span>
import <span class="hljs-string">"github.com/gookit/miglite"</span>
</code></pre>
<h3 data-id="heading-6">基本使用流程</h3>
<pre><code class="hljs language-mermaid" lang="mermaid">flowchart LR
    A[安装 miglite] --&gt; B[配置数据库连接]
    B --&gt; C[创建迁移文件]
    C --&gt; D[编写 UP/DOWN SQL]
    D --&gt; E[执行迁移]
    E --&gt; F[查看状态]
    
    style A fill:#e3f2fd,stroke:#2196f3,color:#0d47a1
    style B fill:#bbdefb,stroke:#2196f3,color:#0d47a1
    style C fill:#90caf9,stroke:#2196f3,color:#ffffff
    style D fill:#64b5f6,stroke:#2196f3,color:#ffffff
    style E fill:#42a5f5,stroke:#2196f3,color:#ffffff
    style F fill:#2196f3,stroke:#2196f3,color:#ffffff
</code></pre>
<h2 data-id="heading-7">💻 实战演示</h2>
<h3 data-id="heading-8">1️⃣ 配置数据库连接</h3>
<p>miglite 提供了<strong>多种配置方式</strong>，从零配置到完整配置文件任你选择。</p>
<details>
<summary><strong>🔧 配置方式一：使用 miglite.yaml 文件（推荐）</strong></summary>
<p>创建项目根目录下创建 <code>miglite.yaml</code>：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">database:</span>
  <span class="hljs-attr">driver:</span> <span class="hljs-string">sqlite</span>  <span class="hljs-comment"># 支持 mysql, postgresql, sqlite</span>
  <span class="hljs-attr">dsn:</span> <span class="hljs-string">./miglite.db</span>  <span class="hljs-comment"># 数据库连接字符串或文件路径</span>
<span class="hljs-attr">migrations:</span>
  <span class="hljs-attr">path:</span> <span class="hljs-string">./migrations</span>  <span class="hljs-comment"># 迁移文件存放目录</span>
</code></pre>
</details>
<details>
<summary><strong>🔧 配置方式二：完全使用环境变量（零配置）</strong></summary>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 设置迁移文件路径</span>
<span class="hljs-built_in">export</span> MIGRATIONS_PATH=<span class="hljs-string">"./migrations"</span>

<span class="hljs-comment"># SQLite 示例</span>
<span class="hljs-built_in">export</span> DATABASE_URL=<span class="hljs-string">"sqlite://path/to/your.db"</span>

<span class="hljs-comment"># MySQL 示例</span>
<span class="hljs-built_in">export</span> DATABASE_URL=<span class="hljs-string">"mysql://user:passwd@tcp(127.0.0.1:3306)/local_test?charset=utf8mb4&amp;parseTime=True&amp;loc=Local"</span>

<span class="hljs-comment"># PostgreSQL 示例</span>
<span class="hljs-built_in">export</span> DATABASE_URL=<span class="hljs-string">"postgres://host=localhost port=5432 user=username password=password dbname=dbname sslmode=disable"</span>
</code></pre>
<blockquote>
<p>⚠️ <strong>注意</strong>：MySQL 连接 URL 必须带上 <code>tcp</code> 协议标记，如 <code>tcp(127.0.0.1:3306)</code>。</p>
</blockquote>
</details>
<h3 data-id="heading-9">2️⃣ 创建迁移文件</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 创建一个新的迁移文件</span>
miglite create add-users-table
</code></pre>
<p>这将在 <code>./migrations/</code> 目录下创建一个格式为 <code>YYYYMMDD-HHMMSS-{migration-name}.sql</code> 的文件，例如：</p>
<pre><code class="hljs language-bash" lang="bash">./migrations/20251105-102325-add-users-table.sql
</code></pre>
<h3 data-id="heading-10">3️⃣ 编写迁移 SQL</h3>
<p>迁移文件使用简单的注释标记来区分 <code>UP</code>（应用）和 <code>DOWN</code>（回滚）操作：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- Migrate:UP</span>
<span class="hljs-comment">-- 在这里添加迁移 SQL（创建表、添加字段等）</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> users (
    id <span class="hljs-type">INT</span> <span class="hljs-keyword">PRIMARY</span> KEY AUTO_INCREMENT,
    username <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">255</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,
    email <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">255</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">UNIQUE</span>,
    created_at <span class="hljs-type">TIMESTAMP</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-built_in">CURRENT_TIMESTAMP</span>
);

<span class="hljs-comment">-- Migrate:DOWN</span>
<span class="hljs-comment">-- 在这里添加回滚 SQL（删除表、移除字段等）</span>
<span class="hljs-keyword">DROP</span> <span class="hljs-keyword">TABLE</span> IF <span class="hljs-keyword">EXISTS</span> users;
</code></pre>
<details>
<summary><strong>📋 更复杂的迁移示例（包含索引和初始数据）</strong></summary>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- Migrate:UP</span>
<span class="hljs-comment">-- 创建文章表</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> posts (
    id <span class="hljs-type">INT</span> <span class="hljs-keyword">PRIMARY</span> KEY AUTO_INCREMENT,
    title <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">255</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,
    content TEXT,
    user_id <span class="hljs-type">INT</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,
    created_at <span class="hljs-type">TIMESTAMP</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-built_in">CURRENT_TIMESTAMP</span>,
    <span class="hljs-keyword">FOREIGN</span> KEY (user_id) <span class="hljs-keyword">REFERENCES</span> users(id) <span class="hljs-keyword">ON</span> <span class="hljs-keyword">DELETE</span> CASCADE
);

<span class="hljs-comment">-- 创建索引</span>
<span class="hljs-keyword">CREATE</span> INDEX idx_posts_user_id <span class="hljs-keyword">ON</span> posts(user_id);
<span class="hljs-keyword">CREATE</span> INDEX idx_posts_created_at <span class="hljs-keyword">ON</span> posts(created_at);

<span class="hljs-comment">-- 插入初始数据</span>
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> posts (title, content, user_id) <span class="hljs-keyword">VALUES</span> 
    (<span class="hljs-string">'Welcome to miglite'</span>, <span class="hljs-string">'This is a sample post.'</span>, <span class="hljs-number">1</span>),
    (<span class="hljs-string">'Getting Started'</span>, <span class="hljs-string">'Learn how to use miglite effectively.'</span>, <span class="hljs-number">1</span>);

<span class="hljs-comment">-- Migrate:DOWN</span>
<span class="hljs-comment">-- 回滚操作（按相反顺序执行）</span>
<span class="hljs-keyword">DROP</span> INDEX IF <span class="hljs-keyword">EXISTS</span> idx_posts_created_at;
<span class="hljs-keyword">DROP</span> INDEX IF <span class="hljs-keyword">EXISTS</span> idx_posts_user_id;
<span class="hljs-keyword">DROP</span> <span class="hljs-keyword">TABLE</span> IF <span class="hljs-keyword">EXISTS</span> posts;
</code></pre>
</details>
<h3 data-id="heading-11">4️⃣ 执行迁移</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 初始化迁移表（首次使用必须执行）</span>
miglite init

<span class="hljs-comment"># 应用所有待处理的迁移</span>
miglite up

<span class="hljs-comment"># 无需确认，立即执行所有迁移</span>
miglite up --<span class="hljs-built_in">yes</span>

<span class="hljs-comment"># 回滚最近的迁移</span>
miglite down

<span class="hljs-comment"># 回滚多个迁移（例如回滚最近3个）</span>
miglite down --number 3

<span class="hljs-comment"># 查看迁移状态</span>
miglite status
</code></pre>
<h2 data-id="heading-12">🧩 作为库使用集成</h2>
<p><code>miglite</code> 的强大之处在于它不仅可以作为 CLI 工具使用，还可以 <strong>无缝集成到你的 Go 项目中</strong>。</p>
<blockquote>
<p><code>github.com/gookit/miglite</code> 不依赖任何三方数据库驱动包，使用你项目中引入的数据库驱动</p>
</blockquote>
<pre><code class="hljs language-go" lang="go"><span class="hljs-keyword">package</span> main

<span class="hljs-keyword">import</span> (
    <span class="hljs-string">"github.com/gookit/miglite"</span>
    _ <span class="hljs-string">"github.com/go-sql-driver/mysql"</span> <span class="hljs-comment">// 导入数据库驱动</span>
    <span class="hljs-string">"log"</span>
)

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    <span class="hljs-comment">// 创建 miglite 实例 - 配置文件可以不存在，会自动读取相关ENV变量使用</span>
    m := miglite.New(<span class="hljs-string">"miglite.yaml"</span>)
    
    <span class="hljs-comment">// 初始化迁移表</span>
    <span class="hljs-keyword">if</span> err := m.Init(); err != <span class="hljs-literal">nil</span> {
        log.Fatal(err)
    }

    <span class="hljs-comment">// 应用迁移</span>
    <span class="hljs-keyword">if</span> err := m.Up(); err != <span class="hljs-literal">nil</span> {
        log.Fatal(err)
    }

    <span class="hljs-comment">// 查看迁移状态</span>
    status, err := m.Status()
    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
        log.Fatal(err)
    }
    log.Printf(<span class="hljs-string">"Migration status: %+v"</span>, status)
}
</code></pre>
<h3 data-id="heading-13">🎨 自定义命令行工具</h3>
<p>你还可以基于 miglite 库构建 <strong>自定义的迁移命令行工具</strong> (这是默认自带的功能)，只包含你需要的数据库驱动：</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-keyword">package</span> main

<span class="hljs-keyword">import</span> (
    <span class="hljs-string">"github.com/gookit/miglite"</span>
    <span class="hljs-string">"github.com/gookit/miglite/pkg/command"</span>
    _ <span class="hljs-string">"github.com/go-sql-driver/mysql"</span> <span class="hljs-comment">// 只导入需要的驱动</span>
    <span class="hljs-comment">// _ "github.com/lib/pq"           // PostgreSQL 驱动（可选）</span>
    <span class="hljs-comment">// _ "modernc.org/sqlite"          // SQLite 驱动（可选）</span>
)

<span class="hljs-keyword">var</span> Version = <span class="hljs-string">"0.1.0"</span>

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    <span class="hljs-comment">// 创建 CLI 应用</span>
    app := command.NewApp(<span class="hljs-string">"my-migrator"</span>, Version, <span class="hljs-string">"Custom migration tool"</span>)
    
    <span class="hljs-comment">// 运行应用</span>
    app.Run()
}
</code></pre>
<h2 data-id="heading-14">🔥 高级特性与技巧</h2>
<details>
<summary><strong>🧪 支持的数据库驱动选择</strong></summary>






























<table><thead><tr><th align="left">数据库</th><th align="left">推荐驱动</th><th align="left">特点</th></tr></thead><tbody><tr><td align="left"><strong>MySQL</strong></td><td align="left"><code>github.com/go-sql-driver/mysql</code></td><td align="left">纯 Go 实现，广泛使用</td></tr><tr><td align="left"><strong>PostgreSQL</strong></td><td align="left"><code>github.com/lib/pq</code> 或 <code>github.com/jackc/pgx/v5</code></td><td align="left">pgx 性能更好，lib/pq 更兼容</td></tr><tr><td align="left"><strong>SQLite</strong></td><td align="left"><code>modernc.org/sqlite</code></td><td align="left">CGO-free，跨平台友好</td></tr><tr><td align="left"><strong>MSSQL</strong></td><td align="left"><code>github.com/microsoft/go-mssqldb</code></td><td align="left">官方驱动，功能完整</td></tr></tbody></table>
<blockquote>
<p>💡 <strong>提示</strong>：作为库使用时，你需要<strong>自己导入所需的数据库驱动</strong>。</p>
</blockquote>
</details>
<details>
<summary><strong>🔧 环境变量自动加载</strong></summary>
<p>miglite 会自动尝试加载项目目录下的 <code>.env</code> 文件，支持以下环境变量：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 数据库连接 URL</span>
DATABASE_URL=<span class="hljs-string">"sqlite://./myapp.db"</span>

<span class="hljs-comment"># 迁移文件目录</span>
MIGRATIONS_PATH=<span class="hljs-string">"./db/migrations"</span>

<span class="hljs-comment"># 其他配置...</span>
</code></pre>
</details>
<details>
<summary><strong>📊 迁移状态查看</strong></summary>
<p>使用 <code>miglite status</code> 命令可以查看详细的迁移状态，包括：</p>
<pre><code class="hljs language-bash" lang="bash">$ miglite status

Migration Status:
================
+----------------+---------+---------------------+
| Migration      | Status  | Applied At          |
+----------------+---------+---------------------+
| 20251105-102325 | UP      | 2025-11-05 10:25:30 |
| 20251106-091500 | UP      | 2025-11-06 09:20:15 |
| 20251107-143000 | DOWN    | 2025-11-07 14:35:00 |
+----------------+---------+---------------------+
</code></pre>
</details>
<h2 data-id="heading-15">🌟 为什么选择 miglite？</h2>
<p>与其他迁移工具相比，miglite 提供了独特的价值：</p>






















































<table><thead><tr><th align="left">特性</th><th align="left">miglite</th><th align="left">golang-migrate</th><th align="left">goose</th><th align="left">dbmate</th></tr></thead><tbody><tr><td align="left"><strong>依赖复杂度</strong></td><td align="left">极简</td><td align="left">中等</td><td align="left">中等</td><td align="left">简单</td></tr><tr><td align="left"><strong>配置方式</strong></td><td align="left">零配置/文件配置</td><td align="left">文件配置</td><td align="left">文件配置</td><td align="left">环境变量</td></tr><tr><td align="left"><strong>迁移方式</strong></td><td align="left">原生 SQL</td><td align="left">多种支持</td><td align="left">原生 SQL/Go</td><td align="left">原生 SQL</td></tr><tr><td align="left"><strong>事务支持</strong></td><td align="left">✅ 是</td><td align="left">✅ 是</td><td align="left">✅ 是</td><td align="left">✅ 是</td></tr><tr><td align="left"><strong>学习曲线</strong></td><td align="left">平缓</td><td align="left">陡峭</td><td align="left">平缓</td><td align="left">平缓</td></tr><tr><td align="left"><strong>库集成</strong></td><td align="left">✅ 优秀</td><td align="left">✅ 优秀</td><td align="left">✅ 一般</td><td align="left">❌ 否</td></tr></tbody></table>
<blockquote>
<p>💡 <strong>核心优势</strong>：miglite 在<strong>保持功能完整的同时</strong>，实现了<strong>极致的简洁性和易用性</strong>，非常适合追求开发效率和代码质量的团队。</p>
</blockquote>
<h2 data-id="heading-16">🎓 使用场景</h2>
<ol>
<li><strong>个人项目</strong>：快速搭建项目原型，无需学习复杂配置</li>
<li><strong>团队项目</strong>：统一迁移规范，通过原生 SQL 保持迁移逻辑透明</li>
<li><strong>CI/CD 集成</strong>：零配置特性使其极易集成到自动化流程中</li>
</ol>
<h2 data-id="heading-17">🤝 贡献与反馈</h2>
<p>miglite 是一个开源项目，我们欢迎任何形式的贡献：</p>
<ul>
<li>🐛 报告 Bug</li>
<li>💡 提出新特性建议</li>
<li>📝 改进文档</li>
<li>🔧 提交代码修复</li>
</ul>
<p>请访问 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fgookit%2Fmiglite" target="_blank" title="https://github.com/gookit/miglite" ref="nofollow noopener noreferrer">GitHub 项目主页</a> 获取更多信息或参与贡献。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[wireguard + iptables + dnsmasq实现异地组网, 端口转发, 自定义域名访问]]></title>    <link>https://juejin.cn/post/7600344784945692718</link>    <guid>https://juejin.cn/post/7600344784945692718</guid>    <pubDate>2026-01-29T06:53:43.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600344784945692718" data-draft-id="7600414546188697610" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="wireguard + iptables + dnsmasq实现异地组网, 端口转发, 自定义域名访问"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2026-01-29T06:53:43.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="kira9924"/> <meta itemprop="url" content="https://juejin.cn/user/274223726860586"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            wireguard + iptables + dnsmasq实现异地组网, 端口转发, 自定义域名访问
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/274223726860586/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    kira9924
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-29T06:53:43.000Z" title="Thu Jan 29 2026 06:53:43 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">💰 前言：为什么选择这个方案？</h2>
<p>随着远程办公和跨地协作成为常态，我一直在寻找一个<strong>稳定、轻量且安全</strong>的异地网络互联方案。经过对比多种方案后，我选择了 <strong>WireGuard + iptables + dnsmasq</strong> 这套组合，并已<strong>稳定运行一年</strong>。</p>
<p>我的核心需求包括：</p>
<ul>
<li>✅ <strong>异地组网</strong>：公司电脑、家里NAS、手机随时互通</li>
<li>✅ <strong>端口映射</strong>：把内网服务暴露到公网（像frp一样）</li>
<li>✅ <strong>好记的域名</strong>：不想再记 <code>10.0.8.xx</code> 这种IP</li>
</ul>
<p>市面上方案很多，但要么重（OpenVPN），要么麻烦（frp+ddns）。<br/>
最后用 <strong>WireGuard + iptables + dnsmasq</strong> 三件套搞定，<strong>稳定运行一年</strong>，分享给大家。</p>
<hr/>
<h3 data-id="heading-1">🎯 本教程可实现：</h3>

























<table><thead><tr><th>功能</th><th>说明</th><th>体验</th></tr></thead><tbody><tr><td><strong>异地组网</strong></td><td>P2P直连，失败自动中继</td><td>延迟10-60ms，远程桌面流畅</td></tr><tr><td><strong>端口映射</strong></td><td>iptables转发，无需额外工具</td><td>可转发全端口，服务器占用&lt;10%</td></tr><tr><td><strong>内网DNS</strong></td><td>自定义域名访问内网设备</td><td><code>my.pc.home</code> 直接访问</td></tr></tbody></table>
<blockquote>
<p>📌 <strong>适合人群</strong>：有云服务器、需要远程访问内网服务、喜欢自建解决方案的玩家。</p>
</blockquote>
<hr/>
<h2 data-id="heading-2">🚀 快速开始</h2>
<p>如果你不想看长篇教程，可以直接使用一键脚本：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 下载脚本</span>
wget https://raw.githubusercontent.com/kira9924/wireguard-setup/refs/heads/main/wg_v2.sh
<span class="hljs-built_in">chmod</span> +x wg.sh

<span class="hljs-comment"># 交互式菜单</span>
./wg.sh
脚本支持：自动初始化配置、生成客户端、端口转发管理、SSH安全加固等。
点击查看完整脚本源码

⚠️ 注意：脚本会修改SSH配置，建议先通读文档再使用！
</code></pre>
<h2 data-id="heading-3">📦 基础部署：WireGuard异地组网</h2>
<h3 data-id="heading-4">1. 安装依赖（Ubuntu）</h3>
<pre><code class="hljs language-bash" lang="bash">apt update
apt install -y wireguard iptables lsof
</code></pre>
<h3 data-id="heading-5">2. 生成密钥对</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 服务端密钥</span>
wg genkey | <span class="hljs-built_in">tee</span> /etc/wireguard/server_private.key | wg pubkey &gt; /etc/wireguard/server_public.key

<span class="hljs-comment"># 客户端密钥（示例）</span>
wg genkey | <span class="hljs-built_in">tee</span> /etc/wireguard/client_private.key | wg pubkey &gt; /etc/wireguard/client_public.key
</code></pre>
<h3 data-id="heading-6">3. 服务端配置（/etc/wireguard/wg0.conf）</h3>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-section">[Interface]</span>
<span class="hljs-attr">PrivateKey</span> = &lt;server_private_key&gt;
<span class="hljs-attr">Address</span> = <span class="hljs-number">10.0</span>.<span class="hljs-number">8.1</span>/<span class="hljs-number">24</span>
<span class="hljs-attr">ListenPort</span> = <span class="hljs-number">50814</span>
<span class="hljs-attr">DNS</span> = <span class="hljs-number">10.0</span>.<span class="hljs-number">8.1</span>
<span class="hljs-attr">MTU</span> = <span class="hljs-number">1420</span>
<span class="hljs-attr">PostUp</span> = /etc/wireguard/iptable-up.sh
<span class="hljs-attr">PostDown</span> = /etc/wireguard/iptable-down.sh

<span class="hljs-section">[Peer]</span>
<span class="hljs-comment"># 客户端1</span>
<span class="hljs-attr">PublicKey</span> = &lt;client1_public_key&gt;
<span class="hljs-attr">AllowedIPs</span> = <span class="hljs-number">10.0</span>.<span class="hljs-number">8.10</span>/<span class="hljs-number">32</span>
<span class="hljs-attr">PersistentKeepalive</span> = <span class="hljs-number">25</span>

<span class="hljs-section">[Peer]</span>
<span class="hljs-comment"># 客户端2</span>
<span class="hljs-attr">PublicKey</span> = &lt;client2_public_key&gt;
<span class="hljs-attr">AllowedIPs</span> = <span class="hljs-number">10.0</span>.<span class="hljs-number">8.11</span>/<span class="hljs-number">32</span>
<span class="hljs-attr">PersistentKeepalive</span> = <span class="hljs-number">25</span>
💡 提示：PersistentKeepalive 是P2P连接的关键，保持25秒心跳可穿透大部分NAT。
</code></pre>
<h3 data-id="heading-7">4. 配置iptables转发脚本</h3>
<p>创建 /etc/wireguard/iptable-up.sh 和 iptable-down.sh，内容见 iptables配置。</p>
<h3 data-id="heading-8">5. 客户端配置</h3>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-section">[Interface]</span>
<span class="hljs-attr">PrivateKey</span> = &lt;client_private_key&gt;
<span class="hljs-attr">Address</span> = <span class="hljs-number">10.0</span>.<span class="hljs-number">8.10</span>/<span class="hljs-number">32</span>
<span class="hljs-attr">MTU</span> = <span class="hljs-number">1420</span>
<span class="hljs-attr">DNS</span> = <span class="hljs-number">10.0</span>.<span class="hljs-number">8.1</span>, <span class="hljs-number">8.8</span>.<span class="hljs-number">8.8</span>

<span class="hljs-section">[Peer]</span>
<span class="hljs-attr">PublicKey</span> = &lt;server_public_key&gt;
<span class="hljs-attr">Endpoint</span> = 你的公网IP:<span class="hljs-number">50814</span>
<span class="hljs-attr">AllowedIPs</span> = <span class="hljs-number">10.0</span>.<span class="hljs-number">8.0</span>/<span class="hljs-number">24</span>
<span class="hljs-attr">PersistentKeepalive</span> = <span class="hljs-number">25</span>
</code></pre>
<h3 data-id="heading-9">6. 启动与测试</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 启动服务端</span>
wg-quick up wg0

<span class="hljs-comment"># 查看状态</span>
wg show

<span class="hljs-comment"># 测试连通性（从客户端）</span>
ping 10.0.8.1
</code></pre>
<h2 data-id="heading-10">🌉 进阶功能1：内网端口映射</h2>
<p>既然设备已经组网，就可以通过iptables将内网端口暴露到公网。</p>
<ul>
<li>为什么需要端口映射？</li>
<li>将家里的NAS网页界面暴露到公网</li>
<li>远程桌面访问公司电脑</li>
<li>搭建自己的网站/服务</li>
</ul>
<h3 data-id="heading-11">单端口转发示例</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 将公网8080端口转发到10.0.8.10:8080</span>
iptables -t nat -A WG-FORWARD-NAT -p tcp --dport 8080 -j DNAT --to 10.0.8.10:8080
iptables -t nat -A POSTROUTING -p tcp -d 10.0.8.10 --dport 8080 -j SNAT --to 10.0.8.1
iptables -A WG-FORWARD-FW -p tcp -d 10.0.8.10 --dport 8080 -j ACCEPT
</code></pre>
<h3 data-id="heading-12">批量端口转发</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 生成规则文件（示例：10000-10010端口）</span>
*nat
-A WG-FORWARD-NAT -p tcp --dport 10000 -j DNAT --to 10.0.8.10:10000
-A POSTROUTING -p tcp -d 10.0.8.10 --dport 10000 -j SNAT --to 10.0.8.1
COMMIT
*filter
-A WG-FORWARD-FW -p tcp -d 10.0.8.10 --dport 10000 -j ACCEPT
COMMIT
<span class="hljs-comment"># 导入规则</span>
iptables-restore --noflush &lt; rules.txt
</code></pre>
<blockquote>
<p>⚠️ 重要提醒：</p>
<ol>
<li>需要在云服务器控制台防火墙/安全组中放行对应端口</li>
<li>全端口转发存在安全风险，建议仅开放必要端口</li>
<li>可以使用脚本的批量转发功能，支持随机端口、范围端口等</li>
</ol>
</blockquote>
<h2 data-id="heading-13">🔗 进阶功能2：内网自定义DNS</h2>
<p>记住 <code>10.0.8.10</code> 这种IP太反人类，我们需要好记的域名。</p>
<h3 data-id="heading-14">为什么需要自建DNS？</h3>
<ul>
<li><code>my.pc.home</code> 比 <code>10.0.8.10</code> 好记</li>
<li>设备多了不用记IP表</li>
<li>浏览器直接输入域名访问</li>
</ul>
<h3 data-id="heading-15">安装配置dnsmasq</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 停止系统自带的DNS服务</span>
sudo systemctl stop systemd-resolved
sudo systemctl <span class="hljs-built_in">disable</span> systemd-resolved

<span class="hljs-comment"># 安装dnsmasq</span>
sudo apt install dnsmasq -y
</code></pre>
<h3 data-id="heading-16">配置dnsmasq</h3>
<p>编辑 /etc/dnsmasq.conf：</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># 仅监听WG网络</span>
<span class="hljs-attr">interface</span>=wg0
<span class="hljs-attr">listen-address</span>=<span class="hljs-number">10.0</span>.<span class="hljs-number">8.1</span>
bind-interfaces

<span class="hljs-comment"># 自定义域名文件</span>
<span class="hljs-attr">addn-hosts</span>=/etc/dnsmasq.hosts

<span class="hljs-comment"># 外网DNS兜底</span>
<span class="hljs-attr">server</span>=<span class="hljs-number">8.8</span>.<span class="hljs-number">8.8</span>
<span class="hljs-attr">server</span>=<span class="hljs-number">114.114</span>.<span class="hljs-number">114.114</span>

<span class="hljs-comment"># 性能优化</span>
<span class="hljs-attr">cache-size</span>=<span class="hljs-number">1000</span>
no-resolv
no-poll
</code></pre>
<p>###添加自定义域名
编辑 /etc/dnsmasq.hosts：</p>
<pre><code class="hljs language-ini" lang="ini">10.0.8.10 my.desktop.home
10.0.8.11 my.thinkpad.home
10.0.8.20 my.nas.home
</code></pre>
<h3 data-id="heading-17">验证DNS解析</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 服务端测试</span>
nslookup my.desktop.home 10.0.8.1

<span class="hljs-comment"># 客户端测试（需配置DNS为10.0.8.1）</span>
nslookup my.desktop.home
🚀 技巧：你可以用 home 作为顶级域名，完全自己掌控，比如 nas.home、router.home 等。
</code></pre>
<h3 data-id="heading-18">⚙️ 一键管理脚本（wg.sh）详解</h3>
<p>手动操作太繁琐？我写了这个全功能管理脚本。</p>
<h4 data-id="heading-19">脚本功能概览</h4>





























<table><thead><tr><th>功能模块</th><th>说明</th></tr></thead><tbody><tr><td>WG管理</td><td>启动/停止/重启/状态查看</td></tr><tr><td>客户端生成</td><td>一键生成多个客户端配置</td></tr><tr><td>端口转发</td><td>单端口、范围端口、随机端口转发</td></tr><tr><td>SSH安全</td><td>限制SSH仅WG网络可访问</td></tr><tr><td>网络配置</td><td>自定义IP段、子网等</td></tr></tbody></table>
<h4 data-id="heading-20">使用方法</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 1. 交互式菜单（推荐新手）</span>
./wg.sh

<span class="hljs-comment"># 2. 命令行快速操作</span>
./wg.sh start          <span class="hljs-comment"># 启动WG</span>
./wg.sh client         <span class="hljs-comment"># 生成客户端配置</span>
./wg.sh forward        <span class="hljs-comment"># 端口转发管理</span>
./wg.sh config-ssh     <span class="hljs-comment"># 加固SSH（仅WG网络可访问）</span>
脚本界面预览
text
==================== WireGuard 全功能管理脚本 ====================
1. 启动 WG
2. 停止 WG
3. 重启 WG
4. 查看 WG/SSH/转发 状态
5. 端口转发管理
6. 生成客户端配置
7. 初始化/重置WireGuard配置
8. 批量添加客户端到服务器
9. 配置 SSH 仅监听 WG IP
10. 恢复 SSH 公网访问
11. 配置网络参数
12. 退出
===============================================================
请选择操作 [1-12]:
点击查看完整脚本源码
</code></pre>
<h3 data-id="heading-21">❓ 常见问题与解决方案</h3>
<ol>
<li>
<p>SSH被频繁扫描怎么办？</p>
<p><strong>问题</strong>：云服务器22端口被爆破，日志满是失败尝试。</p>
<p><strong>解决</strong>：使用脚本的 <code>配置 SSH 仅监听 WG IP</code> 功能，让SSH只监听WG内网IP（如 10.0.8.1:22）。
这样只有连接了WG的客户端才能SSH登录，公网无法访问。</p>
</li>
<li>
<p>跨运营商P2P不通？
问题：电信-移动之间直连失败。
解决：这是NAT穿透的硬伤，两种方案：</p>
</li>
</ol>
<ul>
<li>开启 PersistentKeepalive = 25（已配置）</li>
<li>接受走服务器中继（延迟40-60ms，依然可用）</li>
</ul>
<ol start="3">
<li>客户端连不上？
排查步骤：</li>
</ol>
<ul>
<li>检查服务端 wg show 命令是否有客户端握手</li>
<li>确认云服务器防火墙开放了 50814 端口（UDP）</li>
<li>检查客户端配置的Endpoint是否正确</li>
</ul>
<ol start="4">
<li>
<p>端口转发不生效？
可能原因：
云服务商安全组未放行
iptables规则未正确添加
目标服务未监听或防火墙阻挡</p>
</li>
<li>
<p>DNS解析失败？
检查项：</p>
</li>
</ol>
<ul>
<li>客户端DNS是否配置为 10.0.8.1</li>
<li>dnsmasq是否正常运行 systemctl status dnsmasq</li>
<li>域名是否添加到了 /etc/dnsmasq.hosts</li>
</ul>
<h3 data-id="heading-22">📊 性能实测数据</h3>





























<table><thead><tr><th>场景</th><th>延迟</th><th>带宽</th><th>体验</th></tr></thead><tbody><tr><td>同运营商P2P</td><td>8-15ms</td><td>打满家用上行</td><td>远程桌面无感</td></tr><tr><td>跨运营商中继</td><td>40-60ms</td><td>打满家用上行</td><td>轻度游戏可玩</td></tr><tr><td>文件传输</td><td>-</td><td>7MB/s</td><td>家用宽带基本跑满</td></tr></tbody></table>
<h3 data-id="heading-23">📌 我的使用场景：</h3>
<ul>
<li>ssh远程公司连公司电脑Docker开发环境, 体验接近本地</li>
<li>远程桌面家里台式机, 午休Mac也可以开一把炉石</li>
<li>搭建文件服务器映射到公网, 朋友零配置使用, 速度跑满宽带上传速度</li>
<li>访问家里Nas看电影, 流畅2k</li>
</ul>
<h3 data-id="heading-24">💬 最后的话</h3>
<p>这套方案我已经稳定使用一年多，从最初的简单组网，慢慢加入了端口映射、自定义DNS，最后写成了管理脚本。</p>
<p>它的优势在于：</p>
<p>✅ 轻量：WireGuard内核模块，资源占用极低</p>
<p>✅ 灵活：可按需配置流量路由</p>
<p>✅ 功能完整：组网、映射、DNS一站式解决</p>
<p>如果你在部署中遇到问题，欢迎在评论区留言。
如果觉得有用，可以收藏本文，或分享给有同样需求的朋友。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[React 组件缓存实战指南：从手写 KeepAlive 到 react-activation 深度应用]]></title>    <link>https://juejin.cn/post/7600318091832000539</link>    <guid>https://juejin.cn/post/7600318091832000539</guid>    <pubDate>2026-01-29T05:54:47.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600318091832000539" data-draft-id="7600260767688359962" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="React 组件缓存实战指南：从手写 KeepAlive 到 react-activation 深度应用"/> <meta itemprop="keywords" content="React.js,性能优化,前端"/> <meta itemprop="datePublished" content="2026-01-29T05:54:47.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="xhxxx"/> <meta itemprop="url" content="https://juejin.cn/user/3235201610941578"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            React 组件缓存实战指南：从手写 KeepAlive 到 react-activation 深度应用
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3235201610941578/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    xhxxx
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-29T05:54:47.000Z" title="Thu Jan 29 2026 05:54:47 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">React 组件缓存指南：从手写 KeepAlive 到实战应用</h2>
<p>在现代前端开发中，尤其是移动端 H5 或混合 App 场景下，<strong>组件状态缓存</strong>几乎是一个“刚需”。试想这样一个常见流程：用户在商品列表页滑动到第 20 行，点击某商品进入详情页，返回时却发现列表回到了顶部，筛选条件重置，加载状态清零——这种体验不仅打断用户心智，甚至可能直接导致流失。</p>
<p>Vue 框架通过内置的 <code>&lt;keep-alive&gt;</code> 组件优雅地解决了这一问题，但 <strong>React 官方并未提供等效的原生能力</strong>。开发者要么接受“切换即销毁”的默认行为，要么自行实现缓存逻辑，要么引入第三方方案。</p>
<p>那么，在 React 中，我们该如何实现类似 <code>&lt;keep-alive&gt;</code> 的功能？</p>
<ul>
<li>是自己动手造轮子，深入理解缓存机制的本质？</li>
<li>还是直接采用成熟库，在生产环境中稳定落地？</li>
</ul>
<p>本文将分两部分为你系统解答：</p>
<ol>
<li><strong>原理篇</strong>：从零手写一个简易 <code>KeepAlive</code> 组件，揭示“缓存不销毁”的核心思想；</li>
<li><strong>实战篇</strong>：使用业界广泛采用的 <code>react-activation</code> 库，解决真实项目中的路由缓存、滚动位置恢复等复杂场景，并分享踩坑经验与最佳实践。</li>
</ol>
<p>无论你是想夯实基础，还是亟需上线功能，相信都能从中获得实用价值。</p>
<hr/>
<h3 data-id="heading-1">第一部分：手写一个简易版 KeepAlive</h3>
<p>核心思想非常简单：<strong>不要销毁组件，只是把它们藏起来。</strong></p>
<p>当用户切换 Tab 时，普通的 React 条件渲染（<code>{show &amp;&amp; &lt;Component /&gt;}</code>）会触发组件的卸载（Unmount）。而我们的 KeepAlive 组件会将所有渲染过的组件都存在一个 <code>Map</code>（对象）里，根据当前激活的 ID，控制它们的 <code>display</code> 样式。</p>
<h4 data-id="heading-2">1. 核心代码实现</h4>
<p>看看是怎么写的：</p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">import</span> { useState, useEffect } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>

<span class="hljs-keyword">const</span> <span class="hljs-title function_">KeepAlive</span> = (<span class="hljs-params">{ activeId, children }</span>) =&gt; {
  <span class="hljs-comment">// 1. 核心数据结构：缓存容器</span>
  <span class="hljs-comment">// 用一个对象来存储所有渲染过的 children，key 是 activeId</span>
  <span class="hljs-keyword">const</span> [cache, setCache] = <span class="hljs-title function_">useState</span>({});

  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-comment">// 2. 监听变化：一旦 activeId 变了，或者 children 变了</span>
    <span class="hljs-comment">// 如果这个 activeId 对应的组件还没缓存过，就把它存进去</span>
    <span class="hljs-keyword">if</span> (!cache[activeId]) {
      <span class="hljs-title function_">setCache</span>(<span class="hljs-function">(<span class="hljs-params">prev</span>) =&gt;</span> ({
        ...prev,
        [activeId]: children
      }))
    }
  }, [activeId, children, cache])

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;&gt;</span>
      {
        // 3. 渲染所有缓存：利用 Object.entries 遍历缓存对象
        // 关键点：所有组件都渲染出来了，只是通过 display 控制显隐
        Object.entries(cache).map(([id, component]) =&gt; (
          <span class="hljs-tag">&lt;<span class="hljs-name">div</span> 
            <span class="hljs-attr">key</span>=<span class="hljs-string">{id}</span>
            // <span class="hljs-attr">4.</span> <span class="hljs-attr">样式控制</span>：<span class="hljs-attr">如果是当前激活的</span> <span class="hljs-attr">id</span>，<span class="hljs-attr">就</span> <span class="hljs-attr">block</span>，<span class="hljs-attr">否则</span> <span class="hljs-attr">none</span>
            <span class="hljs-attr">style</span>=<span class="hljs-string">{{display:</span> <span class="hljs-attr">id</span> === <span class="hljs-string">activeId</span> ? '<span class="hljs-attr">block</span>'<span class="hljs-attr">:</span> '<span class="hljs-attr">none</span>'}}
          &gt;</span>
            {component}
          <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
        ))
      }
    <span class="hljs-tag">&lt;/&gt;</span></span>
  )
}
</code></pre>
<h4 data-id="heading-3">核心代码解析</h4>
<ol>
<li><code>const [cache, setCache] = useState({});</code> 使用状态管理来缓存已经渲染过的组件</li>
<li><code>useEffect</code>，使用副作用hook更新缓存，如果当前元素还没有加载过那就存入缓存</li>
<li><code> Object.entries</code> ：能够将键值对对象转换为<code>[key,value]</code>的数组，例如{id:1}会被转换为<code>['id',1]</code>,这里通过解构拿到被keepAlive组件包裹的组件元素，然后通过样式控制来控制对应组件的显示。</li>
</ol>
<h4 data-id="heading-4">2. 使用效果</h4>
<p>在需要的组件中使用它：</p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">import</span> {
  useState,
  useEffect
} <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">KeepAlive</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'./components/KeepAlive.jsx'</span>


<span class="hljs-keyword">const</span> <span class="hljs-title function_">Counter</span> = (<span class="hljs-params">{name}</span>)=&gt;{
  <span class="hljs-keyword">const</span> [count, setCount] = <span class="hljs-title function_">useState</span>(<span class="hljs-number">0</span>);
  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">()=&gt;</span>{
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"挂载"</span>,name)
    <span class="hljs-keyword">return</span> <span class="hljs-function">()=&gt;</span>{
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"卸载"</span>,name)
    }
  },[])
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{{padding:</span>'<span class="hljs-attr">20px</span>',<span class="hljs-attr">border:</span>'<span class="hljs-attr">1px</span> <span class="hljs-attr">solid</span> #<span class="hljs-attr">ccc</span>'}}&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">h3</span>&gt;</span>{name}视图<span class="hljs-tag">&lt;/<span class="hljs-name">h3</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>当前计数: {count}<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span>=&gt;</span>setCount(count+1)}&gt;加一<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  )
}
<span class="hljs-keyword">const</span> <span class="hljs-title function_">OtherCounter</span> = (<span class="hljs-params">{name}</span>)=&gt;{
  <span class="hljs-keyword">const</span> [count, setCount] = <span class="hljs-title function_">useState</span>(<span class="hljs-number">0</span>);
  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">()=&gt;</span>{
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"挂载"</span>,name)
    <span class="hljs-keyword">return</span> <span class="hljs-function">()=&gt;</span>{
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"卸载"</span>,name)
    }
  },[])
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{{padding:</span>'<span class="hljs-attr">20px</span>',<span class="hljs-attr">border:</span>'<span class="hljs-attr">1px</span> <span class="hljs-attr">solid</span> #<span class="hljs-attr">ccc</span>'}}&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">h3</span>&gt;</span>{name}视图<span class="hljs-tag">&lt;/<span class="hljs-name">h3</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>当前计数: {count}<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span>=&gt;</span>setCount(count+1)}&gt;加一<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  )
}

<span class="hljs-keyword">const</span> <span class="hljs-title function_">App</span> = (<span class="hljs-params"/>)=&gt;{
  <span class="hljs-keyword">const</span> [activeTab, setActiveTab] = <span class="hljs-title function_">useState</span>(<span class="hljs-string">'A'</span>);
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{{marginBottom:</span>'<span class="hljs-attr">20px</span>'}}&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span>=&gt;</span>setActiveTab('A')}&gt;显示A组件<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span>=&gt;</span>setActiveTab('B')}&gt;显示B组件<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
      {/* children 在react中是用来提升组件的定制能力 父组件方便 */}
      <span class="hljs-tag">&lt;<span class="hljs-name">KeepAlive</span> <span class="hljs-attr">activeId</span>=<span class="hljs-string">{activeTab}</span>&gt;</span>
        {activeTab === 'A'? <span class="hljs-tag">&lt;<span class="hljs-name">Counter</span> <span class="hljs-attr">name</span>=<span class="hljs-string">'A'</span>/&gt;</span>:<span class="hljs-tag">&lt;<span class="hljs-name">OtherCounter</span> <span class="hljs-attr">name</span>=<span class="hljs-string">'B'</span>/&gt;</span>}
      <span class="hljs-tag">&lt;/<span class="hljs-name">KeepAlive</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  )
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title class_">App</span>

</code></pre>
<pre><code class="hljs language-jsx" lang="jsx">&lt;<span class="hljs-title class_">KeepAlive</span> activeId={activeTab}&gt;
  {activeTab === <span class="hljs-string">'A'</span> ? <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Counter</span> <span class="hljs-attr">name</span>=<span class="hljs-string">'A'</span>/&gt;</span></span> : <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">OtherCounter</span> <span class="hljs-attr">name</span>=<span class="hljs-string">'B'</span>/&gt;</span></span>}
&lt;/<span class="hljs-title class_">KeepAlive</span>&gt;
</code></pre>
<p><strong>效果</strong>：</p>
<ul>
<li>当你点击“显示 A 组件”，计数器加到 5。</li>
<li>切换到 B 组件，再切回 A 组件。</li>
<li><strong>A 组件的计数器依然是 5</strong>，而且控制台不会打印“卸载 A”。</li>
<li>这就实现了最基础的<strong>状态保留</strong>。</li>
</ul>
<h3 data-id="heading-5"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d6c2debee41e474f8d9b17ea11dbf7a9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgeGh4eHg=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770270886&amp;x-signature=TxBAcL2MdzI8HKpMjC4uPpYa4NE%3D" alt="20260129-0520-34.0468753.gif" loading="lazy"/></h3>
<h3 data-id="heading-6">第二部分：生产环境实战 (react-activation)</h3>
<p>手写的版本虽然能用，但在复杂的路由场景（React Router）下往往力不从心。在真实项目中，我们通常使用成熟的第三方库，比如 <code>react-activation</code>。</p>
<h4 data-id="heading-7">1. 引入第三方库</h4>
<p>直接使用封装好的第三方库组件，与手写实现不同的是：第三方库的逻辑是： “骗”过 React 。
让 React 以为组件一直安稳地待在顶层，而实际上通过底层 DOM 操作，把它的“肉身”（DOM 节点）按需移动到用户看得到的地方。</p>
<p>在我们的移动端项目中，我们封装了一个 <code>KeepAliveHome</code> 组件：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// src/components/KeepAliveHome.tsx</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">KeepAlive</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'react-activation'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-title class_">Home</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'@/pages/Home'</span>

<span class="hljs-keyword">const</span> <span class="hljs-title function_">KeepAliveHome</span> = (<span class="hljs-params"/>) =&gt; {
    <span class="hljs-keyword">return</span> (
        <span class="hljs-comment">// name: 缓存的唯一标识</span>
        <span class="hljs-comment">// saveScrollPosition="screen": 自动保存并恢复滚动位置</span>
        <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">KeepAlive</span> <span class="hljs-attr">name</span>=<span class="hljs-string">'home'</span> <span class="hljs-attr">saveScrollPosition</span>=<span class="hljs-string">"screen"</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">Home</span>/&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">KeepAlive</span>&gt;</span></span>
    )
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title class_">KeepAliveHome</span>
</code></pre>
<h5 data-id="heading-8">核心逻辑：Portal “乾坤大挪移”</h5>
<ol>
<li>
<p><strong>影子容器（<code>AliveScope</code>）</strong><br/>
库会在应用顶层创建一个不可见的容器（通常包裹整个应用），称为 <code>AliveScope</code>，可理解为组件的“休眠舱”。</p>
</li>
<li>
<p><strong>劫持渲染（Portal）</strong><br/>
当你写 <code>&lt;KeepAlive&gt;&lt;Home /&gt;&lt;/KeepAlive&gt;</code> 时，<code>&lt;Home /&gt;</code> 并不会渲染在当前位置，而是通过 <code>ReactDOM.createPortal</code> 渲染到 <code>AliveScope</code> 中。</p>
</li>
<li>
<p><strong>占位符（Placeholder）</strong><br/>
原位置只保留一个空的 <code>&lt;div&gt;</code> 或注释节点作为占位。</p>
</li>
<li>
<p><strong>搬运 DOM（Teleportation）</strong></p>
<ul>
<li><strong>显示时</strong>：将 <code>AliveScope</code> 中的真实 DOM 节点 <code>appendChild</code> 到占位符处；</li>
<li><strong>隐藏时</strong>（如切换路由）：将该节点移回 <code>AliveScope</code> 存储。</li>
</ul>
</li>
</ol>
<h5 data-id="heading-9">为什么这么做？</h5>
<p>因为 React 组件的生命周期与其在 <strong>虚拟 DOM 树中的位置</strong> 绑定：</p>
<ul>
<li>普通条件渲染会导致组件树位置变化 → React 卸载组件；</li>
<li>而通过 Portal，组件在 React 树中的位置 <strong>始终固定在 <code>AliveScope</code> 内部</strong>，从未改变；</li>
<li>因此 React 认为它“一直活着”，状态自然保留。</li>
</ul>
<blockquote>
<p>💡 注意：此处仅为演示。实际开发中，建议将 <code>KeepAlive</code> 封装为通用高阶组件，通过 <code>children</code> 接收任意需缓存的子组件。</p>
</blockquote>
<h4 data-id="heading-10">2. 配合路由使用</h4>
<p>在路由配置中，我们需要用 <code>AliveScope</code> 包裹整个应用（通常在 <code>Router</code> 内部）：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// src/router/index.tsx</span>
&lt;<span class="hljs-title class_">Router</span>&gt;
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">AliveScope</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">Routes</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">Route</span> <span class="hljs-attr">path</span>=<span class="hljs-string">"/"</span> <span class="hljs-attr">element</span>=<span class="hljs-string">{</span>&lt;<span class="hljs-attr">KeepAliveHome</span> /&gt;</span>} /&gt;
      {/* ... */}
    <span class="hljs-tag">&lt;/<span class="hljs-name">Routes</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">AliveScope</span>&gt;</span></span>
&lt;/<span class="hljs-title class_">Router</span>&gt;
</code></pre>
<p>当我们浏览时，即使从详情页出来也不会从顶部重新开始看了，而是停留在了上一次的浏览位置
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/835a5009890045d292b40171c3d393cb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgeGh4eHg=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770270886&amp;x-signature=gyEy%2FKrv65SzpogpElsu4CMmsbs%3D" alt="20260129-0537-14.7884793.gif" loading="lazy"/></p>
<h4 data-id="heading-11">3. 遇到的坑与最佳实践</h4>
<p>在使用 <code>react-activation</code> 时，有一个非常容易踩的坑：<strong>父组件卸载导致的缓存失效</strong>。</p>
<p>在 React Router v6 的嵌套路由中，如果你的结构是：</p>
<pre><code class="hljs language-jsx" lang="jsx">&lt;<span class="hljs-title class_">Route</span> path=<span class="hljs-string">"/"</span> element={<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">MainLayout</span> /&gt;</span></span>}&gt;
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Route</span> <span class="hljs-attr">index</span> <span class="hljs-attr">element</span>=<span class="hljs-string">{</span>&lt;<span class="hljs-attr">KeepAliveHome</span> /&gt;</span>} /&gt;</span>
&lt;/<span class="hljs-title class_">Route</span>&gt;
</code></pre>
<p>当你跳转到 <code>/detail</code>（一个不属于 <code>MainLayout</code> 的路由）时，<strong><code>MainLayout</code> 会被卸载</strong>。
根据 React 的规则，父组件卸载，子组件（哪怕包了 KeepAlive）也会随之销毁。</p>
<p><strong>解决方案</strong>：</p>
<ol>
<li><strong>提升层级</strong>：尽量将需要缓存的组件放在路由树的顶层，或者确保其父级 Layout 不会轻易卸载。</li>
<li><strong>静态引入</strong>：避免使用 <code>React.lazy</code> 懒加载包裹 KeepAlive 组件，有时会导致组件引用变化从而重置缓存。</li>
</ol>
<h4 data-id="heading-12">总结</h4>
<p>组件缓存看似是一个小功能，实则深刻影响着用户体验与开发复杂度。通过本文的探索，我们可以清晰地看到两种实现路径的定位与价值：</p>
<ul>
<li><strong>手写简易 KeepAlive</strong>：<br/>
它的核心在于“<strong>渲染但隐藏</strong>”——利用 <code>display: none</code> 配合状态缓存，避免组件卸载。这种方式代码透明、逻辑直观，非常适合学习 React 渲染机制和状态生命周期，也足以应对简单的 Tab 切换、面板切换等静态场景。但它无法处理路由跳转、DOM 结构变化或滚动位置恢复等复杂需求，<strong>更适合教学或轻量级 UI 控制</strong>。</li>
<li><strong>react-activation（生产级方案）</strong> ：<br/>
该库通过 <code>Portal</code> 将需要缓存的组件 DOM 节点“移出”原有树结构，托管到顶层的 <code>&lt;AliveScope&gt;</code> 中，从而在父组件卸载时仍能保留实例。它不仅支持完整的 React 生命周期（如 <code>useEffect</code> 不重复触发），还内置了 <code>saveScrollPosition</code> 等实用功能，<strong>真正实现了类 Vue <code>&lt;keep-alive&gt;</code> 的体验</strong>，是中大型项目中的可靠选择。</li>
</ul>
<blockquote>
<p>📌 <strong>关键认知</strong>：缓存的本质不是“不让组件消失”，而是“不让组件被销毁”。理解这一点，就能明白为何父组件卸载会导致子缓存失效——因为 React 的卸载是自上而下的。这也解释了为何 <code>react-activation</code> 必须依赖全局作用域（<code>AliveScope</code>）来“劫持”组件的挂载点。</p>
</blockquote>
<p>最终，<strong>工具服务于场景</strong>。当你面对一个需要极致体验的移动端应用时，不要犹豫，拥抱成熟的缓存方案；而当你在调试或教学中想透彻理解机制，不妨从一行 <code>Object.entries(cache)</code> 开始，亲手构建属于自己的 KeepAlive。</p>
<p>毕竟，最好的框架使用方式，永远建立在对原理的深刻理解之上。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[别再只盯着 Lodash 了：这 3 个原生 API，才是 2026 年前端性能的“天花板”]]></title>    <link>https://juejin.cn/post/7600345782173188130</link>    <guid>https://juejin.cn/post/7600345782173188130</guid>    <pubDate>2026-01-29T06:16:06.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600345782173188130" data-draft-id="7600345782173171746" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="别再只盯着 Lodash 了：这 3 个原生 API，才是 2026 年前端性能的“天花板”"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2026-01-29T06:16:06.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="用户3905133219288"/> <meta itemprop="url" content="https://juejin.cn/user/3609051079121550"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            别再只盯着 Lodash 了：这 3 个原生 API，才是 2026 年前端性能的“天花板”
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3609051079121550/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    用户3905133219288
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-29T06:16:06.000Z" title="Thu Jan 29 2026 06:16:06 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在 AI 辅助编程普及的今天，写出“能跑”的代码已经没有门槛了。但为什么同样的 Vue 3 或 React 项目，在大数据量或复杂交互下，别人的页面丝滑如 144Hz，你的却总有那种挥之不去的“果冻感”和微小卡顿？</p>
<p>秘密往往不在于你用了什么框架，而在于你是否掌握了浏览器原生调度逻辑。今天分享三个被大多数人忽略、却能解决性能“顽疾”的高效 API。</p>
<hr/>
<h2 data-id="heading-0">一、 Scheduler.yield()：打破长任务的“霸权”</h2>
<h3 data-id="heading-1">痛点：页面“假死”</h3>
<p>我们经常会遇到这种场景：处理一个超大 JSON 数组，或者在 Canvas 中一次性初始化数千个粒子。即便你的电脑性能再强，JS 执行时也会霸占主线程。此时用户点击按钮、滚动页面，浏览器都没法响应，这种“假死”是用户体验的杀手。</p>
<h3 data-id="heading-2">过去的做法：<code>setTimeout(0)</code></h3>
<p>我们习惯用 <code>setTimeout(() =&gt; {...}, 0)</code> 来切分任务。但它的问题是<strong>优先级不受控</strong>。浏览器可能会在两个任务块之间插入不必要的渲染，或者干脆延迟太久才执行。</p>
<h3 data-id="heading-3">2026 年的解法：<code>Scheduler.yield()</code></h3>
<p>这是现代浏览器（基于 Prioritized Task Scheduling API）提供的利器。它能让出主线程，允许浏览器去处理更高优先级的任务（如用户输入），然后<strong>立即</strong>回来继续执行剩下的逻辑。</p>
<pre><code class="hljs language-scss" lang="scss">async function <span class="hljs-built_in">processHugeData</span>(data) {
  for (const item of data) {
    <span class="hljs-comment">// 执行复杂的业务逻辑</span>
    <span class="hljs-built_in">performComplexCalculation</span>(item);

    <span class="hljs-comment">// 每处理 100 条数据，检查是否需要把控制权交给浏览器</span>
    if (shouldYield()) {
      await scheduler<span class="hljs-selector-class">.yield</span>(); 
    }
  }
}
</code></pre>
<p><strong>为什么它更高效？</strong><br/>
它不像 <code>setTimeout</code> 那样盲目等待，而是告诉浏览器：“如果你有急事（用户点了个赞），你先忙；如果你没事，咱们继续。” 这种<strong>协同式调度</strong>是实现高性能交互的基础。</p>
<hr/>
<h2 data-id="heading-4">二、 content-visibility: auto：CSS 里的“虚拟滚动”</h2>
<h3 data-id="heading-5">痛点：DOM 节点过多导致的重绘灾难</h3>
<p>在做数字孪生驾驶舱、长信息流或复杂的管理后台时，页面上可能有数千个 DOM 节点。即便它们在屏幕外面，浏览器依然会计算它们的几何属性。</p>
<h3 data-id="heading-6">传统的解法：虚拟列表</h3>
<p>手动实现虚拟列表（Virtual List）非常痛苦，需要计算高度、监听滚动，且对 SEO 不友好。</p>
<h3 data-id="heading-7">现代解法：<code>content-visibility</code></h3>
<p>只需一行 CSS，你就能获得接近虚拟列表的性能收益：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.card-container</span> {
  <span class="hljs-attribute">content-visibility</span>: auto;
  <span class="hljs-attribute">contain</span>-intrinsic-size: <span class="hljs-number">0</span> <span class="hljs-number">500px</span>; <span class="hljs-comment">/* 给未渲染元素一个预估高度，防止滚动条抖动 */</span>
}
</code></pre>
<ul>
<li>• <strong>原理</strong>：当元素不在视口内时，浏览器会跳过该元素的渲染工作（包括布局和绘图）。</li>
<li>• <strong>收益</strong>：对于含有大量图表（Echarts）或复杂 Canvas 的项目，首屏加载时间和滚动流畅度会有量级的提升。</li>
</ul>
<hr/>
<h2 data-id="heading-8">三、 AbortController：不仅仅是为了取消 Fetch</h2>
<h3 data-id="heading-9">痛点：内存泄漏与监听器地狱</h3>
<p>在 Vue 3 项目中，我们经常在 <code>onMounted</code> 里绑定一堆 <code>window</code> 监听器，然后在 <code>onUnmounted</code> 里一个个手动 <code>removeEventListener</code>。一旦漏写，就是内存泄漏。</p>
<h3 data-id="heading-10">高效技巧：一键“自毁”</h3>
<p><code>AbortController</code> 实际上是一个通用的信号发射器。现在，几乎所有的原生 Web API 都支持接收它的 <code>signal</code>。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> controller = <span class="hljs-keyword">new</span> <span class="hljs-title class_">AbortController</span>();
<span class="hljs-keyword">const</span> { signal } = controller;

<span class="hljs-comment">// 绑定多个事件</span>
<span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'resize'</span>, handleResize, { signal });
<span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'scroll'</span>, handleScroll, { signal });
<span class="hljs-variable language_">document</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'mousemove'</span>, handleMouseMove, { signal });

<span class="hljs-comment">// 请求数据</span>
<span class="hljs-title function_">fetch</span>(<span class="hljs-string">'/api/data'</span>, { signal });

<span class="hljs-comment">// 需要清理时（比如 Vue 组件销毁），只需一行代码：</span>
controller.<span class="hljs-title function_">abort</span>(); 
</code></pre>
<p><strong>为什么这很优雅？</strong><br/>
你不再需要保存每一个函数的引用。当你调用 <code>abort()</code> 时，所有绑定了该信号的事件监听器、正在进行的 Fetch 请求、甚至是某些动画序列，都会被<strong>同时销毁</strong>。这对于构建复杂的交互系统（如手势控制游戏）来说，简直是代码洁癖者的福音。</p>
<hr/>
<h2 data-id="heading-11">总结：博主的私房话</h2>
<p>在 2026 年，前端开发的重心已经从“如何实现功能”转向了“如何优雅地调度资源”。</p>
<ul>
<li>• <strong><code>Scheduler.yield()</code></strong>  解决了 <strong>JS 逻辑层</strong>的阻塞。</li>
<li>• <strong><code>content-visibility</code></strong> 解决了 <strong>渲染层</strong>的冗余。</li>
<li>• <strong><code>AbortController</code></strong> 解决了 <strong>生命周期管理</strong>的混乱。</li>
</ul>
<p>这些 API 虽然冷门，但它们代表了 Web 标准进化的方向：<strong>把复杂的调度交给浏览器引擎，把清爽的代码留给我们自己。</strong></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[一键部署！京东云上线Clawdbot云服务！]]></title>    <link>https://juejin.cn/post/7600318091831853083</link>    <guid>https://juejin.cn/post/7600318091831853083</guid>    <pubDate>2026-01-29T05:30:54.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600318091831853083" data-draft-id="7600508556103172146" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="一键部署！京东云上线Clawdbot云服务！"/> <meta itemprop="keywords" content="程序员"/> <meta itemprop="datePublished" content="2026-01-29T05:30:54.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="京东云开发者"/> <meta itemprop="url" content="https://juejin.cn/user/2634854380340008"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            一键部署！京东云上线Clawdbot云服务！
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2634854380340008/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    京东云开发者
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-29T05:30:54.000Z" title="Thu Jan 29 2026 05:30:54 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>Clawdbot（现改名Moltbot）一夜爆火全球，这个能读文件、跑命令、写代码、管系统的开源 AI 智能体，现已正式登陆京东云，无需手动配置环境，一键即可开启，让你的 AI 助手秒级上线、全天候待命。</p>
<p>Moltbot是少数真正具备系统级操作能力的个人智能助理：</p>
<ul>
<li>本地长期记忆（对话数据自主可控）</li>
<li>跨平台推送（支持对接通讯类软件）</li>
<li>真实任务执行（文件整理、表单提交、代码生成）</li>
</ul>
<p>这样一个强大又敏感的 AI 助手，该运行在哪里？更安全、更稳定的方式，是将其部署在独立、隔离的云端环境中。</p>
<p>京东云全面上线 Moltbot！京东云轻量云主机现已预置 Moltbot 应用镜像，无需手动配置环境，三步即可完成部署，让你的 AI 助手秒级上线、全天候待命。</p>
<p><strong>第一步：一键创建实例</strong></p>
<p>在京东云控制台创建轻量云主机，选择：</p>
<p>镜像名称：Moltbot</p>
<p>规格建议：2 核 2G 起（推荐 2 核 4G 以获得更佳体验）</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/eb5df39896994c999d39dbbbb5683c68~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770269455&amp;x-signature=HJNOu74gtVdWM%2F0oymthVkofXL4%3D" alt="图片" loading="lazy"/></p>
<p><strong>第二步：获取API-Key</strong></p>
<p>登录JoyBuilder 模型开发平台 2.0，进入API-KEY 管理页面：</p>
<p>1、点击「创建」按钮，生成新的 API-Key；</p>
<p>2、在“修改 API-KEY”页面中，为该 Key 配置可访问的模型服务，必须包含以下模型：DeepSeek-V3-0324、DeepSeek-V3.2、DeepSeek-v3、Qwen3-235B-A22B、Kimi-K2-0905-jcloud</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4b2480fed61141f9bfd518706f771fc6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770269455&amp;x-signature=0vC%2FTf1O1yhwC2ArcuFoS%2Fh1yNg%3D" alt="图片" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c69dc9b127fa435eafdb313b981e5ca2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770269455&amp;x-signature=kyWB4rE918egYuyAe%2BaBqt%2F0K3c%3D" alt="图片" loading="lazy"/></p>
<p><strong>第三步：初始化与启动服务</strong></p>
<p>通过控制台或者终端工具登轻量云主机。首次登陆需要执行脚本命令配置京东云模型服务：</p>
<p>bash init-clawdbot.sh pk-xxxxx # 替换为你的 API-Key</p>
<p>执行初始化命令：</p>
<p>clawdbot onboard</p>
<p>按引导完成相关配置：</p>
<p>风险确认</p>
<p>聊天渠道绑定（如 Discord、飞书机器人等）</p>
<p>……</p>
<p>以上配置完成后，即可上手使用。快上京东云开启一键部署，让 Moltbot 成为你专属的 24 小时数字员工！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Moltbot（Clawdbot） + 飞书机器人：一次接入实践]]></title>    <link>https://juejin.cn/post/7600380007885832242</link>    <guid>https://juejin.cn/post/7600380007885832242</guid>    <pubDate>2026-01-29T05:32:02.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600380007885832242" data-draft-id="7600333405978279977" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Moltbot（Clawdbot） + 飞书机器人：一次接入实践"/> <meta itemprop="keywords" content="后端,AIGC,人工智能"/> <meta itemprop="datePublished" content="2026-01-29T05:32:02.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="洛卡卡了"/> <meta itemprop="url" content="https://juejin.cn/user/888839672963544"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Moltbot（Clawdbot） + 飞书机器人：一次接入实践
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/888839672963544/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    洛卡卡了
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-29T05:32:02.000Z" title="Thu Jan 29 2026 05:32:02 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读18分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:14px;overflow-x:hidden;color:var(--cyanosis-base-color);transition:color .35s;--cyanosis-base-color:#353535;--cyanosis-title-color:#005bb7;--cyanosis-strong-color:#2196f3;--cyanosis-em-color:#4fc3f7;--cyanosis-del-color:#ccc;--cyanosis-link-color:#3da8f5;--cyanosis-linkh-color:#007fff;--cyanosis-border-color:#bedcff;--cyanosis-border-color-2:#ececec;--cyanosis-bg-color:#fff;--cyanosis-blockquote-color:#8c8c8c;--cyanosis-blockquote-bg-color:#f0fdff;--cyanosis-code-color:#c2185b;--cyanosis-code-bg-color:#fff4f4;--cyanosis-code-pre-color:#f8f8f8;--cyanosis-table-border-color:#c3e0fd;--cyanosis-table-th-color:#dff0ff;--cyanosis-table-tht-color:#005bb7;--cyanosis-table-tr-nc-color:#f7fbff;--cyanosis-table-trh-color:#e0edf7;--cyanosis-slct-title-color:#005bb7;--cyanosis-slct-titlebg-color:rgba(175,207,247,0.25);--cyanosis-slct-text-color:#c80000;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#e8ebec;--cyanosis-slct-codebg-color:#ffeaeb;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body.__dark{--cyanosis-base-color:#cacaca;--cyanosis-title-color:#ddd;--cyanosis-strong-color:#fe9900;--cyanosis-em-color:#ffd28e;--cyanosis-del-color:#ccc;--cyanosis-link-color:#ffb648;--cyanosis-linkh-color:#fe9900;--cyanosis-border-color:#ffe3ba;--cyanosis-border-color-2:#ffcb7b;--cyanosis-bg-color:#2f2f2f;--cyanosis-blockquote-color:#c7c7c7;--cyanosis-blockquote-bg-color:rgba(255,199,116,0.1);--cyanosis-code-color:#000;--cyanosis-code-bg-color:#ffcb7b;--cyanosis-code-pre-color:rgba(255,227,185,0.5);--cyanosis-table-border-color:#fe9900;--cyanosis-table-th-color:#ffb648;--cyanosis-table-tht-color:#000;--cyanosis-table-tr-nc-color:#6d5736;--cyanosis-table-trh-color:#947443;--cyanosis-slct-title-color:#000;--cyanosis-slct-titlebg-color:#fe9900;--cyanosis-slct-text-color:#00c888;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#000;--cyanosis-slct-codebg-color:#ffcb7b;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body h1{padding-bottom:4px;font-size:30px}.markdown-body h1,.markdown-body h2{margin-top:36px;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);transition:color .35s}.markdown-body h2{position:relative;padding-left:10px;padding-right:10px;padding-bottom:10px;font-size:24px;border-bottom:1px solid var(--cyanosis-border-color-2)}.markdown-body h2:before{content:"「";position:absolute;top:-6px;left:-14px}.markdown-body h2:after{content:"」";position:relative;top:6px;right:auto}.markdown-body h3{position:relative;padding-bottom:0;margin-top:30px;margin-bottom:10px;font-size:20px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h3:before{content:"»";padding-right:6px;color:var(--cyanosis-strong-color)}.markdown-body h4{margin-top:24px;font-size:16px}.markdown-body h4,.markdown-body h5{padding-bottom:0;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h5{margin-top:18px;font-size:14px}.markdown-body h6{padding-bottom:0;margin-top:12px;margin-bottom:10px;font-size:12px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body p{line-height:inherit;margin-top:16px;margin-bottom:16px}.markdown-body img{max-width:100%}.markdown-body hr{position:relative;width:98%;height:1px;margin-top:32px;margin-bottom:32px;background-image:linear-gradient(90deg,var(--cyanosis-link-color),rgba(255,0,0,.3),hsla(0,0%,100%,.1),rgba(255,0,0,.3),var(--cyanosis-link-color));border-width:0;overflow:visible}.markdown-body hr:after{content:"";position:absolute;margin:auto;left:0;right:0;bottom:0;top:0;display:inline-block;width:60px;height:20px;background-color:var(--cyanosis-bg-color);background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAgCAYAAABgrToAAAADoklEQVRYR82XTYgcRRTHf2933Q1RjAa9eFO8JHoJ8RQVBQ2iBwXBET0YEUTXNVmNQtTpmeqaWV0XNRq/o4KoECSCEPSg4CF+BYUkIIiCoCJCPIhC/Ihh2Z0nVV27VnZnenumW9i6ddV7//frV69fVQurfMgq56NawFTPAU6QyomqXrw6wIZeyhCPebA5buNR+akKyGoAjd6BshthnYdSjqNcRVuOlIUsD2j0SuA94IwuMHdh5ZUykOUBXfSGbmKI54EtAeYIHSZoy5dl4JxvNYBOKdW1KE8BQ8AkVk6WhasWsAiN0TX9gveXQaPP+Aytpc4u+bMI06JNohsYYYYOR2lJWtS3OKDRfcAtQfgDoI6Vo4UCGb0OmAEuDvZvYmVbEd/igC3dzDz7gQu8sPA9kJDK27mBmjqBeLjTg90PDFOjWawFFQd06kZHEfaj3LAIpTRpSXsZ5E06zEYP9sDimnAApYaV2SLZG/wjMeqAkijwW4xQJ5Gf/ZzRC8OW3hiBTGGlURRswW55Bh/Ssxljrwew8l1PQaM14GngvGDzBUKdDsMeTtgU5o8B92PFlUf3YXUrHa7Fys6lBqcCGnX15YQ2A18FyPd7Crd1A3M8C1wdbH4DD3hWeP6IEXbQkG97ajR1HPFnuPP5jFFq1OWX7hl8WM9l1AO648uNfwLk7tytMeogty+xeQ4rO3r6bdcx1nuwOGsHmaXGtPzae4uzGnLH1kQkvpdZGrHjssBZJrL+pqS05KWc8tgITAPXRzYvYOXe/C2OV43eDcRBDtIhoS2f9wzc0Cv8Wls+zoFzUC5zF0U241h5uZtPfptp6OUM8wbK+cH5GEpCS17P3fJei0Z3+npTxryJ8CPzbKMtn/ZyWbkPGl0PuFPkmkjkcb4h4R2ZLwRq1H0ALmvjkf2HwK1Y+T1PY2XABe/sHJ6MxN5lnoSpnC/UGbsTaI5phK2R7x6s3Ffk5YoDOrWm3onwJHBmEP86bPmBrsGaenNoIdnxCH+gPEhLXi0Cl1VBvyPVLSh7gEuC62yAfOIUqabWEaaiucMIk6RyqJ+Q/QM69V26jjW86Gvov/EaoyT8zRCn+Xq7PVrbx0nuYUaO9wM3WAbjCE1NEUw09Um4UV+2OKfYfu5/S19gsAzGKqm6LE5FrShbdS0ku465DjDwKA/oQht19ejqbaEVuRbiLhuHByYLjtUAZpDutzP7cYdHsPJXWbjyNVgFwQoa1WXwf4Jd9YD/Ap80+yE7+u9aAAAAAElFTkSuQmCC);background-repeat:no-repeat;background-size:auto 100%;background-position-x:center;transition:background-color .5s}.markdown-body code{padding:.065em .4em;font-size:.87em;color:var(--cyanosis-code-color);word-break:break-word;overflow-x:auto;background-color:var(--cyanosis-code-bg-color);border-radius:2px}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{display:block;padding:16px 12px;margin:0;font-size:12px;color:#333;word-break:normal;overflow-x:auto;background:var(--cyanosis-code-pre-color)}.markdown-body pre&gt;code::-webkit-scrollbar{width:4px;height:4px}.markdown-body pre&gt;code::-webkit-scrollbar-track{background-color:var(--cyanosis-border-color)}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:var(--cyanosis-strong-color);border-radius:10px}.markdown-body a{position:relative;text-decoration:none;color:var(--cyanosis-link-color);border-bottom:1px solid var(--cyanosis-border-color)}.markdown-body a:hover{border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body a:active,.markdown-body a:hover{color:var(--cyanosis-linkh-color)}.markdown-body a:after{position:absolute;content:"";top:100%;left:0;width:100%;opacity:0;border-bottom:1px solid var(--cyanosis-border-color);transition:top .3s,opacity .3s;transform:translateZ(0)}.markdown-body a:hover:after{top:0;opacity:1;border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid var(--cyanosis-table-border-color);border-spacing:0;border-collapse:collapse}.markdown-body table thead{color:#000;text-align:left;font-size:14px;background:#f6f6f6}.markdown-body table tr:nth-child(2n){background-color:var(--cyanosis-table-tr-nc-color)}.markdown-body table tr:hover{background-color:var(--cyanosis-table-trh-color)}.markdown-body table td,.markdown-body table th{padding:12px 8px;line-height:24px;border:1px solid var(--cyanosis-table-border-color)}.markdown-body table th{color:var(--cyanosis-table-tht-color);background-color:var(--cyanosis-table-th-color)}.markdown-body table td{min-width:120px}.markdown-body blockquote{color:var(--cyanosis-blockquote-color);border-left:4px solid var(--cyanosis-strong-color);background-color:var(--cyanosis-blockquote-bg-color);padding:1px 20px;margin:22px 0;transition:color .35s}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body b,.markdown-body blockquote&gt;b,.markdown-body blockquote&gt;strong,.markdown-body strong{color:var(--cyanosis-strong-color)}.markdown-body em,.markdown-body i{color:var(--cyanosis-em-color)}.markdown-body del{color:var(--cyanosis-del-color)}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:4px}.markdown-body ol li{padding-left:6px}.markdown-body details&gt;summary{outline:none;color:var(--cyanosis-title-color);font-size:20px;font-weight:bolder;border-bottom:1px solid var(--cyanosis-border-color);cursor:pointer}.markdown-body details&gt;p{padding:10px 20px;margin:10px 0 0;color:#666;background-color:var(--cyanosis-blockquote-bg-color);border:2px dashed var(--cyanosis-strong-color)}.markdown-body h1::selection,.markdown-body h2::selection,.markdown-body h3::selection,.markdown-body h4::selection,.markdown-body h5::selection,.markdown-body h6::selection{color:var(--cyanosis-slct-title-color);background-color:var(--cyanosis-slct-titlebg-color)}.markdown-body ol li::selection,.markdown-body p::selection,.markdown-body ul li::selection{color:var(--cyanosis-slct-text-color);background-color:var(--cyanosis-slct-bg-color)}.markdown-body a::selection,.markdown-body b::selection,.markdown-body em::selection,.markdown-body i::selection,.markdown-body strong::selection{background-color:var(--cyanosis-slct-elbg-color)}.markdown-body del::selection{color:var(--cyanosis-slct-del-color);background-color:var(--cyanosis-slct-elbg-color)}.markdown-body table thead th::selection{background-color:transparent}.markdown-body table tbody td::selection{background-color:var(--cyanosis-slct-bg-color)}.markdown-body code::selection{background-color:var(--cyanosis-slct-codebg-color)}.markdown-body pre&gt;code::selection{background-color:var(--cyanosis-slct-prebg-color)}.markdown-body .contains-task-list{padding-left:14px;list-style:none}.markdown-body .contains-task-list input[type=checkbox]{position:relative}.markdown-body .contains-task-list input[type=checkbox]:before{content:"";position:absolute;top:0;left:0;right:0;bottom:0;width:inherit;height:inherit;background:#f0f8ff;border:1px solid #add6ff;border-radius:2px;box-sizing:border-box;z-index:1}.markdown-body .contains-task-list input[type=checkbox]:checked:after{content:"✓";position:absolute;top:-12px;left:0;right:0;bottom:0;width:0;height:0;color:#f55;font-size:20px;font-weight:700;z-index:2}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="atom-one-dark">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#abb2bf;background:#282c34}.hljs-comment,.hljs-quote{color:#5c6370;font-style:italic}.hljs-doctag,.hljs-formula,.hljs-keyword{color:#c678dd}.hljs-deletion,.hljs-name,.hljs-section,.hljs-selector-tag,.hljs-subst{color:#e06c75}.hljs-literal{color:#56b6c2}.hljs-addition,.hljs-attribute,.hljs-meta-string,.hljs-regexp,.hljs-string{color:#98c379}.hljs-built_in,.hljs-class .hljs-title{color:#e6c07b}.hljs-attr,.hljs-number,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-pseudo,.hljs-template-variable,.hljs-type,.hljs-variable{color:#d19a66}.hljs-bullet,.hljs-link,.hljs-meta,.hljs-selector-id,.hljs-symbol,.hljs-title{color:#61aeee}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}.hljs-link{text-decoration:underline}</style><h3 data-id="heading-0">简单认识一下 Clawdbot</h3>
<p>大家好，我是卡卡。最近 AI 圈被一款名为 <strong>Clawdbot</strong> 的产品刷屏了，这几天不管是在国内技术社区，还是我晚上没事刷 TG、X 的时候，几乎都能看到有人在讨论它。<br/>
看了一下官方文档，Clawdbot 本质上就是一个偏“个人智能助手”的东西，只不过它不是单独开一个网页给我们用，而是可以直接接入我们平时常用的聊天软件，比如 WhatsApp、Telegram、Discord、Slack、Signal，甚至 iMessage，都可以当作它的交互入口。</p>
<p>真正让技术圈开始认真看待它的，其实是这种使用方式：AI 不跑在某个平台上，而是跑在我们自己的环境里，可以是本地电脑，也可以是个人服务器；我们和它的交互，还是通过熟悉的聊天工具，就像跟一个同事发消息一样；在权限允许的情况下，它可以直接操作文件、执行命令，长期记住上下文，变成一个真正属于我们的 AI 助手；而相关数据也都掌握在我们自己手里，不需要交给第三方平台托管。</p>
<hr/>
<h3 data-id="heading-1">Clawdbot 和我们常用的 AI 聊天工具有什么不一样？</h3>
<p>我第一次安装后在CLI工具里面用 Clawdbot 的时候，其实很容易产生一种错觉：<br/>
<strong>感觉这不就是换了个聊天框在用 Claude / GPT 吗？</strong><br/>
不管是在终端里，还是后面接到飞书、Telegram，输入一句话、等 AI 回复，体验上和 Claude、ChatGPT、豆包、DeepSeek 这些聊天工具确实很像啊。</p>
<p>但真正用下来会发现，两者的定位其实不一样。我们平时用的这些 AI，更像是对话型工具，比如我们问问题、写文案、查资料，用完这一轮基本就结束了；而 Clawdbot 更像是把 AI 变成了一个<strong>长期在线、能干活的助手</strong>。它不是跑在某个平台的聊天页面里，而是直接跑在我们自己的环境中，可以在权限允许的情况下操作文件、执行命令、记住长期上下文，再通过聊天软件把结果反馈给我们。</p>
<p>所以表面上看是在聊天，本质上其实是在<strong>通过聊天工具远程指挥一个跑在自己环境里的 AI</strong>，这也是它和 Claude、GPT 这类纯聊天产品最大的区别。</p>
<hr/>
<h3 data-id="heading-2">Clawdbot 和 Moltbot 是什么关系</h3>
<p>还有一个很多人一开始都会困惑的点：<br/>
<strong>为什么有的地方叫 Clawdbot，有的地方又变成了 Moltbot？</strong></p>
<p>实际上简单了解一下就会知道这并不是两个项目，也不是重写了一套代码，而是同一个项目在近期做了一次命名调整。最早项目对外叫 Clawdbot，后来改成了 Moltbot，主要是出于品牌和命名上的原因；但在具体使用时，我们会发现核心 CLI、运行时以及很多命令里，仍然保留着 Clawdbot 这个名字。</p>
<p>所以在安装和配置过程中，同时看到 Moltbot 和 Clawdbot 是一件很正常的事情，可以简单理解为：<strong>Moltbot 是现在对外的项目名称，Clawdbot 仍然是内部和工具层面的实际名字</strong>。这一点如果不提前说明，第一次上手时确实很容易让人产生困惑。</p>
<hr/>
<h3 data-id="heading-3">关于 Clawdbot 的一些风险考虑</h3>
<p>在继续往下折腾之前，我还是简单考虑了一下 Clawdbot 这类工具本身带来的风险。<br/>
Clawdbot 需要运行在本地电脑或服务器上，并且在实际使用中会涉及文件读写、命令执行等操作，这决定了它并不是一个只聊天、不碰系统的工具。</p>
<p>从工程角度来看，只要涉及到较高权限，就不可避免会有安全层面的顾虑，比如配置是否足够隔离、代码是否完全可控，以及长期运行在一台机器上的影响等问题。这些点目前我自己也还在了解过程中，并没有形成特别成熟的判断。</p>
<p>基于这些考虑，我目前的使用方式还是比较保守：只在个人环境中搭建，用来体验功能和验证流程；在工程实践或生产环境中，暂时不打算直接引入这一套方案。这个使用角度方面大家结合自己的情况自行考虑哈。</p>
<hr/>
<h3 data-id="heading-4">安装环境说明</h3>
<p>接下来就开始安装了。因为我平时一直用的是 Mac，所以这次的安装过程也是基于 macOS 来记录的。<br/>
至于 Windows 或者直接在云服务器上的安装方式，我这边没有逐一去测试，整体思路是一样的，细节差异大家可以参考其他文章，已经有不少写得很详细了。</p>
<p>在正式安装之前，需要先准备好运行环境。Clawdbot / Moltbot 是基于 Node.js 的工具，所以本地需要提前安装好 Node 环境，版本不要太老即可，正常使用官方的 Node LTS 基本都没问题。如果这一步没装，后面执行安装脚本时会直接报错。</p>
<p>另外再强调一次哈，如果有些同学只是想体验功能、熟悉流程，其实不一定非要在我们自己主力电脑上折腾的。更稳妥的方式是单独买一台测试用的 VPS 或轻量服务器来跑，当作一个隔离的实验环境，用起来也会更安心一些。</p>
<hr/>
<h3 data-id="heading-5">可选方案说明</h3>
<p>如果有同学觉得从环境准备到一步步执行命令还是有点麻烦，其实也可以试试阿里云这边提供的 <strong>Clawdbot 一键安装方案</strong>。</p>
<p>阿里云已经把基础环境和安装流程打包好了，整体更偏向“开箱即用”，适合只是想快速体验一下的同学。相关入口在这里：  <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.aliyun.com%2Factivity%2Fecs%2Fclawdbot%3FuserCode%3Doq2t54oi" target="_blank" title="https://www.aliyun.com/activity/ecs/clawdbot?userCode=oq2t54oi" ref="nofollow noopener noreferrer">一键部署</a></p>
<p>不过这篇文章里，我还是选择手动安装的方式来记录，一方面流程更清楚，另一方面也方便后面自己排查问题。如果只是图省事，一键安装也是一个可以考虑的选择。</p>
<hr/>
<h3 data-id="heading-6">安装 Moltbot</h3>
<blockquote>
<p>环境准备好之后，安装过程本身反而很简单，直接使用官方提供的安装脚本即可，一条命令就能完成基础安
装：</p>
</blockquote>
<pre><code class="hljs language-bash" lang="bash">curl -fsSL https://molt.bot/install.sh | bash
</code></pre>
<blockquote>
<p>这个脚本会自动完成 CLI 的下载和基础配置，安装完成后就可以使用 <code>clawdbot</code> 相关命令继续后面的初始化和配置流程。</p>
</blockquote>
<p><img src="https://typora.luokakale.com/typora/20260129095259067.png" alt="image-20260129095258962" loading="lazy"/></p>
<p>如果是第一次安装，过程会稍微慢一点，中间看起来像是卡住了，其实是在下载和初始化依赖，等它跑完就行。
当脚本执行完成后，终端里会自动进入 Clawdbot（现在也叫 Moltbot）的初始化引导界面:
<img src="https://typora.luokakale.com/typora/20260129095334650.png" alt="image-20260129095334616" loading="lazy"/></p>
<p>首先出现的就是这个安全确认提示。大概意思是：Clawdbot 属于权限比较高的 AI Agent，后面可能会涉及本地命令、文件读写等操作，官方在这里提前提醒存在一定风险，需要我们确认是否继续。<br/>
如果只是像本文一样做本地测试、体验功能、后面接入飞书聊天，这里<strong>直接选择 <code>Yes</code> 即可</strong>，继续后面的配置流程。</p>
<hr/>
<p>接下来是初始化方式的选择，这里有 <strong>QuickStart</strong> 和 <strong>Manual</strong> 两种模式。<br/>
QuickStart 相当于帮我们先用一套默认、安全的配置把 Clawdbot 跑起来，后面的模型、渠道、权限等都可以再单独调整；Manual 则是从一开始就自己一项一项配置，步骤会多一些。<br/>
为了先把流程跑通，这里我们直接选择 <strong>QuickStart</strong> 即可。
<img src="https://typora.luokakale.com/typora/20260129095458001.png" alt="image-20260129095457952" loading="lazy"/></p>
<hr/>
<p>接下来会进入模型和鉴权方式的选择，这里可以看到支持的模型非常多，包括 OpenAI、Qwen、MiniMax、Google、Copilot 等。<br/>
因为 Clawdbot 是一个常驻的 AI 助手，随时可能被调用，实际使用过程中对 token 的消耗会比较明显，所以如果只是长期挂着用，选择一些 <strong>免费或成本较低的模型</strong>（比如通义千问这一类）其实也完全没问题。<br/>
我这边本身有 <strong>ChatGPT Plus</strong>，主要也是为了体验 OpenAI 这条链路，所以这里直接选择了 <strong>OpenAI</strong> 作为模型来源。
<img src="https://typora.luokakale.com/typora/20260129095603277.png" alt="image-20260129095603225" loading="lazy"/></p>
<p>这里我选择OpenAI后 我选择OpenAI Codex 来进行ChatGPT OAuth授权</p>
<p><img src="https://typora.luokakale.com/typora/20260129095617412.png" alt="image-20260129095617361" loading="lazy"/></p>
<p>选中后会弹出提示使用ChatGPT 登录到Codex确认页面。</p>
<p><img src="https://typora.luokakale.com/typora/20260129095722415.png" alt="image-20260129095722356" loading="lazy"/></p>
<p>我们点击继续后 会弹出授权成功，然后我们复制地址栏回调地址到我们的命令窗口</p>
<p><img src="https://typora.luokakale.com/typora/20260129095741094.png" alt="image-20260129095741036" loading="lazy"/></p>
<p>这里我们在命令窗口黏贴我们上面授权成功的回调地址后就成了，然后就是选择使用哪个模型，这里我是保持使用gpt-5.2</p>
<p><img src="https://typora.luokakale.com/typora/20260129095935818.png" alt="image-20260129095935750" loading="lazy"/></p>
<p>接下来是聊天渠道的选择，Clawdbot 默认支持的渠道非常多，包括 Telegram、WhatsApp、Discord、Slack 等。<br/>
因为本文后面会单独介绍 <strong>飞书（Lark）</strong> 的配置方式，而飞书并不在这个 QuickStart 列表里，所以这里我们先<strong>不选择任何聊天渠道</strong>，直接选最下面的 <strong><code>Skip for now</code></strong>，先把基础环境跑起来，后续再手动配置飞书即可。
<img src="https://typora.luokakale.com/typora/20260129100047510.png" alt="image-20260129100047432" loading="lazy"/></p>
<p>接下来会询问是否要现在配置 Skills（技能）。这里可以理解为一些额外的自动化能力和扩展功能，但并不是安装和基础聊天所必需的内容。<br/>
为了先把整体流程跑通、减少干扰，这里我们<strong>直接选择 <code>No</code></strong>，后面如果有需要，再单独开启和配置即可。
<img src="https://typora.luokakale.com/typora/20260129100152734.png" alt="image-20260129100152655" loading="lazy"/></p>
<p>接下来是 Hooks 的配置，这里主要是一些用于自动化的小钩子，比如在特定指令触发时自动记录会话、保存上下文之类的功能。<br/>
这些能力对后续深度使用会比较有帮助，但并不是基础聊天或接入飞书所必需的内容。为了先把主流程走完，这里我们同样<strong>选择 <code>Skip for now</code></strong>，然后按空格键确认。后面有需要再单独开启即可。
<img src="https://typora.luokakale.com/typora/20260129100217401.png" alt="image-20260129100217324" loading="lazy"/>
<img src="https://typora.luokakale.com/typora/20260129100452586.png" alt="image-20260129100452502" loading="lazy"/></p>
<p>最后会询问以哪种方式启动（hatch）这个 bot，这里提供了终端交互（TUI）、Web 界面以及稍后再说三种方式。<br/>
因为我们接下来还要继续做飞书相关的配置，不急着马上启动交互界面，所以这里<strong>直接选择 <code>Do this later</code></strong>，先完成初始化流程，后续需要用的时候再手动启动即可。
<img src="https://typora.luokakale.com/typora/20260129100539236.png" alt="image-20260129100539148" loading="lazy"/></p>
<hr/>
<p>安装完成后，可以通过下面这个命令查看 Clawdbot 当前的运行状态：</p>
<pre><code class="hljs language-bash" lang="bash">clawdbot status
</code></pre>
<p>执行后会看到一份状态汇总信息，主要用来确认几件事：<br/>
服务是否已经正常启动、本地 Gateway 有没有跑起来、Dashboard 是否可以访问，以及当前使用的模型和会话状态。</p>
<p>如果像我这样能看到本地 <code>127.0.0.1</code> 的 Dashboard 地址，并且状态显示为 running，基本就说明安装和初始化都是正常的，可以继续往下折腾了。</p>
<p><img src="https://typora.luokakale.com/typora/20260129101023173.png" alt="image-20260129101023074" loading="lazy"/></p>
<hr/>
<p>接下来我们简单测试一下 Clawdbot 是否真的已经跑起来了。</p>
<p>直接在终端里执行：</p>
<pre><code class="hljs language-bash" lang="bash">clawdbot tui
</code></pre>
<p>会进入一个类似聊天窗口的界面，随便输入一句话或者一个简单指令。如果像上图这样能够正常收到回复，说明 Clawdbot 已经可以正常工作了，整个安装和基础配置也算完成。
<img src="https://typora.luokakale.com/typora/20260129101449801.png" alt="image-20260129101449696" loading="lazy"/></p>
<p>到这里为止，其实我们已经有了一个能对话、能响应的本地 AI 助手，后面要做的事情，就是把它接入到飞书里，用聊天的方式来用它。</p>
<hr/>
<h3 data-id="heading-7">飞书侧准备：创建企业自建应用</h3>
<p>接下来我们开始配置飞书相关流程。<br/>
第一步，先到飞书开放平台创建一个应用。</p>
<p>打开飞书开放平台：<a href="https://link.juejin.cn?target=https%3A%2F%2Fopen.feishu.cn%2Fapp" target="_blank" title="https://open.feishu.cn/app" ref="nofollow noopener noreferrer">open.feishu.cn/app</a><br/>
进入后，切换到 <strong>「企业自建应用」</strong> 页面，点击 <strong>「创建企业自建应用」</strong>。<br/>
这里创建的是企业内部使用的应用，刚好符合我们把 Clawdbot 接入飞书做个人/团队助手的场景。
<img src="https://typora.luokakale.com/typora/20260129111019748.png" alt="image-20260129111019581" loading="lazy"/></p>
<p><img src="https://typora.luokakale.com/typora/20260129111113877.png" alt="image-20260129111113730" loading="lazy"/></p>
<p>创建好企业自建应用后，进入应用详情页，在 <strong>「凭证与基础信息」</strong> 页面中，就可以看到应用的 <strong>AppID</strong> 和 <strong>AppSecret</strong>。</p>
<p><img src="https://typora.luokakale.com/typora/20260129111156987.png" alt="image-20260129111156832" loading="lazy"/></p>
<p>这两个值是后面 Clawdbot 接入飞书时必须用到的身份凭证，记得先复制保存好，<strong>不要泄露给其他人</strong>。<br/>
接下来我们会把这两个参数配置到 Clawdbot 中，用来完成飞书侧的身份校验。</p>
<hr/>
<h3 data-id="heading-8">安装并配置 Clawdbot 飞书插件</h3>
<p>前面飞书应用已经创建好，也拿到了 <strong>AppID</strong> 和 <strong>AppSecret</strong>，接下来我们就可以开始配置 Clawdbot 这边了。</p>
<h4 data-id="heading-9">安装飞书插件</h4>
<p>首先安装 Clawdbot 的飞书插件，直接执行下面这条命令即可：</p>
<pre><code class="hljs language-bash" lang="bash">clawdbot plugins install @m1heng-clawd/feishu
</code></pre>
<p>安装过程如果没有报错，基本就说明插件已经就位了。
<img src="https://typora.luokakale.com/typora/20260129111715728.png" alt="image-20260129111715554" loading="lazy"/></p>
<h4 data-id="heading-10">配置飞书应用信息</h4>
<p>接下来把刚才在飞书后台拿到的 <strong>AppID</strong> 和 <strong>AppSecret</strong> 配置到 Clawdbot 中：</p>
<pre><code class="hljs language-arduino" lang="arduino">clawdbot config set channels.feishu.appId <span class="hljs-string">"你的AppID"</span>
clawdbot config set channels.feishu.appSecret <span class="hljs-string">"你的AppSecret"</span>
</code></pre>
<p>然后启用飞书这个 channel：</p>
<pre><code class="hljs language-arduino" lang="arduino">clawdbot config set channels.feishu.enabled <span class="hljs-literal">true</span>
</code></pre>
<p>上面的配置修改完成后，需要重启一次 Gateway 才会真正生效：</p>
<pre><code class="hljs">clawdbot gateway restart
</code></pre>
<p>到这里，Clawdbot 这一侧的飞书插件就算配置完成了，后面只需要在飞书里验证消息是否能正常收发即可。</p>
<p><img src="https://typora.luokakale.com/typora/20260129112009038.png" alt="image-20260129112008889" loading="lazy"/></p>
<h4 data-id="heading-11">如何确认飞书已经配置成功？</h4>
<p>飞书插件配置完成并重启 Gateway 之后，我们需要确认 <strong>Clawdbot 这边是否已经成功连上飞书</strong>。<br/>
最直接的方式就是查看实时日志。</p>
<p>在终端执行下面这条命令：</p>
<pre><code class="hljs language-css" lang="css">clawdbot logs <span class="hljs-attr">--follow</span>
</code></pre>
<p>如果日志中能看到类似下面这样的内容（如图所示）：
<img src="https://typora.luokakale.com/typora/20260129112108593.png" alt="image-20260129112108431" loading="lazy"/></p>
<p>说明 Clawdbot 已经成功启动了飞书通道，并且通过 <strong>WebSocket 长连接</strong> 等待飞书事件回调。</p>
<p>这一步出现这些日志，就可以基本确认：<br/>
<strong>Clawdbot 这一侧的飞书配置是 OK 的</strong></p>
<p>接下来要做的，就是回到 <strong>飞书开放平台</strong>，继续配置应用权限、事件订阅等内容，让飞书真正把消息推送过来。</p>
<h4 data-id="heading-12">在飞书开放平台配置应用权限</h4>
<p>前面 Clawdbot 和飞书插件我们已经跑起来了，但这一步<strong>非常关键</strong>：<br/>
不配置权限，机器人是<strong>收不到消息、也发不了消息的</strong>。</p>
<p>下面我们回到 <strong>飞书开放平台 → 当前应用 → 权限管理</strong>。
<img src="https://typora.luokakale.com/typora/20260129112534160.png" alt="image-20260129112533987" loading="lazy"/></p>
<h4 data-id="heading-13">使用 JSON 批量导入权限</h4>
<p>在权限管理页面，点击 <strong>「批量导入/导出权限」</strong>，选择 <strong>JSON 导入</strong>，把下面这段配置完整粘贴进去：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"scopes"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"tenant"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
      <span class="hljs-string">"im:message.group_msg"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-string">"im:message.p2p_msg:readonly"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-string">"im:message.reactions:read"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-string">"im:message:readonly"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-string">"im:message:recall"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-string">"im:message:send_as_bot"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-string">"im:message:update"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-string">"im:resource"</span><span class="hljs-punctuation">,</span>

      <span class="hljs-string">"contact:user.base:readonly"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-string">"contact:contact.base:readonly"</span>
    <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"user"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
      <span class="hljs-string">"docx:document:readonly"</span>
    <span class="hljs-punctuation">]</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p><strong>这些权限是干什么用的</strong></p>
<p>简单说一下我们这些到底给了机器人什么能力：</p>
<ul>
<li>
<p><strong>消息相关</strong></p>
<ul>
<li>读取群聊和单聊消息</li>
<li>以机器人的身份发送消息</li>
<li>更新、撤回消息</li>
<li>读取消息里的表情、图片、文件等资源</li>
</ul>
</li>
<li>
<p><strong>事件相关</strong></p>
<ul>
<li>接收群聊中 @ 机器人的事件（这是机器人能被“叫醒”的关键）</li>
</ul>
</li>
<li>
<p><strong>通讯录相关</strong></p>
<ul>
<li>获取用户和通讯录的基础信息</li>
</ul>
</li>
<li>
<p><strong>文档相关</strong></p>
<ul>
<li>读取用户的飞书文档（后面做文章流、内容处理会用到）</li>
</ul>
</li>
</ul>
<p>这些权限基本是「能正常做一个飞书机器人」的最低配置。</p>
<h4 data-id="heading-14">确认并导入权限配置</h4>
<p>前面把权限 JSON 粘贴进去之后，点击 <strong>「下一步，确认新增权限」</strong> 就可以了。</p>
<p>我们会看到一个确认页，如图所示，列出了这次新增的权限列表。这里主要确认两点就行：</p>
<ul>
<li>应用身份权限里，消息、通讯录、资源相关的权限都在</li>
<li>用户身份权限里，有文档只读权限
<img src="https://typora.luokakale.com/typora/20260129113023462.png" alt="image-20260129113023297" loading="lazy"/></li>
</ul>
<p><img src="https://typora.luokakale.com/typora/20260129113322992.png" alt="image-20260129113322772" loading="lazy"/></p>
<p><img src="https://typora.luokakale.com/typora/20260129113406267.png" alt="image-20260129113406094" loading="lazy"/></p>
<p>如果这些都在，直接点 <strong>「申请开通」</strong>。</p>
<p>这时候页面顶部一般会提示一句话：</p>
<blockquote>
<p>应用发布后，当前配置方可生效</p>
</blockquote>
<p>这个不用慌，是飞书的正常流程。意思是：</p>
<ul>
<li>权限<strong>已经配置成功</strong></li>
<li>但还没有真正生效</li>
<li>需要后面 <strong>创建版本并发布应用</strong>，权限才会下发给这个应用</li>
</ul>
<p>所以到这里为止，<strong>权限配置这一步就算完成了</strong>。</p>
<hr/>
<h4 data-id="heading-15">配置飞书事件（接收消息）</h4>
<p>接下来需要配置飞书的事件回调。</p>
<p>在飞书开放平台里，进入左侧的「事件与回调」页面，先做事件配置。<br/>
订阅方式这里选择 <strong>使用长连接接收事件</strong>，这个方式不需要额外配置回调地址，和 Clawdbot 的工作方式是匹配的。选好之后直接点击保存。
<img src="https://typora.luokakale.com/typora/20260129113622363.png" alt="image-20260129113622145" loading="lazy"/></p>
<p>保存完成后，点击下面的「添加事件」按钮，在事件列表里找到 <strong>接收消息</strong>，勾选这一项，然后确认添加。</p>
<p><img src="https://typora.luokakale.com/typora/20260129113810247.png" alt="image-20260129113810037" loading="lazy"/></p>
<p>做到这一步，飞书在有人给机器人发消息时，就会把事件通过长连接推送给 Clawdbot，后面我们才能正常接收和处理消息。</p>
<h4 data-id="heading-16">发布应用</h4>
<p>前面的权限和事件都配置完成后，最后一步就是发布应用。</p>
<p>在左侧进入「版本管理与发布」，点击创建版本，填写版本号和更新说明。<br/>
移动端和桌面端的默认能力都选择「机器人」，保持默认即可。
<img src="https://typora.luokakale.com/typora/20260129113940867.png" alt="image-20260129113940671" loading="lazy"/></p>
<p>确认信息无误后，直接提交并发布。<br/>
如果页面提示“本次发布免审核，提交发布后即可上线使用”，说明这是企业自建应用，发布完成后权限和事件会立刻生效。</p>
<p>到这里，飞书侧的配置就全部完成了，机器人已经可以正常接收和回复消息了。</p>
<hr/>
<h3 data-id="heading-17">测试飞书聊天是否正常</h3>
<p>应用发布完成后，我们回到飞书客户端，直接和刚创建的机器人私聊即可。
<img src="https://typora.luokakale.com/typora/20260129120519655.png" alt="image-20260129120519327" loading="lazy"/></p>
<p>像图里这样，给机器人发一条普通消息，如果机器人能够正常回复，说明三件事都已经生效了：</p>
<ul>
<li>飞书应用已经成功发布</li>
<li>事件订阅（接收消息）配置正确</li>
<li>Clawdbot 本地服务和飞书通道已经连通</li>
</ul>
<p>只要能正常对话，说明整个飞书接入流程已经跑通，后面就可以开始接具体的自动化流程或业务逻辑了。</p>
<hr/>
<h3 data-id="heading-18">测试 Clawdbot 的本地自动化能力</h3>
<p>前面只是确认机器人能不能聊天，这一步我们来真正测一下 Clawdbot 能干什么。</p>
<p>在飞书聊天窗口里，直接对机器人输入一条指令，比如：</p>
<blockquote>
<p>帮我打开 ToDesk 远程工具</p>
</blockquote>
<p>如果配置正常，Clawdbot 会在本地自动执行这个动作，我们会看到 Mac 上的 ToDesk 应用被直接唤起，就像我们自己点开了一样。
<img src="https://typora.luokakale.com/typora/20260129122223815.gif" alt="output" loading="lazy"/></p>
<p>这个测试主要是为了确认两件事：</p>
<ul>
<li>飞书消息已经能正确传到本地的 Clawdbot</li>
<li>Clawdbot 已经具备执行本地指令、控制电脑的能力</li>
</ul>
<p>只要这一步能跑通，后面不管是打开应用、执行脚本，还是做更复杂的自动化流程，本质上都是在这个基础上往上叠功能。</p>
<hr/>
<h3 data-id="heading-19">那这个东西到底能干什么？</h3>
<p>前面我们已经试过了，一句话就能把本地的 ToDesk 打开。<br/>
看到这里，其实就能大概明白 Clawdbot 的定位了。</p>
<p>它不是用来聊天的，而是用来<strong>接管一些日常操作</strong>的。</p>
<p>从使用场景上看，我觉得大概可以分成几类。</p>
<p>第一类，是<strong>替代重复点击</strong>。<br/>
像打开某个软件、进入固定网站、启动一套常用工具，这些每天都会做，但又不值得专门写脚本的事情，都可以直接用一句话完成。</p>
<p>第二类，是<strong>固定流程的触发器</strong>。<br/>
平时有一整套顺序操作，比如连远程、起服务、看状态，不需要一步一步点，只要一句指令，剩下的交给它执行。</p>
<p>第三类，是<strong>个人习惯型操作</strong>。<br/>
有些动作只有自己知道，比如写东西前、下班前、排查问题时的一套固定操作，这些不通用，但很适合交给 Clawdbot记住。</p>
<p>整体来看，它更像是一个<strong>听得懂人话、又能真的去做事的工具</strong>。<br/>
不是回答问题，而是接收指令、执行动作。</p>
<p>也正因为这样，前面才需要配置插件、权限和事件。<br/>
这些都准备好之后，Clawdbot 才真正“进到系统里”。</p>
<hr/>
<h3 data-id="heading-20">写在最后</h3>
<p>到这里，Clawdbot 加飞书的整个流程我们基本就跑通了。<br/>
从下载安装到权限、事件配置，再到能在飞书里发消息、在本地执行操作，整体体验还是比较顺的。</p>
<p>需要注意的一点是，这种常驻型的 AI 助手，<strong>对模型调用是持续发生的</strong>，不像平时在网页里偶尔问几句。<br/>
如果接入的是按量计费的模型，实际使用时还是要留意一下 token 消耗，避免后台一直跑着却没注意到费用变化。</p>
<p>目前我这边更多还是把它当成个人助手来用，在自己可控的环境里慢慢试，先摸清楚边界和成本，再决定要不要接到更正式的场景里。</p>
<p>整体来看，这套东西更适合愿意折腾、也清楚自己在干什么的人。<br/>
至于值不值得上，还是看自己的使用习惯和场景哈。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[用skills做了一个AI语音助手，可呼唤AI语音军团帮我干活了]]></title>    <link>https://juejin.cn/post/7600326947505684532</link>    <guid>https://juejin.cn/post/7600326947505684532</guid>    <pubDate>2026-01-29T04:30:39.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600326947505684532" data-draft-id="7600345782172680226" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="用skills做了一个AI语音助手，可呼唤AI语音军团帮我干活了"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2026-01-29T04:30:39.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="500佰"/> <meta itemprop="url" content="https://juejin.cn/user/3182441343757755"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            用skills做了一个AI语音助手，可呼唤AI语音军团帮我干活了
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3182441343757755/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    500佰
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-29T04:30:39.000Z" title="Thu Jan 29 2026 04:30:39 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cfd80ed077ed4f419d18a3730bebbc83~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgNTAw5L2w:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770265842&amp;x-signature=OHuyePu7T%2BVuM5QUwHXeVuPaJT4%3D" alt="image-20260129000515998.png" loading="lazy"/></p>
<p>语音助手，我一直想自己拥有一个。</p>
<p>近期，浏览到语音输入动向，智谱AutoGLM、还有typeless语音助手，闪电的语音识别能力，于是自己动手vb coding了一个<code>语音助手</code>出来。</p>
<p>究其重点，我这个语音助手识别的速度和准确率一点也不输给AutoGLM。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/99c5fda463d44dd1a4883e5cca55e2d8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgNTAw5L2w:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770265842&amp;x-signature=fK%2B3G3TTuMpl%2FAwyb4pEitO4LCE%3D" alt="PixPin_2026-01-29_02-49-05.gif" loading="lazy"/></p>
<p>折腾了三个晚上，先借助了opencode的里面的skills来<code>制定产品规格文档</code>和UI设计，关于AI开发流程控制的4个skills可追<a href="https://juejin.cn/post/7597083743555813419" target="_blank" title="https://juejin.cn/post/7597083743555813419">AI 开发必用的4个skills组合，用来流畅掌控AI开发流程 ，灵活控制AI（opencode skills） </a>，这篇文章skills领取的人数已经超过<code>90位</code>了，非常推荐去使用这个4个skills指令式的去和AI进行高效对话。</p>
<p>然后，<code>语音桌面控制</code>和语音输入文字插入文档，这个两个功能借助的<code>Antigravity</code>编辑器去开发，近期还能使用Gemini 3 Flash、Claude Opus等强大模型。</p>
<p>后端部分，借助了科大讯飞语音识别API的Java实现，主要用于中文语音识别。提供HTTP服务器接口接收音频数据，直接处理音频文件的识别。</p>
<blockquote>
<p>语音助手我已经打包好了，一键安装即可，想试玩或语音输入党可后台发送语音助手，我可分享，提供语音APIkey。</p>
</blockquote>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/403e7be9e09c4ff7bdf0bbc30fdb6ef4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgNTAw5L2w:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770265842&amp;x-signature=IcxUoqs2BSY38RI2JFGECvC42N8%3D" alt="" loading="lazy"/></p>
<h4 data-id="heading-0">01 全局语音唤醒</h4>
<p>全局语音唤醒，<code>Right Ctrl</code>键唤醒语音助手，长按即说，松开即执行，即便输入了很长的一段话，1秒就能将语音闪电般转换为文字，下面是我进行的一些语音对话记录（连续语音对话），语音识别正确率80%+。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6766cd9f71e04568a63d8927b7345b0e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgNTAw5L2w:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770265842&amp;x-signature=fyyIwTCzGmgjltDPY3SdyQf%2BitI%3D" alt="image-20260129004823972.png" loading="lazy"/></p>
<h4 data-id="heading-1">02 语音桌面控制</h4>
<p><code>语音桌面控制</code>，核心不再手动配置应用路径，而动态扫描 Windows 开始菜单，支持所有桌面软件（.exe）和 <code>UWP</code> （应用商店应用）。</p>
<p>桌面应用启动，我通常工作时需要开启的桌面应用较多（写文档、微信、聊天、IDE、浏览器），有时候脑子空白时，通过语音助手能快速启动应用，特别对于桌面一团糟的人来说，就能提高查找效率，也能直接在当前的窗口，<code>直接唤起语音呼叫应用</code>的到来。</p>
<p>我增加了智能容错匹配，即便语音识别出同音字、缩写，或者加上了软件、应用等修词，语音助手也能精准找到目标桌面应用，精准<code>启动我们的桌面应用</code>。关闭功能我暂时删除了，关闭对于多数人来说，不如手动点击关闭，来得更痛快。</p>
<p>启动之前会提示确认/取消，enter一键确认启动。如果3秒超时未确认，则会自动取消。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7049f9cac3a44fc7ba617d50a10c4ee6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgNTAw5L2w:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770265842&amp;x-signature=LVxPsHBXjOglqxSLaNmMaPl5qVc%3D" alt="image-20260129011403665.png" loading="lazy"/></p>
<p>精确/变体匹配，先将语音识别出的文字进行去除空格、取首个单词等变形，尝试与系统 App 列表直接比对。如果第一步失败，会计算两个字符串之间的字符重叠比例。比如Focus See录屏软件，语音听成了Focus C 也能精确匹配到。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cca1a9b22a314b6eb3b8cdc7741b4e47~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgNTAw5L2w:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770265842&amp;x-signature=UchfsBqkBULmEMDZhAhpofgSfJc%3D" alt="PixPin_2026-01-29_03-07-28.gif" loading="lazy"/>
如果想语言丰富一些，比如 [ <code>你好你好，请启动Cursor</code> ]，也是可行的。下面是我写文超时取消了启动，我另外语音启动时的截图，启动时会自动模糊匹配应用的AppID。</p>
<blockquote>
<p>你好你好，请启动Cursor</p>
</blockquote>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d18e3ad7e0ca4a84ac090c2282c5334a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgNTAw5L2w:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770265842&amp;x-signature=jxr08r2VN6HVg6AOs6lA%2BjgGl6M%3D" alt="image-20260129012021646.png" loading="lazy"/></p>
<blockquote>
<p>正在发送识别请求...<br/>
识别结果: 你好你好，我的助手请启动Cursor。<br/>
正在执行: { action: 'start', app: 'Cursor' }<br/>
[模糊查询] 匹配成功: "Cursor" -&gt; Cursor<br/>
找到应用 AppID: Anysphere.Cursor</p>
</blockquote>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/75cc435a3e794171bc9e276ecf1251e6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgNTAw5L2w:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770265842&amp;x-signature=Y%2FcG5ytngQga%2FftwiGE2S9MqDe0%3D" alt="image-20260129012729971.png" loading="lazy"/></p>
<h4 data-id="heading-2">写在最后</h4>
<p>敲一下键盘就偷偷开始录音（PCM格式），利用 node-global-key-listener 监听键盘，它会不停轮询信号文件，发现文件存在就调用开始捕获麦克风数据，发现文件消失就停止把说的话实时丢给后端做语音转文字，后端识别完以后用 JS 正则表达式抓出指令，再交给 executeAppCommand 去执行，从键盘触发录音到语音指令执行的自动化流程，想想就挺丝滑的。</p>
<blockquote>
<p>语音助手我已经打包好了，一键安装即可，想试玩或语音输入党可后台发<code>送语音助手</code>，我可分享，提供语音APIkey。</p>
<p>关注我，获取更多编程/AI实战教程！</p>
<p>vx： <code>Auwubai</code> 添加，入AI技术动向社群，我们一起卷卷AI。</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[go公链实战0x06转账(1)]]></title>    <link>https://juejin.cn/post/7600318091831836699</link>    <guid>https://juejin.cn/post/7600318091831836699</guid>    <pubDate>2026-01-29T05:23:08.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600318091831836699" data-draft-id="6845075572612153352" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="go公链实战0x06转账(1)"/> <meta itemprop="keywords" content="区块链,Go"/> <meta itemprop="datePublished" content="2026-01-29T05:23:08.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="chaors"/> <meta itemprop="url" content="https://juejin.cn/user/272334613646695"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            go公链实战0x06转账(1)
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/272334613646695/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    chaors
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-29T05:23:08.000Z" title="Thu Jan 29 2026 05:23:08 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读10分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>上次基本实现了交易的数据结构,在此基础上便可以来实现转账,即区块链的普通交易.</p>
<h3 data-id="heading-0">cli转账命令</h3>
<p>我们知道挖矿的目的是找到一个公认的记账人把当前的所有交易打包到区块并添加到区块链上.之前我们使用addBlock命令实现添加区块到区块链的,这里转账包含挖矿并添加到区块链.所以,我们需要在cli工具类里用转账命令send代替addBlock命令.</p>
<p>其次我们都知道,一次区块可以包括多个交易.因此,这里我们的转账命令要设计成支持多笔转账.</p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-comment">//命令说明方法 打印目前左右命令使用方法</span>
<span class="hljs-keyword">func</span> <span class="hljs-title function_">printUsage</span>() {
	fmt.<span class="hljs-type">Println</span>(<span class="hljs-string">"Usage:"</span>)
	fmt.<span class="hljs-type">Println</span>(<span class="hljs-string">"<span class="hljs-subst">\t</span>createBlockchain -address --创世区块地址 "</span>)
	fmt.<span class="hljs-type">Println</span>(<span class="hljs-string">"<span class="hljs-subst">\t</span>send -from FROM -to TO -amount AMOUNT --交易明细"</span>)
	fmt.<span class="hljs-type">Println</span>(<span class="hljs-string">"<span class="hljs-subst">\t</span>printchain --打印所有区块信息"</span>)
	fmt.<span class="hljs-type">Println</span>(<span class="hljs-string">"<span class="hljs-subst">\t</span>getbalance -address -- 输出区块信息."</span>)
}
</code></pre>

<pre><code class="hljs language-scss" lang="scss">func (cli *CLI) <span class="hljs-built_in">Run</span>() {

	<span class="hljs-built_in">isValidArgs</span>()

	<span class="hljs-comment">//自定义cli命令</span>
	<span class="hljs-comment">//转账</span>
	sendBlockCmd := flag.<span class="hljs-built_in">NewFlagSet</span>(<span class="hljs-string">"send"</span>, flag.ExitOnError)
	printchainCmd := flag.<span class="hljs-built_in">NewFlagSet</span>(<span class="hljs-string">"printchain"</span>, flag.ExitOnError)
	createBlockchainCmd := flag.<span class="hljs-built_in">NewFlagSet</span>(<span class="hljs-string">"createBlockchain"</span>, flag.ExitOnError)
	blanceBlockCmd := flag.<span class="hljs-built_in">NewFlagSet</span>(<span class="hljs-string">"getBalance"</span>, flag.ExitOnError)

	//addBlockCmd 设置默认参数
	flagSendBlockFrom := sendBlockCmd.<span class="hljs-built_in">String</span>(<span class="hljs-string">"from"</span>, <span class="hljs-string">""</span>, <span class="hljs-string">"源地址"</span>)
	flagSendBlockTo := sendBlockCmd.<span class="hljs-built_in">String</span>(<span class="hljs-string">"to"</span>, <span class="hljs-string">""</span>, <span class="hljs-string">"目标地址"</span>)
	flagSendBlockAmount := sendBlockCmd.<span class="hljs-built_in">String</span>(<span class="hljs-string">"amount"</span>, <span class="hljs-string">""</span>, <span class="hljs-string">"转账金额"</span>)
	flagCreateBlockchainAddress := createBlockchainCmd.<span class="hljs-built_in">String</span>(<span class="hljs-string">"address"</span>, <span class="hljs-string">""</span>, <span class="hljs-string">"创世区块地址"</span>)
	flagBlanceBlockAddress := blanceBlockCmd.<span class="hljs-built_in">String</span>(<span class="hljs-string">"address"</span>, <span class="hljs-string">""</span>, <span class="hljs-string">"输出区块信息"</span>)

	//解析输入的第二个参数是addBlock还是printchain，第一个参数为./main
	switch os.Args[<span class="hljs-number">1</span>] {
	case "send":
		//第二个参数为相应命令，取第三个参数开始作为参数并解析
		err := sendBlockCmd.<span class="hljs-built_in">Parse</span>(os.Args[<span class="hljs-number">2</span>:])
		if err != nil {
			log<span class="hljs-selector-class">.Panic</span>(err)
		}
	case "printchain":
		err := printchainCmd.<span class="hljs-built_in">Parse</span>(os.Args[<span class="hljs-number">2</span>:])
		if err != nil {
			log<span class="hljs-selector-class">.Panic</span>(err)
		}
	case "createBlockchain":
		err := createBlockchainCmd.<span class="hljs-built_in">Parse</span>(os.Args[<span class="hljs-number">2</span>:])
		if err != nil {
			log<span class="hljs-selector-class">.Panic</span>(err)
		}
	case "getBalance":
		err := blanceBlockCmd.<span class="hljs-built_in">Parse</span>(os.Args[<span class="hljs-number">2</span>:])
		if err != nil {
			log<span class="hljs-selector-class">.Panic</span>(err)
		}
	default:
		<span class="hljs-built_in">printUsage</span>()
		os.<span class="hljs-built_in">Exit</span>(<span class="hljs-number">1</span>)
	}

	<span class="hljs-comment">//对addBlockCmd命令的解析</span>
	if sendBlockCmd<span class="hljs-selector-class">.Parsed</span>() {

		if *flagSendBlockFrom == "" {

			<span class="hljs-built_in">printUsage</span>()
			os<span class="hljs-selector-class">.Exit</span>(<span class="hljs-number">1</span>)
		}
		if *flagSendBlockTo == "" {

			<span class="hljs-built_in">printUsage</span>()
			os<span class="hljs-selector-class">.Exit</span>(<span class="hljs-number">1</span>)
		}
		if *flagSendBlockAmount == "" {

			<span class="hljs-built_in">printUsage</span>()
			os<span class="hljs-selector-class">.Exit</span>(<span class="hljs-number">1</span>)
		}

		<span class="hljs-comment">//cli.addBlock(*flagAddBlockData)</span>

		<span class="hljs-comment">//这里真正地调用转账方法</span>
		<span class="hljs-comment">//fmt.Println(*flagSendBlockFrom)</span>
		<span class="hljs-comment">//fmt.Println(*flagSendBlockTo)</span>
		<span class="hljs-comment">//fmt.Println(*flagSendBlockAmount)</span>
		<span class="hljs-comment">//</span>
		<span class="hljs-comment">//fmt.Println(Json2Array(*flagSendBlockFrom))</span>
		<span class="hljs-comment">//fmt.Println(Json2Array(*flagSendBlockTo))</span>
		<span class="hljs-comment">//fmt.Println(Json2Array(*flagSendBlockAmount))</span>
		cli<span class="hljs-selector-class">.send</span>(
			Json2Array(*flagSendBlockFrom),
			<span class="hljs-built_in">Json2Array</span>(*flagSendBlockTo),
			<span class="hljs-built_in">Json2Array</span>(*flagSendBlockAmount),
			)
	}
	<span class="hljs-comment">//对printchainCmd命令的解析</span>
	if printchainCmd<span class="hljs-selector-class">.Parsed</span>() {

		cli<span class="hljs-selector-class">.printchain</span>()
	}
	<span class="hljs-comment">//</span>
	if createBlockchainCmd<span class="hljs-selector-class">.Parsed</span>() {

		if *flagCreateBlockchainAddress == "" {

			cli<span class="hljs-selector-class">.creatBlockchain</span>(*flagCreateBlockchainAddress)
		}

		cli<span class="hljs-selector-class">.creatBlockchain</span>(*flagCreateBlockchainAddress)
	}

	if blanceBlockCmd<span class="hljs-selector-class">.Parsed</span>() {

		if *flagBlanceBlockAddress == "" {

			<span class="hljs-built_in">printUsage</span>()
			os<span class="hljs-selector-class">.Exit</span>(<span class="hljs-number">1</span>)
		}

		cli<span class="hljs-selector-class">.getBlance</span>(*flagBlanceBlockAddress)
	}
}
</code></pre>
<h3 data-id="heading-1">Json2Arr</h3>
<p>命令行输入的都是字符串,要想让转账命令支持多笔转账,则输入的信息是json形式的数组.在编码实现解析并转账的时候,我们需要将Json字符串转化为数组类型.这个功能在utils里实现.</p>
<p>我们一般输入的转账命令是这样的:</p>
<pre><code class="hljs language-css" lang="css">send -<span class="hljs-selector-tag">from</span> '<span class="hljs-selector-attr">[<span class="hljs-string">"chaors"</span>, <span class="hljs-string">"ww"</span>]</span>' -<span class="hljs-selector-tag">to</span> '<span class="hljs-selector-attr">[<span class="hljs-string">"xyz"</span>, <span class="hljs-string">"dh"</span>]</span>' -amount '<span class="hljs-selector-attr">[<span class="hljs-string">"5"</span>, <span class="hljs-string">"100"</span>]</span>'
</code></pre>
<blockquote>
<p>send       转账命令
from       发送方
to           接收方
amount  转账金额
三个参数的数组分别一一对应,上述命令表示:
chaors转给xyx共5btc;
ww转给dh的100btc.</p>
</blockquote>
<p>utils.go</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-comment">// 标准的JSON字符串转数组</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">Json2Array</span><span class="hljs-params">(jsonString <span class="hljs-type">string</span>)</span></span> []<span class="hljs-type">string</span> {

	<span class="hljs-comment">//json 到 []string</span>
	<span class="hljs-keyword">var</span> sArr []<span class="hljs-type">string</span>
	<span class="hljs-keyword">if</span> err := json.Unmarshal([]<span class="hljs-type">byte</span>(jsonString), &amp;sArr); err != <span class="hljs-literal">nil</span> {

		log.Panic(err)
	}
	<span class="hljs-keyword">return</span> sArr
}
</code></pre>
<h3 data-id="heading-2">转账的理解</h3>
<p>说到转账,就离不开交易.这里的转账便是普通交易,之前我们只实现了创币交易.这里需要实现普通交易.</p>
<p>为了更好地理解转账的过程,我们先将复杂问题简单化.假设每一个区块只有一笔交易,我们看一个简单的小🌰.</p>
<p>1.节点chaors挖到一个区块，产生25BTC的创币交易。由于是创币交易，其本身是不需要引用任何交易输出的，所以在输入对象TXInput的交易哈希为空，vount所在的下标为-1，数字签名为空或者随便填写；输出对象里btc拥有者为chaors，面值为25btc  创世区块交易结构</p>
<pre><code class="hljs language-ini" lang="ini"> <span class="hljs-attr">txInput0</span> = &amp;TXInput{[]byte{},-<span class="hljs-number">1</span>,<span class="hljs-string">"Gensis Block"</span>}
 <span class="hljs-attr">txOutput0</span> = &amp;TXOutput{<span class="hljs-number">25</span>, <span class="hljs-string">"chaors"</span>}  //在gaVouts索引为<span class="hljs-number">0</span>

 CoinbaseTransaction{"00000",
			<span class="hljs-section">[]</span>*TXInput{txInput0},
			<span class="hljs-section">[]</span>*TXOutput{txOutput0}
}
</code></pre>
<p>2.chaors获得25btc后，他的好友ww知道后向他索要10btc.大方的chaors便把10btc转给ww.此时
交易的输入为chaors上笔交易获得的btc,TXInput对象的交易ID为奖励chaors的上一个交易ID，vount下标为chaors的TXOutput下标，签名此时且认为是来自chaors，填作"chaors" 此时chaors的25btc面值的TXOutput就被花费不复存在了，那么chaors还应该有15btc的找零哪去了？系统会为chaors的找零新生成一个面值15btc的TXOutput。所以，这次有一个输入，两个输出。</p>
<blockquote>
<p>chaors(25) 给 ww 转 10 -- &gt;&gt;  chaors(15) + ww(10)</p>
</blockquote>
<p>这次的交易结构为:</p>
<pre><code class="hljs language-ini" lang="ini"> //输入
 <span class="hljs-attr">txInput1</span> = &amp;TXInput{<span class="hljs-string">"00000"</span>,<span class="hljs-number">0</span>,<span class="hljs-string">"chaors"</span>}
 //"00000" 相当于来自于哈希为"00000"的交易
 //索引为零，相当于上一次的txOutput0为输入

 //输出
 <span class="hljs-attr">txOutput1</span> = &amp;TXOutput{<span class="hljs-number">10</span>, <span class="hljs-string">"ww"</span>}		//在该笔交易Vouts索引为<span class="hljs-number">0</span>  chaors转给ww的<span class="hljs-number">10</span>btc产生的输出
 <span class="hljs-attr">txOutput2</span> = &amp;TXOutput{<span class="hljs-number">15</span>, <span class="hljs-string">"chaors"</span>}    //在该笔交易Vouts索引为<span class="hljs-number">1</span>  给ww转账产生的找零
 Transaction1{"11111"，
			<span class="hljs-section">[]</span>*TXInput{txInput1}
			<span class="hljs-section">[]</span>*TXOutput{txOutput1, txOutput2}
}
</code></pre>
<p>3.ww感觉拥有比特币是一件很酷的事情，又来跟chaors要。出于兄弟情谊，chaors又转给ww7btc
这次的交易结构为:</p>
<pre><code class="hljs language-ini" lang="ini">//输入
 <span class="hljs-attr">txInput2</span> = &amp;TXInput{<span class="hljs-string">"11111"</span>,<span class="hljs-number">2</span>,<span class="hljs-string">"chaors"</span>}

 //输出
 <span class="hljs-attr">txOutput3</span> = &amp;TXOutput{<span class="hljs-number">7</span>, <span class="hljs-string">"ww"</span>}		  //在该笔交易Vouts索引为<span class="hljs-number">0</span>
 <span class="hljs-attr">txOutput4</span> = &amp;TXOutput{<span class="hljs-number">8</span>, <span class="hljs-string">"chaors"</span>}   //在该笔交易Vouts索引为<span class="hljs-number">1</span>
 Transaction2{"22222"，
			<span class="hljs-section">[]</span>*TXInput{txInput2}
			<span class="hljs-section">[]</span>*TXOutput{txOutput3, txOutput4}
}
</code></pre>
<p>4.消息传到他们共同的朋友xyz那里，xyz觉得btc很好玩向ww索要15btc.ww一向害怕xyx，于是尽管不愿意也只能屈服。</p>
<p>我们来看看ww此时的所有财产:</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">txOutput1</span> = &amp;TXOutput{<span class="hljs-number">10</span>, <span class="hljs-string">"ww"</span>}		//来自Transaction1(hash:<span class="hljs-number">11111</span>)Vouts索引为<span class="hljs-number">0</span>的输出   
<span class="hljs-attr">txOutput3</span> = &amp;TXOutput{<span class="hljs-number">7</span>, <span class="hljs-string">"ww"</span>}		//来自Transaction2(hash:<span class="hljs-number">2222</span>)Vouts索引为<span class="hljs-number">0</span>的输出
</code></pre>
<p>想要转账15btc,ww的哪一笔txOutput都不够，这个时候就需要用ww的两个txOutput都作为
输入,这次的交易结构为:</p>
<pre><code class="hljs language-ini" lang="ini">//输入：
<span class="hljs-attr">txInput3</span> = &amp;TXInput{<span class="hljs-string">"11111"</span>,<span class="hljs-number">1</span>,<span class="hljs-string">"ww"</span>}
<span class="hljs-attr">txInput4</span> = &amp;TXInput{<span class="hljs-string">"22222"</span>,<span class="hljs-number">3</span>,<span class="hljs-string">"ww"</span>}

//输出
 <span class="hljs-attr">txOutput5</span> = &amp;TXOutput{<span class="hljs-number">15</span>, <span class="hljs-string">"xyz"</span>}		索引为<span class="hljs-number">5</span>
 <span class="hljs-attr">txOutput6</span> = &amp;TXOutput{<span class="hljs-number">2</span>, <span class="hljs-string">"ww"</span>}        索引为<span class="hljs-number">6</span>

 第四个区块交易结构
 Transaction3{"33333"，
			<span class="hljs-section">[]</span>*TXInput{txInput3, txInput4}
			<span class="hljs-section">[]</span>*TXOutput{txOutput5, txOutput6}
}
</code></pre>
<p>现在,我们来总结一下上述几个交易.</p>
<blockquote>
<p>A.chaors</p>
<blockquote>
<p>1.从CoinbaseTransaction获得TXOutput0总额25
2.Transaction1转给ww10btc,TXOutput0被消耗,获得txOutput2找零15btc
3.Transaction2转给ww7Btc,txOutput2被消耗,获得txOutput4找零8btc
4.最后只剩8btc的txOutput4作为未花费输出</p>
</blockquote>
</blockquote>
<blockquote>
<p>B.ww</p>
<blockquote>
<p>1.从Transaction1获得TXOutput1,总额10btc
2.从Transaction2获得TXOutput3,总额7btc
3.Transaction3转给xyz15btc,TXOutput1和TXOutput3都被消耗,获得txOutput6找零2btc
4.最后只剩2btc的txOutput6作为未花费输出</p>
</blockquote>
</blockquote>
<blockquote>
<p>C.xyz</p>
<blockquote>
<p>1.从Transaction3获得TXOutput5,总额15btc
2.拥有15btc的TXOutput5作为未花费输出</p>
</blockquote>
</blockquote>
<p>经过这个例子,我们可以发现转账具备几个特点:
#####1.每笔转账必须有输入TXInput和输出TXOutput
#####2.每笔输入必须有源可查(TXInput.TxHash)
#####3.每笔输入的输出引用必须是未花费的(没有被之前的交易输入所引用)
#####4.TXOutput是一个不可分割的整体,一旦被消耗就不可用.消费额度不对等时会有找零(产生新的TXOutput)</p>
<p>这个🌰很重要,对于后面转账的代码逻辑是个扎实的基础准备.</p>
<h3 data-id="heading-3">AddBlockToBlockchain --&gt; MineNewBlock</h3>
<p>既然在cli工具用转账命令send代替了添加区块,那么在实际的函数调用中,我们必须考虑到交易信息.上面对转账有了一定的理解,现在可以认为构造公链的第一笔交易.</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-comment">//2.普通交易</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">NewTransaction</span><span class="hljs-params">(from []<span class="hljs-type">string</span>, to []<span class="hljs-type">string</span>, amount []<span class="hljs-type">string</span>)</span></span> *Transaction {


	<span class="hljs-comment">//单笔交易构造假数据测试交易</span>

	<span class="hljs-comment">//输入输出</span>
	<span class="hljs-keyword">var</span> txInputs []*TXInput
	<span class="hljs-keyword">var</span> txOutputs []*TXOutput

	<span class="hljs-comment">//输入,由于这里引用的TXOutput来自创世区块的奖励, 这里复制创世区块里创币交易的哈希作为交易输入对TXOutput的引用</span>
	txHash, _ := hex.DecodeString(<span class="hljs-string">"d3c17e00ad2c1bd7fec8f5afde710f2c3afd40478c3cca492d7e9a2b0cbe4808"</span>)
	txInput := &amp;TXInput {
		txHash,
		<span class="hljs-number">0</span>, 	<span class="hljs-comment">//要花费的TXOutput在对应交易的Vounts下标为0</span>
		from[<span class="hljs-number">0</span>],
	}

	fmt.Printf(<span class="hljs-string">"111--%x\n"</span>, txInput.TxHash)

	txInputs = <span class="hljs-built_in">append</span>(txInputs, txInput)

	<span class="hljs-comment">//转账</span>
	txOutput := &amp;TXOutput{
		<span class="hljs-number">10</span>,
	to[<span class="hljs-number">0</span>],
	}
	txOutputs = <span class="hljs-built_in">append</span>(txOutputs, txOutput)

	<span class="hljs-comment">//找零</span>
	txOutput = &amp;TXOutput{
		<span class="hljs-number">25</span><span class="hljs-number">-10</span>,
		from[<span class="hljs-number">0</span>],
	}
	txOutputs = <span class="hljs-built_in">append</span>(txOutputs, txOutput)

	tx := &amp;Transaction{
		[]<span class="hljs-type">byte</span>{},
		txInputs,
		txOutputs,
	}

	tx.HashTransactions()

	fmt.Printf(<span class="hljs-string">"222---%x\n"</span>, txInput.TxHash)

	<span class="hljs-keyword">return</span> tx


	<span class="hljs-comment">//1. 有一个函数，返回from这个人所有的未花费交易输出所对应的Transaction</span>
	<span class="hljs-comment">//unSpentTx := UnSpentTransactionsWithAddress("chaors")</span>
	<span class="hljs-comment">//fmt.Println(unSpentTx)</span>
}
</code></pre>
<p>我们在人为通过硬编码构造好一个基于创世区块的转账交易后,此时需要将这笔交易打包到区块并添加到区块链上.之前我们的AddBlockToBlockchain就需要做些改动.</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-comment">//2.新增一个区块到区块链 --&gt; 包含交易的挖矿</span>
<span class="hljs-comment">//func (blc *Blockchain) AddBlockToBlockchain(txs []*Transaction) {</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(blc *Blockchain)</span></span> MineNewBlock(from []<span class="hljs-type">string</span>, to []<span class="hljs-type">string</span>, amount []<span class="hljs-type">string</span>) {

	<span class="hljs-comment">//send -from '["chaors"]' -to '["xyx"]' -amount '["5"]'</span>

	tx := NewTransaction(from, to, amount)
	<span class="hljs-comment">//1.通过相关算法建立Transaction数组</span>
	<span class="hljs-keyword">var</span> txs []*Transaction
	txs = <span class="hljs-built_in">append</span>(txs, tx)

	fmt.Printf(<span class="hljs-string">"333---%x\n\n"</span>, txs[<span class="hljs-number">0</span>].Vins[<span class="hljs-number">0</span>].TxHash)

	<span class="hljs-comment">//2.挖矿</span>
	<span class="hljs-comment">//取上个区块的哈希和高度值</span>
	<span class="hljs-keyword">var</span> block *Block
	err := blc.DB.View(<span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(tx *bolt.Tx)</span></span> <span class="hljs-type">error</span> {

		b := tx.Bucket([]<span class="hljs-type">byte</span>(blockTableName))
		<span class="hljs-keyword">if</span> b != <span class="hljs-literal">nil</span> {

			hash := b.Get([]<span class="hljs-type">byte</span>(newestBlockKey))
			block = DeSerializeBlock(b.Get(hash))
		}

		<span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>
	})
	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {

		log.Panic(err)
	}

	<span class="hljs-comment">//3.建立新区块</span>
	block = NewBlock(txs, block.Height+<span class="hljs-number">1</span>, block.Hash)

	<span class="hljs-comment">//4.存储新区块</span>
	err = blc.DB.Update(<span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(tx *bolt.Tx)</span></span> <span class="hljs-type">error</span> {

		b := tx.Bucket([]<span class="hljs-type">byte</span>(blockTableName))
		<span class="hljs-keyword">if</span> b != <span class="hljs-literal">nil</span> {

			fmt.Printf(<span class="hljs-string">"444---%x\n\n"</span>, block.Txs[<span class="hljs-number">0</span>].Vins[<span class="hljs-number">0</span>].TxHash)
			fmt.Println(block)

			err = b.Put(block.Hash, block.Serialize())
			<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {

				log.Panic(err)
			}

			err = b.Put([]<span class="hljs-type">byte</span>(newestBlockKey), block.Hash)
			<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {

				log.Panic(err)
			}

			blc.Tip = block.Hash
		}

		<span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>
	})
	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {

		log.Panic(err)
		<span class="hljs-comment">//fmt.Print(err)</span>
	}
}
</code></pre>
<p>然后再CLI工具将send命令的具体实现添加好.</p>
<pre><code class="hljs language-css" lang="css">//转账
func (cli *CLI) send(<span class="hljs-selector-tag">from</span> <span class="hljs-selector-attr">[]</span>string, <span class="hljs-selector-tag">to</span> <span class="hljs-selector-attr">[]</span>string, amount <span class="hljs-selector-attr">[]</span>string)  {

	blockchain := <span class="hljs-built_in">GetBlockchain</span>()
	defer blockchain.DB.<span class="hljs-built_in">Close</span>()

	blockchain.<span class="hljs-built_in">MineNewBlock</span>(from, to, amount)
}
</code></pre>
<h3 data-id="heading-4">余额查询GetBalance</h3>
<p>转账和区块上链都实现了,Run也是没有问题的.那么怎么验证转账成功呢?毕竟此时我们不知道各自的余额是多少.这时候,我们就需要来实现余额查询方法.</p>
<p>首先在CLi工具里实现,getBlance命令的添加和解析其实在前面说到send命令时已经有了.回去看看即可.</p>
<p>余额查询的实现</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">//余额查询</span>
func (cli *CLI) <span class="hljs-built_in">getBlance</span>(address string) {

	fmt<span class="hljs-selector-class">.Println</span>("地址：" + address)

	blockchain := <span class="hljs-built_in">GetBlockchain</span>()
	defer blockchain.DB.<span class="hljs-built_in">Close</span>()

	amount := blockchain.<span class="hljs-built_in">GetBalance</span>(address)

	fmt.<span class="hljs-built_in">Printf</span>(<span class="hljs-string">"%s一共有%d个Token\n"</span>, address, amount)
}
</code></pre>
<pre><code class="hljs language-go" lang="go">
<span class="hljs-comment">//查询余额</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(blc *Blockchain)</span></span> GetBalance(address <span class="hljs-type">string</span>) <span class="hljs-type">int64</span> {

	utxos := blc.UTXOs(address)

	<span class="hljs-keyword">var</span> amount <span class="hljs-type">int64</span>
	<span class="hljs-keyword">for</span> _, out := <span class="hljs-keyword">range</span> utxos {

		amount += out.Value
	}

	<span class="hljs-keyword">return</span> amount
}
</code></pre>
<h3 data-id="heading-5">UTXOs</h3>
<p>要想实现余额查询,必须知道某个账户未花费的TxOutput.这个时候我们需要遍历区块链上的区块,然后去每一笔交易里找.在每笔交易输出里被引用的TxOutput必定被消耗,只需要记录被消耗的TxOutput.然后再去比对每笔交易产生的TxOutput,做个去除即可得到当前账户在链上剩余的未花费的TxOutput.</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-comment">//5.返回一个地址对应的UTXO的交易UTXOs</span>
<span class="hljs-comment">//func (blc *Blockchain) UnSpentTransactionsWithAddress(address string) []*Transaction {</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(blc *Blockchain)</span></span> UTXOs(address <span class="hljs-type">string</span>) []*TXOutput {

	<span class="hljs-comment">//未花费的TXOutput</span>
	<span class="hljs-keyword">var</span> UTXOs []*TXOutput

	<span class="hljs-comment">//已经花费的TXOutput [hash:[]] [交易哈希：TxOutput对应的index]</span>
	<span class="hljs-keyword">var</span> spentTXOutputs = <span class="hljs-built_in">make</span>(<span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>][]<span class="hljs-type">int</span>)

	<span class="hljs-comment">//遍历器</span>
	blcIterator := blc.Iterator()

	<span class="hljs-keyword">for</span> {

		block := blcIterator.Next()

		<span class="hljs-comment">//fmt.Println(block)</span>
		<span class="hljs-comment">//fmt.Println()</span>

		<span class="hljs-keyword">for</span> _, tx := <span class="hljs-keyword">range</span> block.Txs {

			<span class="hljs-comment">// txHash</span>

			<span class="hljs-comment">// Vins</span>
			<span class="hljs-comment">//判断当前交易是否为创币交易</span>
			<span class="hljs-keyword">if</span> tx.IsCoinbaseTransaction() == <span class="hljs-literal">false</span> {

				<span class="hljs-keyword">for</span> _, in := <span class="hljs-keyword">range</span> tx.Vins {

					<span class="hljs-comment">//验证当前输入是否是当前地址的</span>
					<span class="hljs-keyword">if</span> in.UnlockWithAddress(address) {

						key := hex.EncodeToString(in.TxHash)

						<span class="hljs-comment">//fmt.Printf("lll%x\n", in.TxHash)</span>
						<span class="hljs-comment">//fmt.Println(key)</span>
						spentTXOutputs[key] = <span class="hljs-built_in">append</span>(spentTXOutputs[key], in.Vout)
					}

				}
			}


			<span class="hljs-comment">// Vouts</span>
			<span class="hljs-keyword">for</span> index, out := <span class="hljs-keyword">range</span> tx.Vouts {

				<span class="hljs-comment">//验证当前输出是否是</span>
				<span class="hljs-keyword">if</span> out.UnLockScriptPubKeyWithAddress(address) {

					fmt.Printf(<span class="hljs-string">"%x"</span>, block.Hash)
					fmt.Println(index, out)

					<span class="hljs-comment">//判断是否曾发生过交易</span>
					<span class="hljs-keyword">if</span> spentTXOutputs != <span class="hljs-literal">nil</span> {

						<span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(spentTXOutputs) != <span class="hljs-number">0</span> {

							<span class="hljs-comment">//遍历spentTXOutputs</span>
							<span class="hljs-keyword">for</span> txHash, indexArray := <span class="hljs-keyword">range</span> spentTXOutputs {

								<span class="hljs-comment">//遍历TXOutputs下标数组</span>
								<span class="hljs-keyword">for</span> _, i := <span class="hljs-keyword">range</span> indexArray {

									fmt.Printf(<span class="hljs-string">"%d--%d\n"</span>, index, i)
									fmt.Printf(<span class="hljs-string">"%s\n"</span>, txHash)
									fmt.Printf(<span class="hljs-string">"%x\n"</span>, tx.TxHAsh)
									fmt.Println(spentTXOutputs)
									fmt.Println(out)

									<span class="hljs-keyword">if</span> index == i &amp;&amp; txHash == hex.EncodeToString(tx.TxHAsh) {

										<span class="hljs-keyword">continue</span>
									} <span class="hljs-keyword">else</span> {

										<span class="hljs-comment">//fmt.Println(index,i)</span>
										<span class="hljs-comment">//fmt.Println(out)</span>
										<span class="hljs-comment">//fmt.Println(spentTXOutputs)</span>

										UTXOs = <span class="hljs-built_in">append</span>(UTXOs, out)
									}
								}
							}
						} <span class="hljs-keyword">else</span> {

							UTXOs = <span class="hljs-built_in">append</span>(UTXOs, out)
						}
					}
				}
			}
		}

		<span class="hljs-comment">//找到创世区块，跳出循环</span>
		<span class="hljs-keyword">var</span> hashInt big.Int
		hashInt.SetBytes(block.PrevBlockHash)

		<span class="hljs-comment">// Cmp compares x and y and returns:</span>
		<span class="hljs-comment">//</span>
		<span class="hljs-comment">//   -1 if x &lt;  y</span>
		<span class="hljs-comment">//    0 if x == y</span>
		<span class="hljs-comment">//   +1 if x &gt;  y</span>
		<span class="hljs-keyword">if</span> hashInt.Cmp(big.NewInt(<span class="hljs-number">0</span>)) == <span class="hljs-number">0</span> {

			<span class="hljs-keyword">break</span>
		}
	}

	<span class="hljs-keyword">return</span> UTXOs
}
</code></pre>
<h3 data-id="heading-6">Main_test</h3>
<pre><code class="hljs language-css" lang="css">package <span class="hljs-selector-tag">main</span>

import (

	"chaors<span class="hljs-selector-class">.com</span>/publicChaorsChain/part8-transfer-Prototype/BLC"
)

func <span class="hljs-selector-tag">main</span>() {

	cli := BLC.CLI{}
	cli<span class="hljs-selector-class">.Run</span>()

	//blc := BLC.<span class="hljs-built_in">CreateBlockchainWithGensisBlock</span>(<span class="hljs-string">"chaors"</span>)
	//utxos := blc.<span class="hljs-built_in">UnUTXOs</span>(<span class="hljs-string">"chaors"</span>)
	//fmt.<span class="hljs-built_in">Println</span>(utxos)
}
</code></pre>
<p>创建好创世区块后,执行第一次转账.
chaors(25btc) --&gt;ww(10) + chaors(15)</p>
<p><img src="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2018/7/10/16484b5e1dd57662~tplv-t2oaga2asx-jj-mark:3024:0:0:0:q75.awebp#?w=1240&amp;h=810&amp;s=576620&amp;e=png&amp;b=323131" alt="Main_test1.png" loading="lazy"/></p>
<p><img src="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2018/7/10/16484b5e1f0a1df3~tplv-t2oaga2asx-jj-mark:3024:0:0:0:q75.awebp#?w=1240&amp;h=373&amp;s=368022&amp;e=png&amp;b=323131" alt="Main_test2.png" loading="lazy"/></p>
<h3 data-id="heading-7">总结</h3>
<p>当前的交易函数是人工硬编码，下次再具体实现。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fchaors%2FPublicBlockChain_go" target="_blank" title="https://github.com/chaors/PublicBlockChain_go" ref="nofollow noopener noreferrer">源代码</a>在这,喜欢的朋友记得给个小star，或者fork.也欢迎大家一起探讨区块链相关知识，一起进步！</p>
<h3 data-id="heading-8">更多原创区块链技术文章请访问<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.jianshu.com%2Fu%2Fa46bd6ade353" target="_blank" title="https://www.jianshu.com/u/a46bd6ade353" ref="nofollow noopener noreferrer">chaors</a></h3>
<p>.
.
.
.</p>
<blockquote>
<p>###互联网颠覆世界，区块链颠覆互联网!</p>
</blockquote>
<blockquote>
<h6 data-id="heading-9">---------------------------------------------20180703 23:47</h6>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[在 React 中手写 KeepAlive]]></title>    <link>https://juejin.cn/post/7600303087875768358</link>    <guid>https://juejin.cn/post/7600303087875768358</guid>    <pubDate>2026-01-29T03:48:15.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600303087875768358" data-draft-id="7600314093294469158" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="在 React 中手写 KeepAlive"/> <meta itemprop="keywords" content="前端,性能优化,面试"/> <meta itemprop="datePublished" content="2026-01-29T03:48:15.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="有意义"/> <meta itemprop="url" content="https://juejin.cn/user/1739866211617625"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            在 React 中手写 KeepAlive
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1739866211617625/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    有意义
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-29T03:48:15.000Z" title="Thu Jan 29 2026 03:48:15 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#595959;font-size:15px;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(60,10,30,.04) 3%,transparent 0),linear-gradient(1turn,rgba(60,10,30,.04) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body p{color:#595959;font-size:15px;line-height:2;font-weight:400}.markdown-body p+p{margin-top:16px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin:0;color:#135ce0}.markdown-body h1{position:relative;text-align:center;font-size:22px;margin:50px 0}.markdown-body h1:before{position:absolute;content:"";top:-10px;left:50%;width:32px;height:32px;transform:translateX(-50%);background-size:100% 100%;opacity:.36;background-repeat:no-repeat;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC)}.markdown-body h2{position:relative;font-size:20px;border-left:4px solid;padding:0 0 0 10px;margin:30px 0}.markdown-body h3{font-size:16px}.markdown-body ul{list-style:disc outside;margin-left:2em;margin-top:1em}.markdown-body li{line-height:2;color:#595959}.markdown-body img.loaded{margin:0 auto;display:block}.markdown-body blockquote{background:#fff9f9;margin:2em 0;padding:2px 20px;border-left:4px solid #b2aec5}.markdown-body blockquote p{color:#666;line-height:2}.markdown-body a{color:#036aca;border-bottom:1px solid rgba(3,106,202,.8);font-weight:400;text-decoration:none}.markdown-body em strong,.markdown-body strong{color:#036aca}.markdown-body hr{border-top:1px solid #135ce0}.markdown-body pre{overflow:auto}.markdown-body code,.markdown-body pre{overflow:auto;position:relative;line-height:1.75;font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body table{border-collapse:collapse;margin:1rem 0;overflow-x:auto}.markdown-body table td,.markdown-body table th{border:1px solid #dfe2e5;padding:.6em 1em}.markdown-body table tr{border-top:1px solid #dfe2e5}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">写在前面</h2>
<p>在 Vue 中，<code>&lt;keep-alive&gt;</code> 是一个<strong>内置的组件</strong></p>
<p>用于缓存动态组件的状态，避免重复创建和销毁。</p>
<p>它常用于 <code>&lt;component :is="..."&gt;</code>、<code>&lt;router-view&gt;</code> 等场景，实现“切换时不销毁组件实例”的效果。</p>
<p>我们知道 React 基于原生 JavaScript，具有更强的灵活性和定制能力，接下来我们将用 React 来实现这一机制。</p>
<h2 data-id="heading-1">一、组件的状态的丢失</h2>
<p>在深入实现 <code>KeepAlive</code> 之前，我们可以先搭建一个简单场景，亲身体验一下：</p>
<p><strong>当动态切换组件时，其内部状态为何会意外丢失</strong>。</p>
<h3 data-id="heading-2">编写一个带状态的计数器组件</h3>
<p>我们需要一个具备本地状态的组件——例如一个计数器。在多个同类组件之间切换时，可以直观观察其状态是否被保留。</p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-comment">// src/App.jsx</span>
<span class="hljs-keyword">import</span> { useState, useEffect } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-title class_">KeepAlive</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'./components/KeepAlive.jsx'</span>;

<span class="hljs-comment">// 普通计数器组件</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">Counter</span> = (<span class="hljs-params">{ name }</span>) =&gt; {
  <span class="hljs-keyword">const</span> [count, setCount] = <span class="hljs-title function_">useState</span>(<span class="hljs-number">0</span>);

  <span class="hljs-comment">//监听组件的挂载与卸载生命周期</span>
  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">` $ {name} 组件已挂载！`</span>);
    <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">` $ {name} 组件已被卸载...`</span>);
    };
  }, []);

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">padding:</span> '<span class="hljs-attr">20px</span>', <span class="hljs-attr">border:</span> '<span class="hljs-attr">1px</span> <span class="hljs-attr">solid</span> #<span class="hljs-attr">ccc</span>', <span class="hljs-attr">margin:</span> '<span class="hljs-attr">10px</span>' }}&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">h3</span>&gt;</span>{name} 视图<span class="hljs-tag">&lt;/<span class="hljs-name">h3</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>当前计数: {count}<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span> =&gt;</span> setCount(count + 1)}&gt;加 1<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
};

<span class="hljs-comment">// 另一个计数器组件（逻辑完全一致）</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">OtherCounter</span> = (<span class="hljs-params">{ name }</span>) =&gt; {
  <span class="hljs-keyword">const</span> [count, setCount] = <span class="hljs-title function_">useState</span>(<span class="hljs-number">0</span>);

  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`  $ {name} 组件已挂载！`</span>);
    <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`  $ {name} 组件已被卸载...`</span>);
    };
  }, []);

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">padding:</span> '<span class="hljs-attr">20px</span>', <span class="hljs-attr">border:</span> '<span class="hljs-attr">1px</span> <span class="hljs-attr">solid</span> #<span class="hljs-attr">ccc</span>', <span class="hljs-attr">margin:</span> '<span class="hljs-attr">10px</span>' }}&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">h3</span>&gt;</span>{name} 视图<span class="hljs-tag">&lt;/<span class="hljs-name">h3</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>当前计数: {count}<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span> =&gt;</span> setCount(count + 1)}&gt;加 1<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
};
</code></pre>
<blockquote>
<p>我们可以看到，尽管两个组件逻辑相同，但由于它们是不同的函数引用，React 会将其视为不同类型。因此，在条件渲染中切换时，React 会<strong>卸载旧组件并重新挂载新组件</strong>，导致状态丢失。</p>
</blockquote>
<p>当我们通过路由或状态控制在这两个组件之间切换时，会发现：<strong>每次返回原组件，计数器都会重置为 0</strong>。</p>
<p>再深入一点， <code>App.jsx</code> 文件中，通过状态 <code>activeTab</code> 来控制显示哪一个组件。这样你可以体验到当组件被条件渲染时，默认情况下它们的状态是如何丢失的。</p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">const</span> <span class="hljs-title function_">App</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-comment">// 使用 'A' 或 'B' 控制当前显示哪个组件</span>
  <span class="hljs-keyword">const</span> [activeTab, setActiveTab] = <span class="hljs-title function_">useState</span>(<span class="hljs-string">'A'</span>); 

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">marginBottom:</span> '<span class="hljs-attr">20px</span>' }}&gt;</span>
        {/* 按钮用于切换 activeTab 状态 */}
        <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span> =&gt;</span> setActiveTab('A')}&gt;显示 A 组件<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span> =&gt;</span> setActiveTab('B')}&gt;显示 B 组件<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>

      {/*  注意：这里的三元运算符会导致组件在切换时被销毁和重建 */}
      {activeTab === 'A' ? <span class="hljs-tag">&lt;<span class="hljs-name">Counter</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"A"</span> /&gt;</span> : <span class="hljs-tag">&lt;<span class="hljs-name">OtherCounter</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"B"</span> /&gt;</span>}
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
};
</code></pre>
<p>我们运行这段代码时</p>
<ol>
<li>点击“显示 A 组件”，然后多次点击“加 1”按钮，直到计数达到 5。</li>
<li>接着，点击“显示 B 组件”。此时，你应该会在控制台看到信息：“ A 组件已被卸载...” 和 “ B 组件已挂载！”。</li>
<li>最后，再次点击“显示 A 组件”。你会注意到控制台输出了“ A 组件已挂载！”，但遗憾的是，计数器已经重置为 0。</li>
</ol>
<p>这种行为展示了 React 中条件渲染（的本质：每次当 <code>activeTab</code> 发生变化时，相应的组件会被卸载和重新挂载，导致其内部状态丢失。</p>
<blockquote>
<p>而下一步，正是通过实现一个类似 Vue 中 <code>&lt;keep-alive&gt;</code> 的 <code>KeepAlive</code> 机制，让组件在切换后仍能<strong>保留其内部状态与 DOM 结构</strong>，从而提升用户体验与性能。</p>
</blockquote>
<h2 data-id="heading-3">二、：KeepAlive 的核心原理</h2>
<p>既然 React 在条件切换时会<strong>销毁组件并清空状态</strong>，</p>
<p>那我们能不能换个思路——</p>
<blockquote>
<p>不让组件被销毁，只让它“隐身”？</p>
</blockquote>
<p>答案是肯定的。关键在于：</p>
<blockquote>
<p>绕过 React 的卸载机制，用视觉隐藏代替真实移除。</p>
</blockquote>
<h3 data-id="heading-4">2.1 核心思想</h3>
<p><code>KeepAlive</code> 的底层逻辑并不复杂，核心就两点：</p>
<blockquote>
<p>所有需要缓存的子组件，一次性全部挂载到 DOM 中，永不卸载。</p>
<p>通过 CSS 的 <code>display</code> 属性控制谁“露脸”、谁“退场”。</p>
</blockquote>
<p>只要组件的真实节点还留在 DOM 树里（哪怕被设为 <code>display: none</code>），React 就不会触发它的卸载流程——<br/>
<code>useState</code> 的值依然保留<br/>
<code>useEffect</code> 的清理函数不会执行<br/>
整个组件实例在内存中“活着”，随时可以重新激活</p>
<p>这其实就是一种<strong>障眼法</strong>：</p>
<blockquote>
<p><strong>用户看到的是“切换视图”，而 React 看到的是“同一组组件，只是 visibility 变了”。</strong></p>
</blockquote>
<p>你不是在反复创建和销毁，而是在<strong>管理一组常驻组件的可见状态</strong>。既省去了重复初始化的开销，又完美保留了交互状态。</p>
<hr/>
<h3 data-id="heading-5">2.2 缓存结构设计</h3>
<p>为了让这套机制可复用、可追踪，我们需要一个<strong>缓存容器</strong>，用来记录所有已经渲染过的子组件。</p>
<p>最直观的方式，就是用一个对象（或 <code>Map</code>）来维护：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> cache = {
  <span class="hljs-attr">A</span>: <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Counter</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"A"</span> /&gt;</span></span>,
  <span class="hljs-attr">B</span>: <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">OtherCounter</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"B"</span> /&gt;</span></span>
};
</code></pre>
<p><strong>Key</strong>：由外部传入的唯一标识（如 <code>'A'</code>、<code>'B'</code>）决定，用于区分不同视图。</p>
<p><strong>Value</strong>：对应的 React 元素（即 JSX 表达式），<strong>仅在首次访问时生成并存入缓存</strong>，后续直接复用。</p>
<blockquote>
<p>虽然缓存的是 React 元素，但一旦它被挂载，其背后的状态、DOM 节点、Fiber 节点都会由 React 内部持续维护。只要不触发 unmount，一切状态都安然无恙。</p>
</blockquote>
<p>最终渲染时，你只需遍历 <code>cache</code>，把所有缓存项都 render 出来，再根据当前激活的 key 动态设置 <code>style={{ display: activeKey === key ? 'block' : 'none' }}</code>。</p>
<p>看起来简单，对吧？<br/>
但要把它封装成一个<strong>通用、健壮、支持动态 children 的 <code>&lt;KeepAlive&gt;</code> 组件</strong>，还需要处理不少细节。接下来，我们就动手实现它。</p>
<hr/>
<h2 data-id="heading-6">三、手写实战：实现 <code>KeepAlive</code> 组件</h2>
<p>现在，我们正式动手编写一个具备缓存能力的 <code>KeepAlive</code> 容器。<br/>
它将接管子组件的渲染逻辑，确保状态在切换中得以保留。</p>
<h3 data-id="heading-7">Props 与内部状态设计</h3>
<p>我们的 <code>KeepAlive</code> 组件需要两个关键输入：</p>
<ul>
<li><strong><code>activeId</code></strong>：标识当前应显示的视图（如 <code>'A'</code>、<code>'B'</code>）。</li>
<li><strong><code>children</code></strong>：当前传入的子组件（即待缓存的 React 元素）。</li>
</ul>
<p>同时，组件内部需维护一个<strong>缓存池</strong>，用于持久化所有已渲染过的子组件。</p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">import</span> { useState, useEffect } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;

<span class="hljs-keyword">const</span> <span class="hljs-title function_">KeepAlive</span> = (<span class="hljs-params">{ activeId, children }</span>) =&gt; {
  <span class="hljs-comment">// 缓存池：key 为视图 ID，value 为对应的 React 元素</span>
  <span class="hljs-keyword">const</span> [cache, setCache] = <span class="hljs-title function_">useState</span>({});
  
  <span class="hljs-comment">// ... 缓存与渲染逻辑</span>
};
</code></pre>
<blockquote>
<p>💡 注意：<code>children</code> 在 React 中本质是一个不可变的 React 元素（Element），将其存入状态是安全且合法的。</p>
</blockquote>
<hr/>
<h3 data-id="heading-8">3.2 缓存策略：按需存储，避免重复</h3>
<p>每当 <code>activeId</code> 或 <code>children</code> 发生变化时，我们需要判断：<strong>该视图是否首次出现？</strong></p>
<p>如果是，则将其 <code>children</code> 存入缓存；否则，直接复用已有内容。</p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-comment">// 仅当当前 activeId 对应的组件尚未缓存时，才进行存储</span>
  <span class="hljs-keyword">if</span> (cache[activeId] == <span class="hljs-literal">null</span>) {
    <span class="hljs-title function_">setCache</span>(<span class="hljs-function"><span class="hljs-params">prev</span> =&gt;</span> ({
      ...prev,
      [activeId]: children
    }));
  }
}, [activeId, children, cache]);
</code></pre>
<blockquote>
<p>这里依赖 <code>cache</code> 作为依赖项看似冗余，但能确保在严格模式（Strict Mode）或并发渲染下行为一致。实际项目中也可通过 <code>ref</code> 优化，但为保持逻辑清晰，此处暂用状态驱动。</p>
</blockquote>
<hr/>
<h3 data-id="heading-9">3.3 渲染机制：全量挂载 + CSS 显隐</h3>
<p>最关键的一步来了：<strong>不要用条件渲染！</strong></p>
<p>我们要将<strong>所有已缓存的组件全部挂载到 DOM 中</strong>，仅通过 <code>display: none/block</code> 控制可见性。这样，React 不会触发卸载，状态自然得以保留。</p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">return</span> (
  <span class="xml"><span class="hljs-tag">&lt;&gt;</span>
    {Object.entries(cache).map(([id, component]) =&gt; (
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span>
        <span class="hljs-attr">key</span>=<span class="hljs-string">{id}</span>
        <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span>
          <span class="hljs-attr">display:</span> <span class="hljs-attr">id</span> === <span class="hljs-string">activeId</span> ? '<span class="hljs-attr">block</span>' <span class="hljs-attr">:</span> '<span class="hljs-attr">none</span>',
          // <span class="hljs-attr">可选</span>：<span class="hljs-attr">防止隐藏组件影响布局</span>
          <span class="hljs-attr">position:</span> '<span class="hljs-attr">absolute</span>',
          <span class="hljs-attr">top:</span> <span class="hljs-attr">0</span>,
          <span class="hljs-attr">left:</span> <span class="hljs-attr">0</span>,
          <span class="hljs-attr">width:</span> '<span class="hljs-attr">100</span>%'
        }}
      &gt;</span>
        {component}
      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    ))}
  <span class="hljs-tag">&lt;/&gt;</span></span>
);
</code></pre>
<blockquote>
<p>每个缓存项都始终存在于 DOM 树中，只是视觉上被隐藏。<br/>
React Fiber 树持续维护其状态，<code>useState</code>、<code>useRef</code>、<code>useEffect</code> 均正常工作。</p>
</blockquote>
<hr/>
<h3 data-id="heading-10">3.4 完整实现</h3>
<p>整合上述逻辑，得到一个简洁而有效的 <code>KeepAlive</code> 组件：</p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">import</span> { useState, useEffect } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;

<span class="hljs-keyword">const</span> <span class="hljs-title function_">KeepAlive</span> = (<span class="hljs-params">{ activeId, children }</span>) =&gt; {
  <span class="hljs-keyword">const</span> [cache, setCache] = <span class="hljs-title function_">useState</span>({});

  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">if</span> (cache[activeId] == <span class="hljs-literal">null</span>) {
      <span class="hljs-title function_">setCache</span>(<span class="hljs-function"><span class="hljs-params">prev</span> =&gt;</span> ({
        ...prev,
        [activeId]: children
      }));
    }
  }, [activeId, children, cache]);

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;&gt;</span>
      {Object.entries(cache).map(([id, component]) =&gt; (
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span>
          <span class="hljs-attr">key</span>=<span class="hljs-string">{id}</span>
          <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">display:</span> <span class="hljs-attr">id</span> === <span class="hljs-string">activeId</span> ? '<span class="hljs-attr">block</span>' <span class="hljs-attr">:</span> '<span class="hljs-attr">none</span>' }}
        &gt;</span>
          {component}
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
      ))}
    <span class="hljs-tag">&lt;/&gt;</span></span>
  );
};

0<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title class_">KeepAlive</span>;
</code></pre>
<p>这个不到 40 行的组件，巧妙利用了 React 的渲染机制与 CSS 的显示控制，实现了类似 Vue <code>&lt;keep-alive&gt;</code> 的缓存能力。</p>
<p>接下来，只需在 <code>App.jsx</code> 中替换原来的三元表达式，就能见证“失忆症”的彻底治愈。</p>
<h3 data-id="heading-11">我们来看看效果：</h3>
<p>首先点击“显示 A 组件”，并将计数增加至 5。</p>
<p>随后切换至“显示 B 组件”。</p>
<p>此时观察控制台输出：<strong>没有出现“A 组件被卸载”的日志</strong>，仅打印了“B 组件已挂载”</p>
<p>这表明 A 组件并未被销毁，其对应的 <code>useEffect</code> 清理函数未被执行。</p>
<p>接着，重新切换回“显示 A 组件”。控制台<strong>未输出“A 组件已挂载”</strong> ，说明该组件实例未经历重新创建过程；同时，界面上的计数值依然保持为 5，状态完整保留。</p>
<p>这一结果验证了 <code>KeepAlive</code> 组件的核心能力：通过避免真实卸载、仅控制视觉显隐，成功实现了动态组件的状态持久化。组件在切换过程中维持了其内部状态、DOM 结构及生命周期上下文，达到了与 Vue 中 <code>&lt;keep-alive&gt;</code> 相似的效果。</p>
<h2 data-id="heading-12">总结</h2>
<p>通过手写实现，我们成功在 React 中模拟了类似 Vue <code>&lt;keep-alive&gt;</code> 的状态缓存能力。但值得注意的是，<strong>两者的实现机制和底层逻辑存在根本性差异</strong>。</p>
<p>在 <strong>Vue</strong> 中，<code>&lt;keep-alive&gt;</code> 是一个深度集成于渲染器（renderer）的<strong>内置抽象组件</strong>。它通过操作虚拟 DOM 的 <code>shapeFlag</code>，直接干预组件的挂载（mount）与卸载（unmount）流程：被缓存的组件不会触发 <code>beforeUnmount</code> 和 <code>unmounted</code>，而是进入“停用”（deactivated）状态；重新激活时调用 <code>activated</code> 钩子，整个过程由 Vue 的响应式系统和组件生命周期体系原生支持。</p>
<p>而在 <strong>React</strong> 中，并无类似的底层钩子或渲染器扩展机制。因此，我们的实现本质上是一种<strong>上层应用级的“障眼法”</strong> ：</p>
<ul>
<li>所有子组件始终处于挂载状态，从未真正卸载；</li>
<li>通过 CSS 的 <code>display: none</code> 实现视觉切换；</li>
<li>依赖 React 对已挂载组件状态的自然保留能力来维持数据。</li>
</ul>
<p>这意味着：</p>
<ul>
<li><strong>优势</strong>：实现简单，无需侵入 React 内部机制，兼容性好；</li>
<li><strong>局限</strong>：所有缓存组件持续占用内存和 DOM 节点，可能影响性能（尤其在缓存大量复杂组件时）；无法像 Vue 那样精确控制“激活/停用”生命周期（如暂停轮询、取消订阅等），需自行结合 <code>useEffect</code> 与 <code>activeId</code> 状态管理副作用。</li>
</ul>
<p>因此，React 版 <code>KeepAlive</code> 更适合<strong>轻量级、状态为主、副作用较少</strong>的场景；而 Vue 的 <code>&lt;keep-alive&gt;</code> 则提供了更精细的生命周期控制和更高效的内存管理策略。</p>
<p>归根结底：<strong>Vue 是“框架帮你管”，React 是“你自己想办法管”</strong> ——这也正是两种框架哲学差异的典型体现。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[React-useReducer 在复杂状态管理中的妙用]]></title>    <link>https://juejin.cn/post/7600303087875833894</link>    <guid>https://juejin.cn/post/7600303087875833894</guid>    <pubDate>2026-01-29T04:00:39.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600303087875833894" data-draft-id="7600370554068828186" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="React-useReducer 在复杂状态管理中的妙用"/> <meta itemprop="keywords" content="前端,面试,React.js"/> <meta itemprop="datePublished" content="2026-01-29T04:00:39.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="发现一只大呆瓜"/> <meta itemprop="url" content="https://juejin.cn/user/180747382561607"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            React-useReducer 在复杂状态管理中的妙用
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/180747382561607/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    发现一只大呆瓜
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-29T04:00:39.000Z" title="Thu Jan 29 2026 04:00:39 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h3 data-id="heading-0">前言</h3>
<p>当你的组件状态逻辑变得复杂（例如：一个状态依赖于另一个状态，或者一个动作需要更新多个状态）时，<code>useState</code> 往往会显得力不从心。此时，React 提供的 <code>useReducer</code> 便成了最佳选择。它借鉴了 Redux 的思想，让状态更新逻辑更具可预测性和可测试性。</p>
<h2 data-id="heading-1">一、 核心概念：什么是 useReducer？</h2>
<p><code>useReducer</code> 是一个通过“动作（Action）”来驱动“状态（State）”转换的 Hook。</p>
<h3 data-id="heading-2">1. 语法拆解</h3>
<p><code>const [state, dispatch] = useReducer(reducer, initialState)</code></p>
<ul>
<li><strong>reducer</strong>：一个纯函数 <code>(state, action) =&gt; newState</code>。它接收当前状态和动作，返回新状态。</li>
<li><strong>initialState</strong>：初始状态值。</li>
<li><strong>state</strong>：当前的状态。</li>
<li><strong>dispatch</strong>：派发函数，用于派发操作给reducer，是改变状态的<strong>唯一途径</strong>。</li>
</ul>
<hr/>
<h2 data-id="heading-3">二、 实战：强类型下的计数器</h2>
<p>在 TypeScript 中，我们通过定义 <code>Action</code> 的联合类型（Union Types），可以获得完美的编辑器补全和类型检查。</p>
<pre><code class="hljs language-TSX" lang="TSX"><span class="hljs-keyword">import</span> <span class="hljs-title class_">React</span>, { useReducer } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;

<span class="hljs-comment">// 1. 定义状态的类型</span>
<span class="hljs-keyword">interface</span> <span class="hljs-title class_">State</span> {
  <span class="hljs-attr">count</span>: <span class="hljs-built_in">number</span>;
}

<span class="hljs-comment">// 2. 定义 Action 的类型 (使用联合类型实现 Discriminated Unions)</span>
<span class="hljs-keyword">type</span> <span class="hljs-title class_">Action</span> =
  | { <span class="hljs-attr">type</span>: <span class="hljs-string">'INCREMENT'</span> }
  | { <span class="hljs-attr">type</span>: <span class="hljs-string">'DECREMENT'</span> }
  | { <span class="hljs-attr">type</span>: <span class="hljs-string">'RESET'</span>; <span class="hljs-attr">payload</span>: <span class="hljs-built_in">number</span> };

<span class="hljs-comment">// 3. 编写 Reducer 纯函数</span>
<span class="hljs-comment">// 确保逻辑独立于组件之外，易于测试</span>
<span class="hljs-keyword">const</span> counterReducer = (<span class="hljs-attr">state</span>: <span class="hljs-title class_">State</span>, <span class="hljs-attr">action</span>: <span class="hljs-title class_">Action</span>): <span class="hljs-function"><span class="hljs-params">State</span> =&gt;</span> {
  <span class="hljs-keyword">switch</span> (action.<span class="hljs-property">type</span>) {
    <span class="hljs-keyword">case</span> <span class="hljs-string">'INCREMENT'</span>:
      <span class="hljs-keyword">return</span> { ...state, <span class="hljs-attr">count</span>: state.<span class="hljs-property">count</span> + <span class="hljs-number">1</span> };
    <span class="hljs-keyword">case</span> <span class="hljs-string">'DECREMENT'</span>:
      <span class="hljs-keyword">return</span> { ...state, <span class="hljs-attr">count</span>: state.<span class="hljs-property">count</span> - <span class="hljs-number">1</span> };
    <span class="hljs-keyword">case</span> <span class="hljs-string">'RESET'</span>:
      <span class="hljs-keyword">return</span> { ...state, <span class="hljs-attr">count</span>: action.<span class="hljs-property">payload</span> };
    <span class="hljs-attr">default</span>:
      <span class="hljs-keyword">return</span> state;
  }
};

<span class="hljs-comment">// 4. 组件实现</span>
<span class="hljs-keyword">const</span> <span class="hljs-title class_">Counter</span>: <span class="hljs-title class_">React</span>.<span class="hljs-property">FC</span> = <span class="hljs-function">() =&gt;</span> {
  <span class="hljs-keyword">const</span> [state, dispatch] = <span class="hljs-title function_">useReducer</span>(counterReducer, { <span class="hljs-attr">count</span>: <span class="hljs-number">0</span> });

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">padding:</span> '<span class="hljs-attr">20px</span>', <span class="hljs-attr">textAlign:</span> '<span class="hljs-attr">center</span>' }}&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">h2</span>&gt;</span>当前计数: {state.count}<span class="hljs-tag">&lt;/<span class="hljs-name">h2</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span> =&gt;</span> dispatch({ type: 'INCREMENT' })}&gt;+<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span> =&gt;</span> dispatch({ type: 'DECREMENT' })}&gt;-<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span> =&gt;</span> dispatch({ type: 'RESET', payload: 0 })}&gt;Reset<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
};

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title class_">Counter</span>;
</code></pre>
<hr/>
<h2 data-id="heading-4">三、 深度解析：useReducer 的优势与场景</h2>
<h3 data-id="heading-5">1. 使用场景</h3>
<ul>
<li><strong>复杂状态逻辑</strong>：当状态对象包含多个子属性，且更新逻辑互相依赖时。</li>
<li><strong>性能优化</strong>：如果你需要向深层子组件传递更新逻辑，传递 <code>dispatch</code> 比传递多个 <code>setXXX</code> 函数更高效。因为 <code>dispatch</code> 在组件生命周期内是<strong>恒定不变</strong>的，不会触发子组件多余的渲染。</li>
<li><strong>全局状态管理</strong>：常与 <code>useContext</code> 结合，构建轻量级的全局数据流，替代 Redux。</li>
</ul>
<h3 data-id="heading-6">2. 与 useState 的区别</h3>

























<table><thead><tr><th><strong>特性</strong></th><th><strong>useState</strong></th><th><strong>useReducer</strong></th></tr></thead><tbody><tr><td><strong>逻辑负责度</strong></td><td>简单状态、基础类型</td><td>复杂对象、多个互关状态</td></tr><tr><td><strong>状态更新</strong></td><td>声明式，直接设置新值</td><td>响应式，通过 Action 派发逻辑</td></tr><tr><td><strong>可维护性</strong></td><td>逻辑散落在事件处理函数中</td><td>逻辑集中在 Reducer 纯函数中</td></tr></tbody></table>
<hr/>
<h2 data-id="heading-7">四、 使用技巧</h2>
<p><strong>注意：</strong> Reducer 必须是纯函数。这意味着：</p>
<ul>
<li><strong>不要</strong>在 Reducer 里修改原 state（应返回新对象）。</li>
<li><strong>不要</strong>在 Reducer 里执行有副作用的操作（如 API 请求、随机数生成、Date.now()）。</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[【前端开发】Vue3框架响应式数据详解（Proxy与ref，reactive）]]></title>    <link>https://juejin.cn/post/7600333405979033641</link>    <guid>https://juejin.cn/post/7600333405979033641</guid>    <pubDate>2026-01-29T04:03:11.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600333405979033641" data-draft-id="7600430748780560427" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="【前端开发】Vue3框架响应式数据详解（Proxy与ref，reactive）"/> <meta itemprop="keywords" content="Vue.js"/> <meta itemprop="datePublished" content="2026-01-29T04:03:11.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="幻羽梦溪"/> <meta itemprop="url" content="https://juejin.cn/user/3950988619167705"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            【前端开发】Vue3框架响应式数据详解（Proxy与ref，reactive）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3950988619167705/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    幻羽梦溪
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-29T04:03:11.000Z" title="Thu Jan 29 2026 04:03:11 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><strong>Vue3</strong>的响应式系统是其核心特性之一，<code>ref(data)</code>和<code>reactive(data)</code>是创建响应式数据的两种主要方式。</p>
<h2 data-id="heading-0">一、响应式基础：为什么需要ref和reactive？以及什么是Proxy代理对象？</h2>
<p>在Vue3中，响应式系统完全重写，使用Proxy替代了Vue2的Object.defineProperty。这带来了更好的性能和更强大的功能。<code>ref</code>和<code>reactive</code>是这套新系统的两个核心API，它们都用于创建响应式数据，但在使用方式和场景上有所不同。</p>
<p>Vue3的响应式系统正是基于Proxy实现的。</p>
<p><strong>Proxy</strong>是ES6（ECMAScript 2015）引入的一个强大特性，它允许你创建一个对象的代理，从而可以拦截和自定义该对象的基本操作。简单来说，Proxy就像是在目标对象前面架设一个"拦截层"，外界对该对象的访问和操作都需要先经过这个拦截层，从而实现对对象行为的完全控制。（其实有点类似于JavaWeb里面的Spring AOP切面）</p>
<p><code>const proxy = new Proxy(target, handler)</code></p>
<ul>
<li>
<p><strong>target</strong>：要代理的目标对象</p>
</li>
<li>
<p><strong>handler</strong>：一个包含"陷阱"（trap）的对象，用于定义代理行为</p>
</li>
<li>
<p><strong>proxy</strong>：返回的代理对象，可以像使用原对象一样使用它</p>
</li>
</ul>
<h3 data-id="heading-1">示例1：最简单的Proxy</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 目标对象</span>
<span class="hljs-keyword">const</span> target = { <span class="hljs-attr">name</span>: <span class="hljs-string">"Alice"</span>, <span class="hljs-attr">age</span>: <span class="hljs-number">25</span> }

<span class="hljs-comment">// 处理器对象</span>
<span class="hljs-keyword">const</span> handler = {
  <span class="hljs-title function_">get</span>(<span class="hljs-params">target, property</span>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`正在读取属性: <span class="hljs-subst">${property}</span>`</span>)
    <span class="hljs-keyword">return</span> target[property] <span class="hljs-comment">// 返回实际值</span>
  },
  <span class="hljs-title function_">set</span>(<span class="hljs-params">target, property, value</span>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`正在设置属性: <span class="hljs-subst">${property}</span> = <span class="hljs-subst">${value}</span>`</span>)
    target[property] = value
    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span> <span class="hljs-comment">// 表示设置成功</span>
  }
}

<span class="hljs-comment">// 创建代理</span>
<span class="hljs-keyword">const</span> proxy = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Proxy</span>(target, handler)

<span class="hljs-comment">// 使用代理</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(proxy.<span class="hljs-property">name</span>) <span class="hljs-comment">// 输出: 正在读取属性: name → Alice</span>
proxy.<span class="hljs-property">age</span> = <span class="hljs-number">30</span>         <span class="hljs-comment">// 输出: 正在设置属性: age = 30</span>
</code></pre>
<h2 data-id="heading-2"/>
<h2 data-id="heading-3">二、ref详解：简单值的响应式包装</h2>
<p>对于<code>ref</code>我们一般会在里面放一些非对象类的简单数据，对其赋予响应式特征</p>
<h3 data-id="heading-4">基本用法</h3>
<pre><code class="hljs language-csharp" lang="csharp">import { <span class="hljs-keyword">ref</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>

<span class="hljs-comment">// 创建响应式数据</span>
<span class="hljs-keyword">const</span> count = <span class="hljs-keyword">ref</span>(<span class="hljs-number">0</span>)
<span class="hljs-keyword">const</span> message = <span class="hljs-keyword">ref</span>(<span class="hljs-string">'Hello Vue3'</span>)
<span class="hljs-keyword">const</span> isVisible = <span class="hljs-keyword">ref</span>(<span class="hljs-literal">true</span>)

<span class="hljs-comment">// 访问值需要.value</span>
console.log(count.<span class="hljs-keyword">value</span>) <span class="hljs-comment">// 0</span>

<span class="hljs-comment">// 修改值</span>
count.<span class="hljs-keyword">value</span> = <span class="hljs-number">10</span>
</code></pre>
<h3 data-id="heading-5">特点</h3>
<ol>
<li><strong>包装基本类型</strong>：可以包装数字、字符串、布尔值等原始类型</li>
<li><strong>.value访问</strong>：需要通过<code>.value</code>属性访问或修改值</li>
<li><strong>模板中无需.value</strong>：在模板中自动解包，直接使用变量名</li>
<li><strong>对象也可包装</strong>：虽然常用于基本类型，但也可以包装对象</li>
</ol>
<h3 data-id="heading-6">适用场景</h3>
<ul>
<li>基本数据类型（字符串、数字、布尔值）</li>
<li>需要在多处引用的单个值</li>
<li>需要明确知道何时访问/修改值的情况</li>
</ul>
<h2 data-id="heading-7">三、reactive详解：对象的深度响应式</h2>
<h3 data-id="heading-8">基本用法</h3>
<pre><code class="hljs language-php" lang="php">import { reactive } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>

<span class="hljs-comment">// 创建响应式对象</span>
<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">user</span> = <span class="hljs-title function_ invoke__">reactive</span>({
  <span class="hljs-attr">name</span>: <span class="hljs-string">'张三'</span>,
  <span class="hljs-attr">age</span>: <span class="hljs-number">25</span>,
  <span class="hljs-attr">profile</span>: {
    <span class="hljs-attr">email</span>: <span class="hljs-string">'zhangsan@example.com'</span>,
    <span class="hljs-attr">address</span>: {
      <span class="hljs-attr">city</span>: <span class="hljs-string">'北京'</span>,
      <span class="hljs-attr">street</span>: <span class="hljs-string">'朝阳路'</span>
    }
  }
})

<span class="hljs-comment">// 直接访问属性</span>
console.<span class="hljs-title function_ invoke__">log</span>(user.name) <span class="hljs-comment">// 张三</span>
user.age = <span class="hljs-number">26</span> <span class="hljs-comment">// 自动响应式更新</span>

<span class="hljs-comment">// 嵌套属性也是响应式的</span>
user.profile.address.city = <span class="hljs-string">'上海'</span>
</code></pre>
<h3 data-id="heading-9">特点</h3>
<ol>
<li><strong>深度响应式</strong>：对象的所有嵌套属性都是响应式的</li>
<li><strong>直接访问</strong>：不需要<code>.value</code>，直接使用属性</li>
<li><strong>仅限对象</strong>：只能用于对象类型（对象、数组、Map、Set等）</li>
<li><strong>保持引用</strong>：返回的是原始对象的Proxy代理</li>
</ol>
<h3 data-id="heading-10">适用场景</h3>
<ul>
<li>复杂对象或数据结构</li>
<li>表单数据</li>
<li>需要深度监听的对象</li>
<li>状态管理中的模块状态</li>
</ul>
<h2 data-id="heading-11">四、ref vs reactive：核心差异对比</h2>








































<table><thead><tr><th>特性</th><th>ref</th><th>reactive</th></tr></thead><tbody><tr><td>数据类型</td><td>任意类型</td><td>仅对象类型</td></tr><tr><td>访问方式</td><td>需要<code>.value</code></td><td>直接访问属性</td></tr><tr><td>模板使用</td><td>自动解包</td><td>直接使用</td></tr><tr><td>重新分配</td><td>可重新赋值整个<code>.value</code></td><td>不能重新赋值整个对象</td></tr><tr><td>解构问题</td><td>保持响应式需<code>toRefs</code>配合</td><td>直接解构会丢失响应式</td></tr><tr><td>TypeScript支持</td><td>更好的类型推断</td><td>类型保持</td></tr></tbody></table></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[React-useImmerReducer进阶]]></title>    <link>https://juejin.cn/post/7600370554068975642</link>    <guid>https://juejin.cn/post/7600370554068975642</guid>    <pubDate>2026-01-29T04:09:29.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600370554068975642" data-draft-id="7600508556102991922" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="React-useImmerReducer进阶"/> <meta itemprop="keywords" content="前端,面试,React.js"/> <meta itemprop="datePublished" content="2026-01-29T04:09:29.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="发现一只大呆瓜"/> <meta itemprop="url" content="https://juejin.cn/user/180747382561607"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            React-useImmerReducer进阶
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/180747382561607/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    发现一只大呆瓜
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-29T04:09:29.000Z" title="Thu Jan 29 2026 04:09:29 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h3 data-id="heading-0">前言</h3>
<p>在 React 中，<code>useReducer</code> 是处理复杂状态的首选方案。但传统的 Reducer 要求我们必须返回一个新的状态对象，这导致代码中充斥着大量的展开运算符（Spread Operator）。通过结合 <code>Immer</code>，我们可以像修改普通对象一样操作状态，同时保持 React 要求的“不可变性”。</p>
<h2 data-id="heading-1">一、 为什么选择 useImmerReducer？</h2>
<h3 data-id="heading-2">1. 产生背景</h3>
<p>原生 <code>useReducer</code> 的核心是“不可变性”，更新深层嵌套对象时非常繁琐：</p>
<pre><code class="hljs language-TSX" lang="TSX"><span class="hljs-comment">// 原生 useReducer 的痛苦：需要手动保证不可变性</span>
<span class="hljs-keyword">return</span> { ...state, <span class="hljs-attr">user</span>: { ...state.<span class="hljs-property">user</span>, <span class="hljs-attr">age</span>: state.<span class="hljs-property">user</span>.<span class="hljs-property">age</span> + <span class="hljs-number">1</span> } };
</code></pre>
<h3 data-id="heading-3">2. useImmerReducer 的优势</h3>
<ul>
<li><strong>直接修改</strong>：可以使用 <code>push</code>、<code>pop</code> 或直接赋值（<code>draft.count++</code>）。</li>
<li><strong>无需显式返回</strong>：Immer 会自动帮你对比 <code>draft</code> 的变化并生成新的 <code>state</code>。</li>
<li><strong>代码极简</strong>：消除冗长的结构赋值，让 Reducer 逻辑更聚焦于业务。</li>
</ul>
<hr/>
<h2 data-id="heading-4">二、 语法拆解</h2>
<p>在使用前，请确保安装了相关依赖：<code>npm install immer use-immer</code>。</p>
<pre><code class="hljs language-TSX" lang="TSX"><span class="hljs-keyword">const</span> [state, dispatch] = <span class="hljs-title function_">useImmerReducer</span>(reducer, initialState);
</code></pre>
<ul>
<li><strong>reducer</strong>: <code>(draft, action) =&gt; void</code>。此时第一个参数不再是不可变的 <code>state</code>，而是可直接修改的代理对象 <strong><code>draft</code></strong>（草稿）。</li>
<li><strong>initialState</strong>: 初始状态。</li>
<li><strong>dispatch</strong>: 与原生 <code>useReducer</code> 一致，用于派发动作。</li>
</ul>
<hr/>
<h2 data-id="heading-5">三、 TSX 实战示例：强类型计数器</h2>
<p>在 TSX 中，我们通过定义接口和联合类型来确保类型安全。</p>
<pre><code class="hljs language-TSX" lang="TSX"><span class="hljs-keyword">import</span> <span class="hljs-title class_">React</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;
<span class="hljs-keyword">import</span> { useImmerReducer } <span class="hljs-keyword">from</span> <span class="hljs-string">'use-immer'</span>;

<span class="hljs-comment">// 1. 定义状态类型</span>
<span class="hljs-keyword">interface</span> <span class="hljs-title class_">CounterState</span> {
  <span class="hljs-attr">count</span>: <span class="hljs-built_in">number</span>;
  <span class="hljs-attr">history</span>: <span class="hljs-built_in">string</span>[]; <span class="hljs-comment">// 增加一个数组，演示 Immer 的便捷性</span>
}

<span class="hljs-comment">// 2. 定义 Action 类型</span>
<span class="hljs-keyword">type</span> <span class="hljs-title class_">CounterAction</span> =
  | { <span class="hljs-attr">type</span>: <span class="hljs-string">'INCREMENT'</span> }
  | { <span class="hljs-attr">type</span>: <span class="hljs-string">'DECREMENT'</span> }
  | { <span class="hljs-attr">type</span>: <span class="hljs-string">'RESET'</span>; payload?: <span class="hljs-built_in">number</span> };

<span class="hljs-comment">// 3. 编写 Immer 风格的 Reducer</span>
<span class="hljs-comment">// 注意：参数是 draft，且不需要 return</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">counterReducer</span> = (<span class="hljs-params">draft: CounterState, action: CounterAction</span>) =&gt; {
  <span class="hljs-keyword">switch</span> (action.<span class="hljs-property">type</span>) {
    <span class="hljs-keyword">case</span> <span class="hljs-string">"INCREMENT"</span>:
      draft.<span class="hljs-property">count</span> += <span class="hljs-number">1</span>;
      draft.<span class="hljs-property">history</span>.<span class="hljs-title function_">push</span>(<span class="hljs-string">'加一'</span>); <span class="hljs-comment">// 直接使用数组原生方法</span>
      <span class="hljs-keyword">break</span>;
    <span class="hljs-keyword">case</span> <span class="hljs-string">"DECREMENT"</span>:
      draft.<span class="hljs-property">count</span> -= <span class="hljs-number">1</span>;
      draft.<span class="hljs-property">history</span>.<span class="hljs-title function_">push</span>(<span class="hljs-string">'减一'</span>);
      <span class="hljs-keyword">break</span>;
    <span class="hljs-keyword">case</span> <span class="hljs-string">"RESET"</span>:
      draft.<span class="hljs-property">count</span> = action.<span class="hljs-property">payload</span> || <span class="hljs-number">0</span>;
      draft.<span class="hljs-property">history</span> = []; <span class="hljs-comment">// 重置数组</span>
      <span class="hljs-keyword">break</span>;
    <span class="hljs-attr">default</span>:
      <span class="hljs-comment">// 无需处理 default 情况下的返回，Immer 会自动处理</span>
      <span class="hljs-keyword">break</span>;
  }
};

<span class="hljs-comment">// 4. 组件实现</span>
<span class="hljs-keyword">const</span> <span class="hljs-title class_">Counter</span>: <span class="hljs-title class_">React</span>.<span class="hljs-property">FC</span> = <span class="hljs-function">() =&gt;</span> {
  <span class="hljs-keyword">const</span> [state, dispatch] = <span class="hljs-title function_">useImmerReducer</span>(counterReducer, { 
    <span class="hljs-attr">count</span>: <span class="hljs-number">0</span>, 
    <span class="hljs-attr">history</span>: [] 
  });

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">padding:</span> '<span class="hljs-attr">20px</span>' }}&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>当前数值: {state.count}<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span> =&gt;</span> dispatch({ type: 'INCREMENT' })}&gt;+<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span> =&gt;</span> dispatch({ type: 'DECREMENT' })}&gt;-<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span> =&gt;</span> dispatch({ type: 'RESET', payload: 0 })}&gt;重置<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
      
      <span class="hljs-tag">&lt;<span class="hljs-name">h4</span>&gt;</span>操作历史记录：<span class="hljs-tag">&lt;/<span class="hljs-name">h4</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">ul</span>&gt;</span>
        {state.history.map((item, index) =&gt; (
          <span class="hljs-tag">&lt;<span class="hljs-name">li</span> <span class="hljs-attr">key</span>=<span class="hljs-string">{index}</span>&gt;</span>{item}<span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span>
        ))}
      <span class="hljs-tag">&lt;/<span class="hljs-name">ul</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
};

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title class_">Counter</span>;
</code></pre>
<hr/>
<h2 data-id="heading-6">四、 核心细节与进阶补充</h2>
<h3 data-id="heading-7">1. 为什么不需要 <code>return</code>？</h3>
<p>在 <code>useImmerReducer</code> 中，Immer 内部使用了 <strong>Proxy</strong>。当你修改 <code>draft</code> 时，它会记录所有的“变更指令”。函数执行结束时，Immer 会根据这些指令生成一个全新的、不可变的状态对象。</p>
<h3 data-id="heading-8">2. 性能开销</h3>
<p>虽然创建 <code>Proxy</code> 代理会有细微的性能开销，但在绝大多数业务场景下（如复杂的表单管理、大型列表操作），它减少了大量解构赋值带来的内存开销和逻辑复杂度，是完全值得的。</p>
<h3 data-id="heading-9">3. 注意事项</h3>
<ul>
<li><strong>不要尝试返回 <code>draft</code></strong>：Reducer 函数内部直接操作即可，不需要 <code>return draft</code>。</li>
<li><strong>不要在外部持有 <code>draft</code> 引用</strong>：<code>draft</code> 仅在 Reducer 函数执行期间有效。</li>
<li><strong>配合 TypeScript</strong>：使用 TSX 时，明确定义 <code>Action</code> 的类型可以获得完美的智能补全，防止拼写错误（如把 <code>INCREMENT</code> 拼成 <code>INCREEMENT</code>）。</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[【CesiumJS】1. 快速开始]]></title>    <link>https://juejin.cn/post/7600380007885652018</link>    <guid>https://juejin.cn/post/7600380007885652018</guid>    <pubDate>2026-01-29T05:00:23.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600380007885652018" data-draft-id="7600260767688081434" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="【CesiumJS】1. 快速开始"/> <meta itemprop="keywords" content="cesium,数据可视化"/> <meta itemprop="datePublished" content="2026-01-29T05:00:23.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="数佳"/> <meta itemprop="url" content="https://juejin.cn/user/1733274175541037"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            【CesiumJS】1. 快速开始
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1733274175541037/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    数佳
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-29T05:00:23.000Z" title="Thu Jan 29 2026 05:00:23 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>官方 CesiumJS 教程：<a href="https://link.juejin.cn?target=https%3A%2F%2Fcesium.com%2Flearn%2Fcesiumjs-learn%2F" target="_blank" title="https://cesium.com/learn/cesiumjs-learn/" ref="nofollow noopener noreferrer">cesium.com/learn/cesiu…</a></p>
<ul>
<li>Cesium 是一款开源 JavaScript 库，是面向网页端的 3D 地理空间可视化开发平台。</li>
<li>在高精度 WGS84 地球模型上进行可视化与分析。</li>
</ul>
<h2 data-id="heading-0">1. 创建账户并获取 token</h2>
<p>Cesium ion 是一款用于 3D 内容流式传输与托管的开放式平台。</p>
<p>免费<a href="https://link.juejin.cn?target=https%3A%2F%2Fion.cesium.com%2Fsignup" target="_blank" title="https://ion.cesium.com/signup" ref="nofollow noopener noreferrer">注册</a>一个 Cesium ion 账户，即可在应用中获取全球卫星图像和真实世界的 3D 内容。</p>
<p>进入 <code>Access Tokens</code> tab，复制 token。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/062a67d6d8f44387a028db65df29c7b3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pWw5L2z:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770267623&amp;x-signature=TuQy9x8MXLAjGUH3DUqco0lnxEI%3D" alt="4.png" loading="lazy"/></p>
<h2 data-id="heading-1">2. 搭建 CesiumJS 客户端</h2>
<p>CesiumJS 是一款开源的 JavaScript 引擎。我们将通过它来可视化从 Cesium ion 加载的内容。</p>
<p>注：将 <code>your_access_token</code> 替换为 2.1. 中获取的 token</p>
<h3 data-id="heading-2">2.1 CDN 引入</h3>
<p>使用 Cesium 需要引入两个文件，分别是<code>Cesium.js</code> 和 <code>widgets.css</code> 。</p>
<p>使用 <code>Open With Live Server</code> 打开才可以正确运行。</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"en"</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">"utf-8"</span>&gt;</span>
  <span class="hljs-comment">&lt;!-- Include the CesiumJS JavaScript and CSS files --&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"https://cesium.com/downloads/cesiumjs/releases/1.135/Build/Cesium/Cesium.js"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">link</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"https://cesium.com/downloads/cesiumjs/releases/1.135/Build/Cesium/Widgets/widgets.css"</span> <span class="hljs-attr">rel</span>=<span class="hljs-string">"stylesheet"</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"cesiumContainer"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"module"</span>&gt;</span><span class="javascript">
    <span class="hljs-comment">// Your access token can be found at: https://ion.cesium.com/tokens.</span>
    <span class="hljs-comment">// This is the default access token from your ion account</span>

    <span class="hljs-title class_">Cesium</span>.<span class="hljs-property">Ion</span>.<span class="hljs-property">defaultAccessToken</span> = <span class="hljs-string">'your_access_token'</span>;

    <span class="hljs-comment">// Initialize the Cesium Viewer in the HTML element with the `cesiumContainer` ID.</span>
    <span class="hljs-keyword">const</span> viewer = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Cesium</span>.<span class="hljs-title class_">Viewer</span>(<span class="hljs-string">'cesiumContainer'</span>);    
  </span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
 <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span>
</code></pre>
<h3 data-id="heading-3">2.2 npm 安装</h3>
<p>如果使用 Webpack、Parcel 或 Rollup 等模块打包工具构建应用，则可以通过运行以下命令安装 CesiumJS：</p>
<pre><code class="hljs language-bash" lang="bash">npm install cesium
</code></pre>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// The URL on your server where CesiumJS's static files are hosted.</span>
<span class="hljs-variable language_">window</span>.<span class="hljs-property">CESIUM_BASE_URL</span> = <span class="hljs-string">'/'</span>;

<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Ion</span>, <span class="hljs-title class_">Viewer</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'cesium'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-string">"cesium/Build/Cesium/Widgets/widgets.css"</span>;

<span class="hljs-comment">// Your access token can be found at: https://ion.cesium.com/tokens.</span>
<span class="hljs-comment">// This is the default access token from your ion account</span>
<span class="hljs-title class_">Ion</span>.<span class="hljs-property">defaultAccessToken</span> = <span class="hljs-string">'your_access_token'</span>;

<span class="hljs-comment">// Initialize the Cesium Viewer in the HTML element with the `cesiumContainer` ID.</span>
<span class="hljs-keyword">const</span> viewer = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Viewer</span>(<span class="hljs-string">'cesiumContainer'</span>);
</code></pre>
<p><strong>配置 CESIUM_BASE_URL</strong></p>
<p>CesiumJS 需要一些静态文件托管在您的服务器上，例如 Web Worker 和 SVG 图标。</p>
<p>请将以下目录复制到项目中，并和前端项目一起部署至自己的服务器，将它们作为静态文件提供。</p>
<ul>
<li><code>node_modules/cesium/Build/Cesium/Workers</code></li>
<li><code>node_modules/cesium/Build/Cesium/ThirdParty</code></li>
<li><code>node_modules/cesium/Build/Cesium/Assets</code></li>
<li><code>node_modules/cesium/Build/Cesium/Widgets</code></li>
</ul>
<p>必须在导入 CesiumJS 之前设置全局变量 <code>window.CESIUM_BASE_URL</code> 。它必须指向提供这四个目录的 URL。例如将上述四个文件复制至 public 目录下，则 <code>window.CESIUM_BASE_URL = "/"</code> 。</p>
<p><strong>在 React 的 Next 框架中使用Cesium</strong></p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-string">"use client"</span>;

<span class="hljs-comment">// The URL on your server where CesiumJS's static files are hosted.</span>
<span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> <span class="hljs-variable language_">window</span> !== <span class="hljs-string">"undefined"</span>) {
  (<span class="hljs-variable language_">window</span> <span class="hljs-keyword">as</span> any).<span class="hljs-property">CESIUM_BASE_URL</span> = <span class="hljs-string">"/"</span>;
}

<span class="hljs-keyword">import</span> { useEffect, useRef } <span class="hljs-keyword">from</span> <span class="hljs-string">"react"</span>;
<span class="hljs-keyword">import</span> {
  <span class="hljs-title class_">Ion</span>,
  <span class="hljs-title class_">Terrain</span>,
  <span class="hljs-title class_">Viewer</span>,
} <span class="hljs-keyword">from</span> <span class="hljs-string">"cesium"</span>;
<span class="hljs-keyword">import</span> <span class="hljs-string">"cesium/Build/Cesium/Widgets/widgets.css"</span>;

<span class="hljs-comment">// Your access token can be found at: https://ion.cesium.com/tokens.</span>
<span class="hljs-comment">// This is the default access token from your ion account</span>
<span class="hljs-title class_">Ion</span>.<span class="hljs-property">defaultAccessToken</span> = <span class="hljs-string">"your_access_token"</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">Home</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> cesiumContainerRef = useRef&lt;<span class="hljs-title class_">HTMLDivElement</span>&gt;(<span class="hljs-literal">null</span>);
  <span class="hljs-keyword">const</span> viewerRef = useRef&lt;<span class="hljs-title class_">Viewer</span> | <span class="hljs-literal">null</span>&gt;(<span class="hljs-literal">null</span>);

  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-comment">// 确保容器存在后再初始化 Viewer</span>
    <span class="hljs-keyword">if</span> (!cesiumContainerRef.<span class="hljs-property">current</span>) <span class="hljs-keyword">return</span>;

    <span class="hljs-comment">// Initialize the Cesium Viewer</span>
    <span class="hljs-keyword">const</span> viewer = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Viewer</span>(cesiumContainerRef.<span class="hljs-property">current</span>);

    viewerRef.<span class="hljs-property">current</span> = viewer;

    <span class="hljs-comment">// 组件卸载时销毁 viewer</span>
    <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> {
      <span class="hljs-keyword">if</span> (viewerRef.<span class="hljs-property">current</span>) {
        viewerRef.<span class="hljs-property">current</span>.<span class="hljs-title function_">destroy</span>();
        viewerRef.<span class="hljs-property">current</span> = <span class="hljs-literal">null</span>;
      }
    };
  }, []);

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">{cesiumContainerRef}</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">width:</span> "<span class="hljs-attr">100</span>%", <span class="hljs-attr">height:</span> "<span class="hljs-attr">100vh</span>" }} /&gt;</span></span>
  );
}
</code></pre>
<h2 data-id="heading-4">3. Cesium 目录结构</h2>
<p>下载源码：<a href="https://link.juejin.cn?target=https%3A%2F%2Fcesium.com%2Fdownloads%2F" target="_blank" title="https://cesium.com/downloads/" ref="nofollow noopener noreferrer">cesium.com/downloads/</a></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6fbbe6d709744aec94d16ee1b3656092~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pWw5L2z:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770267623&amp;x-signature=JQCIk8DJOJbXzZiTwEV0V0bBhXQ%3D" alt="1.png" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7a6df51447ea4548a2e623c53d460bf6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pWw5L2z:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770267623&amp;x-signature=jGBZT%2FEUCHxjCe4j7C1GyIkYxrg%3D" alt="2.png" loading="lazy"/></p>
<ul>
<li><code>Apps</code>: Cesium 示例代码和数据。
<ul>
<li><code>CesiumViewer</code>：一个简单的 Cesium 初始化示例。</li>
<li><code>SampleData</code>：所有示例代码所用到的数据，包括 json、geoJson、topojson、kml、czml、gltf、3dtiles 以及图片等。</li>
<li><code>Sandcastle</code>：Ceisum 的示例程序代码，查阅每一个示例代码，一定会有新的收获。</li>
<li><code>TimelineDemo</code>：时间轴示例代码。</li>
</ul>
</li>
<li><code>Build</code>：用于生产环境的包和文档。
<ul>
<li><code>Cesium</code>：打包之后的 Cesium 库（压缩）。</li>
<li><code>CesiumUnminified</code>：打包之后的 Cesium 库（未压缩），引用该文件可方便开发人员进行调试，找到程序异常或报错的具体代码位置。</li>
<li><code>Documentation</code>：打包之后的 API 文档。</li>
</ul>
</li>
<li><code>packages</code>：Cesium 源码，主要分为 engine（引擎）和 widgets（部件）。</li>
<li><code>Source</code>：Cesium 源码的索引文件。</li>
<li><code>Specs</code>：自动化单元测试，采用了 Jasmine 框架 ，可以实现接口的自动化测试以及接口覆盖率等统计效果。</li>
<li><code>ThirdParty</code>：所依赖的第三方库，比如代码编辑器 codemirror、单元测试框架库 Jasmine、JavaScript 语法和风格的检查工具 JSHint 等。</li>
<li><code>CHANGES.md</code>：Cesium 每个版本的变更记录。</li>
<li><code>gulpfile.js</code>：打包脚本，记录了 Cesium 的所有打包流程，包括 GLSL 语法的转义、压缩和未压缩库文件的打包、API 文档的生成以及自动化单元测试等。</li>
<li><code>index.html</code>：Web 首页。</li>
<li><code>server.js</code>：Cesium 内置的 Node 服务器文件，命令 <code>npm run start</code> 以及 <code>npm run start-public</code> 实际上执行的文件。</li>
</ul>
<p>用 <code>VS Code</code> 打开解压后的文件夹，打开根目录下的 <code>index.html</code>，右击 <code>Open With Live Server</code> ；或者 <code>npm install</code>，<code>npm run start</code>运行界面如下：</p>
<ul>
<li><code>Cesium ion</code>：Cesium 的数据服务平台，包含在线资源-地形(createWorldTerrain)、影像(createWorldImagery/IonImageryProvider)、OSM (createOsmBuildings)、点云 (IonResource.fromAssetId)、3DTiles 等。</li>
<li><code>Local links</code>：Cesium 本地资源链接，文档、示例、单元测试等。</li>
<li><code>External links</code>：Cesium 外部资源链接，社区、博客、GitHub等。</li>
</ul>
<p>Local links 选项包含了文档和示例等，打开后和官网一样，可以使用下载的包部署一个离线版本，方便没有网络时使用。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5bcc7c9f1e6f409d9bbaaad4df526f79~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pWw5L2z:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770267623&amp;x-signature=F0%2BIQMDF8rZaRHf%2BAdFGWL2%2Blqc%3D" alt="3.png" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[在 Nuxt 3 中使用 transformers.js 实现浏览器端中英翻译（支持本地模型与进度条）]]></title>    <link>https://juejin.cn/post/7600508556103090226</link>    <guid>https://juejin.cn/post/7600508556103090226</guid>    <pubDate>2026-01-29T05:09:39.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600508556103090226" data-draft-id="7600370554069155866" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="在 Nuxt 3 中使用 transformers.js 实现浏览器端中英翻译（支持本地模型与进度条）"/> <meta itemprop="keywords" content="前端,Node.js"/> <meta itemprop="datePublished" content="2026-01-29T05:09:39.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="不知处"/> <meta itemprop="url" content="https://juejin.cn/user/3461681342332408"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            在 Nuxt 3 中使用 transformers.js 实现浏览器端中英翻译（支持本地模型与进度条）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3461681342332408/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    不知处
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-29T05:09:39.000Z" title="Thu Jan 29 2026 05:09:39 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">背景与目标</h2>
<p>本文介绍如何在 <strong>Nuxt 3</strong> 项目中，利用 <strong>transformers.js + Xenova 翻译模型</strong>，实现完全运行在浏览器端的中英文互译能力，并满足：</p>
<ul>
<li>模型文件<strong>部署在公司内网服务器</strong>，无外网依赖。</li>
<li>首次加载模型时有<strong>下载进度提示</strong>。</li>
<li>支持中 → 英、英 → 中双向翻译。</li>
</ul>
<p>整套方案适合对隐私敏感（不想把文本发云端）、且希望快速集成前端 AI 翻译能力的业务场景。<a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.aliyun.com%2Farticle%2F1620027" target="_blank" title="https://developer.aliyun.com/article/1620027" ref="nofollow noopener noreferrer"/></p>
<hr/>
<h2 data-id="heading-1">1. 模型选型与部署方案</h2>
<h2 data-id="heading-2">1.1 模型选型</h2>
<p>在浏览器端做翻译，需要在 <strong>效果</strong> 与 <strong>体积</strong> 之间权衡。常见选择：</p>
<ol>
<li>
<p><strong>Xenova/opus-mt-zh-en &amp; Xenova/opus-mt-en-zh</strong></p>
<ul>
<li>基于 Helsinki-NLP 的 OPUS-MT（Marian）模型的 ONNX 版本。<a href="https://link.juejin.cn?target=https%3A%2F%2Fhuggingface.co%2FXenova%2Fopus-mt-en-zh" target="_blank" title="https://huggingface.co/Xenova/opus-mt-en-zh" ref="nofollow noopener noreferrer"/></li>
<li>针对中英单语对，体积相对较小（单模型约几十 MB 级）。<a href="https://link.juejin.cn?target=https%3A%2F%2Fgist.github.com%2Fcomaniac%2Fd6d037ce3189e3ecd63eb99f1c4d53a2" target="_blank" title="https://gist.github.com/comaniac/d6d037ce3189e3ecd63eb99f1c4d53a2" ref="nofollow noopener noreferrer"/>​</li>
<li>已由 Xenova 适配 transformers.js，开箱即用。<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.npmjs.com%2Fpackage%2F%40xenova%2Ftransformers" target="_blank" title="https://www.npmjs.com/package/@xenova/transformers" ref="nofollow noopener noreferrer"/></li>
<li>综合考虑浏览器加载性能与实现难度，是当前<strong>最现实的中英文浏览器端翻译方案</strong>。</li>
</ul>
</li>
<li>
<p><strong>Xenova/nllb-200-distilled-600M</strong>（更高质量但更大）</p>
<ul>
<li>基于 Meta NLLB-200 的 600M 蒸馏版，可翻译 200 语言。<a href="https://link.juejin.cn?target=https%3A%2F%2Fhuggingface.co%2Fdocs%2Ftransformers%2Fmodel_doc%2Fnllb" target="_blank" title="https://huggingface.co/docs/transformers/model_doc/nllb" ref="nofollow noopener noreferrer"/></li>
<li>翻译效果普遍优于 OPUS-MT，但体积大（600M 级），浏览器端首次加载时间明显增加。<a href="https://link.juejin.cn?target=https%3A%2F%2Fhuggingface.co%2FXenova%2Fnllb-200-distilled-600M" target="_blank" title="https://huggingface.co/Xenova/nllb-200-distilled-600M" ref="nofollow noopener noreferrer"/></li>
<li>更适合桌面环境或对质量极度敏感的场景。</li>
</ul>
</li>
</ol>
<p>在公司内部部署、关注首屏性能的前提下，本文采用：</p>
<ul>
<li><code>Xenova/opus-mt-zh-en</code>：中文 → 英文。<a href="https://link.juejin.cn?target=https%3A%2F%2Fhuggingface.co%2FXenova%2Fopus-mt-zh-en" target="_blank" title="https://huggingface.co/Xenova/opus-mt-zh-en" ref="nofollow noopener noreferrer"/>​</li>
<li><code>Xenova/opus-mt-en-zh</code>：英文 → 中文。<a href="https://link.juejin.cn?target=https%3A%2F%2Fhuggingface.co%2FXenova%2Fopus-mt-en-zh" target="_blank" title="https://huggingface.co/Xenova/opus-mt-en-zh" ref="nofollow noopener noreferrer"/>​</li>
</ul>
<h2 data-id="heading-3">1.2 模型下载与目录结构</h2>
<p>在 Nuxt 项目根目录下，使用 <code>public</code> 作为静态资源目录（Nuxt 会原样暴露为静态资源）：<a href="https://juejin.cn/post/7238570834344067131" target="_blank" title="https://juejin.cn/post/7238570834344067131"/>​</p>
<pre><code class="hljs language-bash" lang="bash">bash
<span class="hljs-comment"># 在项目根目录执行</span>
<span class="hljs-built_in">mkdir</span> -p public/models/Xenova

<span class="hljs-comment"># 下中 -&gt; 英</span>
git <span class="hljs-built_in">clone</span> https://huggingface.co/Xenova/opus-mt-zh-en public/models/Xenova/opus-mt-zh-en

<span class="hljs-comment"># 下英 -&gt; 中</span>
git <span class="hljs-built_in">clone</span> https://huggingface.co/Xenova/opus-mt-en-zh public/models/Xenova/opus-mt-en-zh
</code></pre>
<p>目录结构大致如下：</p>
<pre><code class="hljs language-arduino" lang="arduino">text
your-nuxt-app/
  <span class="hljs-keyword">public</span>/
    models/
      Xenova/
        opus-mt-zh-en/
          config.json
          tokenizer.json
          vocab files...
          onnx/
            model.onnx
            ...
        opus-mt-en-zh/
          ...
</code></pre>
<p>Nuxt 打包后，可直接通过 URL 访问：</p>
<ul>
<li><code>/models/Xenova/opus-mt-zh-en/config.json</code></li>
<li><code>/models/Xenova/opus-mt-en-zh/onnx/model.onnx</code></li>
</ul>
<p>浏览器端的 transformers.js 会按模型 ID 映射到这些路径读取文件。<a href="https://link.juejin.cn?target=https%3A%2F%2Fhugging-face.cn%2Fdocs%2Ftransformers.js%2Fapi%2Fenv" target="_blank" title="https://hugging-face.cn/docs/transformers.js/api/env" ref="nofollow noopener noreferrer"/></p>
<hr/>
<h2 data-id="heading-4">2. 在 Nuxt 3 中集成 transformers.js</h2>
<h2 data-id="heading-5">2.1 安装依赖</h2>
<pre><code class="hljs language-bash" lang="bash">bash
npm install @xenova/transformers
</code></pre>
<p><code>@xenova/transformers</code> 是 transformers.js 在 npm 上的包名，支持浏览器环境、提供 ONNX 推理能力。<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.npmjs.com%2Fpackage%2F%40xenova%2Ftransformers" target="_blank" title="https://www.npmjs.com/package/@xenova/transformers" ref="nofollow noopener noreferrer"/>​</p>
<h2 data-id="heading-6">2.2 创建 Nuxt 插件：统一封装翻译逻辑</h2>
<p>我们在 <code>plugins/transformers.client.ts</code> 中：</p>
<ul>
<li>配置 transformers.js 使用本地模型路径。</li>
<li>提供 <code>translate(text, dir)</code> 方法供组件调用。</li>
<li>增加 <code>progress_callback</code>，用于显示模型下载进度。<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fhuggingface%2Ftransformers.js%2Fissues%2F735" target="_blank" title="https://github.com/huggingface/transformers.js/issues/735" ref="nofollow noopener noreferrer"/></li>
</ul>
<pre><code class="hljs language-ini" lang="ini">ts
// plugins/transformers.client.ts
import { defineNuxtPlugin } from '<span class="hljs-comment">#app';</span>
import { pipeline, env } from '@xenova/transformers'<span class="hljs-comment">;</span>

export default defineNuxtPlugin(() =&gt; {
  // 只用本地模型，不访问外网
  <span class="hljs-attr">env.allowRemoteModels</span> = <span class="hljs-literal">false</span><span class="hljs-comment">;</span>
  // 指向 /public/models 目录
  <span class="hljs-attr">env.localModelPath</span> = <span class="hljs-string">'/models/'</span><span class="hljs-comment">;            // 注意末尾斜杠</span>
  // 开启浏览器缓存（IndexedDB + Cache Storage）
  <span class="hljs-attr">env.useBrowserCache</span> = <span class="hljs-literal">true</span><span class="hljs-comment">;                 // 下次加载更快</span>

  // 用于 UI 层显示加载状态
  const <span class="hljs-attr">loadingStatus</span> = ref({
    model: null as string | null,
    progress: 0,
    status: 'idle' as 'idle' | 'loading' | 'ready' | 'error',
    message: '',
  })<span class="hljs-comment">;</span>

  let zh2enPromise: Promise&lt;any&gt; | <span class="hljs-attr">null</span> = null<span class="hljs-comment">;</span>
  let en2zhPromise: Promise&lt;any&gt; | <span class="hljs-attr">null</span> = null<span class="hljs-comment">;</span>

  // transformers.js 的下载 / 加载进度回调<span class="hljs-section">[web:66]</span><span class="hljs-section">[web:67]</span><span class="hljs-section">[web:68]</span><span class="hljs-section">[web:70]</span>
  const <span class="hljs-attr">progressCallback</span> = (args: any) =&gt; {
    if (<span class="hljs-attr">args.status</span> === <span class="hljs-string">'progress'</span>) {
      <span class="hljs-attr">loadingStatus.value.progress</span> = Math.round(args.progress)<span class="hljs-comment">;</span>
      <span class="hljs-attr">loadingStatus.value.message</span> = args.file || <span class="hljs-string">'模型文件'</span><span class="hljs-comment">;</span>
    } else if (<span class="hljs-attr">args.status</span> === <span class="hljs-string">'loading'</span>) {
      <span class="hljs-attr">loadingStatus.value.status</span> = <span class="hljs-string">'loading'</span><span class="hljs-comment">;</span>
      <span class="hljs-attr">loadingStatus.value.model</span> = args.model<span class="hljs-comment">;</span>
      <span class="hljs-attr">loadingStatus.value.message</span> = <span class="hljs-string">'开始加载模型'</span><span class="hljs-comment">;</span>
    } else if (<span class="hljs-attr">args.status</span> === <span class="hljs-string">'ready'</span>) {
      <span class="hljs-attr">loadingStatus.value.status</span> = <span class="hljs-string">'ready'</span><span class="hljs-comment">;</span>
      <span class="hljs-attr">loadingStatus.value.message</span> = <span class="hljs-string">'模型加载完成'</span><span class="hljs-comment">;</span>
    } else if (<span class="hljs-attr">args.status</span> === <span class="hljs-string">'error'</span>) {
      <span class="hljs-attr">loadingStatus.value.status</span> = <span class="hljs-string">'error'</span><span class="hljs-comment">;</span>
      <span class="hljs-attr">loadingStatus.value.message</span> = <span class="hljs-string">'模型加载失败'</span><span class="hljs-comment">;</span>
    }
  }<span class="hljs-comment">;</span>

  const <span class="hljs-attr">getZh2En</span> = () =&gt; {
    if (!zh2enPromise) {
      <span class="hljs-attr">loadingStatus.value.model</span> = <span class="hljs-string">'Xenova/opus-mt-zh-en'</span><span class="hljs-comment">;</span>
      <span class="hljs-attr">zh2enPromise</span> = pipeline(<span class="hljs-string">'translation'</span>, <span class="hljs-string">'Xenova/opus-mt-zh-en'</span>, {
        progress_callback: progressCallback,
      })<span class="hljs-comment">;</span>
    }
    return zh2enPromise<span class="hljs-comment">;</span>
  }<span class="hljs-comment">;</span>

  const <span class="hljs-attr">getEn2Zh</span> = () =&gt; {
    if (!en2zhPromise) {
      <span class="hljs-attr">loadingStatus.value.model</span> = <span class="hljs-string">'Xenova/opus-mt-en-zh'</span><span class="hljs-comment">;</span>
      <span class="hljs-attr">en2zhPromise</span> = pipeline(<span class="hljs-string">'translation'</span>, <span class="hljs-string">'Xenova/opus-mt-en-zh'</span>, {
        progress_callback: progressCallback,
      })<span class="hljs-comment">;</span>
    }
    return en2zhPromise<span class="hljs-comment">;</span>
  }<span class="hljs-comment">;</span>

  const <span class="hljs-attr">translate</span> = async (text: string, dir: <span class="hljs-string">'zh-en'</span> | <span class="hljs-string">'en-zh'</span>) =&gt; {
    const <span class="hljs-attr">pipe</span> = dir === <span class="hljs-string">'zh-en'</span> ? await getZh2En() : await getEn2Zh()<span class="hljs-comment">;</span>
    const <span class="hljs-attr">out</span> = await pipe(text)<span class="hljs-comment">;</span>
    return out<span class="hljs-section">[0]</span>?.translation_text ?? ''<span class="hljs-comment">;</span>
  }<span class="hljs-comment">;</span>

  return {
    provide: {
      translate,
      loadingStatus,
    },
  }<span class="hljs-comment">;</span>
})<span class="hljs-comment">;</span>
</code></pre>
<p>说明：</p>
<ul>
<li><code>env.localModelPath</code> 会让 transformers.js 在 <code>localModelPath/&lt;model-id&gt;/</code> 下寻找模型文件。<a href="https://link.juejin.cn?target=http%3A%2F%2Fcodesandbox.io%2Fp%2Fgithub%2FTrawmoney%2Ftransformers.js-clone" target="_blank" title="http://codesandbox.io/p/github/Trawmoney/transformers.js-clone" ref="nofollow noopener noreferrer"/></li>
<li><code>env.useBrowserCache = true</code> 后，下载的模型会缓存到浏览器，下次访问无需重新下载。<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fhuggingface%2Ftransformers.js%2Fissues%2F735" target="_blank" title="https://github.com/huggingface/transformers.js/issues/735" ref="nofollow noopener noreferrer"/></li>
<li><code>progress_callback</code> 中的 <code>status</code>、<code>progress</code>、<code>file</code> 等可用于 UI 展示下载进度。<a href="https://link.juejin.cn?target=https%3A%2F%2Fzenn.dev%2Fhiraoku%2Farticles%2Fdc226873ee6262" target="_blank" title="https://zenn.dev/hiraoku/articles/dc226873ee6262" ref="nofollow noopener noreferrer"/></li>
</ul>
<hr/>
<h2 data-id="heading-7">3. 构建一个翻译页面：输入、输出与进度条</h2>
<p>在 <code>pages/translate.vue</code> 中实现一个简单的翻译工具页，支持方向选择、进度显示。</p>
<pre><code class="hljs language-xml" lang="xml">text
<span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">setup</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"ts"</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">const</span> input = <span class="hljs-title function_">ref</span>(<span class="hljs-string">''</span>);
<span class="hljs-keyword">const</span> output = <span class="hljs-title function_">ref</span>(<span class="hljs-string">''</span>);
<span class="hljs-keyword">const</span> direction = ref&lt;<span class="hljs-string">'zh-en'</span> | <span class="hljs-string">'en-zh'</span>&gt;(<span class="hljs-string">'zh-en'</span>);
<span class="hljs-keyword">const</span> translating = <span class="hljs-title function_">ref</span>(<span class="hljs-literal">false</span>);
<span class="hljs-keyword">const</span> error = ref&lt;string | <span class="hljs-literal">null</span>&gt;(<span class="hljs-literal">null</span>);

<span class="hljs-keyword">const</span> { $translate, $loadingStatus } = <span class="hljs-title function_">useNuxtApp</span>();

<span class="hljs-keyword">const</span> <span class="hljs-title function_">doTranslate</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params"/>) =&gt; {
  error.<span class="hljs-property">value</span> = <span class="hljs-literal">null</span>;
  <span class="hljs-keyword">if</span> (!input.<span class="hljs-property">value</span>.<span class="hljs-title function_">trim</span>()) <span class="hljs-keyword">return</span>;

  translating.<span class="hljs-property">value</span> = <span class="hljs-literal">true</span>;
  <span class="hljs-keyword">try</span> {
    output.<span class="hljs-property">value</span> = <span class="hljs-keyword">await</span> $translate(input.<span class="hljs-property">value</span>, direction.<span class="hljs-property">value</span>);
  } <span class="hljs-keyword">catch</span> (<span class="hljs-attr">e</span>: any) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(e);
    error.<span class="hljs-property">value</span> = <span class="hljs-string">'翻译失败，请联系管理员检查模型文件和路径'</span>;
  } <span class="hljs-keyword">finally</span> {
    translating.<span class="hljs-property">value</span> = <span class="hljs-literal">false</span>;
  }
};
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"p-4 max-w-3xl mx-auto"</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- 模型加载进度提示 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span>
      <span class="hljs-attr">v-if</span>=<span class="hljs-string">"$loadingStatus.status === 'loading'"</span>
      <span class="hljs-attr">class</span>=<span class="hljs-string">"mb-4 p-3 border rounded bg-blue-50"</span>
    &gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"flex items-center gap-2 mb-1"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"w-2 h-2 bg-blue-500 rounded-full animate-spin"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span>加载中：{{ $loadingStatus.model }}<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"flex items-center gap-2 text-sm text-gray-600"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span>{{ $loadingStatus.message }}<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"ml-auto"</span>&gt;</span>{{ Math.round($loadingStatus.progress) }}%<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"w-full bg-gray-200 rounded-full h-2 mt-1"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span>
          <span class="hljs-attr">class</span>=<span class="hljs-string">"bg-blue-500 h-2 rounded-full transition-all"</span>
          <span class="hljs-attr">:style</span>=<span class="hljs-string">"{ width: `${$loadingStatus.progress}%` }"</span>
        &gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>

    <span class="hljs-comment">&lt;!-- 翻译方向选择 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"mb-3 flex gap-2 items-center"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">label</span>&gt;</span>翻译方向：<span class="hljs-tag">&lt;/<span class="hljs-name">label</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">select</span> <span class="hljs-attr">v-model</span>=<span class="hljs-string">"direction"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"border px-2 py-1"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">option</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"zh-en"</span>&gt;</span>中 → 英<span class="hljs-tag">&lt;/<span class="hljs-name">option</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">option</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"en-zh"</span>&gt;</span>英 → 中<span class="hljs-tag">&lt;/<span class="hljs-name">option</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">select</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>

    <span class="hljs-comment">&lt;!-- 输入文本 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">textarea</span>
      <span class="hljs-attr">v-model</span>=<span class="hljs-string">"input"</span>
      <span class="hljs-attr">rows</span>=<span class="hljs-string">"5"</span>
      <span class="hljs-attr">class</span>=<span class="hljs-string">"w-full border p-2 mb-2"</span>
      <span class="hljs-attr">:disabled</span>=<span class="hljs-string">"$loadingStatus.status === 'loading'"</span>
      <span class="hljs-attr">placeholder</span>=<span class="hljs-string">"输入要翻译的文本（首次使用会自动下载模型）"</span>
    /&gt;</span>

    <span class="hljs-comment">&lt;!-- 操作按钮 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">button</span>
      <span class="hljs-attr">class</span>=<span class="hljs-string">"border px-4 py-1"</span>
      <span class="hljs-attr">:disabled</span>=<span class="hljs-string">"translating || $loadingStatus.status === 'loading'"</span>
      @<span class="hljs-attr">click</span>=<span class="hljs-string">"doTranslate"</span>
    &gt;</span>
      {{ translating ? '翻译中…' : '翻译' }}
    <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">button</span>
      <span class="hljs-attr">class</span>=<span class="hljs-string">"border px-3 py-1 ml-2 text-sm"</span>
      @<span class="hljs-attr">click</span>=<span class="hljs-string">"resetModels"</span>
    &gt;</span>
      清除模型缓存（测试下载进度）
    <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>

    <span class="hljs-comment">&lt;!-- 错误提示 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">p</span> <span class="hljs-attr">v-if</span>=<span class="hljs-string">"error"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"text-red-500 mt-2"</span>&gt;</span>{{ error }}<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>

    <span class="hljs-comment">&lt;!-- 输出结果 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">textarea</span>
      <span class="hljs-attr">:value</span>=<span class="hljs-string">"output"</span>
      <span class="hljs-attr">readonly</span>
      <span class="hljs-attr">rows</span>=<span class="hljs-string">"5"</span>
      <span class="hljs-attr">class</span>=<span class="hljs-string">"w-full border p-2 mt-2 bg-gray-50"</span>
      <span class="hljs-attr">placeholder</span>=<span class="hljs-string">"翻译结果"</span>
    /&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>
</code></pre>
<p>上面模板里用到了 <code>resetModels</code>，见下一节。</p>
<hr/>
<h2 data-id="heading-8">4. 清除浏览器缓存，重复触发首次下载进度</h2>
<p>为了测试和演示下载进度，需要能清空 transformers.js 在浏览器里的模型缓存。transformers.js 默认使用 Cache Storage（如 <code>transformers-cache</code>）以及 IndexedDB 来缓存模型文件。<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fhuggingface%2Ftransformers.js-examples%2Fissues%2F20" target="_blank" title="https://github.com/huggingface/transformers.js-examples/issues/20" ref="nofollow noopener noreferrer"/></p>
<h2 data-id="heading-9">4.1 提供一个 composable 清缓存</h2>
<p><code>composables/useTransformersCache.ts</code>：</p>
<pre><code class="hljs language-javascript" lang="javascript">ts
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">useTransformersCache</span>(<span class="hljs-params"/>) {
  <span class="hljs-comment">// 清除 transformers.js 的所有缓存（包括所有模型）</span>
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">clearAll</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params"/>) =&gt; {
    <span class="hljs-keyword">if</span> (!(<span class="hljs-string">'caches'</span> <span class="hljs-keyword">in</span> <span class="hljs-variable language_">window</span>)) <span class="hljs-keyword">return</span>;
    <span class="hljs-keyword">await</span> caches.<span class="hljs-title function_">delete</span>(<span class="hljs-string">'transformers-cache'</span>); <span class="hljs-comment">// 默认缓存名[web:66][web:88]</span>
  };

  <span class="hljs-comment">// 仅清除包含某个模型名的缓存请求</span>
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">clearModel</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params">modelName: string</span>) =&gt; {
    <span class="hljs-keyword">if</span> (!(<span class="hljs-string">'caches'</span> <span class="hljs-keyword">in</span> <span class="hljs-variable language_">window</span>)) <span class="hljs-keyword">return</span>;
    <span class="hljs-keyword">const</span> cache = <span class="hljs-keyword">await</span> caches.<span class="hljs-title function_">open</span>(<span class="hljs-string">'transformers-cache'</span>);
    <span class="hljs-keyword">const</span> keys = <span class="hljs-keyword">await</span> cache.<span class="hljs-title function_">keys</span>();
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> req <span class="hljs-keyword">of</span> keys) {
      <span class="hljs-keyword">if</span> (req.<span class="hljs-property">url</span>.<span class="hljs-title function_">includes</span>(modelName)) {
        <span class="hljs-keyword">await</span> cache.<span class="hljs-title function_">delete</span>(req);             <span class="hljs-comment">// 官方 issue 中的用法[web:86]</span>
      }
    }
  };

  <span class="hljs-keyword">return</span> { clearAll, clearModel };
}
</code></pre>
<h2 data-id="heading-10">4.2 页面中使用清缓存按钮</h2>
<p>在 <code>pages/translate.vue</code> 的 <code>&lt;script setup&gt;</code> 中加入：</p>
<pre><code class="hljs language-scss" lang="scss">ts
const { clearAll } = <span class="hljs-built_in">useTransformersCache</span>();

const resetModels = async () =&gt; {
  await <span class="hljs-built_in">clearAll</span>();
  location<span class="hljs-selector-class">.reload</span>(); <span class="hljs-comment">// 刷新后再翻译，就会重新触发下载与进度条</span>
};
</code></pre>
<p>调试流程：</p>
<ol>
<li>打开翻译页面，首次翻译时看到模型下载进度条。</li>
<li>点击“清除模型缓存”按钮，页面自动刷新。</li>
<li>再次翻译，确认下载进度条再次出现。</li>
</ol>
<p>如果只想在调试阶段每次都看到进度，可以临时将 <code>env.useBrowserCache = false</code>，关闭缓存。<a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.csdn.net%2Fgitblog_00349%2Farticle%2Fdetails%2F151214871" target="_blank" title="https://blog.csdn.net/gitblog_00349/article/details/151214871" ref="nofollow noopener noreferrer"/></p>
<hr/>
<h2 data-id="heading-11">5. 部署与注意事项</h2>
<h2 data-id="heading-12">5.1 Nuxt 部署方式</h2>
<ul>
<li>本文方案完全运行在 <strong>浏览器端</strong>，Nuxt 可使用 SSR 或静态导出（<code>nuxt generate</code>），对翻译功能无影响。<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.shiniest.cn%2Fblog%2Farticle%2F163" target="_blank" title="https://www.shiniest.cn/blog/article/163" ref="nofollow noopener noreferrer"/>​</li>
<li>需要确保生产环境的静态资源可通过 <code>/models/...</code> 路径访问；若应用部署在子路径（如 <code>/app/</code>），需相应调整 <code>env.localModelPath = '/app/models/'</code>。</li>
</ul>
<h2 data-id="heading-13">5.2 内网环境建议</h2>
<ul>
<li>模型文件托管在公司内部服务器，可以通过 <code>git clone</code> 预拉取到构建机 / 静态服务器，避免运行时从外网下载。<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fharisnae%2Fmultilingual-translator-offline" target="_blank" title="https://github.com/harisnae/multilingual-translator-offline" ref="nofollow noopener noreferrer"/></li>
<li>内网带宽充足时，OPUS-MT 这一级别模型首次加载通常在 2–5 秒内完成，配合进度条体验较好。<a href="https://link.juejin.cn?target=https%3A%2F%2Fgist.github.com%2Fcomaniac%2Fd6d037ce3189e3ecd63eb99f1c4d53a2" target="_blank" title="https://gist.github.com/comaniac/d6d037ce3189e3ecd63eb99f1c4d53a2" ref="nofollow noopener noreferrer"/></li>
</ul>
<hr/>
<h2 data-id="heading-14">6. 扩展方向</h2>
<p>在上述基础上，可以进一步扩展：</p>
<ul>
<li>
<p><strong>划词翻译 / 悬浮翻译</strong>：监听 <code>selectionchange</code>，获取用户选中文本，调用 <code>translate</code> 并展示浮层。</p>
</li>
<li>
<p><strong>与 @nuxtjs/i18n 集成</strong>：</p>
<ul>
<li>固定 UI 文案使用 i18n 语言包。</li>
<li>动态内容（用户输入、后台数据）使用浏览器端翻译作为辅助。</li>
</ul>
</li>
<li>
<p><strong>换更高质量模型</strong>：对于桌面场景，可以尝试 <code>Xenova/nllb-200-distilled-600M</code> 替换 OPUS-MT，并根据项目情况接受更长的首次加载时间。<a href="https://link.juejin.cn?target=https%3A%2F%2Fhuggingface.co%2Fdocs%2Ftransformers%2Fmodel_doc%2Fnllb" target="_blank" title="https://huggingface.co/docs/transformers/model_doc/nllb" ref="nofollow noopener noreferrer"/></p>
</li>
</ul>
<hr/>
<h2 data-id="heading-15">总结</h2>
<p>通过 <strong>Nuxt 3 + transformers.js + Xenova OPUS-MT 模型</strong>，我们可以在浏览器中实现：</p>
<ul>
<li>纯前端中英翻译（无服务端 API）。</li>
<li>模型文件本地化部署到公司内网。</li>
<li>首次加载带下载进度展示，可复现测试。</li>
</ul>
<p>这套方案对于强调数据隐私、安全边界清晰、且愿意在前端接受一定模型体积的业务来说，是一条非常实用的落地路径。<a href="https://juejin.cn/post/7413629689253625910" target="_blank" title="https://juejin.cn/post/7413629689253625910"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Python路径处理全方案：Path、os、shutil等核心工具详解与对比]]></title>    <link>https://juejin.cn/post/7600316828486500367</link>    <guid>https://juejin.cn/post/7600316828486500367</guid>    <pubDate>2026-01-29T05:33:35.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600316828486500367" data-draft-id="7600316828486483983" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Python路径处理全方案：Path、os、shutil等核心工具详解与对比"/> <meta itemprop="keywords" content="Python,后端"/> <meta itemprop="datePublished" content="2026-01-29T05:33:35.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="喝茶与编码"/> <meta itemprop="url" content="https://juejin.cn/user/3378136041922423"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Python路径处理全方案：Path、os、shutil等核心工具详解与对比
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3378136041922423/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    喝茶与编码
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-29T05:33:35.000Z" title="Thu Jan 29 2026 05:33:35 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读11分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Python路径处理全方案：Path、os、shutil等核心工具详解与对比</h2>
<p>在Python开发中，文件路径处理是贯穿项目全流程的基础需求，无论是配置文件读取、目录遍历、文件操作还是跨平台部署，都需要可靠的路径处理方案。Python提供了多套路径处理工具，核心包括<code>pathlib</code>模块的<code>Path</code>、<code>PurePath</code>等类，传统的<code>os</code>模块（含<code>os.path</code>子模块），以及辅助高级文件操作的<code>shutil</code>模块。</p>
<p>本文将系统梳理这些工具的核心用法，重点对比各工具的优劣差异、适用场景，并给出针对性的使用建议，帮助开发者根据项目需求快速选择合适的路径处理方案，规避跨平台兼容、代码冗余等常见问题。</p>
<h3 data-id="heading-1">一、核心工具概览</h3>
<p>Python路径处理工具可分为三大类，各类工具功能互补、侧重不同，核心成员及定位如下：</p>
<ul>
<li>
<p><strong>pathlib模块</strong>：Python 3.4+引入的面向对象路径处理方案，核心类包括<code>Path</code>（文件系统交互类）、<code>PurePath</code>（纯路径解析类，含<code>PurePosixPath</code>、<code>PureWindowsPath</code>两个系统专属子类）；</p>
</li>
<li>
<p><strong>os模块</strong>：Python内置传统工具，核心为<code>os.path</code>子模块（基于字符串的路径处理），配合<code>os.mkdir()</code>、<code>os.listdir()</code>等方法完成基础路径操作；</p>
</li>
<li>
<p><strong>shutil模块</strong>：高级文件/目录操作辅助工具，不专注于路径解析，但可配合前两类工具完成复制、移动、递归删除等复杂操作。</p>
</li>
</ul>
<p>下面先逐一讲解各工具的核心用法，再进行全面对比与建议。</p>
<h3 data-id="heading-2">二、各核心工具详细用法</h3>
<h4 data-id="heading-3">2.1 pathlib模块：面向对象的现代方案</h4>
<p><code>pathlib</code>模块的核心优势是“面向对象”，将路径封装为对象，通过方法调用完成各类操作，代码可读性强、跨平台兼容性好，是Python 3.4+的推荐方案。核心类分为“纯路径类”和“文件系统交互类”两类。</p>
<h5 data-id="heading-4">2.1.1 PurePath：纯路径解析（不交互文件系统）</h5>
<p><code>PurePath</code>是抽象基类，仅负责路径字符串的解析、拼接、格式化，不与实际文件系统交互（无<code>exists()</code>、<code>mkdir()</code>等方法），适合仅需解析路径格式的场景。其两个子类用于强制指定系统路径规则，不受运行环境影响。</p>
<pre><code class="hljs language-python" lang="python">
<span class="hljs-keyword">from</span> pathlib <span class="hljs-keyword">import</span> PurePath, PurePosixPath, PureWindowsPath

<span class="hljs-comment"># 1. 基础用法：自动适配当前系统（类似Path，但无文件系统交互）</span>
pp = PurePath(<span class="hljs-string">"data"</span>, <span class="hljs-string">"logs"</span>, <span class="hljs-string">"app.log"</span>)
<span class="hljs-built_in">print</span>(pp.name)        <span class="hljs-comment"># 输出：app.log（提取文件名）</span>
<span class="hljs-built_in">print</span>(pp.parent)      <span class="hljs-comment"># 输出：data/logs（提取父目录）</span>
<span class="hljs-built_in">print</span>(pp.suffix)      <span class="hljs-comment"># 输出：.log（提取文件后缀）</span>
<span class="hljs-built_in">print</span>(pp.joinpath(<span class="hljs-string">"backup"</span>))  <span class="hljs-comment"># 输出：data/logs/app.log/backup（路径拼接）</span>

<span class="hljs-comment"># 2. PurePosixPath：强制按Unix/Linux规则解析（无论运行系统）</span>
posix_pp = PurePosixPath(<span class="hljs-string">"C:/Users/xxx/test.txt"</span>)
<span class="hljs-built_in">print</span>(posix_pp)       <span class="hljs-comment"># 输出：C:/Users/xxx/test.txt（分隔符保持/）</span>
<span class="hljs-built_in">print</span>(posix_pp.root)  <span class="hljs-comment"># 输出：/（Unix风格根目录）</span>

<span class="hljs-comment"># 3. PureWindowsPath：强制按Windows规则解析（无论运行系统）</span>
windows_pp = PureWindowsPath(<span class="hljs-string">"/usr/local/bin/python3"</span>)
<span class="hljs-built_in">print</span>(windows_pp)     <span class="hljs-comment"># 输出：\usr\local\bin\python3（分隔符转为\）</span>
<span class="hljs-built_in">print</span>(windows_pp.root)<span class="hljs-comment"># 输出：\（Windows风格根目录）</span>
</code></pre>
<h5 data-id="heading-5">2.1.2 Path：文件系统交互（核心推荐）</h5>
<p><code>Path</code>是<code>pathlib</code>模块的核心类，继承自<code>PurePath</code>，在纯路径解析功能基础上，增加了与实际文件系统交互的方法（如创建文件/目录、读取文件内容等），是日常开发的首选。</p>
<p>注：<code>Path</code>是工厂类，会根据当前运行系统自动实例化为<code>PosixPath</code>（Unix/Linux/Mac）或<code>WindowsPath</code>（Windows），二者功能一致，仅适配不同系统。</p>
<pre><code class="hljs language-python" lang="python">
<span class="hljs-keyword">from</span> pathlib <span class="hljs-keyword">import</span> Path

<span class="hljs-comment"># 1. 路径创建与拼接（推荐用/运算符，比os.path.join更直观）</span>
p = Path(<span class="hljs-string">"data"</span>) / <span class="hljs-string">"logs"</span> / <span class="hljs-string">"app.log"</span>  <span class="hljs-comment"># 相对路径</span>
abs_p = Path(<span class="hljs-string">"/usr/local/bin/python3"</span>) <span class="hljs-comment"># 绝对路径（Unix）</span>

<span class="hljs-comment"># 2. 路径解析（继承自PurePath）</span>
<span class="hljs-built_in">print</span>(p.name)         <span class="hljs-comment"># 输出：app.log</span>
<span class="hljs-built_in">print</span>(p.stem)         <span class="hljs-comment"># 输出：app（无后缀文件名）</span>
<span class="hljs-built_in">print</span>(p.parent)       <span class="hljs-comment"># 输出：data/logs</span>
<span class="hljs-built_in">print</span>(p.resolve())    <span class="hljs-comment"># 输出：/当前工作目录/data/logs/app.log（解析为真实绝对路径）</span>

<span class="hljs-comment"># 3. 文件系统交互（核心功能）</span>
<span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> p.parent.exists():  <span class="hljs-comment"># 判断父目录是否存在</span>
    p.parent.mkdir(parents=<span class="hljs-literal">True</span>)  <span class="hljs-comment"># 创建多层目录（类似os.makedirs）</span>
<span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> p.exists():          <span class="hljs-comment"># 判断文件是否存在</span>
    p.touch()               <span class="hljs-comment"># 创建空文件</span>
    p.write_text(<span class="hljs-string">"Hello Path!"</span>)  <span class="hljs-comment"># 写入文本内容（无需手动打开文件）</span>
content = p.read_text()     <span class="hljs-comment"># 读取文本内容</span>
<span class="hljs-built_in">print</span>(content)              <span class="hljs-comment"># 输出：Hello Path!</span>

<span class="hljs-comment"># 4. 目录遍历与匹配</span>
<span class="hljs-keyword">for</span> file <span class="hljs-keyword">in</span> p.parent.iterdir():  <span class="hljs-comment"># 遍历目录下所有文件/子目录</span>
    <span class="hljs-built_in">print</span>(file.name)
py_files = <span class="hljs-built_in">list</span>(Path(<span class="hljs-string">"."</span>).glob(<span class="hljs-string">"*.py"</span>))  <span class="hljs-comment"># 匹配当前目录下所有.py文件</span>
<span class="hljs-built_in">print</span>(py_files)
</code></pre>
<h4 data-id="heading-6">2.2 os模块：传统字符串式路径处理</h4>
<p><code>os</code>模块是Python最早的路径处理工具，核心为<code>os.path</code>子模块，基于字符串操作实现路径处理，无面向对象特性，但兼容性极强（支持Python 2.x+），至今仍广泛用于老项目和简单场景。</p>
<h5 data-id="heading-7">2.2.1 os.path子模块（核心）</h5>
<p><code>os.path</code>提供了一系列字符串处理函数，覆盖路径拼接、解析、判断、规范化等核心需求，自动适配跨平台路径分隔符。</p>
<pre><code class="hljs language-python" lang="python">
<span class="hljs-keyword">import</span> os

<span class="hljs-comment"># 1. 路径拼接（最常用，替代手动写分隔符）</span>
path = os.path.join(<span class="hljs-string">"data"</span>, <span class="hljs-string">"logs"</span>, <span class="hljs-string">"app.log"</span>)
abs_path = os.path.join(<span class="hljs-string">"/usr/local"</span>, <span class="hljs-string">"bin"</span>, <span class="hljs-string">"python3"</span>)  <span class="hljs-comment"># Unix</span>

<span class="hljs-comment"># 2. 路径解析</span>
<span class="hljs-built_in">print</span>(os.path.basename(path))  <span class="hljs-comment"># 输出：app.log（提取文件名）</span>
<span class="hljs-built_in">print</span>(os.path.dirname(path))   <span class="hljs-comment"># 输出：data/logs（提取目录名）</span>
<span class="hljs-built_in">print</span>(os.path.split(path))     <span class="hljs-comment"># 输出：('data/logs', 'app.log')（同时提取目录和文件名）</span>
<span class="hljs-built_in">print</span>(os.path.splitext(path))  <span class="hljs-comment"># 输出：('data/logs/app', '.log')（提取后缀）</span>

<span class="hljs-comment"># 3. 路径判断</span>
<span class="hljs-built_in">print</span>(os.path.exists(path))    <span class="hljs-comment"># 判断路径是否存在（文件/目录通用）</span>
<span class="hljs-built_in">print</span>(os.path.isfile(path))    <span class="hljs-comment"># 判断是否为文件</span>
<span class="hljs-built_in">print</span>(os.path.isdir(os.path.dirname(path)))  <span class="hljs-comment"># 判断是否为目录</span>
<span class="hljs-built_in">print</span>(os.path.isabs(path))     <span class="hljs-comment"># 判断是否为绝对路径</span>

<span class="hljs-comment"># 4. 路径规范化</span>
messy_path = <span class="hljs-string">"/usr/local/../bin//python3/."</span>
norm_path = os.path.normpath(messy_path)  <span class="hljs-comment"># 清理冗余片段（//、.、..）</span>
<span class="hljs-built_in">print</span>(norm_path)  <span class="hljs-comment"># 输出：/usr/bin/python3</span>
abs_norm_path = os.path.abspath(norm_path)  <span class="hljs-comment"># 转换为绝对路径</span>
<span class="hljs-built_in">print</span>(abs_norm_path)
</code></pre>
<h5 data-id="heading-8">2.2.2 os模块辅助路径操作</h5>
<p>除<code>os.path</code>外，<code>os</code>模块本身提供了目录创建、遍历、切换等辅助方法，配合<code>os.path</code>完成完整操作流程。</p>
<pre><code class="hljs language-python" lang="python">
<span class="hljs-keyword">import</span> os

<span class="hljs-comment"># 1. 获取/切换当前工作目录</span>
current_dir = os.getcwd()
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"当前工作目录：<span class="hljs-subst">{current_dir}</span>"</span>)
os.chdir(<span class="hljs-string">"/tmp"</span>)  <span class="hljs-comment"># 切换工作目录（Unix，Windows需写"C:\\tmp"）</span>

<span class="hljs-comment"># 2. 目录创建与删除</span>
<span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> os.path.exists(<span class="hljs-string">"new_dir"</span>):
    os.mkdir(<span class="hljs-string">"new_dir"</span>)  <span class="hljs-comment"># 创建单层目录</span>
<span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> os.path.exists(<span class="hljs-string">"new_dir/sub_dir/child_dir"</span>):
    os.makedirs(<span class="hljs-string">"new_dir/sub_dir/child_dir"</span>)  <span class="hljs-comment"># 创建多层目录</span>
os.rmdir(<span class="hljs-string">"new_dir/sub_dir/child_dir"</span>)  <span class="hljs-comment"># 删除空目录（非空报错）</span>

<span class="hljs-comment"># 3. 目录遍历</span>
dir_content = os.listdir(<span class="hljs-string">"data"</span>)  <span class="hljs-comment"># 返回目录下所有文件/子目录名称列表</span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"data目录内容：<span class="hljs-subst">{dir_content}</span>"</span>)
</code></pre>
<h4 data-id="heading-9">2.3 shutil模块：高级文件操作辅助工具</h4>
<p><code>shutil</code>模块不专注于路径解析，而是提供高级文件/目录操作功能，可配合<code>pathlib.Path</code>或<code>os.path</code>使用，解决复杂场景下的文件操作需求（如复制、移动、递归删除非空目录等）。</p>
<pre><code class="hljs language-python" lang="python">
<span class="hljs-keyword">import</span> shutil
<span class="hljs-keyword">from</span> pathlib <span class="hljs-keyword">import</span> Path
<span class="hljs-keyword">import</span> os

<span class="hljs-comment"># 1. 文件复制（配合Path）</span>
src_file = Path(<span class="hljs-string">"data/app.log"</span>)
dst_file = Path(<span class="hljs-string">"backup/app.log"</span>)
shutil.copy(src_file, dst_file)  <span class="hljs-comment"># 复制文件内容和权限</span>
<span class="hljs-comment"># 配合os.path</span>
shutil.copy(os.path.join(<span class="hljs-string">"data"</span>, <span class="hljs-string">"app.log"</span>), os.path.join(<span class="hljs-string">"backup"</span>, <span class="hljs-string">"app.log"</span>))

<span class="hljs-comment"># 2. 目录复制（递归复制所有内容）</span>
src_dir = Path(<span class="hljs-string">"data/logs"</span>)
dst_dir = Path(<span class="hljs-string">"backup/logs"</span>)
shutil.copytree(src_dir, dst_dir)  <span class="hljs-comment"># 目标目录不存在时自动创建</span>

<span class="hljs-comment"># 3. 文件/目录移动</span>
shutil.move(src_file, Path(<span class="hljs-string">"backup/app_new.log"</span>))  <span class="hljs-comment"># 移动并可重命名</span>

<span class="hljs-comment"># 4. 递归删除非空目录（比os.rmdir更强大）</span>
shutil.rmtree(dst_dir)  <span class="hljs-comment"># 无需手动删除目录内文件，直接递归删除</span>

<span class="hljs-comment"># 5. 文件归档（压缩）</span>
shutil.make_archive(<span class="hljs-string">"backup/logs_archive"</span>, <span class="hljs-string">"zip"</span>, src_dir)  <span class="hljs-comment"># 将logs目录压缩为zip文件</span>
</code></pre>
<h3 data-id="heading-10">三、核心工具优劣对比</h3>
<p>为便于快速选择，下面从编程风格、核心功能、兼容性、可读性等维度，对<code>pathlib</code>（含Path、PurePath等）、<code>os.path</code>、<code>shutil</code>进行全面对比（注：shutil侧重高级操作，不与前两者直接竞争，对比重点为路径解析/基础操作能力）。</p>



























































<table><thead><tr><th>对比维度</th><th>pathlib（Path/PurePath等）</th><th>os.path（含os模块辅助方法）</th><th>shutil</th></tr></thead><tbody><tr><td>编程风格</td><td>面向对象，路径为对象，支持链式调用（如p.parent.exists()）</td><td>函数式，基于字符串操作，需多次函数嵌套</td><td>函数式，专注操作执行，依赖路径参数输入</td></tr><tr><td>核心能力</td><td>路径解析、拼接、格式化，文件系统交互（创建、读写等），基础遍历匹配</td><td>路径解析、拼接、格式化，基础目录/文件操作（创建、遍历等）</td><td>高级操作（复制、移动、递归删除、压缩等），无独立路径解析能力</td></tr><tr><td>跨平台兼容性</td><td>优秀，自动适配分隔符，PurePosixPath/PureWindowsPath可强制指定规则</td><td>良好，自动适配分隔符，但无强制系统规则的功能</td><td>优秀，基于系统底层操作，自动适配跨平台场景</td></tr><tr><td>Python版本支持</td><td>3.4+（不支持2.x）</td><td>全版本（2.x+、3.x+），兼容性极强</td><td>全版本（2.x+、3.x+），核心功能无版本限制</td></tr><tr><td>代码可读性</td><td>优秀，语义清晰，链式调用减少冗余（如p.write_text()替代open()）</td><td>一般，复杂操作需多函数嵌套（如提取无后缀文件名需os.path.splitext(os.path.basename(path))）</td><td>良好，函数语义明确（如shutil.copytree()即递归复制目录）</td></tr><tr><td>学习成本</td><td>中等，需理解面向对象思想，熟悉类方法</td><td>低，仅需记忆常用函数，逻辑简单直白</td><td>低，功能聚焦，仅需在需要时调用对应函数</td></tr><tr><td>优势场景</td><td>Python 3.x新项目、复杂路径操作、追求代码可读性的场景</td><td>老项目维护、简单路径操作、需要兼容Python 2.x的场景</td><td>复制/移动文件/目录、递归删除非空目录、文件压缩等高级操作</td></tr><tr><td>不足</td><td>不支持Python 2.x，老项目迁移成本高</td><td>非面向对象，代码冗余，无内置文件读写、递归匹配功能</td><td>无独立路径解析能力，必须配合pathlib或os.path使用</td></tr></tbody></table>
<h3 data-id="heading-11">四、分场景使用建议</h3>
<p>结合各工具的优劣特性，针对不同开发场景给出明确使用建议，帮助开发者快速决策：</p>
<h4 data-id="heading-12">4.1 新项目开发（Python 3.4+）</h4>
<p>优先选择 <code>pathlib.Path</code> 作为核心路径处理工具，配合 <code>shutil</code>完成高级操作：</p>
<ul>
<li>
<p>日常路径解析、拼接、文件/目录基础操作（创建、读写、遍历）：使用<code>Path</code>类，代码更简洁、可读性更强；</p>
</li>
<li>
<p>需要固定路径系统规则（如生成跨平台配置文件）：使用<code>PurePosixPath</code>（强制Unix规则）或<code>PureWindowsPath</code>（强制Windows规则）；</p>
</li>
<li>
<p>涉及文件/目录复制、移动、递归删除、压缩：配合<code>shutil</code>模块（如<code>shutil.copytree()</code>、<code>shutil.rmtree()</code>）。</p>
</li>
</ul>
<p>示例组合用法：</p>
<pre><code class="hljs language-python" lang="python">
<span class="hljs-keyword">from</span> pathlib <span class="hljs-keyword">import</span> Path
<span class="hljs-keyword">import</span> shutil

<span class="hljs-comment"># 用Path处理路径，shutil处理高级操作</span>
src_dir = Path(<span class="hljs-string">"data/logs"</span>)
dst_dir = Path(<span class="hljs-string">"backup/logs"</span>)

<span class="hljs-comment"># 路径判断与目录创建（Path）</span>
<span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> dst_dir.parent.exists():
    dst_dir.parent.mkdir(parents=<span class="hljs-literal">True</span>)

<span class="hljs-comment"># 递归复制目录（shutil）</span>
shutil.copytree(src_dir, dst_dir)

<span class="hljs-comment"># 读取复制后的文件内容（Path）</span>
copied_file = dst_dir / <span class="hljs-string">"app.log"</span>
<span class="hljs-built_in">print</span>(copied_file.read_text())
</code></pre>
<h4 data-id="heading-13">4.2 老项目维护（Python 2.x或3.x老版本）</h4>
<p>以 <code>os.path</code> 为核心，配合 <code>os</code> 模块辅助方法，必要时引入 <code>shutil</code> 处理高级操作：</p>
<ul>
<li>
<p>路径拼接、解析、判断：使用<code>os.path</code>子模块（如<code>os.path.join()</code>、<code>os.path.exists()</code>）；</p>
</li>
<li>
<p>基础目录/文件操作（创建、遍历、切换目录）：使用<code>os.mkdir()</code>、<code>os.listdir()</code>、<code>os.chdir()</code>等；</p>
</li>
<li>
<p>高级操作（复制、递归删除）：配合<code>shutil</code>模块，避免手动编写递归逻辑。</p>
</li>
</ul>
<p>示例组合用法：</p>
<pre><code class="hljs language-python" lang="python">
<span class="hljs-keyword">import</span> os
<span class="hljs-keyword">import</span> shutil

<span class="hljs-comment"># 用os.path处理路径，os和shutil处理操作</span>
src_path = os.path.join(<span class="hljs-string">"data"</span>, <span class="hljs-string">"logs"</span>, <span class="hljs-string">"app.log"</span>)
dst_path = os.path.join(<span class="hljs-string">"backup"</span>, <span class="hljs-string">"app.log"</span>)

<span class="hljs-comment"># 路径判断与目录创建</span>
<span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> os.path.exists(os.path.dirname(dst_path)):
    os.makedirs(os.path.dirname(dst_path))

<span class="hljs-comment"># 复制文件</span>
shutil.copy(src_path, dst_path)

<span class="hljs-comment"># 遍历目录</span>
<span class="hljs-keyword">for</span> item <span class="hljs-keyword">in</span> os.listdir(os.path.dirname(src_path)):
    <span class="hljs-built_in">print</span>(item)
</code></pre>
<h4 data-id="heading-14">4.3 特殊场景专项建议</h4>
<ul>
<li>
<p>仅需解析路径格式（不操作文件系统）：优先使用<code>PurePath</code>（跨平台自动适配）或其子类（强制系统规则），比<code>os.path</code>更专注、代码更清晰；</p>
</li>
<li>
<p>批量文件匹配（如查找所有.py文件）：Python 3.x用<code>Path.glob()</code>（简洁），Python 2.x用<code>glob</code>模块（配合<code>os.path</code>）；</p>
</li>
<li>
<p>跨平台项目开发：优先用<code>pathlib.Path</code>或<code>os.path</code>，避免手动写死路径分隔符（如“/”“\”），必要时用<code>PurePosixPath</code>/<code>PureWindowsPath</code>统一路径格式。</p>
</li>
</ul>
<h3 data-id="heading-15">五、常见问题与避坑指南</h3>
<h4 data-id="heading-16">5.1 跨平台路径分隔符问题</h4>
<p>避坑建议：无论使用哪种工具，均不要手动写死分隔符（如<code>"data/logs"</code>或<code>"data\\logs"</code>），优先用工具自带的拼接方式：</p>
<ul>
<li>
<p>pathlib：用<code>Path("data") / "logs"</code>；</p>
</li>
<li>
<p>os.path：用<code>os.path.join("data", "logs")</code>。</p>
</li>
</ul>
<h4 data-id="heading-17">5.2 路径存在性判断遗漏</h4>
<p>避坑建议：在进行文件/目录操作（创建、读取、删除、复制）前，必须先判断路径存在性及类型（是文件还是目录），避免抛出异常：</p>
<pre><code class="hljs language-python" lang="python">
<span class="hljs-comment"># 错误示例：直接创建目录，若已存在会报错</span>
os.mkdir(<span class="hljs-string">"new_dir"</span>)

<span class="hljs-comment"># 正确示例（os.path）</span>
<span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> os.path.exists(<span class="hljs-string">"new_dir"</span>) <span class="hljs-keyword">and</span> <span class="hljs-keyword">not</span> os.path.isdir(<span class="hljs-string">"new_dir"</span>):
    os.mkdir(<span class="hljs-string">"new_dir"</span>)

<span class="hljs-comment"># 正确示例（Path）</span>
p = Path(<span class="hljs-string">"new_dir"</span>)
<span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> p.exists() <span class="hljs-keyword">or</span> <span class="hljs-keyword">not</span> p.is_dir():
    p.mkdir()
</code></pre>
<h4 data-id="heading-18">5.3 递归删除目录风险</h4>
<p>避坑建议：使用<code>shutil.rmtree()</code>递归删除目录时，务必确认路径正确性，避免误删重要文件，可增加二次校验：</p>
<pre><code class="hljs language-python" lang="python">
<span class="hljs-keyword">import</span> shutil
<span class="hljs-keyword">from</span> pathlib <span class="hljs-keyword">import</span> Path

del_dir = Path(<span class="hljs-string">"temp_dir"</span>)
<span class="hljs-comment"># 二次校验：确保是临时目录且非空</span>
<span class="hljs-keyword">if</span> del_dir.exists() <span class="hljs-keyword">and</span> del_dir.is_dir() <span class="hljs-keyword">and</span> <span class="hljs-string">"temp"</span> <span class="hljs-keyword">in</span> del_dir.name:
    shutil.rmtree(del_dir)
</code></pre>
<h3 data-id="heading-19">六、总结</h3>
<p>Python路径处理工具各有侧重，无“最优方案”，只有“最适配场景的方案”：</p>
<ol>
<li>
<p><code>pathlib</code>模块（Path/PurePath等）：Python 3.x新项目的首选，面向对象、可读性强、功能完整，兼顾路径解析与文件系统交互；</p>
</li>
<li>
<p><code>os</code>模块（os.path）：老项目维护和简单场景的核心，兼容性极强，逻辑直白，适合不需要复杂功能的场景；</p>
</li>
<li>
<p><code>shutil</code>模块：所有场景的“辅助工具”，专注高级文件/目录操作，需与前两类工具配合使用。</p>
</li>
</ol>
<p>核心建议：掌握<code>pathlib.Path</code>和<code>os.path</code>的核心用法，根据项目版本（是否兼容2.x）和复杂度选择核心工具，必要时用<code>shutil</code>补充高级功能，同时规避跨平台、路径判断等常见坑点，才能高效完成路径处理相关开发工作。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Android Glide 图片加载库源码流程浅析]]></title>    <link>https://juejin.cn/post/7600316828485976079</link>    <guid>https://juejin.cn/post/7600316828485976079</guid>    <pubDate>2026-01-29T03:05:50.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600316828485976079" data-draft-id="7599852579066626063" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Android Glide 图片加载库源码流程浅析"/> <meta itemprop="keywords" content="Android"/> <meta itemprop="datePublished" content="2026-01-29T03:05:50.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Yen"/> <meta itemprop="url" content="https://juejin.cn/user/4037062426633214"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Android Glide 图片加载库源码流程浅析
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4037062426633214/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Yen
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-29T03:05:50.000Z" title="Thu Jan 29 2026 03:05:50 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    7
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读13分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><strong>注：本文基于Glide 4.16版本</strong></p>
<p>通常来说，使用Glide.with(context).load(model).into(imageView)就可以加载图片了，具体的执行流程是怎样的呢？</p>
<h2 data-id="heading-0">一、with方法基本流程</h2>
<h4 data-id="heading-1">1. with重载方法</h4>
<p>首先，让我们来看看with的重载方法</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// Glide.java</span>

<span class="hljs-meta">@NonNull</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> RequestManager <span class="hljs-title function_">with</span><span class="hljs-params">(<span class="hljs-meta">@NonNull</span> Context context)</span> {
  <span class="hljs-keyword">return</span> getRetriever(context).get(context);
}

<span class="hljs-meta">@NonNull</span>
<span class="hljs-meta">@Deprecated</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> RequestManager <span class="hljs-title function_">with</span><span class="hljs-params">(<span class="hljs-meta">@NonNull</span> Activity activity)</span> {
  <span class="hljs-keyword">return</span> with(activity.getApplicationContext());
}

<span class="hljs-meta">@NonNull</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> RequestManager <span class="hljs-title function_">with</span><span class="hljs-params">(<span class="hljs-meta">@NonNull</span> FragmentActivity activity)</span> {
  <span class="hljs-keyword">return</span> getRetriever(activity).get(activity);
}

<span class="hljs-meta">@NonNull</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> RequestManager <span class="hljs-title function_">with</span><span class="hljs-params">(<span class="hljs-meta">@NonNull</span> Fragment fragment)</span> {
  <span class="hljs-keyword">return</span> getRetriever(fragment.getContext()).get(fragment);
}

<span class="hljs-meta">@Deprecated</span>
<span class="hljs-meta">@NonNull</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> RequestManager <span class="hljs-title function_">with</span><span class="hljs-params">(<span class="hljs-meta">@NonNull</span> android.app.Fragment fragment)</span> {
  <span class="hljs-type">Activity</span> <span class="hljs-variable">activity</span> <span class="hljs-operator">=</span> fragment.getActivity();
  Preconditions.checkNotNull(activity, DESTROYED_ACTIVITY_WARNING);
  <span class="hljs-keyword">return</span> with(activity.getApplicationContext());
}

<span class="hljs-meta">@NonNull</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> RequestManager <span class="hljs-title function_">with</span><span class="hljs-params">(<span class="hljs-meta">@NonNull</span> View view)</span> {
  <span class="hljs-keyword">return</span> getRetriever(view.getContext()).get(view);
}

<span class="hljs-meta">@NonNull</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> RequestManagerRetriever <span class="hljs-title function_">getRetriever</span><span class="hljs-params">(<span class="hljs-meta">@Nullable</span> Context context)</span> {
  <span class="hljs-comment">// Context could be null for other reasons (ie the user passes in null), but in practice it will</span>
  <span class="hljs-comment">// only occur due to errors with the Fragment lifecycle.</span>
  Preconditions.checkNotNull(context, DESTROYED_ACTIVITY_WARNING);
  <span class="hljs-keyword">return</span> Glide.get(context).getRequestManagerRetriever();
}
</code></pre>
<p>可以看到，with方法内部会通过getRetriever方法拿到RequestManagerRetriever对象，然后再调用RequestManagerRetriever的get方法得到RequestManager</p>
<h4 data-id="heading-2">2. Glide.get(context)方法</h4>
<p>我们接着来看看Glide.get(context)方法里面都做了些什么</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@NonNull</span>
<span class="hljs-comment">// Double checked locking is safe here.</span>
<span class="hljs-meta">@SuppressWarnings("GuardedBy")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Glide <span class="hljs-title function_">get</span><span class="hljs-params">(<span class="hljs-meta">@NonNull</span> Context context)</span> {
  <span class="hljs-keyword">if</span> (glide == <span class="hljs-literal">null</span>) {
    <span class="hljs-type">GeneratedAppGlideModule</span> <span class="hljs-variable">annotationGeneratedModule</span> <span class="hljs-operator">=</span>
        getAnnotationGeneratedGlideModules(context.getApplicationContext());
    <span class="hljs-keyword">synchronized</span> (Glide.class) {
      <span class="hljs-keyword">if</span> (glide == <span class="hljs-literal">null</span>) {
        checkAndInitializeGlide(context, annotationGeneratedModule);
      }
    }
  }

  <span class="hljs-keyword">return</span> glide;
}
</code></pre>
<p>可以看到，使用了双重校验单例来获取Glide对象，继续查看checkAndInitializeGlide方法</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@GuardedBy("Glide.class")</span>
<span class="hljs-meta">@VisibleForTesting</span>
<span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">checkAndInitializeGlide</span><span class="hljs-params">(
    <span class="hljs-meta">@NonNull</span> Context context, <span class="hljs-meta">@Nullable</span> GeneratedAppGlideModule generatedAppGlideModule)</span> {
  <span class="hljs-comment">// In the thread running initGlide(), one or more classes may call Glide.get(context).</span>
  <span class="hljs-comment">// Without this check, those calls could trigger infinite recursion.</span>
  <span class="hljs-keyword">if</span> (isInitializing) {
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalStateException</span>(
        <span class="hljs-string">"Glide has been called recursively, this is probably an internal library error!"</span>);
  }
  isInitializing = <span class="hljs-literal">true</span>;
  <span class="hljs-keyword">try</span> {
    <span class="hljs-comment">// 重点</span>
    initializeGlide(context, generatedAppGlideModule);
  } <span class="hljs-keyword">finally</span> {
    isInitializing = <span class="hljs-literal">false</span>;
  }
}
</code></pre>
<p>checkAndInitializeGlide 里面会调用 initializeGlide 方法进行初始化</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@GuardedBy("Glide.class")</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">initializeGlide</span><span class="hljs-params">(
    <span class="hljs-meta">@NonNull</span> Context context, <span class="hljs-meta">@Nullable</span> GeneratedAppGlideModule generatedAppGlideModule)</span> {
  initializeGlide(context, <span class="hljs-keyword">new</span> <span class="hljs-title class_">GlideBuilder</span>(), generatedAppGlideModule);
}

<span class="hljs-meta">@GuardedBy("Glide.class")</span>
<span class="hljs-meta">@SuppressWarnings("deprecation")</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">initializeGlide</span><span class="hljs-params">(
    <span class="hljs-meta">@NonNull</span> Context context,
    <span class="hljs-meta">@NonNull</span> GlideBuilder builder,
    <span class="hljs-meta">@Nullable</span> GeneratedAppGlideModule annotationGeneratedModule)</span> {
  ...
  <span class="hljs-type">Glide</span> <span class="hljs-variable">glide</span> <span class="hljs-operator">=</span> builder.build(applicationContext, manifestModules, annotationGeneratedModule);
  applicationContext.registerComponentCallbacks(glide);
  Glide.glide = glide;
}
</code></pre>
<p>可以看到，通过建造者模式去构建glide对象</p>
<h4 data-id="heading-3">3. GlideBuilder.build方法</h4>
<p>里面会创建sourceExecutor、diskCacheExecutor、animationExecutor、memorySizeCalculator、bitmapPool、engine等对象</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// GlideBuilder.java</span>

<span class="hljs-meta">@NonNull</span>
Glide <span class="hljs-title function_">build</span><span class="hljs-params">(
    <span class="hljs-meta">@NonNull</span> Context context,
    List&lt;GlideModule&gt; manifestModules,
    AppGlideModule annotationGeneratedGlideModule)</span> {
  <span class="hljs-keyword">if</span> (sourceExecutor == <span class="hljs-literal">null</span>) {
    sourceExecutor = GlideExecutor.newSourceExecutor();
  }

  <span class="hljs-keyword">if</span> (diskCacheExecutor == <span class="hljs-literal">null</span>) {
    diskCacheExecutor = GlideExecutor.newDiskCacheExecutor();
  }

  <span class="hljs-keyword">if</span> (animationExecutor == <span class="hljs-literal">null</span>) {
    animationExecutor = GlideExecutor.newAnimationExecutor();
  }

  <span class="hljs-keyword">if</span> (memorySizeCalculator == <span class="hljs-literal">null</span>) {
    memorySizeCalculator = <span class="hljs-keyword">new</span> <span class="hljs-title class_">MemorySizeCalculator</span>.Builder(context).build();
  }

  <span class="hljs-keyword">if</span> (connectivityMonitorFactory == <span class="hljs-literal">null</span>) {
    connectivityMonitorFactory = <span class="hljs-keyword">new</span> <span class="hljs-title class_">DefaultConnectivityMonitorFactory</span>();
  }

  <span class="hljs-keyword">if</span> (bitmapPool == <span class="hljs-literal">null</span>) {
    <span class="hljs-type">int</span> <span class="hljs-variable">size</span> <span class="hljs-operator">=</span> memorySizeCalculator.getBitmapPoolSize();
    <span class="hljs-keyword">if</span> (size &gt; <span class="hljs-number">0</span>) {
      bitmapPool = <span class="hljs-keyword">new</span> <span class="hljs-title class_">LruBitmapPool</span>(size);
    } <span class="hljs-keyword">else</span> {
      bitmapPool = <span class="hljs-keyword">new</span> <span class="hljs-title class_">BitmapPoolAdapter</span>();
    }
  }

  <span class="hljs-keyword">if</span> (arrayPool == <span class="hljs-literal">null</span>) {
    arrayPool = <span class="hljs-keyword">new</span> <span class="hljs-title class_">LruArrayPool</span>(memorySizeCalculator.getArrayPoolSizeInBytes());
  }

  <span class="hljs-keyword">if</span> (memoryCache == <span class="hljs-literal">null</span>) {
    memoryCache = <span class="hljs-keyword">new</span> <span class="hljs-title class_">LruResourceCache</span>(memorySizeCalculator.getMemoryCacheSize());
  }

  <span class="hljs-keyword">if</span> (diskCacheFactory == <span class="hljs-literal">null</span>) {
    diskCacheFactory = <span class="hljs-keyword">new</span> <span class="hljs-title class_">InternalCacheDiskCacheFactory</span>(context);
  }

  <span class="hljs-keyword">if</span> (engine == <span class="hljs-literal">null</span>) {
    engine =
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">Engine</span>(
            memoryCache,
            diskCacheFactory,
            diskCacheExecutor,
            sourceExecutor,
            GlideExecutor.newUnlimitedSourceExecutor(),
            animationExecutor,
            isActiveResourceRetentionAllowed);
  }

  <span class="hljs-keyword">if</span> (defaultRequestListeners == <span class="hljs-literal">null</span>) {
    defaultRequestListeners = Collections.emptyList();
  } <span class="hljs-keyword">else</span> {
    defaultRequestListeners = Collections.unmodifiableList(defaultRequestListeners);
  }

  <span class="hljs-type">GlideExperiments</span> <span class="hljs-variable">experiments</span> <span class="hljs-operator">=</span> glideExperimentsBuilder.build();
  <span class="hljs-comment">// 这里拿到RequestManagerRetriever对象</span>
  <span class="hljs-type">RequestManagerRetriever</span> <span class="hljs-variable">requestManagerRetriever</span> <span class="hljs-operator">=</span>
      <span class="hljs-keyword">new</span> <span class="hljs-title class_">RequestManagerRetriever</span>(requestManagerFactory);

  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Glide</span>(
      context,
      engine,
      memoryCache,
      bitmapPool,
      arrayPool,
      requestManagerRetriever,
      connectivityMonitorFactory,
      logLevel,
      defaultRequestOptionsFactory,
      defaultTransitionOptions,
      defaultRequestListeners,
      manifestModules,
      annotationGeneratedGlideModule,
      experiments);
}
</code></pre>
<h4 data-id="heading-4">4. RequestManagerRetriever.get方法</h4>
<p>RequestManagerRetriever.get有多个重载方法，会根据参数类型和调用线程做出不同决策</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// RequestManagerRetriever.java</span>
<span class="hljs-meta">@NonNull</span>
<span class="hljs-keyword">public</span> RequestManager <span class="hljs-title function_">get</span><span class="hljs-params">(<span class="hljs-meta">@NonNull</span> Context context)</span> {
  <span class="hljs-keyword">if</span> (context == <span class="hljs-literal">null</span>) {
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalArgumentException</span>(<span class="hljs-string">"You cannot start a load on a null Context"</span>);
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (Util.isOnMainThread() &amp;&amp; !(context <span class="hljs-keyword">instanceof</span> Application)) {
    <span class="hljs-keyword">if</span> (context <span class="hljs-keyword">instanceof</span> FragmentActivity) {
      <span class="hljs-keyword">return</span> get((FragmentActivity) context);
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (context <span class="hljs-keyword">instanceof</span> ContextWrapper
        &amp;&amp; ((ContextWrapper) context).getBaseContext().getApplicationContext() != <span class="hljs-literal">null</span>) {
      <span class="hljs-keyword">return</span> get(((ContextWrapper) context).getBaseContext());
    }
  }
  <span class="hljs-keyword">return</span> getApplicationManager(context);
}

<span class="hljs-meta">@NonNull</span>
<span class="hljs-keyword">public</span> RequestManager <span class="hljs-title function_">get</span><span class="hljs-params">(<span class="hljs-meta">@NonNull</span> FragmentActivity activity)</span> {
  <span class="hljs-keyword">if</span> (Util.isOnBackgroundThread()) {
    <span class="hljs-keyword">return</span> get(activity.getApplicationContext());
  }
  assertNotDestroyed(activity);
  frameWaiter.registerSelf(activity);
  <span class="hljs-type">boolean</span> <span class="hljs-variable">isActivityVisible</span> <span class="hljs-operator">=</span> isActivityVisible(activity);
  <span class="hljs-type">Glide</span> <span class="hljs-variable">glide</span> <span class="hljs-operator">=</span> Glide.get(activity.getApplicationContext());
  <span class="hljs-keyword">return</span> lifecycleRequestManagerRetriever.getOrCreate(
      activity,
      glide,
      activity.getLifecycle(),
      activity.getSupportFragmentManager(),
      isActivityVisible);
}

<span class="hljs-meta">@NonNull</span>
<span class="hljs-keyword">public</span> RequestManager <span class="hljs-title function_">get</span><span class="hljs-params">(<span class="hljs-meta">@NonNull</span> Fragment fragment)</span> {
  Preconditions.checkNotNull(
      fragment.getContext(),
      <span class="hljs-string">"You cannot start a load on a fragment before it is attached or after it is destroyed"</span>);
  <span class="hljs-keyword">if</span> (Util.isOnBackgroundThread()) {
    <span class="hljs-keyword">return</span> get(fragment.getContext().getApplicationContext());
  }
  <span class="hljs-keyword">if</span> (fragment.getActivity() != <span class="hljs-literal">null</span>) {
    frameWaiter.registerSelf(fragment.getActivity());
  }
  <span class="hljs-type">FragmentManager</span> <span class="hljs-variable">fm</span> <span class="hljs-operator">=</span> fragment.getChildFragmentManager();
  <span class="hljs-type">Context</span> <span class="hljs-variable">context</span> <span class="hljs-operator">=</span> fragment.getContext();
  <span class="hljs-type">Glide</span> <span class="hljs-variable">glide</span> <span class="hljs-operator">=</span> Glide.get(context.getApplicationContext());
  <span class="hljs-keyword">return</span> lifecycleRequestManagerRetriever.getOrCreate(
      context, glide, fragment.getLifecycle(), fm, fragment.isVisible());
}

<span class="hljs-meta">@Deprecated</span>
<span class="hljs-meta">@NonNull</span>
<span class="hljs-keyword">public</span> RequestManager <span class="hljs-title function_">get</span><span class="hljs-params">(<span class="hljs-meta">@NonNull</span> Activity activity)</span> {
  <span class="hljs-keyword">return</span> get(activity.getApplicationContext());
}

<span class="hljs-meta">@NonNull</span>
<span class="hljs-keyword">public</span> RequestManager <span class="hljs-title function_">get</span><span class="hljs-params">(<span class="hljs-meta">@NonNull</span> View view)</span> {
  <span class="hljs-keyword">if</span> (Util.isOnBackgroundThread()) {
    <span class="hljs-keyword">return</span> get(view.getContext().getApplicationContext());
  }

  Preconditions.checkNotNull(view);
  Preconditions.checkNotNull(
      view.getContext(), <span class="hljs-string">"Unable to obtain a request manager for a view without a Context"</span>);
  <span class="hljs-type">Activity</span> <span class="hljs-variable">activity</span> <span class="hljs-operator">=</span> findActivity(view.getContext());
  <span class="hljs-comment">// The view might be somewhere else, like a service.</span>
  <span class="hljs-keyword">if</span> (activity == <span class="hljs-literal">null</span>) {
    <span class="hljs-keyword">return</span> get(view.getContext().getApplicationContext());
  }

  <span class="hljs-keyword">if</span> (activity <span class="hljs-keyword">instanceof</span> FragmentActivity) {
    <span class="hljs-type">Fragment</span> <span class="hljs-variable">fragment</span> <span class="hljs-operator">=</span> findSupportFragment(view, (FragmentActivity) activity);
    <span class="hljs-keyword">return</span> fragment != <span class="hljs-literal">null</span> ? get(fragment) : get((FragmentActivity) activity);
  }

  <span class="hljs-comment">// Standard Fragments.</span>
  <span class="hljs-keyword">return</span> get(view.getContext().getApplicationContext());
}
</code></pre>
<h4 data-id="heading-5">5. LifecycleRequestManagerRetriever.getOrCreate方法</h4>
<p>RequestManager对象是通过lifecycleRequestManagerRetriever.getOrCreate获取的</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// LifecycleRequestManagerRetriever.java</span>

RequestManager <span class="hljs-title function_">getOrCreate</span><span class="hljs-params">(
    Context context,
    Glide glide,
    <span class="hljs-keyword">final</span> Lifecycle lifecycle,
    FragmentManager childFragmentManager,
    <span class="hljs-type">boolean</span> isParentVisible)</span> {
  Util.assertMainThread();
  <span class="hljs-type">RequestManager</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> getOnly(lifecycle);
  <span class="hljs-keyword">if</span> (result == <span class="hljs-literal">null</span>) {
    <span class="hljs-comment">// 传入lifecycle</span>
    <span class="hljs-type">LifecycleLifecycle</span> <span class="hljs-variable">glideLifecycle</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">LifecycleLifecycle</span>(lifecycle);
    result =
        factory.build(
            glide,
            glideLifecycle,
            <span class="hljs-keyword">new</span> <span class="hljs-title class_">SupportRequestManagerTreeNode</span>(childFragmentManager),
            context);
    lifecycleToRequestManager.put(lifecycle, result);
    glideLifecycle.addListener(
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">LifecycleListener</span>() {
          <span class="hljs-meta">@Override</span>
          <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onStart</span><span class="hljs-params">()</span> {}

          <span class="hljs-meta">@Override</span>
          <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onStop</span><span class="hljs-params">()</span> {}

          <span class="hljs-meta">@Override</span>
          <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onDestroy</span><span class="hljs-params">()</span> {
            lifecycleToRequestManager.remove(lifecycle);
          }
        });
        
    <span class="hljs-keyword">if</span> (isParentVisible) {
      result.onStart();
    }
  }
  <span class="hljs-keyword">return</span> result;
}
</code></pre>
<h4 data-id="heading-6">6. RequestManagerFactory工厂方法</h4>
<p>通过RequestManagerFactory 创建了一个RequestManager对象</p>
<pre><code class="hljs language-java" lang="java">RequestManagerRetriever.java

<span class="hljs-comment">/** Used internally to create {<span class="hljs-doctag">@link</span> RequestManager}s. */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">RequestManagerFactory</span> {
  <span class="hljs-meta">@NonNull</span>
  RequestManager <span class="hljs-title function_">build</span><span class="hljs-params">(
      <span class="hljs-meta">@NonNull</span> Glide glide,
      <span class="hljs-meta">@NonNull</span> Lifecycle lifecycle,
      <span class="hljs-meta">@NonNull</span> RequestManagerTreeNode requestManagerTreeNode,
      <span class="hljs-meta">@NonNull</span> Context context)</span>;
}

<span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">RequestManagerFactory</span> <span class="hljs-variable">DEFAULT_FACTORY</span> <span class="hljs-operator">=</span>
    <span class="hljs-keyword">new</span> <span class="hljs-title class_">RequestManagerFactory</span>() {
      <span class="hljs-meta">@NonNull</span>
      <span class="hljs-meta">@Override</span>
      <span class="hljs-keyword">public</span> RequestManager <span class="hljs-title function_">build</span><span class="hljs-params">(
          <span class="hljs-meta">@NonNull</span> Glide glide,
          <span class="hljs-meta">@NonNull</span> Lifecycle lifecycle,
          <span class="hljs-meta">@NonNull</span> RequestManagerTreeNode requestManagerTreeNode,
          <span class="hljs-meta">@NonNull</span> Context context)</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RequestManager</span>(glide, lifecycle, requestManagerTreeNode, context);
      }
    };
</code></pre>
<h4 data-id="heading-7">7.RequestManager构造方法</h4>
<p>RequestManager本身实现LifecycleListener接口，并执行lifecycle.addListener(this)，完成生命周期绑定</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RequestManager</span>
    <span class="hljs-keyword">implements</span> <span class="hljs-title class_">ComponentCallbacks2</span>, LifecycleListener, ModelTypes&lt;RequestBuilder&lt;Drawable&gt;&gt;

<span class="hljs-keyword">public</span> <span class="hljs-title function_">RequestManager</span><span class="hljs-params">(
    <span class="hljs-meta">@NonNull</span> Glide glide,
    <span class="hljs-meta">@NonNull</span> Lifecycle lifecycle,
    <span class="hljs-meta">@NonNull</span> RequestManagerTreeNode treeNode,
    <span class="hljs-meta">@NonNull</span> Context context)</span> {
  <span class="hljs-built_in">this</span>(
      glide,
      lifecycle,
      treeNode,
      <span class="hljs-keyword">new</span> <span class="hljs-title class_">RequestTracker</span>(),
      glide.getConnectivityMonitorFactory(),
      context);
}

<span class="hljs-comment">// Our usage is safe here.</span>
<span class="hljs-meta">@SuppressWarnings("PMD.ConstructorCallsOverridableMethod")</span>
RequestManager(
    Glide glide,
    Lifecycle lifecycle,
    RequestManagerTreeNode treeNode,
    RequestTracker requestTracker,
    ConnectivityMonitorFactory factory,
    Context context) {
  <span class="hljs-built_in">this</span>.glide = glide;
  <span class="hljs-built_in">this</span>.lifecycle = lifecycle;
  <span class="hljs-built_in">this</span>.treeNode = treeNode;
  <span class="hljs-built_in">this</span>.requestTracker = requestTracker;
  <span class="hljs-built_in">this</span>.context = context;

  connectivityMonitor =
      factory.build(
          context.getApplicationContext(),
          <span class="hljs-keyword">new</span> <span class="hljs-title class_">RequestManagerConnectivityListener</span>(requestTracker));

  glide.registerRequestManager(<span class="hljs-built_in">this</span>);

  <span class="hljs-keyword">if</span> (Util.isOnBackgroundThread()) {
    Util.postOnUiThread(addSelfToLifecycle);
  } <span class="hljs-keyword">else</span> {
    lifecycle.addListener(<span class="hljs-built_in">this</span>);
  }
  lifecycle.addListener(connectivityMonitor);

  defaultRequestListeners =
      <span class="hljs-keyword">new</span> <span class="hljs-title class_">CopyOnWriteArrayList</span>&lt;&gt;(glide.getGlideContext().getDefaultRequestListeners());
  setRequestOptions(glide.getGlideContext().getDefaultRequestOptions());
}
</code></pre>
<h4 data-id="heading-8">8. RequestManager生命周期回调方法</h4>
<p>RequestManager相关生命周期回调方法具体如下</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Override</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">synchronized</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onStart</span><span class="hljs-params">()</span> {
  resumeRequests();
  targetTracker.onStart();
}

<span class="hljs-meta">@Override</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">synchronized</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onStop</span><span class="hljs-params">()</span> {
  targetTracker.onStop();
  <span class="hljs-keyword">if</span> (clearOnStop) {
    clearRequests();
  } <span class="hljs-keyword">else</span> {
    pauseRequests();
  }
}

<span class="hljs-meta">@Override</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">synchronized</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onDestroy</span><span class="hljs-params">()</span> {
  targetTracker.onDestroy();
  clearRequests();
  requestTracker.clearRequests();
  lifecycle.removeListener(<span class="hljs-built_in">this</span>);
  lifecycle.removeListener(connectivityMonitor);
  Util.removeCallbacksOnUiThread(addSelfToLifecycle);
  glide.unregisterRequestManager(<span class="hljs-built_in">this</span>);
}
</code></pre>
<h2 data-id="heading-9">二、load()方法基本流程</h2>
<p><code>RequestManager.load()</code> 是 Glide API 的<strong>核心入口</strong>，它负责将各种数据模型统一转换为可管理的加载请求。这个方法的设计体现了 Glide <strong>灵活的数据源支持</strong>和<strong>类型安全的构建器模式</strong>。</p>
<h4 data-id="heading-10">1. RequestManager.load()重载方法</h4>
<p>load方法实际上是一系列<strong>重载方法</strong>，支持不同类型的数据源：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RequestManager</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">LifecycleListener</span> {
    
    <span class="hljs-comment">// 1. 加载网络/本地图片路径</span>
    <span class="hljs-keyword">public</span> RequestBuilder&lt;Drawable&gt; <span class="hljs-title function_">load</span><span class="hljs-params">(<span class="hljs-meta">@Nullable</span> String string)</span> {
        <span class="hljs-keyword">return</span> asDrawable().load(string);
    }
    
    <span class="hljs-comment">// 2. 加载Uri</span>
    <span class="hljs-keyword">public</span> RequestBuilder&lt;Drawable&gt; <span class="hljs-title function_">load</span><span class="hljs-params">(<span class="hljs-meta">@Nullable</span> Uri uri)</span> {
        <span class="hljs-keyword">return</span> asDrawable().load(uri);
    }
    
    <span class="hljs-comment">// 3. 加载File</span>
    <span class="hljs-keyword">public</span> RequestBuilder&lt;Drawable&gt; <span class="hljs-title function_">load</span><span class="hljs-params">(<span class="hljs-meta">@Nullable</span> File file)</span> {
        <span class="hljs-keyword">return</span> asDrawable().load(file);
    }
    
    <span class="hljs-comment">// 4. 加载资源ID</span>
    <span class="hljs-keyword">public</span> RequestBuilder&lt;Drawable&gt; <span class="hljs-title function_">load</span><span class="hljs-params">(<span class="hljs-meta">@RawRes</span> <span class="hljs-meta">@DrawableRes</span> <span class="hljs-meta">@Nullable</span> Integer resourceId)</span> {
        <span class="hljs-keyword">return</span> asDrawable().load(resourceId);
    }
    
    <span class="hljs-comment">// 5. 加载URL对象</span>
    <span class="hljs-keyword">public</span> RequestBuilder&lt;Drawable&gt; <span class="hljs-title function_">load</span><span class="hljs-params">(<span class="hljs-meta">@Nullable</span> URL url)</span> {
        <span class="hljs-keyword">return</span> asDrawable().load(url);
    }
    
    <span class="hljs-comment">// 6. 加载字节数组</span>
    <span class="hljs-keyword">public</span> RequestBuilder&lt;Drawable&gt; <span class="hljs-title function_">load</span><span class="hljs-params">(<span class="hljs-meta">@Nullable</span> <span class="hljs-type">byte</span>[] model)</span> {
        <span class="hljs-keyword">return</span> asDrawable().load(model);
    }
    
    <span class="hljs-comment">// 7. 加载任意对象（泛型方法）</span>
    <span class="hljs-keyword">public</span> &lt;ResourceType&gt; RequestBuilder&lt;ResourceType&gt; <span class="hljs-title function_">load</span><span class="hljs-params">(<span class="hljs-meta">@Nullable</span> Object model)</span> {
        <span class="hljs-keyword">return</span> as(ResourceType.class).load(model);
    }
}
</code></pre>
<h4 data-id="heading-11">2. load方法内部类型推断与转换</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 当你调用：Glide.with(context).load("https://example.com/image.jpg")</span>
<span class="hljs-comment">// 实际执行流程：</span>
<span class="hljs-keyword">public</span> RequestBuilder&lt;Drawable&gt; <span class="hljs-title function_">load</span><span class="hljs-params">(<span class="hljs-meta">@Nullable</span> String string)</span> {
    <span class="hljs-comment">// 步骤1: 确定资源类型为Drawable</span>
    <span class="hljs-keyword">return</span> asDrawable()  <span class="hljs-comment">//  创建指定类型的RequestBuilder</span>
             .load(string); <span class="hljs-comment">//  设置数据模型</span>
}

<span class="hljs-comment">// asDrawable()的实现</span>
<span class="hljs-keyword">public</span> RequestBuilder&lt;Drawable&gt; <span class="hljs-title function_">asDrawable</span><span class="hljs-params">()</span> {
    <span class="hljs-keyword">return</span> as(Drawable.class);
}

<span class="hljs-comment">// 通用的as()方法</span>
<span class="hljs-keyword">public</span> &lt;ResourceType&gt; RequestBuilder&lt;ResourceType&gt; <span class="hljs-title function_">as</span><span class="hljs-params">(
    <span class="hljs-meta">@NonNull</span> Class&lt;ResourceType&gt; resourceClass)</span> {
    
    <span class="hljs-comment">// 创建对应资源类型的RequestBuilder</span>
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RequestBuilder</span>&lt;&gt;(
        glide,                     <span class="hljs-comment">// Glide单例</span>
        <span class="hljs-built_in">this</span>,                      <span class="hljs-comment">// RequestManager自身</span>
        resourceClass,             <span class="hljs-comment">// 目标资源类型（Drawable.class）</span>
        context                    <span class="hljs-comment">// 上下文</span>
    );
}
</code></pre>
<h4 data-id="heading-12">3. RequestBuilder的初始化</h4>
<p><code>RequestBuilder</code> 是真正的<strong>请求建造者</strong>，它存储了请求的所有配置：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// We only override the method to change the return type, not the functionality.</span>
<span class="hljs-meta">@SuppressLint("CheckResult")</span>
<span class="hljs-meta">@SuppressWarnings("PMD.ConstructorCallsOverridableMethod")</span>
<span class="hljs-keyword">protected</span> <span class="hljs-title function_">RequestBuilder</span><span class="hljs-params">(
    <span class="hljs-meta">@NonNull</span> Glide glide,
    RequestManager requestManager,
    Class&lt;TranscodeType&gt; transcodeClass,
    Context context)</span> {
  <span class="hljs-built_in">this</span>.glide = glide;
  <span class="hljs-built_in">this</span>.requestManager = requestManager;
  <span class="hljs-built_in">this</span>.transcodeClass = transcodeClass;
  <span class="hljs-built_in">this</span>.context = context;
  <span class="hljs-built_in">this</span>.transitionOptions = requestManager.getDefaultTransitionOptions(transcodeClass);
  <span class="hljs-built_in">this</span>.glideContext = glide.getGlideContext();

  initRequestListeners(requestManager.getDefaultRequestListeners());
  apply(requestManager.getDefaultRequestOptions());
}
</code></pre>
<h4 data-id="heading-13">4. RequestBuilder.load重载方法</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@NonNull</span>
<span class="hljs-meta">@CheckResult</span>
<span class="hljs-meta">@SuppressWarnings("unchecked")</span>
<span class="hljs-meta">@Override</span>
<span class="hljs-keyword">public</span> RequestBuilder&lt;TranscodeType&gt; <span class="hljs-title function_">load</span><span class="hljs-params">(<span class="hljs-meta">@Nullable</span> Object model)</span> {
  <span class="hljs-keyword">return</span> loadGeneric(model);
}

<span class="hljs-meta">@NonNull</span>
<span class="hljs-keyword">private</span> RequestBuilder&lt;TranscodeType&gt; <span class="hljs-title function_">loadGeneric</span><span class="hljs-params">(<span class="hljs-meta">@Nullable</span> Object model)</span> {
  <span class="hljs-keyword">if</span> (isAutoCloneEnabled()) {
    <span class="hljs-keyword">return</span> clone().loadGeneric(model);
  }
  <span class="hljs-built_in">this</span>.model = model;
  isModelSet = <span class="hljs-literal">true</span>;
  <span class="hljs-keyword">return</span> selfOrThrowIfLocked();
}

<span class="hljs-meta">@NonNull</span>
<span class="hljs-meta">@CheckResult</span>
<span class="hljs-meta">@Override</span>
<span class="hljs-keyword">public</span> RequestBuilder&lt;TranscodeType&gt; <span class="hljs-title function_">load</span><span class="hljs-params">(<span class="hljs-meta">@Nullable</span> Bitmap bitmap)</span> {
  <span class="hljs-keyword">return</span> loadGeneric(bitmap).apply(diskCacheStrategyOf(DiskCacheStrategy.NONE));
}

<span class="hljs-meta">@NonNull</span>
<span class="hljs-meta">@CheckResult</span>
<span class="hljs-meta">@Override</span>
<span class="hljs-keyword">public</span> RequestBuilder&lt;TranscodeType&gt; <span class="hljs-title function_">load</span><span class="hljs-params">(<span class="hljs-meta">@Nullable</span> Drawable drawable)</span> {
  <span class="hljs-keyword">return</span> loadGeneric(drawable).apply(diskCacheStrategyOf(DiskCacheStrategy.NONE));
}

<span class="hljs-meta">@NonNull</span>
<span class="hljs-meta">@Override</span>
<span class="hljs-meta">@CheckResult</span>
<span class="hljs-keyword">public</span> RequestBuilder&lt;TranscodeType&gt; <span class="hljs-title function_">load</span><span class="hljs-params">(<span class="hljs-meta">@Nullable</span> String string)</span> {
  <span class="hljs-keyword">return</span> loadGeneric(string);
}

<span class="hljs-meta">@NonNull</span>
<span class="hljs-meta">@CheckResult</span>
<span class="hljs-meta">@Override</span>
<span class="hljs-keyword">public</span> RequestBuilder&lt;TranscodeType&gt; <span class="hljs-title function_">load</span><span class="hljs-params">(<span class="hljs-meta">@Nullable</span> Uri uri)</span> {
  <span class="hljs-keyword">return</span> maybeApplyOptionsResourceUri(uri, loadGeneric(uri));
}

<span class="hljs-keyword">private</span> RequestBuilder&lt;TranscodeType&gt; <span class="hljs-title function_">maybeApplyOptionsResourceUri</span><span class="hljs-params">(
    <span class="hljs-meta">@Nullable</span> Uri uri, RequestBuilder&lt;TranscodeType&gt; requestBuilder)</span> {
  <span class="hljs-keyword">if</span> (uri == <span class="hljs-literal">null</span> || !ContentResolver.SCHEME_ANDROID_RESOURCE.equals(uri.getScheme())) {
    <span class="hljs-keyword">return</span> requestBuilder;
  }
  <span class="hljs-keyword">return</span> applyResourceThemeAndSignature(requestBuilder);
}

<span class="hljs-keyword">private</span> RequestBuilder&lt;TranscodeType&gt; <span class="hljs-title function_">applyResourceThemeAndSignature</span><span class="hljs-params">(
    RequestBuilder&lt;TranscodeType&gt; requestBuilder)</span> {
  <span class="hljs-keyword">return</span> requestBuilder
      .theme(context.getTheme())
      .signature(AndroidResourceSignature.obtain(context));
}

<span class="hljs-meta">@NonNull</span>
<span class="hljs-meta">@CheckResult</span>
<span class="hljs-meta">@Override</span>
<span class="hljs-keyword">public</span> RequestBuilder&lt;TranscodeType&gt; <span class="hljs-title function_">load</span><span class="hljs-params">(<span class="hljs-meta">@Nullable</span> File file)</span> {
  <span class="hljs-keyword">return</span> loadGeneric(file);
}

<span class="hljs-meta">@NonNull</span>
<span class="hljs-meta">@CheckResult</span>
<span class="hljs-meta">@Override</span>
<span class="hljs-keyword">public</span> RequestBuilder&lt;TranscodeType&gt; <span class="hljs-title function_">load</span><span class="hljs-params">(<span class="hljs-meta">@RawRes</span> <span class="hljs-meta">@DrawableRes</span> <span class="hljs-meta">@Nullable</span> Integer resourceId)</span> {
  <span class="hljs-keyword">return</span> applyResourceThemeAndSignature(loadGeneric(resourceId));
}

<span class="hljs-meta">@Deprecated</span>
<span class="hljs-meta">@CheckResult</span>
<span class="hljs-meta">@Override</span>
<span class="hljs-keyword">public</span> RequestBuilder&lt;TranscodeType&gt; <span class="hljs-title function_">load</span><span class="hljs-params">(<span class="hljs-meta">@Nullable</span> URL url)</span> {
  <span class="hljs-keyword">return</span> loadGeneric(url);
}

<span class="hljs-meta">@NonNull</span>
<span class="hljs-meta">@CheckResult</span>
<span class="hljs-meta">@Override</span>
<span class="hljs-keyword">public</span> RequestBuilder&lt;TranscodeType&gt; <span class="hljs-title function_">load</span><span class="hljs-params">(<span class="hljs-meta">@Nullable</span> <span class="hljs-type">byte</span>[] model)</span> {
  RequestBuilder&lt;TranscodeType&gt; result = loadGeneric(model);
  <span class="hljs-keyword">if</span> (!result.isDiskCacheStrategySet()) {
    result = result.apply(diskCacheStrategyOf(DiskCacheStrategy.NONE));
  }
  <span class="hljs-keyword">if</span> (!result.isSkipMemoryCacheSet()) {
    result = result.apply(skipMemoryCacheOf(<span class="hljs-literal">true</span> <span class="hljs-comment">/*skipMemoryCache*/</span>));
  }
  <span class="hljs-keyword">return</span> result;
}
</code></pre>
<h4 data-id="heading-14">5.设计思想总结</h4>
<p><code>RequestManager.load()</code> 的设计体现了几个重要原则：</p>
<ul>
<li><strong>单一职责</strong>：<code>load()</code> 只负责接收和存储数据模型，不处理具体加载逻辑。</li>
<li><strong>延迟执行</strong>：配置在 <code>into()</code> 调用时才真正生效，支持完整的链式配置。</li>
<li><strong>类型安全</strong>：通过泛型确保资源类型的正确性。</li>
<li><strong>灵活扩展</strong>：支持任意数据模型类型（通过 <code>ModelLoader</code> 机制）。</li>
</ul>
<p>理解 <code>RequestManager.load()</code> 的机制，就掌握了 Glide API 设计的精髓：<strong>通过流畅的构建器模式，将复杂的图片加载过程封装成简单、直观的链式调用，同时保持高度的可配置性和扩展性</strong>。</p>
<h2 data-id="heading-15">三、into()方法基本流程</h2>
<p>into()方法（在RequestBuilder类中）会做几件关键的事：</p>
<ul>
<li>构建Target：将ImageView包装成一个ImageViewTarget</li>
<li>创建并启动请求：调用RequestManager.track()，最终会创建一个SingleRequest对象，并调用它的bedin()方法</li>
</ul>
<h4 data-id="heading-16">1. into重载方法</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@NonNull</span>
<span class="hljs-keyword">public</span> &lt;Y <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Target</span>&lt;TranscodeType&gt;&gt; Y <span class="hljs-title function_">into</span><span class="hljs-params">(<span class="hljs-meta">@NonNull</span> Y target)</span> {
  <span class="hljs-keyword">return</span> into(target, <span class="hljs-comment">/* targetListener= */</span> <span class="hljs-literal">null</span>, Executors.mainThreadExecutor());
}

<span class="hljs-meta">@NonNull</span>
&lt;Y <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Target</span>&lt;TranscodeType&gt;&gt; Y <span class="hljs-title function_">into</span><span class="hljs-params">(
    <span class="hljs-meta">@NonNull</span> Y target,
    <span class="hljs-meta">@Nullable</span> RequestListener&lt;TranscodeType&gt; targetListener,
    Executor callbackExecutor)</span> {
  <span class="hljs-keyword">return</span> into(target, targetListener, <span class="hljs-comment">/* options= */</span> <span class="hljs-built_in">this</span>, callbackExecutor);
}

<span class="hljs-keyword">private</span> &lt;Y <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Target</span>&lt;TranscodeType&gt;&gt; Y <span class="hljs-title function_">into</span><span class="hljs-params">(
    <span class="hljs-meta">@NonNull</span> Y target,
    <span class="hljs-meta">@Nullable</span> RequestListener&lt;TranscodeType&gt; targetListener,
    BaseRequestOptions&lt;?&gt; options,
    Executor callbackExecutor)</span> {
  Preconditions.checkNotNull(target);
  <span class="hljs-keyword">if</span> (!isModelSet) {
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalArgumentException</span>(<span class="hljs-string">"You must call #load() before calling #into()"</span>);
  }

  <span class="hljs-type">Request</span> <span class="hljs-variable">request</span> <span class="hljs-operator">=</span> buildRequest(target, targetListener, options, callbackExecutor);

  <span class="hljs-type">Request</span> <span class="hljs-variable">previous</span> <span class="hljs-operator">=</span> target.getRequest();
  <span class="hljs-keyword">if</span> (request.isEquivalentTo(previous)
      &amp;&amp; !isSkipMemoryCacheWithCompletePreviousRequest(options, previous)) {
    <span class="hljs-keyword">if</span> (!Preconditions.checkNotNull(previous).isRunning()) {
      previous.begin();
    }
    <span class="hljs-keyword">return</span> target;
  }

  requestManager.clear(target);
  target.setRequest(request);
  requestManager.track(target, request);

  <span class="hljs-keyword">return</span> target;
}
</code></pre>
<h4 data-id="heading-17">2. requestManager.track方法</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">synchronized</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">track</span><span class="hljs-params">(<span class="hljs-meta">@NonNull</span> Target&lt;?&gt; target, <span class="hljs-meta">@NonNull</span> Request request)</span> {
  targetTracker.track(target);
  requestTracker.runRequest(request);
}

<span class="hljs-comment">/** Starts tracking the given request. */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">runRequest</span><span class="hljs-params">(<span class="hljs-meta">@NonNull</span> Request request)</span> {
  requests.add(request);
  <span class="hljs-keyword">if</span> (!isPaused) {
    request.begin();
  } <span class="hljs-keyword">else</span> {
    request.clear();
    <span class="hljs-keyword">if</span> (Log.isLoggable(TAG, Log.VERBOSE)) {
      Log.v(TAG, <span class="hljs-string">"Paused, delaying request"</span>);
    }
    pendingRequests.add(request);
  }
}
</code></pre>
<h4 data-id="heading-18">3.SingleRequest.begin方法</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Override</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">begin</span><span class="hljs-params">()</span> {
  <span class="hljs-keyword">synchronized</span> (requestLock) {
    assertNotCallingCallbacks();
    stateVerifier.throwIfRecycled();
    startTime = LogTime.getLogTime();
    <span class="hljs-keyword">if</span> (model == <span class="hljs-literal">null</span>) {
      <span class="hljs-keyword">if</span> (Util.isValidDimensions(overrideWidth, overrideHeight)) {
        width = overrideWidth;
        height = overrideHeight;
      }
      onLoadFailed(<span class="hljs-keyword">new</span> <span class="hljs-title class_">GlideException</span>(<span class="hljs-string">"Received null model"</span>), logLevel);
      <span class="hljs-keyword">return</span>;
    }

    <span class="hljs-keyword">if</span> (status == Status.RUNNING) {
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalArgumentException</span>(<span class="hljs-string">"Cannot restart a running request"</span>);
    }

    <span class="hljs-keyword">if</span> (status == Status.COMPLETE) {
      onResourceReady(
          resource, DataSource.MEMORY_CACHE, <span class="hljs-comment">/* isLoadedFromAlternateCacheKey= */</span> <span class="hljs-literal">false</span>);
      <span class="hljs-keyword">return</span>;
    }

    experimentalNotifyRequestStarted(model);

    cookie = GlideTrace.beginSectionAsync(TAG);
    status = Status.WAITING_FOR_SIZE;
    <span class="hljs-keyword">if</span> (Util.isValidDimensions(overrideWidth, overrideHeight)) {
      onSizeReady(overrideWidth, overrideHeight);
    } <span class="hljs-keyword">else</span> {
      target.getSize(<span class="hljs-built_in">this</span>);
    }

    <span class="hljs-keyword">if</span> ((status == Status.RUNNING || status == Status.WAITING_FOR_SIZE)
        &amp;&amp; canNotifyStatusChanged()) {
      target.onLoadStarted(getPlaceholderDrawable());
    }
    <span class="hljs-keyword">if</span> (IS_VERBOSE_LOGGABLE) {
      logV(<span class="hljs-string">"finished run method in "</span> + LogTime.getElapsedMillis(startTime));
    }
  }
}
</code></pre>
<h4 data-id="heading-19">4. onSizeReady方法</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Override</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onSizeReady</span><span class="hljs-params">(<span class="hljs-type">int</span> width, <span class="hljs-type">int</span> height)</span> {
  stateVerifier.throwIfRecycled();
  <span class="hljs-keyword">synchronized</span> (requestLock) {
    <span class="hljs-keyword">if</span> (IS_VERBOSE_LOGGABLE) {
      logV(<span class="hljs-string">"Got onSizeReady in "</span> + LogTime.getElapsedMillis(startTime));
    }
    <span class="hljs-keyword">if</span> (status != Status.WAITING_FOR_SIZE) {
      <span class="hljs-keyword">return</span>;
    }
    status = Status.RUNNING;

    <span class="hljs-type">float</span> <span class="hljs-variable">sizeMultiplier</span> <span class="hljs-operator">=</span> requestOptions.getSizeMultiplier();
    <span class="hljs-built_in">this</span>.width = maybeApplySizeMultiplier(width, sizeMultiplier);
    <span class="hljs-built_in">this</span>.height = maybeApplySizeMultiplier(height, sizeMultiplier);

    <span class="hljs-keyword">if</span> (IS_VERBOSE_LOGGABLE) {
      logV(<span class="hljs-string">"finished setup for calling load in "</span> + LogTime.getElapsedMillis(startTime));
    }
    loadStatus =
        <span class="hljs-comment">// 重点</span>
        engine.load(
            glideContext,
            model,
            requestOptions.getSignature(),
            <span class="hljs-built_in">this</span>.width,
            <span class="hljs-built_in">this</span>.height,
            requestOptions.getResourceClass(),
            transcodeClass,
            priority,
            requestOptions.getDiskCacheStrategy(),
            requestOptions.getTransformations(),
            requestOptions.isTransformationRequired(),
            requestOptions.isScaleOnlyOrNoTransform(),
            requestOptions.getOptions(),
            requestOptions.isMemoryCacheable(),
            requestOptions.getUseUnlimitedSourceGeneratorsPool(),
            requestOptions.getUseAnimationPool(),
            requestOptions.getOnlyRetrieveFromCache(),
            <span class="hljs-built_in">this</span>,
            callbackExecutor);

    <span class="hljs-keyword">if</span> (status != Status.RUNNING) {
      loadStatus = <span class="hljs-literal">null</span>;
    }
    <span class="hljs-keyword">if</span> (IS_VERBOSE_LOGGABLE) {
      logV(<span class="hljs-string">"finished onSizeReady in "</span> + LogTime.getElapsedMillis(startTime));
    }
  }
}
</code></pre>
<h4 data-id="heading-20">5.Engine.load()方法</h4>
<p>这里是整个加载流程的总调度中心，也是缓存检查的第一关</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> &lt;R&gt; LoadStatus <span class="hljs-title function_">load</span><span class="hljs-params">(
    GlideContext glideContext,
    Object model,
    Key signature,
    <span class="hljs-type">int</span> width,
    <span class="hljs-type">int</span> height,
    Class&lt;?&gt; resourceClass,
    Class&lt;R&gt; transcodeClass,
    Priority priority,
    DiskCacheStrategy diskCacheStrategy,
    Map&lt;Class&lt;?&gt;, Transformation&lt;?&gt;&gt; transformations,
    <span class="hljs-type">boolean</span> isTransformationRequired,
    <span class="hljs-type">boolean</span> isScaleOnlyOrNoTransform,
    Options options,
    <span class="hljs-type">boolean</span> isMemoryCacheable,
    <span class="hljs-type">boolean</span> useUnlimitedSourceExecutorPool,
    <span class="hljs-type">boolean</span> useAnimationPool,
    <span class="hljs-type">boolean</span> onlyRetrieveFromCache,
    ResourceCallback cb,
    Executor callbackExecutor)</span> {
  <span class="hljs-type">long</span> <span class="hljs-variable">startTime</span> <span class="hljs-operator">=</span> VERBOSE_IS_LOGGABLE ? LogTime.getLogTime() : <span class="hljs-number">0</span>;

  <span class="hljs-comment">// 1. 创建唯一缓存Key：根据model、签名、ImageView宽高等参数生成EngineKey</span>
  <span class="hljs-type">EngineKey</span> <span class="hljs-variable">key</span> <span class="hljs-operator">=</span>
      keyFactory.buildKey(
          model,
          signature,
          width,
          height,
          transformations,
          resourceClass,
          transcodeClass,
          options);

  EngineResource&lt;?&gt; memoryResource;
  <span class="hljs-keyword">synchronized</span> (<span class="hljs-built_in">this</span>) {
    <span class="hljs-comment">// 加载内存缓存</span>
    memoryResource = loadFromMemory(key, isMemoryCacheable, startTime);

    <span class="hljs-keyword">if</span> (memoryResource == <span class="hljs-literal">null</span>) {
      <span class="hljs-keyword">return</span> waitForExistingOrStartNewJob(
          glideContext,
          model,
          signature,
          width,
          height,
          resourceClass,
          transcodeClass,
          priority,
          diskCacheStrategy,
          transformations,
          isTransformationRequired,
          isScaleOnlyOrNoTransform,
          options,
          isMemoryCacheable,
          useUnlimitedSourceExecutorPool,
          useAnimationPool,
          onlyRetrieveFromCache,
          cb,
          callbackExecutor,
          key,
          startTime);
    }
  }

  cb.onResourceReady(
      memoryResource, DataSource.MEMORY_CACHE, <span class="hljs-comment">/* isLoadedFromAlternateCacheKey= */</span> <span class="hljs-literal">false</span>);
  <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
}
</code></pre>
<h4 data-id="heading-21">6. loadFromMemory方法</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Nullable</span>
<span class="hljs-keyword">private</span> EngineResource&lt;?&gt; loadFromMemory(
    EngineKey key, <span class="hljs-type">boolean</span> isMemoryCacheable, <span class="hljs-type">long</span> startTime) {
  <span class="hljs-keyword">if</span> (!isMemoryCacheable) {
    <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
  }
  <span class="hljs-comment">// 检查【活动资源缓存】（ActiveResources，弱引用）</span>
  EngineResource&lt;?&gt; active = loadFromActiveResources(key);
  <span class="hljs-keyword">if</span> (active != <span class="hljs-literal">null</span>) {
    <span class="hljs-keyword">if</span> (VERBOSE_IS_LOGGABLE) {
      logWithTimeAndKey(<span class="hljs-string">"Loaded resource from active resources"</span>, startTime, key);
    }
    <span class="hljs-keyword">return</span> active;
  }
  检查【LRU内存缓存】（LruResourceCache）
  EngineResource&lt;?&gt; cached = loadFromCache(key);
  <span class="hljs-keyword">if</span> (cached != <span class="hljs-literal">null</span>) {
    <span class="hljs-keyword">if</span> (VERBOSE_IS_LOGGABLE) {
      logWithTimeAndKey(<span class="hljs-string">"Loaded resource from cache"</span>, startTime, key);
    }
    <span class="hljs-keyword">return</span> cached;
  }

  <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
}
</code></pre>
<h4 data-id="heading-22">7. waitForExistingOrStartNewJob方法</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">private</span> &lt;R&gt; LoadStatus <span class="hljs-title function_">waitForExistingOrStartNewJob</span><span class="hljs-params">(
    GlideContext glideContext,
    Object model,
    Key signature,
    <span class="hljs-type">int</span> width,
    <span class="hljs-type">int</span> height,
    Class&lt;?&gt; resourceClass,
    Class&lt;R&gt; transcodeClass,
    Priority priority,
    DiskCacheStrategy diskCacheStrategy,
    Map&lt;Class&lt;?&gt;, Transformation&lt;?&gt;&gt; transformations,
    <span class="hljs-type">boolean</span> isTransformationRequired,
    <span class="hljs-type">boolean</span> isScaleOnlyOrNoTransform,
    Options options,
    <span class="hljs-type">boolean</span> isMemoryCacheable,
    <span class="hljs-type">boolean</span> useUnlimitedSourceExecutorPool,
    <span class="hljs-type">boolean</span> useAnimationPool,
    <span class="hljs-type">boolean</span> onlyRetrieveFromCache,
    ResourceCallback cb,
    Executor callbackExecutor,
    EngineKey key,
    <span class="hljs-type">long</span> startTime)</span> {

  <span class="hljs-comment">// 检查是否有相同Key的【正在执行的请求】</span>
  EngineJob&lt;?&gt; current = jobs.get(key, onlyRetrieveFromCache);
  <span class="hljs-keyword">if</span> (current != <span class="hljs-literal">null</span>) {
    current.addCallback(cb, callbackExecutor);
    <span class="hljs-keyword">if</span> (VERBOSE_IS_LOGGABLE) {
      logWithTimeAndKey(<span class="hljs-string">"Added to existing load"</span>, startTime, key);
    }
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">LoadStatus</span>(cb, current);
  }
  <span class="hljs-comment">//【缓存未命中】需要创建新任务</span>
  EngineJob&lt;R&gt; engineJob =
      engineJobFactory.build(
          key,
          isMemoryCacheable,
          useUnlimitedSourceExecutorPool,
          useAnimationPool,
          onlyRetrieveFromCache);

  DecodeJob&lt;R&gt; decodeJob =
      decodeJobFactory.build(
          glideContext,
          model,
          key,
          signature,
          width,
          height,
          resourceClass,
          transcodeClass,
          priority,
          diskCacheStrategy,
          transformations,
          isTransformationRequired,
          isScaleOnlyOrNoTransform,
          onlyRetrieveFromCache,
          options,
          engineJob);

  jobs.put(key, engineJob);

  engineJob.addCallback(cb, callbackExecutor);
  <span class="hljs-comment">// 启动DecodeJob</span>
  engineJob.start(decodeJob);

  <span class="hljs-keyword">if</span> (VERBOSE_IS_LOGGABLE) {
    logWithTimeAndKey(<span class="hljs-string">"Started new load"</span>, startTime, key);
  }
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">LoadStatus</span>(cb, engineJob);
}
</code></pre>
<p><strong>关键点</strong>：</p>
<ul>
<li>四级缓存在这里检查了两级（活动资源和内存缓存）</li>
<li>EngineKey是缓存的唯一标识，任何参数变化都会生成不同的Key</li>
<li>jobs 是一个存储正在执行任务的Map，用于请求合并</li>
</ul>
<h4 data-id="heading-23">8. EngineJob：任务管理和线程切换器</h4>
<p>EngineJob是一个管理和协调者，本身不执行加载，而是管理 DecodeJob的执行和回调</p>
<p>EngineJob.start(decodeJob)做了什么？</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">synchronized</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">start</span><span class="hljs-params">(DecodeJob&lt;R&gt; decodeJob)</span> {
  <span class="hljs-built_in">this</span>.decodeJob = decodeJob;
  <span class="hljs-type">GlideExecutor</span> <span class="hljs-variable">executor</span> <span class="hljs-operator">=</span>
      decodeJob.willDecodeFromCache() ? diskCacheExecutor : getActiveSourceExecutor();
  <span class="hljs-comment">// 将decodeJob提交到线程池</span>
  executor.execute(decodeJob);
}
</code></pre>
<p><strong>EngineJob的核心职责</strong>：</p>
<ul>
<li>持有DecodeJob：负责将DecodeJob提交到合适的线程池执行</li>
<li>管理回调：一个EngineJob可能对应多个Target（请求合并）</li>
<li>线程切换：当DecodeJob在子线程完成解码后，EngineJob负责将结果切换回主线程通知Target</li>
<li>资源释放：通过EngineResource的引用计数机制，跟踪资源使用情况</li>
</ul>
<h4 data-id="heading-24">9. DecodeJob：真正执行加载器</h4>
<p>DecodeJob 实现了Runable接口，是真正执行加载，解码，变换的“工人”，它的run（）方法是核心<br/>
DecodeJob.run()的主流程如下：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// We need to rethrow only CallbackException, but not other types of Throwables.</span>
<span class="hljs-meta">@SuppressWarnings("PMD.AvoidRethrowingException")</span>
<span class="hljs-meta">@Override</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">run</span><span class="hljs-params">()</span> {
  GlideTrace.beginSectionFormat(<span class="hljs-string">"DecodeJob#run(reason=%s, model=%s)"</span>, runReason, model);
  DataFetcher&lt;?&gt; localFetcher = currentFetcher;
  <span class="hljs-keyword">try</span> {
    <span class="hljs-keyword">if</span> (isCancelled) {
      notifyFailed();
      <span class="hljs-keyword">return</span>;
    }
    <span class="hljs-comment">// 核心方法：执行解码</span>
    runWrapped();
  } <span class="hljs-keyword">catch</span> (CallbackException e) {
    <span class="hljs-keyword">throw</span> e;
  } <span class="hljs-keyword">catch</span> (Throwable t) {
    <span class="hljs-keyword">if</span> (Log.isLoggable(TAG, Log.DEBUG)) {
      Log.d(
          TAG,
          <span class="hljs-string">"DecodeJob threw unexpectedly"</span> + <span class="hljs-string">", isCancelled: "</span> + isCancelled + <span class="hljs-string">", stage: "</span> + stage,
          t);
    }
    <span class="hljs-keyword">if</span> (stage != Stage.ENCODE) {
      throwables.add(t);
      notifyFailed();
    }
    <span class="hljs-keyword">if</span> (!isCancelled) {
      <span class="hljs-keyword">throw</span> t;
    }
    <span class="hljs-keyword">throw</span> t;
  } <span class="hljs-keyword">finally</span> {
    <span class="hljs-keyword">if</span> (localFetcher != <span class="hljs-literal">null</span>) {
      localFetcher.cleanup();
    }
    GlideTrace.endSection();
  }
}
</code></pre>
<h4 data-id="heading-25">10. runWrapped方法</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">runWrapped</span><span class="hljs-params">()</span> {
  <span class="hljs-keyword">switch</span> (runReason) {
    <span class="hljs-keyword">case</span> INITIALIZE:
      <span class="hljs-comment">// 根据缓存策略，决定从哪个阶段开始</span>
      stage = getNextStage(Stage.INITIALIZE);
      currentGenerator = getNextGenerator();
      <span class="hljs-comment">// 开始执行</span>
      runGenerators();
      <span class="hljs-keyword">break</span>;
    <span class="hljs-keyword">case</span> SWITCH_TO_SOURCE_SERVICE:
      runGenerators();
      <span class="hljs-keyword">break</span>;
    <span class="hljs-keyword">case</span> DECODE_DATA:
      decodeFromRetrievedData();
      <span class="hljs-keyword">break</span>;
    <span class="hljs-keyword">default</span>:
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalStateException</span>(<span class="hljs-string">"Unrecognized run reason: "</span> + runReason);
  }
}
</code></pre>
<p><strong>DecodeJob的三阶段工作流（DataFetcher）</strong></p>
<p>DecodeJob内部使用三个DataFetcherGenerator来按顺序尝试获取数据：</p>
<ul>
<li>ResourceCacheGenerator：尝试从磁盘缓存（转换后的图片）加载</li>
<li>DataCacheGenerator：尝试从磁盘缓存（原始数据）加载</li>
<li>SourceGenerator：最后从原始源（网络、文件等）加载</li>
</ul>
<h4 data-id="heading-26">11. runGenerators方法</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">runGenerators</span><span class="hljs-params">()</span> {
  currentThread = Thread.currentThread();
  startFetchTime = LogTime.getLogTime();
  <span class="hljs-type">boolean</span> <span class="hljs-variable">isStarted</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>;
  <span class="hljs-keyword">while</span> (!isCancelled
      &amp;&amp; currentGenerator != <span class="hljs-literal">null</span>
      &amp;&amp; !(isStarted = currentGenerator.startNext())) {
    <span class="hljs-comment">// 如果当前Generator无法获取数据（未命中），则切换到下一个</span>
    stage = getNextStage(stage);
    currentGenerator = getNextGenerator();

    <span class="hljs-keyword">if</span> (stage == Stage.SOURCE) {
      <span class="hljs-comment">// 当回退到SOURCE阶段时，需要切回主线程回调进度等</span>
      reschedule(RunReason.SWITCH_TO_SOURCE_SERVICE);
      <span class="hljs-keyword">return</span>;
    }
  }
  <span class="hljs-comment">// We've run out of stages and generators, give up.</span>
  <span class="hljs-keyword">if</span> ((stage == Stage.FINISHED || isCancelled) &amp;&amp; !isStarted) {
    notifyFailed();
  }

  <span class="hljs-comment">// Otherwise a generator started a new load and we expect to be called back in</span>
  <span class="hljs-comment">// onDataFetcherReady.</span>
}
</code></pre>
<h4 data-id="heading-27">12. startNext方法</h4>
<p>SourceGenerator的网络加载过程：  当回退到SourceGenerator时，会通过ModelLoader加载网络数据</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// Concurrent access isn't supported.</span>
<span class="hljs-meta">@SuppressWarnings({"NonAtomicOperationOnVolatileField", "NonAtomicVolatileUpdate"})</span>
<span class="hljs-meta">@Override</span>
<span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">startNext</span><span class="hljs-params">()</span> {
  <span class="hljs-keyword">if</span> (dataToCache != <span class="hljs-literal">null</span>) {
    <span class="hljs-type">Object</span> <span class="hljs-variable">data</span> <span class="hljs-operator">=</span> dataToCache;
    dataToCache = <span class="hljs-literal">null</span>;
    <span class="hljs-keyword">try</span> {
      <span class="hljs-comment">// 先缓存原始数据</span>
      <span class="hljs-type">boolean</span> <span class="hljs-variable">isDataInCache</span> <span class="hljs-operator">=</span> cacheData(data);
      <span class="hljs-keyword">if</span> (!isDataInCache) {
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
      }
      <span class="hljs-keyword">if</span> (Log.isLoggable(TAG, Log.DEBUG)) {
        Log.d(TAG, <span class="hljs-string">"Failed to properly rewind or write data to cache"</span>, e);
      }
    }
  }
  
  <span class="hljs-keyword">if</span> (sourceCacheGenerator != <span class="hljs-literal">null</span> &amp;&amp; sourceCacheGenerator.startNext()) {
    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
  }
  sourceCacheGenerator = <span class="hljs-literal">null</span>;

  loadData = <span class="hljs-literal">null</span>;
  <span class="hljs-type">boolean</span> <span class="hljs-variable">started</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>;
  <span class="hljs-keyword">while</span> (!started &amp;&amp; hasNextModelLoader()) {
    <span class="hljs-comment">// 通过ModelLoader获取DataFetcher</span>
    loadData = helper.getLoadData().get(loadDataListIndex++);
    <span class="hljs-keyword">if</span> (loadData != <span class="hljs-literal">null</span>
        &amp;&amp; (helper.getDiskCacheStrategy().isDataCacheable(loadData.fetcher.getDataSource())
            || helper.hasLoadPath(loadData.fetcher.getDataClass()))) {
      started = <span class="hljs-literal">true</span>;
      <span class="hljs-comment">// 开始加载</span>
      startNextLoad(loadData);
    }
  }
  <span class="hljs-keyword">return</span> started;
}
</code></pre>
<h4 data-id="heading-28">13. startNextLoad方法</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">startNextLoad</span><span class="hljs-params">(<span class="hljs-keyword">final</span> LoadData&lt;?&gt; toStart)</span> {
  loadData.fetcher.loadData(
      helper.getPriority(),
      <span class="hljs-keyword">new</span> <span class="hljs-title class_">DataCallback</span>&lt;Object&gt;() {
        <span class="hljs-comment">// 加载完成的回调</span>
        <span class="hljs-meta">@Override</span>
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onDataReady</span><span class="hljs-params">(<span class="hljs-meta">@Nullable</span> Object data)</span> {
          <span class="hljs-keyword">if</span> (isCurrentRequest(toStart)) {
            onDataReadyInternal(toStart, data);
          }
        }

        <span class="hljs-meta">@Override</span>
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onLoadFailed</span><span class="hljs-params">(<span class="hljs-meta">@NonNull</span> Exception e)</span> {
          <span class="hljs-keyword">if</span> (isCurrentRequest(toStart)) {
            onLoadFailedInternal(toStart, e);
          }
        }
      });
}
</code></pre>
<h4 data-id="heading-29">14. onDataReadyInternal方法</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@SuppressWarnings("WeakerAccess")</span>
<span class="hljs-meta">@Synthetic</span>
<span class="hljs-keyword">void</span> <span class="hljs-title function_">onDataReadyInternal</span><span class="hljs-params">(LoadData&lt;?&gt; loadData, Object data)</span> {
  <span class="hljs-type">DiskCacheStrategy</span> <span class="hljs-variable">diskCacheStrategy</span> <span class="hljs-operator">=</span> helper.getDiskCacheStrategy();
  <span class="hljs-keyword">if</span> (data != <span class="hljs-literal">null</span> &amp;&amp; diskCacheStrategy.isDataCacheable(loadData.fetcher.getDataSource())) {
    <span class="hljs-comment">// 标记需要缓存</span>
    dataToCache = data;
    cb.reschedule();
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-comment">// 将数据交给DecodeJob继续处理（解码、变换）</span>
    cb.onDataFetcherReady(
        loadData.sourceKey,
        data,
        loadData.fetcher,
        loadData.fetcher.getDataSource(),
        originalKey);
  }
}
</code></pre>
<h4 data-id="heading-30">15. DecodeJob.decodeFromRetrievedData方法</h4>
<p>数据解码与变换流程：  当获取到数据后，会回到DecodeJob.decodeFromRetrievedData()</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Override</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onDataFetcherReady</span><span class="hljs-params">(
    Key sourceKey, Object data, DataFetcher&lt;?&gt; fetcher, DataSource dataSource, Key attemptedKey)</span> {
  <span class="hljs-built_in">this</span>.currentSourceKey = sourceKey;
  <span class="hljs-built_in">this</span>.currentData = data;
  <span class="hljs-built_in">this</span>.currentFetcher = fetcher;
  <span class="hljs-built_in">this</span>.currentDataSource = dataSource;
  <span class="hljs-built_in">this</span>.currentAttemptingKey = attemptedKey;
  <span class="hljs-built_in">this</span>.isLoadingFromAlternateCacheKey = sourceKey != decodeHelper.getCacheKeys().get(<span class="hljs-number">0</span>);

  <span class="hljs-keyword">if</span> (Thread.currentThread() != currentThread) {
    reschedule(RunReason.DECODE_DATA);
  } <span class="hljs-keyword">else</span> {
    GlideTrace.beginSection(<span class="hljs-string">"DecodeJob.decodeFromRetrievedData"</span>);
    <span class="hljs-keyword">try</span> {
      decodeFromRetrievedData();
    } <span class="hljs-keyword">finally</span> {
      GlideTrace.endSection();
    }
  }
}
</code></pre>
<h4 data-id="heading-31">16. decodeFromRetrievedData方法</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">decodeFromRetrievedData</span><span class="hljs-params">()</span> {
  <span class="hljs-keyword">if</span> (Log.isLoggable(TAG, Log.VERBOSE)) {
    logWithTimeAndKey(
        <span class="hljs-string">"Retrieved data"</span>,
        startFetchTime,
        <span class="hljs-string">"data: "</span>
            + currentData
            + <span class="hljs-string">", cache key: "</span>
            + currentSourceKey
            + <span class="hljs-string">", fetcher: "</span>
            + currentFetcher);
  }
  Resource&lt;R&gt; resource = <span class="hljs-literal">null</span>;
  <span class="hljs-keyword">try</span> {
    <span class="hljs-comment">// 核心解码方法</span>
    resource = decodeFromData(currentFetcher, currentData, currentDataSource);
  } <span class="hljs-keyword">catch</span> (GlideException e) {
    e.setLoggingDetails(currentAttemptingKey, currentDataSource);
    throwables.add(e);
  }
  <span class="hljs-keyword">if</span> (resource != <span class="hljs-literal">null</span>) {
    <span class="hljs-comment">// 通知EngineJob资源就绪</span>
    notifyEncodeAndRelease(resource, currentDataSource, isLoadingFromAlternateCacheKey);
  } <span class="hljs-keyword">else</span> {
    runGenerators();
  }
}

<span class="hljs-keyword">private</span> &lt;Data&gt; Resource&lt;R&gt; <span class="hljs-title function_">decodeFromData</span><span class="hljs-params">(
    DataFetcher&lt;?&gt; fetcher, Data data, DataSource dataSource)</span> <span class="hljs-keyword">throws</span> GlideException {
  <span class="hljs-keyword">try</span> {
    <span class="hljs-keyword">if</span> (data == <span class="hljs-literal">null</span>) {
      <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
    }
    <span class="hljs-type">long</span> <span class="hljs-variable">startTime</span> <span class="hljs-operator">=</span> LogTime.getLogTime();
    Resource&lt;R&gt; result = decodeFromFetcher(data, dataSource);
    <span class="hljs-keyword">if</span> (Log.isLoggable(TAG, Log.VERBOSE)) {
      logWithTimeAndKey(<span class="hljs-string">"Decoded result "</span> + result, startTime);
    }
    <span class="hljs-keyword">return</span> result;
  } <span class="hljs-keyword">finally</span> {
    fetcher.cleanup();
  }
}

<span class="hljs-keyword">private</span> &lt;Data&gt; Resource&lt;R&gt; <span class="hljs-title function_">decodeFromFetcher</span><span class="hljs-params">(Data data, DataSource dataSource)</span>
    <span class="hljs-keyword">throws</span> GlideException {
  LoadPath&lt;Data, ?, R&gt; path = decodeHelper.getLoadPath((Class&lt;Data&gt;) data.getClass());
  <span class="hljs-keyword">return</span> runLoadPath(data, dataSource, path);
}

<span class="hljs-keyword">private</span> &lt;Data, ResourceType&gt; Resource&lt;R&gt; <span class="hljs-title function_">runLoadPath</span><span class="hljs-params">(
    Data data, DataSource dataSource, LoadPath&lt;Data, ResourceType, R&gt; path)</span>
    <span class="hljs-keyword">throws</span> GlideException {
  <span class="hljs-type">Options</span> <span class="hljs-variable">options</span> <span class="hljs-operator">=</span> getOptionsWithHardwareConfig(dataSource);
  DataRewinder&lt;Data&gt; rewinder = glideContext.getRegistry().getRewinder(data);
  <span class="hljs-keyword">try</span> {
    <span class="hljs-comment">// ResourceType in DecodeCallback below is required for compilation to work with gradle.</span>
    <span class="hljs-comment">// 通过LoadPath执行解码链：解码 -&gt; 变换 -&gt; 转码</span>
    <span class="hljs-keyword">return</span> path.load(
        rewinder, options, width, height, <span class="hljs-keyword">new</span> <span class="hljs-title class_">DecodeCallback</span>&lt;ResourceType&gt;(dataSource));
  } <span class="hljs-keyword">finally</span> {
    rewinder.cleanup();
  }
}
</code></pre>
<h4 data-id="heading-32">17. notifyEncodeAndRelease方法</h4>
<p>回到EngineJob：结果分发</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">notifyEncodeAndRelease</span><span class="hljs-params">(
    Resource&lt;R&gt; resource, DataSource dataSource, <span class="hljs-type">boolean</span> isLoadedFromAlternateCacheKey)</span> {
  GlideTrace.beginSection(<span class="hljs-string">"DecodeJob.notifyEncodeAndRelease"</span>);
  <span class="hljs-keyword">try</span> {
    <span class="hljs-keyword">if</span> (resource <span class="hljs-keyword">instanceof</span> Initializable) {
      ((Initializable) resource).initialize();
    }

    Resource&lt;R&gt; result = resource;
    LockedResource&lt;R&gt; lockedResource = <span class="hljs-literal">null</span>;
    <span class="hljs-keyword">if</span> (deferredEncodeManager.hasResourceToEncode()) {
      lockedResource = LockedResource.obtain(resource);
      result = lockedResource;
    }

    notifyComplete(result, dataSource, isLoadedFromAlternateCacheKey);

    stage = Stage.ENCODE;
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">if</span> (deferredEncodeManager.hasResourceToEncode()) {
        deferredEncodeManager.encode(diskCacheProvider, options);
      }
    } <span class="hljs-keyword">finally</span> {
      <span class="hljs-keyword">if</span> (lockedResource != <span class="hljs-literal">null</span>) {
        lockedResource.unlock();
      }
    }
    onEncodeComplete();
  } <span class="hljs-keyword">finally</span> {
    GlideTrace.endSection();
  }
}

<span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">notifyComplete</span><span class="hljs-params">(
    Resource&lt;R&gt; resource, DataSource dataSource, <span class="hljs-type">boolean</span> isLoadedFromAlternateCacheKey)</span> {
  setNotifiedOrThrow();
  callback.onResourceReady(resource, dataSource, isLoadedFromAlternateCacheKey);
}
</code></pre>
<h4 data-id="heading-33">18. EngineJob.onResourceReady方法</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Override</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onResourceReady</span><span class="hljs-params">(
    Resource&lt;R&gt; resource, DataSource dataSource, <span class="hljs-type">boolean</span> isLoadedFromAlternateCacheKey)</span> {
  <span class="hljs-keyword">synchronized</span> (<span class="hljs-built_in">this</span>) {
    <span class="hljs-built_in">this</span>.resource = resource;
    <span class="hljs-built_in">this</span>.dataSource = dataSource;
    <span class="hljs-built_in">this</span>.isLoadedFromAlternateCacheKey = isLoadedFromAlternateCacheKey;
  }
  <span class="hljs-comment">// 通知回调</span>
  notifyCallbacksOfResult();
}

<span class="hljs-meta">@SuppressWarnings({
  "WeakerAccess",
  "PMD.AvoidInstantiatingObjectsInLoops",
  "PMD.AccessorMethodGeneration"
})</span>
<span class="hljs-meta">@Synthetic</span>
<span class="hljs-keyword">void</span> <span class="hljs-title function_">notifyCallbacksOfResult</span><span class="hljs-params">()</span> {
  ResourceCallbacksAndExecutors copy;
  Key localKey;
  EngineResource&lt;?&gt; localResource;
  <span class="hljs-keyword">synchronized</span> (<span class="hljs-built_in">this</span>) {
    stateVerifier.throwIfRecycled();
    <span class="hljs-keyword">if</span> (isCancelled) {
      resource.recycle();
      release();
      <span class="hljs-keyword">return</span>;
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (cbs.isEmpty()) {
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalStateException</span>(<span class="hljs-string">"Received a resource without any callbacks to notify"</span>);
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (hasResource) {
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalStateException</span>(<span class="hljs-string">"Already have resource"</span>);
    }
    engineResource = engineResourceFactory.build(resource, isCacheable, key, resourceListener);
    
    hasResource = <span class="hljs-literal">true</span>;
    copy = cbs.copy();
    incrementPendingCallbacks(copy.size() + <span class="hljs-number">1</span>);

    localKey = key;
    localResource = engineResource;
  }

  engineJobListener.onEngineJobComplete(<span class="hljs-built_in">this</span>, localKey, localResource);

  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">final</span> ResourceCallbackAndExecutor entry : copy) {
    entry.executor.execute(<span class="hljs-keyword">new</span> <span class="hljs-title class_">CallResourceReady</span>(entry.cb));
  }
  decrementPendingCallbacks();
}
</code></pre>
<h4 data-id="heading-34">19. into方法流程总结</h4>
<pre><code class="hljs language-text" lang="text">into() 
→ SingleRequest.begin() 
→ Engine.load() 
    ├→ 命中活动资源 → 直接返回
    ├→ 命中内存缓存 → 直接返回  
    └→ 未命中 → 创建EngineJob &amp; DecodeJob
        → EngineJob.start(decodeJob) 
        → 线程池执行DecodeJob.run()
        → DecodeJob.runWrapped()
            ├→ ResourceCacheGenerator (转换后缓存)
            ├→ DataCacheGenerator (原始数据缓存)
            └→ SourceGenerator (网络/文件)
                → ModelLoader.loadData() 
                → DataFetcher (如HttpUrlFetcher)
                → 获取数据后回调
        → 解码 → 变换 → 得到最终Resource
        → EngineJob.onResourceReady()
        → 切换主线程 → 回调Target → 显示图片
        → EngineResource引用计数管理
</code></pre>
<h2 data-id="heading-35">四、完整调用链总结</h2>
<pre><code class="hljs language-text" lang="text">Glide.with(context)                    // 1. 获取RequestManager（绑定生命周期）
    .load(model)                       // 2. 创建RequestBuilder，设置数据模型
    .apply(options)                    // 3. 配置请求参数
    .thumbnail(...)                    // 4. 可选：设置缩略图
    .listener(...)                     // 5. 可选：设置监听器
    .into(target)                      // 6. 构建并提交请求，开始加载
        ↓
    RequestManager.track(target, request) // 7. 生命周期跟踪
        ↓
    Engine.load()                         // 8. 缓存检查与任务调度
        ↓
    DecodeJob.run()                       // 9. 执行解码任务
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[详解 patch-package：如何优雅地修改 node_modules（打补丁）]]></title>    <link>https://juejin.cn/post/7600370554069221402</link>    <guid>https://juejin.cn/post/7600370554069221402</guid>    <pubDate>2026-01-29T05:18:59.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600370554069221402" data-draft-id="7600370554069205018" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="详解 patch-package：如何优雅地修改 node_modules（打补丁）"/> <meta itemprop="keywords" content="React Native"/> <meta itemprop="datePublished" content="2026-01-29T05:18:59.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="墨狂之逸才"/> <meta itemprop="url" content="https://juejin.cn/user/624178332441166"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            详解 patch-package：如何优雅地修改 node_modules（打补丁）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/624178332441166/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    墨狂之逸才
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-29T05:18:59.000Z" title="Thu Jan 29 2026 05:18:59 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><hr/>
<h2 data-id="heading-0">详解 patch-package：如何优雅地修改 node_modules（打补丁）</h2>
<p>在开发过程中，我们经常会遇到第三方库（<code>node_modules</code>）有 bug 或者不支持某些功能的情况。直接修改 <code>node_modules</code> 下的文件虽然能暂时解决问题，但一旦重新运行 <code>npm install</code> 或者同事拉取代码，这些修改就会丢失。</p>
<p><code>patch-package</code> 就是为了解决这个问题而生的。它允许你<strong>持久化</strong>对 <code>node_modules</code> 的修改，并确保团队中的每个人都能自动应用这些修改。</p>
<h3 data-id="heading-1">1. 核心原理与配置解读</h3>
<p>你提到的 <code>package.json</code> 中的两行代码是整个机制的核心：</p>
<h4 data-id="heading-2">L117: 工具依赖</h4>
<pre><code class="hljs language-json" lang="json"><span class="hljs-attr">"devDependencies"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"patch-package"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"^8.0.1"</span><span class="hljs-punctuation">,</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<ul>
<li><strong>作用</strong>：安装 <code>patch-package</code> 这个工具本身。</li>
<li><strong>目的</strong>：让你能够使用 <code>npx patch-package &lt;库名&gt;</code> 命令来生成补丁文件。</li>
</ul>
<h4 data-id="heading-3">L13: 自动化钩子 (Hook)</h4>
<pre><code class="hljs language-json" lang="json"><span class="hljs-attr">"scripts"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"postinstall"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"patch-package"</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<ul>
<li><strong>作用</strong>：这是一个 npm 生命周期钩子。</li>
<li><strong>目的</strong>：<strong>这是最关键的一步</strong>。每当你（或者你的 CI/CD 系统）运行 <code>npm install</code> 或 <code>yarn</code> 安装依赖<strong>完成之后</strong>，npm 会自动执行 <code>postinstall</code> 指定的命令。</li>
<li><strong>流程</strong>：<code>npm install</code> (下载原始包) -&gt; <code>postinstall</code> (触发 <code>patch-package</code>) -&gt; <code>patch-package</code> 会查找 <code>patches/</code> 目录下的补丁文件 -&gt; <strong>自动将补丁应用到 node_modules 中</strong>。</li>
</ul>
<hr/>
<h3 data-id="heading-4">2. 环境要求</h3>
<p>使用 <code>patch-package</code> 不需要复杂的环境，只需要标准的 Node.js 开发环境：</p>
<ul>
<li><strong>Node.js</strong>: &gt;= 14 (推荐 LTS 版本)</li>
<li><strong>包管理器</strong>: npm, yarn, 或 pnpm 均可。</li>
<li><strong>Git</strong>: 用于版本控制（必须提交生成的 <code>.patch</code> 文件）。</li>
</ul>
<hr/>
<h3 data-id="heading-5">3. 完整操作流程 (Workflow)</h3>
<p>假设我们要修改 <code>@ant-design/icons-react-native</code> 这个库（就像刚才做的那样）。</p>
<h4 data-id="heading-6">第一步：安装 patch-package (一次性设置)</h4>
<p>如果项目中还没有配置，需要先安装并设置 <code>postinstall</code> 脚本。</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 安装</span>
npm install patch-package --save-dev
<span class="hljs-comment"># 或者</span>
yarn add patch-package -D

<span class="hljs-comment"># 配置 package.json (手动添加或修改)</span>
<span class="hljs-comment"># "scripts": {</span>
<span class="hljs-comment">#   "postinstall": "patch-package"</span>
<span class="hljs-comment"># }</span>
</code></pre>
<h4 data-id="heading-7">第二步：直接修改源码</h4>
<p>在你的 IDE 中，直接打开 <code>node_modules/@ant-design/icons-react-native/react-native.config.js</code>，进行你想要的修改。</p>
<ul>
<li><strong>修改前</strong>：<code>assets: ['fonts']</code></li>
<li><strong>修改后</strong>：<code>// assets: ['fonts']</code> (注释掉，避免字体链接错误)</li>
</ul>
<h4 data-id="heading-8">第三步：生成补丁 (Snapshot)</h4>
<p>修改完成后，运行以下命令告诉 <code>patch-package</code> 你修改了哪个包：</p>
<pre><code class="hljs language-bash" lang="bash">npx patch-package @ant-design/icons-react-native
</code></pre>
<p><strong>结果</strong>：
工具会在你的项目根目录下自动生成一个文件夹 <code>patches/</code>，里面有一个文件，例如 <code>@ant-design+icons-react-native+2.3.2.patch</code>。这个文件记录了你的修改内容（diff）。</p>
<h4 data-id="heading-9">第四步：提交代码</h4>
<p>将生成的 <code>patches/</code> 目录和 <code>package.json</code> 的变动提交到 Git。</p>
<pre><code class="hljs language-bash" lang="bash">git add patches/ package.json
git commit -m <span class="hljs-string">"fix: patch @ant-design/icons-react-native to disable font linking"</span>
</code></pre>
<h4 data-id="heading-10">第五步：验证与自动应用</h4>
<ul>
<li><strong>你自己</strong>：下次你删除了 <code>node_modules</code> 重新 <code>yarn</code> 时，补丁会自动应用。</li>
<li><strong>你的同事</strong>：拉取最新代码并运行 <code>yarn</code> 后，补丁也会自动应用，他们的 <code>node_modules</code> 会和你的一模一样。</li>
</ul>
<hr/>
<h3 data-id="heading-11">4. 总结</h3>

























<table><thead><tr><th align="left">文件/命令</th><th align="left">作用</th></tr></thead><tbody><tr><td align="left"><code>node_modules/...</code></td><td align="left">你<strong>临时</strong>修改源码的地方。</td></tr><tr><td align="left"><code>npx patch-package &lt;包名&gt;</code></td><td align="left">将你的临时修改<strong>保存</strong>为补丁文件。</td></tr><tr><td align="left"><code>patches/*.patch</code></td><td align="left">补丁文件，必须<strong>提交到 Git</strong>。</td></tr><tr><td align="left"><code>"postinstall": "patch-package"</code></td><td align="left">确保每次安装依赖后，补丁都会被<strong>重新应用</strong>。</td></tr></tbody></table>
<p>这就是为什么我们在 <code>package.json</code> 中需要那两行配置。它们保证了“一次修改，永久生效，团队共享”。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Python对象的自连接]]></title>    <link>https://juejin.cn/post/7600489282822733874</link>    <guid>https://juejin.cn/post/7600489282822733874</guid>    <pubDate>2026-01-29T03:59:42.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600489282822733874" data-draft-id="7600489282822701106" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Python对象的自连接"/> <meta itemprop="keywords" content="Python"/> <meta itemprop="datePublished" content="2026-01-29T03:59:42.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="深度涌现"/> <meta itemprop="url" content="https://juejin.cn/user/2524932621734990"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Python对象的自连接
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2524932621734990/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    深度涌现
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-29T03:59:42.000Z" title="Thu Jan 29 2026 03:59:42 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    2
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Python对象的自连接</h2>
<p>在Python中，<strong>字符串可以与数字相乘</strong>。</p>
<h2 data-id="heading-1">将字符串连接到数字不起作用。</h2>
<p>在Python中，字符串和数字之间不能使用加号（ <code>+</code> ）：</p>
<pre><code class="hljs language-sql" lang="sql">prefix <span class="hljs-operator">=</span> "year: "
<span class="hljs-keyword">year</span> <span class="hljs-operator">=</span> <span class="hljs-number">1999</span>
prefix <span class="hljs-operator">+</span> <span class="hljs-keyword">year</span>
Traceback (most recent <span class="hljs-keyword">call</span> <span class="hljs-keyword">last</span>):
  File "&lt;python-input-4&gt;", line <span class="hljs-number">1</span>, <span class="hljs-keyword">in</span> <span class="hljs-operator">&lt;</span><span class="hljs-keyword">module</span><span class="hljs-operator">&gt;</span>
    prefix <span class="hljs-operator">+</span> <span class="hljs-keyword">year</span>
    <span class="hljs-operator">~</span><span class="hljs-operator">~</span><span class="hljs-operator">~</span><span class="hljs-operator">~</span><span class="hljs-operator">~</span><span class="hljs-operator">~</span><span class="hljs-operator">~</span><span class="hljs-operator">^</span><span class="hljs-operator">~</span><span class="hljs-operator">~</span><span class="hljs-operator">~</span><span class="hljs-operator">~</span><span class="hljs-operator">~</span>
TypeError: can <span class="hljs-keyword">only</span> concatenate str (<span class="hljs-keyword">not</span> "int") <span class="hljs-keyword">to</span> str
</code></pre>
<p>您可以使用加号将<strong>两个数字相加</strong>：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">year</span> <span class="hljs-operator">+</span> <span class="hljs-number">1</span>
<span class="hljs-number">2000</span>
</code></pre>
<p>或者将<strong>两个字符串连接起来</strong>：</p>
<pre><code class="hljs language-python" lang="python">prefix + <span class="hljs-built_in">str</span>(year)
<span class="hljs-string">'year: 1999'</span>
</code></pre>
<p>但它<strong>不适用于字符串和数字之间</strong>。</p>
<h2 data-id="heading-2">将字符串乘以数字</h2>
<p>有趣的是，你<em>可以</em><strong>将一个字符串乘以一个数字</strong>：</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-string">"ha"</span> * <span class="hljs-number">3</span>
<span class="hljs-string">'hahaha'</span>
</code></pre>
<p>你可以把这理解为<strong>自连接</strong>。我们将这个字符串与自身连接特定的次数：</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-string">"ha"</span> + <span class="hljs-string">"ha"</span> + <span class="hljs-string">"ha"</span>
<span class="hljs-string">'hahaha'</span>
</code></pre>
<h2 data-id="heading-3">自连接仅适用于整数。</h2>
<p>字符串只能用整数自连接：</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-string">"ha"</span> * <span class="hljs-number">2.5</span>
<span class="hljs-built_in">Traceback</span> (most recent call last):
  <span class="hljs-built_in">File</span> <span class="hljs-string">"&lt;python-input-2&gt;"</span>, line <span class="hljs-number">1</span>, in &lt;<span class="hljs-keyword">module</span>&gt;
    <span class="hljs-string">"ha"</span> * <span class="hljs-number">2.5</span>
    ~~~~~^~~~~
TypeError: can<span class="hljs-number">'</span>t multiply sequence by non-<span class="hljs-type">int</span> of type <span class="hljs-string">'float'</span>
</code></pre>
<p>字符串相乘非整数次是没有意义的。</p>
<p>有趣的是，<strong>负数*也可以*</strong>用于自连接，只是结果总是空字符串：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-string">"ha"</span> * -3
<span class="hljs-string">''</span>
</code></pre>
<p>当你将一个字符串乘以<code>0</code>时，也会发生同样的情况：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-string">"ha"</span> * 0
<span class="hljs-string">''</span>
</code></pre>
<h2 data-id="heading-4">序列通常支持自连接</h2>
<p>任何支持字符串拼接的对象，很可能也支持自拼接。</p>
<p>因此，其他序列，如列表、元组和字节串，也可以进行自连接：</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-selector-attr">[2, 1, 3]</span> * <span class="hljs-number">2</span>
<span class="hljs-selector-attr">[2, 1, 3, 2, 1, 3]</span>
(<span class="hljs-number">4</span>, <span class="hljs-number">5</span>) * <span class="hljs-number">3</span>
(<span class="hljs-number">4</span>, <span class="hljs-number">5</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>)
<span class="hljs-selector-tag">b</span>"text " * <span class="hljs-number">3</span>
<span class="hljs-selector-tag">b</span>'text text text '
</code></pre>
<h2 data-id="heading-5">自连接的实际应用</h2>
<p>这算是一个挺有意思的功能，但它存在的意义是什么？它真的有用吗？</p>
<p>我偶尔会使用自连接来<strong>创建具有特定默认值的特定大小的列表</strong>。</p>
<p>例如，我们可以使用自连接来创建一个表示一年中 12 个月的列表，以统计该列表中某个事物出现的次数，并且我们希望将所有计数默认设置为零：</p>
<pre><code class="hljs language-csharp" lang="csharp">[<span class="hljs-meta">0</span>] * <span class="hljs-number">12</span>
[<span class="hljs-meta">0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0</span>]
</code></pre>
<p>但更多时候，我使用这个功能来<strong>创建一个由相同字符重复特定次数的字符串</strong>。</p>
<p>例如，我可能想在程序的输出部分之间打印 80 个连字符（ <code>-</code> ）。</p>
<pre><code class="hljs language-lua" lang="lua"><span class="hljs-built_in">print</span>(<span class="hljs-string">"-"</span> * <span class="hljs-number">80</span>)
<span class="hljs-comment">--------------------------------------------------------------------------------</span>
</code></pre>
<h2 data-id="heading-6">自连接不会复制</h2>
<p>就像在 Python 中创建新的数据结构或分配变量一样，<strong>自连接不会复制任何内容</strong>。</p>
<p>在Python中，给变量赋值并不会复制该值：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-tag">a</span> = <span class="hljs-selector-attr">[2, 1, 3]</span>
<span class="hljs-selector-tag">b</span> = <span class="hljs-selector-tag">a</span>
</code></pre>
<p><strong>Python 中的变量类似于指针</strong>。因此，更改<code>b</code>指向的列表也会更改<code>a</code>指向的列表：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-tag">b</span><span class="hljs-selector-class">.append</span>(<span class="hljs-number">4</span>)
<span class="hljs-selector-tag">b</span>
<span class="hljs-selector-attr">[2, 1, 3, 4]</span>
<span class="hljs-selector-tag">a</span>
<span class="hljs-selector-attr">[2, 1, 3, 4]</span>
</code></pre>
<p>这是因为<strong>这两个变量指向同一个对象</strong>。这就是Python中赋值操作的作用。</p>
<p>就像给变量赋值不会复制该值一样，使用列表或元组的自连接也不会复制这些项。</p>
<p>所以，如果我们尝试将一个包含列表的列表乘以<code>3</code> ，从而将其自身连接三次：</p>
<pre><code class="hljs language-lua" lang="lua">rows = <span class="hljs-string">[[0, 0, 0]]</span> * <span class="hljs-number">3</span>
</code></pre>
<p>最终我们会得到一个包含相同三项的列表：</p>
<pre><code class="hljs language-lua" lang="lua">rows
<span class="hljs-string">[[0, 0, 0], [0, 0, 0], [0, 0, 0]]</span>
</code></pre>
<p>也就是说，索引<code>0</code>与索引<code>1</code>是同一个对象：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">rows</span>[<span class="hljs-number">0</span>] <span class="hljs-keyword">is</span> <span class="hljs-keyword">rows</span>[<span class="hljs-number">1</span>]
<span class="hljs-literal">True</span>
</code></pre>
<p>也就是说，如果我们修改其中一个内部列表，<em>所有</em>内部列表都会随之改变：</p>
<pre><code class="hljs language-css" lang="css">rows<span class="hljs-selector-attr">[1]</span><span class="hljs-selector-attr">[1]</span> = <span class="hljs-number">7</span>
rows
<span class="hljs-selector-attr">[[0, 7, 0]</span>, <span class="hljs-selector-attr">[0, 7, 0]</span>, <span class="hljs-selector-attr">[0, 7, 0]</span>]
</code></pre>
<p>这是因为<strong>它们都属于同一个列表</strong>。</p>
<h2 data-id="heading-7">不要将可变项的列表自连接起来。</h2>
<p>与大多数操作一样，<strong>自连接不会创建副本</strong>。</p>
<p>实际上，这意味着自连接通常<strong>只用于包含不可变项的序列</strong>，而不用于包含可变项的序列。</p>
<h2 data-id="heading-8">何时使用自连接</h2>
<p>自连接可用于创建包含相同字符或相同字符序列且重复次数固定的字符串。它也适用于预先填充包含特定数量默认值的列表。</p>
<p>但是自连接不会复制任何内容，所以不要尝试用它来创建可变值的列表，例如列表的列表。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.pythonmorsels.com%2Fself-concatenation%2F" target="_blank" title="https://www.pythonmorsels.com/self-concatenation/" ref="nofollow noopener noreferrer">www.pythonmorsels.com/self-concat…</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2F4Qd7IoOR8YNhIpGFGWQrAw" target="_blank" title="https://mp.weixin.qq.com/s/4Qd7IoOR8YNhIpGFGWQrAw" ref="nofollow noopener noreferrer">Python对象的自连接</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[【Claude Code】Windows环境下ClaudeCode自定义路径安装及更新PowerShell脚本]]></title>    <link>https://juejin.cn/post/7600370554068959258</link>    <guid>https://juejin.cn/post/7600370554068959258</guid>    <pubDate>2026-01-29T04:02:36.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600370554068959258" data-draft-id="7600370554068926490" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="【Claude Code】Windows环境下ClaudeCode自定义路径安装及更新PowerShell脚本"/> <meta itemprop="keywords" content="开源,Claude"/> <meta itemprop="datePublished" content="2026-01-29T04:02:36.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="等光的影子"/> <meta itemprop="url" content="https://juejin.cn/user/1640889048639277"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            【Claude Code】Windows环境下ClaudeCode自定义路径安装及更新PowerShell脚本
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1640889048639277/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    等光的影子
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-29T04:02:36.000Z" title="Thu Jan 29 2026 04:02:36 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h4 data-id="heading-0">背景</h4>
<p>由于本人对各应用的安装目录有洁癖, 但ClaudeCode官方推出的本地化安装模式无法设置安装路径, 故此基于官方安装脚本进行完善扩展。</p>
<h4 data-id="heading-1">特性</h4>
<ul>
<li>可检查版本是否有更新</li>
<li>可强制覆盖安装</li>
<li>可指定目录安装/更新</li>
<li>可指定具体版本号(2.0.70)/stable/latest版本安装/更新</li>
<li>失败自动重试</li>
<li>自动添加环境变量</li>
<li>文件SHA256校验及更新备份</li>
<li>自动创建ClaudeCode所需本地链接</li>
</ul>
<h4 data-id="heading-2">使用方法</h4>
<p>目录结构如下, 由于安装目录已经配置环境变量, 因此可直接使用, 未配置环境变量则使用如下格式</p>
<blockquote>
<p>.\update-cc.ps1 -h
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d474e844d054444a92a88347d649cae7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg562J5YWJ55qE5b2x5a2Q:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770264155&amp;x-signature=VJfQWY1GMqv4mrjrUA%2BjiKvd%2FUI%3D" alt="在这里插入图片描述" loading="lazy"/></p>
</blockquote>
<pre><code class="hljs language-powershell" lang="powershell"># 显示帮助
update-cc -h
# 更新到最新版本
update-cc
# 安装稳定版
update-cc stable
# 安装指定版本
update-cc 2.0.71
# 强制更新
update-cc -f
# 安装指定目录
update-cc -i "C:\ClaudeCode"
</code></pre>
<h4 data-id="heading-3">脚本内容</h4>
<pre><code class="hljs language-powershell" lang="powershell"># Windows - Claude Code 安装及更新脚本
# 作者: SmallBaby
# 版本: v1.1

param(
    [Parameter(Position=0)]
    [ValidatePattern('^(stable|latest|\d+\.\d+\.\d+(-[^\s]+)?)$')]
    [string]$Target = "latest",

    [switch]$Force,
    [switch]$Help,
    [string]$InstallDir = "C:\Software\ClaudeCode",
    [string]$Platform = "win32-x64"
)

$ErrorActionPreference = "Stop"
$script:ScriptDir = Split-Path -Parent $MyInvocation.MyCommand.Path
$script:InstallPath = Join-Path -Path $InstallDir -ChildPath "claude.exe"

# 配置常量
$script:CONSTANTS = @{
    REPO_URL = "https://storage.googleapis.com/claude-code-dist-86c565f3-f756-42ad-8dfa-d59b1c096819/claude-code-releases"
    TEMP_DIR = $env:TEMP
    DEFAULT_PLATFORM = "win32-x64"
    MAX_RETRY_COUNT = 3
    RETRY_DELAY_MS = 1000
    DEFAULT_CONNECT_TIMEOUT = 30
    DEFAULT_DOWNLOAD_TIMEOUT = 600
    LOG_LEVEL = @{
        SUCCESS = "SUCCESS"
        INFO = "INFO"
        WARN = "WARN"
        ERROR = "ERROR"
    }
}

# 验证32位系统
function Validate-SystemArchitecture {
    if (-not [Environment]::Is64BitProcess) {
        Write-Log "Claude Code 不支持 32 位 Windows，请使用 64 位版本" $script:CONSTANTS.LOG_LEVEL.ERROR
        exit 1
    }
}

# 主函数
function Show-Help {
    Write-Host @"
Windows - Claude Code 安装及更新脚本 © SmallBaby

用法:
    update-cc.ps1 [选项] [版本]

参数:
    目标版本 (可选):
        stable          安装稳定版本
        latest          安装最新版本 (默认)
        2.0.70          安装指定的版本号

    选项:
        -f,-Force       强制更新，即使当前版本已是最新
        -h,-Help        显示此帮助信息并退出
        -i,-InstallDir  指定 Claude Code 的安装目录
                        默认: C:\Software\ClaudeCode
                        示例: -i "C:\Tools"

示例:
    update-cc.ps1
        检查更新并提示安装最新版本

    update-cc.ps1 stable
        安装稳定版本

    update-cc.ps1 2.0.70
        安装指定的 2.0.70 版本

    update-cc.ps1 -Force
        强制重新安装最新版本，不提示确认

    update-cc.ps1 -InstallDir "C:\Tools"
        安装到指定目录 C:\Tools
"@ -ForegroundColor White
}

function Write-Log {
    param(
        [string]$Message,
        [string]$Level = "INFO"
    )

    $timestamp = Get-Date -Format "yyyy-MM-dd HH:mm:ss"
    $color = if ($Level -eq "ERROR") { "Red" }
             elseif ($Level -eq "WARN") { "Yellow" }
             elseif ($Level -eq "SUCCESS") { "Green" }
             else { "White" }

    Write-Host "[$timestamp] [$Level] $Message" -ForegroundColor $color
}

# 下载函数
function Download-Claude {
    param(
        [string]$Version,
        [string]$Platform = $script:CONSTANTS.DEFAULT_PLATFORM,
        [int]$RetryCount = 0
    )

    try {
        $downloadUrl = "$($script:CONSTANTS.REPO_URL)/$Version/$Platform/claude.exe"
        $tempPath = Join-Path $script:CONSTANTS.TEMP_DIR "claude-${Version}-${Platform}.exe"

        Write-Log "正在下载 Claude Code $Version..."
        Write-Log "下载地址: $downloadUrl"

        $response = Invoke-RestMethod -Uri $downloadUrl -Method Get -UseBasicParsing -TimeoutSec $script:CONSTANTS.DEFAULT_DOWNLOAD_TIMEOUT
        Write-Log "使用 Invoke-RestMethod 下载..." "INFO"
        Invoke-WebRequest -Uri $downloadUrl -OutFile $tempPath -TimeoutSec $script:CONSTANTS.DEFAULT_DOWNLOAD_TIMEOUT -UseBasicParsing

        if (Test-Path $tempPath) {
            $fileSize = (Get-Item $tempPath).Length / 1MB
            Write-Log "下载完成，文件大小: $([math]::Round($fileSize, 2)) MB" "SUCCESS"

            # 校验文件完整性
            Write-Log "正在校验文件完整性..."
            $expectedChecksum = Get-Checksum -Version $Version -Platform $Platform
            if (-not $expectedChecksum) { throw "无法获取校验和" }
            
            $actualChecksum = (Get-FileHash -Path $tempPath -Algorithm SHA256).Hash.ToLower()

            if ($actualChecksum -ne $expectedChecksum) {
                Remove-Item -Path $tempPath -Force -ErrorAction SilentlyContinue
                throw "校验和不匹配，文件可能已损坏"
            }

            Write-Log "文件校验通过" "SUCCESS"
            return $tempPath
        } else {
            throw "下载失败，文件未找到"
        }
    }
    catch {
        if ($RetryCount -lt $script:CONSTANTS.MAX_RETRY_COUNT) {
            Write-Log "下载失败 (第$($RetryCount + 1)次), 重试中...: $($_.Exception.Message)" "WARN"
            Start-Sleep -Milliseconds $script:CONSTANTS.RETRY_DELAY_MS
            return Download-Claude -Version $Version -Platform $Platform -RetryCount ($RetryCount + 1)
        } else {
            Write-Log "下载失败 (所有重试均失败): $($_.Exception.Message)" "ERROR"
            throw
        }
    }
}

# 版本信息获取函数
function Get-VersionInfo {
    [CmdletBinding()]
    param(
        [string]$Target,
        [int]$RetryCount = 0
    )

    try {
        Write-Log "正在获取版本信息... (目标: $Target)"

        if ($Target -match '^\d+\.\d+\.\d+') {
            Write-Log "使用指定版本: $Target"
            return $Target
        }

        $versionUrl = "$($script:CONSTANTS.REPO_URL)/$Target"
        $version = Invoke-RestMethod -Uri $versionUrl -TimeoutSec $script:CONSTANTS.DEFAULT_CONNECT_TIMEOUT -ErrorAction Stop
        $version = $version.Trim()

        Write-Log "获取到 $Target 版本: $version"
        return $version
    }
    catch {
        if ($RetryCount -lt $script:CONSTANTS.MAX_RETRY_COUNT) {
            Write-Log "获取版本信息失败 (第$($RetryCount + 1)次), 重试中...: $($_.Exception.Message)" "WARN"
            Start-Sleep -Milliseconds $script:CONSTANTS.RETRY_DELAY_MS
            return Get-VersionInfo -Target $Target -RetryCount ($RetryCount + 1)
        } else {
            Write-Log "获取版本信息失败 (所有重试均失败): $($_.Exception.Message)" "ERROR"
            throw
        }
    }
}

# 当前版本获取函数
function Get-CurrentVersion {
    try {
        Write-Log "正在检查当前版本..."

        # 检查已安装路径
        if (Test-Path $script:InstallPath) {
            try {
                $versionOutput = &amp; $script:InstallPath -v 2&gt;&amp;1
                if ($versionOutput -match '(\d+\.\d+\.\d+)') {
                    $currentVersion = $matches[1]
                    Write-Log "当前版本 (路径): $currentVersion"
                    return $currentVersion
                }
            }
            catch {
                Write-Log "无法从 $script:InstallPath 获取版本: $($_.Exception.Message)" "WARN"
            }
        }

        # 检查PATH中的claude
        try {
            $claudeVersion = &amp; claude -v 2&gt;&amp;1
            if ($claudeVersion -match '(\d+\.\d+\.\d+)') {
                $currentVersion = $matches[1]
                Write-Log "当前版本 (PATH): $currentVersion"
                return $currentVersion
            }
        }
        catch {
            Write-Log "claude command not found in PATH" "WARN"
        }

        Write-Log "未找到已安装的 Claude Code" "WARN"
        return $null
    }
    catch {
        Write-Log "获取当前版本失败: $($_.Exception.Message)" "ERROR"
        return $null
    }
}

# 更新尝试函数
function Try-ClaudeUpdate {
    param(
        [string]$Target
    )

    try {
        Write-Log "尝试使用 claude update 命令更新..." "INFO"

        $claudeCmd = Get-Command claude -ErrorAction SilentlyContinue
        if (-not $claudeCmd) {
            Write-Log "未找到 claude 命令，跳过内置更新" "WARN"
            return $false
        }

        $updateArgs = @("update")
        if ($Target -ne "latest") {
            $updateArgs += $Target
        }

        Write-Log "执行: claude $ $($updateArgs -join ' ')"
        
        # 执行更新并捕获退出代码
        $processInfo = New-Object System.Diagnostics.ProcessStartInfo
        $processInfo.FileName = $claudeCmd.Source
        $processInfo.Arguments = ($updateArgs -join ' ')
        $processInfo.UseShellExecute = $false
        
        $process = [System.Diagnostics.Process]::Start($processInfo)
        $process.WaitForExit()

        Write-Log "claude update 退出代码: $($process.ExitCode)" "INFO"

        if ($process.ExitCode -eq 0) {
            $newVersion = Get-CurrentVersion
            $targetVersion = Get-VersionInfo -Target $Target

            if ($newVersion -eq $targetVersion) {
                Write-Log "使用 claude update 成功更新到版本: $newVersion" "SUCCESS"
                return $true
            } else {
                Write-Log "claude update 未更新到目标版本，将使用下载方式" "INFO"
                return $false
            }
        } else {
            Write-Log "claude update 失败，退出代码: $($process.ExitCode)" "WARN"
            return $false
        }
    }
    catch {
        Write-Log "claude update 失败: $($_.Exception.Message)" "WARN"
        return $false
    }
}

# 版本比较函数
function Compare-Version {
    param(
        [string]$Version1,
        [string]$Version2
    )

    try {
        # 使用[version]对象进行比较
        $v1 = [System.Version]$Version1
        $v2 = [System.Version]$Version2

        if ($v1 -gt $v2) { return 1 }
        elseif ($v1 -lt $v2) { return -1 }
        else { return 0 }
    }
    catch {
        Write-Log "版本比较失败: $($_.Exception.Message)" "ERROR"
        Write-Log "尝试字符串比较..." "WARN"
        
        # 如果版本对象比较失败，使用字符串比较
        $v1Components = $Version1.Split('.')
        $v2Components = $Version2.Split('.')
        
        $maxLen = [Math]::Max($v1Components.Count, $v2Components.Count)
        for ($i = 0; $i -lt $maxLen; $i++) {
            $c1 = [int]($v1Components[$i] ?? 0)
            $c2 = [int]($v2Components[$i] ?? 0)
            
            if ($c1 -gt $c2) { return 1 }
            elseif ($c1 -lt $c2) { return -1 }
        }
        return 0
    }
}

# 校验和获取函数
function Get-Checksum {
    [CmdletBinding()]
    param(
        [string]$Version,
        [string]$Platform = $script:CONSTANTS.DEFAULT_PLATFORM,
        [int]$RetryCount = 0
    )

    try {
        $manifestUrl = "$($script:CONSTANTS.REPO_URL)/$Version/manifest.json"
        Write-Log "获取清单: $manifestUrl"
        
        $manifest = Invoke-RestMethod -Uri $manifestUrl -TimeoutSec $script:CONSTANTS.DEFAULT_CONNECT_TIMEOUT -ErrorAction Stop
        $checksum = $manifest.platforms.$Platform.checksum

        if (-not $checksum) {
            throw "清单中未找到平台 $Platform"
        }

        Write-Log "获取到校验和: $($checksum.Substring(0, 16))..."
        return $checksum.ToLower()
    }
    catch {
        if ($RetryCount -lt $script:CONSTANTS.MAX_RETRY_COUNT) {
            Write-Log "获取校验和失败 (第$($RetryCount + 1)次), 重试中...: $($_.Exception.Message)" "WARN"
            Start-Sleep -Milliseconds $script:CONSTANTS.RETRY_DELAY_MS
            return Get-Checksum -Version $Version -Platform $Platform -RetryCount ($RetryCount + 1)
        } else {
            Write-Log "获取校验和失败 (所有重试均失败): $($_.Exception.Message)" "ERROR"
            throw
        }
    }
}

# 备份函数
function Backup-CurrentClaude {
    param(
        [string]$CurrentVersion
    )

    try {
        if (Test-Path $script:InstallPath) {
            $directory = Split-Path -Path $script:InstallPath -Parent

            # 清理旧备份
            $backupPattern = "claude.exe.*.bak"
            $backupFiles = Get-ChildItem -Path $directory -Name $backupPattern -ErrorAction SilentlyContinue
            if ($backupFiles.Count -gt 0) {
                Write-Log "正在清理旧备份文件..."
                foreach ($backupFile in $backupFiles) {
                    $backupPath = Join-Path -Path $directory -ChildPath $backupFile
                    Remove-Item -Path $backupPath -Force -ErrorAction SilentlyContinue
                    Write-Log "已删除旧备份: $backupFile"
                }
            }

            $timestamp = Get-Date -Format "yyyyMMdd-HHmmss"
            $backupPath = Join-Path -Path $directory -ChildPath "claude.exe.$CurrentVersion.$timestamp.bak"
            Write-Log "正在备份当前文件到: $backupPath"
            Copy-Item -Path $script:InstallPath -Destination $backupPath -Force -ErrorAction Stop
            Write-Log "备份创建成功" "SUCCESS"
            return $backupPath
        }
        return $null
    }
    catch {
        Write-Log "备份失败: $($_.Exception.Message)" "WARN"
        return $null
    }
}

# 环境变量函数
function Add-To-Path {
    param(
        [string]$PathToAdd
    )

    try {
        $directory = Split-Path -Path $PathToAdd -Parent
        $userPath = [Environment]::GetEnvironmentVariable("PATH", "User") -split ';' | Where-Object { $_ -ne $null -and $_ -ne '' }

        if ($userPath -notcontains $directory) {
            Write-Log "正在添加环境变量: $directory"
            $newPath = $userPath + $directory | Where-Object { $_ -ne $null -and $_ -ne '' } 
            [Environment]::SetEnvironmentVariable("PATH", ($newPath -join ';'), "User")
            Write-Log "环境变量已添加，请重启终端或重新登录以使更改生效" "SUCCESS"
        } else {
            Write-Log "环境变量已存在，跳过添加" "INFO"
        }
    }
    catch {
        Write-Log "添加环境变量失败: $($_.Exception.Message)" "WARN"
    }
}

# 链接创建函数
function Create-Links {
    param(
        [string]$Version
    )

    try {
        Write-Log "正在创建链接..." "INFO"

        $installDirectory = Split-Path -Path $script:InstallPath -Parent
        $userProfile = $env:USERPROFILE

        # 创建用户目录下的 .claude 软链接
        $claudeUserDir = Join-Path $userProfile ".claude"
        if (Test-Path $claudeUserDir) {
            Remove-Item -Path $claudeUserDir -Force -Recurse -ErrorAction SilentlyContinue
            Write-Log "已删除现有链接: $claudeUserDir"
        }

        New-Item -ItemType SymbolicLink -Path $claudeUserDir -Value $installDirectory -Force -ErrorAction Stop | Out-Null
        Write-Log "已创建软链接: $claudeUserDir -&gt; $installDirectory" "SUCCESS"

        # 创建各种配置文件的软链接
        $configFiles = @('.claude.json', '.claude.json.backup')
        foreach ($configFile in $configFiles) {
            $sourcePath = Join-Path $installDirectory $configFile
            $targetPath = Join-Path $userProfile $configFile

            if (Test-Path $sourcePath) {
                if (Test-Path $targetPath) {
                    Remove-Item -Path $targetPath -Force -ErrorAction SilentlyContinue
                    Write-Log "已删除现有链接: $targetPath"
                }
                try {
                    New-Item -ItemType SymbolicLink -Path $targetPath -Value $sourcePath -Force -ErrorAction Stop | Out-Null
                    Write-Log "已创建软链接: $targetPath -&gt; $sourcePath" "SUCCESS"
                }
                catch {
                    Write-Log "创建软链接失败 (不影响主功能): $($_.Exception.Message)" "WARN"
                }
            }
        }

        # 创建 .local 目录结构
        $binDir = Join-Path $userProfile ".local\bin"
        $versionsDir = Join-Path $userProfile ".local\share\claude\versions"

        foreach ($dir in @($binDir, $versionsDir)) {
            if (-not (Test-Path $dir)) {
                New-Item -ItemType Directory -Path $dir -Force -ErrorAction Stop | Out-Null
                Write-Log "已创建目录: $dir"
            }
        }

        # 创建到 .local/bin 的软链接
        $binLinkPath = Join-Path $binDir "claude.exe"
        if (Test-Path $binLinkPath) {
            Remove-Item -Path $binLinkPath -Force -ErrorAction SilentlyContinue
            Write-Log "已删除现有链接: $binLinkPath"
        }

        try {
            New-Item -ItemType SymbolicLink -Path $binLinkPath -Value $script:InstallPath -Force -ErrorAction Stop | Out-Null
            Write-Log "已创建软链接: $binLinkPath -&gt; $script:InstallPath" "SUCCESS"
        }
        catch {
            Write-Log "创建软链接失败 (不影响主功能): $($_.Exception.Message)" "WARN"
        }

        Write-Log "链接创建完成" "SUCCESS"
    }
    catch {
        Write-Log "创建链接失败: $($_.Exception.Message)" "WARN"
        Write-Log "此错误通常不影响核心功能" "INFO"
    }
}

# 清理临时文件
function Cleanup-TempFiles {
    param(
        [string]$TempFile = $null,
        [string]$LogFile = $null
    )

    try {
        if ($TempFile -and (Test-Path $TempFile)) {
            Remove-Item -Path $TempFile -Force -ErrorAction SilentlyContinue
            Write-Log "已清理临时文件" "INFO"
        }
        if ($LogFile -and (Test-Path $LogFile)) {
            Remove-Item -Path $LogFile -Force -ErrorAction SilentlyContinue
        }
    }
    catch {
        Write-Log "清理临时文件时出错: $($_.Exception.Message)" "WARN"
    }
}

# 进程检查
function Check-And-KillClaudeProcess {
    Write-Log "检查 Claude Code 运行进程..." "INFO"
    
    # 获取并终止相关进程
    $processes = Get-Process -Name "claude", "Claude*" -ErrorAction SilentlyContinue
    
    if ($processes) {
        foreach ($proc in $processes) {
            # 检查进程是否使用了目标路径中的文件
            if ($proc.Path -and $proc.Path -like "*claude.exe*") {
                Write-Log "发现运行中的 claude 进程 PID: $($proc.Id), 已启动: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss'), 运行时间: $((Get-Date) - $proc.StartTime)" "WARN"
                
                try {
                    Stop-Process -Id $proc.Id -Force -ErrorAction Stop
                    Write-Log "已终止进程 PID: $($proc.Id)" "INFO"
                    Start-Sleep -Seconds 2
                }
                catch {
                    Write-Log "终止进程失败: $($_.Exception.Message)" "WARN"
                }
            }
        }
    }
    
    # 多次检查进程是否完全终止
    for ($i = 1; $i -le 3; $i++) {
        $remaining = Get-Process -Name "claude" -ErrorAction SilentlyContinue
        if ($remaining.Count -eq 0) {
            Write-Log "claude 进程已全部终止" "INFO"
            break
        } else {
            Write-Log "仍有 $([array]$remaining.Count) 个 claude 进程存在，等待 $($i*2) 秒后重试..." "INFO"
            Start-Sleep -Seconds ($i * 2)
        }
    }
    
    # 检查目标文件是否仍然被锁定
    $targetExists = Test-Path $script:InstallPath
    if ($targetExists) {
        try {
            # 尝试访问文件以确认是否被锁定
            $fileInfo = Get-Item $script:InstallPath
            Write-Log "目标文件存在，最后一次写入: $($fileInfo.LastWriteTime)" "INFO"
        }
        catch {
            Write-Log "目标文件被锁定: $($_.Exception.Message)" "WARN"
        }
    }
    
    # 给系统一些时间来清理文件锁
    Start-Sleep -Seconds 2
}

# 主执行逻辑
function Main {
    if ($Help) {
        Show-Help
        return
    }

    try {
        Write-Log "=== Claude Code 自动更新脚本启动 ===" "SUCCESS"
        Write-Log "目标安装路径: $script:InstallPath"
        Write-Log "目标版本: $Target"
        Write-Log "平台架构: $Platform"
        Write-Log "安装目录: $(Split-Path -Path $script:InstallPath -Parent)"

        # 验证系统架构
        Validate-SystemArchitecture

        $targetVersion = Get-VersionInfo -Target $Target
        $backupPath = $null
        $tempFile = $null

        # 如果用户指定了特定版本号，直接走下载流程
        if ($Target -match '^\d+\.\d+\.\d+') {
            Write-Log "检测到指定版本，跳过版本比较，直接下载" "INFO"
        } else {
            # 非指定版本，执行原有检查逻辑
            $currentVersion = Get-CurrentVersion
            
            if ($currentVersion) {
                $comparison = Compare-Version -Version1 $targetVersion -Version2 $currentVersion

                if ($comparison -eq 0) {
                    Write-Log "版本 $currentVersion 已是最新版本" "SUCCESS"
                    if (-not $Force) {
                        Write-Log "如需强制更新，请使用 -Force 参数"
                        return
                    } else {
                        Write-Log "强制模式下，继续更新" "INFO"
                    }
                }
                elseif ($comparison -eq 1) {
                    Write-Log "发现新版本: $currentVersion -&gt; $targetVersion" "INFO"
                }
                else {
                    Write-Log "当前版本 $currentVersion 比目标版本 $targetVersion 更新" "WARN"
                    if (-not $Force) {
                        Write-Log "如需强制更新，请使用 -Force 参数"
                        return
                    }
                }

                # 尝试使用内建更新功能
                if (-not $Force -and $Target -ne "latest" -and $Target -ne "stable") {
                    Write-Log "尝试使用 claude update 功能..." "INFO"
                    $updateSuccess = Try-ClaudeUpdate -Target $Target
                    if ($updateSuccess) {
                        Create-Links -Version (Get-CurrentVersion)
                        Write-Log "=== Claude Code 更新完成 (使用内建更新) ===" "SUCCESS"
                        return
                    }
                }
            } else {
                Write-Log "未找到已安装版本，执行全新安装" "INFO"
            }
        }

        # 用户确认（仅对非指定版本）
        if (-not $Force -and -not ($Target -match '^\d+\.\d+\.\d+')) {
            $choice = Read-Host "是否继续下载并安装 Claude Code $targetVersion ? (y/N)"
            if ($choice -notmatch '^[Yy]$') {
                Write-Log "用户取消更新"
                return
            }
        }

        # 创建安装目录
        $installDirectory = Split-Path -Path $script:InstallPath -Parent
        if (-not (Test-Path $installDirectory)) {
            New-Item -ItemType Directory -Path $installDirectory -Force -ErrorAction Stop | Out-Null
            Write-Log "已创建安装目录: $installDirectory"
        }

        # 对于非指定版本的场景才备份
        if ($Target -notmatch '^\d+\.\d+\.\d+') {
            $currentVersion = Get-CurrentVersion
            if ($currentVersion) {
                $backupPath = Backup-CurrentClaude -CurrentVersion $currentVersion
            }
        }

        # 直接下载新版本
        Write-Log "开始下载文件..." "INFO"
        $tempFile = Download-Claude -Version $targetVersion -Platform $Platform

        try {
            Write-Log "正在安装到: $script:InstallPath"
            Check-And-KillClaudeProcess
            Start-Sleep -Seconds 2
            Copy-Item -Path $tempFile -Destination $script:InstallPath -Force -ErrorAction Stop

            if (Test-Path $script:InstallPath) {
                # 等待文件操作完成
                Start-Sleep -Seconds 2
                
                # 验证安装
                $newVersion = Get-CurrentVersion
                if ($newVersion -eq $targetVersion) {
                    Write-Log "Claude Code 更新安装成功！版本: $targetVersion" "SUCCESS"
                    
                    if ($backupPath) {
                        Write-Log "备份文件保存在: $backupPath" "INFO"
                    }

                    # 创建符号链接和环境变量
                    Create-Links -Version $targetVersion
                    Add-To-Path -PathToAdd $script:InstallPath
                } else {
                    throw "安装验证失败: 期望版本 $targetVersion, 实际版本 $newVersion"
                }
            } else {
                throw "文件复制失败"
            }
        }
        catch {
            Write-Log "安装失败: $($_.Exception.Message)" "ERROR"

            # 恢复备份
            if ($backupPath -and (Test-Path $backupPath)) {
                Write-Log "正在恢复备份..."
                Check-And-KillClaudeProcess
                Start-Sleep -Seconds 2
                Copy-Item -Path $backupPath -Destination $script:InstallPath -Force -ErrorAction SilentlyContinue
                Write-Log "已恢复到之前的版本" "WARN"
            }

            throw
        }
        finally {
            Cleanup-TempFiles -TempFile $tempFile
        }

        Write-Log "=== Claude Code 更新完成 ===" "SUCCESS"
        Write-Log "新版本: $targetVersion" "SUCCESS"
        Write-Log "请重新打开终端以使用新版本" "INFO"
    }
    catch {
        Write-Log "脚本执行失败: $($_.Exception.Message)" "ERROR"
        exit 1
    }
}


# 执行主函数
Main
</code></pre>
<h4 data-id="heading-4">引用</h4>
<ul>
<li>Github地址: <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FShadowSmallBaby%2FOneToolkit.git" target="_blank" title="https://github.com/ShadowSmallBaby/OneToolkit.git" ref="nofollow noopener noreferrer">OneToolkit</a></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[[git版本控制]git branch(详解)]]></title>    <link>https://juejin.cn/post/7600260767688376346</link>    <guid>https://juejin.cn/post/7600260767688376346</guid>    <pubDate>2026-01-29T05:18:59.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600260767688376346" data-draft-id="7600260767688294426" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="[git版本控制]git branch(详解)"/> <meta itemprop="keywords" content="Git"/> <meta itemprop="datePublished" content="2026-01-29T05:18:59.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="import_random"/> <meta itemprop="url" content="https://juejin.cn/user/2013961033882312"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            [git版本控制]git branch(详解)
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2013961033882312/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    import_random
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-29T05:18:59.000Z" title="Thu Jan 29 2026 05:18:59 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>我来为您详细介绍一下 <code>git branch</code> 命令。它是 Git 版本控制中最核心、最常用的命令之一，用于<strong>管理分支</strong>。</p>
<h2 data-id="heading-0">核心概念：什么是分支？</h2>
<p>在深入命令之前，理解“分支”的概念至关重要。</p>
<ul>
<li>分支就像一条独立的<strong>时间线</strong>或<strong>工作线</strong>。</li>
<li>默认情况下，每个 Git 仓库都有一个主时间线，叫做 <code>master</code> 或 <code>main</code> 分支。</li>
<li>你可以从任意时间点创建新的分支，在新分支上进行开发、实验或修复Bug，而不会影响到主分支。</li>
<li>分支之间可以自由切换、合并，这使得并行开发和版本管理变得非常灵活。</li>
</ul>
<p><code>git branch</code> 命令就是用来<strong>创建、列出、重命名和删除</strong>这些分支的工具。</p>
<hr/>
<h2 data-id="heading-1">命令详解及常用选项</h2>
<h5 data-id="heading-2">1. <strong>列出分支</strong></h5>
<p>这是最常用的功能，用于查看当前仓库的所有分支(只显示本地分支)。</p>
<pre><code class="hljs language-bash" lang="bash">git branch
</code></pre>
<ul>
<li>输出列表中，当前所在的分支前会有一个星号 <code>*</code>。</li>
<li>只显示本地分支。</li>
</ul>
<p><strong>查看更多信息</strong>：</p>
<pre><code class="hljs language-bash" lang="bash">git branch -v
<span class="hljs-comment"># 或</span>
git branch --verbose
</code></pre>
<ul>
<li>显示每个分支最后一次提交的提交哈希和提交信息。</li>
</ul>
<p><strong>查看所有分支（包括远程跟踪分支）</strong>：</p>
<pre><code class="hljs language-bash" lang="bash">git branch -a
<span class="hljs-comment"># 或</span>
git branch --all
</code></pre>
<ul>
<li>本地分支会正常显示。</li>
<li>远程跟踪分支（如 <code>origin/main</code>）会以红色或特定颜色显示，通常前缀为 <code>remotes/</code>。</li>
</ul>
<p><strong>查看已合并/未合并到当前分支的分支</strong>：</p>
<pre><code class="hljs language-bash" lang="bash">git branch --merged    <span class="hljs-comment"># 查看已合并到当前分支的分支</span>
git branch --no-merged <span class="hljs-comment"># 查看未合并到当前分支的分支</span>
</code></pre>
<ul>
<li>这对于清理已完成功能的分支非常有用。</li>
</ul>
<h5 data-id="heading-3">2. <strong>创建分支</strong></h5>
<p>创建一个新的分支，但<strong>不会自动切换</strong>到该分支。</p>
<pre><code class="hljs language-bash" lang="bash">git branch &lt;branch-name&gt;
</code></pre>
<ul>
<li><strong>示例</strong>：<code>git branch feature-login</code></li>
<li>新分支会从你<strong>当前所在分支的最新提交（HEAD）</strong> 创建出来。</li>
<li>创建后，你仍然在当前分支, 并不会切换到新的分支"feature-login"</li>
</ul>
<p><strong>从特定提交创建分支</strong>：</p>
<pre><code class="hljs language-bash" lang="bash">git branch &lt;branch-name&gt; &lt;commit-hash&gt;
</code></pre>
<ul>
<li><strong>示例</strong>：<code>git branch hotfix abc1234</code></li>
<li>这在需要基于某个历史版本进行修复时非常有用。</li>
</ul>
<h5 data-id="heading-4">3. <strong>删除分支</strong></h5>
<p>当一个分支的工作已经完成并合并后，通常可以删除它。</p>
<p><strong>安全删除（如果分支已合并）</strong>：</p>
<pre><code class="hljs language-bash" lang="bash">git branch -d &lt;branch-name&gt;
<span class="hljs-comment"># 或</span>
git branch --delete &lt;branch-name&gt;
</code></pre>
<ul>
<li>如果该分支的改动已经合并到其他分支，Git 会允许删除。</li>
<li>如果分支未合并，Git 会阻止删除，以防止数据丢失。</li>
</ul>
<p><strong>强制删除（无论是否合并）</strong>：</p>
<pre><code class="hljs language-bash" lang="bash">git branch -D &lt;branch-name&gt;
</code></pre>
<ul>
<li><strong>谨慎使用！</strong> 这会直接删除分支及其所有未合并的提交。</li>
</ul>
<p><strong>删除远程跟踪分支（在本地清理）</strong>：</p>
<pre><code class="hljs language-bash" lang="bash">git branch -d -r origin/&lt;branch-name&gt; <span class="hljs-comment"># 删除本地的远程跟踪引用</span>
</code></pre>
<ul>
<li>这并不会真正删除远程仓库的分支。要删除远程分支，需要使用：
<pre><code class="hljs language-bash" lang="bash">git push origin --delete &lt;branch-name&gt;
</code></pre>
</li>
</ul>
<h5 data-id="heading-5">4. <strong>重命名分支</strong></h5>
<pre><code class="hljs language-bash" lang="bash">git branch -m &lt;old-name&gt; &lt;new-name&gt; <span class="hljs-comment"># 重命名指定分支</span>
git branch -m &lt;new-name&gt;            <span class="hljs-comment"># 重命名当前分支</span>
</code></pre>
<ul>
<li><strong>示例</strong>：<code>git branch -m fix-typo feature-awesome</code></li>
</ul>
<h5 data-id="heading-6">5. <strong>设置跟踪关系</strong></h5>
<p>这是高级但重要的功能，将本地分支与远程分支关联起来。</p>
<pre><code class="hljs language-bash" lang="bash">git branch -u origin/&lt;remote-branch-name&gt;
<span class="hljs-comment"># 或</span>
git branch --set-upstream-to=origin/&lt;remote-branch-name&gt;
</code></pre>
<ul>
<li>设置后，在该分支上使用 <code>git push</code> 或 <code>git pull</code> 时，如果不指定参数，Git 就知道该推送到或从哪里拉取代码。</li>
<li>通常，在创建分支时使用 <code>git checkout -b &lt;branch&gt; origin/&lt;branch&gt;</code> 或 <code>git switch -c &lt;branch&gt; origin/&lt;branch&gt;</code> 会更方便地建立跟踪。</li>
</ul>
<hr/>
<h2 data-id="heading-7">与其他关键命令的协作</h2>
<p><code>git branch</code> 通常不单独使用，而是与以下命令紧密配合：</p>
<ol>
<li>
<p><strong><code>git checkout &lt;branch-name&gt;</code></strong> 或 <strong><code>git switch &lt;branch-name&gt;</code></strong>：</p>
<ul>
<li><code>git branch</code> 创建分支，<code>git checkout/switch</code> 切换分支。</li>
<li><strong>组合技（创建并切换）</strong>：
<pre><code class="hljs language-bash" lang="bash">git checkout -b &lt;new-branch-name&gt;
<span class="hljs-comment"># 或（更语义化）</span>
git switch -c &lt;new-branch-name&gt;
</code></pre>
</li>
</ul>
</li>
<li>
<p><strong><code>git merge &lt;branch-name&gt;</code></strong>：</p>
<ul>
<li>将指定分支的修改合并到<strong>当前分支</strong>。</li>
<li>完成功能开发后，你会切回 <code>main</code> 分支，然后执行 <code>git merge feature-xxx</code>。</li>
</ul>
</li>
<li>
<p><strong><code>git push</code></strong>：</p>
<ul>
<li>将本地分支推送到远程仓库，与团队共享。</li>
<li><strong>首次推送新分支</strong>：<code>git push -u origin &lt;branch-name&gt;</code> （<code>-u</code> 参数会同时设置跟踪关系）。</li>
</ul>
</li>
</ol>
<hr/>
<h2 data-id="heading-8">典型工作流示例</h2>
<p>假设你要开发一个新功能：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 1. 确保在主分支，并获取最新代码</span>
git checkout main       <span class="hljs-comment"># 在本地切换到主分支main</span>
git pull origin main    <span class="hljs-comment"># 获取最新的代码</span>

<span class="hljs-comment"># 2. 创建并切换到功能分支</span>
git checkout -b feature-user-profile  <span class="hljs-comment"># 创建一个新分支, 用于本次的修改和迭代</span>

<span class="hljs-comment"># 3. 进行开发，多次提交...</span>
git add .
git commit -m <span class="hljs-string">"完成用户头像上传功能"</span>

<span class="hljs-comment"># 4. 将分支推送到远程（首次）-u的作用是建立上游关系, upstream</span>
git push -u origin feature-user-profile

<span class="hljs-comment"># 5. 功能完成后，在主分支上进行合并</span>
git checkout main
git pull origin main <span class="hljs-comment"># 再次确保最新的代码</span>
git merge feature-user-profile  <span class="hljs-comment">#  把新分支的开发, 合并到main分支上来.</span>
git push origin main     <span class="hljs-comment"># 推到远程的仓库</span>

<span class="hljs-comment"># 6. （可选）删除本地和远程的功能分支</span>
git branch -d feature-user-profile
git push origin --delete feature-user-profile
</code></pre>
<h2 data-id="heading-9">总结：<code>git branch</code> 常用命令速查表</h2>













































<table><thead><tr><th align="left">命令</th><th align="left">作用</th></tr></thead><tbody><tr><td align="left"><code>git branch</code></td><td align="left">列出本地分支</td></tr><tr><td align="left"><code>git branch -a</code></td><td align="left">列出所有分支（本地+远程）</td></tr><tr><td align="left"><code>git branch &lt;name&gt;</code></td><td align="left">创建新分支（不切换）</td></tr><tr><td align="left"><code>git branch -d &lt;name&gt;</code></td><td align="left">安全删除分支（已合并）</td></tr><tr><td align="left"><code>git branch -D &lt;name&gt;</code></td><td align="left">强制删除分支（未合并）</td></tr><tr><td align="left"><code>git branch -m &lt;new-name&gt;</code></td><td align="left">重命名<code>当前分支</code></td></tr><tr><td align="left"><code>git branch --merged</code></td><td align="left">查看已合并分支</td></tr><tr><td align="left"><code>git checkout -b &lt;name&gt;</code></td><td align="left"><strong>创建并切换</strong>到新分支（经典）</td></tr><tr><td align="left"><code>git switch -c &lt;name&gt;</code></td><td align="left"><strong>创建并切换</strong>到新分支（推荐）</td></tr></tbody></table>
<p>理解并熟练使用 <code>git branch</code> 是掌握 Git 工作流的基础，它让你能安全、高效地在不同任务间并行工作。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[go公链实战0x05交易（1）]]></title>    <link>https://juejin.cn/post/7600489282822881330</link>    <guid>https://juejin.cn/post/7600489282822881330</guid>    <pubDate>2026-01-29T05:22:38.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600489282822881330" data-draft-id="6845075572612136968" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="go公链实战0x05交易（1）"/> <meta itemprop="keywords" content="后端,Go,区块链"/> <meta itemprop="datePublished" content="2026-01-29T05:22:38.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="chaors"/> <meta itemprop="url" content="https://juejin.cn/user/272334613646695"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            go公链实战0x05交易（1）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/272334613646695/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    chaors
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-29T05:22:38.000Z" title="Thu Jan 29 2026 05:22:38 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>区块链区块的作用是打包链上产生的交易,可以说交易是区块链至关重要的一个组成部分.在区块链中,交易一旦被创建，就没有任何人能够再去修改或是删除它.</p>
<p>关于交易的结构,可以参照以前的这篇:<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.jianshu.com%2Fp%2F3447aab7e864" target="_blank" title="https://www.jianshu.com/p/3447aab7e864" ref="nofollow noopener noreferrer">比特币源码研读(3)数据结构-交易Transaction</a></p>
<p>我们之前定义的区块结构简单地用一个字符串描述交易内容,今后将正式用新的结构来表示交易:</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-keyword">type</span> Block <span class="hljs-keyword">struct</span> {
	<span class="hljs-comment">//1.区块高度</span>
	Height <span class="hljs-type">int64</span>
	<span class="hljs-comment">//2.上一个区块HAsh</span>
	PrevBlockHash []<span class="hljs-type">byte</span>
	<span class="hljs-comment">//3.交易数据</span>
	<span class="hljs-comment">//Data []byte    //只前简单地对交易的描述</span>
        Txs [] *Transaction   <span class="hljs-comment">//Transaction结构数组表示交易</span>
	<span class="hljs-comment">//4.时间戳</span>
	Timestamp <span class="hljs-type">int64</span>
	<span class="hljs-comment">//5.Hash</span>
	Hash []<span class="hljs-type">byte</span>
	<span class="hljs-comment">//6.Nonce  符合工作量证明的随机数</span>
	Nonce <span class="hljs-type">int64</span>
}
</code></pre>
<h3 data-id="heading-0">Transaction结构</h3>
<pre><code class="hljs language-go" lang="go"><span class="hljs-keyword">type</span> Transaction <span class="hljs-keyword">struct</span> {
	<span class="hljs-comment">//1.交易哈希值</span>
	TxHAsh []<span class="hljs-type">byte</span>
	<span class="hljs-comment">//2.交易输入</span>
	Vins []*TXInput
	<span class="hljs-comment">//3.交易输出</span>
	Vouts []*TXOutput
}
</code></pre>
<h3 data-id="heading-1">TXInput</h3>
<pre><code class="hljs language-go" lang="go"><span class="hljs-keyword">type</span> TXInput <span class="hljs-keyword">struct</span> {
	<span class="hljs-comment">//交易ID 引用上一笔交易输出作为输入</span>
	TxHash []<span class="hljs-type">byte</span>
	<span class="hljs-comment">//存储TXOutput在Vout里的索引</span>
	Vout <span class="hljs-type">int</span>
	<span class="hljs-comment">//数字签名  暂时可理解为用户名</span>
	ScriptSig <span class="hljs-type">string</span>
}
</code></pre>
<p>交易输入作为本次交易的消费源,输入来源于之前交易的输出.如上,TxHash是引用的上一笔输出所在的交易的交易哈希;Vout是该输出在相应交易中的输出索引;ScriptSig,可以暂时理解为用户名,表示哪一个用户拥有这一笔输入.ScriptSig的设定是为了保证用户只能话费自己名下的代币.</p>
<h3 data-id="heading-2">TXOutput</h3>
<pre><code class="hljs language-go" lang="go"><span class="hljs-keyword">type</span> TXOutput <span class="hljs-keyword">struct</span> {
	<span class="hljs-comment">//面值</span>
	Value <span class="hljs-type">int64</span>
	<span class="hljs-comment">//暂时理解为用户名</span>
	ScriptPubKey <span class="hljs-type">string</span>
}
</code></pre>
<p>这里的交易输出就是上面交易输入里引用的输出.Value是该输出的面值,ScriptPubKey暂时理解为用户名,表示谁将拥有这笔输出.</p>
<p>了解比特币的人都知道,交易输出是一个完整的不可分割的结构.什么意思呢?就是我们在引用TXOutput,必须全部引用,不能仅仅使用其一部分.举个简单的🌰:</p>
<p>假如你有一个25btc的TXOutput,你需要花费10btc.这个交易的过程并不是:你花费了25btc中的10btc,你的原有TXOutput依旧有15btc的余额.真正的过程是,你花费了整个原有的TXOutput,由于消费额不匹配,这里会产生一个15btc的找零.消费的结果是:你25btc的TXOutput被话费已不复存在,系统重新为你生成一个15btc面值的TXOutput.这两个TXOutput是完全不同的两个对象!!!</p>
<h3 data-id="heading-3">CoinbaseTransaction</h3>
<p>我们知道,当矿工成功挖到一个区块时会获得一笔奖励.那么这笔奖励是怎么交付到矿工账户的.这就有赖于一笔叫做创币交易的交易.</p>
<p>创币交易是区块内的第一笔交易,它负责将系统产生的奖励给挖出区块的矿工.由于它并不是普通意义上的转账,所以交易输入里并不需要引用任何一笔交易输出.</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-comment">//创建创币交易</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">NewCoinbaseTransaction</span><span class="hljs-params">(address <span class="hljs-type">string</span>)</span></span> *Transaction {

	<span class="hljs-comment">//交易输入  由于区块第一笔交易其实没有输入，所以交易哈希传空，TXOutput索引传-1，签名随你</span>
	txInput := &amp;TXInput{
		[]<span class="hljs-type">byte</span>{},
		<span class="hljs-number">-1</span>,
		<span class="hljs-string">"CoinbaseTransaction"</span>,
	}

	<span class="hljs-comment">//交易输出  产生一笔奖励给挖矿者address</span>
	txOutput := &amp;TXOutput{<span class="hljs-number">25</span>, address}
	txCoinbase := &amp;Transaction{
		[]<span class="hljs-type">byte</span>{},	<span class="hljs-comment">//暂时将交易哈希置空</span>
		[]*TXInput{txInput},
		[]*TXOutput{txOutput},
	}
		
	<span class="hljs-comment">//交易哈希的计算</span>
	txCoinbase.HashTransactions()

	<span class="hljs-keyword">return</span> txCoinbase
}
</code></pre>
<h3 data-id="heading-4">HashTransactions</h3>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">//将交易信息转换为字节数组</span>
func (tx *Transaction) <span class="hljs-built_in">HashTransactions</span>() {

	<span class="hljs-comment">//交易信息序列化</span>
	<span class="hljs-selector-tag">var</span> result bytes<span class="hljs-selector-class">.Buffer</span>
	encoder := gob.<span class="hljs-built_in">NewEncoder</span>(&amp;result)

	err := encoder.<span class="hljs-built_in">Encode</span>(tx)
	if err != nil {

		log<span class="hljs-selector-class">.Panic</span>(err)
	}

	<span class="hljs-comment">//设置hash</span>
	txHash := sha256.<span class="hljs-built_in">Sum256</span>(result.<span class="hljs-built_in">Bytes</span>())
	tx.TxHAsh = txHash[:]
}
</code></pre>
<h3 data-id="heading-5">NewBlock改动</h3>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">//1.创建新的区块</span>
func <span class="hljs-built_in">NewBlock</span>(txs []*Transaction, height int64, prevBlockHash []byte) *Block {

	<span class="hljs-comment">//创建区块</span>
	block := &amp;Block{
		<span class="hljs-attribute">Height</span>:        height,
		PrevBlockHash: prevBlockHash,
		Txs:           txs,
		Timestamp:     time.<span class="hljs-built_in">Now</span>().<span class="hljs-built_in">Unix</span>(),
		Hash:          nil,
		Nonce:         <span class="hljs-number">0</span>}

	<span class="hljs-comment">//调用工作量证明返回有效的Hash</span>
	pow := <span class="hljs-built_in">NewProofOfWork</span>(block)
	hash, nonce := pow.<span class="hljs-built_in">Run</span>()
	block.Hash = hash[:]
	block.Nonce = nonce

	fmt.<span class="hljs-built_in">Printf</span>(<span class="hljs-string">"\r######%d-%x\n"</span>, nonce, hash)

	return block
}
</code></pre>
<h3 data-id="heading-6">CreateBlockchainWithGensisBlock改动</h3>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">//1.创建创世区块</span>
func <span class="hljs-built_in">CreateBlockchainWithGensisBlock</span>(address string) {

	<span class="hljs-comment">//判断数据库是否存在</span>
	if <span class="hljs-built_in">IsDBExists</span>(dbName) {

		fmt<span class="hljs-selector-class">.Println</span>("创世区块已存在...")
		os<span class="hljs-selector-class">.Exit</span>(<span class="hljs-number">1</span>)

		<span class="hljs-comment">//创建并打开数据库</span>
		db, err := bolt.<span class="hljs-built_in">Open</span>(dbName, <span class="hljs-number">0600</span>, nil)
		if err != nil {
			log<span class="hljs-selector-class">.Fatal</span>(err)
		}

		<span class="hljs-selector-tag">var</span> block *Block
		err = db<span class="hljs-selector-class">.View</span>(func(tx *bolt.Tx) error {

			<span class="hljs-selector-tag">b</span> := tx.<span class="hljs-built_in">Bucket</span>([]<span class="hljs-built_in">byte</span>(blockTableName))
			if b != nil {

				hash := b.<span class="hljs-built_in">Get</span>([]<span class="hljs-built_in">byte</span>(newestBlockKey))
				block = <span class="hljs-built_in">DeSerializeBlock</span>(b.<span class="hljs-built_in">Get</span>(hash))
				fmt.<span class="hljs-built_in">Printf</span>(<span class="hljs-string">"\r######%d-%x\n"</span>, block.Nonce, hash)
			}

			return nil
		})
		if err != nil {

			log<span class="hljs-selector-class">.Panic</span>(err)
		}

		os<span class="hljs-selector-class">.Exit</span>(<span class="hljs-number">1</span>)
	}

	fmt<span class="hljs-selector-class">.Println</span>("正在创建创世区块...")

	<span class="hljs-comment">//创建并打开数据库</span>
	db, err := bolt.<span class="hljs-built_in">Open</span>(dbName, <span class="hljs-number">0600</span>, nil)
	if err != nil {
		log<span class="hljs-selector-class">.Fatal</span>(err)
	}
	err = db<span class="hljs-selector-class">.Update</span>(func(tx *bolt.Tx) error {

		<span class="hljs-selector-tag">b</span>, err := tx.<span class="hljs-built_in">CreateBucket</span>([]<span class="hljs-built_in">byte</span>(blockTableName))
		if err != nil {

			log<span class="hljs-selector-class">.Panic</span>(err)
		}

		if <span class="hljs-selector-tag">b</span> != nil {

			<span class="hljs-comment">//创币交易</span>
			txCoinbase := <span class="hljs-built_in">NewCoinbaseTransaction</span>(address)
			//创世区块
			gensisBlock := <span class="hljs-built_in">CreateGenesisBlock</span>([]*Transaction{txCoinbase})
			<span class="hljs-comment">//存入数据库</span>
			err := b.<span class="hljs-built_in">Put</span>(gensisBlock.Hash, gensisBlock.<span class="hljs-built_in">Serialize</span>())
			if err != nil {
				log<span class="hljs-selector-class">.Panic</span>(err)
			}

			<span class="hljs-comment">//存储最新区块hash</span>
			err = <span class="hljs-selector-tag">b</span><span class="hljs-selector-class">.Put</span>([]byte(newestBlockKey), gensisBlock<span class="hljs-selector-class">.Hash</span>)
			if err != nil {
				log<span class="hljs-selector-class">.Panic</span>(err)
			}
		}

		return nil
	})
	<span class="hljs-comment">//更新数据库失败</span>
	if err != nil {
		log<span class="hljs-selector-class">.Fatal</span>(err)
	}
}
</code></pre>
<h3 data-id="heading-7">POW/prepareData改动</h3>
<p>添加交易后,POW挖矿时也必须相应地把交易信息考虑进去.这里需要改动prepareData方法</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">//拼接区块属性，返回字节数组</span>
func (pow *ProofOfWork) <span class="hljs-built_in">prepareData</span>(nonce int) <span class="hljs-selector-attr">[]</span>byte {

	data := bytes.<span class="hljs-built_in">Join</span>(
		[][]byte{
			pow<span class="hljs-selector-class">.Block</span><span class="hljs-selector-class">.PrevBlockHash</span>,
			pow<span class="hljs-selector-class">.Block</span><span class="hljs-selector-class">.HashTransactions</span>(),
			<span class="hljs-built_in">IntToHex</span>(pow.Block.Timestamp),
			<span class="hljs-built_in">IntToHex</span>(int64(targetBits)),
			<span class="hljs-built_in">IntToHex</span>(int64(nonce)),
			<span class="hljs-built_in">IntToHex</span>(int64(pow.Block.Height)),
		},
		<span class="hljs-selector-attr">[]</span>byte{},
	)

	return data
}
</code></pre>
<p>这里POW计算目标哈希并不需要将所有的交易信息拼接,我们只需要将每一个交易的交易哈希拼接起来即可.因为,交易哈希是交易所有信息的哈希值.这样做也能保证交易信息的完整性.所以,我们需要在Block新增一个方法:</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-comment">//将交易信息转换为字节数组</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(block *Block)</span></span> HashTransactions() []<span class="hljs-type">byte</span>  {

	<span class="hljs-keyword">var</span> txHashes [][]<span class="hljs-type">byte</span>
	<span class="hljs-keyword">var</span> txHash [<span class="hljs-number">32</span>]<span class="hljs-type">byte</span>

	<span class="hljs-keyword">for</span> _, tx := <span class="hljs-keyword">range</span> block.Txs {

		txHashes = <span class="hljs-built_in">append</span>(txHashes, tx.TxHAsh)
	}

	txHash = sha256.Sum256(bytes.Join(txHashes, []<span class="hljs-type">byte</span>{}))

	<span class="hljs-keyword">return</span> txHash[:]
}
</code></pre>
<h3 data-id="heading-8">Printchain添加交易信息打印</h3>
<p>现在,整个交易的数据结构就搭起来了.我们再改动区块链打印方法,将区块的交易信息添加到打印.</p>
<pre><code class="hljs language-erlang" lang="erlang">//<span class="hljs-number">3</span>.X 优化区块链遍历方法
<span class="hljs-function"><span class="hljs-title">func</span> <span class="hljs-params">(blc *Blockchain)</span> P<span class="hljs-title">rintchain</span><span class="hljs-params">()</span> {
	//迭代器
	<span class="hljs-title">blcIterator</span> := <span class="hljs-title">blc</span>.I<span class="hljs-title">terator</span><span class="hljs-params">()</span>
	<span class="hljs-title">for</span> {

		<span class="hljs-title">block</span> := <span class="hljs-title">blcIterator</span>.N<span class="hljs-title">ext</span><span class="hljs-params">()</span>

		<span class="hljs-title">fmt</span>.P<span class="hljs-title">rintln</span><span class="hljs-params">(<span class="hljs-string">"------------------------------"</span>)</span>
		<span class="hljs-title">fmt</span>.P<span class="hljs-title">rintf</span><span class="hljs-params">(<span class="hljs-string">"Height：%d\n"</span>, block.Height)</span>
		<span class="hljs-title">fmt</span>.P<span class="hljs-title">rintf</span><span class="hljs-params">(<span class="hljs-string">"PrevBlockHash：%x\n"</span>, block.PrevBlockHash)</span>
		<span class="hljs-title">fmt</span>.P<span class="hljs-title">rintf</span><span class="hljs-params">(<span class="hljs-string">"Timestamp：%s\n"</span>, time.Unix(block.Timestamp, <span class="hljs-number">0</span>)</span>.F<span class="hljs-title">ormat</span><span class="hljs-params">(<span class="hljs-string">"2006-01-02 03:04:05 PM"</span>)</span>)
		<span class="hljs-title">fmt</span>.P<span class="hljs-title">rintf</span><span class="hljs-params">(<span class="hljs-string">"Hash：%x\n"</span>, block.Hash)</span>
		<span class="hljs-title">fmt</span>.P<span class="hljs-title">rintf</span><span class="hljs-params">(<span class="hljs-string">"Nonce：%d\n"</span>, block.Nonce)</span>
		<span class="hljs-title">fmt</span>.P<span class="hljs-title">rintln</span><span class="hljs-params">(<span class="hljs-string">"Txs:"</span>)</span>
		<span class="hljs-title">for</span> _,<span class="hljs-title">tx</span> := <span class="hljs-title">range</span> <span class="hljs-title">block</span>.T<span class="hljs-title">xs</span> {

			<span class="hljs-title">fmt</span>.P<span class="hljs-title">rintf</span><span class="hljs-params">(<span class="hljs-string">"%x\n"</span>, tx.TxHAsh)</span>
			<span class="hljs-title">fmt</span>.P<span class="hljs-title">rintln</span><span class="hljs-params">(<span class="hljs-string">"Vins:"</span>)</span>
			<span class="hljs-title">for</span> _,<span class="hljs-title">in</span> := <span class="hljs-title">range</span> <span class="hljs-title">tx</span>.V<span class="hljs-title">ins</span>  {
				<span class="hljs-title">fmt</span>.P<span class="hljs-title">rintf</span><span class="hljs-params">(<span class="hljs-string">"txHash:%x\n"</span>, in.TxHash)</span>
				<span class="hljs-title">fmt</span>.P<span class="hljs-title">rintf</span><span class="hljs-params">(<span class="hljs-string">"Vout:%d\n"</span>, in.Vout)</span>
				<span class="hljs-title">fmt</span>.P<span class="hljs-title">rintf</span><span class="hljs-params">(<span class="hljs-string">"ScriptSig:%s\n\n"</span>, in.ScriptSig)</span>
			}

			<span class="hljs-title">fmt</span>.P<span class="hljs-title">rintln</span><span class="hljs-params">(<span class="hljs-string">"Vouts:"</span>)</span>
			<span class="hljs-title">for</span> _,<span class="hljs-title">out</span> := <span class="hljs-title">range</span> <span class="hljs-title">tx</span>.V<span class="hljs-title">outs</span>  {
				<span class="hljs-title">fmt</span>.P<span class="hljs-title">rintf</span><span class="hljs-params">(<span class="hljs-string">"Value:%x\n"</span>, out.Value)</span>
				<span class="hljs-title">fmt</span>.P<span class="hljs-title">rintf</span><span class="hljs-params">(<span class="hljs-string">"ScriptPubKey:%x\n\n"</span>, out.ScriptPubKey)</span>
			}
		}
		<span class="hljs-title">fmt</span>.P<span class="hljs-title">rintln</span><span class="hljs-params">(<span class="hljs-string">"------------------------------"</span>)</span>

		<span class="hljs-title">var</span> <span class="hljs-title">hashInt</span> <span class="hljs-title">big</span>.I<span class="hljs-title">nt</span>
		<span class="hljs-title">hashInt</span>.S<span class="hljs-title">etBytes</span><span class="hljs-params">(block.PrevBlockHash)</span>

		<span class="hljs-title">if</span> <span class="hljs-title">big</span>.N<span class="hljs-title">ewInt</span><span class="hljs-params">(<span class="hljs-number">0</span>)</span>.C<span class="hljs-title">mp</span><span class="hljs-params">(&amp;hashInt)</span> == 0 {

			<span class="hljs-title">break</span>
		}
	}
}
</span></code></pre>
<h3 data-id="heading-9">Main_Test</h3>
<pre><code class="hljs language-go" lang="go"><span class="hljs-keyword">package</span> main

<span class="hljs-keyword">import</span> (
	<span class="hljs-string">"chaors.com/LearnGo/publicChaorsChain/part7-transaction-Prototype/BLC"</span>
)

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {

	cli := BLC.CLI{}
	cli.Run()
}
</code></pre>
<p>打印创世区块的结果为:</p>
<p><img src="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2018/7/10/16484b583b85666d~tplv-t2oaga2asx-jj-mark:3024:0:0:0:q75.awebp#?w=1240&amp;h=530&amp;s=253184&amp;e=png&amp;b=2c2c2c" alt="main_test" loading="lazy"/></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fchaors%2FPublicBlockChain_go" target="_blank" title="https://github.com/chaors/PublicBlockChain_go" ref="nofollow noopener noreferrer">源代码</a>在这,喜欢的朋友记得给个小star，或者fork.也欢迎大家一起探讨区块链相关知识，一起进步！</p>
<h3 data-id="heading-10">更多原创区块链技术文章请访问<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.jianshu.com%2Fu%2Fa46bd6ade353" target="_blank" title="https://www.jianshu.com/u/a46bd6ade353" ref="nofollow noopener noreferrer">chaors</a></h3>
<p>.
.
.
.</p>
<blockquote>
<p>###互联网颠覆世界，区块链颠覆互联网!</p>
</blockquote>
<blockquote>
<h6 data-id="heading-11">---------------------------------------------20180703 20:40</h6>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[【Python版 2026 从零学Langchain 1.x】（二）结构化输出和工具调用]]></title>    <link>https://juejin.cn/post/7600333405979312169</link>    <guid>https://juejin.cn/post/7600333405979312169</guid>    <pubDate>2026-01-29T05:26:02.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600333405979312169" data-draft-id="7600491179498750006" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="【Python版 2026 从零学Langchain  1.x】（二）结构化输出和工具调用"/> <meta itemprop="keywords" content="Python,LangChain,Agent"/> <meta itemprop="datePublished" content="2026-01-29T05:26:02.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="疯狂踩坑人"/> <meta itemprop="url" content="https://juejin.cn/user/1011206430698574"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            【Python版 2026 从零学Langchain  1.x】（二）结构化输出和工具调用
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1011206430698574/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    疯狂踩坑人
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-29T05:26:02.000Z" title="Thu Jan 29 2026 05:26:02 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读18分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>🔥本系列文章（文章末尾附录了代码和TS版本文章）：<br/>
<a href="https://juejin.cn/post/7599708108622364723" target="_blank" title="https://juejin.cn/post/7599708108622364723">【Python版 2026 从零学Langchain 1.x】（一）快速开始和LCEL</a><br/>
<a href="https://juejin.cn/spost/7600333405979312169" target="_blank" title="https://juejin.cn/spost/7600333405979312169">【Python版 2026 从零学Langchain  1.x】（二）结构化输出和工具调用</a></p>
<h2 data-id="heading-0">一、结构化输出 - Structured</h2>
<h3 data-id="heading-1">1. 概念介绍</h3>
<p>这里的结构化输出主要是指大模型可以输出符合要求的JSON数据，JSON数据的正确分两方面来看：</p>
<ul>
<li>JSON格式正确。比如<code>{"count":1}</code>正确，而<code>{"count":1</code>不正确。</li>
<li>JSON的字段语义正确。比如定义了count字段为数值，那么<code>{"count":1}</code>正确，而<code>{"count":"一"}</code>不正确。</li>
</ul>
<p><code>Langchain</code>（python）提供了- <code>Pydantic</code>、 <code>TypedDict</code>、 <code>JSON Schema</code> 三种方式来定义结构，常用的是<code>Pydantic</code>.</p>
<p>但是早期模型其实不支持JSON格式化输出（API层不提供支持），所以早期的Langchain是通过注入指令/提示词 + 正则提取的方式实现。</p>
<p>到2026年了，很多主流模型都是支持格式化输出了，几乎成了一种标准能力。</p>
<h3 data-id="heading-2">2. 返回对象（词典）</h3>
<p>🌰例子：我想要了解某个电影的信息，并期望以结构化的数据返回。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> app.config <span class="hljs-keyword">import</span> settings
<span class="hljs-keyword">from</span> langchain_openai <span class="hljs-keyword">import</span> ChatOpenAI
<span class="hljs-keyword">from</span> langchain.messages <span class="hljs-keyword">import</span> HumanMessage, AIMessage, SystemMessage
<span class="hljs-keyword">from</span> pydantic <span class="hljs-keyword">import</span> BaseModel, Field

model = ChatOpenAI(
    model=settings.glm_model,
    base_url=settings.siliconflow_base_url,
    api_key=settings.siliconflow_api_key,
    temperature=<span class="hljs-number">0.9</span>,
    max_tokens=<span class="hljs-number">3000</span>,
    timeout=<span class="hljs-number">60</span>,
    verbosity=<span class="hljs-literal">True</span>
)

<span class="hljs-keyword">class</span> <span class="hljs-title class_">Movie</span>(<span class="hljs-title class_ inherited__">BaseModel</span>):
    <span class="hljs-string">"""电影的相关信息"""</span>
    title: <span class="hljs-built_in">str</span> = Field(..., description=<span class="hljs-string">"电影名称"</span>)
    year: <span class="hljs-built_in">int</span> = Field(..., description=<span class="hljs-string">"电影上映时间"</span>)
    director: <span class="hljs-built_in">str</span> = Field(..., description=<span class="hljs-string">"电影的导演"</span>)
    rating: <span class="hljs-built_in">float</span> = Field(..., description=<span class="hljs-string">"电影的豆瓣评分"</span>)

model_with_structure = model.with_structured_output(Movie)
response = model_with_structure.invoke(<span class="hljs-string">"介绍下电影《罗小黑战记2》"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-built_in">type</span>(response)) &lt;<span class="hljs-keyword">class</span> <span class="hljs-string">'__main__.Movie'</span>&gt;
<span class="hljs-built_in">print</span>(response)  <span class="hljs-comment"># title='电影《罗小黑战记2》的最新情况' year=2024 director='不思凡 / MTJJ (疑似联合执导)' rating=5.0</span>
</code></pre>
<p>可以看出，我的提示词里面并没有要求LLM如何提取信息，但是返回结果却是按照我给的Pydantic模型定义提取了信息，最终返回一个Pydantic对象。 （P.S. 这里的代码，langchain可没有去做增强我们的提示词的事哦，而是把结构化输出的任务交给了LLM provider）</p>
<p>现在主流LLM都支持结构化输出，看看<a href="https://link.juejin.cn?target=https%3A%2F%2Fplatform.openai.com%2Fdocs%2Fguides%2Fstructured-outputs%3Fapi-mode%3Dchat%23examples" target="_blank" title="https://platform.openai.com/docs/guides/structured-outputs?api-mode=chat#examples" ref="nofollow noopener noreferrer">openAI的文档</a>，这些LLM provider内部会做工程化，完成结构化输出这个能力，并提供API。</p>
<p>LLM provider内部工程化，会使用提示词要求大模型按"格式"输出。此外，一方面对大模型加掩码控制一些不合法的输出，另一方面对输出的结果进行校验（如果不满足pydantic的校验，则反馈错误给大模型重试）</p>
<p>最终提取的信息准确度，取决于提示词和LLM的能力。这里如果把提示词换成<code>介绍下电影《罗小黑战记2》，获取title、year、director、rating信息</code> 效果会更好点。</p>
<p>在代码顶部加上下面代码，打印所有的调用日志信息</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> langchain_core.<span class="hljs-built_in">globals</span> <span class="hljs-keyword">import</span> set_debug

<span class="hljs-comment"># 开启全局详细模式</span>
set_debug(<span class="hljs-literal">True</span>)
</code></pre>
<p>另外，我还做了下实验：下面是我用deepseek v3.2 作为LLM, 跑上面代码，打印的中间信息，可以看出LLM返回了一个序列化的JSON数据（title重复了，说明deepseek v3.2在结构化输出这方面能力还是较差）</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8244125407ee4ba08157a1950fe77558~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55av54uC6Lip5Z2R5Lq6:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770269394&amp;x-signature=UWPR3lj4QY%2FAMGU6WV17KlesBlQ%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-3">3. 返回列表结构</h3>
<p>🌰例子：我希望LLM对我的需求拆分成任务列表。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> langchain.agents <span class="hljs-keyword">import</span> create_agent
<span class="hljs-keyword">from</span> app.config <span class="hljs-keyword">import</span> settings
<span class="hljs-keyword">from</span> langchain_openai <span class="hljs-keyword">import</span> ChatOpenAI
<span class="hljs-keyword">from</span> pydantic <span class="hljs-keyword">import</span> BaseModel, Field, RootModel
<span class="hljs-keyword">from</span> langchain_core.<span class="hljs-built_in">globals</span> <span class="hljs-keyword">import</span> set_debug

<span class="hljs-comment"># 开启全局详细模式</span>
set_debug(<span class="hljs-literal">True</span>)


model = ChatOpenAI(
    model=settings.glm_model,
    base_url=settings.siliconflow_base_url,
    api_key=settings.siliconflow_api_key,
    temperature=<span class="hljs-number">0.9</span>,
    max_tokens=<span class="hljs-number">3000</span>,
    timeout=<span class="hljs-number">60</span>,
)

<span class="hljs-keyword">class</span> <span class="hljs-title class_">DevProcessList</span>(RootModel[<span class="hljs-built_in">list</span>[<span class="hljs-built_in">str</span>]]):
    <span class="hljs-string">"""按顺序的软件开发流程字符串列表"""</span>

<span class="hljs-keyword">def</span> <span class="hljs-title function_">test_structure_list</span>():
    model_with_structure = model.with_structured_output(DevProcessList)
    response = model_with_structure.invoke(
        [{<span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"软件开发的流程是？请给我一个有顺序的字符串列表"</span>}], 
    )
    <span class="hljs-built_in">print</span>(<span class="hljs-built_in">type</span>(response)) <span class="hljs-comment"># &lt;class '__main__.DevProcessList'&gt;</span>
    <span class="hljs-built_in">print</span>(response.model_dump()) <span class="hljs-comment"># ['需求分析', '系统设计', '编码实现', '软件测试', '部署发布', '运维维护']</span>
</code></pre>
<p>你可以看出<code>model.with_structured_output</code>这种方式，LLM是严格返回列表（序列化的json）</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c3266cbfbc5147f28e2709239df080aa~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55av54uC6Lip5Z2R5Lq6:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770269394&amp;x-signature=unKG1HRZqL6XKeyokAjHTUO5efg%3D" alt="image.png" loading="lazy"/></p>
<p>还有种方式，很多教程都有提到——<code>PydanticOutputParser</code>，核心代码如下：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> langchain_core.output_parsers <span class="hljs-keyword">import</span> PydanticOutputParser

model_with_structure = model | PydanticOutputParser(pydantic_object=DevProcessList)
    response = model_with_structure.invoke(
        [{<span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"软件开发的流程是？请给我一个有顺序的字符串列表"</span>}], 
    )
    <span class="hljs-built_in">print</span>(<span class="hljs-built_in">type</span>(response)) <span class="hljs-comment"># &lt;class '__main__.DevProcessList'&gt;</span>
    <span class="hljs-built_in">print</span>(response.model_dump()) <span class="hljs-comment"># ['需求分析', '系统设计', '编码实现', '软件测试', '部署发布', '运维维护']</span>
</code></pre>
<p>LLM的实际输出如下，并不是一个序列化的JSON。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d38d3e8be3834e39b17aa7b5f336f922~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55av54uC6Lip5Z2R5Lq6:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770269394&amp;x-signature=Cm15uTCwnBh1LBcTJUUsNBReqBo%3D" alt="image.png" loading="lazy"/></p>
<p>但是langchain还是能正确给我们返回 一个 列表。 原因在于<code>PydanticOutputParser</code>解析器，解析器会在用户提示词注入格式化指令（也是提示词），然后对结构进行正则匹配拿到列表/pydantic对象。
而<code>model.with_structured_output</code>则是通过LLM provider提供的API参数，明确获取结构化数据（几乎100%可靠）</p>
<p><code>langchain_core</code> 提供了4种结构化输出的解析器<code>CommaSeparatedListOutputParser</code>、<code>StructuredOutputParser</code>、
<code>JsonOutputParser</code>、<code>PydanticOutputParser</code> 。
这些解析器都依赖langchain的指令注入和正则匹配，可靠性一般，生产环境更推荐<code>model.with_structured_output</code>。</p>
<p>P.S 关于列表生成，更推荐使用<code>PydanticOutputParser</code> ，而不是<code>CommaSeparatedListOutputParser</code>，因为<code>CommaSeparatedListOutputParser</code>是langchain根据逗号进行分割和去空格的方式，准确性会存在问题，比如下面：</p>
<ul>
<li>LLM的返回：</li>
</ul>

<pre><code class="hljs language-swift" lang="swift"><span class="hljs-string">"text"</span>: <span class="hljs-string">"以下是标准软件开发流程（SDLC）的字符串列表：<span class="hljs-subst">\n</span><span class="hljs-subst">\n</span>1. 需求分析<span class="hljs-subst">\n</span>2. 系统设计<span class="hljs-subst">\n</span>3. 开发实施<span class="hljs-subst">\n</span>4. 软件测试<span class="hljs-subst">\n</span>5. 部署上线<span class="hljs-subst">\n</span>6. 运维与迭代"</span>
</code></pre>
<ul>
<li>langchain解析后返回：</li>
</ul>
<pre><code class="hljs language-python" lang="python">[<span class="hljs-string">'以下是标准软件开发流程（SDLC）的字符串列表：'</span>, <span class="hljs-string">'1. 需求分析'</span>, <span class="hljs-string">'2. 系统设计'</span>, <span class="hljs-string">'3. 开发实施'</span>, <span class="hljs-string">'4. 软件测试'</span>, <span class="hljs-string">'5. 部署上线'</span>, <span class="hljs-string">'6. 运维与迭代'</span>]
</code></pre>
<h3 data-id="heading-4">4. agent的结构化输出策略</h3>
<p>在 LangChain（尤其是在较新版本的 <code>create_agent</code> 或 LangGraph 架构中）中，<code>ToolStrategy</code> 和 <code>ProviderStrategy</code> 是实现**结构化输出（Structured Output）**的两种核心策略。</p>
<p>简单来说，它们的区别在于“是利用模型原生的结构化能力，还是通过‘欺骗’模型调用工具来间接实现结构化”。</p>
<p><code>create_agent</code>的参数response_format 支持下面4个类型值：</p>
<ul>
<li><code>ProviderStrategy</code> 使用提供者原生的结构化输出</li>
<li><code>ToolStrategy</code> 使用工具调用以获得结构化输出</li>
<li><code>type</code> 模式类型 - 根据模型能力自动选择最佳策略</li>
<li><code>None</code> 无格式化要求（默认）</li>
</ul>
<p><strong>代码示例：</strong></p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> pydantic <span class="hljs-keyword">import</span> BaseModel, Field
<span class="hljs-keyword">from</span> langchain.agents <span class="hljs-keyword">import</span> create_agent


<span class="hljs-keyword">class</span> <span class="hljs-title class_">ContactInfo</span>(<span class="hljs-title class_ inherited__">BaseModel</span>):
    <span class="hljs-string">"""Contact information for a person."""</span>
    name: <span class="hljs-built_in">str</span> = Field(description=<span class="hljs-string">"The name of the person"</span>)
    email: <span class="hljs-built_in">str</span> = Field(description=<span class="hljs-string">"The email address of the person"</span>)
    phone: <span class="hljs-built_in">str</span> = Field(description=<span class="hljs-string">"The phone number of the person"</span>)

<span class="hljs-comment"># 自动选择策略（推荐）：</span>
agent = create_agent(model, tools, response_format=ContactInfo) 

<span class="hljs-comment"># 使用模型原生提供的，前提是模型API支持</span>
agent = create_agent(model, tools, response_format=ProviderStrategy(ContactInfo)) 

<span class="hljs-comment"># 强制使用 ToolStrategy：</span>
<span class="hljs-keyword">from</span> langchain.agents.structured_output <span class="hljs-keyword">import</span> ToolStrategy
agent = create_agent(model, tools, response_format=ToolStrategy(ContactInfo))
</code></pre>
<h4 data-id="heading-5">ToolStrategy vs. ProviderStrategy 的区别</h4>



































<table><thead><tr><th align="left">维度</th><th align="left">ToolStrategy (工具策略)</th><th align="left">ProviderStrategy (厂商原生策略)</th></tr></thead><tbody><tr><td align="left"><strong>实现机制</strong></td><td align="left"><strong>模拟工具调用</strong>：将你需要的输出 Schema 包装成一个“虚构工具”，让模型去调用它。</td><td align="left"><strong>原生 API 支持</strong>：直接利用模型厂商提供的结构化输出功能（如 OpenAI 的 JSON Mode 或 Strict Mode）。</td></tr><tr><td align="left"><strong>兼容性</strong></td><td align="left"><strong>极高</strong>：只要模型支持工具调用（Function Calling），就能使用。</td><td align="left"><strong>有限</strong>：仅支持提供原生结构化接口的厂商（如 OpenAI, Anthropic, Google）。</td></tr><tr><td align="left"><strong>可靠性</strong></td><td align="left">中等：依赖模型对工具参数的遵循能力。</td><td align="left"><strong>最高</strong>：厂商在模型底层和 API 层做了强校验，输出更稳定。</td></tr><tr><td align="left"><strong>使用场景</strong></td><td align="left">模型不支持原生结构化输出，或需要高度通用的代码实现时。</td><td align="left">追求最高成功率和严谨的 Schema 校验时。</td></tr><tr><td align="left"><strong>默认行为</strong></td><td align="left">在模型不支持原生结构化时作为备选方案（Fallback）。</td><td align="left">LangChain 在识别到支持的模型时会默认优先选择。</td></tr></tbody></table>
<hr/>
<h4 data-id="heading-6">选择建议</h4>
<ul>
<li><strong>什么时候用 ProviderStrategy？</strong>
只要你的模型支持（如 GPT-4o, Claude 3.5 Sonnet），<strong>永远优先使用 ProviderStrategy</strong>。它在底层有更强的约束，能够减少模型胡言乱语（Hallucination）或格式错误的概率。</li>
<li><strong>什么时候用 ToolStrategy？</strong>
当你使用的模型较旧、或是某些国产/开源模型仅支持 Function Calling 但没有专门的 JSON Schema 模式时，使用 <code>ToolStrategy</code> 是实现结构化数据提取的唯一可靠途径。</li>
</ul>
<p>大多数情况下，建议直接传入type（pydantic对象），让Langchain自己选择策略。</p>
<h2 data-id="heading-7">二、工具调用 - Tools</h2>
<h3 data-id="heading-8">1. 工具调用的演变</h3>
<p>主流 LLM 实现工具调用的方式经历了三个阶段，这决定了它们对结构化输出的依赖程度：</p>
<p><strong>第一阶段：纯 Prompt 时代的“软约束”</strong></p>
<ul>
<li><strong>做法</strong>：在 Prompt 里写：“如果你想查天气，请输出 JSON 格式：<code>{"action": "weather", "city": "xxx"}</code>”。</li>
<li><strong>现状</strong>：这是早期的做法（如 GPT-3 时代）。</li>
<li><strong>问题</strong>：模型经常“掉链子”，生成的格式不对，这就往往需要正则来提取函数名和参数。此时，<strong>工具调用非常依赖模型的自觉性</strong>，解析错误率高。</li>
</ul>
<p><strong>第二阶段：模型微调的“半强约束”（主流现状）</strong></p>
<ul>
<li><strong>做法</strong>：OpenAI (GPT-3.5/4)、Anthropic (Claude 3/3.5)、Google (Gemini) 对模型进行了专门的工具调用微调。</li>
<li><strong>现状</strong>：模型看到 <code>tools</code> 参数时，会进入一种“工具模式”。</li>
<li><strong>依赖关系</strong>：虽然模型努力输出结构化 JSON，但<strong>由于没有底层的硬性限制，它仍然可能偶尔输出错误的 JSON 结构</strong>。</li>
</ul>
<p><strong>第三阶段：语法级别（Grammar）的“硬约束”（即 Structured Outputs）</strong></p>
<ul>
<li><strong>做法</strong>：这是 OpenAI 在 2024 年 8 月推出的功能（<code>strict: true</code>）。</li>
<li><strong>原理</strong>：在模型生成 Token 的每一瞬间，系统会根据 JSON Schema 过滤掉所有不符合语法的 Token。</li>
<li><strong>现状</strong>：<strong>这是工具调用的终极形态</strong>。此时，工具调用与结构化输出完全合为一体。如果定义了 Schema，模型<strong>物理上不可能</strong>输出格式错误的 JSON。</li>
</ul>
<h3 data-id="heading-9">2. Function Calling</h3>
<p>OpenAI最早提出<code>Function Calling</code> 的概念和功能。<code>Function Calling</code> 就是一种<code>Tools Calling</code> （在Langchain中所有LLM provider的 "工具使用"，包括Function Calling 都被抽象为<code>Tools Calling</code>）。</p>
<p><strong>Function Calling 的流程（5 个步骤）：</strong></p>
<ol>
<li><strong>定义函数</strong>：你在调用 API 时，提供一份“说明书”（JSON Schema），告诉模型你有几个函数、它们的作用是什么、需要什么参数。</li>
<li><strong>模型判断</strong>：用户提问（如“帮我查下明天的北京天气”）。模型发现这匹配了你定义的函数，于是返回一个特殊的“函数调用请求” JSON。</li>
<li><strong>程序执行</strong>：你的后端代码解析这个 JSON，<strong>实际运行</strong>对应的函数（如去访问气象局 API），并拿到结果。</li>
<li><strong>结果反馈</strong>：你将函数的运行结果（如“北京明天多云转晴，20度”）发回给模型。</li>
<li><strong>自然回复</strong>：模型根据这个真实数据，组织语言给用户一个自然的最终回答。</li>
</ol>
<p><strong>关键特性</strong></p>
<ul>
<li><strong>并行调用 (Parallel Function Calling)</strong>：模型可以一次性决定调用多个函数。例如，问“北京和伦敦天气如何？”，模型会一次性输出两个函数调用指令。</li>
<li><strong>强制/自动模式 (tool_choice)</strong>：你可以强制模型必须调用某个工具，或者让它根据对话自行判断是否需要。</li>
<li><strong>结构化输出 (Structured Outputs)</strong>：OpenAI 的最新版本保证了输出的参数百分之百符合你定义的格式要求，极大地提高了生产环境的稳定性。</li>
</ul>
<h3 data-id="heading-10">3. Function Calling vs. MCP的区别</h3>
<p>先说总结：<mark>MCP是依赖Function Calling 的能力，是对Function Calling （简称FC） 能力的拓展。FC是一种基础能力，而MCP是一种架构协议（这意味这个更好拓展，有利于系统级别开发）。</mark></p>
<p>MCP 包含了3部分</p>
<ul>
<li><strong>MCP Host</strong>：AI 软件（如 Claude Desktop）。</li>
<li><strong>MCP Client</strong>：协议层，负责协调。</li>
<li><strong>MCP Server</strong>：数据源或工具的提供者（如 Google Drive 插件、数据库查询器）。</li>
</ul>
<p>在FC中，需要定义函数...调用函数，这些都是在定义流程，并确保LLM能完成这一流程。</p>
<p>而MCP，则是明确分工了。MCP Server负责定义工具/函数；MCP Client负责把这些工具/函数 暴露给LLM并识别LLM的结果调用工具；
这个MCP Server从 「主应用」中抽离出来，可以被多个「应用」复用——只要「应用」实现了MCP Client。
因此，MCP还定义了 MCP Client和 MCP Server之间的通信协议。</p>
<h3 data-id="heading-11">4. Langchain 的 Tools设计</h3>
<h4 data-id="heading-12">工具定义和使用</h4>
<h5 data-id="heading-13">基础使用</h5>
<p>这里我先假设一个场景——<strong>电影分析</strong>：<br/>
用户希望能准确获取一些《罗小黑》电影的分析，具体来说，希望分析出为什么有人喜欢，有人吐槽。那么就需要真实的影评数据。</p>
<p>首先我们定义一个函数（模拟能从数据库获取 影评 数据）</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> langchain.tools <span class="hljs-keyword">import</span> tool

<span class="hljs-meta">@tool</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">get_reviews</span>(<span class="hljs-params">positive: <span class="hljs-built_in">bool</span></span>) -&gt; <span class="hljs-built_in">list</span>[<span class="hljs-built_in">str</span>]:
    <span class="hljs-string">"""
    获取罗小黑电影评论列表
    Args:
        positive: 是否获取正面评论, True 表示获取正面评论, False 表示获取负面评论
    Returns:
        评论列表
    """</span>
    positive_reviews = [
        <span class="hljs-string">"原来两三岁的小孩也可以不扯女孩裙子啊；原来不整屎尿屁也可以做出让全场大笑的效果啊；原来女角色也可以不穿超短裙高开叉高跟鞋啊；原来男师父女徒弟也可以不暧昧纯师徒情啊；原来一个动画片里正派之间也可以有不同的价值观啊；原来不喊口号不献祭亲朋好友父老乡亲也能表达反战的思想啊。罗小黑你还是太超前了。"</span>,
        <span class="hljs-string">"瑕不掩瑜。非常好的一点是，一点儿爹味都没有，不judge任何人（妖精），没有任何人（妖精）需要被打败或悔过。这在中国的大型说教重灾区———国漫中已是十分可贵。"</span>,
        <span class="hljs-string">"“无限虽然爱装逼，但是他没有跟鹿野搞花千骨，此乃一胜；没有跟罗小黑搞黑猫和他的蓝发师尊，此乃二胜；没有和哪吒搞男同，此乃三胜”"</span>,
        <span class="hljs-string">"我宣布鹿野是我唯一的姐！太帅了！！！工装裤配T恤，低马尾，非传统女性角色，太帅了5555555希望越来越强，早日拳打无限脚踢各大长老！！！ 以及，真是好多场经费爆炸的打斗啊"</span>,
    ]
    negative_reviews = [
        <span class="hljs-string">"呃…片方到底懂不懂自己的IP魅力在哪啊！搞什么武器、战争的宏大场面啊，又搞不明白，妥妥露怯！整个剧情就是，稀碎…"</span>,
    ]
    <span class="hljs-keyword">return</span> positive_reviews <span class="hljs-keyword">if</span> positive <span class="hljs-keyword">else</span> negative_reviews
</code></pre>
<p>使用 <code>@tool</code> 装饰器。默认情况下，函数名就是暴露给LLM的名称，函数的 docstring（函数文档字符串） 会成为工具的描述，帮助模型理解何时使用它。</p>
<p>你也可以自定义，比如：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-meta">@tool(<span class="hljs-params"><span class="hljs-string">"get_movie_reviews"</span>, description=<span class="hljs-string">"获取罗小黑电影评论列表"</span></span>)</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">get_reviews</span>(<span class="hljs-params">positive: <span class="hljs-built_in">bool</span></span>) -&gt; <span class="hljs-built_in">list</span>[<span class="hljs-built_in">str</span>]:
    <span class="hljs-string">"""..."""</span>
    ...
</code></pre>
<p>这里我通过 docstring 来进行了参数说明，对于复杂的参数类型描述，你也可以使用pydantic来声明参数，然后类似下面这样使用</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> pydantic <span class="hljs-keyword">import</span> BaseModel, Field
<span class="hljs-keyword">class</span> <span class="hljs-title class_">ReviewsInput</span>(<span class="hljs-title class_ inherited__">BaseModel</span>):
    <span class="hljs-string">"""查询影评的输入参数"""</span>
    include_forecast: <span class="hljs-built_in">bool</span> = Field(
        default=<span class="hljs-literal">False</span>,
        description=<span class="hljs-string">"是否获取正面评论, True 表示获取正面评论, False 表示获取负面评论"</span>
    )
<span class="hljs-meta">@tool(<span class="hljs-params"><span class="hljs-string">"get_movie_reviews"</span>, args_schema=ReviewsInput</span>)</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">get_reviews</span>(<span class="hljs-params">positive: <span class="hljs-built_in">bool</span></span>) -&gt; <span class="hljs-built_in">list</span>[<span class="hljs-built_in">str</span>]:
    <span class="hljs-string">"""获取罗小黑电影评论列表"""</span>
    ...
</code></pre>
<p>测试 是否能正常调用Tool，代码如下，可以看出LLM识别出我们的意图，然后响应说“你可以发起函数调用”</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">test_tool_calling</span>():
    <span class="hljs-string">"""
    测试工具调用
    """</span>
    <span class="hljs-comment"># reviews = get_reviews.invoke({"positive": True})</span>
    <span class="hljs-comment"># print(reviews) # 输出reviews列表: ["原来两三岁...",...]</span>
    model_with_tools = model.bind_tools([get_reviews])
    response = model_with_tools.invoke(<span class="hljs-string">"请分析罗小黑电影的负面评论原因？"</span>) <span class="hljs-comment"># 返回 AIMessage</span>
    <span class="hljs-keyword">for</span> tool_call <span class="hljs-keyword">in</span> response.tool_calls:
        <span class="hljs-comment"># 查看函数调用</span>
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"Tool: <span class="hljs-subst">{tool_call[<span class="hljs-string">'name'</span>]}</span>"</span>)
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"Args: <span class="hljs-subst">{tool_call[<span class="hljs-string">'args'</span>]}</span>"</span>)
        <span class="hljs-comment"># Tool: get_reviews</span>
        <span class="hljs-comment"># Args: {'positive': False}</span>
</code></pre>
<p>模型输出的结果如图：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b311a7eed34c40ed9a8baf7383f23919~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55av54uC6Lip5Z2R5Lq6:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770269394&amp;x-signature=PPkpwUfT5WoqM46bMl8cpjefZ6o%3D" alt="image.png" loading="lazy"/></p>
<p><code>tool_calls</code>数组有内容说明是成功调用了工具，希望我们提供影评数据。下面就带上影评数据进行第二请求。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">test_tool_calling_2</span>():
    <span class="hljs-string">"""
    测试工具调用2
    """</span>
    model_with_tools = model.bind_tools([get_reviews])
    prompt = <span class="hljs-string">"请分析罗小黑电影的正面评论原因？"</span>
    response = model_with_tools.invoke(prompt) <span class="hljs-comment"># AIMessage</span>

    tool_messages: <span class="hljs-built_in">list</span>[ToolMessage] = []
    <span class="hljs-keyword">for</span> tool_call <span class="hljs-keyword">in</span> response.tool_calls:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"Tool: <span class="hljs-subst">{tool_call[<span class="hljs-string">'name'</span>]}</span>"</span>)
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"Args: <span class="hljs-subst">{tool_call[<span class="hljs-string">'args'</span>]}</span>"</span>)
        reviews = get_reviews.invoke(tool_call[<span class="hljs-string">"args"</span>])
        tool_messages.append(
            ToolMessage(
                content=json.dumps(reviews, ensure_ascii=<span class="hljs-literal">False</span>),
                tool_call_id=tool_call[<span class="hljs-string">"id"</span>],
            )
        )

    final_response = model_with_tools.invoke([HumanMessage(content=prompt), response, *tool_messages])
    <span class="hljs-built_in">print</span>(final_response.content)
	<span class="hljs-string">'''输出：
        ## 🎬 正面评论原因分析
        ### 1. **儿童教育价值出色**
        ...
    '''</span>
</code></pre>
<p>这里用<code>ToolMessage</code> 来封装这些影评数据，然后和历史记录一起发送给LLM。</p>
<blockquote>
<p>每个由工具返回的 <code>ToolMessage</code> 都包含一个与原始工具调用匹配的 <code>tool_call_id</code> ，这有助于模型将结果与请求关联起来。</p>
</blockquote>
<p>下面贴出两次请求的提示词，你可以看到Langchain帮我做了那些事。</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"prompts"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
    <span class="hljs-string">"Human: 请分析罗小黑电影的正面评论原因？"</span>
  <span class="hljs-punctuation">]</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"prompts"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
    <span class="hljs-string">"Human: 请分析罗小黑电影的正面评论原因？\nAI: 我来帮您获取罗小黑电影的正面评论，然后分析其中的正面评价原因。[{'name': 'get_reviews', 'args': {'positive': True}, 'id': '019bf500873b7d3b26cbb49ba71c4984', 'type': 'tool_call'}]\nTool: [\"原来两三岁的小孩也可以不扯女孩裙子啊；原来不整屎尿屁也可以做出让全场大笑的效果啊；原来女角色也可以不穿超短裙高开叉高跟鞋啊；原来男师父女徒弟也可以不暧昧纯师徒情啊；原来一个动画片里正派之间也可以有不同的价值观啊；原来不喊口号不献祭亲朋好友父老乡亲也能表达反战的思想啊。罗小黑你还是太超前了。\", \"瑕不掩瑜。非常好的一点是，一点儿爹味都没有，不judge任何人（妖精），没有任何人（妖精）需要被打败或悔过。这在中国的大型说教重灾区———国漫中已是十分可贵。\", \"“无限虽然爱装逼，但是他没有跟鹿野搞花千骨，此乃一胜；没有跟罗小黑搞黑猫和他的蓝发师尊，此乃二胜；没有和哪吒搞男同，此乃三胜”\", \"我宣布鹿野是我唯一的姐！太帅了！！！工装裤配T恤，低马尾，非传统女性角色，太帅了5555555希望越来越强，早日拳打无限脚踢各大长老！！！ 以及，真是好多场经费爆炸的打斗啊\"]"</span>
  <span class="hljs-punctuation">]</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>P.S. invoke会将Message列表 序列化成字符串，其中ToolMessage就是：</p>
<pre><code class="hljs language-ini" lang="ini">Tool: <span class="hljs-section">[工具调用返回的消息]</span>
</code></pre>
<h5 data-id="heading-14">强制工具使用</h5>
<blockquote>
<p>默认情况下，模型会根据用户的输入自由选择使用哪个绑定工具。但是，你可能希望强制选择一个工具，确保模型使用特定的工具或给定列表中的任何工具：</p>
</blockquote>
<pre><code class="hljs language-python" lang="python">model_with_tools = model.bind_tools([tool_1], tool_choice=<span class="hljs-string">"tool_1"</span>)
</code></pre>
<h5 data-id="heading-15">并行工具调用</h5>
<blockquote>
<p>许多模型在适当的情况下支持并行调用多个工具。这使模型能够同时从不同来源收集信息。</p>
</blockquote>
<p>你留意到了吗？前面的<code>tool_calls</code>字段是一个数组，意味着可以调用多个工具。那么我们试一试下面的提问（只是把问题改了，看下结果）：</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-string">"请分析罗小黑电影的正面评论原因和负面评论原因？"</span>
</code></pre>
<p>现在问题同时包含“正面原因分析”和“负面原因分析”，LLM会调用两次工具 分别查询出正面评论和负面评论吗？</p>
<p>结论：会。</p>
<p>回答结果如下：</p>
<pre><code class="hljs language-shell" lang="shell">基于获取的评论数据，我来为您分析罗小黑电影的正面和负面评论原因：
<span class="hljs-meta prompt_">
#</span><span class="bash"><span class="hljs-comment"># 正面评论的主要原因：</span></span>
... 
<span class="hljs-meta prompt_">
#</span><span class="bash"><span class="hljs-comment"># 负面评论的主要原因：</span></span>
...
</code></pre>
<h5 data-id="heading-16">流工具调用</h5>
<p>这里直接贴出官方的例子吧~</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">for</span> chunk <span class="hljs-keyword">in</span> model_with_tools.stream(
    <span class="hljs-string">"What's the weather in Boston and Tokyo?"</span>
):
    <span class="hljs-comment"># Tool call chunks arrive progressively</span>
    <span class="hljs-keyword">for</span> tool_chunk <span class="hljs-keyword">in</span> chunk.tool_call_chunks:
        <span class="hljs-keyword">if</span> name := tool_chunk.get(<span class="hljs-string">"name"</span>):
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"Tool: <span class="hljs-subst">{name}</span>"</span>)
        <span class="hljs-keyword">if</span> id_ := tool_chunk.get(<span class="hljs-string">"id"</span>):
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"ID: <span class="hljs-subst">{id_}</span>"</span>)
        <span class="hljs-keyword">if</span> args := tool_chunk.get(<span class="hljs-string">"args"</span>):
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"Args: <span class="hljs-subst">{args}</span>"</span>)

<span class="hljs-comment"># Output:</span>
<span class="hljs-comment"># Tool: get_weather</span>
<span class="hljs-comment"># ID: call_SvMlU1TVIZugrFLckFE2ceRE</span>
<span class="hljs-comment"># Args: {"lo</span>
<span class="hljs-comment"># Args: catio</span>
<span class="hljs-comment"># Args: n": "B</span>
<span class="hljs-comment"># Args: osto</span>
<span class="hljs-comment"># Args: n"}</span>
<span class="hljs-comment"># Tool: get_weather</span>
<span class="hljs-comment"># ID: call_QMZdy6qInx13oWKE7KhuhOLR</span>
<span class="hljs-comment"># Args: {"lo</span>
<span class="hljs-comment"># Args: catio</span>
<span class="hljs-comment"># Args: n": "T</span>
<span class="hljs-comment"># Args: okyo</span>
<span class="hljs-comment"># Args: "}</span>
</code></pre>
<h4 data-id="heading-17">访问上下文</h4>
<p>试想一下，如果下面的<code>get_reviews</code>想要访问一些其他信息，这些信息又不应该暴露给LLM使用，那么如何处理呢？Langchain给出了答案：<code>ToolRuntime</code>。</p>
<pre><code class="hljs language-python;" lang="python;">@tool
def get_reviews(positive: bool) -&gt; list[str]:
	"""
	"""
	pass
</code></pre>
<p>其实很简单，就是给你定义的工具函数传入一个<code>ToolRuntime</code>的参数（句柄），这个句柄可以获取上下文信息。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-meta">@dataclass</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Context</span>:
    user_id: <span class="hljs-built_in">str</span>

<span class="hljs-meta">@tool</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">get_reviews_with_runtime</span>(<span class="hljs-params">
    positive: <span class="hljs-built_in">bool</span>, 
    runtime: ToolRuntime[Context] <span class="hljs-comment"># ToolRuntime 对模型不可见, 最终的实际tool 函数的参数不会包含runtime</span>
</span>) -&gt; <span class="hljs-built_in">list</span>[<span class="hljs-built_in">str</span>]:
    <span class="hljs-string">"""
    获取罗小黑电影评论列表
    Args:
        positive: 是否获取正面评论, True 表示获取正面评论, False 表示获取负面评论
    Returns:
        评论列表
    """</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"1.查看对话的状态"</span>)
    <span class="hljs-built_in">print</span>(runtime.state[<span class="hljs-string">"messages"</span>])
    <span class="hljs-comment"># [HumanMessage(content='请分析罗小黑电影的正面评论原因？'), IMessage(content='我来帮您获取罗小黑电影的正面评论并分析其中的原因。'), ...]</span>

    
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"2.借助user_id，可以查询user的个人信息"</span>)
    user_id = runtime.context.user_id
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"user_id: <span class="hljs-subst">{user_id}</span>"</span>)
    <span class="hljs-comment"># user_id: user123</span>

    <span class="hljs-built_in">print</span>(<span class="hljs-string">"3.在长任务中，使用stream_writer反馈进度，通常配合langgraph使用"</span>)
    writer = runtime.stream_writer
    writer({<span class="hljs-string">"status"</span>: <span class="hljs-string">"starting"</span>, <span class="hljs-string">"message"</span>: <span class="hljs-string">f"正在处理查询"</span>})
    writer({<span class="hljs-string">"status"</span>: <span class="hljs-string">"progress"</span>, <span class="hljs-string">"message"</span>: <span class="hljs-string">f"完成50%"</span>})
        
    <span class="hljs-comment">#...</span>
</code></pre>
<p>运行agent，调用工具，查看上下文信息打印。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">test_tool_runtime</span>():
    agent = create_agent(
        model,
        tools=[get_reviews_with_runtime],
        context_schema=Context,
    )
    result = agent.invoke(
        {<span class="hljs-string">"messages"</span>: [{<span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"请分析罗小黑电影的正面评论原因？"</span>}]},
        context=Context(user_id=<span class="hljs-string">"user123"</span>)
    )
</code></pre>
<h2 data-id="heading-18">附录</h2>
<h3 data-id="heading-19">代码 - 传送门</h3>
<p>本章节对应的代码：</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Ffkcaikengren%2Flangchain-tutorials%2Ftree%2Fmain%2Flangchain_py%2Fapp%2F2" target="_blank" title="https://github.com/fkcaikengren/langchain-tutorials/tree/main/langchain_py/app/2" ref="nofollow noopener noreferrer">langchain_py 篇2</a></p>
<h3 data-id="heading-20">系列 - 传送门</h3></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[拒绝 AI 写“烂代码”：深度解读 antfu/skills 与前端 AI 的新范式]]></title>    <link>https://juejin.cn/post/7600380007885897778</link>    <guid>https://juejin.cn/post/7600380007885897778</guid>    <pubDate>2026-01-29T05:51:51.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600380007885897778" data-draft-id="7600370554069401626" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="拒绝 AI 写“烂代码”：深度解读 antfu/skills 与前端 AI 的新范式"/> <meta itemprop="keywords" content="前端,Vue.js"/> <meta itemprop="datePublished" content="2026-01-29T05:51:51.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="皮蛋小精灵"/> <meta itemprop="url" content="https://juejin.cn/user/219558056559278"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            拒绝 AI 写“烂代码”：深度解读 antfu/skills 与前端 AI 的新范式
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/219558056559278/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    皮蛋小精灵
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-29T05:51:51.000Z" title="Thu Jan 29 2026 05:51:51 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>最近，Vue/Vite 核心成员 Anthony Fu 发布了 <code>antfu/skills</code> 项目，引发了社区热议。这不仅是一个新工具，更标志着 AI 辅助编程正在从“通用大模型”向“精细化上下文管理”转型。本文将带你了解什么是 AI Skills，以及它为何能解决 AI 写过时代码的痛点。</p>
<hr/>
<p>在 AI 辅助编程（AI Coding）日益普及的今天，我们经常遇到一个尴尬的场景：你让 ChatGPT 或 Cursor 写一个 Vue 组件，它却给你吐出了一段 Vue 2 的 Options API 代码，或者使用了一些两年前就已经废弃的配置写法。</p>
<p>为什么会这样？因为大模型是基于历史数据训练的，它不懂“最新”，也不懂“最佳实践”。</p>
<p>最近，前端圈的一个新名词 <strong>"Skills"</strong> 开始频繁出现，特别是 Anthony Fu 发布的 <strong><code>antfu/skills</code></strong> 项目，正是为了解决这个问题而生。</p>
<h2 data-id="heading-0">什么是 AI 的 "Skills"？</h2>
<p>在 AI Agent（智能体）的语境下，大模型（LLM）被视为大脑，而 <strong>Skills（技能）</strong> —— 有时也被称为 Tools（工具）或 Context（上下文）—— 则是它的外挂知识库和手脚。</p>
<p>如果不加干预，AI 就像一个虽然博学但仅仅读过 2023 年之前旧书的程序员。</p>
<p><strong>Skills 的作用，就是把最新的“参考手册”和“操作指南”塞给 AI。</strong></p>
<h2 data-id="heading-1">为什么我们需要 <code>antfu/skills</code>？</h2>
<p>虽然我们可以通过 Prompt（提示词）告诉 AI “请使用 Vue 3.5 的写法”，但这非常依赖开发者个人的 Prompt Engineering 能力。</p>
<p><code>antfu/skills</code> 的核心价值在于：<strong>它是由框架作者维护的标准答案。</strong></p>
<h3 data-id="heading-2">1. 解决“版本时差”问题</h3>
<p>AI 最容易犯的错误就是“幻觉”和“过时”。Anthony Fu 的这个项目通过自动化脚本，从 <strong>Vue, Nuxt, Vite, Vitest</strong> 等官方文档中抓取最新的核心概念和 API 变动。</p>
<p>当你向 AI 注入这个 Skill，它瞬间就从“凭借旧印象写代码”变成了“看着最新官方文档写代码”。</p>
<h3 data-id="heading-3">2. 也是一种 Opinionated（独断）的最佳实践</h3>
<p>除了官方文档，该项目还包含了一个 <code>antfu</code> 专属 Skill。这是 Anthony Fu 基于维护数十个开源项目的经验，总结出的一套高效开发流：</p>
<ul>
<li>如何配置最高效的 ESLint 规则？</li>
<li>如何使用 UnoCSS 进行原子化开发？</li>
<li>目录结构应该如何组织？</li>
</ul>
<p>通过使用这个 Skill，你可以让 AI 直接复刻顶尖开发者的工程化思维。</p>
<h2 data-id="heading-4">技术原理：MCP 与上下文工程</h2>
<p><code>antfu/skills</code> 的出现并非偶然，它背后对应的是 <strong>MCP (Model Context Protocol)</strong> 协议的兴起。</p>
<ul>
<li><strong>过去</strong>：我们需要手动把文档复制粘贴给 ChatGPT。</li>
<li><strong>现在</strong>：通过 <code>npx skills</code> 命令行工具生成 Prompt。</li>
<li><strong>未来 (MCP)</strong> ：你的 IDE（如 Cursor, Windsurf）将原生支持 MCP 协议。你只需要在设置里勾选“Vue Skills”，IDE 就会自动连接到这个知识库。</li>
</ul>
<p>这意味着，以后“如何写出高质量代码”的 Prompt，不再需要我们自己去摸索，而是由开源库的作者直接提供。</p>
<h2 data-id="heading-5">实际使用场景</h2>
<p>虽然该项目还在早期阶段，但我们已经可以这样利用它：</p>
<ol>
<li>
<p><strong>生成高质量配置</strong>：</p>
<p>当你需要初始化一个 Vite + Vue + TS 项目时，使用 Skill 生成的配置，一定是目前最符合生态标准的，没有任何过时依赖。</p>
</li>
<li>
<p><strong>代码审查 (Code Review)</strong> ：</p>
<p>你可以将 <code>antfu/skills</code> 的规则作为系统提示词（System Prompt），让 AI 检查你的现有代码：“根据这些最佳实践，我的代码有什么可以优化的地方？”</p>
</li>
<li>
<p><strong>学习最新特性</strong>：</p>
<p>甚至不需要写代码，你可以直接问 AI：“根据 Vue Skill，3.5 版本引入的 <code>useTemplateRef</code> 和旧的 <code>ref</code> 有什么区别？” AI 会基于最新的上下文给你准确解答。</p>
</li>
</ol>
<h2 data-id="heading-6">总结</h2>
<p><code>antfu/skills</code> 的发布释放了一个重要信号：<strong>Prompt Engineering（提示词工程）正在转变为 Context Engineering（上下文工程）。</strong></p>
<p>未来的开发者可能不再需要背诵复杂的 API，也不需要费尽心思去调教 AI。我们只需要选择合适的 <strong>Skills</strong> —— 就像给游戏角色装备不同的技能卡片一样 —— 就能让通用的 AI 瞬间变身为特定领域的资深专家。</p>
<p>对于 Vue/Vite 生态的开发者来说，这无疑是一个必须关注的利器；而对于其他领域的开发者，这也预示着一种全新的 AI 协作模式即将到来。</p>
<hr/>
<p><em>项目地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fantfu%2Fskills" target="_blank" title="https://github.com/antfu/skills" ref="nofollow noopener noreferrer">github.com/antfu/skill…</a></em></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[JustGRPO：扩散语言模型的极简主义回归]]></title>    <link>https://juejin.cn/post/7600326947505930292</link>    <guid>https://juejin.cn/post/7600326947505930292</guid>    <pubDate>2026-01-29T05:52:16.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600326947505930292" data-draft-id="7600341731047030819" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="JustGRPO：扩散语言模型的极简主义回归"/> <meta itemprop="keywords" content="人工智能,OpenAI"/> <meta itemprop="datePublished" content="2026-01-29T05:52:16.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="机器之心"/> <meta itemprop="url" content="https://juejin.cn/user/1873223543167902"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            JustGRPO：扩散语言模型的极简主义回归
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1873223543167902/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    机器之心
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-29T05:52:16.000Z" title="Thu Jan 29 2026 05:52:16 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>扩散语言模型（Diffusion LLMs, dLLMs）因支持「任意顺序生成」和并行解码而备受瞩目。直觉上，打破传统自回归（AR）「从左到右」的束缚，理应赋予模型更广阔的解空间，从而在数学、代码等复杂任务上解锁更强的推理潜力。</p>
<p>然而，本研究揭示了一个反直觉的现实：当前的任意顺序生成，反而通过「规避不确定性」收窄了模型的推理边界。</p>
<p>基于此，本文提出了一种回归极简的方法——JustGRPO。实验表明，在 RL 阶段让模型自回归生成，并直接用标准的 GRPO 进行训练，即可超越当前各类针对 dLLM 设计的 RL 算法表现。更重要的是，这种训练方式在提升推理表现的同时，并未牺牲 dLLM 引以为傲的并行解码能力。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4ed42f013b4d473e9873b77ecd77013e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770270738&amp;x-signature=oZtS8LMO8qmnbAROCjZ85He6bgs%3D" alt="图片" loading="lazy"/></p>

<ul>
<li>论文标题：The Flexibility Trap: Why Arbitrary Order Limits Reasoning Potential in Diffusion Language Models</li>
<li>论文链接：<a href="https://link.juejin.cn?target=https%3A%2F%2Fhuggingface.co%2Fpapers%2F2601.15165" target="_blank" title="https://huggingface.co/papers/2601.15165" ref="nofollow noopener noreferrer">huggingface.co/papers/2601…</a></li>
<li>项目主页：<a href="https://link.juejin.cn?target=https%3A%2F%2Fnzl-thu.github.io%2Fthe-flexibility-trap" target="_blank" title="https://nzl-thu.github.io/the-flexibility-trap" ref="nofollow noopener noreferrer">nzl-thu.github.io/the-flexibi…</a></li>
<li>论文代码：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FLeapLabTHU%2FJustGRPO" target="_blank" title="https://github.com/LeapLabTHU/JustGRPO" ref="nofollow noopener noreferrer">github.com/LeapLabTHU/…</a></li>
</ul>
<h3 data-id="heading-0">「灵活性陷阱」：</h3>
<h3 data-id="heading-1">为什么选择多反而考不好？</h3>
<p>为了探究「灵活性是否等同于推理潜力」，本文引入了 Pass@k 作为核心衡量指标。该指标量化了在 k 次采样中至少生成一个正确答案的概率，能够有效反映模型解空间的覆盖广度以及 RL 训练可激发的推理潜力上限（Yue et al., 2025）。</p>
<p>对比实验涵盖了两种主要的解码模式：</p>
<ul>
<li>
<p><strong>任意顺序（Arbitrary Order）</strong> ：允许模型根据置信度动态选择生成顺序，这是扩散语言模型的标准解码方式。</p>
</li>
<li>
<p><strong>AR 顺序（AR Order）</strong> ：约束模型遵循传统 LLM 从左到右的生成顺序。</p>
</li>
</ul>
<p>实验结果揭示了一个值得深思的趋势：虽然任意顺序在 k=1 时表现尚可，但随着采样次数 k 的增加，AR 顺序的 Pass@k 曲线不仅攀升速率更快，且最终达到的上限显著更高。这表明，在涉及复杂推理时，AR 顺序实际上可帮助模型覆盖更广阔的正确解空间。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1be1394657f14ab8a1c4bc5358d39732~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770270738&amp;x-signature=1hmZGXsmOgZp6Qx6O6sPJAlRiFg%3D" alt="图片" loading="lazy"/></p>
<p>图：限制 dLLM 使用标准的 AR 顺序，反而比灵活的任意顺序拥有更高的推理上限。</p>
<h3 data-id="heading-2">熵坍塌现象</h3>
<h3 data-id="heading-3"/>
<p>为何看似受限的 AR 顺序反而更具潜力？这与两种顺序如何处理不确定性有关。</p>
<p>在自回归模式下，模型被迫直面第一个未知 Token；而在任意顺序模式下，模型则有跳过（bypass）当前不确定 Token、优先填充后续更确定的内容的「特权」。统计显示，被频繁跳过的往往是诸如「Therefore」、「Thus」、「To」等逻辑衔接词（下图左）：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ec64900df09e44c5a6cee273bfeabc8e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770270738&amp;x-signature=ZQLwEXE1hzKiGPX64wr0quFYSG8%3D" alt="图片" loading="lazy"/></p>
<p>图左：任意顺序下，模型倾向于跳过不确定token而先填后续token，且这些被跳过的token往往是一些逻辑衔接词；图右：这些逻辑衔接词解码时的entropy显著低于自回归顺序（虚线代表average token entropy）。以上结果为LLaDA-Instruct在MATH-500数据集的结果。</p>
<p>已有工作（Wang et al., 2025）表明，这些逻辑衔接词往往起到通往不同推理路径的功能，且将这些词保持高熵状态对模型探索丰富的解空间至关重要。而在任意顺序下，这些衔接词被解码时的熵（Entropy）显著低于自回归顺序（上图右）。</p>
<p>我们将这种现象称为「熵降级」（Entropy Degradation）。形象地说，模型利用了任意顺序的灵活性进行了一种「局部贪婪优化」：它跳过了艰难的推理决策点，试图通过先生成后续上下文来「凑」出逻辑连接。虽然这在单次生成中可能有效，但却牺牲了对多样化推理路径的有效探索。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b6b78b1bfa6f4e43bbc7777a6f945285~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770270738&amp;x-signature=k6k%2FaSm6xK%2BBCdvI8ppircM8KgM%3D" alt="图片" loading="lazy"/></p>
<p>图：任意顺序生成倾向于绕过高熵的逻辑连接词，导致解空间过早坍缩。</p>
<h3 data-id="heading-4">返璞归真：</h3>
<h3 data-id="heading-5">JustGRPO</h3>
<p>既然「任意顺序」反而可能限制推理路径的探索，本文提出了一种回归极简的方法——JustGRPO。不同于现有 RL 算法，JustGRPO 不再试图用各种近似处理以显式保留任意顺序特性，而是选择了一条更为彻底的路径：</p>
<p>在 RL 训练阶段，直接摒弃对任意顺序的执念，强制扩散语言模型采用自回归（AR）顺序生成。这样不仅保持了更广阔的推理路径，同时也让我们得以直接复用成熟的 GRPO 算法进行优化。这种「生成轨迹的确定性」也自然使得强化学习时的信用分配（Credit Assignment）更加清晰，有助于模型更有效地学习鲁棒的联合分布。</p>
<p>值得一提的是：<strong>「训练时的约束」≠「推理时的退化」</strong>。</p>
<p>自回归的约束仅存在于训练阶段。它的目的是为了让模型更有效地进行 RL 阶段的探索与信用分配，模型本身的双向注意力机制并未被破坏。一旦训练完成，我们依然可以在推理阶段无损地应用并行解码，在享受 AR 训练带来的更优推理表现的同时，保留扩散模型引以为傲的生成速度。</p>
<h3 data-id="heading-6">实验结果：</h3>
<h3 data-id="heading-7">简单，但极其有效</h3>
<h4 data-id="heading-8">性能大幅提升</h4>
<p>在数学推理和代码生成这两类通用的推理任务上，JustGRPO 均有优秀的表现：</p>
<ul>
<li>
<p><strong>数学推理</strong>：在 GSM8K 和 MATH-500 上，模型展现了极高的推理上限，准确率最高分别可达 89.8% 和 45.2%，相比之前的最佳方法（SPG）显著提升。</p>
</li>
<li>
<p><strong>代码生成</strong>：在 HumanEval 与 MBPP 数据集上，准确率分别达到 49.4% 和 52.4%。</p>
</li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cb6dbf83a2354e1eaad638958a270bd6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770270738&amp;x-signature=sJku5l4iCi7OzXTvFHYMDA0YE54%3D" alt="图片" loading="lazy"/></p>
<p>表：JustGRPO在多个基准测试中超越了现有的 dLLM 强化学习方法，基座模型：LLaDA-Instruct。注：LLaDA-1.5使用了大规模私有数据集训练、LLaDOU在训练中引入了额外模块，因此未列入对比。</p>
<h4 data-id="heading-9">并行能力不仅没丢，还更强了</h4>
<p>一个可能的担忧是：用 AR 方式训练是否会让 dLLM 退化，失去其并行优势？实验结果恰恰相反。使用现成的 training-free 并行采样器（Ben-Hamu et al., 2025），JustGRPO 训练后的模型在并行解码下表现更佳。例如在 MBPP 数据集上，当每步并行解码 5 个 Token 时，JustGRPO 相比基座模型（LLaDA-Instruct）的准确率优势从单步的 10.6% 扩大到了 25.5%。</p>
<p>这表明训练后的模型学到了更鲁棒的联合分布，使其更能适应并行采样过程中的近似误差。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4931ac51e437477d8a2d4aae670f28c0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770270738&amp;x-signature=ZnMNR1K98j9fnVCJACd4f%2B7XR3E%3D" alt="图片" loading="lazy"/></p>
<p>图：JustGRPO 训练后的模型在并行解码时表现出更好的速度-精度权衡。</p>
<h3 data-id="heading-10">结语：</h3>
<h3 data-id="heading-11">少即是多</h3>
<p>这篇工作挑战了该领域的一个普遍假设，即「必须在 RL 中保留任意顺序灵活性」。事实证明，通过限制训练时的生成顺序，迫使模型直面逻辑分叉点的高不确定性，反而能更有效地激发 dLLMs 的推理潜能。</p>
<p>JustGRPO 以一种极简的方式，实现了推理能力的大幅提升，同时未牺牲扩散模型标志性的推理速度。也希望借此工作启发社区重新审视「任意顺序生成」在通用推理任务中的真实价值。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[SpringBoot开发者的5个痛点和解决方案，第3个90%的人都遇到过！]]></title>    <link>https://juejin.cn/post/7600342201793642511</link>    <guid>https://juejin.cn/post/7600342201793642511</guid>    <pubDate>2026-01-29T04:20:27.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600342201793642511" data-draft-id="7600342201793626127" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="SpringBoot开发者的5个痛点和解决方案，第3个90%的人都遇到过！"/> <meta itemprop="keywords" content="后端,前端,人工智能"/> <meta itemprop="datePublished" content="2026-01-29T04:20:27.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="阿橙的百宝箱"/> <meta itemprop="url" content="https://juejin.cn/user/1638743356481367"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            SpringBoot开发者的5个痛点和解决方案，第3个90%的人都遇到过！
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1638743356481367/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    阿橙的百宝箱
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-29T04:20:27.000Z" title="Thu Jan 29 2026 04:20:27 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0"><strong>SpringBoot开发者的5个痛点和解决方案，第3个90%的人都遇到过！</strong></h2>
<h3 data-id="heading-1">引言</h3>
<p>SpringBoot作为Java生态中最流行的框架之一，凭借其"约定优于配置"的理念和强大的自动化能力，极大地简化了企业级应用的开发。然而，在实际开发中，开发者仍然会遇到许多令人头疼的问题。这些问题可能来自框架本身的设计、依赖管理的复杂性，或是生产环境中的性能调优。本文将深入探讨SpringBoot开发者的5个常见痛点，并提供切实可行的解决方案。其中第3个问题——"依赖冲突"，据统计90%的开发者都曾遇到过！</p>
<hr/>
<h3 data-id="heading-2">1. 配置文件的混乱管理</h3>
<h4 data-id="heading-3">痛点描述</h4>
<p>SpringBoot支持多种配置文件（如<code>application.yml</code>、<code>application.properties</code>），但在多环境（dev/test/prod）下，配置文件的管理容易变得混乱。例如：</p>
<ul>
<li>不同环境的配置分散在多个文件中，难以维护。</li>
<li>敏感信息（如数据库密码）硬编码在配置文件中，存在安全隐患。</li>
</ul>
<h4 data-id="heading-4">解决方案</h4>
<ol>
<li><strong>多环境配置分离</strong>：<br/>
使用<code>spring.profiles.active</code>指定环境，并通过<code>application-{profile}.yml</code>分离配置。例如：
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># application-dev.yml</span>
<span class="hljs-attr">server:</span>
  <span class="hljs-attr">port:</span> <span class="hljs-number">8080</span>
<span class="hljs-comment"># application-prod.yml</span>
<span class="hljs-attr">server:</span>
  <span class="hljs-attr">port:</span> <span class="hljs-number">80</span>
</code></pre>
</li>
<li><strong>敏感信息加密</strong>：<br/>
结合Spring Cloud Config和Vault工具实现配置加密，或使用Jasypt库：
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Bean</span>
<span class="hljs-keyword">public</span> StandardPBEStringEncryptor <span class="hljs-title function_">encryptor</span><span class="hljs-params">()</span> {
    <span class="hljs-type">StandardPBEStringEncryptor</span> <span class="hljs-variable">encryptor</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StandardPBEStringEncryptor</span>();
    encryptor.setPassword(<span class="hljs-string">"secure-key"</span>);
    <span class="hljs-keyword">return</span> encryptor;
}
</code></pre>
</li>
</ol>
<hr/>
<h3 data-id="heading-5">2. 启动速度缓慢</h3>
<h4 data-id="heading-6">痛点描述</h4>
<p>随着项目规模增长，SpringBoot应用的启动时间可能从几秒延长到几十秒甚至分钟级。主要原因包括：</p>
<ul>
<li>过多的自动配置类扫描（Auto-Configuration）。</li>
<li>依赖注入的Bean数量过多。</li>
</ul>
<h4 data-id="heading-7">解决方案</h4>
<ol>
<li><strong>延迟初始化（Lazy Initialization）</strong>：<br/>
在<code>application.yml</code>中启用延迟加载：
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">spring:</span>
  <span class="hljs-attr">main:</span>
    <span class="hljs-attr">lazy-initialization:</span> <span class="hljs-literal">true</span>
</code></pre>
注意：此方案可能导致首次请求响应变慢。</li>
<li><strong>排除不必要的自动配置</strong>：<br/>
通过<code>@SpringBootApplication(exclude)</code>禁用特定自动配置类：
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@SpringBootApplication(exclude = {DataSourceAutoConfiguration.class})</span>
</code></pre>
</li>
</ol>
<hr/>
<h3 data-id="heading-8">3. 依赖冲突（90%的开发者遇到过！）</h3>
<h4 data-id="heading-9">痛点描述</h4>
<p>Maven或Gradle项目中，不同库引入的相同依赖版本不一致，导致运行时异常（如<code>NoSuchMethodError</code>或<code>ClassNotFoundException</code>）。例如：</p>
<ul>
<li>SpringBoot Starter Web和Spring Cloud Starter Feign引入的Jackson版本冲突。</li>
</ul>
<h4 data-id="heading-10">解决方案</h4>
<ol>
<li><strong>依赖树分析</strong>：<br/>
使用Maven命令定位冲突：
<pre><code class="hljs language-bash" lang="bash">mvn dependency:tree -Dverbose
</code></pre>
</li>
<li><strong>强制统一版本号</strong>：<br/>
在<code>pom.xml</code>中显式指定版本：
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">properties</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">jackson.version</span>&gt;</span>2.12.3<span class="hljs-tag">&lt;/<span class="hljs-name">jackson.version</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">properties</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">dependencyManagement</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.fasterxml.jackson.core<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>jackson-databind<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>${jackson.version}<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependencyManagement</span>&gt;</span>
</code></pre>
</li>
</ol>
<hr/>
<h3 data-id="heading-11">4. 性能监控与调优困难</h3>
<h4 data-id="heading-12">痛点描述</h4>
<p>生产环境中，应用可能出现内存泄漏、线程阻塞或数据库连接池耗尽等问题，但缺乏有效的监控手段定位根因。</p>
<h4 data-id="heading-13">解决方案</h4>
<ol>
<li><strong>集成Micrometer + Prometheus + Grafana</strong>：<br/>
通过Spring Boot Actuator暴露指标数据：
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">management:</span>
  <span class="hljs-attr">endpoints:</span>
    <span class="hljs-attr">web:</span>
      <span class="hljs-attr">exposure:</span>
        <span class="hljs-attr">include:</span> <span class="hljs-string">health,metrics,prometheus</span>
  <span class="hljs-attr">metrics:</span>
    <span class="hljs-attr">export:</span>
      <span class="hljs-attr">prometheus:</span>
        <span class="hljs-attr">enabled:</span> <span class="hljs-literal">true</span>
</code></pre>
</li>
<li><strong>APM工具集成</strong>：<br/>
使用SkyWalking或Elastic APM实现分布式追踪：
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Bean</span>
<span class="hljs-keyword">public</span> ElasticApmTracer <span class="hljs-title function_">apmTracer</span><span class="hljs-params">()</span> {
    <span class="hljs-keyword">return</span> ElasticApmTracer.Builder.create().build();
}
</code></pre>
</li>
</ol>
<hr/>
<h3 data-id="heading-14">5. Spring Boot版本升级兼容性问题</h3>
<h4 data-id="heading-15">痛点描述</h4>
<p>从低版本（如1.x）升级到高版本（如3.x）时，可能遇到以下问题：</p>
<ul>
<li>API废弃导致编译错误（如<code>JpaRepository#findOne</code>改为<code>findById</code>）。</li>
<li>Spring Security配置语法变更。</li>
</ul>
<h4 data-id="heading-16">解决方案</h4>
<ol>
<li><strong>逐步升级策略</strong>：<br/>
参考官方迁移指南（<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fspring-projects%2Fspring-boot%2Fwiki" target="_blank" title="https://github.com/spring-projects/spring-boot/wiki" ref="nofollow noopener noreferrer">Spring Boot Release Notes</a>），分阶段升级（如2.4 → 2.7 → 3.x）。</li>
<li><strong>自动化测试覆盖</strong>：<br/>
确保单元测试和集成测试覆盖率足够高，升级后立即运行测试验证兼容性。</li>
</ol>
<hr/>
<h3 data-id="heading-17">总结</h3>
<p>SpringBoot虽然极大提升了开发效率，但仍需开发者深入理解其底层机制以规避常见陷阱。本文提到的5个痛点——配置文件管理、启动速度、依赖冲突、性能监控和版本升级——涵盖了从开发到运维的全生命周期问题。尤其是依赖冲突问题，90%的开发者都会遇到！通过合理的工具链设计和最佳实践积累，这些问题完全可以被系统化解决。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item>  </channel></rss>