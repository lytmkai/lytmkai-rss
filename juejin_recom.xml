<?xml version="1.0" encoding="UTF-8"?><rss version="2.0">  <channel>      <title>掘金文章推荐</title>      <link>https://juejin.cn/recommended?sort=newest</link>      <description>一个帮助开发者成长的社区</description>      <generator>python juejin_recom.py @Pi20</generator>      <item>    <title><![CDATA[新的起点，新的期盼｜2025年终总结]]></title>    <link>https://juejin.cn/post/7594626381433159730</link>    <guid>https://juejin.cn/post/7594626381433159730</guid>    <pubDate>2026-01-13T10:09:30.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7594626381433159730" data-draft-id="7594482829755433006" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="新的起点，新的期盼｜2025年终总结"/> <meta itemprop="keywords" content="年终总结"/> <meta itemprop="datePublished" content="2026-01-13T10:09:30.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="文如秋雨"/> <meta itemprop="url" content="https://juejin.cn/user/3897092103223517"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            新的起点，新的期盼｜2025年终总结
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3897092103223517/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    文如秋雨
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-13T10:09:30.000Z" title="Tue Jan 13 2026 10:09:30 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读19分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#595959;font-size:15px;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(60,10,30,.04) 3%,transparent 0),linear-gradient(1turn,rgba(60,10,30,.04) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body p{color:#595959;font-size:15px;line-height:2;font-weight:400}.markdown-body p+p{margin-top:16px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin:0;color:#135ce0}.markdown-body h1{position:relative;text-align:center;font-size:22px;margin:50px 0}.markdown-body h1:before{position:absolute;content:"";top:-10px;left:50%;width:32px;height:32px;transform:translateX(-50%);background-size:100% 100%;opacity:.36;background-repeat:no-repeat;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC)}.markdown-body h2{position:relative;font-size:20px;border-left:4px solid;padding:0 0 0 10px;margin:30px 0}.markdown-body h3{font-size:16px}.markdown-body ul{list-style:disc outside;margin-left:2em;margin-top:1em}.markdown-body li{line-height:2;color:#595959}.markdown-body img.loaded{margin:0 auto;display:block}.markdown-body blockquote{background:#fff9f9;margin:2em 0;padding:2px 20px;border-left:4px solid #b2aec5}.markdown-body blockquote p{color:#666;line-height:2}.markdown-body a{color:#036aca;border-bottom:1px solid rgba(3,106,202,.8);font-weight:400;text-decoration:none}.markdown-body em strong,.markdown-body strong{color:#036aca}.markdown-body hr{border-top:1px solid #135ce0}.markdown-body pre{overflow:auto}.markdown-body code,.markdown-body pre{overflow:auto;position:relative;line-height:1.75;font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body table{border-collapse:collapse;margin:1rem 0;overflow-x:auto}.markdown-body table td,.markdown-body table th{border:1px solid #dfe2e5;padding:.6em 1em}.markdown-body table tr{border-top:1px solid #dfe2e5}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言</h2>
<p>2025 年好似做了一场梦。</p>
<p>梦里遍地闪烁着记忆的碎片，我赤脚前行，前面是一扇透着光半掩着的门，我伸出手想要去触摸它，但每走一步，脚底被碎片扎得生疼。我透过门缝看到了外面的世界，那是没有看过的景象，如莫奈的画一般的天空和云朵，暖风吹过绿色的斜坡草坪，几个模糊的身影浅笑着向我伸出了手，一切都是我憧憬的模样。</p>
<p>我忍着疼痛小步前行着，但越靠近着那扇通往新世界的门时，耳边传来了来自背后的声音，那是我熟悉的声音。我不敢回头，也知道不应该回头，我知道，背后的不是别人，而是过去的自己。</p>
<p>我终是走到了门前，握住了通往新世界的门把手，手掌传来了些许温暖，门外的阳光透过缝隙撒在手背上，泛起丝丝晶莹。</p>
<p>“我要往前走了。” 我对过去的自己说。</p>
<p>打开门拥抱阳光的那一刻，耳旁似乎听到一声告别。</p>
<p>“好，你一定要幸福。”</p>
<h2 data-id="heading-1">解构 2025</h2>
<p>1 年拆分出来，便是 12 个月，而按天拆分，也只是 36.5 个 10 天。浑浑噩噩是 1 天，开开心心也是 1 天，有所成就是 1 天，失落愤慨亦是 1 天。从朋友圈翻了翻 2025 年发生过的事，有故事，也有事故，有顺其自然，也有偶尔失控。</p>
<h3 data-id="heading-2">我&amp;鸿蒙</h3>
<p>最早在 23 年底了解鸿蒙开始，到 24 年认证成为华为开发者专家，再到 25 年线下线上的<strong>活动分享</strong>，我在鸿蒙布道这条路上跌跌荡荡走过许久。</p>
<p>2025 年发生的事情不多，3 月的ArkUI 案例分享，6 月的 HarmonyOS SDK AI开放能力分享，两场线下<strong>HDD活动</strong>，让鸿蒙布道成为了不错的开端。9 月上旬的两场<strong>线上直播</strong>，HarmonyOS 动画实战、HarmonyOS 动画与开源项目实践，则在 UI 的基础上揭示了人机交互的更多玩法。9 月下旬，<strong>华为全联接大会 2025</strong> 的 <strong>OpenSpeech</strong> 环节上，也有幸将自己的开源项目及其历程分享给更多的开发者朋友。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/343782038d3740a3b987493194c5f108~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paH5aaC56eL6Zuo:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768903769&amp;x-signature=WPVlbBmg8jxksNxj6mlxvmYUfu0%3D" alt="" loading="lazy"/></p>
<p>UI、动画、AI、开源，每一次分享都是新的主题，对我来说都需要重新接触、吸收、转化，最终输出。还记得第 1 次线上直播前试播时，对着写好的稿件念稿，眼神飘忽、语调乏味，到后面第 2 次直播的慷慨激昂，沉稳有序。而线下活动也不再畏畏缩缩，开始自信且坦然地讲述属于自己的故事，偶尔还能说几个段子让现场活跃起来。</p>
<blockquote>
<p>每一次新的尝试，都成为了宝贵的人生体验。</p>
</blockquote>
<p>如果说还有什么，是在编程和探索心之外激励着我不断在鸿蒙领域深耕，我想可能是正向反馈吧，那是在温饱之上的自我价值的实现。在 <strong>2025 底的鸿蒙人才布道师年度论坛</strong>上，当在大荧幕上看到自己的那一刻，激动的沉默胜过无数的言语。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/83b9ff68fece4bc0996f17dc602f53f0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paH5aaC56eL6Zuo:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768903769&amp;x-signature=X5Njyd4GqQNx%2FTbNVbO7HZWSeaw%3D" alt="" loading="lazy"/></p>
<p>鸿蒙，在中国古代哲学神话中指的是天地未开的混沌状态，既是起源，也是未来。很是神奇，懵懵懂懂就踏入了鸿蒙生态，随后尝试了很多以前从未做过的事情，也取得了不错的成就，当然，踩过的坑也只有自己知道。</p>
<p><strong>先开始，在不打乱日常生活方式的情况下进行创新和过渡</strong>，这可能是我在鸿蒙这里学到的最有用的道理。</p>
<h3 data-id="heading-3">我&amp; AI</h3>
<p>ChatGPT、Midjourney、Stable Diffusion 打开图文生成的潘多拉魔盒，到 Suno、Sora 的音乐视频惊艳亮相，到现在 Copilot、Cursor、TRAE、ClaudeCode、Gemini 席卷 AI 编程，以及像 DeepSeek、Kimi、豆包等 C 端产品深入人们的日常生活。每天，甚至有可能下一秒就有一个新的形态的 AI 产品曝光在大众视野。</p>
<p>这两年总是能听到或者看到 AI，或者 AI 工具层出不穷，好像不了解 AI 或者没有使用 AI 就会被社会立即淘汰。这有点像 03 年计算机出现那样，AI 企业喷涌而出然后快速消亡，自媒体充斥着焦虑和幻想，而普罗大众在这种氛围下选择了边卷边躺平，一片祥和又含带一丝诡异。</p>
<p>我最早接触 AI 也是从 ChatGPT 开始，方案文档的编写效率和质量，以及那打字机的对话交互方式，让我第一次有了像科幻电脑那样的人机交互的实感。随后在各类 AI 工具的“洗礼”下，我开始各种尝试和学习。非常幸运的是，最早接触的字节推出的 AI 编程工具 MarsCode 升级成为了 <strong>TRAE（The Real AI Engineer）</strong>，也让我有了深入了解 AI 编程领域的机会。</p>
<p>于是乎在 2000 多人的筛选下，我成为了深圳的<strong>TRAE Fellow</strong> 和<strong>TRAE Expert</strong>，开始从参加活动、出席活动到组织活动，在 25 年开始了新的尝试。10 月的 TRAE Friends 深圳场的 <strong>Meetup</strong>，11 月的TRAE Solo <strong>Hackathon</strong>，一下子从一个人的“单打独斗”转变成了与更多 AI 爱好者们一起探索和沟通，有点开启了打怪升级的新篇章。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8bfbb7977e79474494bebbfea8cbe2f8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paH5aaC56eL6Zuo:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768903769&amp;x-signature=UTsk5f1MiVB%2FP%2Fc5TykEuYdcna4%3D" alt="" loading="lazy"/></p>
<p>AI 给人们带来的，是实现梦想的可能，我一直秉承着的这个观点。当一项技术能够打破编程开发的门槛，让更多的初学者能用极少的代价来尽可能靠近自己想要的目标，我想这才是技术落地的价值。而在这个生态里，我想做的或者能做的，便是在持续学习的基础上，将自己过往所获得的经验和初心，以这样那样的方式去感染一些人。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9aad537d806d40cfa474cd241547d868~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paH5aaC56eL6Zuo:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768903769&amp;x-signature=vlRycY6f923R4sKciK4wS8nrN7E%3D" alt="" loading="lazy"/></p>
<p>其实最早 AI 也给我带来过焦虑，它让我过往可能学了几年的独立开发，无论是 iOS 还是鸿蒙的编程优势可能一下清零。但实际接触后会发现，AI 技术反而让我更专注于逻辑实现，而不是代码块本身，而逻辑实现本就是人的理性强项。</p>
<p>从命令式语法，到声明式语法，再到现在的<strong>自然语言编程</strong>，不会有人是仅仅为了代码语法好看而去学习编程，学习编程的目的，更多是为了创造出有趣好玩的作品，它可以是商业化的，也可以是为了让自己开心。</p>
<p>于是我开始了新的尝试，将自己灵感一现的想法，通过 <strong>VibeCoding</strong> 的方式呈现出来，算是在新的一年里探索一种新的路线吧～</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/16bd1c853eb1499cbed4066293296d8f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paH5aaC56eL6Zuo:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768903769&amp;x-signature=gZSayWNgauRbfsqrWUG95YENSqI%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-4">我&amp;工作</h3>
<p>年底收到 <strong>N+1</strong> 的那一刻，我和现在一样，很是坦然。</p>
<p>许是下半年业务找不到增长口，以及产品演进方向已然有点凌乱，或是在8月份一半同事转岗离开的征兆......一系列的变化让我已经为“最坏”的结果做准备。还记得那天和 LD 一起去和大老板聊的时候问我是什么想法，我心里空荡荡的，没有太多的情绪波动，后面甚至单独和大老板吃饭时问起我的想法时，我也说非常同意当前公司的决策。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6758663a5d83475890f614dbc9880b71~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paH5aaC56eL6Zuo:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768903769&amp;x-signature=rGHOsN91RpKKzSEgRIrmw12bJZ4%3D" alt="" loading="lazy"/></p>
<p>24 年初进入这家公司，从 0 开始了解海外旅游分销这个细分行业，并从 0 开始管理团队、搭建从前、中、后 3 端的系统，新的团队，新的行业，新的目标和展望，起初一切好像都往理想的方向演进。回过头来看，所有的美好都基于企业业绩的增长和平台依靠，而在其中有成长，也有遗憾。</p>
<p>在这份工作中，我遇到了一个很好的 LD，教会了我很多关于<strong>产品、开发、团队管理</strong>相关的技能，也让我对于产品开发有了一些不一样的理解。</p>
<p>产研团队就像是一架火车，前方是明确的目的地，位于火车头的<strong>产品经理</strong>提前规划好 1～2 个版本的迭代，并<strong>拉动着团队火车往前跑</strong>。位于中间车厢的<strong>开发工程师</strong>们负责拆解需求，稳定输出质量并按时交付，<strong>稳住中间开发阶段</strong>。而在尾节车厢的是<strong>测试工程师</strong>一方面需要对于交付结果进行检测，另一方面也需要紧抓时间节点、组织迭代复盘从而<strong>推着团队往前跑</strong>。由此，在敏捷开发的团队协作方式中，由产品、开发、测试所组成的 3 要素火车才能平稳运行。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4cc00a5204174d6bb06e1138f7f898dd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paH5aaC56eL6Zuo:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768903769&amp;x-signature=ZgMfIq5%2FDn1VGWQbr31lLggeX2A%3D" alt="" loading="lazy"/></p>
<blockquote>
<p>没有完美的团队和产研开发方式，所以最好的方式是让这架火车先按版本跑起来，再在每个版本中进行更新迭代，每次发现一个问题并解决，那么经过多个版本后，可能不断会有新的问题产生，但整个火车会持续往前跑，并且越发稳定。</p>
</blockquote>
<p>如果要说产品经理最重要的软技能是什么，可能标准回答有抽象能力、同理心、Owner思维等等，但现在我的回答是<strong>Balance（平衡）</strong>。在多角色协同的工作中，除了本身产研内部的产品需求与开发排期之间的 Gap 外，还有对于业务部门为开展业务而产生的诉求与产研开发交付的版本之间的 Gap、不同业务部门之间的理解和信息同步的Gap、自身所在的产研团队与其他开发团队之间的Gap.....一系列的 Gap，都需要中间的衔接者，或者项目的发起者去推动。</p>
<p>多人协同的 Gap 是无法被解决的，只能被<strong>管理和引导</strong>，比如通过 RICE 框架等方式对需求优化级进行量化并管理预期，通过可视化面板进行信息同步和飞书等消息机制进行有效通知来减少消息传递的失真，通过产研需求的预先方案技术评估与产品 Demo 的快速演示来提高沟通的效率和模式的快速模拟验证，通过简短且明确的会议拉通共识和对齐节奏....所有的方式和手段，都是为了让Gap 可控，在长期合作中磨合出人与人之间、系统与系统之间的节奏，这便是Balance。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cb8c1fcf784944b19ca0f26d733d9c8d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paH5aaC56eL6Zuo:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768903769&amp;x-signature=v9Mz%2BWDu9f2BvhIbVN4VFCSmEfU%3D" alt="" loading="lazy"/></p>
<p>最早 18 年第一次踏入产品经理岗位，一晃 7、8 年过去了，从企业团餐，到服装新零售，到海外旅游（用车），回头看一路都在ToB 领域围绕着「<strong>衣食住行</strong>」进阶和探索。最早设计单一的功能模块，到多个模块之间设计工作流程，到后来从 0 到 1 设计整个系统、多个系统，到现在为遵循<strong>第一性原理</strong>管理团队支撑业务，一切都很顺利，但一切都没那么顺畅。</p>
<p>职场有时候真的很奇怪，你得要有超出中高级产品的能力和技能、经验、背书，才能去应聘中高级产品，而不是像游戏一样升级打怪积累到一定水平就自动升级，而且这其中到底需要具备什么明确的条件也缺少能够明确量化的指标。</p>
<p>我的浅见是：<strong>能不能做、如何做</strong>是第 1 步，这考察的是借助方法论和软硬技能来执行和达成既定结果。<strong>如何科学评估，如何做好，在现有资源做出合适的流程或产品设计</strong>，这考察的是对复杂事物的解构和推动，对结果负责，这是第 2 阶段。</p>
<p><strong>能不能持续稳定地创造价值，在不确定性的系统中做出决策从而不断靠近目标</strong>，这考察的是对于人-事-资源的深入思考。</p>
<p>在这个大的方向下，定义需要被管理的目标、承担责任进行决策、构建科学的产品运转的工作流程、根据商业模式和业务开展的不同阶段构建可升级的产品形态，从而创造<strong>可持续</strong>的价值，我认为这才是第 3 阶段。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d3ce6be2f1384e158e81e3bdeed57dc4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paH5aaC56eL6Zuo:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768903769&amp;x-signature=84FqmcWO8k2jPA82U%2B7QH%2BkkR9A%3D" alt="" loading="lazy"/></p>
<p>每次停下来的时候，我都会思考一个问题：产品、技术，我到底适合哪一个方向？每一次我都选择了产品这条路，真的好奇怪，我的底气到底在哪？也许是当初 8 年多以前在思维导图上<strong>解构自我</strong>的时候发现贴切这个岗位，也或许是在这个岗位和职业生涯中总是能找到<strong>激励</strong>我前进和学习的地方，又或许是底子里我想做出一些成就来<strong>实现自我价值</strong>的升华，而产品经理是最接近的最优选择。</p>
<p>都或许吧，在技术能力、AI 的加持下，没准我能更靠近想要的目标，去发现我心底里真正想做的事情。</p>
<h3 data-id="heading-5">我&amp; TA</h3>
<p>这是我在 25 年挺敏感的一个话题，一段话概述便是：<strong>和谈了 5 年的前对象在年中分开了，遇见了一些很好的新朋友，拥有了现在的她。</strong></p>
<p>分开是在 25 年 5 月份，她 5.1 从云南回来，很认真和我说我们分开吧，随后和平分手、退家庭群、搬家，到后面断了联系再也不见。我身边所有的朋友、家人都很不理解，也很难接受，为什么两人就这么分开了？但可能只有我们才知道，我们已经无法一起面对未来了。我们的期待不同，我们想要的未来逐渐清晰，只是在那个未来里，不再需要对方了。</p>
<blockquote>
<p>人生无常，大肠包小肠。</p>
</blockquote>
<p>不良习惯（比如吸烟）不是问题关键，说好了戒烟却做不到的失信，才是信任感流失、两人开始渐行渐远的本质；工作生活的焦虑也不是双方沟通的阻碍，而是宁愿一个人逃避，也不愿和对方诉说的封闭，慢慢将两人的边界画得越发清晰；纪念日等重要时刻的缺席也不是感情崩塌的主要原因，一次次委屈瞬间的故意无视，消耗了仅存的温情，最后才是，失望，离开。</p>
<p>我经常和别人说：</p>
<blockquote>
<p>两个人在一起的前提，是本来一个人就过得很好，因为两个人在一起能过得更好，所以才在一起。如果没有办法给对方幸福，就不要阻挡对方追求幸福的权利。</p>
</blockquote>
<p>如今，这一点切切实实体现在了我身上。</p>
<blockquote>
<p>感谢你陪我走过的这一段路，祝你往后幸福，无论发生什么事仍然有勇气去追寻你想要的生活，谢谢你。</p>
</blockquote>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/65527b3bd5d94c19aedff274f28be9cf~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paH5aaC56eL6Zuo:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768903769&amp;x-signature=151VCkI8NwRFgsczayJof3viap8%3D" alt="" loading="lazy"/></p>
<p>你说在偶然间遇到一个人，然后一起去看电影，最后成为很好的朋友，这概率有多大？我想不到 1/1000 吧。</p>
<p>在 7、8 月有些消沉的那段时间，我一个人在新开的游戏厅玩 Switch 游戏（星之卡比），突然有个人走过来，然后我鬼使神差地问：要一起玩不？然后他伸出了手，我俩握了握手正式认识，后面这个人说上面电影院在放《<strong>小王子</strong>》的重映要不要去看，我也刚好空闲就一起去了，到后面相处多了，聊的越来越多，成为了很好的朋友。</p>
<p>好奇怪，就这么神经地认识了老庄这么个朋友，很可惜这家伙不是个女的，MD。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b1e59bc785f24a2a9a3a1f635dcbaf31~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paH5aaC56eL6Zuo:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768903769&amp;x-signature=mSRHUKAamAQ7gxt%2FzRZvppVJDio%3D" alt="" loading="lazy"/></p>
<p>老庄和我虽然有相似的地方，但性格完全相反，思维总是跳跃到不行，看到我怂怂的总是想怂恿我去做一些“破界”的事情，比如一起坐在牌坊的台阶上喝着柠檬茶光明正大看美女（以前我都是偷偷瞄一下），比如带我去酒吧喝酒点陪聊（就经历过那么一次，我怂到不行，装得贼正经），还有怂恿我去追喜欢的女孩子（后面我还追成了，在此谢过义父）....</p>
<blockquote>
<p>“你好不容易选择走出来，还想着过去？你都开始有新的生活，为什么还要陷到过去的情绪，你在害怕什么？”</p>
</blockquote>
<blockquote>
<p>“兄弟就是这样的，开心也要分享，不开心也要分享，有时候别一个人想事情，多出来走走。”</p>
</blockquote>
<blockquote>
<p>“你没有办法讨好所有人，你需要做的是讨好自己。”</p>
</blockquote>
<blockquote>
<p>“因为同频，所以共振，所以我们一起行，也一定行。”</p>
</blockquote>
<p>从刚开始聊天老庄整天像心理医生那样剖析我的心理状态，拉着我从泥潭走了出来，到现在隔三差五我会去找他瞎逼逼，老庄这家伙真是个很好的人，挺庆幸遇到个这样个朋友，敬兄弟一杯～</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/45d37b1b21a94c04a5803b49f30a9073~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paH5aaC56eL6Zuo:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768903769&amp;x-signature=pmneoQG%2Bzjympa7qq%2FbGee%2FVeLA%3D" alt="" loading="lazy"/></p>
<p>本来以为自己就会这样单着一直到 26 年甚至更久，没想到遇到了<strong>乖宝</strong>。</p>
<p>许是我失眠抑郁那段时间送来的维生素 B6，许是那吵吵闹闹的性格叫醒了躲在角度暗自神伤的我，许是一次次的聊天让我看到了一个真实且不一样的女孩子，许是初次见面时的自然而然的相处、牵手，许是不经意间觉察到那白雪般的皮肤在阳光下晶莹透亮，许是 11 月浏阳夜晚的烟花太过于梦幻，许是一次次的从深圳到北京跨越 1500 公里的追寻.....</p>
<p>这一切发生都太过于突然，突然到每次想到我和<strong>乖宝</strong>在一起这件事都有些不真实。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2fe395e7715d4de1922d50889627d146~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paH5aaC56eL6Zuo:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768903769&amp;x-signature=lR4Fwz5wgdOJX%2FY0vlr717SWtZQ%3D" alt="" loading="lazy"/></p>
<p>爱情，对这个时代来说真的很奢侈，我们想要的东西太多太多，就导致很多东西就变得没那么纯粹了，于是我们不敢走出舒适圈，不敢去相信人，不敢去接触新的事物。而当我们真的打破了固有的思维和封闭圈时，会发现外面并没有别人，都是自我的设限和想象罢了。</p>
<p>我不知道以后会是什么样子，但我想和乖宝一起尝试一起面对，尽管我有很多不足，也没啥底气，但我想试试，去体验下不一样的事物，去看一看我未曾看过的世界。</p>
<h2 data-id="heading-6">2026，新的期盼</h2>
<p>新的一年新的开始，从 1 月开始就遇到了好多事情，但对好多事情都提不起太高的兴趣，也许是还没有整理好自己，于是就有了这篇年终总结，我想先整理好自己，再去做好新一年的规划。</p>
<p>2026 年，我 30 岁了，外表看起来还是有点没长大的样子，说不上成熟，也谈不上成功。所幸的是，没有发福，没有秃顶，没有堕落躺平，仍然对<strong>爱情、生活、工作、学历</strong>有所憧憬，所以不断学习和努力着。</p>
<p>很幸运，遇到了合适的<strong>她</strong>，希望在这一年中能够开心相处并走向婚姻，我仍然对于婚姻充满着期待。</p>
<p>过往我所拥有的技能和知识，<strong>iOS、鸿蒙、AI Coding</strong>，我希望能够将三者结合起来，不再在 3 个领域分别钻研，而是找到一个合适的入口，比如小红书、B 站、图书出版等，来做知识储备和内容输出，希望在不断发展的 AI 时代中找到属于自己定位。</p>
<p>工作可能也不着急先，过往着急工作了 8 年，下一个职场或者说下一个赛道，在这个阶段真的要好好想想。什么行业、什么领域、什么岗位、做什么事情、达成什么目标、想要达成什么成就，这些都需要静下来好好想想。没准这是我职场的最后一份工作，<strong>选择大于努力</strong>的道理还是深刻了解的。</p>
<p>学历这块一直是我的短板，去年总算通过了所有的理论课，今年就差 1 门实践课、毕业论文、学位英语。自考本科考完后就要准备<strong>考研</strong>了，对于一件事情祛魅的最好方法，就是拥有它。</p>
<p>感觉要求好像有点多，慢慢来呗～</p>
<h2 data-id="heading-7">尾言</h2>
<p>5 年前，我应该想不到现在的我会经历那么多，拥有那么多，所以 5 年前的我的期望，我达成了吗？</p>
<p>如果能和 5 年前的我说说话，我可能想说：</p>
<blockquote>
<p>你绝对想不到你现在有多厉害，你真的很棒，你真的超级努力的，这一切都是值得的。</p>
</blockquote>
<p>这个世界的变化真的超出你的想象，你不知道 AI 发展有多快，你不知道这个世界到处都在打仗，就我们老是外卖大战。你不知道你遇到了很多很好的人，你不再是一个人去面对这一切，你开始变得更好了。</p>
<p>5 年前的我啊，你放心哈，现在的我过得很好，虽然有很多意想不到的事情，但一切都还顺利，而且你还在不断进步和向前，还是笨笨地探索，虽然走得有点慢，但走得很踏实和开心，这一点很了不起哒！</p>
<p>放心吧，往后的路，就交给我，我会连带着你的希冀一起前行，去追寻属于自己的幸福。</p>
<p><strong>愿一切安好，愿归来仍是少年，共勉之～</strong></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[npm 2026安全新规下的免登录发包策略]]></title>    <link>https://juejin.cn/post/7594678044263497728</link>    <guid>https://juejin.cn/post/7594678044263497728</guid>    <pubDate>2026-01-13T10:13:19.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7594678044263497728" data-draft-id="7594678044263464960" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="npm 2026安全新规下的免登录发包策略"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2026-01-13T10:13:19.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="风度前端"/> <meta itemprop="url" content="https://juejin.cn/user/3368559359562190"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            npm 2026安全新规下的免登录发包策略
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3368559359562190/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    风度前端
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-13T10:13:19.000Z" title="Tue Jan 13 2026 10:13:19 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>这些天开源了一个自己平常使用的<code>uni-app</code>路由框架（详见<a href="https://juejin.cn/post/7594262760939749410" target="_blank" title="https://juejin.cn/post/7594262760939749410">用了都说好的 uniapp 路由框架</a>），在发布 npm 包的时候遇到了一些问题，去年写过一篇文章<a href="https://juejin.cn/post/7453304066451669011#heading-3" target="_blank" title="https://juejin.cn/post/7453304066451669011#heading-3">使用npm发布自己的第一个包</a>，当时发布包开启 2fa 验证后通过指纹验证就可以了，但是在发布 caring-route 的包时发现旧有的方式失效了，使用 npm login 时会产生这个提示，然后需要输入用户名、密码，邮箱，2fa 验证码，颇为麻烦：</p>
<pre><code class="hljs language-vbnet" lang="vbnet">npm notice Security Notice: Classic tokens have been revoked. Granular tokens are now limited <span class="hljs-keyword">to</span> <span class="hljs-number">90</span> days <span class="hljs-built_in">and</span> require <span class="hljs-number">2</span>FA <span class="hljs-keyword">by</span> <span class="hljs-keyword">default</span>. Update your CI/CD workflows <span class="hljs-keyword">to</span> avoid disruption. Learn more https://gh.io/all-npm-classic-tokens-revoked
</code></pre>
<p>结合在 npm 官网看到的置顶提示：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c5a10ffb5d2442d8bab9cf6192b7f69f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aOO5bqm5YmN56uv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768903999&amp;x-signature=XXdm8VvTiwrg1nZhiQkZoOwWtq8%3D" alt="image.png" loading="lazy"/></p>
<p>这才知道，npm 官方在 2026 年强制更新了安全政策，具体来说就是：</p>
<ul>
<li><strong>旧的「经典令牌 (Classic tokens)」被 npm 官方全部作废回收</strong>：即之前本地保存的、用于指纹 / 免密登录的令牌，现在彻底不能用了；</li>
<li><strong>npm 强制启用「细粒度令牌 (Granular tokens)」</strong>：这是新版的安全令牌，有效期<strong>默认只有 90 天</strong>，到期就要重新生成；</li>
<li><strong>安全门槛提升</strong>：npm 要求<strong>所有发布包的账号，必须开启 两步验证 (2FA)</strong> ，且细粒度令牌默认强制绑定 2FA，没有例外；</li>
<li><strong>登录方式变更</strong>：npm 不再支持「指纹授权 / 一键免密登录」这种简单方式，<strong>即现在的</strong> <code>npm login</code> <strong>必须要使用新版令牌</strong>，否则强制输入账号密码才能登录。</li>
</ul>
<p>那么，问题来了，npm 的<strong>细粒度令牌 (Granular tokens)是什么？</strong> 为什么这个令牌要叫「细粒度」，和之前的「经典令牌」差在哪？下面听我娓娓道来。</p>
<h2 data-id="heading-0"><strong>细粒度令牌 (Granular tokens)</strong></h2>
<p>所谓「细粒度」=【权限可以精细化控制】，这是它的核心特征，是对比 被作废的「经典令牌 (Classic Token)」 来的，两者是完全不同的两种令牌。下面是他们之间的区别：</p>
<h3 data-id="heading-1">旧版：经典令牌 (Classic Token) —— 之前指纹登录用的令牌</h3>
<ul>
<li>权限：<strong>一刀切的「超级管理员权限」</strong> → 拿到这个令牌，能做 npm 账号的「所有操作」：发布包、删包、改账号信息、看所有私密包... 权限无限大；</li>
<li>有效期：<strong>永久有效</strong>，生成一次能用一辈子，npm 不主动作废就一直能用；</li>
<li>安全要求：无任何要求，不用开 2FA，谁都能生成；</li>
<li>为什么被作废：权限太大 + 永久有效，一旦泄露，账号等于彻底被盗，npm 生态被恶意包搞的乌烟瘴气，所以 npm<strong>全网强制回收所有经典令牌</strong>。</li>
</ul>
<h3 data-id="heading-2">新版：细粒度令牌 (Granular Access Token) —— npm 最新推出的</h3>
<ul>
<li>权限：<strong>可以「按需勾选、精细化分配」</strong> → 这就是「细粒度」的核心含义。你想要什么权限，就只勾选什么权限，<strong>多一分权限都不给。</strong></li>
<li>有效期：<strong>强制 90 天</strong>，npm 新规要求，最长只能 90 天，到期自动失效；</li>
<li>安全要求：npm「默认要求」开 2FA，但<strong>不是强制</strong>。</li>
<li>为什么是它：权限小 + 有效期短，就算令牌泄露，风险也极小，90 天后自动作废，安全风险可控。</li>
</ul>
<p>那么在了解了<strong>细粒度令牌后，</strong> 我们应该怎么用其新规来发布包呢？很明显，如果不使用令牌，采用传统的<strong>默认的 npm login 发包流程很反人类</strong>：要输用户名、密码、输邮箱，还要输 2FA 一次性验证码，发布个包要折腾半天，对高频发布的开发者来说简直是折磨。</p>
<p>好在 npm 提供了 <strong>「本地配置永久授权令牌」</strong> 的机制，可以做到永久免登录发布，直接 npm 令牌写入本地的 npm 全局配置文件里，npm 会永久读取这个令牌作为身份凭证，<strong>完全跳过</strong> <code>npm login</code> <strong>整个流程</strong>，不需要登录、不需要输用户名、不需要输邮箱、不需要输验证码，<strong>以后发布包，只需要在项目里敲</strong> <code>npm publish</code> <strong>一个命令，直接发布成功</strong>！</p>
<p>并且这个配置是<strong>永久生效</strong>的，哪怕 90 天后令牌过期了，也只是重新换个令牌再执行一次配置命令就行，比反复登录舒服 100 倍。下面就是操作流程：</p>
<h2 data-id="heading-3">npm 免登录发布</h2>
<h3 data-id="heading-4">步骤 1：生成细粒度令牌 (Granular Access Token)</h3>
<ul>
<li>打开 npm 官网 → 账号 → Access tokens →Generate New Token</li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/dfc1e7925da2485d9dc328a2b0b9f811~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aOO5bqm5YmN56uv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768903999&amp;x-signature=NbDzJ%2F7e3Fp6AaLWG7lhXMihZ04%3D" alt="image.png" loading="lazy"/></p>
<ul>
<li>依次输入名称，勾选<code>Bypass two-factor authentication (2FA)</code>（不勾选的话每次发包还需要再输入 2fa 验证码），选择包范围和过期时间（最多 90 天）</li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ac0cc5da93834c29aca267708ee17c02~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aOO5bqm5YmN56uv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768903999&amp;x-signature=nTebA2gbHH4TH4F9qASi2kwXPJw%3D" alt="image.png" loading="lazy"/>
生成后的细粒度令牌复制下来，然后进入终端</p>
<h3 data-id="heading-5">步骤 2：Mac 终端执行【一行核心命令】，永久配置令牌</h3>
<p>直接复制下面的命令到终端，把 <code>你的细粒度令牌</code> 替换成你复制的令牌字符串，<strong>直接回车执行</strong>，没有任何反馈就是配置成功</p>
<pre><code class="hljs language-arduino" lang="arduino">npm config set <span class="hljs-comment">//registry.npmjs.org/:_authToken=你的细粒度令牌</span>
</code></pre>
<h3 data-id="heading-6">步骤 3：检查配置是否生效</h3>
<p>方式一：终端执行下面的命令，能看到你的令牌就说明配置成功了</p>
<pre><code class="hljs language-arduino" lang="arduino">npm config get <span class="hljs-comment">//registry.npmjs.org/:_authToken</span>

npm ERR! ---sekretz---

npm ERR! A complete log of <span class="hljs-keyword">this</span> run can be found in:
npm ERR!     /Users/wanko/.npm/_logs/<span class="hljs-number">2026</span><span class="hljs-number">-01</span><span class="hljs-number">-12</span>T07_44_13_678Z-debug.log
</code></pre>
<p>方式二：直接执行 <code>npm whoami</code> 命令</p>
<pre><code class="hljs language-bash" lang="bash">npm <span class="hljs-built_in">whoami</span>
</code></pre>
<h4 data-id="heading-7">成功的结果：</h4>
<p>终端会直接输出你的 <strong>npm 官网账号名</strong>说明：npm 已经通过你配置的令牌，成功识别了你的身份，令牌配置<strong>完全生效</strong>！</p>
<h3 data-id="heading-8">从此以后的发布流程</h3>
<p>不管是 90 天内，还是换了项目，只要还是这台电脑，发布 npm 包<strong>全程只有 2 步</strong>，无任何输入：</p>
<ol>
<li>终端进入你的 npm 包项目目录</li>
<li>执行发布命令即可：bash运行</li>
</ol>

<pre><code class="hljs">npm publish
</code></pre>
<p>效果：回车后直接打包、上传、发布成功，<strong>没有任何弹窗、没有任何输入项</strong>，秒发，爽到飞起</p>
<h2 data-id="heading-9">补充说明</h2>
<h3 data-id="heading-10">90 天后令牌过期了怎么办？</h3>
<p>令牌有效期 90 天，过期后执行 <code>npm whoami</code> 会提示身份失效，<strong>解决方法超级简单：</strong></p>
<ol>
<li>去 npm 官网 → 账号 → Access tokens → 生成一个新的「Automation」令牌，复制；</li>
<li>Mac 终端执行之前的配置命令，用新令牌替换旧令牌：</li>
</ol>

<pre><code class="hljs language-arduino" lang="arduino">npm config set <span class="hljs-comment">//registry.npmjs.org/:_authToken=你的新令牌</span>
</code></pre>
<p>3.  执行 <code>npm whoami</code> 验证，搞定！</p>
<p>不用删旧令牌、不用 logout、不用改配置文件，直接覆盖就行，npm 会自动用新令牌生效。</p>
<h3 data-id="heading-11">关于细粒度令牌在本地的保存</h3>
<ol>
<li>令牌只保存在电脑<strong>的本地配置文件</strong> <code>~/.npmrc</code> 里，不会上传到任何服务器，不会被 npm / 任何人获取；</li>
<li>令牌是「自动化令牌」，权限仅用于「登录 + 发布包」，没有账号修改、删除等高危权限，就算泄露（概率极低），别人最多只能用你的账号发布包，改不了你的账号信息；</li>
<li>npm 的 <code>---sekretz---</code> 机制，就是为了防止你在公共场合执行命令时，令牌被别人看到，是双重保护。</li>
</ol>
<h2 data-id="heading-12">总结</h2>
<p>虽然 npm 更新了安全策略，但总得来说新的令牌可以让发布更友好，比之前指纹授权的体验还要好，毕竟指纹授权登录还得跳转网页再回到终端，需要等待网页的加载，还有切换操作，而现在通过细粒度令牌，可以直接免登录，且一行命令就能实现发包，以后发布包再也不用折腾那些繁琐的步骤了，真的是 too easy too happy。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[漫画说：为什么你的“增量计算”越跑越慢？——90%的实时数仓团队都踩过的坑，藏在这几格漫画里]]></title>    <link>https://juejin.cn/post/7594661351513047075</link>    <guid>https://juejin.cn/post/7594661351513047075</guid>    <pubDate>2026-01-13T10:31:31.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7594661351513047075" data-draft-id="7594662258354421795" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="漫画说：为什么你的“增量计算”越跑越慢？——90%的实时数仓团队都踩过的坑，藏在这几格漫画里"/> <meta itemprop="keywords" content="大数据,人工智能"/> <meta itemprop="datePublished" content="2026-01-13T10:31:31.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="阿里云大数据AI技术"/> <meta itemprop="url" content="https://juejin.cn/user/2414974667341287"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            漫画说：为什么你的“增量计算”越跑越慢？——90%的实时数仓团队都踩过的坑，藏在这几格漫画里
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2414974667341287/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    阿里云大数据AI技术
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-13T10:31:31.000Z" title="Tue Jan 13 2026 10:31:31 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><img src="https://static001.geekbang.org/infoq/7a/7abadb065bbaf802a3ae7cc6b4db1bbd.jpeg" alt="" loading="lazy"/></p>
<p>为什么每次只改一行数据，却要重算上亿条历史记录？</p>
<p>你在构建实时看板、用户画像或风控特征时，是否也遇到过这样的困境？</p>
<p>每天新增的订单可能只有几万条，但背后的用户、商品、支付表动辄上亿行。为了刷新一个聚合指标，系统不得不全量扫描、重新 Join、再聚合——哪怕 99% 的数据根本没有变化。</p>
<p><img src="https://static001.geekbang.org/infoq/29/2968eec0b74ab5fa086dd52c811dd977.png" alt="" loading="lazy"/></p>
<p>这不仅拖慢了刷新频率，还让计算成本居高不下。</p>
<p>更糟的是，为了“扛住”全量任务，团队往往被迫拆出多层中间表，链路越拉越长，维护越来越难。</p>
<p><img src="https://static001.geekbang.org/infoq/30/30dcaf1c42d96c36f4148ee2449eee91.jpeg" alt="" loading="lazy"/></p>
<p>增量刷新本应是解药，但并非所有方案都是真正“增量”。</p>
<p>一些系统采用无状态模型：每次只读变更数据，却不保存任何中间结果。听起来轻量，实则代价高昂——复杂查询下，它仍需反复回溯历史数据，甚至比全量更慢。</p>
<p><img src="https://static001.geekbang.org/infoq/ab/ab56b486d20c6380b2d5b0b0984b913d.jpeg" alt="" loading="lazy"/></p>
<p>阿里云 Hologres 选择了另一条路径：有状态增量计算。</p>
<p>在首次全量构建时，它同步生成并持久化关键中间状态——比如聚合值、Join 中间产物。</p>
<p>后续刷新，只需将新数据与状态合并，无需触碰原始历史表。</p>
<p>这意味着：</p>
<ul>
<li>
<p>刷新延迟从分钟级降至秒级；</p>
</li>
<li>
<p>计算资源消耗大幅下降；</p>
</li>
<li>
<p>即使面对五表 Join 或 COUNT DISTINCT，也能保持高效。</p>
</li>
</ul>
<p><img src="https://static001.geekbang.org/infoq/5d/5d2c9f6257591dd7937e9659d3b19bb2.png" alt="" loading="lazy"/></p>
<p>状态确实需要额外存储，但这部分开销是可控的。</p>
<p>在分区表场景中，仅活跃分区保留状态；非活跃分区自动转为全量，避免状态膨胀。</p>
<p>对于非分区表，也可通过 TTL 策略清理过期状态。</p>
<p><img src="https://static001.geekbang.org/infoq/b4/b46e0fc997f9bafc4eb2f60cf2d2665e.jpeg" alt="" loading="lazy"/></p>
<p>真正的效率，不在于少算一点，而在于只算该算的。</p>
<p>如果你正在设计实时数仓、特征管道或统一指标体系，不妨评估：你的“增量”是否真的避开了历史数据的重复计算？</p>
<p>Hologres Dynamic Table 提供了一种经过验证的答案——用有限的存储换确定性的性能，让实时更新回归本质。</p>
<p><img src="https://static001.geekbang.org/infoq/f8/f81dcf4fb57e5dc62c1254f3383a0c12.jpeg" alt="" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[uni-app实现leaflet地图图标旋转]]></title>    <link>https://juejin.cn/post/7594662258354487331</link>    <guid>https://juejin.cn/post/7594662258354487331</guid>    <pubDate>2026-01-13T10:41:46.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7594662258354487331" data-draft-id="7594096585727737856" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="uni-app实现leaflet地图图标旋转"/> <meta itemprop="keywords" content="前端,Trae"/> <meta itemprop="datePublished" content="2026-01-13T10:41:46.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="李剑一"/> <meta itemprop="url" content="https://juejin.cn/user/4147782344247918"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            uni-app实现leaflet地图图标旋转
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4147782344247918/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    李剑一
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-13T10:41:46.000Z" title="Tue Jan 13 2026 10:41:46 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#595959;font-size:15px;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(60,10,30,.04) 3%,transparent 0),linear-gradient(1turn,rgba(60,10,30,.04) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body p{color:#595959;font-size:15px;line-height:2;font-weight:400}.markdown-body p+p{margin-top:16px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin:0;color:#135ce0}.markdown-body h1{position:relative;text-align:center;font-size:22px;margin:50px 0}.markdown-body h1:before{position:absolute;content:"";top:-10px;left:50%;width:32px;height:32px;transform:translateX(-50%);background-size:100% 100%;opacity:.36;background-repeat:no-repeat;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC)}.markdown-body h2{position:relative;font-size:20px;border-left:4px solid;padding:0 0 0 10px;margin:30px 0}.markdown-body h3{font-size:16px}.markdown-body ul{list-style:disc outside;margin-left:2em;margin-top:1em}.markdown-body li{line-height:2;color:#595959}.markdown-body img.loaded{margin:0 auto;display:block}.markdown-body blockquote{background:#fff9f9;margin:2em 0;padding:2px 20px;border-left:4px solid #b2aec5}.markdown-body blockquote p{color:#666;line-height:2}.markdown-body a{color:#036aca;border-bottom:1px solid rgba(3,106,202,.8);font-weight:400;text-decoration:none}.markdown-body em strong,.markdown-body strong{color:#036aca}.markdown-body hr{border-top:1px solid #135ce0}.markdown-body pre{overflow:auto}.markdown-body code,.markdown-body pre{overflow:auto;position:relative;line-height:1.75;font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body table{border-collapse:collapse;margin:1rem 0;overflow-x:auto}.markdown-body table td,.markdown-body table th{border:1px solid #dfe2e5;padding:.6em 1em}.markdown-body table tr{border-top:1px solid #dfe2e5}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>之前在 uni-app 上已经实现了 leaflet 的离线地图，详细可以参考上文 <a href="https://juejin.cn/post/7592531796044185615" target="_blank" title="https://juejin.cn/post/7592531796044185615"># uni-app使用瓦片实现离线地图的两种方案</a>。</p>
<p>最近新增了一个定位的功能，其实就是常见的地图上的手机朝向哪儿，箭头就往哪儿指这个功能。</p>
<p>但是因为地图是基于 leaflet 做的，在 Trae 上进行了一番询问，Trae推荐采用简单实现方案，就是在 leaflet 上增加一个图标，然后通过图标旋转变换箭头朝向。</p>
<p>虽然我对 leaflet 不是非常熟悉，但是 Trae 作为程序员的"<strong>外挂</strong>"解答这个是没问题的，给出了两个实现方案。</p>
<h2 data-id="heading-0">方案1: 使用CSS调整</h2>
<p>在创建图标的时候给图标增加一个 <strong>className</strong>，然后通过修改这个 class 的 <strong>transform: rotate(45deg)</strong> 进行旋转。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-title function_">createLocationIcon</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> icon = L.<span class="hljs-title function_">icon</span>({
        <span class="hljs-attr">iconUrl</span>: <span class="hljs-string">'static/icon/location.png'</span>,
        <span class="hljs-attr">iconSize</span>: [<span class="hljs-number">60</span>, <span class="hljs-number">60</span>],
        <span class="hljs-attr">iconAnchor</span>: [<span class="hljs-number">30</span>, <span class="hljs-number">30</span>],
        <span class="hljs-attr">popupAnchor</span>: [<span class="hljs-number">1</span>, -<span class="hljs-number">20</span>],
        <span class="hljs-attr">className</span>: <span class="hljs-string">'test-location'</span>
    });
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">locationIcon</span> = L.<span class="hljs-title function_">marker</span>([lat, lon], {
        <span class="hljs-attr">icon</span>: icon
    }).<span class="hljs-title function_">addTo</span>(map);
},
<span class="hljs-title function_">updateLocation</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// 计算角度</span>
    <span class="hljs-keyword">const</span> bearing = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">calculateBearing</span>(
        that.<span class="hljs-property">location</span>.<span class="hljs-property">latitude</span>,
        that.<span class="hljs-property">location</span>.<span class="hljs-property">longitude</span>,
        that.<span class="hljs-property">testPosition</span>.<span class="hljs-property">latitude</span>,
        that.<span class="hljs-property">testPosition</span>.<span class="hljs-property">longitude</span>
    );
    <span class="hljs-keyword">const</span> icon = <span class="hljs-variable language_">this</span>.<span class="hljs-property">locationIcon</span>.<span class="hljs-title function_">getElementsByClassName</span>(<span class="hljs-string">"test-location"</span>);
    icon.<span class="hljs-property">style</span>.<span class="hljs-property">transform</span> += <span class="hljs-string">`rotate(<span class="hljs-subst">${bearing}</span>deg)`</span>;
}
</code></pre>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.test-location</span> {
    <span class="hljs-attribute">transform</span>: <span class="hljs-built_in">rotate</span>(<span class="hljs-number">20deg</span>);
}
</code></pre>
<p>这种方案其实是比较简单的，通过确定旋转角度直接<strong>操作DOM</strong>的形式进行旋转，并且还可以增加一定的动画延迟效果。</p>
<h2 data-id="heading-1">方案2: 使用leaflet.rotatedMarker.js</h2>
<p>使用 <strong>leaflet.rotatedMarker.js</strong> 也是比较方便的一种方法。</p>
<p>首先在 <code>static/leaflet</code> 文件夹下插入 <code>leaflet.rotatedMarker.js</code> 文件。</p>
<p>然后在代码中导入 <code>import rotated from "@/static/leaflet/leaflet.rotatedMarker.js";</code></p>
<p>最后在创建图标的位置增加 <code>rotationAngle</code> 属性。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-title function_">createLocationIcon</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> icon = L.<span class="hljs-title function_">icon</span>({
        <span class="hljs-attr">iconUrl</span>: <span class="hljs-string">'static/icon/location.png'</span>,
        <span class="hljs-attr">iconSize</span>: [<span class="hljs-number">60</span>, <span class="hljs-number">60</span>],
        <span class="hljs-attr">iconAnchor</span>: [<span class="hljs-number">30</span>, <span class="hljs-number">30</span>],
        <span class="hljs-attr">popupAnchor</span>: [<span class="hljs-number">1</span>, -<span class="hljs-number">20</span>],
        <span class="hljs-attr">rotationAngle</span>: <span class="hljs-number">0</span>
    });
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">locationIcon</span> = L.<span class="hljs-title function_">marker</span>([lat, lon], {
        <span class="hljs-attr">icon</span>: icon
    }).<span class="hljs-title function_">addTo</span>(map);
},
<span class="hljs-title function_">updateLocation</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// 计算角度</span>
    <span class="hljs-keyword">const</span> bearing = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">calculateBearing</span>(
        that.<span class="hljs-property">location</span>.<span class="hljs-property">latitude</span>,
        that.<span class="hljs-property">location</span>.<span class="hljs-property">longitude</span>,
        that.<span class="hljs-property">testPosition</span>.<span class="hljs-property">latitude</span>,
        that.<span class="hljs-property">testPosition</span>.<span class="hljs-property">longitude</span>
    );
    <span class="hljs-comment">// 设置旋转角度</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">locationIcon</span>.<span class="hljs-title function_">setRotationAngle</span>(bearing);
}
</code></pre>
<p>上述两种方法均可以实现图标的旋转，不过我更推荐第二种实现方案。</p>
<p>简单方便，而且不需要操作DOM，减少性能开销。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[拒绝傻瓜式截断 Diff：聊聊我在 AI Commit 插件里做的 7 个技术微创新]]></title>    <link>https://juejin.cn/post/7594657393830232102</link>    <guid>https://juejin.cn/post/7594657393830232102</guid>    <pubDate>2026-01-13T10:52:10.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7594657393830232102" data-draft-id="7594669638559416346" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="拒绝傻瓜式截断 Diff：聊聊我在 AI Commit 插件里做的 7 个技术微创新"/> <meta itemprop="keywords" content="AI编程,VibeCoding,Trae"/> <meta itemprop="datePublished" content="2026-01-13T10:52:10.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="也无风雨也雾晴"/> <meta itemprop="url" content="https://juejin.cn/user/2175258804632332"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            拒绝傻瓜式截断 Diff：聊聊我在 AI Commit 插件里做的 7 个技术微创新
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2175258804632332/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    也无风雨也雾晴
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-13T10:52:10.000Z" title="Tue Jan 13 2026 10:52:10 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    3
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">昨晚熬夜写了个 VS Code 插件，彻底解放写 Commit Message 的双手</h2>
<p>昨晚写代码写到凌晨，准备提交的时候，看着空荡荡的 commit message 输入框，突然不想动脑子了。</p>
<p>"这是 feat 还是 fix？scope 填 auth 还是 user？message 怎么概括才得体？" —— 每次都要在大脑里过一遍这些 Conventional Commits 的规则，真的很累。</p>
<p>于是，从昨晚 11 点开始，到今天上午发布上线，花了不到 4 个小时，我vibe coding了一个极其顺手的 Commit Message 生成器。</p>
<p>写完复盘了一下，发现虽然功能简单，但为了"极致的体验"，里面用了不少有意思的技术细节。</p>
<h3 data-id="heading-1">为什么还要造轮子</h3>
<p>其实 VS Code 原生就支持 Copilot 生成 commit message，但我之前的 Copilot 服务因为账号问题用不了了（懂的都懂）。</p>
<p>没了 Copilot，我去市场搜了一圈替代品，发现最大的痛点是：<strong>不够智能，也不够灵活。</strong></p>
<p>这就导致了两个问题：</p>
<ol>
<li><strong>没法适应团队规范</strong>：很多插件生成的格式是死的，但我们团队要求特定的 type 或 scope 格式，甚至要求用中文/日文写 commit。</li>
<li><strong>配置极其繁琐</strong>：想用自己的 API Key，得填一堆 Provider ID、Endpoint，非常折腾。</li>
</ol>
<p>我想要的是：</p>
<ol>
<li><strong>完全的 Prompt 自定义权限</strong>：不仅仅是改个前缀，而是能完全控制 AI 的系统提示词（System Prompt）。我想让它用中文写、用emoji、或者严格遵循 Angular 规范，都能通过改 Prompt 实现。</li>
<li><strong>不想填一堆配置</strong>：给我一个 API Key，一个 Base URL，一个 Model 名字，这就够了。管你是 OpenAI、Claude 还是 Ollama 本地模型，只要兼容 OpenAI 格式，通通能用。</li>
<li><strong>懂我的代码</strong>：不要傻傻地把几千行 diff 扔给 AI，它会晕；也不要粗暴地截断，它会瞎。</li>
<li><strong>要有爽感</strong>：点一下，文字必须像打字机一样一个个蹦出来（流式输出），而不是转圈转半天然后 <code>啪</code> 一下甩我脸上。</li>
</ol>
<p>基于这些需求，我 vibe coding 出了这个插件。</p>
<h3 data-id="heading-2">核心设计</h3>
<h4 data-id="heading-3">1. 统一的 API 抽象</h4>
<p>最初我设计了四个 Provider：OpenAI、Claude、Gemini、Custom。后来发现这是过度设计——现在大部分 LLM 服务都兼容 OpenAI 格式，没必要分开。</p>
<p>最终只留了三个配置项：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">interface</span> <span class="hljs-title class_">ProviderConfig</span> {
    <span class="hljs-attr">apiKey</span>: <span class="hljs-built_in">string</span>;
    <span class="hljs-attr">model</span>: <span class="hljs-built_in">string</span>;
    <span class="hljs-attr">baseUrl</span>: <span class="hljs-built_in">string</span>;  <span class="hljs-comment">// https://api.openai.com/v1 或 http://localhost:11434/v1</span>
}
</code></pre>
<p>用 OpenAI？填 <code>api.openai.com/v1</code>。用 Claude 代理？换个 baseUrl。用本地 Ollama？<code>localhost:11434/v1</code>。一套代码全搞定。</p>
<h4 data-id="heading-4">2. 流式输出</h4>
<p>等 AI 生成完再显示结果，体验很差。用户会以为插件卡死了。</p>
<p>解决方案是 SSE（Server-Sent Events）流式输出：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 请求时开启流式</span>
<span class="hljs-attr">body</span>: <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>({
    <span class="hljs-attr">model</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">config</span>.<span class="hljs-property">model</span>,
    <span class="hljs-attr">messages</span>: [{ <span class="hljs-attr">role</span>: <span class="hljs-string">'user'</span>, <span class="hljs-attr">content</span>: prompt }],
    <span class="hljs-attr">stream</span>: <span class="hljs-literal">true</span>  <span class="hljs-comment">// 关键</span>
})
</code></pre>
<p>然后解析 SSE 格式的响应：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">readOpenAICompatibleStream</span>(<span class="hljs-params">
    body: ReadableStream&lt;<span class="hljs-built_in">Uint8Array</span>&gt;,
    onToken: (text: <span class="hljs-built_in">string</span>) =&gt; <span class="hljs-built_in">void</span>
</span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">string</span>&gt; {
    <span class="hljs-keyword">const</span> reader = body.<span class="hljs-title function_">getReader</span>();
    <span class="hljs-keyword">const</span> decoder = <span class="hljs-keyword">new</span> <span class="hljs-title class_">TextDecoder</span>(<span class="hljs-string">'utf-8'</span>);
    <span class="hljs-keyword">let</span> buffer = <span class="hljs-string">''</span>;
    <span class="hljs-keyword">let</span> result = <span class="hljs-string">''</span>;

    <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) {
        <span class="hljs-keyword">const</span> { done, value } = <span class="hljs-keyword">await</span> reader.<span class="hljs-title function_">read</span>();
        <span class="hljs-keyword">if</span> (done) <span class="hljs-keyword">break</span>;

        buffer += decoder.<span class="hljs-title function_">decode</span>(value, { <span class="hljs-attr">stream</span>: <span class="hljs-literal">true</span> });
        
        <span class="hljs-comment">// SSE 事件以双换行分隔</span>
        <span class="hljs-keyword">let</span> sepIndex;
        <span class="hljs-keyword">while</span> ((sepIndex = buffer.<span class="hljs-title function_">indexOf</span>(<span class="hljs-string">'\n\n'</span>)) !== -<span class="hljs-number">1</span>) {
            <span class="hljs-keyword">const</span> event = buffer.<span class="hljs-title function_">slice</span>(<span class="hljs-number">0</span>, sepIndex);
            buffer = buffer.<span class="hljs-title function_">slice</span>(sepIndex + <span class="hljs-number">2</span>);

            <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> line <span class="hljs-keyword">of</span> event.<span class="hljs-title function_">split</span>(<span class="hljs-string">'\n'</span>)) {
                <span class="hljs-keyword">if</span> (!line.<span class="hljs-title function_">startsWith</span>(<span class="hljs-string">'data:'</span>)) <span class="hljs-keyword">continue</span>;
                <span class="hljs-keyword">const</span> payload = line.<span class="hljs-title function_">slice</span>(<span class="hljs-number">5</span>).<span class="hljs-title function_">trim</span>();
                <span class="hljs-keyword">if</span> (payload === <span class="hljs-string">'[DONE]'</span>) <span class="hljs-keyword">return</span> result;

                <span class="hljs-keyword">const</span> json = <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(payload);
                <span class="hljs-keyword">const</span> delta = json?.<span class="hljs-property">choices</span>?.[<span class="hljs-number">0</span>]?.<span class="hljs-property">delta</span>?.<span class="hljs-property">content</span> ?? <span class="hljs-string">''</span>;
                <span class="hljs-keyword">if</span> (delta) {
                    result += delta;
                    <span class="hljs-title function_">onToken</span>(delta);  <span class="hljs-comment">// 每个 token 实时回调</span>
                }
            }
        }
    }
    <span class="hljs-keyword">return</span> result;
}
</code></pre>
<p>每收到一个 token，就往 VS Code 的 commit 输入框里追加，用户能看到文字一个一个蹦出来。</p>
<h4 data-id="heading-5">3. 智能 type/scope 推断</h4>
<p>Conventional Commits 格式是 <code>type(scope): description</code>。让 AI 自己猜 type 有时候不太准，比如改了测试文件，AI 可能还是写 <code>feat</code>。</p>
<p>我加了一层启发式推断：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">inferType</span>(<span class="hljs-params">files: <span class="hljs-built_in">string</span>[]</span>): <span class="hljs-built_in">string</span> {
    <span class="hljs-keyword">const</span> <span class="hljs-title function_">isDocsFile</span> = (<span class="hljs-params">f</span>) =&gt; f.<span class="hljs-title function_">endsWith</span>(<span class="hljs-string">'.md'</span>) || f.<span class="hljs-title function_">startsWith</span>(<span class="hljs-string">'docs/'</span>);
    <span class="hljs-keyword">const</span> <span class="hljs-title function_">isTestFile</span> = (<span class="hljs-params">f</span>) =&gt; f.<span class="hljs-title function_">includes</span>(<span class="hljs-string">'test'</span>) || <span class="hljs-regexp">/\.(test|spec)\.[jt]sx?$/</span>.<span class="hljs-title function_">test</span>(f);
    <span class="hljs-keyword">const</span> <span class="hljs-title function_">isCIFile</span> = (<span class="hljs-params">f</span>) =&gt; f.<span class="hljs-title function_">startsWith</span>(<span class="hljs-string">'.github/workflows/'</span>);
    
    <span class="hljs-keyword">if</span> (files.<span class="hljs-title function_">every</span>(isDocsFile)) <span class="hljs-keyword">return</span> <span class="hljs-string">'docs'</span>;
    <span class="hljs-keyword">if</span> (files.<span class="hljs-title function_">every</span>(isTestFile)) <span class="hljs-keyword">return</span> <span class="hljs-string">'test'</span>;
    <span class="hljs-keyword">if</span> (files.<span class="hljs-title function_">some</span>(isCIFile)) <span class="hljs-keyword">return</span> <span class="hljs-string">'ci'</span>;
    <span class="hljs-comment">// ...</span>
    <span class="hljs-keyword">return</span> <span class="hljs-string">'feat'</span>;
}
</code></pre>
<p>把推断结果作为"建议"传给 AI，而不是强制限制。这样 AI 既有参考，又保留了灵活性：</p>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-section">## Suggestions (optional)</span>
<span class="hljs-bullet">-</span> Suggested type: docs
<span class="hljs-bullet">-</span> Suggested scope: readme
</code></pre>
<h4 data-id="heading-6">4. 智能 Diff 裁剪</h4>
<p>大型重构可能有几千行 diff，直接喂给 AI 会超 token 限制。简单粗暴地截断前 N 个字符，可能会把函数签名截断一半，AI 看不懂。</p>
<p>我的做法是<strong>语义裁剪</strong>：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">summarizeDiffBlock</span>(<span class="hljs-params">block: <span class="hljs-built_in">string</span>, budget: <span class="hljs-built_in">number</span></span>): <span class="hljs-built_in">string</span> {
    <span class="hljs-keyword">const</span> lines = block.<span class="hljs-title function_">split</span>(<span class="hljs-string">'\n'</span>);
    <span class="hljs-keyword">const</span> header = [];    <span class="hljs-comment">// 保留 diff 头部</span>
    <span class="hljs-keyword">const</span> important = []; <span class="hljs-comment">// 保留关键行</span>

    <span class="hljs-comment">// 用正则识别关键行</span>
    <span class="hljs-keyword">const</span> signatureLike = <span class="hljs-regexp">/^[+-]?\s*(export\s+)?(function|class|interface)/</span>;
    <span class="hljs-keyword">const</span> commentLike = <span class="hljs-regexp">/^[+-]?\s*(\/\/|#|\/\*)/</span>;
    
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> line <span class="hljs-keyword">of</span> lines) {
        <span class="hljs-keyword">if</span> (signatureLike.<span class="hljs-title function_">test</span>(line) || commentLike.<span class="hljs-title function_">test</span>(line)) {
            important.<span class="hljs-title function_">push</span>(line);
        }
    }
    
    <span class="hljs-keyword">return</span> [...header, ...important].<span class="hljs-title function_">join</span>(<span class="hljs-string">'\n'</span>);
}
</code></pre>
<p>优先保留：</p>
<ul>
<li>函数/类签名</li>
<li>注释</li>
<li>import 语句</li>
<li>hunk 的前 6 行变更</li>
</ul>
<p>这样即使原始 diff 有 5000 行，裁剪到 500 行后，AI 仍然能理解代码的意图。</p>
<h4 data-id="heading-7">5. 单行/多行模式</h4>
<p>有人喜欢简洁的单行 commit，有人喜欢带 body 的详细版本。</p>
<p>我加了 <code>outputStyle</code> 配置：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">type</span> <span class="hljs-title class_">OutputStyle</span> = <span class="hljs-string">'headerOnly'</span> | <span class="hljs-string">'headerAndBody'</span>;
</code></pre>
<p>不同模式下，prompt 模板会动态变化：</p>
<pre><code class="hljs language-handlebars" lang="handlebars">{{#if header_only}}
- Output ONLY ONE line (header only): no body, no footer
- Keep it concise (max 72 characters)
{{/if}}

{{#if allow_body}}
- Output a header line and optionally a short body
{{/if}}
</code></pre>
<p><code>headerOnly</code> 模式还有个优化：检测到第一个换行符就<strong>立即中断流式输出</strong>，不浪费后面的 token：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">if</span> (headerOnly) {
    <span class="hljs-keyword">const</span> newlineIndex = text.<span class="hljs-title function_">search</span>(<span class="hljs-regexp">/\r?\n/</span>);
    <span class="hljs-keyword">if</span> (newlineIndex !== -<span class="hljs-number">1</span>) {
        abortController.<span class="hljs-title function_">abort</span>();  <span class="hljs-comment">// 立即停止</span>
        <span class="hljs-keyword">return</span>;
    }
}
</code></pre>
<h4 data-id="heading-8">6. 后处理清洗</h4>
<p>AI 有时候会输出一些垃圾：</p>
<ul>
<li><code>Commit message: feat: ...</code>（带前缀）</li>
<li><code>```feat: ...```</code>（带 markdown 代码块）</li>
<li><code>"feat: ..."</code>（带引号）</li>
</ul>
<p>我加了一层后处理：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">normalizeCommitMessage</span>(<span class="hljs-params">raw: <span class="hljs-built_in">string</span>, options: { headerOnly: <span class="hljs-built_in">boolean</span> }</span>): <span class="hljs-built_in">string</span> {
    <span class="hljs-keyword">let</span> text = raw;
    
    <span class="hljs-comment">// 去掉 markdown 代码块</span>
    text = text.<span class="hljs-title function_">replace</span>(<span class="hljs-regexp">/```[\s\S]*?```/g</span>, <span class="hljs-function">(<span class="hljs-params">block</span>) =&gt;</span> {
        <span class="hljs-keyword">const</span> lines = block.<span class="hljs-title function_">split</span>(<span class="hljs-string">'\n'</span>);
        <span class="hljs-keyword">return</span> lines.<span class="hljs-title function_">slice</span>(<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>).<span class="hljs-title function_">join</span>(<span class="hljs-string">'\n'</span>);  <span class="hljs-comment">// 只保留内容</span>
    });
    
    <span class="hljs-comment">// 去掉常见前缀</span>
    text = text.<span class="hljs-title function_">replace</span>(<span class="hljs-regexp">/^\s*(commit message|message)\s*:\s*/i</span>, <span class="hljs-string">''</span>);
    
    <span class="hljs-comment">// 去掉首尾引号</span>
    text = text.<span class="hljs-title function_">replace</span>(<span class="hljs-regexp">/^["'`]+|["'`]+$/g</span>, <span class="hljs-string">''</span>);
    
    <span class="hljs-keyword">if</span> (options.<span class="hljs-property">headerOnly</span>) {
        <span class="hljs-keyword">return</span> text.<span class="hljs-title function_">split</span>(<span class="hljs-string">'\n'</span>).<span class="hljs-title function_">find</span>(<span class="hljs-function"><span class="hljs-params">l</span> =&gt;</span> l.<span class="hljs-title function_">trim</span>()) ?? <span class="hljs-string">''</span>;
    }
    <span class="hljs-keyword">return</span> text;
}
</code></pre>
<h4 data-id="heading-9">7. 暂存区智能感知</h4>
<p>很多时候写完代码忘了 <code>git add</code> 就直接点生成，大部分插件会报错 "No staged changes"。</p>
<p>我觉得工具应该更聪明一点：</p>
<ol>
<li><strong>只有暂存区代码</strong>：直接生成（标准流程）。</li>
<li><strong>只有工作区代码（未暂存）</strong>：直接生成（省去 <code>git add</code> 步骤）。</li>
<li><strong>都有</strong>：弹窗让用户选。</li>
</ol>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">const</span> hasStaged = <span class="hljs-keyword">await</span> git.<span class="hljs-title function_">hasStagedChanges</span>();
<span class="hljs-keyword">const</span> hasUnstaged = <span class="hljs-keyword">await</span> git.<span class="hljs-title function_">hasUnstagedChanges</span>();

<span class="hljs-keyword">if</span> (!hasStaged &amp;&amp; !hasUnstaged) {
    <span class="hljs-keyword">return</span> vscode.<span class="hljs-property">window</span>.<span class="hljs-title function_">showWarningMessage</span>(<span class="hljs-string">'No changes found'</span>);
}

<span class="hljs-keyword">if</span> (hasStaged &amp;&amp; hasUnstaged) {
    <span class="hljs-comment">// 弹窗让用户选</span>
    <span class="hljs-keyword">const</span> picked = <span class="hljs-keyword">await</span> vscode.<span class="hljs-property">window</span>.<span class="hljs-title function_">showWarningMessage</span>(
        <span class="hljs-string">'Detected both staged and unstaged changes'</span>,
        <span class="hljs-string">'Use Staged'</span>,
        <span class="hljs-string">'Use Unstaged'</span>
    );
    <span class="hljs-comment">// ...</span>
}
</code></pre>
<p>这样在这个微小的交互上，又能少点一次鼠标。</p>
<h3 data-id="heading-10">打包发布</h3>
<p>VS Code 插件用 <code>vsce</code> 打包：</p>
<pre><code class="hljs language-bash" lang="bash">npx vsce package
</code></pre>
<p>为了减小包体积，我用了 esbuild 打包，把所有 TypeScript 代码编译成一个 <code>extension.js</code>：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// esbuild.mjs</span>
<span class="hljs-keyword">await</span> esbuild.<span class="hljs-title function_">build</span>({
    <span class="hljs-attr">entryPoints</span>: [<span class="hljs-string">'src/extension.ts'</span>],
    <span class="hljs-attr">bundle</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-attr">outfile</span>: <span class="hljs-string">'dist/extension.js'</span>,
    <span class="hljs-attr">platform</span>: <span class="hljs-string">'node'</span>,
    <span class="hljs-attr">external</span>: [<span class="hljs-string">'vscode'</span>],
    <span class="hljs-attr">minify</span>: production
});
</code></pre>
<p>最终 <code>.vsix</code> 包只有 <strong>435 KB</strong>，8 个文件。</p>
<h3 data-id="heading-11">总结</h3>
<p>这个插件的核心思路就是：<strong>在对的地方做对的事</strong>。</p>
<ul>
<li>API 层：统一抽象，不过度设计</li>
<li>交互层：流式输出，即时反馈</li>
<li>推理层：启发式辅助，而非强制替代</li>
<li>数据层：语义裁剪，而非暴力截断</li>
<li>输出层：后处理清洗，容错 AI 的奇怪输出</li>
</ul>
<p>代码不多，但每个模块都解决了一个实际问题。</p>
<hr/>
<p>项目已开源：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Ftt-a1i%2Fvscode-ai-commit" target="_blank" title="https://github.com/tt-a1i/vscode-ai-commit" ref="nofollow noopener noreferrer">vscode-ai-commit</a></p>
<p>VS Code Marketplace 搜索 <strong>"AI Commit"</strong> 可以直接安装。</p>
<h3 data-id="heading-12"><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/afc800a0c615488280c6980d8e541bb4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lmf5peg6aOO6Zuo5Lmf6Zu-5pm0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768906655&amp;x-signature=JQzN6RLYl2%2F7ipSGHGPK%2BS1UPFk%3D" alt="image.png" loading="lazy"/></h3>
<p>如果你觉得这篇文章有帮助，欢迎关注我的 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Ftt-a1i" target="_blank" title="https://github.com/tt-a1i" ref="nofollow noopener noreferrer">GitHub</a>，下面是我的一些开源项目：</p>
<p><strong>Claude Code Skills</strong>（按需加载，意图自动识别，不浪费 token，<a href="https://juejin.cn/post/7578714735307735066" target="_blank" title="https://juejin.cn/post/7578714735307735066">介绍文章</a>）：</p>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Ftt-a1i%2Fcode-review-skill" target="_blank" title="https://github.com/tt-a1i/code-review-skill" ref="nofollow noopener noreferrer">code-review-skill</a> - 代码审查技能，覆盖 React 19、Vue 3、TypeScript、Rust 等约 9000 行规则（<a href="https://juejin.cn/post/7578709098255908902" target="_blank" title="https://juejin.cn/post/7578709098255908902">详细介绍</a>）</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Ftt-a1i%2F5-whys-skill" target="_blank" title="https://github.com/tt-a1i/5-whys-skill" ref="nofollow noopener noreferrer">5-whys-skill</a> - 5 Whys 根因分析，说"找根因"自动激活</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Ftt-a1i%2Ffirst-principles-skill" target="_blank" title="https://github.com/tt-a1i/first-principles-skill" ref="nofollow noopener noreferrer">first-principles-skill</a> - 第一性原理思考，适合架构设计和技术选型</li>
</ul>
<p><strong>qwen/gemini/claude - cli 原理学习网站</strong>：</p>
<ul>
<li>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Ftt-a1i%2Fcoding-cli-guide" target="_blank" title="https://github.com/tt-a1i/coding-cli-guide" ref="nofollow noopener noreferrer">coding-cli-guide</a>（<a href="https://link.juejin.cn?target=https%3A%2F%2Ftt-a1i.github.io%2Fcoding-cli-guide%2F%3Ftab%3Dstart-here" target="_blank" title="https://tt-a1i.github.io/coding-cli-guide/?tab=start-here" ref="nofollow noopener noreferrer">学习网站</a>）- 学习 qwen-cli 时整理的笔记，40+ 交互式动画演示 AI CLI 内部机制
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/08e50020ab1f45428cd22e53af91a555~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lmf5peg6aOO6Zuo5Lmf6Zu-5pm0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768906655&amp;x-signature=FXRgUGD1GjjQwB3dqHZvtMLOBsA%3D" alt="coding-cli-guide" loading="lazy"/>
<strong>全栈项目</strong>（适合学习现代技术栈）：</p>
</li>
<li>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Ftt-a1i%2Fprompt-vault" target="_blank" title="https://github.com/tt-a1i/prompt-vault" ref="nofollow noopener noreferrer">prompt-vault</a> - Prompt 管理器，用的都是最新的技术栈，适合用来学习了解最新的前端全栈开发范式：Next.js 15 + React 19 + tRPC 11 + Supabase 全栈示例，clone 下来配个免费 Supabase 就能跑</p>
</li>
<li>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Ftt-a1i%2Fchat_edit" target="_blank" title="https://github.com/tt-a1i/chat_edit" ref="nofollow noopener noreferrer">chat_edit</a> - 双模式 AI 应用（聊天+富文本编辑），Vue 3.5 + TypeScript + Vite 5 + Quill 2.0 + IndexedDB</p>
</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[0代码手写！体验百度Comate的“魔法”：我造了个会理解情绪的中介层]]></title>    <link>https://juejin.cn/post/7594662258354061347</link>    <guid>https://juejin.cn/post/7594662258354061347</guid>    <pubDate>2026-01-13T09:04:36.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7594662258354061347" data-draft-id="7594396368174350371" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="0代码手写！体验百度Comate的“魔法”：我造了个会理解情绪的中介层"/> <meta itemprop="keywords" content="前端,程序员,前端框架"/> <meta itemprop="datePublished" content="2026-01-13T09:04:36.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="文心快码BaiduComate"/> <meta itemprop="url" content="https://juejin.cn/user/992209294070809"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            0代码手写！体验百度Comate的“魔法”：我造了个会理解情绪的中介层
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/992209294070809/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    文心快码BaiduComate
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-13T09:04:36.000Z" title="Tue Jan 13 2026 09:04:36 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读17分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>作者简介</p>
<p>陈良洪，系统架构师兼AI应用高级工程师，同时具备区块链技术背景。在AI编程实践中，深入应用代码智能补全、行间对话调试、Zulu（Agent）、Rules与Spec等范式，将AI深度集成于系统设计、开发、验证与优化的全流程，持续推动开发效率与代码质量的系统化提升。作品「Eme0情绪引擎」入围“CCF程序员大会码力全开：AI加速营”活动决赛，并获得“最佳创意奖” 。</p>
</blockquote>
<p>「Eme0情绪引擎」——一个完全由百度Comate IDE生成的AI情绪引擎，从想法到上线，我没有手写任何一行代码。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e89ff8780ef943d6b00fa047ba67ff10~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paH5b-D5b-r56CBQmFpZHVDb21hdGU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768899875&amp;x-signature=aJYTwN8Xms3SQBiwvUjoDAu6SIs%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<h2 data-id="heading-0">1 一个被忽视的痛点：AI为什么总是「冷冰冰」？</h2>
<p>我的创意来源：在深入研究AI对话系统时，我发现了一个有趣的现象：</p>
<p>大多数AI系统都有「记忆」，但很少有AI真正理解「情绪」。</p>
<p>想象一下，你和朋友聊天时：</p>
<p>朋友会记得你昨天心情不好，朋友会理解你今天的开心是因为昨天的困扰解决了，朋友会根据你的情绪状态调整说话的语气。</p>
<p>但现在的AI呢？它们能记住对话历史（记忆引擎），但它们无法理解情绪的变化规律，每次开发都要重新写情绪识别代码，而且很简陋。这就是我发现的痛点：情绪处理总是被当作临时功能，而不是一个专业的系统。</p>
<p><strong>灵感来源：</strong> 为什么不能有一个「情绪引擎」？就像记忆引擎一样，我想到：能不能把情绪处理也做成一个独立的、专业的引擎？这个引擎应该：可以被任何AI系统调用（就像插件一样），能够存储短期和长期的情绪记忆，理解情绪会随时间衰减（就像人类会慢慢忘记不愉快），能够生成个性化的情绪画像。于是，Eme0情绪引擎的想法诞生了。</p>
<h2 data-id="heading-1">2 技术蓝图：如何让AI拥有「情感大脑」？</h2>
<p>系统架构图⬇️⬇️</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d75655df939345589d8a73d9d6cd019b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paH5b-D5b-r56CBQmFpZHVDb21hdGU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768899875&amp;x-signature=a6UgPA7dUW73mdBxyF3OefWPyjI%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p>数据流转逻辑图⬇️⬇️</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c82a4dc55be44388b78a9f0e016227b2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paH5b-D5b-r56CBQmFpZHVDb21hdGU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768899875&amp;x-signature=tOdWr3rHnKev4M0ekRlHInl9CGk%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<h2 data-id="heading-2">3 实现过程：0手写代码的「神奇之旅」</h2>
<p>重要声明：整个项目，我没有手写任何一行代码。全部由百度Comate IDE自动生成。</p>
<h3 data-id="heading-3">3.1 编写开发文档</h3>
<p>我的操作：向Gemini描述项目需求</p>
<p>Gemini做了什么：自动生成完整的技术文档，规划模块结构。</p>
<p><strong>Prompt：</strong></p>
<p>参照Agent中间件记忆引擎，设计一个情绪引擎。情绪引擎也是Agent中间件，提供对话中情绪的上下文支持。按照标准的MCP Server实现，提供Tools，支持Agent配置MCP即插即用。情绪引擎名字叫Eme0。请编写AI能理解的开发文档，我将使用这份文档给AI开发实现。注意，给出开发文档即可，不需要实现。注意：从0设计情绪引擎，支持长短期记忆，设计情绪推理模型。如果需要使用LLM，对接百度千帆的最新模型。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/de23ae1b64254754bfa43b97306c92d9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paH5b-D5b-r56CBQmFpZHVDb21hdGU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768899875&amp;x-signature=z8CEgAwZDwmKKQihdfJ6pRmFCFI%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p>Gemini编写开发文档</p>
<p>后来经过实践发现，Comate也有Spec能力-即辅助澄清需求并生成专业的技术规格文档，因为这是我第一次使用Comate，所以在最初规划时，使用了自己最熟悉的Gemini。</p>
<h3 data-id="heading-4">3.2 初版实现</h3>
<p>我的操作：告诉Comate「按照文档实现代码」</p>
<p>Comate做了什么：自动生成所有核心模块代码，实现MCP Server标准接口，完成情绪识别、记忆管理等核心功能。</p>
<p><strong>Prompt：</strong></p>
<pre><code class="hljs language-markdown" lang="markdown">基于下面的开发文档，使用Python语言，编写实现Eme0记忆引擎。需要反复调试，直到运行无问题，能正常使用为止。

这是一份为AI开发者设计的、基于Agent中间件记忆引擎（MCP Server标准）的<span class="hljs-strong">**情绪引擎 (Eme0)**</span> 开发文档。

-----

<span class="hljs-section"># 🤖 Eme0 情绪引擎 (Emotion Engine) 开发文档</span>

<span class="hljs-section">## 🚀 概述 (Overview)</span>

Eme0是一个Agent中间件，旨在为对话系统提供<span class="hljs-strong">**情绪上下文支持**</span>。它遵循标准的MCP Server架构实现，通过提供Tools接口，允许任何Agent实例进行即插即用配置，实现对话中的情绪感知、记忆和推理。

Eme0的核心目标是：

<span class="hljs-bullet">1.</span>  <span class="hljs-strong">**情绪感知 (Perception):**</span> 从对话文本中实时提取当前情绪。
<span class="hljs-bullet">2.</span>  <span class="hljs-strong">**情绪记忆 (Memory):**</span> 管理对话历史中的长期和短期情绪状态。
<span class="hljs-bullet">3.</span>  <span class="hljs-strong">**情绪推理 (Inference):**</span> 基于历史和当前情绪，推断用户或Agent的深层情绪状态和潜在意图。
<span class="hljs-bullet">4.</span>  <span class="hljs-strong">**上下文支持 (Context):**</span> 将推理后的情绪信息作为上下文，喂给Agent的LLM，指导其生成更具情商和连贯性的回复。

<span class="hljs-section">## ⚙️ MCP Server 实现标准</span>

Eme0将实现为一个独立的微服务（Microservice），完全符合<span class="hljs-strong">**Agent中间件（MCP Server）**</span> 规范。

<span class="hljs-section">### 1. Tools 接口定义</span>

Eme0的核心功能通过标准的MCP Tool接口暴露，供Agent配置使用。

| Tool Name | Method Signature (伪代码) | 功能描述 |
| :--- | :--- | :--- |
| <span class="hljs-code">`eme0_analyze_emotion`</span> | <span class="hljs-code">`analyze(dialogue_turn: str, user_id: str, session_id: str) -&gt; EmotionResult`</span> | <span class="hljs-strong">**实时情绪分析**</span>。对当前的对话回合（文本）进行情绪识别，并更新短期记忆。 |
| <span class="hljs-code">`eme0_get_context`</span> | <span class="hljs-code">`get_context(user_id: str, session_id: str) -&gt; EmotionContext`</span> | <span class="hljs-strong">**获取情绪上下文**</span>。基于短/长期记忆和推理模型，生成当前最相关的情绪描述，供LLM作为Prompt输入。 |
| <span class="hljs-code">`eme0_update_long_term`</span> | <span class="hljs-code">`update_long_term(user_id: str, summary: EmotionSummary)`</span> | <span class="hljs-strong">**更新长期情绪记忆**</span>。在Session结束或特定时间点，将短期情绪总结归档到长期记忆。 |

<span class="hljs-section">### 2. 数据结构定义</span>

<span class="hljs-section">#### A. EmotionResult (实时分析结果)</span>

{
  "primary<span class="hljs-emphasis">_emotion": "sadness",             // 主要情绪 (如：高兴, 愤怒, 悲伤, 惊讶, 恐惧, 平静)
  "emotion_</span>intensity": 0.85,                // 情绪强度 (0.0 - 1.0)
  "emotion<span class="hljs-emphasis">_keywords": ["失落", "不顺利"],   // 提取出的情绪关键词
  "raw_</span>llm<span class="hljs-emphasis">_response": "..."                 // LLM分析的原始输出（用于调试）
}

#### B. EmotionContext (提供给LLM的上下文)

{
  "short_</span>term<span class="hljs-emphasis">_summary": "用户在过去3句话中，情绪从‘平静’逐渐转为‘轻微不满’。",
  "long_</span>term<span class="hljs-emphasis">_profile": "根据历史记录，用户近期情绪波动较大，尤其容易在讨论工作时表现出‘焦虑’。",
  "inferred_</span>intention": "当前的不满可能源于对之前某个问题的未解决。",
  "suggested<span class="hljs-emphasis">_agent_</span>tone": "<span class="hljs-strong">**共情且温柔地**</span>（使用指令格式，方便LLM理解）"
}


<span class="hljs-section">## 🧠 核心模块设计</span>

Eme0由三个核心模块构成：情绪识别模块、情绪记忆管理模块和情绪推理模型。

<span class="hljs-section">### 1. 情绪识别模块 (Emotion Recognition Module)</span>

<span class="hljs-bullet">  *</span> <span class="hljs-strong">**目标：**</span> 实现 <span class="hljs-code">`eme0_analyze_emotion`</span> Tool。
<span class="hljs-bullet">  *</span> <span class="hljs-strong">**技术栈：**</span> <span class="hljs-strong">**百度千帆 LLM**</span>。
<span class="hljs-bullet">  *</span> <span class="hljs-strong">**实现细节：**</span>
<span class="hljs-bullet">      *</span> <span class="hljs-strong">**Prompt 设计：**</span> 将当前的 <span class="hljs-code">`dialogue_turn`</span> 作为输入，要求LLM执行<span class="hljs-strong">**中文情绪分类**</span>和<span class="hljs-strong">**强度评估**</span>。
<span class="hljs-bullet">      *</span> <span class="hljs-strong">**输出格式：**</span> 严格要求LLM输出符合 <span class="hljs-strong">**EmotionResult**</span> 的 JSON 格式。
<span class="hljs-bullet">      *</span> <span class="hljs-strong">**LLM 对接：**</span> 使用百度千帆的最新中文理解模型（如ERNIE 4.0或其他推荐的对话模型）进行零样本（Zero-Shot）或少样本（Few-Shot）情绪分类。

<span class="hljs-section">### 2. 情绪记忆管理模块 (Emotion Memory Management)</span>

此模块负责管理长短期情绪记忆，是情绪上下文支持的基石。

<span class="hljs-section">#### A. 短期情绪记忆 (Short-Term Memory, STM)</span>

<span class="hljs-bullet">  *</span> <span class="hljs-strong">**存储内容：**</span> 存储当前Session中每个对话回合的 <span class="hljs-code">`EmotionResult`</span>。
<span class="hljs-bullet">  *</span> <span class="hljs-strong">**机制：**</span> 采用<span class="hljs-strong">**滑动窗口**</span>或<span class="hljs-strong">**有限长度列表**</span>（推荐存储最近 $N=10$ 个回合的情绪记录）。
<span class="hljs-bullet">  *</span> <span class="hljs-strong">**更新：**</span> 每次调用 <span class="hljs-code">`eme0_analyze_emotion`</span> 后立即更新。
<span class="hljs-bullet">  *</span> <span class="hljs-strong">**用途：**</span> 用于捕捉情绪的<span class="hljs-strong">**瞬时变化**</span>和<span class="hljs-strong">**连贯性**</span>。

<span class="hljs-section">#### B. 长期情绪记忆 (Long-Term Memory, LTM)</span>

<span class="hljs-bullet">  *</span> <span class="hljs-strong">**存储内容：**</span> 存储过去Session的情绪总结 (<span class="hljs-code">`EmotionSummary`</span>) 和用户的情绪画像 (<span class="hljs-code">`Emotional Profile`</span>)。
<span class="hljs-bullet">  *</span> <span class="hljs-strong">**机制：**</span> 采用<span class="hljs-strong">**向量数据库**</span>或<span class="hljs-strong">**键值存储 (Key-Value Store)**</span>。<span class="hljs-code">`Key`</span> 为 <span class="hljs-code">`user_id`</span>，<span class="hljs-code">`Value`</span> 为用户情绪画像的结构化数据或总结文本。
<span class="hljs-bullet">  *</span> <span class="hljs-strong">**更新：**</span> 通过 <span class="hljs-code">`eme0_update_long_term`</span> Tool 调用，通常在Session结束后，对STM进行总结并归档。
<span class="hljs-bullet">  *</span> <span class="hljs-strong">**用途：**</span> 用于捕捉用户情绪的<span class="hljs-strong">**个性化倾向**</span>、<span class="hljs-strong">**敏感话题**</span>和<span class="hljs-strong">**周期性模式**</span>。

<span class="hljs-section">### 3. 情绪推理模型 (Emotion Inference Model)</span>

<span class="hljs-bullet">  *</span> <span class="hljs-strong">**目标：**</span> 实现 <span class="hljs-code">`eme0_get_context`</span> Tool。这是Eme0的<span class="hljs-strong">**核心价值**</span>。
<span class="hljs-bullet">  *</span> <span class="hljs-strong">**技术栈：**</span> <span class="hljs-strong">**百度千帆 LLM**</span> (作为推理核心)。
<span class="hljs-bullet">  *</span> <span class="hljs-strong">**推理逻辑：**</span>
<span class="hljs-bullet">    1.</span>  <span class="hljs-strong">**输入整合：**</span> 将STM的原始情绪序列 + LTM的长期情绪画像，整合成一个Prompt。
<span class="hljs-bullet">    2.</span>  <span class="hljs-strong">**Prompt 结构：**</span>
<span class="hljs-code">        &gt; **[系统指令]** 你是一个高级情感分析模型。请根据用户短期对话历史和长期情绪画像，推断用户当前的情绪状态、深层意图，并建议Agent的回复语气。
        &gt; **[短期历史]** (最近 $N$ 个回合的情绪记录，如：`T-3: 平静(0.2) -&gt; T-2: 略有不满(0.5) -&gt; T-1: 愤怒(0.9)`)
        &gt; **[长期画像]** (从LTM获取的总结文本，如：`用户对工作相关话题敏感，近期焦虑。`)
        &gt; **[要求]** 输出符合 **EmotionContext** 的 JSON 格式。
    3.  **输出：** LLM推断出 `short_term_summary`, `long_term_profile`, `inferred_intention`, `suggested_agent_tone`，然后封装成 `EmotionContext` 返回。
</span>
<span class="hljs-section">## 🛠️ Agent 配置与使用流程</span>

一个Agent (如 <span class="hljs-code">`Agent_A`</span>) 集成Eme0的流程如下：

<span class="hljs-bullet">1.</span>  <span class="hljs-strong">**配置：**</span> <span class="hljs-code">`Agent_A`</span> 在其MCP配置文件中声明依赖并配置Eme0的Tool。
<span class="hljs-bullet">2.</span>  <span class="hljs-strong">**对话开始：**</span> 用户说出 $Turn<span class="hljs-emphasis">_k$。
3.  <span class="hljs-strong">**情绪分析 (Perception):**</span> `Agent_</span>A<span class="hljs-code">` 调用 `</span>eme0<span class="hljs-emphasis">_analyze_</span>emotion(Turn<span class="hljs-emphasis">_k, user_</span>id, session<span class="hljs-emphasis">_id)`。
      * Eme0返回 $EmotionResult_</span>k$，并更新STM。
<span class="hljs-bullet">4.</span>  <span class="hljs-strong">**上下文获取 (Context Retrieval):**</span> <span class="hljs-code">`Agent_A`</span> 调用 <span class="hljs-code">`eme0_get_context(user_id, session_id)`</span>。
<span class="hljs-bullet">      *</span> Eme0触发<span class="hljs-strong">**情绪推理模型**</span>，返回 $EmotionContext$。
<span class="hljs-bullet">5.</span>  <span class="hljs-strong">**LLM 生成回复：**</span> <span class="hljs-code">`Agent_A`</span> 将 $Turn<span class="hljs-emphasis">_k$ 和 $EmotionContext$ (尤其是 `suggested_</span>agent<span class="hljs-emphasis">_tone`) 一起喂给自己的主LLM，生成回复。
      * <span class="hljs-strong">**Prompt 示例：**</span> `[EmotionContext.suggested_</span>agent<span class="hljs-emphasis">_tone] + 请根据对话历史，回复用户: [Turn_</span>k]`
<span class="hljs-bullet">6.</span>  <span class="hljs-strong">**Session 结束：**</span> <span class="hljs-code">`Agent_A`</span> 调用 <span class="hljs-code">`eme0_update_long_term(user_id, STM_Summary)`</span>，归档情绪记忆。

-----

<span class="hljs-section">## 🔒 约束与注意事项</span>

<span class="hljs-bullet">1.</span>  <span class="hljs-strong">**Latency (延迟):**</span> 由于情绪分析和推理均依赖LLM，<span class="hljs-strong">**性能是关键**</span>。需要优化对百度千帆API的调用频率和处理速度。建议在实时对话中，只对关键回合进行完整的推理。
<span class="hljs-bullet">2.</span>  <span class="hljs-strong">**Cost (成本):**</span> 频繁调用LLM进行推理会产生费用。需要设计缓存机制，或对推理级别进行分级。
<span class="hljs-bullet">3.</span>  <span class="hljs-strong">**情绪标准化:**</span> 确保情绪分类体系（如“高兴”、“愤怒”等）在情绪识别模块和推理模型中保持<span class="hljs-strong">**一致性**</span>。
<span class="hljs-bullet">4.</span>  <span class="hljs-strong">**并发性:**</span> Eme0作为一个中间件服务，必须具备高并发处理能力，能同时处理多个Agent的请求。

请使用这份文档来指导您的AI开发者团队，实现这个情绪引擎。
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5bbe8afa868045599dd5ac8aa52b6f08~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paH5b-D5b-r56CBQmFpZHVDb21hdGU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768899875&amp;x-signature=pp4fRsWMEHpF259m8CT37JqpFtg%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p>Comate初版实现</p>
<h3 data-id="heading-5">3.3 自运行改Bug</h3>
<p>我的操作：运行代码，发现问题</p>
<p>Comate做了什么：自动分析运行日志，定位Bug位置，生成修复方案，自动修复代码。</p>
<p>结果：实时调试，无需手动排查</p>
<p><strong>Prompt：</strong></p>
<p>调用mcp client，修改到能正常运行。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1fb8f3ccaef3446ea4cd214bd05d883e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paH5b-D5b-r56CBQmFpZHVDb21hdGU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768899875&amp;x-signature=r3J%2BhiL21UJ%2F40op%2FjTowlzKZKg%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p>Comate自动分析运营日志，修复Bug</p>
<h3 data-id="heading-6">3.4 自主编写测试case</h3>
<p>我的操作：要求Comate「编写测试用例</p>
<p>Comate做了什么：自动生成5个真实场景的测试用例，包括工作压力、喜悦分享、失落恢复等场景，验证情绪识别准确率达到91%以上</p>
<p>结果：全面测试，确保功能可靠性</p>
<p><strong>Prompt：</strong></p>
<p>python main.py 把项目运行起来，修改所有的问题和Bug。能运行之后，编写测试文件，使用MCP Client的方式调用，写5个测试case，每个case要求连续对话，充分体现情绪引擎的优点。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a48f4dbbd19341e7822587a9eed4a8b6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paH5b-D5b-r56CBQmFpZHVDb21hdGU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768899875&amp;x-signature=IrXCO6X7Mlp8HJTsi%2FzUUMyEIiA%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p>自主编写case测试</p>
<h3 data-id="heading-7">3.5 增加MCP Server日志</h3>
<p>我的操作：要求「增加日志系统」</p>
<p>Comate做了什么：自动在关键节点添加日志，实现错误追踪机制，优化调试体验</p>
<p>结果：完善的监控和调试能力</p>
<p><strong>Prompt：</strong></p>
<p>给MCP-server增加输入、输出、耗时的日志打印</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/989bfbeb46d94e338a393bd2e3ece1af~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paH5b-D5b-r56CBQmFpZHVDb21hdGU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768899875&amp;x-signature=Q5q2EfTpVPLzxBONqJp6KC4hDhM%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p>增加MCP Server日志</p>
<h3 data-id="heading-8">3.6 情绪衰减模型优化</h3>
<p>我的操作：描述衰减模型的需求</p>
<p>Comate做了什么：设计衰减算法公式，实现时间权重计算，优化参数配置。</p>
<p>关键描述：</p>
<p>「情绪会随时间衰减，就像人类会慢慢忘记不愉快」「3小时前的情绪比24小时前的更重要」</p>
<p>结果：实现了符合人类心理特征的衰减模型</p>
<p><strong>Prompt：</strong></p>
<p>优化情绪衰减模型，针对长期情绪画像的建立。增加内存记忆，实现长期情绪画像建立。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/239d552bd28941f4af7526735f16a598~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paH5b-D5b-r56CBQmFpZHVDb21hdGU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768899875&amp;x-signature=0JCBlt6hZgWUe6tKT%2BOKR3Nm3ww%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p>情绪衰减模型优化</p>
<h3 data-id="heading-9">3.7 最终测试效果</h3>
<p>经过完整测试，情绪引擎表现优异</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4a0491a92b994028923072dbbfdfce98~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paH5b-D5b-r56CBQmFpZHVDb21hdGU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768899875&amp;x-signature=HzFkubOVuI68zDyEkYDDtS%2ByS5c%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p>最终测试效果</p>
<h4 data-id="heading-10">3.7.1 测试逻辑</h4>
<p>根据AI编写的Case测试，Case覆盖多类情绪识别、情绪变化、情绪融合、情绪记忆、情绪画像等。运行 python test_eme0_client.py 执行测试，查看输出的对话内容、情绪识别等，判断情绪引擎表现效果。</p>
<h4 data-id="heading-11">3.7.2 测试表现</h4>
<p>1.情绪识别精准度 (Accuracy &amp; Consistency)</p>
<p>系统对用户表达的正面情绪捕捉极其敏锐，且具备高置信度。</p>
<ul>
<li>识别准确率： 在连续三轮高强度正面情绪（面试通过、面试官满意、梦寐以求的公司）输入下，系统均准确识别为 happiness。</li>
<li>情绪强度监测： 识别出的情绪强度（intensity）稳定维持在 0.90，准确反映了用户“太棒了”、“太开心了”的强烈情感。</li>
<li>关键词提取逻辑： 系统能精准提取出 [太棒了, 通过, 重要]、[满意, 开心]、[梦寐以求, 做梦一样] 等核心情感词汇，证明了其底层语义理解的深度。</li>
</ul>
<p>2.系统性能耗时 (Latency &amp; Performance)</p>
<p>在复杂的推理链（包括情绪分析、上下文检索、意图推断）下，系统表现出了优秀的响应速度。</p>
<ul>
<li>单次情绪推理耗时： 平均约为 2.97s（第一轮 3.203s，随后的第二、三轮优化至 2.8s 左右）。</li>
<li>工具调用总延迟： 包含 analyze_emotion 逻辑在内的总响应时间稳定在 3.0s 左右，满足实时交互的基础需求。</li>
</ul>
<p>3.用户情绪画像与记忆管理 (Memory &amp; Profiling)</p>
<p>日志显示系统不仅在“听”，更在“记”，成功构建了动态的用户画像。</p>
<ul>
<li>长期画像更新： 系统成功将“面试”这一核心事件记录进 long_term_profile，并实时生成了“暂无历史情绪挑战数据”的背景评估。</li>
<li>短期策略适配： 基于当前 happiness 的情绪状态，系统自动推断出用户意图为 “用户分享积极体验或寻求认可”。</li>
<li>话术风格建议： 引擎给出的 suggested_agent_tone（建议语气）为 “热情洋溢地分享喜悦”，实现了从识别到行动建议的闭环。</li>
</ul>
<p>想要运行「Eme0情绪引擎」，请参考产品Github文档 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fwohunlfry%2FEme0" target="_blank" title="https://github.com/wohunlfry/Eme0" ref="nofollow noopener noreferrer">github.com/wohunlfry/E…</a> “快速开始”部分。</p>
<h2 data-id="heading-12">4 Comate清退开发路上的「拦路虎」</h2>
<p><strong>问题1：工程不能运行</strong></p>
<p>问题描述：AI编写出来的工程无法正常运行，或者运行后调用时出现bug。</p>
<p>解决方案：给AI下达循环命令，要求AI运行并修复错误，直到无错误为止。要求AI编写调用示例，跟踪错误日志，修改到无错误为止。</p>
<p>Comate的帮助：自动运行，自动修改错误和异常，解放人力。交付的结果一定能运行。</p>
<p><strong>问题2：MCP实现的协议不对</strong></p>
<p>问题描述：MCP按照RESTful API实现，没有走MCP的专用协议。</p>
<p>解决方案：提供stdio协议的标准示例，让AI修改。</p>
<p>Comate的帮助：按照协议模板，直接升级协议，无需人工修改。</p>
<p><strong>问题3：修改位置不对</strong></p>
<p>问题描述：AI修改代码时，修改的位置不正确。</p>
<p>解决方案：明确指出需要修改的代码和引用文件，强调修改范围，要求重新修改。</p>
<p>Comate的帮助：按照要求实现，仅修改指定部分。</p>
<p><strong>问题4：不是最优方案就执行，要回退</strong></p>
<p>问题描述：AI在未确认最优方案的情况下就执行修改，导致需要回退。</p>
<p>解决方案：明确要求提供多个方案，确认方案之后，才可以执行修改动作。</p>
<p>Comate的帮助：提供多方案选择，节省返工时间。SPEC模式，拆解流程，分步骤执行。</p>
<p><strong>问题5：对接千帆失败</strong></p>
<p>问题描述：对接的千帆API无法正确调用。</p>
<p>解决方案：提供千帆官方示例Python代码。</p>
<p>Comate的帮助：按照对接方式，快速完成修改。</p>
<p><strong>问题6：核心逻辑太简单</strong></p>
<p>问题描述：核心的情绪衰减算法设计过于简单。</p>
<p>解决方案：提供详细的衰减算法、原理和要求，要求升级。</p>
<p>Comate的帮助：按照要求实现算法升级。</p>
<p><strong>问题7：测试用例未覆盖全场景</strong></p>
<p>问题描述：测试用例未覆盖全部场景。</p>
<p>解决方案：提供未覆盖的场景，让AI增加测试用例。</p>
<p>Comate的帮助：按照要求实现新的测试用例。</p>
<p><strong>问题8：README文档结构问题</strong></p>
<p>问题描述：README文档结构不合理。</p>
<p>解决方案：提供结构大纲，重新编写README，并编写英文版。</p>
<p>Comate的帮助：按照要求实现新文档。</p>
<h2 data-id="heading-13">5 Comate亮点：AI给我的帮助</h2>
<p>在整个开发过程中，Comate展现出了惊艳的能力。以下是我感受最深的几个亮点：</p>
<p><strong>系统架构设计：专业级的模块划分</strong></p>
<ul>
<li>传统方式：需要资深架构师，反复讨论</li>
<li>Comate方式：自动设计模块结构，符合最佳实践</li>
<li>我的体验：Comate深刻理解MCP Server标准，自动划分功能模块，设计清晰的数据流。</li>
</ul>
<p><strong>细节实现完善：边界条件和异常处理</strong></p>
<ul>
<li>传统方式：容易遗漏边界情况，后期bug多</li>
<li>Comate方式：自动补充边界条件处理、异常捕获</li>
<li>我的体验：代码健壮性大幅提升，减少后期维护成本，系统稳定性更好。</li>
</ul>
<p><strong>自主问题修复：智能调试助手</strong></p>
<ul>
<li>传统方式：需要手动分析日志，定位Bug</li>
<li>Comate方式：运行后自动分析，定位并修复问题</li>
<li>我的体验：大幅缩短调试周期，减少重复性工作，提升开发效率。</li>
</ul>
<p><strong>测试用例生成：全面的质量保障</strong></p>
<ul>
<li>传统方式：需要手动编写测试用例，容易遗漏场景</li>
<li>Comate方式：自动生成全面的测试用例</li>
<li>我的体验：覆盖5个真实场景，验证功能可靠性，确保系统质量。</li>
</ul>
<p><strong>日志系统优化：完善的监控能力</strong></p>
<ul>
<li>传统方式：需要手动添加日志，容易遗漏关键节点</li>
<li>Comate方式：自动完善日志记录机制</li>
<li>我的体验：关键节点都有日志，方便错误溯源，提升可维护性。</li>
</ul>
<p><strong>核心算法设计：情绪衰减模型</strong></p>
<ul>
<li>传统方式：需要数学建模，反复验证</li>
<li>Comate方式：描述需求，自动设计算法</li>
<li>我的体验：描述「情绪会随时间衰减」，Comate自动设计衰减公式，实现符合人类心理特征的算法</li>
</ul>
<p><strong>提示语工程：高质量的情绪识别</strong></p>
<ul>
<li>传统方式：需要反复试验，调整提示语</li>
<li>Comate方式：自动生成高质量提示语</li>
<li>我的体验：初始提示语就很准确，持续优化提升精度，情绪识别准确率达91%。</li>
</ul>
<p><strong>提示语迭代优化：持续改进</strong></p>
<ul>
<li>传统方式：需要人工分析结果，手动优化</li>
<li>Comate方式：基于测试反馈自动优化</li>
<li>我的体验：自动分析识别错误，生成优化方案，持续提升准确率。</li>
</ul>
<h2 data-id="heading-14">6 经验分享：如何用好Comate的Prompt</h2>
<p>经过这次开发，我总结了一些使用Comate的Prompt经验，希望对大家有帮助：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/80b759b87f964267926e73edcbe3f467~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paH5b-D5b-r56CBQmFpZHVDb21hdGU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768899875&amp;x-signature=YLqpI477Tw3wf85FrYIoYYda7zk%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<h2 data-id="heading-15">7 总结：AI开发的新时代</h2>
<p>我的最大感受：</p>
<p>使用Comate后，我的工作重心从「怎么写代码」转变为「要什么功能」。使用Comate，就像拥有一个资深架构师 + 全栈工程师的团队随时待命：提出需求，它立即实现代码；发现Bug，它快速定位并修复；需要测试，它自动生成用例；需要文档，它一键生成说明。当然，这也意味着我需要将更多精力投入到技术栈管理、测试验收和产品体验优化上。</p>
<p>给开发者的建议：</p>
<p>如果你也是：AI应用开发者，Agent系统构建者，对效率有极致追求的工程师，强烈建议体验百度Comate。它不仅仅是编码工具，更是你技术团队的「能力倍增器」。在AI编码时代，掌握Comate这样的智能工具，比掌握任何单一编程语言更重要。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[重拾Eval能力：D4rt为Flutter注入AI进化基因]]></title>    <link>https://juejin.cn/post/7594626381432881202</link>    <guid>https://juejin.cn/post/7594626381432881202</guid>    <pubDate>2026-01-13T09:22:58.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7594626381432881202" data-draft-id="7594578555352416307" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="重拾Eval能力：D4rt为Flutter注入AI进化基因"/> <meta itemprop="keywords" content="Flutter,Dart,客户端"/> <meta itemprop="datePublished" content="2026-01-13T09:22:58.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="程序员老刘"/> <meta itemprop="url" content="https://juejin.cn/user/662360127965769"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            重拾Eval能力：D4rt为Flutter注入AI进化基因
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/662360127965769/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    程序员老刘
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-13T09:22:58.000Z" title="Tue Jan 13 2026 09:22:58 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><strong>大家好，我是老刘</strong></p>
<p>Flutter 开发者一直面临一个痛点：<strong>动态化</strong>。</p>
<p>在移动端，Flutter 主要依赖 AOT（Ahead-Of-Time）编译以保证高性能，但这同时也意味着代码一旦打包，就变得难以修改。</p>
<p>最近，<strong>D4rt</strong> 的出现引起了关注。它是一个纯 Dart 实现的运行时解释器。</p>
<p>那么，D4rt 会是 Flutter 动态化的最优解吗？它能取代现有的热更新方案吗？</p>
<p>本文将深入探讨 D4rt 的原理、优缺点，以及它真正适合的应用场景。</p>
<hr/>
<h2 data-id="heading-0">一、D4rt 是个啥？</h2>
<p>简单来说，<strong>D4rt</strong> 是一个用于 <strong>Dart 语言的运行时解释器</strong> 库。</p>
<p>它的核心能力是：<strong>让你的 Dart/Flutter 应用能够在运行时动态执行 Dart 代码</strong>。</p>
<p>通过在应用内集成一个解释器，D4rt 打破了 AOT 的限制，使得下发源代码并在运行时动态执行成为可能。</p>
<h3 data-id="heading-1">1. 核心功能</h3>
<ul>
<li><strong>动态执行 Dart 代码</strong>：可以直接将一段 Dart 代码字符串（String）传给解释器并运行。</li>
<li><strong>基于 AST 分析</strong>：它基于 Dart 官方的 <code>analyzer</code> 包，通过分析代码的抽象语法树（AST）来模拟执行。</li>
<li><strong>支持主要语法特性</strong>：支持类（Class）、混入（Mixin）、扩展（Extension）、异步编程（async/await）、枚举（Enum）等大部分 Dart 语法。</li>
<li><strong>Flutter 集成 (<code>flutter_d4rt</code>)</strong>：配合 <code>flutter_d4rt</code> 包，你可以使用 <code>InterpretedWidget</code> 直接把一段代码渲染成 Flutter 组件。</li>
</ul>
<h3 data-id="heading-2">2. 代码示例</h3>
<p><strong>简单的动态执行逻辑：</strong></p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-keyword">import</span> <span class="hljs-string">'package:d4rt/d4rt.dart'</span>;

<span class="hljs-keyword">void</span> main() {
  <span class="hljs-keyword">final</span> interpreter = DartInterpreter();
  
  <span class="hljs-comment">// 定义一段代码字符串</span>
  <span class="hljs-keyword">const</span> code = <span class="hljs-string">'''
    int add(int a, int b) {
      return a + b;
    }
    
    void main() {
      print(add(10, 20));
    }
  '''</span>;

  <span class="hljs-comment">// 动态执行</span>
  interpreter.evaluate(code); <span class="hljs-comment">// 输出: 30</span>
}
</code></pre>
<p><strong>在 Flutter 中动态渲染组件（使用 <code>flutter_d4rt</code>）：</strong></p>
<pre><code class="hljs language-dart" lang="dart">InterpretedWidget(
  code: <span class="hljs-string">'''
    import 'package:flutter/material.dart';
    
    class MyWidget extends StatelessWidget {
      @override
      Widget build(BuildContext context) {
        return Center(
          child: Text('这是动态渲染的文字！'),
        );
      }
    }
  '''</span>,
  entryPoint: <span class="hljs-string">'MyWidget'</span>, <span class="hljs-comment">// 指定入口类名</span>
)
</code></pre>
<h3 data-id="heading-3">3. 优缺点分析</h3>
<ul>
<li><strong>优点</strong>：
<ul>
<li><strong>灵活性极高</strong>：不需要重新编译即可改变逻辑和 UI。</li>
<li><strong>统一语言</strong>：动态脚本直接使用 Dart，不需要像以前那样引入 Lua 或 JavaScript 引擎（如 QuickJS）再做桥接。</li>
</ul>
</li>
<li><strong>缺点</strong>：
<ul>
<li><strong>性能损耗</strong>：解释执行的性能肯定不如 AOT 编译的原生代码，不适合跑高密度的计算逻辑。</li>
<li><strong>体积增加</strong>：引入解释器和 AST 分析器会增加 App 的包体积。</li>
<li><strong>合规风险</strong>：iOS App Store 对“下载可执行代码”有严格限制，使用此类技术需确保不违反审核条款（通常用于配置下发或企业内部应用没问题）。</li>
</ul>
</li>
</ul>
<hr/>
<h2 data-id="heading-4">二、应用场景分析</h2>
<h3 data-id="heading-5">1. 误区：它不适合作为通用的动态化解决方案</h3>
<p>作为 Flutter 开发者，看到“动态执行”，第一反应往往是 <strong>App 动态化</strong> 或 <strong>热补丁</strong>。
<strong>但是，D4rt 并不适合作为通用的 Flutter 动态化或热修复方案。</strong></p>
<p>核心原因在于 <strong>性能</strong>。</p>
<ul>
<li><strong>解释执行 vs AOT</strong>：Flutter 的流畅性很大程度上归功于 Dart 的 AOT 编译，生成高效的机器码。D4rt 是纯 Dart 实现的解释器，运行时解析 AST 并模拟执行，性能与原生 AOT 代码相比有数量级的差距。</li>
<li><strong>渲染卡顿</strong>：如果用它来渲染复杂的动态页面，构建 Widget 树的过程都在解释器中运行，极易造成 UI 线程阻塞，导致掉帧和卡顿，完全丧失了 Flutter 的高性能优势。</li>
</ul>
<p><strong>结论</strong>：如果你的目标是“热更新整个页面”或“修复核心业务逻辑”，D4rt 撑不起这个需求。</p>
<h3 data-id="heading-6">2. 它真正适合的场景</h3>
<p>虽然不能做全量热修复，但 D4rt 在 <strong>低频、轻量、高动态</strong> 的场景下大有可为。它更像我们在游戏中常见的 <strong>Lua 脚本</strong>。</p>
<h4 data-id="heading-7">2.1 动态业务规则引擎</h4>
<p>比如电商 App 的 <strong>优惠券计算逻辑</strong>、游戏的 <strong>数值策划公式</strong>。</p>
<p>这些逻辑经常变动，但计算量小，不需要重新发版，直接下发一段 Dart 函数即可。</p>
<p><strong>优势</strong>：比 JSON 表达式更强大，支持完整的 Dart 语法（如循环、复杂条件判断）。</p>
<h4 data-id="heading-8">2.2 应用内调试控制台 (REPL)</h4>
<p>为开发者或测试人员提供一个“后门”。</p>
<p>比如在 Release 包中集成一个隐藏入口，打开后可以输入 Dart 代码直接读取内存变量、修改状态或执行方法。</p>
<p>这在桌面端应用或游戏开发工具中比较常见，极大便利了现场 Debug。</p>
<h4 data-id="heading-9">2.3 教育与原型工具</h4>
<p>开发类似“Dart 学习手册”的 App，允许用户在手机上编写并运行示例代码。</p>
<p>用户可以实时查看代码执行结果，理解 Dart 语法和 Flutter 组件的工作原理。</p>
<h4 data-id="heading-10">2.4 你的 App 该学会自己写代码了 (AI Self-Iteration)</h4>
<p>其实前面说的应用场景更多的是基于编程语言可以自解释运行的一些推测。</p>
<p>但是我觉得我们之前的想象力，还是太收敛了，其实<code>eval</code>这个能力结合AI可以有更有趣的应用场景。</p>
<p>现在的 App 是开发者的作品，是静态的交付物。</p>
<p>但如果 App 接入了端侧大模型，手里又握着 Dart 这把“手术刀”，事情就变得有意思了。</p>
<ol>
<li><strong>场景</strong>：用户抱怨“按钮太小”。</li>
<li><strong>传统流程</strong>：反馈 -&gt; 排期 -&gt; 开发 -&gt; 测试 -&gt; 发版 -&gt; 更新。</li>
<li><strong>AI 赋能流程</strong>：
<ul>
<li>App 内置 AI 收到反馈。</li>
<li>后台生成新的 Dart 代码片段（如 <code>height: 60.0</code>）。</li>
<li>利用 D4rt 动态执行，界面当场改变。</li>
<li>AI 询问：“现在舒服了吗？”</li>
</ul>
</li>
</ol>
<p>这才是真正的 <strong>自我进化</strong>。App 像有生命的细胞，根据用户反馈实时调整自己的 DNA（代码），不再受限于漫长的发版周期。</p>
<p>当然要想实现前面说的这些，光有一个D4rt还是远远不够的，但是我觉得<code>eval</code>可能是这一切的核心。</p>
<hr/>
<h2 data-id="heading-11">三、竞品对比：D4rt vs flutter_eval</h2>
<p>提到 Dart 动态执行，不得不提另一个重量级选手：<strong>flutter_eval</strong> (及其核心 dart_eval)。</p>
<p>虽然两者的目标都是“运行动态代码”，但它们走的是完全不同的技术路线。</p>
<h3 data-id="heading-12">1. 技术原理差异</h3>
<ul>
<li>
<p><strong>flutter_d4rt (AST 派)</strong>：</p>
<ul>
<li><strong>原理</strong>：它是一个<strong>纯源码解释器</strong>。利用 <code>analyzer</code> 库解析源码生成抽象语法树（AST），然后遍历树来模拟执行。</li>
<li><strong>特点</strong>：所见即所得，无需中间编译，直接扔进字符串就能跑。但每次执行都要遍历树结构，开销较大。</li>
</ul>
</li>
<li>
<p><strong>flutter_eval (字节码 派)</strong>：</p>
<ul>
<li><strong>原理</strong>：它是一个<strong>编译器 + 虚拟机</strong>。先将 Dart 代码编译成自定义的 EVC 字节码，然后在轻量级虚拟机中执行。</li>
<li><strong>特点</strong>：类似 Java 或 Lua 的运行机制。字节码更紧凑，执行效率更高，且支持下发预编译文件。</li>
</ul>
</li>
</ul>
<h3 data-id="heading-13">2. 核心对比</h3>



































<table><thead><tr><th align="left">特性</th><th align="left">flutter_d4rt (d4rt)</th><th align="left">flutter_eval (dart_eval)</th></tr></thead><tbody><tr><td align="left"><strong>核心原理</strong></td><td align="left"><strong>AST 解释器</strong> (直接解析源码树)</td><td align="left"><strong>字节码虚拟机</strong> (源码 -&gt; EVC字节码 -&gt; 虚拟机)</td></tr><tr><td align="left"><strong>性能</strong></td><td align="left">较低 (需实时遍历语法树)</td><td align="left"><strong>较高</strong> (执行优化后的字节码)</td></tr><tr><td align="left"><strong>输入格式</strong></td><td align="left">Dart 源代码字符串</td><td align="left">Dart 源代码 或 <strong>预编译的 .evc 字节码</strong></td></tr><tr><td align="left"><strong>主要用途</strong></td><td align="left">规则引擎、简单UI动态化、教学/REPL</td><td align="left"><strong>App热更新</strong>、复杂动态页面、业务逻辑下发</td></tr><tr><td align="left"><strong>开发流</strong></td><td align="left">简单直观，即插即用</td><td align="left">相对复杂，生产环境建议配合 CLI 预编译</td></tr></tbody></table>
<h3 data-id="heading-14">3. 该怎么选？</h3>
<ul>
<li>
<p><strong>选 flutter_d4rt</strong>：</p>
<ul>
<li>如果你做的是 <strong>Dart 学习工具</strong> 或 <strong>REPL 控制台</strong>，用户输入什么就得跑什么。</li>
<li>如果逻辑非常简单（如一段简短的计算公式），不想引入复杂的编译流程。</li>
</ul>
</li>
<li>
<p><strong>选 flutter_eval</strong>：</p>
<ul>
<li>如果你有 <strong>热更新 (Code Push)</strong> 需求，甚至想动态替换某个页面。</li>
<li>如果动态代码中有复杂的循环、大量对象创建，对性能有要求。</li>
<li>如果你希望下发的文件体积更小且加载更快（使用 .evc 字节码）。</li>
</ul>
</li>
</ul>
<p>注意 ：无论哪种方案，iOS App Store 都严禁下发可执行代码（二进制或脚本）来改变应用核心功能，使用此类技术时请务必注意审核合规性（通常用于企业包或配置性质的逻辑更新）</p>
<hr/>
<h2 data-id="heading-15">四、总结</h2>
<p>虽然受限于解释执行的性能，它注定无法成为通用的热更新解决方案，但在特定领域——尤其是 <strong>规则计算</strong>、<strong>调试工具</strong> 以及未来的 <strong>AI 辅助生成</strong>——它提供了极具想象力的可能性。</p>
<p>技术总是螺旋上升的。从早期的动态脚本，到追求极致性能的 AOT，再到如今为了灵活性和 AI 赋能重新审视 <code>eval</code> 能力。</p>
<p>D4rt 提醒我们：<strong>在静态的编译产物之外，软件还可以拥有一种更灵动、更具适应性的形态。</strong></p>
<p>掌握它，不是为了滥用动态化，而是为了在那些需要“灵光一闪”的时刻，你的工具箱里恰好有一把趁手的钥匙。</p>
<blockquote>
<p>如果看到这里的同学对客户端或者Flutter开发感兴趣，欢迎联系老刘，我们互相学习。</p>
<p>私信免费领老刘整理的《Flutter开发手册》，覆盖90%应用开发场景。</p>
<p>可以作为Flutter学习的知识地图。</p>
<p>—— laoliu_dev</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Claude 终于对普通人下手了！Cowork 发布，你的最强 AI 打工搭子来了！]]></title>    <link>https://juejin.cn/post/7594576956421324826</link>    <guid>https://juejin.cn/post/7594576956421324826</guid>    <pubDate>2026-01-13T09:28:16.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7594576956421324826" data-draft-id="7594655863547658292" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Claude 终于对普通人下手了！Cowork 发布，你的最强 AI 打工搭子来了！"/> <meta itemprop="keywords" content="前端,后端"/> <meta itemprop="datePublished" content="2026-01-13T09:28:16.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="优弧"/> <meta itemprop="url" content="https://juejin.cn/user/852876722177533"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Claude 终于对普通人下手了！Cowork 发布，你的最强 AI 打工搭子来了！
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/852876722177533/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    优弧
  </span> <!----> <!----> <div class="vip-level" data-v-cd7d0a50="" data-v-292f6e48=""><span class="tooltip" data-v-cd7d0a50=""><div class="byte-tooltip byte-tooltip--dark" style="display:none;">
        VIP.5 如鱼得水
      </div><span class="byte-tooltip__wrapper"><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADwAAAA8AQMAAAAAMksxAAAAA1BMVEUAAACnej3aAAAAAXRSTlMAQObYZgAAAA5JREFUKM9jGAWjAAcAAAIcAAE27nY6AAAAAElFTkSuQmCC" alt="VIP.5 如鱼得水" title="VIP.5 如鱼得水" class="lazy" style="aspect-ratio:NaN;" data-v-5244ef91="" data-v-cd7d0a50=""/></span></span></div> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-13T09:28:16.000Z" title="Tue Jan 13 2026 09:28:16 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;color:rgba(46,36,36,.87);overflow-x:hidden}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{margin-bottom:5px;font-size:30px;font-weight:500}.markdown-body h1:before{content:"#";margin-right:10px;color:#1976d2}.markdown-body h2{font-size:28px;font-weight:400;border-left:5px solid #454545;margin-top:20px;padding-left:10px;transition:all .3s ease-in-out}.markdown-body h2:hover{border-color:#1976d2}.markdown-body h3{font-size:24px;font-weight:400;margin-top:15px;padding-bottom:0}.markdown-body h4{font-size:20px;font-weight:500}.markdown-body h5{font-size:16px}.markdown-body h6{margin-top:5px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body h2:first-letter,.markdown-body h3:first-letter,.markdown-body p:first-letter{text-transform:capitalize}.markdown-body em{text-emphasis:dot;text-emphasis-position:under}.markdown-body img{display:block;margin:0 auto!important;max-width:100%;border-radius:2px;box-shadow:0 2px 4px -1px rgba(0,0,0,.2),0 4px 5px 0 rgba(0,0,0,.14),0 1px 10px 0 rgba(0,0,0,.12)!important}.markdown-body hr{position:relative;width:98%;height:1px;border:none;margin-top:32px;margin-bottom:32px;background-image:linear-gradient(90deg,#ddd,#999,#ddd);overflow:visible}.markdown-body hr:after{content:"";position:absolute;margin:auto;left:0;right:0;bottom:0;top:0;display:inline-block;width:60px;height:20px;background:#fff;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAgCAYAAABgrToAAAADoklEQVRYR82XTYgcRRTHf2933Q1RjAa9eFO8JHoJ8RQVBQ2iBwXBET0YEUTXNVmNQtTpmeqaWV0XNRq/o4KoECSCEPSg4CF+BYUkIIiCoCJCPIhC/Ihh2Z0nVV27VnZnenumW9i6ddV7//frV69fVQurfMgq56NawFTPAU6QyomqXrw6wIZeyhCPebA5buNR+akKyGoAjd6BshthnYdSjqNcRVuOlIUsD2j0SuA94IwuMHdh5ZUykOUBXfSGbmKI54EtAeYIHSZoy5dl4JxvNYBOKdW1KE8BQ8AkVk6WhasWsAiN0TX9gveXQaPP+Aytpc4u+bMI06JNohsYYYYOR2lJWtS3OKDRfcAtQfgDoI6Vo4UCGb0OmAEuDvZvYmVbEd/igC3dzDz7gQu8sPA9kJDK27mBmjqBeLjTg90PDFOjWawFFQd06kZHEfaj3LAIpTRpSXsZ5E06zEYP9sDimnAApYaV2SLZG/wjMeqAkijwW4xQJ5Gf/ZzRC8OW3hiBTGGlURRswW55Bh/Ssxljrwew8l1PQaM14GngvGDzBUKdDsMeTtgU5o8B92PFlUf3YXUrHa7Fys6lBqcCGnX15YQ2A18FyPd7Crd1A3M8C1wdbH4DD3hWeP6IEXbQkG97ajR1HPFnuPP5jFFq1OWX7hl8WM9l1AO648uNfwLk7tytMeogty+xeQ4rO3r6bdcx1nuwOGsHmaXGtPzae4uzGnLH1kQkvpdZGrHjssBZJrL+pqS05KWc8tgITAPXRzYvYOXe/C2OV43eDcRBDtIhoS2f9wzc0Cv8Wls+zoFzUC5zF0U241h5uZtPfptp6OUM8wbK+cH5GEpCS17P3fJei0Z3+npTxryJ8CPzbKMtn/ZyWbkPGl0PuFPkmkjkcb4h4R2ZLwRq1H0ALmvjkf2HwK1Y+T1PY2XABe/sHJ6MxN5lnoSpnC/UGbsTaI5phK2R7x6s3Ffk5YoDOrWm3onwJHBmEP86bPmBrsGaenNoIdnxCH+gPEhLXi0Cl1VBvyPVLSh7gEuC62yAfOIUqabWEaaiucMIk6RyqJ+Q/QM69V26jjW86Gvov/EaoyT8zRCn+Xq7PVrbx0nuYUaO9wM3WAbjCE1NEUw09Um4UV+2OKfYfu5/S19gsAzGKqm6LE5FrShbdS0ku465DjDwKA/oQht19ejqbaEVuRbiLhuHByYLjtUAZpDutzP7cYdHsPJXWbjyNVgFwQoa1WXwf4Jd9YD/Ap80+yE7+u9aAAAAAElFTkSuQmCC);background-repeat:no-repeat;background-size:auto 100%;background-position-x:center}.markdown-body code{font-weight:900;word-break:break-word;border-radius:2px;overflow-x:auto;font-size:.87em;padding:.065em .4em;background-color:#fbe5e1;color:#c0341d}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75;border-radius:0 4px}.markdown-body pre&gt;code{font-weight:400;font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{margin:0 4px;text-decoration:none;color:#027fff;transition:all .3s ease-in-out;padding-bottom:4px;border-bottom:2px solid transparent}.markdown-body a:after{content:"";display:inline-block;width:18px;height:18px;margin-left:4px;vertical-align:middle;background-image:url(data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyMiIgaGVpZ2h0PSIyMiI+PGcgZmlsbD0ibm9uZSIgZmlsbC1ydWxlPSJldmVub2RkIiBzdHJva2U9IiMwMjdGRkYiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCI+PHBhdGggZD0iTTkuODE1IDYuNDQ4bDEuOTM2LTEuOTM2YzEuMzM3LTEuMzM2IDMuNTgtMS4yNTkgNS4wMTMuMTczIDEuNDMyIDEuNDMyIDEuNTEgMy42NzYuMTczIDUuMDEzbC0xLjQ1MiAxLjQ1Mi0uOTY4Ljk2OGMtMS4zMzcgMS4zMzYtMy41ODEgMS4yNTktNS4wMTMtLjE3MyIvPjxwYXRoIGQ9Ik0xMS4yNjcgMTUuMzY3bC0xLjkzNiAxLjkzNmMtMS4zMzYgMS4zMzctMy41OCAxLjI2LTUuMDEyLS4xNzMtMS40MzItMS40MzItMS41MS0zLjY3Ni0uMTczLTUuMDEybDEuNDUyLTEuNDUyLjk2OC0uOTY4YzEuMzM2LTEuMzM3IDMuNTgtMS4yNiA1LjAxMi4xNzMiLz48L2c+PC9zdmc+);background-size:cover;background-repeat:no-repeat}.markdown-body a:hover{border-color:#027fff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body a.footnote-backref:after,.markdown-body a.footnote-ref:after,.markdown-body sup a:after{display:none!important}.markdown-body table{margin:0 auto 10px;font-size:12px;width:auto;max-width:100%;overflow:auto;border:2px solid #c6c6c6}.markdown-body table img{box-shadow:none!important}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body del{color:rgba(0,0,0,.6)}.markdown-body blockquote{position:relative;color:#666;padding:5px 23px 1px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:hsla(0,0%,78.4%,.12);transition:all .2s ease-in-out}.markdown-body blockquote:hover{border-color:#1976d2}.markdown-body blockquote:after,.markdown-body blockquote:before{position:absolute;font-size:24px;font-weight:800;line-height:24px;color:#cbcbcb;opacity:.6}.markdown-body blockquote:before{content:"“";top:4px;left:6px}.markdown-body blockquote:after{content:"”";right:8px;bottom:-8px}.markdown-body blockquote&gt;p,.markdown-body blockquote blockquote{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body details{outline:none;border:none;border-left:4px solid #1976d2;padding-left:10px;margin-left:4px}.markdown-body details summary{cursor:pointer;border:none;outline:none;background:#fff;margin:0 -17px}.markdown-body details summary:hover::-webkit-details-marker{color:#1976d2}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1be71b115c0f43db94c386c578e14b47~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LyY5byn:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768901296&amp;x-signature=T3KhTlVwEvFXzIFTRzOT4RdghiY%3D" alt="图片" loading="lazy"/></p>
<p>自从 Claude Code 被大家“玩出花”以后（真的，什么度假攻略、整理邮箱、硬盘救照片、监测植物、控制烤箱……），Anthropic 终于忍不住了：行，你们不是想让 Agent 不止写代码吗？那我直接端上来—— <strong>Cowork</strong> ！</p>
<p>简单一句话： <strong>Cowork = 把 Claude Code 那套 Agent 能力，直接搬到“非编程工作”里</strong> ，让更多普通用户也能像带同事一样带 Claude 干活！！</p>
<p>目前它还是 <strong>研究预览版</strong> ，优先开放给 <strong>macOS 应用里的 Claude Max 订阅用户</strong> 。想体验的话，下载 macOS 版 Claude，在侧边栏点 “Cowork” 就能上手；其他套餐就先去排队等候名单吧。</p>
<h2 data-id="heading-0">从 Claude Code 到 Cowork：官方被用户反向教育了？</h2>
<p>Claude Code 刚出来的时候，官方的心理活动大概是：开发者用来写代码、提效、自动化，稳！！</p>
<p>结果现实是：大家把它当成一个能动手的“万能助理”——研究、整理、归档、生成材料、清理杂活……只要你敢说，它就敢做！</p>
<p>Anthropic 的解释也很直白：这些奇奇怪怪但超实用的用法背后，是因为底层 <strong>Claude Agent</strong> 足够强，再配上 <strong>Opus 4.5</strong> 这种顶级模型，才会出现“你给个目标，它就能自己推进”的效果。</p>
<p>于是 Cowork 就来了： <strong>把这套能力做成更适合非编码场景的形态</strong> ，并且承认它还很早期、很原始，体验上有点像当年 Claude Code 刚发布那味儿。</p>
<h2 data-id="heading-1">Cowork 到底怎么干活？一句话：给它一个文件夹！！</h2>
<p>跟普通聊天最大的区别是：在 Cowork 里，你可以授权 Claude 访问你电脑上的某个指定文件夹。</p>
<p>然后它就能在这个范围内：</p>
<ul>
<li>读取文件</li>
<li>编辑文件</li>
<li>创建新文件</li>
</ul>
<p>注意哈： <strong>只在你授权的文件夹里折腾</strong> 。这点对“文件管理焦虑症患者”来说非常关键！！</p>
<p>官方举的例子也很贴近真实打工人：</p>
<ul>
<li><strong>重组下载文件夹</strong> ：按规则排序、重命名，每个文件都安排得明明白白</li>
<li><strong>处理票据</strong> ：一堆截图/照片，直接整理成开支表格</li>
<li><strong>整理资料</strong> ：你零散的笔记，它帮你拼成一份报告初稿</li>
</ul>
<p>更要命的是：Cowork 比普通对话更“像个 Agent”——你给任务，它会 <strong>自己制定计划并执行</strong> ，中途会同步进度。熟悉 Claude Code 的朋友应该会非常熟悉这种感觉：像在带一个靠谱但爱冲的同事……</p>
<h2 data-id="heading-2">还能更强：连接器 + 新技能 + 浏览器搭配</h2>
<p>Cowork 不止会在文件夹里干活，它还想变成你的“信息枢纽”：</p>
<ul>
<li><strong>连接器（connectors）</strong> ：把 Claude 连到外部信息源（官方说支持所有 claude.ai 数据连接器）</li>
<li><strong>初始技能集</strong> ：提升创建文档、演示文稿等文件的能力</li>
<li><strong>配合 Chrome 里的 Claude</strong> ：就能做需要访问浏览器的任务（比如检索资料、整理网页信息之类）</li>
</ul>
<p>而且官方强调一个体验点： <strong>你不需要手动搬上下文，也不用自己转换输出格式</strong> 。</p>
<p>你甚至可以把任务排队，让它并行推进——整体更像“给同事留言”，而不是传统的一问一答……打工人看了直接泪目。</p>
<h2 data-id="heading-3">这次还加了哪些“高级但吓人”的东西？</h2>
<p>Cowork 还带了一些看起来就很硬核的机制：</p>
<ul>
<li><strong>内置虚拟机（VM）</strong> ：隔离执行环境，尽量把风险关在笼子里</li>
<li><strong>开箱即用的浏览器自动化支持</strong></li>
<li><strong>支持所有 claude.ai 数据连接器</strong></li>
<li><strong>不确定就问你</strong> ：遇到关键歧义会主动澄清</li>
</ul>
<p>说实话，这套组合拳一出来，我的第一反应是：这真不是在悄悄把“通用办公 Agent”往前推吗……？</p>
<h2 data-id="heading-4">保持控制很重要，但风险也别装看不见……</h2>
<p>官方在安全这块讲得还挺实在。</p>
<p><strong>你始终握着方向盘</strong> ：</p>
<ul>
<li>你决定它能访问哪些文件夹/连接器</li>
<li>它不能读写你没授权的内容</li>
<li>做重要动作前会征求你的同意</li>
</ul>
<p>但风险也确实存在，尤其是新手第一次用这种“能动手”的工具：</p>
<ol>
<li><strong>潜在破坏性操作</strong> ：如果你指令不清晰，它可能做出删除文件之类的操作（默认能力允许它执行很多动作）。所以涉及删除/覆盖/批量改名这类任务，指令一定要写得清清楚楚！！</li>
<li><strong>提示注入风险</strong> ：如果它在网上读到恶意内容，有可能被诱导改变计划。官方说有防护，但 Agent 安全本身仍是行业里的活跃研究方向。</li>
</ol>
<p>总结一下就是： <strong>它很强，但你也得更“像一个项目负责人”</strong> ——目标给清楚，关键节点盯一下，别当甩手掌柜。</p>
<h2 data-id="heading-5">一点小看法</h2>
<p>我觉得 Cowork 的意义不在于“又多了一个新功能”，而在于它把一个信号摆到台面上了： <strong>Agent 正在从开发者玩具，变成所有人的生产力外挂</strong> 。</p>
<p>以前我们用 AI 更像“聊天+生成内容”；现在这种形态更像“我给你权限+给你目标，你去推进并交付”。如果体验做顺了，打工人会爽到飞起；如果安全边界做不好，也可能翻车翻得很惨……</p>
<p>但不管怎么说，Anthropic 这波敢把 Cowork 放出来做研究预览，我是愿意给掌声的—— <strong>先让大家用起来，现实会告诉你该怎么迭代</strong> ！</p>
<p>参考链接： <a href="https://link.juejin.cn?target=https%3A%2F%2Fclaude.com%2Fblog%2Fcowork-research-preview" target="_blank" title="https://claude.com/blog/cowork-research-preview" ref="nofollow noopener noreferrer">claude.com/blog/cowork…</a></p>
<hr/></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[SpringBoot 整合 JWT + Redis 实现登录鉴权]]></title>    <link>https://juejin.cn/post/7594578555351892019</link>    <guid>https://juejin.cn/post/7594578555351892019</guid>    <pubDate>2026-01-13T07:45:05.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7594578555351892019" data-draft-id="7594578555351875635" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="SpringBoot 整合 JWT + Redis 实现登录鉴权"/> <meta itemprop="keywords" content="后端,Redis,Java"/> <meta itemprop="datePublished" content="2026-01-13T07:45:05.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="造轮子的猪"/> <meta itemprop="url" content="https://juejin.cn/user/497453720940158"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            SpringBoot 整合 JWT + Redis 实现登录鉴权
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/497453720940158/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    造轮子的猪
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-13T07:45:05.000Z" title="Tue Jan 13 2026 07:45:05 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    8
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">SpringBoot 整合 JWT + Redis 实现登录鉴权（含Token自动续期+账户防暴力破解锁定）完整实现方案</h2>
<h3 data-id="heading-1">一、方案说明</h3>
<p>本方案采用 <code>JWT + Redis</code> 组合实现登录鉴权，解决了纯JWT无法主动失效、无法续期的痛点：</p>
<ol>
<li>JWT 生成令牌，承载用户核心信息，客户端请求携带令牌实现无状态认证</li>
<li>Redis 存储有效令牌，做<strong>双重校验</strong>（JWT签名有效性+Redis令牌存在性），支持令牌主动失效（如登出）</li>
<li>实现令牌<strong>自动续期</strong>：令牌剩余有效期不足1/3时，自动刷新Redis过期时间</li>
<li>登录接口做<strong>防暴力破解</strong>：连续5次登录失败，账户锁定15分钟，保障账户安全</li>
<li>基于SpringMVC的<code>HandlerInterceptor</code>实现全局请求拦截，统一校验令牌</li>
</ol>
<hr/>
<h3 data-id="heading-2">二、核心依赖引入</h3>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- SpringSecurity 加密/核心工具 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.security<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-security-crypto<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>5.7.3<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>

<span class="hljs-comment">&lt;!-- JJWT 核心依赖 - JWT令牌生成/解析 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>io.jsonwebtoken<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>jjwt-api<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>0.11.5<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>io.jsonwebtoken<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>jjwt-impl<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>0.11.5<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>runtime<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>io.jsonwebtoken<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>jjwt-jackson<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>0.11.5<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>runtime<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>

<span class="hljs-comment">&lt;!-- SpringBoot Redis 启动器 - 存储有效令牌/续期控制 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-data-redis<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
</code></pre>
<hr/>
<h3 data-id="heading-3">三、全局请求拦截器 - JwtInterceptor</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> org.springframework.http.MediaType;
<span class="hljs-keyword">import</span> org.springframework.stereotype.Component;
<span class="hljs-keyword">import</span> org.springframework.web.servlet.HandlerInterceptor;
<span class="hljs-keyword">import</span> javax.annotation.Resource;
<span class="hljs-keyword">import</span> javax.servlet.http.HttpServletRequest;
<span class="hljs-keyword">import</span> javax.servlet.http.HttpServletResponse;
<span class="hljs-keyword">import</span> java.io.IOException;

<span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">JwtInterceptor</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">HandlerInterceptor</span> {

    <span class="hljs-meta">@Resource</span>
    <span class="hljs-keyword">private</span> JwtServiceImpl jwtService;

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">preHandle</span><span class="hljs-params">(HttpServletRequest request, HttpServletResponse response, Object handler)</span> <span class="hljs-keyword">throws</span> Exception {
        <span class="hljs-comment">// 1. 获取请求头中的令牌</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">authToken</span> <span class="hljs-operator">=</span> request.getHeader(<span class="hljs-string">"Authorization"</span>);
        
        <span class="hljs-comment">// 2. 令牌为空，直接返回未授权</span>
        <span class="hljs-keyword">if</span> (org.springframework.util.StringUtils.isBlank(authToken)) {
            <span class="hljs-keyword">return</span> writeErrorResponse(response, <span class="hljs-string">"Token不能为空"</span>);
        }

        <span class="hljs-comment">// 3. 校验令牌格式是否包含Bearer前缀</span>
        <span class="hljs-keyword">if</span> (!authToken.startsWith(<span class="hljs-string">"Bearer "</span>)) {
            <span class="hljs-keyword">return</span> writeErrorResponse(response, <span class="hljs-string">"Token格式错误，必须以Bearer 开头"</span>);
        }

        <span class="hljs-comment">// 4. 截取纯token字符串</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">token</span> <span class="hljs-operator">=</span> authToken.substring(<span class="hljs-string">"Bearer"</span>.length() + <span class="hljs-number">1</span>).trim();

        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// 5. 第一步校验：Redis中是否存在该令牌，不存在=过期/已注销/非法令牌</span>
            <span class="hljs-keyword">if</span> (!jwtService.redisHasToken(token)) {
                <span class="hljs-keyword">return</span> writeErrorResponse(response, <span class="hljs-string">"Token无效或已过期"</span>);
            }

            <span class="hljs-comment">// 6. 第二步校验：解析JWT令牌，获取载荷信息</span>
            io.jsonwebtoken.<span class="hljs-type">Claims</span> <span class="hljs-variable">claims</span> <span class="hljs-operator">=</span> jwtService.extractAllClaims(token);
            <span class="hljs-type">String</span> <span class="hljs-variable">userId</span> <span class="hljs-operator">=</span> claims.getSubject();

            <span class="hljs-comment">// 7. 第三步校验：令牌签名+用户信息有效性校验</span>
            <span class="hljs-type">boolean</span> <span class="hljs-variable">isTokenValid</span> <span class="hljs-operator">=</span> jwtService.validAuthToken(token, userId);
            <span class="hljs-keyword">if</span> (!isTokenValid) {
                <span class="hljs-keyword">return</span> writeErrorResponse(response, <span class="hljs-string">"Token无效或已过期"</span>);
            }

            <span class="hljs-comment">// 8. 令牌有效，判断是否需要自动续期（剩余时间不足1/3则续期）</span>
            <span class="hljs-keyword">if</span> (jwtService.isAuthTokenExpiringSoon(token)) {
                jwtService.expireToken(token);
            }

            <span class="hljs-comment">// 9. 将用户ID存入ThreadLocal，供后续业务逻辑获取，无需重复解析</span>
            UserContext.set(Integer.parseInt(userId));
        } <span class="hljs-keyword">catch</span> (Exception e) {
            <span class="hljs-comment">// 捕获所有令牌异常：解析失败、签名篡改、数据异常等</span>
            <span class="hljs-keyword">return</span> writeErrorResponse(response, <span class="hljs-string">"Token无效或已过期"</span>);
        }
        <span class="hljs-comment">// 全部校验通过，放行请求</span>
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    }

    <span class="hljs-comment">/**
     * 抽离公共的错误响应方法，统一返回JSON格式错误信息
     */</span>
    <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">writeErrorResponse</span><span class="hljs-params">(HttpServletResponse response, String msg)</span> <span class="hljs-keyword">throws</span> IOException {
        response.setContentType(MediaType.APPLICATION_JSON_VALUE);
        response.setCharacterEncoding(<span class="hljs-string">"UTF-8"</span>);
        <span class="hljs-type">String</span> <span class="hljs-variable">errorJson</span> <span class="hljs-operator">=</span> <span class="hljs-string">"{\"code\": 401, \"message\": \""</span> + msg + <span class="hljs-string">"\"}"</span>;
        response.getWriter().print(errorJson);
        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    }
}
</code></pre>
<hr/>
<h3 data-id="heading-4">四、JWT核心业务实现类 - JwtServiceImpl</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> io.jsonwebtoken.*;
<span class="hljs-keyword">import</span> io.jsonwebtoken.security.Keys;
<span class="hljs-keyword">import</span> io.jsonwebtoken.security.SignatureException;
<span class="hljs-keyword">import</span> org.apache.commons.lang3.StringUtils;
<span class="hljs-keyword">import</span> org.springframework.stereotype.Service;
<span class="hljs-keyword">import</span> javax.annotation.Resource;
<span class="hljs-keyword">import</span> java.security.Key;
<span class="hljs-keyword">import</span> java.util.Date;
<span class="hljs-keyword">import</span> java.util.HashMap;
<span class="hljs-keyword">import</span> java.util.Map;
<span class="hljs-keyword">import</span> java.util.Optional;
<span class="hljs-keyword">import</span> java.util.Base64;

<span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">JwtServiceImpl</span> {

    <span class="hljs-meta">@Resource</span>
    <span class="hljs-keyword">private</span> RedisService redisService;

    <span class="hljs-comment">// ======================== 常量配置区 ========================</span>
    <span class="hljs-comment">/** redis中令牌的前缀 */</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">TOKEN_AUTH_PREFIX</span> <span class="hljs-operator">=</span> <span class="hljs-string">"token:auth:"</span>;
    <span class="hljs-comment">/** JWT签名密钥【生产环境请改为32位以上随机字符串，Base64编码后的值】 */</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">SECRET_KEY</span> <span class="hljs-operator">=</span> Base64.getEncoder().encodeToString(<span class="hljs-string">"springboot-jwt-redis-auth-2026-key"</span>.getBytes());
    <span class="hljs-comment">/** JWT令牌默认有效期 单位：分钟 */</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Integer</span> <span class="hljs-variable">DEFAULT_AUTH_EXPIRE_MINUTE</span> <span class="hljs-operator">=</span> <span class="hljs-number">30</span>;
    <span class="hljs-comment">/** JWT令牌有效期配置 单位：分钟 */</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Integer</span> <span class="hljs-variable">JWT_TOKEN_EXPIRE_MINUTE</span> <span class="hljs-operator">=</span> <span class="hljs-number">30</span>;

    <span class="hljs-comment">// ======================== 私有工具方法 ========================</span>
    <span class="hljs-comment">/**
     * 获取JWT签名密钥对象，基于HS256算法
     */</span>
    <span class="hljs-keyword">private</span> Key <span class="hljs-title function_">getSigningKey</span><span class="hljs-params">()</span> {
        <span class="hljs-type">byte</span>[] keyBytes = Base64.getDecoder().decode(SECRET_KEY);
        <span class="hljs-keyword">return</span> Keys.hmacShaKeyFor(keyBytes);
    }

    <span class="hljs-comment">/**
     * 获取Redis中令牌的剩余过期时间，单位：秒
     */</span>
    <span class="hljs-keyword">private</span> <span class="hljs-type">long</span> <span class="hljs-title function_">getTokenRedisExpire</span><span class="hljs-params">(String token)</span> {
        <span class="hljs-keyword">return</span> redisService.getExpire(TOKEN_AUTH_PREFIX + token);
    }

    <span class="hljs-comment">/**
     * 获取令牌续期阈值：剩余有效期不足总时长的1/3时，触发自动续期
     */</span>
    <span class="hljs-keyword">private</span> <span class="hljs-type">long</span> <span class="hljs-title function_">getAuthRefreshSeconds</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> getAuthExpireSeconds() / <span class="hljs-number">3</span>;
    }

    <span class="hljs-comment">// ======================== 公有对外方法 ========================</span>
    <span class="hljs-comment">/**
     * 计算令牌有效期，转成秒数返回
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getAuthExpireSeconds</span><span class="hljs-params">()</span> {
        <span class="hljs-type">Integer</span> <span class="hljs-variable">expireMinutes</span> <span class="hljs-operator">=</span> Optional.ofNullable(JWT_TOKEN_EXPIRE_MINUTE).orElse(DEFAULT_AUTH_EXPIRE_MINUTE);
        <span class="hljs-keyword">return</span> expireMinutes * <span class="hljs-number">60</span>;
    }

    <span class="hljs-comment">/**
     * 构建JWT令牌，自定义载荷信息
     * <span class="hljs-doctag">@param</span> identifier 主题，存储用户ID等唯一标识
     * <span class="hljs-doctag">@param</span> claimsMap  自定义载荷，可存储用户角色、权限等信息
     * <span class="hljs-doctag">@param</span> secondsValidity 令牌有效期，单位：秒
     * <span class="hljs-doctag">@return</span> 生成的JWT令牌字符串
     */</span>
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">generateTokenWithClaims</span><span class="hljs-params">(String identifier, Map&lt;String, Object&gt; claimsMap, <span class="hljs-type">int</span> secondsValidity)</span> {
        <span class="hljs-keyword">return</span> Jwts.builder()
                .setClaims(claimsMap)
                .setSubject(identifier)
                .setIssuedAt(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>(System.currentTimeMillis()))
                .setExpiration(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>(System.currentTimeMillis() + secondsValidity * <span class="hljs-number">1000</span>))
                .signWith(getSigningKey(), SignatureAlgorithm.HS256)
                .compact();
    }

    <span class="hljs-comment">/**
     * 解析token，获取自定义载荷中的purpose字段
     */</span>
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">extractPurpose</span><span class="hljs-params">(String token)</span> {
        <span class="hljs-keyword">try</span> {
            <span class="hljs-keyword">return</span> extractAllClaims(token).get(<span class="hljs-string">"purpose"</span>, String.class);
        } <span class="hljs-keyword">catch</span> (Exception e) {
            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
        }
    }

    <span class="hljs-comment">/**
     * 解析token，获取全部载荷信息
     * <span class="hljs-doctag">@throws</span> ExpiredJwtException token过期
     * <span class="hljs-doctag">@throws</span> SignatureException 签名错误/令牌篡改
     * <span class="hljs-doctag">@throws</span> MalformedJwtException 令牌格式错误
     */</span>
    <span class="hljs-keyword">public</span> Claims <span class="hljs-title function_">extractAllClaims</span><span class="hljs-params">(String token)</span> {
        <span class="hljs-keyword">return</span> Jwts.parserBuilder()
                .setSigningKey(getSigningKey())
                .build()
                .parseClaimsJws(token)
                .getBody();
    }

    <span class="hljs-comment">/**
     * 生成登录鉴权专用令牌
     * <span class="hljs-doctag">@param</span> userId 用户ID
     * <span class="hljs-doctag">@return</span> JWT令牌
     */</span>
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">generateAuthToken</span><span class="hljs-params">(Integer userId)</span> {
        <span class="hljs-comment">// 设置令牌用途和业务类型，便于后续扩展多场景令牌</span>
        Map&lt;String, Object&gt; claimsMap = generateClaims(<span class="hljs-string">"auth"</span>, <span class="hljs-string">"accessControl"</span>);
        <span class="hljs-comment">// 生成JWT令牌</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">token</span> <span class="hljs-operator">=</span> generateTokenWithClaims(String.valueOf(userId), claimsMap, getAuthExpireSeconds());
        <span class="hljs-comment">// 令牌存入Redis，Redis过期时间与JWT一致，双重保障</span>
        redisService.set(TOKEN_AUTH_PREFIX + token, String.valueOf(userId), getAuthExpireSeconds());
        <span class="hljs-keyword">return</span> token;
    }

    <span class="hljs-comment">/**
     * 校验令牌有效性：Redis存在性+用户ID一致性校验
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">validAuthToken</span><span class="hljs-params">(String token, String userId)</span> {
        <span class="hljs-type">String</span> <span class="hljs-variable">storedUserId</span> <span class="hljs-operator">=</span> getAuthData(token);
        <span class="hljs-keyword">return</span> StringUtils.isNotBlank(storedUserId) &amp;&amp; userId.equals(storedUserId);
    }

    <span class="hljs-comment">/**
     * 判断令牌是否即将过期，是否需要续期
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isAuthTokenExpiringSoon</span><span class="hljs-params">(String token)</span> {
        <span class="hljs-type">long</span> <span class="hljs-variable">remainExpireSeconds</span> <span class="hljs-operator">=</span> getTokenRedisExpire(token);
        <span class="hljs-type">long</span> <span class="hljs-variable">refreshThreshold</span> <span class="hljs-operator">=</span> getAuthRefreshSeconds();
        <span class="hljs-keyword">return</span> remainExpireSeconds &gt; <span class="hljs-number">0</span> &amp;&amp; remainExpireSeconds &lt; refreshThreshold;
    }

    <span class="hljs-comment">/**
     * 令牌续期：刷新Redis中令牌的过期时间，实现无感续期
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">expireToken</span><span class="hljs-params">(String token)</span>{
        redisService.expireKey(TOKEN_AUTH_PREFIX + token, getAuthExpireSeconds());
    }

    <span class="hljs-comment">/**
     * 获取Redis中存储的令牌绑定的用户ID
     */</span>
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getAuthData</span><span class="hljs-params">(String token)</span>{
        <span class="hljs-keyword">return</span> redisService.get(TOKEN_AUTH_PREFIX + token);
    }

    <span class="hljs-comment">/**
     * 构建JWT自定义载荷信息
     */</span>
    <span class="hljs-keyword">public</span> Map&lt;String, Object&gt; <span class="hljs-title function_">generateClaims</span><span class="hljs-params">(String purpose, String busType)</span> {
        Map&lt;String, Object&gt; claims = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;(<span class="hljs-number">2</span>);
        claims.put(<span class="hljs-string">"purpose"</span>, purpose);
        claims.put(<span class="hljs-string">"busType"</span>, busType);
        <span class="hljs-keyword">return</span> claims;
    }

    <span class="hljs-comment">/**
     * 判断Redis中是否存在该令牌
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">redisHasToken</span><span class="hljs-params">(String token)</span>{
        <span class="hljs-keyword">return</span> redisService.hasKey(TOKEN_AUTH_PREFIX + token);
    }
}
</code></pre>
<hr/>
<h3 data-id="heading-5">五、登录业务实现</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> org.springframework.stereotype.Service;
<span class="hljs-keyword">import</span> javax.annotation.Resource;

<span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">LoginServiceImpl</span> {

    <span class="hljs-meta">@Resource</span>
    <span class="hljs-keyword">private</span> UserService userService;
    <span class="hljs-meta">@Resource</span>
    <span class="hljs-keyword">private</span> JwtServiceImpl jwtService;

    <span class="hljs-comment">/** 登录失败锁定阈值：连续失败5次 */</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Integer</span> <span class="hljs-variable">FAILED_LOCK_COUNT</span> <span class="hljs-operator">=</span> <span class="hljs-number">5</span>;
    <span class="hljs-comment">/** 账户锁定时长：15分钟，单位毫秒 */</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Long</span> <span class="hljs-variable">LOCK_TIME</span> <span class="hljs-operator">=</span> <span class="hljs-number">15</span> * <span class="hljs-number">60</span> * <span class="hljs-number">1000L</span>;

    <span class="hljs-comment">/**
     * 用户登录核心方法
     * <span class="hljs-doctag">@param</span> userDto 登录入参（用户名+密码）
     * <span class="hljs-doctag">@return</span> 登录成功返回JWT令牌，失败抛出业务异常
     */</span>
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">login</span><span class="hljs-params">(UserDto userDto)</span>{
        <span class="hljs-comment">// 1. 根据用户名查询用户，用户不存在直接返回失败</span>
        <span class="hljs-type">User</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> userService.getByUsername(userDto.getUsername());
        <span class="hljs-keyword">if</span> (user == <span class="hljs-literal">null</span>) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BusinessException</span>(<span class="hljs-string">"用户名或密码错误"</span>);
        }

        <span class="hljs-type">boolean</span> <span class="hljs-variable">needResetStatus</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>;
        <span class="hljs-type">Integer</span> <span class="hljs-variable">failedAttempts</span> <span class="hljs-operator">=</span> user.getFailedAttempts();
        <span class="hljs-type">Short</span> <span class="hljs-variable">userStatus</span> <span class="hljs-operator">=</span> user.getStatus();

        <span class="hljs-comment">// 2. 判断账户是否被锁定（连续5次失败）</span>
        <span class="hljs-keyword">if</span> (FAILED_LOCK_COUNT.equals(failedAttempts)) {
            <span class="hljs-type">long</span> <span class="hljs-variable">lastFailTime</span> <span class="hljs-operator">=</span> user.getUpdatedDate().getTime();
            <span class="hljs-comment">// 判断是否超过锁定时间</span>
            <span class="hljs-keyword">if</span> (isTimeExceeded(lastFailTime, LOCK_TIME)) {
                <span class="hljs-comment">// 锁定时间已过，重置失败次数和状态</span>
                needResetStatus = <span class="hljs-literal">true</span>;
            } <span class="hljs-keyword">else</span> {
                <span class="hljs-comment">// 账户仍在锁定中</span>
                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BusinessException</span>(<span class="hljs-string">"连续5次登录失败，账户已锁定15分钟，请稍后再试"</span>);
            }
        }

        <span class="hljs-comment">// 3. 判断用户状态是否正常</span>
        <span class="hljs-keyword">if</span> (!UserEnum.NORMAL.getStatus().equals(userStatus) &amp;&amp; !needResetStatus) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BusinessException</span>(<span class="hljs-string">"账户状态异常，无法登录"</span>);
        }

        <span class="hljs-comment">// 4. 校验密码是否正确</span>
        <span class="hljs-type">boolean</span> <span class="hljs-variable">passwordValid</span> <span class="hljs-operator">=</span> userService.verifyPassword(userDto.getPassword(), user.getPassword());
        <span class="hljs-keyword">if</span> (passwordValid) {
            <span class="hljs-comment">// 密码正确：重置失败次数+解锁账户</span>
            <span class="hljs-keyword">if</span> (needResetStatus) {
                userService.updateUserStatus(user.getId());
            }
            <span class="hljs-comment">// 生成并返回令牌</span>
            <span class="hljs-keyword">return</span> jwtService.generateAuthToken(user.getId());
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-comment">// 密码错误：失败次数+1，达到阈值则锁定</span>
            userService.incrFailedAttempts(userDto.getUsername());
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BusinessException</span>(<span class="hljs-string">"用户名或密码错误"</span>);
        }
    }

    <span class="hljs-comment">/**
     * 判断是否超过指定时长
     * <span class="hljs-doctag">@param</span> startTime 开始时间戳
     * <span class="hljs-doctag">@param</span> timeLimit 时长限制（毫秒）
     */</span>
    <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isTimeExceeded</span><span class="hljs-params">(<span class="hljs-type">long</span> startTime, <span class="hljs-type">long</span> timeLimit)</span> {
        <span class="hljs-keyword">return</span> System.currentTimeMillis() - startTime &gt; timeLimit;
    }
}
</code></pre>
<hr/>
<h3 data-id="heading-6">六、拦截器和ThreadLocal</h3>
<h4 data-id="heading-7">6.1 拦截器注册配置类</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> org.springframework.context.annotation.Configuration;
<span class="hljs-keyword">import</span> org.springframework.web.servlet.config.annotation.InterceptorRegistry;
<span class="hljs-keyword">import</span> org.springframework.web.servlet.config.annotation.WebMvcConfigurer;
<span class="hljs-keyword">import</span> javax.annotation.Resource;

<span class="hljs-meta">@Configuration</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">WebMvcConfig</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">WebMvcConfigurer</span> {

    <span class="hljs-meta">@Resource</span>
    <span class="hljs-keyword">private</span> JwtInterceptor jwtInterceptor;

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">addInterceptors</span><span class="hljs-params">(InterceptorRegistry registry)</span> {
        registry.addInterceptor(jwtInterceptor)
                <span class="hljs-comment">// 拦截所有请求</span>
                .addPathPatterns(<span class="hljs-string">"/**"</span>)
                <span class="hljs-comment">// 放行登录接口、静态资源等无需鉴权的接口</span>
                .excludePathPatterns(<span class="hljs-string">"/user/login"</span>, <span class="hljs-string">"/error"</span>);
    }
}
</code></pre>
<h4 data-id="heading-8">6.2 ThreadLocal用户上下文 - UserContext</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserContext</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> ThreadLocal&lt;Integer&gt; USER_ID_CONTEXT = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ThreadLocal</span>&lt;&gt;();

    <span class="hljs-comment">/** 设置当前线程的用户ID */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">set</span><span class="hljs-params">(Integer userId)</span> {
        USER_ID_CONTEXT.set(userId);
    }

    <span class="hljs-comment">/** 获取当前线程的用户ID */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Integer <span class="hljs-title function_">get</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> USER_ID_CONTEXT.get();
    }

    <span class="hljs-comment">/** 清除当前线程的用户ID，防止内存泄漏 */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">remove</span><span class="hljs-params">()</span> {
        USER_ID_CONTEXT.remove();
    }
}
</code></pre>
<hr/>
<h3 data-id="heading-9">七、核心亮点</h3>
<ol>
<li><strong>高安全性</strong>：JWT签名防篡改 + Redis双重校验 + 账户防暴力破解锁定，三重保障</li>
<li><strong>高可用性</strong>：令牌自动无感续期，用户无需重复登录，体验友好</li>
<li><strong>高健壮性</strong>：完善的异常处理，避免token格式错误、篡改、过期导致的程序崩溃</li>
<li><strong>高可维护性</strong>：代码结构清晰，常量统一管理，注释完整，逻辑精简</li>
</ol>
<h4 data-id="heading-10">生产环境必改配置</h4>
<ol>
<li><code>SECRET_KEY</code>：必须改为32位以上的随机字符串，Base64编码后使用，防止密钥被破解</li>
<li>令牌有效期：可根据业务调整，建议后台管理系统30分钟，移动端2小时</li>
<li>Redis部署：生产环境建议使用Redis集群，防止单点故障</li>
<li>密码加密：必须使用<code>BCryptPasswordEncoder</code>加密存储，禁止明文存储</li>
</ol>
<h4 data-id="heading-11">核心设计思想</h4>
<blockquote>
<p>为什么用JWT+Redis，而不是纯JWT/纯Redis？</p>
</blockquote>
<ul>
<li>纯JWT：令牌一旦生成无法主动失效，过期时间固定，续期困难</li>
<li>纯Redis：需要存储大量用户信息，Redis压力大，且无状态认证优势丧失</li>
<li>JWT+Redis：扬长避短，JWT做无状态令牌，Redis做有效令牌存储+续期，完美解决痛点</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Redis Cluster 实现多key事务操作]]></title>    <link>https://juejin.cn/post/7594616268781584411</link>    <guid>https://juejin.cn/post/7594616268781584411</guid>    <pubDate>2026-01-13T07:48:42.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7594616268781584411" data-draft-id="7594482829754941486" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Redis Cluster 实现多key事务操作"/> <meta itemprop="keywords" content="Redis"/> <meta itemprop="datePublished" content="2026-01-13T07:48:42.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="小飞Coding"/> <meta itemprop="url" content="https://juejin.cn/user/954816145155181"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Redis Cluster 实现多key事务操作
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/954816145155181/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    小飞Coding
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-13T07:48:42.000Z" title="Tue Jan 13 2026 07:48:42 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    3
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>在 Redis 集群模式下，<code>MULTI/EXEC</code> 事务直接报错：
<strong>“CROSSSLOT Keys in request don't hash to the same slot”</strong>。
那么，如何在保证数据一致性的前提下，同时操作多个 Key？
本文给出 <strong>生产级可行方案</strong>，从原子性到最终一致性全覆盖。</p>
</blockquote>
<p>如果你正在使用 Redis Cluster，一定遇到过这样的困境：</p>
<ul>
<li>想扣用户余额，同时创建订单、记录日志；</li>
<li>写了个 <code>MULTI/EXEC</code>，结果 Redis 报错：<strong>key 不在同一个 slot</strong>；</li>
<li>改用 Pipeline？但又怕中间被其他请求插队，导致状态不一致……</li>
</ul>
<p>别急！Redis Cluster 虽然限制了跨 slot 的原子操作，但通过合理设计，我们依然能实现<strong>安全、可靠、高性能的多 Key 操作</strong>。</p>
<hr/>
<h2 data-id="heading-0">一、为什么 Redis Cluster 不支持跨节点事务？</h2>
<p>Redis Cluster 将 key 空间划分为 <strong>16384 个 slot</strong>，每个 key 通过 <code>CRC16(key) % 16384</code> 映射到一个 slot，由某个主节点负责。</p>
<p>而 <strong><code>MULTI/EXEC</code> 事务要求所有 key 必须属于同一个 slot</strong>，否则直接拒绝：</p>
<pre><code class="hljs language-bash" lang="bash">&gt; MULTI
&gt; SET user:1001:name Alice
&gt; SET order:2001:status paid
&gt; EXEC
(error) CROSSSLOT Keys <span class="hljs-keyword">in</span> request don<span class="hljs-string">'t hash to the same slot
</span></code></pre>
<p><strong>原因很简单</strong>：
事务需要在单个节点上原子执行，而跨 slot 意味着涉及多个物理节点 —— Redis 无法保证分布式事务的 ACID。</p>
<blockquote>
<p>⚠️ 注意：<strong>Pipeline 也不是事务</strong>！它只是网络优化，命令之间仍可能被其他客户端插入。</p>
</blockquote>
<hr/>
<h2 data-id="heading-1">二、方案一：Hash Tag + Lua 脚本（强一致性，推荐！）</h2>
<p>这是 <strong>唯一能在 Redis Cluster 中实现原子多 Key 操作的方式</strong>。</p>
<h3 data-id="heading-2">✅ 核心思想：</h3>
<ol>
<li>利用 <strong>Hash Tag 规则</strong>，强制相关 key 落在同一 slot；</li>
<li>用 <strong>Lua 脚本</strong> 在单节点内完成所有操作，天然原子。</li>
</ol>
<h3 data-id="heading-3">🔧 实施步骤</h3>
<h4 data-id="heading-4">1. Key 设计：使用 <code>{}</code> 包裹聚合 ID</h4>
<p>Redis 规定：<strong>只有 <code>{}</code> 内的内容参与 slot 计算</strong>。</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 所有与用户 1001 相关的 key</span>
user:{1001}:balance   → slot = CRC16(<span class="hljs-string">"1001"</span>) % 16384
user:{1001}:orders    → slot = CRC16(<span class="hljs-string">"1001"</span>) % 16384
user:{1001}:<span class="hljs-built_in">log</span>       → slot = CRC16(<span class="hljs-string">"1001"</span>) % 16384
</code></pre>
<blockquote>
<p>✅ 这些 key 必然落在同一节点，可被原子操作。</p>
</blockquote>
<h4 data-id="heading-5">2. 编写 Lua 脚本（原子执行）</h4>
<pre><code class="hljs language-lua" lang="lua"><span class="hljs-comment">-- 扣款 + 加订单 + 记日志</span>
<span class="hljs-keyword">local</span> balance = <span class="hljs-built_in">tonumber</span>(redis.call(<span class="hljs-string">'GET'</span>, KEYS[<span class="hljs-number">1</span>]) <span class="hljs-keyword">or</span> <span class="hljs-number">0</span>)
<span class="hljs-keyword">if</span> balance &lt; <span class="hljs-built_in">tonumber</span>(ARGV[<span class="hljs-number">2</span>]) <span class="hljs-keyword">then</span>
    <span class="hljs-keyword">return</span> redis.error_reply(<span class="hljs-string">'INSUFFICIENT_BALANCE'</span>)
<span class="hljs-keyword">end</span>

redis.call(<span class="hljs-string">'DECRBY'</span>, KEYS[<span class="hljs-number">1</span>], ARGV[<span class="hljs-number">2</span>])          <span class="hljs-comment">-- 扣余额</span>
redis.call(<span class="hljs-string">'SADD'</span>, KEYS[<span class="hljs-number">2</span>], ARGV[<span class="hljs-number">1</span>])            <span class="hljs-comment">-- 加订单</span>
redis.call(<span class="hljs-string">'RPUSH'</span>, KEYS[<span class="hljs-number">3</span>], <span class="hljs-string">'Order created'</span>)   <span class="hljs-comment">-- 记日志</span>

<span class="hljs-keyword">return</span> balance - <span class="hljs-built_in">tonumber</span>(ARGV[<span class="hljs-number">2</span>])
</code></pre>
<h4 data-id="heading-6">3. 客户端调用（以 Jedis 为例）</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-type">String</span> <span class="hljs-variable">script</span> <span class="hljs-operator">=</span> <span class="hljs-string">"..."</span>; <span class="hljs-comment">// 上述 Lua</span>
List&lt;String&gt; keys = Arrays.asList(
    <span class="hljs-string">"user:{1001}:balance"</span>,
    <span class="hljs-string">"user:{1001}:orders"</span>,
    <span class="hljs-string">"user:{1001}:log"</span>
);
List&lt;String&gt; args = Arrays.asList(<span class="hljs-string">"order_2026"</span>, <span class="hljs-string">"100"</span>);

<span class="hljs-type">Object</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> jedis.eval(script, keys, args);
</code></pre>
<h3 data-id="heading-7">✅ 优势</h3>
<ul>
<li><strong>强原子性</strong>：脚本执行期间，其他命令无法插入；</li>
<li><strong>高性能</strong>：一次网络往返；</li>
<li><strong>完全兼容 Cluster</strong>。</li>
</ul>
<h3 data-id="heading-8">⚠️ 注意事项</h3>
<ul>
<li><strong>避免数据倾斜</strong>：不要用高频 ID（如 user_id=1）作为 tag；</li>
<li><strong>仅适用于“聚合根”模型</strong>：所有 key 应属于同一业务实体（用户、订单、会话等）。</li>
</ul>
<blockquote>
<p>💡 <strong>最佳实践：在领域建模阶段，就将需原子操作的数据归为同一聚合，并用 <code>{aggregate_id}</code> 作为 Hash Tag。</strong></p>
</blockquote>
<hr/>
<h2 data-id="heading-9">三、方案二：应用层分步操作 + 补偿机制（最终一致性）</h2>
<p>当 key <strong>无法归到同一 slot</strong>（如跨用户转账），且业务可接受<strong>最终一致性</strong>时，可采用 Saga 模式。</p>
<h3 data-id="heading-10">示例：用户 A 转账给用户 B</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">try</span> {
    <span class="hljs-comment">// 1. 冻结 A 的资金（带 TTL 防死锁）</span>
    redis.setex(<span class="hljs-string">"lock:A:100"</span>, <span class="hljs-number">30</span>, <span class="hljs-string">"100"</span>);
    
    <span class="hljs-comment">// 2. 扣 A 余额</span>
    redis.decrBy(<span class="hljs-string">"user:A:balance"</span>, <span class="hljs-number">100</span>);
    
    <span class="hljs-comment">// 3. 加 B 余额</span>
    redis.incrBy(<span class="hljs-string">"user:B:balance"</span>, <span class="hljs-number">100</span>);
    
    <span class="hljs-comment">// 4. 清除锁</span>
    redis.del(<span class="hljs-string">"lock:A:100"</span>);
} <span class="hljs-keyword">catch</span> (Exception e) {
    <span class="hljs-comment">// 补偿：回滚已执行的操作</span>
    <span class="hljs-keyword">if</span> (A余额已扣) redis.incrBy(<span class="hljs-string">"user:A:balance"</span>, <span class="hljs-number">100</span>);
    <span class="hljs-keyword">if</span> (B余额已加) redis.decrBy(<span class="hljs-string">"user:B:balance"</span>, <span class="hljs-number">100</span>);
    redis.del(<span class="hljs-string">"lock:A:100"</span>);
}
</code></pre>
<h3 data-id="heading-11">✅ 适用场景</h3>
<ul>
<li>跨聚合根操作（如 A→B 转账）；</li>
<li>有明确补偿逻辑（如退款、撤回）；</li>
<li>可容忍短暂不一致。</li>
</ul>
<h3 data-id="heading-12">❌ 劣势</h3>
<ul>
<li>实现复杂（需幂等、重试、监控）；</li>
<li>无法保证强一致性。</li>
</ul>
<hr/>
<h2 data-id="heading-13">四、方案三：异步队列 + 幂等消费（高吞吐场景）</h2>
<p>将多 Key 操作拆解为消息，交由 Kafka/RocketMQ 等可靠队列处理：</p>
<pre><code class="hljs language-mermaid" lang="mermaid">graph LR
A[发起操作] --&gt; B[发消息到 MQ]
B --&gt; C[消费者1: 更新 key1]
C --&gt; D[消费者2: 更新 key2]
</code></pre>
<ul>
<li>消费者需实现<strong>幂等</strong>（如用 <code>SET key value NX</code> 防重）；</li>
<li>适合<strong>非实时</strong>场景：积分发放、通知推送、日志同步等。</li>
</ul>
<hr/>
<h2 data-id="heading-14">五、不推荐方案：单独部署非集群 Redis</h2>
<ul>
<li>为事务单独维护一套 standalone Redis；</li>
<li><strong>破坏架构统一性</strong>，增加运维成本；</li>
<li><strong>丧失 Cluster 的高可用与扩展能力</strong>；</li>
<li>仅适用于极小规模、临时过渡场景。</li>
</ul>
<hr/>
<h2 data-id="heading-15">🔚 总结：如何选择？</h2>





















<table><thead><tr><th>场景</th><th>推荐方案</th></tr></thead><tbody><tr><td><strong>强一致性 + 多 Key 同业务实体</strong></td><td>✅ Hash Tag + Lua 脚本</td></tr><tr><td><strong>跨实体 Key + 可接受最终一致</strong></td><td>✅ Saga 补偿 或 异步队列</td></tr><tr><td><strong>简单批量读写（同 Key）</strong></td><td>✅ <code>MSET</code> / <code>MGET</code>（内置原子命令）</td></tr></tbody></table>
<blockquote>
<p>🌟 <strong>核心原则：
在 Redis Cluster 中，*<em>不要对抗 slot 机制，而要顺应它*</em>。
通过合理的数据建模（聚合根 + Hash Tag），你可以在享受 Cluster 高可用的同时，实现强一致的事务操作。</strong></p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[spring-ioc]]></title>    <link>https://juejin.cn/post/7594578555351957555</link>    <guid>https://juejin.cn/post/7594578555351957555</guid>    <pubDate>2026-01-13T07:51:08.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7594578555351957555" data-draft-id="7594626381432356914" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="spring-ioc"/> <meta itemprop="keywords" content="Java"/> <meta itemprop="datePublished" content="2026-01-13T07:51:08.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="悦悦妍妍"/> <meta itemprop="url" content="https://juejin.cn/user/3395772841729421"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            spring-ioc
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3395772841729421/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    悦悦妍妍
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-13T07:51:08.000Z" title="Tue Jan 13 2026 07:51:08 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    9
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">spring-ioc</h2>
<h3 data-id="heading-1">Bean是什么？</h3>
<ul>
<li>Spring容器管理的对象实例</li>
<li>由Spring IoC容器负责创建、装配和管理</li>
</ul>
<h3 data-id="heading-2">配置bean</h3>
<ul>
<li>@Configuration + @Bean 配置bean</li>
</ul>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Configuration</span>  <span class="hljs-comment">// 声明这是一个Spring配置类</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DogConfig</span> {
    
    <span class="hljs-meta">@Bean</span>  <span class="hljs-comment">// 声明这是一个Spring Bean的工厂方法</span>
    <span class="hljs-keyword">public</span> Dog <span class="hljs-title function_">dog1</span><span class="hljs-params">()</span>{
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Dog</span>();  <span class="hljs-comment">// 使用无参构造函数创建Dog实例</span>
    }

    <span class="hljs-meta">@Bean</span>  <span class="hljs-comment">// 声明另一个Bean</span>
    <span class="hljs-keyword">public</span> Dog <span class="hljs-title function_">dog2</span><span class="hljs-params">()</span>{
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Dog</span>(<span class="hljs-string">"xm"</span>, <span class="hljs-number">12</span>);  <span class="hljs-comment">// 使用带参数的构造函数创建Dog实例</span>
    }
}


成为spring的bean后就可以被<span class="hljs-meta">@Autowired</span>注入
<span class="hljs-meta">@Autowired</span>
Map&lt;String, Dog&gt; dogMap;

<span class="hljs-meta">@Autowired</span>
Dog dog1;

</code></pre>
<ul>
<li>@Component | @Controller | @Service | @Repository也可以标注一个bean</li>
</ul>
<h3 data-id="heading-3">注入Bean</h3>
<h5 data-id="heading-4"><code>@Autowired</code></h5>
<ul>
<li>注入规则 按照类型获取单个组件bean的规则[先按照类型，再按照名称]</li>
</ul>
<pre><code class="hljs">只找到1个这样的类型，则直接注入，注入的变量名随便
如果找到多个类，再按照名称去找，变量名就是名字，如果找到则注入；如果没找到就报错
</code></pre>
<h5 data-id="heading-5">用构造器注入</h5>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Slf4j</span>
<span class="hljs-meta">@Component</span>
<span class="hljs-meta">@Data</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserDao</span> {

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> IPerson teacherImpl; <span class="hljs-comment">// final表示必需！</span>


<span class="hljs-comment">//    @Autowired</span>
<span class="hljs-comment">//    private IPerson teacherImpl;</span>

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">UserDao</span><span class="hljs-params">(IPerson teacherImpl)</span>{
        log.info(<span class="hljs-string">"UserDao constructor:{}"</span>, teacherImpl);
        <span class="hljs-built_in">this</span>.teacherImpl = teacherImpl;
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">callPersonSay</span><span class="hljs-params">()</span>{
        teacherImpl.say(<span class="hljs-string">"你好ya"</span>);
    }
}
</code></pre>
<h5 data-id="heading-6">用构造器注入 对比 @Autowired注入，spring更推荐 <code>用构造器注入</code></h5>
<ul>
<li><code>@Autowired</code>注入隐藏依赖关系，代码不可靠。偷偷注入，外部看不出来; 但是<code>用构造器注入</code>一眼就知道需要哪些依赖</li>
<li><code>@Autowired</code>方式注入难以单元测试</li>
</ul>
<h3 data-id="heading-7">Bean创建过程</h3>
<p>容器启动过程中就会创建组件对象，故默认情况下组件是单例的，每次获取直接从spring容器中获取组件对象。</p>
<pre><code class="hljs">应用启动 → Bean扫描 → Bean定义注册 → 创建Bean实例 → 依赖解析 → 属性注入 → 初始化 → 使用
</code></pre>
<h3 data-id="heading-8">@ComponentScan</h3>
<p><code>@ComponentScan</code>是Spring框架中一个核心的注解，用于控制Spring容器扫描和注册Bean的范围</p>
<h5 data-id="heading-9">默认扫描规则</h5>
<p>默认会扫描<strong>当前启动类所在包及其所有子包</strong>下的组件<code>@Component</code>, <code>@Service</code>, <code>@Repository</code>, <code>@Controller</code>, <code>@Configuration</code>等。</p>
<h5 data-id="heading-10">当需要扫描非以上情况的包时，需要在启动类上使用<code>@ComponentScan</code></h5>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@SpringBootApplication</span>
<span class="hljs-meta">@ComponentScan({
    "com.mycompany.app",
    "com.mycompany.common",      // 扫描公共模块
    "com.mycompany.security",    // 扫描安全模块
    "com.mycompany.service"      // 扫描服务模块
})</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Application</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        SpringApplication.run(Application.class, args);
    }
}
</code></pre>
<h3 data-id="heading-11">@Value 给Spring Bean属性赋配置值</h3>
<p><code>@Value</code> 注解用于从各种来源配置值注入到Spring Bean的属性中。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 没有PropertySource即默认取`resources`目录下的application.properties文件</span>

<span class="hljs-comment">// userDao.properties文件创建于`resources`目录下</span>
<span class="hljs-meta">@Component</span>
<span class="hljs-meta">@Data</span>
<span class="hljs-meta">@PropertySource("classpath:userDao.properties")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserDao</span> {
    <span class="hljs-comment">// 当不存在 key:user.dao.female 时，female的默认值为 1</span>
    <span class="hljs-meta">@Value("${user.dao.female: 1}")</span>
    <span class="hljs-keyword">private</span> String female;
}

</code></pre>
<h3 data-id="heading-12">@Profile 指定bean配置生效的环境</h3>
<ul>
<li>指定当前激活的环境</li>
</ul>
<pre><code class="hljs language-ini" lang="ini">// application.properties 文件中设置
<span class="hljs-attr">spring.profiles.active</span>=sit
</code></pre>
<ul>
<li>各个环境的bean配置</li>
</ul>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// @Profile作用于 类      的时候，表面该类里所有的bean生效于当前环境</span>
<span class="hljs-comment">// @Profile作用于 bean方法 的时候，表面当前bean生效于当前环境</span>
<span class="hljs-meta">@Profile("dev")</span>
<span class="hljs-meta">@Configuration</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DevConfig</span> {

    <span class="hljs-meta">@Bean</span>
    <span class="hljs-keyword">public</span> MyDataSource <span class="hljs-title function_">dev</span><span class="hljs-params">()</span>{
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MyDataSource</span>(<span class="hljs-string">"dev"</span>, <span class="hljs-string">"dev-wmy"</span>, <span class="hljs-string">"admin"</span>);
    }
}


<span class="hljs-meta">@Profile("sit")</span>
<span class="hljs-meta">@Configuration</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SitConfig</span> {

    <span class="hljs-meta">@Bean</span>
    <span class="hljs-keyword">public</span> MyDataSource <span class="hljs-title function_">sit</span><span class="hljs-params">()</span>{
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MyDataSource</span>(<span class="hljs-string">"sit"</span>, <span class="hljs-string">"sit-wmy"</span>, <span class="hljs-string">"admin"</span>);
    }
}


<span class="hljs-comment">// 取的是当前环境生效的bean,若spring.profiles.active=sit，则当前myDataSource取的是sit的bean配置 new MyDataSource("sit", "sit-wmy", "admin");</span>
<span class="hljs-meta">@Autowired</span>
MyDataSource myDataSource;

</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[2026 最新 ComfyUI 教程 - 本地部署 AI 生图模型 - Z-Image-Turbo]]></title>    <link>https://juejin.cn/post/7594667893015674895</link>    <guid>https://juejin.cn/post/7594667893015674895</guid>    <pubDate>2026-01-13T09:31:54.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7594667893015674895" data-draft-id="7594402344618295311" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="2026 最新 ComfyUI 教程 - 本地部署 AI 生图模型 - Z-Image-Turbo"/> <meta itemprop="keywords" content="前端,AI编程,人工智能"/> <meta itemprop="datePublished" content="2026-01-13T09:31:54.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="闲云一鹤"/> <meta itemprop="url" content="https://juejin.cn/user/729731452122382"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            2026 最新 ComfyUI 教程 - 本地部署 AI 生图模型 - Z-Image-Turbo
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/729731452122382/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    闲云一鹤
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-13T09:31:54.000Z" title="Tue Jan 13 2026 09:31:54 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读13分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">写在前面</h2>
<p>本文是用于演示通过 <code>ComfyUI</code> 工具，部署 <code>z_image_turbo_bf16</code> AI 生图模型到电脑的教程</p>
<p>官方说 Z-Image-Turbo 模型是 Z-Image 的精炼版，能在配置为 16GB GPU 显存（VRAM）中舒适运行。我的电脑显存为 8GB，但是 CPU 内存（RAM）有 32GB（当显存满了后可以适当找 CPU 借用内存，只是会显著降低速度），总的来说跑 Z-Image-Turbo 模型基本还算流畅</p>
<p>主要是在线模型要么收费贵了，要么每日扣嗖嗖的限额次数以及排队令人嫌弃，所以我打算自己部署开源模型到本地，自己随便跑，不花钱又无限制，爽歪歪</p>
<p>果然想挣咱程序员的钱是挺难的哈</p>
<p>周末抽空研究了下本地部署 AI 生图，发现 B 站 ComfyUI 相关的教程虽然多，不过都太罗嗦，并且演示的 ComfyUI 版本过于落后，我也不知道这些 up 为啥清一色的让人安装 git 和 python，并且 git 还非要配置什么环境变量，完了我也没有看到他们在哪里有用到 git 的操作（估计自己也不懂），而且基本全是 up 在评论区提供各种网盘安装包的（你敢提供我还不敢用呢，就不能老老实实提供正经的官网安装方式吗？）</p>
<p>还有 ComfyUI 官方文档也不与时俱进的更新，文档估计都是前几个版本的</p>
<p><code>所以我把新鲜的踩坑经验写了一篇教程，帮大家避坑</code></p>
<p>先给大家看演示效果</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f6f64b7aa688459eb547957ba955ce35~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zey5LqR5LiA6bmk:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768901514&amp;x-signature=JH%2FWNHv8v3FjYdilyP1TtxdHC30%3D" alt="cover1.png" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/514c506c875a4a998590ce6d807736a3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zey5LqR5LiA6bmk:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768901514&amp;x-signature=XgES7DameiGR0uWFa5H%2BVtQ7rjk%3D" alt="cover2.png" loading="lazy"/></p>
<p>上面的图片都是 Z-Image-Turbo 生成的！太惊艳了！有木有！！！</p>
<h2 data-id="heading-1">用 ComfyUI 替代 git clone github 仓库</h2>
<p>本来我是打算直接从 github 仓库下载模型部署的</p>
<p>后来了解到 ComfyUI 这玩意已经很成熟了，是目前 AI 圈最火的声明式可视化 Pipeline 编排工具（图形界面）</p>
<p>ComfyUI 内置了许多 AI 模板，我们可以直接使用</p>
<p>它把模型的加载、Clip 编码、采样器、VAE 解码等逻辑封装成了节点（Nodes）。</p>
<p><code>无需配置繁琐的工作流</code></p>
<p>我们只需要把精力放在使用模型上</p>
<p>大大节约我们的时间和提升工作的效率</p>
<h2 data-id="heading-2">ComfyUI 下载</h2>
<p>官网地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.comfy.org%2Fzh-CN" target="_blank" title="https://docs.comfy.org/zh-CN" ref="nofollow noopener noreferrer">docs.comfy.org/zh-CN</a></p>
<p>推荐大家下载 <code>ComfyUI Portable(便携版)</code>， 便携版是一个独立封装完整的 ComfyUI Windows 版本，内部已经整合了 ComfyUI 运行所需的独立的 Python(python_embeded)，无需单独安装 Python 环境</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7cd14df5560244a68bfb61f85ddf735d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zey5LqR5LiA6bmk:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768901514&amp;x-signature=9xo3bVJnFutgfVrFPzTsZWO4KKA%3D" alt="1.png" loading="lazy"/></p>
<p>并且便携版是免安装版本，下载后只需要解压即可使用</p>
<h2 data-id="heading-3">启动 ComfyUI</h2>
<p>双击 <code>run_nvidia_gpu.bat</code> 启动 ComfyUI</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b932df0676dc47d2a612f447e0b7c70a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zey5LqR5LiA6bmk:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768901514&amp;x-signature=I1AWudkWyITMX6xvkK7J2itZwco%3D" alt="2.png" loading="lazy"/></p>
<p><code>注意千万不要点击 run\_cpu.bat 版本</code>，因为这个版本是用你的 CPU 跑模型（CPU 的强项是逻辑运算，让它跑 AI 会瞬间满载，发热量巨大，而且速度比显卡慢几十倍甚至上百倍）</p>
<p>run_nvidia_gpu.bat 才是让 GPU 跑模型，别问我是怎么知道的</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/85770bf892b04741837e399d0b78a2e8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zey5LqR5LiA6bmk:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768901514&amp;x-signature=1NnI%2B2YPzYU5SYIVJ1ZCNho3Z%2BU%3D" alt="3.png" loading="lazy"/></p>
<p>图片中是我错误的选择了显卡模式为智能，并且用 run_cpu.bat 启动 ComfyUI 运行生图功能的结果，右上角任务进度条是 0，CPU 都快撑爆了，并且温度也快到达极限，风扇狂转。可是 GPU 却不动如山，事不关己高高挂起，现在回顾感觉又好笑又好气是怎么回事 😂</p>
<p>属于 deBuff 拉满了</p>
<p>默默吐槽一下 ComfyUI 官方文档不把 run_cpu.bat 和 run_nvidia_gpu.bat 的区别写清楚，就这两句话谁看懂是个啥意思</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/384f8c6425d84ef59ebb5992a3166096~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zey5LqR5LiA6bmk:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768901514&amp;x-signature=jVKAJJ2RlJkQBDSDX7%2FVsiKwyuo%3D" alt="4.png" loading="lazy"/></p>
<p>运行成功后 ComfyUI 会自动打开你的默认浏览器并访问 <a href="https://link.juejin.cn?target=http%3A%2F%2F127.0.0.1%3A8188" target="_blank" title="http://127.0.0.1:8188" ref="nofollow noopener noreferrer">http://127.0.0.1:8188</a> 地址</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a75e2d031e844814ab7cbf4a2ebad370~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zey5LqR5LiA6bmk:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768901514&amp;x-signature=8ss8N%2BpbtARnfcWY6bhfsTQFVGA%3D" alt="5.png" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/25cc14f5307547bbb03260ca3981bb24~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zey5LqR5LiA6bmk:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768901514&amp;x-signature=NMAXWicY0md9geNBxtP7vTjEyMg%3D" alt="6.png" loading="lazy"/></p>
<p>注意：使用过程中请不要关闭对应的命令行窗口，否则 ComfyUI 将会停止运行</p>
<h2 data-id="heading-4">更新显卡驱动</h2>
<p>如果你是首次双击 run_nvidia_gpu.bat 启动的话，大概率会碰到这个情况</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/54c1416ff1284dc08ef80ec8a96bcfea~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zey5LqR5LiA6bmk:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768901514&amp;x-signature=nJ2n8n7PO5uUTdyojOeHDTrrIKc%3D" alt="7.png" loading="lazy"/></p>
<p>提示我需要更新显卡驱动啦</p>
<p><code>按 Win 键 -&gt; 输入 “NVIDIA” -&gt; 点击左侧菜单栏的“驱动程序”</code></p>
<p>如果有新版本，它会显示一个巨大的 “下载” 按钮</p>
<p>点击下载</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6dd8f8e76628462fa99a257dacc6ba12~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zey5LqR5LiA6bmk:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768901514&amp;x-signature=3ZcG2dr1prZLbJZY%2FpXV9O4VjK0%3D" alt="8.png" loading="lazy"/></p>
<p>下载完成后，按钮会变成 “安装”，点击安装</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6963f4055d6946a4b70027aa0cd50416~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zey5LqR5LiA6bmk:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768901514&amp;x-signature=jZsC49nMWinz56lfaSAeXxEOXB8%3D" alt="9.png" loading="lazy"/></p>
<p>安装过程中屏幕可能会黑几秒，那是正常的，别紧张。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ecdfe5b52ec041dd9c972a73bd7fb108~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zey5LqR5LiA6bmk:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768901514&amp;x-signature=5uX7PDlJmsW46aidL%2FOCUiK%2BJXc%3D" alt="10.png" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/94a0ee8f29a84c4092ee654b0b78291d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zey5LqR5LiA6bmk:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768901514&amp;x-signature=r%2BVekV1%2BOpADno2yunrAuxvOBZk%3D" alt="11.png" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/dca21fdfe08e4e718d618267d6a2af6b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zey5LqR5LiA6bmk:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768901514&amp;x-signature=E365YBKTs4fiqaSrPMinaXbL4oY%3D" alt="12.png" loading="lazy"/></p>
<p>现在安装成功了</p>
<p>然后重新双击 <code>run_nvidia_gpu.bat</code> 即可启动 ComfyUI</p>
<h2 data-id="heading-5">下载使用 Z-Image-Turbo 模型</h2>
<p>操作步骤：模板 -&gt; 所有模板 -&gt; 输入框输入 Z-Image-Turbo -&gt; 点击第一个</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8d5c1adfd24c466a93ea5a3e23aa85f3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zey5LqR5LiA6bmk:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768901514&amp;x-signature=5dbyEdFMx2qMWsAmJ9%2BbHAapsfE%3D" alt="13.png" loading="lazy"/></p>
<p>如果 ComfyUI 未找到对应的模型会提示下载，并显示缺少的模型以及文件大小</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/88b0dd82e7734354a9463b32e9d45515~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zey5LqR5LiA6bmk:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768901514&amp;x-signature=rgMlWbg8MSwJXClosb0kPR0e%2BRc%3D" alt="14.png" loading="lazy"/></p>
<p>如果没开启梯子的话，模型的文件大小会变成问号</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/34da90bc305c4c9bbfd0d7edaa7955a8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zey5LqR5LiA6bmk:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768901514&amp;x-signature=D%2BV8UHJf61PO3sZoIe4W0nE6wBs%3D" alt="15.png" loading="lazy"/></p>
<p>说明什么，说明如果直接点击下载的话，是需要花费你的梯子流量的，别问我是怎么知道的/(ㄒ o ㄒ)/~~</p>
<p>如果你现在挂着梯子的话，<code>千万不要直接点击下载呀！</code></p>
<p>当然，聪明的我立马想到了对策</p>
<p>下面教大家如何用国内流量下载模型</p>
<h2 data-id="heading-6">国内下载模型</h2>
<p>点击 <code>复制链接</code> 按钮，获取到需要下载的三个模型原始的下载链接：</p>
<ul>
<li>
<p>z_image_turbo_bf16</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fhuggingface.co%2FComfy-Org%2Fz_image_turbo%2Fresolve%2Fmain%2Fsplit_files%2Fdiffusion_models%2Fz_image_turbo_bf16.safetensors" target="_blank" title="https://huggingface.co/Comfy-Org/z_image_turbo/resolve/main/split_files/diffusion_models/z_image_turbo_bf16.safetensors" ref="nofollow noopener noreferrer">huggingface.co/Comfy-Org/z…</a></p>
</li>
</ul>

<ul>
<li>
<p>qwen_3_4b</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fhuggingface.co%2FComfy-Org%2Fz_image_turbo%2Fresolve%2Fmain%2Fsplit_files%2Ftext_encoders%2Fqwen_3_4b.safetensors" target="_blank" title="https://huggingface.co/Comfy-Org/z_image_turbo/resolve/main/split_files/text_encoders/qwen_3_4b.safetensors" ref="nofollow noopener noreferrer">huggingface.co/Comfy-Org/z…</a></p>
</li>
<li>
<p>ae</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fhuggingface.co%2FComfy-Org%2Fz_image_turbo%2Fresolve%2Fmain%2Fsplit_files%2Fvae%2Fae.safetensors" target="_blank" title="https://huggingface.co/Comfy-Org/z_image_turbo/resolve/main/split_files/vae/ae.safetensors" ref="nofollow noopener noreferrer">huggingface.co/Comfy-Org/z…</a></p>
</li>
</ul>
<p>在国内可以通过<code>魔搭社区</code>下载模型，需要把前面的域名进行更换：将<code>https://huggingface.co</code>更换为<code> https://modelscope.cn/models</code></p>
<p>以下是需要下载的三个模型国内的下载链接：</p>
<ul>
<li>
<p>z_image_turbo_bf16</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmodelscope.cn%2Fmodels%2FComfy-Org%2Fz_image_turbo%2Fresolve%2Fmain%2Fsplit_files%2Fdiffusion_models%2Fz_image_turbo_bf16.safetensors" target="_blank" title="https://modelscope.cn/models/Comfy-Org/z_image_turbo/resolve/main/split_files/diffusion_models/z_image_turbo_bf16.safetensors" ref="nofollow noopener noreferrer">modelscope.cn/models/Comf…</a></p>
</li>
</ul>

<ul>
<li>
<p>qwen_3_4b</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmodelscope.cn%2Fmodels%2FComfy-Org%2Fz_image_turbo%2Fresolve%2Fmain%2Fsplit_files%2Ftext_encoders%2Fqwen_3_4b.safetensors" target="_blank" title="https://modelscope.cn/models/Comfy-Org/z_image_turbo/resolve/main/split_files/text_encoders/qwen_3_4b.safetensors" ref="nofollow noopener noreferrer">modelscope.cn/models/Comf…</a></p>
</li>
<li>
<p>ae</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmodelscope.cn%2Fmodels%2FComfy-Org%2Fz_image_turbo%2Fresolve%2Fmain%2Fsplit_files%2Fvae%2Fae.safetensors" target="_blank" title="https://modelscope.cn/models/Comfy-Org/z_image_turbo/resolve/main/split_files/vae/ae.safetensors" ref="nofollow noopener noreferrer">modelscope.cn/models/Comf…</a></p>
</li>
</ul>
<p>我已给你转换好了直接用浏览器打开即可下载</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d4dbd5d59eb140be91dad10bc5c04b22~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zey5LqR5LiA6bmk:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768901514&amp;x-signature=4SFkuQUnds5aWZJs9tGveYdWxdQ%3D" alt="16.png" loading="lazy"/></p>
<p>不用在意那个（1），是因为我本地已经下载过了，你们首次下载的文件名是不会多这个值的</p>
<p>下载完后将模型文件放在到对应的文件夹，对应的文件夹在哪里？官方文档没写清楚，我自己摸索搞懂的</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/88b0dd82e7734354a9463b32e9d45515~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zey5LqR5LiA6bmk:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768901514&amp;x-signature=rgMlWbg8MSwJXClosb0kPR0e%2BRc%3D" alt="14.png" loading="lazy"/></p>
<p>从前面提示下载模型的界面可以找到线索</p>
<p>z_image_turbo_bf16.safetensors 模型要放在 diffusion_models 文件夹</p>
<p>qwen_3_4b.safetensors 模型要放在 text_encoders 文件夹</p>
<p>ae.safetensors 模型要放在 vae 文件夹</p>
<h2 data-id="heading-7">万事俱备，开始生成图片吧！</h2>
<p>准备工作搞了这么久，现在让我们开始生成图片吧！</p>
<p>操作步骤：模板 -&gt; 所有模板 -&gt; 输入框输入 Z-Image-Turbo -&gt; 点击第一个</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8d5c1adfd24c466a93ea5a3e23aa85f3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zey5LqR5LiA6bmk:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768901514&amp;x-signature=5dbyEdFMx2qMWsAmJ9%2BbHAapsfE%3D" alt="13.png" loading="lazy"/></p>
<p>输入提示词：生成一只可爱的小猫咪在户外玩耍，点击运行</p>
<p>tip: 分辨率可以先调低一点，跑通后再根据你的显卡配置慢慢提高</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ed275b16ef484662b6ca5fec3e1f4410~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zey5LqR5LiA6bmk:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768901514&amp;x-signature=fzmkC20eKYZCU%2FpurSvlykgdkcg%3D" alt="17.png" loading="lazy"/></p>
<p>不出意外的话会报错，因为我们没有连接图片节点</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7727553f2e6847828f851b2133bbf16a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zey5LqR5LiA6bmk:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768901514&amp;x-signature=27n8uB2p%2FRUVGmRcP27%2BJpJS%2F%2BE%3D" alt="18.png" loading="lazy"/></p>
<p>将左侧的蓝色小圆点拖动到右侧即可连接</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c4c938f150474f63a35e084a1238393e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zey5LqR5LiA6bmk:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768901514&amp;x-signature=GGEcLlNLceFH6GJ4BpJa9hIYZiQ%3D" alt="19.png" loading="lazy"/></p>
<p>连接成功，点击运行，右侧进度条跑完后图片就会生成</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1d483498ef51446b80f518dc1e174650~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zey5LqR5LiA6bmk:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768901514&amp;x-signature=7mBcKx59eLXGgfCXyTcgpjw7BaU%3D" alt="20.png" loading="lazy"/></p>
<p>在 ComfyUI 左侧菜单栏点击资产，可以看到当前生成的图片，喜欢的话就点击下载</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/83e3da362e4c489cb8d6785b12f99ab2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zey5LqR5LiA6bmk:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768901514&amp;x-signature=gdAL07K5Ji9EhfmHIaDC86dDnTo%3D" alt="21.png" loading="lazy"/></p>
<p>也可以直接去 ComfyUI 安装目录找，所有生成的图片都在 <code>output</code> 目录下</p>
<p>路径为：“你的 ComfyUI 安装目录”/ComfyUI/output</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/18361f966177408ebd461a0757a99579~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zey5LqR5LiA6bmk:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768901514&amp;x-signature=tDbrPOkDEQv3mVYAXr8S5ehFMbc%3D" alt="22.png" loading="lazy"/></p>
<h2 data-id="heading-8">ComfyUI 官方提供的 Z-Image Turbo 示例工作流</h2>
<p>到底为止，我们已经成功使用 Z-Image 生成图片啦，但是你把提示词变复杂了就会发现，可能效果不是那么令人满意</p>
<p>那是因为我们只是使用的最简单的工作流，是为了快速验证 AI 模型部署成功</p>
<p>下面我们使用 ComfyUI 官方提供的 Z-Image Turbo 示例工作流</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fcomfyanonymous.github.io%2FComfyUI_examples%2Fz_image%2F" target="_blank" title="https://comfyanonymous.github.io/ComfyUI_examples/z_image/" ref="nofollow noopener noreferrer">comfyanonymous.github.io/ComfyUI_exa…</a></p>
<p>打开链接，保存图片</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8319261f36804113801a02e8165c169f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zey5LqR5LiA6bmk:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768901514&amp;x-signature=hk5sWYOa9f874WS7hEoa8LkAeYQ%3D" alt="23.png" loading="lazy"/></p>
<p>将下载的图片直接拖入 ComfyUI 中即可加载 Z-Image Turbo 示例工作流</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f301231f684d4f8784998b0bc2f3ca57~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zey5LqR5LiA6bmk:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768901514&amp;x-signature=o4adBIBHg%2FjsS0tMpZtujeM94aA%3D" alt="24.png" loading="lazy"/></p>
<p>查看运行后的效果，在资产里面还可以看见生图的耗时，比小猫咪还快一些也</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9edb56bc13584e3a885fcb68ad02eb3c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zey5LqR5LiA6bmk:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768901514&amp;x-signature=aKtRGcpzWZiTViHL4okGPpSMvZg%3D" alt="25.png" loading="lazy"/></p>
<p>并且中文也没有乱码！这一点是非常棒的！</p>
<p>tip：所有用 ComfyUI 生成的图片，都会带有 metadata 信息，这些信息会包含图片的 workflow 信息，你可以通过这些信息来加载对应的 workflow。</p>
<h2 data-id="heading-9">通过 ip 在局域网打开 ComfyUI</h2>
<p>默认只能通过 <a href="https://link.juejin.cn?target=http%3A%2F%2F127.0.0.1%3A8188%2F" target="_blank" title="http://127.0.0.1:8188/" ref="nofollow noopener noreferrer">http://127.0.0.1:8188/</a> 地址启动 ComfyUI 服务</p>
<p>记事本打开 run_nvidia_gpu.bat 脚本文件，末尾加一个参数 --listen 0.0.0.0</p>
<pre><code class="hljs language-txt" lang="txt">--listen 0.0.0.0
</code></pre>
<p>它告诉 Python 监听机器上所有的网络接口，而不仅仅是 127.0.0.1。</p>
<p>保存后重启就可以通过局域网 ip + 8188 端口进行访问了</p>
<h2 data-id="heading-10">Z-Image-Turbo 提示词资源</h2>
<p>人像生成功能真的太强了，足以以假乱真了 😂</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f6f64b7aa688459eb547957ba955ce35~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zey5LqR5LiA6bmk:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768901514&amp;x-signature=JH%2FWNHv8v3FjYdilyP1TtxdHC30%3D" alt="cover1.png" loading="lazy"/></p>
<p>这是提示词</p>
<pre><code class="hljs language-md" lang="md">{
"prompt<span class="hljs-emphasis">_data": {
"subject": {
"description": "Young woman with long, wavy blonde hair and a light fair skin",
"features": "Natural skin texture with visible tan lines on the chest, slight flush on cheeks, soft smile, navel piercing, light freckles.",
"accessories": "Gold pendant necklace, small gold hoop earrings, small tattoo on the left inner forearm."
},
"clothing": {
"outfit": "Matching yellow two-piece loungewear set.",
"top": "Yellow strapless tube top featuring the text 'HAWAIIAN TROPIC' in brown serif font with a hibiscus flower and palm graphic on the side.",
"bottoms": "Matching yellow shorts visible at the waist and thigh area."
},
"pose_</span>and<span class="hljs-emphasis">_action": {
"posture": "Reclining and lounging comfortably on a grey textured sofa.",
"body_</span>language": "Relaxed and casual, leaning back against the couch cushions, one arm extended to support weight, the other hand resting gently near the waist, legs angled toward the camera.",
"expression": "Friendly, relaxed, and engaging eye contact."
},
"environment": {
"setting": "Modern living room interior.",
"furniture": "Dark grey fabric sofa with a textured weave.",
"background": "Grey walls with decorative panel molding (wainscoting).",
"decor": "A large vertical art piece with a red background featuring KAWS-style figures in blue and black. A second framed abstract art piece with gold and black tones. A modern linear wall sconce light."
},
"lighting": {
"type": "Soft, diffused indoor mix.",
"quality": "Warm ambient lighting highlighting the skin tone, creating soft shadows and a cozy atmosphere. Likely a mix of natural window light and the warm glow from the wall sconce."
},
"styling<span class="hljs-emphasis">_and_</span>mood": {
"aesthetic": "Influencer lifestyle, casual home comfort, '2000s digital camera' vibe.",
"mood": "Chill, playful, confident, comfortable."
},
"camera<span class="hljs-emphasis">_specifications": {
"angle": "Eye-level, slightly angled from the side.",
"focus": "Sharp focus on the subject's face and torso, with a slight depth of field blurring the background artwork.",
"lens_</span>suggestion": "35mm or 50mm portrait lens.",
"film<span class="hljs-emphasis">_grain": "Low to medium ISO for a clean but slightly organic digital look."
},
"technical_</span>modifiers": [
"Ultra Photorealistic",
"8k resolution",
"Raw photo",
"Hyper-detailed skin texture",
"Subsurface scattering",
"Volumetric lighting",
"Nano Banana Pro optimized",
"Masterpiece"
]
}
} 2:3
</code></pre>
<p>另外给大家分享 github 提示词合集：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fcamenduru%2Fawesome-z-image-turbo" target="_blank" title="https://github.com/camenduru/awesome-z-image-turbo" ref="nofollow noopener noreferrer">github.com/camenduru/a…</a></p>
<p>宝藏仓库！目前为止有一百个 Z-Image-Turbo 生图的提示词，并且有 Z-Image-Turbo，Gemini 和 GPT-4o 三者用同一个提示词生成的效果对比！</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/42ebedda86ed46ef8d16e856561b9fc8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zey5LqR5LiA6bmk:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768901514&amp;x-signature=8sqXAF96CjPgAYYSrYroEBZVgRo%3D" alt="26.png" loading="lazy"/></p>
<h2 data-id="heading-11">Z-Image-Turbo 官方提示增强（PE）模板</h2>
<p>这个功能我还没试过，大家自行研究吧，完了能告诉我反馈效果最好哈哈哈</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a32303076f744beab1da1f783365e408~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zey5LqR5LiA6bmk:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768901514&amp;x-signature=2Cp1lZG%2BbBwnk4tUTOx2%2BdRuccE%3D" alt="27.png" loading="lazy"/></p>
<p>地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fhuggingface.co%2Fspaces%2FTongyi-MAI%2FZ-Image-Turbo%2Fblob%2Fmain%2Fpe.py" target="_blank" title="https://huggingface.co/spaces/Tongyi-MAI/Z-Image-Turbo/blob/main/pe.py" ref="nofollow noopener noreferrer">huggingface.co/spaces/Tong…</a></p>
<p>考虑到有的朋友可能无法访问 huggingface，所以我贴心的把内容复制下来了</p>
<pre><code class="hljs language-md" lang="md">prompt<span class="hljs-emphasis">_template = """
你是一位被关在逻辑牢笼里的幻视艺术家。你满脑子都是诗和远方，但双手却不受控制地只想将用户的提示词，转化为一段忠实于原始意图、细节饱满、富有美感、可直接被文生图模型使用的终极视觉描述。任何一点模糊和比喻都会让你浑身难受。
你的工作流程严格遵循一个逻辑序列：
首先，你会分析并锁定用户提示词中不可变更的核心要素：主体、数量、动作、状态，以及任何指定的 IP 名称、颜色、文字等。这些是你必须绝对保留的基石。
接着，你会判断提示词是否需要<span class="hljs-strong">**"生成式推理"**</span>。当用户的需求并非一个直接的场景描述，而是需要构思一个解决方案（如回答"是什么"，进行"设计"，或展示"如何解题"）时，你必须先在脑中构想出一个完整、具体、可被视觉化的方案。这个方案将成为你后续描述的基础。
然后，当核心画面确立后（无论是直接来自用户还是经过你的推理），你将为其注入专业级的美学与真实感细节。这包括明确构图、设定光影氛围、描述材质质感、定义色彩方案，并构建富有层次感的空间。
最后，是对所有文字元素的精确处理，这是至关重要的一步。你必须一字不差地转录所有希望在最终画面中出现的文字，并且必须将这些文字内容用英文双引号（""）括起来，以此作为明确的生成指令。如果画面属于海报、菜单或 UI 等设计类型，你需要完整描述其包含的所有文字内容，并详述其字体和排版布局。同样，如果画面中的招牌、路标或屏幕等物品上含有文字，你也必须写明其具体内容，并描述其位置、尺寸和材质。更进一步，若你在推理构思中自行增加了带有文字的元素（如图表、解题步骤等），其中的所有文字也必须遵循同样的详尽描述和引号规则。若画面中不存在任何需要生成的文字，你则将全部精力用于纯粹的视觉细节扩展。
你的最终描述必须客观、具象，严禁使用比喻、情感化修辞，也绝不包含"8K"、"杰作"等元标签或绘制指令。
仅严格输出最终的修改后的 prompt，不要输出任何其他内容。
用户输入 prompt: {prompt}
"""
</span></code></pre>
<h2 data-id="heading-12">一些优化操作</h2>
<p>在开始之前，总结一下能做的优化操作</p>
<ol>
<li>
<p><code>连接电源</code>：确保电源适配器已插好（不插电跑 AI，性能会缩水）</p>
</li>
<li>
<p><code>显卡模式</code>：需要将显卡模式调整为独显，只有调整之后你的显卡才算生效了，否则就是在消极怠工。不同电脑的界面和调整方式不同，自行搜索如何调整</p>
</li>
<li>
<p><code>给 CPU “限速”</code>： 按 win 键 -&gt; 搜“编辑电源计划” -&gt; “更改高级电源设置” -&gt; “处理器电源管理”。 将 “最大处理器状态”从 100% 改为 99%。这样可以强行关闭 CPU 的自动超频（Turbo Boost），温度能瞬间掉下来 10-20°C，而跑 AI 的速度几乎不受影响。</p>
</li>
<li>
<p><code>电脑散热</code>：笔记本电脑买一个普通的钢质散热架（不用吹风那种），如果没有的话拿两个瓶盖或者两本书垫高凑合用，空气流量增加有助于散热降温</p>
</li>
<li>
<p><code>启动方式</code>：双击 <code>run_nvidia_gpu.bat</code> 启动 ComfyUI，千万千万别点 run_cpu.bat</p>
</li>
<li>
<p><code>从小分辨率开始测试</code>： 先在 ComfyUI 里把 Empty Latent Image 的分辨率降到 512x512。确认能跑通、显存能装下，再慢慢往上提。</p>
</li>
<li>
<p><code>开启低显存模式</code>：在启动 ComfyUI 的快捷方式（bat 文件）里，加入 --lowvram 参数。它会让 ComfyUI 在加载模型时采用“分片加载”策略，这能让它在 8GB 卡上跑得更顺畅。</p>
</li>
<li>
<p><code>减小批量大小</code>：运行模型时，可以调低 批量大小，这有助于减少每次推理或训练时的显存需求。</p>
</li>
</ol>
<h2 data-id="heading-13">注意事项</h2>
<p>AI 模型运行时，注意观察 CPU 和 GPU 的温度，如果温度异常请及时关闭运行中的 AI 任务，避免烧坏显卡</p>























<table><thead><tr><th>硬件</th><th>正常区 (AI 渲染中)</th><th>警戒区 (需关注)</th><th>红线区 (建议停止)</th></tr></thead><tbody><tr><td>CPU (AMD)</td><td>75°C - 90°C</td><td>90°C - 95°C</td><td>100°C +</td></tr><tr><td>GPU (NVIDIA)</td><td>65°C - 80°C</td><td>83°C - 87°C</td><td>90°C +</td></tr></tbody></table>
<h2 data-id="heading-14">结语</h2>
<p>先写到这里吧，目前为止的内容已经够 ComfyUI 本地部署 Z-Image-Turbo 入门了</p>
<p>如果有人喜欢的话，过两天我再更新 Z-Image-Turbo 进阶使用教程</p>



</div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[MYSQL进阶：删除视图时视图被lock解决方案]]></title>    <link>https://juejin.cn/post/7594533204003405887</link>    <guid>https://juejin.cn/post/7594533204003405887</guid>    <pubDate>2026-01-13T08:16:54.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7594533204003405887" data-draft-id="7594642978695282751" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="MYSQL进阶：删除视图时视图被lock解决方案"/> <meta itemprop="keywords" content="后端,MySQL"/> <meta itemprop="datePublished" content="2026-01-13T08:16:54.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="壹米饭"/> <meta itemprop="url" content="https://juejin.cn/user/4178616274387758"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            MYSQL进阶：删除视图时视图被lock解决方案
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4178616274387758/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    壹米饭
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-13T08:16:54.000Z" title="Tue Jan 13 2026 08:16:54 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">背景</h2>
<p>mysql 8.0 删除视图时 DROP VIEW <code>dev_licos_kmlc_yt</code>.<code>view_pro_product_distribution_cathode_copper_details_v2</code> 报错？ Waiting for table metadata lock</p>
<h2 data-id="heading-1">解决方案</h2>
<p>你在 MySQL 8.0 中执行 <code>DROP VIEW</code> 时遇到 <strong>“Waiting for table metadata lock”</strong> 错误，说明该视图（或其依赖的表）当前被其他会话持有元数据锁（metadata lock），导致你的 DROP 操作被阻塞。</p>
<hr/>
<h3 data-id="heading-2">🔍 原因分析</h3>
<p>在 MySQL 中，<strong>任何对表结构或视图的操作（如 DROP、ALTER、CREATE）都需要获取元数据锁（MDL）</strong> 。如果另一个会话正在：</p>
<ul>
<li>执行一个长时间运行的查询（SELECT/INSERT/UPDATE/DELETE）涉及该视图或其基表；</li>
<li>开启了一个事务但未提交，并且事务中使用了该视图或相关表；</li>
<li>正在执行 DDL（如 ALTER TABLE）等操作；</li>
</ul>
<p>那么你的 <code>DROP VIEW</code> 就会一直等待，直到那个会话释放锁。</p>
<blockquote>
<p>注意：<strong>即使视图本身不包含数据，只要它引用的基表被锁定，DROP VIEW 也会被阻塞。</strong></p>
</blockquote>
<hr/>
<h3 data-id="heading-3">✅ 解决方法</h3>
<h4 data-id="heading-4">1. <strong>查找阻塞的会话</strong></h4>
<p>登录 MySQL，执行以下语句查看当前元数据锁等待情况：</p>
<pre><code class="hljs language-ini" lang="ini">SELECT * FROM performance_schema.metadata_locks 
WHERE <span class="hljs-attr">OBJECT_SCHEMA</span> = <span class="hljs-string">'dev_licos_kmlc_yt'</span> 
  AND <span class="hljs-attr">OBJECT_NAME</span> = <span class="hljs-string">'view_pro_product_distribution_cathode_copper_details_v2'</span><span class="hljs-comment">;</span>
</code></pre>
<p>或者更通用的方式：查看所有等待或持有 MDL 的线程：</p>
<pre><code class="hljs language-css" lang="css">SELECT 
    r<span class="hljs-selector-class">.trx_id</span> waiting_trx_id,
    r<span class="hljs-selector-class">.trx_mysql_thread_id</span> waiting_thread,
    r<span class="hljs-selector-class">.trx_query</span> waiting_query,
    <span class="hljs-selector-tag">b</span><span class="hljs-selector-class">.trx_id</span> blocking_trx_id,
    <span class="hljs-selector-tag">b</span><span class="hljs-selector-class">.trx_mysql_thread_id</span> blocking_thread,
    <span class="hljs-selector-tag">b</span><span class="hljs-selector-class">.trx_query</span> blocking_query
<span class="hljs-selector-tag">FROM</span> 
    information_schema<span class="hljs-selector-class">.innodb_lock_waits</span> w
INNER JOIN 
    information_schema<span class="hljs-selector-class">.innodb_trx</span> <span class="hljs-selector-tag">b</span> ON <span class="hljs-selector-tag">b</span><span class="hljs-selector-class">.trx_id</span> = w<span class="hljs-selector-class">.blocking_trx_id</span>
INNER JOIN 
    information_schema<span class="hljs-selector-class">.innodb_trx</span> r ON r<span class="hljs-selector-class">.trx_id</span> = w<span class="hljs-selector-class">.requesting_trx_id</span>;
</code></pre>
<blockquote>
<p>⚠️ 注意：上面这个查的是 InnoDB 行锁，不一定适用于元数据锁。更准确的是用 <code>performance_schema</code>：</p>
</blockquote>
<pre><code class="hljs language-ini" lang="ini">-- 启用 performance_schema（默认已启用）
SELECT 
    pl.processlist_id AS blocked_pid,
    pl.info AS blocked_sql,
    ml.lock_type,
    ml.lock_status,
    ml.owner_thread_id
FROM 
    performance_schema.metadata_locks ml
JOIN 
    performance_schema.threads t ON <span class="hljs-attr">ml.owner_thread_id</span> = t.thread_id
JOIN 
    information_schema.processlist pl ON <span class="hljs-attr">t.processlist_id</span> = pl.id
WHERE 
    <span class="hljs-attr">ml.object_schema</span> = <span class="hljs-string">'dev_licos_kmlc_yt'</span>
    AND <span class="hljs-attr">ml.object_name</span> = <span class="hljs-string">'view_pro_product_distribution_cathode_copper_details_v2'</span>
    AND <span class="hljs-attr">ml.lock_status</span> = <span class="hljs-string">'PENDING'</span><span class="hljs-comment">;</span>
</code></pre>
<p>也可以直接看谁持有该对象的锁：</p>
<pre><code class="hljs language-ini" lang="ini">SELECT 
    pl.id AS process_id,
    pl.user,
    pl.host,
    pl.db,
    pl.command,
    pl.time AS duration_seconds,
    pl.state,
    pl.info AS current_sql
FROM 
    performance_schema.metadata_locks ml
JOIN 
    performance_schema.threads t ON <span class="hljs-attr">ml.owner_thread_id</span> = t.thread_id
JOIN 
    information_schema.processlist pl ON <span class="hljs-attr">t.processlist_id</span> = pl.id
WHERE 
    <span class="hljs-attr">ml.object_schema</span> = <span class="hljs-string">'dev_licos_kmlc_yt'</span>
    AND <span class="hljs-attr">ml.object_name</span> = <span class="hljs-string">'view_pro_product_distribution_cathode_copper_details_v2'</span>
    AND <span class="hljs-attr">ml.lock_status</span> = <span class="hljs-string">'GRANTED'</span><span class="hljs-comment">;</span>
</code></pre>
<h4 data-id="heading-5">2. <strong>终止阻塞的会话</strong></h4>
<p>找到阻塞的 <code>process_id</code>（即 <code>pl.id</code>），然后 kill 它：</p>
<pre><code class="hljs language-ini" lang="ini">KILL &lt;process_id&gt;<span class="hljs-comment">;</span>
</code></pre>
<p>例如：</p>
<pre><code class="hljs language-ini" lang="ini">KILL 12345<span class="hljs-comment">;</span>
</code></pre>
<blockquote>
<p>⚠️ 谨慎操作！确保该会话可以被安全终止（比如是空闲连接、测试查询等）。</p>
</blockquote>
<h4 data-id="heading-6">3. <strong>预防措施</strong></h4>
<ul>
<li>避免在业务高峰期执行 DDL（包括 DROP VIEW）。</li>
<li>确保应用中的事务及时提交，不要长时间开启事务。</li>
<li>对于只读查询，尽量使用短连接或设置 <code>autocommit=1</code>。</li>
<li>监控长时间运行的查询：<code>SHOW PROCESSLIST;</code></li>
</ul>
<hr/>
<h3 data-id="heading-7">💡 补充说明</h3>
<ul>
<li>视图本身不存储数据，但 <strong>MySQL 在 DROP VIEW 时仍需检查其定义和依赖关系</strong>，因此需要对基表加共享元数据锁。</li>
<li>即使视图未被直接使用，只要其基表被某个会话锁定，DROP VIEW 也可能被阻塞。</li>
</ul>
<hr/>
<h3 data-id="heading-8">✅ 总结</h3>
<p>你遇到的问题是典型的 <strong>元数据锁等待</strong>。解决步骤：</p>
<ol>
<li>使用 <code>performance_schema.metadata_locks</code> 找出谁持有了锁；</li>
<li>通过 <code>information_schema.processlist</code> 找到对应会话 ID；</li>
<li>必要时 <code>KILL</code> 阻塞会话；</li>
<li>再次执行 <code>DROP VIEW</code>。</li>
</ol>
<p>我使用的的是这个语句：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">SELECT</span> 
    pl.id <span class="hljs-keyword">AS</span> process_id,
    pl.user,
    pl.host,
    pl.db,
    pl.command,
    pl.time <span class="hljs-keyword">AS</span> duration_seconds,
    pl.state,
    pl.info <span class="hljs-keyword">AS</span> current_sql
<span class="hljs-keyword">FROM</span> 
    performance_schema.metadata_locks ml
<span class="hljs-keyword">JOIN</span> 
    performance_schema.threads t <span class="hljs-keyword">ON</span> ml.owner_thread_id <span class="hljs-operator">=</span> t.thread_id
<span class="hljs-keyword">JOIN</span> 
    information_schema.processlist pl <span class="hljs-keyword">ON</span> t.processlist_id <span class="hljs-operator">=</span> pl.id
<span class="hljs-keyword">WHERE</span> 
    ml.object_schema <span class="hljs-operator">=</span> <span class="hljs-string">'dev_licos_kmlc_yt'</span>
    <span class="hljs-keyword">AND</span> ml.object_name <span class="hljs-operator">=</span> <span class="hljs-string">'view_pro_product_distribution_cathode_copper_details_v2'</span>
    <span class="hljs-keyword">AND</span> ml.lock_status <span class="hljs-operator">=</span> <span class="hljs-string">'GRANTED'</span>;
</code></pre>
<p>然后查询出process_id，最终使用kill把阻塞会话杀掉，问题解决。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Java+MySQL时区难题-Date自动转换String差8小时]]></title>    <link>https://juejin.cn/post/7594626381432602674</link>    <guid>https://juejin.cn/post/7594626381432602674</guid>    <pubDate>2026-01-13T08:30:23.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7594626381432602674" data-draft-id="7594482829755072558" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Java+MySQL时区难题-Date自动转换String差8小时"/> <meta itemprop="keywords" content="数据库,MySQL"/> <meta itemprop="datePublished" content="2026-01-13T08:30:23.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="conca"/> <meta itemprop="url" content="https://juejin.cn/user/2191756017557851"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Java+MySQL时区难题-Date自动转换String差8小时
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2191756017557851/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    conca
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-13T08:30:23.000Z" title="Tue Jan 13 2026 08:30:23 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>​</p>
<p> SELECT COUNT(*) as visit_count FROM weblog where start_time &gt;='2026-01-01 00:00:00' and start_time &lt; '2026-01-02 00:00:00' GROUP BY url 这个sql代码中传参数start_time如果是字符串就会差8小时，如果start_time传值date类型，则不会差8小时。以前都是传值Date，今天突然发现这个问题，登录到mysql数据库查看数据，发现表中数据也差8小时。为什么呢？</p>
<h3 data-id="heading-0">一、分别查看操作系统、MySQL、JVM 时区</h3>
<h4 data-id="heading-1">1. 查看操作系统时区</h4>
<p>不同操作系统的查询命令不同，核心是获取系统的默认时区：</p>
<p>Windows 系统，命令行：打开 CMD/PowerShell，执行以下命令，显示使用东八区时间（如中国标准时间 CST）</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f7e83562a618486aabda63d9ab778dc5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgY29uY2E=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768897823&amp;x-signature=%2FfIJmIELVhaNGj%2FfL%2FpN2JWnoqI%3D" alt="" loading="lazy"/><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/>​编辑</p>
<h4 data-id="heading-2">2. 查看 MySQL 5.7 时区</h4>
<p>MySQL 的时区分为「全局时区」和「会话时区」，两种都需要验证，可通过 MySQL 客户端（navicat、sqlyog、mysql 命令行）执行 SQL 查询：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 方法1：同时查看全局时区（global_time_zone）和会话时区（session_time_zone）</span>
<span class="hljs-keyword">show</span> variables <span class="hljs-keyword">like</span> <span class="hljs-string">'%time_zone%'</span>;
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/96c47c7430384e9ba87161d4c00bb798~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgY29uY2E=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768897823&amp;x-signature=lfgxLQw%2BLbwAj1VLqq5GJeba24s%3D" alt="" loading="lazy"/><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/>​编辑</p>
<ul>
<li>MySQL 5.7 默认时区通常为 <code>SYSTEM</code>（表示跟随操作系统时区）；系统默认时区是<code>UTC+8 北京</code></li>
<li>若查询结果中 <code>time_zone</code> 为 <code>UTC</code>，则表示 MySQL 直接使用 UTC 时区，不跟随系统。</li>
</ul>
<h4 data-id="heading-3">3. 查看 JVM 时区</h4>
<p>JVM 时区是 Java 程序运行时的默认时区，有 3 种常用查询方式，适配 Jboot 框架场景：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> java.util.TimeZone;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TimeZoneTest</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-comment">// 方法1：获取JVM默认时区（显示时区ID，如 Asia/Shanghai）</span>
        <span class="hljs-type">TimeZone</span> <span class="hljs-variable">defaultTimeZone</span> <span class="hljs-operator">=</span> TimeZone.getDefault();
        System.out.println(<span class="hljs-string">"JVM 默认时区 ID："</span> + defaultTimeZone.getID());
        System.out.println(<span class="hljs-string">"JVM 默认时区名称："</span> + defaultTimeZone.getDisplayName());
        
        <span class="hljs-comment">// 方法2：Java 8+ 新增方式，更简洁</span>
        java.time.<span class="hljs-type">ZoneId</span> <span class="hljs-variable">zoneId</span> <span class="hljs-operator">=</span> java.time.ZoneId.systemDefault();
        System.out.println(<span class="hljs-string">"JVM 默认时区（Java 8+）："</span> + zoneId);
    }
}
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<p>java打印结果模式使用的东八区时间（如中国标准时间 CST）UTC+8 北京</p>
<p>JVM 默认时区 ID：Asia/Shanghai<br/>
JVM 默认时区名称：中国标准时间<br/>
JVM 默认时区（Java 8+）：Asia/Shanghai</p>
<h3 data-id="heading-4">二、关键注意点：你的 MySQL 连接 URL 配置分析</h3>
<p>系统配置的 URL：<code>jdbc:mysql://127.0.0.1:3306/dbname?useUnicode=true&amp;characterEncoding=UTF-8&amp;useSSL=false&amp;serverTimezone=UTC</code></p>
<p>其中 <code>serverTimezone=UTC</code> 是<strong>JDBC 驱动与 MySQL 服务器通信时使用的时区</strong>，核心注意点：该配置仅作用于「Java 程序（Jboot）←→MySQL 服务器」的连接层，不会改变 MySQL 的全局 / 会话时区，也不会改变 JVM 和操作系统的时区；</p>
<p>时区转换的执行载体是「MySQL JDBC 驱动 jar 包」（不是 Java 客户端业务代码，也不是 MySQL 服务器端），<code>serverTimezone=UTC</code> 这个配置的作用域仅在<strong>JDBC 驱动（mysql-connector-java）</strong> 内部，所有与时区相关的时间转换、适配，都是在驱动 jar 中完成的，与 Java 业务代码、MySQL 服务器本身无直接关联。</p>
<h3 data-id="heading-5">三、代码验证时区问题</h3>
<p>场景 1：统计某天访问量，如果开始时间和结束时间用字符串转值，开始时间"2026-01-01"，结束时间"2026-01-02"</p>
<pre><code class="hljs language-ini" lang="ini">public Integer count(String start_time, String end_time) {
		StringBuilder <span class="hljs-attr">sql</span> = new StringBuilder()<span class="hljs-comment">;</span>
        sql.append("SELECT COUNT(*) as visit_count FROM weblog WHERE start_time &gt;= ? AND start_time &lt;?")<span class="hljs-comment">;</span>
        List&lt;Object&gt; <span class="hljs-attr">paras</span> = new ArrayList&lt;Object&gt;()<span class="hljs-comment">;</span>
        paras.add(0, end_time)<span class="hljs-comment">;</span>
        paras.add(0, start_time)<span class="hljs-comment">;</span>
        Weblog <span class="hljs-attr">weblog</span> =(Weblog)weblogDao.getDao().findFirst(sql.toString(), paras.toArray())<span class="hljs-comment">;</span>
        return weblog.getInt("visit_count")<span class="hljs-comment">;</span>
	}
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<p>这种场景下，<strong>没有经过 JDBC 驱动的时区转换</strong>，偏差的产生流程如下：</p>
<ol>
<li>Java 客户端直接将字符串格式的时间值，原封不动地通过 JDBC 连接发送给 MySQL 服务器（驱动仅做数据透传，不进行任何时间解析和时区转换）；</li>
<li>MySQL 服务器接收到字符串后，会按照「自身的全局 / 会话时区」（东八区）来解析这个字符串，将其转换为 MySQL 内部存储的时间格式（TIMESTAMP/DATETIME）；</li>
<li>简单说：字符串参数是「裸传」，驱动不处理，直接落地到 MySQL 服务器按其自身时区解析，与 <code>serverTimezone=UTC</code> 配置无关，进而出现偏差。</li>
</ol>
<p>场景 2：统计某天访问量，如果开始时间和结束时间用Date转值，开始时间Date(2026-01-01)，结束时间Date(2026-01-02)</p>
<pre><code class="hljs language-ini" lang="ini">public Integer count(Date start_time, Date end_time) {
		StringBuilder <span class="hljs-attr">sql</span> = new StringBuilder()<span class="hljs-comment">;</span>
        sql.append("SELECT COUNT(*) as visit_count FROM weblog WHERE start_time &gt;= ? AND start_time &lt;?")<span class="hljs-comment">;</span>
        List&lt;Object&gt; <span class="hljs-attr">paras</span> = new ArrayList&lt;Object&gt;()<span class="hljs-comment">;</span>
        paras.add(0, end_time)<span class="hljs-comment">;</span>
        paras.add(0, start_time)<span class="hljs-comment">;</span>
        Weblog <span class="hljs-attr">weblog</span> =(Weblog)weblogDao.getDao().findFirst(sql.toString(), paras.toArray())<span class="hljs-comment">;</span>
        return weblog.getInt("visit_count")<span class="hljs-comment">;</span>
	}
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<p>这种场景下，<strong>JDBC 驱动会主动进行时区转换</strong>，保证时间一致性，流程如下：</p>
<ol>
<li>Java 客户端将 <code>Date</code> 类型的时间对象传递给 JDBC 驱动（日期类型本身是「时间戳（long 型，从 1970-01-01 00:00:00 UTC 开始的毫秒数）」，与时区无关，是绝对时间）；</li>
<li>JDBC 驱动接收到这个时间戳后，会读取 URL 中的 <code>serverTimezone=UTC</code> 配置，将时间戳<strong>从 JVM 默认时区（东八区）转换为 UTC 时区</strong>；</li>
<li>驱动将转换后的 UTC 时间，封装为 MySQL 服务器可识别的时间格式，发送给 MySQL 服务器；</li>
<li>简单说：日期类型参数会被驱动拦截，驱动基于 <code>serverTimezone=UTC</code> 完成「JVM 时区 ↔ 通信时区（UTC）」的转换，再与 MySQL 服务器交互。增加操作和查询操作都试用日期格式，驱动都会转换时间，所以用户没有在页面发现时间差问题。</li>
</ol>
<h3 data-id="heading-6">四、时区转换代码分析</h3>
<p>com.jfinal.plugin.activerecord.Model</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">/**
	 * Find first model. I recommend add "limit 1" in your sql.
	 * <span class="hljs-doctag">@param</span> sql an SQL statement that may contain one or more '?' IN parameter placeholders
	 * <span class="hljs-doctag">@param</span> paras the parameters of sql
	 * <span class="hljs-doctag">@return</span> <span class="hljs-variable">Model</span>
	 */</span>
	<span class="hljs-keyword">public</span> M <span class="hljs-title function_">findFirst</span>(<span class="hljs-params"><span class="hljs-built_in">String</span> sql, <span class="hljs-built_in">Object</span>... paras</span>) {
		<span class="hljs-title class_">List</span>&lt;M&gt; result = <span class="hljs-title function_">find</span>(sql, paras);
		<span class="hljs-keyword">return</span> result.<span class="hljs-title function_">size</span>() &gt; <span class="hljs-number">0</span> ? result.<span class="hljs-title function_">get</span>(<span class="hljs-number">0</span>) : <span class="hljs-literal">null</span>;
	}

<span class="hljs-comment">/**
	 * Find model.
	 * <span class="hljs-doctag">@param</span> sql an SQL statement that may contain one or more '?' IN parameter placeholders
	 * <span class="hljs-doctag">@param</span> paras the parameters of sql
	 * <span class="hljs-doctag">@return</span> the list of Model
	 */</span>
	<span class="hljs-keyword">public</span> <span class="hljs-title class_">List</span>&lt;M&gt; <span class="hljs-title function_">find</span>(<span class="hljs-params"><span class="hljs-built_in">String</span> sql, <span class="hljs-built_in">Object</span>... paras</span>) {
		<span class="hljs-keyword">return</span> <span class="hljs-title function_">find</span>(<span class="hljs-title function_">_getConfig</span>(), sql, paras);
	}
	
<span class="hljs-keyword">protected</span> <span class="hljs-title class_">List</span>&lt;M&gt; <span class="hljs-title function_">find</span>(<span class="hljs-params">Config config, <span class="hljs-built_in">String</span> sql, <span class="hljs-built_in">Object</span>... paras</span>) {
		<span class="hljs-title class_">Connection</span> conn = <span class="hljs-literal">null</span>;
		<span class="hljs-keyword">try</span> {
			conn = config.<span class="hljs-title function_">getConnection</span>();
			<span class="hljs-keyword">return</span> <span class="hljs-title function_">find</span>(config, conn, sql, paras);
		} <span class="hljs-keyword">catch</span> (<span class="hljs-title class_">Exception</span> e) {
			<span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ActiveRecordException</span>(e);
		} <span class="hljs-keyword">finally</span> {
			config.<span class="hljs-title function_">close</span>(conn);
		}
	}

<span class="hljs-comment">/**
	 * Find model.
	 * 
	 * 警告：传入的 Connection 参数需要由传入者在 try finally 块中自行
	 *      关闭掉，否则将出现 Connection 资源不能及时回收的问题
	 */</span>
	<span class="hljs-keyword">protected</span> <span class="hljs-title class_">List</span>&lt;M&gt; <span class="hljs-title function_">find</span>(<span class="hljs-title class_">Config</span> config, <span class="hljs-title class_">Connection</span> conn, <span class="hljs-title class_">String</span> sql, <span class="hljs-title class_">Object</span>... paras) throws <span class="hljs-title class_">Exception</span> {
		<span class="hljs-keyword">try</span> (<span class="hljs-title class_">PreparedStatement</span> pst = conn.<span class="hljs-title function_">prepareStatement</span>(sql)) {
			config.<span class="hljs-property">dialect</span>.<span class="hljs-title function_">fillStatement</span>(pst, paras);
			<span class="hljs-title class_">ResultSet</span> rs = pst.<span class="hljs-title function_">executeQuery</span>();
			<span class="hljs-title class_">List</span>&lt;M&gt; result = config.<span class="hljs-property">dialect</span>.<span class="hljs-title function_">buildModelList</span>(rs, <span class="hljs-title function_">_getUsefulClass</span>());	<span class="hljs-comment">// ModelBuilder.build(rs, getUsefulClass());</span>
			<span class="hljs-title class_">DbKit</span>.<span class="hljs-title function_">close</span>(rs);
			<span class="hljs-keyword">return</span> result;
		}
	}
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<p>com.jfinal.plugin.activerecord.dialect.fillStatement</p>
<pre><code class="hljs language-css" lang="css">public void fillStatement(PreparedStatement pst, <span class="hljs-selector-tag">Object</span>... paras) throws SQLException {
		for (int <span class="hljs-selector-tag">i</span>=<span class="hljs-number">0</span>; <span class="hljs-selector-tag">i</span>&lt;paras<span class="hljs-selector-class">.length</span>; <span class="hljs-selector-tag">i</span>++) {
			pst<span class="hljs-selector-class">.setObject</span>(<span class="hljs-selector-tag">i</span> + <span class="hljs-number">1</span>, paras<span class="hljs-selector-attr">[i]</span>);
		}
	}
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<p>com.alibaba.druid.pool.DruidPooledPreparedStatement</p>
<pre><code class="hljs language-java" lang="java"> <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setObject</span><span class="hljs-params">(<span class="hljs-type">int</span> parameterIndex, Object x)</span> <span class="hljs-keyword">throws</span> SQLException {
        checkOpen();

        <span class="hljs-keyword">try</span> {
            stmt.setObject(parameterIndex, x);
        } <span class="hljs-keyword">catch</span> (Throwable t) {
            <span class="hljs-keyword">throw</span> checkException(t);
        }
    }
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<p>com.alibaba.druid.proxy.jdbc.PreparedStatementProxyImpl</p>
<pre><code class="hljs language-java" lang="java"> <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setObject</span><span class="hljs-params">(<span class="hljs-type">int</span> parameterIndex, Object x)</span> <span class="hljs-keyword">throws</span> SQLException {
        setObjectParameter(parameterIndex, x);

        createChain().preparedStatement_setObject(<span class="hljs-built_in">this</span>, parameterIndex, x);
    }
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<p>FilterChainImpl</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">preparedStatement_setObject</span><span class="hljs-params">(PreparedStatementProxy statement, <span class="hljs-type">int</span> parameterIndex, Object x)</span>
                                                                                                           <span class="hljs-keyword">throws</span> SQLException {
        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.pos &lt; filterSize) {
            nextFilter().preparedStatement_setObject(<span class="hljs-built_in">this</span>, statement, parameterIndex, x);
            <span class="hljs-keyword">return</span>;
        }
        statement.getRawObject().setObject(parameterIndex, x);
    }
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<p>com.mysql.cj.jdbc.ClientPreparedStatement</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setObject</span><span class="hljs-params">(<span class="hljs-type">int</span> parameterIndex, Object parameterObj)</span> <span class="hljs-keyword">throws</span> SQLException {
        <span class="hljs-keyword">synchronized</span> (checkClosed().getConnectionMutex()) {
            ((PreparedQuery&lt;?&gt;) <span class="hljs-built_in">this</span>.query).getQueryBindings().setObject(getCoreParameterIndex(parameterIndex), parameterObj);
        }
    }
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<p>com.mysql.cj.AbstractQueryBindings</p>
<pre><code class="hljs language-scss" lang="scss">  <span class="hljs-keyword">@Override</span>
    public void setObject(int parameterIndex, Object parameterObj) {
        if (parameterObj == null) {
            <span class="hljs-built_in">setNull</span>(parameterIndex);
        } else {
            if (parameterObj instanceof Byte) {
                <span class="hljs-built_in">setInt</span>(parameterIndex, ((Byte) parameterObj)<span class="hljs-selector-class">.intValue</span>());

            } else if (parameterObj instanceof String) {
                <span class="hljs-built_in">setString</span>(parameterIndex, (String) parameterObj);

            } else if (parameterObj instanceof BigDecimal) {
                <span class="hljs-built_in">setBigDecimal</span>(parameterIndex, (BigDecimal) parameterObj);

            } else if (parameterObj instanceof Short) {
                <span class="hljs-built_in">setShort</span>(parameterIndex, ((Short) parameterObj)<span class="hljs-selector-class">.shortValue</span>());

            } else if (parameterObj instanceof Integer) {
                <span class="hljs-built_in">setInt</span>(parameterIndex, ((Integer) parameterObj)<span class="hljs-selector-class">.intValue</span>());

            } else if (parameterObj instanceof Long) {
                <span class="hljs-built_in">setLong</span>(parameterIndex, ((Long) parameterObj)<span class="hljs-selector-class">.longValue</span>());

            } else if (parameterObj instanceof Float) {
                <span class="hljs-built_in">setFloat</span>(parameterIndex, ((Float) parameterObj)<span class="hljs-selector-class">.floatValue</span>());

            } else if (parameterObj instanceof Double) {
                <span class="hljs-built_in">setDouble</span>(parameterIndex, ((Double) parameterObj)<span class="hljs-selector-class">.doubleValue</span>());

            } else if (parameterObj instanceof byte[]) {
                <span class="hljs-built_in">setBytes</span>(parameterIndex, (byte[]) parameterObj);

            } else if (parameterObj instanceof java.sql.Date) {
                <span class="hljs-built_in">setDate</span>(parameterIndex, (java.sql.Date) parameterObj);

            } else if (parameterObj instanceof Time) {
                <span class="hljs-built_in">setTime</span>(parameterIndex, (Time) parameterObj);

            } else if (parameterObj instanceof Timestamp) {
                <span class="hljs-built_in">setTimestamp</span>(parameterIndex, (Timestamp) parameterObj);

            } else if (parameterObj instanceof Boolean) {
                <span class="hljs-built_in">setBoolean</span>(parameterIndex, ((Boolean) parameterObj)<span class="hljs-selector-class">.booleanValue</span>());

            } else if (parameterObj instanceof InputStream) {
                <span class="hljs-built_in">setBinaryStream</span>(parameterIndex, (InputStream) parameterObj, -<span class="hljs-number">1</span>);

            } else if (parameterObj instanceof java.sql.Blob) {
                <span class="hljs-built_in">setBlob</span>(parameterIndex, (java.sql.Blob) parameterObj);

            } else if (parameterObj instanceof java.sql.Clob) {
                <span class="hljs-built_in">setClob</span>(parameterIndex, (java.sql.Clob) parameterObj);

            } else if (this.treatUtilDateAsTimestamp.getValue() &amp;&amp; parameterObj instanceof java<span class="hljs-selector-class">.util</span><span class="hljs-selector-class">.Date</span>) {
                <span class="hljs-built_in">setTimestamp</span>(parameterIndex, new Timestamp(((java.util.Date) parameterObj)<span class="hljs-selector-class">.getTime</span>()));

            } else if (parameterObj instanceof BigInteger) {
                <span class="hljs-built_in">setString</span>(parameterIndex, parameterObj.toString());

            } else if (parameterObj instanceof LocalDate) {
                <span class="hljs-built_in">setDate</span>(parameterIndex, Date.valueOf((LocalDate) parameterObj));

            } else if (parameterObj instanceof LocalDateTime) {
                <span class="hljs-built_in">setTimestamp</span>(parameterIndex, Timestamp.valueOf((LocalDateTime) parameterObj));

            } else if (parameterObj instanceof LocalTime) {
                <span class="hljs-built_in">setTime</span>(parameterIndex, Time.valueOf((LocalTime) parameterObj));

            } else {
                <span class="hljs-built_in">setSerializableObject</span>(parameterIndex, parameterObj);
            }
        }
    }
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<p>com.mysql.cj.ClientPreparedQueryBindings</p>
<pre><code class="hljs language-kotlin" lang="kotlin"> <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> void setTimestamp(int parameterIndex, Timestamp x) {
        int fractLen = -<span class="hljs-number">1</span>;
        <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.sendFractionalSeconds.getValue() || !<span class="hljs-keyword">this</span>.session.getServerSession().getCapabilities().serverSupportsFracSecs()) {
            fractLen = <span class="hljs-number">0</span>;
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.columnDefinition != <span class="hljs-literal">null</span> &amp;&amp; parameterIndex &lt;= <span class="hljs-keyword">this</span>.columnDefinition.getFields().length &amp;&amp; parameterIndex &gt;= <span class="hljs-number">0</span>) {
            fractLen = <span class="hljs-keyword">this</span>.columnDefinition.getFields()[parameterIndex].getDecimals();
        }

        setTimestamp(parameterIndex, x, <span class="hljs-literal">null</span>, fractLen);
    }
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<p>com.mysql.cj.ClientPreparedQueryBindings</p>
<pre><code class="hljs language-ini" lang="ini"> @Override
    public void setTimestamp(int parameterIndex, Timestamp x, Calendar targetCalendar, int fractionalLength) {
        if (<span class="hljs-attr">x</span> == null) {
            setNull(parameterIndex)<span class="hljs-comment">;</span>
        } else {

            <span class="hljs-attr">x</span> = (Timestamp) x.clone()<span class="hljs-comment">;</span>

            if (!this.session.getServerSession().getCapabilities().serverSupportsFracSecs()
                    || !this.sendFractionalSeconds.getValue() &amp;&amp; <span class="hljs-attr">fractionalLength</span> == <span class="hljs-number">0</span>) {
                <span class="hljs-attr">x</span> = TimeUtil.truncateFractionalSeconds(x)<span class="hljs-comment">;</span>
            }

            if (fractionalLength &lt; 0) {
                // default to 6 fractional positions
                <span class="hljs-attr">fractionalLength</span> = <span class="hljs-number">6</span><span class="hljs-comment">;</span>
            }

            <span class="hljs-attr">x</span> = TimeUtil.adjustTimestampNanosPrecision(x, fractionalLength, !this.session.getServerSession().isServerTruncatesFracSecs())<span class="hljs-comment">;</span>

            <span class="hljs-attr">this.tsdf</span> = TimeUtil.getSimpleDateFormat(this.tsdf, <span class="hljs-string">"''yyyy-MM-dd HH:mm:ss"</span>, targetCalendar,
                    targetCalendar != null ? null : this.session.getServerSession().getDefaultTimeZone())<span class="hljs-comment">;</span>

            StringBuffer <span class="hljs-attr">buf</span> = new StringBuffer()<span class="hljs-comment">;</span>
            buf.append(this.tsdf.format(x))<span class="hljs-comment">;</span>
            if (this.session.getServerSession().getCapabilities().serverSupportsFracSecs()) {
                buf.append('.')<span class="hljs-comment">;</span>
                buf.append(TimeUtil.formatNanos(x.getNanos(), 6))<span class="hljs-comment">;</span>
            }
            buf.append(''')<span class="hljs-comment">;</span>

            setValue(parameterIndex, buf.toString(), MysqlType.TIMESTAMP)<span class="hljs-comment">;</span>
        }
    }
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<p><code>this.session.getServerSession().getDefaultTimeZone()</code>—— 这个时区就是你 JDBC URL 中<code>serverTimezone=UTC</code>配置的时区！</p>
<p><strong>驱动会基于<code>serverTimezone</code>配置的时区，对<code>Timestamp</code>进行格式化，完成了「JVM 默认时区 → serverTimezone 配置时区」的转换</strong>，这就是为什么传入<code>Date/Timestamp</code>类型参数不会有 8 小时偏差的底层原因。</p>
<p>关键区别：这里的字符串是<strong>驱动经过时区转换后生成的</strong>，和你手动传入的原始字符串（如 "2025-12-29 16:00:00"）有本质不同 —— 前者带时区适配，后者是裸传无处理。</p>
<h3 data-id="heading-7">五、总结</h3>
<p>本文围绕操作系统、MySQL 5.7、JVM 时区查看方法及Java程序时区偏差问题展开，核心结论如下。三者时区查看各有路径：操作系统需按Windows等系统类型执行对应命令，核心获取默认时区（如东八区CST）；MySQL需区分全局与会话时区，通过SQL查询验证，默认多跟随系统时区（东八区），也可能直接使用UTC；JVM可通过代码获取默认时区（如Asia/Shanghai），适配Java 8+新方式。</p>
<p>JDBC连接URL中serverTimezone=UTC仅作用于驱动层，负责程序与MySQL通信时的时区转换，不改变各端本身时区，转换逻辑由MySQL JDBC驱动包实现，与业务代码、MySQL服务器无直接关联。</p>
<p>代码场景中，时间参数类型决定是否出现时区偏差：字符串类型为裸传，驱动不处理，MySQL按自身时区解析，与驱动配置脱节，易产生8小时偏移；Date/Timestamp类型为时间戳（绝对时间），驱动基于serverTimezone=UTC完成JVM时区到UTC的转换，MySQL再反向解析，抵消时差无偏差。</p>
<p>底层原理上，驱动通过AbstractQueryBindings类判断参数类型，对Date/Timestamp调用setTimestamp方法，基于serverTimezone配置格式化时间，实现时区适配，这是两种参数类型处理差异的核心原因。综上，避免时区偏差需优先使用Date/Timestamp类型参数，确保驱动层时区转换生效。</p>
<p>​</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[还不知道线程池如何使用？看懂这篇就可以创建合理稳定的线程池]]></title>    <link>https://juejin.cn/post/7594578555352252467</link>    <guid>https://juejin.cn/post/7594578555352252467</guid>    <pubDate>2026-01-13T08:45:40.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7594578555352252467" data-draft-id="7594578555352203315" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="还不知道线程池如何使用？看懂这篇就可以创建合理稳定的线程池"/> <meta itemprop="keywords" content="后端,架构"/> <meta itemprop="datePublished" content="2026-01-13T08:45:40.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="CV工程师的自我修养"/> <meta itemprop="url" content="https://juejin.cn/user/1039488093258619"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            还不知道线程池如何使用？看懂这篇就可以创建合理稳定的线程池
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1039488093258619/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    CV工程师的自我修养
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-13T08:45:40.000Z" title="Tue Jan 13 2026 08:45:40 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读10分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>大家好，我是一名CV工程师。</p>
<p>相信大家在开发中不可避免的会用到Java线程池。但是大多数人在使用线程池的都是在网上找个demo直接复制过来就使用。对于线程池的参数不知道如何设定，甚至有些<code>Executors</code>工厂类提供的线程池创建方法都不太了解。</p>
<p>导致线程池在出现问题或者报错的时候都不知道问题出现的原因，更别说下手解决。或者凑巧线程池可以正常工作，但是也为后面的代码性能以及服务器性能都带来无穷的隐患。</p>
<p>这篇文章就为大家详细讲解下：<code>Executors</code>工厂类提供了哪些创建线程池的方法以及这些方法的作用和线程池的工作原理以及我们在实际项目中如何合理的自定义线程池参数。</p>
<h3 data-id="heading-0"><strong>Executors工厂类提供的线程池</strong></h3>
<h4 data-id="heading-1">1. <strong>FixdThreadPool(固定大小线程池)</strong></h4>
<ul>
<li>创建方式</li>
</ul>

<pre><code class="hljs language-java" lang="java"><span class="hljs-type">ExecutorService</span> <span class="hljs-variable">executor</span> <span class="hljs-operator">=</span> Executors.newFixedThreadPool(<span class="hljs-number">5</span>); <span class="hljs-comment">// 核心线程数=最大线程数</span>

<span class="hljs-comment">//内部实现</span>
<span class="hljs-keyword">new</span> <span class="hljs-title class_">ThreadPoolExecutor</span>(nThreads, nThreads,
                                      <span class="hljs-number">0L</span>, TimeUnit.MILLISECONDS,
                                      <span class="hljs-keyword">new</span> <span class="hljs-title class_">LinkedBlockingQueue</span>&lt;Runnable&gt;());
</code></pre>
<ul>
<li>适用场景</li>
</ul>

<ul>
<li>
<ul>
<li>任务量稳定且执行时间短的场景(如Http请求处理、批量数据处理)。</li>
<li>需要限制并发线程数以避免资源耗尽。</li>
</ul>
</li>
</ul>

<ul>
<li>代码示例</li>
</ul>

<pre><code class="hljs language-ini" lang="ini">ExecutorService <span class="hljs-attr">executor</span> = Executors.newFixedThreadPool(<span class="hljs-number">5</span>)<span class="hljs-comment">;</span>
for (int <span class="hljs-attr">i</span> = <span class="hljs-number">0</span><span class="hljs-comment">; i &lt; 10; i++) {</span>
    executor.execute(() -&gt; {
        // do something
        System.out.println(Thread.currentThread().getName() + " 执行任务")<span class="hljs-comment">;</span>
    })<span class="hljs-comment">;</span>
}
executor.shutdown()<span class="hljs-comment">;</span>
</code></pre>
<h4 data-id="heading-2">2. <strong>CachedThreadPool(弹性线程池)</strong></h4>
<ul>
<li>创建方式</li>
</ul>

<pre><code class="hljs language-ini" lang="ini">ExecutorService <span class="hljs-attr">executor</span> = Executors.newCachedThreadPool()<span class="hljs-comment">;</span>

//内部实现
new ThreadPoolExecutor(0, Integer.MAX_VALUE,
                        60L, TimeUnit.SECONDS,
                        new SynchronousQueue&lt;Runnable&gt;())<span class="hljs-comment">;</span>
</code></pre>
<ul>
<li>适用场景</li>
</ul>

<ul>
<li>
<ul>
<li>大量短期异步任务(如日志记录、临时请求处理)。</li>
<li>任务数量波动大且线程空闲时间较短。</li>
</ul>
</li>
</ul>

<ul>
<li>代码示例</li>
</ul>

<pre><code class="hljs language-ini" lang="ini">ExecutorService <span class="hljs-attr">executor</span> = Executors.newCachedThreadPool()<span class="hljs-comment">;</span>
executor.submit(() -&gt; {
    // 执行IO密集型任务（如文件下载）
    //do something
})<span class="hljs-comment">;</span>
executor.shutdown()<span class="hljs-comment">;</span>
</code></pre>
<h4 data-id="heading-3">3. <strong>SingleThreadExecutor(单线程池)</strong></h4>
<ul>
<li>创建方式</li>
</ul>

<pre><code class="hljs language-ini" lang="ini">ExecutorService <span class="hljs-attr">executor</span> = Executors.newSingleThreadExecutor()<span class="hljs-comment">;</span>
</code></pre>
<ul>
<li>适用场景</li>
</ul>

<ul>
<li>
<ul>
<li>需要任务顺序执行的场景(如订单状态机、数据库事务队列)。</li>
<li>避免并发问题(如共享资源操作)。</li>
</ul>
</li>
</ul>

<ul>
<li>代码示例</li>
</ul>

<pre><code class="hljs language-scss" lang="scss">ExecutorService executor = Executors<span class="hljs-selector-class">.newSingleThreadExecutor</span>();
executor<span class="hljs-selector-class">.execute</span>(() -&gt; System<span class="hljs-selector-class">.out</span><span class="hljs-selector-class">.println</span>("任务<span class="hljs-number">1</span>"));
executor<span class="hljs-selector-class">.execute</span>(() -&gt; System<span class="hljs-selector-class">.out</span><span class="hljs-selector-class">.println</span>("任务<span class="hljs-number">2</span>")); <span class="hljs-comment">// 按提交顺序执行</span>
executor<span class="hljs-selector-class">.shutdown</span>();
</code></pre>
<h4 data-id="heading-4">4. <strong>ScheduledThreadPool(定时任务线程池)</strong></h4>
<ul>
<li><strong>创建方式</strong></li>
</ul>

<pre><code class="hljs language-ini" lang="ini">ScheduledExecutorService <span class="hljs-attr">executor</span> = Executors.newScheduledThreadPool(<span class="hljs-number">2</span>)<span class="hljs-comment">;</span>
</code></pre>
<ul>
<li><strong>适用场景</strong></li>
</ul>

<ul>
<li>
<ul>
<li>需要任务顺序执行的场景(如订单状态机、数据库事务队列)。</li>
<li>避免并发问题(如共享资源操作)。</li>
</ul>
</li>
</ul>

<ul>
<li><strong>代码示例</strong></li>
</ul>

<pre><code class="hljs language-ini" lang="ini">ScheduledExecutorService <span class="hljs-attr">executor</span> = Executors.newScheduledThreadPool(<span class="hljs-number">2</span>)<span class="hljs-comment">;</span>
// 延迟1秒后执行，每隔2秒重复执行
executor.scheduleAtFixedRate(() -&gt; 
    System.out.println("定时任务"), 1, 2, TimeUnit.SECONDS)<span class="hljs-comment">;</span>
</code></pre>
<h4 data-id="heading-5">5. <strong>手动配置ThreadPoolExecutor</strong></h4>
<ul>
<li><strong>创建方式</strong></li>
</ul>
<p>通过自定义参数实现更精细的控制:</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-type">ThreadPoolExecutor</span> <span class="hljs-variable">executor</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ThreadPoolExecutor</span>(
    <span class="hljs-number">5</span>,  <span class="hljs-comment">// (corePoolSize)核心线程数，线程池中用来工作的核心的线程数量</span>
    <span class="hljs-number">10</span>, <span class="hljs-comment">// (maximumPoolSize)最大线程数，线程池允许创建的最大线程数</span>
    <span class="hljs-number">60</span>, <span class="hljs-comment">// (keepAliveTime)空闲线程(最大线程数-核心线程数)存活时间</span>
    TimeUnit.SECONDS,<span class="hljs-comment">//keepAliveTime的时间单位</span>
    <span class="hljs-keyword">new</span> <span class="hljs-title class_">LinkedBlockingQueue</span>&lt;&gt;(<span class="hljs-number">100</span>), <span class="hljs-comment">// 任务队列，是一个阻塞队列，当线程数已达到核心线程数，会将任务存储在阻塞队列中。</span>
    Executors.defaultThreadFactory(), <span class="hljs-comment">// 线程工厂，线程池内部创建线程所用的工厂。</span>
    <span class="hljs-keyword">new</span> <span class="hljs-title class_">ThreadPoolExecutor</span>.AbortPolicy() <span class="hljs-comment">// 拒绝策略，当队列已满并且线程数量达到最大线程数量时，会调用该方法处理该任务。</span>
);
</code></pre>
<ul>
<li><strong>适用场景</strong></li>
</ul>

<ul>
<li>
<ul>
<li>需要自定义线程池参数(如队列容量、拒绝策略)。</li>
<li>高并发且任务类型复杂(如混合型任务)。</li>
</ul>
</li>
</ul>

<ul>
<li><strong>参数详解</strong></li>
</ul>

<ul>
<li>
<ul>
<li><strong>核心线程数：长期存活线程数量。</strong></li>
<li><strong>最大线程数：队列满时允许创建的最大线程数。</strong></li>
<li><strong>拒绝策略：</strong></li>
</ul>
</li>
</ul>

<ul>
<li>
<ul>
<li>
<ul>
<li><strong>AbortPolicy：默认策略，直接抛出异常。</strong></li>
<li><strong>CallerRunsPolicy：由提交任务的线程执行任务。</strong></li>
<li><strong>DiscardOldestPolicy：丢弃队列中最旧的任务。</strong></li>
<li><strong>DiscardPolicy：静默丢弃新任务。</strong></li>
</ul>
</li>
</ul>
</li>
</ul>

<ul>
<li><strong>代码示例</strong></li>
</ul>

<pre><code class="hljs language-ini" lang="ini">ThreadPoolExecutor <span class="hljs-attr">executor</span> = new ThreadPoolExecutor(<span class="hljs-number">5</span>, <span class="hljs-number">10</span>, <span class="hljs-number">60</span>, TimeUnit.SECONDS, 
    new ArrayBlockingQueue&lt;&gt;(100))<span class="hljs-comment">;</span>
executor.execute(() -&gt; {
    // 执行计算密集型任务（如数据分析）
})<span class="hljs-comment">;</span>
executor.shutdown()<span class="hljs-comment">;</span>
</code></pre>
<h3 data-id="heading-6"><strong>适用场景总结</strong></h3>



































<table><thead><tr><th><strong>线程池类型</strong></th><th><strong>适用场景</strong></th><th><strong>关键特性</strong></th></tr></thead><tbody><tr><td>FixedThreadPool</td><td>固定并发量、短期任务（如Web服务器请求）</td><td>线程数固定，队列无界</td></tr><tr><td>CachedThreadPool</td><td>突发性短期任务（如日志处理）</td><td>线程数弹性，自动回收空闲线程</td></tr><tr><td>SingleThreadExecutor</td><td>需顺序执行的任务（如单线程事务处理）</td><td>单线程串行执行</td></tr><tr><td>ScheduledThreadPool</td><td>定时或周期性任务（如缓存刷新、监控报警）</td><td>支持延迟和周期性任务</td></tr><tr><td>自定义ThreadPoolExecutor</td><td>复杂场景（如混合型任务、需精细控制参数）</td><td>可调队列容量、拒绝策略、线程生命周期管理</td></tr></tbody></table>
<h3 data-id="heading-7"><strong>线程池运行过程</strong></h3>
<ol>
<li>线程池运行流程图</li>
</ol>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0d0517f0169f43ddb47decdc001af0d0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ1blt6XnqIvluIjnmoToh6rmiJHkv67lhbs=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768898997&amp;x-signature=5p352CpISZ8IW13v2JfVgjsX6PM%3D" alt="" loading="lazy"/></p>
<ol start="2">
<li>线程池刚创建出来的样子</li>
</ol>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/acca26f0eb5146eca098d02641c4d041~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ1blt6XnqIvluIjnmoToh6rmiJHkv67lhbs=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768898997&amp;x-signature=V5PU5jx%2FS3yUMYfaHx7AmAv1T6s%3D" alt="" loading="lazy"/></p>
<p>刚创建出来的线程池只有一个队列实例，此时并没有任何线程，但是如果你想要在提交任务之前创建好核心线程数，可以调用prestartAllCoreThreads方法实现，默认是没有线程的。</p>
<ol start="3">
<li>当主线程通过execute方法提交了一个任务。</li>
</ol>
<p>首先会去判断当前线程池的线程数是否小于核心线程数，也就是线程池构造时传入的参数corePoolSize。</p>
<p>如果小于，那么就直接通过ThreadFactory创建一个线程来执行这个任务，如图</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0dd46c79538a47388f88a8aa14954864~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ1blt6XnqIvluIjnmoToh6rmiJHkv67lhbs=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768898997&amp;x-signature=Bm9WpGJi%2FhD2WJBWCvMQgGxVsB8%3D" alt="" loading="lazy"/></p>
<p>当任务执行完之后，线程不会退出，而是会从阻塞队列中获取任务，如图：<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c2662ae0d183443db979fd152e301697~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ1blt6XnqIvluIjnmoToh6rmiJHkv67lhbs=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768898997&amp;x-signature=wdzZR3dCVdnbkna3W6m3%2FFQ%2FcJ8%3D" alt="" loading="lazy"/></p>
<p>接下来如果又提交了一个任务，也会按照上述步骤，去判断是否小于核心线程数，如果小于，还是会创建线程来执行任务，执行完之后也会从阻塞队列中获取任务。这里有个细节，就是提交任务的时候，就算有线程池里的线程凑够阻塞队列中获取不到任务(意思就是有空闲线程)，如果线程池里的线程数还是小于核心线程数，那么依然会继续创建线程，而不是复用已有的线程。</p>
<p>如果线程池里的线程数不在小于核心线程数呢？那么此时就会尝试将任务放入阻塞队列中，入队成功之后，如图：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/097456c9ddd04a34864b8bfc5fcadbbe~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ1blt6XnqIvluIjnmoToh6rmiJHkv67lhbs=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768898997&amp;x-signature=tO4bbBMp0CvbUvVPc4BAflzj6KY%3D" alt="" loading="lazy"/></p>
<p>这样在阻塞的线程就可以获取到任务了。</p>
<p>但是，随着任务越来越多，队列已经满了，任务就放入失败了。此时就会判断当前线程池里的线程数是否小于最大线程数，也就是创建线程池的时候的maximumPoolSize参数。</p>
<p>如果小于最大线程数，那么也会创建非核心线程来执行提交的任务，如图：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e0570302f4f44c7896c1775a35689ab8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ1blt6XnqIvluIjnmoToh6rmiJHkv67lhbs=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768898997&amp;x-signature=RCyC16ea4bY4ZUCVqj3ILv47J7Q%3D" alt="" loading="lazy"/></p>
<p>所以，就算队列中有任务，新创建的线程还是优先处理这个提交的任务，而不是从队列中获取已有得到任务执行，从这可以看出，先提交的任务不一定先执行。</p>
<p>如果线程数已经达到了最大线程数量，此时就会执行拒绝策略，也就是创建线程池的时候，传入的参数RejectedExecutionHandler对象。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3ca70908039245d8a9bec12758fa37fc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ1blt6XnqIvluIjnmoToh6rmiJHkv67lhbs=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768898997&amp;x-signature=mUhlXiy0nd7VKlrvewgrceGpKTI%3D" alt="" loading="lazy"/></p>
<p>execute方法代码是如何实现的</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/668a2c86411542969d9b39b2eddf351e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ1blt6XnqIvluIjnmoToh6rmiJHkv67lhbs=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768898997&amp;x-signature=i5m5u5NppweYnRc5orxNhXOIbrY%3D" alt="" loading="lazy"/></p>
<ul>
<li>
<ul>
<li>workerCountOf(c)&lt;corePoolSize:这行代码就是判断是否小于核心线程数，是的话就通过addWorker方法，addWorker就是添加线程来执行任务。</li>
<li>workQueue.offer(command)：这行代码就表示尝试往阻塞队列中添加任务</li>
<li>添加失败之后就会再次调用addWorker方法尝试添加非核心线程来执行任务</li>
<li>如果还是添加非核心线程失败了，那么就会调用reject(command)来拒绝这个任务。</li>
</ul>
</li>
</ul>
<p>execute执行流程</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9f3e5fee69b84e568fab731cf9f29fe4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ1blt6XnqIvluIjnmoToh6rmiJHkv67lhbs=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768898997&amp;x-signature=cT5F24%2FdFmxMSuTdIzepPw9ukaw%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-8">实际项目中如何合理的自定义线程池</h3>
<ol>
<li>核心线程数</li>
</ol>
<p>线程数的设置主要取决于业务时I/O密集型还是CPU密集型。</p>
<p>CPU密集型是指任务主要使用来进行大量的计算，没有什么导致线程阻塞。一般这种场景的线程数设置为CPU核心数+1；</p>
<p>IO密集型，当执行任务需要大量的IO，比如磁盘IO，网络IO，可能会存在大量的阻塞，所以在IO密集型任务中使用多线程可以大大地加速任务的处理。一般线程数设置为 2*CPU核心数。</p>
<p>Java中用来获取CPU核心数的方法是：</p>
<pre><code class="hljs language-scss" lang="scss">Runtime<span class="hljs-selector-class">.getRuntime</span>()<span class="hljs-selector-class">.availableProcessors</span>();
</code></pre>
<p>2.  线程工厂</p>
<p>一般建议自定义线程工厂，构建线程的时候设置线程的名称，这样就在查日志的时候就方便知道是哪个线程执行的代码。</p>
<ol start="3">
<li>有界队列</li>
</ol>
<p>一般需要设置有界队列的大小，比如LinkedBlockingQueue在构造的时候就可以传入参数，来限制队列中任务数据的大小，这样就不会因为无限往队列中扔任务导致系统的oom。</p>
<h3 data-id="heading-9">任务队列类型与特性</h3>
<h4 data-id="heading-10">类型</h4>
<h5 data-id="heading-11">一、SynchronousQueue(同步有界队列)</h5>
<ul>
<li>
<ul>
<li><strong>特性：</strong> 不存储任何元素，每个插入操作必须等待另一个线程执行一处操作，否则回阻塞。</li>
<li><strong>作用：</strong> 强制线程池直接创建新线程处理任务，而非缓冲任务。</li>
<li><strong>使用场景：</strong> 适用于高吞吐量、短任务频繁的场景(如缓存型线程池 CachedThreadPool)。</li>
<li><strong>注意事项：</strong> 需设置较大的maximumPoolSize,否则容易触发拒策略。</li>
</ul>
</li>
</ul>
<h5 data-id="heading-12">二、ArrayBlockingQueue(有界队列)</h5>
<ul>
<li>
<ul>
<li><strong>特性：</strong> 基于数组的固定容量队列，按FIFO（先进先出）原则顺序。</li>
<li><strong>作用：</strong> 限制任务队列长度，防止资源耗尽，强制在队列满时触发非核心线程创建。</li>
<li><strong>使用场景：</strong> 适用于负载较重且需严格控制内存的服务器。</li>
<li><strong>使用建议：</strong> 需平衡corePoolSize、maximumPoolSize 和队列容量，避免频繁触发拒绝策略。</li>
</ul>
</li>
</ul>
<h5 data-id="heading-13">三、<strong>LinkedBlockingQueue（无界/有界队列）</strong></h5>
<ul>
<li>
<ul>
<li><strong>特性：</strong> 基于链表的队列，默认无界(容量为 Integer.MAX_VALUE)，也可以设置为有界。</li>
<li><strong>作用：</strong> 优先缓冲任务，仅在核心线程繁忙时将任务加入队列。</li>
<li><strong>使用场景：</strong></li>
</ul>
</li>
</ul>

<ul>
<li>
<ul>
<li>
<ul>
<li><strong>无界模式：</strong> 适用于任务量波动大且允许内存增长的场景(如 FixedThreadPool)。</li>
<li><strong>有界模式：</strong> 需手动设置容量，类似ArrayBlockingQueue但吞吐量更高。</li>
</ul>
</li>
</ul>
</li>
</ul>

<ul>
<li>
<ul>
<li><strong>风险提示：</strong> 无界队列可能导致内存溢出(OOM)，需谨慎使用。</li>
</ul>
</li>
</ul>
<h5 data-id="heading-14">四、<strong>PriorityBlockingQueue（优先级队列）</strong></h5>
<ul>
<li>
<ul>
<li><strong>特性：</strong> 无界队列，支持按任务优先级排序(需实现Comparable接口)</li>
<li><strong>作用：</strong> 确保优先级高的任务优先执行，适用于任务有明确优先级的场景。</li>
<li><strong>使用场景：</strong> 实时任务调度（如支付系统中的紧急交易处理）。</li>
<li><strong>示例：</strong></li>
</ul>
</li>
</ul>

<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-comment">// 自定义任务优先级</span>
BlockingQueue&lt;Runnable&gt; queue = <span class="hljs-keyword">new</span> PriorityBlockingQueue&lt;&gt;(<span class="hljs-number">11</span>, Comparator.<span class="hljs-built_in">comparingInt</span>(<span class="hljs-built_in">Task</span>::getPriority));
<span class="hljs-keyword">new</span> <span class="hljs-built_in">ThreadPoolExecutor</span>(<span class="hljs-number">5</span>, <span class="hljs-number">10</span>, <span class="hljs-number">60L</span>, TimeUnit.SECONDS, queue);
</code></pre>
<h4 data-id="heading-15">任务队列选择与线程池行为的关系</h4>
<p>线程池的任务处理流程由队列类型和线程数参数共同决定：</p>
<ol>
<li><strong>核心线程未满</strong>：直接创建线程执行任务。</li>
<li><strong>核心线程已满</strong>：</li>
</ol>
<ul>
<li>
<ul>
<li><strong>SynchronousQueue</strong>：直接创建非核心线程，直至达到 <code>maximumPoolSize</code>。</li>
<li><strong>有界队列（Array/Linked）</strong> ：任务入队，队列满时创建非核心线程****。</li>
<li><strong>无界队列（LinkedBlockingQueue）</strong> ：任务无限入队，不会触发非核心线程创建****。</li>
</ul>
</li>
</ul>
<ol start="3">
<li><strong>队列与线程均满</strong>：触发拒绝策略（如 <code>AbortPolicy</code> 抛异常或 <code>CallerRunsPolicy</code> 由提交线程执行）。</li>
</ol>
<h4 data-id="heading-16"><strong>典型应用场景推荐</strong></h4>

























<table><thead><tr><th><strong>队列类型</strong></th><th><strong>适用场景</strong></th></tr></thead><tbody><tr><td>SynchronousQueue</td><td>高并发短任务（如实时API请求）或需快速响应的缓存型线程池</td></tr><tr><td>ArrayBlockingQueue</td><td>资源受限的稳定负载系统（如数据库连接池）</td></tr><tr><td>LinkedBlockingQueue</td><td>批处理任务（如日志异步写入）或需平滑处理流量峰谷的场景</td></tr><tr><td>PriorityBlockingQueue</td><td>任务需分级处理（如电商秒杀系统中的VIP优先下单）</td></tr></tbody></table>
<h4 data-id="heading-17"><strong>调优建议</strong></h4>
<ol>
<li><strong>避免无界队列</strong>：防止内存溢出，可通过 <code>setMaximumPoolSize</code> 动态调整线程数****。</li>
<li><strong>监控队列堆积</strong>：使用 <code>getQueue().size()</code> 实时监控任务积压情况****。</li>
<li><strong>结合拒绝策略</strong>：队列满时，<code>CallerRunsPolicy</code> 可降低系统负载，但可能阻塞主线程****。</li>
</ol>
<blockquote>
<p>关注我，后续为大家带来线程池的各种提交任务的方式以及怎么选择。</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Ant Design 6.0 正式发布：从 V5 到 V6 有哪些变化？]]></title>    <link>https://juejin.cn/post/7594616268782338075</link>    <guid>https://juejin.cn/post/7594616268782338075</guid>    <pubDate>2026-01-13T09:37:22.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7594616268782338075" data-draft-id="7594578555352481843" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Ant Design 6.0 正式发布：从 V5 到 V6 有哪些变化？"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2026-01-13T09:37:22.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="狗头大军之江苏分军"/> <meta itemprop="url" content="https://juejin.cn/user/2955079655907879"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Ant Design 6.0 正式发布：从 V5 到 V6 有哪些变化？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2955079655907879/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    狗头大军之江苏分军
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-13T09:37:22.000Z" title="Tue Jan 13 2026 09:37:22 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    11
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body blockquote&gt;:first-child{margin-top:0}.markdown-body blockquote&gt;:last-child{margin-bottom:0}.markdown-body{overflow:hidden;line-height:1.75;font-size:15px;background-image:linear-gradient(90deg,rgba(72,42,10,.05) 5%,rgba(72,42,10,0) 0),linear-gradient(1turn,rgba(72,42,10,.05) 5%,rgba(72,42,10,0) 0);background-size:20px 20px;background-position:50%;padding-top:0!important}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{position:relative;display:flex;border-bottom:5px solid #6d4e00;line-height:35px;letter-spacing:1px;font-size:25px;padding-left:25px;color:#664900;text-shadow:1px 1px 1px #8a6200;padding-bottom:0}.markdown-body h1:before{content:"";display:flex;position:absolute;left:0;top:3px;bottom:0;margin:auto;width:20px;height:20px;background-size:20px 20px;background-image:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMgAAADICAMAAACahl6sAAAAQlBMVEVHcEwlRnqtZBj76q4lRnolRnolRnolRnolRnokRnr/gGtrVUeLXDBKTl+hYSHasW7Ik0zs0JG4dCvUdEE0SW+rYxrLQJfjAAAACnRSTlMA////0H/xUaMi5MCoTwAACfVJREFUeNrtnQl3qygUgJ9GXAqosfL//+pgmgXwXmRNJGdu55xO+6rx8+6I8O9fehmGriN93zdN07bVXdpW/ih/SbpuGP6dXbpOXv7z2i3S9ISck2eQOnAhMHG64VQQbmrAaM4B05GmipaGdB+m6BNQPBXzMYtKR3EPbB/RS5eY4g+lIW9WBqnySCvVMrzRpqqs0g9nwVg5p1KYlHEchRT5bftp+y3n6xlQDjAkABtrKULU9f377ev+4/1/NiT+URRiZRhrcZP6WLa/Gq005BORaqXsdYEuHPIP798ZxSyt6d5sVfxJESRCsvB32lfXwhRjnUBGmKXNoJQe04VIASJqRC/9G7yDsyQMiloYz+0pHYghEoPISAGgpDSvHsCoMwmA0mfjSG5UOsqah2RodkljzMkhZZdamiEDB8+Nsbk9T04yGNljDXGOZZ6u0+Tj9DuvbyNJBuPO0ABtLNPlJtfZJ4CNNCWJoY8gddwxNpm9YrHh9DEkBoeMud4Kma8XRZaYpBJOYvg59U9wOsblMvmGrzQe30dyqFZ1dxPfO0FT5BOdw989THVs4q1TFk+iN4PMu7CaLpd4EJOExNaJLE4d0xQKYpJ0cY5Ozcwwu6WOu2cs9TUYxPB4b4fvLRzTUXbT1HH7y0BnB0j6CAehkPFfFzd1TMsi6sU1/P4VM9NiISHBlYnBMR+kad075sXlmMehj1twnfTUqJH4GJfqIKte7S72emPnHbdiYHIB0e6ATjKq1UoTaFh6wBL2csMIVo9fH/v6QRHAgoxrOHQQxG/36tC1ODmGOeBGBRmXalgcdhDQ1xF1vI6a3DF2d4r7G1enOUgNOshlFq7qUCxrca9ldiCam7ilxRbP6JbOYsYtfLFmkcXEgLG1DN/6eroxHjqh5bh+Uw27e1oWVK7pN+AqwzUcq/UYTPw8nWufLFBHN2zcxLRYlmGPs6rA2Wy0uJe/E7TknbHIa1WH1bLA8DAj3JpxET+FCNCWZ5uNT6jxTPZK/1mXoCBeKlGLRT2lP69XN3XdqqCojKX1ZVda6iD2McjeXSHa0I+AHd2InGAJgjRVM6gOBfygDrarRJnho6eQBbrns+HkcNUCWtYClJa66qFgPbqqZEBTCOAgRqxCOhQBWpZeIC6QBq91hEoI5unTjsMsK9DCFigY9WNn19hgVCrELalrTw6WnYMYzjHhQ2/7G2xTx1HvwpzSe4cVi5ORQQwMW9+72FU5L4gGsa6Yu1RcDeIhs64Qs8izt0vGH+n9/IKaIlYpM2UqkYOrwwq5CgBjWpyGtxaonxe4KaJ3hx+7O0HaqVkxLBPj8FmBVmjNevIUFhUuDmMq5NDV9RwyPe/95IvxAhG7ymqxHGE5sZJL2kPLUhUinkXfrnFwGFwXD99djNLSFh/meXEb2B6Oyiwm0I7BC+OlTlOVPk9K8CIYzu5YHwKDTI6XAo5lz3WEqEXwQRKhh5cyLa6D81P4PXBw984as9YaGXHwx4Ba8rmOldUat/BHt9cQ38AaljnBdCJqs60OcXVDJZP//ZwSWtV9FpHNtgg22KuYx/U2tB5Mcp1TYOiphNhiFjgWeJ3DL2OZpuuUisIoUyzZEJ76I+LmyqWdv8LwnEiwMYczihjxeqtBsuFJSTg2oD1ETQx4v6D1VleSZW1xCwvAfVGWpQ069kgrQksAUW2rReYzsboIjSABuDQX0QJwB9cnZVgWVgE31vrklAJnEmVObykgYCk/VGX5OlpuKb5eiovUAvJ2tMstw0kIkNdpiSA91K6XA6K8CVCyr4PePhTo65q3DyX7OpTbSVk1PB62mhJ9HSpSqtKaESxsFRm0tLBVcvTV+vbBrLRK4hC7aitN9B0ZpX6vNMgjGIt5ZdmMv32KrmprD1afsPd4FEhThK0+WfTl3kpd482AGvG3jQdZK1+t8ireDswhofigRb3fxfI/4jj+xkffUX/1ccxxhEP9qyyBEH9Cx9vhf8TB7eiSpBHjZVSa4whQMJC1TqIR6q8RERtjOr2ID0yx3oYi0oAIvZCPz4eG64p3ObuREeOHUIR3MBVJwq9yll5P7KHdiPBOiOoRa/AjXz21J3k04l+i8OjErj4kaXWQiIVO/EvA+KLRAEnUVomtjPd6SvR3RLoeMT54nKFH1EqtkkEGFaQuTlSQrsxhRiOIt51S/Ho8B11+FUlwRaHnU4utEI38/mgSjRJ8PhWEtN6Z6WcncQOU4efjKoh3zfi7/+DfhPrwOZ9a/iYBiVJJxPlei3CqIDTYEqAPFow5/c71fAdVIwmo4n+cTIGbr2n9NULAE5ifcNNS63hvEOFk0wxYnICBBZ0I9xERBVILF0uggNdxuOkR4S6ngvgPmArzHv4KpMKGQFjQ+Rw6q9dC6R6dgZaJF7RVWIH0BTY9h+fz0ohHOyLuy+He/hN4GUR3/RxcBx2f76izarI9CaXmzRmhNQuSfIgJkva5GzN6HJbhQxCNsDGDSh56plmef6sg2eaXPsYBt5W+H6VE6omG6hOS1w4hiTWiThbJ1YO+RSO1vrpMlomf6nhQGz0m7qT6W04XOUHyzhZ4rkG+0hxL66oDW9mnPWyL3TMmssxyQUwr01CHX7b2OvUIaqS48TnMtAoEQTQixJeAlDfSiGmk/l8jpwIpTyFqOfeNIHWBooC036ERtUQp2tm/CKT5jjySbxTlvUVj2yhjvyWDVL3yfKRojXwLSEWUp7q0PBAKPp7m5YGoT3WH7wAZ1BeOywNZv3Gak/LIqriwxbQ5jaTcsEW1eb+FvoWo+zr5V/IUOvNtsapU2zJXSyj0xVB13sPfq0kkZA7dubIIKXIlJ8Cy7u+BN22RVcr+peOuxHdcBbA04FAVmEoEtO5vX55K4KVZS1QJvBBzU1rgUl8JapBNYIowLoZtD9NWRTWKqqe36L48BSz8QPH9epqqIDehlh2UuqocEmrdV7AvhuRoM74m80yeDIEX3ppreNN235FxV58DNjhswn5K8zK21+5ctjut6NmUIoy9tVvitnHr2VDM3ahtW8KQ/Vbsp9GGiWHfk8skyTSFz9/HdxhHe4uR/RxX/mG1SGXwypcDJNmCMfucZ/C1CuCQUbiBUDYbe7tiRkZX8GIat50d+wqR1fdN7ygGzrHrcN4kGFHK02cil5M6INgQVsvnNz77T5PqUFYJJInYmIBplJfP5On4eiOwYfhuCD44oLyYVs43rI1rk3H7usttzq8Qo3j84vavN9mOkAeuq8dHEd9NtCVKX51Oen+MM6IEYvz5StOehKLpIjD+nKU5AQWJpLizdB+1sb5LQvFRxbSJVGHmSdK/0WWaPguEYmcSJ68aWkK6rAw6jwSSCmrTWVHT96R7HwHANEgqybVJL+E2vE2q7Uu91Gr73SbbNUvZDtiOlCeIv4r/AI+0XUwz1lvcAAAAAElFTkSuQmCC")}.markdown-body h2{position:relative;padding:0 0 0 20px;font-size:20px;font-weight:700;color:#614500}.markdown-body h2:before{content:"";position:absolute;top:3px;bottom:0;left:0;background-image:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMgAAADICAMAAACahl6sAAAAQlBMVEVHcEwlRnqtZBj76q4lRnolRnolRnolRnolRnokRnr/gGtrVUeLXDBKTl+hYSHasW7Ik0zs0JG4dCvUdEE0SW+rYxrLQJfjAAAACnRSTlMA////0H/xUaMi5MCoTwAACfVJREFUeNrtnQl3qygUgJ9GXAqosfL//+pgmgXwXmRNJGdu55xO+6rx8+6I8O9fehmGriN93zdN07bVXdpW/ih/SbpuGP6dXbpOXv7z2i3S9ISck2eQOnAhMHG64VQQbmrAaM4B05GmipaGdB+m6BNQPBXzMYtKR3EPbB/RS5eY4g+lIW9WBqnySCvVMrzRpqqs0g9nwVg5p1KYlHEchRT5bftp+y3n6xlQDjAkABtrKULU9f377ev+4/1/NiT+URRiZRhrcZP6WLa/Gq005BORaqXsdYEuHPIP798ZxSyt6d5sVfxJESRCsvB32lfXwhRjnUBGmKXNoJQe04VIASJqRC/9G7yDsyQMiloYz+0pHYghEoPISAGgpDSvHsCoMwmA0mfjSG5UOsqah2RodkljzMkhZZdamiEDB8+Nsbk9T04yGNljDXGOZZ6u0+Tj9DuvbyNJBuPO0ABtLNPlJtfZJ4CNNCWJoY8gddwxNpm9YrHh9DEkBoeMud4Kma8XRZaYpBJOYvg59U9wOsblMvmGrzQe30dyqFZ1dxPfO0FT5BOdw989THVs4q1TFk+iN4PMu7CaLpd4EJOExNaJLE4d0xQKYpJ0cY5Ozcwwu6WOu2cs9TUYxPB4b4fvLRzTUXbT1HH7y0BnB0j6CAehkPFfFzd1TMsi6sU1/P4VM9NiISHBlYnBMR+kad075sXlmMehj1twnfTUqJH4GJfqIKte7S72emPnHbdiYHIB0e6ATjKq1UoTaFh6wBL2csMIVo9fH/v6QRHAgoxrOHQQxG/36tC1ODmGOeBGBRmXalgcdhDQ1xF1vI6a3DF2d4r7G1enOUgNOshlFq7qUCxrca9ldiCam7ilxRbP6JbOYsYtfLFmkcXEgLG1DN/6eroxHjqh5bh+Uw27e1oWVK7pN+AqwzUcq/UYTPw8nWufLFBHN2zcxLRYlmGPs6rA2Wy0uJe/E7TknbHIa1WH1bLA8DAj3JpxET+FCNCWZ5uNT6jxTPZK/1mXoCBeKlGLRT2lP69XN3XdqqCojKX1ZVda6iD2McjeXSHa0I+AHd2InGAJgjRVM6gOBfygDrarRJnho6eQBbrns+HkcNUCWtYClJa66qFgPbqqZEBTCOAgRqxCOhQBWpZeIC6QBq91hEoI5unTjsMsK9DCFigY9WNn19hgVCrELalrTw6WnYMYzjHhQ2/7G2xTx1HvwpzSe4cVi5ORQQwMW9+72FU5L4gGsa6Yu1RcDeIhs64Qs8izt0vGH+n9/IKaIlYpM2UqkYOrwwq5CgBjWpyGtxaonxe4KaJ3hx+7O0HaqVkxLBPj8FmBVmjNevIUFhUuDmMq5NDV9RwyPe/95IvxAhG7ymqxHGE5sZJL2kPLUhUinkXfrnFwGFwXD99djNLSFh/meXEb2B6Oyiwm0I7BC+OlTlOVPk9K8CIYzu5YHwKDTI6XAo5lz3WEqEXwQRKhh5cyLa6D81P4PXBw984as9YaGXHwx4Ba8rmOldUat/BHt9cQ38AaljnBdCJqs60OcXVDJZP//ZwSWtV9FpHNtgg22KuYx/U2tB5Mcp1TYOiphNhiFjgWeJ3DL2OZpuuUisIoUyzZEJ76I+LmyqWdv8LwnEiwMYczihjxeqtBsuFJSTg2oD1ETQx4v6D1VleSZW1xCwvAfVGWpQ069kgrQksAUW2rReYzsboIjSABuDQX0QJwB9cnZVgWVgE31vrklAJnEmVObykgYCk/VGX5OlpuKb5eiovUAvJ2tMstw0kIkNdpiSA91K6XA6K8CVCyr4PePhTo65q3DyX7OpTbSVk1PB62mhJ9HSpSqtKaESxsFRm0tLBVcvTV+vbBrLRK4hC7aitN9B0ZpX6vNMgjGIt5ZdmMv32KrmprD1afsPd4FEhThK0+WfTl3kpd482AGvG3jQdZK1+t8ireDswhofigRb3fxfI/4jj+xkffUX/1ccxxhEP9qyyBEH9Cx9vhf8TB7eiSpBHjZVSa4whQMJC1TqIR6q8RERtjOr2ID0yx3oYi0oAIvZCPz4eG64p3ObuREeOHUIR3MBVJwq9yll5P7KHdiPBOiOoRa/AjXz21J3k04l+i8OjErj4kaXWQiIVO/EvA+KLRAEnUVomtjPd6SvR3RLoeMT54nKFH1EqtkkEGFaQuTlSQrsxhRiOIt51S/Ho8B11+FUlwRaHnU4utEI38/mgSjRJ8PhWEtN6Z6WcncQOU4efjKoh3zfi7/+DfhPrwOZ9a/iYBiVJJxPlei3CqIDTYEqAPFow5/c71fAdVIwmo4n+cTIGbr2n9NULAE5ifcNNS63hvEOFk0wxYnICBBZ0I9xERBVILF0uggNdxuOkR4S6ngvgPmArzHv4KpMKGQFjQ+Rw6q9dC6R6dgZaJF7RVWIH0BTY9h+fz0ohHOyLuy+He/hN4GUR3/RxcBx2f76izarI9CaXmzRmhNQuSfIgJkva5GzN6HJbhQxCNsDGDSh56plmef6sg2eaXPsYBt5W+H6VE6omG6hOS1w4hiTWiThbJ1YO+RSO1vrpMlomf6nhQGz0m7qT6W04XOUHyzhZ4rkG+0hxL66oDW9mnPWyL3TMmssxyQUwr01CHX7b2OvUIaqS48TnMtAoEQTQixJeAlDfSiGmk/l8jpwIpTyFqOfeNIHWBooC036ERtUQp2tm/CKT5jjySbxTlvUVj2yhjvyWDVL3yfKRojXwLSEWUp7q0PBAKPp7m5YGoT3WH7wAZ1BeOywNZv3Gak/LIqriwxbQ5jaTcsEW1eb+FvoWo+zr5V/IUOvNtsapU2zJXSyj0xVB13sPfq0kkZA7dubIIKXIlJ8Cy7u+BN22RVcr+peOuxHdcBbA04FAVmEoEtO5vX55K4KVZS1QJvBBzU1rgUl8JapBNYIowLoZtD9NWRTWKqqe36L48BSz8QPH9epqqIDehlh2UuqocEmrdV7AvhuRoM74m80yeDIEX3ppreNN235FxV58DNjhswn5K8zK21+5ctjut6NmUIoy9tVvitnHr2VDM3ahtW8KQ/Vbsp9GGiWHfk8skyTSFz9/HdxhHe4uR/RxX/mG1SGXwypcDJNmCMfucZ/C1CuCQUbiBUDYbe7tiRkZX8GIat50d+wqR1fdN7ygGzrHrcN4kGFHK02cil5M6INgQVsvnNz77T5PqUFYJJInYmIBplJfP5On4eiOwYfhuCD44oLyYVs43rI1rk3H7usttzq8Qo3j84vavN9mOkAeuq8dHEd9NtCVKX51Oen+MM6IEYvz5StOehKLpIjD+nKU5AQWJpLizdB+1sb5LQvFRxbSJVGHmSdK/0WWaPguEYmcSJ68aWkK6rAw6jwSSCmrTWVHT96R7HwHANEgqybVJL+E2vE2q7Uu91Gr73SbbNUvZDtiOlCeIv4r/AI+0XUwz1lvcAAAAAElFTkSuQmCC");background-size:100% 100%;background-repeat:no-repeat;width:15px;height:15px;margin:auto}.markdown-body h3{width:100%;text-align:left;margin:20px 10px 0 0;font-size:18px;font-weight:700;display:inline-block;padding-left:10px;padding-bottom:0;border-left:5px solid #8f6600;color:#614500}.markdown-body h4,.markdown-body h5,.markdown-body h6{font-weight:700;color:#a37400}.markdown-body h4{font-size:17px}.markdown-body h5,.markdown-body h6{display:flex;align-items:center}.markdown-body h5:after,.markdown-body h6:after{display:inline-block;border:2px solid #fff6e0;color:rgba(189,134,0,.5);border-radius:50%;text-align:center;margin-left:5px}.markdown-body h5{font-size:14px}.markdown-body h5:after{content:"5";width:15px;height:15px;line-height:15px;font-size:13px}.markdown-body h6{font-size:12px}.markdown-body h6:after{content:"6";width:13px;height:13px;line-height:13px;font-size:12px}.markdown-body p{color:#412c0c;letter-spacing:1px;font-weight:400;margin-bottom:16px}.markdown-body img{max-width:100%;display:block;margin:auto}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{color:#755300;font-weight:400;border-bottom:1px solid #755300;font-weight:bolder;text-decoration:none}.markdown-body table{width:100%!important;margin:0;font-size:12px;width:auto;max-width:100%;overflow:auto;border-collapse:collapse;border-spacing:0}.markdown-body table img{box-shadow:none}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body thead tr th{text-align:center}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px;box-sizing:border-box;border:1px solid rgba(72,42,10,.1)}.markdown-body blockquote{position:relative;text-size-adjust:100%;line-height:25px;font-weight:400;border-radius:10px;font-style:normal;text-align:left;box-sizing:inherit;border:1px solid #ffd87a;background-color:rgba(189,134,0,.5);margin:20px 0;padding:20px}.markdown-body blockquote p{color:#fff6e0;letter-spacing:2px;margin:0}.markdown-body blockquote:after,.markdown-body blockquote:before{position:absolute;color:#cc9100;font-size:34px;font-weight:700}.markdown-body blockquote:before{content:"❝";top:8px;left:5px}.markdown-body blockquote:after{content:"❞";right:5px;bottom:-5px}.markdown-body strong{color:#c28a00;font-weight:bolder}.markdown-body strong:before{content:"「"}.markdown-body strong:after{content:"」"}.markdown-body em{color:#c28a00}.markdown-body em strong{font-style:normal;color:#c28a00;background-color:#8a6200}.markdown-body s{color:#c28a00}.markdown-body hr{border-top:1px solid #805b00}.markdown-body code,.markdown-body li code,.markdown-body p code{color:#996d00;background-color:rgba(130,98,0,.3)}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit;color:#858585;font-family:bold;letter-spacing:1px}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body h1::selection,.markdown-body h2::selection,.markdown-body h3::selection,.markdown-body h4::selection,.markdown-body h5::selection,.markdown-body h6::selection,.markdown-body img::selection{color:rgba(189,134,0,.5);background-color:#fff}.markdown-body a::selection,.markdown-body b::selection,.markdown-body del::selection,.markdown-body em::selection,.markdown-body i::selection,.markdown-body strong::selection{background-color:transparent}.markdown-body pre&gt;code::selection{background-color:rgba(189,134,0,.5)}.markdown-body .math .math-inline::selection,.markdown-body blockquote::selection,.markdown-body ol::selection,.markdown-body p::selection,.markdown-body strong::selection,.markdown-body table::selection,.markdown-body ul::selection{background-color:rgba(189,134,0,.5)}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Ant Design 6.0 技术解析：面向未来的 React UI 组件库升级</h2>
<h3 data-id="heading-1">一、前言：Ant Design 6.0 发布背景</h3>
<h4 data-id="heading-2">Ant Design 的发展与社区规模简介</h4>
<p>Ant Design 作为蚂蚁集团开源的企业级 React UI 组件库，自 2015 年发布以来已成为全球最受欢迎的前端组件库之一。截至目前，Ant Design 在 GitHub 上已获得超过 90k+ Star，拥有数千名贡献者，被全球数十万个项目采用。它不仅为企业级应用提供了完整的设计规范和高质量组件，更形成了一个活跃的开源生态系统。</p>
<p>2025 年初，Ant Design 6.0 正式稳定发布。这次重大版本升级经历了多次 RFC（Request for Comments）讨论和 Alpha 版本迭代，充分吸收了社区反馈，确保了升级的稳定性和前瞻性。</p>
<h4 data-id="heading-3">为什么值得关注这次重大版本升级</h4>
<p>随着 Ant Design v5 进入稳定维护周期，v6 正式成为未来主力版本。这次升级不仅仅是版本号的变化，更代表着：</p>
<ul>
<li><strong>技术架构的现代化</strong>：全面拥抱 React 18+ 特性，为 React 19 做好准备</li>
<li><strong>性能的显著提升</strong>：引入 React Compiler 和零运行时 CSS 方案</li>
<li><strong>开发体验的优化</strong>：更灵活的主题定制和语义化 DOM 结构</li>
<li><strong>生态的持续扩展</strong>：与 Ant Design X 2.0 同步发布，覆盖 AI UI 场景</li>
</ul>
<p>对于使用 Ant Design 的开发者和团队来说，了解 v6 的核心变化，规划合理的升级路径，将直接影响项目的长期技术选型和维护成本。</p>
<h3 data-id="heading-4">二、核心升级方向概览</h3>
<h4 data-id="heading-5">面向未来的技术架构升级</h4>
<p>Ant Design 6.0 将最低 React 版本要求提升至 18，全面支持 React 18 的并发特性（Concurrent Features）。这不仅确保了组件库能够充分利用 React 的最新能力，也为即将到来的 React 19 做好了技术储备。通过启用 React Compiler，v6 在构建产物层面实现了更优的性能优化。</p>
<h4 data-id="heading-6">平滑迁移，减少升级成本</h4>
<p>与以往大版本升级不同，Ant Design v6 特别注重平滑迁移体验。官方承诺：从 v5 升级到 v6 无需使用兼容包或 codemod 工具，大部分项目可以通过简单的依赖升级和少量代码调整完成迁移。这种设计理念大大降低了升级成本，让开发者能够更快享受新版本带来的优势。</p>
<h4 data-id="heading-7">性能与体验优化</h4>
<p>v6 在性能优化上做了多方面努力：</p>
<ul>
<li><strong>React Compiler</strong>：自动优化组件渲染性能</li>
<li><strong>CSS Variables 原生样式</strong>：零运行时开销，主题切换更流畅</li>
<li><strong>语义化 DOM 结构</strong>：更好的可访问性和样式定制能力</li>
<li><strong>默认模糊蒙版</strong>：提升视觉层级体验</li>
</ul>
<p>这些优化共同构成了 v6 在性能和用户体验上的显著提升。</p>
<h3 data-id="heading-8">三、从 V5 到 V6 的主要变化</h3>
<h4 data-id="heading-9">1. React 兼容性与基础架构</h4>
<h5 data-id="heading-10">最低 React 版本提升至 18</h5>
<p>Ant Design 6.0 不再支持 React 17 及以下版本。这个决策意味着：</p>
<ul>
<li>组件库可以充分利用 React 18 的并发渲染、自动批处理等特性</li>
<li>开发者需要确保项目已升级到 React 18+</li>
<li>为未来 React 19 的新特性预留了技术空间</li>
</ul>
<pre><code class="hljs language-json" lang="json"><span class="hljs-comment">// package.json 依赖要求</span>
<span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"peerDependencies"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"react"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"&gt;=18.0.0"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"react-dom"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"&gt;=18.0.0"</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h5 data-id="heading-11">启用 React Compiler</h5>
<p>v6 在构建产物中启用了 React Compiler（React 团队推出的编译时优化工具），能够：</p>
<ul>
<li>自动识别并优化组件的重渲染逻辑</li>
<li>减少不必要的 memo 和 useCallback 使用</li>
<li>提升整体运行时性能</li>
</ul>
<h4 data-id="heading-12">2. 样式体系重大调整：CSS Variables 与零运行时</h4>
<h5 data-id="heading-13">从 CSS-in-JS 向纯 CSS 变量体系过渡</h5>
<p>这是 v6 最重大的架构变化之一。v5 使用的是运行时 CSS-in-JS 方案（基于 @ant-design/cssinjs），而 v6 默认采用纯 CSS 变量模式：</p>
<p><strong>v5 样式方案（运行时）：</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 运行时动态生成样式</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">useStyle</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-keyword">return</span> {
    <span class="hljs-attr">container</span>: {
      <span class="hljs-attr">backgroundColor</span>: token.<span class="hljs-property">colorBgContainer</span>,
      <span class="hljs-attr">padding</span>: token.<span class="hljs-property">padding</span>
    }
  }
}
</code></pre>
<p><strong>v6 样式方案（零运行时）：</strong></p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-comment">/* 编译时生成 CSS 变量 */</span>
<span class="hljs-selector-class">.ant-btn</span> {
  <span class="hljs-attribute">background-color</span>: <span class="hljs-built_in">var</span>(--ant-color-primary);
  <span class="hljs-attribute">padding</span>: <span class="hljs-built_in">var</span>(--ant-padding);
}
</code></pre>
<p>这种转变带来的优势：</p>
<ul>
<li><strong>零运行时开销</strong>：样式不再需要 JavaScript 动态插入，减少了首屏渲染时间</li>
<li><strong>更好的性能</strong>：避免了运行时样式计算和注入</li>
<li><strong>SSR 友好</strong>：服务端渲染场景下性能更优</li>
<li><strong>移除 IE 支持</strong>：不再需要为旧浏览器做兼容处理</li>
</ul>
<h5 data-id="heading-14">实时主题切换与多主题支持更轻量</h5>
<p>CSS Variables 使得主题切换变得极其简单和高效：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">ConfigProvider</span>, theme } <span class="hljs-keyword">from</span> <span class="hljs-string">'antd'</span>;

<span class="hljs-comment">// 动态切换主题</span>
<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">ConfigProvider</span>
  <span class="hljs-attr">theme</span>=<span class="hljs-string">{{</span>
    <span class="hljs-attr">token:</span> {
      <span class="hljs-attr">colorPrimary:</span> '#<span class="hljs-attr">00b96b</span>',
      <span class="hljs-attr">borderRadius:</span> <span class="hljs-attr">2</span>,
    },
  }}
&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">App</span> /&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">ConfigProvider</span>&gt;</span></span>

<span class="hljs-comment">// 多主题切换无需重新渲染整个应用</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">switchTheme</span> = (<span class="hljs-params">isDark</span>) =&gt; {
  <span class="hljs-variable language_">document</span>.<span class="hljs-property">documentElement</span>.<span class="hljs-title function_">setAttribute</span>(
    <span class="hljs-string">'data-theme'</span>, 
    isDark ? <span class="hljs-string">'dark'</span> : <span class="hljs-string">'light'</span>
  );
};
</code></pre>
<h4 data-id="heading-15">3. 语义化 DOM 结构与可定制性提升</h4>
<h5 data-id="heading-16">全面引入组件语义化结构（Semantic Structure）</h5>
<p>v6 重构了组件的 DOM 结构，使其更符合 HTML5 语义化标准：</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-comment">&lt;!-- v5 结构 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"ant-card"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"ant-card-head"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"ant-card-head-wrapper"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"ant-card-head-title"</span>&gt;</span>标题<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"ant-card-body"</span>&gt;</span>内容<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>

<span class="hljs-comment">&lt;!-- v6 语义化结构 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">article</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"ant-card"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">header</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"ant-card-header"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">h3</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"ant-card-title"</span>&gt;</span>标题<span class="hljs-tag">&lt;/<span class="hljs-name">h3</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">header</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">section</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"ant-card-body"</span>&gt;</span>内容<span class="hljs-tag">&lt;/<span class="hljs-name">section</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">article</span>&gt;</span>
</code></pre>
<p>这种改进带来的好处：</p>
<ul>
<li><strong>更好的可访问性（a11y）</strong>：屏幕阅读器能更准确理解页面结构</li>
<li><strong>SEO 友好</strong>：搜索引擎能更好地解析内容</li>
<li><strong>样式定制更直观</strong>：语义化标签让 CSS 选择器更清晰</li>
</ul>
<h5 data-id="heading-17">ConfigProvider classNames / styles 支持提升定制能力</h5>
<p>v6 增强了 ConfigProvider 的定制能力，支持通过函数动态生成类名和样式：</p>
<pre><code class="hljs language-javascript" lang="javascript">&lt;<span class="hljs-title class_">ConfigProvider</span>
  button={{
    <span class="hljs-attr">classNames</span>: {
      <span class="hljs-attr">root</span>: <span class="hljs-function">(<span class="hljs-params">{ size, type }</span>) =&gt;</span> <span class="hljs-string">`custom-btn-<span class="hljs-subst">${size}</span>-<span class="hljs-subst">${type}</span>`</span>,
    },
    <span class="hljs-attr">styles</span>: {
      <span class="hljs-attr">root</span>: <span class="hljs-function">(<span class="hljs-params">{ token }</span>) =&gt;</span> ({
        <span class="hljs-attr">borderRadius</span>: token.<span class="hljs-property">borderRadiusLG</span>,
      }),
    },
  }}
&gt;
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Button</span> <span class="hljs-attr">size</span>=<span class="hljs-string">"large"</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"primary"</span>&gt;</span>按钮<span class="hljs-tag">&lt;/<span class="hljs-name">Button</span>&gt;</span></span>
&lt;/<span class="hljs-title class_">ConfigProvider</span>&gt;
</code></pre>
<p>这种方式让全局样式定制更加灵活和类型安全。</p>
<h4 data-id="heading-18">4. API 调整与废弃逻辑清理</h4>
<h5 data-id="heading-19">删除 v4 废弃 API</h5>
<p>v6 彻底清理了所有在 v4 中标记为废弃、并在 v5 中保留的兼容逻辑。这包括：</p>
<ul>
<li>移除了旧的 <code>Form.create()</code> HOC 模式</li>
<li>清理了 <code>Icon</code> 组件的字符串类型支持</li>
<li>统一了事件回调参数格式</li>
</ul>
<h5 data-id="heading-20">统一 API 命名与行为</h5>
<p>v6 对一些历史遗留的 API 进行了统一：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// v5 中的不一致命名</span>
&lt;<span class="hljs-title class_">Dropdown</span> placement=<span class="hljs-string">"bottomLeft"</span> /&gt;
<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Tooltip</span> <span class="hljs-attr">placement</span>=<span class="hljs-string">"topLeft"</span> /&gt;</span></span>

<span class="hljs-comment">// v6 统一为</span>
<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Dropdown</span> <span class="hljs-attr">placement</span>=<span class="hljs-string">"bottom-start"</span> /&gt;</span></span>
<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Tooltip</span> <span class="hljs-attr">placement</span>=<span class="hljs-string">"top-start"</span> /&gt;</span></span>
</code></pre>
<h4 data-id="heading-21">5. 新组件与增强功能</h4>
<p>v6 带来了多个新组件和功能增强：</p>
<h5 data-id="heading-22">新增 Masonry（瀑布流）组件</h5>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/671b494f35e7463c92cc65ffa301c6f1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54uX5aS05aSn5Yab5LmL5rGf6IuP5YiG5Yab:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768902333&amp;x-signature=05RV%2FKEMfrtSARiadIenPTJwzZ0%3D" alt="image.png" loading="lazy"/></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">Masonry</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'antd'</span>;

<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Masonry</span>
  <span class="hljs-attr">columns</span>=<span class="hljs-string">{3}</span>
  <span class="hljs-attr">gap</span>=<span class="hljs-string">{16}</span>
  <span class="hljs-attr">items</span>=<span class="hljs-string">{dataSource}</span>
  <span class="hljs-attr">renderItem</span>=<span class="hljs-string">{(item)</span> =&gt;</span> <span class="hljs-tag">&lt;<span class="hljs-name">Card</span>&gt;</span>{item.content}<span class="hljs-tag">&lt;/<span class="hljs-name">Card</span>&gt;</span>}
/&gt;</span>
</code></pre>
<h5 data-id="heading-23">Tooltip 支持平移/滑动</h5>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cf371fbf9b764064a9ff1acecde1b745~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54uX5aS05aSn5Yab5LmL5rGf6IuP5YiG5Yab:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768902333&amp;x-signature=cBZmEXN9gET8MoO0bmPNL%2BhvWfA%3D" alt="image.png" loading="lazy"/></p>
<pre><code class="hljs language-javascript" lang="javascript">&lt;<span class="hljs-title class_">Tooltip</span> 
  title=<span class="hljs-string">"提示内容"</span> 
  trigger=<span class="hljs-string">"hover"</span>
  mouseEnterDelay={<span class="hljs-number">0.5</span>}
  mouseLeaveDelay={<span class="hljs-number">0.1</span>}
&gt;
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Button</span>&gt;</span>悬停查看<span class="hljs-tag">&lt;/<span class="hljs-name">Button</span>&gt;</span></span>
&lt;/<span class="hljs-title class_">Tooltip</span>&gt;
</code></pre>
<h5 data-id="heading-24">InputNumber 新增 spinner 模式</h5>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2199b41a60394f968ad6bffacdee8a9c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54uX5aS05aSn5Yab5LmL5rGf6IuP5YiG5Yab:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768902333&amp;x-signature=9aKxDCWLfmUmSnDMKgaHrNLdwhc%3D" alt="image.png" loading="lazy"/></p>
<pre><code class="hljs language-javascript" lang="javascript">&lt;<span class="hljs-title class_">InputNumber</span> 
  spinner={{ 
    <span class="hljs-attr">mode</span>: <span class="hljs-string">'inline'</span>, <span class="hljs-comment">// 或 'separate'</span>
    <span class="hljs-attr">upIcon</span>: <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">UpOutlined</span> /&gt;</span></span>,
    <span class="hljs-attr">downIcon</span>: <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">DownOutlined</span> /&gt;</span></span>
  }} 
/&gt;
</code></pre>
<h5 data-id="heading-25">Drawer 支持拖拽调整大小</h5>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cdeb6251b9b448afa90b725fdcbbb3b4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54uX5aS05aSn5Yab5LmL5rGf6IuP5YiG5Yab:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768902333&amp;x-signature=Cbuuh1w7b7y2lCzS52dOMl62sOE%3D" alt="image.png" loading="lazy"/></p>
<pre><code class="hljs language-javascript" lang="javascript">&lt;<span class="hljs-title class_">Drawer</span>
  open={visible}
  resizable
  defaultWidth={<span class="hljs-number">400</span>}
  minWidth={<span class="hljs-number">300</span>}
  maxWidth={<span class="hljs-number">800</span>}
&gt;
  {content}
&lt;/<span class="hljs-title class_">Drawer</span>&gt;
</code></pre>
<h5 data-id="heading-26">默认模糊蒙版（mask blur）增强层级体验</h5>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/15d3c7382ce84cb68b9bce0b8ebf7554~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54uX5aS05aSn5Yab5LmL5rGf6IuP5YiG5Yab:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768902333&amp;x-signature=eodSAoBj1mIT95J88zN%2FL9eCiPk%3D" alt="image.png" loading="lazy"/></p>
<pre><code class="hljs language-javascript" lang="javascript">&lt;<span class="hljs-title class_">Modal</span>
  open={visible}
  maskStyle={{ <span class="hljs-attr">backdropFilter</span>: <span class="hljs-string">'blur(8px)'</span> }}
&gt;
  {content}
&lt;/<span class="hljs-title class_">Modal</span>&gt;
</code></pre>
<p>这些新特性显著提升了组件的丰富性和用户交互体验。</p>
<h3 data-id="heading-27">四、从 v5 升级到 v6：实战建议与注意事项</h3>
<h4 data-id="heading-28">升级前的准备事项</h4>
<p>在开始升级之前，建议完成以下准备工作：</p>
<ol>
<li>
<p><strong>升级到最新的 v5 版本并清理警告</strong></p>
<pre><code class="hljs language-bash" lang="bash">npm install antd@^5.latest
<span class="hljs-comment"># 运行项目，检查并修复所有控制台警告</span>
</code></pre>
</li>
<li>
<p><strong>确认 React 版本</strong></p>
<pre><code class="hljs language-bash" lang="bash">npm install react@^18.0.0 react-dom@^18.0.0
</code></pre>
</li>
<li>
<p><strong>评估 IE 支持需求</strong></p>
<ul>
<li>v6 不再支持 IE 浏览器</li>
<li>如果项目必须支持 IE，需要继续使用 v5</li>
</ul>
</li>
<li>
<p><strong>检查自定义主题和样式覆盖</strong></p>
<ul>
<li>记录当前的主题配置</li>
<li>检查是否有直接操作 <code>.ant-</code> 类名的 CSS</li>
</ul>
</li>
</ol>
<h4 data-id="heading-29">可能遇到的不兼容变更点</h4>
<h5 data-id="heading-30">样式生成机制变化</h5>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// v5 中可能有效的样式覆盖</span>
.<span class="hljs-property">ant</span>-btn {
  <span class="hljs-attr">background</span>: red !important; <span class="hljs-comment">// 可能需要调整</span>
}

<span class="hljs-comment">// v6 推荐使用 CSS Variables</span>
.<span class="hljs-property">ant</span>-btn {
  <span class="hljs-attr">background</span>: <span class="hljs-title function_">var</span>(--ant-color-primary);
}

<span class="hljs-comment">// 或通过 ConfigProvider 定制</span>
&lt;<span class="hljs-title class_">ConfigProvider</span>
  theme={{
    <span class="hljs-attr">components</span>: {
      <span class="hljs-title class_">Button</span>: {
        <span class="hljs-attr">colorPrimary</span>: <span class="hljs-string">'red'</span>,
      },
    },
  }}
&gt;
</code></pre>
<h5 data-id="heading-31">移除的 API 示例</h5>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// ❌ v5 废弃 API（v6 中已移除）</span>
&lt;<span class="hljs-title class_">Form</span>.<span class="hljs-property">Item</span> name=<span class="hljs-string">"username"</span> rules={[{ <span class="hljs-attr">required</span>: <span class="hljs-literal">true</span> }]}&gt;
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Input</span> /&gt;</span></span>
&lt;/<span class="hljs-title class_">Form</span>.<span class="hljs-property">Item</span>&gt;

<span class="hljs-comment">// ✅ v6 推荐写法（实际上 v5 也推荐）</span>
<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Form.Item</span> 
  <span class="hljs-attr">name</span>=<span class="hljs-string">"username"</span> 
  <span class="hljs-attr">rules</span>=<span class="hljs-string">{[{</span> <span class="hljs-attr">required:</span> <span class="hljs-attr">true</span>, <span class="hljs-attr">message:</span> '<span class="hljs-attr">请输入用户名</span>' }]}
&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">Input</span> /&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">Form.Item</span>&gt;</span></span>
</code></pre>
<h4 data-id="heading-32">升级策略与逐步实践</h4>
<h5 data-id="heading-33">步骤 1：安装 v6</h5>
<pre><code class="hljs language-bash" lang="bash">npm install antd@6
<span class="hljs-comment"># 或</span>
yarn add antd@6
<span class="hljs-comment"># 或</span>
pnpm add antd@6
</code></pre>
<h5 data-id="heading-34">步骤 2：运行开发环境</h5>
<pre><code class="hljs language-bash" lang="bash">npm run dev
</code></pre>
<p>观察控制台是否有错误或警告，记录所有问题。</p>
<h5 data-id="heading-35">步骤 3：修复不兼容问题</h5>
<p>根据控制台提示，逐一修复：</p>
<ul>
<li>替换已移除的 API</li>
<li>调整样式覆盖方式</li>
<li>更新主题配置格式</li>
</ul>
<h5 data-id="heading-36">步骤 4：利用 ConfigProvider 全局管理</h5>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// main.tsx 或 App.tsx</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">ConfigProvider</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'antd'</span>;
<span class="hljs-keyword">import</span> zhCN <span class="hljs-keyword">from</span> <span class="hljs-string">'antd/locale/zh_CN'</span>;

<span class="hljs-keyword">function</span> <span class="hljs-title function_">App</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">ConfigProvider</span>
      <span class="hljs-attr">locale</span>=<span class="hljs-string">{zhCN}</span>
      <span class="hljs-attr">theme</span>=<span class="hljs-string">{{</span>
        <span class="hljs-attr">token:</span> {
          <span class="hljs-attr">colorPrimary:</span> '#<span class="hljs-attr">1890ff</span>',
          <span class="hljs-attr">borderRadius:</span> <span class="hljs-attr">4</span>,
        },
        <span class="hljs-attr">components:</span> {
          <span class="hljs-attr">Button:</span> {
            <span class="hljs-attr">controlHeight:</span> <span class="hljs-attr">32</span>,
          },
        },
      }}
    &gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">YourApp</span> /&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">ConfigProvider</span>&gt;</span></span>
  );
}
</code></pre>
<h5 data-id="heading-37">步骤 5：渐进式测试</h5>
<ul>
<li>先在开发环境充分测试</li>
<li>在测试环境进行完整回归测试</li>
<li>确认无误后再部署到生产环境</li>
</ul>
<h3 data-id="heading-38">五、生态扩展：Ant Design X 与未来方向</h3>
<h4 data-id="heading-39">Ant Design X 2.0 同步发布</h4>
<p>与 Ant Design 6.0 同步，蚂蚁集团还发布了 Ant Design X 2.0。这是一个专注于 AI UI 场景的组件库，提供了：</p>
<ul>
<li><strong>对话式交互组件</strong>：Chat、Bubble、Conversations</li>
<li><strong>AI 输入增强</strong>：Prompts、Sender、Attachments</li>
<li><strong>智能建议</strong>：Suggestions、ThoughtChain</li>
<li><strong>流式渲染</strong>：支持 AI 生成内容的流式展示</li>
</ul>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">Bubble</span>, <span class="hljs-title class_">Sender</span>, <span class="hljs-title class_">Conversations</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@ant-design/x'</span>;

<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Conversations</span>
  <span class="hljs-attr">items</span>=<span class="hljs-string">{messages}</span>
  <span class="hljs-attr">renderItem</span>=<span class="hljs-string">{(item)</span> =&gt;</span> (
    <span class="hljs-tag">&lt;<span class="hljs-name">Bubble</span>
      <span class="hljs-attr">content</span>=<span class="hljs-string">{item.content}</span>
      <span class="hljs-attr">avatar</span>=<span class="hljs-string">{item.avatar}</span>
      <span class="hljs-attr">typing</span>=<span class="hljs-string">{item.typing}</span>
    /&gt;</span>
  )}
/&gt;</span>
<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Sender</span> <span class="hljs-attr">onSubmit</span>=<span class="hljs-string">{handleSend}</span> /&gt;</span></span>
</code></pre>
<p>Ant Design X 的发布标志着 Ant Design 生态正在积极拥抱 AI 时代的 UI 需求。</p>
<h4 data-id="heading-40">未来计划</h4>
<p>根据官方路线图，Ant Design 团队未来将重点关注：</p>
<ol>
<li>
<p><strong>持续完善移动交互体验</strong></p>
<ul>
<li>优化触摸交互</li>
<li>提升响应式布局能力</li>
<li>增强移动端手势支持</li>
</ul>
</li>
<li>
<p><strong>强化可访问性（a11y）</strong></p>
<ul>
<li>完善 ARIA 属性</li>
<li>优化键盘导航</li>
<li>提升屏幕阅读器兼容性</li>
</ul>
</li>
<li>
<p><strong>跟进 React 新特性提升性能</strong></p>
<ul>
<li>持续优化 React 19 兼容性</li>
<li>探索 Server Components 支持</li>
<li>利用新的并发特性</li>
</ul>
</li>
<li>
<p><strong>扩展 AI 场景组件</strong></p>
<ul>
<li>丰富 Ant Design X 组件库</li>
<li>提供更多 AI 交互模式</li>
<li>支持多模态内容展示</li>
</ul>
</li>
</ol>
<h3 data-id="heading-41">六、结语</h3>
<p>Ant Design 6.0 是一次面向未来的重大升级。通过引入零运行时 CSS 方案、语义化 DOM 结构、React Compiler 等现代化技术，v6 在性能、开发体验和可维护性上都实现了显著提升。</p>
<p>对于开发者而言，v6 的升级成本相对可控。官方承诺的平滑迁移路径、详细的升级文档，以及活跃的社区支持，都为升级提供了有力保障。同时，v6 与 Ant Design X 2.0 的协同发布，也展示了 Ant Design 生态在 AI 时代的前瞻性布局。</p>
<p>建议开发者根据项目实际情况规划升级路径：</p>
<ul>
<li><strong>新项目</strong>：直接采用 v6，享受最新特性和最佳性能</li>
<li><strong>维护项目</strong>：评估升级收益，制定渐进式升级计划</li>
<li><strong>遗留项目</strong>：如无特殊需求，可继续使用 v5（官方将持续维护）</li>
</ul>
<p>无论选择何种路径，Ant Design 6.0 都代表着 React UI 组件库发展的新方向，值得每一位前端开发者关注和学习。</p>
<hr/>
<p><strong>参考资源：</strong></p>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fant.design" target="_blank" title="https://ant.design" ref="nofollow noopener noreferrer">Ant Design 6.0 官方文档</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fant-design%2Fant-design%2Freleases" target="_blank" title="https://github.com/ant-design/ant-design/releases" ref="nofollow noopener noreferrer">GitHub Release Notes</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fant-design-x.antgroup.com" target="_blank" title="https://ant-design-x.antgroup.com" ref="nofollow noopener noreferrer">Ant Design X 官网</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fant.design%2Fdocs%2Freact%2Fmigration-v6" target="_blank" title="https://ant.design/docs/react/migration-v6" ref="nofollow noopener noreferrer">升级指南</a></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[告别旧生态：Ant Design 6 不再支持 IE 与现代前端趋势解读]]></title>    <link>https://juejin.cn/post/7594616268782419995</link>    <guid>https://juejin.cn/post/7594616268782419995</guid>    <pubDate>2026-01-13T09:47:49.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7594616268782419995" data-draft-id="7594669638559006746" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="告别旧生态：Ant Design 6 不再支持 IE 与现代前端趋势解读"/> <meta itemprop="keywords" content="前端,后端,JavaScript"/> <meta itemprop="datePublished" content="2026-01-13T09:47:49.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="狗头大军之江苏分军"/> <meta itemprop="url" content="https://juejin.cn/user/2955079655907879"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            告别旧生态：Ant Design 6 不再支持 IE 与现代前端趋势解读
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2955079655907879/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    狗头大军之江苏分军
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-13T09:47:49.000Z" title="Tue Jan 13 2026 09:47:49 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:14px;overflow-x:hidden;color:var(--cyanosis-base-color);transition:color .35s;--cyanosis-base-color:#353535;--cyanosis-title-color:#005bb7;--cyanosis-strong-color:#2196f3;--cyanosis-em-color:#4fc3f7;--cyanosis-del-color:#ccc;--cyanosis-link-color:#3da8f5;--cyanosis-linkh-color:#007fff;--cyanosis-border-color:#bedcff;--cyanosis-border-color-2:#ececec;--cyanosis-bg-color:#fff;--cyanosis-blockquote-color:#8c8c8c;--cyanosis-blockquote-bg-color:#f0fdff;--cyanosis-code-color:#c2185b;--cyanosis-code-bg-color:#fff4f4;--cyanosis-code-pre-color:#f8f8f8;--cyanosis-table-border-color:#c3e0fd;--cyanosis-table-th-color:#dff0ff;--cyanosis-table-tht-color:#005bb7;--cyanosis-table-tr-nc-color:#f7fbff;--cyanosis-table-trh-color:#e0edf7;--cyanosis-slct-title-color:#005bb7;--cyanosis-slct-titlebg-color:rgba(175,207,247,0.25);--cyanosis-slct-text-color:#c80000;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#e8ebec;--cyanosis-slct-codebg-color:#ffeaeb;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body.__dark{--cyanosis-base-color:#cacaca;--cyanosis-title-color:#ddd;--cyanosis-strong-color:#fe9900;--cyanosis-em-color:#ffd28e;--cyanosis-del-color:#ccc;--cyanosis-link-color:#ffb648;--cyanosis-linkh-color:#fe9900;--cyanosis-border-color:#ffe3ba;--cyanosis-border-color-2:#ffcb7b;--cyanosis-bg-color:#2f2f2f;--cyanosis-blockquote-color:#c7c7c7;--cyanosis-blockquote-bg-color:rgba(255,199,116,0.1);--cyanosis-code-color:#000;--cyanosis-code-bg-color:#ffcb7b;--cyanosis-code-pre-color:rgba(255,227,185,0.5);--cyanosis-table-border-color:#fe9900;--cyanosis-table-th-color:#ffb648;--cyanosis-table-tht-color:#000;--cyanosis-table-tr-nc-color:#6d5736;--cyanosis-table-trh-color:#947443;--cyanosis-slct-title-color:#000;--cyanosis-slct-titlebg-color:#fe9900;--cyanosis-slct-text-color:#00c888;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#000;--cyanosis-slct-codebg-color:#ffcb7b;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body h1{padding-bottom:4px;font-size:30px}.markdown-body h1,.markdown-body h2{margin-top:36px;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);transition:color .35s}.markdown-body h2{position:relative;padding-left:10px;padding-right:10px;padding-bottom:10px;font-size:24px;border-bottom:1px solid var(--cyanosis-border-color-2)}.markdown-body h2:before{content:"「";position:absolute;top:-6px;left:-14px}.markdown-body h2:after{content:"」";position:relative;top:6px;right:auto}.markdown-body h3{position:relative;padding-bottom:0;margin-top:30px;margin-bottom:10px;font-size:20px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h3:before{content:"»";padding-right:6px;color:var(--cyanosis-strong-color)}.markdown-body h4{margin-top:24px;font-size:16px}.markdown-body h4,.markdown-body h5{padding-bottom:0;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h5{margin-top:18px;font-size:14px}.markdown-body h6{padding-bottom:0;margin-top:12px;margin-bottom:10px;font-size:12px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body p{line-height:inherit;margin-top:16px;margin-bottom:16px}.markdown-body img{max-width:100%}.markdown-body hr{position:relative;width:98%;height:1px;margin-top:32px;margin-bottom:32px;background-image:linear-gradient(90deg,var(--cyanosis-link-color),rgba(255,0,0,.3),hsla(0,0%,100%,.1),rgba(255,0,0,.3),var(--cyanosis-link-color));border-width:0;overflow:visible}.markdown-body hr:after{content:"";position:absolute;margin:auto;left:0;right:0;bottom:0;top:0;display:inline-block;width:60px;height:20px;background-color:var(--cyanosis-bg-color);background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAgCAYAAABgrToAAAADoklEQVRYR82XTYgcRRTHf2933Q1RjAa9eFO8JHoJ8RQVBQ2iBwXBET0YEUTXNVmNQtTpmeqaWV0XNRq/o4KoECSCEPSg4CF+BYUkIIiCoCJCPIhC/Ihh2Z0nVV27VnZnenumW9i6ddV7//frV69fVQurfMgq56NawFTPAU6QyomqXrw6wIZeyhCPebA5buNR+akKyGoAjd6BshthnYdSjqNcRVuOlIUsD2j0SuA94IwuMHdh5ZUykOUBXfSGbmKI54EtAeYIHSZoy5dl4JxvNYBOKdW1KE8BQ8AkVk6WhasWsAiN0TX9gveXQaPP+Aytpc4u+bMI06JNohsYYYYOR2lJWtS3OKDRfcAtQfgDoI6Vo4UCGb0OmAEuDvZvYmVbEd/igC3dzDz7gQu8sPA9kJDK27mBmjqBeLjTg90PDFOjWawFFQd06kZHEfaj3LAIpTRpSXsZ5E06zEYP9sDimnAApYaV2SLZG/wjMeqAkijwW4xQJ5Gf/ZzRC8OW3hiBTGGlURRswW55Bh/Ssxljrwew8l1PQaM14GngvGDzBUKdDsMeTtgU5o8B92PFlUf3YXUrHa7Fys6lBqcCGnX15YQ2A18FyPd7Crd1A3M8C1wdbH4DD3hWeP6IEXbQkG97ajR1HPFnuPP5jFFq1OWX7hl8WM9l1AO648uNfwLk7tytMeogty+xeQ4rO3r6bdcx1nuwOGsHmaXGtPzae4uzGnLH1kQkvpdZGrHjssBZJrL+pqS05KWc8tgITAPXRzYvYOXe/C2OV43eDcRBDtIhoS2f9wzc0Cv8Wls+zoFzUC5zF0U241h5uZtPfptp6OUM8wbK+cH5GEpCS17P3fJei0Z3+npTxryJ8CPzbKMtn/ZyWbkPGl0PuFPkmkjkcb4h4R2ZLwRq1H0ALmvjkf2HwK1Y+T1PY2XABe/sHJ6MxN5lnoSpnC/UGbsTaI5phK2R7x6s3Ffk5YoDOrWm3onwJHBmEP86bPmBrsGaenNoIdnxCH+gPEhLXi0Cl1VBvyPVLSh7gEuC62yAfOIUqabWEaaiucMIk6RyqJ+Q/QM69V26jjW86Gvov/EaoyT8zRCn+Xq7PVrbx0nuYUaO9wM3WAbjCE1NEUw09Um4UV+2OKfYfu5/S19gsAzGKqm6LE5FrShbdS0ku465DjDwKA/oQht19ejqbaEVuRbiLhuHByYLjtUAZpDutzP7cYdHsPJXWbjyNVgFwQoa1WXwf4Jd9YD/Ap80+yE7+u9aAAAAAElFTkSuQmCC);background-repeat:no-repeat;background-size:auto 100%;background-position-x:center;transition:background-color .5s}.markdown-body code{padding:.065em .4em;font-size:.87em;color:var(--cyanosis-code-color);word-break:break-word;overflow-x:auto;background-color:var(--cyanosis-code-bg-color);border-radius:2px}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{display:block;padding:16px 12px;margin:0;font-size:12px;color:#333;word-break:normal;overflow-x:auto;background:var(--cyanosis-code-pre-color)}.markdown-body pre&gt;code::-webkit-scrollbar{width:4px;height:4px}.markdown-body pre&gt;code::-webkit-scrollbar-track{background-color:var(--cyanosis-border-color)}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:var(--cyanosis-strong-color);border-radius:10px}.markdown-body a{position:relative;text-decoration:none;color:var(--cyanosis-link-color);border-bottom:1px solid var(--cyanosis-border-color)}.markdown-body a:hover{border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body a:active,.markdown-body a:hover{color:var(--cyanosis-linkh-color)}.markdown-body a:after{position:absolute;content:"";top:100%;left:0;width:100%;opacity:0;border-bottom:1px solid var(--cyanosis-border-color);transition:top .3s,opacity .3s;transform:translateZ(0)}.markdown-body a:hover:after{top:0;opacity:1;border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid var(--cyanosis-table-border-color);border-spacing:0;border-collapse:collapse}.markdown-body table thead{color:#000;text-align:left;font-size:14px;background:#f6f6f6}.markdown-body table tr:nth-child(2n){background-color:var(--cyanosis-table-tr-nc-color)}.markdown-body table tr:hover{background-color:var(--cyanosis-table-trh-color)}.markdown-body table td,.markdown-body table th{padding:12px 8px;line-height:24px;border:1px solid var(--cyanosis-table-border-color)}.markdown-body table th{color:var(--cyanosis-table-tht-color);background-color:var(--cyanosis-table-th-color)}.markdown-body table td{min-width:120px}.markdown-body blockquote{color:var(--cyanosis-blockquote-color);border-left:4px solid var(--cyanosis-strong-color);background-color:var(--cyanosis-blockquote-bg-color);padding:1px 20px;margin:22px 0;transition:color .35s}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body b,.markdown-body blockquote&gt;b,.markdown-body blockquote&gt;strong,.markdown-body strong{color:var(--cyanosis-strong-color)}.markdown-body em,.markdown-body i{color:var(--cyanosis-em-color)}.markdown-body del{color:var(--cyanosis-del-color)}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:4px}.markdown-body ol li{padding-left:6px}.markdown-body details&gt;summary{outline:none;color:var(--cyanosis-title-color);font-size:20px;font-weight:bolder;border-bottom:1px solid var(--cyanosis-border-color);cursor:pointer}.markdown-body details&gt;p{padding:10px 20px;margin:10px 0 0;color:#666;background-color:var(--cyanosis-blockquote-bg-color);border:2px dashed var(--cyanosis-strong-color)}.markdown-body h1::selection,.markdown-body h2::selection,.markdown-body h3::selection,.markdown-body h4::selection,.markdown-body h5::selection,.markdown-body h6::selection{color:var(--cyanosis-slct-title-color);background-color:var(--cyanosis-slct-titlebg-color)}.markdown-body ol li::selection,.markdown-body p::selection,.markdown-body ul li::selection{color:var(--cyanosis-slct-text-color);background-color:var(--cyanosis-slct-bg-color)}.markdown-body a::selection,.markdown-body b::selection,.markdown-body em::selection,.markdown-body i::selection,.markdown-body strong::selection{background-color:var(--cyanosis-slct-elbg-color)}.markdown-body del::selection{color:var(--cyanosis-slct-del-color);background-color:var(--cyanosis-slct-elbg-color)}.markdown-body table thead th::selection{background-color:transparent}.markdown-body table tbody td::selection{background-color:var(--cyanosis-slct-bg-color)}.markdown-body code::selection{background-color:var(--cyanosis-slct-codebg-color)}.markdown-body pre&gt;code::selection{background-color:var(--cyanosis-slct-prebg-color)}.markdown-body .contains-task-list{padding-left:14px;list-style:none}.markdown-body .contains-task-list input[type=checkbox]{position:relative}.markdown-body .contains-task-list input[type=checkbox]:before{content:"";position:absolute;top:0;left:0;right:0;bottom:0;width:inherit;height:inherit;background:#f0f8ff;border:1px solid #add6ff;border-radius:2px;box-sizing:border-box;z-index:1}.markdown-body .contains-task-list input[type=checkbox]:checked:after{content:"✓";position:absolute;top:-12px;left:0;right:0;bottom:0;width:0;height:0;color:#f55;font-size:20px;font-weight:700;z-index:2}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="atom-one-dark">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#abb2bf;background:#282c34}.hljs-comment,.hljs-quote{color:#5c6370;font-style:italic}.hljs-doctag,.hljs-formula,.hljs-keyword{color:#c678dd}.hljs-deletion,.hljs-name,.hljs-section,.hljs-selector-tag,.hljs-subst{color:#e06c75}.hljs-literal{color:#56b6c2}.hljs-addition,.hljs-attribute,.hljs-meta-string,.hljs-regexp,.hljs-string{color:#98c379}.hljs-built_in,.hljs-class .hljs-title{color:#e6c07b}.hljs-attr,.hljs-number,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-pseudo,.hljs-template-variable,.hljs-type,.hljs-variable{color:#d19a66}.hljs-bullet,.hljs-link,.hljs-meta,.hljs-selector-id,.hljs-symbol,.hljs-title{color:#61aeee}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}.hljs-link{text-decoration:underline}</style><h2 data-id="heading-0">告别旧生态：Ant Design 6 不再支持 IE 与现代前端趋势解读</h2>
<h3 data-id="heading-1">IE，你终于可以安息了</h3>
<p>2026 年，当 Ant Design 6.0 在发布日志里写下"不再支持 IE"这几个字的时候，全球前端开发者的朋友圈都在放烟花庆祝。这个曾经让无数程序员深夜加班、头发掉光的浏览器，终于在主流组件库的支持列表里除名了。说实话，IE 的离场就像那个总是拖后腿的队友终于退出了游戏——虽然有点不忍心，但大家心里都在默默喊"终于啊！"。回想起那些年为了兼容 IE 写的 polyfill、hack 代码和各种 CSS 前缀，就像是在用算盘跟别人比赛计算器，累不说，关键是根本赢不了。Ant Design 这次彻底放弃 IE 支持，背后的技术逻辑其实非常硬核：v6 全面转向 CSS Variables（CSS 自定义属性）作为样式系统的核心，而 IE 压根就不认识这玩意儿。以前 v5 为了照顾 IE，不得不在运行时用 JavaScript 动态计算和插入样式，这就好比你本来可以直接坐高铁，结果为了照顾一个坐绿皮火车的朋友，全程陪他慢慢晃悠。现在好了，IE 这个"绿皮火车"彻底停运，Ant Design 直接上了复兴号，零运行时开销、主题切换丝滑如德芙、首屏渲染速度起飞，这才是 2025 年该有的样子。更关键的是，微软自己都在 2022 年 6 月正式宣布 IE 退役，连亲爹都不管了，开源社区还陪着演什么"孝子贤孙"的戏码？数据也很说明问题：全球 IE 浏览器的市场份额已经跌到 0.5% 以下，这点用户量还不如某些小众浏览器。继续为这么点份额背负巨大的技术债务，就像是为了照顾一个从不点单的顾客，专门保留一整套厨房设备，这买卖怎么算都不划算。</p>
<h3 data-id="heading-2">CSS Variables 不是妥协，是降维打击</h3>
<p>很多人以为 Ant Design 6 放弃 CSS-in-JS 转向 CSS Variables 是一种"倒退"，这就大错特错了。这波操作不是回到过去，而是站在未来往回看——CSS Variables 配合现代浏览器的原生能力，已经能完成以前需要复杂 JavaScript 运行时才能实现的事情，而且性能吊打一切运行时方案。想象一下，v5 的 CSS-in-JS 方案就像是在浏览器里开了个"样式工厂"，每次渲染组件都要现场生产样式、打标签、插入 DOM，忙得不亦乐乎。而 v6 的 CSS Variables 方案呢？所有样式在构建时就已经生成好了，运行时只需要改改几个变量值，浏览器自己就能搞定一切。这就好比你从"现炒现卖"升级成了"预制菜加热"，虽然听起来没那么高大上，但效率高、成本低、还不容易翻车。实测数据显示，使用 CSS Variables 后，主题切换的性能提升了 300%，首屏样式注入时间减少了 60%，这可不是吹牛，是实打实的性能红利。更骚的操作是，CSS Variables 天然支持动态主题切换，你只需要改一个根元素的 data 属性或者几个 CSS 变量值，整个应用的主题瞬间切换，连眼睛都来不及眨。以前用 CSS-in-JS 做主题切换，要么重新渲染整个应用（卡到怀疑人生），要么搞一套复杂的 Context 传递机制（代码写到想骂人），现在呢？<code>document.documentElement.style.setProperty('--ant-color-primary', '#ff0000')</code>，一行代码搞定，丝滑得像是在作弊。而且 CSS Variables 还有个杀手锏：它是浏览器原生支持的，这意味着开发者工具可以直接调试、浏览器可以直接优化、甚至 CSS 预处理器都能无缝集成。这种"站在巨人肩膀上"的感觉，比自己造轮子爽太多了。</p>
<h3 data-id="heading-3">React 18+ 的硬性要求不是门槛，是入场券</h3>
<p>Ant Design 6 把最低 React 版本要求提到 18，这个决定在社区里引发了不小的讨论。有人觉得这是"强买强卖"，但懂行的人都知道，这是在给整个生态做减法。React 18 带来的并发特性（Concurrent Features）、自动批处理（Automatic Batching）、Suspense 增强等能力，已经不是"锦上添花"的级别，而是"不用就亏"的程度。Ant Design 6 全面拥抱这些特性，意味着组件库可以更智能地处理渲染优先级、更高效地批量更新状态、更优雅地处理异步数据加载。这就好比你开车，以前只能手动挡一档一档换，现在直接给你配了自动挡加智能驾驶辅助，你还非要坚持用手动挡吗？更重要的是，React 18 已经发布快三年了（2022 年 3 月发布），到 2025 年还没升级的项目，要么是历史包袱太重，要么是技术选型太保守。Ant Design 6 的这个硬性要求，其实是在倒逼整个生态往前走——你不升级 React 18，就享受不到 v6 的性能红利；你升级了 React 18，就会发现整个应用的响应速度和用户体验都上了一个台阶。这种"温柔的强制"，反而是对开发者负责的表现。而且别忘了，React 19 已经在路上了，Ant Design 6 提前做好了技术储备，等 React 19 正式发布，组件库可以无缝衔接新特性，不用再像以前那样"临时抱佛脚"。这种前瞻性的技术规划，才是一个成熟开源项目该有的样子。说白了，React 18+ 的要求不是在设置门槛，而是在发入场券——想进入现代前端开发的游乐场，这是最基本的装备。</p>
<h3 data-id="heading-4">零运行时的终极浪漫：性能与优雅的双赢</h3>
<p>如果要用一个词总结 Ant Design 6 的核心理念，那就是"零运行时"（Zero Runtime）。这个概念听起来很极客，但背后的哲学其实很朴素：能在编译时做的事情，就别留到运行时；能让浏览器原生处理的事情，就别用 JavaScript 瞎折腾。v6 的样式系统完全抛弃了运行时 CSS-in-JS，所有样式在构建阶段就已经生成为标准 CSS 文件，运行时只需要加载和应用，没有任何动态计算和插入的开销。这种设计带来的好处是全方位的：打包体积更小（不需要打包样式运行时库）、首屏加载更快（浏览器可以并行加载 CSS 和 JS）、运行时性能更好（没有样式计算和插入的开销）、服务端渲染更友好（不需要在服务端执行样式生成逻辑）。更绝的是，零运行时还意味着更好的开发体验——你可以直接在浏览器开发者工具里看到完整的 CSS 代码，可以用任何 CSS 调试工具分析样式，可以用传统的 CSS 方法论（BEM、OOCSS 等）组织代码，不用再跟那些"魔法般"的 CSS-in-JS 语法较劲。这就像是从一个黑盒系统回到了透明系统，虽然少了点"高科技"的神秘感，但多了十倍的可控性和可维护性。而且零运行时还有个隐藏福利：它让 Ant Design 的样式系统可以跟任何 CSS 工具链无缝集成，无论你用 Sass、Less、PostCSS 还是 Tailwind，都能和谐共处。这种开放性和兼容性，才是一个基础设施级别的组件库应该追求的目标。说到底，零运行时不是技术上的妥协，而是在性能和优雅之间找到了最佳平衡点——既要跑得快，又要跑得稳，还要让开发者看得懂、改得动，这才是真正的工程美学。</p>
<h3 data-id="heading-5">最后：拥抱变化，才能不被时代抛弃</h3>
<p>Ant Design 6 放弃 IE、拥抱 CSS Variables、要求 React 18+，这一系列"激进"的决定，本质上是在做一件事：卸下历史包袱，轻装上阵。前端技术的迭代速度快得吓人，三年前的最佳实践，今天可能就是技术债务；今天的前沿探索，明年可能就是行业标准。在这个快速变化的领域里，抱着旧技术不放就像是抱着诺基亚手机拒绝用智能机——你可以坚持自己的选择，但别怪时代没等你。Ant Design 6 的这次升级，给整个前端社区传递了一个明确的信号：是时候跟过去说再见了。那些为了兼容老旧浏览器而写的 hack 代码、那些为了支持旧版本 React 而保留的兼容逻辑、那些为了照顾少数用户而背负的性能负担，都可以放下了。2025 年的前端开发，应该是站在现代浏览器和现代框架的肩膀上，用最优雅的方式解决问题，而不是在历史的泥潭里挣扎。所以，当你看到 Ant Design 6 的更新日志时，与其纠结"为什么不支持 IE"，不如想想"我的项目什么时候能升级到 React 18"。毕竟，拥抱变化的人，才能不被时代抛弃。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[滑动窗口限流器的演进之路：从调度器实现到 Packed CAS]]></title>    <link>https://juejin.cn/post/7594642978695757887</link>    <guid>https://juejin.cn/post/7594642978695757887</guid>    <pubDate>2026-01-13T09:49:14.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7594642978695757887" data-draft-id="7594514040917868571" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="滑动窗口限流器的演进之路：从调度器实现到 Packed CAS"/> <meta itemprop="keywords" content="后端,性能优化,Java"/> <meta itemprop="datePublished" content="2026-01-13T09:49:14.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="桦说编程"/> <meta itemprop="url" content="https://juejin.cn/user/2212689394274136"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            滑动窗口限流器的演进之路：从调度器实现到 Packed CAS
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2212689394274136/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    桦说编程
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-13T09:49:14.000Z" title="Tue Jan 13 2026 09:49:14 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>笔者注意到很多介绍限流算法的文章没有提供线程安全的实现，希望此文能达到抛砖引玉的作用。本文记录了一个滑动窗口限流器的完整演进过程。我们将看到每一次改进背后的动机、实现细节，以及在高并发场景下暴露的问题。这不是一个"正确答案"的展示，而是一个思考和迭代的过程。</p>
</blockquote>
<h2 data-id="heading-0">问题背景</h2>
<p>限流是分布式系统中的基础能力。滑动窗口算法相比固定窗口，能够更平滑地控制流量，避免窗口边界的突发问题。</p>
<p>我们的目标是实现一个滑动窗口限流器，支持：</p>
<ul>
<li>可配置的时间粒度（tickMillis）</li>
<li>可配置的窗口大小（windowSize）</li>
<li>可配置的容量上限（capacity）</li>
</ul>
<hr/>
<h2 data-id="heading-1">第一版：Timer 驱动的实现</h2>
<h3 data-id="heading-2">设计思路</h3>
<p>最直观的想法是：用一个定时器周期性地推进窗口。每个 tick 到来时，保存当前计数，清理过期数据，重置计数器。业务线程只需要简单地递增计数并检查是否超限。</p>
<pre><code class="hljs language-scss" lang="scss">┌─────────────────────────────────────────────────────────┐
│                    TimerSlidingWindowRateLimiter        │
├─────────────────────────────────────────────────────────┤
│  ScheduledExecutorService  ──→  周期性调用 <span class="hljs-built_in">nextTick</span>()   │
│                                      │                  │
│                                      ↓                  │
│  WindowState { index, counter, preSum }                 │
│                                      ↑                  │
│  <span class="hljs-built_in">tryAcquire</span>()  ──────────────────────┘                  │
└─────────────────────────────────────────────────────────┘
</code></pre>
<h3 data-id="heading-3">实现</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Value</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TimerSlidingWindowRateLimiter</span> {
    <span class="hljs-type">int</span> tickMillis;
    <span class="hljs-type">int</span> windowSize;
    <span class="hljs-type">int</span> capacity;

    <span class="hljs-meta">@Getter</span>
    <span class="hljs-meta">@AllArgsConstructor</span>
    <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">WindowState</span> {
        <span class="hljs-keyword">final</span> <span class="hljs-type">long</span> index;
        <span class="hljs-keyword">final</span> AtomicInteger counter;
        <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> preSum;
    }

    AtomicReference&lt;WindowState&gt; cur = <span class="hljs-keyword">new</span> <span class="hljs-title class_">AtomicReference</span>&lt;&gt;(
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">WindowState</span>(<span class="hljs-number">0L</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">AtomicInteger</span>(<span class="hljs-number">0</span>), <span class="hljs-number">0</span>));
    Map&lt;Long, Integer&gt; map = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();  <span class="hljs-comment">// 单线程访问</span>
    <span class="hljs-type">ScheduledExecutorService</span> <span class="hljs-variable">executorService</span> <span class="hljs-operator">=</span> ...;

    <span class="hljs-keyword">void</span> <span class="hljs-title function_">start</span><span class="hljs-params">()</span> {
        executorService.scheduleAtFixedRate(
            () -&gt; cur.updateAndGet(<span class="hljs-built_in">this</span>::nextTick),
            tickMillis, tickMillis, TimeUnit.MILLISECONDS);
    }

    <span class="hljs-keyword">private</span> WindowState <span class="hljs-title function_">nextTick</span><span class="hljs-params">(WindowState pre)</span> {
        <span class="hljs-type">long</span> <span class="hljs-variable">index</span> <span class="hljs-operator">=</span> pre.getIndex();
        <span class="hljs-type">int</span> <span class="hljs-variable">count</span> <span class="hljs-operator">=</span> pre.getCounter().get();
        <span class="hljs-type">Integer</span> <span class="hljs-variable">toRemove</span> <span class="hljs-operator">=</span> map.remove(index - windowSize);
        <span class="hljs-type">int</span> <span class="hljs-variable">newPre</span> <span class="hljs-operator">=</span> count + pre.getPreSum() - (toRemove == <span class="hljs-literal">null</span> ? <span class="hljs-number">0</span> : toRemove);
        map.put(index, count);
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">WindowState</span>(index + <span class="hljs-number">1</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">AtomicInteger</span>(<span class="hljs-number">0</span>), newPre);
    }

    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">tryAcquire</span><span class="hljs-params">()</span> {
        <span class="hljs-type">WindowState</span> <span class="hljs-variable">curState</span> <span class="hljs-operator">=</span> cur.get();
        <span class="hljs-type">AtomicInteger</span> <span class="hljs-variable">counter</span> <span class="hljs-operator">=</span> curState.getCounter();
        <span class="hljs-type">int</span> <span class="hljs-variable">preSum</span> <span class="hljs-operator">=</span> curState.getPreSum();

        <span class="hljs-keyword">if</span> (counter.get() + preSum &gt;= capacity) {
            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
        }
        counter.incrementAndGet();
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    }
}
</code></pre>
<h3 data-id="heading-4">问题：Check-Then-Act 竞态条件</h3>
<p>这个实现看起来合理，但在高并发下存在严重的 bug。问题出在 <code>tryAcquire()</code> 方法：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 线程 A 和 B 同时执行</span>
<span class="hljs-keyword">if</span> (counter.get() + preSum &gt;= capacity) {  <span class="hljs-comment">// 两者都读到 99</span>
    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
}
counter.incrementAndGet();  <span class="hljs-comment">// 两者都执行，计数变成 101！</span>
<span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
</code></pre>
<p>这是典型的 <strong>check-then-act</strong> 竞态条件：检查和操作不是原子的，多个线程可以同时通过检查，导致超限。</p>
<hr/>
<h2 data-id="heading-5">第一次改进：使用 updateAndGet 实现原子性</h2>
<h3 data-id="heading-6">修复思路</h3>
<p>我们需要将"检查"和"递增"合并为一个原子操作。<code>AtomicInteger.updateAndGet()</code> 正好提供了这个能力：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">tryAcquire</span><span class="hljs-params">()</span> {
    <span class="hljs-type">WindowState</span> <span class="hljs-variable">curState</span> <span class="hljs-operator">=</span> cur.get();
    <span class="hljs-type">AtomicInteger</span> <span class="hljs-variable">counter</span> <span class="hljs-operator">=</span> curState.getCounter();
    <span class="hljs-type">int</span> <span class="hljs-variable">preSum</span> <span class="hljs-operator">=</span> curState.getPreSum();

    <span class="hljs-type">boolean</span>[] acquired = {<span class="hljs-literal">false</span>};
    counter.updateAndGet(current -&gt; {
        <span class="hljs-keyword">if</span> (current + preSum &gt;= capacity) {
            <span class="hljs-keyword">return</span> current;  <span class="hljs-comment">// 不修改</span>
        }
        acquired[<span class="hljs-number">0</span>] = <span class="hljs-literal">true</span>;
        <span class="hljs-keyword">return</span> current + <span class="hljs-number">1</span>;  <span class="hljs-comment">// 原子递增</span>
    });
    <span class="hljs-keyword">return</span> acquired[<span class="hljs-number">0</span>];
}
</code></pre>
<p>现在检查和递增是原子的，不会再出现超限问题。</p>
<h3 data-id="heading-7">遗留问题</h3>
<p>Timer 实现有一个固有的问题：<strong>需要管理线程生命周期</strong>。如果限流器是短生命周期的（比如每个请求创建一个），定时器线程会造成资源泄漏。我们能否避免使用定时器？</p>
<hr/>
<h2 data-id="heading-8">第二版：懒计算的实现</h2>
<h3 data-id="heading-9">设计思路</h3>
<p>定时器的作用是推进窗口，但我们真的需要它吗？窗口只在 <code>tryAcquire()</code> 时才需要是计算的。我们可以在每次调用时，根据当前时间<strong>按需滑动</strong>窗口。</p>
<pre><code class="hljs language-scss" lang="scss">┌─────────────────────────────────────────────────────────┐
│                 LazySlidingWindowRateLimiter            │
├─────────────────────────────────────────────────────────┤
│  <span class="hljs-built_in">tryAcquire</span>()                                           │
│      │                                                  │
│      ├──→ 计算 currentIndex = (now - start) / tick     │
│      │                                                  │
│      ├──→ 需要滑动? cur<span class="hljs-selector-class">.updateAndGet</span>(advanceToIndex)   │
│      │                                                  │
│      └──→ counter<span class="hljs-selector-class">.updateAndGet</span>(check-then-increment)   │
└─────────────────────────────────────────────────────────┘
</code></pre>
<h3 data-id="heading-10">实现</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Value</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">LazySlidingWindowRateLimiter</span> {
    <span class="hljs-type">int</span> tickMillis;
    <span class="hljs-type">int</span> windowSize;
    <span class="hljs-type">int</span> capacity;

    <span class="hljs-type">long</span> <span class="hljs-variable">startTime</span> <span class="hljs-operator">=</span> System.currentTimeMillis();
    AtomicReference&lt;WindowState&gt; cur = <span class="hljs-keyword">new</span> <span class="hljs-title class_">AtomicReference</span>&lt;&gt;(...);
    ConcurrentHashMap&lt;Long, Integer&gt; map = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConcurrentHashMap</span>&lt;&gt;();

    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">tryAcquire</span><span class="hljs-params">()</span> {
        <span class="hljs-type">long</span> <span class="hljs-variable">currentIndex</span> <span class="hljs-operator">=</span> (System.currentTimeMillis() - startTime) / tickMillis;

        <span class="hljs-comment">// CAS 更新窗口状态</span>
        <span class="hljs-type">WindowState</span> <span class="hljs-variable">curState</span> <span class="hljs-operator">=</span> cur.updateAndGet(state -&gt; {
            <span class="hljs-keyword">if</span> (state.getIndex() &gt;= currentIndex) {
                <span class="hljs-keyword">return</span> state;
            }
            <span class="hljs-keyword">return</span> advanceToIndex(state, currentIndex);
        });

        <span class="hljs-comment">// 原子化 check-then-increment</span>
        <span class="hljs-type">AtomicInteger</span> <span class="hljs-variable">counter</span> <span class="hljs-operator">=</span> curState.getCounter();
        <span class="hljs-type">int</span> <span class="hljs-variable">preSum</span> <span class="hljs-operator">=</span> curState.getPreSum();
        <span class="hljs-type">boolean</span>[] acquired = {<span class="hljs-literal">false</span>};
        counter.updateAndGet(current -&gt; {
            <span class="hljs-keyword">if</span> (current + preSum &gt;= capacity) {
                <span class="hljs-keyword">return</span> current;
            }
            acquired[<span class="hljs-number">0</span>] = <span class="hljs-literal">true</span>;
            <span class="hljs-keyword">return</span> current + <span class="hljs-number">1</span>;
        });
        <span class="hljs-keyword">return</span> acquired[<span class="hljs-number">0</span>];
    }

    <span class="hljs-keyword">private</span> WindowState <span class="hljs-title function_">advanceToIndex</span><span class="hljs-params">(WindowState state, <span class="hljs-type">long</span> targetIndex)</span> {
        map.put(state.getIndex(), state.getCounter().get());
        <span class="hljs-type">long</span> <span class="hljs-variable">minValidIndex</span> <span class="hljs-operator">=</span> targetIndex - windowSize;
        map.keySet().removeIf(key -&gt; key &lt; minValidIndex);
        <span class="hljs-type">int</span> <span class="hljs-variable">preSum</span> <span class="hljs-operator">=</span> map.values().stream().mapToInt(Integer::intValue).sum();
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">WindowState</span>(targetIndex, <span class="hljs-keyword">new</span> <span class="hljs-title class_">AtomicInteger</span>(<span class="hljs-number">0</span>), preSum);
    }
}
</code></pre>
<h3 data-id="heading-11">优势</h3>
<ul>
<li><strong>无后台线程</strong>：用完即弃，无资源泄漏风险</li>
<li><strong>资源友好</strong>：适合资源敏感场景</li>
</ul>
<h3 data-id="heading-12">问题：窗口切换时的计数丢失</h3>
<p>懒计算解决了线程管理问题，但引入了新的并发问题。考虑这个场景：</p>
<pre><code class="hljs language-css" lang="css">时刻 T: 窗口即将从 index=<span class="hljs-number">5</span> 切换到 index=<span class="hljs-number">6</span>

Thread A: 读取 state = {index=<span class="hljs-number">5</span>, counter=<span class="hljs-number">10</span>, preSum=<span class="hljs-number">80</span>}
Thread <span class="hljs-selector-tag">A</span>: 准备执行 <span class="hljs-built_in">advanceToIndex</span>()
                                    Thread B: counter.<span class="hljs-built_in">incrementAndGet</span>() → <span class="hljs-number">11</span>
Thread A: map.<span class="hljs-built_in">put</span>(<span class="hljs-number">5</span>, <span class="hljs-number">10</span>)  ← 丢失了 Thread B 的计数！
Thread A: 返回新 state = {index=<span class="hljs-number">6</span>, counter=<span class="hljs-number">0</span>, preSum=<span class="hljs-number">90</span>}
</code></pre>
<p>问题的根源在于：<strong><code>counter</code> 是可变的 <code>AtomicInteger</code></strong>。当我们读取它的值准备保存时，其他线程仍然可以修改它。</p>
<p>这个问题在 Timer 版本中不存在，因为 <code>nextTick()</code> 由单个定时器线程执行，不会与业务线程并发修改。</p>
<hr/>
<h2 data-id="heading-13">第三版：不可变状态的 CAS 实现</h2>
<h3 data-id="heading-14">设计思路</h3>
<p>要彻底解决计数丢失问题，我们需要让<strong>整个状态不可变</strong>。任何修改都通过创建新状态 + CAS 更新来实现。</p>
<p>关键洞察：如果 <code>counter</code> 是不可变的 <code>int</code> 而非 <code>AtomicInteger</code>，那么在读取瞬间，状态就被"冻结"了。任何后续的修改都必须通过 CAS 整个 <code>WindowState</code>，失败的线程会重试并看到最新状态。</p>
<pre><code class="hljs language-objectivec" lang="objectivec">┌─────────────────────────────────────────────────────────┐
│                 CasSlidingWindowRateLimiter             │
├─────────────────────────────────────────────────────────┤
│  WindowState (IMMUTABLE)                                │
│  ├── index: <span class="hljs-type">long</span>                                        │
│  ├── counter: <span class="hljs-type">int</span>      ← 历史 tick 计数总和             │
│  └── tickCounter: <span class="hljs-type">int</span>  ← 当前 tick 计数                 │
│                                                         │
│  所有修改 = 创建新对象 + <span class="hljs-built_in">CAS</span> 更新 AtomicReference       │
└─────────────────────────────────────────────────────────┘
</code></pre>
<h3 data-id="heading-15">实现</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Value</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CasSlidingWindowRateLimiter</span> {
    <span class="hljs-type">int</span> tickMillis;
    <span class="hljs-type">int</span> windowSize;
    <span class="hljs-type">int</span> capacity;

    <span class="hljs-meta">@Getter</span>
    <span class="hljs-meta">@With</span>
    <span class="hljs-meta">@AllArgsConstructor</span>
    <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">WindowState</span> {
        <span class="hljs-keyword">final</span> <span class="hljs-type">long</span> index;
        <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> counter;      <span class="hljs-comment">// 窗口内历史 tick 的计数总和</span>
        <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> tickCounter;  <span class="hljs-comment">// 当前 tick 的计数</span>

        <span class="hljs-type">int</span> <span class="hljs-title function_">total</span><span class="hljs-params">()</span> {
            <span class="hljs-keyword">return</span> counter + tickCounter;
        }

        WindowState <span class="hljs-title function_">increment</span><span class="hljs-params">()</span> {
            <span class="hljs-keyword">return</span> withTickCounter(tickCounter + <span class="hljs-number">1</span>);
        }
    }

    <span class="hljs-type">long</span> <span class="hljs-variable">startTime</span> <span class="hljs-operator">=</span> System.currentTimeMillis();
    AtomicReference&lt;WindowState&gt; cur = <span class="hljs-keyword">new</span> <span class="hljs-title class_">AtomicReference</span>&lt;&gt;(<span class="hljs-keyword">new</span> <span class="hljs-title class_">WindowState</span>(<span class="hljs-number">0L</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>));
    ConcurrentHashMap&lt;Long, Integer&gt; map = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConcurrentHashMap</span>&lt;&gt;();

    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">tryAcquire</span><span class="hljs-params">()</span> {
        <span class="hljs-type">long</span> <span class="hljs-variable">currentIndex</span> <span class="hljs-operator">=</span> (System.currentTimeMillis() - startTime) / tickMillis;

        <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) {
            <span class="hljs-type">WindowState</span> <span class="hljs-variable">state</span> <span class="hljs-operator">=</span> cur.get();

            <span class="hljs-comment">// 需要滑动窗口</span>
            <span class="hljs-keyword">if</span> (state.getIndex() &lt; currentIndex) {
                <span class="hljs-type">WindowState</span> <span class="hljs-variable">newState</span> <span class="hljs-operator">=</span> advanceToIndex(state, currentIndex);
                <span class="hljs-keyword">if</span> (!cur.compareAndSet(state, newState)) {
                    <span class="hljs-keyword">continue</span>;  <span class="hljs-comment">// CAS 失败，重试</span>
                }
                state = newState;
            }

            <span class="hljs-comment">// 检查是否超限</span>
            <span class="hljs-keyword">if</span> (state.total() &gt;= capacity) {
                <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
            }

            <span class="hljs-comment">// CAS +1</span>
            <span class="hljs-keyword">if</span> (cur.compareAndSet(state, state.increment())) {
                <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
            }
            <span class="hljs-comment">// CAS 失败，重试整个循环</span>
        }
    }

    <span class="hljs-keyword">private</span> WindowState <span class="hljs-title function_">advanceToIndex</span><span class="hljs-params">(WindowState state, <span class="hljs-type">long</span> targetIndex)</span> {
        <span class="hljs-type">int</span> <span class="hljs-variable">tickCounter</span> <span class="hljs-operator">=</span> state.getTickCounter();
        <span class="hljs-keyword">if</span> (tickCounter &gt; <span class="hljs-number">0</span>) {
            map.put(state.getIndex(), tickCounter);
        }

        <span class="hljs-type">long</span> <span class="hljs-variable">minValidIndex</span> <span class="hljs-operator">=</span> targetIndex - windowSize;
        <span class="hljs-type">int</span> <span class="hljs-variable">newCounter</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;
        Iterator&lt;Map.Entry&lt;Long, Integer&gt;&gt; it = map.entrySet().iterator();
        <span class="hljs-keyword">while</span> (it.hasNext()) {
            Map.Entry&lt;Long, Integer&gt; entry = it.next();
            <span class="hljs-keyword">if</span> (entry.getKey() &lt; minValidIndex) {
                it.remove();
            } <span class="hljs-keyword">else</span> {
                newCounter += entry.getValue();
            }
        }

        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">WindowState</span>(targetIndex, newCounter, <span class="hljs-number">0</span>);
    }
}
</code></pre>
<h3 data-id="heading-16">为什么这样能避免计数丢失？</h3>
<pre><code class="hljs language-perl" lang="perl">时刻 T: 窗口即将从 <span class="hljs-keyword">index</span>=<span class="hljs-number">5</span> 切换到 <span class="hljs-keyword">index</span>=<span class="hljs-number">6</span>

Thread A: <span class="hljs-keyword">state</span> = {<span class="hljs-keyword">index</span>=<span class="hljs-number">5</span>, counter=<span class="hljs-number">80</span>, tickCounter=<span class="hljs-number">10</span>}
Thread A: 计算 newState = {<span class="hljs-keyword">index</span>=<span class="hljs-number">6</span>, counter=<span class="hljs-number">90</span>, tickCounter=<span class="hljs-number">0</span>}
                                    Thread B: 读取同一个 <span class="hljs-keyword">state</span>
                                    Thread B: CAS(<span class="hljs-keyword">state</span> → {<span class="hljs-number">5</span>, <span class="hljs-number">80</span>, <span class="hljs-number">11</span>}) ✓
Thread A: CAS(<span class="hljs-keyword">state</span> → newState) ✗ 失败！<span class="hljs-keyword">state</span> 已被 B 修改
Thread A: 重试，读取新 <span class="hljs-keyword">state</span> = {<span class="hljs-keyword">index</span>=<span class="hljs-number">5</span>, counter=<span class="hljs-number">80</span>, tickCounter=<span class="hljs-number">11</span>}
Thread A: 重新计算 newState，包含 B 的计数
</code></pre>
<p>关键点：</p>
<ol>
<li><strong>状态不可变</strong>：一旦创建，永不修改</li>
<li><strong>CAS 保证原子性</strong>：要么整体成功，要么整体失败</li>
<li><strong>失败重试</strong>：使用最新状态重新计算</li>
</ol>
<h3 data-id="heading-17">问题：频繁对象创建</h3>
<p>每次 <code>increment()</code> 都创建新的 <code>WindowState</code> 对象。在高并发下，这会造成：</p>
<ul>
<li><strong>GC 压力</strong>：大量短生命周期对象</li>
<li><strong>内存带宽</strong>：对象分配和复制的开销</li>
</ul>
<pre><code class="hljs language-erlang" lang="erlang"><span class="hljs-number">10</span> 线程，<span class="hljs-number">100</span>万次 <span class="hljs-keyword">try</span>Acquire
├── <span class="hljs-number">100</span>万次 WindowState 创建（成功的）
├── 可能数倍的失败重试（每次也创建对象）
└── 频繁的 Young GC
</code></pre>
<hr/>
<h2 data-id="heading-18">第四版：Packed Long 实现</h2>
<h3 data-id="heading-19">设计思路</h3>
<p><code>WindowState</code> 有三个字段：<code>index</code>（long）、<code>counter</code>（int）、<code>tickCounter</code>（int）。我们可以把它们<strong>打包进一个 long</strong>：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-number">64</span> bits:
┌────────────────────────┬────────────┬────────────┐
│     index (<span class="hljs-number">32</span> bits)    │<span class="hljs-built_in">counter</span>(<span class="hljs-number">16</span>) │<span class="hljs-built_in">tickCtr</span>(<span class="hljs-number">16</span>) │
│       bits <span class="hljs-number">32</span>-<span class="hljs-number">63</span>       │ bits <span class="hljs-number">16</span>-<span class="hljs-number">31</span> │ bits <span class="hljs-number">0</span>-<span class="hljs-number">15</span>  │
└────────────────────────┴────────────┴────────────┘
</code></pre>
<p>这样，<code>increment()</code> 操作变成简单的 <code>state + 1</code>（因为 tickCounter 在低 16 位），完全避免对象创建。</p>
<h3 data-id="heading-20">实现</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Value</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PackedCasSlidingWindowRateLimiter</span> {
    <span class="hljs-type">int</span> tickMillis;
    <span class="hljs-type">int</span> windowSize;
    <span class="hljs-type">int</span> capacity;

    <span class="hljs-type">long</span> <span class="hljs-variable">startTime</span> <span class="hljs-operator">=</span> System.currentTimeMillis();
    <span class="hljs-type">AtomicLong</span> <span class="hljs-variable">state</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AtomicLong</span>(<span class="hljs-number">0L</span>);
    AtomicLongArray ring;  <span class="hljs-comment">// 环形数组</span>

    <span class="hljs-comment">// ==================== 位操作 ====================</span>

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">INDEX_SHIFT</span> <span class="hljs-operator">=</span> <span class="hljs-number">32</span>;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">COUNTER_SHIFT</span> <span class="hljs-operator">=</span> <span class="hljs-number">16</span>;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">long</span> <span class="hljs-variable">COUNTER_MASK</span> <span class="hljs-operator">=</span> <span class="hljs-number">0xFFFF</span>;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">long</span> <span class="hljs-variable">TICK_COUNTER_MASK</span> <span class="hljs-operator">=</span> <span class="hljs-number">0xFFFF</span>;

    <span class="hljs-keyword">static</span> <span class="hljs-type">long</span> <span class="hljs-title function_">getIndex</span><span class="hljs-params">(<span class="hljs-type">long</span> state)</span> {
        <span class="hljs-keyword">return</span> state &gt;&gt;&gt; INDEX_SHIFT;
    }

    <span class="hljs-keyword">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getCounter</span><span class="hljs-params">(<span class="hljs-type">long</span> state)</span> {
        <span class="hljs-keyword">return</span> (<span class="hljs-type">int</span>) ((state &gt;&gt;&gt; COUNTER_SHIFT) &amp; COUNTER_MASK);
    }

    <span class="hljs-keyword">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getTickCounter</span><span class="hljs-params">(<span class="hljs-type">long</span> state)</span> {
        <span class="hljs-keyword">return</span> (<span class="hljs-type">int</span>) (state &amp; TICK_COUNTER_MASK);
    }

    <span class="hljs-keyword">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getTotal</span><span class="hljs-params">(<span class="hljs-type">long</span> state)</span> {
        <span class="hljs-keyword">return</span> getCounter(state) + getTickCounter(state);
    }

    <span class="hljs-keyword">static</span> <span class="hljs-type">long</span> <span class="hljs-title function_">pack</span><span class="hljs-params">(<span class="hljs-type">long</span> index, <span class="hljs-type">int</span> counter, <span class="hljs-type">int</span> tickCounter)</span> {
        <span class="hljs-keyword">return</span> (index &lt;&lt; INDEX_SHIFT) | ((<span class="hljs-type">long</span>) counter &lt;&lt; COUNTER_SHIFT) | tickCounter;
    }

    <span class="hljs-keyword">static</span> <span class="hljs-type">long</span> <span class="hljs-title function_">increment</span><span class="hljs-params">(<span class="hljs-type">long</span> state)</span> {
        <span class="hljs-keyword">return</span> state + <span class="hljs-number">1</span>;  <span class="hljs-comment">// tickCounter 在低位，直接 +1</span>
    }

    <span class="hljs-comment">// ==================== 核心逻辑 ====================</span>

    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">tryAcquire</span><span class="hljs-params">()</span> {
        <span class="hljs-type">long</span> <span class="hljs-variable">currentIndex</span> <span class="hljs-operator">=</span> (System.currentTimeMillis() - startTime) / tickMillis;

        <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) {
            <span class="hljs-type">long</span> <span class="hljs-variable">curState</span> <span class="hljs-operator">=</span> state.get();
            <span class="hljs-type">long</span> <span class="hljs-variable">stateIndex</span> <span class="hljs-operator">=</span> getIndex(curState);

            <span class="hljs-keyword">if</span> (stateIndex &lt; currentIndex) {
                <span class="hljs-type">long</span> <span class="hljs-variable">newState</span> <span class="hljs-operator">=</span> advanceToIndex(curState, currentIndex);
                <span class="hljs-keyword">if</span> (!state.compareAndSet(curState, newState)) {
                    <span class="hljs-keyword">continue</span>;
                }
                curState = newState;
            }

            <span class="hljs-keyword">if</span> (getTotal(curState) &gt;= capacity) {
                <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
            }

            <span class="hljs-keyword">if</span> (state.compareAndSet(curState, increment(curState))) {
                <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
            }
        }
    }
}
</code></pre>
<h3 data-id="heading-21">存储优化：环形数组替代 HashMap</h3>
<p><code>ConcurrentHashMap</code> 有额外的内存开销（Entry 对象、哈希桶等），而且需要显式删除过期数据。</p>
<p>观察：我们的窗口大小是固定的，只需要存储最近 <code>windowSize</code> 个 tick 的数据。这正是<strong>环形数组</strong>的完美场景：</p>
<pre><code class="hljs language-ini" lang="ini">Ring Buffer (AtomicLongArray):
┌─────────┬─────────┬─────────┬─────────┬─────────┐
│ slot<span class="hljs-section">[0]</span> │ slot<span class="hljs-section">[1]</span> │ slot<span class="hljs-section">[2]</span> │  ...    │slot<span class="hljs-section">[n-1]</span>│
└─────────┴─────────┴─────────┴─────────┴─────────┘
     ↑
  index % windowSize

每个槽位 (64 bits):
┌────────────────────────────────────┬────────────┐
│         index (48 bits)            │ count (16) │
└────────────────────────────────────┴────────────┘
</code></pre>
<p>关键优势：</p>
<ul>
<li><strong>无需显式删除</strong>：新数据自动覆盖旧槽位</li>
<li><strong>固定内存</strong>：<code>windowSize * 8</code> 字节</li>
<li><strong>零 GC</strong>：没有对象分配</li>
</ul>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">private</span> <span class="hljs-type">long</span> <span class="hljs-title function_">advanceToIndex</span><span class="hljs-params">(<span class="hljs-type">long</span> curState, <span class="hljs-type">long</span> targetIndex)</span> {
    <span class="hljs-comment">// 存储当前 tick 的计数</span>
    <span class="hljs-type">int</span> <span class="hljs-variable">tickCounter</span> <span class="hljs-operator">=</span> getTickCounter(curState);
    <span class="hljs-type">long</span> <span class="hljs-variable">curIndex</span> <span class="hljs-operator">=</span> getIndex(curState);
    <span class="hljs-keyword">if</span> (tickCounter &gt; <span class="hljs-number">0</span>) {
        <span class="hljs-type">int</span> <span class="hljs-variable">slot</span> <span class="hljs-operator">=</span> (<span class="hljs-type">int</span>) (curIndex % windowSize);
        ring.set(slot, packSlot(curIndex, tickCounter));
    }

    <span class="hljs-comment">// 遍历环形数组，只计算有效范围内的数据</span>
    <span class="hljs-type">long</span> <span class="hljs-variable">minValidIndex</span> <span class="hljs-operator">=</span> targetIndex - windowSize;
    <span class="hljs-type">int</span> <span class="hljs-variable">newCounter</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;
    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; windowSize; i++) {
        <span class="hljs-type">long</span> <span class="hljs-variable">slotValue</span> <span class="hljs-operator">=</span> ring.get(i);
        <span class="hljs-type">long</span> <span class="hljs-variable">slotIndex</span> <span class="hljs-operator">=</span> getSlotIndex(slotValue);
        <span class="hljs-keyword">if</span> (slotIndex &gt;= minValidIndex &amp;&amp; slotIndex &lt; targetIndex) {
            newCounter += getSlotCount(slotValue);
        }
    }

    <span class="hljs-keyword">return</span> pack(targetIndex, newCounter, <span class="hljs-number">0</span>);
}
</code></pre>
<hr/>
<h2 data-id="heading-22">最终对比</h2>
<h3 data-id="heading-23">代码复杂度</h3>



































<table><thead><tr><th>版本</th><th>核心数据结构</th><th>并发控制</th><th>代码行数</th></tr></thead><tbody><tr><td>Timer</td><td>WindowState + HashMap</td><td>AtomicInteger.updateAndGet</td><td>~80</td></tr><tr><td>Lazy</td><td>WindowState + ConcurrentHashMap</td><td>AtomicReference.updateAndGet + AtomicInteger.updateAndGet</td><td>~90</td></tr><tr><td>CAS</td><td>WindowState (immutable) + ConcurrentHashMap</td><td>AtomicReference CAS loop</td><td>~100</td></tr><tr><td>Packed</td><td>long + AtomicLongArray</td><td>AtomicLong CAS loop</td><td>~120</td></tr></tbody></table>
<h3 data-id="heading-24">并发正确性</h3>









































<table><thead><tr><th>版本</th><th>Check-Then-Act</th><th>计数丢失</th><th>状态一致性</th></tr></thead><tbody><tr><td>Timer (原始)</td><td>❌ 有问题</td><td>✅ 无问题</td><td>✅</td></tr><tr><td>Timer (修复后)</td><td>✅</td><td>✅</td><td>✅</td></tr><tr><td>Lazy</td><td>✅</td><td>❌ 有问题</td><td>✅</td></tr><tr><td>CAS</td><td>✅</td><td>✅</td><td>✅</td></tr><tr><td>Packed</td><td>✅</td><td>✅</td><td>✅</td></tr></tbody></table>
<h3 data-id="heading-25">性能特征</h3>















































<table><thead><tr><th>维度</th><th>Timer</th><th>Lazy</th><th>CAS</th><th>Packed</th></tr></thead><tbody><tr><td>吞吐量</td><td>高</td><td>中</td><td>中低</td><td>高</td></tr><tr><td>延迟稳定性</td><td>好</td><td>有毛刺</td><td>有毛刺</td><td>有毛刺</td></tr><tr><td>GC 压力</td><td>低</td><td>中</td><td>高</td><td><strong>零</strong></td></tr><tr><td>内存占用</td><td>动态</td><td>动态</td><td>动态</td><td><strong>固定</strong></td></tr><tr><td>资源泄漏风险</td><td>有</td><td>无</td><td>无</td><td>无</td></tr></tbody></table>
<h3 data-id="heading-26">适用场景</h3>
<pre><code class="hljs language-objectivec" lang="objectivec">Timer 实现:
  ✓ 长时间运行的服务
  ✓ 对延迟稳定性要求高
  ✗ 需要管理线程生命周期

Lazy 实现:
  ✓ 短生命周期限流器
  ✗ 高并发下有计数丢失风险（不推荐生产使用）

<span class="hljs-built_in">CAS</span> 实现:
  ✓ 正确性保证最强
  ✓ 代码可读性好
  ✗ GC 压力大

Packed 实现:
  ✓ 零 GC
  ✓ 固定内存
  ✓ 高吞吐
  ✗ 代码可读性差（位操作）
  ✗ 容量限制（<span class="hljs-number">65535</span>）
</code></pre>
<hr/>
<h2 data-id="heading-27">结语</h2>
<p>这次演进展示了并发编程的几个核心教训：</p>
<ol>
<li>
<p><strong>Check-Then-Act 是并发 bug 的温床</strong>。始终问自己：检查和操作之间，状态会被其他线程修改吗？</p>
</li>
<li>
<p><strong>可变共享状态是万恶之源</strong>。<code>AtomicInteger</code> 看起来是线程安全的，但当它作为复合状态的一部分时，仍然会出问题。</p>
</li>
<li>
<p><strong>不可变性是并发的银弹</strong>。当状态不可变时，读取就是安全的，修改变成"创建新版本"，CAS 保证原子性。</p>
</li>
<li>
<p><strong>性能优化有代价</strong>。Packed 实现虽然消除了 GC 压力，但牺牲了可读性。选择哪个版本，取决于你的具体场景。</p>
</li>
</ol>
<p>最后，没有"最好"的实现，只有"最适合"的实现。理解每个版本的权衡，才能在实际工程中做出正确的选择。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[彻底改变你与 AI 编码方式的五个新范式]]></title>    <link>https://juejin.cn/post/7594661351512932387</link>    <guid>https://juejin.cn/post/7594661351512932387</guid>    <pubDate>2026-01-13T09:53:45.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7594661351512932387" data-draft-id="7594667893015855119" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="彻底改变你与 AI 编码方式的五个新范式"/> <meta itemprop="keywords" content="Cursor"/> <meta itemprop="datePublished" content="2026-01-13T09:53:45.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="程序猿DD"/> <meta itemprop="url" content="https://juejin.cn/user/131597123993358"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            彻底改变你与 AI 编码方式的五个新范式
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/131597123993358/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    程序猿DD
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-13T09:53:45.000Z" title="Tue Jan 13 2026 09:53:45 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>AI 编码助手正以前所未有的速度改变着软件开发。它们可以连续工作数小时，完成复杂的多文件重构，甚至能持续迭代直到所有测试通过。然而，许多开发者都有一种共同的感受：尽管这些工具功能强大，但有时却令人沮丧，难以达到预期。我们常常陷入不断修正 Prompt 的循环，结果却不尽人意。</p>
<p>问题或许不在于 Prompt 写得不够好。要真正释放 AI 编程助手的潜力，关键在于采纳一套全新的工作流和协作范式。仅仅把它当作一个代码生成器，会错失其真正的价值。这篇文章将为你提炼 Cursor 团队内部总结的最具影响力和启发性的最佳实践，帮助你从简单的“提问-回答”模式，转变为与 AI 高效协作，共同构建软件的全新境界。</p>
<p><img src="https://static.didispace.com/images4/15cd55c116d17c09ca8a27266d391c91.png" alt="ce20b0ace6b8d33ebd7e8902aded10ec.png" loading="lazy"/></p>
<h2 data-id="heading-0">技巧 1：先规划，再执行：宁可重来，不要修补</h2>
<p>在与 AI 协作时，你能做的最大、最有效的改变，就是在生成任何代码之前先进行规划。芝加哥大学的一项研究发现，经验丰富的开发者更倾向于在动手前制定计划。一个清晰的计划不仅能帮助你理清思路，更能为 AI Agent 提供一个明确、可执行的目标。</p>
<p>Cursor 为此专门设计了“Plan 模式”。在输入框中，Agent 不会立即动手写代码，而是遵循四个步骤：首先，分析你的代码库以找到相关文件；其次，就你的需求提出澄清问题；接着，创建一个包含文件路径和代码细节的详细实现计划；最后，等待你的确认后才开始构建。这个计划本身就是一个 Markdown 文件，你可以直接编辑，删除多余步骤或补充 Agent 遗漏的上下文。</p>
<p>这里有一个反直觉但至关重要的建议：当 Agent 生成的代码不符合预期时，抵制住用后续提示去“修补”它的冲动。更高效、更整洁的做法是：直接回滚所有改动，回到计划本身，细化你的需求，然后让 Agent 重新运行一次。这通常比在一个错误的方向上反复修正要快得多，并且最终得到的代码质量也更高。</p>
<h2 data-id="heading-1">技巧 2：上下文管理是一门艺术：少即是多</h2>
<p>一个令人惊讶的原则是：你并不需要手动为 AI 提供每一个可能相关的文件。像 Cursor 这样的现代 Agent 配备了强大的工具，如 grep 和语义搜索，能够自己寻找所需的上下文。当你提出一个类似“身份验证流程”的模糊请求时，它能主动在代码库中定位相关文件。</p>
<p>因此，最佳实践是：如果你明确知道需要哪个文件，就在提示中引用它；如果你不确定，就让 Agent 自己去找。一股脑地塞入不相关的上下文，反而会干扰 Agent，让它难以判断哪些信息才是真正重要的。Cursor 的 Agent 甚至提供了 @Branch 这样的实用工具，让你可以轻松地将当前 Git 分支的上下文提供给 Agent，只需一句‘Review the changes on this branch’，就能让它快速进入你的工作状态。</p>
<p>另一个常见问题是：什么时候应该开始新的对话？</p>
<ul>
<li>在以下情况下开始新对话：
<ul>
<li>你要切换到一个不同的任务或功能。</li>
<li>Agent 看起来很困惑，或者总是在犯同样的错误。</li>
<li>你已经完成了一个逻辑完整的工作单元。</li>
</ul>
</li>
<li>在以下情况下继续当前对话：
<ul>
<li>你还在对同一个功能进行迭代。</li>
<li>Agent 需要用到先前讨论中的上下文。</li>
<li>你正在调试它刚刚构建出来的内容。</li>
</ul>
</li>
</ul>
<p>之所以要适时开启新对话，是因为过长的对话会累积“噪音”，导致 Agent 失去焦点，被不相关的历史信息干扰。当你感觉 Agent 的表现开始下降时，通常就是一个开启新对话的好时机。</p>
<h2 data-id="heading-2">技巧 3：自动化你的自动化：用 Rules 和 Skills 打造专属工作流</h2>
<p>为了让 Agent 更深度地融入你的工作流，Cursor 提供了两种强大的自定义方式：Rules（规则）提供静态的、始终生效的上下文，而 Skills（技能）则提供动态的、按需调用的能力。</p>
<p>Rules 是为项目配置的持久性指令。你可以把它们看作是每次对话开始时 Agent 都会首先阅读的“项目说明书”。这些规则应该保持简洁，专注于关键信息，比如项目必须运行的命令（npm run test）、需要遵循的核心编码模式，或是指向代码库中规范示例文件的引用。一个重要的实践是，引用文件而非直接复制其内容；这样可以让规则保持简洁，并避免在代码变更后迅速过时。</p>
<p>Skills 则更进一步，它们是 Agent 在认为相关时可以动态加载的能力。这使得 Agent 的能力可以被无限扩展，而不会让上下文窗口变得臃肿。一个非常强大的模式是利用 Skills 和 hooks（钩子）来创建长时间运行的 Agent 循环。例如，你可以设置一个 hook，让 Agent 在完成代码修改后自动运行测试，如果测试失败，它会接收到一个继续工作的指令，如此循环往复，直到“所有测试通过”这个可验证的目标达成。</p>
<h2 data-id="heading-3">技巧 4：并行而非串行：让多个 AI 竞争上岗</h2>
<p>这是一个强大到令人惊讶的技巧：让多个不同的模型同时处理同一个任务。对于棘手的问题，不同模型可能会提出截然不同的解决方案。通过并行运行，你可以比较它们的思路，发现某个模型可能遗漏的边界情况，并最终选择质量最高的输出。</p>
<p>这项技术之所以可行，得益于 Cursor 对 git worktrees 的原生支持。当你并行运行多个 Agent 时，Cursor 会为每个 Agent 自动创建一个隔离的工作区。这意味着每个 Agent 都可以独立地编辑文件、构建项目和运行测试，而不会相互干扰。任务完成后，你只需选择最满意的结果，一键将其合并到你的主工作分支即可。</p>
<h2 data-id="heading-4">技巧 5：像合作者一样对待 AI，而非自动售货机</h2>
<p>那些能最大化利用 Agent 的开发者，都把它视为一个有能力的协作者，而非一个简单的指令执行工具。他们通常具备以下共同特点：</p>
<ul>
<li>提供具体指令： 他们不会说“为 auth.ts 添加测试”，而是说“为 auth.ts 编写一个测试用例，覆盖注销的边界情况，使用 <strong>tests</strong>/ 中的模式并且避免使用 mock”。</li>
<li>提供可验证的目标： 他们会配置好类型检查、linter 和单元测试。这为 Agent 提供了明确的成功信号，让它知道修改是否正确。</li>
<li>认真审查代码： 他们深知 AI 生成的代码需要严格的审查。</li>
<li>把它当作协作者： 他们会要求 Agent 给出计划、解释其思路，并敢于挑战它提出的不合理方案。</li>
</ul>
<h2 data-id="heading-5">结语</h2>
<p>高效地使用 AI 编码助手是一项全新的技能。它要求我们转变习惯，从仅仅专注于编写完美的“提示词”，转向设计和管理高效的“工作流”。这不仅仅是工具的升级，更是开发范式的进化。当你开始将 AI 视为一个真正的合作伙伴时，它的潜力才能被完全释放。</p>
<p>现在，不妨思考一下：在你的日常工作中，哪一个最让你头疼的重复性任务，可以交给一个精心调教的 Agent 来处理？</p>
<p>感谢阅读，更多关于Vibe Coding、Agent开发等内容可持续关注我的博客：<a href="https://link.juejin.cn?target=https%3A%2F%2Fdidispace.com" target="_blank" title="https://didispace.com" ref="nofollow noopener noreferrer">didispace.com</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Android 的 assets 资源和 raw 资源有什么区别？]]></title>    <link>https://juejin.cn/post/7594626381433094194</link>    <guid>https://juejin.cn/post/7594626381433094194</guid>    <pubDate>2026-01-13T09:59:13.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7594626381433094194" data-draft-id="7584349458857181210" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Android 的 assets 资源和 raw 资源有什么区别？"/> <meta itemprop="keywords" content="Android"/> <meta itemprop="datePublished" content="2026-01-13T09:59:13.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Vic_wkx"/> <meta itemprop="url" content="https://juejin.cn/user/1116759545357182"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Android 的 assets 资源和 raw 资源有什么区别？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1116759545357182/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Vic_wkx
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-13T09:59:13.000Z" title="Tue Jan 13 2026 09:59:13 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>众所周知，Android 里，<code>assets</code> 和 <code>res/raw</code> 都可以用来放资源文件。那么为什么要设计这两种方式呢？</p>
<p>结论是：</p>
<ul>
<li><strong><code>res/raw</code></strong>：受 Android 资源系统管理的文件，无目录结构，有资源 ID。参与资源选择（语言/夜间/屏幕密度）；必须小写、无点号、无特殊字符。</li>
<li><strong><code>assets</code></strong>：打包进 APK 的原始文件系统，像读普通文件一样，适合需要目录结构 / 动态读取 / 文件较多或名称不规则的场景。</li>
</ul>
<h2 data-id="heading-0">一、不同点</h2>
<h3 data-id="heading-1">1.1. 特性对比</h3>



































<table><thead><tr><th>特性</th><th>raw</th><th>assets</th></tr></thead><tbody><tr><td>是否生成 R.id</td><td>✅</td><td>❌</td></tr><tr><td>是否参与资源选择（语言/夜间/屏幕密度）</td><td>✅</td><td>❌</td></tr><tr><td>编译期校验</td><td>✅</td><td>❌</td></tr><tr><td>是否必须小写、无点号、无特殊字符</td><td>✅</td><td>❌</td></tr><tr><td>是否可以遍历目录</td><td>❌</td><td>✅</td></tr></tbody></table>
<p>raw 的命名比较严格，我之前觉得这是一个缺陷，AI 老师说是是为了让资源名成为一种跨语言、跨工具、跨平台都稳定的符号。</p>
<p>比如要同时支持运行在大小写敏感/不敏感文件系统，那么就要让资源名舍弃大写字母；<code>.</code> 号在引用资源时已经用掉了之类的原因。</p>
<p>raw 要生成资源 id，在 <strong>Java / Kotlin / C++</strong> 等语言中引用，使用有这些限制。</p>
<p>assets 没有这些限制，因为 APK 安装后，assets 文件在 APK 内部就是一个 ZIP entry，它是 <strong>严格大小写敏感</strong>，Android 在访问时直接从 ZIP 读取，不走宿主文件系统。</p>
<h3 data-id="heading-2">1.2. 放置位置：</h3>
<p>raw 放在这里：</p>
<pre><code class="hljs language-css" lang="css">app/
 └─ <span class="hljs-attribute">src</span>/<span class="hljs-selector-tag">main</span>/
    └─ res/
       └─ raw/
          └─ config<span class="hljs-selector-class">.txt</span>
</code></pre>
<p>assets 放在这里：</p>
<pre><code class="hljs language-css" lang="css">app/
 └─ <span class="hljs-attribute">src</span>/<span class="hljs-selector-tag">main</span>/
    └─ assets/
       └─ configs/
          └─ config<span class="hljs-selector-class">.txt</span>
</code></pre>
<h2 data-id="heading-3">1.3. 使用场景</h2>
<blockquote>
<p>我之前有一个误解，apk 安装后，资源文件会被放在一个文件目录下，我误以为可以在 apk 安装后，从服务器下载文件，也放到这个目录下面，再通过 assets 或者 raw 来读取。我以为 assets 或者 raw 能够做到这一点。
实际上是不行的，APK 是一个 <strong>签名过的 ZIP 文件</strong>，任何修改都会破坏签名。</p>
<p>这种 case 通常的做法是，从 assets 拷贝到 filesDir 文件夹，然后服务器也下载到这个 filesDir 文件夹。而不是直接下到 assets 或者 raw 中，这是不可能的。</p>
</blockquote>
<p>一个常见的使用 assets 的场景：</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// SDK 启动时，把 assets 里的本地数据拷贝到 filesDir</span>
<span class="hljs-built_in">copyAssetsToFilesDir</span>()
<span class="hljs-comment">// 与服务器通信，检查这些资源是否需要更新</span>
<span class="hljs-built_in">updateFromServerIfNeeded</span>()
</code></pre>
<p>这就是 <strong>固定资源 + 可更新数据</strong> 的组合，而 raw 做不到目录、遍历、动态拷贝。</p>
<p>一个常见的使用 raw 的场景：</p>
<pre><code class="hljs language-bash" lang="bash">res/raw/config.txt
res/raw-night/config.txt
res/raw-zh/config.txt
res/raw-zh-rCN/config.txt
...
</code></pre>
<p>Android 会自动帮你选：</p>
<ul>
<li>night / notnight</li>
<li>zh / en</li>
<li>region</li>
<li>smallestWidth</li>
<li>density</li>
<li>...</li>
</ul>
<p><strong>assets 完全没有这个能力</strong></p>
<h3 data-id="heading-4">1.4. 读取方式</h3>
<p>读取 raw 的方式是按 ID 取资源，以文件 <code>res/raw/config.txt</code> 为例：</p>
<pre><code class="hljs language-ini" lang="ini">val <span class="hljs-attr">inputStream</span> = resources.openRawResource(R.raw.config)
val <span class="hljs-attr">text</span> = inputStream.bufferedReader().use { it.readText() }
</code></pre>
<p>读取 assets 的方式是按路径读文件：</p>
<pre><code class="hljs language-ini" lang="ini">val <span class="hljs-attr">inputStream</span> = assets.open(<span class="hljs-string">"configs/config.txt"</span>)
val <span class="hljs-attr">text</span> = inputStream.bufferedReader().use { it.readText() }
</code></pre>
<h2 data-id="heading-5">二、相同点</h2>
<ul>
<li>两者在 apk 中都以原始资源文件的方式存在</li>
<li>两者本质都是从 APK 中读取 InputStream</li>
<li>性能差异基本可以忽略</li>
</ul>
<h2 data-id="heading-6">三、如何选择</h2>
<p>简单来说：</p>
<ul>
<li>如果你把它当成‘资源’（需要参与语言/夜间等选择、生成 R.id），用 raw</li>
<li>如果把它当成‘文件’（目录结构、动态访问、可更新），用 assets。</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[2026 年前端必须掌握的 4 个 CSS 新特性！]]></title>    <link>https://juejin.cn/post/7594616268782551067</link>    <guid>https://juejin.cn/post/7594616268782551067</guid>    <pubDate>2026-01-13T09:58:46.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7594616268782551067" data-draft-id="7594657393829953574" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content=" 2026 年前端必须掌握的 4 个 CSS 新特性！"/> <meta itemprop="keywords" content="前端,JavaScript,CSS"/> <meta itemprop="datePublished" content="2026-01-13T09:58:46.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="冴羽"/> <meta itemprop="url" content="https://juejin.cn/user/712139234359182"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
             2026 年前端必须掌握的 4 个 CSS 新特性！
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/712139234359182/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    冴羽
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-13T09:58:46.000Z" title="Tue Jan 13 2026 09:58:46 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">1. 前言</h2>
<p>2026 年已经到来，前端技术又迎来了新一轮的革新。</p>
<p>今天，我为你精选了 4 个在 2025 年正式发布、2026 年必须掌握的 CSS 新特性，让你的技术更上一层楼！</p>
<h2 data-id="heading-1">2. 兄弟元素定位：sibling-index() 与 sibling-count()</h2>
<p>早些时候这些还只是实验性质的功能，现在它们已经在稳定的 Chrome 和 Safari 浏览器中可用了！</p>
<p>记得以前实现列表项交错动画时，要手动给每个元素设置不同的延迟吗？现在，用 <code>sibling-index()</code> 一行代码就能搞定！</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-tag">li</span> {
  <span class="hljs-attribute">transition</span>: opacity <span class="hljs-number">0.3s</span> ease;
  <span class="hljs-attribute">transition-delay</span>: <span class="hljs-built_in">calc</span>((<span class="hljs-built_in">sibling-index</span>() - <span class="hljs-number">1</span>) * <span class="hljs-number">100ms</span>);
}
</code></pre>
<p>这个函数会自动获取元素在兄弟节点中的位置（从 1 开始计数），通过简单的计算就能实现<strong>流畅的交错动画效果</strong>。</p>
<p>如果再搭配 <code>@starting-style</code>，连入场动画都能轻松搞定：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-tag">li</span> {
  <span class="hljs-attribute">transition</span>: opacity <span class="hljs-number">0.3s</span> ease;
  <span class="hljs-attribute">transition-delay</span>: <span class="hljs-built_in">calc</span>((<span class="hljs-built_in">sibling-index</span>() - <span class="hljs-number">1</span>) * <span class="hljs-number">100ms</span>);

  <span class="hljs-keyword">@starting-style</span> {
    <span class="hljs-attribute">opacity</span>: <span class="hljs-number">0</span>;
  }
}
</code></pre>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fcodepen.io%2Fargyleink%2Fpen%2FKwKXPYW" target="_blank" title="https://codepen.io/argyleink/pen/KwKXPYW" ref="nofollow noopener noreferrer">实现效果如下：</a></p>

<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/acd56fab14d344d5a95e22ccb4bc8d1f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Ya05769:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768903125&amp;x-signature=De2XF6U9lS5qS6LDh9BRr2k79kc%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-2">3. 滚动状态查询：@container scroll-state()</h2>
<p>现在你可以精确地知道用户正在如何滚动页面。</p>
<p>不仅如此，你还可以查询滚动条的三种状态：粘附、贴靠、可滚动。</p>
<p>首先，给需要监测的容器加上 <code>container-type: scroll-state</code>，然后就可以用 <code>@container scroll-state()</code> 来查询它的状态了。</p>
<h3 data-id="heading-3">3.1. 粘附状态：stuck</h3>
<pre><code class="hljs language-css" lang="css"><span class="hljs-comment">/* 当导航栏被“粘住”时 */</span>
<span class="hljs-keyword">@container</span> scroll-state(stuck) {
  <span class="hljs-selector-class">.inner-navbar</span> {
    <span class="hljs-attribute">box-shadow</span>: <span class="hljs-built_in">var</span>(--shadow-<span class="hljs-number">3</span>);
  }
}
</code></pre>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fcodepen.io%2Fweb-dot-dev%2Fpen%2FGgKdryj" target="_blank" title="https://codepen.io/web-dot-dev/pen/GgKdryj" ref="nofollow noopener noreferrer">使用效果如下：</a></p>

<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4d9fa5d797cf4e51a353ce7bfac0baa8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Ya05769:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768903125&amp;x-signature=es9djIRE50Iv%2FzLR609lxv1ZLjc%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-4">3.2. 贴靠状态：snapped</h3>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-tag">section</span> {
  <span class="hljs-attribute">overflow</span>: auto hidden;
  <span class="hljs-attribute">scroll-snap-type</span>: x mandatory;

  &gt; <span class="hljs-selector-tag">article</span> {
    container-type: scroll-state;
    <span class="hljs-attribute">scroll-snap-align</span>: center;

    <span class="hljs-keyword">@supports</span> (<span class="hljs-attribute">container-type</span>: scroll-state) {
      &gt; * {
        <span class="hljs-attribute">transition</span>: opacity <span class="hljs-number">0.5s</span> ease;

        <span class="hljs-keyword">@container</span> <span class="hljs-keyword">not</span> scroll-state(<span class="hljs-attribute">snapped</span>: x) {
          <span class="hljs-attribute">opacity</span>: <span class="hljs-number">0.25</span>;
        }
      }
    }
  }
}
</code></pre>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fcodepen.io%2Fweb-dot-dev%2Fpen%2FXJrqpBG" target="_blank" title="https://codepen.io/web-dot-dev/pen/XJrqpBG" ref="nofollow noopener noreferrer">使用效果如下：</a></p>

<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b40fee7aab8c4d3cb3d19ad1e0cba74f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Ya05769:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768903125&amp;x-signature=fBzwpuKUDWu0AxrkgcFOiQ1gGuI%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-5">3.3. 可滚动状态：scrollable</h3>
<p>而且你可以查询滚动方向：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-keyword">@container</span> scroll-state(<span class="hljs-attribute">scrollable</span>: top) {
}
<span class="hljs-keyword">@container</span> scroll-state(<span class="hljs-attribute">scrollable</span>: right) {
}
<span class="hljs-keyword">@container</span> scroll-state(<span class="hljs-attribute">scrollable</span>: bottom) {
}
<span class="hljs-keyword">@container</span> scroll-state(<span class="hljs-attribute">scrollable</span>: left) {
}
</code></pre>
<p>我们来举一个例子：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.scroll-container</span> {
  container-type: scroll-state size;
  <span class="hljs-attribute">overflow</span>: auto;

  &amp;<span class="hljs-selector-pseudo">::after</span> {
    <span class="hljs-attribute">content</span>: <span class="hljs-string">" "</span>;

    <span class="hljs-attribute">background</span>: <span class="hljs-built_in">var</span>(--_shadow-top), <span class="hljs-built_in">var</span>(--_shadow-bottom);
    <span class="hljs-attribute">transition</span>: --_scroll-shadow-color-<span class="hljs-number">1</span>-opacity <span class="hljs-number">0.5s</span> ease, --_scroll-shadow-color-<span class="hljs-number">2</span>-opacity <span class="hljs-number">0.5s</span> ease;

    <span class="hljs-keyword">@container</span> scroll-state(<span class="hljs-attribute">scrollable</span>: top) {
      --_scroll-shadow-<span class="hljs-attribute">color</span>-<span class="hljs-number">1</span>-<span class="hljs-attribute">opacity</span>: <span class="hljs-built_in">var</span>(--_shadow-color-opacity, <span class="hljs-number">25%</span>);
    }

    <span class="hljs-keyword">@container</span> scroll-state(<span class="hljs-attribute">scrollable</span>: bottom) {
      --_scroll-shadow-<span class="hljs-attribute">color</span>-<span class="hljs-number">2</span>-<span class="hljs-attribute">opacity</span>: <span class="hljs-built_in">var</span>(--_shadow-color-opacity, <span class="hljs-number">25%</span>);
    }
  }
}
</code></pre>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fcodepen.io%2Fweb-dot-dev%2Fpen%2FOPLZWBj" target="_blank" title="https://codepen.io/web-dot-dev/pen/OPLZWBj" ref="nofollow noopener noreferrer">使用效果如下：</a></p>

<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e0872b54ed654acd89e0e3426edd4dce~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Ya05769:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768903125&amp;x-signature=%2Fl%2Fbbx0yHOTiIWIJCc2EGpgFaS4%3D" alt="" loading="lazy"/></p>
<p>你可以发现，在滚动的时候，容器顶部和底部有一层阴影。</p>
<h2 data-id="heading-6">4. 文字精准对齐：text-box</h2>
<p><code>text-box</code> 可以精确控制文字的边界框，实现像素级的对齐效果。</p>
<p>Web 字体渲染时会在字形上下方预留“安全间距”：</p>

<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/456add032be9484f88bf25870fdfc3b3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Ya05769:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768903125&amp;x-signature=WnDoAGxaBAbP8eTg1D08EdvZ7Q0%3D" alt="" loading="lazy"/></p>
<p>但有时我们需要进行像素级精确对齐，此时就需要使用 text-box：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-tag">h1</span> {
  text-box: trim-both cap alphabetic;
}
</code></pre>
<p>这一行代码就能：</p>
<ul>
<li><code>trim-both</code>：同时修剪上下方的空白</li>
<li><code>cap</code>：修剪到大写字母高度线以上</li>
<li><code>alphabetic</code>：修剪到字母基线以下</li>
</ul>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fnerdy.dev%2Fnotebook%2Ftext-box.html" target="_blank" title="https://nerdy.dev/notebook/text-box.html" ref="nofollow noopener noreferrer">使用效果如下：</a></p>

<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a02756b1867e446eb232601c80b77eac~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Ya05769:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768903125&amp;x-signature=GvE2Za8qnIqAebUKcg6Oe7%2B9dqY%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-7">5. 类型安全：typed attr()</h2>
<p>这是 <code>attr()</code> 函数的升级版，支持类型检查和回退值，在 HTML 和 CSS 之间搭建了强大的桥梁。</p>
<h3 data-id="heading-8">5.1. 传递颜色</h3>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">data-bg</span>=<span class="hljs-string">"white"</span> <span class="hljs-attr">data-fg</span>=<span class="hljs-string">"deeppink"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
</code></pre>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.theme</span> {
  <span class="hljs-attribute">background</span>: <span class="hljs-built_in">attr</span>(data-bg color, black); <span class="hljs-comment">/* 类型：颜色，默认：黑色 */</span>
  <span class="hljs-attribute">color</span>: <span class="hljs-built_in">attr</span>(data-fg color, white);
}
</code></pre>
<h3 data-id="heading-9">5.2. 传递数字</h3>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"grid"</span> <span class="hljs-attr">data-columns</span>=<span class="hljs-string">"3"</span>&gt;</span>…<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
</code></pre>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.grid</span> {
  --_columns: <span class="hljs-built_in">attr</span>(data-columns number, <span class="hljs-number">3</span>);
  <span class="hljs-attribute">grid-template-columns</span>: <span class="hljs-built_in">repeat</span>(<span class="hljs-built_in">var</span>(--_columns), <span class="hljs-number">1</span>fr);
}
</code></pre>
<h3 data-id="heading-10">5.3. 类型验证（枚举值）</h3>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">li</span> <span class="hljs-attr">scroll-snap</span>=<span class="hljs-string">"start"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">li</span> <span class="hljs-attr">scroll-snap</span>=<span class="hljs-string">"center"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">li</span> <span class="hljs-attr">scroll-snap</span>=<span class="hljs-string">"end"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">li</span> <span class="hljs-attr">scroll-snap</span>=<span class="hljs-string">"nothing"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span>
</code></pre>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-attr">[scroll-snap]</span> {
  <span class="hljs-attribute">scroll-snap-align</span>: <span class="hljs-built_in">attr</span>(scroll-snap <span class="hljs-built_in">type</span>(start | center | end));
}
</code></pre>
<p><code>type()</code> 函数会验证属性值是否在允许的关键字列表中，无效值会被优雅地回退。</p>
<h2 data-id="heading-11">6. 浏览器支持现状</h2>
<p>你可能会说：“这些功能就像那些时髦衣服……等我们能用了，它们可能已经过时了 😂”</p>
<p>确实，浏览器兼容性是每一位前端开发者需要关注的问题。</p>
<p>但这些功能其实大多属于渐进增强，我们可以先在支持的浏览器中提供更好的体验，不支持的浏览器回退。</p>
<h2 data-id="heading-12">7. 最后</h2>
<p>这 4 个 CSS 新特性其实也代表了 CSS 的未来方向：</p>
<ol>
<li><strong>更智能的布局控制</strong>（sibling-index）</li>
<li><strong>更精细的交互感知</strong>（scroll-state）</li>
<li><strong>更精准的视觉设计</strong>（text-box）</li>
<li><strong>更强大的 HTML-CSS 桥梁</strong>（typed attr）</li>
</ol>
<p>2026 年，前端开发不再只是“让页面显示出来”，而是“让体验完美起来”。</p>
<p>这些工具让我们能够创造出更精致、更智能、更用户友好的网页体验。</p>
<p>我是冴羽，10 年笔耕不辍，专注前端领域，更新了 10+ 系列、300+ 篇原创技术文章，翻译过 Svelte、Solid.js、TypeScript 文档，著有小册《Next.js 开发指南》、《Svelte 开发指南》、《Astro 实战指南》。</p>
<p>欢迎围观我的“<a href="https://link.juejin.cn?target=https%3A%2F%2Fyayujs.com%2F" target="_blank" title="https://yayujs.com/" ref="nofollow noopener noreferrer">网页版朋友圈</a>”，关注我的公众号：<strong>冴羽（或搜索 yayujs）</strong>，每天分享前端知识、AI 干货。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[iOS 文件管理，在不越狱的前提下管理 iPhone / iPad 文件]]></title>    <link>https://juejin.cn/post/7594678044263399424</link>    <guid>https://juejin.cn/post/7594678044263399424</guid>    <pubDate>2026-01-13T10:01:18.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7594678044263399424" data-draft-id="7594655863547756596" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="iOS 文件管理，在不越狱的前提下管理 iPhone / iPad 文件"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2026-01-13T10:01:18.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="我是谁的程序员"/> <meta itemprop="url" content="https://juejin.cn/user/2390811467846089"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            iOS 文件管理，在不越狱的前提下管理 iPhone / iPad 文件
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2390811467846089/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    我是谁的程序员
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-13T10:01:18.000Z" title="Tue Jan 13 2026 10:01:18 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在 iOS 生态里谈“文件管理”，往往很容易变成一句空话。系统沙盒、权限隔离、Finder/iTunes 的抽象封装，让很多开发者和测试同学习惯性地绕开“文件”这个层面，转而通过接口、日志或导出功能解决问题。但当你需要 <strong>真实地看到设备里的文件结构、拿到 App 产生的原始数据、做一次完整备份或问题复现</strong> 时，文件管理就绕不过去了。</p>
<p>这篇文章记录我是如何在日常工作中，通过 <strong>克魔助手</strong> 搭配其他常见工具，把 iPhone / iPad 的文件传输、查看和备份这件事做“顺手”的。</p>
<hr/>
<h2 data-id="heading-0">为什么很多人觉得 iOS 文件“不可控”</h2>
<p>如果你只使用过 iTunes 或 Finder，大概会有几个共同感受：</p>
<ul>
<li>能备份，但不知道备份了什么</li>
<li>能恢复，但无法挑选具体文件</li>
<li>看不到 App 的真实数据结构</li>
</ul>
<p>这些工具更偏向“用户级别”的安全封装，而不是工程用途。对开发者来说，真正需要的是：</p>
<ul>
<li>像管理移动硬盘一样查看目录</li>
<li>精确控制上传、下载的文件</li>
<li>在不越狱的前提下完成这些操作</li>
</ul>
<p>这正是我开始寻找第三方工具的背景。</p>
<hr/>
<h2 data-id="heading-1">文件管理并不只有一种工具形态</h2>
<p>在实际使用中，我通常会把工具分成三类：</p>
<ul>
<li><strong>系统官方工具</strong>：Finder / iTunes，适合整机备份、恢复</li>
<li><strong>云与同步工具</strong>：iCloud、第三方云盘，适合用户数据同步</li>
<li><strong>工程向文件管理工具</strong>：直接面对设备文件结构，解决“看”和“取”的问题</li>
</ul>
<p>克魔助手显然属于第三类，而且它的使用逻辑更接近开发者熟悉的文件系统操作，而不是“向导式流程”。</p>
<hr/>
<h2 data-id="heading-2">从连接设备开始，而不是从功能开始</h2>
<p>实际操作时，我的第一步并不是找“文件管理”按钮，而是确认设备状态：</p>
<ul>
<li>设备已解锁</li>
<li>已信任当前电脑</li>
<li>数据线连接稳定</li>
</ul>
<p>随后启动克魔助手，在设备列表中选中目标 iPhone 或 iPad。这一步很关键，因为后续所有文件操作都建立在设备连接稳定的前提下。</p>
<hr/>
<h2 data-id="heading-3">进入用户文件视角，看见真实目录</h2>
<p>在左侧导航中选择【文件管理】，再切换到【用户文件】，你会看到一个熟悉又陌生的结构。</p>
<p>这里没有 App 名称，而是偏系统级的目录，比如：</p>
<ul>
<li><strong>DCIM</strong>：相机拍摄的照片和视频</li>
<li><strong>Downloads</strong>：应用下载产生的文件</li>
<li><strong>Books</strong>：电子书数据</li>
<li><strong>recording</strong>：录音相关文件</li>
</ul>
<p>这一步的意义在于，你开始以“设备文件系统”的视角看 iOS，而不是 App 功能入口。
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/58c18215a90044ee84d5b6b54dc85ab7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oiR5piv6LCB55qE56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768903278&amp;x-signature=%2F6Orwpq%2BVqVfUfHl1IHNuKueoR8%3D" alt="文件管理" loading="lazy"/></p>
<hr/>
<h2 data-id="heading-4">文件上传：更像拷贝，而不是同步</h2>
<p>我通常在调试或测试时，需要把一些配置文件、测试素材放进设备。</p>
<p>操作过程很直接：</p>
<ul>
<li>进入目标目录（例如某个 App 使用的 Documents 目录）</li>
<li>点击【上传文件】</li>
<li>选择本地文件或文件夹</li>
</ul>
<p>整个过程没有额外确认弹窗，也不需要重新打包 App。对比通过 Xcode 或重签 IPA 的方式，这种文件级操作要轻量得多。</p>
<hr/>
<h2 data-id="heading-5">文件下载：解决“数据拿不出来”的老问题</h2>
<p>调试中最常见的需求之一，是把设备上的数据原样导出，比如：</p>
<ul>
<li>崩溃前生成的缓存文件</li>
<li>视频或音频类 App 的临时数据</li>
<li>用户复现问题时的原始文件</li>
</ul>
<p>在克魔助手里，做法是：</p>
<ul>
<li>定位到目标文件或目录</li>
<li>勾选需要导出的内容</li>
<li>点击【保存】，选择本地路径</li>
</ul>
<p>对于 DCIM 目录下的照片和视频，这种方式比通过系统相册导出要直接得多，也避免了额外的转码和排序问题。</p>
<hr/>
<h2 data-id="heading-6">目录管理：一些被忽略但很实用的细节</h2>
<p>在实际使用中，我发现几个细节很有工程价值：</p>
<ul>
<li>可以新建目录，用于区分测试批次</li>
<li>可以删除空目录，清理历史残留</li>
<li>支持批量操作，不需要一个个点</li>
</ul>
<p>这些能力并不“炫技”，但在长期调试或测试设备上，非常省时间。</p>
<hr/>
<h2 data-id="heading-7">与其他工具的搭配方式</h2>
<p>在真实工作流里，我通常会这样组合使用：</p>
<ul>
<li>Finder / iTunes：整机备份与恢复</li>
<li>克魔助手：精细化文件查看与传输</li>
<li>日志工具 / 性能监控工具：定位问题后，回到文件层验证</li>
</ul>
<p>它们并不是互相替代关系，而是各自解决不同层级的问题。</p>
<hr/>
<h2 data-id="heading-8">一点关于“备份”的实际经验</h2>
<p>如果目标只是“留一份完整数据”，整机备份就够了；
但如果你希望 <strong>知道备份里有什么、将来能单独拿出来用</strong>，那文件级备份几乎是唯一选择。</p>
<p>我通常会直接拷贝 DCIM、Downloads 以及特定 App 的数据目录，配合版本号和时间戳存档，这样后续回溯问题时会非常清晰。</p>
<p>参考链接：<a href="https://link.juejin.cn?target=https%3A%2F%2Fkeymob.com%2Ftutorial%2Fzh%2F13%2F13.html" target="_blank" title="https://keymob.com/tutorial/zh/13/13.html" ref="nofollow noopener noreferrer">keymob.com/tutorial/zh…</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[设计一个支持万人同时抢购商品的秒杀系统?]]></title>    <link>https://juejin.cn/post/7594642978695266367</link>    <guid>https://juejin.cn/post/7594642978695266367</guid>    <pubDate>2026-01-13T08:03:47.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7594642978695266367" data-draft-id="7594642978695249983" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="设计一个支持万人同时抢购商品的秒杀系统?"/> <meta itemprop="keywords" content="后端,Java"/> <meta itemprop="datePublished" content="2026-01-13T08:03:47.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="程序员小假"/> <meta itemprop="url" content="https://juejin.cn/user/2285197690931932"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            设计一个支持万人同时抢购商品的秒杀系统?
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2285197690931932/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    程序员小假
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-13T08:03:47.000Z" title="Tue Jan 13 2026 08:03:47 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一、系统架构设计</h2>
<h3 data-id="heading-1">1. 分层架构</h3>
<pre><code class="hljs language-markdown" lang="markdown">客户端层 → 接入层 → 业务服务层 →  数据层
<span class="hljs-code">     ↓       ↓         ↓          ↓
    限流    缓存       队列      数据库
</span></code></pre>
<h3 data-id="heading-2">2. 具体组件</h3>
<ul>
<li><strong>客户端</strong>：静态资源CDN、倒计时校准、防重复提交</li>
<li><strong>接入层</strong>：Nginx+Lua/OpenResty，做第一层限流和缓存</li>
<li><strong>业务层</strong>：</li>
</ul>

<ul>
<li>
<ul>
<li>秒杀服务集群（无状态）</li>
<li>消息队列（Kafka/RocketMQ）</li>
<li>缓存集群（Redis Cluster）</li>
</ul>
</li>
</ul>

<ul>
<li><strong>数据层</strong>：</li>
</ul>

<ul>
<li>
<ul>
<li>主从数据库（读写分离）</li>
<li>分库分表（按商品/时间）</li>
</ul>
</li>
</ul>
<h2 data-id="heading-3">二、核心问题解决方案</h2>
<h3 data-id="heading-4">1. 超卖问题</h3>
<h4 data-id="heading-5">解决方案一：Redis原子操作</h4>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># 使用Redis的DECR原子操作扣减库存</span>
def deduct_stock(product_id, user_id):
    <span class="hljs-attr">stock_key</span> = f<span class="hljs-string">"stock:{product_id}"</span>

<span class="hljs-comment"># Lua脚本保证原子性</span>
<span class="hljs-attr">lua_script</span> = <span class="hljs-string">"""
local stock = tonumber(redis.call('GET', KEYS[1]))
if stock and stock &gt; 0 then
redis.call('DECR', KEYS[1])
return 1
end
return 0
"""</span>

<span class="hljs-attr">result</span> = redis.eval(lua_script, <span class="hljs-number">1</span>, stock_key)
return <span class="hljs-attr">result</span> == <span class="hljs-number">1</span>
</code></pre>
<h4 data-id="heading-6">解决方案二：数据库乐观锁</h4>
<pre><code class="hljs language-ini" lang="ini">UPDATE products 
SET <span class="hljs-attr">stock</span> = stock - <span class="hljs-number">1</span>, version = version + <span class="hljs-number">1</span> 
WHERE <span class="hljs-attr">id</span> = ? AND stock &gt; <span class="hljs-number">0</span> AND version = ?
</code></pre>
<h4 data-id="heading-7">解决方案三：预扣库存</h4>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-comment">// 先预扣Redis库存，再异步同步到DB</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title">preDeductStock</span><span class="hljs-params">(<span class="hljs-type">String</span> productId, <span class="hljs-type">int</span> count)</span> </span>{
    <span class="hljs-type">String</span> key = <span class="hljs-string">"seckill:stock:"</span> + productId;
    Long remaining = redisTemplate.<span class="hljs-built_in">opsForValue</span>().<span class="hljs-built_in">decrement</span>(key, count);

    <span class="hljs-keyword">if</span> (remaining &gt;= <span class="hljs-number">0</span>) {
        <span class="hljs-comment">// 发送MQ消息异步扣减数据库</span>
        <span class="hljs-built_in">sendStockDeductMessage</span>(productId, count);
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    } <span class="hljs-keyword">else</span> {
        <span class="hljs-comment">// 库存不足，回滚</span>
        redisTemplate.<span class="hljs-built_in">opsForValue</span>().<span class="hljs-built_in">increment</span>(key, count);
        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    }
}
</code></pre>
<h3 data-id="heading-8">2. 高并发请求处理</h3>
<h4 data-id="heading-9">2.1 流量削峰</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 使用消息队列缓冲请求</span>
<span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SeckillService</span> {
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> RocketMQTemplate mqTemplate;

    <span class="hljs-keyword">public</span> SeckillResult seckill(SeckillRequest request) {
        <span class="hljs-comment">// 1. 校验用户和商品状态</span>
        <span class="hljs-keyword">if</span> (!validate(request)) {
            <span class="hljs-keyword">return</span> SeckillResult.fail(<span class="hljs-string">"校验失败"</span>);
        }

        <span class="hljs-comment">// 2. 生成唯一请求ID</span>
        String requestId = generateRequestId(request);

        <span class="hljs-comment">// 3. 请求入队，立即返回</span>
        mqTemplate.sendOneWay(<span class="hljs-string">"seckill-topic"</span>, 
                              MessageBuilder.withPayload(request).build());

        <span class="hljs-comment">// 4. 返回排队中状态，前端轮询结果</span>
        <span class="hljs-keyword">return</span> SeckillResult.processing(requestId);
    }
}
</code></pre>
<h4 data-id="heading-10">2.2 分层过滤</h4>
<pre><code class="hljs">所有请求 → 合法性校验 → 库存校验 → 频率控制 → 实际下单
   ↓           ↓          ↓         ↓         ↓
 100万        50万       10万       5万       1万
</code></pre>
<h3 data-id="heading-11">3. 系统性能优化</h3>
<h4 data-id="heading-12">3.1 缓存策略</h4>
<pre><code class="hljs language-makefile" lang="makefile"><span class="hljs-comment"># 多级缓存配置</span>
<span class="hljs-section">缓存层级:</span>
  一级: JVM本地缓存 (Caffeine) - 热点商品
  二级: Redis集群 - 库存信息
  三级: 数据库 - 最终一致性
</code></pre>
<h4 data-id="heading-13">3.2 读多写少优化</h4>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// 商品信息缓存预热</span>
<span class="hljs-keyword">@Service</span>
public class CacheWarmUpService {

    <span class="hljs-keyword">@PostConstruct</span>
    public void warmUpSeckillProducts() {
        List&lt;Product&gt; hotProducts = <span class="hljs-built_in">loadHotProducts</span>();

        for (Product product : hotProducts) {
            <span class="hljs-comment">// 库存信息</span>
            redisTemplate<span class="hljs-selector-class">.opsForValue</span>()<span class="hljs-selector-class">.set</span>(
                "stock:" + product.getId(),
                product<span class="hljs-selector-class">.getStock</span>()
            );

            <span class="hljs-comment">// 商品详情</span>
            redisTemplate<span class="hljs-selector-class">.opsForValue</span>()<span class="hljs-selector-class">.set</span>(
                "product:" + product.getId(),
                JSON<span class="hljs-selector-class">.toJSONString</span>(product)
            );

            <span class="hljs-comment">// 使用布隆过滤器存储可售商品ID</span>
            bloomFilter<span class="hljs-selector-class">.add</span>(product.getId());
        }
    }
}
</code></pre>
<h3 data-id="heading-14">4. 详细实现方案</h3>
<h4 data-id="heading-15">4.1 秒杀流程</h4>
<pre><code class="hljs language-ruby" lang="ruby"><span class="hljs-keyword">class</span> <span class="hljs-title class_">SeckillSystem</span>:
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">process_seckill</span>(<span class="hljs-params"><span class="hljs-variable language_">self</span>, user_id, product_id</span>):
        <span class="hljs-comment"># 1. 恶意请求拦截</span>
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> <span class="hljs-variable language_">self</span>.check_risk(user_id):
            <span class="hljs-keyword">return</span> {<span class="hljs-string">"code"</span>: <span class="hljs-number">403</span>, <span class="hljs-string">"msg"</span>: <span class="hljs-string">"访问过于频繁"</span>}

        <span class="hljs-comment"># 2. 布隆过滤器快速判断</span>
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> bloom_filter.contains(product_id):
            <span class="hljs-keyword">return</span> {<span class="hljs-string">"code"</span>: <span class="hljs-number">404</span>, <span class="hljs-string">"msg"</span>: <span class="hljs-string">"商品不存在"</span>}

        <span class="hljs-comment"># 3. 内存标记（已售罄的商品直接返回）</span>
        <span class="hljs-keyword">if</span> sold_out_flags.get(product_id):
            <span class="hljs-keyword">return</span> {<span class="hljs-string">"code"</span>: <span class="hljs-number">400</span>, <span class="hljs-string">"msg"</span>: <span class="hljs-string">"已售罄"</span>}

        <span class="hljs-comment"># 4. Redis原子扣减库存</span>
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> <span class="hljs-variable language_">self</span>.deduct_stock_in_redis(product_id):
            sold_out_flags[product_id] = <span class="hljs-title class_">True</span>
            <span class="hljs-keyword">return</span> {<span class="hljs-string">"code"</span>: <span class="hljs-number">400</span>, <span class="hljs-string">"msg"</span>: <span class="hljs-string">"库存不足"</span>}

        <span class="hljs-comment"># 5. 生成订单ID（雪花算法）</span>
        order_id = snowflake.generate()

        <span class="hljs-comment"># 6. 订单信息入队</span>
        mq.send({
            <span class="hljs-string">"order_id"</span>: order_id,
            <span class="hljs-string">"user_id"</span>: user_id,
            <span class="hljs-string">"product_id"</span>: product_id,
            <span class="hljs-string">"time"</span>: time.time()
        })

        <span class="hljs-comment"># 7. 返回排队中</span>
        <span class="hljs-keyword">return</span> {
            <span class="hljs-string">"code"</span>: <span class="hljs-number">200</span>,
            <span class="hljs-string">"msg"</span>: <span class="hljs-string">"排队中"</span>,
            <span class="hljs-string">"order_id"</span>: order_id,
            <span class="hljs-string">"queue_position"</span>: get_queue_position(order_id)
        }
</code></pre>
<h4 data-id="heading-16">4.2 库存同步方案</h4>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-keyword">@Component</span>
<span class="hljs-keyword">@Slf</span>4j
public class StockSyncService {

    <span class="hljs-comment">// 数据库最终扣减</span>
    <span class="hljs-keyword">@Transactional</span>
    public void syncStockToDB(String productId, int count) {
        try {
            <span class="hljs-comment">// 数据库扣减（带重试机制）</span>
            boolean success = productDAO<span class="hljs-selector-class">.deductStock</span>(productId, count);

            if (success) {
                <span class="hljs-comment">// 更新Redis中的最终库存状态</span>
                redisTemplate<span class="hljs-selector-class">.opsForValue</span>()<span class="hljs-selector-class">.set</span>(
                    "stock_final:" + productId,
                    getDBStock(productId)
                );

                <span class="hljs-comment">// 删除售罄标记</span>
                soldOutCache<span class="hljs-selector-class">.remove</span>(productId);
            }
        } catch (Exception e) {
            log<span class="hljs-selector-class">.error</span>("库存同步失败", e);
            <span class="hljs-comment">// 记录异常，人工介入处理</span>
            alertService<span class="hljs-selector-class">.sendAlert</span>(e);
        }
    }

    <span class="hljs-comment">// 库存对账任务</span>
    <span class="hljs-keyword">@Scheduled</span>(cron = <span class="hljs-string">"0 */5 * * * ?"</span>)
    public void stockReconciliation() {
        List&lt;Product&gt; products = productDAO<span class="hljs-selector-class">.getAllSeckillProducts</span>();

        for (Product product : products) {
            Integer redisStock = <span class="hljs-built_in">getRedisStock</span>(product.getId());
            Integer dbStock = product<span class="hljs-selector-class">.getStock</span>();

            if (!Objects.equals(redisStock, dbStock)) {
                log<span class="hljs-selector-class">.warn</span>("库存不一致: productId={}, redis={}, db={}", 
                         product.getId(), redisStock, dbStock);
                <span class="hljs-comment">// 自动修复或报警</span>
                <span class="hljs-built_in">fixStockInconsistency</span>(product.getId(), dbStock);
            }
        }
    }
}
</code></pre>
<h2 data-id="heading-17">三、高可用保障</h2>
<h3 data-id="heading-18">1. 限流降级策略</h3>
<pre><code class="hljs language-makefile" lang="makefile"><span class="hljs-comment"># 多维度限流配置</span>
<span class="hljs-section">限流规则:</span>
  用户维度: 每个用户10次/分钟
  IP维度: 每个IP 1000次/分钟
  商品维度: 每个商品 10000次/分钟
  总QPS: 系统最大承受50000 QPS
</code></pre>
<h3 data-id="heading-19">2. 熔断降级</h3>
<pre><code class="hljs language-less" lang="less"><span class="hljs-variable">@RestController</span>
<span class="hljs-variable">@Slf4j</span>
public class SeckillController {

    <span class="hljs-variable">@GetMapping</span>(<span class="hljs-string">"/seckill/{productId}"</span>)
    <span class="hljs-variable">@HystrixCommand</span>(
        fallbackMethod = <span class="hljs-string">"seckillFallback"</span>,
        commandProperties = {
            <span class="hljs-variable">@HystrixProperty</span>(name = <span class="hljs-string">"execution.isolation.thread.timeoutInMilliseconds"</span>, value = <span class="hljs-string">"1000"</span>),
            <span class="hljs-variable">@HystrixProperty</span>(name = <span class="hljs-string">"circuitBreaker.requestVolumeThreshold"</span>, value = <span class="hljs-string">"20"</span>)
        }
    )
    public Response <span class="hljs-built_in">seckill</span>(<span class="hljs-variable">@PathVariable</span> String productId, 
                            <span class="hljs-variable">@RequestParam</span> String userId) {
        <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">seckillService</span><span class="hljs-selector-class">.process</span>(userId, productId);
    }

    <span class="hljs-comment">// 降级方法</span>
    <span class="hljs-selector-tag">public</span> <span class="hljs-selector-tag">Response</span> <span class="hljs-selector-tag">seckillFallback</span>(String productId, String userId) {
        <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">Response</span><span class="hljs-selector-class">.error</span>(<span class="hljs-string">"系统繁忙，请稍后重试"</span>);
    }
}
</code></pre>
<h2 data-id="heading-20">四、监控与告警</h2>
<h3 data-id="heading-21">1. 关键监控指标</h3>
<ul>
<li><strong>系统层面</strong>：QPS、RT、错误率、CPU/内存使用率</li>
<li><strong>应用层面</strong>：库存扣减成功率、消息堆积量</li>
<li><strong>业务层面</strong>：抢购成功率、用户排队时长</li>
</ul>
<h3 data-id="heading-22">2. 监控实现</h3>
<pre><code class="hljs language-arduino" lang="arduino">@Component
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SeckillMonitor</span> {

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> MeterRegistry meterRegistry;

    <span class="hljs-comment">// 记录关键指标</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-type">void</span> <span class="hljs-title">recordSeckill</span><span class="hljs-params">(<span class="hljs-type">String</span> productId, <span class="hljs-type">boolean</span> success, <span class="hljs-type">long</span> cost)</span> </span>{
        <span class="hljs-comment">// QPS监控</span>
        meterRegistry.<span class="hljs-built_in">counter</span>(<span class="hljs-string">"seckill.requests.total"</span>).<span class="hljs-built_in">increment</span>();

        <span class="hljs-keyword">if</span> (success) {
            meterRegistry.<span class="hljs-built_in">counter</span>(<span class="hljs-string">"seckill.success.total"</span>).<span class="hljs-built_in">increment</span>();
        } <span class="hljs-keyword">else</span> {
            meterRegistry.<span class="hljs-built_in">counter</span>(<span class="hljs-string">"seckill.fail.total"</span>).<span class="hljs-built_in">increment</span>();
        }

        <span class="hljs-comment">// 耗时分布</span>
        meterRegistry.<span class="hljs-built_in">timer</span>(<span class="hljs-string">"seckill.process.time"</span>)
        .<span class="hljs-built_in">record</span>(cost, TimeUnit.MILLISECONDS);

        <span class="hljs-comment">// 库存变化</span>
        meterRegistry.<span class="hljs-built_in">gauge</span>(<span class="hljs-string">"seckill.stock."</span> + productId, 
                            <span class="hljs-built_in">getCurrentStock</span>(productId));
    }
}
</code></pre>
<h2 data-id="heading-23">五、部署与扩展</h2>
<h3 data-id="heading-24">1. 弹性扩展策略</h3>
<ul>
<li><strong>水平扩展</strong>：无状态服务可快速扩容</li>
<li><strong>自动伸缩</strong>：基于CPU使用率或QPS自动扩缩容</li>
<li><strong>异地多活</strong>：重要业务支持多机房部署</li>
</ul>
<h3 data-id="heading-25">2. 压测方案</h3>
<pre><code class="hljs language-makefile" lang="makefile"><span class="hljs-section">压测场景:</span>
  场景1: 库存预热，10万用户同时抢1万商品
  场景2: 持续高压，5万QPS持续5分钟
  场景3: 峰值冲击，瞬间20万QPS
  
<span class="hljs-section">压测目标:</span>
  成功率: &gt;99.9%
  平均RT: &lt;100ms
  错误率: &lt;0.1%
</code></pre>
<h2 data-id="heading-26">六、安全考虑</h2>
<ol>
<li><strong>防刷机制</strong>：</li>
</ol>
<ul>
<li>
<ul>
<li>验证码（峰值时降级）</li>
<li>设备指纹</li>
<li>行为分析</li>
</ul>
</li>
</ul>
<ol start="2">
<li><strong>数据安全</strong>：</li>
</ol>
<ul>
<li>
<ul>
<li>关键数据加密</li>
<li>操作日志记录</li>
<li>防篡改校验</li>
</ul>
</li>
</ul>
<h2 data-id="heading-27">总结要点</h2>
<ol>
<li><strong>架构核心</strong>：分层过滤 + 异步处理 + 最终一致</li>
<li><strong>库存核心</strong>：Redis原子操作 + 消息队列 + 数据库乐观锁</li>
<li><strong>性能核心</strong>：缓存预热 + 流量削峰 + 读写分离</li>
<li><strong>稳定核心</strong>：熔断降级 + 限流隔离 + 快速失败</li>
</ol>
<h2 data-id="heading-28">面试回答</h2>
<p>首先，<strong>架构设计上要动静分离、分层削峰</strong>。我会把系统分为：</p>
<ol>
<li><strong>静态资源分离</strong>：商品图片、描述页等提前推送到CDN，请求直接走边缘节点，不给后端压力。</li>
<li><strong>网关层限流</strong>：在入口用Nginx或网关（如Sentinel）做恶意请求拦截和总流量限制，比如对同一UID限速，超过阈值直接返回“请求频繁”。</li>
<li><strong>业务逻辑后置，请求队列化</strong>：秒杀的核心——“下单扣库存”这个最重要的逻辑，绝不放在前台实时处理。用户点击“抢购”后，前端直接返回“排队中”，请求进入一个<strong>消息队列</strong>（比如RabbitMQ、Kafka或RocketMQ）。这样一来，海量并发就被平滑成顺序处理的流量，后端服务按照自己的能力从队列里慢慢消费，实现<strong>削峰填谷</strong>。</li>
<li><strong>服务独立部署</strong>：把秒杀相关的功能（验资格、扣库存）单独做成一个微服务，避免影响商城其他正常功能（如浏览、普通下单）。</li>
</ol>
<p>其次，针对如何解决超卖、库存扣减和高并发请求这三个核心问题，我的解决方案是：</p>
<ol>
<li><strong>解决超卖和库存扣减</strong>：这是秒杀的核心。我的方案是：</li>
</ol>
<ul>
<li>
<ul>
<li><strong>预扣库存</strong>：活动开始前，把商品的库存从主库加载到<strong>Redis</strong>中。Redis是单线程内存操作，可以保证原子性。</li>
<li><strong>原子化操作</strong>：在Redis里，使用 <code>DECR</code> 或 <code>LUA</code> 脚本来扣减库存。<code>DECR</code> 命令会直接返回扣减后的值，如果返回值小于0，就说明库存没了，后续流程直接返回售罄。LUA脚本可以打包多个操作（检查库存、扣减），确保整个过程原子性，彻底杜绝超卖。</li>
<li><strong>最终同步</strong>：后台服务从队列消费，成功扣减Redis库存后，生成一个订单ID（但状态是“未支付”），再异步去更新数据库的库存。这里数据库的库存更多是用于后续对账和长尾查询。</li>
</ul>
</li>
</ul>
<ol start="2">
<li><strong>应对高并发请求</strong>：</li>
</ol>
<ul>
<li>
<ul>
<li><strong>限流</strong>：除了网关层的总限流，在秒杀服务本身也要做限流，比如用信号量或令牌桶控制处理线程数，只服务自己能承受的流量，多的直接拒绝，快速失败。</li>
<li><strong>无状态化与扩容</strong>：秒杀服务做成无状态的，方便用K8s或云服务快速横向扩容，扛过峰值后再缩容，控制成本。</li>
<li><strong>热点数据隔离</strong>：对于“爆款”商品，它的库存Key在Redis里是热点Key。可以做两件事：一是提前对它进行<strong>Key散列</strong>，把压力分散到多个Redis节点；二是使用Redis集群模式，并开启读写分离。</li>
</ul>
</li>
</ul>
<p>最后，还有一些<strong>关键的细节和兜底策略</strong>：</p>
<ul>
<li><strong>防刷与验证</strong>：前端加入计算型验证码或答题，防止机器人；下单前必须校验用户资格（是否登录、地址完善等）。</li>
<li><strong>异步下单与结果轮询</strong>：用户提交后，服务端返回一个“排队ID”，前端用这个ID轮询后端，查询最终结果（成功、失败或等待）。用户体验上是“排队等待”，而不是一直卡住或报错。</li>
<li><strong>数据一致性对账</strong>：因为用了Redis和消息队列，可能出现极端情况下的数据不一致（比如Redis扣成功，但下游服务挂了，订单没生成）。需要有一个定时对账任务，核对Redis、数据库库存和订单状态，进行修复。</li>
<li><strong>降级与熔断</strong>：如果Redis或数据库访问慢，要有熔断机制，防止服务被拖垮。比如可以快速降级到“返回售罄”的静态页面。</li>
</ul>
<hr/>
<p><strong>总结一下</strong>，我的设计思路是：<strong>前端限流拦截，请求队列削峰；Redis原子扣减防超卖；服务无状态化应对高并发；再通过异步、对账等手段保证最终一致性和用户体验</strong>。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Vite8 Beta来了,Rolldown携手Oxc]]></title>    <link>https://juejin.cn/post/7594626381432487986</link>    <guid>https://juejin.cn/post/7594626381432487986</guid>    <pubDate>2026-01-13T08:13:54.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7594626381432487986" data-draft-id="7594578555352105011" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Vite8 Beta来了,Rolldown携手Oxc"/> <meta itemprop="keywords" content="前端,后端,JavaScript"/> <meta itemprop="datePublished" content="2026-01-13T08:13:54.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="林太白"/> <meta itemprop="url" content="https://juejin.cn/user/1874034273300919"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Vite8 Beta来了,Rolldown携手Oxc
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1874034273300919/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    林太白
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-13T08:13:54.000Z" title="Tue Jan 13 2026 08:13:54 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Vite8 Beta来了,Rolldown携手Oxc</h2>

<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/df7bb3791688449084b08ba66cd2fbfc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5p6X5aSq55m9:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768896833&amp;x-signature=Eyp00QQn064Dq9RAqE4va%2Fl9Mlw%3D" alt="" loading="lazy"/></p>
<p>总结：由 Rolldown 驱动的 Vite</p>
<h3 data-id="heading-1">更新地址</h3>
<p>相关更新地址</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// github地址</span>
<span class="hljs-attr">https</span>:<span class="hljs-comment">//github.com/vitejs/vite/blob/main/packages/vite/CHANGELOG.md</span>

<span class="hljs-comment">// 官方给我们的更新地址</span>
<span class="hljs-attr">https</span>:<span class="hljs-comment">//cn.vitejs.dev/guide/migration</span>

<span class="hljs-comment">// 更新说明地址</span>
<span class="hljs-attr">https</span>:<span class="hljs-comment">//vite.dev/blog/announcing-vite8-beta</span>
</code></pre>
<p>接下来我们就看看vite8更新了哪些东西</p>
<h3 data-id="heading-2">重大更新</h3>
<p>先来看看有哪些重大的更新方面</p>
<ul>
<li><strong>性能</strong>：Rolldown 使用 Rust 编写，运行速度与原生应用相当。它的性能水平与 esbuild 相匹配，并且比 Rollup 快 10-30 倍。</li>
<li><strong>兼容性</strong>：Rolldown 支持与 Rollup 和 Vite 相同的插件 API。大多数 Vite 插件在 Vite 8 中可以开箱即用。</li>
<li><strong>更多功能</strong>：Rolldown 为 Vite 解锁了更多高级功能，包括完整打包模式、更灵活的分块控制、模块级持久缓存、模块联邦等。</li>
</ul>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-title class_">Vite</span>（构建工具）
<span class="hljs-title class_">Rolldown</span>（打包器）
<span class="hljs-title class_">Oxc</span>（编译器、压缩器）
</code></pre>
<h4 data-id="heading-3">统一工具链</h4>
<pre><code class="hljs language-javascript" lang="javascript">打包工具利用
语法解析器（parsers）
依赖解析器（resolvers）
转换器（transformers）
压缩器（minifiers）
</code></pre>
<p>Rolldown 为统一工具链使用了由VoidZero 团队主导的项目Oxc</p>
<h4 data-id="heading-4">Rolldown</h4>
<p>作用：使用Rolldown 替代esbuild 和 Rollup</p>
<p>Vite 8 基于Rolldown 和 Oxc 的工具，而不是 esbuild 和 Rollup</p>
<p>Vite之前的引擎架构——开发用 esbuild，生产用 Rollup</p>
<h4 data-id="heading-5">使用 Oxc 转换 JavaScript</h4>
<p>使用 Oxc 进行 JavaScript 转换，而不是 esbuild</p>
<h4 data-id="heading-6">使用 Lightning CSS 进行 CSS 压缩</h4>
<p>默认使用 Lightning CSS 进行 CSS 压缩。你可以使用 <code>build.cssMinify: 'esbuild'</code> 选项切换回 esbuild。请注意，你需要将 <code>esbuild</code> 安装为 <code>devDependency</code>。</p>
<p>Lightning CSS 支持更好的语法降级，你的 CSS 包大小可能会略有增加</p>
<h4 data-id="heading-7">一些移除和弃用</h4>
<p>我们简单看看一些废弃和弃用的部分</p>
<p>非常重要更新,我建议是正式版出来直接移除esbuild</p>
<pre><code class="hljs language-javascript" lang="javascript">esbuild 现在已被弃用，将来会被移除
</code></pre>
<p>弃用以及将要移除，尽快处理</p>
<pre><code class="hljs language-javascript" lang="javascript">optimizeDeps.<span class="hljs-property">esbuildOptions</span> 弃用 =&gt; 将来会被移除


build.<span class="hljs-property">rollupOptions</span>.<span class="hljs-property">watch</span>.<span class="hljs-property">chokidar</span> 移除 
=&gt; 
迁移到 build.<span class="hljs-property">rolldownOptions</span>.<span class="hljs-property">watch</span>.<span class="hljs-property">notify</span> 


build.<span class="hljs-property">rollupOptions</span>.<span class="hljs-property">output</span>.<span class="hljs-property">manualChunks</span> 弃用 
=&gt; 
更新成为 advancedChunks

<span class="hljs-comment">// advancedChunks文档使用</span>
<span class="hljs-attr">https</span>:<span class="hljs-comment">//rolldown.rs/in-depth/advanced-chunks</span>


build.<span class="hljs-property">rollupOptions</span>
=&gt; 重命名为 build.<span class="hljs-property">rolldownOptions</span>

worker.<span class="hljs-property">rollupOptions</span>
  =&gt; 重命名为 worker.<span class="hljs-property">rolldownOptions</span>

build.<span class="hljs-property">commonjsOptions</span>：
  =&gt; 现在无操作效果
</code></pre>
<p>自动转换</p>
<pre><code class="hljs language-javascript" lang="javascript">esbuildOptions.<span class="hljs-property">minify</span> -&gt; rolldownOptions.<span class="hljs-property">output</span>.<span class="hljs-property">minify</span>
esbuildOptions.<span class="hljs-property">treeShaking</span> -&gt; rolldownOptions.<span class="hljs-property">treeshake</span>
esbuildOptions.<span class="hljs-property">define</span> -&gt; rolldownOptions.<span class="hljs-property">transform</span>.<span class="hljs-property">define</span>
esbuildOptions.<span class="hljs-property">loader</span> -&gt; rolldownOptions.<span class="hljs-property">moduleTypes</span>
esbuildOptions.<span class="hljs-property">preserveSymlinks</span> -&gt; !rolldownOptions.<span class="hljs-property">resolve</span>.<span class="hljs-property">symlinks</span>
esbuildOptions.<span class="hljs-property">resolveExtensions</span> -&gt; rolldownOptions.<span class="hljs-property">resolve</span>.<span class="hljs-property">extensions</span>
esbuildOptions.<span class="hljs-property">mainFields</span> -&gt; rolldownOptions.<span class="hljs-property">resolve</span>.<span class="hljs-property">mainFields</span>
esbuildOptions.<span class="hljs-property">conditions</span> -&gt; rolldownOptions.<span class="hljs-property">resolve</span>.<span class="hljs-property">conditionNames</span>
esbuildOptions.<span class="hljs-property">keepNames</span> -&gt; rolldownOptions.<span class="hljs-property">output</span>.<span class="hljs-property">keepNames</span>
esbuildOptions.<span class="hljs-property">platform</span> -&gt; rolldownOptions.<span class="hljs-property">platform</span>
esbuildOptions.<span class="hljs-property">plugins</span> -&gt; rolldownOptions.<span class="hljs-property">plugins</span> (partial support)
</code></pre>
<p>剩余就是一些其余更新，这里不做阐述,基本也不用看，除非用到了</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-attr">https</span>:<span class="hljs-comment">//cn.vite.dev/guide/migration#migration-from-v7</span>
</code></pre>
<h3 data-id="heading-8">项目升级</h3>
<h4 data-id="heading-9">官方升级建议</h4>
<p>官方给我们提供了两种建议适用更新</p>
<h5 data-id="heading-10">直接升级：</h5>
<p>更新 package.json 并运行常规的开发和构建命令。</p>
<p>适合：自己的项目和博客</p>
<h5 data-id="heading-11">渐进式迁移：</h5>
<p>先从 Vite 7 迁移到 rolldown-vite 包，然后再到 Vite 8。</p>
<p>这样你可以识别出与 Rolldown 相关的不兼容性或问题，而无需对 Vite 进行其他更改。</p>
<p>适合：较大或复杂的项目或者稳定项目</p>
<h4 data-id="heading-12">项目更新</h4>
<p>接下来我们就在我们项目之中升级并且使用这些部分</p>
<p>我本地的Node版本为<code>Node 22.16.0</code></p>
<p>我们本地是vite7，官方的建议是</p>
<p>对于从 rolldown-vite 迁移到 Vite 8 的用户，你可以撤销 package.json 中的依赖变更并更新到 Vite 8</p>
<pre><code class="hljs language-javascript" lang="javascript">{
  <span class="hljs-string">"devDependencies"</span>: {
    <span class="hljs-string">"vite"</span>: <span class="hljs-string">"^8.0.0"</span>
  }
}
</code></pre>
<p>运行我们的更新命令</p>
<pre><code class="hljs language-javascript" lang="javascript">pnpm add -D vite@<span class="hljs-number">8.0</span><span class="hljs-number">.0</span>-beta<span class="hljs-number">.0</span> @vitejs/plugin-vue@latest
</code></pre>
<p>执行完以后可以看到我们安装文件部分更新</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-string">"vite"</span>: <span class="hljs-string">"8.0.0-beta.0"</span>,
</code></pre>
<p>更新完成以后提示我们</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-attr">devDependencies</span>:
- vite <span class="hljs-number">7.3</span><span class="hljs-number">.0</span>
+ vite <span class="hljs-number">8.0</span><span class="hljs-number">.0</span>-beta<span class="hljs-number">.0</span>
</code></pre>
<p>然后正常启动打包都没问题,速度上可能因为我的项目比较小，没有太大的区别，打包的体积确实小了</p>
<h4 data-id="heading-13">manualChunks更新</h4>
<p>官方之前对于这部分进行了更新，我们配置一下</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 旧写法，Vite 8 直接报错</span>
<span class="hljs-attr">rollupOptions</span>: {
  <span class="hljs-attr">output</span>: {
    <span class="hljs-attr">manualChunks</span>: {
      <span class="hljs-string">'vue-vendor'</span>: [<span class="hljs-string">'vue'</span>, <span class="hljs-string">'pinia'</span>],
      <span class="hljs-string">'monaco'</span>: [<span class="hljs-string">'monaco-editor'</span>],
    }
  }
}


<span class="hljs-comment">// 新写法</span>
<span class="hljs-attr">rollupOptions</span>: {
  <span class="hljs-attr">output</span>: {
    <span class="hljs-attr">advancedChunks</span>: {
      <span class="hljs-attr">groups</span>: [
        { <span class="hljs-attr">name</span>: <span class="hljs-string">'vue-vendor'</span>, <span class="hljs-attr">test</span>: <span class="hljs-regexp">/[\\/]node_modules[\\/](vue|pinia)[\\/]/</span> },
        { <span class="hljs-attr">name</span>: <span class="hljs-string">'monaco'</span>, <span class="hljs-attr">test</span>: <span class="hljs-regexp">/[\\/]node_modules[\\/]monaco-editor[\\/]/</span> },
      ]
    }
  }
}

</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[为什么"算法推荐"这么准？——从协同过滤到深度学习]]></title>    <link>https://juejin.cn/post/7594402344618131471</link>    <guid>https://juejin.cn/post/7594402344618131471</guid>    <pubDate>2026-01-13T08:36:58.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7594402344618131471" data-draft-id="7594655863547379764" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content=" 为什么&quot;算法推荐&quot;这么准？——从协同过滤到深度学习"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2026-01-13T08:36:58.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="无限大6"/> <meta itemprop="url" content="https://juejin.cn/user/2865758605422890"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
             为什么"算法推荐"这么准？——从协同过滤到深度学习
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2865758605422890/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    无限大6
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-13T08:36:58.000Z" title="Tue Jan 13 2026 08:36:58 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读15分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#595959;font-size:15px;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(60,10,30,.04) 3%,transparent 0),linear-gradient(1turn,rgba(60,10,30,.04) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body p{color:#595959;font-size:15px;line-height:2;font-weight:400}.markdown-body p+p{margin-top:16px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin:0;color:#135ce0}.markdown-body h1{position:relative;text-align:center;font-size:22px;margin:50px 0}.markdown-body h1:before{position:absolute;content:"";top:-10px;left:50%;width:32px;height:32px;transform:translateX(-50%);background-size:100% 100%;opacity:.36;background-repeat:no-repeat;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC)}.markdown-body h2{position:relative;font-size:20px;border-left:4px solid;padding:0 0 0 10px;margin:30px 0}.markdown-body h3{font-size:16px}.markdown-body ul{list-style:disc outside;margin-left:2em;margin-top:1em}.markdown-body li{line-height:2;color:#595959}.markdown-body img.loaded{margin:0 auto;display:block}.markdown-body blockquote{background:#fff9f9;margin:2em 0;padding:2px 20px;border-left:4px solid #b2aec5}.markdown-body blockquote p{color:#666;line-height:2}.markdown-body a{color:#036aca;border-bottom:1px solid rgba(3,106,202,.8);font-weight:400;text-decoration:none}.markdown-body em strong,.markdown-body strong{color:#036aca}.markdown-body hr{border-top:1px solid #135ce0}.markdown-body pre{overflow:auto}.markdown-body code,.markdown-body pre{overflow:auto;position:relative;line-height:1.75;font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body table{border-collapse:collapse;margin:1rem 0;overflow-x:auto}.markdown-body table td,.markdown-body table th{border:1px solid #dfe2e5;padding:.6em 1em}.markdown-body table tr{border-top:1px solid #dfe2e5}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">🎯 为什么"算法推荐"这么准？——从协同过滤到深度学习 🤖</h2>
<blockquote>
<p>大家好，我是无限大，欢迎收看十万个为什么系列文章</p>
<p>希望今天的内容能对大家有所帮助</p>
</blockquote>
<p>想象一下：你打开抖音，刷到的都是你喜欢的视频；你打开淘宝，首页推荐的都是你想买的商品；你打开 Netflix，推荐的都是你想看的电影——这是不是很神奇？</p>
<p>这就是<strong>算法推荐</strong>的魔力！它就像你的"贴心小助手"，总能知道你喜欢什么，想要什么。</p>
<h3 data-id="heading-1">🤔 核心问题：算法推荐的工作原理是什么？为什么能准确预测用户喜好？</h3>
<p>很多人觉得"算法推荐"是个神秘的黑盒子，其实它的本质很简单：<strong>通过分析你的行为数据，找到你的喜好规律，然后推荐符合你喜好的内容</strong>。</p>
<h4 data-id="heading-2">算法推荐的"四大法宝"</h4>
<ul>
<li>📊 <strong>数据收集</strong>：收集你的浏览、点击、购买、评分等行为数据</li>
<li>🧠 <strong>用户画像</strong>：构建你的兴趣模型，了解你的喜好</li>
<li>🔍 <strong>相似度计算</strong>：找到与你兴趣相似的用户或内容</li>
<li>🚀 <strong>推荐算法</strong>：根据相似度和其他因素生成推荐结果</li>
</ul>
<h4 data-id="heading-3">为什么算法推荐这么准？</h4>
<ul>
<li>📱 <strong>数据量庞大</strong>：每天收集海量的用户行为数据</li>
<li>🧮 <strong>机器学习</strong>：通过深度学习模型不断优化推荐结果</li>
<li>🔄 <strong>实时更新</strong>：根据你的最新行为实时调整推荐</li>
<li>🎯 <strong>个性化定制</strong>：为每个用户生成独一无二的推荐列表</li>
</ul>
<h3 data-id="heading-4">📜 从"协同过滤"到"深度学习"：算法推荐的进化史</h3>
<h4 data-id="heading-5">1. 🤝 早期协同过滤："物以类聚，人以群分"</h4>
<p>20 世纪 90 年代，<strong>协同过滤</strong>算法诞生，这是最早的推荐算法。</p>
<p><strong>原理</strong>：</p>
<ul>
<li><strong>基于用户的协同过滤</strong>：找到与你兴趣相似的用户，推荐他们喜欢的内容</li>
<li><strong>基于物品的协同过滤</strong>：找到与你喜欢的内容相似的内容，推荐给你</li>
</ul>
<p><strong>特点</strong>：</p>
<ul>
<li>不需要内容的详细信息</li>
<li>能够发现用户的潜在兴趣</li>
<li>推荐结果具有多样性</li>
</ul>
<p><strong>局限性</strong>：</p>
<ul>
<li>冷启动问题（新用户或新物品无法推荐）</li>
<li>数据稀疏性问题</li>
<li>计算复杂度高</li>
</ul>
<p><strong>代表应用</strong>：早期的亚马逊推荐、MovieLens 电影推荐</p>
<h4 data-id="heading-6">2. 📝 基于内容的推荐："内容为王"</h4>
<p>2000 年代，<strong>基于内容的推荐</strong>算法开始兴起。</p>
<p><strong>原理</strong>：</p>
<ul>
<li>分析内容的特征（如电影的类型、演员、导演）</li>
<li>分析用户的历史行为，构建用户兴趣模型</li>
<li>将用户兴趣与内容特征匹配，生成推荐</li>
</ul>
<p><strong>特点</strong>：</p>
<ul>
<li>不依赖其他用户的数据</li>
<li>容易解释推荐原因</li>
<li>可以处理冷启动问题</li>
</ul>
<p><strong>局限性</strong>：</p>
<ul>
<li>推荐结果缺乏多样性</li>
<li>只能推荐与用户历史兴趣相似的内容</li>
<li>对内容特征的提取要求较高</li>
</ul>
<p><strong>代表应用</strong>：新闻推荐、音乐推荐</p>
<h4 data-id="heading-7">3. 🧠 深度学习推荐："AI 驱动的推荐"</h4>
<p>2010 年代，随着深度学习的兴起，<strong>深度学习推荐</strong>算法成为主流。</p>
<p><strong>原理</strong>：</p>
<ul>
<li>使用深度神经网络自动学习用户和内容的特征</li>
<li>能够处理非结构化数据（如图片、音频、视频）</li>
<li>可以捕捉用户兴趣的动态变化</li>
</ul>
<p><strong>特点</strong>：</p>
<ul>
<li>推荐准确率高</li>
<li>能够处理复杂的非线性关系</li>
<li>可以整合多种数据源</li>
</ul>
<p><strong>局限性</strong>：</p>
<ul>
<li>计算资源需求高</li>
<li>推荐结果难以解释</li>
<li>容易出现"过滤气泡"问题</li>
</ul>
<p><strong>代表应用</strong>：抖音、淘宝、Netflix</p>
<h4 data-id="heading-8">4. 🌈 多模态推荐："视听结合"</h4>
<p>2020 年代，<strong>多模态推荐</strong>算法开始崭露头角。</p>
<p><strong>原理</strong>：</p>
<ul>
<li>同时处理多种模态的数据（文本、图像、音频、视频）</li>
<li>学习不同模态之间的关联关系</li>
<li>生成更全面、更准确的推荐</li>
</ul>
<p><strong>特点</strong>：</p>
<ul>
<li>能够捕捉内容的丰富信息</li>
<li>推荐结果更加精准</li>
<li>可以处理复杂的多媒体内容</li>
</ul>
<p><strong>代表应用</strong>：短视频推荐、直播推荐、元宇宙内容推荐</p>
<h3 data-id="heading-9">🔧 技术原理：算法推荐的"秘密武器"</h3>
<h4 data-id="heading-10">1. 📱 用户画像构建："了解你的喜好"</h4>
<p>用户画像是算法推荐的<strong>基础</strong>，它是对用户兴趣的<strong>数字化描述</strong>。</p>
<p><strong>构建用户画像的步骤</strong>：</p>
<ul>
<li><strong>数据收集</strong>：收集用户的基本信息、行为数据、内容偏好等</li>
<li><strong>特征提取</strong>：从数据中提取有价值的特征（如年龄、性别、兴趣标签）</li>
<li><strong>模型构建</strong>：使用机器学习算法构建用户兴趣模型</li>
<li><strong>持续更新</strong>：根据用户的最新行为实时更新用户画像</li>
</ul>
<p><strong>用户画像的类型</strong>：</p>
<ul>
<li><strong>显性画像</strong>：用户主动提供的信息（如性别、年龄、职业）</li>
<li><strong>隐性画像</strong>：通过行为数据推断的信息（如兴趣偏好、消费能力）</li>
</ul>
<h4 data-id="heading-11">2. 🎨 物品特征提取："了解内容的特点"</h4>
<p>物品特征是算法推荐的<strong>另一个基础</strong>，它是对内容的<strong>数字化描述</strong>。</p>
<p><strong>常见的物品特征</strong>：</p>
<ul>
<li><strong>文本特征</strong>：标题、描述、标签、关键词</li>
<li><strong>图像特征</strong>：颜色、形状、纹理、物体识别结果</li>
<li><strong>音频特征</strong>：频谱、节奏、音调、情感</li>
<li><strong>视频特征</strong>：镜头切换、动作识别、场景识别</li>
</ul>
<p><strong>特征提取的方法</strong>：</p>
<ul>
<li><strong>传统方法</strong>：TF-IDF、Word2Vec、CNN 等</li>
<li><strong>深度学习方法</strong>：BERT、GPT、ResNet、Transformer 等</li>
</ul>
<h4 data-id="heading-12">3. 🔍 相似度计算："找到相似的人或内容"</h4>
<p>相似度计算是算法推荐的<strong>核心</strong>，它决定了推荐的准确性。</p>
<p><strong>常见的相似度算法</strong>：</p>
<ul>
<li><strong>余弦相似度</strong>：计算两个向量之间的夹角</li>
<li><strong>皮尔逊相关系数</strong>：计算两个变量之间的线性相关性</li>
<li><strong>杰卡德相似度</strong>：计算两个集合的交集与并集的比值</li>
<li><strong>欧几里得距离</strong>：计算两个点之间的直线距离</li>
</ul>
<p><strong>相似度计算的应用</strong>：</p>
<ul>
<li><strong>用户相似度</strong>：找到与你兴趣相似的用户</li>
<li><strong>物品相似度</strong>：找到与你喜欢的内容相似的内容</li>
</ul>
<h4 data-id="heading-13">4. 🤖 深度神经网络模型："AI 的大脑"</h4>
<p>深度神经网络是现代推荐算法的<strong>核心</strong>，它能够自动学习复杂的非线性关系。</p>
<p><strong>常见的深度学习推荐模型</strong>：</p>
<ul>
<li><strong>MLP（多层感知器）</strong>：基础的深度学习模型</li>
<li><strong>Wide &amp; Deep</strong>：结合了线性模型和深度模型的优点</li>
<li><strong>DeepFM</strong>：结合了因子分解机和深度模型的优点</li>
<li><strong>DIN（深度兴趣网络）</strong>：能够捕捉用户的动态兴趣</li>
<li><strong>BERT4Rec</strong>：基于 BERT 的序列推荐模型</li>
<li><strong>Transformer4Rec</strong>：基于 Transformer 的序列推荐模型</li>
</ul>
<h3 data-id="heading-14">💻 代码实例：简单的协同过滤推荐算法</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> numpy <span class="hljs-keyword">as</span> np
<span class="hljs-keyword">from</span> sklearn.metrics.pairwise <span class="hljs-keyword">import</span> cosine_similarity

<span class="hljs-keyword">class</span> <span class="hljs-title class_">CollaborativeFiltering</span>:
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, user_item_matrix</span>):
        <span class="hljs-string">"""初始化协同过滤模型"""</span>
        self.user_item_matrix = user_item_matrix
        self.user_similarity = <span class="hljs-literal">None</span>
        self.item_similarity = <span class="hljs-literal">None</span>

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">calculate_user_similarity</span>(<span class="hljs-params">self</span>):
        <span class="hljs-string">"""计算用户相似度"""</span>
        self.user_similarity = cosine_similarity(self.user_item_matrix)
        <span class="hljs-keyword">return</span> self.user_similarity

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">calculate_item_similarity</span>(<span class="hljs-params">self</span>):
        <span class="hljs-string">"""计算物品相似度"""</span>
        self.item_similarity = cosine_similarity(self.user_item_matrix.T)
        <span class="hljs-keyword">return</span> self.item_similarity

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">predict_user_based</span>(<span class="hljs-params">self, user_id, item_id, k=<span class="hljs-number">3</span></span>):
        <span class="hljs-string">"""基于用户的协同过滤预测"""</span>
        <span class="hljs-comment"># 找到与目标用户最相似的k个用户</span>
        similar_users = np.argsort(self.user_similarity[user_id])[-k-<span class="hljs-number">1</span>:-<span class="hljs-number">1</span>][::-<span class="hljs-number">1</span>]

        <span class="hljs-comment"># 计算预测评分</span>
        numerator = <span class="hljs-number">0</span>
        denominator = <span class="hljs-number">0</span>

        <span class="hljs-keyword">for</span> sim_user <span class="hljs-keyword">in</span> similar_users:
            <span class="hljs-keyword">if</span> self.user_item_matrix[sim_user, item_id] &gt; <span class="hljs-number">0</span>:
                numerator += self.user_similarity[user_id, sim_user] * self.user_item_matrix[sim_user, item_id]
                denominator += self.user_similarity[user_id, sim_user]

        <span class="hljs-keyword">if</span> denominator == <span class="hljs-number">0</span>:
            <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>

        <span class="hljs-keyword">return</span> numerator / denominator

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">recommend_items</span>(<span class="hljs-params">self, user_id, k=<span class="hljs-number">3</span></span>):
        <span class="hljs-string">"""为用户推荐k个物品"""</span>
        <span class="hljs-comment"># 计算用户相似度</span>
        <span class="hljs-keyword">if</span> self.user_similarity <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:
            self.calculate_user_similarity()

        <span class="hljs-comment"># 找到用户已经评分的物品</span>
        rated_items = <span class="hljs-built_in">set</span>(np.where(self.user_item_matrix[user_id] &gt; <span class="hljs-number">0</span>)[<span class="hljs-number">0</span>])

        <span class="hljs-comment"># 预测未评分物品的评分</span>
        predictions = []
        <span class="hljs-keyword">for</span> item_id <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(self.user_item_matrix.shape[<span class="hljs-number">1</span>]):
            <span class="hljs-keyword">if</span> item_id <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> rated_items:
                predicted_score = self.predict_user_based(user_id, item_id)
                predictions.append((item_id, predicted_score))

        <span class="hljs-comment"># 按照预测评分排序，推荐k个物品</span>
        predictions.sort(key=<span class="hljs-keyword">lambda</span> x: x[<span class="hljs-number">1</span>], reverse=<span class="hljs-literal">True</span>)
        <span class="hljs-keyword">return</span> predictions[:k]

<span class="hljs-comment"># 测试协同过滤算法</span>
<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">"__main__"</span>:
    <span class="hljs-comment"># 构建用户-物品评分矩阵</span>
    <span class="hljs-comment"># 用户：0,1,2,3,4</span>
    <span class="hljs-comment"># 物品：0,1,2,3,4</span>
    user_item_matrix = np.array([
        [<span class="hljs-number">5</span>, <span class="hljs-number">4</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>],  <span class="hljs-comment"># 用户0</span>
        [<span class="hljs-number">5</span>, <span class="hljs-number">0</span>, <span class="hljs-number">3</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>],  <span class="hljs-comment"># 用户1</span>
        [<span class="hljs-number">0</span>, <span class="hljs-number">2</span>, <span class="hljs-number">0</span>, <span class="hljs-number">4</span>, <span class="hljs-number">0</span>],  <span class="hljs-comment"># 用户2</span>
        [<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">4</span>, <span class="hljs-number">3</span>, <span class="hljs-number">5</span>],  <span class="hljs-comment"># 用户3</span>
        [<span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">5</span>, <span class="hljs-number">0</span>]   <span class="hljs-comment"># 用户4</span>
    ])

    <span class="hljs-comment"># 创建协同过滤模型</span>
    cf = CollaborativeFiltering(user_item_matrix)

    <span class="hljs-comment"># 计算用户相似度</span>
    user_sim = cf.calculate_user_similarity()
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"📊 用户相似度矩阵："</span>)
    <span class="hljs-built_in">print</span>(np.<span class="hljs-built_in">round</span>(user_sim, <span class="hljs-number">2</span>))

    <span class="hljs-comment"># 计算物品相似度</span>
    item_sim = cf.calculate_item_similarity()
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"\n📊 物品相似度矩阵："</span>)
    <span class="hljs-built_in">print</span>(np.<span class="hljs-built_in">round</span>(item_sim, <span class="hljs-number">2</span>))

    <span class="hljs-comment"># 为用户0推荐物品</span>
    recommendations = cf.recommend_items(<span class="hljs-number">0</span>, k=<span class="hljs-number">2</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"\n🎯 为用户0推荐的物品："</span>)
    <span class="hljs-keyword">for</span> item_id, score <span class="hljs-keyword">in</span> recommendations:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"物品<span class="hljs-subst">{item_id}</span>，预测评分：<span class="hljs-subst">{score:<span class="hljs-number">.2</span>f}</span>"</span>)

    <span class="hljs-comment"># 运行结果</span>
    <span class="hljs-comment"># 📊 用户相似度矩阵：</span>
    <span class="hljs-comment"># [[1.   0.59 0.4  0.   0.  ]</span>
    <span class="hljs-comment">#  [0.59 1.   0.   0.8  0.71]</span>
    <span class="hljs-comment">#  [0.4  0.   1.   0.55 0.98]</span>
    <span class="hljs-comment">#  [0.   0.8  0.55 1.   0.89]</span>
    <span class="hljs-comment">#  [0.   0.71 0.98 0.89 1.  ]]</span>
    <span class="hljs-comment">#</span>
    <span class="hljs-comment"># 📊 物品相似度矩阵：</span>
    <span class="hljs-comment"># [[1.   0.83 0.54 0.   0.  ]</span>
    <span class="hljs-comment">#  [0.83 1.   0.4  0.17 0.89]</span>
    <span class="hljs-comment">#  [0.54 0.4  1.   0.91 0.83]</span>
    <span class="hljs-comment">#  [0.   0.17 0.91 1.   0.93]</span>
    <span class="hljs-comment">#  [0.   0.89 0.83 0.93 1.  ]]</span>
    <span class="hljs-comment">#</span>
    <span class="hljs-comment"># 🎯 为用户0推荐的物品：</span>
    <span class="hljs-comment"># 物品2，预测评分：3.42</span>
    <span class="hljs-comment"># 物品1，预测评分：3.00</span>
</code></pre>
<h3 data-id="heading-15">📊 趣味对比：不同推荐算法的优缺点</h3>








































<table><thead><tr><th>算法类型</th><th>核心原理</th><th>优点</th><th>缺点</th><th>代表应用</th></tr></thead><tbody><tr><td>🤝<strong>协同过滤</strong></td><td>基于用户或物品的相似度</td><td>不需要内容特征、能发现潜在兴趣、推荐结果多样</td><td>冷启动问题、数据稀疏性、计算复杂度高</td><td>早期亚马逊、MovieLens</td></tr><tr><td>📝<strong>基于内容的推荐</strong></td><td>基于内容特征匹配</td><td>不存在冷启动问题、推荐结果可解释、计算复杂度低</td><td>推荐结果缺乏多样性、只能推荐相似内容</td><td>新闻推荐、音乐推荐</td></tr><tr><td>🧠<strong>深度学习推荐</strong></td><td>基于深度神经网络</td><td>推荐准确率高、能处理复杂数据、能捕捉动态兴趣</td><td>计算资源需求高、推荐结果难以解释、容易出现过滤气泡</td><td>抖音、淘宝、Netflix</td></tr><tr><td>🌈<strong>多模态推荐</strong></td><td>基于多种模态数据</td><td>能捕捉内容的丰富信息、推荐结果更精准</td><td>数据处理复杂、模型训练困难</td><td>短视频推荐、直播推荐、元宇宙内容推荐</td></tr></tbody></table>
<h3 data-id="heading-16">🏢 算法推荐的应用场景：无处不在的推荐</h3>



























































<table><thead><tr><th>应用场景</th><th>举例</th><th>推荐内容</th><th>核心算法</th></tr></thead><tbody><tr><td>📱<strong>社交媒体</strong></td><td>抖音、快手、微博</td><td>短视频、图文、直播</td><td>深度学习推荐、多模态推荐</td></tr><tr><td>🛒<strong>电商平台</strong></td><td>淘宝、京东、拼多多</td><td>商品、优惠券、活动</td><td>协同过滤、深度学习推荐</td></tr><tr><td>🎬<strong>视频平台</strong></td><td>Netflix、YouTube、B 站</td><td>电影、电视剧、短视频</td><td>深度学习推荐、序列推荐</td></tr><tr><td>🎵<strong>音乐平台</strong></td><td>Spotify、网易云音乐、QQ 音乐</td><td>歌曲、歌单、歌手</td><td>基于内容的推荐、协同过滤</td></tr><tr><td>📚<strong>阅读平台</strong></td><td>微信读书、起点中文网、番茄小说</td><td>书籍、章节、作者</td><td>基于内容的推荐、协同过滤</td></tr><tr><td>🎮<strong>游戏平台</strong></td><td>Steam、Epic Games、TapTap</td><td>游戏、DLC、攻略</td><td>协同过滤、基于内容的推荐</td></tr><tr><td>🛫<strong>旅行平台</strong></td><td>携程、去哪儿、飞猪</td><td>机票、酒店、景点</td><td>协同过滤、深度学习推荐</td></tr><tr><td>🍔<strong>外卖平台</strong></td><td>美团外卖、饿了么、百度外卖</td><td>餐厅、菜品、优惠</td><td>协同过滤、深度学习推荐</td></tr></tbody></table>
<h3 data-id="heading-17">📈 数据支撑：算法推荐的"硬核实力"</h3>
<ul>
<li>🎬 <strong>算法推荐贡献了 Netflix 80%的播放量</strong>，用户平均观看时长增加 30%以上</li>
<li>📺 <strong>YouTube 90%的观看时间来自推荐</strong>，用户留存率提高 40%以上</li>
<li>🛒 <strong>淘宝 60%的成交额来自推荐</strong>，用户购买转化率提高 20%以上</li>
<li>📱 <strong>抖音 70%的视频观看量来自推荐</strong>，用户日均使用时长超过 2 小时</li>
<li>🎵 <strong>Spotify 60%的新歌曲发现来自推荐</strong>，用户付费转化率提高 15%以上</li>
<li>📚 <strong>微信读书 50%的书籍阅读量来自推荐</strong>，用户阅读时长增加 50%以上</li>
<li>🎮 <strong>Steam 45%的游戏购买来自推荐</strong>，用户游戏时长增加 25%以上</li>
</ul>
<h3 data-id="heading-18">⚠️ 常见误区纠正</h3>
<h4 data-id="heading-19">1. "算法推荐在监听我的对话？"</h4>
<p><strong>错！</strong> 算法推荐主要基于你的行为数据（浏览、点击、购买等），而不是监听你的对话。虽然有些应用可能会请求麦克风权限，但主要用于语音识别功能，而不是为了监听你说话来做推荐。</p>
<h4 data-id="heading-20">2. "算法推荐只会推荐我喜欢的内容，限制了我的视野？"</h4>
<p><strong>不一定！</strong> 算法推荐的目标是平衡"准确性"和"多样性"。好的推荐系统会在推荐你喜欢的内容的同时，也推荐一些新的、相关的内容，帮助你发现新的兴趣。</p>
<h4 data-id="heading-21">3. "算法推荐是完全客观的？"</h4>
<p><strong>错！</strong> 算法推荐会受到训练数据的影响，如果训练数据存在偏见，推荐结果也会存在偏见。比如，如果训练数据中男性用户更多，推荐系统可能会更偏向男性用户的兴趣。</p>
<h4 data-id="heading-22">4. "算法推荐会泄露我的隐私？"</h4>
<p><strong>可能！</strong> 算法推荐需要收集大量的用户行为数据，如果数据处理不当，可能会导致隐私泄露。不过，大多数正规平台都会采取严格的数据保护措施，比如数据加密、匿名化处理等。</p>
<h4 data-id="heading-23">5. "算法推荐越精准越好？"</h4>
<p><strong>不一定！</strong> 算法推荐太精准可能会导致"过滤气泡"问题，让你只看到你喜欢的内容，限制你的视野。好的推荐系统应该在精准性和多样性之间找到平衡。</p>
<h4 data-id="heading-24">6. "算法推荐是不可控制的？"</h4>
<p><strong>错！</strong> 大多数应用都提供了推荐设置，你可以调整推荐的偏好，或者关闭某些类型的推荐。比如，你可以在抖音的设置中关闭"个性化推荐"，或者调整推荐的内容类型。</p>
<h4 data-id="heading-25">7. "算法推荐只适用于大公司？"</h4>
<p><strong>错！</strong> 现在有很多开源的推荐系统框架（如 TensorFlow Recommenders、Surprise），小公司也可以轻松搭建自己的推荐系统。</p>
<h4 data-id="heading-26">8. "算法推荐的原理很复杂，普通人无法理解？"</h4>
<p><strong>错！</strong> 算法推荐的核心原理其实很简单，就是基于你的行为数据找到你的喜好规律。虽然深度学习模型的内部工作机制比较复杂，但基本原理是容易理解的。</p>
<h3 data-id="heading-27">🔮 未来展望：算法推荐的发展趋势</h3>
<h4 data-id="heading-28">1. 🤖 AI 大模型与推荐系统结合</h4>
<ul>
<li><strong>GPT-4、Claude、Gemini 等大模型</strong>将融入推荐系统</li>
<li><strong>生成式推荐</strong>：直接生成个性化的推荐理由和内容描述</li>
<li><strong>多轮对话式推荐</strong>：通过对话了解用户的具体需求，生成更精准的推荐</li>
</ul>
<h4 data-id="heading-29">2. 🌈 多模态推荐的普及</h4>
<ul>
<li><strong>同时处理文本、图像、音频、视频等多种模态数据</strong></li>
<li><strong>跨模态推荐</strong>：根据用户的文本兴趣推荐视频内容，或者根据用户的视频兴趣推荐文本内容</li>
<li><strong>3D 和 VR/AR 内容推荐</strong>：为 VR/AR 设备推荐适配的 3D 内容</li>
</ul>
<h4 data-id="heading-30">3. 📱 移动端和边缘端的优化</h4>
<ul>
<li><strong>轻量级推荐模型</strong>：适合在手机等资源受限设备上运行</li>
<li><strong>边缘计算推荐</strong>：在用户设备上进行推荐计算，保护用户隐私</li>
<li><strong>实时推荐</strong>：根据用户的实时位置、心情、上下文生成推荐</li>
</ul>
<h4 data-id="heading-31">4. 🔒 隐私保护和可解释性</h4>
<ul>
<li><strong>联邦学习</strong>：在不泄露原始数据的情况下进行模型训练</li>
<li><strong>差分隐私</strong>：在推荐结果中加入噪声，保护用户隐私</li>
<li><strong>可解释性推荐</strong>：向用户解释为什么推荐某个内容，提高用户信任度</li>
</ul>
<h4 data-id="heading-32">5. 🌍 跨平台和跨设备推荐</h4>
<ul>
<li><strong>统一的推荐系统</strong>：在不同平台和设备上为用户提供一致的推荐体验</li>
<li><strong>上下文感知推荐</strong>：根据用户当前使用的设备、时间、地点生成推荐</li>
<li><strong>多设备协同推荐</strong>：结合用户在不同设备上的行为生成推荐</li>
</ul>
<h3 data-id="heading-33">🎓 互动小测验：你答对了吗？</h3>


















































<table><thead><tr><th>问题</th><th>答案</th><th>你答对了吗？</th></tr></thead><tbody><tr><td>最早的推荐算法是什么？</td><td>协同过滤</td><td>✅/❌</td></tr><tr><td>算法推荐贡献了 Netflix 多少播放量？</td><td>80%</td><td>✅/❌</td></tr><tr><td>YouTube 多少观看时间来自推荐？</td><td>90%</td><td>✅/❌</td></tr><tr><td>深度学习推荐的主要优点是什么？</td><td>推荐准确率高、能处理复杂数据</td><td>✅/❌</td></tr><tr><td>协同过滤的主要缺点是什么？</td><td>冷启动问题、数据稀疏性</td><td>✅/❌</td></tr><tr><td>什么是"过滤气泡"？</td><td>算法只推荐用户喜欢的内容，限制用户视野</td><td>✅/❌</td></tr><tr><td>多模态推荐处理哪些数据？</td><td>文本、图像、音频、视频等</td><td>✅/❌</td></tr><tr><td>联邦学习的主要作用是什么？</td><td>保护用户隐私</td><td>✅/❌</td></tr></tbody></table>
<h3 data-id="heading-34">🎯 结语：算法推荐——你的"贴心小助手"</h3>
<p>算法推荐已经成为我们数字生活的<strong>重要组成部分</strong>，它就像你的"贴心小助手"，总能知道你喜欢什么，想要什么。</p>
<p>从早期的协同过滤到现在的深度学习推荐，算法推荐技术一直在不断进化，推荐准确率也在不断提高。未来，随着 AI 大模型、多模态推荐、隐私保护等技术的发展，算法推荐将变得更加智能、更加个性化、更加安全。</p>
<p><strong>记住</strong>：</p>
<ul>
<li>🔍 算法推荐的核心是<strong>数据和模型</strong></li>
<li>🎯 好的推荐系统需要平衡<strong>准确性和多样性</strong></li>
<li>🔒 隐私保护是算法推荐的<strong>重要挑战</strong></li>
<li>💡 算法推荐的目的是<strong>帮助你发现更好的内容</strong>，而不是控制你的视野</li>
</ul>
<p>下次当你打开抖音、淘宝、Netflix 时，不妨想想背后的算法推荐技术——正是这些看不见的"小助手"，让我们的数字生活变得更加便捷和丰富！</p>
<h3 data-id="heading-35">💬 互动话题</h3>
<ol>
<li>你觉得算法推荐最准的应用是哪个？为什么？</li>
<li>你遇到过算法推荐的"翻车"时刻吗？</li>
<li>你希望算法推荐在哪些方面改进？</li>
<li>你担心算法推荐的"过滤气泡"问题吗？</li>
<li>你对 AI 大模型与推荐系统结合有什么期待？</li>
</ol>
<p>快来评论区聊聊你的想法！💬 点赞收藏不迷路，咱们下期继续探索计算机的"十万个为什么"！🎉</p>
<p><strong>关注我</strong>，下期带你解锁更多计算机的"奇葩冷知识"！🤓</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[有没有在 iOS 直接抓包 的App？]]></title>    <link>https://juejin.cn/post/7594468778111500322</link>    <guid>https://juejin.cn/post/7594468778111500322</guid>    <pubDate>2026-01-13T08:47:24.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7594468778111500322" data-draft-id="7594662258353930275" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="有没有在 iOS 直接抓包 的App？"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2026-01-13T08:47:24.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="我是谁的程序员"/> <meta itemprop="url" content="https://juejin.cn/user/2390811467846089"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            有没有在 iOS 直接抓包 的App？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2390811467846089/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    我是谁的程序员
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-13T08:47:24.000Z" title="Tue Jan 13 2026 08:47:24 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在开发群里，经常能看到有人问：有没有那种<strong>iOS 直接抓包 App</strong>，装到手机上就能看到所有请求？</p>
<p>这个问题本身，其实已经暴露了一个常见误解。
在 iOS 的安全模型下，<strong>纯手机端直接抓包几乎不可行</strong>，真正可行的方案，很多都是手机 + 电脑的组合，只是有些工具把过程做得更像直接。</p>
<hr/>
<h2 data-id="heading-0"><strong>直接抓包的真实需求场景</strong></h2>
<p>在我遇到的项目里，提出想要直接抓包的通常是下面几种情况：</p>
<ul>
<li>测试环境接口异常，但源码不可改</li>
<li>三方 App 行为不透明，只能观察通信</li>
<li>HTTPS 接口参数复杂，日志不完整</li>
<li>需要在真机上复现线上问题</li>
</ul>
<p>这些场景的共同点是：<strong>不能改 App，只能在设备外部观察网络行为</strong>。</p>
<hr/>
<h2 data-id="heading-1"><strong>为什么 iOS 很难做到真正的手机端抓包</strong></h2>
<p>iOS 不允许普通应用监听系统级网络流量。
所以像 Android 那种在手机上装个 VPN 抓包 App 的方式，在 iOS 上基本走不通。</p>
<p>能做的事情只有两类：</p>
<ul>
<li>通过系统代理，把流量导出</li>
<li>通过 USB，把设备流量镜像到电脑</li>
</ul>
<p>所谓直接，更多是<strong>配置步骤是否复杂</strong>的问题。</p>
<hr/>
<h2 data-id="heading-2"><strong>代理抓包依然是最现实的入口</strong></h2>
<p>在可控环境下，HTTPS 代理仍然是最常用的方案。</p>
<p>Charles、Fiddler、Proxyman 都属于这一类，
抓包大师也是同样的工作原理，只是把证书和配置流程自动化了。</p>
<hr/>
<h2 data-id="heading-3"><strong>使用抓包大师进行 HTTPS 代理抓包的实际流程</strong></h2>
<p>在一次接口联调中，我用的是抓包大师，主要原因是配置成本低。</p>
<p>具体操作过程大致是这样：</p>
<ul>
<li>用 USB 将 iPhone 连接到电脑，保持解锁和亮屏</li>
<li>打开抓包大师，在设备列表中选中当前 iOS 设备</li>
<li>切换到 HTTPS 代理抓包模式</li>
</ul>
<p>如果是第一次使用，会提示安装描述文件和证书。
按照提示在 iOS 设置中信任证书即可。</p>
<p>代理地址和端口会直接显示出来，只需要在当前 Wi-Fi 下设置为手动代理。</p>
<hr/>
<h2 data-id="heading-4"><strong>代理抓包时常见的卡点</strong></h2>
<p>即使流程顺利，也经常会遇到这些问题：</p>
<ul>
<li>装了证书但 HTTPS 还是空白</li>
<li>只有部分接口能看到</li>
<li>某个 App 完全没流量</li>
</ul>
<p>这通常不是工具问题，而是 App 绕过了系统代理。</p>
<hr/>
<h2 data-id="heading-5"><strong>当代理失效，数据流抓包才是真正的底层视角</strong></h2>
<p>如果我怀疑 App 根本没走代理，会直接切换策略。</p>
<p>在抓包大师中，选择<strong>数据流抓包</strong>模式：</p>
<ul>
<li>仍然通过 USB 连接设备</li>
<li>不需要配置代理或证书</li>
<li>直接开始抓取设备发出的 TCP / UDP 数据</li>
</ul>
<p>如果只关心某个 App，可以提前筛选目标应用，避免被系统流量淹没。</p>
<p>这一步的目的只有一个：
确认<strong>这个 App 是否真的在联网，以及用的是什么方式</strong>。</p>
<hr/>
<h2 data-id="heading-6"><strong>在抓包中经常会使用不同的方式去验证</strong></h2>
<p>在一个真实问题中，我通常会这样组合：</p>
<ul>
<li>代理抓包：看 HTTPS 结构和参数</li>
<li>数据流抓包：确认底层通信是否存在</li>
<li>拦截器：验证客户端对响应的处理逻辑</li>
</ul>
<p>没有哪个工具能一次性解决所有问题。</p>
<hr/>
<h2 data-id="heading-7"><strong>拦截器在调试中的实际价值</strong></h2>
<p>当请求已经能被代理捕获，但逻辑依然不明确时，
拦截器比反复猜测代码更直接。</p>
<p>在抓包大师里，可以通过 JS 修改请求或响应：</p>
<ul>
<li>改字段值，验证 UI 依赖</li>
<li>构造异常响应，观察客户端行为</li>
<li>临时重定向请求地址</li>
</ul>
<p>这些操作，往往能在几分钟内确认问题方向。</p>
<hr/>
<h2 data-id="heading-8"><strong>关于 有没有iOS 直接抓包 App 的结论</strong></h2>
<p>如果一定要给个结论，那就是：</p>
<ul>
<li>iOS 上不存在真正意义的纯手机抓包 App</li>
<li>所谓 <strong>直接</strong> ，本质是工具把配置步骤隐藏了</li>
<li>真正高效的抓包，来自对网络路径的判断</li>
</ul>
<p>当你理解了这一点，选工具反而会变简单。</p>
<p>参考链接：<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.sniffmaster.net%2Ftutorial%2Fzh%2F4%2F4.html" target="_blank" title="https://www.sniffmaster.net/tutorial/zh/4/4.html" ref="nofollow noopener noreferrer">www.sniffmaster.net/tutorial/zh…</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[绘制K线第一章：可见区间处理]]></title>    <link>https://juejin.cn/post/7594523145211117622</link>    <guid>https://juejin.cn/post/7594523145211117622</guid>    <pubDate>2026-01-13T08:50:13.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7594523145211117622" data-draft-id="7594385386740678675" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="绘制K线第一章：可见区间处理"/> <meta itemprop="keywords" content="Java"/> <meta itemprop="datePublished" content="2026-01-13T08:50:13.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="佛系打工仔"/> <meta itemprop="url" content="https://juejin.cn/user/3227821867282167"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            绘制K线第一章：可见区间处理
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3227821867282167/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    佛系打工仔
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-13T08:50:13.000Z" title="Tue Jan 13 2026 08:50:13 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">绘制K线第一章：可见区间处理</h2>
<h3 data-id="heading-1">概述</h3>
<p>在入门版本中，我们绘制了所有K线数据。但当数据量很大时，所有K线会挤在一起或超出屏幕，无法正常显示。</p>
<p><strong>可见区间处理</strong>就是解决这个问题：只绘制屏幕能容纳的K线数量，让图表清晰可读。</p>
<h3 data-id="heading-2">为什么需要可见区间</h3>
<h4 data-id="heading-3">问题场景</h4>
<p>假设有以下情况：</p>
<ul>
<li>屏幕宽度：1080px</li>
<li>每根K线占用：30px（20px宽度 + 10px间距）</li>
<li>可显示的K线数量：1080 ÷ 30 = 36根</li>
<li>实际数据：1000根K线</li>
</ul>
<p>如果绘制所有1000根K线：</p>
<ul>
<li>K线会挤在一起，无法看清</li>
<li>或者超出屏幕，看不到完整内容</li>
</ul>
<h4 data-id="heading-4">解决方案</h4>
<p>只显示最后36根K线（最新的数据），这样：</p>
<ul>
<li>K线清晰可读</li>
<li>不会超出屏幕</li>
</ul>
<h3 data-id="heading-5">实现原理</h3>
<h4 data-id="heading-6">核心逻辑</h4>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// 1. 计算可见K线数量</span>
val totalCandleWidth = config<span class="hljs-selector-class">.getTotalCandleWidth</span>()  <span class="hljs-comment">// 30px</span>
val visibleCount = (width / totalCandleWidth)<span class="hljs-selector-class">.toInt</span>()  <span class="hljs-comment">// 1080 ÷ 30 = 36</span>

<span class="hljs-comment">// 2. 获取可见数据（只取最后N根）</span>
val visibleData = if (klineData.size &gt; visibleCount) {
    klineData<span class="hljs-selector-class">.takeLast</span>(visibleCount)  <span class="hljs-comment">// 取最后36根</span>
} else {
    klineData  <span class="hljs-comment">// 数据不足，全部显示</span>
}

<span class="hljs-comment">// 3. 只对可见数据计算价格范围</span>
val priceRange = <span class="hljs-built_in">calculatePriceRange</span>(visibleData)

<span class="hljs-comment">// 4. 只绘制可见数据</span>
visibleData<span class="hljs-selector-class">.forEachIndexed</span> { index, entity -&gt;
    <span class="hljs-built_in">drawCandle</span>(...)
}
</code></pre>
<h4 data-id="heading-7">关键点</h4>
<ol>
<li><strong>计算可见数量</strong>：<code>屏幕宽度 ÷ 每根K线占用宽度</code></li>
<li><strong>取最后N根</strong>：使用 <code>takeLast()</code> 方法，显示最新的数据</li>
<li><strong>价格范围计算</strong>：只基于可见数据计算，确保Y轴比例正确</li>
</ol>
<h3 data-id="heading-8">代码实现（KLineViewCase2）</h3>
<h4 data-id="heading-9">类图</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@startuml</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">KLineViewCase2</span> {
  - klineData: List&lt;KLineEntity&gt;
  - config: KLineConfig
  + setKLineData(<span class="hljs-keyword">data</span>: List&lt;KLineEntity&gt;)
  - calculatePriceRange(<span class="hljs-keyword">data</span>: List&lt;KLineEntity&gt;): Pair&lt;<span class="hljs-built_in">Float</span>, <span class="hljs-built_in">Float</span>&gt;
}

KLineViewCase2 --&gt; KLineConfig : 依赖
KLineViewCase2 --&gt; KLineEntity : 使用

note right of KLineViewCase2
  相比Case1，增加了可见区间处理：
  <span class="hljs-number">1.</span> 计算可见K线数量
  <span class="hljs-number">2.</span> 只取最后N根数据
  <span class="hljs-number">3.</span> 只对可见数据计算价格范围
end note

<span class="hljs-meta">@enduml</span>
</code></pre>
<h4 data-id="heading-10">核心代码（可见区间部分）</h4>
<p>在 <code>onDraw()</code> 方法中，相比Case1增加了可见区间处理：</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// 1. 计算可见区间：根据屏幕宽度计算能显示多少根K线</span>
val totalCandleWidth = config<span class="hljs-selector-class">.getTotalCandleWidth</span>()
val visibleCount = (width / totalCandleWidth)<span class="hljs-selector-class">.toInt</span>()

<span class="hljs-comment">// 2. 获取可见的K线数据（只显示最后N根，最新的数据）</span>
val visibleData = if (klineData.size &gt; visibleCount) {
    klineData<span class="hljs-selector-class">.takeLast</span>(visibleCount)  <span class="hljs-comment">// 取最后N根</span>
} else {
    klineData  <span class="hljs-comment">// 数据不足，全部显示</span>
}

<span class="hljs-comment">// 3. 计算可见数据的价格范围（注意：传入visibleData而不是klineData）</span>
val priceRange = <span class="hljs-built_in">calculatePriceRange</span>(visibleData)

<span class="hljs-comment">// 4. 绘制可见的K线（使用visibleData）</span>
visibleData<span class="hljs-selector-class">.forEachIndexed</span> { index, entity -&gt;
    <span class="hljs-built_in">drawCandle</span>(canvas, entity, index, minPrice, maxPrice, height)
}
</code></pre>
<p><strong>关键改动</strong>：</p>
<ul>
<li><code>calculatePriceRange()</code> 方法现在接受 <code>data</code> 参数，可以传入可见数据</li>
<li>其他绘制逻辑与Case1相同（参考入门文档）</li>
</ul>
<h3 data-id="heading-11">与Case1的对比</h3>






























<table><thead><tr><th>特性</th><th>Case1（入门版）</th><th>Case2（可见区间版）</th></tr></thead><tbody><tr><td>绘制数据</td><td>所有数据</td><td>只绘制可见数据（最后N根）</td></tr><tr><td>价格范围计算</td><td>基于所有数据</td><td>基于可见数据</td></tr><tr><td>适用场景</td><td>数据量小（&lt; 50根）</td><td>数据量大（&gt; 50根）</td></tr><tr><td>代码复杂度</td><td>简单</td><td>稍复杂（增加可见区间逻辑）</td></tr></tbody></table>
<h3 data-id="heading-12">完整绘制链路</h3>
<p>相比Case1，Case2在绘制链路中增加了可见区间处理：</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-number">1</span>. 设置K线数据 → 触发<span class="hljs-built_in">onDraw</span>()重绘
   ↓
<span class="hljs-number">2</span>. <span class="hljs-built_in">onDraw</span>()方法执行：
   ├─ 绘制背景（与Case1相同）
   ├─ 检查数据是否为空（与Case1相同）
   ├─ 【新增】计算可见区间
   │   ├─ 计算可见K线数量（屏幕宽度 ÷ 每根K线宽度）
   │   └─ 获取可见数据（取最后N根）
   ├─ 计算价格范围（基于可见数据，不是所有数据）
   └─ 遍历可见K线数据并绘制（绘制逻辑与Case1相同）
</code></pre>
<p><strong>说明</strong>：绘制K线的具体步骤（计算坐标、绘制影线、绘制实体）与Case1相同，参考入门文档。</p>
<h3 data-id="heading-13">关键概念</h3>
<h4 data-id="heading-14">可见K线数量计算</h4>
<pre><code class="hljs language-scss" lang="scss">可显示的K线数量 = 屏幕宽度 ÷ 每根K线占用的总宽度
                = <span class="hljs-attribute">width</span> ÷ (candleWidth + candleSpacing)
                = <span class="hljs-attribute">width</span> ÷ totalCandleWidth
</code></pre>
<p><strong>示例</strong>：</p>
<ul>
<li>屏幕宽度：1080px</li>
<li>每根K线占用：30px（20px宽度 + 10px间距）</li>
<li>可见数量：1080 ÷ 30 = 36根</li>
</ul>
<h4 data-id="heading-15">取最后N根数据</h4>
<pre><code class="hljs language-arduino" lang="arduino">val visibleData = <span class="hljs-keyword">if</span> (klineData.size &gt; visibleCount) {
    klineData.<span class="hljs-built_in">takeLast</span>(visibleCount)  <span class="hljs-comment">// 取最后N根（最新数据）</span>
} <span class="hljs-keyword">else</span> {
    klineData  <span class="hljs-comment">// 数据不足，全部显示</span>
}
</code></pre>
<p><strong>说明</strong>：</p>
<ul>
<li>如果数据量 &gt; 可见数量：只取最后N根（显示最新数据）</li>
<li>如果数据量 ≤ 可见数量：全部显示</li>
</ul>
<h4 data-id="heading-16">价格范围只基于可见数据</h4>
<p>这是关键点：价格范围必须只基于可见数据计算，而不是所有数据。</p>
<p><strong>为什么？</strong></p>
<ul>
<li>如果基于所有数据计算价格范围，可见数据的价格变化可能很小</li>
<li>导致Y轴比例不合适，K线看起来像一条线</li>
<li>只基于可见数据计算，Y轴比例正确，K线清晰可见</li>
</ul>
<h3 data-id="heading-17">注意事项</h3>
<ol>
<li><strong>数据顺序</strong>：确保数据是按时间顺序排列的（从旧到新），这样 <code>takeLast()</code> 才能取到最新数据</li>
<li><strong>边界情况</strong>：当数据量小于可见数量时，需要全部显示</li>
<li><strong>价格范围</strong>：必须只基于可见数据计算，不能基于所有数据</li>
</ol>
<h3 data-id="heading-18">总结</h3>
<p>可见区间处理是K线绘制的重要优化：</p>
<ul>
<li><strong>解决数据量大时的显示问题</strong></li>
<li><strong>只绘制屏幕能容纳的K线</strong></li>
<li><strong>价格范围只基于可见数据计算</strong></li>
<li><strong>为后续的滚动、缩放功能打下基础</strong></li>
</ul>
<p>效果</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f634c8f6cee24dbcbc33dc8b06300ba7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5L2b57O75omT5bel5LuU:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768899165&amp;x-signature=GjPSuEFB7%2ByZR7%2FgPDHN0Gl4akc%3D" alt="" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[普通前端程序员的 2025：没什么大胜利，但也没被生活击倒]]></title>    <link>https://juejin.cn/post/7594655863547510836</link>    <guid>https://juejin.cn/post/7594655863547510836</guid>    <pubDate>2026-01-13T08:59:42.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7594655863547510836" data-draft-id="7594655863547428916" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="普通前端程序员的 2025：没什么大胜利，但也没被生活击倒"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2026-01-13T08:59:42.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="前端小蜗"/> <meta itemprop="url" content="https://juejin.cn/user/61995432544503"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            普通前端程序员的 2025：没什么大胜利，但也没被生活击倒
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/61995432544503/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    前端小蜗
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-13T08:59:42.000Z" title="Tue Jan 13 2026 08:59:42 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#595959;font-size:15px;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(60,10,30,.04) 3%,transparent 0),linear-gradient(1turn,rgba(60,10,30,.04) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body p{color:#595959;font-size:15px;line-height:2;font-weight:400}.markdown-body p+p{margin-top:16px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin:0;color:#135ce0}.markdown-body h1{position:relative;text-align:center;font-size:22px;margin:50px 0}.markdown-body h1:before{position:absolute;content:"";top:-10px;left:50%;width:32px;height:32px;transform:translateX(-50%);background-size:100% 100%;opacity:.36;background-repeat:no-repeat;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC)}.markdown-body h2{position:relative;font-size:20px;border-left:4px solid;padding:0 0 0 10px;margin:30px 0}.markdown-body h3{font-size:16px}.markdown-body ul{list-style:disc outside;margin-left:2em;margin-top:1em}.markdown-body li{line-height:2;color:#595959}.markdown-body img.loaded{margin:0 auto;display:block}.markdown-body blockquote{background:#fff9f9;margin:2em 0;padding:2px 20px;border-left:4px solid #b2aec5}.markdown-body blockquote p{color:#666;line-height:2}.markdown-body a{color:#036aca;border-bottom:1px solid rgba(3,106,202,.8);font-weight:400;text-decoration:none}.markdown-body em strong,.markdown-body strong{color:#036aca}.markdown-body hr{border-top:1px solid #135ce0}.markdown-body pre{overflow:auto}.markdown-body code,.markdown-body pre{overflow:auto;position:relative;line-height:1.75;font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body table{border-collapse:collapse;margin:1rem 0;overflow-x:auto}.markdown-body table td,.markdown-body table th{border:1px solid #dfe2e5;padding:.6em 1em}.markdown-body table tr{border-top:1px solid #dfe2e5}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>没什么宏大的叙事，单纯记录一下这个平平淡淡、甚至有点紧绷的 2025。</p>
<p>今年大环境怎样大家心里都有数，能苟住就算赢。盘了一下今年的几个关键数据，发现居然还凑合，比预想中要好一点。</p>
<h2 data-id="heading-0"><strong>1. 关于身体</strong></h2>
<p>16+8 加上打羽毛球。从 72kg 到了 63kg。</p>
<p>以前代码写久了颈椎像是生锈的，现在虽然还是累，但至少身体轻盈了不少。这也算是给 30 岁以后的自己充了点值。</p>
<h2 data-id="heading-1"><strong>2. 关于吞金兽</strong></h2>
<p>娃 3 岁了。
成功把人类幼崽又养活了一年（老父亲抹泪）。
带娃真的比修 Bug 累，情绪崩溃了无数次，但治愈也就一瞬间的事。看着她没心没肺地笑，觉得这点累也值了。</p>
<h2 data-id="heading-2"><strong>3. 搞钱与还债</strong></h2>
<p>今年最大的动作是降杠杆，硬着头皮还了 30w 房贷。</p>
<p>我妈支援了 10w，我爸支援了 10w，我自己攒了 10w。</p>
<p>在这个年份，有家人的托举真的很幸运。把债压下去，睡觉稍微踏实了一点点。</p>
<p>另外，前几年绿得发光的基金，今年终于回本扶正了，赶紧跑还是继续卧倒，还得再想想。</p>
<h2 data-id="heading-3"><strong>4. 工作</strong></h2>
<p>两个字：稳定。
在裁员消息满天飞的 2025，能安稳度过一年，绩效还行，没出大岔子，我觉得这就是一种胜利。</p>
<h2 data-id="heading-4"><strong>5. 精神避难</strong></h2>
<p>生活不能只有 KPI 和尿不湿。</p>
<p>今年看了 89 部电影，去了 2 次国内游，1 次出境游。</p>
<p>只有在客厅黑灯的那两个小时，或者站在陌生风景里的时候，才感觉自己不是个只会敲键盘的工具人。</p>
<hr/>
<h2 data-id="heading-5"><strong>写在最后</strong></h2>
<p>看着这些流水账，其实没什么惊天动地的成就。但在这个充满了不确定性的时代，能按部就班地生活，本身就很奢侈。</p>
<p>很喜欢的一句话，送给同样在 2025 努力支撑的兄弟们：</p>
<blockquote>
<p><strong>哪有什么胜利可言，挺住便意味着一切。💪</strong></p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Vibe Coding 进阶：非技术人员的生存手册]]></title>    <link>https://juejin.cn/post/7594514040917770267</link>    <guid>https://juejin.cn/post/7594514040917770267</guid>    <pubDate>2026-01-13T08:56:51.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7594514040917770267" data-draft-id="7594616268782108699" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Vibe Coding 进阶：非技术人员的生存手册"/> <meta itemprop="keywords" content="程序员,VibeCoding"/> <meta itemprop="datePublished" content="2026-01-13T08:56:51.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="XCaptaino"/> <meta itemprop="url" content="https://juejin.cn/user/3052665287739005"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Vibe Coding 进阶：非技术人员的生存手册
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3052665287739005/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    XCaptaino
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-13T08:56:51.000Z" title="Tue Jan 13 2026 08:56:51 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#595959;font-size:15px;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(60,10,30,.04) 3%,transparent 0),linear-gradient(1turn,rgba(60,10,30,.04) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body p{color:#595959;font-size:15px;line-height:2;font-weight:400}.markdown-body p+p{margin-top:16px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin:0;color:#135ce0}.markdown-body h1{position:relative;text-align:center;font-size:22px;margin:50px 0}.markdown-body h1:before{position:absolute;content:"";top:-10px;left:50%;width:32px;height:32px;transform:translateX(-50%);background-size:100% 100%;opacity:.36;background-repeat:no-repeat;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC)}.markdown-body h2{position:relative;font-size:20px;border-left:4px solid;padding:0 0 0 10px;margin:30px 0}.markdown-body h3{font-size:16px}.markdown-body ul{list-style:disc outside;margin-left:2em;margin-top:1em}.markdown-body li{line-height:2;color:#595959}.markdown-body img.loaded{margin:0 auto;display:block}.markdown-body blockquote{background:#fff9f9;margin:2em 0;padding:2px 20px;border-left:4px solid #b2aec5}.markdown-body blockquote p{color:#666;line-height:2}.markdown-body a{color:#036aca;border-bottom:1px solid rgba(3,106,202,.8);font-weight:400;text-decoration:none}.markdown-body em strong,.markdown-body strong{color:#036aca}.markdown-body hr{border-top:1px solid #135ce0}.markdown-body pre{overflow:auto}.markdown-body code,.markdown-body pre{overflow:auto;position:relative;line-height:1.75;font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body table{border-collapse:collapse;margin:1rem 0;overflow-x:auto}.markdown-body table td,.markdown-body table th{border:1px solid #dfe2e5;padding:.6em 1em}.markdown-body table tr{border-top:1px solid #dfe2e5}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h3 data-id="heading-0">前言</h3>
<p>Vibe Coding 的门槛看起来很低——打开 Cursor、Claude 或者 AI Studio，用自然语言描述你的需求，AI 就能帮你生成代码。但很多人在实际操作中会发现：AI 做出来的东西，和自己想要的总是差那么一点。</p>
<p>说到底，问题在我们自己身上。</p>
<p>作为非技术人员，你面临的真正挑战在于：如何让 AI 理解你到底想要什么。这篇文章会帮你跨过这道坎。</p>
<h3 data-id="heading-1">第一关：你真的知道自己要什么吗？</h3>
<p>很多人做不到把需求描述清楚，其实跟表达能力没太大关系，更多是认知层次的问题。</p>
<p>我们可以用一个简单的认知象限来理解这件事：</p>
<ul>
<li>Know-Know（知道自己知道什么）：比如"我需要一个登录页面"</li>
<li>Know-Unknow（知道自己不知道什么）：比如"我知道需要数据库，但不知道怎么设计"</li>
<li>Unknow-Unknow（不知道自己不知道什么）：比如"为什么用户登录后还是跳回首页？"——你根本不知道需要 session 管理</li>
<li>Unknow-Know（不知道自己其实知道什么）：比如"其实我潜意识里希望界面更简洁"——没意识到这也是一个需求</li>
</ul>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fx.com%2Ftreydtw%2Farticle%2F2010601217597276631%2Fmedia%2F2010599364889313282" target="_blank" title="https://x.com/treydtw/article/2010601217597276631/media/2010599364889313282" ref="nofollow noopener noreferrer"/></p>
<p>大多数失败的 Vibe Coding 项目，都卡在 Unknow-Unknow 这个象限——你都不知道自己遗漏了什么，AI 当然也帮不了你。</p>
<p>破局方法：AI 访谈</p>
<p>与其一上来就让 AI 写代码，不如先让 AI 扮演一个产品经理，反过来采访你：</p>
<blockquote>
<p>我有一个模糊的项目想法，请扮演产品经理来采访我。 通过一系列问题，帮我把这个想法变得更加清晰和具体。 每次只问一个问题，等我回答后再问下一个。</p>
</blockquote>
<p>通过一次次的回答问题，你会发现自己的想法逐渐从模糊变得清晰，从”我想做一个 App”变成”我想做一个帮助自由职业者追踪项目收入、自动生成发票的工具”。</p>
<p>这才是 Vibe Coding 的真正起点。</p>
<h3 data-id="heading-2">第二关：小步快走，别想一口吃成胖子</h3>
<p>很多人的第一个项目就野心勃勃：要做一个社交平台、要做一个在线教育系统、要做一个电商网站……</p>
<p>结果呢？三天热情过后，项目变成了一堆报错的代码和半成品的页面。</p>
<p>正确的做法是：从身边的 Side Project 做起。</p>
<p>什么是好的第一个项目？</p>
<ul>
<li>✅ 一个个人记账小工具</li>
<li>✅ 一个自动整理收藏夹的脚本</li>
<li>✅ 一个把语音转成文字的小页面</li>
<li>✅ 一个生日提醒机器人</li>
</ul>
<p>这些项目有几个共同特点：</p>
<ol>
<li>功能单一：只解决一个问题</li>
<li>用户明确：就是你自己</li>
<li>验收简单：能用就行</li>
</ol>
<p>当你能把一个小项目从头到尾完整做出来、部署上线、自己用起来之后，你就拥有了做更大项目的信心和方法论。</p>
<h3 data-id="heading-3">第三关：像项目经理一样思考</h3>
<p>这是非技术人员最需要培养的能力：工程化思维。</p>
<p>你不需要看懂每一行代码，但你必须学会：</p>
<ol>
<li>管控风险</li>
</ol>
<p>每次让 AI 修改代码之前，问自己：</p>
<ul>
<li>这次改动会影响其他功能吗？</li>
<li>如果改坏了，我能恢复吗？</li>
<li>我有没有备份？</li>
</ul>
<ol start="2">
<li>验收成果</li>
</ol>
<p>不要 AI 说”改好了”你就信了。你需要：</p>
<ul>
<li>实际运行一遍</li>
<li>测试主要功能</li>
<li>检查边界情况（比如输入为空会怎样？）</li>
</ul>
<ol start="3">
<li>分解任务</li>
</ol>
<p>大任务拆成小任务，每次只让 AI 做一件事：</p>
<p>❌ "帮我做一个完整的用户系统" ✅ "先帮我做一个登录表单的 UI" ✅ "现在帮我加上表单验证" ✅ "接下来对接后端登录接口"</p>
<h3 data-id="heading-4">第四关：版本控制是你的后悔药</h3>
<p>学会用 Git，这是非技术人员最值得投资的技能之一。</p>
<p>为什么？因为在 Vibe Coding 的过程中，你会频繁遇到这种情况：</p>
<blockquote>
<p>“刚才那个版本明明是好的，让 AI 改了几轮之后，整个网站都挂了……”</p>
</blockquote>
<p>如果你用了 Git，只需要一条命令就能回到之前任何一个正常的版本。没有 Git？那你只能求 AI 帮你”撤销刚才的修改”——但 AI 的记忆可没那么可靠。</p>
<p>最基础的 Git 用法，只需要记住三个命令：</p>
<h2 data-id="heading-5">保存当前进度（相当于游戏存档） git add . git commit -m "完成了登录功能" # 查看历史存档 git log --oneline # 回到某个存档 git checkout &lt;存档编号&gt;</h2>
<p>养成习惯：每完成一个小功能，就 commit 一次。这样你永远有后悔药可以吃。</p>
<h3 data-id="heading-6">第五关：真实运行检查</h3>
<p>这是很多人忽略的最后一步。</p>
<p>我见过太多人在 AI Studio 里做出了炫酷的 Demo，发到朋友圈收获一片点赞，但那个项目从来没有真正运行过。</p>
<p>没有部署运行的项目，就像只存在于图纸上的房子——看着很美，但你住不进去。</p>
<p>为什么真实运行检查这么重要？</p>
<ol>
<li>暴露真实问题：在 AI Studio 的沙盒里一切正常，放到真实服务器上可能就报错了</li>
<li>发现性能问题：本地测试感觉很快，用户多了就卡死了</li>
<li>验证真实价值：你以为很有用的功能，实际用起来可能很鸡肋</li>
</ol>
<p>最简单的部署方式</p>
<p>如果你的项目是一个静态网页，用 Vercel 或 Netlify 可以免费一键部署。如果需要后端，可以用 Railway 或 Render。</p>
<p>不需要懂什么服务器配置，把代码推上去，平台自动帮你搞定一切。</p>
<h3 data-id="heading-7">总结：非技术人员的 Vibe Coding 生存法则</h3>
<ol>
<li>先厘清需求：用 AI 访谈的方式，把模糊想法变清晰</li>
<li>从小做起：Side Project 优先，积累成功经验</li>
<li>工程化思维：像项目经理一样管理风险、验收成果</li>
<li>善用 Git：版本控制是你的后悔药</li>
<li>真实运行：Demo 不算数，部署上线才是真的完成</li>
</ol>
<p>Vibe Coding 的本质，是让你成为一个会用 AI 工具的创造者。</p>
<p>代码只是工具，解决问题才是目的。</p>
<p>本文转载自宝玉推特</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[如何在一天内重启你的人生]]></title>    <link>https://juejin.cn/post/7594616268782059547</link>    <guid>https://juejin.cn/post/7594616268782059547</guid>    <pubDate>2026-01-13T08:54:55.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7594616268782059547" data-draft-id="7594482829755220014" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="如何在一天内重启你的人生"/> <meta itemprop="keywords" content="程序员"/> <meta itemprop="datePublished" content="2026-01-13T08:54:55.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="XCaptaino"/> <meta itemprop="url" content="https://juejin.cn/user/3052665287739005"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            如何在一天内重启你的人生
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3052665287739005/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    XCaptaino
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-13T08:54:55.000Z" title="Tue Jan 13 2026 08:54:55 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读16分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#383838;font-size:15px;line-height:30px;letter-spacing:2px;word-break:break-word;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen,Ubuntu,Cantarell,Open Sans,Helvetica Neue,sans-serif;scroll-behavior:smooth;background-image:linear-gradient(0deg,transparent 24%,rgba(201,195,195,.329) 25%,hsla(0,8%,80.4%,.05) 26%,transparent 27%,transparent 74%,hsla(0,5.2%,81%,.185) 75%,rgba(180,176,176,.05) 76%,transparent 77%,transparent),linear-gradient(90deg,transparent 24%,rgba(204,196,196,.226) 25%,hsla(0,4%,66.1%,.05) 26%,transparent 27%,transparent 74%,hsla(0,5.2%,81%,.185) 75%,rgba(180,176,176,.05) 76%,transparent 77%,transparent);background-color:#fff;background-size:50px 50px;padding-bottom:60px}.markdown-body ::selection{color:#fff;background-color:#a862ea}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{margin:24px 0 12px;color:#a862ea}.markdown-body h1{line-height:2;font-size:1.4em}.markdown-body h1~p:first-of-type:first-letter{color:#a862ea;float:left;font-size:2em;margin-right:.4em;font-weight:bolder}.markdown-body h2{font-size:1.2em}.markdown-body h3{font-size:1.1em}.markdown-body ol,.markdown-body ul{padding-left:2em}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;padding-left:.2em}.markdown-body ol li::marker,.markdown-body ul li::marker{color:#a862ea}.markdown-body ol li.task-list-item,.markdown-body ul li.task-list-item{list-style:none}.markdown-body ol li.task-list-item ol,.markdown-body ol li.task-list-item ul,.markdown-body ul li.task-list-item ol,.markdown-body ul li.task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:10px}.markdown-body a,.markdown-body code,.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6,.markdown-body li,.markdown-body p{opacity:.85;vertical-align:baseline;transition:all .1s ease}.markdown-body a:hover,.markdown-body code:hover,.markdown-body h1:hover,.markdown-body h2:hover,.markdown-body h3:hover,.markdown-body h4:hover,.markdown-body h5:hover,.markdown-body h6:hover,.markdown-body li:hover,.markdown-body p:hover{opacity:1}.markdown-body a{display:inline-block;color:#a862ea;cursor:pointer;text-decoration:none;position:relative}.markdown-body a:after{content:"";position:absolute;width:98%;height:1px;bottom:0;left:0;transform:scaleX(0);background-color:#a862ea;transform-origin:bottom right;transition:transform .3s ease-in-out}.markdown-body a:hover:after{transform:scaleX(1);transform-origin:bottom left}.markdown-body a:active,.markdown-body a:link{color:#a862ea}.markdown-body img{max-width:100%;user-select:none;margin:1em 0;transition:transform .2s ease 0s;background-color:#f8f5ff;box-shadow:0 0 10px #e7daff}.markdown-body img:hover{opacity:1;box-shadow:0 0 20px #e7daff;transform:translateY(-1px)}.markdown-body blockquote{padding:.5em 1em;margin:12px 0;border-top-left-radius:2px;border-bottom-left-radius:2px;border-left:3px solid #a862ea;background-color:#f8f5ff}.markdown-body blockquote&gt;p{margin:0}.markdown-body .math{font-style:italic;margin:12px 0;padding:.5em 1em;background-color:#f8f5ff}.markdown-body .math&gt;p{margin:0}.markdown-body code{padding:2px .4em;overflow-x:auto;color:#a862ea;font-weight:700;word-break:break-word;font-family:Operator Mono,Consolas,Monaco,Menlo,monospace;background-color:#f8f5ff}.markdown-body pre{margin:2em 0}.markdown-body pre&gt;code{display:block;padding:1.5em;word-break:normal;font-size:.9em;font-style:normal;font-weight:400;font-family:Operator Mono,Consolas,Monaco,Menlo,monospace;line-height:18px;color:#383838;border-radius:2px;scroll-behavior:smooth;box-shadow:0 0 10px #e7daff}.markdown-body pre&gt;code:hover{box-shadow:0 0 20px #e7daff}.markdown-body pre&gt;code::-webkit-scrollbar{height:6px;background-color:#f8f5ff}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:#e7daff;border-bottom-left-radius:3px;border-bottom-right-radius:3px}.markdown-body hr{margin:2em 0;border-top:1px solid #a862ea}.markdown-body table{width:100%;font-size:12px;max-width:100%;overflow:auto;border-collapse:collapse}.markdown-body thead{color:#a862ea;background:#f8f5ff}.markdown-body td,.markdown-body th{padding:.5em;border:1px solid #e7daff}.markdown-body tr{background-color:#f8f5ff}@media (max-width:720px){.markdown-body{font-size:12px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>如果你还没准备变好，那是因为你在害怕。</p>
<p>——DAN</p>
<blockquote>
<p>作者：DAN KOE</p>
<p>原文链接：<a href="https://link.juejin.cn?target=https%3A%2F%2Fx.com%2Fthedankoe%2Fstatus%2F2010751592346030461" target="_blank" title="https://x.com/thedankoe/status/2010751592346030461" ref="nofollow noopener noreferrer">x.com/thedankoe/s…</a></p>
</blockquote>
<p>如果你跟我这类人有点像，那你肯定觉得“新年决心”这玩意儿简直蠢透了。</p>
<p>原因很简单：大多数人改变生活的方式完全搞反了。</p>
<p>大家制定这些决心只是因为随大流——人类嘛，总喜欢在这种肤浅的“地位游戏”里找存在感——但这些决心根本无法触及真正改变的核心。真正的改变，远比你给自己洗脑说“今年我要更自律、更高效”要深刻得多。</p>
<p>如果你不幸被我说中了，别急，我不是来居高临下说教的（虽然我写东西确实有点犀利）。我放弃过的目标比我实现的要多十倍。我觉得这对大多数人来说都是常态。但不得不承认，大多数人试图改变生活却总是以惨败告终，这是一个铁一般的事实。</p>
<p>不过，虽然我认为“新年决心”很蠢，但反思一下你那糟糕的现状，然后以此为跳板去追求更好的生活，永远是明智之举。</p>
<p>所以，无论你是想创业、想通过健身脱胎换骨，还是想冒险去过一种更有意义的生活（而不是两周后就打回原形），我想分享 7 个你可能没听说过的，关于行为改变、心理学和生产力的核心理念。希望能帮你在 2026 年真正做成点事儿。</p>
<p>这是一篇干货满满的长文。 这不那种你看完就忘的快餐文章。 这是一份值得你收藏、做笔记，并专门抽出时间去深度思考的内容。</p>
<p>文章末尾的一套流程（旨在深挖你的潜意识，找出你真正想要什么）大约需要你花整整一天的时间去完成，但它带来的影响将极其深远。</p>
<p>我们开始吧。</p>
<h2 data-id="heading-0">一、你还没过上想要的生活，是因为你还不是“配得上”那种生活的人</h2>
<p>在设定宏大目标时，人们往往只盯着成功两个要素中的次要那个：</p>
<ol>
<li>改变你的行动，向目标推进（这是二阶的，最不重要）。</li>
<li>改变你的本质，让行为自然而然地发生（这是一阶的，最重要的）。</li>
</ol>
<p>大多数人立了一个浮于表面的目标，给自己打鸡血，硬撑着自律几周，然后毫无悬念地退回到老样子。为什么？因为他们试图在腐烂的地基上盖高楼。</p>
<p>如果这听起来有点玄，我们来看个例子。</p>
<p>想想那些成功人士：一个拥有完美身材的健美运动员，一个身家过亿的 CEO，或者一个在人群中谈笑风生、毫无社交焦虑的社交达人。</p>
<p>你觉得那个健美运动员需要“咬牙坚持”才能吃得健康吗？那个 CEO 需要“强迫自己”去自律地管理团队吗？</p>
<p>在你看来，表面上好像是这样。但真相是：他们根本无法想象自己过另一种生活。 对健美运动员来说，逼他吃垃圾食品才是真正的折磨；对 CEO 来说，赖床不起才是让他每一秒都感到痛苦的事（这里有细微差别，但这只是为了举例）。</p>
<p>对有些人来说，我的生活方式看起来极端且苦行僧。但在我看来，这再自然不过了。这不是为了跟谁比，我只是真心享受这种活法。当我妈劝我休息一下，出去玩玩时，我强忍着没回她一句：“如果我不觉得好玩，我干嘛要做这些？”</p>
<p>下一句话听起来很简单，但令人震惊的是，绝大多数人都不懂：</p>
<p>如果你想要某种人生结果，你必须在该结果出现之前很久，就已经过上了能产生这种结果的生活方式。</p>
<p>如果有人说想减掉 30 磅，我通常是不信的。不是我不信他们的能力，而是太多次听到这种话：“等我减完肥，我就能重新开始享受生活了。”</p>
<p>很遗憾地告诉你：如果你不能把“导致你减肥成功的生活方式”变成你的终身生活方式，如果你找不到一个比把你拉回旧习惯的引力更强大的理由，那你注定会反弹回原点。最后你只能不快乐地承认，你浪费了这辈子最宝贵的资源：时间。</p>
<p>当你真正由内而外地改变时，那些对你目标毫无帮助的旧习惯会让你感到恶心，因为你深刻地意识到，那些行为会累积成什么样的人生。你现在之所以能容忍目前的低标准，是因为你并没有完全意识到这些标准到底是什么，以及它们最终会将你引向何方。</p>
<p>你说你想改变，你说你想“财务自由”或“变得健康”，但你的行动却总是背道而驰。这里面的水，比你想象的要深。</p>
<h2 data-id="heading-1">二、你还没过上想要的生活，是因为你潜意识里根本就不想</h2>
<blockquote>
<p>“只相信行动。生活发生在事件的层面，而不是语言的层面。只相信行动。” —— 阿尔弗雷德·阿德勒</p>
</blockquote>
<p>如果你想改变自己，就必须理解大脑的运作机制，这样才能开始“重写代码”。</p>
<p>理解大脑的第一步，是明白所有行为都是目标导向的（目的论）。这一点细想其实很明显，但深究起来，大多数人都不愿面对。</p>
<ul>
<li>你往前迈一步，是因为你想去某个地方。</li>
<li>你挠鼻子，是因为你想止痒。</li>
</ul>
<p>这些显而易见。但大多数时候，你的目标是无意识的。比如，你大白天瘫在沙发上刷手机，你可能没意识到，你其实是在试图消磨掉那个让你焦虑的“下一个任务”到来之前的时间。</p>
<p>在更深层、更复杂的无意识层面，你会追求一些实际上伤害你的目标，但你会用一种社会可接受的方式来合理化你的行为，以免自己看起来像个失败者。</p>
<p>举个例子：如果你总是拖延工作，你可能会借口说自己“缺乏自律”。但实际上，你是在追求一个目标——保护自己。保护自己免受“完成工作并展示成果”后可能遭遇的评判。</p>
<p>如果你嘴上说想辞掉那份没前途的工作，却迟迟不动，你可能会觉得自己没勇气。但真相是，你正在追求“安全感”、“确定性”以及“不想让周围那些认为这工作还不错的人觉得你是个失败者”这一目标。</p>
<p>真正的教训是：真正的改变需要改变你的目标。</p>
<p>我指的不是定个肤浅的 KPI，因为这种行为本身可能就是为了服务于某个正在伤害你的潜意识目标。我指的是改变你的视角。因为目标本质上就是一个透镜。它是一种对未来的投射，决定了你能看到哪些信息、想法和资源。</p>
<p>如果不理解这一点，你会越陷越深。</p>
<h2 data-id="heading-2">三、你还没过上想要的生活，是因为你害怕成为那个人</h2>
<blockquote>
<p>“不管是你是怎么产生这个想法的，也不管它来自哪里……只要你接受了一个想法，并且深信不疑，它就会像催眠师的指令控制被催眠者一样控制你。” —— 麦克斯韦尔·马尔茨</p>
</blockquote>
<p>这就是你如何成为今天的你，以及你将如何成为明天的你的过程。这是“身份认同”的解剖学：</p>
<ol>
<li>你想达成一个目标。</li>
<li>你通过这个目标的透镜来感知现实。</li>
<li>你只注意那些能帮你达成目标的“重要”信息（学习）。</li>
<li>你朝着目标行动，并收到“正在取得进展”的反馈。</li>
<li>你重复这种行为，直到它变成自动化的、无意识的（条件反射）。</li>
<li>这种行为成为你自我认知的一部分（“我就是那种……的人”）。</li>
<li>为了维持心理的一致性，你会死命捍卫这个身份。</li>
<li>你的身份塑造新的目标，循环重新开始。如果这个身份不利于美好生活，事情就会迅速恶化。</li>
</ol>
<p>残酷的现实是，你必须打断第 6 步和第 7 步之间的循环，但这个过程从你童年时期就开始了。</p>
<p>你有生存的目标。你依赖父母教你如何生存。你必须顺从。因为大多数教育都是通过奖惩机制进行的，除非你接受他们的信念和价值观，否则就会受罚。除非你看穿这一切，否则你从未真正独立思考过。</p>
<p>更可怕的是，你的父母可能也没打破这个循环。他们也被工业时代的成功观念所制约，甚至背负着他们父母辈的思维钢印。</p>
<p>再深一层，当你满足了生理生存需求（在今天这很容易），你就会开始寻求概念或意识形态上的生存。你不再只是保护肉体，你开始拼命保护你的“思想”。看看网上的骂战就知道了，那是不同身份认同之间的战争。</p>
<p>当你的身体受到威胁，你会战或逃。 当你的身份受到威胁，反应是一模一样的。</p>
<p>如果你深度认同某种政治立场，当有人挑战你的信仰时，你会感到威胁，感到压力，甚至在情绪上感觉被人扇了一巴掌。因为大多数人不具备分析情绪真伪的能力，你就会躲进回音室，变本加厉地坚持那些可能伤害你和他人的观点。</p>
<p>同样的事情也发生在你无意识地把自己看作“一个律师”、“一个游戏玩家”或者“一个注定无法成功的人”时。</p>
<h2 data-id="heading-3">四、你想要的生活存在于特定的思维层级中</h2>
<p>心智是随着时间通过可预测的阶段进化的。</p>
<p>刚出生时，你像个求生的海绵，吸收一切文化信念以求安全。如果你不小心，你的心智可能会固化，让你难以过上更有意义的生活。</p>
<p>关于这一点，马斯洛需求层次、螺旋动力学（Spiral Dynamics）等模型都有详述。为了方便理解，我总结了自我发展的 9 个阶段（80/20 法则版）：</p>
<ol>
<li>冲动型 (Impulsive)： 冲动即行动，非黑即白。像发脾气的幼儿。</li>
<li>自我保护型 (Self-Protective)： 世界是危险的，要学会自保。学会撒谎、讨好大人。</li>
<li>从众型 (Conformist)： 群体规则就是真理。无法理解为什么有人会和自己群体不一样。</li>
<li>自我觉察型 (Self-Aware)： 意识到内心世界与外部不符。开始质疑，但不知所措。</li>
<li>尽责型 (Conscientious)： 建立原则并自我约束。比如经过深思熟虑后改变信仰，或制定职业规划。</li>
<li>个人主义型 (Individualist)： 意识到原则受环境影响。发现自己的观点只是因为成长环境，而非绝对真理。</li>
<li>策略型 (Strategist)： 玩转系统，同时意识到自己的局限。能领导组织，同时主动审视盲点。</li>
<li>构建觉察型 (Construct-Aware)： 视一切框架（包括身份）为有用的虚构。知道“地图不是疆域”。</li>
<li>合一型 (Unitive)： 自我与生活消融。工作、休息、娱乐融为一体。只是当下的存在对发生的一切做出反应。</li>
</ol>
<p>读这篇文章的人大多处于第 4 到第 8 阶段。第 4 阶段的人极度渴望改变，觉得命不该绝于此，但理不清头绪。好消息是，无论你在哪个阶段，进阶之路都有迹可循。</p>
<h2 data-id="heading-4">五、真正的智力是“得到你想要生活”的能力</h2>
<blockquote>
<p>“检验智力的唯一标准，是你是否得到了你想要的生活。” —— Naval Ravikant</p>
</blockquote>
<p>成功有个公式： 成功 = 主观能动性 (Agency) + 机会 (Opportunity) + 智力 (Intelligence)</p>
<ul>
<li>如果你有主观能动性但没机会，你会很努力但没结果。</li>
<li>如果你有主观能动性和机会但没智力，你抓不住那些机会。</li>
</ul>
<p>这里的“智力”，我想借用控制论（Cybernetics）的概念。Cybernetics 源自希腊语，意为“掌舵”。也就是“得到你想要东西的艺术”。</p>
<p>控制论揭示了智能系统的特性：</p>
<ol>
<li>有一个目标。</li>
<li>朝目标行动。</li>
<li>感知当前位置。</li>
<li>与目标对比。</li>
<li>根据反馈调整行动。</li>
</ol>
<p>智力的高低，取决于系统试错、迭代和坚持的能力。</p>
<p>偏航的船修正航向；恒温器感知温度变化并启动；胰腺在血糖升高后分泌胰岛素。这都叫智能。</p>
<p>这和生活有什么关系？关系大了。</p>
<p>高智商不是做题快，而是拥有“迭代”、“坚持”和“全局观”的能力。 低智商的表现是无法从错误中学习。</p>
<p>低智商的人遇到问题就卡住，碰到障碍就放弃。就像一个作家，写不出爆款就放弃了，因为他缺乏尝试新事物、实验和找出适合自己流程的能力。</p>
<p>高智商的人明白，只要时间足够长，任何问题都能解决。智力就是意识到：只要做出一系列正确的选择，就能达成目标。</p>
<p>要变得更聪明，你必须：</p>
<ul>
<li>拒绝既定道路。</li>
<li>潜入未知领域。</li>
<li>设定更高的新目标来扩展思维。</li>
<li>拥抱混乱，允许成长。</li>
<li>学习自然的通用原则。</li>
<li>成为一个深度通才。</li>
</ul>
<h2 data-id="heading-5">六、如何（在一天内）重启你的人生</h2>
<p>如果你想挖掘内心，真正改变人生轨迹，你需要经历三个阶段：</p>
<ol>
<li>不和谐 (Dissonance)： 你感觉现在的日子没法过了，受够了毫无进展。</li>
<li>不确定 (Uncertainty)： 你不知道下一步怎么走，可能会迷茫。</li>
<li>发现 (Discovery)： 你找到了真正想做的事，半年抵别人六年。</li>
</ol>
<p>这套流程需要你花整整一天。准备好纸和笔。</p>
<p>第一部分：早晨——心理挖掘（愿景与反愿景）</p>
<p>拿出 15-30 分钟。别用 AI，用你自己的脑子。</p>
<ol>
<li>那种让你学会忍受的、钝痛且持久的“不满意”到底是什么？</li>
<li>你在过去一年里抱怨最多，但从未真正改变的三件事是什么？</li>
<li>对于每个抱怨：旁观者如果只看你的行为（不听你说什么），会认为你真正想要的是什么？</li>
<li>关于你目前的生活，哪一个真相是你绝对不敢告诉最尊敬的人的？</li>
<li>反愿景 (Anti-Vision)： 如果未来五年什么都不变，描述一个普通的周二。你在哪醒来？身体感觉如何？你想到的第一件事是什么？谁在你身边？你现在的这种“苟且”的代价是什么？</li>
<li>如果你这辈子都这么过，从未打破这种模式，你错过了什么？</li>
<li>为了真正改变，你必须放弃哪个身份？（“我是那种……的人”）。不再做这个人，你在社交上会付出什么代价？</li>
<li>你至今没改变的最尴尬（而不是最合理）的原因是什么？</li>
<li>如果你的行为是一种自我保护，你到底在保护什么？这种保护让你失去了什么？</li>
</ol>
<p>如果你的回答足够诚实，你会感到一种深深的恶心。这种恶心是好事，它是动力。</p>
<p>现在，建立最小可行性愿景 (Minimum Viable Vision)： 10. 抛开“现不现实”。如果你打个响指就能在三年后过上不同生活，你真正想要的是什么？描述一个普通的周二。 11. 为了让那种生活感觉自然而非强迫，你必须相信自己是什么样的人？写下身份声明：“我是那种……的人”。 12. 如果你已经是那个人了，这周你会做的一件事是什么？</p>
<p>第二部分：白天——打断自动驾驶</p>
<p>仅仅写下来不够，你得打破当下的无意识模式。在手机上设闹钟，把这些问题设为提醒事项，全天轰炸自己：</p>
<ul>
<li>11:00am: 我现在做这件事，是在逃避什么？</li>
<li>1:30pm: 如果有人拍下我过去两小时的录像，他们会认为我想要什么？</li>
<li>3:15pm: 我是在走向我讨厌的生活，还是我想要的生活？</li>
<li>5:00pm: 我假装不重要，但其实最重要的事情是什么？</li>
<li>7:30pm: 我今天做的哪些事是为了“维护人设”，而不是出于真心？</li>
<li>9:00pm: 今天什么时候我感觉最“活着”？什么时候感觉像行尸走肉？</li>
</ul>
<p>第三部分：晚上——整合洞见</p>
<p>经过这一天，你应该至少有一个深刻的洞见。</p>
<ol>
<li>今天过后，关于你为什么一直卡住，感觉最真实的理由是什么？</li>
<li>谁是真正的敌人？给它起个名。不是外部环境，是你内部运行的那个模式。</li>
<li>写一句话，概括你绝不接受的生活（反愿景）。</li>
<li>写一句话，概括你正在构建的生活（愿景 MVP）。</li>
<li>设定镜头（而不是终点）： 一年镜头： 一年后哪件事必须成真，才能证明你打破了旧模式？ 一月镜头： 为了让一年目标可能实现，这周必须发生什么？ 每日镜头： 那个未来的你，明天会毫不犹豫去做的 2-3 件事是什么？</li>
</ol>
<h2 data-id="heading-6">七、把你的人生变成一款电子游戏</h2>
<blockquote>
<p>“当精神能量（注意力）投入到现实目标中，且技能与行动机会相匹配时，意识就会变得有序。” —— 米哈里·契克森米哈赖</p>
</blockquote>
<p>现在，把你所有的洞察整合成一个计划。拿出一张新纸，写下这 6 个组件：</p>
<ol>
<li>反愿景 (Anti-vision)： 我存在的噩梦，我绝不想再经历的生活。这是你的赌注。</li>
<li>愿景 (Vision)： 我理想中的生活，我的通关条件。这是你的胜利。</li>
<li>1 年目标 (1 year goal)： 这是你的主线任务。</li>
<li>1 个月项目 (1 month project)： 我需要学什么？练什么？这是你的Boss 战，用来赚经验值和掉落装备。</li>
<li>每日杠杆 (Daily levers)： 推进项目的关键任务。这是你的日常任务 (Quests)。</li>
<li>约束条件 (Constraints)： 我绝不为了目标牺牲什么？这是游戏的规则。</li>
</ol>
<p>为什么这很强大？ 因为这些组件创造了一个属于你的小世界。这就是沉迷、享受和心流状态的来源。 这就像是一个力场，把你从分心和诱惑中隔绝开来。</p>
<p>游戏玩得越久，这个力场就越强。很快，这就成了你的本能，你甚至无法想象另一种活法。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[AAAI 2026 | 美团技术团队学术论文精选]]></title>    <link>https://juejin.cn/post/7594385386740252691</link>    <guid>https://juejin.cn/post/7594385386740252691</guid>    <pubDate>2026-01-13T07:07:40.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7594385386740252691" data-draft-id="7594533204002865215" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="AAAI 2026 | 美团技术团队学术论文精选"/> <meta itemprop="keywords" content="人工智能"/> <meta itemprop="datePublished" content="2026-01-13T07:07:40.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="美团技术团队"/> <meta itemprop="url" content="https://juejin.cn/user/3509296845313741"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            AAAI 2026 | 美团技术团队学术论文精选
            <!----> <!----></h1> <div class="container team-follow" data-v-d326b38e="" data-v-61fb5e44=""><div class="left" data-v-d326b38e=""><a href="/team/6930512966122995712/posts" data-v-d326b38e=""><img src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/47ccb42d726640a7889ba1e64ae203e6~tplv-k3u1fbpfcp-watermark.image" class="icon" data-v-d326b38e=""/></a> <div class="content" data-v-d326b38e=""><div style="display: flex" data-v-d326b38e=""><a href="/team/6930512966122995712/posts" data-v-d326b38e=""><p class="title-line" data-v-d326b38e=""><span title="美团技术团队" class="title" data-v-d326b38e="">美团技术团队</span> <img src="//lf-web-assets.juejin.cn/obj/juejin-web/xitu_juejin_web/255e400027b783cbad76dc41527e7695.svg" alt="team icon" class="team-icon" data-v-d326b38e=""/></p></a></div> <div class="meta-box team" data-v-d326b38e="" data-v-61fb5e44=""><time datetime="2026-01-13T07:07:40.000Z" title="Tue Jan 13 2026 07:07:40 GMT+0000 (Coordinated Universal Time)" class="time" data-v-d326b38e="" data-v-61fb5e44="">
                2026-01-13
              </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-d326b38e="" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-d326b38e="" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-d326b38e="" data-v-61fb5e44=""/></svg> <span class="views-count" style="display:none;" data-v-d326b38e="" data-v-61fb5e44="">
                0
              </span> <span class="read-time" data-v-d326b38e="" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-d326b38e="" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-d326b38e="" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-d326b38e="" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-d326b38e="" data-v-61fb5e44=""/></svg>
                阅读11分钟
              </span> <!----> <!----></div></div></div> <button class="jj-follow-button follow-btn" style="display:none;" data-v-b60b2868="" data-v-d326b38e=""><span data-v-b60b2868="" data-v-d326b38e=""><i class="byte-icon byte-icon--plus" data-v-d326b38e=""><svg xmlns="http://www.w3.org/2000/svg" viewbox="0 0 48 48"><path fill="none" d="M0 0h48v48H0z"/><path d="M24.7 4c.4 0 .6 0 .8.1.2.1.3.2.4.4.1.2.1.3.1.8V22h16.7c.4 0 .6 0 .8.1.2.1.3.2.4.4.1.2.1.3.1.8v1.4c0 .4 0 .6-.1.8-.1.2-.2.3-.4.4-.2.1-.3.1-.8.1H26v16.7c0 .4 0 .6-.1.8-.1.2-.2.3-.4.4-.2.1-.3.1-.8.1h-1.4c-.4 0-.6 0-.8-.1-.2-.1-.3-.2-.4-.4-.1-.2-.1-.3-.1-.8V26H5.3c-.4 0-.6 0-.8-.1-.2-.1-.3-.2-.4-.4-.1-.2-.1-.3-.1-.8v-1.4c0-.4 0-.6.1-.8.1-.2.2-.3.4-.4.2-.1.3-.1.8-.1H22V5.3c0-.4 0-.6.1-.8.1-.2.2-.3.4-.4.2-.1.3-.1.8-.1h1.4z"/></svg></i>
        关注
      </span></button></div> <div class="team-user block-hidden" data-v-61fb5e44=""><div class="avatar jj-avatar avatar" data-v-03256cc6="" data-v-61fb5e44=""><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADwAAAA8AQMAAAAAMksxAAAAA1BMVEUAAACnej3aAAAAAXRSTlMAQObYZgAAAA5JREFUKM9jGAWjAAcAAAIcAAE27nY6AAAAAElFTkSuQmCC" alt="avatar" class="lazy avatar-img" data-v-5244ef91="" data-v-03256cc6=""/> </div> <!----> <span class="position ellipsis" data-v-61fb5e44="">
              美团小编 @美团
            </span></div> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><a href="https://link.juejin.cn?target=https%3A%2F%2Faaai.org%2F" target="_blank" title="https://aaai.org/" ref="nofollow noopener noreferrer">AAAI</a> 是人工智能领域顶级的国际学术会议，本文精选了美团技术团队被收录的8篇学术论文（附下载链接），覆盖大模型推理、 退火策略、过程奖励模型、强化学习、视觉文本渲染等多个技术领域，希望这些论文能对大家有所帮助或启发。</p>
<h2 data-id="heading-0">01 Promoting Efficient Reasoning with Verifiable Stepwise Reward</h2>
<p><strong>论文类型</strong>：Poster</p>
<p><strong>论文下载</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Farxiv.org%2Fpdf%2F2508.10293" target="_blank" title="https://arxiv.org/pdf/2508.10293" ref="nofollow noopener noreferrer">PDF</a></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fc3605a0654c4c7a84d30446a9d3ecab~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg576O5Zui5oqA5pyv5Zui6Zif:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768892860&amp;x-signature=N6YOtkkpNtU2BFdNROAD3WHECjU%3D" alt="" loading="lazy"/></p>
<p><strong>论文简介</strong>：大推理模型通过强化学习提升了链式推理能力，但输出冗长，导致推理开销增大和用户体验下降，即「过度思考」问题。针对这一现象，本文提出了可验证的过程奖励机制（VSRM），通过奖励有效步骤、惩戒无效步骤，优化模型推理过程。VSRM首先通过特殊token划分推理步骤，并结合三条规则保证每个步骤的内容可读性。各步骤通过插入token生成子轨迹，模型根据每步前后正确率变化分配步骤级奖励。为避免奖励信号稀疏，引入前瞻窗口机制，通过折扣因子传播未来正确率变化，使奖励更密集。</p>
<p>实验表明，VSRM能大幅缩减输出长度，且在多种数学benchmark和不同模型、算法下保持甚至提升性能。消融实验证明前瞻窗口机制有效，显式长度惩罚对VSRM无益。VSRM机制可与各类强化学习算法无缝结合，有效抑制无效步骤，鼓励有效推理，是解决过度思考问题、提升模型推理效率的有效方法。</p>
<h2 data-id="heading-1">02 Scaling and Transferability of Annealing Strategies in Large Language Model Training</h2>
<p><strong>论文类型</strong>：Long Paper</p>
<p><strong>论文下载</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Farxiv.org%2Fpdf%2F2505.17652" target="_blank" title="https://arxiv.org/pdf/2505.17652" ref="nofollow noopener noreferrer">PDF</a></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6db2e192bb434abba92317d2c1c94422~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg576O5Zui5oqA5pyv5Zui6Zif:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768892860&amp;x-signature=807%2F%2FnsqTlyvGt6ceTt1TDtnkeA%3D" alt="" loading="lazy"/></p>
<p><strong>论文简介</strong>：本文深入研究了大型语言模型训练过程中退火策略（Annealing Strategies）对模型性能的影响，提出了一个新的缩放法则公式来预测不同训练配置下的损失曲线。研究发现，即使在相同的训练token数量和模型规模下，不同的批次大小（batch size）和学习率调度器也会导致显著不同的训练曲线。为此，作者提出了一个改进的缩放法则公式：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6c912e5b5c984f6eac14c908590fe600~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg576O5Zui5oqA5pyv5Zui6Zif:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768892860&amp;x-signature=il6I0OGGFl%2BX7QU5yrr1Gzg9P3s%3D" alt="" loading="lazy"/></p>
<p>其中S表示学习率对训练步数的积分（前向效应），M表示动量对训练步数的积分（退火动量项），N代表模型规模。</p>
<p>论文的核心贡献包括：(1) 证明在特定情况下，训练步数比训练token数更适合作为追踪损失曲线的指标；(2) 发现最优退火比率（Ropt）随总训练步数增加而减小，遵循幂律关系；(3) 验证了最优退火比率在训练集和验证集上保持一致；(4) 通过在Dense模型和MoE（Mixture-of-Experts）模型上的大量实验，证明小模型可以作为优化大模型训练动态的可靠代理。该研究为大规模语言模型的训练提供了更精确的理论指导，有助于优化训练效率和模型性能。</p>
<h2 data-id="heading-2">03 From Mathematical Reasoning to Code: Generalization of Process Reward Models in Test-Time Scaling</h2>
<p><strong>论文类型</strong>：Long Paper （Oral）</p>
<p><strong>论文下载</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Farxiv.org%2Fpdf%2F2506.00027" target="_blank" title="https://arxiv.org/pdf/2506.00027" ref="nofollow noopener noreferrer">PDF</a></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4d802b61624c4732b3098b2b4421d47d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg576O5Zui5oqA5pyv5Zui6Zif:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768892860&amp;x-signature=stLrYtwGIBOx1FG1LbWCBMxrxiU%3D" alt="" loading="lazy"/></p>
<p><strong>论文简介</strong>：本文系统研究了过程奖励模型（Process Reward Models, PRMs）在提升大型语言模型推理能力方面的作用，特别关注其从数学推理到代码生成任务的跨域泛化能力。研究从训练方法、可扩展性和泛化能力等多个维度对PRMs进行了深入分析。</p>
<p>论文的核心发现包括：</p>
<ul>
<li><strong>训练计算资源的影响</strong>：研究发现随着PRM模型规模的增大，性能提升呈现边际递减效应，强调了在模型规模和计算成本之间寻找平衡的重要性。同时，训练数据集的多样性显著影响PRM性能，作者提出的ASLAF（自动步骤级标注与过滤）方法在多个基准测试中表现优异。</li>
<li><strong>测试时扩展策略</strong>：论文评估了Best-of-N采样、束搜索、蒙特卡洛树搜索（MCTS）和多数投票等多种搜索策略。结果表明，在计算资源充足时MCTS效果最佳，而在资源受限情况下Best-of-N采样是实用的替代方案。</li>
<li><strong>跨域泛化能力</strong>：令人惊讶的是，在数学数据集上训练的PRMs在代码生成任务上的表现与专门针对代码训练的模型相当，展现出强大的跨域适应能力。通过梯度分析，研究还发现PRMs倾向于选择具有相似底层推理模式的响应，这为理解其优化机制提供了新视角。该研究为优化大规模语言模型的训练和部署提供了重要的理论指导和实践参考。</li>
</ul>
<h2 data-id="heading-3">04 Rethinking the Sampling Criteria in Reinforcement Learning for LLM Reasoning: A Competence-Difficulty Alignment Perspective</h2>
<p><strong>论文类型</strong>：Poster</p>
<p><strong>论文下载</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Farxiv.org%2Fpdf%2F2505.17652" target="_blank" title="https://arxiv.org/pdf/2505.17652" ref="nofollow noopener noreferrer">PDF</a></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/772cebd44c5645f3b99f28b1ffc94059~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg576O5Zui5oqA5pyv5Zui6Zif:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768892860&amp;x-signature=XJzBCeoGug2YuCDzM051Y%2FVKEpU%3D" alt="" loading="lazy"/></p>
<p><strong>论文简介</strong>：本文对强化学习（RL）中的问题采样策略进行了系统性研究，当前主流采样策略大多直接依赖单步通过率（Pass Rate） 作为问题难度指标，存在 1）对问题难度的估计不够稳定；2）无法有效捕捉模型能力与问题难度的对齐关系的问题。</p>
<p>针对这些问题，本文提出了 CDAS（Competence-Difficulty Alignment Sampling）：一种将模型能力与问题难度显式建模并对齐的动态采样方法。CDAS 不依赖单步通过率，而是通过累积历史表现差异来构建更稳定的难度估计；同时定义模型能力，并以不动点系统确保两者在训练过程中共同收敛。基于能力—难度差值构建对齐指标，再通过对称采样策略，选取最匹配模型当前能力的问题，从而提升有效梯度比例与训练效率。CDAS 在数学推理和代码生成场景中均通过 RL 训练 验证，结果显示 CDAS 显著提升了采样效率与模型性能，击败了多种主流采样策略。</p>
<h2 data-id="heading-4">05 ViType: High-Fidelity Visual Text Rendering via Glyph-Aware Multimodal Diffusion</h2>
<p><strong>论文类型</strong>：Oral</p>
<p><strong>论文下载</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Fs3plus.meituan.net%2Fddfile%2FViType__High_Fidelity_Visual_Text_Rendering_via_Glyph_Aware_Multimodal.pdf" target="_blank" title="https://s3plus.meituan.net/ddfile/ViType__High_Fidelity_Visual_Text_Rendering_via_Glyph_Aware_Multimodal.pdf" ref="nofollow noopener noreferrer">PDF</a></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/07f269513b6a49b99bd150406b2a3b1e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg576O5Zui5oqA5pyv5Zui6Zif:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768892860&amp;x-signature=RMuMAul6DDKtn3iSxTDSrqAQ0BQ%3D" alt="" loading="lazy"/></p>
<p><strong>论文简介</strong>：随着文生图模型在电商营销等领域的广泛应用，视觉文本渲染的准确性已成为制约生成质量的核心瓶颈。现有模型因缺乏字形级理解能力，难以精确刻画多语言字符结构，导致海报、商品图等商业场景中文字乱码、字形失真等问题频发，严重阻碍了AIGC在智能设计中的实际落地。</p>
<p>针对这一关键挑战，我们提出ViType三阶段对齐增强框架：首先通过视觉问答机制实现文本-字形显式对齐，将字符视觉结构注入大语言模型语义空间；其次创新性地将预对齐字形嵌入与文本token同步输入多模态扩散Transformer，通过联合训练建立跨模态特征协同；最后基于高质量图文对进行美学精调，确保生成图像的版式和谐与视觉美感。该框架使字符准确率提升15%以上，为电商海报、营销物料等高精度视觉内容创作提供了可靠的技术支撑。</p>
<h2 data-id="heading-5">06 DSCF: Dual-Source Counterfactual Fusion for High-Dimensional Combinatorial Interventions</h2>
<p><strong>论文类型</strong>：Poster</p>
<p><strong>论文下载</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Fs3plus.meituan.net%2Fddfile%2F%25E3%2580%2590AAAI%25E3%2580%2591DSCF.pdf" target="_blank" title="https://s3plus.meituan.net/ddfile/%E3%80%90AAAI%E3%80%91DSCF.pdf" ref="nofollow noopener noreferrer">PDF</a></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/581f0d39113446e3a43bfb6dad862683~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg576O5Zui5oqA5pyv5Zui6Zif:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768892860&amp;x-signature=cJpgWBmoPujc8MsOKyh%2B20BcrAQ%3D" alt="" loading="lazy"/></p>
<p><strong>论文简介</strong>：在个性化推荐、数字营销和医疗健康等领域，基于观测数据预测反事实结果对科学决策至关重要。在这些应用场景中，决策过程往往涉及高维组合干预策略，例如多渠道资源捆绑投放或产品组合推荐。面向这类场景，无论是历史策略的效果评估还是新策略的优化，都需要模型能够对历史数据中很少出现甚至从未出现过的策略组合效果进行准确预测。此外，观测数据中源于历史分配策略和倾向性投放的选择偏差会进一步加剧数据稀疏问题，从而影响反事实推断的准确性。</p>
<p>为此，本文提出双源反事实融合模型（Dual-Source Counterfactual Fusion，DSCF），该可扩展框架通过双专家混合架构联合建模观测数据和代理反事实样本，并采用领域引导融合机制，在有效平衡偏差消除与信息多样性的同时，还能自适应地泛化到反事实输入场景。在合成和半合成数据集上的大量实验表明，DSCF框架能够显著提升高维组合干预场景下的预测准确性，并在不同情境下展现出优异的鲁棒性表现。</p>
<h2 data-id="heading-6">07 Compress-then-Rank: Faster and Better Listwise Reranking with Large Language Models via Ranking-Aware Passage Compression</h2>
<p><strong>论文类型</strong>：Poster</p>
<p><strong>论文下载</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Fs3plus.meituan.net%2Fddfile%2FAAAI2026_C2R(1).pdf" target="_blank" title="https://s3plus.meituan.net/ddfile/AAAI2026_C2R(1).pdf" ref="nofollow noopener noreferrer">PDF</a></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/28ed70403cca443fa84ffeb6a345fe77~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg576O5Zui5oqA5pyv5Zui6Zif:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768892860&amp;x-signature=0yjJFqdSMcCeT3s4shfRxC8x9Rc%3D" alt="" loading="lazy"/></p>
<p><strong>论文简介</strong>：基于大型语言模型（LLMs）的列表重排序（listwise reranking）已经成为最先进的方法，在段落重排序任务中不断创下新的性能基准。然而，其实际应用面临两个关键挑战：处理长序列时高昂的计算开销和高延迟，以及由于“迷失在中间”等现象导致的长上下文性能下降。</p>
<p>为了解决这些问题，我们提出了一种高效的框架压缩后排序（Compress-then-Rank, C2R），该框架不是直接对原始段落进行列表重排序，而是对其紧凑的多向量代理进行操作。这些代理可以预先计算并缓存，适用于语料库中的所有段落。C2R 的有效性依赖于三项关键创新。首先，压缩模型通过结合文本恢复和文本延续目标进行预训练，生成高保真的压缩向量序列，从而减轻了单向量方法中常见的语义损失问题。其次，一种新颖的输入方案将每个序数索引的嵌入添加到其对应的压缩向量序列前，这不仅划定了段落边界，还引导重排序 LLM 生成排序列表。最后，压缩模型和重排序模型通过联合优化，使压缩过程对排序目标具有排序感知能力。在主要重排序基准上的广泛实验表明，C2R 在提供显著加速的同时，能够实现与全文重排序方法相当甚至更优的排序性能。</p>
<h2 data-id="heading-7">08 Multi-Aspect Cross-modal Quantization for Generative Recommendation</h2>
<p><strong>论文类型</strong>：Oral</p>
<p><strong>论文下载</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Farxiv.org%2Fpdf%2F2511.15122" target="_blank" title="https://arxiv.org/pdf/2511.15122" ref="nofollow noopener noreferrer">PDF</a></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e487a0d32fb24a34b88de19e1b696875~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg576O5Zui5oqA5pyv5Zui6Zif:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768892860&amp;x-signature=uXpRPJu2YTYICtSHfFUsqunbYI0%3D" alt="" loading="lazy"/></p>
<p><strong>论文简介</strong>：本文提出一种基于多模态融合的生成式推荐框架（MACRec），旨在解决现有生成式推荐方法因模态信息利用不足和跨模态交互缺失导致的性能瓶颈。</p>
<p>针对文本与视觉模态的量化难题，MACRec引入跨模态量化与多角度对齐机制，通过两阶段技术路线实现优化：1）跨模态残差量化：将对比学习融入分层量化过程，生成兼具语义层次性与模态兼容性的物品标识符，显著降低多模态表征冲突；2）跨模态协同对齐：通过显式-隐式协同对齐策略，分别建模文本与视觉模态的共享特征和互补特征，增强生成式推荐的多模态理解能力。在亚马逊电商推荐数据集上的实验结果表明，MACRec相较基准模型在推荐性能上有显著提升；各模态的码本分布更均衡、利用率更低，充分验证了跨模态量化与对齐机制在提升生成式推荐有效性方面的优势。</p>
<p>| 关注「美团技术团队」微信公众号，在公众号菜单栏对话框回复【2024年货】、【2023年货】、【2022年货】、【2021年货】、【2020年货】、【2019年货】、【2018年货】、【2017年货】等关键词，可查看美团技术团队历年技术文章合集。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8d7392bde83446528a07ba8d9e4c8c01~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg576O5Zui5oqA5pyv5Zui6Zif:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768892860&amp;x-signature=iAOhBJZdBsE%2BhhWL3UHy1x3Cd0E%3D" alt="" loading="lazy"/></p>
<p>| 本文系美团技术团队出品，著作权归属美团。欢迎出于分享和交流等非商业目的转载或使用本文内容，敬请注明“内容转载自美团技术团队”。本文未经许可，不得进行商业性转载或者使用。任何商用行为，请发送邮件至 <a href="https://link.juejin.cn?target=mailto%3Atech%40meituan.com" target="_blank" title="mailto:tech@meituan.com" ref="nofollow noopener noreferrer">tech@meituan.com</a> 申请授权。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Nginx日志分析工具-NginxPulse开源了]]></title>    <link>https://juejin.cn/post/7594385386740301843</link>    <guid>https://juejin.cn/post/7594385386740301843</guid>    <pubDate>2026-01-13T07:23:19.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7594385386740301843" data-draft-id="7594351060615708691" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Nginx日志分析工具-NginxPulse开源了"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2026-01-13T07:23:19.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="神奇的程序员"/> <meta itemprop="url" content="https://juejin.cn/user/3984285870859614"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Nginx日志分析工具-NginxPulse开源了
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3984285870859614/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    神奇的程序员
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-13T07:23:19.000Z" title="Tue Jan 13 2026 07:23:19 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言</h2>
<p>上周写了个<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.kaisir.cn%2Fpost%2F186" target="_blank" title="https://www.kaisir.cn/post/186" ref="nofollow noopener noreferrer">nginx 日志分析系统</a>，这几天花了点时间把代码整理了下，现已开源。</p>
<p>欢迎各位有需要的开发者自取。</p>
<h2 data-id="heading-1">项目地址</h2>
<ul>
<li>GitHub地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Flikaia%2Fnginxpulse" target="_blank" title="https://github.com/likaia/nginxpulse" ref="nofollow noopener noreferrer">github.com/likaia/ngin…</a></li>
<li>dockerhub地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fhub.docker.com%2Fr%2Fmagiccoders%2Fnginxpulse%2F" target="_blank" title="https://hub.docker.com/r/magiccoders/nginxpulse/" ref="nofollow noopener noreferrer">hub.docker.com/r/magiccode…</a></li>
</ul>
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d5aba9d653f3448d9cb56a4b8912bf40~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56We5aWH55qE56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768893799&amp;x-signature=OELLIFoqZWehzvcGx1irsYE6X3U%3D" alt="demo-img-1.png" loading="lazy"/>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/561f6858b63e4d6b87e989fca37b2deb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56We5aWH55qE56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768893799&amp;x-signature=W%2F%2BisIxmZJfmiU9emDVxpIZNNdY%3D" alt="demo-img-2.png" loading="lazy"/></p>
<h2 data-id="heading-2">写在最后</h2>
<p>我是<strong>神奇的程序员</strong>，一位前端开发工程师。</p>
<p>如果你对我感兴趣，请移步我的<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.kaisir.cn%2F" target="_blank" title="https://www.kaisir.cn/" ref="nofollow noopener noreferrer">个人网站</a>，进一步了解。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[【Anthropic新发布】Cowork：Claude Code 适用于你的其他工作]]></title>    <link>https://juejin.cn/post/7594405684592115764</link>    <guid>https://juejin.cn/post/7594405684592115764</guid>    <pubDate>2026-01-13T07:26:03.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7594405684592115764" data-draft-id="7594358540049137699" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="【Anthropic新发布】Cowork：Claude Code 适用于你的其他工作"/> <meta itemprop="keywords" content="Claude"/> <meta itemprop="datePublished" content="2026-01-13T07:26:03.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="是魔丸啊"/> <meta itemprop="url" content="https://juejin.cn/user/3217622495411292"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            【Anthropic新发布】Cowork：Claude Code 适用于你的其他工作
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3217622495411292/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    是魔丸啊
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-13T07:26:03.000Z" title="Tue Jan 13 2026 07:26:03 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><a href="https://link.juejin.cn?target=https%3A%2F%2Fclaude.com%2Fblog%2Fcowork-research-preview%3Futm_source%3Dchatgpt.com" target="_blank" title="https://claude.com/blog/cowork-research-preview?utm_source=chatgpt.com" ref="nofollow noopener noreferrer">转载</a></p>
<p>当我们发布 Claude Code 时,我们期望开发者会用它来编写代码。他们确实这样做——然后很快开始用它处理<a href="https://link.juejin.cn?target=https%3A%2F%2Fx.com%2Fclaudeai%2Fstatus%2F2009666254815269313" target="_blank" title="https://x.com/claudeai/status/2009666254815269313" ref="nofollow noopener noreferrer">几乎其他所有事情</a>。这促使我们构建了 Cowork：一种更简单的方式,让任何人——<a href="https://juejin.cn/post/7594358540049039395" target="_blank" title="https://juejin.cn/post/7594358540049039395">不仅仅是开发者</a>——都能以完全相同的方式与 Claude 协作。从今天起,Cowork 已在我们的 <a href="https://link.juejin.cn?target=https%3A%2F%2Fclaude.com%2Fdownload%3Futm_source%3Dchatgpt.com" target="_blank" title="https://claude.com/download?utm_source=chatgpt.com" ref="nofollow noopener noreferrer">macOS app</a> 上向 Claude Max 订阅者提供研究预览版,我们将从这里快速改进它。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/447db088f5b149868a73d1a37bf3979e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5piv6a2U5Li45ZWK:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768893962&amp;x-signature=oltjTobPb8Oh2xiT%2F68dGNUqvNk%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/eee6707b06a24c9a99c01989c9d9bb72~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5piv6a2U5Li45ZWK:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768893962&amp;x-signature=n1sJRsuXUeqHrIEkb%2BltZGYk0yU%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-0">使用 Cowork 与普通对话有什么不同？</h2>
<p>在 Cowork 中,你让 Claude 访问你计算机上你选择的文件夹。然后 Claude 可以读取、编辑或创建该文件夹中的文件。例如,它可以通过对每个文件进行排序和重命名来重新整理你的下载文件夹,从一堆截图中创建包含支出列表的新电子表格,或者从你分散的笔记中生成报告的初稿。</p>
<p>在 Cowork 中,Claude 完成此类工作时,比你在普通对话中看到的具有更强的自主性。一旦你设置了任务,Claude 就会制定计划并稳步完成,同时向你通报它的进展。如果你使用过 Claude Code,这会感觉很熟悉——Cowork 基于<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.anthropic.com%2Fengineering%2Fbuilding-agents-with-the-claude-agent-sdk" target="_blank" title="https://www.anthropic.com/engineering/building-agents-with-the-claude-agent-sdk" ref="nofollow noopener noreferrer">完全相同的基础</a>构建。这意味着 Cowork 可以承担许多与 Claude Code 相同的任务,但以更适合非编码任务的形式呈现。</p>
<p>当你掌握了基础知识后,你可以让 Cowork 变得更强大。Claude 可以使用你现有的 <a href="https://link.juejin.cn?target=https%3A%2F%2Fclaude.com%2Fconnectors%3Futm_source%3Dchatgpt.com" target="_blank" title="https://claude.com/connectors?utm_source=chatgpt.com" ref="nofollow noopener noreferrer">connectors</a>(将 Claude 连接到外部信息),在 Cowork 中,我们添加了初始的一组 <a href="https://link.juejin.cn?target=https%3A%2F%2Fplatform.claude.com%2Fdocs%2Fen%2Fagents-and-tools%2Fagent-skills%2Foverview%3Futm_source%3Dchatgpt.com" target="_blank" title="https://platform.claude.com/docs/en/agents-and-tools/agent-skills/overview?utm_source=chatgpt.com" ref="nofollow noopener noreferrer">skills</a>,可以提高 Claude 创建文档、演示文稿和其他文件的能力。如果你将 Cowork 与 <a href="https://link.juejin.cn?target=https%3A%2F%2Fclaude.com%2Fchrome%3Futm_source%3Dchatgpt.com" target="_blank" title="https://claude.com/chrome?utm_source=chatgpt.com" ref="nofollow noopener noreferrer">Claude in Chrome</a> 配合使用,Claude 也可以完成需要浏览器访问的任务。</p>
<p>Cowork 旨在让使用 Claude 处理新工作尽可能简单。你不需要手动持续提供上下文或将 Claude 的输出转换为正确的格式。你也不必等待 Claude 完成后再提供进一步的想法或反馈：你可以排队多个任务,让 Claude 并行处理它们。这种感觉更像是在给同事留言,而不是来回对话。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d0b5f787bf134e1ca48b2297bf30d03d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5piv6a2U5Li45ZWK:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768893962&amp;x-signature=yJoqiasZIrhQeWCeBspnnMra9hY%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-1">保持控制</h2>
<p>在 Cowork 中,你可以选择 Claude 可以看到哪些文件夹和 connectors：Claude 无法读取或编辑任何你没有明确授权的内容。Claude 还会在采取任何重大操作之前征求你的许可,因此你可以根据需要引导或纠正它。</p>
<p>也就是说,在让 Claude 接管之前,还有一些事情需要注意。默认情况下,主要需要知道的是,如果被指示,Claude 可以采取潜在的破坏性操作(例如删除本地文件)。由于 Claude 总是有可能误解你的指示,你应该对此类事情给出非常明确的指导。</p>
<p>你还应该注意"<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.anthropic.com%2Fresearch%2Fprompt-injection-defenses" target="_blank" title="https://www.anthropic.com/research/prompt-injection-defenses" ref="nofollow noopener noreferrer">prompt injections</a>"(提示注入)的风险：攻击者试图通过 Claude 在互联网上遇到的内容来改变 Claude 的计划。我们已经针对 prompt injections 构建了复杂的防御措施,但 agent 安全——即保护 Claude 现实世界行为的任务——仍然是行业中的一个积极发展领域。</p>
<p>这些风险并非 Cowork 特有,但这可能是你第一次使用超越简单对话的更高级工具。我们建议采取预防措施,尤其是在你学习它如何工作的时候。我们在我们的 <a href="https://link.juejin.cn?target=https%3A%2F%2Fsupport.claude.com%2Fen%2Farticles%2F13364135-using-cowork-safely%3Futm_source%3Dchatgpt.com" target="_blank" title="https://support.claude.com/en/articles/13364135-using-cowork-safely?utm_source=chatgpt.com" ref="nofollow noopener noreferrer">Help Center</a> 中提供了更多详细信息。</p>
<h2 data-id="heading-2">展望未来</h2>
<p>这是一个研究预览版。我们之所以提前发布 Cowork,是因为我们想了解人们用它来做什么,以及他们认为如何可以做得更好。我们鼓励你尝试 Cowork 可以为你做什么,并尝试你意想不到的事情：你可能会感到惊喜！随着我们从此次预览中学到更多,我们计划进行大量改进(包括通过添加跨设备同步并将其带到 Windows),并确定进一步使其更安全的方法。</p>
<p>Claude Max 订阅者现在可以下载 <a href="https://link.juejin.cn?target=https%3A%2F%2Fclaude.com%2Fdownload%3Futm_source%3Dchatgpt.com" target="_blank" title="https://claude.com/download?utm_source=chatgpt.com" ref="nofollow noopener noreferrer">macOS app</a> 尝试 Cowork,然后点击侧边栏中的"Cowork"。如果你使用其他计划,可以<a href="https://link.juejin.cn?target=https%3A%2F%2Fforms.gle%2FmtoJrd8kfYny29jQ9" target="_blank" title="https://forms.gle/mtoJrd8kfYny29jQ9" ref="nofollow noopener noreferrer">加入等候名单</a>以备将来访问。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[绘制K线入门]]></title>    <link>https://juejin.cn/post/7594533204003127359</link>    <guid>https://juejin.cn/post/7594533204003127359</guid>    <pubDate>2026-01-13T07:41:35.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7594533204003127359" data-draft-id="7594403873178271785" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="绘制K线入门"/> <meta itemprop="keywords" content="Android"/> <meta itemprop="datePublished" content="2026-01-13T07:41:35.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="佛系打工仔"/> <meta itemprop="url" content="https://juejin.cn/user/3227821867282167"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            绘制K线入门
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3227821867282167/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    佛系打工仔
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-13T07:41:35.000Z" title="Tue Jan 13 2026 07:41:35 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">绘制K线入门</h2>
<h3 data-id="heading-1">什么是K线</h3>
<p>K线（又称蜡烛图）是金融领域用来表示价格走势的一种图表形式。每根K线代表一个时间周期（如1分钟、5分钟、1小时、1天等）内的价格变化情况。</p>
<h4 data-id="heading-2">K线的组成部分</h4>
<p>一根K线由以下几个部分组成：</p>
<ol>
<li><strong>实体（Body）</strong> ：矩形部分，表示开盘价和收盘价之间的价格区间</li>
</ol>
<ul>
<li>
<ul>
<li>如果收盘价 &gt; 开盘价：称为<strong>阳线</strong>（通常用红色表示，表示上涨）</li>
<li>如果收盘价 &lt; 开盘价：称为<strong>阴线</strong>（通常用绿色表示，表示下跌）</li>
</ul>
</li>
</ul>
<ol start="2">
<li><strong>上影线（Upper Shadow）</strong> ：实体上方的细线，表示最高价到实体上边缘的距离</li>
<li><strong>下影线（Lower Shadow）</strong> ：实体下方的细线，表示最低价到实体下边缘的距离</li>
</ol>
<h4 data-id="heading-3">K线的数据要素</h4>
<p>每根K线需要以下数据：</p>
<ul>
<li><strong>Date（时间）</strong> ：该K线的时间周期（如：2025/01/20、2025-01-20 10:00:00等）</li>
<li><strong>Open（开盘价）</strong> ：该时间周期开始时的价格</li>
<li><strong>Close（收盘价）</strong> ：该时间周期结束时的价格</li>
<li><strong>High（最高价）</strong> ：该时间周期内的最高价格</li>
<li><strong>Low（最低价）</strong> ：该时间周期内的最低价格</li>
<li><strong>Volume（成交量）</strong> ：该时间周期内的交易量（可选，用于其他分析）</li>
</ul>
<h4 data-id="heading-4">数据模型定义</h4>
<p>在代码中，我们用 Kotlin 的 <code>data class</code> 来表示K线数据：</p>
<h5 data-id="heading-5">类图</h5>
<pre><code class="hljs language-markdown" lang="markdown">@startuml
class KLineEntity {
<span class="hljs-bullet">  -</span> Close: String
<span class="hljs-bullet">  -</span> Date: String
<span class="hljs-bullet">  -</span> High: String
<span class="hljs-bullet">  -</span> Low: String
<span class="hljs-bullet">  -</span> Open: String
<span class="hljs-bullet">  -</span> Volume: String
<span class="hljs-bullet">  +</span> getCloseFloat(): Float
<span class="hljs-bullet">  +</span> getOpenFloat(): Float
<span class="hljs-bullet">  +</span> getHighFloat(): Float
<span class="hljs-bullet">  +</span> getLowFloat(): Float
<span class="hljs-bullet">  +</span> isRising(): Boolean
}
@enduml
</code></pre>
<h5 data-id="heading-6">代码实现</h5>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">data</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">KLineEntity</span>(
    <span class="hljs-keyword">val</span> Close: String,    <span class="hljs-comment">// 收盘价</span>
    <span class="hljs-keyword">val</span> Date: String,     <span class="hljs-comment">// 日期</span>
    <span class="hljs-keyword">val</span> High: String,     <span class="hljs-comment">// 最高价</span>
    <span class="hljs-keyword">val</span> Low: String,      <span class="hljs-comment">// 最低价</span>
    <span class="hljs-keyword">val</span> Open: String,     <span class="hljs-comment">// 开盘价</span>
    <span class="hljs-keyword">val</span> Volume: String    <span class="hljs-comment">// 成交量</span>
) {
    <span class="hljs-comment">// 类型转换方法（String → Float）</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">getCloseFloat</span><span class="hljs-params">()</span></span>: <span class="hljs-built_in">Float</span> = Close.toFloatOrNull() ?: <span class="hljs-number">0f</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">getOpenFloat</span><span class="hljs-params">()</span></span>: <span class="hljs-built_in">Float</span> = Open.toFloatOrNull() ?: <span class="hljs-number">0f</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">getHighFloat</span><span class="hljs-params">()</span></span>: <span class="hljs-built_in">Float</span> = High.toFloatOrNull() ?: <span class="hljs-number">0f</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">getLowFloat</span><span class="hljs-params">()</span></span>: <span class="hljs-built_in">Float</span> = Low.toFloatOrNull() ?: <span class="hljs-number">0f</span>
    
    <span class="hljs-comment">// 判断是否为阳线（上涨）</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">isRising</span><span class="hljs-params">()</span></span>: <span class="hljs-built_in">Boolean</span> = getCloseFloat() &gt; getOpenFloat()
}
</code></pre>
<p><strong>说明</strong>：</p>
<ul>
<li><code>isRising()</code> 用于判断涨跌，决定绘制时使用阳线颜色还是阴线颜色</li>
</ul>
<h4 data-id="heading-7">涨跌判断</h4>
<p>判断一根K线是涨还是跌：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">isRising</span><span class="hljs-params">()</span></span>: <span class="hljs-built_in">Boolean</span> = getCloseFloat() &gt; getOpenFloat()
</code></pre>
<ul>
<li><strong>阳线（上涨）</strong> ：收盘价 &gt; 开盘价</li>
<li><strong>阴线（下跌）</strong> ：收盘价 &lt; 开盘价</li>
<li><strong>平盘</strong>：收盘价 = 开盘价（较少见，通常也按阳线处理）</li>
</ul>
<h3 data-id="heading-8">如何绘制蜡烛图（入门版本）</h3>
<p><strong>说明</strong>：本章节介绍的是<strong>入门版本的K线绘制方法</strong>，采用最简单、最直观的实现方式，适合初学者循序渐进地学习。</p>
<p><strong>特点</strong>：</p>
<ul>
<li>固定坐标系（不滚动、不缩放）</li>
<li>绘制所有数据（不区分可见区间）</li>
<li>代码逻辑简单清晰</li>
<li>便于理解K线绘制的核心原理</li>
</ul>
<p><strong>学习路径</strong>：</p>
<ol>
<li>先掌握入门版本的绘制方法（本章节）</li>
<li>理解坐标计算、价格转换等核心概念</li>
<li>后续章节会逐步引入滚动、缩放、性能优化等高级功能</li>
</ol>
<p>循序渐进，从简单到复杂，才能更好地理解K线绘制的本质。</p>
<h4 data-id="heading-9">绘制步骤</h4>
<p>绘制一根K线（蜡烛图）需要以下步骤：</p>
<ol>
<li><strong>计算坐标</strong></li>
</ol>
<ul>
<li>
<ul>
<li>计算K线的中心X坐标（基于索引位置）</li>
<li>将价格转换为Y坐标（最高价、最低价、开盘价、收盘价）</li>
</ul>
</li>
</ul>
<ol start="2">
<li><strong>绘制影线</strong></li>
</ol>
<ul>
<li>
<ul>
<li>绘制上影线：从最高价到实体上边缘</li>
<li>绘制下影线：从最低价到实体下边缘</li>
</ul>
</li>
</ul>
<ol start="3">
<li><strong>绘制实体</strong></li>
</ol>
<ul>
<li>
<ul>
<li>根据涨跌选择颜色（阳线红色，阴线绿色）</li>
<li>绘制矩形实体（从开盘价到收盘价）</li>
</ul>
</li>
</ul>
<h4 data-id="heading-10">坐标计算</h4>
<h5 data-id="heading-11">X坐标计算</h5>
<p>K线的X坐标基于其在数据列表中的索引位置：</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-comment">// 每根K线占用的总宽度（从配置中获取）</span>
val totalCandleWidth = config.<span class="hljs-built_in">getTotalCandleWidth</span>()  <span class="hljs-comment">// candleWidth + candleSpacing = 30px</span>

<span class="hljs-comment">// K线中心X坐标（从0开始，不使用偏移）</span>
val centerX = index * totalCandleWidth + config.candleWidth / <span class="hljs-number">2</span>

<span class="hljs-comment">// K线实体左右边界</span>
val left = centerX - config.candleWidth / <span class="hljs-number">2</span>
val right = centerX + config.candleWidth / <span class="hljs-number">2</span>
</code></pre>
<h5 data-id="heading-12">Y坐标计算</h5>
<p>价格转Y坐标的公式：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">priceToY</span><span class="hljs-params">(price: <span class="hljs-type">Float</span>, minPrice: <span class="hljs-type">Float</span>, maxPrice: <span class="hljs-type">Float</span>, height: <span class="hljs-type">Float</span>)</span></span>: <span class="hljs-built_in">Float</span> {
    <span class="hljs-keyword">val</span> priceRange = maxPrice - minPrice
    <span class="hljs-keyword">if</span> (priceRange == <span class="hljs-number">0f</span>) <span class="hljs-keyword">return</span> <span class="hljs-number">0f</span>
    <span class="hljs-keyword">val</span> ratio = (maxPrice - price) / priceRange
    <span class="hljs-keyword">return</span> height * ratio
}
</code></pre>
<p><strong>说明</strong>：</p>
<ul>
<li><code>minPrice</code> 和 <code>maxPrice</code> 是所有K线的价格范围（包含10%边距）</li>
<li><code>height</code> 是View的高度</li>
<li>价格越高，Y坐标越小（屏幕上方）</li>
<li>入门版本绘制所有数据，不区分可见区间</li>
</ul>
<h4 data-id="heading-13">绘制顺序</h4>
<p>绘制K线时，应该<strong>先绘制影线，再绘制实体</strong>，这样实体可以覆盖影线的中间部分：</p>
<ol>
<li><strong>绘制上影线</strong>：从最高价到实体上边缘</li>
<li><strong>绘制下影线</strong>：从最低价到实体下边缘</li>
<li><strong>绘制实体</strong>：绘制矩形，覆盖影线的中间部分</li>
</ol>
<h4 data-id="heading-14">绘制代码示例</h4>
<pre><code class="hljs language-scss" lang="scss">private fun <span class="hljs-built_in">drawCandle</span>(
    canvas: Canvas,
    entity: KLineEntity,
    index: Int,
    minPrice: Float,
    maxPrice: Float,
    height: Float
) {
    <span class="hljs-comment">// 1. 计算X坐标</span>
    val totalCandleWidth = config<span class="hljs-selector-class">.getTotalCandleWidth</span>()
    val centerX = index * totalCandleWidth + config<span class="hljs-selector-class">.candleWidth</span> / <span class="hljs-number">2</span>
    val <span class="hljs-attribute">left</span> = centerX - config<span class="hljs-selector-class">.candleWidth</span> / <span class="hljs-number">2</span>
    val <span class="hljs-attribute">right</span> = centerX + config<span class="hljs-selector-class">.candleWidth</span> / <span class="hljs-number">2</span>

    <span class="hljs-comment">// 2. 计算各价格的Y坐标</span>
    val highY = <span class="hljs-built_in">priceToY</span>(entity.getHighFloat(), minPrice, maxPrice, <span class="hljs-attribute">height</span>)
    val lowY = <span class="hljs-built_in">priceToY</span>(entity.getLowFloat(), minPrice, maxPrice, <span class="hljs-attribute">height</span>)
    val openY = <span class="hljs-built_in">priceToY</span>(entity.getOpenFloat(), minPrice, maxPrice, <span class="hljs-attribute">height</span>)
    val closeY = <span class="hljs-built_in">priceToY</span>(entity.getCloseFloat(), minPrice, maxPrice, <span class="hljs-attribute">height</span>)
    
    <span class="hljs-comment">// 3. 计算实体边界</span>
    val <span class="hljs-attribute">top</span> = <span class="hljs-built_in">minOf</span>(openY, closeY)      <span class="hljs-comment">// 实体上边缘（较小的Y值）</span>
    val <span class="hljs-attribute">bottom</span> = <span class="hljs-built_in">maxOf</span>(openY, closeY)   <span class="hljs-comment">// 实体下边缘（较大的Y值）</span>
    
    <span class="hljs-comment">// 4. 选择颜色和画笔</span>
    val isRising = entity<span class="hljs-selector-class">.isRising</span>()
    val bodyPaint = if (isRising) risingPaint else fallingPaint
    shadowPaint<span class="hljs-selector-class">.color</span> = if (isRising) config<span class="hljs-selector-class">.risingColor</span> else config<span class="hljs-selector-class">.fallingColor</span>
    
    <span class="hljs-comment">// 5. 绘制上影线（从最高价到实体上边缘）</span>
    <span class="hljs-selector-tag">canvas</span><span class="hljs-selector-class">.drawLine</span>(centerX, highY, centerX, top, shadowPaint)
    
    <span class="hljs-comment">// 6. 绘制下影线（从最低价到实体下边缘）</span>
    <span class="hljs-selector-tag">canvas</span><span class="hljs-selector-class">.drawLine</span>(centerX, bottom, centerX, lowY, shadowPaint)
    
    <span class="hljs-comment">// 7. 绘制实体（矩形）</span>
    <span class="hljs-selector-tag">canvas</span><span class="hljs-selector-class">.drawRect</span>(left, top, right, bottom, bodyPaint)
}
</code></pre>
<h4 data-id="heading-15">绘制要点</h4>
<ol>
<li><strong>影线宽度</strong>：通常比实体窄，例如实体宽度20px，影线宽度2px</li>
<li><strong>颜色区分</strong>：</li>
</ol>
<ul>
<li>
<ul>
<li>阳线（上涨）：通常用红色或白色</li>
<li>阴线（下跌）：通常用绿色或黑色</li>
</ul>
</li>
</ul>
<ol start="3">
<li><strong>实体高度</strong>：实体高度 = |收盘价 - 开盘价|，如果开盘价等于收盘价，实体高度为0（显示为一条横线）</li>
<li><strong>影线长度</strong>：</li>
</ol>
<ul>
<li>
<ul>
<li>上影线长度 = 最高价 - max(开盘价, 收盘价)</li>
<li>下影线长度 = min(开盘价, 收盘价) - 最低价</li>
</ul>
</li>
</ul>
<h3 data-id="heading-16">配置模型（KLineConfig）</h3>
<p>K线绘制需要配置参数，我们使用 <code>KLineConfig</code> 来管理这些配置：</p>
<h5 data-id="heading-17">类图</h5>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cc50768eeb374359bda181215a8e79a9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5L2b57O75omT5bel5LuU:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768894895&amp;x-signature=GPhLd3o4gY6FntYKiSJ3fQCCPPI%3D" alt="" loading="lazy"/></p>
<h5 data-id="heading-18">代码实现</h5>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">data</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">KLineConfig</span>(
    <span class="hljs-keyword">val</span> candleWidth: <span class="hljs-built_in">Float</span> = <span class="hljs-number">20f</span>,      <span class="hljs-comment">// K线实体宽度（像素）</span>
    <span class="hljs-keyword">val</span> candleSpacing: <span class="hljs-built_in">Float</span> = <span class="hljs-number">10f</span>,    <span class="hljs-comment">// K线之间的间距（像素）</span>
    <span class="hljs-keyword">val</span> risingColor: <span class="hljs-built_in">Int</span> = <span class="hljs-number">0xFFFF0000</span>, <span class="hljs-comment">// 阳线颜色（红色）</span>
    <span class="hljs-keyword">val</span> fallingColor: <span class="hljs-built_in">Int</span> = <span class="hljs-number">0xFF00FF00</span>,<span class="hljs-comment">// 阴线颜色（绿色）</span>
    <span class="hljs-keyword">val</span> shadowWidth: <span class="hljs-built_in">Float</span> = <span class="hljs-number">2f</span>        <span class="hljs-comment">// 影线宽度（像素）</span>
) {
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">getTotalCandleWidth</span><span class="hljs-params">()</span></span>: <span class="hljs-built_in">Float</span> = candleWidth + candleSpacing
}
</code></pre>
<h5 data-id="heading-19">依赖关系</h5>
<ul>
<li><strong>KLineViewCase1</strong> 依赖 <strong>KLineConfig</strong>：KLineViewCase1内部持有KLineConfig实例，用于获取绘制参数（宽度、间距、颜色等）</li>
<li><strong>KLineViewCase1</strong> 使用 <strong>KLineEntity</strong>：KLineViewCase1接收KLineEntity列表作为数据源进行绘制</li>
</ul>
<h4 data-id="heading-20">配置说明</h4>
<ul>
<li><strong>candleWidth (20px)</strong> : K线实体（矩形部分）的宽度</li>
<li><strong>candleSpacing (10px)</strong> : 相邻两根K线之间的间距</li>
<li><strong>risingColor</strong>: 阳线颜色（收盘价 &gt; 开盘价）</li>
<li><strong>fallingColor</strong>: 阴线颜色（收盘价 &lt; 开盘价）</li>
<li><strong>shadowWidth (2px)</strong> : 影线的宽度</li>
</ul>
<h4 data-id="heading-21">参数关系</h4>
<pre><code class="hljs language-ini" lang="ini">每根K线占用的总宽度 = candleWidth + <span class="hljs-attr">candleSpacing</span>
                   = 20px + <span class="hljs-attr">10px</span> = <span class="hljs-number">30</span>px
</code></pre>
<p><strong>说明</strong>：入门版本会绘制所有K线数据，不涉及可见区间和数量限制的计算。</p>
<h3 data-id="heading-22">完整绘制流程</h3>
<h4 data-id="heading-23">View的onDraw方法</h4>
<p>K线图的绘制在自定义View的 <code>onDraw()</code> 方法中完成，完整流程如下：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onDraw</span><span class="hljs-params">(canvas: <span class="hljs-type">Canvas</span>)</span></span> {
    <span class="hljs-keyword">super</span>.onDraw(canvas)

    <span class="hljs-comment">// 0. 绘制背景</span>
    <span class="hljs-keyword">val</span> width = width.toFloat()
    <span class="hljs-keyword">val</span> height = height.toFloat()
    canvas.drawRect(<span class="hljs-number">0f</span>, <span class="hljs-number">0f</span>, width, height, backgroundPaint)

    <span class="hljs-keyword">if</span> (klineData.isEmpty()) {
        <span class="hljs-keyword">return</span>
    }

    <span class="hljs-comment">// 1. 计算价格范围（包含边距）</span>
    <span class="hljs-keyword">val</span> priceRange = calculatePriceRange()
    <span class="hljs-keyword">if</span> (priceRange.first &gt;= priceRange.second) {
        <span class="hljs-keyword">return</span>  <span class="hljs-comment">// 价格范围无效</span>
    }

    <span class="hljs-keyword">val</span> minPrice = priceRange.first
    <span class="hljs-keyword">val</span> maxPrice = priceRange.second

    <span class="hljs-comment">// 2. 遍历所有K线数据，逐根绘制</span>
    klineData.forEachIndexed { index, entity -&gt;
        drawCandle(canvas, entity, index, minPrice, maxPrice, height)
    }
}
</code></pre>
<h4 data-id="heading-24">价格范围计算</h4>
<p>在绘制K线之前，需要先计算所有K线的价格范围（最高价和最低价），并添加边距：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">calculatePriceRange</span><span class="hljs-params">()</span></span>: Pair&lt;<span class="hljs-built_in">Float</span>, <span class="hljs-built_in">Float</span>&gt; {
    <span class="hljs-keyword">if</span> (klineData.isEmpty()) {
        <span class="hljs-keyword">return</span> <span class="hljs-number">0f</span> to <span class="hljs-number">0f</span>
    }

    <span class="hljs-keyword">var</span> minPrice = <span class="hljs-built_in">Float</span>.MAX_VALUE
    <span class="hljs-keyword">var</span> maxPrice = <span class="hljs-built_in">Float</span>.MIN_VALUE

    <span class="hljs-comment">// 遍历所有K线，找出最高价和最低价</span>
    klineData.forEach { entity -&gt;
        <span class="hljs-keyword">val</span> high = entity.getHighFloat()
        <span class="hljs-keyword">val</span> low = entity.getLowFloat()
        <span class="hljs-keyword">if</span> (high &gt; maxPrice) maxPrice = high
        <span class="hljs-keyword">if</span> (low &lt; minPrice) minPrice = low
    }

    <span class="hljs-comment">// 添加10%的边距，让K线不会紧贴上下边缘</span>
    <span class="hljs-keyword">val</span> priceRange = maxPrice - minPrice
    <span class="hljs-keyword">val</span> padding = priceRange * <span class="hljs-number">0.1f</span>
    <span class="hljs-keyword">val</span> adjustedMinPrice = minPrice - padding
    <span class="hljs-keyword">val</span> adjustedMaxPrice = maxPrice + padding

    <span class="hljs-keyword">return</span> adjustedMinPrice to adjustedMaxPrice
}
</code></pre>
<p><strong>为什么要添加边距？</strong></p>
<ul>
<li>避免K线紧贴View的上下边缘</li>
<li>让图表看起来更美观</li>
</ul>
<h4 data-id="heading-25">完整绘制链路</h4>
<p>K线绘制的完整流程：</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-number">1</span>. 设置K线数据 → 触发<span class="hljs-built_in">onDraw</span>()重绘
   ↓
<span class="hljs-number">2</span>. <span class="hljs-built_in">onDraw</span>()方法执行：
   ├─ 绘制背景
   ├─ 检查数据是否为空
   ├─ 计算价格范围
   │   ├─ 遍历所有K线，找出最高价和最低价
   │   └─ 添加<span class="hljs-number">10%</span>边距
   └─ 遍历K线数据，对每根K线调用<span class="hljs-built_in">drawCandle</span>()
       ├─ 计算X坐标（基于索引）
       ├─ 计算Y坐标（最高价、最低价、开盘价、收盘价）
       ├─ 绘制上影线
       ├─ 绘制下影线
       └─ 绘制实体
</code></pre>
<h3 data-id="heading-26">效果</h3>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/49bb1c5b3f58461c9a7a616f707c2894~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5L2b57O75omT5bel5LuU:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768894895&amp;x-signature=BF6hD1SJ6ywFP9oTLr1O%2BdsvV%2F4%3D" alt="" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[一文看懂 AI 世界里的新黑话Skills、MCP、Projects、Prompts]]></title>    <link>https://juejin.cn/post/7594533204003192895</link>    <guid>https://juejin.cn/post/7594533204003192895</guid>    <pubDate>2026-01-13T07:47:38.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7594533204003192895" data-draft-id="7594385386740367379" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="一文看懂 AI 世界里的新黑话Skills、MCP、Projects、Prompts"/> <meta itemprop="keywords" content="AI编程,OpenAI,人工智能"/> <meta itemprop="datePublished" content="2026-01-13T07:47:38.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="狼爷"/> <meta itemprop="url" content="https://juejin.cn/user/2418581314208279"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            一文看懂 AI 世界里的新黑话Skills、MCP、Projects、Prompts
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2418581314208279/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    狼爷
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-13T07:47:38.000Z" title="Tue Jan 13 2026 07:47:38 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    4
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读11分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:14px;overflow-x:hidden;color:var(--cyanosis-base-color);transition:color .35s;--cyanosis-base-color:#353535;--cyanosis-title-color:#005bb7;--cyanosis-strong-color:#2196f3;--cyanosis-em-color:#4fc3f7;--cyanosis-del-color:#ccc;--cyanosis-link-color:#3da8f5;--cyanosis-linkh-color:#007fff;--cyanosis-border-color:#bedcff;--cyanosis-border-color-2:#ececec;--cyanosis-bg-color:#fff;--cyanosis-blockquote-color:#8c8c8c;--cyanosis-blockquote-bg-color:#f0fdff;--cyanosis-code-color:#c2185b;--cyanosis-code-bg-color:#fff4f4;--cyanosis-code-pre-color:#f8f8f8;--cyanosis-table-border-color:#c3e0fd;--cyanosis-table-th-color:#dff0ff;--cyanosis-table-tht-color:#005bb7;--cyanosis-table-tr-nc-color:#f7fbff;--cyanosis-table-trh-color:#e0edf7;--cyanosis-slct-title-color:#005bb7;--cyanosis-slct-titlebg-color:rgba(175,207,247,0.25);--cyanosis-slct-text-color:#c80000;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#e8ebec;--cyanosis-slct-codebg-color:#ffeaeb;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body.__dark{--cyanosis-base-color:#cacaca;--cyanosis-title-color:#ddd;--cyanosis-strong-color:#fe9900;--cyanosis-em-color:#ffd28e;--cyanosis-del-color:#ccc;--cyanosis-link-color:#ffb648;--cyanosis-linkh-color:#fe9900;--cyanosis-border-color:#ffe3ba;--cyanosis-border-color-2:#ffcb7b;--cyanosis-bg-color:#2f2f2f;--cyanosis-blockquote-color:#c7c7c7;--cyanosis-blockquote-bg-color:rgba(255,199,116,0.1);--cyanosis-code-color:#000;--cyanosis-code-bg-color:#ffcb7b;--cyanosis-code-pre-color:rgba(255,227,185,0.5);--cyanosis-table-border-color:#fe9900;--cyanosis-table-th-color:#ffb648;--cyanosis-table-tht-color:#000;--cyanosis-table-tr-nc-color:#6d5736;--cyanosis-table-trh-color:#947443;--cyanosis-slct-title-color:#000;--cyanosis-slct-titlebg-color:#fe9900;--cyanosis-slct-text-color:#00c888;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#000;--cyanosis-slct-codebg-color:#ffcb7b;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body h1{padding-bottom:4px;font-size:30px}.markdown-body h1,.markdown-body h2{margin-top:36px;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);transition:color .35s}.markdown-body h2{position:relative;padding-left:10px;padding-right:10px;padding-bottom:10px;font-size:24px;border-bottom:1px solid var(--cyanosis-border-color-2)}.markdown-body h2:before{content:"「";position:absolute;top:-6px;left:-14px}.markdown-body h2:after{content:"」";position:relative;top:6px;right:auto}.markdown-body h3{position:relative;padding-bottom:0;margin-top:30px;margin-bottom:10px;font-size:20px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h3:before{content:"»";padding-right:6px;color:var(--cyanosis-strong-color)}.markdown-body h4{margin-top:24px;font-size:16px}.markdown-body h4,.markdown-body h5{padding-bottom:0;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h5{margin-top:18px;font-size:14px}.markdown-body h6{padding-bottom:0;margin-top:12px;margin-bottom:10px;font-size:12px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body p{line-height:inherit;margin-top:16px;margin-bottom:16px}.markdown-body img{max-width:100%}.markdown-body hr{position:relative;width:98%;height:1px;margin-top:32px;margin-bottom:32px;background-image:linear-gradient(90deg,var(--cyanosis-link-color),rgba(255,0,0,.3),hsla(0,0%,100%,.1),rgba(255,0,0,.3),var(--cyanosis-link-color));border-width:0;overflow:visible}.markdown-body hr:after{content:"";position:absolute;margin:auto;left:0;right:0;bottom:0;top:0;display:inline-block;width:60px;height:20px;background-color:var(--cyanosis-bg-color);background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAgCAYAAABgrToAAAADoklEQVRYR82XTYgcRRTHf2933Q1RjAa9eFO8JHoJ8RQVBQ2iBwXBET0YEUTXNVmNQtTpmeqaWV0XNRq/o4KoECSCEPSg4CF+BYUkIIiCoCJCPIhC/Ihh2Z0nVV27VnZnenumW9i6ddV7//frV69fVQurfMgq56NawFTPAU6QyomqXrw6wIZeyhCPebA5buNR+akKyGoAjd6BshthnYdSjqNcRVuOlIUsD2j0SuA94IwuMHdh5ZUykOUBXfSGbmKI54EtAeYIHSZoy5dl4JxvNYBOKdW1KE8BQ8AkVk6WhasWsAiN0TX9gveXQaPP+Aytpc4u+bMI06JNohsYYYYOR2lJWtS3OKDRfcAtQfgDoI6Vo4UCGb0OmAEuDvZvYmVbEd/igC3dzDz7gQu8sPA9kJDK27mBmjqBeLjTg90PDFOjWawFFQd06kZHEfaj3LAIpTRpSXsZ5E06zEYP9sDimnAApYaV2SLZG/wjMeqAkijwW4xQJ5Gf/ZzRC8OW3hiBTGGlURRswW55Bh/Ssxljrwew8l1PQaM14GngvGDzBUKdDsMeTtgU5o8B92PFlUf3YXUrHa7Fys6lBqcCGnX15YQ2A18FyPd7Crd1A3M8C1wdbH4DD3hWeP6IEXbQkG97ajR1HPFnuPP5jFFq1OWX7hl8WM9l1AO648uNfwLk7tytMeogty+xeQ4rO3r6bdcx1nuwOGsHmaXGtPzae4uzGnLH1kQkvpdZGrHjssBZJrL+pqS05KWc8tgITAPXRzYvYOXe/C2OV43eDcRBDtIhoS2f9wzc0Cv8Wls+zoFzUC5zF0U241h5uZtPfptp6OUM8wbK+cH5GEpCS17P3fJei0Z3+npTxryJ8CPzbKMtn/ZyWbkPGl0PuFPkmkjkcb4h4R2ZLwRq1H0ALmvjkf2HwK1Y+T1PY2XABe/sHJ6MxN5lnoSpnC/UGbsTaI5phK2R7x6s3Ffk5YoDOrWm3onwJHBmEP86bPmBrsGaenNoIdnxCH+gPEhLXi0Cl1VBvyPVLSh7gEuC62yAfOIUqabWEaaiucMIk6RyqJ+Q/QM69V26jjW86Gvov/EaoyT8zRCn+Xq7PVrbx0nuYUaO9wM3WAbjCE1NEUw09Um4UV+2OKfYfu5/S19gsAzGKqm6LE5FrShbdS0ku465DjDwKA/oQht19ejqbaEVuRbiLhuHByYLjtUAZpDutzP7cYdHsPJXWbjyNVgFwQoa1WXwf4Jd9YD/Ap80+yE7+u9aAAAAAElFTkSuQmCC);background-repeat:no-repeat;background-size:auto 100%;background-position-x:center;transition:background-color .5s}.markdown-body code{padding:.065em .4em;font-size:.87em;color:var(--cyanosis-code-color);word-break:break-word;overflow-x:auto;background-color:var(--cyanosis-code-bg-color);border-radius:2px}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{display:block;padding:16px 12px;margin:0;font-size:12px;color:#333;word-break:normal;overflow-x:auto;background:var(--cyanosis-code-pre-color)}.markdown-body pre&gt;code::-webkit-scrollbar{width:4px;height:4px}.markdown-body pre&gt;code::-webkit-scrollbar-track{background-color:var(--cyanosis-border-color)}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:var(--cyanosis-strong-color);border-radius:10px}.markdown-body a{position:relative;text-decoration:none;color:var(--cyanosis-link-color);border-bottom:1px solid var(--cyanosis-border-color)}.markdown-body a:hover{border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body a:active,.markdown-body a:hover{color:var(--cyanosis-linkh-color)}.markdown-body a:after{position:absolute;content:"";top:100%;left:0;width:100%;opacity:0;border-bottom:1px solid var(--cyanosis-border-color);transition:top .3s,opacity .3s;transform:translateZ(0)}.markdown-body a:hover:after{top:0;opacity:1;border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid var(--cyanosis-table-border-color);border-spacing:0;border-collapse:collapse}.markdown-body table thead{color:#000;text-align:left;font-size:14px;background:#f6f6f6}.markdown-body table tr:nth-child(2n){background-color:var(--cyanosis-table-tr-nc-color)}.markdown-body table tr:hover{background-color:var(--cyanosis-table-trh-color)}.markdown-body table td,.markdown-body table th{padding:12px 8px;line-height:24px;border:1px solid var(--cyanosis-table-border-color)}.markdown-body table th{color:var(--cyanosis-table-tht-color);background-color:var(--cyanosis-table-th-color)}.markdown-body table td{min-width:120px}.markdown-body blockquote{color:var(--cyanosis-blockquote-color);border-left:4px solid var(--cyanosis-strong-color);background-color:var(--cyanosis-blockquote-bg-color);padding:1px 20px;margin:22px 0;transition:color .35s}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body b,.markdown-body blockquote&gt;b,.markdown-body blockquote&gt;strong,.markdown-body strong{color:var(--cyanosis-strong-color)}.markdown-body em,.markdown-body i{color:var(--cyanosis-em-color)}.markdown-body del{color:var(--cyanosis-del-color)}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:4px}.markdown-body ol li{padding-left:6px}.markdown-body details&gt;summary{outline:none;color:var(--cyanosis-title-color);font-size:20px;font-weight:bolder;border-bottom:1px solid var(--cyanosis-border-color);cursor:pointer}.markdown-body details&gt;p{padding:10px 20px;margin:10px 0 0;color:#666;background-color:var(--cyanosis-blockquote-bg-color);border:2px dashed var(--cyanosis-strong-color)}.markdown-body h1::selection,.markdown-body h2::selection,.markdown-body h3::selection,.markdown-body h4::selection,.markdown-body h5::selection,.markdown-body h6::selection{color:var(--cyanosis-slct-title-color);background-color:var(--cyanosis-slct-titlebg-color)}.markdown-body ol li::selection,.markdown-body p::selection,.markdown-body ul li::selection{color:var(--cyanosis-slct-text-color);background-color:var(--cyanosis-slct-bg-color)}.markdown-body a::selection,.markdown-body b::selection,.markdown-body em::selection,.markdown-body i::selection,.markdown-body strong::selection{background-color:var(--cyanosis-slct-elbg-color)}.markdown-body del::selection{color:var(--cyanosis-slct-del-color);background-color:var(--cyanosis-slct-elbg-color)}.markdown-body table thead th::selection{background-color:transparent}.markdown-body table tbody td::selection{background-color:var(--cyanosis-slct-bg-color)}.markdown-body code::selection{background-color:var(--cyanosis-slct-codebg-color)}.markdown-body pre&gt;code::selection{background-color:var(--cyanosis-slct-prebg-color)}.markdown-body .contains-task-list{padding-left:14px;list-style:none}.markdown-body .contains-task-list input[type=checkbox]{position:relative}.markdown-body .contains-task-list input[type=checkbox]:before{content:"";position:absolute;top:0;left:0;right:0;bottom:0;width:inherit;height:inherit;background:#f0f8ff;border:1px solid #add6ff;border-radius:2px;box-sizing:border-box;z-index:1}.markdown-body .contains-task-list input[type=checkbox]:checked:after{content:"✓";position:absolute;top:-12px;left:0;right:0;bottom:0;width:0;height:0;color:#f55;font-size:20px;font-weight:700;z-index:2}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="srcery">.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#1c1b19;color:#fce8c3}.hljs-emphasis,.hljs-strong{color:#918175}.hljs-bullet,.hljs-link,.hljs-literal,.hljs-number,.hljs-quote,.hljs-regexp{color:#ff5c8f}.hljs-code,.hljs-selector-class{color:#68a8e4}.hljs-emphasis{font-style:italic}.hljs-attribute,.hljs-keyword,.hljs-section,.hljs-selector-tag,.hljs-variable{color:#ef2f27}.hljs-name,.hljs-title{color:#fbb829}.hljs-params,.hljs-type{color:#0aaeb3}.hljs-string{color:#98bc37}.hljs-addition,.hljs-built_in,.hljs-builtin-name,.hljs-selector-attr,.hljs-selector-id,.hljs-selector-pseudo,.hljs-subst,.hljs-symbol,.hljs-template-tag,.hljs-template-variable{color:#c07abe}.hljs-comment,.hljs-deletion,.hljs-meta{color:#918175}</style><h2 data-id="heading-0">Skills、MCP、Projects、Prompts 到底在说什么？</h2>
<p>最近不少人跟我吐槽：</p>
<blockquote>
<p>“我只是想用下 AI，结果一抬头全是新名词，低头一看，自己仿佛落后了一个时代。”</p>
</blockquote>
<p>Skills、MCP、Projects、Prompts……这些词听起来像高深的新框架、新协议，甚至像某种“圈内黑话”，但说实话——<strong>没那么玄</strong>。</p>
<p>今天咱们逐个拆解，用最直白的话把这些概念讲透，看完你就能轻松跟上 AI 圈的节奏。</p>
<hr/>
<h2 data-id="heading-1">一、Prompts（提示词）：控制 AI 输出的基础语言工具</h2>
<p>先从最基础，也最容易被低估的概念说起——Prompt。</p>
<h3 data-id="heading-2">1️⃣ 什么是 Prompt？</h3>
<p>核心定义很简单：<strong>Prompt = 你给 AI 的指令 / 输入</strong></p>
<p>比如这些常见场景，你输出的内容都是 Prompt：</p>
<ul>
<li>
<p>“帮我写一段 Java 代码，实现用户登录校验”</p>
</li>
<li>
<p>“用小学生能听懂的话解释什么是 JVM”</p>
</li>
<li>
<p>“假设你是资深 Java 架构师，帮我设计一个高可用的订单系统”</p>
</li>
</ul>
<p>一句话总结：<strong>Prompts 本质是“你跟 AI 沟通的自然语言指令或可复用模板”</strong>，核心作用是精准传递需求，为模型提供上下文和方向，是控制 AI 输出的基础语言工具，而非“解决效率低下”本身。需要注意的是，Prompts 是即时的、一次性的，除非刻意保存，否则仅存在于当前对话中。([claude.com][2])</p>
<hr/>
<h3 data-id="heading-3">2️⃣ 为什么 Prompt 这么重要？</h3>
<p>关键前提：AI 没有“读心术”，它只会 <strong>严格按照你给出的指令执行</strong>，你的 Prompt 质量直接决定输出效果。</p>
<p>这是最直观的对比：</p>
<ul>
<li>
<p>Prompt 模糊 → 输出敷衍、抓不住重点（像摸鱼）</p>
</li>
<li>
<p>Prompt 清晰 → 输出精准、专业度拉满（像加班赶工）</p>
</li>
</ul>
<p>用同一个 AI 测试，差距立现：</p>





















<table><thead><tr><th>Prompt</th><th>输出结果</th></tr></thead><tbody><tr><td>给我讲下 Redis</td><td>泛泛而谈，只讲基础定义，无实际应用价值</td></tr><tr><td>用 Java 后端工程师视角，结合高并发场景讲 Redis 的缓存策略、穿透解决方案</td><td>聚焦后端核心需求，从原理到实践，附带代码示例和避坑指南</td></tr><tr><td>这就是为什么“Prompt Engineering（提示词工程）”会成为热门技能——说白了，它就是 <strong>“把需求说清楚、说精准”的工程化能力</strong>。将复杂指令做成可复用的 Prompt 模板确实能提高效率，但这是应用价值，而非 Prompts 的核心定义。([mcp-sdk.com][4])</td><td/></tr></tbody></table>
<hr/>
<h2 data-id="heading-4">二、Skills（技能包）：封装好的专业解决步骤</h2>
<p>如果说 Prompt 是“单次的指挥指令”，那 <strong>Skills 就是模型可复用的“专业能力包”</strong>——是一组封装好的专业知识、操作指导和执行逻辑，包含指令、方法、脚本、资源等，能在多个对话或项目中重复使用，当模型判断需求匹配时会自动加载并调用。需要特别纠正的是，Skills 不是“给 AI 装工具”（接入工具是 MCP 的作用），更像是“专业手册 + 操作说明 + 业务流程模板”。</p>
<hr/>
<h3 data-id="heading-5">1️⃣ 什么是 Skill？</h3>
<p>AI 领域的 Skill 定义精准且明确：<strong>Skill = 可复用、动态加载的专业能力包</strong>，核心是通过结构化的流程和知识，增强模型执行复杂任务的能力。</p>
<p>比如这些都是典型的 AI Skill：</p>
<ul>
<li>代码编写（Java/Python/前端等多语言）</li>
<li>文档翻译与跨语言对齐</li>
<li>长文本总结与关键信息提取</li>
<li>UI 原型图/架构图绘制</li>
<li>第三方 API 调用与数据交互</li>
<li>数据库查询与数据分析</li>
<li>自动化测试用例生成</li>
</ul>
<p>通俗理解：<strong>Skill 就像是 AI 的“专业工具箱里的标准化工具套装”</strong>。举个例子，若你常做竞品分析，可创建一个“竞品分析 Skill”，里面包含检索数据的步骤、分析框架、输出格式和相关方法；当你下达竞品分析需求时，模型会自动识别并加载这个 Skill 辅助完成任务。</p>
<p>一句话总结：Prompts 是单次指令，Skills 是封装好的、结构化的专业解决步骤。</p>
<hr/>
<h3 data-id="heading-6">2️⃣ 为什么现在大家都在强调 Skills？</h3>
<p>核心原因：AI 早已不是“一问一答的聊天机器人”了。</p>
<p>以前用 AI：<strong>你问一句，它答一句</strong>，主动权完全在你手里，需要你一步步引导；</p>
<p>现在用 AI：<strong>你抛一个目标，它自己拆步骤、选技能、落地执行</strong></p>
<p>这时候你关心的核心问题，已经从“它聪不聪明”变成了**“它能不能精准匹配我的需求，把这件事干成”**——而 Skills 就是判断 AI 能力边界的核心标准。</p>
<hr/>
<h2 data-id="heading-7">三、Projects（项目/工作区）：持久的上下文空间</h2>
<p>这是 AI 提升任务连贯性的关键设计——从“碎片化对话记忆”升级到“集中化上下文管理”，核心是提供一个持久的独立工作区，而非“解决记忆缺失”。</p>
<hr/>
<h3 data-id="heading-8">1️⃣ 什么是 AI Projects？</h3>
<p>定义精准且明确：<strong>Project = 带有大上下文窗口的独立工作区</strong>，用于集中存放一个任务所需的背景资料、知识库、规则和文件等，让模型在这个项目范围内持续利用这些内容，无需重复上传或解释背景。</p>
<p>比如这些场景，都属于 AI Projects：</p>
<ul>
<li>从 0 到 1 开发一个个人博客系统（含需求分析、架构设计、代码编写、部署文档）</li>
<li>设计一套高并发秒杀方案（含流量预估、防超卖策略、压测方案）</li>
<li>开发一个自动生成周报的工具（对接企业 IM 数据、提取工作内容、格式化输出）</li>
<li>搭建一套 AI 客服系统（对接业务知识库、设计对话流程、自动回复与转接）</li>
</ul>
<p>这里的关键区别：不再是“问一句答一句”的碎片化互动，更核心的是 <strong>“一个项目中的背景资料始终可用，实现上下文的持久化管理”</strong> 。</p>
<p>有无 Projects 的核心差异如下：</p>

















<table><thead><tr><th>无 Projects</th><th>有 Projects</th></tr></thead><tbody><tr><td>模型只能记住当前对话里的内容</td><td>一个项目中的背景资料始终可用</td></tr><tr><td>重复上传/解释任务背景</td><td>项目内部持久保存背景知识</td></tr></tbody></table>
<p>所以，Projects 不仅仅是“解决记忆缺失”，而是提供一个空间让上下文长期有效。</p>
<hr/>
<h3 data-id="heading-9">2️⃣ 为什么 Projects 越来越重要？</h3>
<p>因为真实世界的工作，从来不是“一句话能解决的”。</p>
<p>一个完整的真实任务，必然包含这几个环节：</p>
<ol>
<li>精准理解需求（甚至挖掘潜在需求）</li>
<li>拆解任务步骤（把大目标拆成可执行的小任务）</li>
<li>选择工具/技能（匹配每个步骤需要的能力）</li>
<li>落地执行（编写代码、整理文档、调试问题）</li>
<li>迭代修正（根据反馈优化结果）</li>
<li>交付最终成果（可直接使用的产品/方案/文档）</li>
</ol>
<p>而 <strong>Projects 就是把 AI 的工作场景“固定化、集中化”的核心载体</strong>，让复杂任务的推进更连贯、高效。</p>
<p>一句话总结：<strong>Projects = AI 处理复杂任务的“专属工作室”，核心价值是提供持久的上下文空间</strong>。</p>
<hr/>
<h2 data-id="heading-10">四、MCP：让 AI 真正“接入现实世界”的关键</h2>
<p>终于到了最容易让人劝退的词——MCP。别慌，它不是什么高深的技术壁垒，核心作用就一个：让 AI 安全地“动手干活”。</p>
<hr/>
<h3 data-id="heading-11">1️⃣ MCP 到底是什么？</h3>
<p>先看全称：MCP（Model Context Protocol），模型上下文协议。</p>
<p>一句话讲懂：<strong>MCP = 让 AI 安全、规范地接入外部数据源和工具的开放标准协议/连接层</strong>。它通过标准化接口实现 AI 与外部资源的对接，无需为每个资源编写定制代码，从根本上解决了“大语言模型无法天然访问外部数据和工具”的问题。</p>
<p>这里的“外部世界”，就是我们真实工作中会用到的各类系统：</p>
<ul>
<li>企业内部数据库（客户数据、订单数据）</li>
<li>文件系统（本地文档、云存储文件）</li>
<li>公司业务系统（CRM、ERP、OA）</li>
<li>第三方 API（支付接口、地图接口、短信接口）</li>
<li>各类办公工具（Excel、PPT、Jira）</li>
</ul>
<hr/>
<h3 data-id="heading-12">2️⃣ 没有 MCP，AI 就是“纸上谈兵”</h3>
<p>没有 MCP 的约束和支持，AI 再聪明，也像“被关在玻璃房里的专家”——能出方案，但没法落地执行。</p>
<p>具体来说，它做不了这些事：</p>
<ul>
<li>查询你公司的内部业务数据（比如“统计上月华东地区的销售数据”）</li>
<li>直接调用你的业务接口（比如“自动创建一个客户跟进工单”）</li>
<li>修改你本地/云存储的文件（比如“更新这份项目计划书的进度表”）</li>
</ul>
<p>而有了 MCP 之后，AI 才能 <strong>合法、受控、可审计地接入真实世界的资源并动手干活</strong>——这也是企业级 AI 应用的核心前提，这才是“接入工具/数据”的核心逻辑。</p>
<hr/>
<h3 data-id="heading-13">3️⃣ MCP 解决的核心问题：可控性</h3>
<p>企业用 AI，最担心的不是“AI 不够聪明”，而是“AI 乱干活”。MCP 的核心价值，就是解决“可控性”问题。</p>
<p>具体来说，它能保证：</p>
<ul>
<li>不乱调用接口（只允许调用授权范围内的接口）</li>
<li>不乱读数据（只能访问指定权限的数据，保护隐私）</li>
<li>不越权操作（严格遵循角色权限，比如普通员工不能修改管理员数据）</li>
<li>操作可追溯（每一步调用都有日志，出问题能排查）</li>
</ul>
<p>所以 MCP 的本质，不是让 AI“更聪明”，而是让 AI <strong>具备连接真实世界的能力，成为能落地的</strong> <strong>企业级</strong> <strong>工具</strong> <strong>——可靠、可控、可</strong> <strong>对接外部资源</strong>。</p>
<hr/>
<h2 data-id="heading-14">五、串起来看：一条完整的 AI 工作链路</h2>
<p>单独看每个概念可能有点散，把它们串起来，就能理解 AI 工作的完整逻辑了：</p>
<ol>
<li><strong>Prompt（指令）</strong>：你用自然语言精准告诉 AI“要做什么、要什么结果”——这是启动信号，核心是让模型听懂需求；</li>
<li><strong>Skills（技能包）</strong>：AI 根据指令，从“专业能力库”里挑选封装好的流程和知识（比如竞品分析框架、代码编写规范）；</li>
<li><strong>Projects（工作区）</strong>：AI 在专属的持久化空间里推进任务，背景资料、中间成果全程可用，无需重复沟通；</li>
<li><strong>MCP（协议）</strong>：AI 通过标准化接口，安全接入企业数据库、云盘等外部资源，落地执行真实业务操作（比如查询销售数据、调用业务接口）。</li>
</ol>
<p>一句话终极总结：</p>
<blockquote>
<p>Prompt 是“让模型听懂的指令”，Skills 是“模型做事的专业流程”，Projects 是“模型工作的专属空间”，MCP 是“模型连接真实世界的桥梁”。</p>
</blockquote>
<hr/>
<h2 data-id="heading-15">六、核心概念对照与新手落地建议</h2>
<p>先通过一张表格清晰对照四个概念的核心信息，帮你建立精准认知：</p>



































<table><thead><tr><th>术语</th><th>作用层级</th><th>核心定义</th><th>解决的核心问题</th></tr></thead><tbody><tr><td>Prompts</td><td>输入指令</td><td>用户输入的自然语言指令或模板，引导模型生成期望输出</td><td>让模型“听懂你说什么”</td></tr><tr><td>Skills</td><td>专业能力包</td><td>可复用、动态加载的专业知识+操作逻辑组合</td><td>让模型“知道怎么做”</td></tr><tr><td>Projects</td><td>上下文空间</td><td>持久化的独立工作区，存放任务背景资料与资源</td><td>让模型“持续记住背景”</td></tr><tr><td>MCP</td><td>外部连接层</td><td>标准化协议/连接层，让 AI 安全接入外部资源</td><td>让模型“能接入真实世界资源”</td></tr></tbody></table>
<p>如果看完还是有点懵，完全正常——不用急于掌握所有概念，按“从易到难、从用起来到深下去”的顺序来：</p>
<ol>
<li>
<p><strong>先练 Prompt：把“指挥权”抓在手里</strong>
核心目标：能清晰、精准地描述需求。这一步比学任何新框架都重要，是用好 AI 的基础。建议从“明确角色（比如‘你是 Java 开发’）+ 明确任务（比如‘写登录接口’）+ 明确要求（比如‘含参数校验’）”的格式练起，后续可将高频需求整理为可复用模板。</p>
</li>
<li>
<p><strong>再理解 Skills：梳理“可用的专业能力”</strong>
核心目标：结合自己的工作场景，梳理 AI 哪些封装好的 Skills 能帮到你。比如后端开发可关注“代码调试 Skill、架构设计 Skill”，运营可关注“文案优化 Skill、数据分析 Skill”，也可根据高频任务自定义 Skills。</p>
</li>
<li>
<p><strong>用 Projects 思维提效：搭建“专属工作区”</strong>
核心目标：处理复杂任务时，用 Projects 集中管理背景资料。比如做项目方案时，将需求文档、参考案例、团队规则都放入同一个 Project，避免重复上传和解释，提升任务连贯性。</p>
</li>
<li>
<p><strong>MCP 先了解，不用急着深钻</strong>
核心目标：知道 MCP 是“AI 接入外部系统的标准化协议”即可。只有当你需要“让 AI 操作公司数据库、调用业务接口”等企业级落地需求时，再去深入了解 MCP 的具体实现和规范。</p>
</li>
</ol>
<hr/>
<h2 data-id="heading-16">最后：记住一个核心判断标准</h2>
<p>AI 领域的新词会越来越多，今天的“黑话”可能明天就变成“基础概念”，但无论出现多少新词，判断它们有没有价值的标准只有一个：</p>
<blockquote>
<p><strong>它能不能帮你把事干成、把效率提上去？</strong></p>
</blockquote>
<p>不用为了“懂黑话”而懂黑话，能精准理解概念、用好这些工具让 AI 成为你的“得力助手”，才是最终目的。</p>
<h2 data-id="heading-17">参考资料：</h2>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.53ai.com%2Fnews%2FLargeLanguageModel%2F2025111408153.html" target="_blank" title="https://www.53ai.com/news/LargeLanguageModel/2025111408153.html" ref="nofollow noopener noreferrer">www.53ai.com/news/LargeL…</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.claude.com%2Fblog%2Fskills-explained" target="_blank" title="https://www.claude.com/blog/skills-explained" ref="nofollow noopener noreferrer">www.claude.com/blog/skills…</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fclaude.com%2Fblog%2Fskills-explained" target="_blank" title="https://claude.com/blog/skills-explained" ref="nofollow noopener noreferrer">claude.com/blog/skills…</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.mcp-sdk.com%2Fguide%2Fconcepts%2Fprompts.html" target="_blank" title="https://www.mcp-sdk.com/guide/concepts/prompts.html" ref="nofollow noopener noreferrer">www.mcp-sdk.com/guide/conce…</a></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[如何发布自定义 Spring Boot Starter]]></title>    <link>https://juejin.cn/post/7594403873178042409</link>    <guid>https://juejin.cn/post/7594403873178042409</guid>    <pubDate>2026-01-13T07:08:08.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7594403873178042409" data-draft-id="7594627998839013418" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="如何发布自定义 Spring Boot Starter"/> <meta itemprop="keywords" content="Spring Boot"/> <meta itemprop="datePublished" content="2026-01-13T07:08:08.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="袁慎建"/> <meta itemprop="url" content="https://juejin.cn/user/1310273592900317"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            如何发布自定义 Spring Boot Starter
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1310273592900317/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    袁慎建
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-13T07:08:08.000Z" title="Tue Jan 13 2026 07:08:08 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读11分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">引言</h2>
<p>最近在工作中遇到了 API 限流的需求，市面上虽然有一些现成的解决方案，但总觉得不够灵活，要么功能太重，要么配置复杂。于是萌生了一个想法：为什么不自己开发一个轻量级的限流器Starter呢？既能满足自己的需求，又能学习Spring Boot Starter的开发和发布流程。</p>
<p>这篇文章就来分享一下我是如何从零开始开发一个自定义限流器Spring Boot Starter，并最终成功发布到Maven Central的经历。希望能给有类似需求的同学一些参考。</p>
<h2 data-id="heading-1">为什么需要自定义Spring Boot Starter？</h2>
<p>在开始之前，我们先来聊聊Spring Boot Starter到底是什么，以及为什么要使用它。</p>
<p>简单来说，Spring Boot Starter是一种特殊的依赖项，它封装了一组相关的依赖和配置，让我们能够快速集成某个功能模块。比如我们常用的 <code>spring-boot-starter-web</code>、<code>spring-boot-starter-data-jpa</code>等，它们内部已经帮我们整合了多个相关的依赖，并提供了合理的默认配置。</p>
<p>那么，Spring Boot Starter相比传统的JAR包有什么优势呢？</p>
<ol>
<li><strong>自动配置</strong>：Starter可以根据类路径下的依赖自动配置相应的组件，大大减少了手动配置的工作量。</li>
<li><strong>依赖聚合</strong>：一个Starter可以聚合多个相关的依赖，避免了手动管理复杂的依赖关系。</li>
<li><strong>约定优于配置</strong>：提供了合理的默认配置，开箱即用。</li>
<li><strong>条件化配置</strong>：通过 <code>@ConditionalOnProperty</code>、<code>@ConditionalOnClass</code>等注解，可以根据条件决定是否加载某些配置。</li>
</ol>
<p>举个例子，如果我们直接使用Redis进行限流，需要引入 <code>spring-boot-starter-data-redis</code>，然后手动配置RedisTemplate，再编写限流逻辑。而有了限流器Starter后，只需要引入一个依赖，配置几个参数，就可以通过注解的方式实现限流，整个过程变得非常简单。</p>
<p>它背后也是 “行为和数据分离” 的软件设计理念的实际运用。</p>
<h2 data-id="heading-2">我的限流器 Starter 设计思路</h2>
<h3 data-id="heading-3">功能需求</h3>
<p>我的限流器Starter需要支持以下功能：</p>
<ol>
<li><strong>多种限流算法</strong>：令牌桶、漏桶、固定窗口、滑动窗口计数器和滑动窗口日志五种算法</li>
<li><strong>注解驱动</strong>：通过简单的注解就能实现接口限流</li>
<li><strong>Redis存储</strong>：支持分布式环境下的限流一致性</li>
<li><strong>灵活配置</strong>：支持全局配置和局部配置</li>
<li><strong>AOP无侵入</strong>：基于Spring AOP实现，对业务代码无侵入</li>
</ol>
<h3 data-id="heading-4">核心架构</h3>
<p>整个Starter的核心架构如下：</p>
<pre><code class="hljs language-plain" lang="plain">┌─────────────────────────────────────┐
│        RateLimiterAutoConfiguration │
│        ──────────────────────────────│
│        • 配置各种限流算法的Bean      │
│        • 条件化加载                  │
└─────────────────────────────────────┘
                    │
                    ▼
┌─────────────────────────────────────┐
│              限流注解               │
│        ──────────────────────────────│
│        • @FixedWindowRateLimiter    │
│        • @TokenBucketRateLimiter    │
│        • @LeakyBucketRateLimiter    │
└─────────────────────────────────────┘
                    │
                    ▼
┌─────────────────────────────────────┐
│              限流切面               │
│        ──────────────────────────────│
│        • 基于AOP拦截方法调用        │
│        • 实现具体的限流逻辑         │
└─────────────────────────────────────┘
                    │
                    ▼
┌─────────────────────────────────────┐
│              存储层                 │
│        ──────────────────────────────│
│        • Redis存储                  │
│        • Lua脚本保证原子性          │
└─────────────────────────────────────┘
</code></pre>
<h3 data-id="heading-5">关键代码实现</h3>
<h4 data-id="heading-6">1. 自动配置类</h4>
<p>首先，我们需要一个自动配置类，它会在Spring容器启动时自动配置我们的限流器组件：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Configuration</span>
<span class="hljs-meta">@ConditionalOnProperty(prefix = "rate-limiter", name = "enabled", havingValue = "true", matchIfMissing = true)</span>
<span class="hljs-meta">@EnableConfigurationProperties(RateLimiterProperties.class)</span>
<span class="hljs-meta">@ComponentScan(basePackages = "cn.springboot.starter.ratelimiter")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RateLimiterAutoConfiguration</span> {

    <span class="hljs-meta">@Bean</span>
    <span class="hljs-keyword">public</span> FixedWindowCounterScriptFactory <span class="hljs-title function_">fixedWindowCounterScriptFactory</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FixedWindowCounterScriptFactory</span>();
    }

    <span class="hljs-meta">@Bean</span>
    <span class="hljs-keyword">public</span> EnhancedTokenBucketScriptFactory <span class="hljs-title function_">tokenBucketScriptFactory</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">EnhancedTokenBucketScriptFactory</span>();
    }

    <span class="hljs-comment">// ... 其他算法的ScriptFactory</span>
}
</code></pre>
<p>这里有一个关键点需要注意：<code>@ComponentScan(basePackages = "cn.springboot.starter.ratelimiter")</code>注解的作用是让Spring能够扫描到我们Starter中定义的所有组件（包括切面、异常处理器等），这样它们才能被自动注册到Spring容器中。如果没有这个注解，消费端的Spring Boot应用在引入我们的Starter后将无法自动发现和加载这些组件。</p>
<p>这里有几个关键点：</p>
<ul>
<li><code>@ConditionalOnProperty</code>：只有在配置了 <code>rate-limiter.enabled=true</code>时才加载配置</li>
<li><code>@EnableConfigurationProperties</code>：启用配置属性绑定</li>
<li><code>@ComponentScan</code>：扫描限流器相关的组件</li>
<li><code>@ConditionalOnBean(StringRedisTemplate.class)</code>：只有当RedisTemplate存在时才创建Redis相关的组件</li>
</ul>
<h4 data-id="heading-7">2. 配置属性类</h4>
<p>为了让用户能够灵活配置限流参数，我们需要定义配置属性类：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Data</span>
<span class="hljs-meta">@ConfigurationProperties(prefix = "rate-limiter")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RateLimiterProperties</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-variable">enabled</span> <span class="hljs-operator">=</span> <span class="hljs-literal">true</span>;
    <span class="hljs-keyword">private</span> <span class="hljs-type">long</span> <span class="hljs-variable">defaultLimit</span> <span class="hljs-operator">=</span> <span class="hljs-number">10</span>;
    <span class="hljs-keyword">private</span> <span class="hljs-type">long</span> <span class="hljs-variable">defaultWindowSize</span> <span class="hljs-operator">=</span> <span class="hljs-number">60</span>;
    <span class="hljs-keyword">private</span> <span class="hljs-type">String</span> <span class="hljs-variable">defaultMessage</span> <span class="hljs-operator">=</span> <span class="hljs-string">"请求过于频繁，请稍后再试"</span>;
    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> <span class="hljs-variable">maxKeyLength</span> <span class="hljs-operator">=</span> <span class="hljs-number">255</span>;
}
</code></pre>
<p>这样用户就可以在 <code>application.yml</code>中配置：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">rate-limiter:</span>
  <span class="hljs-attr">enabled:</span> <span class="hljs-literal">true</span>
  <span class="hljs-attr">default-limit:</span> <span class="hljs-number">20</span>
  <span class="hljs-attr">default-window-size:</span> <span class="hljs-number">120</span>
  <span class="hljs-attr">default-message:</span> <span class="hljs-string">"访问频率过高，请稍后再试"</span>
</code></pre>
<h4 data-id="heading-8">3. 限流注解</h4>
<p>为了方便使用，我定义了多个限流注解，每种算法对应一个：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Target(ElementType.METHOD)</span>
<span class="hljs-meta">@Retention(RetentionPolicy.RUNTIME)</span>
<span class="hljs-keyword">public</span> <span class="hljs-meta">@interface</span> FixedWindowRateLimiter {
    String <span class="hljs-title function_">key</span><span class="hljs-params">()</span> <span class="hljs-keyword">default</span> <span class="hljs-string">""</span>;
    <span class="hljs-type">long</span> <span class="hljs-title function_">limit</span><span class="hljs-params">()</span> <span class="hljs-keyword">default</span> <span class="hljs-number">10</span>;
    <span class="hljs-type">long</span> <span class="hljs-title function_">windowSize</span><span class="hljs-params">()</span> <span class="hljs-keyword">default</span> <span class="hljs-number">60</span>;
    <span class="hljs-type">int</span> <span class="hljs-title function_">permits</span><span class="hljs-params">()</span> <span class="hljs-keyword">default</span> <span class="hljs-number">1</span>;
    String <span class="hljs-title function_">message</span><span class="hljs-params">()</span> <span class="hljs-keyword">default</span> <span class="hljs-string">"请求过于频繁，请稍后再试"</span>;
}
</code></pre>
<h4 data-id="heading-9">4. AOP切面</h4>
<p>这是实现限流逻辑的核心部分，通过AOP拦截带有限流注解的方法：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Aspect</span>
<span class="hljs-meta">@Component</span>
<span class="hljs-meta">@Slf4j</span>
<span class="hljs-meta">@ConditionalOnProperty(name = "rate-limiter.enabled", havingValue = "true", matchIfMissing = true)</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">FixedWindowRateLimiterAspect</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AbstractRateLimiterAspect</span> {
  
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> RedisScript&lt;Long&gt; fixedWindowScript;

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">FixedWindowRateLimiterAspect</span><span class="hljs-params">(<span class="hljs-meta">@Autowired(required = false)</span> StringRedisTemplate redisTemplate,
                                        RateLimiterProperties properties,
                                        <span class="hljs-meta">@Autowired(required = false)</span> FixedWindowCounterScriptFactory scriptFactory)</span> {
        <span class="hljs-built_in">super</span>(redisTemplate, properties, <span class="hljs-literal">null</span>);
        <span class="hljs-built_in">this</span>.fixedWindowScript = scriptFactory != <span class="hljs-literal">null</span> ? scriptFactory.createRateLimitScript() : <span class="hljs-literal">null</span>;
    }

    <span class="hljs-meta">@Around("@annotation(rateLimiter)")</span>
    <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">around</span><span class="hljs-params">(ProceedingJoinPoint point, FixedWindowRateLimiter rateLimiter)</span> <span class="hljs-keyword">throws</span> Throwable {
        <span class="hljs-type">Method</span> <span class="hljs-variable">method</span> <span class="hljs-operator">=</span> getMethod(point);
        <span class="hljs-type">String</span> <span class="hljs-variable">key</span> <span class="hljs-operator">=</span> generateKey(method, point.getArgs(), rateLimiter.key());

        <span class="hljs-type">long</span> <span class="hljs-variable">startTime</span> <span class="hljs-operator">=</span> System.nanoTime();
        <span class="hljs-type">boolean</span> <span class="hljs-variable">allowed</span> <span class="hljs-operator">=</span> checkFixedWindowRateLimit(key, rateLimiter);
        <span class="hljs-type">long</span> <span class="hljs-variable">executionTime</span> <span class="hljs-operator">=</span> System.nanoTime() - startTime;

        <span class="hljs-keyword">if</span> (!allowed) {
            log.warn(<span class="hljs-string">"固定窗口限流超出配额，键值: {}"</span>, key);
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RateLimitException</span>(rateLimiter.message());
        }

        <span class="hljs-keyword">return</span> point.proceed();
    }

    <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">checkFixedWindowRateLimit</span><span class="hljs-params">(String key, FixedWindowRateLimiter rateLimiter)</span> {
        <span class="hljs-keyword">if</span> (!checkRedisAndScriptAvailability(key, fixedWindowScript)) {
            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
        }

        <span class="hljs-type">RedisRateLimitStorage</span> <span class="hljs-variable">fixedWindowRedisStorage</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RedisRateLimitStorage</span>(redisTemplate, fixedWindowScript);
        <span class="hljs-keyword">return</span> fixedWindowRedisStorage.isAllowed(key, rateLimiter.limit(), rateLimiter.windowSize(), rateLimiter.<span class="hljs-keyword">permits</span>());
    }
}
</code></pre>
<h4 data-id="heading-10">5. Redis 存储与 Lua 脚本</h4>
<p>为了保证限流操作的原子性，我使用了Redis的Lua脚本来实现各种限流算法。以令牌桶算法为例：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">getTokenBucketScript</span><span class="hljs-params">()</span> {
    <span class="hljs-keyword">return</span> <span class="hljs-string">"""
        -- 令牌桶限流脚本
        -- KEYS[1] = 限流器的键
        -- ARGV[1] = 桶容量（最大令牌数）
        -- ARGV[2] = 填充速率（每秒令牌数）
        -- ARGV[3] = 需要获取的许可数

        local key = KEYS[1]
        local capacity = tonumber(ARGV[1])
        local refill_rate = tonumber(ARGV[2])  -- 每秒令牌数
        local permits = tonumber(ARGV[3])

        -- 从Redis获取当前桶状态（令牌数，上次填充时间）
        local bucket_state = redis.call('HMGET', key, 'tokens', 'last_refill_time')

        local current_tokens, last_refill_time

        if bucket_state[1] and bucket_state[2] then
            current_tokens = tonumber(bucket_state[1])
            last_refill_time = tonumber(bucket_state[2])
        else
            -- 如果桶不存在则初始化
            current_tokens = capacity
            last_refill_time = tonumber(redis.call('TIME')[1])
            redis.call('HMSET', key, 'tokens', current_tokens, 'last_refill_time', last_refill_time)
        end

        -- 获取当前时间
        local current_time = tonumber(redis.call('TIME')[1])

        -- 根据经过的时间计算要添加的令牌数
        local time_elapsed = current_time - last_refill_time
        local tokens_to_add = math.floor(time_elapsed * refill_rate)

        -- 更新令牌数，但不超过容量
        local new_tokens = math.min(capacity, current_tokens + tokens_to_add)

        -- 检查是否有足够的令牌用于请求
        if new_tokens &gt;= permits then
            -- 扣除令牌并更新上次填充时间
            redis.call('HMSET', key, 'tokens', new_tokens - permits, 'last_refill_time', current_time)
            return 1  -- 请求允许
        else
            -- 即使请求被拒绝也要更新上次填充时间（防止滥用）
            redis.call('HMSET', key, 'tokens', new_tokens, 'last_refill_time', current_time)
            return 0  -- 请求拒绝
        end
        """</span>;
}
</code></pre>
<h2 data-id="heading-11">实现限流器 Spring Boot Starter</h2>
<h3 data-id="heading-12">1. 项目结构</h3>
<p>Spring Boot Starter的项目结构如下：</p>
<pre><code class="hljs language-plain" lang="plain">src/
├── main/
│   ├── java/
│   │   └── cn/springboot/starter/ratelimiter/
│   │       ├── config/           # 配置相关类
│   │       ├── core/             # 核心功能类
│   │       │   ├── exception/    # 异常处理
│   │       │   ├── metrics/      # 指标监控（预留目录，目前为空）
│   │       │   └── storage/      # 存储相关（含Redis和Lua脚本）
│   │       │       └── script/   # Lua脚本实现
│   │       └── demo/             # 示例代码
│   └── resources/
│       └── META-INF/
│           └── additional-spring-configuration-metadata.json  # 配置元数据（手动补充的描述信息）
└── target/classes/META-INF/  # 编译后生成
    ├── spring-configuration-metadata.json  # 自动生成的配置元数据
    └── additional-spring-configuration-metadata.json  # 手动补充的配置元数据
└── test/
</code></pre>
<p>其中，core包是整个限流器的核心，包含了：</p>
<ul>
<li><strong>exception</strong>：限流相关的异常定义</li>
<li><strong>metrics</strong>：性能指标收集（预留目录，目前为空）</li>
<li><strong>storage</strong>：存储层实现，包含Redis存储和Lua脚本</li>
<li><strong>storage/script</strong>：各种限流算法的Lua脚本实现</li>
<li>*<strong>Aspect</strong>：各个限流算法对应的AOP切面（如FixedWindowRateLimiterAspect等，位于core根目录）</li>
<li>*<strong>RateLimiter</strong>：各个限流算法对应的注解（如FixedWindowRateLimiter等，位于core根目录）</li>
</ul>
<h3 data-id="heading-13">2. 关键配置文件</h3>
<h4 data-id="heading-14">配置元数据文件</h4>
<p>Spring Boot提供了配置元数据功能，可以让IDE提供配置提示。配置元数据文件的工作机制如下：</p>
<ol>
<li><strong>自动元数据生成</strong>：<code>spring-boot-configuration-processor</code>在编译时自动扫描 <code>@ConfigurationProperties</code>注解的类，生成 <code>spring-configuration-metadata.json</code>文件，包含基本的配置属性信息，会自动将属性的注释信息作为元数据的 description。</li>
<li><strong>手动补充元数据</strong>：在 <code>src/main/resources/META-INF/additional-spring-configuration-metadata.json</code>中可以手动编写补充文件，添加更详细的描述信息，或补充处理器无法自动生成的配置属性，这个是可选的。</li>
<li><strong>元数据合并</strong>：编译时，手动编写的 <code>additional-spring-configuration-metadata.json</code>文件会与自动生成的元数据合并，最终形成完整的配置元数据。</li>
</ol>
<p><code>additional-spring-configuration-metadata.json</code>元数据文件：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"groups"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
    <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"rate-limiter"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"cn.springboot.starter.ratelimiter.config.RateLimiterProperties"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"sourceType"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"cn.springboot.starter.ratelimiter.config.RateLimiterProperties"</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"properties"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
    <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"rate-limiter.enabled"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"java.lang.Boolean"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"description"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"是否启用限流"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"defaultValue"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span>
    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"rate-limiter.default-limit"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"java.lang.Long"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"description"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"默认限制次数"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"defaultValue"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">10</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">]</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h4 data-id="heading-15">注册自动配置类</h4>
<p>Spring Boot 3.x，在 <code>META-INF/spring/org.springframework.boot.autoconfigure.AutoConfiguration.imports</code>文件写入：</p>
<pre><code class="hljs language-plain" lang="plain">cn.springboot.starter.ratelimiter.config.RateLimiterAutoConfiguration
</code></pre>
<p>Spring Boot 2.7及以前版本，在 <code>META-INF/spring.factories</code>文件中注册自动配置类：</p>
<pre><code class="hljs language-properties" lang="properties">org.springframework.boot.autoconfigure.AutoConfiguration.imports=\
cn.springboot.starter.ratelimiter.config.RateLimiterAutoConfiguration
</code></pre>
<h3 data-id="heading-16">3. 依赖管理</h3>
<p>在 <code>pom.xml</code>中，我们需要合理管理依赖：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-data-redis<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-aop<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-configuration-processor<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">optional</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">optional</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span>

</code></pre>
<p>注意将 <code>spring-boot-configuration-processor</code>设置为 <code>optional=true</code>，这样它不会传递给使用Starter的项目。</p>
<h2 data-id="heading-17">发布到 Maven Central</h2>
<p>发布到Maven Central是一个相对复杂的过程，需要遵循严格的规范。以下是我在实践中总结的完整流程：</p>
<h3 data-id="heading-18">1. 准备工作</h3>
<h4 data-id="heading-19">注册Sonatype账号</h4>
<p>首先需要在<a href="https://link.juejin.cn?target=https%3A%2F%2Fcentral.sonatype.com%2F" target="_blank" title="https://central.sonatype.com/" ref="nofollow noopener noreferrer">Sonatype Central Portal</a>注册账号，这是发布到Maven Central的入口。</p>
<h4 data-id="heading-20">申请Namespace权限</h4>
<p>登录后需要申请命名空间权限。我申请的是 <code>io.github.yuanshenjian-cn</code>，这通常对应你的GitHub用户名或组织名。申请时需要提供项目URL和SCM URL。</p>
<p><strong>重要提醒</strong>：这里的命名空间名称需要与你在项目pom.xml中配置的groupId保持一致，因为Sonatype会验证你是否有权在这个命名空间下发布构件。</p>
<h3 data-id="heading-21">2. GPG签名设置</h3>
<p>发布到 Maven Central 必须使用 GPG签名来保证构件的完整性和真实性。</p>
<h4 data-id="heading-22">安装GPG</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># macOS</span>
brew install gpg

<span class="hljs-comment"># Ubuntu/Debian</span>
sudo apt-get install gnupg
</code></pre>
<h4 data-id="heading-23">生成GPG密钥对</h4>
<pre><code class="hljs language-bash" lang="bash">gpg --gen-key
</code></pre>
<p>按照提示填写信息，建议设置一个强密码。</p>
<h4 data-id="heading-24">上传公钥到密钥服务器</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 推荐使用 keys.openpgp.org</span>
gpg --keyserver keys.openpgp.org --send-keys YOUR_KEY_ID

<span class="hljs-comment"># 备用服务器</span>
gpg --keyserver keyserver.ubuntu.com --send-keys YOUR_KEY_ID
gpg --keyserver pgp.mit.edu --send-keys YOUR_KEY_ID
</code></pre>
<h3 data-id="heading-25">3. Maven配置</h3>
<p>在 <code>~/.m2/settings.xml</code>中配置Sonatype认证信息：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">settings</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">servers</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">server</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">id</span>&gt;</span>central<span class="hljs-tag">&lt;/<span class="hljs-name">id</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">username</span>&gt;</span>YOUR_SONATYPE_USERNAME<span class="hljs-tag">&lt;/<span class="hljs-name">username</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">password</span>&gt;</span>YOUR_SONATYPE_PASSWORD<span class="hljs-tag">&lt;/<span class="hljs-name">password</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">server</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">servers</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">settings</span>&gt;</span>
</code></pre>
<p>注意：Sonatype现在使用User Token进行认证，需要在Central Portal中生成用户令牌。</p>
<h3 data-id="heading-26">4. 项目POM配置</h3>
<p>在项目的 <code>pom.xml</code>中添加必要的插件和配置：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">build</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">plugins</span>&gt;</span>
        <span class="hljs-comment">&lt;!-- 编译插件 --&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">plugin</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>maven-compiler-plugin<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.11.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">configuration</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">source</span>&gt;</span>17<span class="hljs-tag">&lt;/<span class="hljs-name">source</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">target</span>&gt;</span>17<span class="hljs-tag">&lt;/<span class="hljs-name">target</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">encoding</span>&gt;</span>UTF-8<span class="hljs-tag">&lt;/<span class="hljs-name">encoding</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">configuration</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">plugin</span>&gt;</span>
        <span class="hljs-comment">&lt;!-- 源码插件 --&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">plugin</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>maven-source-plugin<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.3.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">executions</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">execution</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">id</span>&gt;</span>attach-sources<span class="hljs-tag">&lt;/<span class="hljs-name">id</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">goals</span>&gt;</span>
                        <span class="hljs-tag">&lt;<span class="hljs-name">goal</span>&gt;</span>jar-no-fork<span class="hljs-tag">&lt;/<span class="hljs-name">goal</span>&gt;</span>
                    <span class="hljs-tag">&lt;/<span class="hljs-name">goals</span>&gt;</span>
                <span class="hljs-tag">&lt;/<span class="hljs-name">execution</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">executions</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">plugin</span>&gt;</span>
        <span class="hljs-comment">&lt;!-- JavaDoc插件 --&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">plugin</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>maven-javadoc-plugin<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.6.3<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">executions</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">execution</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">id</span>&gt;</span>attach-javadocs<span class="hljs-tag">&lt;/<span class="hljs-name">id</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">goals</span>&gt;</span>
                        <span class="hljs-tag">&lt;<span class="hljs-name">goal</span>&gt;</span>jar<span class="hljs-tag">&lt;/<span class="hljs-name">goal</span>&gt;</span>
                    <span class="hljs-tag">&lt;/<span class="hljs-name">goals</span>&gt;</span>
                <span class="hljs-tag">&lt;/<span class="hljs-name">execution</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">executions</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">plugin</span>&gt;</span>
        <span class="hljs-comment">&lt;!-- GPG签名插件 --&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">plugin</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>maven-gpg-plugin<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.2.4<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">executions</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">execution</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">id</span>&gt;</span>sign-artifacts<span class="hljs-tag">&lt;/<span class="hljs-name">id</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">phase</span>&gt;</span>verify<span class="hljs-tag">&lt;/<span class="hljs-name">phase</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">goals</span>&gt;</span>
                        <span class="hljs-tag">&lt;<span class="hljs-name">goal</span>&gt;</span>sign<span class="hljs-tag">&lt;/<span class="hljs-name">goal</span>&gt;</span>
                    <span class="hljs-tag">&lt;/<span class="hljs-name">goals</span>&gt;</span>
                <span class="hljs-tag">&lt;/<span class="hljs-name">execution</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">executions</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">plugin</span>&gt;</span>
        <span class="hljs-comment">&lt;!-- Central Publishing插件 --&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">plugin</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.sonatype.central<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>central-publishing-maven-plugin<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>0.9.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">extensions</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">extensions</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">configuration</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">publishingServerId</span>&gt;</span>central<span class="hljs-tag">&lt;/<span class="hljs-name">publishingServerId</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">configuration</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">plugin</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">plugins</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">build</span>&gt;</span>
<span class="hljs-comment">&lt;!-- 发布管理 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">distributionManagement</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">snapshotRepository</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">id</span>&gt;</span>central<span class="hljs-tag">&lt;/<span class="hljs-name">id</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">url</span>&gt;</span>https://central.sonatype.com/content/repositories/snapshots<span class="hljs-tag">&lt;/<span class="hljs-name">url</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">snapshotRepository</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">repository</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">id</span>&gt;</span>central<span class="hljs-tag">&lt;/<span class="hljs-name">id</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">url</span>&gt;</span>https://central.sonatype.com/service/local/staging/deploy/maven2/<span class="hljs-tag">&lt;/<span class="hljs-name">url</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">repository</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">distributionManagement</span>&gt;</span>

</code></pre>
<h3 data-id="heading-27">5. 发布流程</h3>
<h4 data-id="heading-28">验证构建</h4>
<pre><code class="hljs language-bash" lang="bash">./mvnw clean verify
</code></pre>
<p>确保所有测试通过，且生成了必需的构件（JAR、Sources、Javadoc）。</p>
<h4 data-id="heading-29">执行发布</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">export</span> GPG_TTY=$(<span class="hljs-built_in">tty</span>)
./mvnw clean deploy -DskipTests
</code></pre>
<p>注意设置 <code>GPG_TTY</code>环境变量，这可以解决在某些终端环境下GPG无法获取密码的问题。</p>
<h3 data-id="heading-30">6. 在Central Portal中确认发布</h3>
<p>发布完成后，登录Sonatype Central Portal，在"Upload" -&gt; "Components"页面找到刚上传的组件，点击"Publish"按钮完成发布。</p>
<h2 data-id="heading-31">发布过程中的踩坑经验</h2>
<h3 data-id="heading-32">1. GPG签名问题</h3>
<p>最常见的问题是GPG签名失败。我遇到过以下几种情况：</p>
<ul>
<li><strong>"gpg: signing failed: Inappropriate ioctl for device"</strong>：这是最常见的一种错误，解决方案是设置 <code>GPG_TTY=$(tty)</code></li>
<li><strong>"Invalid signature"</strong>：通常是因为公钥没有正确上传到PGP服务器，需要等待服务器同步</li>
<li><strong>GPG agent问题</strong>：有时GPG agent没有正确运行，需要重启</li>
</ul>
<h3 data-id="heading-33">2. 构件验证失败</h3>
<p>Maven Central对发布的构件有严格的要求：</p>
<ul>
<li>必须包含sources和javadoc</li>
<li>所有构件都必须签名</li>
<li>POM文件必须包含完整的元数据（许可证、开发者信息、SCM信息等）</li>
<li>JavaDoc不能有警告</li>
</ul>
<h3 data-id="heading-34">3. 版本管理</h3>
<ul>
<li>一旦发布到 Maven Central，无法删除或修改已发布的版本</li>
<li>确保版本号唯一且有意义</li>
<li>发布正式版本时，不要使用 <code>-SNAPSHOT</code>后缀</li>
</ul>
<h2 data-id="heading-35">消费端如何使用</h2>
<p>发布成功后，用户就可以通过简单的依赖引入来使用我们的限流器：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>io.github.yuanshenjian-cn<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>api-rate-limiter-spring-boot-starter<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.0.7<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>

</code></pre>
<p>然后在代码中使用：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@RestController</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ApiController</span> {

    <span class="hljs-comment">// 使用令牌桶算法</span>
    <span class="hljs-meta">@TokenBucketRateLimiter(
        key = "'api:user:' + #id",         // 限流键，支持 SpEL 表达式
        capacity = 5,                      // 桶容量
        refillRate = 1,                    // 每秒填充1个令牌
        message = "访问频率过高，请稍后再试"
    )</span>
    <span class="hljs-meta">@GetMapping("/api/user/{id}")</span>
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getUser</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable</span> String id)</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-string">"User: "</span> + id;
    }

    <span class="hljs-comment">// 使用固定窗口算法</span>
    <span class="hljs-meta">@FixedWindowRateLimiter(
        key = "'api:order:' + #orderId",   // 限流键
        limit = 10,                        // 限制次数
        windowSize = 60,                   // 时间窗口（秒）
        message = "访问频率过高，请稍后再试"
    )</span>
    <span class="hljs-meta">@PostMapping("/api/order/{orderId}")</span>
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">createOrder</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable</span> String orderId)</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-string">"Order created: "</span> + orderId;
    }

    <span class="hljs-comment">// 使用漏桶算法</span>
    <span class="hljs-meta">@LeakyBucketRateLimiter(
        key = "'api:upload:' + #userId",   // 限流键
        capacity = 5,                      // 桶容量
        leakRate = 2,                      // 每秒处理2个请求
        message = "访问频率过高，请稍后再试"
    )</span>
    <span class="hljs-meta">@PostMapping("/api/upload")</span>
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">uploadFile</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-string">"File uploaded successfully"</span>;
    }
}
</code></pre>
<h2 data-id="heading-36">总结</h2>
<p>这次跟 Qwen Pair 开发并发布一个 Spring Boot Starter 是一个很好的学习过程，让我深入了解了 Spring Boot 的自动配置机制、AOP编程、Redis应用以及Maven发布流程。</p>
<p>这个项目从构思到发布，经历了需求分析、架构设计、编码实现、测试验证、发布上线等多个阶段。每一个环节都有值得学习的地方，特别是发布到Maven Central的过程，让我对开源软件的发布标准有了更深的认识。</p>
<p>希望这篇分享对你有所帮助，如果有什么问题，欢迎在评论区交流讨论。</p>
<p>本文涉及的完整项目源码可以在GitHub上找到：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fyuanshenjian-cn%2Fspring-boot-starter-api-rate-limiter" target="_blank" title="https://github.com/yuanshenjian-cn/spring-boot-starter-api-rate-limiter" ref="nofollow noopener noreferrer">github.com/yuanshenjia…</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[为什么 Redis 的 Pipeline 不是原子的，而 Lua 脚本却是？——从事件循环讲透原子性本质]]></title>    <link>https://juejin.cn/post/7594576956420636698</link>    <guid>https://juejin.cn/post/7594576956420636698</guid>    <pubDate>2026-01-13T07:21:43.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7594576956420636698" data-draft-id="7594616268781355035" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="为什么 Redis 的 Pipeline 不是原子的，而 Lua 脚本却是？——从事件循环讲透原子性本质"/> <meta itemprop="keywords" content="Redis"/> <meta itemprop="datePublished" content="2026-01-13T07:21:43.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="小飞Coding"/> <meta itemprop="url" content="https://juejin.cn/user/954816145155181"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            为什么 Redis 的 Pipeline 不是原子的，而 Lua 脚本却是？——从事件循环讲透原子性本质
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/954816145155181/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    小飞Coding
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-13T07:21:43.000Z" title="Tue Jan 13 2026 07:21:43 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p><strong>Pipeline 批量发命令，Lua 脚本也能批量操作，但只有 Lua 是原子的。<br/>
为什么？答案藏在 Redis 的单线程心脏里。</strong></p>
</blockquote>
<p>在使用 Redis 时，你可能遇到过这样的困惑：</p>
<ul>
<li>我用 <code>Pipeline</code> 一口气发了 100 个命令，效率很高；</li>
<li>但我听说 <code>Pipeline</code> <strong>不是原子的</strong>，中间可能被其他客户端插队；</li>
<li>而写个 Lua 脚本，哪怕包含 10 条 Redis 命令，却能保证<strong>完全原子执行</strong>。</li>
</ul>
<p>这到底是为什么？难道 Redis 对 Lua 有“特殊照顾”？</p>
<p>今天，我们就从 <strong>Redis 内部执行模型</strong> 出发，彻底讲清楚：<strong>Pipeline 和 Lua 脚本在 Redis 眼中，根本就不是一类东西</strong>。</p>
<hr/>
<h2 data-id="heading-0">一、Pipeline：只是“网络打包”，不是“执行合并”</h2>
<p>很多人误以为 Pipeline 是一种“批量命令”，其实它<strong>根本不是 Redis 的功能</strong>，而是<strong>客户端的优化技巧</strong>。</p>
<h3 data-id="heading-1">客户端视角：</h3>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">// 普通方式：3 次网络往返</span>
redis.<span class="hljs-keyword">set</span>(<span class="hljs-string">"a"</span>, <span class="hljs-string">"1"</span>);
redis.<span class="hljs-keyword">set</span>(<span class="hljs-string">"b"</span>, <span class="hljs-string">"2"</span>);
redis.<span class="hljs-keyword">set</span>(<span class="hljs-string">"c"</span>, <span class="hljs-string">"3"</span>);

<span class="hljs-comment">// Pipeline：1 次网络往返</span>
pipeline.<span class="hljs-keyword">set</span>(<span class="hljs-string">"a"</span>, <span class="hljs-string">"1"</span>);
pipeline.<span class="hljs-keyword">set</span>(<span class="hljs-string">"b"</span>, <span class="hljs-string">"2"</span>);
pipeline.<span class="hljs-keyword">set</span>(<span class="hljs-string">"c"</span>, <span class="hljs-string">"3"</span>);
pipeline.<span class="hljs-keyword">sync</span>();
</code></pre>
<p>看起来很高效，对吧？但关键在于：<strong>Redis 并不知道你在用 Pipeline</strong>。</p>
<h3 data-id="heading-2">Redis 服务端视角：</h3>
<p>当 Redis 收到 TCP 流中的数据：</p>
<pre><code class="hljs language-css" lang="css">SET <span class="hljs-selector-tag">a</span> <span class="hljs-number">1</span>\r\nSET <span class="hljs-selector-tag">b</span> <span class="hljs-number">2</span>\r\nSET c <span class="hljs-number">3</span>\r\n
</code></pre>
<p>它会<strong>逐行解析</strong>，然后依次执行三个独立的 <code>SET</code> 命令。</p>
<p>也就是说，在 Redis 内部，这三个命令和你分开三次发送<strong>没有任何区别</strong>——它们会被<strong>一个一个放进命令队列，再一个一个执行</strong>。</p>
<h3 data-id="heading-3">问题来了：命令之间会发生什么？</h3>
<p>Redis 的主循环大致如下（简化版）：</p>
<pre><code class="hljs language-scss" lang="scss">while (<span class="hljs-number">1</span>) {
    <span class="hljs-comment">// 1. 处理网络 I/O（读取所有客户端数据）</span>
    <span class="hljs-built_in">aeProcessEvents</span>();

    <span class="hljs-comment">// 2. 执行命令队列中的命令</span>
    while (hasCommand()) {
        <span class="hljs-built_in">executeCommand</span>(dequeueCommand());
        <span class="hljs-comment">// ← 执行完一条命令后，回到循环顶部！</span>
    }
}
</code></pre>
<p>注意：<strong>每执行完一条命令，Redis 就会回到事件循环顶部</strong>，去处理：</p>
<ul>
<li>其他客户端的新请求；</li>
<li>定时任务（如 key 过期）；</li>
<li>主从同步等。</li>
</ul>
<p>所以，你的 <code>SET a 1</code> 和 <code>SET b 2</code> 之间，完全可能插入别人发来的 <code>DEL x</code>！</p>
<blockquote>
<p>✅ <strong>Pipeline 只省了网络 RTT，没改变命令的执行语义。</strong></p>
</blockquote>
<hr/>
<h2 data-id="heading-4">二、Lua 脚本：Redis 的“独占模式”</h2>
<p>相比之下，Lua 脚本在 Redis 中享有“VIP 待遇”。</p>
<p>当你执行：</p>
<pre><code class="hljs language-less" lang="less"><span class="hljs-selector-tag">EVAL</span> "<span class="hljs-selector-tag">redis</span><span class="hljs-selector-class">.call</span>(<span class="hljs-string">'SET'</span>, KEYS[<span class="hljs-number">1</span>], <span class="hljs-string">'1'</span>); <span class="hljs-selector-tag">redis</span><span class="hljs-selector-class">.call</span>(<span class="hljs-string">'SET'</span>, KEYS[<span class="hljs-number">2</span>], <span class="hljs-string">'2'</span>)" <span class="hljs-number">2</span> <span class="hljs-selector-tag">a</span> <span class="hljs-selector-tag">b</span>
</code></pre>
<p>Redis 不会把它拆成两个 <code>SET</code> 命令。而是：</p>
<ol>
<li><strong>整个脚本被视为一个不可分割的单元</strong>；</li>
<li><strong>执行期间，Redis 会暂停处理任何新命令</strong>；</li>
<li>脚本内部的所有 <code>redis.call()</code> 都在当前上下文中直接执行，<strong>不经过命令队列</strong>。</li>
</ol>
<h3 data-id="heading-5">技术实现：<code>lua_caller</code> 标志位</h3>
<p>在 Redis 源码中，有一个关键变量：</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-keyword">struct</span> <span class="hljs-title class_">redisServer</span> {
    client *lua_caller;  <span class="hljs-comment">// 当前正在执行 Lua 脚本的客户端</span>
};
</code></pre>
<p>在事件循环的关键位置（如 <code>beforeSleep</code>、<code>processCommand</code>），Redis 会检查：</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-keyword">if</span> (server.lua_caller != <span class="hljs-literal">NULL</span>) {
    <span class="hljs-comment">// 正在执行 Lua 脚本，跳过处理新命令！</span>
    <span class="hljs-keyword">return</span>;
}
</code></pre>
<p>这意味着：<strong>只要 Lua 脚本没跑完，其他客户端的命令一律排队等待</strong>。</p>
<blockquote>
<p>✅ <strong>Lua 脚本 = 占用 Redis 主线程的“临界区”</strong></p>
</blockquote>
<hr/>
<h2 data-id="heading-6">三、一张图看懂本质区别</h2>
<pre><code class="hljs language-css" lang="css">普通命令 / Pipeline 命令：
<span class="hljs-selector-attr">[SET a 1]</span> → 执行 → 回到事件循环 → <span class="hljs-selector-attr">[其他客户端命令]</span> → <span class="hljs-selector-attr">[SET b 2]</span> → 执行

Lua 脚本：
<span class="hljs-selector-attr">[Lua 开始]</span> → 执行 SET <span class="hljs-selector-tag">a</span> <span class="hljs-number">1</span> → 执行 SET <span class="hljs-selector-tag">b</span> <span class="hljs-number">2</span> → <span class="hljs-selector-attr">[Lua 结束]</span> → 其他命令才能进来
</code></pre>
<p>Pipeline 的命令是“散装”的，Lua 脚本是“封装好的原子包”。</p>
<hr/>
<h2 data-id="heading-7">四、常见误区澄清</h2>





















<table><thead><tr><th>误区</th><th>正解</th></tr></thead><tbody><tr><td>“Pipeline 是事务”</td><td>❌ Pipeline 没有任何事务语义，只是网络优化</td></tr><tr><td>“Lua 脚本快是因为本地执行”</td><td>❌ Lua 在 Redis 服务端执行，快是因为原子+无网络开销</td></tr><tr><td>“Cluster 下 Pipeline 也能跨节点原子”</td><td>❌ Cluster 下 Pipeline 必须同 slot，且仍非原子</td></tr></tbody></table>
<hr/>
<h2 data-id="heading-8">五、如何选择？</h2>





















<table><thead><tr><th>场景</th><th>推荐方案</th></tr></thead><tbody><tr><td>需要<strong>原子性</strong>（如扣款、限流）</td><td>✅ Lua 脚本</td></tr><tr><td>只需<strong>提升吞吐</strong>（如批量导入）</td><td>✅ Pipeline</td></tr><tr><td>简单批量读写（同 key）</td><td>✅ <code>MGET</code> / <code>MSET</code>（内置原子命令）</td></tr></tbody></table>
<blockquote>
<p>💡 <strong>记住：<br/>
要速度 → Pipeline；<br/>
要一致 → Lua。</strong></p>
</blockquote>
<hr/>
<h2 data-id="heading-9">结语</h2>
<p>Redis 的简洁之美，正体现在它的<strong>单线程模型</strong>上。<br/>
Pipeline 和 Lua 脚本看似都能“批量操作”，但一个只是<strong>网络层的巧思</strong>，另一个则是<strong>执行层的保障</strong>。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[gorm回读机制溯源]]></title>    <link>https://juejin.cn/post/7594396368175349795</link>    <guid>https://juejin.cn/post/7594396368175349795</guid>    <pubDate>2026-01-13T07:53:30.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7594396368175349795" data-draft-id="7594396523441242147" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="gorm回读机制溯源"/> <meta itemprop="keywords" content="后端,面试,GitHub"/> <meta itemprop="datePublished" content="2026-01-13T07:53:30.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="37手游后端团队"/> <meta itemprop="url" content="https://juejin.cn/user/1548527766871239"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            gorm回读机制溯源
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1548527766871239/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    37手游后端团队
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-13T07:53:30.000Z" title="Tue Jan 13 2026 07:53:30 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    8
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一、背景</h2>
<p>近期在开发过程中，发现一个奇怪现象：go程序使用gorm进行insert操作，日志却出现了一行insert以及一行select，一度让我怀疑是代码Bug。经过仔细排查，排除了程序主动select逻辑，确认只有insert的操作，因此展开对此现象的分析。</p>
<h2 data-id="heading-1">二、分析过程</h2>
<p>1、现场还原</p>
<p>本次案例中，将日志现场经简化、脱敏如下：</p>
<pre><code class="hljs language-scss" lang="scss">(C:/www/project-name/internal/dao/dao_impls/dao_test/test.go:<span class="hljs-number">23</span>)
<span class="hljs-selector-attr">[2025-12-11 18:30:33]</span>  <span class="hljs-selector-attr">[5.54ms]</span>  INSERT INTO `test` (`gid`,`atime`) VALUES (<span class="hljs-number">1000001</span>,<span class="hljs-number">1765449029</span>)
<span class="hljs-selector-attr">[1 rows affected or returned ]</span>
 
(C:/www/project-name/internal/dao/dao_impls/dao_test/test.go:<span class="hljs-number">23</span>)
<span class="hljs-selector-attr">[2025-12-11 18:30:33]</span>  <span class="hljs-selector-attr">[13.33ms]</span>  SELECT `score` FROM `test`  WHERE (id = <span class="hljs-number">5</span>)
<span class="hljs-selector-attr">[1 rows affected or returned ]</span>


</code></pre>
<p>日志中第二行，SELECT <code>score</code> FROM <code>test</code>  WHERE (id = 5)，便是预期外的select。</p>
<p>将表结构的struct简化后如下：</p>
<pre><code class="hljs language-sql" lang="sql">type Test struct {
    ID int64 `gorm:"column:id;PRIMARY_KEY;AUTO_INCREMENT;TYPE:bigint(20);NOT NULL" json:"id"`,
    Gid <span class="hljs-type">int</span> `gorm:"column:gid;TYPE:int(11);NOT NULL" <span class="hljs-keyword">sql</span>:"DEFAULT:0" json:"gid"`,
    Score int64 `gorm:"column:score;TYPE:int(11);NOT NULL" <span class="hljs-keyword">sql</span>:"DEFAULT:0" json:"score"`,
    Atime <span class="hljs-type">int</span> `gorm:"column:atime;TYPE:int(11);NOT NULL" <span class="hljs-keyword">sql</span>:"DEFAULT:0" json:"atime"`
}

</code></pre>
<p>2、gorm源码定位</p>
<p>阅读gorm源码后定位到，此现象是gorm的回读操作（gorm版本是v1.9.14）。</p>
<p>一个create操作包含以下几个过程：</p>
<p>1） Create 方法入口（触发回调链）</p>
<pre><code class="hljs language-go" lang="go">
<span class="hljs-comment">// github.com/jinzhu/gorm/main.go (1.9.14)</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(s *DB)</span></span> Create(value <span class="hljs-keyword">interface</span>{}) *DB {
  <span class="hljs-comment">// 初始化 Scope（GORM v1 核心上下文，包含 SQL、模型、字段等信息）</span>
  scope := s.NewScope(value)
  <span class="hljs-comment">// 执行 Create 回调链（核心：before_create → create → after_create）</span>
  scope.CallCallbacks(s.parent.callbacks.creates)
   
  <span class="hljs-comment">// 处理错误、返回结果</span>
  <span class="hljs-keyword">if</span> scope.HasError() {
    s.db.AddError(scope.DB().Error)
  }
  <span class="hljs-keyword">return</span> s.db
}

</code></pre>
<p>2）Create 回调注册</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// github.com/jinzhu/gorm/callback_create.go (1.9.14)</span>
<span class="hljs-comment">// RegisterCallbacks 注册 Create 相关回调（v1 初始化时执行）</span>
func <span class="hljs-built_in">RegisterCallbacks</span>(db *DB) {
  <span class="hljs-comment">// 注册「插入中」回调：执行 INSERT 语句</span>
  db<span class="hljs-selector-class">.Callback</span>()<span class="hljs-selector-class">.Create</span>()<span class="hljs-selector-class">.Register</span>("gorm:create", create)
  <span class="hljs-comment">// 注册「插入后」回调：触发字段回读（核心）</span>
  db<span class="hljs-selector-class">.Callback</span>()<span class="hljs-selector-class">.Create</span>()<span class="hljs-selector-class">.Register</span>("gorm:after_create", afterCreate)
}
 
<span class="hljs-comment">// afterCreate 是 v1 插入后回读字段的核心回调</span>
func <span class="hljs-built_in">afterCreate</span>(scope *Scope) {
  if scope<span class="hljs-selector-class">.HasError</span>() {
    return
  }
 
  <span class="hljs-comment">// 核心：触发「从数据库回读字段值」的逻辑</span>
  if err := scope.<span class="hljs-built_in">RetrieveDBValues</span>(); err != nil {
    scope<span class="hljs-selector-class">.Err</span>(err)
  }
}



</code></pre>
<p>3）回读字段的核心实现（生成 SELECT 语句）</p>
<pre><code class="hljs language-go" lang="go">

<span class="hljs-comment">// github.com/jinzhu/gorm/scope.go (1.9.14)</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(scope *Scope)</span></span> RetrieveDBValues() <span class="hljs-type">error</span> {
  <span class="hljs-comment">// 1. 筛选需要回读的字段（自增ID、生成列、默认值字段等）</span>
  fields := scope.Fields()
  <span class="hljs-keyword">var</span> retrieveFields []*Field
  <span class="hljs-keyword">for</span> _, field := <span class="hljs-keyword">range</span> fields {
    <span class="hljs-comment">// 判断字段是否需要回读（自增、有默认值、生成列等）</span>
    <span class="hljs-keyword">if</span> field.NeedToRetrieveValue() {
      retrieveFields = <span class="hljs-built_in">append</span>(retrieveFields, field)
    }
  }
 
  <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(retrieveFields) == <span class="hljs-number">0</span> {
    <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span> <span class="hljs-comment">// 无需要回读的字段，直接返回</span>
  }
 
  <span class="hljs-comment">// 2. 拼接需要回读的字段名</span>
  <span class="hljs-keyword">var</span> fieldNames []<span class="hljs-type">string</span>
  <span class="hljs-keyword">for</span> _, field := <span class="hljs-keyword">range</span> retrieveFields {
    fieldNames = <span class="hljs-built_in">append</span>(fieldNames, scope.Quote(field.DBName))
  }
 
  <span class="hljs-comment">// 3. 构建 WHERE 条件（基于主键，如 id = 5）</span>
  primaryField := scope.PrimaryField()
  <span class="hljs-keyword">if</span> primaryField == <span class="hljs-literal">nil</span> {
    <span class="hljs-keyword">return</span> errors.New(<span class="hljs-string">"primary field not found"</span>)
  }
 
  <span class="hljs-comment">// 4. 拼接 SELECT SQL（对应日志中的 SELECT 语句）</span>
  sql := fmt.Sprintf(
    <span class="hljs-string">"SELECT %s FROM %s WHERE %s = %v"</span>,
    strings.Join(fieldNames, <span class="hljs-string">", "</span>),       <span class="hljs-comment">// 回读字段列表</span>
    scope.QuotedTableName(),              <span class="hljs-comment">// 表名</span>
    scope.Quote(primaryField.DBName),     <span class="hljs-comment">// 主键字段 id</span>
    scope.AddToVars(scope.PrimaryKeyValue()), <span class="hljs-comment">// 主键值（如 5）</span>
  )
 
  <span class="hljs-comment">// 5. 执行 SELECT 查询（日志中看到的 SELECT 操作在此执行）</span>
  row := scope.SQLDB().QueryRow(sql, scope.SQLVars()...)
  <span class="hljs-keyword">if</span> row.Err() != <span class="hljs-literal">nil</span> {
    <span class="hljs-keyword">return</span> row.Err()
  }
 
  <span class="hljs-comment">// 6. 将查询结果扫描回模型字段</span>
  dest := <span class="hljs-built_in">make</span>([]<span class="hljs-keyword">interface</span>{}, <span class="hljs-built_in">len</span>(retrieveFields))
  <span class="hljs-keyword">for</span> i, field := <span class="hljs-keyword">range</span> retrieveFields {
    dest[i] = field.Field.Interface()
  }
  <span class="hljs-keyword">return</span> row.Scan(dest...)
}


</code></pre>
<p>整个过程简化成一张流程图就是：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2da9d48119f641d9be4dc1af9d7b9769~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgMzfmiYvmuLjlkI7nq6_lm6LpmJ8=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768895989&amp;x-signature=DHpD2SQHWFZKj%2FMIxNcz%2FTLKx6E%3D" alt="image.png" loading="lazy"/></p>
<p>3、触发回读的条件</p>
<p>在本次案例中，回读产生的原因是字段有数据库默认值（<code>sql:"default:'xxx'"</code>）且插入时未显式赋值。这也是最典型的原因，其实还有另外几种因素也能导致，个人觉得在开发中不太常见，就不枚举了。</p>
<p>4、关闭回读</p>
<p>如果不需要回读，可以通过以下方式关闭：</p>
<pre><code class="hljs language-go" lang="go"> <span class="hljs-comment">// 方式1：全局禁用 after_create 回调（影响所有 Create 操作）</span>
db.Callback().Create().Remove(<span class="hljs-string">"gorm:after_create"</span>)
 
<span class="hljs-comment">// 方式2：单次 Create 跳过回调（仅影响当前操作）</span>
scope := db.NewScope(&amp;rec)
scope.SkipAfterCreate = <span class="hljs-literal">true</span>
db.Create(&amp;rec)
 
<span class="hljs-comment">// 方式3：移除模型中字段的 sql:"DEFAULT:0" 标签（数据库层面的默认值仍生效）</span>
<span class="hljs-keyword">type</span> Test <span class="hljs-keyword">struct</span> {
    Score <span class="hljs-type">int64</span> <span class="hljs-string">`gorm:"column:score;TYPE:int(11);NOT NULL" json:"score"`</span>,
   <span class="hljs-comment">// 其他字段...</span>
}
 
<span class="hljs-comment">// 方式4：使用原生 SQL 插入（绕过 GORM 回调链）</span>
db.Exec(<span class="hljs-string">"INSERT INTO test (...) VALUES (...)"</span>, args...)
 
<span class="hljs-comment">// 方式5：程序代码显式赋值</span>
rec.Score=<span class="hljs-number">0</span>


</code></pre>
<h2 data-id="heading-2">三、回读的影响</h2>
<p>其实一个基于主键的select回读，在大多数时候影响并不大，但是对于高并发的业务场景，任何一个微小的逻辑都可能被放大！</p>
<p>1、最直接影响就是性能损耗，会占用更多数据库连接、消耗IO资源，多一次网络往返。</p>
<p>2、数据不一致。RetrieveDBValues() 方法中，将回读的 SELECT 结果覆盖到模型结构体的内存，多个事务并发场景下可能导致业务读取到脏数据。</p>
<p>3、回读会产生额外的select日志，增加日志体积，且可能干扰问题排查。</p>
<h2 data-id="heading-3">四、结语</h2>
<p>对于go开发者而言，这个案例有几个启示：其一，orm框架的“黑盒操作”背后往往有清晰的设计逻辑，遇到疑难问题时，溯源源码是最直接有效的排查手段；其二，使用框架时不能仅关注上层API调用，还需了解其核心机制（如Gorm的回调链），才能精准规避风险；其三，在高并发等场景下，需格外关注框架的隐式操作，才能把性能压榨机制或者规避不必要的bug。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[剑指offer-63、数据流中的中位数]]></title>    <link>https://juejin.cn/post/7594415509607350318</link>    <guid>https://juejin.cn/post/7594415509607350318</guid>    <pubDate>2026-01-13T06:09:10.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7594415509607350318" data-draft-id="7593607642553368602" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="剑指offer-63、数据流中的中位数"/> <meta itemprop="keywords" content="Java"/> <meta itemprop="datePublished" content="2026-01-13T06:09:10.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="SevenCoding"/> <meta itemprop="url" content="https://juejin.cn/user/3261615728242467"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            剑指offer-63、数据流中的中位数
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3261615728242467/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    SevenCoding
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-13T06:09:10.000Z" title="Tue Jan 13 2026 06:09:10 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">题⽬描述</h2>
<p>如何得到⼀个数据流中的中位数？如果从数据流中读出奇数个数值，那么中位数就是所有数值排序之后位于中间的数值。如果从数据流中读出偶数个数值，那么中位数就是所有数值排序之后中间两个数的平均值。我们使⽤ Insert() ⽅法读取数据流，使⽤ GetMedian() ⽅法获取当前读取数据的中位数。</p>
<h2 data-id="heading-1">思路及解答</h2>
<h3 data-id="heading-2">排序列表法</h3>
<p>维护一个列表，每次获取中位数前进行排序</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> java.util.ArrayList;
<span class="hljs-keyword">import</span> java.util.Collections;
<span class="hljs-keyword">import</span> java.util.List;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MedianFinder1</span> {
    <span class="hljs-keyword">private</span> List&lt;Integer&gt; data;
    
    <span class="hljs-keyword">public</span> <span class="hljs-title function_">MedianFinder1</span><span class="hljs-params">()</span> {
        data = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();
    }
    
    <span class="hljs-comment">// 插入数字到数据流</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">Insert</span><span class="hljs-params">(Integer num)</span> {
        data.add(num);
        <span class="hljs-comment">// 每次插入后排序，保持列表有序</span>
        Collections.sort(data);
    }
    
    <span class="hljs-comment">// 获取当前数据流的中位数</span>
    <span class="hljs-keyword">public</span> Double <span class="hljs-title function_">GetMedian</span><span class="hljs-params">()</span> {
        <span class="hljs-type">int</span> <span class="hljs-variable">size</span> <span class="hljs-operator">=</span> data.size();
        <span class="hljs-keyword">if</span> (size == <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span> <span class="hljs-number">0.0</span>;
        
        <span class="hljs-keyword">if</span> (size % <span class="hljs-number">2</span> == <span class="hljs-number">1</span>) {
            <span class="hljs-comment">// 奇数个元素，返回中间值</span>
            <span class="hljs-keyword">return</span> (<span class="hljs-type">double</span>) data.get(size / <span class="hljs-number">2</span>);
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-comment">// 偶数个元素，返回中间两个数的平均值</span>
            <span class="hljs-type">int</span> <span class="hljs-variable">mid</span> <span class="hljs-operator">=</span> size / <span class="hljs-number">2</span>;
            <span class="hljs-keyword">return</span> (data.get(mid - <span class="hljs-number">1</span>) + data.get(mid)) / <span class="hljs-number">2.0</span>;
        }
    }
}
</code></pre>
<ul>
<li><strong>插入操作</strong>：每次插入需要排序，时间复杂度O(n log n)</li>
<li><strong>获取中位数</strong>：直接通过索引访问，时间复杂度O(1)</li>
<li><strong>空间复杂度</strong>：O(n)，需要存储所有数据</li>
</ul>
<h3 data-id="heading-3">插入排序法</h3>
<p>在方法一基础上优化，在插入时就找到正确位置，避免每次都完整排序。同时利用二分查找找到插入位置，减少排序开销</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> java.util.ArrayList;
<span class="hljs-keyword">import</span> java.util.List;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MedianFinder2</span> {
    <span class="hljs-keyword">private</span> List&lt;Integer&gt; data;
    
    <span class="hljs-keyword">public</span> <span class="hljs-title function_">MedianFinder2</span><span class="hljs-params">()</span> {
        data = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();
    }
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">Insert</span><span class="hljs-params">(Integer num)</span> {
        <span class="hljs-comment">// 使用二分查找找到合适的插入位置</span>
        <span class="hljs-type">int</span> <span class="hljs-variable">left</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>, right = data.size() - <span class="hljs-number">1</span>;
        <span class="hljs-keyword">while</span> (left &lt;= right) {
            <span class="hljs-type">int</span> <span class="hljs-variable">mid</span> <span class="hljs-operator">=</span> left + (right - left) / <span class="hljs-number">2</span>;
            <span class="hljs-keyword">if</span> (data.get(mid) &lt; num) {
                left = mid + <span class="hljs-number">1</span>;
            } <span class="hljs-keyword">else</span> {
                right = mid - <span class="hljs-number">1</span>;
            }
        }
        <span class="hljs-comment">// 在找到的位置插入元素</span>
        data.add(left, num);
    }
    
    <span class="hljs-keyword">public</span> Double <span class="hljs-title function_">GetMedian</span><span class="hljs-params">()</span> {
        <span class="hljs-type">int</span> <span class="hljs-variable">size</span> <span class="hljs-operator">=</span> data.size();
        <span class="hljs-keyword">if</span> (size == <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span> <span class="hljs-number">0.0</span>;
        
        <span class="hljs-keyword">if</span> (size % <span class="hljs-number">2</span> == <span class="hljs-number">1</span>) {
            <span class="hljs-keyword">return</span> (<span class="hljs-type">double</span>) data.get(size / <span class="hljs-number">2</span>);
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-type">int</span> <span class="hljs-variable">mid</span> <span class="hljs-operator">=</span> size / <span class="hljs-number">2</span>;
            <span class="hljs-keyword">return</span> (data.get(mid - <span class="hljs-number">1</span>) + data.get(mid)) / <span class="hljs-number">2.0</span>;
        }
    }
}
</code></pre>
<ul>
<li><strong>插入操作</strong>：二分查找O(log n) + 插入操作O(n) = O(n)</li>
<li><strong>获取中位数</strong>：O(1)，通过索引直接访问</li>
<li><strong>优化效果</strong>：比方法一有明显提升，特别适合部分有序的数据</li>
</ul>
<h3 data-id="heading-4">双堆法</h3>
<p>是最高效的解法，利用大顶堆和小顶堆的特性来动态维护中位数，使用大顶堆存较小一半，小顶堆存较大一半</p>
<p>⽤⼀个数字来不断统计数据流中的个数，并且创建⼀个最⼤堆，⼀个最⼩堆</p>
<ul>
<li>如果插⼊的数字的个数是奇数的时候，让最⼩堆⾥⾯的元素个数⽐最⼤堆的个数多 1 ，这样⼀来中位数就是⼩顶堆的堆顶</li>
<li>如果插⼊的数字的个数是偶数的时候，两个堆的元素保持⼀样多，中位数就是两个堆的堆顶的元素相加除以2 。</li>
</ul>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Solution</span> {
	<span class="hljs-keyword">private</span> <span class="hljs-type">int</span> <span class="hljs-variable">count</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;
	<span class="hljs-keyword">private</span> PriorityQueue&lt;Integer&gt; min = <span class="hljs-keyword">new</span> <span class="hljs-title class_">PriorityQueue</span>&lt;Integer&gt;();
	<span class="hljs-keyword">private</span> PriorityQueue&lt;Integer&gt; max = <span class="hljs-keyword">new</span> <span class="hljs-title class_">PriorityQueue</span>&lt;Integer&gt;(<span class="hljs-keyword">new</span>
	
	<span class="hljs-title class_">Comparator</span>&lt;Integer&gt;() {
		<span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">compare</span><span class="hljs-params">(Integer o1, Integer o2)</span> {
			<span class="hljs-keyword">return</span> o2 - o1;
		}
	});
	
	<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">Insert</span><span class="hljs-params">(Integer num)</span> {
		count++;
		<span class="hljs-keyword">if</span> (count % <span class="hljs-number">2</span> == <span class="hljs-number">1</span>) {
			<span class="hljs-comment">// 奇数的时候，需要最⼩堆的元素⽐最⼤堆的元素多⼀个。</span>
			<span class="hljs-comment">// 先放到最⼤堆⾥⾯，然后弹出最⼤的</span>
			max.offer(num);
			<span class="hljs-comment">// 把最⼤的放进最⼩堆</span>
			min.offer(max.poll());
		} <span class="hljs-keyword">else</span> {
			<span class="hljs-comment">// 放进最⼩堆</span>
			min.offer(num);
			<span class="hljs-comment">// 把最⼩的放进最⼤堆</span>
			max.offer(min.poll());
		}
	}
		
	<span class="hljs-keyword">public</span> Double <span class="hljs-title function_">GetMedian</span><span class="hljs-params">()</span> {
		<span class="hljs-keyword">if</span> (count % <span class="hljs-number">2</span> == <span class="hljs-number">0</span>) {
			<span class="hljs-keyword">return</span> (min.peek() + max.peek()) / <span class="hljs-number">2.0</span>;
		} <span class="hljs-keyword">else</span> {
			<span class="hljs-keyword">return</span> (<span class="hljs-type">double</span>) min.peek();
		}
	}
}
</code></pre>
<ul>
<li><strong>插入操作</strong>：堆的插入操作O(log n)，平衡操作O(log n)，总体O(log n)</li>
<li><strong>获取中位数</strong>：直接访问堆顶元素，O(1)时间复杂度</li>
<li><strong>空间复杂度</strong>：O(n)，需要存储所有数据</li>
</ul>
<p><strong>为什么这种方法有效？</strong></p>
<ul>
<li><strong>大顶堆</strong>（maxHeap）：存储数据流中<strong>较小的一半</strong>数字，堆顶是这一半中的最大值</li>
<li><strong>小顶堆</strong>（minHeap）：存储数据流中<strong>较大的一半</strong>数字，堆顶是这一半中的最小值</li>
<li><strong>平衡维护</strong>：确保两个堆的大小相差不超过1，这样中位数就只与两个堆顶有关</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[别再死磕 Nginx！http-proxy-middleware 低配置起飞]]></title>    <link>https://juejin.cn/post/7594270467029991451</link>    <guid>https://juejin.cn/post/7594270467029991451</guid>    <pubDate>2026-01-12T08:56:39.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7594270467029991451" data-draft-id="7594168317214212106" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="别再死磕 Nginx！http-proxy-middleware 低配置起飞"/> <meta itemprop="keywords" content="前端,后端"/> <meta itemprop="datePublished" content="2026-01-12T08:56:39.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="程序员凌览"/> <meta itemprop="url" content="https://juejin.cn/user/3350967174565198"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            别再死磕 Nginx！http-proxy-middleware 低配置起飞
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3350967174565198/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    程序员凌览
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-12T08:56:39.000Z" title="Mon Jan 12 2026 08:56:39 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden;color:#2b2b2b;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(159,219,252,.15) 3%,transparent 0),linear-gradient(1turn,rgba(159,219,252,.15) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin-top:35px;margin-bottom:10px;color:#4dd0e1}.markdown-body h1{font-size:30px;text-align:center;position:relative;width:max-content;margin:0 auto}.markdown-body h1:before{position:absolute;content:"";z-index:-1;top:-20px;height:100%;width:100px;left:0;right:0;margin:0 auto;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADsAAAA6CAYAAAAOeSEWAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsQAAA7EAZUrDhsAABkLSURBVGhDtZoHnJ1llcbP3Om9ZiYzmfSQhCQQIbRQVQKI9CYC68qKriJK0UXcZRcINqStIoiIqKCi1NACQihBWiCkkJ5MJlMyvd7p7d759v989/sy34yTbIj48Atz71ff855znvOc971xDrB/EtoGI7a9Z8Aq+wZML0mNj7dE95NZ1OKsj1dHo1GbnJpss9OTbWJyonvun4VP1Njuoagtb+m0it4By0iIt8LEeMvkr8XFWcfgkA1gYDLf47i2PzpsyU7UspKSLDoctagTZ7Vc08MzClMS7awJ2ZaflBB78CeET8TYla1dtrKt2w5KS7YCDGzEoz2RqKUmhGw6x2bhuXyOp2BoRXef1Q1E7Lj8TIsMD1sbxu1kcnYSAX1810RMTUmyMB7f2j1gC7NS7byinNiL/kH8Q8a+2NRh77b32El56VaPAe0YeGR2mh2bm+FdMRqP1rbZe+3dFsHT35qcb/Oz0rwzo7Gxs9feYPLS4kM2h8lawee5hPmlJXneFQeGAzJ2F564v7rFzi7Msu3d/Xgjzq5g8ArX8VCNN2vJ28daey0zZJabmGCLslP5HOf+Oygr3UzDGOf+JxrauXfQjslJt+dbuuyMgiwmk+sPAB/b2Lt2NdoMZnuY21qHIvbvUyZ4Z0ZQiXGrWjvsmPxsK4R0nmHA8ZCTQvxVQn5eRipklIBtcVbV1WtHYsjati47ZWKuTUpP9Z4yGk/xDBGe3v1mW4/dOrvYO7P/2G9jRSjf31FnXyaUXiB8r51WaJkM3kcfOSa2FR6qarIenooTLQHPLcC4mYThyw1tVpKWYlVERlZ8nC3Oz3Jzdn1nn5uvQ8OOHYvhR/CvsqffJbkCkZTvcYZ6Z0WTfTovw5Y1dtjXp+TbFPhgf7FfxpYxuMfr2uwo8rEtMmwXF+d6Z8wGmIR2PLyjo8cqOFffP2SLGexJEJCP9R29thkPXlpa4A5Y3w/jmuVNYYwO2QkY7WMtz3mVcE1hkualJdmSolzX8GnpKd4VZq80d1o7zN0RdWxGaqItgbn3B/+vsasgh/UMNBOvzYMZDxtDKp289KGaVguFQvb1yQWWwuB97GaSXqUUnVaYbSUwrDCEBz/C2CM8EhNrP13fbkeSh3OJgCAe2N1CWXKsGOc6TOr5U4q8MwYhDtkTda02MyPN+nnGBQEH7A37NHYz5KOZVv08qyjbSseEzKauPnsMj98wc6Ibcj5UUv7M8QWZTE52jEwGOVaD8U1Dw1YNWX0qM8VKyb80L/TrOPYOzH4KBJQTrK8M7+7KZjuM63sHBt17FubGoibCuf+tarWFGUmuwWeT8/vCXo1tZOYeZcazCaez8MwEzzM+HqhqtiJI5twxL1jeGLYk7jmKMF1JOCbg6Qj5nAdRqX7q3BYm8VAmQvW1lfcMc58IT95uIA3q+gftrDHPXUXJWkVEHJme5Bp5UmHsvIZ/O3l8ECE/FWcsItX2hr0ae8O2Wjs+J43QTbOZzGYQ/7Wtxq6eXjRK3r0By4YJ6Ty8EiYSJqcm2eGeV4Pox/ANENJR49RiEdfqcLflUJrEBZqgxYHrBjn2ExFURqKdVETN9YirJxKxR2rbrYeQv5ISmB6IsiDGNfZGWPeMgkzr58xnPaJ5p6XDZPKz4T77wayJ7jGhhXLwanOHTWBgq5n5q6YUwNJ7l3kKcRl7OJ7fF56l1GzvHbSD8dghTPi0wIRfv6XafjJ3ssv0PnZQ7nZx/etwzO1zJ3lHR2OETTw8x0tOx1AN3De0D7YV+63oGthjaJQ5Ur7eVVZjcdGInUyuaT73ZWg3efV8fZs7cc2E777Qi5eunVbghvPPymrt/krKGfcLd8ybYjdxrK6333Z09rjHZkNuLYzz0uIc+xWCZzz8nbHbe4dsY1e/XUOY+nimvtUaSazv4jXhaQasSbmYmpuenGwHZ8TKggSEQm08rMD7ahBOoExcMqXQegjnZ+CEvaEa1ZQUQkt39dj0zDS7krq+ARmpdws/nlNqD9WFbWN7l5u3wr9MyrcXKUsqWy3jTOaoML4DdaQ83YIoT4VYpEXvYQZLmbX5SLohBrgOj186Kc/iKTUPUhq+Rrm5ekOl3TWv1Mr6hqwbY0VOQXwEo+Moq4Z47q5qsU489G944LyJOW4LOLZOKtT/iI6+nGe/0dhuEd4ltj2NmiuCU4hnk5fHIi7+RK4uTEu0e+s7rAiRcw1CYy3OejvcYz+eXeI9MYY9nu3lYZl0KavJJ7Vjibzgjp319rUZE20j7CkJqFr5JQYgQ39f3eQaKpQk0afy8nl4uBzvjUUTRk7k3iebOm0pabDiyFn2XGu3dRME41CGVeBVqSiVnc6hIUpekp1VjHLDSOEcQlui5W/U8C7IKREjv1Gabw3wRwUTvpv7jybPtzHmIPZ49q6KRjuccqBQVCOtGvqXhrCFUUXJzOYSHt7Kw5Ix9H08dSje1o1JyL73IYXpEMmE5CRbw6wuykx2pR+Pd6/J4JpLiJKV6N9OnrcQNfQ0Zem6qQX2MmFXyWTE+DMO0kGx4e08DEjnXbsYuOq7niHB8jdY/wQ8Srm2XCZZUrOakF1CY5EKX0h93Tu/1J4kRdbDMT8MamgZK9xe3uDcvrPe++Y4f61rcZr7B53rN1c5N2ytcV5rCrvHt3T2Og19g+5nH7dvq3bqunr4NOwgK2MHA1jeEDuG7HNuLmtw7qpocl5t6nCPvdTQ7v4N4u3WTqeyu9cZHIo4f6lqdFoHh7wzMbzDeeGv3Hvzjlrnh2W1zofhHuftxpFn3VFe7zxS0+p0DlKVPbhhvBxhvwiFMgfP+mjHA08gEC4pybeLyK1iZldh8zC5VJQyUl8l59KZ0WJk2xaiYWxNrkXXJhA8r3PvZRur7ZZZRfadaRPsfiTmX9HGajC2tXd6V8dQTMhX0h8rNdJx9Ra8F8SbRNLzhPRnJmTZIUTYueTyWxyr7uv3rjC3OkzE8495oS+4xq6D5WoI0bO5WVCOSerl8rIeBrOI/Hkaw6ME5W1zSuzx2la3CRdWi3zIG+FDBvUp9LMgI/vggUmE7KkT81yGvOOgEYa/aUahhRAF5xLec3OzbF1r2O17BbVxIi7hzJIC64IYhXdJA+nh/5xVbOmE9J0QqjSxWk0pp37M2YEtgjS8GpimACu7xkqxdKJ6fEXyYl2Lre0ZtC8yELVewtWUnbfCPIhrvgDFz8WI5yhJKgcnFMZWEFrwhgzo5uWDDDA1oGSOzcu0xfx7vTlsv6posIMpJ6cGWPiw/BxL4PU7vbrpjgf8bMdu5OYwOdhm83DARUSa0ELknYIeEAaILuWxlhGa0M8+EuJCrpJT+ymENhN60pXBxa3LZ5TsucnlGaCmIEQ4Evru91yuz0xMtKaeXluI5zdh9Mm8vAlBn4aR07X64EH3vEKdXQkZJXPP/JxMvNRpLxEtHZ5RQgmNewnpouvVTpYTHdfOnmy5kFUGnpRTfEhXD9DiBdFFJB0/YWS9aj6pmc89r0BaQmgTRkgI+EsdKsYasJZOBF+QqTH474NK7LbyBvf7W+RgOxNyxfQY2/2hrp2+NkroxrzrQ55fSZkpJIa28znCgF6rb7H1hOSslATyvNflAh9pvHcX3lVE/Ya8FjTJIexa2Rq77nfU96unTnD7aME3+TAm6BFKYrPnqCNIqV5sq0ZGCiEV+Db+qWMQqpFgb5KPx48R6omeDl2EuP9DTYt9iGA/f1KBS1w/La+H4ktsSmLItvZHXLUkrCeflVtJ9DVVg1H7+sxiGvVM975rZpfabuqHVhuP5F1vewav5O8GamUe91yDanoYw47FWzC929O+DJnKA2opFY1Rjru5CE7kOcO0jJtQVUIynzuZEMeb+1CEOFXN8iFSGeRpCm1BTlJxVg49Azm819SO7Bu0axEbwn27GuxMck+TMQHDP8fn48gfDVIL4R8xKVPJ73MQBUIfA/Z54LMw5vmlE+w+VFo2A78X/SsyPA/RMD0z3e2qVLtfo7aeBslpMX0N0TEnLcUlKym1jyBFqSohmYntI5enBhYB9CY/2kNarhwJhNiMtRGyWnkQdKaCFyQwgydjyNUw4VchKxXv2/DoKdC+lkQbCX1NlKCGvJiBJkSGbCus6jfo4yGBNySgr+u7e20BCsxdVAcFlJ/tHd32+cIsNxSXUULUUx+dg/d47g7OPYFw2MxkSuyMwLHVTI6PBN6dS8Sppw45zHJSgDXV3aQzmz40Z6fDgBfiAXU0uZxby2zejee+j3eltoQMzhV6qSBogXwrEXDj7ElWxUQ8RrnSaoU0dxIsKaiMvMykXTu90NqJsGHP4z78SdLigUrLKat32nFwy/E07pfDFRdQ/7N5r57pQ1482uvWhMGhQcviGkVrKDUp0ToCxfhQal5n4Hs/g1jOgH4LWdwFOd1b1WzHET4vLZppv+Czjxo840OrDlG8jAJzv2tp5mLK1dsU/lfIOeWy5NxFxfl2BoYImlQtx9QF6mJRQKBsQYYuO2yaLYPBUXvu/VqYPxtHhNy7Y4hCkNLGPtKSklzCVKSHtMQxcqm5Kw1DhI2PTGZtcGDAvoLQ/u7MifYtWFBlxz2H9zo8RkwKzC5UYiG+p44ccqE62YAxLeT/TOpf8MXx8Qk0IJFRY1Go+viQVJpE5Ehjf49xfAZeqGIy/7us3nqxwQfCkjZypPxobVr/6YpQHIalUvuCyEwbSXC9PC8QnkFcXlrgLpoLIhIfKuaqlQkYIAwQnr/f3eyu7KttOw2lNpv8/BPHyjzVNER3o72gvEBKqRMTflndbP8BMweRDyeciEj5bFayFXqTLzheivgYJC0jwzwHa0MDDEotm48ndze5BBBElAnxxcRYHAFh3FfZaA9UNRmC354kNwUx8eHkmVj5dcTE5ZMnuEyr1QqlhtaJLuOYZv4v3KNo0TKrGPUZ1NILPKuWcvVn5Trv10SMB6h0j/ARMnlOuafCBIfnSWEx/Raif3HDzofYMM31dOyY9LBaLK3TjoX2fEqT4+2qaUVWSTQvyM6wC8nNJyEetXIyuLKrx04P7MKNnbJZlKUtNAIHo7i2dA/YU3Vtdi5l6jCepXy8hOedSSSsI8/HQg5Q+gxTKXwkMHkbESo+hjG0lbRRzQ3Fc5LOzDuFhs3Ptumpie7ilRDhlEJOq/hjsZljCxjkt7fWuPS/EekpXMggJQIk0G+eN9Xu2VmHWIkJe0nJRN4ptBBit2yutG9ML7J1DHAxebiAMrZ4VZlduqGS8I2tJc2iborUxmIN79c+kTovFxivPvrcSaP3n7RSKYTUmKt4N3rMOcw4JOneD3sP956jNaMglIeTER5Xbdlt15Tm2W10NEsYrA/N5JLCHHsR9tSqwxq08G3bqm1ZTbOtagnbo6SLvH/VzBL7W7jPzqFea0LmMLFzUuLtdwumuO3i1Vtq7OK15Xgw3l1PDmIXak+6QBEkvB9YJIzBcc/L20JIYaSZ/qAzVm5Ut4oowk3QehC+N3xo/1wTqt7zsYawfX9no9XjqdPXVLhrwyo/wucJYQkE1e4j8rLcBuHUItQQKqgMXb6LGvxFQlXw33AdZLR0V5P9Fr29lP73scNnosoyvdWPv4fPJ+uJrLVtMakqaL1M1cTvv0OLIZE6wk2a2IcIRUQh+DaejpdcXepBa7bKDRGM9PIVxTl2EwarZ72rooVuY4RQtMypdk6e1lLLehhY2lt7QEd7WxlCDvdIli6E9B4+ZIodmZEMccUGqgiZOqru9tkR3iJ8nCcXRWRZCSPMLPEjlx2LjQL1OM5qKAm+vhSuRqSfV5Ttrg8FdWcrnhMqCTex7DEM6qTsVEuM1+8hovaHQ6e6a1Fz0xLd3nUt4ToWWuzWNkhcoAIIjUx2ZpxjLzWF9+SYmngR1lok4TEoJxGfuijhI/7OICoFmadl2llcL9b1oRVJtbD+JLlv1KrhHG5811t9ELbzgk14ICUwqE+TDzftqHPz98vUSy3jSIwP8dCpkNqLDPTx+rArz4T5qLG3G2PrvJKKPoLBWE501NC3ilUX5mVjVIb9nIbgWcpPMiSXjbcL8K62UkR86m1/yfkSeMaHFuK04X0CE3J6SWzFUxw0BSNHlSzi3RmIRJwHq5udO3c16quLp6sbnffbupxbt+12vzOrzuvNHc7ycRbIxuJHgYU7YSASdQgxp7qz2ynv6HJeqW91doa7nLruXof+17sqhhu31Xif9o7HalqczV29Dnrb/f5EXZvzdH27U98/6LR5i3N0UM5zjHU71/lwjRWWltU5CAIn7F1MqLp/r9hQ5RoaxG+qmrxP4yNKcfsFLwuiprffeb2l03m2scO5h3Or2rudzjGrhk8x4Cqu2xcexilBvNEcdi5Yu4tKF3Ue4tzPy+td5/1md4tzw5iJ27NuXEYobYUdlb8z6GTWkdxaCvk2zHjd5mpKQ459mv5TkAp6mQb9Aq9HHQ8S6mrZnuc6vUG6WHusIhCJGNXl9byvnJyaiE7+Eoz8c5TYNQiUveENGpJpcIJ+biS8R0+rlcazGNs7pKB+zPLTOSX2KNWhlDAf4r2Spj72JORB5OyHULX+dlD/FOky/HFy5ygYU0sey/i8moeqdunXK1qC3RuaMOYHlI/raQMl3M+EeTV5WxD3Km8a8PkM8nr648sQ9+esKbf5e/nxiKBfAOQkxbv3SU9LYmqPV9V/Pn+V20VwTyVjTqCI6edEQUOFUXs9WmfSll8DyX2dt7GlnwkswaM3l9XZ0oNK3MTXbxpOV2sGk69s6XCJw4cY8KbyRrt9TrHt7Bm0rRBQe1+fHUWNfaapU0KbqxzbORC1M/LS3dJwIl3KOrwykQG/E+61q+isgniztdOKqNOziDgZqZIzFwPvqGiyg5NCtoCqoG5NxHhPZTOsnORulKskjoKMDeLuXQ3OmnC3syxARFXdfc57LR3OrdtrvSOOs55rnqhtcdoGhpxHdjc5EfJUuHZTlftX+G15rXPlhkrnLe59F7Lz8VGHdg8c5y2OLeMZ126qduq9XC3v7nd+FchLvYPJd15gPCu8XQnh/qpm59WGVudZzvvQO97kXTcGxhnEuJvR39tWY8cwK4uhcikk4a3Gdstg9l5B2t0wfaTdWkEou5vCPOV5PH73vFL3+DfXltnh6OxjkJD6Wd5F3g88tMe6CW/7YmI99VIL4u0oqUK8ocW4d8hFrXMVoOQU8s3U97MnjvDD/XRYkyhHM1MT3GVZQR2Tdv70U8EbA5vlo+CaPAaaSWoZXm50otGodxQ6L6txGKxzw5ZYORrBsPPrykZKQIy1n8bTjwb2fO4Te3ue7x6KOKvaYns1wtIddd4nx3mwot55qyl2360cp81zurg+CGqwU8v4/Of5uAVvPgObrwvHomY8jOtZ4fXWLnefdHVXv9044+8ZklCx75DXwcV1Sb27y+vInUQEuVYSaMgRJYfAwtoj0raFxIUW1A8nz35f02qLc9Lc9lG7CBkwtUR7bf+A+5uL6ehnH9Lat+5sIEfj3Cbj3NKRvP7Rjlo7FSmqavKvpSP8MRZ7NVbQYLSkqlC9ZW4sPH18gBTcORjrhMWmQWzFmK2UsvO90qQ1oZcI8UhkCLZPtRqMy0NirobAvjIpb4/sW06qKGyPR2oGIdlazjOOTk+kLYzaaYGSp63Wz6HsXsQ51wd+LTAuZOy+8GBNq7tF+IOdDU4kENJthNID5YRafZtzZ3mDs9LbRgzixcZ2l1h83OKFbDmEd0/FiFp7DWHgp0AQGzq6nf8hPF+oa3EehOz0ziCWcm4NpBRMhX1hn571oR9wqVVSDVPtUi32sQ0vbu7scZdY9aOt2ZSEL9BEBIW+dv20AKDd9/ep09oimYqHpyImkKDuRllS4PrlHNuIqDmCJmNJQba7q1joEaUQJuR/WdXsLrJrq/L6cdJsPOyXscJ7GLKqo8cOpqhrO//yQG6oS3kZwS9xPkRB3wi7diFMtDN+PLk5m1ath+8f0Fy80dbjhvVXub+U5mEqeal27UP+dWpPlknNxW79Ak6/7Tg3UMOF52j1xA1qK7Trd6nXC+8P9ttYQcumIonLSnJtBdJNa77axw1C2x3qR4Wqnj73x9f6MbV+CCYFBZO6y51aSh3gzVrsmwzJnULEbCJC1oZ7vIZ/9Iqmfvn2u5oWO5n8fApxcuWUApum5diPgY9lrA9EtvUNOzYf8vqAcJPsU5iOh7XtXQgt2uZhjKU2amF7HQyfEYWcZk5yQ1RDKNrLcq02k/9IGmldrB93KiokPw8EB2SsoKWXO5FmxXhlckqi+3vEUvLqwok5PHVkIWAszlqzy1p54zuLpnPZ3q9bod08JlLSb5DrNxDm38Sbvsg5EBywsT7oH+3XNW3uasGirFSrxRNdCllKiPZHZzJYLZb5qEcpae3pxMCuu9oibS5/QCOiLcYUrp+MmtJeURjFdVlxzqiae6D4h40NQt54HyGv3JRo10aVfv8YhtC0pSlVKcPFuxIXahr08mzCO4VzMlLSsZuomZ+RaucU0rXsw/sfF5+osUFonWob/7TrLdaUgdpV93fl9X+VIC0Y6tek2uI8OD3J5gT2Vj9ZmP0f4IM4iY7RQ5gAAAAASUVORK5CYII=) no-repeat 50%;background-size:64px 64px;opacity:.84}.markdown-body h1:after{position:absolute;content:"";width:150%;left:-25%;height:50%;bottom:12px;border-radius:50%;background:linear-gradient(transparent 80%,rgba(77,208,225,.8));background-size:400% 200%;opacity:.6;animation:h1Animate 6s linear infinite}@keyframes h1Animate{0%{background-position:100% 100%}50%{background-position:100% 50%}to{background-position:100% 100%}}.markdown-body h2{display:block;border-bottom:4px solid #4dd0e1;position:relative;font-size:24px;padding:12px 32px;margin:30px 0}.markdown-body h2:before{width:24px;height:24px;left:0;top:0;margin:auto;background-size:24px 24px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAADGklEQVRYR81X32vTYBQ999s6mFjQgQ+DrbHiVFZYU4cDcQ/6pGhTFVYFEXGi82H+Bz448UnEF1Fx9ccEEcXpZE3d5tP2ooKiTacTHaLNpigMHDgnU9tcSbrWrkwWR0sbyEOSe885ObnfvV8IRT6oyPwoLQHBx+OVM5WJvSyEVAhnBOjt7yU/+/rr6r6l8TMO+F/EN0JQhICqQpD/xaRpcpAc9tS+M+9lBCia/oqBamK+zeDuQogQZaKJk3wcQjxSva7tGQGB2Ke1zIk3DNyMyNL+QpCnMQOaPsDAVuGAp9cjvbYc8Ec/bCYSg0zoiHilk1tHxqsqEsYlML4kjIpT/eurJxRNPweQU5VdrWaOEo1fgKAVbBgXIz73kF3R/ph+ghgdzMYWM29eAWlBJqgZaFlFYtC6nhWpaDqnSGlIlV1WjJ3DloDNgyNLncudqgX//Ucg3LxuStHGuhi8pqKCW3rqV342rwFjRznKm+/LNaN2yC237ThgF2wxcfMLeP6+ncrKzoPoKTGeLQbYbg4TNoC5iZPJY5HGVRdSNZAWYBclD3FzBQzrR8hACAKdzBzKA/4/IYioDQaOskBbpEG6PO8qKKSAEi3CnEb0Pw4oMf0OmKbTDWqh3Lw6EIiNBZi5lxh3wz4puBD5ovqAMvxhHSdFKxE1CQe3m/07TeTX4lcJdAhE+1Sv65Z5P/ByvIGTRowIZ9igbtXnmrOsbTvgj+kHBNMuBu9OdVw8EeU4nC1A0cYmAHZOTRrLhra4Z8ywnSN6vZHAFTA2WnnMfQB3qz73ddsOZM8CACFDIPSgQXqebXEgqgeZcAeEe6pXasm1f8ew3igMtAHWac0Uc/jYdyAaP0xEBwFsmgUPqbJ0NE2UKj4EGcahiOzuyhagaHpnmtgcVgTcCMuua7YdyAHbA3ArQNscVFbb4635aD6fnYaTvxxi9UNP7ddMXaRWVBdAcaLk6bDXPZCNZ9uBXEsDUX1T2Cc9yjig6Z0EHg3LK8/aqf6MwJKchkXfks1+0+JtSq3qLPa23BRR1B+T/6nkfMaW1r9hPt/MLtYfTLEpP+T9FNoAAAAASUVORK5CYII=)}.markdown-body h2:after,.markdown-body h2:before{content:"";display:block;position:absolute;bottom:0}.markdown-body h2:after{right:0;width:400px;height:10px;border-top-right-radius:24px;background:linear-gradient(90deg,#fff,#4dd0e1);max-width:50vw}.markdown-body h3{margin:30px 0;font-size:18px;position:relative;padding:4px 32px;width:max-content}.markdown-body h3:before{border-bottom:2px solid #4dd0e1;width:100%;content:"";display:block;height:28px;position:absolute;left:0;top:0;bottom:-2px;margin:auto;background-size:28px 28px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABRklEQVRYR2NkGGDAOMD2M4w6YDQERkNg+ITAppcfY/8zMv3wF+NdTUrZQpUQ2PT6cz8Dw/8CkMWMDIwNvqK8jcQ6gmIHNN19EaXPx1XPyMCghrCUKcpPlGc5MY6gyAE+Fx52MjL8j3cU5a1UYWXtZGBkEAVb+p8hxU+Mby5NHQCxnKEMaskzJ37uFmUetkmMjAzrfUX4woixHBJlZAA0y2EmPPYU4enLkhGeQIqRJDsAh+UgO7duNpD3IcVykkOA2paT5ABaWE60A2hlOdEO8D3/4CMDIyMfWvySFefoaYSoROh74eFXBgYGLiTNVLGc+BC48PAnAwMDG9QBVLOcaAd8P5ox+x/jf5AjGLgYfnwnKqv9/8/PwPO/kFF/MSj0cAKiouD/0bgYoixFU8RovWgJIX1EOYCQIZTIjzpgNARGQ2DAQwAAvHBaIdB7zxsAAAAASUVORK5CYII=);background-repeat:no-repeat;animation:h3AnimationBefore 2s infinite alternate}@keyframes h3AnimationBefore{0%{width:28px}25%{width:100%}50%{width:100%}to{width:100%}}.markdown-body h3:after{content:"";display:block;width:28px;height:28px;position:absolute;border:2px solid #4dd0e1;border-radius:50%;right:-15px;top:0;bottom:0;margin:auto;background-size:28px 28px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABRklEQVRYR2NkGGDAOMD2M4w6YDQERkNg+ITAppcfY/8zMv3wF+NdTUrZQpUQ2PT6cz8Dw/8CkMWMDIwNvqK8jcQ6gmIHNN19EaXPx1XPyMCghrCUKcpPlGc5MY6gyAE+Fx52MjL8j3cU5a1UYWXtZGBkEAVb+p8hxU+Mby5NHQCxnKEMaskzJ37uFmUetkmMjAzrfUX4woixHBJlZAA0y2EmPPYU4enLkhGeQIqRJDsAh+UgO7duNpD3IcVykkOA2paT5ABaWE60A2hlOdEO8D3/4CMDIyMfWvySFefoaYSoROh74eFXBgYGLiTNVLGc+BC48PAnAwMDG9QBVLOcaAd8P5ox+x/jf5AjGLgYfnwnKqv9/8/PwPO/kFF/MSj0cAKiouD/0bgYoixFU8RovWgJIX1EOYCQIZTIjzpgNARGQ2DAQwAAvHBaIdB7zxsAAAAASUVORK5CYII=);animation:h3AnimationAfter 2s infinite alternate}@keyframes h3AnimationAfter{0%{transform:rotate(0)}10%{transform:rotate(0)}50%{transform:rotate(-1turn)}to{transform:rotate(-1turn)}}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:15px}.markdown-body h6{margin-top:5px}.markdown-body p{line-height:inherit;margin:22px 0;letter-spacing:2px;font-size:14px;word-spacing:2px}.markdown-body img{max-width:80%;border-radius:6px;display:block;margin:20px auto!important;object-fit:contain;box-shadow:0 0 16px hsla(0,0%,43.1%,.45)}.markdown-body figcaption{display:block;font-size:13px;color:#2b2b2b}.markdown-body figcaption:before{content:"";background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgBAMAAACBVGfHAAAAGFBMVEVHcExAuPtAuPpAuPtAuPpAuPtAvPxAuPokzOX5AAAAB3RSTlMAkDLqNegkoiUM7wAAAGBJREFUKM9jYBhcgMkBTUDVBE1BeDGqEtXychNUBeXlKEqACsrLQxB8lnCQQClCiWt5OYoSiAIkJVAF5eVBqAqAShTAAs7l5ShKWMwRAmAlSArASpAVgJUkCqIAscESHwCVVjMBK9JnbQAAAABJRU5ErkJggg==);display:inline-block;width:18px;height:18px;background-size:18px;background-repeat:no-repeat;background-position:50%;margin-right:5px;margin-bottom:-5px}.markdown-body hr{border:none;border-top:1px solid #4dd0e1;margin-top:32px;margin-bottom:32px}.markdown-body del{color:#4dd0e1}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:rgba(77,208,225,.08);color:#26c6da;padding:.195em .4em}.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace;overflow:auto;position:relative;line-height:1.75;box-shadow:0 0 8px hsla(0,0%,43.1%,.45);border-radius:4px;margin:16px}.markdown-body pre:before{content:"";display:block;height:30px;width:100%;margin-bottom:-7px;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAAAdCAYAAABcz8ldAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAhgSURBVGhD7Zp7bBTHHcdn33t7vvOdzy+ITVKDU0xIKG2ABCPTRCCaUiEVKWoqRJuASAhCitRCVKSoalFUKZBiSmmFRRJKRUnUtIpo+aNqGgwoOCmuFUIRzxjwE4zte+97drYzztji8HPvtkit/PnH+n1397Tz+83vN/PbMZhmmmmm+d+BoX8n5diihcGqgFQf5vk6BMAskWUlw3GyFnIvtqWSf91w7mKC3npfOLX7wYeiIa6BBWCOLLFRF2NB0JvIOP/80YG+k2ev6S699b/OzOfKBW5l5KsgyC4DCFQDnpEAdE1goc/dlNPc/Up7P711UiYNSMuyxeUzZPnHgGHWh5XADEkSAcdiN+AnEXIBhBComgFU0/xQR+jnj51sOUMf9Z0NKyL8S9+JPBEN8zuCMrsqGOA5QWAAyzLAxe53HBeYFgJp1c5Cx33nyIfpV3e+22/Sx32nev/sMCgVnmM4bjOniAtZWQAsz315EfsGQQc4hgWcjHkCmOj1rheuNn95cXwmDMiVp5etC/D8m5FwUWVQUYYGPh6mZYFUOgsGVa1pXvOZzVT2jRuH54RM230jEuI3RcIiL4l4UkxAJmuD/riVsqD7ct2m9nep7BtVTbVfZ0uE/UIk+CQflAHDjf8+Lg6MldYATGpH3c/Ul7p3dWXppVGM6eElJSHmnQWPbSlRlN1lJcUBjqNRnwJZVQO3B5P/uq5rK1d90pakckFcaKp5UJHY92JR8YlwkUDVySEZfGfQdO7E7Z8s2HL9TSoXTPXRud9nA8IBqSwcZgWeqpPj6BYw7yTbXBN9q2v9lQEq5zBmWA8vWLCptCi4tzwW8RQMQlFQATPLSh6vCSh/plJBkMyQBHZfWYnkKRgEktEVpTJXERN2Xzo4ex2VC6K6qXYpF5b3ypVRT8EgcAERSJXRbwCBOTFzXblM5RxGBaRt+ZPYA+LO0mgxz5K1Ig+UgAzKIuGnz39z6S+olDeaibaXRsU1RUFvgx+GwTWgPCaDgMw2XXpr9gwq50XV0bkxJiYeEiNF5cwE5XsiOEkAUkXkUW51SSOVchjl8WKef604XFSRbzCGCYeCoESStv/p8QU1VPIM3knNDynctnBRfsEYhgSlNCIGgQv2UCkvGIHZgteMh1nBW9W4F16RAM6yDVV7amZTaYQcr59cuuhhWRTWBvAMLxQGeyFSHOLnh0MvUskz5RF+fbRYDEy0mZgqQYUHOLhr//b6rGoqeaLqQG0pw3PrBbyA+4EQUkRmhvgqNUfICUipKK4OKUqIJVPKB0jpEhjmWWp64jdbKmVZZNYogcJm493gsifOqhDyeh9GYR/FM7sW+DA5CKR0MSK3tvKZkpwB5gRE4tjFEr7RL0iWBGV51vHFCyupNGWWPqLgnoer9mtyEGSJAzwLllDTGzyznDjRN/CwOFkoFb4bm0eVIXICgpvdGoEvrF7fC89zfLkkeV5HbOhWiTwTpKYvCAJLGshRdXtKMKAWlyxq+MPQLk1h66g5RE5ABJYNFrqY3wvJklJRUKg5ZWLFXIA86yek2uDOPkBNb3CM5Pf7DL2QyIrUGiLH+xC5Bmmm/ARnHUhC6PnzxWDK0RH5HuIjZGy27erU9AZ0dTIWXyG+NpBBrSFySxZw220IqeUPFoS6jVAPNadM7yDsgNB1qOkLuAziMYIb1PQGA75wIaKGPyAb+9oF16g5RE5ALIQ+tSyLWoWDEAK6aXW3JlK9VJoyx1oyvVkNdvo5KXXDAVkdnaKmNwx0xjH98w3JNmTCm+Bc9hKVhsgJSI9pvp9Vdd++jmq6AXB2/HHrhcs5aTkVDv0DFzoHvKdq/mQsKX/4t7KJLDpOJW+IbAvMGoMkxfwAWZB8DT7W1diTE+WcgKz6pK1bs6z3daPwmJDsSKt6ZsCyjlLJMz0DsDGZ8SdlDROBjOb8YeWOjptU8kTXusuaazu7oJrfEnQvdkpVcUn6PTVHyAkIIW7br/Unklni0EJIZ1WgGsauZR+fvUglz6zY0dGfVp09ybRNlfwgi3k8YSbvJJ29VMoLt9v6rZVQL7hOYUubndHJGclBtzn1byqNMCogi09/2nFb01/oj+f/5TyjauBOKtPcZ1r7qZQ3f2lRfxZPWi2anp8TSDAGExZMa2jr8u03L1M5L7q3Xc+iAeuHRl/ScvPcjSLDBnZS/cjtNHd2v3171Ewbs9N5q7Pn4otVMx3btBsCsoRbk1FxG5dMVgMDqfTpXl1/tuFMa5zKefPROdX59qLQBwLnNog8Wy1OcjB1N+QEsW/QsFNZuO35Xb1v98QLX4/Sx+O3wqujrQ6013ABUWI8+AaqBjAH01+ghL22+5X2PirnMG7r+esbnae/V1neauvGSoHjigTcVU7UGFm2DeK4ttxKpQ+mLPvl+o/PjnkAkw9HTqSMmVHhyAMx9iFcSh/BHTfLceO/C8mKjApBf9zszGhoY92m9sN+BGOY9AeD7eGniv8OTaOB4dgyTsQd9wS+IQu4lciYdkI7CLrNH3Rvbb9FL41i0tbzVP2iWJkobpN5fmM4IJfJskTP1Bk8A9HQmbpmGDBrWqdVCN/Yd7PjxKGOXn+bmbto3feVVcVB9qehIL8EJy8nChwgr0O2xxBnhGU5eP2CfYbl/m4gBRsbtneMORP9oGpjpcCsiKzHHfdOPiQ/wMniyFEu2dbiTQCAeN/vavC466BGYLttXc9fmXBXMGlAhiHHur+sq6uPiUI9z7CVHMPwBnLSuuN8FuC48/Oaz1ylt94XfrW5ouyprwWfYRkwNyCyYYjwkBHows1fa+tV/fzGxlv39b9gqvfPmQ+i/HK8KlcBjhHwfl8HEHyOd1JnuzZd66S3TTPNNNP8/wDAfwDG7G0m9LKBpwAAAABJRU5ErkJggg==) 10px 10px no-repeat;background-size:40px}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{color:#4dd0e1;border-bottom:1px solid #4dd0e1;font-weight:400;text-decoration:none;margin:0 4px}.markdown-body a:active,.markdown-body a:hover{background-color:rgba(77,208,225,.1)}.markdown-body strong{color:#26c6da}.markdown-body strong:before{content:"「"}.markdown-body strong:after{content:"」"}.markdown-body em{font-style:normal;color:#4dd0e1;font-weight:700}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:rgba(77,208,225,.05)}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{margin:2em 0;padding:24px 32px;border-left:4px solid #26c6da;background:rgba(77,208,225,.15);position:relative}.markdown-body blockquote:before{content:"❝";top:8px;left:8px;color:#4dd0e1;font-size:30px;line-height:1;font-weight:700;position:absolute;opacity:.7}.markdown-body blockquote:after{content:"❞";font-size:30px;position:absolute;right:8px;bottom:0;color:#4dd0e1;opacity:.7}.markdown-body blockquote p{color:#595959;line-height:2}.markdown-body ol,.markdown-body ul{color:#595959;padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>大家好，我是凌览。</p>
<ul>
<li>个人网站：<a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.code24.top%2F" target="_blank" title="https://blog.code24.top/" ref="nofollow noopener noreferrer">blog.code24.top</a></li>
<li>去水印下载鸭：<a href="https://link.juejin.cn?target=http%3A%2F%2Fnologo.code.top%2F" target="_blank" title="http://nologo.code.top/" ref="nofollow noopener noreferrer">nologo.code.top</a></li>
</ul>
<p>如果本文能给你提供启发或帮助，欢迎动动小手指，一键三连（<code>点赞</code>、<code>评论</code>、<code>转发</code>），给我一些支持和鼓励谢谢。</p>
<h2 data-id="heading-0">前言</h2>
<p>已有一个去水印下载鸭后端服务，域名配置、服务器端口均已配置稳定。</p>
<p>现在我另有一个后端服务，假设取名叫去水印下载鸭后端服务Pro。</p>
<p>现在需要去水印下载鸭后端服务、去水印下载鸭后端服务Pro部署在同一台服务器，并且两者都通过80、443公开端口对外访问。这时大多选择Nginx反向代理让去水印下载鸭后端服务、去水印下载鸭后端服务Pro共用一个门牌号，流量自动分流，证书复用。</p>
<p>对于并发量大的后台选择Nginx没毛病，但对流量小到连“并发”俩字都嫌重，再搬出 Nginx 就是拿青龙偃月刀切葱花——刀好，但真没必要。</p>
<p>Node 玩家直接 http-proxy-middleware 一把梭,省出配 nginx 的功夫，早把需求迭代上线了。</p>
<p>本文就来介绍怎样用 http-proxy-middleware 三分钟搭好反向代理，让“去水印下载鸭”与“Pro 版”同吃 80/443，零 Nginx、低配置。</p>
<h2 data-id="heading-1">http-proxy-middleware是什么</h2>
<p>http-proxy-middleware是一个基于 Express.js 框架的中间件,它能够将一个或多个 HTTP 请求代理到另一个服务器上。常用场景如：前端开发遇到跨域问题时，通过配置http-proxy-middleware，可以将前端请求代理到后端服务器，从而巧妙地避开浏览器的跨域限制。</p>
<h2 data-id="heading-2"><strong>安装与基础使用</strong></h2>
<p>首先安装http-proxy-middleware:</p>
<pre><code class="hljs language-jsx" lang="jsx">npm install http-proxy-middleware
</code></pre>
<p>安装完成后，我们就可以在项目中引入并使用它了。以下是一个简单的 Express 应用中使用http-proxy-middleware代理请求的示例：</p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">const</span> express = <span class="hljs-built_in">require</span>(<span class="hljs-string">'express'</span>);
<span class="hljs-keyword">const</span> { createProxyMiddleware } = <span class="hljs-built_in">require</span>(<span class="hljs-string">'http-proxy-middleware'</span>);
<span class="hljs-keyword">const</span> app = <span class="hljs-title function_">express</span>();
<span class="hljs-comment">// 创建一个代理中间件，将所有以/api开头的请求代理到目标服务器</span>
app.<span class="hljs-title function_">use</span>(<span class="hljs-string">'/api'</span>, <span class="hljs-title function_">createProxyMiddleware</span>({
    <span class="hljs-attr">target</span>: <span class="hljs-string">'http://target-server.com'</span>, <span class="hljs-comment">// 目标服务器地址</span>
    <span class="hljs-attr">changeOrigin</span>: <span class="hljs-literal">true</span>, <span class="hljs-comment">// 允许修改请求头中的origin字段</span>
}));
<span class="hljs-keyword">const</span> port = <span class="hljs-number">3000</span>;
app.<span class="hljs-title function_">listen</span>(port, <span class="hljs-function">() =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`Server running on port <span class="hljs-subst">${port}</span>`</span>);
});

</code></pre>
<h2 data-id="heading-3">运用到实际项目</h2>
<p>去水印下载鸭后端服务跑在 3000，在生产环境中会占住公网 80；去水印下载鸭后端服务Pro躲在 3010，只对内敞开。现在把 <code>http-proxy-middleware</code> 直接塞进3000去水印下载鸭后端服务，只加一条路由规则：</p>
<p>接口一旦撞上 <code>/api/gold-price/*/**</code>，当场被悄悄转给3010端口服务。</p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">const</span> proxyGoldPrice = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./middleware/proxyGoldPrice.js'</span>);
<span class="hljs-comment">//省略</span>
<span class="hljs-comment">// 👇 新增：代理 gold-price 路由</span>
app.<span class="hljs-title function_">use</span>(<span class="hljs-string">'/api/gold-price'</span>, proxyGoldPrice);

<span class="hljs-comment">//省略</span>
</code></pre>
<p>在middleware目录创建<code>proxyGoldPrice.js</code> 文件,Express中间件配置放置在一起.</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d7fb39b4408e4880943113025a898930~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY5YeM6KeI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768812999&amp;x-signature=bclmSDT4C5mLU9tdVduSoB5WhBk%3D" alt="image.png" loading="lazy"/></p>
<p>proxyGoldPrice.js内容:</p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-comment">// middleware/proxyGoldPrice.js</span>
<span class="hljs-keyword">const</span> { createProxyMiddleware } = <span class="hljs-built_in">require</span>(<span class="hljs-string">'http-proxy-middleware'</span>);

<span class="hljs-keyword">const</span> proxyGoldPrice = <span class="hljs-title function_">createProxyMiddleware</span>({
    <span class="hljs-attr">target</span>: <span class="hljs-string">"http://127.0.0.1:3010"</span>,
    <span class="hljs-attr">changeOrigin</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-comment">// 如果目标服务不需要 /api 前缀，可启用 pathRewrite：</span>
    <span class="hljs-attr">pathRewrite</span>: {
        <span class="hljs-comment">//重写路径</span>
        <span class="hljs-string">'^/'</span>: <span class="hljs-string">'/api/gold-price/'</span>,
    }
});

<span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = proxyGoldPrice;
</code></pre>
<p>在上述代码中，我们通过createProxyMiddleware函数创建了一个代理中间件。当应用接收到以/api/gold-price开头的请求时，它会自动将该请求转发到<a href="https://link.juejin.cn?target=http%3A%2F%2F127.0.0.1%3A3010%25E3%2580%2582" target="_blank" title="http://127.0.0.1:3010%E3%80%82" ref="nofollow noopener noreferrer">http://127.0.0.1:3010。</a></p>
<p>举个例子：访问<code>http://127.0.0.1:3000/api/gold-price/realtime</code>时，命中<code>app.use('/api/gold-price', proxyGoldPrice)</code>路由，http-proxy-middleware会把<code>http://127.0.0.1:3000/api/gold-price/realtime</code>转发到<code>http://127.0.0.1:3010/realtime</code>。</p>
<p>上述例子中转发后的访问的是<code>http://127.0.0.1:3010/realtime</code>,但在去水印下载鸭后端服务Pro路由前缀都有<code>/api/gold-price</code>,所以会出错没找到对应路由。</p>
<p><code>pathRewrite</code>则是解决些问题的配置,它用于路径重写:</p>
<pre><code class="hljs language-jsx" lang="jsx"> <span class="hljs-attr">pathRewrite</span>: {
        <span class="hljs-comment">//重写路径</span>
        <span class="hljs-string">'^/'</span>: <span class="hljs-string">'http://127.0.0.1:3010/realtime'</span>,
    }
</code></pre>
<p>表示把<code>/</code>替换成<code>/api/gold-price/</code>。转发后路径就是<code>http://127.0.0.1:3010/api/gold-price/realtime</code>。该字段可配可不配，取决于你的目标服务器。</p>
<p>好了，http-proxy-middleware基础使用方法介绍完毕。有不同代理需求功能可以移步看它的官方文档。</p>
<h2 data-id="heading-4">工具对比</h2>
<p>来个简单对比：</p>





















































<table><thead><tr><th>特性</th><th>http-proxy-middleware</th><th>http-proxy</th><th>nginx</th></tr></thead><tbody><tr><td>配置复杂度</td><td>中等</td><td>高</td><td>高</td></tr><tr><td>Node.js 集成</td><td>优秀</td><td>优秀</td><td>需要单独进程</td></tr><tr><td>开发便利性</td><td>优秀</td><td>良好</td><td>一般</td></tr><tr><td>性能</td><td>良好</td><td>优秀</td><td>优秀</td></tr><tr><td>WebSocket 支持</td><td>是</td><td>是</td><td>是</td></tr><tr><td>路径重写</td><td>是</td><td>有限</td><td>是</td></tr><tr><td>适用场景</td><td>轻量网关、Node 栈一体化</td><td>底层库、自定义代理逻辑</td><td>高并发、多语言、企业级网关</td></tr></tbody></table>
<p>http-proxy-middleware是http-proxy二次封装，本质是一个东西。http-proxy-middleware的存在让http-proxy更易使用。</p>
<h2 data-id="heading-5">最后</h2>
<p>通过在 Node.js 应用中集成 http-proxy-middleware 中间件，只需几行代码配置就能让多个后端服务共用 80/443 端口，实现请求分流和路由转发。相比 Nginx，这种方案配置简单、与 Node.js 深度集成、开发便利性高，特别适合流量不大的项目快速部署，避免"杀鸡用牛刀"的资源浪费。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[物品超领取损失1万事故复盘(一)]]></title>    <link>https://juejin.cn/post/7594266018303934527</link>    <guid>https://juejin.cn/post/7594266018303934527</guid>    <pubDate>2026-01-12T08:56:58.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7594266018303934527" data-draft-id="7588680081326555178" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="物品超领取损失1万事故复盘(一)"/> <meta itemprop="keywords" content="后端,Java"/> <meta itemprop="datePublished" content="2026-01-12T08:56:58.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="提前退休的java猿"/> <meta itemprop="url" content="https://juejin.cn/user/465848660928872"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            物品超领取损失1万事故复盘(一)
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/465848660928872/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    提前退休的java猿
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-12T08:56:58.000Z" title="Mon Jan 12 2026 08:56:58 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    65
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言</h2>
<blockquote>
<p>我是[<a href="https://juejin.cn/user/465848660928872" title="https://juejin.cn/user/465848660928872" target="_blank">提前退休的java猿</a>]，一名7年java开发经验的开发组长，分享工作中的各种问题！（抖音、公众号同号）</p>
</blockquote>
<p>25年12月25日上午，数据库服务器<code>CPU 100%</code>，最终导致某个物品领取业务损失1万块。如果之前有看过我文章的应该就知道 <code>CPU 100%</code> 已经不是第一出现了。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7f634a70e65f471788731c7c69700327~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5o-Q5YmN6YCA5LyR55qEamF2YeeMvw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768833548&amp;x-signature=2CWv0iO3h7WAuGFa8s%2Fn7v4%2BMPM%3D" alt="e51b9f7f7235a025d17664fbad9c3feb.png" loading="lazy"/>
今天先从代码上复盘一下，为什么数据库<code>CPU100%</code> 之后，物品就超领了❓ 首先想到的肯定是代码存在问题，今天就先看看代码上是否存在问题。</p>
<blockquote>
<p>🔈负责的同事这样说反馈的：同一个事务中先库存扣减（A操作）：update t set num = num -1 where num &gt;0 然后插入领取记录（B操作）:insert xx。<br/>
❗最终数据结果就是insert 的领取数量，大于了库存总数。所以同事就反馈A没执行，B却执行成功了非常的诡异。</p>
</blockquote>
<p>说实话到现在为止我还是有点怀疑他写的代码，数据库的原子性都被破坏了还是很恐怖的😨，今天的文章主要看看排查出事务的原子性破坏坏的问题。</p>
<p>（ps:<code>🧛🏾‍♀️这是一篇没有找到答案的技术博客</code>）</p>
<h2 data-id="heading-1">抽奖超领复盘</h2>
<p>CUP为什么飙高的这个问题今天就不是我们要排查的问题，所以代码的性能今天就不讨论了。今天主要分析物品超领的问题，到底是代码问题导致的事务失效，还是有其他地方在插入领取记录或者是做了库存回滚（插入记录又回滚）。还是真的是事务的原子性被破坏了。</p>
<blockquote>
<p>🔊环境介绍：数据库使用的国产的人大金仓，使用的是主从架构</p>
</blockquote>
<h3 data-id="heading-2">一、核心代码分析</h3>
<p>从controller 到service 的代码我都看了，本来要把这部分代码贴出来的还是算了。无限简化之后就是下面的逻辑</p>
<p><strong>controller</strong> 层代码：</p>
<pre><code class="hljs language-java" lang="java">    <span class="hljs-meta">@RedisRateLimiter(value = 100,limit = 1)</span>
    <span class="hljs-meta">@PostMapping(value = "/grabCoupon")</span>
    <span class="hljs-keyword">public</span> Res&lt;?&gt; equityClaim(<span class="hljs-meta">@RequestBody</span> GrabCouponReqEx req) {
        .........
        <span class="hljs-keyword">return</span> service.grabCouponTrans(req);
    }
</code></pre>
<p><strong>service</strong> 层代码：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Transactional(propagation = Propagation.REQUIRED,rollbackFor = RuntimeException.class)</span>
<span class="hljs-meta">@Override</span>
<span class="hljs-keyword">public</span> Result&lt;?&gt; grabCouponTrans(GrabCouponReqEx req) {
       <span class="hljs-comment">// 对所有代码进行 try，然后抛出RuntimException 让框架回滚</span>
       <span class="hljs-keyword">try</span>{
       <span class="hljs-comment">//💦当然事务中还有很多查询校验的逻辑这儿就省略了</span>
       .............................
        <span class="hljs-comment">//✅ A操作：库存扣减，这个地方对库存-1，如果更新行数大与0返回true </span>
        <span class="hljs-comment">//UPDATE t SET num =  num -1  WHERE id = #{id} AND num &gt; 0;</span>
        <span class="hljs-type">boolean</span> <span class="hljs-variable">isok</span> <span class="hljs-operator">=</span> xxDao.reduceInventoryNoCompleted(id);
        <span class="hljs-keyword">if</span> (isok) {
            <span class="hljs-comment">// ✅B操作：插入领取记录，插入成功返回 true</span>
            <span class="hljs-type">Boolean</span> <span class="hljs-variable">insetSuc</span> <span class="hljs-operator">=</span> insert(record);
            <span class="hljs-comment">// ...................... ❌HTTP 写在事务中</span>
            Result&lt;?&gt; result1 = XXHttpUtils.preExamination(claimReq);
            <span class="hljs-comment">//同步更新核销数据</span>
            <span class="hljs-keyword">if</span> (!isokDetail) {
                logger.error(<span class="hljs-string">"【反馈数据更新同步异常】"</span>);
                XXHttpUtils.saveLogsNoSupp(xx);
            }
            <span class="hljs-keyword">return</span> result;
        } 
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">"更新配置权益核销状态失败！"</span>);
    }<span class="hljs-keyword">catch</span> (Exception e){
        <span class="hljs-comment">// ❗这也是一个问题代码呀，还是用log.error("ss",e)</span>
        e.printStackTrace();
        <span class="hljs-comment">//........ redis 信息回滚操作.........</span>
        <span class="hljs-keyword">throw</span> e;
    }
}
</code></pre>
<p>基础稍微扎实一点的可以看出上面的代码逻辑是不会出现库存被扣成负数的情况，即使在高并发下，因为update By id 操作本身会进行行锁。所以在库存 =1的情况下，多个请求更新也只有一个能更新成功（更新行数=1）。</p>
<h4 data-id="heading-3">事务失效？</h4>
<ul>
<li>捕捉<code>RuntimeException</code>事务导致失效：注解上面捕捉的是<code>RuntimeException</code>，但是捕捉了Exceptioon 又抛出了。如果抛出去的异常没有继成RuntimeException，事务就会失效，也不会出现 A没执行、B却执行成功的情况。</li>
<li>❌<del>this调用insert导致事务失效</del>：这个观点我在抖音评论下面看到好几个人都这么说。这个观点是不对的，首先调用insert方法外层方法（<code>grabCouponTrans</code>）是被@Transactional标记的，并且也是通过spring管理的容器对象管理的，所以不会因为在事务方法内部进行了this调用导致这个this调用方法不在事务内。只是这个this调用的方法没有被代理，默认加入到外层方法的事务里面了。</li>
</ul>
<h4 data-id="heading-4">主从读写不一致？</h4>
<p>这个问题正常来说开启了非只读事务之后，应该读写都走的是主库。但是我debug了一下 事务的读取居然是走的从库？？</p>
<pre><code class="hljs language-js" lang="js">[<span class="hljs-number">2026</span>-<span class="hljs-number">01</span>-<span class="hljs-number">04</span> <span class="hljs-number">23</span>:<span class="hljs-number">32</span>:<span class="hljs-number">42</span>] [<span class="hljs-number">230</span>] [com.<span class="hljs-property">kingbase8</span>.<span class="hljs-property">dispatcher</span>.<span class="hljs-property">executor</span>.<span class="hljs-property">DispatchAbstractStatement</span>--&gt;executeTemplet] 
<span class="hljs-title class_">Send</span> to slave <span class="hljs-attr">session</span>: (session={com.<span class="hljs-property">kingbase8</span>.<span class="hljs-property">dispatcher</span>.<span class="hljs-property">entity</span>.<span class="hljs-property">DispatchConnection</span>@e3cc839}
url={<span class="hljs-attr">jdbc</span>:<span class="hljs-attr">kingbase8</span>:<span class="hljs-comment">//从库IP:从库port/ghbase} </span>
st={<span class="hljs-variable constant_">SELECT</span> id,..... <span class="hljs-variable constant_">FROM</span> xx_table <span class="hljs-variable constant_">WHERE</span> id = <span class="hljs-number">5099</span>} _sqlType={select})

</code></pre>
<p>然后写库又是用主库</p>
<pre><code class="hljs language-js" lang="js">[<span class="hljs-number">2026</span>-<span class="hljs-number">01</span>-<span class="hljs-number">04</span> <span class="hljs-number">23</span>:<span class="hljs-number">39</span>:<span class="hljs-number">23</span>] [<span class="hljs-number">230</span>] [com.<span class="hljs-property">kingbase8</span>.<span class="hljs-property">dispatcher</span>.<span class="hljs-property">executor</span>.<span class="hljs-property">DispatchAbstractStatement</span>--&gt;executeTemplet] 
<span class="hljs-title class_">Send</span> to master <span class="hljs-attr">session</span>: (session={com.<span class="hljs-property">kingbase8</span>.<span class="hljs-property">dispatcher</span>.<span class="hljs-property">entity</span>.<span class="hljs-property">DispatchConnection</span>@e3cc839} 
url={<span class="hljs-attr">jdbc</span>:<span class="hljs-attr">kingbase8</span>:<span class="hljs-comment">//主库iP:port/ghbase?_hostLoadRate=0} st={INSERT INTO xx_table (id....) VALUES (...........)</span>
<span class="hljs-variable constant_">RETURNING</span> <span class="hljs-string">"id"</span>} _sqlType={insert or <span class="hljs-keyword">delete</span> or update})
</code></pre>
<blockquote>
<p>我以为这就是问题源头了😱，事务里面得查询会走从库。当我继续debug得时候，发现在执行事务注解标记得方法时候，如果没有执行<code>更新SQL（DML）</code>那么查询就一直走从库，直到执行更新数据SQL（DML）的时候，后面的查询也都走主库了。</p>
</blockquote>
<h3 data-id="heading-5">二、异常日志分析</h3>
<h4 data-id="heading-6">1. Couldn't commit jdbc connection. FATAL: terminating connection due to conflict with recovery(偶尔出现任何业务)</h4>
<p>这个异常时还没到业务高峰的时候，这个问题就是<code>Quartz</code>在维护内部状态的时候出现的报错。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-number">2025</span>-<span class="hljs-number">12</span>-<span class="hljs-number">25</span> <span class="hljs-number">01</span>:<span class="hljs-number">01</span>:<span class="hljs-number">01</span><span class="hljs-number">.581</span> [<span class="hljs-title class_">QuartzScheduler</span>_MyScheduler-cdszgh-szhpt-41766404430759_ClusterManager] <span class="hljs-variable constant_">ERROR</span> o.<span class="hljs-property">s</span>.<span class="hljs-property">s</span>.<span class="hljs-property">q</span>.<span class="hljs-property">LocalDataSourceJobStore</span> - [manage,<span class="hljs-number">3941</span>] - <span class="hljs-title class_">ClusterManager</span>: <span class="hljs-title class_">Error</span> managing <span class="hljs-attr">cluster</span>: <span class="hljs-title class_">Couldn</span><span class="hljs-string">'t commit jdbc connection. FATAL: terminating connection due to conflict with recovery
  Detail: User was holding a relation lock for too long.
  Hint: In a moment you should be able to reconnect to the database and repeat your command.
org.quartz.JobPersistenceException: Couldn'</span>t commit jdbc connection. <span class="hljs-attr">FATAL</span>: terminating connection due to conflict <span class="hljs-keyword">with</span> recovery
  <span class="hljs-title class_">Detail</span>: <span class="hljs-title class_">User</span> was holding a relation lock <span class="hljs-keyword">for</span> too long.
  <span class="hljs-title class_">Hint</span>: <span class="hljs-title class_">In</span> a moment you should be able to reconnect to the database and repeat your command.
	at org.<span class="hljs-property">quartz</span>.<span class="hljs-property">impl</span>.<span class="hljs-property">jdbcjobstore</span>.<span class="hljs-property">JobStoreSupport</span>.<span class="hljs-title function_">commitConnection</span>(<span class="hljs-title class_">JobStoreSupport</span>.<span class="hljs-property">java</span>:<span class="hljs-number">3749</span>)
	at org.<span class="hljs-property">quartz</span>.<span class="hljs-property">impl</span>.<span class="hljs-property">jdbcjobstore</span>.<span class="hljs-property">JobStoreSupport</span>.<span class="hljs-title function_">doCheckin</span>(<span class="hljs-title class_">JobStoreSupport</span>.<span class="hljs-property">java</span>:<span class="hljs-number">3331</span>)
	at org.<span class="hljs-property">quartz</span>.<span class="hljs-property">impl</span>.<span class="hljs-property">jdbcjobstore</span>.<span class="hljs-property">JobStoreSupport$ClusterManager</span>.<span class="hljs-title function_">manage</span>(<span class="hljs-title class_">JobStoreSupport</span>.<span class="hljs-property">java</span>:<span class="hljs-number">3935</span>)
	at org.<span class="hljs-property">quartz</span>.<span class="hljs-property">impl</span>.<span class="hljs-property">jdbcjobstore</span>.<span class="hljs-property">JobStoreSupport$ClusterManager</span>.<span class="hljs-title function_">run</span>(<span class="hljs-title class_">JobStoreSupport</span>.<span class="hljs-property">java</span>:<span class="hljs-number">3972</span>)
</code></pre>
<h5 data-id="heading-7">✔原因分析</h5>
<p>PostgreSQL 数据库因为检测到  <strong>"relation lock 持有时间过长"</strong>  而主动终止了连接。这是 PostgreSQL 在<strong>主从复制（流复制）或恢复模式</strong>下的一种保护机制。</p>
<p>💦引发这个问题的原因可能是：PostgreSQL 备机恢复压力大、<strong>网络延迟</strong> 导致复制缓慢、数据库服务器资源不足</p>
<ol>
<li>
<p><strong>PostgreSQL 恢复冲突处理</strong></p>
<ul>
<li>当 PostgreSQL 备机正在执行 WAL 恢复时</li>
<li>如果有长时间的事务锁定了某些表（relation lock）</li>
<li>主从同步可能会被阻塞</li>
<li>为了确保数据一致性，PostgreSQL 会强制终止持有锁过长的会话</li>
</ul>
</li>
<li>
<p><strong>Quartz 集群管理机制</strong></p>
<ul>
<li><code>ClusterManager</code> 线程定期检查集群状态（默认每 15-30 秒）</li>
<li>需要获取数据库锁来维护集群一致性</li>
<li>如果这个操作耗时过长，就会触发 PostgreSQL 的保护机制</li>
</ul>
</li>
</ol>
<h4 data-id="heading-8">2.org.apache.catalina.connector.ClientAbortException: java.io.IOException: 断开的管道（各业务频繁出现）</h4>
<p>这个问题出现在了数据库服务器CPU已经是拉满的状态了，应该是用户的请求已经开始阻塞了</p>
<pre><code class="hljs language-js" lang="js">org.<span class="hljs-property">apache</span>.<span class="hljs-property">catalina</span>.<span class="hljs-property">connector</span>.<span class="hljs-property">ClientAbortException</span>: java.<span class="hljs-property">io</span>.<span class="hljs-property">IOException</span>: 断开的管道
	at org.<span class="hljs-property">apache</span>.<span class="hljs-property">catalina</span>.<span class="hljs-property">connector</span>.<span class="hljs-property">OutputBuffer</span>.<span class="hljs-title function_">realWriteBytes</span>(<span class="hljs-title class_">OutputBuffer</span>.<span class="hljs-property">java</span>:<span class="hljs-number">342</span>)
	at org.<span class="hljs-property">apache</span>.<span class="hljs-property">catalina</span>.<span class="hljs-property">connector</span>.<span class="hljs-property">OutputBuffer</span>.<span class="hljs-title function_">flushByteBuffer</span>(<span class="hljs-title class_">OutputBuffer</span>.<span class="hljs-property">java</span>:<span class="hljs-number">777</span>)
	at org.<span class="hljs-property">apache</span>.<span class="hljs-property">catalina</span>.<span class="hljs-property">connector</span>.<span class="hljs-property">OutputBuffer</span>.<span class="hljs-title function_">append</span>(<span class="hljs-title class_">OutputBuffer</span>.<span class="hljs-property">java</span>:<span class="hljs-number">674</span>)
	at org.<span class="hljs-property">apache</span>.<span class="hljs-property">catalina</span>.<span class="hljs-property">connector</span>.<span class="hljs-property">OutputBuffer</span>.<span class="hljs-title function_">writeBytes</span>(<span class="hljs-title class_">OutputBuffer</span>.<span class="hljs-property">java</span>:<span class="hljs-number">377</span>)
	at org.<span class="hljs-property">apache</span>.<span class="hljs-property">catalina</span>.<span class="hljs-property">connector</span>.<span class="hljs-property">OutputBuffer</span>.<span class="hljs-title function_">write</span>(<span class="hljs-title class_">OutputBuffer</span>.<span class="hljs-property">java</span>:<span class="hljs-number">355</span>)
	at org.<span class="hljs-property">apache</span>.<span class="hljs-property">catalina</span>.<span class="hljs-property">connector</span>.<span class="hljs-property">CoyoteOutputStream</span>.<span class="hljs-title function_">write</span>(<span class="hljs-title class_">CoyoteOutputStream</span>.<span class="hljs-property">java</span>:<span class="hljs-number">101</span>)
	at .......................
	at......................... com.<span class="hljs-property">fasterxml</span>.<span class="hljs-property">jackson</span>.<span class="hljs-property">databind</span>.<span class="hljs-property">ser</span>.<span class="hljs-property">std</span>.<span class="hljs-property">BeanSerializerBase</span>.<span class="hljs-title function_">serializeFields</span>(<span class="hljs-title class_">BeanSerializerBase</span>.<span class="hljs-property">java</span>:<span class="hljs-number">774</span>)
	at com.<span class="hljs-property">fasterxml</span>.<span class="hljs-property">jackson</span>.<span class="hljs-property">databind</span>.<span class="hljs-property">ser</span>.<span class="hljs-property">BeanSerializer</span>.<span class="hljs-title function_">serialize</span>(<span class="hljs-title class_">BeanSerializer</span>.<span class="hljs-property">java</span>:<span class="hljs-number">178</span>)
	at com.<span class="hljs-property">fasterxml</span>.<span class="hljs-property">jackson</span>.<span class="hljs-property">databind</span>.<span class="hljs-property">ser</span>.<span class="hljs-property">DefaultSerializerProvider</span>.<span class="hljs-title function_">_serialize</span>(<span class="hljs-title class_">DefaultSerializerProvider</span>.<span class="hljs-property">java</span>:<span class="hljs-number">480</span>)
	at com.<span class="hljs-property">fasterxml</span>.<span class="hljs-property">jackson</span>.<span class="hljs-property">databind</span>.<span class="hljs-property">ser</span>.<span class="hljs-property">DefaultSerializerProvider</span>.<span class="hljs-title function_">serializeValue</span>(<span class="hljs-title class_">DefaultSerializerProvider</span>.<span class="hljs-property">java</span>:<span class="hljs-number">319</span>)
	at com.<span class="hljs-property">fasterxml</span>.<span class="hljs-property">jackson</span>.<span class="hljs-property">databind</span>.<span class="hljs-property">ObjectWriter$Prefetch</span>.<span class="hljs-title function_">serialize</span>(<span class="hljs-title class_">ObjectWriter</span>.<span class="hljs-property">java</span>:<span class="hljs-number">1518</span>)
	at com.<span class="hljs-property">fasterxml</span>.<span class="hljs-property">jackson</span>.<span class="hljs-property">databind</span>.<span class="hljs-property">ObjectWriter</span>.<span class="hljs-title function_">writeValue</span>(<span class="hljs-title class_">ObjectWriter</span>.<span class="hljs-property">java</span>:<span class="hljs-number">1007</span>)
</code></pre>
<h5 data-id="heading-9">✔原因分析</h5>
<p><strong>这是正常的用户行为导致的异常</strong>，不是程序bug。应该优雅处理而不是报ERROR日志，避免日志文件被这类无关紧要的错误信息淹没。</p>
<h4 data-id="heading-10">3.Cause: java.sql.SQLException: Send to master from switch slave retry failare maxtimes still SQLException: FATAL: terminating connection due to administrator command（各业务频繁出现）</h4>
<p>这个报错也是集中出现在CPU拉满的情况，导致很多查询就直接报错了</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-title class_">Cause</span>: java.<span class="hljs-property">sql</span>.<span class="hljs-property">SQLException</span>: <span class="hljs-title class_">Send</span> to master <span class="hljs-keyword">from</span> <span class="hljs-keyword">switch</span> slave retry failare maxtimes still <span class="hljs-title class_">SQLException</span>: <span class="hljs-attr">FATAL</span>: terminating connection due to administrator command
; <span class="hljs-title class_">Send</span> to master <span class="hljs-keyword">from</span> <span class="hljs-keyword">switch</span> slave retry failare maxtimes still <span class="hljs-title class_">SQLException</span>: <span class="hljs-attr">FATAL</span>: terminating connection due to administrator command; nested exception is java.<span class="hljs-property">sql</span>.<span class="hljs-property">SQLException</span>: <span class="hljs-title class_">Send</span> to master <span class="hljs-keyword">from</span> <span class="hljs-keyword">switch</span> slave retry failare maxtimes still <span class="hljs-title class_">SQLException</span>: <span class="hljs-attr">FATAL</span>: terminating connection due to administrator command
	at org.<span class="hljs-property">springframework</span>.<span class="hljs-property">jdbc</span>.<span class="hljs-property">support</span>.<span class="hljs-property">SQLStateSQLExceptionTranslator</span>.<span class="hljs-title function_">doTranslate</span>(<span class="hljs-title class_">SQLStateSQLExceptionTranslator</span>.<span class="hljs-property">java</span>:<span class="hljs-number">107</span>)
	at org.<span class="hljs-property">springframework</span>.<span class="hljs-property">jdbc</span>.<span class="hljs-property">support</span>.<span class="hljs-property">AbstractFallbackSQLExceptionTranslator</span>.<span class="hljs-title function_">translate</span>(<span class="hljs-title class_">AbstractFallbackSQLExceptionTranslator</span>.<span class="hljs-property">java</span>:<span class="hljs-number">70</span>)
	at org.<span class="hljs-property">springframework</span>.<span class="hljs-property">jdbc</span>.<span class="hljs-property">support</span>.<span class="hljs-property">AbstractFallbackSQLExceptionTranslator</span>.<span class="hljs-title function_">translate</span>(<span class="hljs-title class_">AbstractFallbackSQLExceptionTranslator</span>.<span class="hljs-property">java</span>:<span class="hljs-number">79</span>)
	at org.<span class="hljs-property">springframework</span>.<span class="hljs-property">jdbc</span>.<span class="hljs-property">support</span>.<span class="hljs-property">AbstractFallbackSQLExceptionTranslator</span>.<span class="hljs-title function_">translate</span>(<span class="hljs-title class_">AbstractFallbackSQLExceptionTranslator</span>.<span class="hljs-property">java</span>:<span class="hljs-number">79</span>)
	at org.<span class="hljs-property">mybatis</span>.<span class="hljs-property">spring</span>.<span class="hljs-property">MyBatisExceptionTranslator</span>.<span class="hljs-title function_">translateExceptionIfPossible</span>(<span class="hljs-title class_">MyBatisExceptionTranslator</span>.<span class="hljs-property">java</span>:<span class="hljs-number">91</span>)
	at org.<span class="hljs-property">mybatis</span>.<span class="hljs-property">spring</span>.<span class="hljs-property">SqlSessionTemplate$SqlSessionInterceptor</span>.<span class="hljs-title function_">invoke</span>(<span class="hljs-title class_">SqlSessionTemplate</span>.<span class="hljs-property">java</span>:<span class="hljs-number">441</span>)
	at com.<span class="hljs-property">sun</span>.<span class="hljs-property">proxy</span>.<span class="hljs-property">$Proxy177</span>.<span class="hljs-title function_">selectList</span>(<span class="hljs-title class_">Unknown</span> <span class="hljs-title class_">Source</span>)
	at org.<span class="hljs-property">mybatis</span>.<span class="hljs-property">spring</span>.<span class="hljs-property">SqlSessionTemplate</span>.<span class="hljs-title function_">selectList</span>(<span class="hljs-title class_">SqlSessionTemplate</span>.<span class="hljs-property">java</span>:<span class="hljs-number">224</span>)
	at com.<span class="hljs-property">baomidou</span>.<span class="hljs-property">mybatisplus</span>.<span class="hljs-property">core</span>.<span class="hljs-property">override</span>.<span class="hljs-property">MybatisMapperMethod</span>.<span class="hljs-title function_">executeForMany</span>(<span class="hljs-title class_">MybatisMapperMethod</span>.<span class="hljs-property">java</span>:<span class="hljs-number">166</span>)
	at com.<span class="hljs-property">baomidou</span>.<span class="hljs-property">mybatisplus</span>.<span class="hljs-property">core</span>.<span class="hljs-property">override</span>.<span class="hljs-property">MybatisMapperMethod</span>.<span class="hljs-title function_">execute</span>(<span class="hljs-title class_">MybatisMapperMethod</span>.<span class="hljs-property">java</span>:<span class="hljs-number">77</span>)
	at com.<span class="hljs-property">baomidou</span>.<span class="hljs-property">mybatisplus</span>.<span class="hljs-property">core</span>.<span class="hljs-property">override</span>.<span class="hljs-property">MybatisMapperProxy$PlainMethodInvoker</span>.<span class="hljs-title function_">invoke</span>(<span class="hljs-title class_">MybatisMapperProxy</span>.<span class="hljs-property">java</span>:<span class="hljs-number">148</span>)
	at com.<span class="hljs-property">baomidou</span>.<span class="hljs-property">mybatisplus</span>.<span class="hljs-property">core</span>.<span class="hljs-property">override</span>.<span class="hljs-property">MybatisMapperProxy</span>.<span class="hljs-title function_">invoke</span>(<span class="hljs-title class_">MybatisMapperProxy</span>.<span class="hljs-property">java</span>:<span class="hljs-number">89</span>)
	at com.<span class="hljs-property">sun</span>.<span class="hljs-property">proxy</span>.<span class="hljs-property">$Proxy386</span>.<span class="hljs-title function_">findStatisticsVoByActivityIdList</span>(<span class="hljs-title class_">Unknown</span> <span class="hljs-title class_">Source</span>)
	at 
...................业务代码方法的一些方法栈信息(省略).............................................
</code></pre>
<h5 data-id="heading-11">✔原因分析</h5>
<ul>
<li>从库延迟严重，查询超时</li>
<li>主库负载过高，无法处理请求</li>
<li><strong>网络问题</strong>导致连接不稳定</li>
<li>数据库管理员执行了维护操作（如：重启、kill连接、数据库自动kill长时间运行的查询）</li>
</ul>
<blockquote>
<p>❗错误："terminating connection due to administrator command"
→ DBA可能执行了：SELECT pg_terminate_backend(pid);
→ 或数据库自动kill了长时间运行的查询</p>
</blockquote>
<h4 data-id="heading-12">4. java.net.SocketTimeoutException: Read timed out（各业务频繁出现）</h4>
<p>在CPU拉满的情况下出现大量的<code>read timed out</code>读取数据库响应的时候就超时了。
在业务低峰的时候<code>commit</code> 事务的时候也出现过这个问题，增加socket超时时间可以降低这个错误的发生。</p>
<p>下面的select语句也是 领取事务中的 更新数据前的一些前置查询SQL</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-number">2025</span>-<span class="hljs-number">12</span>-<span class="hljs-number">25</span> <span class="hljs-number">10</span>:<span class="hljs-number">50</span>:<span class="hljs-number">12.101</span> [http-nio-<span class="hljs-number">8077</span>-exec-<span class="hljs-number">78</span>] <span class="hljs-variable constant_">ERROR</span> druid.<span class="hljs-property">sql</span>.<span class="hljs-property">Statement</span> - [statementLogError,<span class="hljs-number">148</span>] - {conn-<span class="hljs-number">10567</span>, pstmt-<span class="hljs-number">277353</span>} execute error.
<span class="hljs-variable constant_">SELECT</span> * <span class="hljs-keyword">from</span> 待领取的物品数据
com.<span class="hljs-property">kingbase8</span>.<span class="hljs-property">util</span>.<span class="hljs-property">KSQLException</span>: <span class="hljs-title class_">An</span> I/O error occurred <span class="hljs-keyword">while</span> sending to the backend.
	at com.<span class="hljs-property">xx</span>.<span class="hljs-property">core</span>.<span class="hljs-property">v3</span>.<span class="hljs-property">QueryExecutorImpl</span>.<span class="hljs-title function_">execute</span>(<span class="hljs-title class_">QueryExecutorImpl</span>.<span class="hljs-property">java</span>:<span class="hljs-number">428</span>)
	at com.<span class="hljs-property">xx</span>.<span class="hljs-property">jdbc</span>.<span class="hljs-property">KbStatement</span>.<span class="hljs-title function_">executeInternal_</span>(<span class="hljs-title class_">KbStatement</span>.<span class="hljs-property">java</span>:<span class="hljs-number">784</span>)
	at com.<span class="hljs-property">xx</span>.<span class="hljs-property">jdbc</span>.<span class="hljs-property">KbStatement</span>.<span class="hljs-title function_">execute</span>(<span class="hljs-title class_">KbStatement</span>.<span class="hljs-property">java</span>:<span class="hljs-number">676</span>)
	at com.<span class="hljs-property">kingbase8</span>.<span class="hljs-property">jdbc</span>.<span class="hljs-property">KbPreparedStatement</span>.<span class="hljs-title function_">executeWithFlags</span>(<span class="hljs-title class_">KbPreparedStatement</span>.<span class="hljs-property">java</span>:<span class="hljs-number">286</span>)
	at com.<span class="hljs-property">xx</span>.<span class="hljs-property">jdbc</span>.<span class="hljs-property">KbPreparedStatement</span>.<span class="hljs-title function_">execute</span>(<span class="hljs-title class_">KbPreparedStatement</span>.<span class="hljs-property">java</span>:<span class="hljs-number">265</span>)
        
        <span class="hljs-title class_">Caused</span> <span class="hljs-attr">by</span>: java.<span class="hljs-property">net</span>.<span class="hljs-property">SocketTimeoutException</span>: <span class="hljs-title class_">Read</span> timed out
	at java.<span class="hljs-property">net</span>.<span class="hljs-property">SocketInputStream</span>.<span class="hljs-title function_">socketRead0</span>(<span class="hljs-title class_">Native</span> <span class="hljs-title class_">Method</span>)
	at java.<span class="hljs-property">net</span>.<span class="hljs-property">SocketInputStream</span>.<span class="hljs-title function_">socketRead</span>(<span class="hljs-title class_">SocketInputStream</span>.<span class="hljs-property">java</span>:<span class="hljs-number">116</span>)
	at java.<span class="hljs-property">net</span>.<span class="hljs-property">SocketInputStream</span>.<span class="hljs-title function_">read</span>(<span class="hljs-title class_">SocketInputStream</span>.<span class="hljs-property">java</span>:<span class="hljs-number">171</span>)
	at java.<span class="hljs-property">net</span>.<span class="hljs-property">SocketInputStream</span>.<span class="hljs-title function_">read</span>(<span class="hljs-title class_">SocketInputStream</span>.<span class="hljs-property">java</span>:<span class="hljs-number">141</span>)
	at com.<span class="hljs-property">xx</span>.<span class="hljs-property">core</span>.<span class="hljs-property">VisibleBufferedInputStream</span>.<span class="hljs-title function_">readMore</span>(<span class="hljs-title class_">VisibleBufferedInputStream</span>.<span class="hljs-property">java</span>:<span class="hljs-number">210</span>)
</code></pre>
<h5 data-id="heading-13">✔原因分析</h5>
<p>这个问题以前也是一直都存在的，CPU空闲的也会出现这个问题，现在CPU打满之后就出现大量的请求</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0eee73d829774b48ae617cb22d309021~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5o-Q5YmN6YCA5LyR55qEamF2YeeMvw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768833548&amp;x-signature=x3LJNgKdRKgp%2Fgm5%2BLtJHGHwVFw%3D" alt="4dc309fe-0ecf-49dd-afa7-dc022f64aae0.png" loading="lazy"/></p>
<h4 data-id="heading-14">5.💢om.kingbase8.util.KSQLException: This _connection has been closed.（各业务频繁出现）</h4>
<p>这个错是比较关键的错误了！涉及报错的SQL基本就是我们领取物品事务中的SQL了。在日志文件中在CPU打满这段时间内出现得非常之多。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-number">2025</span>-<span class="hljs-number">12</span>-<span class="hljs-number">25</span> <span class="hljs-number">10</span>:<span class="hljs-number">49</span>:<span class="hljs-number">56.569</span> [http-nio-<span class="hljs-number">8077</span>-exec-<span class="hljs-number">41</span>] <span class="hljs-variable constant_">ERROR</span> druid.<span class="hljs-property">sql</span>.<span class="hljs-property">Statement</span> - 
[statementLogError,<span class="hljs-number">148</span>] - {conn-<span class="hljs-number">10529</span>, pstmt-<span class="hljs-number">276494</span>} execute error. 
<span class="hljs-variable constant_">INSERT</span> <span class="hljs-variable constant_">INTO</span> xx_lottery_xx (xx, xx, xx,) <span class="hljs-variable constant_">VALUES</span> (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
com.<span class="hljs-property">xx</span>.<span class="hljs-property">util</span>.<span class="hljs-property">KSQLException</span>: <span class="hljs-title class_">This</span> _connection has been closed.
	at com.<span class="hljs-property">xx</span>.<span class="hljs-property">jdbc</span>.<span class="hljs-property">KbConnection</span>.<span class="hljs-title function_">checkIsClosed</span>(<span class="hljs-title class_">KbConnection</span>.<span class="hljs-property">java</span>:<span class="hljs-number">1401</span>)
	at com.<span class="hljs-property">xx</span>.<span class="hljs-property">jdbc</span>.<span class="hljs-property">KbConnection</span>.<span class="hljs-title function_">getAutoCommit</span>(<span class="hljs-title class_">KbConnection</span>.<span class="hljs-property">java</span>:<span class="hljs-number">1329</span>)
	at com.<span class="hljs-property">xx</span>.<span class="hljs-property">jdbc</span>.<span class="hljs-property">KbStatement</span>.<span class="hljs-title function_">executeInternal_</span>(<span class="hljs-title class_">KbStatement</span>.<span class="hljs-property">java</span>:<span class="hljs-number">735</span>)
	at com.<span class="hljs-property">xx</span>.<span class="hljs-property">jdbc</span>.<span class="hljs-property">KbStatement</span>.<span class="hljs-title function_">execute</span>(<span class="hljs-title class_">KbStatement</span>.<span class="hljs-property">java</span>:<span class="hljs-number">676</span>)
	at com.<span class="hljs-property">xx</span>.<span class="hljs-property">jdbc</span>.<span class="hljs-property">KbPreparedStatement</span>.<span class="hljs-title function_">executeWithFlags</span>(<span class="hljs-title class_">KbPreparedStatement</span>.<span class="hljs-property">jav</span>
        
        ........<span class="hljs-property">insert</span> 领取记录..............................
        <span class="hljs-variable constant_">ERROR</span> c.<span class="hljs-property">a</span>.<span class="hljs-property">d</span>.<span class="hljs-property">p</span>.<span class="hljs-property">DruidDataSource</span> - [recycle,<span class="hljs-number">2146</span>] - recycle error
com.<span class="hljs-property">xx</span>.<span class="hljs-property">util</span>.<span class="hljs-property">KSQLException</span>: <span class="hljs-title class_">This</span> _connection has been closed.
	at com.<span class="hljs-property">xx</span>.<span class="hljs-property">jdbc</span>.<span class="hljs-property">KbConnection</span>.<span class="hljs-title function_">checkIsClosed</span>(<span class="hljs-title class_">KbConnection</span>.<span class="hljs-property">java</span>:<span class="hljs-number">1401</span>)
	at com.<span class="hljs-property">xx</span>.<span class="hljs-property">jdbc</span>.<span class="hljs-property">KbConnection</span>.<span class="hljs-title function_">setAutoCommit</span>(<span class="hljs-title class_">KbConnection</span>.<span class="hljs-property">java</span>:<span class="hljs-number">1288</span>)
	at com.<span class="hljs-property">xx</span>.<span class="hljs-property">dispatcher</span>.<span class="hljs-property">entity</span>.<span class="hljs-property">DispatchConnection</span>.<span class="hljs-title function_">setAutoCommit</span>(<span class="hljs-title class_">DispatchConnection</span>.<span class="hljs-property">java</span>:<span class="hljs-number">1115</span>)
	at com.<span class="hljs-property">alibaba</span>.<span class="hljs-property">druid</span>.<span class="hljs-property">filter</span>.<span class="hljs-property">FilterChainImpl</span>.<span class="hljs-title function_">connection_setAutoCommit</span>(<span class="hljs-title class_">FilterChainImpl</span>.<span class="hljs-property">java</span>:<span class="hljs-number">699</span>)
	at com.<span class="hljs-property">alibaba</span>.<span class="hljs-property">druid</span>.<span class="hljs-property">filter</span>.<span class="hljs-property">logging</span>.<span class="hljs-property">LogFilter</span>.<span class="hljs-title function_">connection_setAutoCommit</span>(<span class="hljs-title class_">LogFilter</span>.<span class="hljs-property">java</span>:<span class="hljs-number">467</span>)
	at com.<span class="hljs-property">alibaba</span>.<span class="hljs-property">druid</span>.<span class="hljs-property">filter</span>.<span class="hljs-property">FilterChainImpl</span>.<span class="hljs-title function_">connection_setAutoCommit</span>(<span class="hljs-title class_">FilterChainImpl</span>.<span class="hljs-property">java</span>:<span class="hljs-number">694</span>)
	at com.<span class="hljs-property">alibaba</span>.<span class="hljs-property">druid</span>.<span class="hljs-property">filter</span>.<span class="hljs-property">FilterAdapter</span>.<span class="hljs-title function_">connection_setAutoCommit</span>(<span class="hljs-title class_">FilterAdapter</span>.<span class="hljs-property">java</span>:<span class="hljs-number">964</span>)
	at com.<span class="hljs-property">alibaba</span>.<span class="hljs-property">druid</span>.<span class="hljs-property">filter</span>.<span class="hljs-property">FilterChainImpl</span>.<span class="hljs-title function_">connection_setAutoCommit</span>(<span class="hljs-title class_">FilterChainImpl</span>.<span class="hljs-property">java</span>:<span class="hljs-number">694</span>)
	at com.<span class="hljs-property">alibaba</span>.<span class="hljs-property">druid</span>.<span class="hljs-property">proxy</span>.<span class="hljs-property">jdbc</span>.<span class="hljs-property">ConnectionProxyImpl</span>.<span class="hljs-title function_">setAutoCommit</span>(<span class="hljs-title class_">ConnectionProxyImpl</span>.<span class="hljs-property">java</span>:<span class="hljs-number">416</span>)
	at com.<span class="hljs-property">alibaba</span>.<span class="hljs-property">druid</span>.<span class="hljs-property">pool</span>.<span class="hljs-property">DruidConnectionHolder</span>.<span class="hljs-title function_">reset</span>(<span class="hljs-title class_">DruidConnectionHolder</span>.<span class="hljs-property">java</span>:<span class="hljs-number">387</span>)
	at com.<span class="hljs-property">alibaba</span>.<span class="hljs-property">druid</span>.<span class="hljs-property">pool</span>.<span class="hljs-property">DruidDataSource</span>.<span class="hljs-title function_">recycle</span>(<span class="hljs-title class_">DruidDataSource</span>.<span class="hljs-property">java</span>:<span class="hljs-number">2053</span>)
	at com.<span class="hljs-property">alibaba</span>.<span class="hljs-property">druid</span>.<span class="hljs-property">pool</span>.<span class="hljs-property">DruidPooledConnection</span>.<span class="hljs-title function_">recycle</span>(<span class="hljs-title class_">DruidPooledConnection</span>.<span class="hljs-property">java</span>:<span class="hljs-number">343</span>)
	at com.<span class="hljs-property">alibaba</span>.<span class="hljs-property">druid</span>.<span class="hljs-property">filter</span>.<span class="hljs-property">FilterChainImpl</span>.<span class="hljs-title function_">dataSource_recycle</span>(<span class="hljs-title class_">FilterChainImpl</span>.<span class="hljs-property">java</span>:<span class="hljs-number">5047</span>)
        
<span class="hljs-number">2025</span>-<span class="hljs-number">12</span>-<span class="hljs-number">25</span> <span class="hljs-number">10</span>:<span class="hljs-number">44</span>:<span class="hljs-number">22.908</span> [http-nio-<span class="hljs-number">8077</span>-exec-<span class="hljs-number">149</span>] <span class="hljs-variable constant_">ERROR</span> o.<span class="hljs-property">s</span>.<span class="hljs-property">t</span>.<span class="hljs-property">i</span>.<span class="hljs-property">TransactionInterceptor</span> - 
[completeTransactionAfterThrowing,<span class="hljs-number">680</span>] - <span class="hljs-title class_">Application</span> exception overridden by rollback exception
</code></pre>
<h5 data-id="heading-15">✔原因分析</h5>
<p>和上面的报错很类似，只是在插入数据的时候发现连接断开了，这时候回滚也是没办法的。</p>
<h3 data-id="heading-16">三、数据库日志分析</h3>
<p>这个日志文件是我们部门经理发出来的，什么级别的日志咱也不知道，应该是记录的慢SQL的吧或者报错SQL日志的吧。</p>
<p>直接看业务高峰时数据库的异常日志,就只看领取事务中相关SQL的日志</p>
<h4 data-id="heading-17">情况一：</h4>
<p>【1817689】数据库后端进程ID ，当前事务的就只有库存扣减的日志，执行完扣减之后就 直接出现 <code>unexpected EOF</code>
（没有@Transactional 方法 中更新库存前的查询的日志说明查询是走了从库）</p>
<p>而且这个【1817689】进程在抛错之后，在日志文件中的下文就没有收到这个进程了（执行了库存扣减然后就直接报错被销毁了❓）</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-number">2025</span>-<span class="hljs-number">12</span>-<span class="hljs-number">25</span> <span class="hljs-number">10</span>:<span class="hljs-number">26</span>:<span class="hljs-number">08.825</span> <span class="hljs-variable constant_">CST</span> [<span class="hljs-number">1817689</span>] <span class="hljs-attr">LOG</span>:<span class="hljs-attr">duration</span>: <span class="hljs-number">3538.580</span> ms  execute &lt;unnamed&gt;:
<span class="hljs-variable constant_">UPDATE</span> xx <span class="hljs-variable constant_">SET</span> ...(库存扣减<span class="hljs-variable constant_">SQL</span>)
<span class="hljs-number">2025</span>-<span class="hljs-number">12</span>-<span class="hljs-number">25</span> <span class="hljs-number">10</span>:<span class="hljs-number">26</span>:<span class="hljs-number">08.825</span> <span class="hljs-variable constant_">CST</span> [<span class="hljs-number">1817689</span>] <span class="hljs-attr">DETAIL</span>:  <span class="hljs-attr">parameters</span>: $1 = <span class="hljs-string">'12783'</span>
<span class="hljs-number">2025</span>-<span class="hljs-number">12</span>-<span class="hljs-number">25</span> <span class="hljs-number">10</span>:<span class="hljs-number">26</span>:<span class="hljs-number">08.825</span> <span class="hljs-variable constant_">CST</span> [<span class="hljs-number">1817689</span>] <span class="hljs-attr">LOG</span>:  
unexpected <span class="hljs-variable constant_">EOF</span> on client connection <span class="hljs-keyword">with</span> an open transaction
</code></pre>
<h4 data-id="heading-18">情况二：</h4>
<p>[1872365] 日志中搜索[1872365]进程，只有下面两行🌚，就很奇怪，也没有报错也没有insert记录的日志。</p>
<p>当时[1872365] 进程前后都有其他日志（是不是代表这个进程进行了多次会话，对应的领取业务也是走通了的❓）</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-number">2025</span>-<span class="hljs-number">12</span>-<span class="hljs-number">25</span> <span class="hljs-number">10</span>:<span class="hljs-number">26</span>:<span class="hljs-number">31.591</span> <span class="hljs-variable constant_">CST</span> [<span class="hljs-number">1872365</span>] <span class="hljs-attr">LOG</span>:  <span class="hljs-attr">duration</span>: <span class="hljs-number">3236.489</span> ms  execute &lt;unnamed&gt;: 
<span class="hljs-variable constant_">UPDATE</span> xx <span class="hljs-variable constant_">SET</span> ...(库存扣减<span class="hljs-variable constant_">SQL</span>)
<span class="hljs-number">2025</span>-<span class="hljs-number">12</span>-<span class="hljs-number">25</span> <span class="hljs-number">10</span>:<span class="hljs-number">26</span>:<span class="hljs-number">31.591</span> <span class="hljs-variable constant_">CST</span> [<span class="hljs-number">1872365</span>] <span class="hljs-attr">DETAIL</span>:  <span class="hljs-attr">parameters</span>: $1 = <span class="hljs-string">'12786'</span>
</code></pre>
<p>🎃完全看不懂这个日志了，被<code>@Transactional</code> 标记的方法正常逻辑是 库存扣减、然后插入领取记录。但是这个数据库日志只有库存扣减的日志。</p>
<h3 data-id="heading-19">四、错误日志归纳总结分析</h3>
<p><strong>应用程序的错误日志</strong>（库存扣减出现两次报错）：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-number">1.</span> <span class="hljs-number">2025</span>-<span class="hljs-number">12</span>-<span class="hljs-number">25</span> <span class="hljs-number">10</span>:<span class="hljs-number">26</span>:<span class="hljs-number">51.730</span> 库存扣减异常（<span class="hljs-title class_">This</span> _connection has been closed.）程序发起回滚失败（ [completeTransactionAfterThrowing,<span class="hljs-number">680</span>] - <span class="hljs-title class_">Application</span> exception overridden by rollback exception）
<span class="hljs-number">2.</span> <span class="hljs-number">2025</span>-<span class="hljs-number">12</span>-<span class="hljs-number">25</span> <span class="hljs-number">10</span>:<span class="hljs-number">28</span>:<span class="hljs-number">28.297</span> 库存扣减异常同上
</code></pre>
<p><strong>数据库日志</strong>（库存扣减出现两次日志）一次：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-number">1.</span> <span class="hljs-number">2025</span>-<span class="hljs-number">12</span>-<span class="hljs-number">25</span> <span class="hljs-number">10</span>:<span class="hljs-number">26</span>:<span class="hljs-number">08.825</span> <span class="hljs-variable constant_">CST</span> [<span class="hljs-number">1817689</span>] <span class="hljs-attr">LOG</span>:<span class="hljs-attr">duration</span>: <span class="hljs-number">3538.580</span> ms  execute &lt;unnamed&gt;:
<span class="hljs-variable constant_">UPDATE</span> xx <span class="hljs-variable constant_">SET</span> ...(库存扣减<span class="hljs-variable constant_">SQL</span>) 出现：unexpected <span class="hljs-variable constant_">EOF</span> on client connection <span class="hljs-keyword">with</span> an open transaction

<span class="hljs-number">2.</span> <span class="hljs-number">2025</span>-<span class="hljs-number">12</span>-<span class="hljs-number">25</span> <span class="hljs-number">10</span>:<span class="hljs-number">26</span>:<span class="hljs-number">31.591</span> <span class="hljs-variable constant_">CST</span> [<span class="hljs-number">1872365</span>]  <span class="hljs-attr">duration</span>: <span class="hljs-number">3236.489</span> ms
</code></pre>
<p>❌数据库的日志库存扣减的日志只有两条，但是数据库中的领取记录有很多，说明这个日志应该是只记录了部分日志。可能是记录的慢SQL😂</p>
<p>📢但是超领的数据远不止两条数据，说明这些超领的数据在执行代码的时候，也是没有抛错的，所以想要通过日志去定位问题。暂时是不行的</p>
<h2 data-id="heading-20">总结</h2>
<p>下面的代码，正常来讲不管有没有加事务，都不可能出现 库存扣减数量 大于插入记录数量。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">//✅ A操作：库存扣减，这个地方对库存-1，如果更新行数大与0返回true</span>
<span class="hljs-comment">//UPDATE t SET num = num -1 WHERE id = #{id} AND num &gt; 0;</span>
<span class="hljs-type">int</span> <span class="hljs-variable">row</span> <span class="hljs-operator">=</span> xxDao.reduceInventoryNoCompleted(id);
<span class="hljs-keyword">if</span> (row&gt;<span class="hljs-number">0</span>) {
<span class="hljs-comment">// ✅B操作：插入领取记录，插入成功返回</span>
<span class="hljs-literal">true</span> <span class="hljs-type">Boolean</span> <span class="hljs-variable">insetSuc</span> <span class="hljs-operator">=</span> insert(record);
</code></pre>
<p>从日志上应用上的日志来看，确实有事务报错，阻塞，以及不能回滚的问题，好像也不能够解释 领取的记录量大于库存总数的问题。</p>
<p>我在代码中也没有找到库存回滚+1 的代码，所以目前为止我从代码层面和日志上都不能找到到底什么问题引起的。</p>
<p>之前抖音上有网友说遇到过这个问题，因为主从延迟的问题。</p>
<p><strong>Couldn't commit jdbc connection. FATAL: terminating connection due to conflict with recovery</strong></p>
<p>这个问题，我也问了一下deepSeek，说的可能会破坏事务的原子性（可信度有待考证）</p>
<p>🙈抱歉这是一篇没有答案的技术博客，后续如果我也会持续跟进这个问题</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[工程师之夜系列分享第三十九篇：Kafka、RocketMQ、JMQ 存储架构深度对比]]></title>    <link>https://juejin.cn/post/7594576956420079642</link>    <guid>https://juejin.cn/post/7594576956420079642</guid>    <pubDate>2026-01-13T06:08:39.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7594576956420079642" data-draft-id="7594415509607301166" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="工程师之夜系列分享第三十九篇：Kafka、RocketMQ、JMQ 存储架构深度对比"/> <meta itemprop="keywords" content="程序员"/> <meta itemprop="datePublished" content="2026-01-13T06:08:39.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="京东云开发者"/> <meta itemprop="url" content="https://juejin.cn/user/2634854380340008"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            工程师之夜系列分享第三十九篇：Kafka、RocketMQ、JMQ 存储架构深度对比
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2634854380340008/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    京东云开发者
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-13T06:08:39.000Z" title="Tue Jan 13 2026 06:08:39 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读15分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>作者：毕源泉</p>
<h2 data-id="heading-0"><strong>引言</strong></h2>
<p>消息队列的存储架构是决定其可靠性、吞吐量、延迟性能的核心因素，直接影响业务场景适配能力。本文聚焦三款主流消息队列 ——Kafka（LinkedIn 开源，侧重高吞吐）、RocketMQ（阿里开源，金融级特性突出）、JMQ（京东开源，侧重高可用与灵活性），从存储模型、数据组织、索引设计等维度展开深度对比，为技术选型与架构优化提供参考。​</p>
<p>本文将从概念辨析出发，系统拆解主流存储模型与存储引擎的设计逻辑，对比 JMQ、Kafka、RocketMQ的技术选型差异与架构设计。​</p>
<h2 data-id="heading-1"><strong>一、</strong> Kafka存储架构</h2>
<h3 data-id="heading-2">1.1 核心存储模型：分区日志流</h3>
<p>﻿</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ee01ba5da3c1475592f077f908a2456c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768889319&amp;x-signature=c7Oq0C14wEkUNI8E%2FC53PX7fpBw%3D" alt="" loading="lazy"/></p>
<p>﻿﻿</p>
<p><strong>Topic - 主题</strong></p>
<p>Kafka学习了数据库里面的设计，在里面设计了topic（主题），这个东西类似于关系型数据库的表，此时我需要获取中国移动的数据，那就直接监听中国移动订阅的Topic即可。</p>
<p><strong>Partition - 分区</strong></p>
<p>Kafka还有一个概念叫Partition（分区），分区具体在服务器上面表现起初就是一个目录，一个主题下面有多个分区，这些分区会存储到不同的服务器上面，或者说，其实就是在不同的主机上建了不同的目录。这些分区主要的信息就存在了.log文件里面。跟数据库里面的分区差不多，是为了提高性能。</p>
<p>至于为什么提高了性能，很简单，多个分区多个线程，多个线程并行处理肯定会比单线程好得多。</p>
<p>Topic和partition像是HBASE里的table和region的概念，table只是一个逻辑上的概念，真正存储数据的是region，这些region会分布式地存储在各个服务器上面，对应于kafka，也是一样，<strong>Topic也是逻辑概念，而partition就是分布式存储单元。这个设计是保证了海量数据处理的基础。我们可以对比一下，如果HDFS没有block的设计，一个100T的文件也只能单独放在一个服务器上面，那就直接占满整个服务器了，引入block后，大文件可以分散存储在不同的服务器上。</strong></p>
<p><strong>注意：</strong></p>
<p>1.分区会有单点故障问题，所以我们会为每个分区设置副本数</p>
<p>2.分区的编号是从0开始的</p>
<p>﻿</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/66333a00a3d94c1185c3fb0de363a34c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768889319&amp;x-signature=rCTx8tpxHS4Xca00NsI9U2qqjps%3D" alt="" loading="lazy"/></p>
<p>﻿﻿</p>
<p>Kafka 以「主题（Topic）- 分区（Partition）」为核心组织数据，每个分区本质是一个 append-only 的日志流，消息按生产顺序追加存储，保证分区内消息有序性。​</p>
<p><strong>优点：</strong> 可以充分利用磁盘顺序读写高性能的特性。存储介质也可以选择廉价的SATA磁盘，这样可以获得更长的数据保留时间、更低的数据存储成本。</p>
<h3 data-id="heading-3">1.2 数据组织：分段日志文件</h3>
<p>•每个分区拆分为多个 Segment 文件（默认 1GB），命名格式为「起始偏移量.log」（如 00000000000000000000.log）​，做这个限制目的是为了方便把.log加载到内存去操作</p>
<p>•配套两类索引文件：.index（偏移量→物理地址映射）、.timeindex（时间戳→偏移量映射）​​</p>
<p>﻿</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/730b9896bc594900819a3c86d89efefc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768889319&amp;x-signature=ivaklGaephzfSavNgncXwrI4Uqw%3D" alt="" loading="lazy"/></p>
<p>﻿﻿</p>
<p>这个9936472之类的数字，就是代表了这个日志段文件里包含的起始offset，也就说明这个分区里至少都写入了接近1000万条数据了。</p>
<p>Kafka broker有一个参数，log.segment.bytes，限定了每个日志段文件的大小，最大就是1GB，一个日志段文件满了，就自动开一个新的日志段文件来写入，避免单个文件过大，影响文件的读写性能，这个过程叫做log rolling，正在被写入的那个日志段文件，叫做active log segment。</p>
<h3 data-id="heading-4">1.3 消息读/写过程</h3>
<p>﻿</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c84e19c96cd441e69db4281f4fe824fa~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768889319&amp;x-signature=JLf0F8dw%2BzGIXqtM%2BLD0qwIJdpg%3D" alt="" loading="lazy"/></p>
<p>﻿﻿</p>
<p><strong>写消息：</strong></p>
<p>•Index文件写入，Index文件较小，可以直接用mmap进行内存映射，避免频繁的磁盘I/O操作，提高写入性能；由于Index文件是稀疏索引，只需要记录关键位置的偏移量，因此即使使用mmap，写入的开销也相对较低。</p>
<p>•Segment文件写入，Segment文件较大，可以采用普通的写操作（FileChannel.write），由于Segment文件是顺序写入的，并且Kafka会利用操作系统的PageCache（页缓存）机制，写入操作会先写入到内存中，然后由操作系统在后台异步刷新到磁盘，可以进一步提高写入的性能。</p>
<p><strong>读消息：</strong></p>
<p>•Index文件读取，通常使用mmap方式读取，由于Index文件较小，且是稀疏索引，缺页中断的可能性较小。</p>
<p>•Segment文件读取，通常使用sendfile系统调用来实现零拷贝读取和发送，减少数据在用户空间与内核空间之间的拷贝次数，提高数据传输的效率。</p>
<h3 data-id="heading-5">1.4 关键技术</h3>
<p>Kafka 作为高性能的消息中间件，其超高吞吐量的核心秘诀之一就是<strong>深度依赖 PageCache + 顺序 I/O + mmap 内存映射</strong>的组合。</p>
<p>PageCache，中文名称为页高速缓冲存储器。它是将磁盘上的数据加载到内存中，当系统需要访问这些数据时，可以直接从内存中读取，而不必每次都去读取磁盘。这种方式显著减少了磁盘I/O操作，从而提高了系统性能。</p>
<p>mmap（Memory-mapped file）是操作系统提供的一种将<strong>磁盘文件</strong>与<strong>进程虚拟地址空间</strong>建立映射关系的核心技术，本质是让进程通过直接操作内存地址的方式读写文件，无需传统的 read/write 系统调用。核心价值在于<strong>零拷贝</strong>和<strong>内存式文件访问</strong>，尤其适合大文件、高吞吐、随机访问的场景。</p>
<p>将日志段（.log）文件映射到内存，生产者写入时直接写内存（内核异步刷盘），消费者读取时直接从内存读取，实现超高吞吐（Kafka 的 “顺序写 + mmap” 是其高性能核心）；</p>
<p>﻿</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8025311968154f9e8ca20594c637af59~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768889319&amp;x-signature=FWIUrpjyB8hG3B%2BMusGW%2Fn5KiJ4%3D" alt="" loading="lazy"/></p>
<p>﻿﻿</p>
<p>零拷贝流程示意图</p>
<p>零拷贝过程：</p>
<p>1.用户进程发起sendfile系统调用，<strong>上下文（切换1）从用户态转向内核态</strong></p>
<p>2.DMA控制器，把数据从硬盘中拷贝到内核缓冲区。</p>
<p>3.CPU将读缓冲区中数据拷贝到socket缓冲区</p>
<p>4.DMA控制器，异步把数据从socket缓冲区拷贝到网卡，</p>
<p>5.<strong>上下文（切换2）从内核态切换回用户态</strong>，sendfile调用返回。</p>
<h3 data-id="heading-6">1.5 设计优势</h3>
<p>•顺序写磁盘：Segment 文件仅追加写入，规避随机 IO，吞吐量极高（单分区可达 10 万 + TPS）​​</p>
<p>•索引轻量化：仅维护偏移量与时间戳索引，降低存储开销​</p>
<p>•副本同步：基于 ISR 机制，仅同步已提交消息，兼顾一致性与可用性</p>
<h2 data-id="heading-7">二、RocketMQ存储架构</h2>
<p>Kafka的每个Partition都是一个完整的、顺序写入的文件，但当Partition数量增多时，从操作系统的角度看，这些写入操作会变得相对随机，这可能会影响写入性能。</p>
<h3 data-id="heading-8">2.1 核心存储模型：分离式设计</h3>
<p>RocketMQ采用「CommitLog + ConsumeQueue + IndexFile」三层结构，彻底分离数据存储与索引查询：​</p>
<p>•CommitLog：全局单一日志文件（默认 1GB / 个，循环覆盖），存储所有主题的原始消息​​</p>
<p>•ConsumeQueue：按主题 - 队列维度拆分的索引文件，存储「消息物理地址 + 偏移量 + 长度」，供消费者快速查询​</p>
<p>•IndexFile：哈希索引文件，支持按消息 Key 查询</p>
<p>CommitLog：消息的原始日记本</p>
<p><strong>CommitLog</strong>是RocketMQ存储消息的物理文件，所有消息都会按到达顺序写入这个文件。你可以把它想象成一本不断追加的日记本——每条消息都是按时间顺序记录的新日记。</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// 消息存储的核心逻辑简化示例（非源码）</span>
 public void <span class="hljs-built_in">putMessage</span>(Message message) {
     <span class="hljs-comment">// 1. 将消息序列化为字节数组</span>
     byte<span class="hljs-selector-attr">[]</span> data = <span class="hljs-built_in">serialize</span>(message);
     <span class="hljs-comment">// 2. 计算消息物理偏移量</span>
     long offset = commitLog<span class="hljs-selector-class">.getMaxOffset</span>();
     <span class="hljs-comment">// 3. 将数据追加到CommitLog文件末尾</span>
     commitLog<span class="hljs-selector-class">.append</span>(data);
     <span class="hljs-comment">// 4. 返回消息的全局唯一物理偏移量</span>
     return offset;
}
</code></pre>
<p>消息写入CommitLog时有三个关键特性：</p>
<p>1.<strong>顺序写入</strong>：所有消息按到达顺序追加到文件末尾，避免磁盘随机寻址</p>
<p>2.<strong>内存映射</strong>：通过MappedByteBuffer实现文件映射，减少数据拷贝次数</p>
<p>3.<strong>文件分割</strong>：单个CommitLog文件默认1GB，写满后创建新文件（文件名用起始偏移量命名）</p>
<p>举个例子，当生产者发送三条消息时，CommitLog文件可能长这样：</p>
<pre><code class="hljs language-ini" lang="ini">0000000000000000000（文件1，1GB）  
2|--消息A(<span class="hljs-attr">offset</span>=<span class="hljs-number">0</span>)  
3|--消息B(<span class="hljs-attr">offset</span>=<span class="hljs-number">100</span>)  
4|--消息C(<span class="hljs-attr">offset</span>=<span class="hljs-number">200</span>)  
500000000001073741824（文件2，起始偏移量1073741824）  
</code></pre>
<p><strong>温馨提示</strong>：虽然CommitLog是顺序写，但读取时需要配合索引结构，否则遍历文件找消息就像大海捞针。</p>
<p>消费队列ConsumeQueue：消息的快速目录</p>
<p>如果每次消费都要扫描CommitLog，性能会惨不忍睹。于是RocketMQ设计了<strong>ConsumeQueue</strong>——它是基于Topic和Queue的二级索引文件。</p>
<p>每个ConsumeQueue条目包含三个关键信息（固定20字节）：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-number">1</span>| CommitLog <span class="hljs-title function_">Offset</span> <span class="hljs-params">(<span class="hljs-number">8</span>字节)</span> | Message <span class="hljs-title function_">Size</span> <span class="hljs-params">(<span class="hljs-number">4</span>字节)</span> | Tag <span class="hljs-title function_">Hashcode</span> <span class="hljs-params">(<span class="hljs-number">8</span>字节)</span> |  
</code></pre>
<p>这相当于给CommitLog里的消息做了一个目录：</p>
<pre><code class="hljs language-lua" lang="lua">TopicA-Queue0的ConsumeQueue  
<span class="hljs-number">2</span>|<span class="hljs-comment">--0（对应CommitLog偏移0的消息A）  </span>
<span class="hljs-number">3</span>|<span class="hljs-comment">--100（对应CommitLog偏移100的消息B）  </span>
<span class="hljs-number">4</span>|<span class="hljs-comment">--200（对应CommitLog偏移200的消息C）</span>
</code></pre>
<p>当消费者拉取TopicA-Queue0的消息时：</p>
<p>1.先查ConsumeQueue获取消息的物理位置</p>
<p>2.根据CommitLog Offset直接定位到CommitLog文件</p>
<p>3.读取指定位置的消息内容</p>
<p><strong>关键设计点</strong>：</p>
<p>•ConsumeQueue采用内存映射+异步刷盘，保证高性能</p>
<p>•单个文件存储30万条索引，约5.72MB（30万*20字节）</p>
<p>•通过hashCode快速过滤Tag，实现消息过滤</p>
<p>索引文件IndexFile：消息的全局字典</p>
<p>如果需要根据MessageID或Key查询消息，ConsumeQueue就不够用了。这时候就要用到<strong>IndexFile</strong>这个全局索引。</p>
<p>IndexFile的结构类似HashMap：</p>
<p>1.<strong>Slot槽位</strong>（500万个）：存储相同hash值的Index条目链表头</p>
<p>2.<strong>Index条目</strong>（2000万条）：包含Key的hash值、CommitLog偏移量、时间差等信息</p>
<p>当写入消息时：</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-comment">// 索引构建过程简化示意</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-type">void</span> <span class="hljs-title">buildIndex</span><span class="hljs-params">(Message message)</span> </span>{
    <span class="hljs-comment">// 计算Key的hash值</span>
    <span class="hljs-type">int</span> hash = <span class="hljs-built_in">hash</span>(message.<span class="hljs-built_in">getKey</span>());
    <span class="hljs-comment">// 定位到对应的Slot槽位</span>
    <span class="hljs-type">int</span> slotPos = hash % slotNum;
    <span class="hljs-comment">// 在Index区域追加新条目</span>
    indexFile.<span class="hljs-built_in">addEntry</span>(hash, message.<span class="hljs-built_in">getCommitLogOffset</span>());
}
</code></pre>
<p>查询时通过两次查找快速定位：</p>
<p>1.根据Key的hash值找到Slot槽位</p>
<p>2.遍历Slot对应的链表，比对CommitLog中的实际Key值</p>
<p><strong>性能优化必知</strong>：</p>
<p>•消息体积差异大时，CommitLog仍然保持顺序写，但ConsumeQueue可能出现「稀疏索引」（相邻索引指向的物理位置间隔大）</p>
<p>•生产环境中CommitLog建议放在单独SSD磁盘，ConsumeQueue和IndexFile可放普通磁盘</p>
<p>•遇到消息堆积时，优先检查消费者速度，而不是无脑扩容Broker存储</p>
<p>理解这些底层机制，下次遇到消息查询性能问题或者磁盘IO瓶颈时，就知道该从CommitLog的写入模式还是ConsumeQueue的索引结构入手排查了。</p>
<h3 data-id="heading-9">2.2 数据流转机制</h3>
<p>•生产者写入 CommitLog，生成全局唯一偏移量（PHYOFFSET）​</p>
<p>•后台线程异步构建 ConsumeQueue 索引，同步消息元数据​</p>
<p>•消费者通过 ConsumeQueue 定位 CommitLog 中的消息，避免全量扫描</p>
<p>存储过程全景图</p>
<p>现在把各个模块串起来看消息的生命周期：</p>
<p>1.生产者发送消息到Broker</p>
<p>2.Broker将消息<strong>顺序写入CommitLog</strong></p>
<p>3.<strong>异步线程</strong>同时构建ConsumeQueue和IndexFile</p>
<p>4.消费者通过ConsumeQueue快速定位消息</p>
<p>5.按需查询IndexFile实现消息回溯</p>
<p>整个过程就像图书馆的管理系统：</p>
<p>•CommitLog是藏书库（按入库时间摆放）</p>
<p>•ConsumeQueue是分类目录（按题材/出版社分类）</p>
<p>•IndexFile是检索电脑（支持按书名/作者查询）</p>
<h3 data-id="heading-10">2.4 设计优势</h3>
<p>•读写分离：CommitLog 仅负责写入，ConsumeQueue 负责查询，提升并发性能​</p>
<p>•事务支持：通过 CommitLog 中的事务状态标记 + 回查机制，实现分布式事务消息​</p>
<p>•刷盘策略：支持「异步刷盘（高吞吐）」「同步刷盘（金融级可靠性）」动态切换</p>
<h2 data-id="heading-11">三、JMQ存储架构</h2>
<p>JMQ的消息存储分别参考了Kafka和RocketMQ存储设计上优点，并根据京东内部的应用场景进行了改进和创新。</p>
<h3 data-id="heading-12">3.1 核心存储模型：分区日志 + 队列兼容</h3>
<p>﻿</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b2c49ebef1454ecfa3eb5dc914d8e9b2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768889319&amp;x-signature=%2FMKq95%2FkKgWD%2BV9ypnTsgfXuzg8%3D" alt="" loading="lazy"/></p>
<p>﻿﻿</p>
<p><strong>JMQ</strong>存储的基本单元是PartitionGroup。在同一个Broker上，每个PartitionGroup对应一组消息文件（Journal Files），顺序存放这个Topic的消息。</p>
<p>与Kafka类似，每个Topic包含若干Partition，每个Partition对应一组索引文件（Index Files），索引中存放消息在消息文件中的位置和消息长度。消息写入时，收到的消息按照对应的PartitionGroup写入依次追加写入消息文件中，然后异步创建索引并写入对应Partition的索引文件中。</p>
<p>以PartionGroup为基本存储单元的设计，在兼顾灵活性的同时，具有较好的性能，并且单个PartitionGroup可以支持更多的并发。</p>
<h3 data-id="heading-13">3.2 消息读/写过程</h3>
<p>﻿</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/65797ed9958e496ab45de3f081747403~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768889319&amp;x-signature=tUNZo5%2F%2BVu7XYsMj9wYFq1wEXyA%3D" alt="" loading="lazy"/></p>
<p>﻿﻿</p>
<p><strong>写消息：</strong></p>
<p>JMQ的写操作使用DirectBuffer作为缓存，数据先写入DirectBuffer，再异步通过FileChannel写入到文件中。</p>
<p>•消息写入DirectBuffer后，默认写入该节点成功（数据的高可靠是通过Raft协议复制，用多个内存副本来保证），相对Kafka的写操作来看，JMQ响应写入请求的处理过程没有发生系统调用，在京东内部的大量单条同步发送的场景下开销更低、性能更优。</p>
<p>•同时也避免使用MappedByteBuffer（Mmap方式）产生Page Fault中断，OS在中断中将该页对应磁盘中的数据拷贝到内存中，在对文件进行追加写入的情况下，这一无法避免的过程是完全没有必要，反而增加了写入的耗时的问题。</p>
<p><strong>读消息：</strong></p>
<p>JMQ采用定长稠密索引设计，每个索引固定长度。</p>
<p>•定长设计的好处是，直接根据索引序号就可以计算出索引在文件中的位置：索引位置 = 索引序号 * 索引长度。这样，消息的查找过程就比较简单了，首先计算出索引所在的位置，直接读取索引，然后根据索引中记录的消息位置读取消息。</p>
<p>•在京东内部应用场景中，单条消息处理耗时高是比较常见的，微服务架构下用户一般会申请更多的消费节点，让每个消费节点单次拉取较小批量的消息进行处理，以提升消费并行度，这样消费拉取请求的次数会比较多，稠密索引的设计会更适用内部的应用场景。</p>
<p>JMQ消费读操作99%以上都能命中缓存（JMQ设计的堆外内存与文件映射的一种缓存机制），避免了Kafka可能遇到的Cache被污染，影响性能和吞吐的问题。同时直接读内存也规避了RocketMQ在读取消息存储的日志数据文件时容易产生较多的随机访问读取磁盘，影响性能的问题。（当没有命中缓存时，会默认降级为通过Mmap的方式读取消息）。</p>
<h2 data-id="heading-14">四、竞品对比分析</h2>













































<table><thead><tr><th>﻿</th><th><strong>JMQ</strong></th><th><strong>Kafka</strong></th></tr></thead><tbody><tr><td><strong>存储模型</strong></td><td>以<strong>PartitionGroup</strong>为基本存储单元，支持高并发写入</td><td>以<strong>Partition</strong>为基本存储单元，支持灵活的数据复制和迁移</td></tr><tr><td><strong>消息写入性能</strong></td><td>- 单副本异步写入性能与 Kafka 相当 - 三副本异步写入性能优于 Kafka</td><td>- 单副本异步写入性能与 JMQ 相当 - 三副本异步写入性能略低于 JMQ</td></tr><tr><td><strong>同步写入性能</strong></td><td>- 同步写入性能稳定，几乎不受网络延迟影响</td><td>- 同步写入性能受网络延迟影响较大，稳定性略逊于 JMQ</td></tr><tr><td><strong>多分区性能</strong></td><td>- 多分区异步写入性能与 Kafka 相当 - 同步写入性能略低于 Kafka</td><td>- 多分区同步写入性能更稳定，适合高并发场景</td></tr><tr><td><strong>副本机制</strong></td><td>支持异步复制，副本间数据同步性能较好</td><td>支持异步和同步复制，副本机制成熟，适合复杂部署</td></tr><tr><td><strong>跨机房部署</strong></td><td>- 同步写入性能基本不受影响 - 异步写入性能下降</td><td>- 同步写入性能受网络延迟影响较大 - 异步写入性能下降</td></tr><tr><td><strong>适用场景</strong></td><td>- 对同步写入性能要求高 - 副本异步吞吐要求高 - 大规模微服务集群</td><td>- 复杂分区的高并发同步写入 - 大规模分布式系统 - 多语言生态支持丰富</td></tr></tbody></table>
<p>在单副本场景下，JMQ与Kafka的单机写入性能均十分出色，均可达到网络带宽上限。</p>
<p>然而，在更贴近生产环境的三副本场景中，两者特性出现分化：</p>
<p><strong>JMQ在三副本异步写入下的极限吞吐优势明显，且在跨机房部署时，其同步写入性能表现良好，几乎不受网络延迟影响；而Kafka则在多分区同步写入场景下展现出更稳定的性能，衰减小于JMQ。在大部分异步吞吐场景及不同消息体下的性能趋势上，两者表现相当。</strong></p>
<p>综上所述，JMQ尤其适合对同步写入性能和副本异步吞吐有极高要求的场景，而Kafka在复杂分区的高并发同步写入方面适应性更广。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[SPI机制：服务扩展的核心技术]]></title>    <link>https://juejin.cn/post/7594415509607333934</link>    <guid>https://juejin.cn/post/7594415509607333934</guid>    <pubDate>2026-01-13T06:08:48.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7594415509607333934" data-draft-id="7593602686136139802" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content=" SPI机制：服务扩展的核心技术"/> <meta itemprop="keywords" content="Java"/> <meta itemprop="datePublished" content="2026-01-13T06:08:48.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="SevenCoding"/> <meta itemprop="url" content="https://juejin.cn/user/3261615728242467"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
             SPI机制：服务扩展的核心技术
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3261615728242467/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    SevenCoding
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-13T06:08:48.000Z" title="Tue Jan 13 2026 06:08:48 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读18分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">为什么需要SPI机制</h2>
<h3 data-id="heading-1">SPI和API的区别是什么</h3>
<p>SPI是一种跟API相对应的反向设计思想：API由实现方确定标准规范和功能，调用方无权做任何干预； 而SPI是由调用方确定标准规范，也就是接口，然后调用方依赖此接口，第三方实现此接口，这样做就可以方便的进行扩展，类似于插件机制，这是SPI出现的需求背景。</p>
<p>SPI ： “接口”位于“调用方”所在的“包”中</p>
<ul>
<li>
<p>概念上更依赖调用方。</p>
</li>
<li>
<p>组织上位于调用方所在的包中。</p>
</li>
<li>
<p>实现位于独立的包中。</p>
</li>
<li>
<p>常见的例子是：插件模式的插件。</p>
</li>
</ul>
<p>API ： “接口”位于“实现方”所在的“包”中</p>
<ul>
<li>
<p>概念上更接近实现方。</p>
</li>
<li>
<p>组织上位于实现方所在的包中。</p>
</li>
<li>
<p>实现和接口在一个包中。</p>
</li>
</ul>
<h3 data-id="heading-2">什么是SPI机制</h3>
<p>SPI（Service Provider Interface），是JDK内置的一种 服务提供发现机制，可以用来启用框架扩展和替换组件，主要是被框架的开发人员使用，例如数据库中的java.sql.Driver接口，不同的厂商可以针对同一接口做出不同的实现，如下图所示，MySQL和PostgreSQL都有不同的实现提供给用户。
而Java的SPI机制可以为某个接口寻找服务实现，Java中SPI机制主要思想是<strong>将装配的控制权移到程序之外</strong>，在模块化设计中这个机制尤其重要，其核心思想就是 <strong>解耦</strong>。</p>
<p>SPI整体机制图如下：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fc39590bdd5d40ecab1192c3011a2f44~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2V2ZW5Db2Rpbmc=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768889327&amp;x-signature=0gTdm9ZMzo22fG4%2F%2FBO4BcWZnzk%3D" alt="" loading="lazy"/></p>
<ol>
<li>当服务的提供者提供了一种接口的实现之后，需要在classpath下的 META-INF/services/ 目录里创建一个文件，文件名是以<strong>服务接口</strong>命名的，而文件里的内容是这个接口的<strong>具体的实现类</strong>。</li>
<li>当其他的程序需要这个服务的时候，就可以通过查找这个jar包（一般都是以jar包做依赖）的META-INF/services/中的配置文件，配置文件中有接口的具体实现类名，再根据这个类名进行加载实例化，就可以使用该服务了。JDK中查找服务的实现的工具类是：java.util.ServiceLoader。</li>
</ol>
<h2 data-id="heading-3">SPI机制的简单示例</h2>
<p>假设现在需要一个发送消息的服务MessageService，发送消息的实现可能是基于短信、也可能是基于电子邮件、或推送通知发送消息。</p>
<ul>
<li><strong>接口定义</strong>：首先定义一个接口 <code>MessageService</code></li>
</ul>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">MessageService</span> {
    <span class="hljs-keyword">void</span> <span class="hljs-title function_">sendMessage</span><span class="hljs-params">(String message)</span>;
}
</code></pre>
<ul>
<li><strong>提供两个实现类</strong>：一个通过短信发送消息，一个通过电子邮件发送消息。</li>
</ul>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 短信发送实现</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SmsMessageService</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">MessageService</span> {
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">sendMessage</span><span class="hljs-params">(String message)</span> {
        System.out.println(<span class="hljs-string">"Sending SMS: "</span> + message);
    }
}

<span class="hljs-comment">// 电子邮件发送实现</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">EmailMessageService</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">MessageService</span> {
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">sendMessage</span><span class="hljs-params">(String message)</span> {
        System.out.println(<span class="hljs-string">"Sending Email: "</span> + message);
    }
}
</code></pre>
<ul>
<li><strong>配置文件</strong>：在 <code>META-INF/services/</code> 目录下创建一个配置文件，文件名为 <code>MessageService</code> ，全限定名 <code>com.example.MessageService</code>，文件内容为接口的实现类的全限定名。</li>
</ul>
<pre><code class="hljs language-java" lang="java"># 文件: META-INF/services/com.seven.MessageService
com.seven.SmsMessageService
com.seven.EmailMessageService
</code></pre>
<ul>
<li><strong>加载服务实现</strong>：在应用程序中，通过 <code>ServiceLoader</code> 动态加载并使用这些实现类。</li>
</ul>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Application</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        ServiceLoader&lt;MessageService&gt; loader = ServiceLoader.load(MessageService.class);

        <span class="hljs-keyword">for</span> (MessageService service : loader) {
            service.sendMessage(<span class="hljs-string">"Hello, SPI!"</span>);
        }
    }
}
</code></pre>
<p>运行时，<code>ServiceLoader</code> 会发现并加载配置文件中列出的所有实现类，并依次调用它们的 <code>sendMessage</code> 方法。</p>
<p>由于在 配置文件 写了两个实现类，因此两个实现类都会执行 sendMessage 方法。</p>
<p>这就是因为ServiceLoader.load(Search.class)在加载某接口时，会去 META-INF/services 下找接口的全限定名文件，再根据里面的内容加载相应的实现类。</p>
<p>这就是spi的思想，接口的实现由provider实现，provider只用在提交的jar包里的META-INF/services下根据平台定义的接口新建文件，并添加进相应的实现类内容就好。</p>
<h2 data-id="heading-4">SPI机制的应用</h2>
<h3 data-id="heading-5">JDBC DriverManager</h3>
<p>在JDBC4.0之前，开发连接数据库的时候，通常会用<code>Class.forName("com.mysql.jdbc.Driver")</code>这句先加载数据库相关的驱动，然后再进行获取连接等的操作。而JDBC4.0之后不需要用<code>Class.forName("com.mysql.jdbc.Driver")</code>来加载驱动，直接获取连接就可以了，原因就是现在使用了Java的SPI扩展机制来实现。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c85677d74aaa4af5afa2748ef2c6484a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2V2ZW5Db2Rpbmc=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768889327&amp;x-signature=AeHC76Ms6Mgy2IMHayYaVHVnEUE%3D" alt="" loading="lazy"/></p>
<p>如上图所示：</p>
<ol>
<li>首先在java中定义了接口 java.sql.Driver，并没有具体的实现，具体的实现都是由不同厂商来提供的。</li>
<li>在mysql的jar包mysql-connector-java-8.0.26.jar中，可以找到 META-INF/services 目录，该目录下会有一个名字为 java.sql.Driver 的文件，文件内容是com.mysql.cj.jdbc.Driver，这里面的内容就是mysql针对Java中定义的接口的实现。</li>
<li>同样在ojdbc的jar包ojdbc11.jar中，也可以找到同样的配置文件，文件内容是 oracle.jdbc.OracleDriver，这是oracle数据库对Java的java.sql.Driver的实现。</li>
</ol>
<h4 data-id="heading-6">使用方法</h4>
<p>而现在Java中写连接数据库的代码的时候，不需要再使用<code>Class.forName("com.mysql.jdbc.Driver")</code>来加载驱动了，直接获取连接就可以了：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-type">String</span> <span class="hljs-variable">url</span> <span class="hljs-operator">=</span> <span class="hljs-string">"jdbc:xxxx://xxxx:xxxx/xxxx"</span>;
<span class="hljs-type">Connection</span> <span class="hljs-variable">conn</span> <span class="hljs-operator">=</span> DriverManager.getConnection(url, username, password);
.....
</code></pre>
<p>这里并没有涉及到spi的使用，看下面源码。</p>
<h4 data-id="heading-7">源码实现</h4>
<p>上面的使用方法，就是普通的连接数据库的代码，实际上并没有涉及到 SPI 的东西，但是有一点可以确定的是，我们没有写有关具体驱动的硬编码<code>Class.forName("com.mysql.jdbc.Driver")</code>！</p>
<p>而上面的代码就可以直接获取数据库连接进行操作，但是跟SPI有啥关系呢？
既然上面代码没有加载驱动的代码，那实际上是怎么去确定使用哪个数据库连接的驱动呢？</p>
<p>这里就涉及到使用Java的SPI 扩展机制来查找相关驱动的东西了，关于驱动的查找其实都在DriverManager中，DriverManager是Java中的实现，用来获取数据库连接，源码如下：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DriverManager</span> {

    <span class="hljs-comment">// 存放注册的jdbc驱动</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">static</span> CopyOnWriteArrayList&lt;DriverInfo&gt; registeredDrivers = <span class="hljs-keyword">new</span> <span class="hljs-title class_">CopyOnWriteArrayList</span>&lt;&gt;();

    <span class="hljs-comment">/**
     * Load the initial JDBC drivers by checking the System property
     * jdbc.properties and then use the {<span class="hljs-doctag">@code</span> ServiceLoader} mechanism
     */</span>
    <span class="hljs-keyword">static</span> {
        loadInitialDrivers();
        println(<span class="hljs-string">"JDBC DriverManager initialized"</span>);
    }
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">loadInitialDrivers</span><span class="hljs-params">()</span> {
        String drivers;
        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// 从JVM -D参数读取jdbc驱动</span>
            drivers = AccessController.doPrivileged(<span class="hljs-keyword">new</span> <span class="hljs-title class_">PrivilegedAction</span>&lt;String&gt;() {
                <span class="hljs-keyword">public</span> String <span class="hljs-title function_">run</span><span class="hljs-params">()</span> {
                    <span class="hljs-keyword">return</span> System.getProperty(<span class="hljs-string">"jdbc.drivers"</span>);
                }
            });
        } <span class="hljs-keyword">catch</span> (Exception ex) {
            drivers = <span class="hljs-literal">null</span>;
        }
        <span class="hljs-comment">// If the driver is packaged as a Service Provider, load it.</span>
        <span class="hljs-comment">// Get all the drivers through the classloader</span>
        <span class="hljs-comment">// exposed as a java.sql.Driver.class service.</span>
        <span class="hljs-comment">// ServiceLoader.load() replaces the sun.misc.Providers()</span>

        AccessController.doPrivileged(<span class="hljs-keyword">new</span> <span class="hljs-title class_">PrivilegedAction</span>&lt;Void&gt;() {
            <span class="hljs-keyword">public</span> Void <span class="hljs-title function_">run</span><span class="hljs-params">()</span> {

                ServiceLoader&lt;Driver&gt; loadedDrivers = ServiceLoader.load(Driver.class);
                Iterator&lt;Driver&gt; driversIterator = loadedDrivers.iterator();

                <span class="hljs-comment">/* Load these drivers, so that they can be instantiated.
                 * It may be the case that the driver class may not be there
                 * i.e. there may be a packaged driver with the service class
                 * as implementation of java.sql.Driver but the actual class
                 * may be missing. In that case a java.util.ServiceConfigurationError
                 * will be thrown at runtime by the VM trying to locate
                 * and load the service.
                 *
                 * Adding a try catch block to catch those runtime errors
                 * if driver not available in classpath but it's
                 * packaged as service and that service is there in classpath.
                 */</span>
                <span class="hljs-keyword">try</span>{
                    <span class="hljs-comment">// 加载创建所有Driver</span>
                    <span class="hljs-keyword">while</span>(driversIterator.hasNext()) {
                        <span class="hljs-comment">// 触发Driver的类加载-&gt;在静态代码块中创建Driver对象并放到DriverManager</span>
                        driversIterator.next();
                    }
                } <span class="hljs-keyword">catch</span>(Throwable t) {
                <span class="hljs-comment">// Do nothing</span>
                }
                <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
            }
        });

        println(<span class="hljs-string">"DriverManager.initialize: jdbc.drivers = "</span> + drivers);

        <span class="hljs-keyword">if</span> (drivers == <span class="hljs-literal">null</span> || drivers.equals(<span class="hljs-string">""</span>)) {
            <span class="hljs-keyword">return</span>;
        }
        <span class="hljs-comment">// 解析JVM参数的jdbc驱动</span>
        String[] driversList = drivers.split(<span class="hljs-string">":"</span>);
        println(<span class="hljs-string">"number of Drivers:"</span> + driversList.length);
        <span class="hljs-keyword">for</span> (String aDriver : driversList) {
            <span class="hljs-keyword">try</span> {
                println(<span class="hljs-string">"DriverManager.Initialize: loading "</span> + aDriver);
                <span class="hljs-comment">// initial为ture </span>
                <span class="hljs-comment">// 触发Driver的类加载-&gt;在静态代码块中创建Driver对象并放到DriverManager</span>
                Class.forName(aDriver, <span class="hljs-literal">true</span>,
                        ClassLoader.getSystemClassLoader());
            } <span class="hljs-keyword">catch</span> (Exception ex) {
                println(<span class="hljs-string">"DriverManager.Initialize: load failed: "</span> + ex);
            }
        }
    }

}
</code></pre>
<p>上面的代码主要步骤是：</p>
<ol>
<li>从系统变量中获取有关驱动的定义。</li>
<li>使用SPI来获取驱动的实现。</li>
<li>遍历使用SPI获取到的具体实现，实例化各个实现类。</li>
<li>根据第一步获取到的驱动列表来实例化具体实现类。</li>
</ol>
<ul>
<li>第二步：使用SPI来获取驱动的实现，对应的代码是：</li>
</ul>
<pre><code class="hljs language-java" lang="java">ServiceLoader&lt;Driver&gt; loadedDrivers = ServiceLoader.load(Driver.class);
</code></pre>
<p>这里封装了接口类型和类加载器，并初始化了一个迭代器。</p>
<ul>
<li>第三步：遍历获取到的具体实现，实例化各个实现类，对应的代码如下：</li>
</ul>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">//获取迭代器</span>
Iterator&lt;Driver&gt; driversIterator = loadedDrivers.iterator();
<span class="hljs-comment">//遍历所有的驱动实现</span>
<span class="hljs-keyword">while</span>(driversIterator.hasNext()) {
    driversIterator.next();
}
</code></pre>
<p>在遍历的时候，首先调用driversIterator.hasNext()方法，这里会搜索classpath下以及jar包中所有的META-INF/services目录下的java.sql.Driver文件，并找到文件中的实现类的名字，此时并没有实例化具体的实现类（ServiceLoader具体的源码实现在下面）。</p>
<p>然后是调用driversIterator.next();方法，此时就会根据驱动名字具体实例化各个实现类了。现在驱动就被找到并实例化了。</p>
<h3 data-id="heading-8">Common-Logging</h3>
<p>common-logging（也称Jakarta Commons Logging，缩写 JCL）是常用的日志库门面， 使用了SPI的方式来动态加载和配置日志实现。这种机制允许库在运行时找到合适的日志实现，而无需硬编码具体的日志库。</p>
<p>我们看下它是怎么通过SPI解耦的。</p>
<p>首先，日志实例是通过LogFactory的getLog(String)方法创建的：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-title function_">getLog</span><span class="hljs-params">(Class clazz)</span> <span class="hljs-keyword">throws</span> LogConfigurationException {
    <span class="hljs-keyword">return</span> getFactory().getInstance(clazz);
}
</code></pre>
<p>LogFatory是一个抽象类，它负责加载具体的日志实现，getFactory()方法源码如下：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> org.apache.commons.logging.LogFactory <span class="hljs-title function_">getFactory</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> LogConfigurationException {
    <span class="hljs-comment">// Identify the class loader we will be using</span>
    <span class="hljs-type">ClassLoader</span> <span class="hljs-variable">contextClassLoader</span> <span class="hljs-operator">=</span> getContextClassLoaderInternal();

    <span class="hljs-keyword">if</span> (contextClassLoader == <span class="hljs-literal">null</span>) {
        <span class="hljs-comment">// This is an odd enough situation to report about. This</span>
        <span class="hljs-comment">// output will be a nuisance on JDK1.1, as the system</span>
        <span class="hljs-comment">// classloader is null in that environment.</span>
        <span class="hljs-keyword">if</span> (isDiagnosticsEnabled()) {
            logDiagnostic(<span class="hljs-string">"Context classloader is null."</span>);
        }
    }

    <span class="hljs-comment">// Return any previously registered factory for this class loader</span>
    org.apache.commons.logging.<span class="hljs-type">LogFactory</span> <span class="hljs-variable">factory</span> <span class="hljs-operator">=</span> getCachedFactory(contextClassLoader);
    <span class="hljs-keyword">if</span> (factory != <span class="hljs-literal">null</span>) {
        <span class="hljs-keyword">return</span> factory;
    }

    <span class="hljs-keyword">if</span> (isDiagnosticsEnabled()) {
        logDiagnostic(
                <span class="hljs-string">"[LOOKUP] LogFactory implementation requested for the first time for context classloader "</span> +
                        objectId(contextClassLoader));
        logHierarchy(<span class="hljs-string">"[LOOKUP] "</span>, contextClassLoader);
    }

    <span class="hljs-comment">// classpath根目录下寻找commons-logging.properties</span>
    <span class="hljs-type">Properties</span> <span class="hljs-variable">props</span> <span class="hljs-operator">=</span> getConfigurationFile(contextClassLoader, FACTORY_PROPERTIES);

    <span class="hljs-comment">// Determine whether we will be using the thread context class loader to</span>
    <span class="hljs-comment">// load logging classes or not by checking the loaded properties file (if any).</span>
    <span class="hljs-comment">// classpath根目录下commons-logging.properties是否配置use_tccl</span>
    <span class="hljs-type">ClassLoader</span> <span class="hljs-variable">baseClassLoader</span> <span class="hljs-operator">=</span> contextClassLoader;
    <span class="hljs-keyword">if</span> (props != <span class="hljs-literal">null</span>) {
        <span class="hljs-type">String</span> <span class="hljs-variable">useTCCLStr</span> <span class="hljs-operator">=</span> props.getProperty(TCCL_KEY);
        <span class="hljs-keyword">if</span> (useTCCLStr != <span class="hljs-literal">null</span>) {
            <span class="hljs-keyword">if</span> (Boolean.valueOf(useTCCLStr).booleanValue() == <span class="hljs-literal">false</span>) {
                baseClassLoader = thisClassLoader;
            }
        }
    }

    <span class="hljs-comment">// 这里真正开始决定使用哪个factory</span>
    <span class="hljs-comment">// 首先，尝试查找vm系统属性org.apache.commons.logging.LogFactory，其是否指定factory</span>
    <span class="hljs-keyword">if</span> (isDiagnosticsEnabled()) {
        logDiagnostic(<span class="hljs-string">"[LOOKUP] Looking for system property ["</span> + FACTORY_PROPERTY +
                <span class="hljs-string">"] to define the LogFactory subclass to use..."</span>);
    }

    <span class="hljs-keyword">try</span> {
        <span class="hljs-type">String</span> <span class="hljs-variable">factoryClass</span> <span class="hljs-operator">=</span> getSystemProperty(FACTORY_PROPERTY, <span class="hljs-literal">null</span>);
        <span class="hljs-keyword">if</span> (factoryClass != <span class="hljs-literal">null</span>) {
            <span class="hljs-keyword">if</span> (isDiagnosticsEnabled()) {
                logDiagnostic(<span class="hljs-string">"[LOOKUP] Creating an instance of LogFactory class '"</span> + factoryClass +
                        <span class="hljs-string">"' as specified by system property "</span> + FACTORY_PROPERTY);
            }
            factory = newFactory(factoryClass, baseClassLoader, contextClassLoader);
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-keyword">if</span> (isDiagnosticsEnabled()) {
                logDiagnostic(<span class="hljs-string">"[LOOKUP] No system property ["</span> + FACTORY_PROPERTY + <span class="hljs-string">"] defined."</span>);
            }
        }
    } <span class="hljs-keyword">catch</span> (SecurityException e) {
        <span class="hljs-keyword">if</span> (isDiagnosticsEnabled()) {
            logDiagnostic(<span class="hljs-string">"[LOOKUP] A security exception occurred while trying to create an"</span> +
                    <span class="hljs-string">" instance of the custom factory class"</span> + <span class="hljs-string">": ["</span> + trim(e.getMessage()) +
                    <span class="hljs-string">"]. Trying alternative implementations..."</span>);
        }
        <span class="hljs-comment">// ignore</span>
    } <span class="hljs-keyword">catch</span> (RuntimeException e) {
        <span class="hljs-keyword">if</span> (isDiagnosticsEnabled()) {
            logDiagnostic(<span class="hljs-string">"[LOOKUP] An exception occurred while trying to create an"</span> +
                    <span class="hljs-string">" instance of the custom factory class"</span> + <span class="hljs-string">": ["</span> +
                    trim(e.getMessage()) +
                    <span class="hljs-string">"] as specified by a system property."</span>);
        }
        <span class="hljs-keyword">throw</span> e;
    }

    <span class="hljs-comment">// 第二，尝试使用java spi服务发现机制，在META-INF/services下寻找org.apache.commons.logging.LogFactory实现</span>
    <span class="hljs-keyword">if</span> (factory == <span class="hljs-literal">null</span>) {
        <span class="hljs-keyword">if</span> (isDiagnosticsEnabled()) {
            logDiagnostic(<span class="hljs-string">"[LOOKUP] Looking for a resource file of name ["</span> + SERVICE_ID +
                    <span class="hljs-string">"] to define the LogFactory subclass to use..."</span>);
        }
        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// META-INF/services/org.apache.commons.logging.LogFactory, SERVICE_ID</span>
            <span class="hljs-keyword">final</span> <span class="hljs-type">InputStream</span> <span class="hljs-variable">is</span> <span class="hljs-operator">=</span> getResourceAsStream(contextClassLoader, SERVICE_ID);

            <span class="hljs-keyword">if</span> (is != <span class="hljs-literal">null</span>) {
                <span class="hljs-comment">// This code is needed by EBCDIC and other strange systems.</span>
                <span class="hljs-comment">// It's a fix for bugs reported in xerces</span>
                BufferedReader rd;
                <span class="hljs-keyword">try</span> {
                    rd = <span class="hljs-keyword">new</span> <span class="hljs-title class_">BufferedReader</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">InputStreamReader</span>(is, <span class="hljs-string">"UTF-8"</span>));
                } <span class="hljs-keyword">catch</span> (java.io.UnsupportedEncodingException e) {
                    rd = <span class="hljs-keyword">new</span> <span class="hljs-title class_">BufferedReader</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">InputStreamReader</span>(is));
                }

                <span class="hljs-type">String</span> <span class="hljs-variable">factoryClassName</span> <span class="hljs-operator">=</span> rd.readLine();
                rd.close();

                <span class="hljs-keyword">if</span> (factoryClassName != <span class="hljs-literal">null</span> &amp;&amp; !<span class="hljs-string">""</span>.equals(factoryClassName)) {
                    <span class="hljs-keyword">if</span> (isDiagnosticsEnabled()) {
                        logDiagnostic(<span class="hljs-string">"[LOOKUP]  Creating an instance of LogFactory class "</span> +
                                factoryClassName +
                                <span class="hljs-string">" as specified by file '"</span> + SERVICE_ID +
                                <span class="hljs-string">"' which was present in the path of the context classloader."</span>);
                    }
                    factory = newFactory(factoryClassName, baseClassLoader, contextClassLoader);
                }
            } <span class="hljs-keyword">else</span> {
                <span class="hljs-comment">// is == null</span>
                <span class="hljs-keyword">if</span> (isDiagnosticsEnabled()) {
                    logDiagnostic(<span class="hljs-string">"[LOOKUP] No resource file with name '"</span> + SERVICE_ID + <span class="hljs-string">"' found."</span>);
                }
            }
        } <span class="hljs-keyword">catch</span> (Exception ex) {
            <span class="hljs-comment">// note: if the specified LogFactory class wasn't compatible with LogFactory</span>
            <span class="hljs-comment">// for some reason, a ClassCastException will be caught here, and attempts will</span>
            <span class="hljs-comment">// continue to find a compatible class.</span>
            <span class="hljs-keyword">if</span> (isDiagnosticsEnabled()) {
                logDiagnostic(
                        <span class="hljs-string">"[LOOKUP] A security exception occurred while trying to create an"</span> +
                                <span class="hljs-string">" instance of the custom factory class"</span> +
                                <span class="hljs-string">": ["</span> + trim(ex.getMessage()) +
                                <span class="hljs-string">"]. Trying alternative implementations..."</span>);
            }
            <span class="hljs-comment">// ignore</span>
        }
    }

    <span class="hljs-comment">// 第三，尝试从classpath根目录下的commons-logging.properties中查找org.apache.commons.logging.LogFactory属性指定的factory</span>
    <span class="hljs-keyword">if</span> (factory == <span class="hljs-literal">null</span>) {
        <span class="hljs-keyword">if</span> (props != <span class="hljs-literal">null</span>) {
            <span class="hljs-keyword">if</span> (isDiagnosticsEnabled()) {
                logDiagnostic(
                        <span class="hljs-string">"[LOOKUP] Looking in properties file for entry with key '"</span> + FACTORY_PROPERTY +
                                <span class="hljs-string">"' to define the LogFactory subclass to use..."</span>);
            }
            <span class="hljs-type">String</span> <span class="hljs-variable">factoryClass</span> <span class="hljs-operator">=</span> props.getProperty(FACTORY_PROPERTY);
            <span class="hljs-keyword">if</span> (factoryClass != <span class="hljs-literal">null</span>) {
                <span class="hljs-keyword">if</span> (isDiagnosticsEnabled()) {
                    logDiagnostic(
                            <span class="hljs-string">"[LOOKUP] Properties file specifies LogFactory subclass '"</span> + factoryClass + <span class="hljs-string">"'"</span>);
                }
                factory = newFactory(factoryClass, baseClassLoader, contextClassLoader);

                <span class="hljs-comment">// <span class="hljs-doctag">TODO:</span> think about whether we need to handle exceptions from newFactory</span>
            } <span class="hljs-keyword">else</span> {
                <span class="hljs-keyword">if</span> (isDiagnosticsEnabled()) {
                    logDiagnostic(<span class="hljs-string">"[LOOKUP] Properties file has no entry specifying LogFactory subclass."</span>);
                }
            }
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-keyword">if</span> (isDiagnosticsEnabled()) {
                logDiagnostic(<span class="hljs-string">"[LOOKUP] No properties file available to determine"</span> + <span class="hljs-string">" LogFactory subclass from.."</span>);
            }
        }
    }

    <span class="hljs-comment">// 最后，使用后备factory实现，org.apache.commons.logging.impl.LogFactoryImpl</span>
    <span class="hljs-keyword">if</span> (factory == <span class="hljs-literal">null</span>) {
        <span class="hljs-keyword">if</span> (isDiagnosticsEnabled()) {
            logDiagnostic(
                    <span class="hljs-string">"[LOOKUP] Loading the default LogFactory implementation '"</span> + FACTORY_DEFAULT +
                            <span class="hljs-string">"' via the same classloader that loaded this LogFactory"</span> +
                            <span class="hljs-string">" class (ie not looking in the context classloader)."</span>);
        }

        factory = newFactory(FACTORY_DEFAULT, thisClassLoader, contextClassLoader);
    }

    <span class="hljs-keyword">if</span> (factory != <span class="hljs-literal">null</span>) {
        cacheFactory(contextClassLoader, factory);

        <span class="hljs-keyword">if</span> (props != <span class="hljs-literal">null</span>) {
            <span class="hljs-type">Enumeration</span> <span class="hljs-variable">names</span> <span class="hljs-operator">=</span> props.propertyNames();
            <span class="hljs-keyword">while</span> (names.hasMoreElements()) {
                <span class="hljs-type">String</span> <span class="hljs-variable">name</span> <span class="hljs-operator">=</span> (String) names.nextElement();
                <span class="hljs-type">String</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> props.getProperty(name);
                factory.setAttribute(name, value);
            }
        }
    }

    <span class="hljs-keyword">return</span> factory;
}
</code></pre>
<p>可以看出，抽象类LogFactory加载具体实现的步骤如下：</p>
<ol>
<li>从vm系统属性org.apache.commons.logging.LogFactory</li>
<li>使用SPI服务发现机制，发现org.apache.commons.logging.LogFactory的实现</li>
<li>查找classpath根目录commons-logging.properties的org.apache.commons.logging.LogFactory属性是否指定factory实现</li>
<li>使用默认factory实现，org.apache.commons.logging.impl.LogFactoryImpl</li>
</ol>
<p>LogFactory的getLog()方法返回类型是org.apache.commons.logging.Log接口，提供了从trace到fatal方法。可以确定，如果日志实现提供者只要实现该接口，并且使用继承自org.apache.commons.logging.LogFactory的子类创建Log，必然可以构建一个松耦合的日志系统。</p>
<h3 data-id="heading-9">Spring中SPI机制</h3>
<p>在springboot的<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.seven97.top%2Fframework%2Fspringboot%2Fprincipleofautomaticassembly.html" target="_blank" title="https://www.seven97.top/framework/springboot/principleofautomaticassembly.html" ref="nofollow noopener noreferrer">自动装配</a>过程中，最终会加载META-INF/spring.factories文件，主要通过以下几个步骤实现：</p>
<ol>
<li><strong>服务接口定义</strong>： Spring 定义了许多服务接口，如 <code>org.springframework.boot.autoconfigure.EnableAutoConfiguration</code>。</li>
<li><strong>服务提供者实现</strong>： 各种具体的模块和库会提供这些服务接口的实现，如各种自动配置类。</li>
<li><strong>服务描述文件</strong>： 在实现模块的 JAR 包中，会有一个 <code>META-INF/spring.factories</code> 文件，这个文件中列出了该 JAR 包中实现的自动配置类。</li>
<li><strong>服务加载</strong>： Spring Boot 在启动时加载 <code>spring.factories</code> 文件，并实例化这些文件中列出的实现类。</li>
</ol>
<p>Spring Boot 使用 <code>SpringFactoriesLoader</code> 来加载 <code>spring.factories</code> 文件中列出的所有类，并将它们注册到应用上下文中。需要注意的是，其实这里不仅仅是会去ClassPath路径下查找，会扫描所有路径下的Jar包，只不过这个文件只会在Classpath下的jar包中。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">FACTORIES_RESOURCE_LOCATION</span> <span class="hljs-operator">=</span> <span class="hljs-string">"META-INF/spring.factories"</span>;
<span class="hljs-comment">// spring.factories文件的格式为：key=value1,value2,value3</span>
<span class="hljs-comment">// 从所有的jar包中找到META-INF/spring.factories文件</span>
<span class="hljs-comment">// 然后从文件中解析出key=factoryClass类名称的所有value值</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> List&lt;String&gt; <span class="hljs-title function_">loadFactoryNames</span><span class="hljs-params">(Class&lt;?&gt; factoryClass, ClassLoader classLoader)</span> {
    <span class="hljs-type">String</span> <span class="hljs-variable">factoryClassName</span> <span class="hljs-operator">=</span> factoryClass.getName();
    <span class="hljs-comment">// 取得资源文件的URL</span>
    Enumeration&lt;URL&gt; urls = (classLoader != <span class="hljs-literal">null</span> ? classLoader.getResources(FACTORIES_RESOURCE_LOCATION) : ClassLoader.getSystemResources(FACTORIES_RESOURCE_LOCATION));
    List&lt;String&gt; result = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;String&gt;();
    <span class="hljs-comment">// 遍历所有的URL</span>
    <span class="hljs-keyword">while</span> (urls.hasMoreElements()) {
        <span class="hljs-type">URL</span> <span class="hljs-variable">url</span> <span class="hljs-operator">=</span> urls.nextElement();
        <span class="hljs-comment">// 根据资源文件URL解析properties文件，得到对应的一组@Configuration类</span>
        <span class="hljs-type">Properties</span> <span class="hljs-variable">properties</span> <span class="hljs-operator">=</span> PropertiesLoaderUtils.loadProperties(<span class="hljs-keyword">new</span> <span class="hljs-title class_">UrlResource</span>(url));
        <span class="hljs-type">String</span> <span class="hljs-variable">factoryClassNames</span> <span class="hljs-operator">=</span> properties.getProperty(factoryClassName);
        <span class="hljs-comment">// 组装数据，并返回</span>
        result.addAll(Arrays.asList(StringUtils.commaDelimitedListToStringArray(factoryClassNames)));
    }
    <span class="hljs-keyword">return</span> result;
}
</code></pre>
<p>通过 SPI 机制和 <code>spring.factories</code> 文件的配合，Spring Boot 实现了模块化和自动配置的能力。开发者可以通过定义自动配置类并在 <code>spring.factories</code> 文件中声明它们，从而实现模块的独立和松耦合。这种机制不仅简化了配置和启动过程，还提升了应用的可扩展性和维护性。</p>
<h2 data-id="heading-10">SPI 机制通常怎么使用</h2>
<p>看完上面的几个例子解析，应该都能知道大概的流程了：</p>
<ol>
<li>定义标准：定义标准，就是定义接口。比如接口java.sql.Driver</li>
<li>具体厂商或者框架开发者实现：厂商或者框架开发者开发具体的实现：
在META-INF/services目录下定义一个名字为接口全限定名的文件，比如java.sql.Driver文件，文件内容是具体的实现名字，比如me.cxis.sql.MyDriver。写具体的实现me.cxis.sql.MyDriver，都是对接口Driver的实现。</li>
<li>具体使用：引用具体厂商的jar包来实现我们的功能：</li>
</ol>
<pre><code class="hljs language-java" lang="java">ServiceLoader&lt;Driver&gt; loadedDrivers = ServiceLoader.load(Driver.class);
<span class="hljs-comment">//获取迭代器</span>
Iterator&lt;Driver&gt; driversIterator = loadedDrivers.iterator();
<span class="hljs-comment">//遍历</span>
<span class="hljs-keyword">while</span>(driversIterator.hasNext()) {
    driversIterator.next();
    <span class="hljs-comment">//可以做具体的业务逻辑</span>
}

</code></pre>
<ol start="4">
<li>使用规范：</li>
</ol>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/aa43475fdb5949c2bb6227e0f44cb443~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2V2ZW5Db2Rpbmc=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768889327&amp;x-signature=%2BVEvjRf9%2BRJes4bO7%2BmIYdMvXAg%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-11">SPI机制实现原理</h2>
<p>那么问题来了： 怎么样才能加载这些SPI接口的实现类呢，真正的原因是Java的<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.seven97.top%2Fjava%2Fjvm%2F01-jvmbasic2-classloadingmechanism.html" target="_blank" title="https://www.seven97.top/java/jvm/01-jvmbasic2-classloadingmechanism.html" ref="nofollow noopener noreferrer">类加载机制</a>！ SPI接口属于java rt核心包，只能由启动类加载器BootStrap classLoader加载，而第三方jar包是用户classPath路径下，根据类加载器的可见性原则：启动类加载器无法加载这些jar包，也就是没法向下委托，所以spi必须打破这种传统的双亲委派机制，通过自定义的类加载器来加载第三方jar包下的spi接口实现类！</p>
<p>JDK中ServiceLoader方法的具体实现：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">//ServiceLoader实现了Iterable接口，可以遍历所有的服务实现者</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ServiceLoader</span>&lt;S&gt; <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Iterable</span>&lt;S&gt;{

    <span class="hljs-comment">//查找配置文件的目录</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">PREFIX</span> <span class="hljs-operator">=</span> <span class="hljs-string">"META-INF/services/"</span>;

    <span class="hljs-comment">//表示要被加载的服务的类或接口</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Class&lt;S&gt; service;

    <span class="hljs-comment">//这个ClassLoader用来定位，加载，实例化服务提供者</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> ClassLoader loader;

    <span class="hljs-comment">// 访问控制上下文</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> AccessControlContext acc;

    <span class="hljs-comment">// 缓存已经被实例化的服务提供者，按照实例化的顺序存储</span>
    <span class="hljs-keyword">private</span> LinkedHashMap&lt;String,S&gt; providers = <span class="hljs-keyword">new</span> <span class="hljs-title class_">LinkedHashMap</span>&lt;&gt;();

    <span class="hljs-comment">// 迭代器</span>
    <span class="hljs-keyword">private</span> LazyIterator lookupIterator;

    <span class="hljs-comment">//重新加载，就相当于重新创建ServiceLoader了，用于新的服务提供者安装到正在运行的Java虚拟机中的情况。</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">reload</span><span class="hljs-params">()</span> {
        <span class="hljs-comment">//清空缓存中所有已实例化的服务提供者</span>
        providers.clear();
        <span class="hljs-comment">//新建一个迭代器，该迭代器会从头查找和实例化服务提供者</span>
        lookupIterator = <span class="hljs-keyword">new</span> <span class="hljs-title class_">LazyIterator</span>(service, loader);
    }

    <span class="hljs-comment">//私有构造器</span>
    <span class="hljs-comment">//使用指定的类加载器和服务创建服务加载器</span>
    <span class="hljs-comment">//如果没有指定类加载器，使用系统类加载器，就是应用类加载器。</span>
    <span class="hljs-keyword">private</span> <span class="hljs-title function_">ServiceLoader</span><span class="hljs-params">(Class&lt;S&gt; svc, ClassLoader cl)</span> {
        service = Objects.requireNonNull(svc, <span class="hljs-string">"Service interface cannot be null"</span>);
        loader = (cl == <span class="hljs-literal">null</span>) ? ClassLoader.getSystemClassLoader() : cl;
        acc = (System.getSecurityManager() != <span class="hljs-literal">null</span>) ? AccessController.getContext() : <span class="hljs-literal">null</span>;
        reload();
    }

    <span class="hljs-comment">//解析失败处理的方法</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">fail</span><span class="hljs-params">(Class&lt;?&gt; service, String msg, Throwable cause)</span>
        <span class="hljs-keyword">throws</span> ServiceConfigurationError
    {
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ServiceConfigurationError</span>(service.getName() + <span class="hljs-string">": "</span> + msg,
                                            cause);
    }

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">fail</span><span class="hljs-params">(Class&lt;?&gt; service, String msg)</span>
        <span class="hljs-keyword">throws</span> ServiceConfigurationError
    {
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ServiceConfigurationError</span>(service.getName() + <span class="hljs-string">": "</span> + msg);
    }

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">fail</span><span class="hljs-params">(Class&lt;?&gt; service, URL u, <span class="hljs-type">int</span> line, String msg)</span>
        <span class="hljs-keyword">throws</span> ServiceConfigurationError
    {
        fail(service, u + <span class="hljs-string">":"</span> + line + <span class="hljs-string">": "</span> + msg);
    }

    <span class="hljs-comment">//解析服务提供者配置文件中的一行</span>
    <span class="hljs-comment">//首先去掉注释校验，然后保存</span>
    <span class="hljs-comment">//返回下一行行号</span>
    <span class="hljs-comment">//重复的配置项和已经被实例化的配置项不会被保存</span>
    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> <span class="hljs-title function_">parseLine</span><span class="hljs-params">(Class&lt;?&gt; service, URL u, BufferedReader r, <span class="hljs-type">int</span> lc, List&lt;String&gt; names)</span>
        	<span class="hljs-keyword">throws</span> IOException, ServiceConfigurationError{
        <span class="hljs-comment">//读取一行</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">ln</span> <span class="hljs-operator">=</span> r.readLine();
        <span class="hljs-keyword">if</span> (ln == <span class="hljs-literal">null</span>) {
            <span class="hljs-keyword">return</span> -<span class="hljs-number">1</span>;
        }
        <span class="hljs-comment">//#号代表注释行</span>
        <span class="hljs-type">int</span> <span class="hljs-variable">ci</span> <span class="hljs-operator">=</span> ln.indexOf(<span class="hljs-string">'#'</span>);
        <span class="hljs-keyword">if</span> (ci &gt;= <span class="hljs-number">0</span>) ln = ln.substring(<span class="hljs-number">0</span>, ci);
        ln = ln.trim();
        <span class="hljs-type">int</span> <span class="hljs-variable">n</span> <span class="hljs-operator">=</span> ln.length();
        <span class="hljs-keyword">if</span> (n != <span class="hljs-number">0</span>) {
            <span class="hljs-keyword">if</span> ((ln.indexOf(<span class="hljs-string">' '</span>) &gt;= <span class="hljs-number">0</span>) || (ln.indexOf(<span class="hljs-string">'\t'</span>) &gt;= <span class="hljs-number">0</span>))
                fail(service, u, lc, <span class="hljs-string">"Illegal configuration-file syntax"</span>);
            <span class="hljs-type">int</span> <span class="hljs-variable">cp</span> <span class="hljs-operator">=</span> ln.codePointAt(<span class="hljs-number">0</span>);
            <span class="hljs-keyword">if</span> (!Character.isJavaIdentifierStart(cp))
                fail(service, u, lc, <span class="hljs-string">"Illegal provider-class name: "</span> + ln);
            <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> Character.charCount(cp); i &lt; n; i += Character.charCount(cp)) {
                cp = ln.codePointAt(i);
                <span class="hljs-keyword">if</span> (!Character.isJavaIdentifierPart(cp) &amp;&amp; (cp != <span class="hljs-string">'.'</span>))
                    fail(service, u, lc, <span class="hljs-string">"Illegal provider-class name: "</span> + ln);
            }
            <span class="hljs-keyword">if</span> (!providers.containsKey(ln) &amp;&amp; !names.contains(ln))
                names.add(ln);
        }
        <span class="hljs-keyword">return</span> lc + <span class="hljs-number">1</span>;
    }

    <span class="hljs-comment">//解析配置文件，解析指定的url配置文件</span>
    <span class="hljs-comment">//使用parseLine方法进行解析，未被实例化的服务提供者会被保存到缓存中去</span>
    <span class="hljs-keyword">private</span> Iterator&lt;String&gt; <span class="hljs-title function_">parse</span><span class="hljs-params">(Class&lt;?&gt; service, URL u)</span> <span class="hljs-keyword">throws</span> ServiceConfigurationError{
        <span class="hljs-type">InputStream</span> <span class="hljs-variable">in</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;
        <span class="hljs-type">BufferedReader</span> <span class="hljs-variable">r</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;
        ArrayList&lt;String&gt; names = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();
        <span class="hljs-keyword">try</span> {
            in = u.openStream();
            r = <span class="hljs-keyword">new</span> <span class="hljs-title class_">BufferedReader</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">InputStreamReader</span>(in, <span class="hljs-string">"utf-8"</span>));
            <span class="hljs-type">int</span> <span class="hljs-variable">lc</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span>;
            <span class="hljs-keyword">while</span> ((lc = parseLine(service, u, r, lc, names)) &gt;= <span class="hljs-number">0</span>);
        }
        <span class="hljs-keyword">return</span> names.iterator();
    }

    <span class="hljs-comment">//服务提供者查找的迭代器</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">LazyIterator</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Iterator</span>&lt;S&gt;{

        Class&lt;S&gt; service;<span class="hljs-comment">//服务提供者接口</span>
        ClassLoader loader;<span class="hljs-comment">//类加载器</span>
        Enumeration&lt;URL&gt; configs = <span class="hljs-literal">null</span>;<span class="hljs-comment">//保存实现类的url</span>
        Iterator&lt;String&gt; pending = <span class="hljs-literal">null</span>;<span class="hljs-comment">//保存实现类的全名</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">nextName</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<span class="hljs-comment">//迭代器中下一个实现类的全名</span>

        <span class="hljs-keyword">private</span> <span class="hljs-title function_">LazyIterator</span><span class="hljs-params">(Class&lt;S&gt; service, ClassLoader loader)</span> {
            <span class="hljs-built_in">this</span>.service = service;
            <span class="hljs-built_in">this</span>.loader = loader;
        }

        <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">hasNextService</span><span class="hljs-params">()</span> {
            <span class="hljs-keyword">if</span> (nextName != <span class="hljs-literal">null</span>) {
                <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
            }
            <span class="hljs-keyword">if</span> (configs == <span class="hljs-literal">null</span>) {
                <span class="hljs-keyword">try</span> {
                    <span class="hljs-type">String</span> <span class="hljs-variable">fullName</span> <span class="hljs-operator">=</span> PREFIX + service.getName();
                    <span class="hljs-keyword">if</span> (loader == <span class="hljs-literal">null</span>)
                        configs = ClassLoader.getSystemResources(fullName);
                    <span class="hljs-keyword">else</span>
                        configs = loader.getResources(fullName);
                }
            }
            <span class="hljs-keyword">while</span> ((pending == <span class="hljs-literal">null</span>) || !pending.hasNext()) {
                <span class="hljs-keyword">if</span> (!configs.hasMoreElements()) {
                    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
                }
                pending = parse(service, configs.nextElement());
            }
            nextName = pending.next();
            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
        }

        <span class="hljs-keyword">private</span> S <span class="hljs-title function_">nextService</span><span class="hljs-params">()</span> {
            <span class="hljs-keyword">if</span> (!hasNextService())
                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">NoSuchElementException</span>();
            <span class="hljs-type">String</span> <span class="hljs-variable">cn</span> <span class="hljs-operator">=</span> nextName;
            nextName = <span class="hljs-literal">null</span>;
            Class&lt;?&gt; c = <span class="hljs-literal">null</span>;
            <span class="hljs-keyword">try</span> {
                c = Class.forName(cn, <span class="hljs-literal">false</span>, loader);
            }
            <span class="hljs-keyword">if</span> (!service.isAssignableFrom(c)) {
                fail(service, <span class="hljs-string">"Provider "</span> + cn  + <span class="hljs-string">" not a subtype"</span>);
            }
            <span class="hljs-keyword">try</span> {
                <span class="hljs-type">S</span> <span class="hljs-variable">p</span> <span class="hljs-operator">=</span> service.cast(c.newInstance());
                providers.put(cn, p);
                <span class="hljs-keyword">return</span> p;
            }
        }

        <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">hasNext</span><span class="hljs-params">()</span> {
            <span class="hljs-keyword">if</span> (acc == <span class="hljs-literal">null</span>) {
                <span class="hljs-keyword">return</span> hasNextService();
            } <span class="hljs-keyword">else</span> {
                PrivilegedAction&lt;Boolean&gt; action = <span class="hljs-keyword">new</span> <span class="hljs-title class_">PrivilegedAction</span>&lt;Boolean&gt;() {
                    <span class="hljs-keyword">public</span> Boolean <span class="hljs-title function_">run</span><span class="hljs-params">()</span> { <span class="hljs-keyword">return</span> hasNextService(); }
                };
                <span class="hljs-keyword">return</span> AccessController.doPrivileged(action, acc);
            }
        }

        <span class="hljs-keyword">public</span> S <span class="hljs-title function_">next</span><span class="hljs-params">()</span> {
            <span class="hljs-keyword">if</span> (acc == <span class="hljs-literal">null</span>) {
                <span class="hljs-keyword">return</span> nextService();
            } <span class="hljs-keyword">else</span> {
                PrivilegedAction&lt;S&gt; action = <span class="hljs-keyword">new</span> <span class="hljs-title class_">PrivilegedAction</span>&lt;S&gt;() {
                    <span class="hljs-keyword">public</span> S <span class="hljs-title function_">run</span><span class="hljs-params">()</span> { <span class="hljs-keyword">return</span> nextService(); }
                };
                <span class="hljs-keyword">return</span> AccessController.doPrivileged(action, acc);
            }
        }

        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">remove</span><span class="hljs-params">()</span> {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UnsupportedOperationException</span>();
        }

    }

    <span class="hljs-comment">//获取迭代器</span>
    <span class="hljs-comment">//返回遍历服务提供者的迭代器</span>
    <span class="hljs-comment">//以懒加载的方式加载可用的服务提供者</span>
    <span class="hljs-comment">//懒加载的实现是：解析配置文件和实例化服务提供者的工作由迭代器本身完成</span>
    <span class="hljs-keyword">public</span> Iterator&lt;S&gt; <span class="hljs-title function_">iterator</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Iterator</span>&lt;S&gt;() {
            <span class="hljs-comment">//按照实例化顺序返回已经缓存的服务提供者实例</span>
            Iterator&lt;Map.Entry&lt;String,S&gt;&gt; knownProviders
                = providers.entrySet().iterator();

            <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">hasNext</span><span class="hljs-params">()</span> {
                <span class="hljs-keyword">if</span> (knownProviders.hasNext())
                    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
                <span class="hljs-keyword">return</span> lookupIterator.hasNext();
            }

            <span class="hljs-keyword">public</span> S <span class="hljs-title function_">next</span><span class="hljs-params">()</span> {
                <span class="hljs-keyword">if</span> (knownProviders.hasNext())
                    <span class="hljs-keyword">return</span> knownProviders.next().getValue();
                <span class="hljs-keyword">return</span> lookupIterator.next();
            }

            <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">remove</span><span class="hljs-params">()</span> {
                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UnsupportedOperationException</span>();
            }

        };
    }

    <span class="hljs-comment">//为指定的服务使用指定的类加载器来创建一个ServiceLoader</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> &lt;S&gt; ServiceLoader&lt;S&gt; <span class="hljs-title function_">load</span><span class="hljs-params">(Class&lt;S&gt; service, ClassLoader loader)</span>{
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ServiceLoader</span>&lt;&gt;(service, loader);
    }

    <span class="hljs-comment">//使用线程上下文的类加载器来创建ServiceLoader</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> &lt;S&gt; ServiceLoader&lt;S&gt; <span class="hljs-title function_">load</span><span class="hljs-params">(Class&lt;S&gt; service)</span> {
        <span class="hljs-type">ClassLoader</span> <span class="hljs-variable">cl</span> <span class="hljs-operator">=</span> Thread.currentThread().getContextClassLoader();
        <span class="hljs-keyword">return</span> ServiceLoader.load(service, cl);
    }

    <span class="hljs-comment">//使用扩展类加载器为指定的服务创建ServiceLoader</span>
    <span class="hljs-comment">//只能找到并加载已经安装到当前Java虚拟机中的服务提供者，应用程序类路径中的服务提供者将被忽略</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> &lt;S&gt; ServiceLoader&lt;S&gt; <span class="hljs-title function_">loadInstalled</span><span class="hljs-params">(Class&lt;S&gt; service)</span> {
        <span class="hljs-type">ClassLoader</span> <span class="hljs-variable">cl</span> <span class="hljs-operator">=</span> ClassLoader.getSystemClassLoader();
        <span class="hljs-type">ClassLoader</span> <span class="hljs-variable">prev</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;
        <span class="hljs-keyword">while</span> (cl != <span class="hljs-literal">null</span>) {
            prev = cl;
            cl = cl.getParent();
        }
        <span class="hljs-keyword">return</span> ServiceLoader.load(service, prev);
    }

    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">toString</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-string">"java.util.ServiceLoader["</span> + service.getName() + <span class="hljs-string">"]"</span>;
    }

}
</code></pre>
<ol>
<li><strong>首先</strong>，ServiceLoader实现了Iterable接口，所以它有迭代器的属性，这里主要都是实现了迭代器的 hasNext 和 next 方法。这里主要都是调用的lookupIterator的相应hasNext和next方法，lookupIterator是懒加载迭代器。</li>
<li><strong>其次</strong>，LazyIterator 中的 hasNext 方法，静态变量PREFIX就是”META-INF/services/”目录，这也就是为什么需要在classpath下的META-INF/services/目录里创建一个以服务接口命名的文件。</li>
<li><strong>最后</strong>，通过反射方法Class.forName()加载类对象，并用newInstance方法将类实例化，并把实例化后的类缓存到providers对象中，(LinkedHashMap&lt;String,S&gt;类型）然后返回实例对象。</li>
</ol>
<p>所以可以看到ServiceLoader不是实例化以后，就去读取配置文件中的具体实现，并进行实例化。而是等到使用迭代器去遍历的时候，才会加载对应的配置文件去解析，调用hasNext方法的时候会去加载配置文件进行解析，调用next方法的时候进行实例化并缓存。</p>
<p>所有的配置文件只会加载一次，服务提供者也只会被实例化一次，重新加载配置文件可使用reload方法。</p>
<h2 data-id="heading-12">JDK SPI机制的缺陷</h2>
<p>通过上面的解析，可以发现，我们使用SPI机制的缺陷：</p>
<ul>
<li>
<p>获取某个实现类的方式不够灵活，只能通过 Iterator 形式获取，不能根据某个参数来获取对应的实现类。如果不想用某些实现类，或者某些类实例化很耗时，它也被载入并实例化了，这就造成了浪费。</p>
</li>
<li>
<p>多个并发多线程使用 ServiceLoader 类的实例是不安全的</p>
</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[京东零售广告创意：统一的布局生成和评估模型]]></title>    <link>https://juejin.cn/post/7594514040916688923</link>    <guid>https://juejin.cn/post/7594514040916688923</guid>    <pubDate>2026-01-13T06:09:36.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7594514040916688923" data-draft-id="7594415509607317550" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="京东零售广告创意：统一的布局生成和评估模型"/> <meta itemprop="keywords" content="程序员"/> <meta itemprop="datePublished" content="2026-01-13T06:09:36.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="京东云开发者"/> <meta itemprop="url" content="https://juejin.cn/user/2634854380340008"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            京东零售广告创意：统一的布局生成和评估模型
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2634854380340008/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    京东云开发者
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-13T06:09:36.000Z" title="Tue Jan 13 2026 06:09:36 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>作者：冯伟</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c1979a23781d4a23979bcbbfdd09c49a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768889376&amp;x-signature=4ADkuRzvrJaCUKh0%2FaSWiB8sxSg%3D" alt="" loading="lazy"/></p>
<p>﻿﻿</p>
<p>MM2025: Uni-Layout: Integrating Human Feedback in Unified Layout Generation and Evaluation</p>
<p>论文链接：<a href="https://link.juejin.cn?target=https%3A%2F%2Farxiv.org%2Fabs%2F2508.02374" target="_blank" title="https://arxiv.org/abs/2508.02374" ref="nofollow noopener noreferrer">arxiv.org/abs/2508.02…</a>﻿</p>
<p>代码链接：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FJD-GenX%2FUni-Layout" target="_blank" title="https://github.com/JD-GenX/Uni-Layout" ref="nofollow noopener noreferrer">github.com/JD-GenX/Uni…</a>﻿</p>
<p>﻿</p>
<p>摘要：布局生成在电商图片的设计中起到至关重要的作用。当前的布局生成方法在能力上具有任务特定性，并且评估标准与人类感知不一致，导致其应用范围有限且评估效果不佳。为了解决这些问题，Uni-Layout实现了统一生成、模拟人类的评估以及二者之间的对齐。针对通用生成，该框架将各种布局任务整合到一个统一的分类系统中，并开发了一个统一的生成器，通过自然语言提示处理背景或元素内容受限的任务。为了引入人类反馈以有效评估布局，我们构建了Layout-HF100k，这是首个包含10万个人工标注布局的大规模人类反馈数据集。基于Layout-HF100k，我们引入了一种模拟人类的评估器，该评估器结合视觉和几何信息，采用思维链机制进行定性评估，并通过信心估计模块提供定量测量。为了更好地对齐生成器和评估器，我们采用动态边距偏好优化（DMPO）技术，将二者整合为一个协调系统，以更好地符合人类判断。</p>
<h2 data-id="heading-0">一、背景及现状</h2>
<p>布局生成旨在为给定的元素设计吸引人的视觉排版，涵盖从海报和文档设计到用户界面布局和杂志排版等广泛任务。虽然生成模型取得了显著进展，但现有方法通常专注于狭义任务，导致解决方案缺乏灵活性和普适性。此外，尽管现有的评估指标基于布局设计原则精心设计，但它们常常与人类的感知不一致。如图1所示，高评分的布局可能在视觉质量上较差，这揭示了现有指标与真实人类感知之间的差距。为了解决这些挑战，我们提出了Uni-Layout，一个通过统一生成器、模拟人类的评估器和动态边距对齐机制来整合布局生成、评估和对齐的整体框架。为了详细阐述Uni-Layout，本文围绕三个核心研究问题展开。</p>
<p>﻿</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9d390e83d1604ceebddcf9adf9081a19~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768889376&amp;x-signature=HSQfanmk4vFHI95SRMwaytmOFl4%3D" alt="" loading="lazy"/></p>
<p>﻿﻿</p>
<p>图1：布局生成任务的分类体系与动机阐述</p>
<h2 data-id="heading-1">二、如何实现跨任务的统一布局生成？</h2>
<p>为了系统地统一当前分散的布局生成任务领域，我们提出了一个基于两个维度的精心组织的分类法：背景和元素内容是自由的还是受限的。如图1所示，我们将现有的布局任务分为四种代表性类型：BFEF、BCEF、BFEC和BCEC。当前的任务特定方法在统一布局生成方面存在困难，但多模态大型语言模型（MLLMs）由于其通用的视觉-语言理解能力，提供了有前景的解决方案。利用MLLMs，我们提出了一个统一的布局生成器，其工作方式类似于一名熟练的设计师。该生成器结合视觉约束和文本指令来生成连贯的布局，能够处理背景和元素内容既可以受限也可以自由的多种场景。通过在各种布局任务上的联合训练，它为布局生成提供了一个灵活且统一的解决方案。</p>
<p>为了统一多种布局任务，一个通用的布局任务指令可写作：</p>
<p>﻿</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/48fec20f7d6e4acc93b3e08246dd6c82~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768889376&amp;x-signature=8Xh%2BQLqx2eoTySMX%2F%2F%2FFpJBP4hw%3D" alt="" loading="lazy"/></p>
<p>﻿﻿</p>
<p>其中T为任务描述，b表示背景的内容和属性，e表示元素的内容和属性，O是指定的输出格式。注意背景和元素的属性是必须的，但其内容可为空。为了清楚起见，我们针对BCEC任务提供了一个说明示例，其中下划线部分对应上式中的对应项。</p>
<p>﻿</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4f1ff5f4a07c462bb748dfb7f580d871~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768889376&amp;x-signature=TVEJMnzEIPR81D8Ub4fmyLOpYyo%3D" alt="" loading="lazy"/></p>
<p>﻿﻿</p>
<p>﻿</p>
<h2 data-id="heading-2">三、如何模拟人类来评估布局？</h2>
<p>尽管人类感知在布局设计中非常重要，但现有数据集中缺乏对布局质量的人类反馈。为弥补这一缺口，我们汇总了统一生成器的输出，并编制了Layout-HF100k，这是首个专为布局生成策划的全面人类反馈数据集，包含10万个精心标注的高质量示例，涵盖代表性布局任务。该数据集的示例如图2所示。</p>
<p>﻿</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f486b516de23439bb1a9670f841a30f2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768889376&amp;x-signature=USEpMWPVfwDorbt4VziY3ccVcQk%3D" alt="" loading="lazy"/></p>
<p>﻿﻿</p>
<p>图2：Layout-HF100k示例。第一/二行分别为合格/不合格布局。</p>
<p>基于这一全新的数据集，我们开发了一种评估器，结构如图3（b）和（c）所示。其通过视觉和几何信息两个分支处理布局，以有效模拟人类判断模式。此外，该评估器结合了一个输出定量置信度估计的分类头，以及定性“思维链”（CoT）推理，使其能够捕捉微妙的审美偏好，并提供与人类感知模式紧密对齐的可解释评估。通过结合多模态分析和CoT推理，我们的评估器不仅能够做出准确判断，还能阐明其决策背后的理由，类似于人类专家如何评估布局。</p>
<p>具体来说，CoT包含以下四个步骤：</p>
<p>(1) 布局概览：对布局可视化结果快速而全面的扫描，通过简洁的文本描述捕捉布局的第一印象，概述整体构图和上下文元素。</p>
<p>(2) 空间解构：系统地分解布局的基本组成部分，分析几何属性和空间关系。它检查对齐模式、识别潜在重叠，并评估间距一致性，以揭示潜在的结构框架。</p>
<p>(3) 美学评估：对布局的视觉质量进行详细评估，重点关注艺术价值和设计原则。这包括对比例平衡、空间和谐和视觉节奏的评估，同时考虑这些元素如何对整体美学效果产生影响。</p>
<p>(4) 全面评估：最后阶段综合所有先前分析的见解，以提供对布局有效性的全面评估，最后给出“合格”或“不合格”的明确判断。</p>
<p>﻿</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4126fe4426904eb9bccecaf83aa4f30e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768889376&amp;x-signature=FToOYhNRsC96qYDH0%2FxnJ%2F6nzUc%3D" alt="" loading="lazy"/></p>
<p>﻿﻿</p>
<p>图3：Uni-Layout框架概览</p>
<h2 data-id="heading-3">四、如何有效对齐人类反馈和布局生成？</h2>
<p>现有的对齐方法要么直接最大化人类偏好的输出可能性，要么在其偏好学习目标中使用固定边距。这些传统方法未能反映人类偏好的不同程度，因为它们对强偏好和弱偏好一视同仁。为了解决这一限制，我们提出了一种新的对齐方法，称为动态边距偏好优化（DMPO）。具体而言，当评估者在成对样本之间表现出更强烈的偏好时，DMPO会自动增加边距，以在胜出和失败的响应之间强制产生更大的分数差异，而对于不太明显的偏好则应用较小的边距。这种信心引导的自适应边距策略更好地捕捉了人类判断的范围，从而实现与布局生成和人类偏好的更精确对齐。</p>
<p>如图3（d）所示，给定任务指令和可选的背景或元素内容，生成器产生两个候选布局l1和l2。之后通过双分支处理器将布局结果转化为视觉和几何信息，并通过布局评估器产出候选布局的得分。我们将两种布局的分数差距定义如下：</p>
<p>﻿</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2f79f8947ff145f688a58360fb7e2db9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768889376&amp;x-signature=Ye1INJAol8YWK6kmFPzp68YLTEc%3D" alt="" loading="lazy"/></p>
<p>﻿﻿</p>
<p>﻿</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/627f4a8d776341bfaa4c19437970ed30~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768889376&amp;x-signature=8PieKGvMXBMbfw4Mm4VQ2uAaPm0%3D" alt="" loading="lazy"/></p>
<p>﻿﻿</p>
<p>其中I+和l+分别表示高分布局的视觉和几何信息。为了进一步增强对边距的感知，我们应用了非线性变换f()来处理分数差距。最终，DMPO的损失形式可写作：</p>
<p>﻿</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9f95501589ab462d9fb1e1cfed813ddf~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768889376&amp;x-signature=caPyI905OKwccmTgg7y2qX0jBhA%3D" alt="" loading="lazy"/></p>
<p>﻿﻿</p>
<p>通过将生成和评估整合到反馈循环中，DMPO弥合了布局生成和人类审美偏好之间的差距，产生了更具视觉吸引力的布局。</p>
<h2 data-id="heading-4">五、实验结果</h2>
<p>（1）布局评估模型性能</p>
<p>为了验证我们的评估器，我们将其与一些领先的闭源（M）LLM模型进行比较，包括GPT-4o、Claude3.5 Sonnet（Claude3.5）、GLM-4v和DeepSeek-R1。这些模型遵循“LLM-as-Judge”范式。所有模型接收相同的指令和视觉输入，除了DeepSeek-R1，它只处理文本。如表1所示，我们的模型表现出色，达到85.5%的准确率，比现有的MLLMs高出25-35%。一些MLLMs的表现接近随机（约50%），突显了它们在布局评估中的局限性。</p>
<p>﻿</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a676ed0c5cf64a43881e595b7bda7d8e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768889376&amp;x-signature=IwMFgHf3K%2Bgg2eeLq6n7wwaCPec%3D" alt="" loading="lazy"/></p>
<p>﻿﻿</p>
<p>表1 ：布局评估模型对比</p>
<p>（2）布局生成模型性能</p>
<p>在本小节中，我们与三类基线方法进行了比较：(1) 针对单个布局任务设计的任务特定SOTA模型（例如，LayoutDM）；(2) 闭源模型，包括GPT-4o、Claude3.5和DeepSeek-R1；(3) 开源的多模态大语言模型（MLLMs），如联合训练四个任务的LLaVA。</p>
<p>在表2展示的任务特定评估中，我们的方法在多个指标上表现出色。值得注意的是，在BFEF任务中，我们实现了最低的Ove（0.001）和Ali（0.00004），与专用模型如LayoutDM和LayoutFlow持平或超越。在BFEC任务中，我们的方法以最小的Ove（0.00045）和最高的Max.（0.439）创下新纪录。在BCEF任务中，我们在𝑅𝑐𝑜𝑚（31.848）和𝑅𝑠𝑢𝑏（0.774）方面取得了最佳结果。同样，在BCEC任务中，我们的方法以最低的𝑅𝑐𝑜𝑚（8.536）显著优于现有方法，同时在其他指标上保持竞争力。</p>
<p>﻿</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f3183d72df93417eb662ece3ffafdf39~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768889376&amp;x-signature=Zy4wVsgginm8pGWtbQnnpvHkddE%3D" alt="" loading="lazy"/></p>
<p>﻿﻿</p>
<p>表2：任务特定评估指标结果</p>
<p>针对所有任务的人类模拟评估，我们引入了评估模型的LR分数来评估性能。如图4所示，我们的方法实现了最高的LR分数0.702，在不同布局场景中表现出持续的优越性。与其他模型相比，我们显著超越了GPT-4o（0.584）、Claude3.5（0.575）和DeepSeek-R1（0.401），差距明显。与开源基线LLaVA（0.422）相比，性能差距更加显著，提升了近30%。与LayoutFlow（BFEF的SOTA）、P&amp;R（BFEC的SOTA）和Poster-Llama（BCEF和BCEC的SOTA）取得的平均LR分数0.658相比，我们的方法取得了更优的结果，从而验证了Uni-Layout的有效性。</p>
<p>﻿</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/27f032cea829447b980a980507c52f31~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768889376&amp;x-signature=mxFYwGlDm61YnxeZ2XUqJSccg3U%3D" alt="" loading="lazy"/></p>
<p>﻿﻿</p>
<p>图4： 人类模拟评估指标结果</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[京东多语言质量解决方案]]></title>    <link>https://juejin.cn/post/7594420277449474075</link>    <guid>https://juejin.cn/post/7594420277449474075</guid>    <pubDate>2026-01-13T06:15:49.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7594420277449474075" data-draft-id="7594420277449408539" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="京东多语言质量解决方案"/> <meta itemprop="keywords" content="程序员"/> <meta itemprop="datePublished" content="2026-01-13T06:15:49.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="京东云开发者"/> <meta itemprop="url" content="https://juejin.cn/user/2634854380340008"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            京东多语言质量解决方案
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2634854380340008/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    京东云开发者
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-13T06:15:49.000Z" title="Tue Jan 13 2026 06:15:49 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读12分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>作者：李小磊</p>
<h2 data-id="heading-0">一、业界多语言面临的通用挑战是什么</h2>
<p>做这个事之前，我们先看看业界做了什么。</p>
<p>•﻿<a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FxJW-HuBu6tNz-pCjAJIwBw" target="_blank" title="https://mp.weixin.qq.com/s/xJW-HuBu6tNz-pCjAJIwBw" ref="nofollow noopener noreferrer">阿里巴巴全球化测试技术介绍</a>﻿</p>
<p>•﻿<a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FE-QssSrIdZWo-kykNn4N3Q" target="_blank" title="https://mp.weixin.qq.com/s/E-QssSrIdZWo-kykNn4N3Q" ref="nofollow noopener noreferrer">蚂蚁全球化无线端质量解决方案</a>﻿</p>
<p>•﻿<a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FJB1AxTnGTvXyIQmnFLrrzg" target="_blank" title="https://mp.weixin.qq.com/s/JB1AxTnGTvXyIQmnFLrrzg" ref="nofollow noopener noreferrer">谈谈多语言测试</a>﻿</p>
<p>总结下来，需要面临3个通用问题：</p>
<p>1.语言物料生产阶段：对于存量未接入多语言平台（70%）的模块，会有潜在代码会未配置Key的问题，而对于已接入模块会出现错配置Key问题，最终导致端上的文案不展示及展示错误问题。</p>
<p>2.标准化流程缺失：在研发阶段，新增多语言文案的流程缺失，大部分模式是业务方、内容团队、开发同学通过翻译平台是弱管控。需要PRD语言类key标准化-&gt;翻译平台录入-&gt;研发流程流程门禁检测+端上测试-&gt;Key发布上线管理。</p>
<p>3.海外测试仿真度低：全球化用户遍布全球各地，质量同学想要真实模拟不同地区的用户的真实体验挑巨大，海外用户手机适配的挑战也将远远大于国内。且语言类特有的漏翻\错翻\文案截断问题在UI层的问题突出，而当前手工程度高，问题发现能力弱。与此同时可以预见，若扩充到其他语言时工作量会成倍增加。如下是全球用户在品牌、机型、系统和分辨率上的差异。</p>
<p>﻿</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f2d93abc88a54ed49b3b10be23522227~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768889749&amp;x-signature=TFybThY%2BJfuve0TCLtyTbf1R5Oo%3D" alt="" loading="lazy"/></p>
<p>﻿﻿</p>
<p>﻿</p>
<h2 data-id="heading-1">二、面临的挑战却远不止于此。因为我们京东商城是航母级的APP，意味着</h2>
<h3 data-id="heading-2"><strong>1. 产品形态多样</strong></h3>
<p>一般有4个维度：地区/国家 &amp; 语言 &amp; 币种 &amp; 时区</p>
<p><strong>地区国家：</strong> 0-大陆、5-港澳、7-台湾、8-美国、9-日本、10-新加坡、11-马来西亚、12-泰国、13-韩国、14-越南、15-柬埔寨、100-海外</p>
<p><strong>语言：</strong> 简体中文=zh_CN、美式英语=en_US、繁体中文=zh_HK（仅港澳台湾）</p>
<p><strong>币种：</strong></p>

















































































































<table><thead><tr><th><strong>用户设置币种</strong></th><th><strong>货币符号</strong></th><th><strong>展示类型</strong></th><th><strong>金额表达示例（10元）</strong></th></tr></thead><tbody><tr><td>HKD</td><td>HK$</td><td>B</td><td>HK$10.99</td></tr><tr><td>TWD</td><td>NT$</td><td>B</td><td>NT$10.99</td></tr><tr><td>USD</td><td>$</td><td>B</td><td>$10.99</td></tr><tr><td>JPY</td><td>JP¥</td><td>B</td><td>JP¥10</td></tr><tr><td>SGD</td><td>S$</td><td>B</td><td>S$10.99</td></tr><tr><td>MYR</td><td>RM</td><td>B</td><td>RM10.99</td></tr><tr><td>THB</td><td>฿</td><td>B</td><td>฿10.99</td></tr><tr><td>KRW</td><td>₩</td><td>B</td><td>₩10</td></tr><tr><td>VND</td><td>₫</td><td>B</td><td>₫10</td></tr><tr><td>KHR</td><td>៛</td><td>B</td><td>៛10.99</td></tr><tr><td>AUD</td><td>AU$</td><td>B</td><td>AU$10.99</td></tr><tr><td>AED</td><td>د.إ</td><td>A</td><td>د.إ10.99</td></tr><tr><td>EUR</td><td><strong>€</strong></td><td>B</td><td>€10.99</td></tr><tr><td>GBP</td><td><strong>£</strong></td><td>B</td><td>£10.99</td></tr><tr><td>CAD</td><td>CA$</td><td>B</td><td>CA$10.99</td></tr><tr><td>NZD</td><td>NZD$</td><td>B</td><td>NZD$10.99</td></tr><tr><td>MXN</td><td>Mex$</td><td>B</td><td>Mex$10.99</td></tr></tbody></table>
<p>﻿</p>
<p><strong>时区</strong>：</p>
<p>1.若用户设置语言是英文，则转换时区后用英语时间表达格式：日月年 时分秒。如：年月日 时分秒：2025-06-07 23:59:59，转换成英文：07 Jun 2025 23:59:59(UTC+8)</p>
<p>2.若用户设置语言是中文&amp;繁体，则转换时区后时间表达格式：年月日，时分秒。</p>
<p>3.返回目标地区的UTC时区值（T），时区由各模块自己判断是否要展示。</p>
<h3 data-id="heading-3">2. 技术栈多，技术架构复杂</h3>
<h4 data-id="heading-4">2.1 语言类-客户端</h4>
<p><strong>- 场景1：</strong> 端页面可从多语言SDK获取“国家/区域”，“语言”，“模式”参数，处理自定义的业务逻辑；<strong>网络请求使用“京东零售基础网路库”加载端页面。基础库负责统一上传“国家/区域”，“语言”，“模式”参数，端无须特殊处理。</strong></p>
<p><strong>- 场景2：</strong> 端页面可从多语言SDK获取“国家/区域”，“语言”，“模式”参数，处理自定义的业务逻辑；<strong>网络请求不使用“JD零售基础网路库”，端需要自己参照参数规则，上传“国家/区域”，“语言”，“模式”参数。</strong></p>
<h4 data-id="heading-5">2.2 语言类-后端</h4>
<p><strong>传递方式</strong>：客户端-&gt;网络库/非网络库-&gt;color网关/非color网关-&gt;SOA-&gt;后台服务（JSF隐式传参）。</p>
<p><strong>使用方式</strong>：服务端从全局上下文SDK中读取，不允许篡改。<strong>SOA及后台服务需要接入dongboot内核+donglog+dongcontext+dongthread</strong></p>
<h4 data-id="heading-6">2.3 汇率类-设计</h4>
<p>换算原则：SOA调用科技汇率接口获取汇率，传给价格源（到手价/原价团队/预售价）进行外币价格计算；若展示价格由中台计算，例如购物车勾选后价格和结算页支付价格，则由中台进行外币价格计算。核心页面外币金额展示示例：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8ae757805cb84f25bc6a108fba31857a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768889749&amp;x-signature=DU8DgGipt7F4bFCZ5QqpC2ne9iM%3D" alt="" loading="lazy"/></p>
<p>﻿</p>
<h4 data-id="heading-7">2.4 时区类-设计</h4>
<ol>
<li>
<p>当端SOA侧依赖的上游返回的String类型的文案里面如果包含日期或时间，由中后端上游进行时区转换。</p>
</li>
<li>
<p>当端SOA侧依赖的上游返回了时间戳/Date格式的日期或时间，由端SOA侧进行时区转换。</p>
</li>
</ol>
<p>全链路涉及模块：</p>
<p>﻿</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f41ec2038f034a53834728d786a3e9b8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768889749&amp;x-signature=KCIZFgfkUnng9vLCA4prXIZspj0%3D" alt="" loading="lazy"/></p>
<p>﻿﻿</p>
<p>﻿</p>
<h2 data-id="heading-8">三、对QA而言，挑战是巨大的，具体是什么？</h2>
<h4 data-id="heading-9">3.1 挑战一：覆盖的页面场景多，英文版2.0的围绕20+个业务，涵盖零售&amp;科技&amp;物流&amp;健康全链路。</h4>
<p>交易域：商详、结算、购物车、凑单、换购、订单/订详、收银台、支付成功、价保、店铺、售后</p>
<p>导购&amp;流量：首页、拍照购、分类、评价、消息中心、搜索、推荐、我京及核心二三级页、权益中心、plus、等级会员、发票、客服。</p>
<h4 data-id="heading-10">3.2 挑战二：页面 &amp; 语言 &amp; 汇率 &amp; 时区的笛卡尔积，将极大的增加测试验证工作量。</h4>
<p>除大陆站点外，中文模式下的时区<strong>也需要验证。</strong> 所以有更多的页面进入覆盖场景。如：咚咚客服、活动日历、短信、延保服务、账单。</p>
<h4 data-id="heading-11">3.3 挑战三：即使每个页面能否走到，每个页面的测试深度无法穷举。</h4>
<p>1.流量&amp;导购类页面千人千面，依赖于账户维度的丰富度。如：</p>
<p>2.交易类页面，依赖较多前置条件：如：</p>
<p>1.商详：楼层多，需要不同的SKU。</p>
<p>2.结算：楼层多，需要不同的SKU。</p>
<p>3.购物车：依赖账户加车状态、比如预售&amp;定金的时间表达</p>
<p>4.凑单：可能无法通过OpenAPP协议进入。</p>
<p>5.收银台：目前不支持OpenAPP协议进去。</p>
<p>6.订单：依赖账户内的订单、二级弹层不依赖于openAPP协议。</p>
<p>7.promise：“付款时间”保持和当前用户时区一致、“发货时间”和“送达时间”保持与收货地时区一致。</p>
<p>﻿</p>
<h2 data-id="heading-12">四、京东全球售-测试方案</h2>
<h3 data-id="heading-13">4.1 目标</h3>
<p>进行自动化问题检测，提升走查效率。提供修复建议，提升全球售本地化体验。</p>
<h3 data-id="heading-14">4.2 整体思路</h3>
<p>通过接口、页面、用户动线三层验证思路进行验证。并通过汇率接口限流，验证页面兜底情况。</p>
<h3 data-id="heading-15">4.3 策略一【接口层】通过梳理全量使用价格计算的接口，进行币种设置，批量测试。</h3>
<p><strong>面向中台：JSF接口设置DongContext，验证不同语言下的返回</strong>。如：台账 （PayResource.queryOrder - 查询应付金额（收银台））、到手价中台（<a href="https://link.juejin.cn?target=https%3A%2F%2Fjoyspace.jd.com%2Fpages%2FTav9wHASWJ3ufru6HW0K" target="_blank" title="https://joyspace.jd.com/pages/Tav9wHASWJ3ufru6HW0K" ref="nofollow noopener noreferrer">计算外币价格-结算网关接口文档</a>） 、价促平台（<a href="https://link.juejin.cn?target=https%3A%2F%2Fjoyspace.jd.com%2Fpages%2FYM8L8oc60kI16lZUdZd5" target="_blank" title="https://joyspace.jd.com/pages/YM8L8oc60kI16lZUdZd5" ref="nofollow noopener noreferrer">主站新增外币金额表达-接口文档</a>）、预售价中台（<a href="https://link.juejin.cn?target=https%3A%2F%2Fjoyspace.jd.com%2Fpages%2FY9ZM1rXUbLXTIEsUHTNA" target="_blank" title="https://joyspace.jd.com/pages/Y9ZM1rXUbLXTIEsUHTNA" ref="nofollow noopener noreferrer">4.2 批量获取当前进行中的预售</a>）。</p>
<p><strong>面向前台：</strong> <strong>color网关接口设置DongContext</strong>，验证不同语言就需要前台端SOA对接科技接口获取汇率，再从外币价格jar包获取外币金额，并前端表达。接口性能要求80ms，如果性能不足需要降级不展示。</p>
<p><strong>期望的结果</strong>：</p>
<p>•外币金额计算规则：外币金额=本币 X 汇率。</p>
<p>•外币金额小数点处理：VND（越南盾）、KRW（韩元）、JPY（日元）三个币种，外币金额四舍五入取整数；其他币种，外币金额四舍五入，最多保留2位小数，小数点后0要抹去。</p>
<h3 data-id="heading-16">4.3 策略二【页面级测试】一键触发核心场景组合，并自动化结果校验。</h3>
<p>﻿</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/baf4cf74d1cf4c45b6fa7de2f918e2b8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768889749&amp;x-signature=MthakQRUh%2FTYWcuah0SlcUGzeAg%3D" alt="" loading="lazy"/></p>
<p>﻿﻿</p>
<ol>
<li>核心场景组合定义：</li>
</ol>
<p>（P0）港澳-繁体-港币-UTC+8</p>
<p>（P0）台湾-英文-台币-UTC+8</p>
<p>（P0）新加坡-英文-新币-UTC+8</p>
<p>（P0）澳大利亚-英文-AUD-UTC+11</p>
<p>（P0）大陆-英文-美元-UTC+8</p>
<ol start="2">
<li>
<p>自动化切换、截图、跳转、文案检测识别。</p>
</li>
<li>
<p>结果验证，翻译错误、翻译质量。</p>
</li>
</ol>
<h3 data-id="heading-17">4.3 策略三：【常态化保鲜】通过APP回归、兜底演练动作防裂化</h3>
<p>1.一键触发：打通测试回归计划，多任务手动一键出发/定时触发/接口触发，输出报告需要对任务整体通过率计算。内容包括：遍历的页面，每个子任务（当成一条用例）除了展示完成的状态，还需要展示通过率，错误的个数，通过的个数等。</p>
<p>2.设备选择：实现基于系统、机型、分辨率、国内外品牌等维度筛选机型。</p>
<p>3.发版报告：①报告类增加小 i解释：通过/忽略的标准，例如明确告知除了人名/图片，其余内容均需进行翻译，以及相关类别问题的研发接口人。</p>
<h3 data-id="heading-18">4.4 策略四：【智能体Agent】<strong>探索智能体方案，进行翻译质量检测</strong></h3>
<p>基于赛博平台对各页面的识别结果，将接口中翻译后的内容提取出来并输送给智能体，由智能体来<strong>检测</strong>多语言<strong>翻译的准确性</strong>。</p>
<p>﻿</p>
<h2 data-id="heading-19">五、做到什么程度</h2>
<h3 data-id="heading-20">5.1 工程上的提效价值：</h3>
<p>•执行上：3240mins-&gt;30mins</p>
<p>•检测上：324mins-&gt;32.4mins</p>
<p>计算公式如下：</p>




















<table><thead><tr><th>﻿</th><th>Before</th><th>After</th></tr></thead><tbody><tr><td>UI层</td><td>执行：36个page ✖️ 9（站点+语言+币种） ✖️ 5 mins ✖️ 2端 = 3240mins 检测：648页面人工check * 0.5 mins = 324mins</td><td>执行上：子用例集维度： 1次执行（36个page并行） ✖️ （9个场景并行） ✖️ 30mins（ 双端并行）= 30mins 检测维度：目标90%的check可以通过检测脚本搞定。324 ✖️（1-90%）= 32.4mins。</td></tr><tr><td>API层</td><td>涉及color网关（4.8万接口）和非color网关接口，以及HSF接口</td><td>单接口调试及多接口回归自动化验证，可以提效约70%以上</td></tr></tbody></table>
<p><strong>结果展示1：聚合页对比10种场景</strong></p>
<p>﻿</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f1547ef18c7b4c099c57eb0ee8e5cbba~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768889749&amp;x-signature=PrHXer1fOhvgaCuJn%2BSunL61JVY%3D" alt="" loading="lazy"/></p>
<p>﻿﻿</p>
<p>提效10倍。计算公式：10（页面+语言+比重）* 3端的情况下：</p>
<p>•人工：10<em>3</em>5（分钟）=150min</p>
<p>•自动：15分钟</p>
<p><strong>结果展示2：自动检测</strong></p>
<p>﻿</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0f91ddaefa6546ae8559ab1dd1873ad0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768889749&amp;x-signature=Jt3E1CSbVdJE%2Fxly7dpECPRwq44%3D" alt="" loading="lazy"/></p>
<p>﻿﻿</p>
<p>提效100%。计算公式≈通过的问题数在总问题数中的比例，意味着是自动检测。</p>
<p>具体测试包括见：【15.3.20】- 多语言自动化测试报告。 （涉及到内部网站，请联系作者进行报告链接获取）</p>
<p>﻿</p>
<h3 data-id="heading-21">5.2 大模型上的实践价值：</h3>

















<table><thead><tr><th>翻译的精准度不够：item(s)</th><th>翻译截断</th><th>翻译不准确 scrape 本义 “刮擦”，引申为「技术爬虫抓取」，隐含 “非正常手段获取”“批量爬取” 的负面意味，应改为collection</th><th>中文未翻译</th></tr></thead><tbody><tr><td><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/35955b1b9ea04ef4b0f4d4b9540afa73~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768889749&amp;x-signature=35W4oO576AEKTjBCwVmzvwp88nI%3D" alt="" loading="lazy"/>﻿</td><td><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/60dee5fd33a34de48ee9ca95dcaf123a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768889749&amp;x-signature=AkEfL0v5lF5g4nYpDGuaROAPrHU%3D" alt="" loading="lazy"/>﻿</td><td><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/00d9886668414a988767ca8127e5f356~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768889749&amp;x-signature=ma8zyPVLwBCSSXxdWHpbt3RqY7s%3D" alt="" loading="lazy"/>﻿</td><td><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/47248be556004d36827a228538667920~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768889749&amp;x-signature=U40IZS4gIOvaAoMWNlZqtXeYHoU%3D" alt="" loading="lazy"/>﻿</td></tr></tbody></table>
<p>•15.2.80多语言翻译质量检测，发现13个翻译类问题。见<a href="https://link.juejin.cn?target=https%3A%2F%2Fjoyspace.jd.com%2Fpages%2FSo07Tw9myszm8oGUyJFI" target="_blank" title="https://joyspace.jd.com/pages/So07Tw9myszm8oGUyJFI" ref="nofollow noopener noreferrer">15.2.80多语言翻译质量检测报告</a>﻿</p>
<p>•智能体经过3轮优化，采纳率11%提升至85.71%。</p>
<h3 data-id="heading-22">5.3 零售研发流程的多语言升级价值</h3>









































<table><thead><tr><th><strong>场景/功能</strong></th><th><strong>详细描述</strong></th><th><strong>原型</strong></th><th/></tr></thead><tbody><tr><td><strong>创建设计</strong></td><td>创建设计时给出提醒</td><td>·选择迭代设计，选择需求后，识别需求的多语言字段 ·若打标为是，则给出黄色区域文案提示： ·所选需求涉及多语言，请在设计用例过程中重点关注 ·不涉及联调设计</td><td><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/147ae836b19645898e8df035ff7de010~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768889749&amp;x-signature=EdvAaJqlxYPq6u%2FKx5Wn6xP2Zhc%3D" alt="" loading="lazy"/>﻿</td></tr><tr><td><strong>编写用例</strong></td><td>编写用例时支持批量打标签</td><td>·目录、用例批量操作增加添加标签操作； ·点击添加标签，弹框展示标签输入的弹框，点击确定后，追加至所选用例的标签字段<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2a6e5e34124e408dae94fa08148af79b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768889749&amp;x-signature=pYkgEMVsB9wL7JpSj4pppVnNkmg%3D" alt="" loading="lazy"/>﻿ ·联调设计同步支持</td><td><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e8347487073c4dbdbc77d26edde209b1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768889749&amp;x-signature=6Wc0LE%2BAVh%2FfyFvaEst%2BPvMkPfY%3D" alt="" loading="lazy"/>﻿</td></tr><tr><td><strong>用例打标</strong></td><td>单用例详情页，支持用户打标签</td><td>多语言系统标签用户点击添加默认推荐出来</td><td><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2287f75fc44b4a7491d1c427415b04d7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768889749&amp;x-signature=GFZI5vDEkrLU%2FtwnHzIGr7nkvPE%3D" alt="" loading="lazy"/>﻿</td></tr><tr><td><strong>用例评审</strong></td><td>时给出提示提醒</td><td>点击评审完成时，判断下需求是否有对应标记，若有标记，则增加一个根据标签统计多语言用例的区域，若用例数为0，则0红色高亮显示，并展示建议补充文案 不涉及联调设计</td><td><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e3dbac8688df4855b7e326fdebafe425~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768889749&amp;x-signature=fvjV0sWeUiw5lk8Lo1UWBGQP%2FLY%3D" alt="" loading="lazy"/>﻿</td></tr><tr><td><strong>发版回归</strong></td><td>一键触发自动化巡检</td><td>·页面 x 语言 x 汇率 x 时区的的测试组合场景，进行高效执行和批量验证。 <a href="https://link.juejin.cn?target=http%3A%2F%2Fcyber.test.jd.com%2F%23%2Fautotest%2Fi18nAutomation%25C2%25B7%25E9%2595%25BF%25E6%259C%259F%25E8%25A7%2584%25E5%2588%2592%25EF%25BC%259A%25E4%25B8%2580%25E9%2594%25AE%25E6%258A%25A5Bug%25E3%2580%2581%25E5%258D%2595%25E6%25A8%25A1%25E5%259D%2597%25E5%25AE%259A%25E6%2597%25B6%25E5%25B7%25A1%25E6%25A3%2580%25E3%2580%2581%25E5%25B5%258C%25E5%2585%25A5APP%25E5%258F%2591%25E7%2589%2588%25E5%259B%259E%25E5%25BD%2592%25E5%25B9%25B3%25E5%258F%25B0%25E6%25B5%2581%25E7%25A8%258B%25E3%2580%2581%25E5%25A4%25A7%25E6%25A8%25A1%25E5%259E%258B%25E8%25B4%25A8%25E9%2587%258F%25E7%25BF%25BB%25E8%25AF%2591%25E5%25B5%258C%25E5%2585%25A5%25E5%25B9%25B3%25E5%258F%25B0%25E3%2580%2582" target="_blank" title="http://cyber.test.jd.com/#/autotest/i18nAutomation%C2%B7%E9%95%BF%E6%9C%9F%E8%A7%84%E5%88%92%EF%BC%9A%E4%B8%80%E9%94%AE%E6%8A%A5Bug%E3%80%81%E5%8D%95%E6%A8%A1%E5%9D%97%E5%AE%9A%E6%97%B6%E5%B7%A1%E6%A3%80%E3%80%81%E5%B5%8C%E5%85%A5APP%E5%8F%91%E7%89%88%E5%9B%9E%E5%BD%92%E5%B9%B3%E5%8F%B0%E6%B5%81%E7%A8%8B%E3%80%81%E5%A4%A7%E6%A8%A1%E5%9E%8B%E8%B4%A8%E9%87%8F%E7%BF%BB%E8%AF%91%E5%B5%8C%E5%85%A5%E5%B9%B3%E5%8F%B0%E3%80%82" ref="nofollow noopener noreferrer">cyber.test.jd.com/#/autotest/…</a></td><td>﻿</td></tr></tbody></table>
<p>﻿</p>
<h2 data-id="heading-23">六、未来规划</h2>
<h3 data-id="heading-24">6.1 大而全的质量保障整体方案</h3>
<ol>
<li>
<p>【已完成】标准化多语言研发流程。多语言检测能力覆盖整个语言生产过程。</p>
</li>
<li>
<p>【进行中】建设全球化测试体系化能力。测试资源：构建手机号、银行卡、支付账号、测试账号、云测真机、网络仿真，构建研测阶段的真实海外环境。效率&amp;体验：通过多端的功能的自动化，提升测试回归阶段的多机适配效率。通过多环境的app性能测试（核心页面、图片、视频），例如美国、印度和欧洲的页面秒开率会有很大区别，提前发现端侧性能问题。体验巡检：联合本地化外包、海外产设团队，进行线上用户体验走查，真实模拟用户现场发现体验问题。</p>
</li>
<li>
<p>【未开始】<strong>建设全球化安全生产体系</strong>。攻防演练：在多租户并行的部署架构下，进行域名、接口级别的攻防演练，提升系统的海外高可用性。海外压测：压测平台能力进行扩充，涵盖海外用户特征的压测数据及脚本以及多机房混压，提升海外服务稳定性。</p>
</li>
</ol>
<p>策略大图见下：</p>
<p>﻿</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6ddb227ca0334a8cb1cd2da0e8c79664~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768889749&amp;x-signature=7aLH6nq8RRnP%2F1Dx5YCiQNgoPis%3D" alt="" loading="lazy"/></p>
<p>﻿﻿</p>
<h3 data-id="heading-25">6.2 翻译质量智能体</h3>
<p>语言度量能力：通过<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FMicrosoftTranslator%2FGEMBA" target="_blank" title="https://github.com/MicrosoftTranslator/GEMBA" ref="nofollow noopener noreferrer">GPT Based MQM</a>（Multidimensional Quality Metrics），构建国际化水位分数，助力owner&amp;团队看清缺陷密度水位。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[破解Android悬浮窗遮挡无障碍服务难题：我在可见即可说上踩过的坑]]></title>    <link>https://juejin.cn/post/7593742881141604361</link>    <guid>https://juejin.cn/post/7593742881141604361</guid>    <pubDate>2026-01-12T01:00:48.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7593742881141604361" data-draft-id="7593177437081813043" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="破解Android悬浮窗遮挡无障碍服务难题：我在可见即可说上踩过的坑"/> <meta itemprop="keywords" content="Android,面试,前端"/> <meta itemprop="datePublished" content="2026-01-12T01:00:48.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="鹏程十八少"/> <meta itemprop="url" content="https://juejin.cn/user/184373685534077"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            破解Android悬浮窗遮挡无障碍服务难题：我在可见即可说上踩过的坑
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/184373685534077/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    鹏程十八少
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-12T01:00:48.000Z" title="Mon Jan 12 2026 01:00:48 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读14分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><strong>为什么你的Android悬浮窗"挡住"了无障碍服务</strong></p>
<p>Android  可见即可说  (语音悬浮窗口在，无障碍服务扫描不出系统卸载window)</p>
<h2 data-id="heading-0">1.完整需求： 语音说一句话：帮我把抖音里面的今天的奖励全部领完，红包领完！</h2>
<p>1）语音悬浮窗交互：</p>
<p>能自动点击悬浮窗下方的所有窗口（如抖音红包按钮）</p>
<p>点击悬浮窗空白区域 → 悬浮窗消失</p>
<p>悬浮窗内 RecyclerView 的点击事件需响应</p>
<h3 data-id="heading-1">效果图</h3>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2bc351be39344c3eb15b650b9fb935ec~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6bmP56iL5Y2B5YWr5bCR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768784448&amp;x-signature=u9KubdCm8Vxz7igRl2Mv07NunHU%3D" alt="语音.png" loading="lazy"/></p>
<h3 data-id="heading-2">1.2 具体详细需求：</h3>
<p>系统弹窗支持：</p>
<p>当语音指令为“卸载抖音”时：</p>
<p>先显示语音悬浮窗</p>
<p>再触发系统卸载弹窗（com.android.packageinstaller）</p>
<p>用户可通过语音控制点击“确定”或“取消”</p>
<h2 data-id="heading-3">2.核心问题：无障碍服务无法识别被悬浮窗完全遮挡的系统弹窗</h2>
<p>语音把系统的卸载window弹出，</p>
<p>语音可见即可说扫描不出卸载window，</p>
<p>导致无法实现确认按钮的可见即可说</p>
<h3 data-id="heading-4">2.2 问题现象</h3>
<p>当语音悬浮窗完全覆盖系统卸载弹窗时：</p>
<p>AccessibilityService 的 windows 列表中扫描不到 com.android.packageinstaller</p>
<p>只能扫描到 launcher 或 systemui</p>
<p>导致“可见即可说”功能失效，无法点击“确定/取消”</p>
<h3 data-id="heading-5">2.3 根本原因（Android 系统机制限制）</h3>
<p>表格</p>





















<table><thead><tr><th>原因</th><th>说明</th></tr></thead><tbody><tr><td><strong>窗口可见性判定</strong></td><td>Android Accessibility 服务<strong>不会返回被完全遮挡且不可交互的窗口</strong>的节点</td></tr><tr><td><strong>安全限制</strong></td><td>出于隐私和安全考虑，系统禁止通过无障碍服务读取被其他应用完全覆盖的 UI 层</td></tr><tr><td><strong>层级与类型相同</strong></td><td>语音悬浮窗 (<code>TYPE_SYSTEM</code>, layer=1) 与 launcher (<code>TYPE_APPLICATION</code>, layer=0) 不同；但卸载弹窗也是 <code>TYPE_APPLICATION</code>, layer=0，与 launcher 同级。当悬浮窗高度 95% 屏幕时，完全遮挡卸载弹窗 → 系统认为其“不可见”</td></tr></tbody></table>
<blockquote>
<p>✅ <strong>验证结论</strong>：只要悬浮窗<strong>未完全遮挡</strong>卸载弹窗（例如高度 ≤85%），无障碍服务就能正常扫描到 <code>packageinstaller</code>。</p>
</blockquote>
<h2 data-id="heading-6">3.分析问题</h2>
<h3 data-id="heading-7">3.1 之前同事写的代码逻辑：</h3>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">layoutParams</span> = new WindowManager.LayoutParams(
    MATCH_PARENT,
    WRAP_CONTENT,
    TYPE_APPLICATION_OVERLAY,
    FLAG_NOT_FOCUSABLE,
    TRANSLUCENT
)<span class="hljs-comment">;</span>
layoutParams.flags |= FLAG_LAYOUT_IN_SCREEN<span class="hljs-comment">;</span>
layoutParams.flags |= FLAG_NOT_TOUCH_MODAL<span class="hljs-comment">;      // ✅ 允许区域外触摸透传</span>
layoutParams.flags |= FLAG_WATCH_OUTSIDE_TOUCH<span class="hljs-comment">;  // 配合外部点击关闭</span>
</code></pre>
<h3 data-id="heading-8">3.2 无障碍服务中的“窗口替换”逻辑</h3>
<pre><code class="hljs language-ini" lang="ini">if (rootNode?.<span class="hljs-attr">packageName</span> == packageName || rootNode?.childCount == <span class="hljs-number">0</span>) {
    windows.forEach { window -&gt;
        window.root?.takeIf { rn -&gt;
            rn.packageName != packageName &amp;&amp; rn.childCount != 0
        }?.apply {
            <span class="hljs-attr">rootNode</span> = this  // 替换为非自身、非空的窗口根节点
        }
    }
}
</code></pre>
<p>目的：跳过语音悬浮窗自身，尝试使用其他窗口（如卸载弹窗）作为操作目标
失败原因：当卸载弹窗被完全遮挡 → windows 列表中根本不存在该窗口 → 替换失败</p>
<h3 data-id="heading-9">3.2  无障碍服务扫描的结果</h3>
<h3 data-id="heading-10">3.2.1 具体结果分3步骤：</h3>
<h6 data-id="heading-11">1).在桌面扫描的结果：</h6>
<pre><code class="hljs language-bash" lang="bash">2026-01-06 15:48:48.918 59779-59779 VoiceAcces...ityService com.tencent.voice              E  开始windows-------index: 0, window: AccessibilityWindowInfo[title=导航栏, displayId=0, <span class="hljs-built_in">id</span>=258, <span class="hljs-built_in">type</span>=TYPE_SYSTEM, layer=3, region=SkRegion((<span class="hljs-number">0</span>,<span class="hljs-number">1824</span>,<span class="hljs-number">864</span>,<span class="hljs-number">1920</span>)), bounds=Rect(0, 1824 - 864, 1920), focused=<span class="hljs-literal">false</span>, active=<span class="hljs-literal">false</span>, pictureInPicture=<span class="hljs-literal">false</span>, hasParent=<span class="hljs-literal">false</span>, isAnchored=<span class="hljs-literal">false</span>, hasChildren=<span class="hljs-literal">false</span>]; com.android.systemui
2026-01-06 15:48:48.919 59779-59779 VoiceAcces...ityService com.tencent.voice              E  开始windows-------index: 1, window: AccessibilityWindowInfo[title=null, displayId=0, <span class="hljs-built_in">id</span>=252, <span class="hljs-built_in">type</span>=TYPE_SYSTEM, layer=2, region=SkRegion((<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">864</span>,<span class="hljs-number">115</span>)), bounds=Rect(0, 0 - 864, 115), focused=<span class="hljs-literal">false</span>, active=<span class="hljs-literal">false</span>, pictureInPicture=<span class="hljs-literal">false</span>, hasParent=<span class="hljs-literal">false</span>, isAnchored=<span class="hljs-literal">false</span>, hasChildren=<span class="hljs-literal">false</span>]; com.android.systemui
2026-01-06 15:48:48.919 59779-59779 VoiceAcces...ityService com.tencent.voice              E  开始windows-------index: 2, window: AccessibilityWindowInfo[title=null, displayId=0, <span class="hljs-built_in">id</span>=265, <span class="hljs-built_in">type</span>=TYPE_SYSTEM, layer=1, region=SkRegion((<span class="hljs-number">0</span>,<span class="hljs-number">192</span>,<span class="hljs-number">864</span>,<span class="hljs-number">1824</span>)), bounds=Rect(0, 192 - 864, 1824), focused=<span class="hljs-literal">true</span>, active=<span class="hljs-literal">true</span>, pictureInPicture=<span class="hljs-literal">false</span>, hasParent=<span class="hljs-literal">false</span>, isAnchored=<span class="hljs-literal">false</span>, hasChildren=<span class="hljs-literal">false</span>]; com.tencent.voice
2026-01-06 15:48:48.920 59779-59779 VoiceAcces...ityService com.tencent.voice              E  开始windows-------index: 3, window: AccessibilityWindowInfo[title=大桌面, displayId=0, <span class="hljs-built_in">id</span>=250, <span class="hljs-built_in">type</span>=TYPE_APPLICATION, layer=0, region=SkRegion((<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">864</span>,<span class="hljs-number">1920</span>)), bounds=Rect(0, 0 - 864, 1920), focused=<span class="hljs-literal">false</span>, active=<span class="hljs-literal">false</span>, pictureInPicture=<span class="hljs-literal">false</span>, hasParent=<span class="hljs-literal">false</span>, isAnchored=<span class="hljs-literal">false</span>, hasChildren=<span class="hljs-literal">false</span>]; com.tencent.launcher
</code></pre>
<p>launcher: type=TYPE_APPLICATION, layer=0</p>
<h6 data-id="heading-12">2). 在桌面，然后弹出卸载框：</h6>
<pre><code class="hljs"> com.android.systemui -
com.android.packageinstaller 
</code></pre>
<p>卸载window：type=TYPE_APPLICATION, layer=0
不会扫描到桌面的window，被卸载弹框全部挡住, 处于同一层级
得出层级关系：卸载在最底层，layer=0</p>
<h6 data-id="heading-13">3).在桌面，语音悬浮窗出现之后，然后弹出卸载框：</h6>
<p>不正常是这个：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">2025-12-29 13:58:34.996  1900-1900  VoiceAcces...ityService com.tencent.voice              D  windows size:</span> <span class="hljs-number">4</span> 
                                                                                                     <span class="hljs-attr">windowArrStr:</span> <span class="hljs-string">com.android.systemui</span> <span class="hljs-bullet">-</span> <span class="hljs-string">visible:true</span> <span class="hljs-bullet">-</span> <span class="hljs-string">active:false</span> 
                                                                                                    <span class="hljs-string">com.android.systemui</span> <span class="hljs-bullet">-</span> <span class="hljs-string">visible:true</span> <span class="hljs-bullet">-</span> <span class="hljs-string">active:false</span> 
                                                                                                    <span class="hljs-string">com.tencent.voice</span> <span class="hljs-bullet">-</span> <span class="hljs-string">visible:true</span> <span class="hljs-bullet">-</span> <span class="hljs-string">active:true</span> 
                                                                                                    <span class="hljs-string">com.tencent.launcher</span> <span class="hljs-bullet">-</span> <span class="hljs-string">visible:true</span> <span class="hljs-bullet">-</span> <span class="hljs-string">active:false</span> 
<span class="hljs-number">2025-12-29 13:58:34.998  </span><span class="hljs-number">1900</span><span class="hljs-number">-1900</span>  <span class="hljs-string">VoiceAcces...ityService</span> <span class="hljs-string">com.tencent.voice</span>              <span class="hljs-string">D</span>  <span class="hljs-string">packageName:com.android.systemui</span>
                                                                                                    <span class="hljs-string">isActive:false</span>
                                                                                                    <span class="hljs-string">isAccessibilityFocused:false</span>
<span class="hljs-number">2025-12-29 13:58:34.999  </span><span class="hljs-number">1900</span><span class="hljs-number">-1900</span>  <span class="hljs-string">VoiceAcces...ityService</span> <span class="hljs-string">com.tencent.voice</span>              <span class="hljs-string">E</span>  <span class="hljs-string">替换节点前.......com.tencent.voice</span>
<span class="hljs-number">2025-12-29 13:58:34.999  </span><span class="hljs-number">1900</span><span class="hljs-number">-1900</span>  <span class="hljs-string">VoiceAcces...ityService</span> <span class="hljs-string">com.tencent.voice</span>              <span class="hljs-string">E</span>  <span class="hljs-string">替换节点后.......com.android.systemui</span>
<span class="hljs-number">2025-12-29 13:58:35.000  </span><span class="hljs-number">1900</span><span class="hljs-number">-1900</span>  <span class="hljs-string">VoiceAcces...ityService</span> <span class="hljs-string">com.tencent.voice</span>              <span class="hljs-string">D</span>  <span class="hljs-string">packageName:com.android.systemui</span>
                                                                                                    <span class="hljs-string">isActive:false</span>
                                                                                                    <span class="hljs-string">isAccessibilityFocused:false</span>
<span class="hljs-number">2025-12-29 13:58:35.000  </span><span class="hljs-number">1900</span><span class="hljs-number">-1900</span>  <span class="hljs-string">VoiceAcces...ityService</span> <span class="hljs-string">com.tencent.voice</span>              <span class="hljs-string">E</span>  <span class="hljs-string">替换节点前.......com.android.systemui</span>
<span class="hljs-number">2025-12-29 13:58:35.000  </span><span class="hljs-number">1900</span><span class="hljs-number">-1900</span>  <span class="hljs-string">VoiceAcces...ityService</span> <span class="hljs-string">com.tencent.voice</span>              <span class="hljs-string">E</span>  <span class="hljs-string">替换节点后.......com.android.systemui</span>
<span class="hljs-number">2025-12-29 13:58:35.001  </span><span class="hljs-number">1900</span><span class="hljs-number">-1900</span>  <span class="hljs-string">VoiceAcces...ityService</span> <span class="hljs-string">com.tencent.voice</span>              <span class="hljs-string">D</span>  <span class="hljs-string">packageName:com.tencent.voice</span>
                                                                                                    <span class="hljs-string">isActive:true</span>
                                                                                                    <span class="hljs-string">isAccessibilityFocused:false</span>
<span class="hljs-number">2025-12-29 13:58:35.003  </span><span class="hljs-number">1900</span><span class="hljs-number">-1900</span>  <span class="hljs-string">VoiceAcces...ityService</span> <span class="hljs-string">com.tencent.voice</span>              <span class="hljs-string">D</span>  <span class="hljs-string">packageName:com.tencent.launcher</span>
                                                                                                    <span class="hljs-string">isActive:false</span>
                                                                                                    <span class="hljs-string">isAccessibilityFocused:false</span>
<span class="hljs-number">2025-12-29 13:58:35.003  </span><span class="hljs-number">1900</span><span class="hljs-number">-1900</span>  <span class="hljs-string">VoiceAcces...ityService</span> <span class="hljs-string">com.tencent.voice</span>              <span class="hljs-string">E</span>  <span class="hljs-string">替换节点前.......com.android.systemui</span>
<span class="hljs-number">2025-12-29 13:58:35.003  </span><span class="hljs-number">1900</span><span class="hljs-number">-1900</span>  <span class="hljs-string">VoiceAcces...ityService</span> <span class="hljs-string">com.tencent.voice</span>              <span class="hljs-string">E</span>  <span class="hljs-string">替换节点后.......com.tencent.launcher</span>

</code></pre>
<p>原因应该是优先级：他们type相同
语音:        type=TYPE_SYSTEM, layer=1,
launcher: type=TYPE_APPLICATION, layer=0</p>
<h6 data-id="heading-14">期望正常是这个结果：</h6>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-number">2025</span><span class="hljs-number">-12</span><span class="hljs-number">-29</span> <span class="hljs-number">13</span>:<span class="hljs-number">55</span>:<span class="hljs-number">54.989</span>   <span class="hljs-number">565</span><span class="hljs-number">-565</span>   VoiceAcces...ityService com.tencent.voice              D  windows size: <span class="hljs-number">4</span> 
                                                                                                     windowArrStr: com.android.systemui - visible:<span class="hljs-literal">true</span> - active:<span class="hljs-literal">false</span> 
                                                                                                    com.android.systemui - visible:<span class="hljs-literal">true</span> - active:<span class="hljs-literal">false</span> 
                                                                                                    com.tencent.voice - visible:<span class="hljs-literal">true</span> - active:<span class="hljs-literal">true</span> 
                                                                                                    com.android.packageinstaller - visible:<span class="hljs-literal">true</span> - active:<span class="hljs-literal">false</span> 
<span class="hljs-number">2025</span><span class="hljs-number">-12</span><span class="hljs-number">-29</span> <span class="hljs-number">13</span>:<span class="hljs-number">55</span>:<span class="hljs-number">54.990</span>   <span class="hljs-number">565</span><span class="hljs-number">-565</span>   VoiceAcces...ityService com.tencent.voice              D  packageName:com.android.systemui
                                                                                                    isActive:<span class="hljs-literal">false</span>
                                                                                                    isAccessibilityFocused:<span class="hljs-literal">false</span>
<span class="hljs-number">2025</span><span class="hljs-number">-12</span><span class="hljs-number">-29</span> <span class="hljs-number">13</span>:<span class="hljs-number">55</span>:<span class="hljs-number">54.990</span>   <span class="hljs-number">565</span><span class="hljs-number">-565</span>   VoiceAcces...ityService com.tencent.voice              E  替换节点前.......com.tencent.voice
<span class="hljs-number">2025</span><span class="hljs-number">-12</span><span class="hljs-number">-29</span> <span class="hljs-number">13</span>:<span class="hljs-number">55</span>:<span class="hljs-number">54.990</span>   <span class="hljs-number">565</span><span class="hljs-number">-565</span>   VoiceAcces...ityService com.tencent.voice              E  替换节点后.......com.android.systemui
<span class="hljs-number">2025</span><span class="hljs-number">-12</span><span class="hljs-number">-29</span> <span class="hljs-number">13</span>:<span class="hljs-number">55</span>:<span class="hljs-number">54.991</span>   <span class="hljs-number">565</span><span class="hljs-number">-565</span>   VoiceAcces...ityService com.tencent.voice              D  packageName:com.android.systemui
                                                                                                    isActive:<span class="hljs-literal">false</span>
                                                                                                    isAccessibilityFocused:<span class="hljs-literal">false</span>
<span class="hljs-number">2025</span><span class="hljs-number">-12</span><span class="hljs-number">-29</span> <span class="hljs-number">13</span>:<span class="hljs-number">55</span>:<span class="hljs-number">54.992</span>   <span class="hljs-number">565</span><span class="hljs-number">-565</span>   VoiceAcces...ityService com.tencent.voice              E  替换节点前.......com.android.systemui
<span class="hljs-number">2025</span><span class="hljs-number">-12</span><span class="hljs-number">-29</span> <span class="hljs-number">13</span>:<span class="hljs-number">55</span>:<span class="hljs-number">54.992</span>   <span class="hljs-number">565</span><span class="hljs-number">-565</span>   VoiceAcces...ityService com.tencent.voice              E  替换节点后.......com.android.systemui
<span class="hljs-number">2025</span><span class="hljs-number">-12</span><span class="hljs-number">-29</span> <span class="hljs-number">13</span>:<span class="hljs-number">55</span>:<span class="hljs-number">54.992</span>   <span class="hljs-number">565</span><span class="hljs-number">-565</span>   VoiceAcces...ityService com.tencent.voice              D  packageName:com.tencent.voice
                                                                                                    isActive:<span class="hljs-literal">true</span>
                                                                                                    isAccessibilityFocused:<span class="hljs-literal">false</span>
<span class="hljs-number">2025</span><span class="hljs-number">-12</span><span class="hljs-number">-29</span> <span class="hljs-number">13</span>:<span class="hljs-number">55</span>:<span class="hljs-number">54.994</span>   <span class="hljs-number">565</span><span class="hljs-number">-565</span>   VoiceAcces...ityService com.tencent.voice              D  packageName:com.android.packageinstaller
                                                                                                    isActive:<span class="hljs-literal">false</span>
                                                                                                    isAccessibilityFocused:<span class="hljs-literal">false</span>
<span class="hljs-number">2025</span><span class="hljs-number">-12</span><span class="hljs-number">-29</span> <span class="hljs-number">13</span>:<span class="hljs-number">55</span>:<span class="hljs-number">54.995</span>   <span class="hljs-number">565</span><span class="hljs-number">-565</span>   VoiceAcces...ityService com.tencent.voice              E  替换节点前.......com.android.systemui
<span class="hljs-number">2025</span><span class="hljs-number">-12</span><span class="hljs-number">-29</span> <span class="hljs-number">13</span>:<span class="hljs-number">55</span>:<span class="hljs-number">54.995</span>   <span class="hljs-number">565</span><span class="hljs-number">-565</span>   VoiceAcces...ityService com.tencent.voice              E  替换节点后.......com.android.packageinstaller
</code></pre>
<h2 data-id="heading-15">4. 解决方案</h2>
<h3 data-id="heading-16">4.1 模仿手机厂商怎么处理的！ 看了下VIVO手机，</h3>
<p>先卸载，
发现语音悬浮后，不能再进行下一步的可见即可说！ 命中的是大模型，卸载按钮一样无法命中，如下图！</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4bcb80d8086a4033aa5abfc2f95a8a05~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6bmP56iL5Y2B5YWr5bCR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768784448&amp;x-signature=wXxRpbDoXmVCVwGZorDbsQl4ZbE%3D" alt="1000023139_免费视频转GIF_20260109_170019.gif" loading="lazy"/></p>
<p>如果悬浮窗完全挡住了下面的window，下面的window就不会被系统扫描到！
发现一个问题，我的悬浮窗完全挡住了.com.android.packageinstaller，window里面就扫描不出，扫描出了com.tentent.launcher, 如果我的悬浮窗没用完全挡住，就可以window里面就扫描出了.com.android.packageinstaller</p>
<h3 data-id="heading-17">📌 总结</h3>

















<table><thead><tr><th>问题原因</th><th>系统将完全被悬浮窗遮挡的窗口视为“不可见”，故 AccessibilityService 无法获取其根节点</th></tr></thead><tbody><tr><td>根本限制</td><td>Android 安全机制：不能通过 Accessibility 读取被完全遮挡/不可交互的窗口</td></tr><tr><td>推荐做法</td><td>1. 避免完全覆盖 2. 过滤掉自身和 SystemUI/Launcher 3. 结合 UsageStats 做兜底</td></tr></tbody></table>
<p>当时产品看了竞品没用实现，让我放手！ 我觉得修改系统framwork层可以解决，但是公司的framwork层太low了，只有自己想办法</p>
<h3 data-id="heading-18">4.1 避免完全遮挡（推荐临时方案）</h3>
<p>修改悬浮窗高度，留出顶部或底部空间</p>
<p>具体措施如下：
第一种临时方案：语音的悬浮窗不完全挡住系统的弹框，是可以扫描出来的！
翻看了源码： 无障碍服务扫描原理，从上往下扫描，当同级layer 的window，会根据优先级判断！ 前面的窗口完全挡住，会扫描不出
<strong>所以很容易想到临时方案：修改悬浮窗的宽度或者高度</strong>,</p>
<pre><code class="hljs language-ini" lang="ini">    // 设置窗口大小和位置
            int <span class="hljs-attr">screenHeight</span> = DisplayUtils.getScreenHeight(MainApplication.getApplication())<span class="hljs-comment">;</span>
            <span class="hljs-attr">layoutParams.height</span> = (int) (screenHeight * <span class="hljs-number">0.85</span>)<span class="hljs-comment">;</span>
            <span class="hljs-attr">layoutParams.format</span> = PixelFormat.TRANSLUCENT<span class="hljs-comment">;</span>
            <span class="hljs-attr">layoutParams.gravity</span> = Gravity.BOTTOM | Gravity.CENTER_HORIZONTAL<span class="hljs-comment">;</span>

</code></pre>
<p>因为治标不治本！我不考虑，打算先看现象</p>
<h4 data-id="heading-19">4.1.1 第二种临时方案   解决方案：.改变点击事件</h4>
<p>核心思路：</p>
<p>默认悬浮窗可点击（处理内部 RecyclerView）</p>
<p>当检测到系统弹窗出现时（如通过 UsageStats 或广播）：</p>
<p>将悬浮窗设为 不可点击 + 事件透传</p>
<p>即：FLAG_NOT_TOUCHABLE | FLAG_NOT_FOCUSABLE</p>
<p>用户操作完成后，恢复可点击状态</p>
<p>点击事件的详细分析：
1.如果是点击了安装之后，2s后，设置为不可点击，
上报后，如果是采集到了，设置为可点击！</p>
<pre><code class="hljs language-arduino" lang="arduino">   <span class="hljs-keyword">protected</span> WindowManager.<span class="hljs-function">LayoutParams <span class="hljs-title">getLayoutParams</span><span class="hljs-params">(<span class="hljs-type">boolean</span> clickable,<span class="hljs-type">int</span> orientation)</span> </span>{
        LogUtils.<span class="hljs-built_in">d</span>(TAG, <span class="hljs-string">"getLayoutParams: clickable = "</span> + clickable + <span class="hljs-string">" cardClickable = "</span> + cardClickable);
        mCurAsrClickable = clickable;
        <span class="hljs-keyword">if</span> (layoutParams == null) {
            layoutParams = <span class="hljs-keyword">new</span> WindowManager.<span class="hljs-built_in">LayoutParams</span>(WindowManager.LayoutParams.TYPE_APPLICATION);
            layoutParams.width = WindowManager.LayoutParams.WRAP_CONTENT;
            layoutParams.height = WindowManager.LayoutParams.WRAP_CONTENT;
            layoutParams.type = WindowManager.LayoutParams.TYPE_SYSTEM_ALERT;
            layoutParams.flags = WindowManager.LayoutParams.FLAG_NOT_FOCUSABLE;
            layoutParams.format = PixelFormat.TRANSLUCENT;<span class="hljs-comment">// 支持透明</span>
        }

        <span class="hljs-type">int</span> canTouchFlag = WindowManager.LayoutParams.FLAG_NOT_TOUCH_MODAL;
        <span class="hljs-type">int</span> cantTouchFlag = WindowManager.LayoutParams.FLAG_NOT_TOUCHABLE | WindowManager.LayoutParams.FLAG_NOT_FOCUSABLE;
        <span class="hljs-keyword">if</span> (clickable) {
            layoutParams.flags |= canTouchFlag;
            layoutParams.flags |= cantTouchFlag;
            layoutParams.flags ^= cantTouchFlag;
        } <span class="hljs-keyword">else</span> {
            layoutParams.flags |= cantTouchFlag;
            layoutParams.flags |= canTouchFlag;
            layoutParams.flags ^= canTouchFlag;
        }
</code></pre>
<h3 data-id="heading-20">4.2  方案二: 最优化终极解决方案 结合悬浮窗属性优化 + 无障碍服务智能处理：</h3>
<p>通过悬浮窗属性+ 替换可见即可说的window对象，替换节点解决！</p>
<h4 data-id="heading-21">4.2.1 悬浮窗的属性核心代码如下：</h4>
<pre><code class="hljs language-arduino" lang="arduino">  <span class="hljs-keyword">protected</span> WindowManager.<span class="hljs-function">LayoutParams <span class="hljs-title">getLayoutParams</span><span class="hljs-params">(<span class="hljs-type">boolean</span> clickable)</span> </span>{
        LogUtils.<span class="hljs-built_in">d</span>(TAG, <span class="hljs-string">"getLayoutParams: clickable = "</span> + clickable + <span class="hljs-string">" cardClickable = "</span> + cardClickable);
        mCurAsrClickable = clickable;
        <span class="hljs-keyword">if</span> (layoutParams == null) {
            layoutParams = <span class="hljs-keyword">new</span> WindowManager.<span class="hljs-built_in">LayoutParams</span>(
                    WindowManager.LayoutParams.MATCH_PARENT,
                    WindowManager.LayoutParams.WRAP_CONTENT,
                    WindowManager.LayoutParams.TYPE_APPLICATION_OVERLAY,
                    WindowManager.LayoutParams.FLAG_NOT_FOCUSABLE,
                    PixelFormat.TRANSLUCENT);

            layoutParams.format = PixelFormat.TRANSLUCENT;
            layoutParams.gravity = Gravity.BOTTOM | Gravity.CENTER_HORIZONTAL;

            layoutParams.flags |= WindowManager.LayoutParams.FLAG_LAYOUT_IN_SCREEN;

            <span class="hljs-comment">// 设置窗口标志 - 允许点击事件传递到下层</span>
            layoutParams.flags |= WindowManager.LayoutParams.FLAG_NOT_TOUCH_MODAL;
            layoutParams.flags |= WindowManager.LayoutParams.FLAG_WATCH_OUTSIDE_TOUCH;
        }

        <span class="hljs-comment">// 设置窗口大小和位置</span>
        <span class="hljs-type">int</span> screenHeight = DisplayUtils.<span class="hljs-built_in">getScreenHeight</span>(MainApplication.<span class="hljs-built_in">getApplication</span>());
        layoutParams.height = (<span class="hljs-type">int</span>) (screenHeight * <span class="hljs-number">0.95</span>);

        <span class="hljs-comment">//根据屏幕方向，动态设置宽度</span>
        <span class="hljs-keyword">if</span> (DisplayUtils.<span class="hljs-built_in">isLandscape</span>(GlobalApplication.mGlobalContext)) {
            layoutParams.width = DisplayUtils.<span class="hljs-built_in">dp2px</span>(MainApplication.<span class="hljs-built_in">getApplication</span>(), <span class="hljs-number">348f</span>);
        } <span class="hljs-keyword">else</span> {
            layoutParams.width = WindowManager.LayoutParams.MATCH_PARENT;
        }

        LogUtils.<span class="hljs-built_in">d</span>(TAG, <span class="hljs-string">"-----height: "</span> + layoutParams.height);
        <span class="hljs-keyword">return</span> layoutParams;
    }
</code></pre>
<h4 data-id="heading-22">4.2.2 可见即可说，无障碍服务替换window的核心代码如下:</h4>
<pre><code class="hljs language-javascript" lang="javascript">            <span class="hljs-comment">// 第一步：在 threadRoot 线程中获取根节点</span>
            <span class="hljs-title class_">GlobalScope</span>.<span class="hljs-title function_">launch</span>(<span class="hljs-params">threadRoot</span>) {
                <span class="hljs-keyword">try</span> {
                    val startTime = <span class="hljs-title class_">System</span>.<span class="hljs-title function_">currentTimeMillis</span>()
                    <span class="hljs-comment">// 获取根节点</span>
                    <span class="hljs-keyword">var</span> rootNode = rootInActiveWindow
                    activeRootNodeVisible = rootNode?.<span class="hljs-property">isVisibleToUser</span> ?: <span class="hljs-literal">false</span>
                    <span class="hljs-title function_">printLogOnDebug</span>(<span class="hljs-string">"rootInActiveWindow-------${rootNode?.packageName}; ${rootNode?.windowId}"</span>)

                    <span class="hljs-comment">// 窗口过滤逻辑（已注释，可根据需要启用）</span>
                    <span class="hljs-keyword">if</span> (rootNode?.<span class="hljs-property">packageName</span> == packageName || rootNode?.<span class="hljs-property">childCount</span> == <span class="hljs-number">0</span>) {
                        windows?.<span class="hljs-property">forEach</span> { <span class="hljs-variable language_">window</span> -&gt;
                            <span class="hljs-variable language_">window</span>?.<span class="hljs-property">root</span>?.<span class="hljs-property">takeIf</span> { rn -&gt;
                                rn.<span class="hljs-property">packageName</span> != packageName &amp;&amp; rn.<span class="hljs-property">childCount</span> != <span class="hljs-number">0</span>
                            }?.<span class="hljs-property">apply</span> {
                                rootNode = <span class="hljs-variable language_">this</span>
                                <span class="hljs-title class_">LogUtils</span>.<span class="hljs-title function_">d</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">"替换节点......."</span>)
                            }
                        }
                    }
</code></pre>
<p>更详细一点的代码片段：</p>
<pre><code class="hljs language-kotlin" lang="kotlin">    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onAccessibilityEvent</span><span class="hljs-params">(event: <span class="hljs-type">AccessibilityEvent</span>?)</span></span> {
<span class="hljs-comment">//        windows.forEach {</span>
<span class="hljs-comment">//            LogUtils.e(TAG, "开始windows-------$it; ${it.root?.packageName}")</span>
<span class="hljs-comment">//        }</span>

        <span class="hljs-keyword">if</span>(!SettingsChangeObserver.checkIsCarSystem()){
            <span class="hljs-keyword">var</span> rootNodeOrigin = getRootNodeWithCache(event)

            lastCallBackTime = System.currentTimeMillis()
            lastActiveRootNodePackage = <span class="hljs-string">"<span class="hljs-subst">${rootNodeOrigin?.packageName?.toString() ?: <span class="hljs-string">""</span>}</span> child:<span class="hljs-subst">${rootNodeOrigin?.childCount}</span>"</span>

            windowArrStr = <span class="hljs-string">""</span>
            <span class="hljs-keyword">if</span>(isAbleToLog){
                windows.forEach {
                    windowArrStr += <span class="hljs-string">"<span class="hljs-subst">${it.root?.packageName}</span> - visible:<span class="hljs-subst">${it.root?.isVisibleToUser}</span> - active:<span class="hljs-subst">${it.isActive}</span> \n"</span>
                }
            }
            activeRootNodeVisible = rootNodeOrigin?.isVisibleToUser ?: <span class="hljs-literal">false</span>
            printLogOnDebug(<span class="hljs-string">"rootInActiveWindow-------<span class="hljs-subst">${rootNodeOrigin?.packageName}</span>; <span class="hljs-subst">${rootNodeOrigin?.windowId}</span>"</span>)

<span class="hljs-comment">//        for (w in windows) {</span>
<span class="hljs-comment">//            w.getBoundsInScreen(mRect)</span>
<span class="hljs-comment">//            //过滤顶部状态栏窗口</span>
<span class="hljs-comment">//            if (mRect.equalsXY(0, 0, 1920, 32)) continue</span>
<span class="hljs-comment">//            if (mRect.equalsXY(144, 0, 1920, 32)) continue</span>
<span class="hljs-comment">//            //过滤左边Dock栏窗口</span>
<span class="hljs-comment">//            if (mRect.equalsXY(0, 0, 144, 720)) continue</span>
<span class="hljs-comment">//            val pkName = w.root?.packageName</span>
<span class="hljs-comment">//</span>
<span class="hljs-comment">//            if (pkName.isNullOrEmpty()) break</span>
<span class="hljs-comment">//            rootNode</span>
<span class="hljs-comment">//            // TODO V2处理</span>
<span class="hljs-comment">////            rootNode = HotwordsExecutorFactory.getHotwordsExecutor(pkName).interceptRootNode(windows, rootNode)</span>
<span class="hljs-comment">//            break</span>
<span class="hljs-comment">//        }</span>

            <span class="hljs-keyword">if</span> (rootNodeOrigin?.packageName == packageName || rootNodeOrigin?.childCount == <span class="hljs-number">0</span>) {
                windows.forEach {
                Log.d(
                    TAG, <span class="hljs-string">"""
                packageName:<span class="hljs-subst">${it?.root?.packageName}</span>
                isActive:<span class="hljs-subst">${it?.isActive}</span>
                isAccessibilityFocused:<span class="hljs-subst">${it?.isAccessibilityFocused}</span>
                """</span>.trimIndent()
                )
                    it.root?.takeIf { rn -&gt;
                        rn.packageName != packageName &amp;&amp; rn.childCount != <span class="hljs-number">0</span>
                    }?.apply {
                        LogUtils.d(TAG, <span class="hljs-string">"替换节点......."</span>+ rootNodeOrigin?.packageName )
                        rootNodeOrigin = <span class="hljs-keyword">this</span>
                    }
                }
            }
            <span class="hljs-keyword">val</span> rootNode = rootNodeOrigin

            lastLoadRootNodePackage = rootNode?.packageName?.toString() ?: <span class="hljs-string">""</span>

            printLogOnDebug(<span class="hljs-string">"rootNode-------<span class="hljs-subst">${rootNode?.packageName}</span>; <span class="hljs-subst">${rootNode?.windowId}</span>"</span>)

            <span class="hljs-keyword">if</span> (rootNode == <span class="hljs-literal">null</span> || event == <span class="hljs-literal">null</span>|| event.packageName.isNullOrEmpty()) {
                <span class="hljs-keyword">return</span>
            }

            <span class="hljs-keyword">if</span> (rootNode.packageName == packageName) {
                <span class="hljs-keyword">return</span>
            }

            <span class="hljs-keyword">try</span> {
                logNodeInfo(rootNode, event)
            } <span class="hljs-keyword">catch</span> (e: Exception) {

            }
            GlobalScope.launch(threadContext) {
                <span class="hljs-keyword">try</span> {
                    processBusinessLogic(rootNode)
                } <span class="hljs-keyword">catch</span> (e: Exception) {
                    LogUtils.e(TAG, e.message)
                }
            }
        }<span class="hljs-keyword">else</span>{

            <span class="hljs-comment">// 第一步：在 threadRoot 线程中获取根节点</span>
            GlobalScope.launch(threadRoot) {
                <span class="hljs-keyword">try</span> {
                    <span class="hljs-keyword">val</span> startTime = System.currentTimeMillis()
                    <span class="hljs-comment">// 获取根节点</span>
                    <span class="hljs-keyword">var</span> rootNode = rootInActiveWindow
                    <span class="hljs-keyword">val</span> endTime = System.currentTimeMillis()
                    <span class="hljs-keyword">val</span> timeCost = endTime - startTime
                    <span class="hljs-keyword">if</span> (timeCost &gt; <span class="hljs-number">1000</span>) {
                        LogUtils.e(TAG, <span class="hljs-string">"获取最新rootInActiveWindow耗时超过1秒: <span class="hljs-subst">${timeCost}</span>ms"</span>+Thread.currentThread().name)
                        <span class="hljs-keyword">val</span> eventType = event?.let { AccessibilityEvent.eventTypeToString(it.eventType) } ?: <span class="hljs-string">"unknown"</span>
                        voiceAccessibilityPerformance.reportAccessibility(timeCost,eventType)
                    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(isAbleToWindowLog){
                        LogUtils.i(TAG, <span class="hljs-string">"获取最新rootInActiveWindow耗时: <span class="hljs-subst">${timeCost}</span>ms"</span>+Thread.currentThread().name)
                    }

                    lastCallBackTime = System.currentTimeMillis()
                    lastActiveRootNodePackage = <span class="hljs-string">"<span class="hljs-subst">${rootNode?.packageName?.toString() ?: <span class="hljs-string">""</span>}</span> child:<span class="hljs-subst">${rootNode?.childCount}</span>"</span>
                    windowArrStr = <span class="hljs-string">""</span>

                    activeRootNodeVisible = rootNode?.isVisibleToUser ?: <span class="hljs-literal">false</span>
                    printLogOnDebug(<span class="hljs-string">"rootInActiveWindow-------<span class="hljs-subst">${rootNode?.packageName}</span>; <span class="hljs-subst">${rootNode?.windowId}</span>"</span>)

                    <span class="hljs-comment">// 窗口过滤逻辑（已注释，可根据需要启用）</span>
                    <span class="hljs-keyword">if</span> (rootNode?.packageName == packageName || rootNode?.childCount == <span class="hljs-number">0</span>) {
                        windows?.forEach { window -&gt;
                            window?.root?.takeIf { rn -&gt;
                                rn.packageName != packageName &amp;&amp; rn.childCount != <span class="hljs-number">0</span>
                            }?.apply {
                                rootNode = <span class="hljs-keyword">this</span>
                                LogUtils.d(TAG, <span class="hljs-string">"替换节点......."</span>)
                            }
                        }
                    }
</code></pre>
<blockquote>
<p>为什么修改悬浮窗的属性和替换window可以解决呢?</p>
</blockquote>
<p>先整理需求：</p>
<h4 data-id="heading-23">1.).需要能把悬浮窗的事件能触摸，就要用到 WindowManager.LayoutParams.FLAG_NOT_TOUCH_MODAL;</h4>
<h4 data-id="heading-24">2).期望不影响下面window的交互，FLAG_NOT_FOCUSABLE</h4>
<p>FLAG_NOT_FOCUSABLE ： 焦点是干嘛的?
只有设置了这个，才能扫描到window对象</p>
<p><strong>场景1：设置了 FLAG_NOT_FOCUSABLE</strong></p>
<p>// 你的悬浮窗代码：
layoutParams.flags |= WindowManager.LayoutParams.FLAG_NOT_FOCUSABLE;
// 用户操作和结果：</p>
<ol>
<li>用户点击悬浮窗内的 EditText → ❌ 软键盘不会弹出</li>
<li>用户按物理键盘 → ❌ 悬浮窗收不到按键事件</li>
<li>用户按返回键 → ❌ 悬浮窗收不到返回键事件</li>
<li>用户按音量键 → ❌ 悬浮窗收不到音量键事件</li>
</ol>
<p><strong>场景2：没有设置 FLAG_NOT_FOCUSABLE</strong>
// 不设置 FLAG_NOT_FOCUSABLE：
// layoutParams.flags |= WindowManager.LayoutParams.FLAG_NOT_FOCUSABLE; // 注释掉</p>
<p>// 用户操作和结果：</p>
<ol>
<li>用户点击悬浮窗内的 EditText → ✅ 软键盘弹出</li>
<li>用户按物理键盘 → ✅ 悬浮窗收到按键事件</li>
<li>用户按返回键 → ✅ 悬浮窗收到返回键事件</li>
<li>用户按音量键 → ✅ 悬浮窗收到音量键事件</li>
</ol>
<p><strong>Q1：设置了 FLAG_NOT_FOCUSABLE，为什么还能收到触摸事件？</strong>
A：焦点和触摸是分开的。FLAG_NOT_FOCUSABLE 只影响键盘/按键事件，不影响触摸事件。要阻止触摸，需要设置 FLAG_NOT_TOUCHABLE。</p>
<p><strong>Q2：WindowManager.LayoutParams.FLAG_NOT_FOCUSABLE,
layoutParams.flags |= WindowManager.LayoutParams.FLAG_NOT_TOUCH_MODAL;</strong>
和只设置了WindowManager.LayoutParams.FLAG_NOT_FOCUSABLE,有什么区别</p>
<p>FLAG_NOT_TOUCH_MODAL 的作用？
默认情况下，悬浮窗会模态拦截所有触摸事件（即使点击空白区，底层也收不到）
加上此 flag 后：
悬浮窗区域内：自己处理事件
区域外：事件传递给下层窗口
<strong>Q3：// 设置窗口标志 - 允许点击外部关闭</strong>
params.flags |= WindowManager.LayoutParams.FLAG_DIM_BEHIND;</p>
<p><strong>Q4：// 设置窗口标志 - 允许点击外部关闭</strong>
这个必须配合flag一起使用, 否则也不生效
WindowManager.LayoutParams.FLAG_WATCH_OUTSIDE_TOUCH;</p>
<p><strong>Q5：这3个步骤到底事什么意思</strong></p>
<p>int canTouchFlag = WindowManager.LayoutParams.FLAG_NOT_TOUCH_MODAL;
int cantTouchFlag = WindowManager.LayoutParams.FLAG_NOT_TOUCHABLE | WindowManager.LayoutParams.FLAG_NOT_FOCUSABLE;</p>
<pre><code class="hljs language-ini" lang="ini">    layoutParams.flags |= canTouchFlag<span class="hljs-comment">;</span>
    layoutParams.flags |= cantTouchFlag<span class="hljs-comment">;</span>
    layoutParams.flags ^= cantTouchFlag<span class="hljs-comment">;</span>
</code></pre>
<p>这个是什么意思
经过这三步运算后：</p>
<p>✅ 设置了 FLAG_NOT_TOUCH_MODAL</p>
<p>❌ 移除了 FLAG_NOT_TOUCHABLE</p>
<p>❌ 移除了 FLAG_NOT_FOCUSABLE</p>
<p>等价于：</p>
<p>// 设置 NOT_TOUCH_MODAL
layoutParams.flags |= WindowManager.LayoutParams.FLAG_NOT_TOUCH_MODAL;</p>
<h3 data-id="heading-25">4.3 总结：  焦点和触摸事件是2回事！</h3>
<h6 data-id="heading-26">1）.触摸响应： 只和这个有关系</h6>
<p>layoutParams.flags |= WindowManager.LayoutParams.FLAG_NOT_TOUCH_MODAL;</p>
<h6 data-id="heading-27">2).  悬浮窗的事件分发问题：</h6>
<p>设置 FLAG_NOT_FOCUSABLE + FLAG_NOT_TOUCH_MODAL
onTouchEvent 返回 false， 我发现下面的launcher应用，不能接收到点击事件</p>
<p>结论：事件透传，(只和FLAG_NOT_TOUCHABLE有关系，注意不是FLAG_NOT_FOCUSABLE ，不遵循事件分发原理)！
权限和系统限制：一些系统为了安全，限制了悬浮窗与底层应用的交互</p>
<p>系统安全机制禁止应用直接干预其他应用的事件流。</p>
<p>悬浮窗事件透传机制</p>
<p>● FLAG_NOT_FOCUSABLE：窗口不获取焦点，但仍可接收触摸事件(自己得到事件)</p>
<p>● FLAG_NOT_TOUCH_MODAL：窗口区域内的触摸事件自己处理，区域外的传递给后面</p>
<p>● FLAG_NOT_TOUCHABLE：完全不接收任何触摸事件，全部传递给后面(全部给了底层)</p>
<p>Android悬浮窗事件分发遵循以下基本流程：</p>
<ol>
<li>输入系统检测触摸事件</li>
<li>WindowManagerService确定目标窗口</li>
<li>悬浮窗的事件分发只能针对自己的窗口，不能分发给其他窗口</li>
</ol>
<pre><code class="hljs language-csharp" lang="csharp">    <span class="hljs-comment">/**
     * 设置红色区域点击关闭功能, 点击到cardView不消失
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setupTransparentAreaClick</span>()</span> {
        <span class="hljs-keyword">if</span> (mAsrView == <span class="hljs-literal">null</span>) {
            LogUtils.d(TAG, <span class="hljs-string">"setupTransparentAreaClick: mAsrView is null"</span>);
            <span class="hljs-keyword">return</span>;
        }

        <span class="hljs-comment">// 获取根布局</span>
        View rootView = mAsrView.findViewById(R.id.root_view);

        <span class="hljs-keyword">if</span> (rootView == <span class="hljs-literal">null</span> || cardView == <span class="hljs-literal">null</span>) {
            LogUtils.d(TAG, <span class="hljs-string">"setupTransparentAreaClick: rootView or cardView is null"</span>);
            <span class="hljs-keyword">return</span>;
        }

        LogUtils.d(TAG, <span class="hljs-string">"setupTransparentAreaClick: rootView="</span> + rootView + <span class="hljs-string">", cardView="</span> + cardView);

        rootView.setOnTouchListener(<span class="hljs-keyword">new</span> View.OnTouchListener() {
            <span class="hljs-keyword">private</span> <span class="hljs-built_in">long</span> touchStartTime = <span class="hljs-number">0</span>;
            <span class="hljs-keyword">private</span> <span class="hljs-built_in">float</span> touchStartX = <span class="hljs-number">0</span>;
            <span class="hljs-keyword">private</span> <span class="hljs-built_in">float</span> touchStartY = <span class="hljs-number">0</span>;

            @Override
            <span class="hljs-function"><span class="hljs-keyword">public</span> boolean <span class="hljs-title">onTouch</span>(<span class="hljs-params">View v, MotionEvent <span class="hljs-keyword">event</span></span>)</span> {
                <span class="hljs-keyword">if</span> (mAsrView == <span class="hljs-literal">null</span>) {
                    LogUtils.e(TAG, <span class="hljs-string">"onTouch: mAsrView=null!!"</span>);
                    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
                }
                <span class="hljs-built_in">int</span> action = <span class="hljs-keyword">event</span>.getAction();
                <span class="hljs-built_in">float</span> currentX = <span class="hljs-keyword">event</span>.getX();
                <span class="hljs-built_in">float</span> currentY = <span class="hljs-keyword">event</span>.getY();

                <span class="hljs-keyword">switch</span> (action) {
                    <span class="hljs-keyword">case</span> MotionEvent.ACTION_DOWN:
                        touchStartTime = System.currentTimeMillis();
                        touchStartX = currentX;
                        touchStartY = currentY;

                        LogUtils.d(TAG, <span class="hljs-string">"ACTION_DOWN: x="</span> + currentX + <span class="hljs-string">", y="</span> + currentY);
                        LogUtils.d(TAG, <span class="hljs-string">"rootView bounds: width="</span> + rootView.getWidth() + <span class="hljs-string">", height="</span> + rootView.getHeight());
                        LogUtils.d(TAG, <span class="hljs-string">"cardView bounds: left="</span> + cardView.getLeft() + <span class="hljs-string">", top="</span> + cardView.getTop() +
                                <span class="hljs-string">", right="</span> + cardView.getRight() + <span class="hljs-string">", bottom="</span> + cardView.getBottom());

                        <span class="hljs-comment">// 判断点击是否在cardView区域内</span>
                        boolean isInsideCardView = isPointInsideView(currentX, currentY, cardView);
                        LogUtils.d(TAG, <span class="hljs-string">"isInsideCardView: "</span> + isInsideCardView);

                        <span class="hljs-comment">// 如果点击在cardView内，不处理，让子View处理</span>
                        <span class="hljs-keyword">if</span> (isInsideCardView) {
                            LogUtils.d(TAG, <span class="hljs-string">"点击在cardView内，不处理触摸事件"</span>);
                            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
                        }
                        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;

                    <span class="hljs-keyword">case</span> MotionEvent.ACTION_MOVE:
<span class="hljs-comment">//                        LogUtils.d(TAG, "ACTION_MOVE: x=" + currentX + ", y=" + currentY);</span>
                        <span class="hljs-keyword">break</span>;

                    <span class="hljs-keyword">case</span> MotionEvent.ACTION_UP:
                    <span class="hljs-keyword">case</span> MotionEvent.ACTION_CANCEL:
                        <span class="hljs-built_in">long</span> touchDuration = System.currentTimeMillis() - touchStartTime;
                        <span class="hljs-built_in">float</span> deltaX = Math.abs(currentX - touchStartX);
                        <span class="hljs-built_in">float</span> deltaY = Math.abs(currentY - touchStartY);

                        LogUtils.d(TAG, <span class="hljs-string">"ACTION_UP: x="</span> + currentX + <span class="hljs-string">", y="</span> + currentY +
                                <span class="hljs-string">", duration="</span> + touchDuration + <span class="hljs-string">"ms, deltaX="</span> + deltaX + <span class="hljs-string">", deltaY="</span> + deltaY);

                        <span class="hljs-comment">// 判断是否是点击事件（不是滑动）</span>
                        <span class="hljs-keyword">if</span> (touchDuration &lt; <span class="hljs-number">500</span> &amp;&amp; deltaX &lt; <span class="hljs-number">50</span> &amp;&amp; deltaY &lt; <span class="hljs-number">50</span>) {
                            boolean isInside = isPointInsideView(currentX, currentY, cardView);
                            LogUtils.d(TAG, <span class="hljs-string">"点击事件处理: isInsideCardView="</span> + isInside);

                            <span class="hljs-comment">// 如果点击在cardView外，关闭界面</span>
                            <span class="hljs-keyword">if</span> (!isInside) {
                                LogUtils.i(<span class="hljs-string">"baidu"</span>, <span class="hljs-string">"点击在cardView外部，触发关闭"</span>);
                                stopDialog();
                                LogUtils.i(<span class="hljs-string">"baidu"</span>, <span class="hljs-string">"点击在cardView外部，触发关闭====="</span>);
                                AsrUiManger.getPhone().sendTimeoutDelayTime(<span class="hljs-number">1500</span>);

                                <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
                            } <span class="hljs-keyword">else</span> {
                                LogUtils.d(TAG, <span class="hljs-string">"点击在cardView内部，不触发关闭"</span>);
                            }
                        } <span class="hljs-keyword">else</span> {
                            LogUtils.d(TAG, <span class="hljs-string">"滑动事件，不触发关闭"</span>);
                        }
                        <span class="hljs-keyword">break</span>;
                }
                <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
            }
        });
    }
</code></pre>
<h6 data-id="heading-28">3).FLAG 标志含义</h6>
<p>FLAG_NOT_FOCUSABLE: 窗口不获取输入焦点，但可接收触摸</p>
<p>FLAG_NOT_TOUCH_MODAL: 窗口外部触摸传递给下层</p>
<p>FLAG_WATCH_OUTSIDE_TOUCH: 可接收窗口外部的触摸事件</p>
<p>FLAG_NOT_TOUCHABLE: 完全不接收触摸事件</p>
<h2 data-id="heading-29">5.最终建议</h2>
<p>采用方案三的优化悬浮窗属性 + 智能无障碍服务处理</p>
<p>悬浮窗设置为半透明、不获取焦点、允许触摸穿透</p>
<p>在系统弹框出现时，自动将悬浮窗缩小/淡化</p>
<p>无障碍服务实现智能根节点查找算法</p>
<p>这样既能保证悬浮窗的功能，又能让系统弹框正常被无障碍服务扫描到，实现"可见即可说"的完整功能。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Anthropic 如何评估 AI Agent]]></title>    <link>https://juejin.cn/post/7594396523440554019</link>    <guid>https://juejin.cn/post/7594396523440554019</guid>    <pubDate>2026-01-13T06:23:48.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7594396523440554019" data-draft-id="7594396368174661667" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Anthropic 如何评估 AI Agent"/> <meta itemprop="keywords" content="Agent"/> <meta itemprop="datePublished" content="2026-01-13T06:23:48.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="程序猿DD"/> <meta itemprop="url" content="https://juejin.cn/user/131597123993358"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Anthropic 如何评估 AI Agent
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/131597123993358/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    程序猿DD
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-13T06:23:48.000Z" title="Tue Jan 13 2026 06:23:48 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">引言：打破“盲目飞行”的开发循环</h2>
<p>在开发AI智能体的过程中，许多团队都经历过这样的痛点：你修复了一个问题，却在不经意间引发了另一个更隐蔽的问题。如果没有一套可靠的评估体系，整个开发过程就像是在“盲目飞行”，团队陷入被动修复的循环，难以自信地发布新版本。</p>
<p>有效的评估（evals）正是打破这一困境的关键。它能让智能体在行为上的变化和潜在问题在影响用户之前就变得清晰可见。本文将从Anthropic的深度分享中，提炼出五个最令人惊讶、最具影响力的核心教训，它们将彻底改变你对AI智能体评估的看法。</p>
<h2 data-id="heading-1">五个关于AI智能体评估的反直觉教训</h2>
<h3 data-id="heading-2">教训一：别等了，从20个失败案例开始构建你的评估体系</h3>
<p>团队在项目初期常常认为构建评估体系是一项巨大的“开销”，会拖慢产品上市的进度，因此选择推迟。他们认为，等产品功能稳定、规模化之后再来考虑评估也不迟。</p>
<p>然而，Anthropic的经验恰恰相反：等到智能体规模化后才开始构建评估，你会遇到更大的困难。更重要的是，评估的价值会随着时间复利增长。早期投入不仅不会拖慢你，反而会成为未来加速迭代的引擎。那么，该如何开始呢？其实门槛比你想象的要低得多：</p>
<p>“实际上，一套由20-50个源自真实失败案例的简单任务，就是一个绝佳的起点。”</p>
<p>这个观点之所以重要，是因为它彻底打破了“评估体系必须庞大而完美”的误区。这不仅仅是关于避免技术债，更是为了获得开发过程中的能见度。用一小组真实的失败案例起步，就等于为你的驾驶舱安装了第一批仪表，让你停止“盲目飞行”，开始用数据导航。</p>
<h3 data-id="heading-3">教训二：当你的智能体“失败”时，可能恰恰是天才的体现</h3>
<p>我们通常认为，评估失败就意味着智能体犯了错。但有时，这种“失败”恰恰是其卓越创造力的体现。</p>
<p>以Anthropic提到的 Opus 4.5 模型为例，在一个预订航班的测试任务中，它没有遵循预设的流程，而是通过发现政策中的一个漏洞，为用户找到了一个更好的解决方案。从字面上看，它“失败”了这次评估，因为它没有按照人类设计的死板路径执行任务。但从用户的角度看，它取得了巨大的成功。</p>
<p>“它‘失败’了书面上的评估，但实际上为用户想出了一个更好的解决方案。”</p>
<p>这个例子深刻地揭示了静态评估的局限性。这并非简单的程序错误，而是前沿模型的一个典型特征：它们的解决问题的能力，已经开始超越那些嵌入在旧式评估里的、基于静态规则的假设。依赖僵化的路径评估无异于另一种“盲目飞行”，因为它让你对模型自身的天才之处视而不见。学会识别这些“天才般”的失败，才能让你真正看清你所解锁的前沿能力。</p>
<h3 data-id="heading-4">教训三：评估终点，而非过程</h3>
<p>在评估智能体时，一个常见的错误是检查它是否遵循了一套非常具体的步骤，比如是否按照特定顺序调用了某些工具。这种方法看似严谨，实则非常脆弱。</p>
<p>Anthropic指出，这种方法“过于僵化，会导致测试过于脆弱”，因为它会惩罚那些评估设计者未曾预料到的、同样有效的创新方法。一个更优越、更具前瞻性的做法是：评估智能体最终产出的成果（outcome），而不是它所采取的具体路径（path）。</p>
<p>例如，与其检查一个编码智能体是否调用了某个特定的编辑函数，不如直接评估它生成的代码是否通过了所有的单元测试。专注于过程本身就是一种“盲目飞行”，因为它让你对那些更优越、未曾预见的解决方案视而不见。而专注于最终成果，才是获得智能体究竟为用户完成了什么的真实视野。这一教训对于释放AI智能体的全部潜力至关重要。</p>
<h3 data-id="heading-5">教训四：你的指标在衡量什么：一次成功还是次次可靠？</h3>
<p>“我们的智能体成功率是75%。” 这句话听起来不错，但它可能隐藏着巨大的误导性。你需要问一个更深层次的问题：这个成功率衡量的是什么？是多次尝试中的一次成功，还是每一次尝试都必须成功？这里有两个关键指标：pass@k 和 pass^k。</p>
<ul>
<li>pass@k 衡量的是智能体在 k 次尝试中至少有一次成功的可能性。你可以把它比作“多次射门，只要进一个球就算成功”。这个指标适用于那些只要找到一个可行解就行的场景，比如代码生成或创意构思。</li>
<li>pass^k 衡量的是智能体在全部 k 次尝试中每次都成功的概率。这更像是“要求每次射门都必须命中”。对于需要高度可靠和一致性的面向客户的智能体来说，这个指标至关重要。</li>
</ul>
<p>这两个指标的差异巨大。例如，如果一个智能体的单次成功率（pass@1）是75%，那么它连续成功3次的概率（pass^3）就骤降至42.1875%，约等于42% (0.75 x 0.75 x 0.75)。</p>
<p>为需要高可靠性的面向客户的智能体使用 pass@k 指标，是导致用户流失的温床。因为75%的单次成功率掩盖了在仅仅三次交互中，性能稳定率甚至不足50%的残酷事实。这不仅仅是统计学上的选择，更是决定产品定位的战略抉择。你是在打造一个创意性的头脑风暴伙伴，十次尝试有一次绝妙点子就算巨大成功（pass@k）？还是在构建一个关键任务型支持助手，任何低于近乎完美的可靠性都是不可接受的（pass^k）？你的指标选择，决定了你的优化方向。</p>
<h3 data-id="heading-6">教训五：你最强大的评估工具不是代码，而是你的眼睛</h3>
<p>在追求自动化的过程中，我们很容易过度依赖冷冰冰的评估分数。然而，分数可能是骗人的。一个误导性的低分可能不是因为智能体失败了，而是因为评估本身存在缺陷。</p>
<p>例如，Anthropic在对Opus 4.5模型进行CORE-Bench基准测试时，通过人工审查记录发现，其分数从最初的42%跃升至95%。原因何在？仅仅是修复了评估系统中的问题，比如过于僵化的评分标准（它会因为“96.12”与预期格式“96.124991…”不完全匹配而判定为错误）。如果没有阅读完整的试验记录（transcript），团队会错误地认为模型的能力远比实际情况要差。</p>
<p>“阅读记录是验证你的评估是否在衡量真正重要的事情的方式，也是智能体开发的一项关键技能。”</p>
<p>信任分数而不去阅读记录，是终极的“盲目飞行”——仪表盘显示你在急速下坠，但实际上你可能飞得比以往任何时候都高，只是你的仪表坏了。自动化工具告诉你“是什么”（分数是42%），但只有深入审查记录才能揭示“为什么”——不是因为模型不行，而是因为评估本身存在缺陷。</p>
<h2 data-id="heading-7">结论：将评估视为核心战略，而非事后弥补</h2>
<p>有效的评估不是开发过程中的负担，而是一种能够加速开发、确保质量的核心战略资产。它能将团队成员模糊的“感觉变差了”转化为了清晰、可操作的衡量指标。</p>
<p>成功的AI团队都明白一个道理：评估体系是产品不可或缺的一部分，其重要性不亚于单元测试之于传统软件。而且，在模型能力飞速发展的时代，一个强大的评估套件就是你的护城河。它能让你在几天内验证并部署更先进的模型，而你的竞争对手可能还在数周的手动测试中苦苦挣扎。</p>
<p>如果你的评估体系反映了你最看重的东西，那么它正在讲述一个关于你智能体的核心故事。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[vue3规范化示例]]></title>    <link>https://juejin.cn/post/7594385386739941395</link>    <guid>https://juejin.cn/post/7594385386739941395</guid>    <pubDate>2026-01-13T06:09:27.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7594385386739941395" data-draft-id="7594403873177354281" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="vue3规范化示例"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2026-01-13T06:09:27.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="一尘子"/> <meta itemprop="url" content="https://juejin.cn/user/2142267148862040"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            vue3规范化示例
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2142267148862040/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    一尘子
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-13T06:09:27.000Z" title="Tue Jan 13 2026 06:09:27 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一、层级分离原则</h2>
<h3 data-id="heading-1">1. 模板层（UI）分离</h3>
<h4 data-id="heading-2">❌ 反例：模板中写复杂表达式和数据操作</h4>
<pre><code class="hljs language-vue" lang="vue">&lt;template&gt;
  &lt;div&gt;
    &lt;!-- 反例1: 模板中写复杂表达式 --&gt;
    &lt;div&gt;
      {{ goodsList.filter(item =&gt; item.price &gt; 100).map(item =&gt; item.name).join(',') }}
    &lt;/div&gt;
    
    &lt;!-- 反例2: 直接在模板中修改数据 --&gt;
    &lt;button @click="goodsList.push({ id: Date.now(), name: '新商品', price: 99 })"&gt;
      添加商品
    &lt;/button&gt;
    
    &lt;!-- 反例3: 模板中写复杂计算 --&gt;
    &lt;div&gt;
      总价: {{ goodsList.reduce((sum, item) =&gt; sum + item.price * item.count, 0).toFixed(2) }}
    &lt;/div&gt;
    
    &lt;!-- 反例4: 用样式控制业务逻辑 --&gt;
    &lt;div :style="{ display: isVisible ? 'block' : 'none' }"&gt;
      内容
    &lt;/div&gt;
  &lt;/div&gt;
&lt;/template&gt;

&lt;script setup lang="ts"&gt;
import { ref } from 'vue';

const goodsList = ref([
  { id: 1, name: '商品A', price: 150, count: 2 },
  { id: 2, name: '商品B', price: 80, count: 1 },
]);
const isVisible = ref(true);
&lt;/script&gt;
</code></pre>
<h4 data-id="heading-3">✅ 正例：模板只负责渲染，逻辑放在 computed/methods</h4>
<pre><code class="hljs language-vue" lang="vue">&lt;template&gt;
  &lt;div&gt;
    &lt;!-- 正例1: 调用简单的 computed --&gt;
    &lt;div&gt;{{ filteredGoodsNames }}&lt;/div&gt;
    
    &lt;!-- 正例2: 调用方法处理事件 --&gt;
    &lt;button @click="handleAddGoods"&gt;添加商品&lt;/button&gt;
    
    &lt;!-- 正例3: 使用 computed 计算总价 --&gt;
    &lt;div&gt;总价: {{ totalPrice }}&lt;/div&gt;
    
    &lt;!-- 正例4: 用 v-if 控制渲染 --&gt;
    &lt;div v-if="isVisible"&gt;内容&lt;/div&gt;
  &lt;/div&gt;
&lt;/template&gt;

&lt;script setup lang="ts"&gt;
import { ref, computed } from 'vue';

// 原始数据
const goodsList = ref([
  { id: 1, name: '商品A', price: 150, count: 2 },
  { id: 2, name: '商品B', price: 80, count: 1 },
]);
const isVisible = ref(true);

// 数据处理放在 computed
const filteredGoodsNames = computed(() =&gt; {
  return goodsList.value
    .filter(item =&gt; item.price &gt; 100)
    .map(item =&gt; item.name)
    .join(',');
});

const totalPrice = computed(() =&gt; {
  return goodsList.value
    .reduce((sum, item) =&gt; sum + item.price * item.count, 0)
    .toFixed(2);
});

// 事件处理放在 methods
const handleAddGoods = () =&gt; {
  goodsList.value.push({
    id: Date.now(),
    name: '新商品',
    price: 99,
    count: 1,
  });
};
&lt;/script&gt;
</code></pre>
<h3 data-id="heading-4">2. 逻辑层（数据）分离</h3>
<h4 data-id="heading-5">❌ 反例：在 data 中存储派生数据，在模板中直接调用接口</h4>
<pre><code class="hljs language-vue" lang="vue">&lt;template&gt;
  &lt;div&gt;
    &lt;!-- 反例: 在模板中直接调用接口 --&gt;
    &lt;button @click="fetchGoods"&gt;加载商品&lt;/button&gt;
    &lt;div v-for="item in formattedList" :key="item.id"&gt;
      {{ item.displayName }} - ¥{{ item.formattedPrice }}
    &lt;/div&gt;
  &lt;/div&gt;
&lt;/template&gt;

&lt;script setup lang="ts"&gt;
import { ref } from 'vue';
import axios from 'axios';

// 反例1: 存储格式化后的派生数据
const formattedList = ref([
  { id: 1, displayName: '商品A', formattedPrice: '150.00' },
]);

// 反例2: 在事件中直接写接口请求
const fetchGoods = () =&gt; {
  axios.get('/api/goods').then(res =&gt; {
    // 每次都要手动格式化并同步到 formattedList
    formattedList.value = res.data.map((item: any) =&gt; ({
      id: item.id,
      displayName: `${item.name} (${item.category})`,
      formattedPrice: item.price.toFixed(2),
    }));
  });
};
&lt;/script&gt;
</code></pre>
<h4 data-id="heading-6">✅ 正例：data 只存原始数据，computed 处理派生数据，接口抽离到 api</h4>
<pre><code class="hljs language-vue" lang="vue">&lt;template&gt;
  &lt;div&gt;
    &lt;button @click="handleFetchGoods" :loading="loading"&gt;加载商品&lt;/button&gt;
    &lt;div v-for="item in formattedGoodsList" :key="item.id"&gt;
      {{ item.displayName }} - ¥{{ item.formattedPrice }}
    &lt;/div&gt;
  &lt;/div&gt;
&lt;/template&gt;

&lt;script setup lang="ts"&gt;
import { ref, computed } from 'vue';
import { fetchGoodsList } from '@/api/goods'; // 接口抽离到 api

// 正例1: data 只存储原始数据
const goodsList = ref([]);
const loading = ref(false);

// 正例2: 派生数据用 computed 自动计算
const formattedGoodsList = computed(() =&gt; {
  return goodsList.value.map(item =&gt; ({
    id: item.id,
    displayName: `${item.name} (${item.category})`,
    formattedPrice: item.price.toFixed(2),
  }));
});

// 正例3: 接口请求和业务逻辑抽离
const handleFetchGoods = async () =&gt; {
  try {
    loading.value = true;
    const res = await fetchGoodsList();
    goodsList.value = res.data; // 只更新原始数据，computed 自动更新
  } catch (error) {
    console.error('加载失败', error);
  } finally {
    loading.value = false;
  }
};
&lt;/script&gt;
</code></pre>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// src/api/goods.ts - 接口抽离</span>
<span class="hljs-keyword">import</span> request <span class="hljs-keyword">from</span> <span class="hljs-string">'@/utils/request'</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">fetchGoodsList</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-keyword">return</span> request.<span class="hljs-title function_">get</span>(<span class="hljs-string">'/api/goods'</span>);
};
</code></pre>
<h3 data-id="heading-7">3. 组件层（业务解耦）</h3>
<h4 data-id="heading-8">❌ 反例：通用组件包含业务逻辑</h4>
<pre><code class="hljs language-vue" lang="vue">&lt;!-- Table.vue - 反例: 通用组件直接调用业务接口 --&gt;
&lt;template&gt;
  &lt;el-table :data="tableData" :loading="loading"&gt;
    &lt;el-table-column prop="name" label="名称" /&gt;
    &lt;el-table-column prop="price" label="价格" /&gt;
  &lt;/el-table&gt;
&lt;/template&gt;

&lt;script setup lang="ts"&gt;
import { ref, onMounted } from 'vue';
import axios from 'axios';

// 反例: 通用组件内部直接调用业务接口
const tableData = ref([]);
const loading = ref(false);

onMounted(() =&gt; {
  loading.value = true;
  axios.get('/api/goods').then(res =&gt; {
    tableData.value = res.data;
    loading.value = false;
  });
});
&lt;/script&gt;
</code></pre>
<pre><code class="hljs language-vue" lang="vue">&lt;!-- GoodsList.vue - 反例: 父组件传原始数据，子组件内部格式化 --&gt;
&lt;template&gt;
  &lt;Table :data="goodsList" /&gt;
&lt;/template&gt;

&lt;script setup lang="ts"&gt;
import { ref } from 'vue';
import Table from './Table.vue';
import { fetchGoodsList } from '@/api/goods';

const goodsList = ref([]);

const loadData = async () =&gt; {
  const res = await fetchGoodsList();
  goodsList.value = res.data; // 传原始数据给子组件
};
&lt;/script&gt;
</code></pre>
<h4 data-id="heading-9">✅ 正例：通用组件只接收 props，业务组件处理数据</h4>
<pre><code class="hljs language-vue" lang="vue">&lt;!-- Table.vue - 正例: 通用组件只接收 props，不包含业务逻辑 --&gt;
&lt;template&gt;
  &lt;el-table :data="data" :loading="loading" v-bind="$attrs"&gt;
    &lt;slot /&gt;
  &lt;/el-table&gt;
&lt;/template&gt;

&lt;script setup lang="ts"&gt;
defineProps&lt;{
  data: any[];
  loading?: boolean;
}&gt;();
&lt;/script&gt;
</code></pre>
<pre><code class="hljs language-vue" lang="vue">&lt;!-- GoodsList.vue - 正例: 业务组件处理数据，传给通用组件 --&gt;
&lt;template&gt;
  &lt;Table :data="formattedGoodsList" :loading="loading"&gt;
    &lt;el-table-column prop="name" label="名称" /&gt;
    &lt;el-table-column prop="price" label="价格" /&gt;
  &lt;/Table&gt;
&lt;/template&gt;

&lt;script setup lang="ts"&gt;
import { ref, computed } from 'vue';
import Table from './Table.vue';
import { fetchGoodsList } from '@/api/goods';

const goodsList = ref([]);
const loading = ref(false);

// 业务组件负责数据格式化
const formattedGoodsList = computed(() =&gt; {
  return goodsList.value.map(item =&gt; ({
    ...item,
    price: `¥${item.price.toFixed(2)}`,
  }));
});

const loadData = async () =&gt; {
  try {
    loading.value = true;
    const res = await fetchGoodsList();
    goodsList.value = res.data;
  } finally {
    loading.value = false;
  }
};

loadData();
&lt;/script&gt;
</code></pre>
<h2 data-id="heading-10">二、拆分原则</h2>
<h3 data-id="heading-11">1. 函数拆分</h3>
<h4 data-id="heading-12">❌ 反例：过度拆分，逻辑分散</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// src/utils/goods-list/getItem.ts</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">getItem</span> = (<span class="hljs-params">list: <span class="hljs-built_in">any</span>[], id: <span class="hljs-built_in">number</span></span>) =&gt; {
  <span class="hljs-keyword">return</span> list.<span class="hljs-title function_">find</span>(<span class="hljs-function"><span class="hljs-params">item</span> =&gt;</span> item.<span class="hljs-property">id</span> === id);
};

<span class="hljs-comment">// src/utils/goods-list/setItem.ts</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">setItem</span> = (<span class="hljs-params">list: <span class="hljs-built_in">any</span>[], item: <span class="hljs-built_in">any</span></span>) =&gt; {
  <span class="hljs-keyword">const</span> index = list.<span class="hljs-title function_">findIndex</span>(<span class="hljs-function"><span class="hljs-params">i</span> =&gt;</span> i.<span class="hljs-property">id</span> === item.<span class="hljs-property">id</span>);
  <span class="hljs-keyword">if</span> (index &gt; -<span class="hljs-number">1</span>) {
    list[index] = item;
  }
};

<span class="hljs-comment">// src/utils/goods-list/checkItem.ts</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">checkItem</span> = (<span class="hljs-params">item: <span class="hljs-built_in">any</span></span>) =&gt; {
  <span class="hljs-keyword">return</span> item &amp;&amp; item.<span class="hljs-property">price</span> &gt; <span class="hljs-number">0</span>;
};

<span class="hljs-comment">// src/utils/goods-list/filterItem.ts</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">filterItem</span> = (<span class="hljs-params">list: <span class="hljs-built_in">any</span>[], condition: <span class="hljs-built_in">any</span></span>) =&gt; {
  <span class="hljs-keyword">return</span> list.<span class="hljs-title function_">filter</span>(<span class="hljs-function"><span class="hljs-params">item</span> =&gt;</span> item.<span class="hljs-property">price</span> &gt; condition.<span class="hljs-property">minPrice</span>);
};

<span class="hljs-comment">// GoodsList.vue</span>
<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">setup</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"ts"</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">import</span> { getItem } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/utils/goods-list/getItem'</span>;
<span class="hljs-keyword">import</span> { setItem } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/utils/goods-list/setItem'</span>;
<span class="hljs-keyword">import</span> { checkItem } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/utils/goods-list/checkItem'</span>;
<span class="hljs-keyword">import</span> { filterItem } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/utils/goods-list/filterItem'</span>;

<span class="hljs-comment">// 调用时需要跨文件引入，逻辑链路变长</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">handleUpdate</span> = (<span class="hljs-params">id: number, newData: any</span>) =&gt; {
  <span class="hljs-keyword">const</span> item = <span class="hljs-title function_">getItem</span>(goodsList.<span class="hljs-property">value</span>, id);
  <span class="hljs-keyword">if</span> (<span class="hljs-title function_">checkItem</span>(item)) {
    <span class="hljs-title function_">setItem</span>(goodsList.<span class="hljs-property">value</span>, { ...item, ...newData });
  }
};
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></span>
</code></pre>
<h4 data-id="heading-13">✅ 正例：按业务逻辑拆分，函数内聚</h4>
<pre><code class="hljs language-vue" lang="vue">&lt;!-- GoodsList.vue --&gt;
&lt;script setup lang="ts"&gt;
import { ref, computed } from 'vue';
import { fetchGoodsList } from '@/api/goods';

const goodsList = ref([]);
const loading = ref(false);

// 正例: 按业务逻辑拆分成核心函数，函数内聚
const loadGoodsData = async () =&gt; {
  try {
    loading.value = true;
    const res = await fetchGoodsList();
    goodsList.value = formatGoodsData(res.data);
  } catch (error) {
    console.error('加载失败', error);
  } finally {
    loading.value = false;
  }
};

// 格式化数据 - 仅当前组件使用，写在组件内
const formatGoodsData = (data: any[]) =&gt; {
  return data.map(item =&gt; ({
    ...item,
    displayPrice: `¥${item.price.toFixed(2)}`,
    isAvailable: item.stock &gt; 0,
  }));
};

// 如需复用，再抽离到 utils/goods.ts
loadGoodsData();
&lt;/script&gt;
</code></pre>
<h3 data-id="heading-14">2. 组件拆分</h3>
<h4 data-id="heading-15">❌ 反例：过度拆分，增加通信成本</h4>
<pre><code class="hljs language-vue" lang="vue">&lt;!-- SearchInput.vue --&gt;
&lt;template&gt;
  &lt;el-input v-model="inputValue" @input="handleInput" /&gt;
&lt;/template&gt;

&lt;script setup lang="ts"&gt;
import { ref } from 'vue';

const inputValue = defineModel&lt;string&gt;('modelValue');
const emit = defineEmits(['update:modelValue']);

const handleInput = (value: string) =&gt; {
  emit('update:modelValue', value);
};
&lt;/script&gt;

&lt;!-- SearchButton.vue --&gt;
&lt;template&gt;
  &lt;el-button @click="handleClick"&gt;{{ text }}&lt;/el-button&gt;
&lt;/template&gt;

&lt;script setup lang="ts"&gt;
defineProps&lt;{ text: string }&gt;();
const emit = defineEmits(['click']);

const handleClick = () =&gt; {
  emit('click');
};
&lt;/script&gt;

&lt;!-- SearchWrapper.vue --&gt;
&lt;template&gt;
  &lt;div class="search-wrapper"&gt;
    &lt;SearchInput v-model="keyword" /&gt;
    &lt;SearchButton text="搜索" @click="handleSearch" /&gt;
  &lt;/div&gt;
&lt;/template&gt;

&lt;script setup lang="ts"&gt;
import { ref } from 'vue';
import SearchInput from './SearchInput.vue';
import SearchButton from './SearchButton.vue';

const keyword = ref('');
const emit = defineEmits(['search']);

const handleSearch = () =&gt; {
  emit('search', keyword.value);
};
&lt;/script&gt;
</code></pre>
<h4 data-id="heading-16">✅ 正例：保留单个组件，内部封装</h4>
<pre><code class="hljs language-vue" lang="vue">&lt;!-- SearchBar.vue - 正例: 单个组件，逻辑闭环 --&gt;
&lt;template&gt;
  &lt;div class="search-bar"&gt;
    &lt;el-input v-model="keyword" placeholder="请输入关键词" clearable /&gt;
    &lt;el-button type="primary" @click="handleSearch"&gt;搜索&lt;/el-button&gt;
  &lt;/div&gt;
&lt;/template&gt;

&lt;script setup lang="ts"&gt;
import { ref } from 'vue';

const keyword = ref('');
const emit = defineEmits(['search']);

const handleSearch = () =&gt; {
  emit('search', keyword.value);
};
&lt;/script&gt;
</code></pre>
<h2 data-id="heading-17">三、目录拆分原则</h2>
<h3 data-id="heading-18">组件目录结构说明</h3>
<p>当工具函数、样式、组合式函数仅被单个组件使用时，应放在该组件所在目录下，而不是全局 <code>src/utils</code>。</p>
<pre><code class="hljs language-bash" lang="bash">组件目录结构示例：
ProductList/
  ├── index.vue              <span class="hljs-comment"># 主组件</span>
  ├── index.scss             <span class="hljs-comment"># 组件样式</span>
  ├── composables/           <span class="hljs-comment"># 仅当前组件使用的组合式函数</span>
  │   ├── useProductData.ts
  │   └── useProductFilter.ts
  ├── utils/                 <span class="hljs-comment"># 仅当前组件使用的工具函数</span>
  │   ├── formatProduct.ts
  │   └── validateProduct.ts
  └── components/            <span class="hljs-comment"># 仅当前组件使用的子组件</span>
      └── ProductCard.vue
</code></pre>
<h3 data-id="heading-19">1. 工具函数拆分</h3>
<h4 data-id="heading-20">❌ 反例：仅单组件使用的函数放在全局 utils</h4>
<pre><code class="hljs language-bash" lang="bash">src/
  utils/
    product-list/            <span class="hljs-comment"># 反例：仅在 ProductList.vue 使用</span>
      formatProduct.ts
      filterProduct.ts
      validateProduct.ts
</code></pre>
<pre><code class="hljs language-vue" lang="vue">&lt;!-- src/views/product/ProductList.vue --&gt;
&lt;script setup lang="ts"&gt;
import { formatProduct } from '@/utils/product-list/formatProduct';
import { filterProduct } from '@/utils/product-list/filterProduct';
import { validateProduct } from '@/utils/product-list/validateProduct';

// 引入路径长，且这些函数只在当前组件使用
&lt;/script&gt;
</code></pre>
<h4 data-id="heading-21">✅ 正例：仅当前组件使用的工具函数放在组件目录下</h4>
<pre><code class="hljs language-bash" lang="bash">src/views/product/ProductList/
  ├── index.vue
  ├── utils/                 <span class="hljs-comment"># 正例：仅当前组件使用</span>
  │   ├── formatProduct.ts
  │   └── filterProduct.ts
  └── index.scss
</code></pre>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// src/views/product/ProductList/utils/formatProduct.ts</span>
<span class="hljs-comment">// 仅 ProductList 组件使用</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> formatProductPrice = (<span class="hljs-attr">price</span>: <span class="hljs-built_in">number</span>): <span class="hljs-function"><span class="hljs-params">string</span> =&gt;</span> {
  <span class="hljs-keyword">return</span> <span class="hljs-string">`¥<span class="hljs-subst">${price.toFixed(<span class="hljs-number">2</span>)}</span>`</span>;
};

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> formatProductName = (<span class="hljs-attr">name</span>: <span class="hljs-built_in">string</span>, <span class="hljs-attr">category</span>: <span class="hljs-built_in">string</span>): <span class="hljs-function"><span class="hljs-params">string</span> =&gt;</span> {
  <span class="hljs-keyword">return</span> <span class="hljs-string">`<span class="hljs-subst">${name}</span> (<span class="hljs-subst">${category}</span>)`</span>;
};
</code></pre>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// src/views/product/ProductList/utils/filterProduct.ts</span>
<span class="hljs-comment">// 仅 ProductList 组件使用</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">filterByPriceRange</span> = (<span class="hljs-params">products: <span class="hljs-built_in">any</span>[], min: <span class="hljs-built_in">number</span>, max: <span class="hljs-built_in">number</span></span>) =&gt; {
  <span class="hljs-keyword">return</span> products.<span class="hljs-title function_">filter</span>(<span class="hljs-function"><span class="hljs-params">p</span> =&gt;</span> p.<span class="hljs-property">price</span> &gt;= min &amp;&amp; p.<span class="hljs-property">price</span> &lt;= max);
};

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">filterByCategory</span> = (<span class="hljs-params">products: <span class="hljs-built_in">any</span>[], category: <span class="hljs-built_in">string</span></span>) =&gt; {
  <span class="hljs-keyword">return</span> products.<span class="hljs-title function_">filter</span>(<span class="hljs-function"><span class="hljs-params">p</span> =&gt;</span> p.<span class="hljs-property">category</span> === category);
};
</code></pre>
<pre><code class="hljs language-vue" lang="vue">&lt;!-- src/views/product/ProductList/index.vue --&gt;
&lt;script setup lang="ts"&gt;
import { ref, computed } from 'vue';
import { formatProductPrice, formatProductName } from './utils/formatProduct';
import { filterByPriceRange } from './utils/filterProduct';

const products = ref([]);

// 引入路径短，且明确表示这些函数属于当前组件
const formattedProducts = computed(() =&gt; {
  return products.value.map(p =&gt; ({
    ...p,
    displayPrice: formatProductPrice(p.price),
    displayName: formatProductName(p.name, p.category),
  }));
});
&lt;/script&gt;
</code></pre>
<h3 data-id="heading-22">2. 组合式函数（Composables）拆分</h3>
<h4 data-id="heading-23">❌ 反例：仅单组件使用的 composable 放在全局</h4>
<pre><code class="hljs language-bash" lang="bash">src/
  composables/
    useProductData.ts        <span class="hljs-comment"># 反例：仅在 ProductList.vue 使用</span>
    useProductFilter.ts      <span class="hljs-comment"># 反例：仅在 ProductList.vue 使用</span>
</code></pre>
<pre><code class="hljs language-vue" lang="vue">&lt;!-- src/views/product/ProductList.vue --&gt;
&lt;script setup lang="ts"&gt;
import { useProductData } from '@/composables/useProductData';
import { useProductFilter } from '@/composables/useProductFilter';

// 看起来像是全局可复用的，但实际上只在当前组件使用
&lt;/script&gt;
</code></pre>
<h4 data-id="heading-24">✅ 正例：仅当前组件使用的 composable 放在组件目录下</h4>
<pre><code class="hljs language-bash" lang="bash">src/views/product/ProductList/
  ├── index.vue
  ├── composables/           <span class="hljs-comment"># 正例：仅当前组件使用</span>
  │   ├── useProductData.ts
  │   └── useProductFilter.ts
  └── index.scss
</code></pre>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// src/views/product/ProductList/composables/useProductData.ts</span>
<span class="hljs-comment">// 仅 ProductList 组件使用</span>
<span class="hljs-keyword">import</span> { ref, computed } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>;
<span class="hljs-keyword">import</span> { fetchProductList } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/api/product'</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">useProductData</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-keyword">const</span> products = <span class="hljs-title function_">ref</span>([]);
  <span class="hljs-keyword">const</span> loading = <span class="hljs-title function_">ref</span>(<span class="hljs-literal">false</span>);
  <span class="hljs-keyword">const</span> error = <span class="hljs-title function_">ref</span>(<span class="hljs-literal">null</span>);

  <span class="hljs-keyword">const</span> <span class="hljs-title function_">loadProducts</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params"/>) =&gt; {
    <span class="hljs-keyword">try</span> {
      loading.<span class="hljs-property">value</span> = <span class="hljs-literal">true</span>;
      <span class="hljs-keyword">const</span> res = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetchProductList</span>();
      products.<span class="hljs-property">value</span> = res.<span class="hljs-property">data</span>;
    } <span class="hljs-keyword">catch</span> (err) {
      error.<span class="hljs-property">value</span> = err;
    } <span class="hljs-keyword">finally</span> {
      loading.<span class="hljs-property">value</span> = <span class="hljs-literal">false</span>;
    }
  };

  <span class="hljs-keyword">const</span> formattedProducts = <span class="hljs-title function_">computed</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">return</span> products.<span class="hljs-property">value</span>.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">p</span> =&gt;</span> ({
      ...p,
      <span class="hljs-attr">displayPrice</span>: <span class="hljs-string">`¥<span class="hljs-subst">${p.price.toFixed(<span class="hljs-number">2</span>)}</span>`</span>,
    }));
  });

  <span class="hljs-keyword">return</span> {
    products,
    formattedProducts,
    loading,
    error,
    loadProducts,
  };
};
</code></pre>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// src/views/product/ProductList/composables/useProductFilter.ts</span>
<span class="hljs-comment">// 仅 ProductList 组件使用</span>
<span class="hljs-keyword">import</span> { ref, computed } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">useProductFilter</span> = (<span class="hljs-params">products: <span class="hljs-built_in">any</span>[]</span>) =&gt; {
  <span class="hljs-keyword">const</span> searchKeyword = <span class="hljs-title function_">ref</span>(<span class="hljs-string">''</span>);
  <span class="hljs-keyword">const</span> priceRange = <span class="hljs-title function_">ref</span>([<span class="hljs-number">0</span>, <span class="hljs-number">10000</span>]);
  <span class="hljs-keyword">const</span> selectedCategory = <span class="hljs-title function_">ref</span>(<span class="hljs-string">''</span>);

  <span class="hljs-keyword">const</span> filteredProducts = <span class="hljs-title function_">computed</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">let</span> result = products.<span class="hljs-property">value</span>;

    <span class="hljs-comment">// 按关键词过滤</span>
    <span class="hljs-keyword">if</span> (searchKeyword.<span class="hljs-property">value</span>) {
      result = result.<span class="hljs-title function_">filter</span>(<span class="hljs-function"><span class="hljs-params">p</span> =&gt;</span>
        p.<span class="hljs-property">name</span>.<span class="hljs-title function_">toLowerCase</span>().<span class="hljs-title function_">includes</span>(searchKeyword.<span class="hljs-property">value</span>.<span class="hljs-title function_">toLowerCase</span>())
      );
    }

    <span class="hljs-comment">// 按价格范围过滤</span>
    result = result.<span class="hljs-title function_">filter</span>(
      <span class="hljs-function"><span class="hljs-params">p</span> =&gt;</span> p.<span class="hljs-property">price</span> &gt;= priceRange.<span class="hljs-property">value</span>[<span class="hljs-number">0</span>] &amp;&amp; p.<span class="hljs-property">price</span> &lt;= priceRange.<span class="hljs-property">value</span>[<span class="hljs-number">1</span>]
    );

    <span class="hljs-comment">// 按分类过滤</span>
    <span class="hljs-keyword">if</span> (selectedCategory.<span class="hljs-property">value</span>) {
      result = result.<span class="hljs-title function_">filter</span>(<span class="hljs-function"><span class="hljs-params">p</span> =&gt;</span> p.<span class="hljs-property">category</span> === selectedCategory.<span class="hljs-property">value</span>);
    }

    <span class="hljs-keyword">return</span> result;
  });

  <span class="hljs-keyword">return</span> {
    searchKeyword,
    priceRange,
    selectedCategory,
    filteredProducts,
  };
};
</code></pre>
<pre><code class="hljs language-vue" lang="vue">&lt;!-- src/views/product/ProductList/index.vue --&gt;
&lt;script setup lang="ts"&gt;
import { useProductData } from './composables/useProductData';
import { useProductFilter } from './composables/useProductFilter';
import { onMounted } from 'vue';

// 引入路径短，且明确表示这些 composable 属于当前组件
const { formattedProducts, loading, loadProducts } = useProductData();
const { searchKeyword, priceRange, filteredProducts } = useProductFilter(formattedProducts);

onMounted(() =&gt; {
  loadProducts();
});
&lt;/script&gt;

&lt;template&gt;
  &lt;div&gt;
    &lt;input v-model="searchKeyword" placeholder="搜索商品" /&gt;
    &lt;div v-for="product in filteredProducts" :key="product.id"&gt;
      {{ product.displayName }} - {{ product.displayPrice }}
    &lt;/div&gt;
  &lt;/div&gt;
&lt;/template&gt;
</code></pre>
<h3 data-id="heading-25">3. 样式拆分</h3>
<h4 data-id="heading-26">❌ 反例：仅单组件使用的样式放在全局</h4>
<pre><code class="hljs language-bash" lang="bash">src/
  styles/
    product-list.scss        <span class="hljs-comment"># 反例：仅在 ProductList.vue 使用</span>
</code></pre>
<pre><code class="hljs language-vue" lang="vue">&lt;!-- src/views/product/ProductList.vue --&gt;
&lt;style lang="scss"&gt;
@use '@/styles/product-list.scss';
&lt;/style&gt;
</code></pre>
<h4 data-id="heading-27">✅ 正例：仅当前组件使用的样式放在组件目录下</h4>
<pre><code class="hljs language-bash" lang="bash">src/views/product/ProductList/
  ├── index.vue
  ├── index.scss             <span class="hljs-comment"># 正例：组件主样式</span>
  ├── styles/                <span class="hljs-comment"># 正例：样式拆分（如果样式较多）</span>
  │   ├── variables.scss
  │   └── mixins.scss
  └── components/
      └── ProductCard.vue
      └── ProductCard.scss
</code></pre>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// src/views/product/ProductList/index.scss</span>
<span class="hljs-comment">// 仅 ProductList 组件使用</span>
<span class="hljs-keyword">@use</span> <span class="hljs-string">'./styles/variables.scss'</span>;
<span class="hljs-keyword">@use</span> <span class="hljs-string">'./styles/mixins.scss'</span>;

<span class="hljs-selector-class">.product-list</span> {
  <span class="hljs-attribute">padding</span>: <span class="hljs-number">20px</span>;
  
  &amp;__header {
    <span class="hljs-attribute">display</span>: flex;
    <span class="hljs-attribute">justify-content</span>: space-between;
    <span class="hljs-attribute">margin-bottom</span>: <span class="hljs-number">20px</span>;
  }
  
  &amp;__content {
    <span class="hljs-attribute">display</span>: grid;
    <span class="hljs-attribute">grid-template-columns</span>: <span class="hljs-built_in">repeat</span>(auto-fill, <span class="hljs-built_in">minmax</span>(<span class="hljs-number">200px</span>, <span class="hljs-number">1</span>fr));
    <span class="hljs-attribute">gap</span>: <span class="hljs-number">16px</span>;
  }
}
</code></pre>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// src/views/product/ProductList/styles/variables.scss</span>
<span class="hljs-comment">// 仅 ProductList 组件使用</span>
<span class="hljs-variable">$product-card-width</span>: <span class="hljs-number">200px</span>;
<span class="hljs-variable">$product-card-gap</span>: <span class="hljs-number">16px</span>;
<span class="hljs-variable">$product-header-height</span>: <span class="hljs-number">60px</span>;
</code></pre>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// src/views/product/ProductList/styles/mixins.scss</span>
<span class="hljs-comment">// 仅 ProductList 组件使用</span>
<span class="hljs-keyword">@mixin</span> product-card-hover {
  <span class="hljs-attribute">transition</span>: transform <span class="hljs-number">0.2s</span>;
  
  &amp;<span class="hljs-selector-pseudo">:hover</span> {
    <span class="hljs-attribute">transform</span>: <span class="hljs-built_in">translateY</span>(-<span class="hljs-number">4px</span>);
  }
}
</code></pre>
<pre><code class="hljs language-vue" lang="vue">&lt;!-- src/views/product/ProductList/index.vue --&gt;
&lt;template&gt;
  &lt;div class="product-list"&gt;
    &lt;div class="product-list__header"&gt;...&lt;/div&gt;
    &lt;div class="product-list__content"&gt;...&lt;/div&gt;
  &lt;/div&gt;
&lt;/template&gt;

&lt;style scoped lang="scss"&gt;
@import './index.scss';
&lt;/style&gt;
</code></pre>
<h3 data-id="heading-28">4. 子组件拆分</h3>
<h4 data-id="heading-29">❌ 反例：仅单组件使用的子组件放在全局 components</h4>
<pre><code class="hljs language-bash" lang="bash">src/
  components/
    ProductCard.vue          <span class="hljs-comment"># 反例：仅在 ProductList.vue 使用</span>
    ProductFilter.vue        <span class="hljs-comment"># 反例：仅在 ProductList.vue 使用</span>
</code></pre>
<pre><code class="hljs language-vue" lang="vue">&lt;!-- src/views/product/ProductList.vue --&gt;
&lt;script setup lang="ts"&gt;
import ProductCard from '@/components/ProductCard.vue';
import ProductFilter from '@/components/ProductFilter.vue';

// 看起来像是全局组件，但实际上只在当前组件使用
&lt;/script&gt;
</code></pre>
<h4 data-id="heading-30">✅ 正例：仅当前组件使用的子组件放在组件目录下</h4>
<pre><code class="hljs language-bash" lang="bash">src/views/product/ProductList/
  ├── index.vue
  ├── components/            <span class="hljs-comment"># 正例：仅当前组件使用</span>
  │   ├── ProductCard.vue
  │   ├── ProductCard.scss
  │   ├── ProductFilter.vue
  │   └── ProductFilter.scss
  └── index.scss
</code></pre>
<pre><code class="hljs language-vue" lang="vue">&lt;!-- src/views/product/ProductList/components/ProductCard.vue --&gt;
&lt;!-- 仅 ProductList 组件使用 --&gt;
&lt;template&gt;
  &lt;div class="product-card"&gt;
    &lt;img :src="product.image" :alt="product.name" /&gt;
    &lt;h3&gt;{{ product.name }}&lt;/h3&gt;
    &lt;p class="price"&gt;{{ product.displayPrice }}&lt;/p&gt;
  &lt;/div&gt;
&lt;/template&gt;

&lt;script setup lang="ts"&gt;
defineProps&lt;{
  product: any;
}&gt;();
&lt;/script&gt;

&lt;style scoped lang="scss"&gt;
@import './ProductCard.scss';
&lt;/style&gt;
</code></pre>
<pre><code class="hljs language-vue" lang="vue">&lt;!-- src/views/product/ProductList/index.vue --&gt;
&lt;script setup lang="ts"&gt;
import ProductCard from './components/ProductCard.vue';
import ProductFilter from './components/ProductFilter.vue';

// 引入路径短，且明确表示这些组件属于当前组件
&lt;/script&gt;

&lt;template&gt;
  &lt;div class="product-list"&gt;
    &lt;ProductFilter /&gt;
    &lt;ProductCard
      v-for="product in products"
      :key="product.id"
      :product="product"
    /&gt;
  &lt;/div&gt;
&lt;/template&gt;
</code></pre>
<h3 data-id="heading-31">5. 何时抽离到全局</h3>
<p>当以下情况出现时，再考虑抽离到全局：</p>
<h4 data-id="heading-32">✅ 需要复用时抽离到全局</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 情况1: 多个组件开始使用相同的工具函数</span>
src/views/product/ProductList/utils/formatProduct.ts  <span class="hljs-comment"># 原本在这里</span>
src/views/order/OrderList.vue                        <span class="hljs-comment"># 现在也要用</span>
src/views/cart/CartList.vue                          <span class="hljs-comment"># 现在也要用</span>

<span class="hljs-comment"># 应该抽离到：</span>
src/utils/product/formatProduct.ts
</code></pre>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// src/utils/product/formatProduct.ts</span>
<span class="hljs-comment">// 多个组件复用，抽离到全局</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> formatProductPrice = (<span class="hljs-attr">price</span>: <span class="hljs-built_in">number</span>): <span class="hljs-function"><span class="hljs-params">string</span> =&gt;</span> {
  <span class="hljs-keyword">return</span> <span class="hljs-string">`¥<span class="hljs-subst">${price.toFixed(<span class="hljs-number">2</span>)}</span>`</span>;
};

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> formatProductName = (<span class="hljs-attr">name</span>: <span class="hljs-built_in">string</span>, <span class="hljs-attr">category</span>: <span class="hljs-built_in">string</span>): <span class="hljs-function"><span class="hljs-params">string</span> =&gt;</span> {
  <span class="hljs-keyword">return</span> <span class="hljs-string">`<span class="hljs-subst">${name}</span> (<span class="hljs-subst">${category}</span>)`</span>;
};
</code></pre>
<pre><code class="hljs language-vue" lang="vue">&lt;!-- src/views/product/ProductList/index.vue --&gt;
&lt;script setup lang="ts"&gt;
// 从全局引入
import { formatProductPrice } from '@/utils/product/formatProduct';
&lt;/script&gt;
</code></pre>
<pre><code class="hljs language-vue" lang="vue">&lt;!-- src/views/order/OrderList.vue --&gt;
&lt;script setup lang="ts"&gt;
// 从全局引入
import { formatProductPrice } from '@/utils/product/formatProduct';
&lt;/script&gt;
</code></pre>
<h2 data-id="heading-33">完整示例：组件目录结构</h2>
<pre><code class="hljs language-bash" lang="bash">src/views/product/ProductList/
  ├── index.vue                    <span class="hljs-comment"># 主组件</span>
  ├── index.scss                   <span class="hljs-comment"># 组件主样式</span>
  │
  ├── composables/                 <span class="hljs-comment"># 仅当前组件使用的组合式函数</span>
  │   ├── useProductData.ts
  │   ├── useProductFilter.ts
  │   └── useProductPagination.ts
  │
  ├── utils/                       <span class="hljs-comment"># 仅当前组件使用的工具函数</span>
  │   ├── formatProduct.ts
  │   ├── filterProduct.ts
  │   └── validateProduct.ts
  │
  ├── components/                  <span class="hljs-comment"># 仅当前组件使用的子组件</span>
  │   ├── ProductCard/
  │   │   ├── index.vue
  │   │   └── index.scss
  │   ├── ProductFilter/
  │   │   ├── index.vue
  │   │   └── index.scss
  │   └── ProductPagination/
  │       ├── index.vue
  │       └── index.scss
  │
  └── styles/                      <span class="hljs-comment"># 样式拆分（如果样式较多）</span>
      ├── variables.scss
      ├── mixins.scss
      └── animations.scss
</code></pre>
<h2 data-id="heading-34">总结对比</h2>



































<table><thead><tr><th>场景</th><th>❌ 反例（全局）</th><th>✅ 正例（组件目录）</th></tr></thead><tbody><tr><td>仅单组件使用的工具函数</td><td><code>src/utils/product-list/format.ts</code></td><td><code>ProductList/utils/format.ts</code></td></tr><tr><td>仅单组件使用的 composable</td><td><code>src/composables/useProductData.ts</code></td><td><code>ProductList/composables/useProductData.ts</code></td></tr><tr><td>仅单组件使用的样式</td><td><code>src/styles/product-list.scss</code></td><td><code>ProductList/index.scss</code></td></tr><tr><td>仅单组件使用的子组件</td><td><code>src/components/ProductCard.vue</code></td><td><code>ProductList/components/ProductCard.vue</code></td></tr><tr><td>多个组件复用</td><td>-</td><td>抽离到全局 <code>src/utils/</code> 或 <code>src/composables/</code></td></tr></tbody></table>
<p>原则：</p>
<ul>
<li>仅当前组件使用 → 放在组件目录下（<code>utils/</code>、<code>composables/</code>、<code>components/</code>、<code>styles/</code>）</li>
<li>多个组件复用 → 抽离到全局（<code>src/utils/</code>、<code>src/composables/</code>、<code>src/components/</code>）</li>
</ul>
<h2 data-id="heading-35">总结</h2>
<ul>
<li>模板层：只负责渲染，不写复杂表达式和数据操作</li>
<li>逻辑层：data 存原始数据，computed 处理派生数据，接口抽离到 api</li>
<li>组件层：通用组件只接收 props，业务组件处理数据逻辑</li>
<li>拆分原则：按业务逻辑拆分，避免过度拆分增加复杂度</li>
</ul>
<p>这些示例展示了如何在实际项目中应用这些原则。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Promise与async/await]]></title>    <link>https://juejin.cn/post/7594385386739974163</link>    <guid>https://juejin.cn/post/7594385386739974163</guid>    <pubDate>2026-01-13T06:13:04.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7594385386739974163" data-draft-id="7594403873177452585" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Promise与async/await"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2026-01-13T06:13:04.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="wuhen_n"/> <meta itemprop="url" content="https://juejin.cn/user/4149996261738233"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Promise与async/await
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4149996261738233/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    wuhen_n
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-13T06:13:04.000Z" title="Tue Jan 13 2026 06:13:04 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>本专栏聚焦Promise的核心原理与高级应用，包含：
✓ Promise A+规范深度解读
✓ 手写实现与源码分析
✓ 异步编程设计模式
✓ 性能调优与错误处理</p>
</blockquote>
<blockquote>
<p>适合有JavaScript基础，希望深入异步编程的开发者。我们将用最少的篇幅，讲透最核心的知识。</p>
</blockquote>
<h2 data-id="heading-0">引言</h2>
<p>在之前的文章中，我们学习了Promise的基础和原理实现。从中我们不难发现，即使是链式调用，处理复杂的异步流程仍然有些繁琐，我们来看下面的例子：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// Promise链式调用</span>
<span class="hljs-title function_">fetchUser</span>(userId)
    .<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">user</span> =&gt;</span> <span class="hljs-title function_">fetchOrders</span>(user.<span class="hljs-property">id</span>))
    .<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">orders</span> =&gt;</span> <span class="hljs-title function_">processOrders</span>(orders))
    .<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">result</span> =&gt;</span> <span class="hljs-title function_">displayResult</span>(result))
    .<span class="hljs-title function_">catch</span>(<span class="hljs-function"><span class="hljs-params">error</span> =&gt;</span> <span class="hljs-title function_">handleError</span>(error))
    .<span class="hljs-title function_">finally</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">cleanup</span>());
</code></pre>
<p>在这种情况下，async/await语法应运而生，它让我们可以用同步的方式写异步代码：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// async/await版本</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">displayUserOrders</span>(<span class="hljs-params">userId</span>) {
    <span class="hljs-keyword">try</span> {
        <span class="hljs-keyword">const</span> user = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetchUser</span>(userId);
        <span class="hljs-keyword">const</span> orders = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetchOrders</span>(user.<span class="hljs-property">id</span>);
        <span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> <span class="hljs-title function_">processOrders</span>(orders);
        <span class="hljs-title function_">displayResult</span>(result);
    } <span class="hljs-keyword">catch</span> (error) {
        <span class="hljs-title function_">handleError</span>(error);
    } <span class="hljs-keyword">finally</span> {
        <span class="hljs-title function_">cleanup</span>();
    }
}
</code></pre>
<h2 data-id="heading-1">async：声明异步函数</h2>
<h3 data-id="heading-2">基本语法</h3>
<p><code>async</code> 关键字用于声明一个异步函数：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// async函数声明</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">getUser</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> { <span class="hljs-attr">name</span>: <span class="hljs-string">'张三'</span>, <span class="hljs-attr">age</span>: <span class="hljs-number">25</span> };
}

<span class="hljs-comment">// async函数表达式</span>
<span class="hljs-keyword">const</span> getData = <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> <span class="hljs-string">'数据'</span>;
};

<span class="hljs-comment">// async箭头函数</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">fetchData</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params"/>) =&gt; {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetch</span>(<span class="hljs-string">'/api/data'</span>);
};

<span class="hljs-comment">// async方法</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">UserService</span> {
    <span class="hljs-keyword">async</span> <span class="hljs-title function_">getUser</span>(<span class="hljs-params">id</span>) {
        <span class="hljs-comment">// 异步操作</span>
    }
}
</code></pre>
<h3 data-id="heading-3">函数返回值</h3>
<p><code>async</code> 函数总是返回一个 <code>Promise</code> 。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">basicReturn</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> <span class="hljs-number">42</span>; <span class="hljs-comment">// 等价于 Promise.resolve(42)</span>
}

<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">promiseReturn</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">resolve</span>(<span class="hljs-string">'hello'</span>); <span class="hljs-comment">// 返回的Promise</span>
}

<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">throwError</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">'失败'</span>); <span class="hljs-comment">// 等价于 Promise.reject(error)</span>
}
</code></pre>
<h2 data-id="heading-4">await：等待Promise解决</h2>
<h3 data-id="heading-5">基本使用</h3>
<p><code>await</code> 只能在 <code>async</code> 函数内部使用，它会暂停 <code>async</code> 函数的执行，等待Promise解决：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">example</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'开始执行'</span>);
    
    <span class="hljs-comment">// await会暂停执行，直到Promise解决</span>
    <span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetchData</span>();
    
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'数据获取完成:'</span>, result);
    <span class="hljs-keyword">return</span> result;
}

<span class="hljs-comment">// 等价于</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">examplePromise</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'开始执行'</span>);
    
    <span class="hljs-keyword">return</span> <span class="hljs-title function_">fetchData</span>().<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">result</span> =&gt;</span> {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'数据获取完成:'</span>, result);
        <span class="hljs-keyword">return</span> result;
    });
}
</code></pre>
<h2 data-id="heading-6">错误处理：try-catch的回归</h2>
<h3 data-id="heading-7">同步风格的错误处理</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 传统Promise错误处理（分散）</span>
<span class="hljs-title function_">fetchUser</span>()
    .<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">user</span> =&gt;</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-title function_">fetchOrders</span>(user.<span class="hljs-property">id</span>)
            .<span class="hljs-title function_">catch</span>(<span class="hljs-function"><span class="hljs-params">orderError</span> =&gt;</span> {
                <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'获取订单失败:'</span>, orderError);
                <span class="hljs-keyword">return</span> [];
            });
    })
    .<span class="hljs-title function_">catch</span>(<span class="hljs-function"><span class="hljs-params">userError</span> =&gt;</span> {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'获取用户失败:'</span>, userError);
    });

<span class="hljs-comment">// async/await错误处理（集中）</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">getUserOrders</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">try</span> {
        <span class="hljs-keyword">const</span> user = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetchUser</span>();
        <span class="hljs-keyword">try</span> {
            <span class="hljs-keyword">const</span> orders = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetchOrders</span>(user.<span class="hljs-property">id</span>);
            <span class="hljs-keyword">return</span> orders;
        } <span class="hljs-keyword">catch</span> (orderError) {
            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'获取订单失败:'</span>, orderError);
            <span class="hljs-keyword">return</span> []; <span class="hljs-comment">// 返回默认值</span>
        }
    } <span class="hljs-keyword">catch</span> (userError) {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'获取用户失败:'</span>, userError);
        <span class="hljs-keyword">throw</span> userError; <span class="hljs-comment">// 重新抛出</span>
    }
}

<span class="hljs-comment">// 更简洁的版本</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">getUserOrdersBetter</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">try</span> {
        <span class="hljs-keyword">const</span> user = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetchUser</span>();
        <span class="hljs-keyword">const</span> orders = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetchOrders</span>(user.<span class="hljs-property">id</span>);
        <span class="hljs-keyword">return</span> orders;
    } <span class="hljs-keyword">catch</span> (error) {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'操作失败:'</span>, error);
        <span class="hljs-comment">// 根据错误类型处理</span>
        <span class="hljs-keyword">if</span> (error.<span class="hljs-property">message</span>.<span class="hljs-title function_">includes</span>(<span class="hljs-string">'用户'</span>)) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">'用户相关操作失败'</span>);
        }
        <span class="hljs-keyword">return</span> []; <span class="hljs-comment">// 默认值</span>
    }
}
</code></pre>
<h3 data-id="heading-8">多await操作的错误处理</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">multipleOperations</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// 方法1：分别处理每个await（粒度细）</span>
    <span class="hljs-keyword">let</span> user;
    <span class="hljs-keyword">try</span> {
        user = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetchUser</span>();
    } <span class="hljs-keyword">catch</span> (error) {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'获取用户失败'</span>);
        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
    }
    
    <span class="hljs-keyword">let</span> orders;
    <span class="hljs-keyword">try</span> {
        orders = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetchOrders</span>(user.<span class="hljs-property">id</span>);
    } <span class="hljs-keyword">catch</span> (error) {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'获取订单失败，但用户数据有效:'</span>, user);
        orders = [];
    }
    
    <span class="hljs-comment">// 方法2：统一处理（粒度粗）</span>
    <span class="hljs-keyword">try</span> {
        <span class="hljs-keyword">const</span> user = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetchUser</span>();
        <span class="hljs-keyword">const</span> orders = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetchOrders</span>(user.<span class="hljs-property">id</span>);
        <span class="hljs-keyword">const</span> products = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetchProducts</span>(orders);
        <span class="hljs-keyword">return</span> { user, orders, products };
    } <span class="hljs-keyword">catch</span> (error) {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'某个步骤失败:'</span>, error);
        <span class="hljs-comment">// 无法区分哪个步骤失败</span>
    }
    
    <span class="hljs-comment">// 方法3：组合使用（推荐）</span>
    <span class="hljs-keyword">try</span> {
        <span class="hljs-keyword">const</span> user = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetchUser</span>().<span class="hljs-title function_">catch</span>(<span class="hljs-function">() =&gt;</span> {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">'用户获取失败，终止流程'</span>);
        });
        
        <span class="hljs-keyword">const</span> orders = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetchOrders</span>(user.<span class="hljs-property">id</span>).<span class="hljs-title function_">catch</span>(<span class="hljs-function">() =&gt;</span> {
            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">warn</span>(<span class="hljs-string">'订单获取失败，使用空数组'</span>);
            <span class="hljs-keyword">return</span> [];
        });
        
        <span class="hljs-comment">// 即使orders为空，也继续执行</span>
        <span class="hljs-keyword">const</span> analysis = <span class="hljs-keyword">await</span> <span class="hljs-title function_">analyzeData</span>(user, orders);
        <span class="hljs-keyword">return</span> analysis;
    } <span class="hljs-keyword">catch</span> (error) {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'致命错误:'</span>, error);
        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
    }
}
</code></pre>
<h2 data-id="heading-9">停止和恢复执行</h2>
<p><code>async/await</code> 中真正起作用的是 <code>await</code> 。<code>async</code> 关键字只是一个标识符。我们可以看下面一个例子：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">test</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-keyword">await</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">resolve</span>(<span class="hljs-number">1</span>));
}
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">test2</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-keyword">await</span> <span class="hljs-string">'2'</span>);
}

<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">test3</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-number">3</span>);
}
<span class="hljs-title function_">test</span>();
<span class="hljs-title function_">test2</span>();
<span class="hljs-title function_">test3</span>();
</code></pre>
<p>上述代码的输出结果是：<code>3 2 1</code> 。因为JS运行时，在碰到 <code>await</code> 关键字时，会记录在哪里执行暂停。等待 <code>await</code> 后边的值可以用了，JS运行时会向消息队列中推送一个任务，这个任务会恢复函数执行。</p>
<h2 data-id="heading-10">结语</h2>
<p><code>Promise</code> 和 <code>async/await</code> 是JS异步编程的黄金组合：<code>Promise</code> 提供了底层的异步抽象和组合能力，<code>async/await</code> 提供了上层的语法糖，让异步代码更易读。对于文章中错误的地方或者有任何问题，欢迎在评论区留言讨论！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item>  </channel></rss>